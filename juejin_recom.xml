<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Kotlin中的JvmMultifileClass注解]]></title>    <link>https://juejin.cn/post/7603444191448727586</link>    <guid>https://juejin.cn/post/7603444191448727586</guid>    <pubDate>2026-02-06T12:13:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191448727586" data-draft-id="7603383311531311119" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin中的JvmMultifileClass注解"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-02-06T12:13:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin中的JvmMultifileClass注解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T12:13:13.000Z" title="Fri Feb 06 2026 12:13:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>@JvmMultifileClass 是 Kotlin 中的一个文件级注解（File-level Annotation），通常与 @file:JvmName 配合使用，将多个 Kotlin 文件的顶层声明合并到同一个 JVM 类中。</p>
<p>其核心作用是解决“同一功能模块的代码分散在多个 Kotlin 文件中时，如何在 Java 中以统一的类名调用”的问题，提升跨语言调用的便利性。</p>
<h2 data-id="heading-0">背景与问题场景</h2>
<p>Kotlin 的顶层函数（不在类或对象中定义的函数）默认会被编译到一个与文件名关联的 JVM 类中（命名规则：文件名 + "Kt"，例如 StringUtils.kt 生成 StringUtilsKt 类）。</p>
<p>若一个功能模块的工具方法分散在多个 Kotlin 文件中（例如 StringUtils.kt、NumberUtils.kt），每个文件会生成独立的 JVM 类（如 StringUtilsKt、NumberUtilsKt），导致 Java 调用时需要分别引用不同的类，不够直观。</p>
<p>示例问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// File1: StringUtils.kt</span>
<span class="hljs-keyword">package</span> com.example.utils
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEmpty</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span> = str.isEmpty()

<span class="hljs-comment">// File2: NumberUtils.kt  </span>
<span class="hljs-keyword">package</span> com.example.utils
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isPositive</span><span class="hljs-params">(num: <span class="hljs-type">Int</span>)</span></span> = num &gt; <span class="hljs-number">0</span>

<span class="hljs-comment">// Java 调用时需分别引用两个类：</span>
<span class="hljs-comment">// boolean empty = StringUtilsKt.isEmpty("test");</span>
<span class="hljs-comment">// boolean positive = NumberUtilsKt.isPositive(10);</span>
</code></pre>
<h2 data-id="heading-1">@JvmMultifileClass 的解决方案</h2>
<p>通过 @file:JvmName 为多个文件指定相同的 JVM 类名，并添加 @file:JvmMultifileClass 注解，Kotlin 编译器会将这些文件的顶层声明合并到同一个 JVM 类中。这样，Java 调用时只需通过一个类名即可访问所有分散的顶层函数。</p>
<p>使用步骤与示例</p>
<ol>
<li>为目标文件指定相同的 @file:JvmName</li>
</ol>
<p>在所有需要合并的 Kotlin 文件顶部，使用 @file:JvmName 注解指定相同的 JVM 类名（需包含包名）。</p>
<ol start="2">
<li>添加 @file:JvmMultifileClass 注解</li>
</ol>
<p>在每个文件的 @file:JvmName 下方添加 @file:JvmMultifileClass 注解，告知编译器合并这些文件的顶层声明。</p>
<p>示例代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// File1: StringUtils.kt</span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"CommonUtils"</span>)       <span class="hljs-comment">// 指定 JVM 类名为 com.example.utils.CommonUtils</span>
<span class="hljs-meta">@file:JvmMultifileClass</span>           <span class="hljs-comment">// 标记为需要合并的文件</span>
<span class="hljs-keyword">package</span> com.example.utils          <span class="hljs-comment">// 包名需一致</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEmpty</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span> = str.isEmpty()

<span class="hljs-comment">// File2: NumberUtils.kt  </span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"CommonUtils"</span>)       <span class="hljs-comment">// 与 File1 相同的 JVM 类名</span>
<span class="hljs-meta">@file:JvmMultifileClass</span>           <span class="hljs-comment">// 同样标记为需要合并的文件</span>
<span class="hljs-keyword">package</span> com.example.utils          <span class="hljs-comment">// 包名必须一致</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isPositive</span><span class="hljs-params">(num: <span class="hljs-type">Int</span>)</span></span> = num &gt; <span class="hljs-number">0</span>
</code></pre>
<ol start="3">
<li>Java 调用效果</li>
</ol>
<p>编译后，两个文件的顶层函数会被合并到 com.example.utils.CommonUtils 类中。Java 调用时只需通过该统一类名访问：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 调用（无需区分 StringUtilsKt 或 NumberUtilsKt）</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">empty</span> <span class="hljs-operator">=</span> CommonUtils.isEmpty(<span class="hljs-string">"test"</span>);      <span class="hljs-comment">// 来自 StringUtils.kt</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">positive</span> <span class="hljs-operator">=</span> CommonUtils.isPositive(<span class="hljs-number">10</span>);    <span class="hljs-comment">// 来自 NumberUtils.kt</span>
</code></pre>
<h2 data-id="heading-2">关键注意事项</h2>
<ol>
<li>
<p>包名必须一致：所有参与合并的 Kotlin 文件必须属于同一个包（即 package 语句相同），否则无法合并。</p>
</li>
<li>
<p>@file:JvmName 的名称需全局唯一：指定的 JVM 类名（如 CommonUtils）不能与同一模块中其他类的名称冲突，否则会导致编译错误。</p>
</li>
<li>
<p>仅合并顶层声明：@JvmMultifileClass 仅对顶层函数、顶层属性生效，类、对象、伴生对象等声明不会被合并。</p>
</li>
<li>
<p>注解顺序要求：@file:JvmName 必须位于 @file:JvmMultifileClass 之前，且两者均需放在文件顶部（package 语句之前）。</p>
</li>
<li>
<p>避免过度合并：合并的文件应具有逻辑关联性（如同一功能模块的工具类），否则可能导致 JVM 类过于庞大，影响可读性和维护性。</p>
</li>
</ol>
<h2 data-id="heading-3">典型应用场景</h2>
<p>• 工具类拆分：将一个大型工具类（如 StringUtils、NumberUtils）拆分为多个 Kotlin 文件，但通过 @JvmMultifileClass 合并为同一个 JVM 类，方便 Java 调用。</p>
<p>• 模块化开发：团队开发中，不同开发者负责同一功能模块的不同部分（如网络请求的工具函数、数据校验的工具函数），通过合并注解保持对外接口的统一。</p>
<h2 data-id="heading-4">总结</h2>
<p>@JvmMultifileClass 是 Kotlin 为优化 JVM 平台互操作性设计的注解，通过与 @file:JvmName 配合，将多个文件的顶层声明合并到同一个 JVM 类中，解决了“分散代码的统一调用”问题。合理使用可提升跨语言代码的可读性和维护性，尤其适用于工具类或模块化开发的场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[地平线征程 6 工具链入门教程 | 征程 6B 计算平台部署指南]]></title>    <link>https://juejin.cn/post/7603359026711838730</link>    <guid>https://juejin.cn/post/7603359026711838730</guid>    <pubDate>2026-02-06T12:14:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603359026711838730" data-draft-id="7603584155784331314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="地平线征程 6 工具链入门教程 | 征程 6B 计算平台部署指南"/> <meta itemprop="keywords" content="自动驾驶,算法"/> <meta itemprop="datePublished" content="2026-02-06T12:14:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            地平线征程 6 工具链入门教程 | 征程 6B 计算平台部署指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T12:14:55.000Z" title="Fri Feb 06 2026 12:14:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.前言</h2>
<p>本文旨在提供 征程 6B 计算平台的部署指南，将会从硬件、软件两部分进行介绍，本文整理了我们推荐的使用流程，和大家可能会用到的一些工具特性，以便于您更好地理解工具链。某个工具具体详细的使用说明，还请参考用户手册。</p>
<h2 data-id="heading-1">2.征程 6B 硬件配置</h2>
<p><img src="http://openwrite.cn/uploads/19742/59443/6e793ae7-b061-4833-8cbd-7baade202e31.png" alt="image.png" loading="lazy"/></p>
<p><img src="http://openwrite.cn/uploads/19742/59443/e3db4baa-bba9-45b6-9dea-96e5bfb80ec3.png" alt="image.png" loading="lazy"/></p>
<p>BPU 内部器件：</p>
<p><strong>TAE</strong>：BPU 内部的张量加速引擎，主要用于 Conv、MatMul、Linear 等 Gemm 类算子加速，<strong>征程 6B 新增</strong>​<strong>浮点</strong>​<strong>输出支持（模型中间层支持 ​</strong>​<strong>fp16</strong>​<strong>​ 输出，模型</strong>​<strong>输出层</strong>​<strong>支持 fp32 输出）</strong></p>
<p><strong>AAE</strong>：Pooling、Resizer、Warping 等偏专用单元的集合，其中 Warping 可用于加速 Gridsample 等算子</p>
<p><strong>DTE</strong>：BPU 内部的数据排布变换引擎，支持各种维度的高效变换</p>
<p><strong>VAE</strong>：BPU 内部的 SIMD 向量加速引擎，可用于加速 Add、Mul、查表等 Vector 计算，<strong>征程 6B 新增浮点支持</strong></p>
<p><strong>VPU</strong>：BPU 内部的 SIMT 向量加速单元，征程 6EM 可用于实现 Quantize、Dequantize 等算子，<strong>征程 6B 没有该硬件</strong></p>
<p><strong>SPU</strong>：BPU 内部的 RISC-V 标量加速单元，征程 6EM 可用于实现 TopK 等算子，<strong>征程 6B 没有该硬件，仅有 APM</strong></p>
<p><strong>APM</strong>：BPU 内部另一块 RISC-V 标量加速单元，主要用于 BPU 任务调度等功能</p>
<h2 data-id="heading-2">3.征程 6 工具链简介</h2>
<h3 data-id="heading-3">3.1 模块架构图</h3>
<p><img src="http://openwrite.cn/uploads/19742/59443/84d44aa3-9ca6-4d7b-b21e-73eed5341ee4.png" alt="image.png" loading="lazy"/></p>
<p><strong>PTQ</strong>：征程 6 工具链基于 <code>horizon_tc_ui</code> 包封装的 <code>hb_compile</code> 命令行工具，提供 ONNX 模型 PTQ 全流程转换能力，其内部会先调用 <code>hmct</code> 包实现模型解析、图优化、校准功能，再调用 <code>hbdk4_compiler</code> 包实现模型的定点化和编译功能；</p>
<p><strong>QAT</strong>：征程 6 工具链基于 <code>horizon_plugin_pytorch</code> 包提供量化感知训练能力；</p>
<p><strong>HBDK</strong>：征程 6 工具链编译器，基于 <code>hbdk4_compiler</code> 包提供模型定点化、图修改、模型编译、静态 perf 等功能；</p>
<p><strong>高效模型算法包</strong>：征程 6 工具链基于 <code>horizon-torch-samples</code> 包，以源码开放形式提供了多场景参考算法，这些模型基于开源数据集训练，模型结构贴合地平线芯片进行了高效且用户友好的设计，并基于 QAT 链路实现了模型的量化转换；</p>
<p><strong>UCP</strong>：征程 6 工具链统一计算平台，通过一套统一的异构编程接口实现了对 征程 6 计算平台相关计算资源的调用，提供视觉处理、模型推理、高性能计算库、自定义算子插件开发等功能；</p>
<p><strong>AI-Benchmark</strong>：征程 6 工具链基于预编译好模型提供的嵌入式工程示例，可实现模型的性能评测和精度评测。</p>
<h3 data-id="heading-4">3.2 两套模型转换链路</h3>
<p><img src="http://openwrite.cn/uploads/19742/59443/3023172f-40fc-4c06-8c03-417e1325aff3.png" alt="image.png" loading="lazy"/></p>
<p>征程 6 工具链支持 PTQ（训练后量化）、QAT（量化感知训练）两套模型转换链路，其特性和优缺点如下：</p>
<p><strong>PTQ</strong>：基于 <code>hb_compile</code> 命令行工具转换模型，配置好 yaml、校准数据集后，可一步实现模型的图优化、校准、量化、编译全流程。​<strong>该量化方式快捷易用，但仅基于数学统计方式的离线量化不利于模型迭代，且可能会触发难以解决的 corner case</strong>​，因此在量产项目中通常用于早期评测和简单模型的量化。</p>
<p><strong>QAT</strong>：在 PyTorch 开源框架上，基于 <code>plugin</code> 插件的形式提供模型量化能力，并调用 <code>hbdk</code> 编译器的 API 实现模型的定点化和编译。该链路支持模型校准后进一步的 finetune 训练，虽然上手难度和训练成本都较高，​<strong>但精度上限也更高，更利于模型迭代优化</strong>​，是量产项目中的更优选择。</p>
<h3 data-id="heading-5">3.3 工具链推荐使用流程</h3>
<p>鉴于两条量化链路的特性，我们建议的工具链使用流程如下：
<img src="http://openwrite.cn/uploads/19742/59443/a43e1ccb-89fb-4712-8546-e7eece421719.png" alt="image.png" loading="lazy"/></p>
<p><strong>Step1</strong>：先导出浮点 ONNX 模型（opset10～19），并基于 PTQ 链路进行快速的模型结构验证，全 int8 性能上限验证；若该性能符合预期，则可以精调 PTQ，若最终精度/精度都可同时满足预期，则可进行板端部署。</p>
<p><strong>Step2</strong>：如果遇到 PTQ 无法解决的精度 corner case，则需要转到 QAT 链路进行量化。依然建议先进行模型结构验证和全 int8 性能上限验证；若该性能符合预期，则优先在全 int16 配置下将精度训练至符合预期，然后再降低 int16 比例，实现 int8/int16/fp16 混合精度下的性能/精度调优，最后进行板端部署。</p>
<p>在以上推荐链路中：</p>
<p>PTQ 链路的模型结构验证和标准量化，可在 X86 端参考本文 4.2 节使用 <code>hb_compile</code> 命令行工具；</p>
<p>模型性能分析和验证，可在 X86 端参考本文 6.4 节《静态 perf》使用 <code>hbm_perf</code> 接口生成 html 分析文件，可在板端参考本文 8.2.1 节使用 <code>hrt_model_exec</code> 工具；</p>
<p>模型推理，可在 X86 端参考用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fptq%2Fptq_tool%2Fhbruntime.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ptq/ptq_tool/hbruntime.html" ref="nofollow noopener noreferrer">训练后量化-PTQ 转换工具-HBRuntime 推理库</a>》，可在板端参考本文第 8 章《模型板端部署》使用 UCP 推理接口；</p>
<p>模型性能/精度调优，请见后续文章的详细介绍。</p>
<h2 data-id="heading-6">4.PTQ 链路</h2>
<h3 data-id="heading-7">4.1 模型转换流程</h3>
<p><img src="http://openwrite.cn/uploads/19742/59443/5f1bc48b-20b3-41de-9440-6431df6e4b6a.png" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">4.2 hb_compile 工具</h3>
<p><code>hb_compile</code> 为 PTQ 模型转换的命令行工具，支持以下 3 种使用方式：</p>
<p><img src="http://openwrite.cn/uploads/19742/59443/078b7de3-c703-4452-ad08-f89f8ba17c5f.png" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">4.3 PTQ 模型产出物</h3>



































<table><thead><tr><th><strong>original_float.onnx</strong></th><th>浮点</th><th>对 Caffe1.0 模型进行解析，转成 ONNX</th></tr></thead><tbody><tr><td><strong>optimized_float.onnx</strong></td><td>浮点</td><td>图优化，例如 BN 融合到 Conv</td></tr><tr><td><strong>calibrated.onnx</strong></td><td>伪量化</td><td>插入校准节点，并基于校准数据计算统计到每个节点的量化参数</td></tr><tr><td><strong>ptq.onnx</strong></td><td>查表算子定点 + 其他算子伪量化</td><td>将查表算子定点化</td></tr><tr><td><strong>quantized.bc</strong></td><td>定点</td><td>整个模型定点化，并转换为地平线 hbir 中间表达</td></tr><tr><td><strong>hbm</strong></td><td>指令集</td><td>经过编译后的最终部署模型</td></tr></tbody></table>
<h3 data-id="heading-10">4.4 PTQ 精度配置方法</h3>
<p>在 config.yaml 中，支持通过 json 的方式配置 ​<strong>全局</strong>​、​<strong>某类算子</strong>​、​<strong>某个子图</strong>​、<strong>某个节点 ​</strong>的计算精度，可根据 BPU 算子支持约束进行配置。</p>
<pre><code class="hljs language-Plain" lang="Plain"># 校准参数组
calibration_parameters:
  quant_config: './quant_config.json'
</code></pre>
<h3 data-id="heading-11">4.5 PTQ 精度调优流程</h3>
<p>请参考用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fptq%2Fptq_usage%2Faccuracy_tune.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ptq/ptq_usage/accuracy_tune.html" ref="nofollow noopener noreferrer">训练后量化-PTQ 转换步骤-模型精度调优</a>》和《训练后量化-PTQ 转换步骤-精度调优实战》章节。</p>
<h2 data-id="heading-12">5.QAT 链路</h2>
<h3 data-id="heading-13">5.1 模型转换流程</h3>
<p><img src="http://openwrite.cn/uploads/19742/59443/eaadb6db-c995-494c-b37a-f3970fac4b90.png" alt="image.png" loading="lazy"/></p>
<p><strong>浮点模型改造​</strong>：在模型前插入 QuantStub、在模型后插入 DequantStub，用于识别模型首尾部，剥离前后处理</p>
<p><strong>模型校准</strong>：通过在模型中插入 Observer 的方式，在 forward 过程中统计各处的数据分布，以计算出量化参数</p>
<p>部分模型仅通过 Calibration 便可满足精度要求，则无需进行 QAT，可直接编译模型用于部署</p>
<p>即使 Calibration 无法满足精度要求，也可降低后续 QAT 难度，缩短训练时间，提升最终训练精度</p>
<p><strong>量化感知训练</strong>：进一步通过训练的方式微调模型参数，如果 Calibration 精度较好，则推荐固定激活 scale</p>
<p>JIT-STRIP：使用 hook 和 subclass tensor 的方式感知图结构，在原有 forward 上做算子替换/算子融合等操作，并且会根据模型中 QuantStub 和 DequantStub 的位置识别并跳过前后处理</p>
<p>优点：全自动，代码修改少，屏蔽了很多细节问题，便于 debug</p>
<p>缺点：动态代码块仍需要特殊处理</p>
<h3 data-id="heading-14">5.2 QAT 精度配置方法</h3>
<p>请见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13112" target="_blank" title="https://developer.horizon.auto/blog/13112" ref="nofollow noopener noreferrer">【地平线 J6 工具链入门教程】QAT 新版 qconfig 量化模板使用教程</a>。</p>
<h3 data-id="heading-15">5.3 QAT 精度调优流程</h3>
<p><strong>整体调优流程：</strong></p>
<p>征程 6B 区别于征程 6E/M 来说浮点算子（fp16）的支持能力更多，但是由于没有 vpu，因此不高优推荐 fp16 调优，仍建议沿用。
<img src="http://openwrite.cn/uploads/19742/59443/66fa477b-078d-4b92-85c7-945ab281d6e3.png" alt="image.png" loading="lazy"/></p>
<p><strong>fp16 配置方式：</strong></p>
<p>QAT 新版 qconfig 量化模板使用教程见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F13112" target="_blank" title="https://developer.horizon.auto/blog/13112" ref="nofollow noopener noreferrer">developer.horizon.auto/blog/13112</a></p>
<pre><code class="hljs language-Plain" lang="Plain">my_qconfig_setter=QconfigSetter(
    reference_qconfig=get_qconfig(observer=MSEObserver),
    templates=[
        ModuleNameTemplate({ "":qint16,}),
        ModuleNameTemplate({"quant":torch.float16}),
        ...        
        ],
        save_dir="./work_dir",
    )
</code></pre>
<p>需要注意，由于征程 6B 没有 vpu，fp16 算子的使用可能会引入 cpu 的 quant、dequant 算子。建议尽量少的配 FP 16，避免性能损失。</p>
<h2 data-id="heading-16">6.模型导出/定点化/编译</h2>
<h3 data-id="heading-17">6.1 PTQ 链路</h3>
<p>该流程封装在 <code>hb_compile</code> 中，相关参数通过 yaml 进行配置。若自行调用编译器接口执行，参考代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">import onnx
from hbdk4.compiler.onnx import export
from hbdk4.compiler import convert, save, compile

# 经过PTQ校准得到的伪量化onnx模型，非线性的查表算子已定点
ptq_model = onnx.load("xxx_ptq_model.onnx")    

# 导出查表算子定点+其他算子伪量化的hbir模型
qat_bc = export(ptq_model)
save(qat_bc, "qat.bc")

# 导出全定点hbir模型
quantized_bc = convert(qat_bc, "nash-b")
save(quantized_bc, "quantized.bc")

# 编译生成hbm模型
compile(
    m=quantized_bc, 
    path="model.hbm", 
    opt=2, 
    march="nash-b", 
    progress_bar=True,
    input_no_padding=True,
    output_no_padding=True
)
</code></pre>
<h4 data-id="heading-18">6.1.1 输入/输出去 padding</h4>
<p>模型在 BPU 上推理时，其输入和输出节点的内存大小和数据存放规则需满足硬件对齐要求。</p>
<p><strong>内存对齐</strong>：申请的内存大小需满足某个字节数的整数倍，</p>
<p><strong>跨距对齐</strong>：跨距（Stride）是指数据存储在内存中时，每一行所占空间的实际大小，当对齐到某个字节数的整数倍后，硬件即可高效处理。该对齐的操作又叫 Padding，实际的对齐规则取决于具体的软硬件系统。假设一份 NHWC 为 1x20x30x1 的 int8 数据，若硬件要求跨距 W32 对齐，那么每一行 W 都将 Padding 2 个字节。</p>
<p>征程 6 工具链支持在 <code>compile</code> 接口中传入 <code>input_no_padding</code>、<code>output_no_padding</code> 参数来控制是否使用 BPU 自动完成 padding 对齐操作。开启后用户即可不关心 BPU 跨距对齐要求，无需手动 Padding，数据可连续存储在内存中。该特性可优化模型输入/输出的 IO 负载，但也有微小概率会引入性能的小幅下降，所以是否开启该功能请在您的模型上实际验证，并请在模型编译和板端部署环节统一跨距对齐的处理策略。</p>
<h3 data-id="heading-19">6.2 QAT 链路</h3>
<p>QAT 链路的模型定点化和编译直接调用如上的编译器接口，模型导出额外封装了一层，参考代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">from horizon_plugin_pytorch.quantization.hbdk4 import export

def export(
    model: nn.Module,
    example_inputs: Any,
    name: str = "forward",
    input_names: Optional[Any] = None,    # 建议在模型导出时就配置好输入输出节点名称
    output_names: Optional[Any] = None,
    input_descs: Optional[Any] = None,
    output_descs: Optional[Any] = None,
    native_pytree: bool = True,
) -&gt; Module
</code></pre>
<h3 data-id="heading-20">6.3 模型修改</h3>
<p>编译器支持在 hbir 上进行多 batch 拆分、插入数据前处理、算子删除、调整输入输出 layout 等修改操作，其主要应用场景如下：</p>
<p><strong>多 batch 拆分</strong>：典型场景是 BEV 模型在部署时，多 V 输入来源于不同的摄像头，其数据在内存中独立存储，因此模型可将其多 V 输入沿 batch 维度做拆分；</p>
<p><strong>数据前处理</strong>：征程 6 工具链支持在模型前端插入一个前处理节点，以实现颜色空间转换（如 NV12—&gt; BGR）、数据归一化（<code>(data-mean)/std</code>），和 Resizer 功能（从大图上抠图 + Resize），并可由 BPU 进行加速；</p>
<p><strong>算子删除</strong>：征程 6 工具链支持将模型首尾部的 Quantize、Dequantize、Cast、Reshape、Transpose 等算子删除，以适配更加灵活的部署方案；</p>
<p><strong>调整输入输出 layout</strong>：模型首尾部除了支持删除 Reshape、Transpose 节点外，还支持插入 Transpose 节点，用户可灵活调整其 layout 排布。</p>
<p>以下参考代码对一个多输入模型实现了多 batch 输入拆分、图像输入的色彩空间转换、数据归一化、Resizer 功能：</p>
<pre><code class="hljs language-Plain" lang="Plain">from hbdk4.compiler import load, convert

qat_bc = load("qat.bc")  
func = qat_bc[0]
batch_input = ["input_name1"]   # 需要使用独立地址方式部署的输入节点名称列表
resizer_input = ["resize"]      # 部署时数据来源于resizer的输入节点名称列表
pyramid_input = ["pym"]         # 部署时数据来源于pyramid的输入节点名称列表

def channge_source(input, source):
    node = input.insert_transpose(permutes=[0, 3, 1, 2])
    node = node.insert_image_preprocess(mode="yuvbt601full2bgr", divisor=1, mean=[128, 128, 128], std=[128, 128, 128])
    if source == "pyramid":
        node.insert_image_convert("nv12")          
    elif source == "resizer":
        node.insert_roi_resize("nv12")

for input in func.inputs[::-1]:
    if input.name in batch_input:
        origin_name = input.name
        split_inputs = input.insert_split(dim=0)
        for split_input in reversed(split_inputs):
            if origin_name in pyramid_input:
                channge_source(split_input, "pyramid")
            elif origin_name in resizer_input:
                channge_source(split_input, "resizer")
</code></pre>
<h3 data-id="heading-21">6.4 静态 perf</h3>
<p>对于编译好的 hbm，编译器支持在 X86 端对其 BPU 部分进行静态性能预估，执行以下命令即可生成一个 html 文件，包含模型预估性能、带宽、内存占用、BPU 内部单帧执行时序图等信息。</p>
<pre><code class="hljs language-Plain" lang="Plain">from hbdk4.compiler import hbm_perf
hbm_perf(model="xxx.hbm", output_dir="./")
</code></pre>
<h2 data-id="heading-22">7.浮点能力使用</h2>
<h3 data-id="heading-23">7.1 TAE 张量输出，VAE 向量计算支持浮点</h3>
<p>征程 6B BPU 的 TAE 张量计算单元支持 FP16/FP32 输出，VAE 向量计算单元支持 FP16 计算。但在实际部署中仍需综合评估后再使用，具体原因如下：</p>
<p><strong>精度</strong>：FP16 并非在所有情况下都优于 INT16，通常情况下数值范围小时 FP16 更优，数值范围大时 INT16 更优，但也需要考虑数值较小或较大部分的误差对模型输出的影响程度。所以量化精度是否使用 FP16，更建议基于精度 Debug 的分析结果来确定；</p>
<p><strong>性能</strong>：除 Reduce 性能为 INT16 的 1/2 外，其他算子的 FP16 性能和 INT16 性能持平</p>
<p><strong>额外开销</strong>：虽然 FP16 算子本身无需量化，但上下游算子如果涉及 FP16 &lt;—&gt; INT16 的数据转换，则会引入量化/反量化：</p>
<p>虽然该节点可以由 VAE 硬件直接支持，但相比于全 INT16 直接串接仍会有额外的性能、带宽开销；</p>
<p>新引入的量化或反量化节点的 Scale 需要重新校准/QAT 训练得到。</p>
<h3 data-id="heading-24">7.2 无 VPU 加速量化/反量化</h3>
<p>相比于 征程 6EM 计算平台，征程 6B 无 VPU 硬件加速模型首尾部的量化/反量化节点，但支持 Gemm 类算子直接 FP32 输出，其他 INT8/INT16 输出节点的反量化，则更建议使用编译器接口将其从 quantized.bc 上移除，并参考该篇文章（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.horizon.auto%2Fblog%2F10424" target="_blank" title="https://developer.horizon.auto/blog/10424" ref="nofollow noopener noreferrer">反量化节点的融合实现</a>）将其融合进前后处理代码中，以减少一次数据遍历的冗余开销。</p>
<pre><code class="hljs language-Plain" lang="Plain">from hbdk4.compiler import load

quantized_bc = load("quantized.bc")
quantized_bc[0].remove_io_op(op_types=["Quantize", "Dequantize"])
</code></pre>
<h3 data-id="heading-25">7.3 无 SPU，标量计算能力有限</h3>
<p>相比于 征程 6 其他计算平台，征程 6B 的标量计算单元算力减少，因此 TopK 等标量算子的部署性能需要综合评估后选择合适方案。</p>
<h2 data-id="heading-26">8.模型板端部署</h2>
<h3 data-id="heading-27">8.1 UCP 简介</h3>
<p>UCP（Unify Compute Platform，统一计算平台）定义了一套统一的异构编程接口， 将 SOC 上的功能硬件抽象出来并进行封装，对外提供基于功能的 API 进行调用。UCP 提供的具体功能包括：​<strong>视觉处理</strong>​（Vision Process）、​<strong>神经网络模型推理</strong>​（Neural Network）、​<strong>高性能计算库</strong>​（High Performance Library）、​<strong>自定义算子插件开发</strong>​。</p>
<p><img src="http://openwrite.cn/uploads/19742/59443/723349cb-c241-4612-859f-594123989d06.png" alt="image.png" loading="lazy"/></p>
<p>UCP 支持的 Backend 如下：
<img src="http://openwrite.cn/uploads/19742/59443/19bd1039-5d83-4358-bde4-dd9d664eb1fc.png" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-28">8.2 快速上手</h3>
<p>使用 UCP 推理模型的基本代码参考如下，详细信息可参考用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fruntime%2Fruntime_dev.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/runtime/runtime_dev.html" ref="nofollow noopener noreferrer">统一计算平台-模型推理开发</a>》、《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fmodel_deployment_guidance%2Fmodel_deployment_guidance_examples%2Frgb_resnet18_deployment_guidance.html" target="_blank" title="https://doc.oe.horizon.auto/guide/model_deployment_guidance/model_deployment_guidance_examples/rgb_resnet18_deployment_guidance.html" ref="nofollow noopener noreferrer">模型部署实践指导-模型部署实践指导实例</a>》、《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fucp%2Fucp_api_reference%2Fucp_api_overview.html" target="_blank" title="https://docs.oe.horizon.auto/guide/ucp/ucp_api_reference/ucp_api_overview.html" ref="nofollow noopener noreferrer">UCP 通用 API 介绍</a>》等相关章节。</p>
<pre><code class="hljs language-Plain" lang="Plain">// 1. 加载模型并获取模型名称列表以及Handle
{
    hbDNNInitializeFromFiles(&amp;packed_dnn_handle, &amp;modelFileName, 1);
    hbDNNGetModelNameList(&amp;model_name_list, &amp;model_count, packed_dnn_handle);
    hbDNNGetModelHandle(&amp;dnn_handle, packed_dnn_handle, model_name_list[0]);
}

// 2. 根据模型的输入输出信息准备张量
std::vector&lt;hbDNNTensor&gt; input_tensors;
std::vector&lt;hbDNNTensor&gt; output_tensors;
int input_count = 0;
int output_count = 0;
{
    hbDNNGetInputCount(&amp;input_count, dnn_handle);
    hbDNNGetOutputCount(&amp;output_count, dnn_handle);
    input_tensors.resize(input_count);
    output_tensors.resize(output_count);
    prepare_tensor(input_tensors.data(), output_tensors.data(), dnn_handle);
}

// 3. 准备输入数据并填入对应的张量中
{
    read_data_2_tensor(input_data, input_tensors);
    // 确保更新输入后进行Flush操作以确保BPU使用正确的数据
    for (int i = 0; i &lt; input_count; i++) {
      hbUCPMemFlush(&amp;input_tensors[i].sysMem, HB_SYS_MEM_CACHE_CLEAN);
    }
}

// 4. 创建任务并进行推理
{
    // 创建任务
    hbDNNInferV2(&amp;task_handle, output_tensors.data(), input_tensors.data(), dnn_handle)
    
    // 提交任务
    hbUCPSchedParam sched_param;
    HB_UCP_INITIALIZE_SCHED_PARAM(&amp;sched_param);
    sched_param.backend = HB_UCP_BPU_CORE_ANY;
    hbUCPSubmitTask(task_handle, &amp;sched_param);
    
    // 等待任务完成
    hbUCPWaitTaskDone(task_handle, 0);
}

// 5. 处理输出数据
{
    // 确保处理输出前进行Flush操作以确保读取的不是缓存中的脏数据
    for (int i = 0; i &lt; output_count; i++) {
      hbUCPMemFlush(&amp;output_tensors[i].sysMem, HB_SYS_MEM_CACHE_INVALIDATE);
    }
    // 对输出进行后处理操作
}

// 6. 释放资源
{
    // 释放任务
    hbUCPReleaseTask(task_handle);
    // 释放输入内存
    for (int i = 0; i &lt; input_count; i++) {
      hbUCPFree(&amp;(input_tensors[i].sysMem));
    }
    // 释放输出内存
    for (int i = 0; i &lt; output_count; i++) {
      hbUCPFree(&amp;(output_tensors[i].sysMem));
    }
    // 释放模型
    hbDNNRelease(packed_dnn_handle);
}
</code></pre>
<h4 data-id="heading-29">8.2.1 hrt_model_exec 工具</h4>
<p>为了方便用户快速查看 hbm 和 quantized.bc 的模型信息、进行模型单帧推理和性能评测，征程 6 工具链 UCP 提供了 <code>hrt_model_exec</code> 工具，并支持编译 X86、aarch64（aarch64 仅支持 hbm 推理）两个架构下的可执行程序。</p>
<p>hrt_model_exec 的三种使用方法如下：</p>
<pre><code class="hljs language-Plain" lang="Plain"># 设置环境变量
# arch代表架构类型，aarch64或x86
arch=aarch64
bin=../$arch/bin/hrt_model_exec
lib=../$arch/lib/
export LD_LIBRARY_PATH=${lib}:${LD_LIBRARY_PATH}

# 获取模型信息
${bin} model_info --model_file=xxx.hbm

# 模型单帧推理
${bin} infer --model_file=xxx.hbm --input_file=xxx.bin

# 模型性能评测-Latency(单线程)
${bin} perf --model_file=xxx.hbm --thread_num 1 --frame_count=1000

# 模型性能评测-FPS(多线程)
${bin} perf --model_file=xxx.hbm --thread_num 8 --frame_count=1000
</code></pre>
<h3 data-id="heading-30">8.3 图像输入动态 shape/stride</h3>
<p>在 征程 6 芯片的视频通路上，有一块叫 Pyramid 的金字塔硬件处理模块，可提供 Camera 输入图像的缩放及 ROI 抠图能力，其输出为 nv12 类型的图像数据，并可基于共享内存机制直接给到 BPU 进行模型推理。因此在 征程 6 工具链中：</p>
<ol>
<li>Pyramid 模型指的是具有 nv12 图像输入的模型；</li>
<li>Resizer 模型指的是具有 nv12 图像输入和 ROI 输入的模型，编译器支持通过 JIT 动态指令的方式，从 nv12 图像上完成 ROI 抠图 + Resize 的功能。</li>
</ol>
<p>在 征程 6 工具链中，Pyramid 的输入 stride 为动态，Resizer 模型的 stride 和 shape 都是动态。如下为 mobilenetv1 编译后的模型信息：
<img src="http://openwrite.cn/uploads/19742/59443/58fced0e-364c-4019-95fd-730d8d9b7896.png" alt="image.png" loading="lazy"/>
hrt_model_exec model_info 板端可执行程序工具</p>
<p><img src="http://openwrite.cn/uploads/19742/59443/75071b3d-fa56-4930-a50d-4d99fded8704.png" alt="image.png" loading="lazy"/></p>
<p>其中，-1 为占位符，表示为动态，Pyramid 输入的 stride 为动态；Resizer 输入的 H、W、stride 均为动态。</p>
<ul>
<li>Resizer 输入的 ​<strong>HW 动态</strong>​，是因为原始输入的大小可以是任意的；</li>
<li>Pyramid/Resizer 输入的​<strong>​ stride 动态</strong>​，可以理解为是支持 ​<strong>Crop 功能</strong>​，详细内容可参考用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fruntime%2Fbasic_sample.html%23crop" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/runtime/basic_sample.html#crop" ref="nofollow noopener noreferrer">统一计算平台-模型推理开发-基础示例包使用说明-advanced_samples-crop</a>》</li>
</ul>
<h3 data-id="heading-31">8.4 非图像 tensor 内存对齐</h3>
<p>对于非图像 tensor，征程 6B 要求 128 对齐，征程 6EM 要求内存 64 对齐，征程 6PH 要求 256 对齐。如上图所示，模型输出节点虽然 stride[0] 为 4000，但需要申请的 BPU 内存大小（aligned byte size）为 4096，即为 128 对齐的结果。</p>
<p>在模型实际部署中，非图像输入/输出节点所需申请的内存大小（ aligned byte size）均可从模型节点属性的结构体中读取到（<code>hbDNNTensorProperties</code>），因此无需特别关注。</p>
<h3 data-id="heading-32">8.5 图像 tensor 跨距对齐</h3>
<p>征程 6EMB 对于 Pyramid/Resizer 模型的图像输入，要求 W32 对齐，征程 6PH 要求 W64 对齐。若您有 征程 6 不同架构平台迁移的场景，请注意跨距对齐要求的差异。</p>
<p>部署代码建议您避免 hard code，推荐基于模型节点属性中的 validShape（张量有效内容尺寸）和 stride（张量各维度步长）进行解析和使用。</p>
<h4 data-id="heading-33">8.5.1 Pyramid 输入</h4>
<p>Pyramid 输入 tensor 准备的参考代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">hbDNNTensor *input = input_tensor;
for (int i = 0; i &lt; input_count; i++) {
HB_CHECK_SUCCESS(
    hbDNNGetInputTensorProperties(&amp;input[i].properties, dnn_handle, i),
    "hbDNNGetInputTensorProperties failed");
    
    auto dim_len = input[i].properties.validShape.numDimensions;    // 获取维度信息
    for (int32_t dim_i = dim_len - 1; dim_i &gt;= 0; --dim_i) {
      if (input[i].properties.stride[dim_i] == -1) {                // stride=-1即为动态
        auto cur_stride =                                           // 计算当前维度stride
            input[i].properties.stride[dim_i + 1] *
            input[i].properties.validShape.dimensionSize[dim_i + 1];
        input[i].properties.stride[dim_i] = ALIGN_32(cur_stride);   // 32对齐
      }
    }

    int input_memSize = input[i].properties.stride[0] *             // 计算内存大小
                        input[i].properties.validShape.dimensionSize[0];
    HB_CHECK_SUCCESS(hbUCPMallocCached(&amp;input[i].sysMem[0], input_memSize, 0),
                     "hbUCPMallocCached failed");
    
    const char *input_name;
    HB_CHECK_SUCCESS(hbDNNGetInputName(&amp;input_name, dnn_handle, i),    // 获取节点名称
                     "hbDNNGetInputName failed");
}
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-Plain" lang="Plain">ucp_tutorial/dnn/basic_samples/code/00_quick_start/resnet_nv12/src/main.cc
</code></pre>
<p>​<strong>注意</strong>​：</p>
<p>视频通路上的金字塔硬件，其输出层支持配置 y、uv 的 stride，但仅要求 W16 对齐，若数据需要喂给 BPU 推理模型，建议直接按 BPU 的跨距对齐要求来配置。金字塔硬件的更多信息请参考系统软件用户手册。</p>
<h4 data-id="heading-34">8.5.2 Resizer 输入</h4>
<p>Resizer 输入的 H、W 也是动态的，因此需要设置为原图尺寸，并计算好 W32 对齐的 Stride；ROI 作为模型输入节点，也需要对其进行赋值。以下为参考代码：</p>
<pre><code class="hljs language-Plain" lang="Plain">#define ALIGN(value, alignment) (((value) + ((alignment)-1)) &amp; ~((alignment)-1))
#define ALIGN_32(value) ALIGN(value, 32)

int prepare_image_tensor(const std::vector&lt;hbUCPSysMem&gt; &amp;image_mem, int input_h,
                         int input_w, hbDNNHandle_t dnn_handle,
                         std::vector&lt;hbDNNTensor&gt; &amp;input_tensor) {
  // 准备Y、UV输入tensor
  for (int i = 0; i &lt; 2; i++) {
    HB_CHECK_SUCCESS(hbDNNGetInputTensorProperties(&amp;input_tensor[i].properties,
                                                   dnn_handle, i),
                     "hbDNNGetInputTensorProperties failed");
    // auto w_stride = ALIGN_32(input_w);
    // int32_t y_mem_size = input_h * w_stride;
    input_tensor[i].sysMem[0] = image_mem[i];

    // 配置原图大小，NHWC
    input_tensor[i].properties.validShape.dimensionSize[1] = input_h;
    input_tensor[i].properties.validShape.dimensionSize[2] = input_w;
    if (i == 1) {
      // UV输入大小为Y的1/2
      input_tensor[i].properties.validShape.dimensionSize[1] /= 2;
      input_tensor[i].properties.validShape.dimensionSize[2] /= 2;
    }

    // stride满足32对齐
    input_tensor[i].properties.stride[1] =
        ALIGN_32(input_tensor[i].properties.stride[2] *
                 input_tensor[i].properties.validShape.dimensionSize[2]);
    input_tensor[i].properties.stride[0] =
        input_tensor[i].properties.stride[1] *
        input_tensor[i].properties.validShape.dimensionSize[1];
  }
  return 0;
}

// 准备roi输入tensor
int prepare_roi_tensor(const hbUCPSysMem *roi_mem, hbDNNHandle_t dnn_handle,
                       int32_t roi_tensor_id, hbDNNTensor *roi_tensor) {
  HB_CHECK_SUCCESS(hbDNNGetInputTensorProperties(&amp;roi_tensor-&gt;properties,
                                                 dnn_handle, roi_tensor_id),
                   "hbDNNGetInputTensorProperties failed");
  roi_tensor-&gt;sysMem[0] = *roi_mem;
  return 0;
}

int prepare_roi_mem(const std::vector&lt;hbDNNRoi&gt; &amp;rois,
                    std::vector&lt;hbUCPSysMem&gt; &amp;roi_mem) {
  auto roi_size = rois.size();
  roi_mem.resize(roi_size);
  for (auto i = 0; i &lt; roi_size; ++i) {
    int32_t mem_size = 4 * sizeof(int32_t);
    HB_CHECK_SUCCESS(hbUCPMallocCached(&amp;roi_mem[i], mem_size, 0),
                     "hbUCPMallocCached failed");
    int32_t *roi_data = reinterpret_cast&lt;int32_t *&gt;(roi_mem[i].virAddr);
    roi_data[0] = rois[i].left;
    roi_data[1] = rois[i].top;
    roi_data[2] = rois[i].right;
    roi_data[3] = rois[i].bottom;
    hbUCPMemFlush(&amp;roi_mem[i], HB_SYS_MEM_CACHE_CLEAN);
  }
  return 0;
}
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-Plain" lang="Plain">ucp_tutorial/dnn/basic_samples/code/02_advanced_samples/roi_infer/src/roi_infer.cc
</code></pre>
<h3 data-id="heading-35">8.6 小模型批量处理功能</h3>
<p>由于 BPU 是资源独占式硬件，所以对于 Latency 很小的模型而言，其框架调度开销占比会相对较大。在 征程 6 平台，UCP 支持通过复用 task_handle 的方式，将多个小模型任务一次性下发，全部执行完成后再一次性返回，从而可将 N 次框架调度开销合并为 1 次，以下为参考代码：</p>
<pre><code class="hljs language-Plain" lang="Plain">// 获取模型指针并存储
std::vector&lt;hbDNNHandle_t&gt; model_handles;

// 准备各个模型的输入输出，准备过程省略
std::vector&lt;std::vector&lt;hbDNNTensor&gt;&gt; inputs;
std::vector&lt;std::vector&lt;hbDNNTensor&gt;&gt; outputs;

// 创建任务并进行推理
{
    // 创建并添加任务，复用task_handle
    hbUCPTaskHandle_t task_handle{nullptr};
    for(size_t task_id{0U}; task_id &lt; inputs.size(); task_id++){
        hbDNNInferV2(&amp;task_handle, outputs[task_id].data(), inputs[task_id].data(), model_handles[i]);
    }
    
    // 提交任务
    hbUCPSchedParam sche_param;
    HB_UCP_INITIALIZE_SCHED_PARAM(&amp;sche_param);
    sche_param.backend = HB_UCP_BPU_CORE_ANY;
    hbUCPSubmitTask(task_handle, &amp;sche_param);
    
    // 等待任务完成
    hbUCPWaitTaskDone(task_handle, 0);
}
</code></pre>
<h3 data-id="heading-36">8.7 优先级调度/抢占</h3>
<p>UCP 支持任务优先级调度和抢占，可通过 <code>hbUCPSchedParam</code> 结构体进行配置，其中：</p>
<ul>
<li><code>priority</code> &gt; <code>customId</code> &gt; submit_time（任务提交时间）</li>
<li><code>priority</code> 支持 [0， 255]，对于模型任务而言：</li>
</ul>
<p>[0， 253] 为普通优先级，不可抢占其他任务，但在未执行时支持按优先级进行排队</p>
<p>254 为 high 抢占任务，可支持抢占普通任务</p>
<p>255 为 urgent 抢占任务，可抢占普通任务和 high 抢占任务</p>
<p>可被中断抢占的低优任务，需要在模型编译阶段配置 <code>max_time_per_fc</code> 参数拆分模型指令</p>
<ul>
<li>其他 backend 任务，priority 支持 [0， 255]，但不支持抢占，可以认为都是普通优先级</li>
</ul>
<h3 data-id="heading-37">8.8 X86 仿真</h3>
<p>征程 6 工具链在 X86 端支持 hbm 指令仿真，但效率非常低，所以更推荐使用 quantized.bc 模型进行推理，其定点部分和 hbm 数值二进制一致，浮点部分可能存在架构本身差异，但通常对精度影响可忽略不计。</p>
<p>征程 6B 平台 X86 仿真需要配置如下环境变量，默认架构为"nash-m"：</p>
<p>export HB_UCP_SIM_PLATFORM_TYPE=nash-b</p>
<h4 data-id="heading-38">8.8.1 推理 quantized.bc</h4>
<p><strong>Python 推理：</strong></p>
<p>quantized.bc 在 X86 端的推理，可以使用 <code>horizon_tc_ui</code> 包封装的 <code>HBRuntime</code> 接口，具体可见用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fptq%2Fptq_tool%2Fhbruntime.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ptq/ptq_tool/hbruntime.html" ref="nofollow noopener noreferrer">训练后量化-PTQ 转换工具-HBRuntime 推理库</a>》，参考代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">import numpy as np
from horizon_tc_ui.hb_runtime import HBRuntime

sess = HBRuntime("quantized.bc")
input_names = sess.input_names
output_names = sess.output_names

data1 = np.load("input1.npy")
data2 = np.load("input2.npy")
input_feed = {input_names[0]: data1, input_names[1]: data2}

output = sess.run(output_names, input_feed)
</code></pre>
<p>quantized.bc 也可以直接调用其 func 的 feed 接口进行推理，其输入格式也为 dict，value 支持 torch.tensor 和 np.array 两种类型，输出格式与输入格式保持一致。参考代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">import numpy as np
from hbdk4.compiler import load

hbir = load("quantized.bc")
func = hbir[0]

data1 = np.load("input1.npy")
data2 = np.load("input2.npy") 
input_feed = {inputs[0].name: data1, inputs[1].name: data2}
hbir_outputs = func.feed(input_feed)
</code></pre>
<p><strong>C++ 推理：</strong></p>
<p>quantized.bc 的 C++ 推理接口复用 hbm UCP 推理接口，仅 so 动态库需要替换成 X86 版本即可。 您也可以在 X86 端使用 <code>hrt_model_exec</code> 工具对 quantized.bc 进行模型信息查看和单帧推理。</p>
<h4 data-id="heading-39">8.8.2 推理 hbm</h4>
<p>由于 X86 端 hbm 推理为指令仿真，运行速度非常慢，因此工具链提供了 <code>hbm_infer</code> 工具以便用户在服务器端给直连的开发板下发推理任务。本文只介绍最简单的单进程使用方式，多进程、多阶段模型输入输出的传输优化，以及统计模型推理、网络传输耗时等功能请参考用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fucp%2Fruntime%2Ftool_introduction%2Fhbm_infer.html" target="_blank" title="https://docs.oe.horizon.auto/guide/ucp/runtime/tool_introduction/hbm_infer.html" ref="nofollow noopener noreferrer">hbm_infer 工具介绍</a>》。</p>
<pre><code class="hljs language-Plain" lang="Plain"># hbm也可传入一个list，推理时通过指定model_name来选择推理哪个模型，推理所用的.so即可只传输一次
hbm_model = HbmRpcSession(
    host="xx.xx.xx.xx",
    local_hbm_path="xx.hbm", 
)

# 打印模型输入输出信息
hbm_model.show_input_output_info()

# 准备输入数据
input_data = {
    'img': torch.ones((1, 3, 224, 224), dtype=torch.int8)
}

# 执行推理并返回结果
# 若传入的是list，需要正确指定model_name
# output_data = hbm_model(input_data, model_name=model_name)
output_data = hbm_model(input_data) 

print([output_data[k].shape for k in output_data])

# 关闭server
hbm_model.close_server()
</code></pre>
<h2 data-id="heading-40">9.UCP 视觉处理/高性能算子</h2>
<p>除模型推理外，UCP 还提供了视觉处理和高性能算子两大方向的多种算子接口，可支持诸如 Remap、Jpeg、H264/265、FFT/IFF 等功能，这些算子底层是基于地平线 SOC 上不同硬件 IP 进行的封装，并提供统一的调用接口。</p>
<p>更多信息可参考用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fucp_overview.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/ucp_overview.html" ref="nofollow noopener noreferrer">统一计算平台</a>》的相关章节。</p>
<p><strong>注意：</strong></p>
<ol>
<li>板端实际部署时，ISP 到 Pyramid 的视频通路不建议使用 UCP，无法实现数据 Online，建议直接调用底软接口进行功能实现。</li>
<li>基于 DSP Backend 实现的 HPL 算子，在 征程 6B 平台仅会提供 征程 6EM 上 Q8 实现的源码，如需在 征程 6B 上使用 HPL 算子，需要您自行适配 V130 并编译镜像。VP 算子和 SLAM 等 征程 6EM 上已有的 Q8 DSP sample，将在 征程 6B 后续正式版本中提供 V130 版本。</li>
</ol>
<h2 data-id="heading-41">10.UCP 自定义算子（DSP）</h2>
<p>为了简化用户开发，UCP 封装了一套基于 RPC 的开发框架，来实现 CPU 对 DSP 的功能调用，但具体 DSP 算子实现仍是调用 Cadence 接口去做开发。总体来说可分为三个步骤：</p>
<p>使用 Cadence 提供的工具及资料完成算子开发；</p>
<pre><code class="hljs language-Plain" lang="Plain">int test_custom_op(void *input, void *output, void *tm) {
  // custom impl
  return 0;
}
</code></pre>
<p>DSP 侧通过 UCP 提供的 API 注册算子，编译带自定义算子的镜像；</p>
<pre><code class="hljs language-Plain" lang="Plain">// dsp镜像中注册自定义算子
hb_dsp_register_fn(cmd, test_custom_op, latency)
</code></pre>
<p>ARM 侧通过 UCP 提供的算子调用接口，完成开发板上的部署使用。</p>
<pre><code class="hljs language-Plain" lang="Plain">// 将输入输出的hbUCPSysMem映射为DSP可访问的内存地址
hbUCPSysMem in;
hbUCPMalloc(&amp;in, in_size, 0)
hbDSPAddrMap(&amp;in, &amp;in)

hbUCPSysMem out;
hbUCPMalloc(&amp;out, out_size, 0)
hbDSPAddrMap(&amp;out, &amp;out)

// 创建并提交DSP任务
hbUCPTaskHandle_t taskHandle{nullptr};
hbDSPRpcV2(&amp;taskHandle, &amp;in, &amp;out, cmd)

hbUCPSchedParam ctrl_param;
HB_UCP_INITIALIZE_SCHED_PARAM(&amp;ctrl_param);
ctrl_param.backend = HB_UCP_DSP_CORE_ANY;
hbUCPSubmitTask(task_handle, &amp;ctrl_param);

// 等待任务完成
hbUCPWaitTaskDone(task_handle, 0);
</code></pre>
<p>更多信息可见用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fplugin%2Fdsp_develop%2Fdsp_intro.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/plugin/dsp_develop/dsp_intro.html" ref="nofollow noopener noreferrer">统一计算平台-自定义算子-DSP 算子开发</a>》。</p>
<h2 data-id="heading-42">11.性能监测工具</h2>
<p>征程 6 平台 BPU、DSP 都是独占的硬件资源，任务一旦提交就会独占推理，UCP 侧仅能通过 <code>hrt_ucp_monitor</code> 工具去监测其硬件占用率（采样频率支持配置 [10， 1000]，默认 500），并且能查看到 DDR 内存占用情况。</p>
<p><img src="http://openwrite.cn/uploads/19742/59443/5a9ecb7e-7ed0-4d6e-a605-da2b9e42c012.png" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-43">12.QNX 带来的功能裁剪</h2>
<ol>
<li><strong>UCP Service （中继模式）</strong>：
UCP 框架支持两种主要工作模式：直连模式、中继模式。系统默认运行在直连模式下，在中继模式下，UCP 将支持跨进程任务优先级的统一调度。但 QNX 上跨进程调度的模型性能较差，不满足使用需求，故功能移除。</li>
<li><strong>UCP Trace</strong>： UCP trace 通过在 UCP 执行的关键路径上嵌入 trace 记录，提供深入分析 UCP 应用程序调度逻辑的能力。在出现性能异常时，可以通过分析 UCP trace，快速找到异常发生的时间点。但 QNX 底软不支持 Trace 功能，故移除。</li>
<li><strong>DEB 部署包</strong>： 用于简化板端部署，可通过自动安装所需的二进制文件和相关依赖库，快速设置并运行 UCP 相关的应用程序，具体包括：<code>ucp_service</code> 和 <code>hrt_ucp_monitor</code>。但鉴于 <code>ucp_service</code> 不支持，该功能也移除。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[凌晨突袭！GPT-5.3-Codex手撕代码，OpenAI让AI开始造AI了]]></title>    <link>https://juejin.cn/post/7603567912592244763</link>    <guid>https://juejin.cn/post/7603567912592244763</guid>    <pubDate>2026-02-06T12:18:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603567912592244763" data-draft-id="7603567912592228379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="凌晨突袭！GPT-5.3-Codex手撕代码，OpenAI让AI开始造AI了"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-02-06T12:18:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            凌晨突袭！GPT-5.3-Codex手撕代码，OpenAI让AI开始造AI了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T12:18:49.000Z" title="Fri Feb 06 2026 12:18:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在这个2026年2月的寒冷清晨，科技圈的很多开发者大概又是被手机震醒的。</p>
<p>就在几个小时前，硅谷上演了一场经典的“神仙打架”。Anthropic前脚刚发布Claude Opus 4.6，OpenAI后脚就甩出了GPT-5.3-Codex。相差不过几分钟，但这不仅仅是巧合，更是两条路线的正面硬刚。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F02%2Fdfasgfdg.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/02/dfasgfdg.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64a23f1d5ea94e17ab0ba545b561ebe9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770985128&amp;x-signature=wNOaZHJxg%2F6CiXtoHR11MneXyxs%3D" alt="dfasgfdg" loading="lazy"/></a></p>
<p>如果你还以为这只是又一次常规的模型升级，只是写代码稍微快一点，那你就大错特错了。根据目前流出的各路评测和媒体报道，OpenAI这次没打算和你聊“聊天机器人”，他们直接把“全能智能体”摆上了桌面。</p>
<h3 data-id="heading-0">不只是写代码，它是你的硅谷合伙人</h3>
<p>很长一段时间里，我们在使用Copilot或者ChatGPT时，心里是有预期的：它是个助手，我得盯着它，因为这货随时可能胡言乱语。</p>
<p>但GPT-5.3-Codex的定位彻底变了。它不再满足于当你敲代码时的自动补全工具，它想接管你的整个工作流。</p>
<p>现在的它，能从头到尾干完一套活：写代码、自己调试、跑单元测试、去终端环境里配置服务器，甚至最后还能帮你把产品文档（PRD）和PPT写好。以前我们说AI是“副驾驶”，现在的感觉是，它想坐主驾驶位，你只要在旁边喝咖啡喊口号就行。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F02%2Fadgdfg-1024x566.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/02/adgdfg-1024x566.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6aabe2dd9394ec0b6589bb5ef1ae38f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770985128&amp;x-signature=9uwL013SoX6Guj0tCSaXh%2FDye7c%3D" alt="adgdfg" loading="lazy"/></a></p>
<p>这种底气来自哪里？看看数据就知道了。</p>
<p>在Terminal-Bench 2.0这个专门测试终端操作和环境配置的考场上，GPT-5.3-Codex拿下了77.3%的高分。作为对比，上一代还在64%徘徊。这意味着在面对那些让人头秃的黑框命令行时，它的表现已经不仅是“能用”，而是“精通”。</p>
<p>更杀人诛心的是，有数据显示，在这一项上它比隔壁同期发布的Claude Opus 4.6高出了将近12个百分点。虽然Claude在长文本推理上依然强悍，但在这种还要动手干脏活累活的工程能力上，OpenAI这次确实秀了一把肌肉。</p>
<h3 data-id="heading-1">快，而且省</h3>
<p>对于企业主和开发者来说，性能强固然好，但“贵”是原罪。</p>
<p>这次更新最让我感到意外的，不是它能考多少分，而是它的效率。根据测试，GPT-5.3-Codex在完成同等复杂度的任务时，消耗的Token数量直接砍半。与此同时，推理速度提升了25%。</p>
<p>这意味着什么？意味着它的废话变少了，直击痛点的能力变强了。以前你得跟AI来回拉扯十几个回合才能修好的Bug，现在可能三两下就解决了。这不仅仅是省钱，更是省命——毕竟谁也不想在大半夜陪AI玩猜谜游戏。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F02%2Fagdfgfdgh.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/02/agdfgfdgh.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d745f35db4541be884def24363679bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770985128&amp;x-signature=1c0QZ4OsHu7gjR4STWnTgAriGPY%3D" alt="agdfgfdgh" loading="lazy"/></a></p>
<p>还有一个非常人性化的改进：<strong>实时引导</strong>。以前的任务是“离手不管”，你发了指令就得干等结果。现在你可以像指导坐在你工位旁的实习生一样，中间随时插嘴：“不对，这个方向错了，换个库试试。”这种交互模式的改变，才是真正让AI融入团队的关键。</p>
<p><strong>细思极恐的“自我迭代”</strong></p>
<p>整场发布会最让我起鸡皮疙瘩的，其实是OpenAI轻描淡写透露的一句话：</p>
<h3 data-id="heading-2">这是首个参与了自身开发过程的模型。</h3>
<p>没错，OpenAI的工程师们在训练GPT-5.3-Codex时，已经在使用它的早期版本来调试训练流程、管理部署甚至诊断问题了。</p>
<p>这听起来很像科幻电影的开场白，AI开始通过自我递归来加速进化。虽然目前还需要人类把控方向，但这层窗户纸捅破后，技术迭代的速度可能会超出我们的线性认知。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F02%2Frthfgfg.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/02/rthfgfg.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebf86829561649b19d34d702cf0a604a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770985128&amp;x-signature=l1e0yYeB%2F4ppf4I3JXTnSDnp5mo%3D" alt="rthfgfg" loading="lazy"/></a></p>
<p>当然，能力越强，风险越大。OpenAI这次也很谨慎，因为这东西的网络攻击能力也被评定为“高”。所以API接口暂时没开，目前只有ChatGPT的付费用户（Plus、Team、Enterprise）可以通过Codex应用、命令行工具（CLI）或IDE插件尝鲜。为了安抚安全界，他们还专门掏了1000万美元搞防御研究。</p>
<h3 data-id="heading-3">写在最后</h3>
<p>看着手中这份新鲜出炉的报告，我的感觉很复杂。</p>
<p>一方面，作为工具使用者，GPT-5.3-Codex带来的生产力释放是诱人的。它能帮我们搞定那些繁琐的文档、讨厌的环境配置和无穷无尽的单元测试。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F02%2Fasdffgdfg.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/02/asdffgdfg.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fcb3aadcd13456eb61c44223fe99ba7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770985128&amp;x-signature=J3YR3XL549SN0wYvFKShNxM2sAw%3D" alt="asdffgdfg" loading="lazy"/></a></p>
<p>另一方面，作为从业者，我们也清晰地看到了门槛的提升。当AI已经能熟练操作操作系统、能自我Debug甚至能优化自己的时候，“写代码”这项技能本身的护城河，正在被以前所未有的速度填平。</p>
<p>2026年的春天，比以往来得更早一些，也更猛烈一些。各位，准备好迎接这位新同事了吗？</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Debian 12 环境下 PostgreSQL 15 部署与安全配置]]></title>    <link>https://juejin.cn/post/7603321550247641138</link>    <guid>https://juejin.cn/post/7603321550247641138</guid>    <pubDate>2026-02-06T12:22:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603321550247641138" data-draft-id="7603321550247624754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Debian 12 环境下 PostgreSQL 15 部署与安全配置"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T12:22:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HBLOG"/> <meta itemprop="url" content="https://juejin.cn/user/131597124767479"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Debian 12 环境下 PostgreSQL 15 部署与安全配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597124767479/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HBLOG
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T12:22:24.000Z" title="Fri Feb 06 2026 12:22:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>1. 系统安装</p>
<p>Debian 12 官方仓库已包含 PostgreSQL 15。</p>
<pre><code class="hljs language-sql" lang="sql">sudo apt <span class="hljs-keyword">update</span>
sudo apt install postgresql postgresql<span class="hljs-operator">-</span>contrib <span class="hljs-operator">-</span>y
</code></pre>
<p>2. 防火墙配置 (UFW)</p>
<p>确保系统防火墙放行数据库默认端口 <strong>5432</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">sudo ufw allow 5432/tcp
sudo ufw reload
</code></pre>
<p>3. 数据库权限管理</p>
<p>直接在终端调用 <code>psql</code> 管理器创建环境：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 以 postgres 管理员身份进入</span>
sudo -u postgres psql

<span class="hljs-comment"># --- SQL 执行区域 ---</span>
<span class="hljs-comment"># 1. 创建用户并设密码</span>
CREATE USER myuser WITH PASSWORD 'your_password'<span class="hljs-comment">;</span>

<span class="hljs-comment"># 2. 创建数据库并指定归属</span>
CREATE DATABASE mydatabase OWNER myuser<span class="hljs-comment">;</span>

<span class="hljs-comment"># 3. 授予所有权限</span>
GRANT ALL PRIVILEGES ON DATABASE mydatabase TO myuser<span class="hljs-comment">;</span>

<span class="hljs-comment"># 退出</span>
\q
</code></pre>
<p>4. 开启外部连接 (核心配置)</p>
<p>默认情况下，PostgreSQL 只允许本机 <code>127.0.0.1</code> 访问。若要远程连接，需修改两个配置文件。</p>
<p>A. 修改监听地址</p>
<p>使用 GNU Nano 编辑器 修改主配置：</p>
<pre><code class="hljs language-bash" lang="bash">sudo nano /etc/postgresql/15/main/postgresql.conf
</code></pre>
<p>找到以下行，取消注释并将 <code>localhost</code> 改为 <code>*</code>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">listen_addresses</span> = <span class="hljs-string">'*'</span>
</code></pre>
<p>B. 修改访问策略</p>
<p>修改基于主机的身份验证文件：</p>
<pre><code class="hljs language-bash" lang="bash">sudo nano /etc/postgresql/15/main/pg_hba.conf
</code></pre>
<p>在文件末尾添加以下行（允许所有 IP 使用 MD5 密码认证）：</p>
<pre><code class="hljs language-css" lang="css">host    <span class="hljs-attribute">all</span>             <span class="hljs-attribute">all</span>             <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">0</span>               md5
</code></pre>
<p>C. 重启服务</p>
<pre><code class="hljs">sudo systemctl restart postgresql
</code></pre>
<p><strong>建议步骤：</strong> 你现在可以使用 <strong>Navicat</strong> 或 <strong>DBeaver</strong> 尝试连接。如果连接失败，请检查是否漏掉了 <strong>5432</strong> 端口的放行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin中的JvmPackageName注解]]></title>    <link>https://juejin.cn/post/7603563317040218175</link>    <guid>https://juejin.cn/post/7603563317040218175</guid>    <pubDate>2026-02-06T12:26:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603563317040218175" data-draft-id="7603581886149427254" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin中的JvmPackageName注解"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-02-06T12:26:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin中的JvmPackageName注解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T12:26:08.000Z" title="Fri Feb 06 2026 12:26:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>@JvmPackageName 是 Kotlin 中的一个文件级注解（File-level Annotation），用于自定义 Kotlin 文件中的顶层声明（函数、属性等）在 JVM 平台上生成的类所在的包名。</p>
<p>其核心作用是突破 Kotlin 文件 package 语句的限制，让同一文件中的顶层声明在 JVM 中生成到不同的包路径下，从而更灵活地组织代码结构或适配已有的 Java 包结构。</p>
<h2 data-id="heading-0">背景与问题场景</h2>
<p>Kotlin 的顶层声明（如顶层函数、属性）在编译为 JVM 字节码时，默认会被放入一个与 Kotlin 文件 package 语句一致的类中（类名由 @file:JvmName 或默认规则 文件名 + "Kt" 决定）。例如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// File: com/example/utils/StringUtils.kt</span>
<span class="hljs-keyword">package</span> com.example.utils  <span class="hljs-comment">// Kotlin 文件的包名</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEmpty</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span> = str.isEmpty()
</code></pre>
<p>编译后，该函数的 JVM 类为 com.example.utils.StringUtilsKt（假设未使用 @file:JvmName），包名与 Kotlin 文件的 package 完全一致。</p>
<p>但实际开发中可能需要：</p>
<p>• 让 Kotlin 顶层声明生成的 JVM 类放入与 Kotlin 文件 package 不同的路径（如适配已有的 Java 包结构）；</p>
<p>• 同一 Kotlin 文件中的不同顶层声明生成到不同的 JVM 包（尽管这种情况较少见）。</p>
<p>此时，默认的包名规则无法满足需求，@JvmPackageName 应运而生。</p>
<h2 data-id="heading-1">核心作用</h2>
<p>通过 @JvmPackageName 注解，可以显式指定当前 Kotlin 文件中的顶层声明在 JVM 中生成的类的包名，覆盖 Kotlin 文件 package 语句的默认行为。</p>
<h2 data-id="heading-2">使用方式与示例</h2>
<h3 data-id="heading-3">基本用法：覆盖文件包名</h3>
<p>在 Kotlin 文件顶部使用 @file:JvmPackageName 注解，指定目标 JVM 包名（需包含完整包路径）。该注解需放在 package 语句之前。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// File: src/kotlin/com/example/utils/StringUtils.kt</span>
<span class="hljs-meta">@file:JvmPackageName</span>(<span class="hljs-string">"com.example.java.utils"</span>)  <span class="hljs-comment">// 指定 JVM 包名为 com.example.java.utils</span>
<span class="hljs-keyword">package</span> com.example.utils  <span class="hljs-comment">// Kotlin 文件的包名（仅为 Kotlin 代码的组织，不影响 JVM 包名）</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEmpty</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span> = str.isEmpty()

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isBlank</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span> = str.isBlank()
</code></pre>
<p>编译后效果：</p>
<p>Kotlin 顶层函数 isEmpty 和 isBlank 会被编译到 JVM 类 com.example.java.utils.StringUtilsKt（类名仍由默认规则或 @file:JvmName 决定），而非 com.example.utils.StringUtilsKt。</p>
<p>Java 调用方式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 直接通过目标 JVM 包名访问，无需关心 Kotlin 文件的 package 语句</span>
<span class="hljs-keyword">import</span> com.example.java.utils.StringUtilsKt;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">empty</span> <span class="hljs-operator">=</span> StringUtilsKt.isEmpty(<span class="hljs-string">"test"</span>);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">blank</span> <span class="hljs-operator">=</span> StringUtilsKt.isBlank(<span class="hljs-string">"  "</span>);
    }
}
</code></pre>
<h3 data-id="heading-4">与 @file:JvmName 配合使用</h3>
<p>@JvmPackageName 通常与 @file:JvmName 配合使用，同时自定义 JVM 类的包名和类名，完全控制顶层声明在 JVM 中的定位。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// File: src/kotlin/utils/LegacyUtils.kt</span>
<span class="hljs-meta">@file:JvmPackageName</span>(<span class="hljs-string">"com.legacy.api"</span>)       <span class="hljs-comment">// 自定义 JVM 包名</span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"OldStringUtils"</span>)             <span class="hljs-comment">// 自定义 JVM 类名（替代默认的 LegacyUtilsKt）</span>
<span class="hljs-keyword">package</span> com.kotlin.<span class="hljs-keyword">internal</span>                  <span class="hljs-comment">// Kotlin 文件的包名（仅用于 Kotlin 代码组织）</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">trimAndUpper</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span> = str.trim().uppercase()
</code></pre>
<p>编译后效果：</p>
<p>函数 trimAndUpper 对应的 JVM 类为 com.legacy.api.OldStringUtils（包名由 @JvmPackageName 指定，类名由 @file:JvmName 指定）。</p>
<p>Java 调用方式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.legacy.api.OldStringUtils;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> OldStringUtils.trimAndUpper(<span class="hljs-string">"  hello  "</span>); <span class="hljs-comment">// 输出 "HELLO"</span>
    }
}
</code></pre>
<h2 data-id="heading-5">关键注意事项</h2>
<ol>
<li>
<p>注解位置限制：@file:JvmPackageName 是文件级注解，必须放在 Kotlin 文件的最顶部（package 语句之前），否则会编译报错。</p>
</li>
<li>
<p>包名格式要求：value 参数需传入完整的 JVM 包名（如 "com.example.utils"），不能省略包路径或使用相对路径。</p>
</li>
<li>
<p>与 package 语句的关系：Kotlin 文件的 package 语句仅用于 Kotlin 代码内部的组织（如导入、可见性），不影响 JVM 类的包名；@JvmPackageName 才是 JVM 包名的决定因素。</p>
</li>
<li>
<p>避免包名冲突：自定义的 JVM 包名不能与项目中其他类（包括 Java 类和 Kotlin 类）的包名重复，否则会导致类加载冲突。</p>
</li>
<li>
<p>适用范围：@JvmPackageName 仅对当前文件的顶层函数、顶层属性生效，类、对象、伴生对象等声明仍遵循其自身的 package 语句（或 @JvmPackageName 若在类上标注时的规则，不过类通常不使用此注解）。</p>
</li>
</ol>
<h2 data-id="heading-6">典型应用场景</h2>
<p>• 适配已有 Java 包结构：当需要将 Kotlin 编写的工具函数集成到已有的 Java 项目中，且 Java 项目要求工具类必须位于特定包路径（如 com.company.common.utils）时，可用 @JvmPackageName 强制 Kotlin 顶层声明生成到该路径。</p>
<p>• 隔离 Kotlin 与 Java 包结构：Kotlin 项目希望内部代码按一种包结构组织（如 com.kotlin.feature），但对外提供的 JVM 接口需按另一种结构暴露（如 com.api.v1），此时可通过 @JvmPackageName 解耦。</p>
<p>• 避免类名冲突：当多个 Kotlin 文件因文件名相似导致默认生成的 JVM 类名冲突时（如 StringUtils.kt 和 StringUtils_Ext.kt 均生成 StringUtilsKt 和 StringUtils_ExtKt），可通过 @JvmPackageName 将它们分配到不同的 JVM 包中。</p>
<h2 data-id="heading-7">总结</h2>
<p>@JvmPackageName 是 Kotlin 为 JVM 平台提供的精细化包名控制工具，通过覆盖 Kotlin 文件 package 语句的默认行为，让顶层声明在 JVM 中生成到任意指定的包路径。它与 @file:JvmName 配合使用时，能完全自定义 JVM 类的定位（包名+类名），是跨语言开发中优化代码结构的重要手段。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin中的JvmField注解]]></title>    <link>https://juejin.cn/post/7603352117640003593</link>    <guid>https://juejin.cn/post/7603352117640003593</guid>    <pubDate>2026-02-06T12:41:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352117640003593" data-draft-id="7603376587652546610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin中的JvmField注解"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2026-02-06T12:41:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin中的JvmField注解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T12:41:47.000Z" title="Fri Feb 06 2026 12:41:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>@JvmField 是 Kotlin 中的一个注解（Annotation），用于将 Kotlin 类中的属性（Property）直接暴露为 JVM 平台的字段（Field），而不是默认的 getter/setter 方法。</p>
<p>其核心作用是消除 Kotlin 属性访问器与 Java 字段访问之间的差异，让 Kotlin 属性在 Java 中调用时更符合 Java 开发者的直觉（直接访问字段而非方法）。</p>
<h2 data-id="heading-0">背景：Kotlin 属性的默认 JVM 表现</h2>
<p>在 Kotlin 中，属性（如 var name: String 或 val age: Int）本质上由以下部分组成：</p>
<p>• 幕后字段（Backing Field）：存储属性值的实际字段（仅在需要时生成）。</p>
<p>• 访问器（Accessor）：getter（读取值）和 setter（设置值，仅 var 有）方法。</p>
<p>默认情况下，Kotlin 属性在 JVM 中会被编译为：</p>
<p>• 对于 val（只读属性）：生成一个 getXxx() 方法（如 getName()）。</p>
<p>• 对于 var（可变属性）：生成 getXxx() 和 setXxx() 方法（如 getName() 和 setName()）。</p>
<p>这种设计符合 Kotlin 的封装原则，但与 Java 中直接访问字段的习惯（如 obj.name）不一致。此时，@JvmField 注解可改变这一默认行为。</p>
<h2 data-id="heading-1">@JvmField 的作用</h2>
<p>@JvmField 的核心目标是让 Kotlin 属性在 JVM 中表现为一个公共字段（Public Field），而非 getter/setter 方法。具体表现为：</p>
<p>• Java 代码可直接通过 对象.字段名 访问属性值（如同访问 Java 类的公共字段）。</p>
<p>• 不再生成默认的 getter/setter 方法（除非显式定义）。</p>
<h2 data-id="heading-2">使用场景与示例</h2>
<h3 data-id="heading-3">标注在类的属性上（非私有、非 const）</h3>
<p>@JvmField 可用于标注类的普通属性（val 或 var），使其暴露为 JVM 字段。需注意：属性必须是非私有（public 或包级可见）且非 const（const val 本身已生成静态字段，无需 @JvmField）。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-comment">// 普通 var 属性：默认生成 getName()/setName()</span>
    <span class="hljs-meta">@JvmField</span> <span class="hljs-comment">// 暴露为 JVM 字段（无 getter/setter）</span>
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">"Unknown"</span>
    
    <span class="hljs-comment">// 普通 val 属性：默认生成 getAge()</span>
    <span class="hljs-meta">@JvmField</span> <span class="hljs-comment">// 暴露为 JVM 字段（无 getter）</span>
    <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">18</span>
}
</code></pre>
<p>Java 调用效果：</p>
<pre><code class="hljs language-java" lang="java">Java 代码可直接访问字段，无需调用 getter/setter：  
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
user.name = <span class="hljs-string">"Alice"</span>;  <span class="hljs-comment">// 直接赋值（等效于 Kotlin 的 user.setName("Alice")）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> user.name;  <span class="hljs-comment">// 直接读取（等效于 Kotlin 的 user.getName()）</span>
<span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> user.age;  <span class="hljs-comment">// 直接读取（等效于 Kotlin 的 user.getAge()）</span>
</code></pre>
<p>若不添加 @JvmField，Java 需通过 getter/setter 访问：</p>
<pre><code class="hljs language-java" lang="java">user.setName(<span class="hljs-string">"Alice"</span>);  <span class="hljs-comment">// 必须调用 setter</span>
<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> user.getName();  <span class="hljs-comment">// 必须调用 getter</span>
</code></pre>
<h3 data-id="heading-4">标注在伴生对象的属性上</h3>
<p>伴生对象（companion object）中的属性默认在 JVM 中属于伴生对象的 Companion 类（如 User.Companion.getStaticName()）。</p>
<p>使用 @JvmField 可将伴生对象的属性暴露为宿主类的静态字段（如同 Java 的 static final 字段）。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 普通伴生属性：默认生成 Config.Companion.getDefaultPort()</span>
        <span class="hljs-meta">@JvmField</span> <span class="hljs-comment">// 暴露为 Config.DEFAULT_PORT（静态字段）</span>
        <span class="hljs-keyword">val</span> DEFAULT_PORT: <span class="hljs-built_in">Int</span> = <span class="hljs-number">8080</span>
        
        <span class="hljs-comment">// const val 本身已生成静态字段（无需 @JvmField）</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> VERSION: String = <span class="hljs-string">"1.0"</span>
    }
}
</code></pre>
<p>Java 调用效果：</p>
<pre><code class="hljs language-java" lang="java">Java 可直接通过宿主类访问静态字段：  
<span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> Config.DEFAULT_PORT;  <span class="hljs-comment">// 直接访问（等效于 Kotlin 的 Config.DEFAULT_PORT）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> Config.VERSION;  <span class="hljs-comment">// const val 本身已是静态字段</span>
</code></pre>
<p>若不添加 @JvmField，Java 需通过伴生对象的 Companion 类访问：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> Config.Companion.getDefaultPort();  <span class="hljs-comment">// 需通过 Companion</span>
</code></pre>
<h3 data-id="heading-5">标注在顶层属性上</h3>
<p>顶层属性（不在任何类或对象中定义的属性）默认被编译到 文件名 + "Kt" 类中（如 AppConfig.kt 生成 AppConfigKt 类），并通过 getter/setter 访问。使用 @JvmField 可将其暴露为 文件名 + "Kt" 类的静态字段。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 文件：AppConfig.kt</span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"AppConfig"</span>) <span class="hljs-comment">// 自定义 JVM 类名为 AppConfig（可选）</span>

<span class="hljs-comment">// 顶层属性：默认生成 AppConfigKt.getBaseUrl()</span>
<span class="hljs-meta">@JvmField</span> <span class="hljs-comment">// 暴露为 AppConfig.BASE_URL（静态字段）</span>
<span class="hljs-keyword">val</span> BASE_URL: String = <span class="hljs-string">"https://api.example.com"</span>
</code></pre>
<p>Java 调用效果：</p>
<pre><code class="hljs language-java" lang="java">Java 可直接通过自定义的类名访问静态字段：  
<span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> AppConfig.BASE_URL;  <span class="hljs-comment">// 直接访问（等效于 Kotlin 的 BASE_URL）</span>
</code></pre>
<p>若不添加 @JvmField，Java 需通过 AppConfigKt 类的 getter 访问：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> AppConfigKt.getBaseUrl();  <span class="hljs-comment">// 需通过 Kt 类</span>
</code></pre>
<h3 data-id="heading-6">标注在枚举类的属性上</h3>
<p>枚举常量的属性默认通过 getter 访问（如 Color.RED.getHex()）。使用 @JvmField 可将其暴露为枚举常量的字段，便于 Java 直接访问。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Color</span>(<span class="hljs-keyword">val</span> hex: String) {
    RED(<span class="hljs-string">"#FF0000"</span>),
    GREEN(<span class="hljs-string">"#00FF00"</span>);

    <span class="hljs-comment">// 枚举常量的属性：默认生成 getHex()</span>
    <span class="hljs-meta">@JvmField</span> <span class="hljs-comment">// 暴露为 RED.hex（字段）</span>
    <span class="hljs-keyword">val</span> hexCode: String = hex
}
</code></pre>
<p>Java 调用效果：</p>
<pre><code class="hljs language-java" lang="java">Java 可直接访问枚举常量的字段：  
<span class="hljs-type">String</span> <span class="hljs-variable">redHex</span> <span class="hljs-operator">=</span> Color.RED.hexCode;  <span class="hljs-comment">// 直接访问（等效于 Kotlin 的 Color.RED.hexCode）</span>
</code></pre>
<p>若不添加 @JvmField，Java 需通过 getter 访问：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">redHex</span> <span class="hljs-operator">=</span> Color.RED.getHexCode();  <span class="hljs-comment">// 需调用 getter</span>
</code></pre>
<h2 data-id="heading-7">关键注意事项</h2>
<ol>
<li>
<p>访问权限限制：被 @JvmField 标注的属性必须是非私有的（public 或包级可见）。私有属性（private）无法被 Java 直接访问，即使添加 @JvmField 也会被忽略（编译报错）。</p>
</li>
<li>
<p>不可与自定义访问器共存：若属性显式定义了自定义的 getter/setter（如 get() = ... 或 set(value) { ... }），则不能使用 @JvmField（编译报错）。因为 @JvmField 要求属性直接暴露为字段，而自定义访问器会覆盖默认行为，导致冲突。</p>
</li>
<li>
<p>val 与 var 的差异：</p>
<p>• val（只读属性）+ @JvmField：暴露为 JVM 的 final 字段（Java 中不可修改）。</p>
<p>• var（可变属性）+ @JvmField：暴露为 JVM 的非 final 字段（Java 中可修改）。</p>
</li>
<li>
<p>与 const val 的区别：const val 用于编译期常量（如 const val MAX_SIZE = 100），默认生成 JVM 的 public static final 字段，无需 @JvmField。@JvmField 主要用于运行时常量或非 const 属性。</p>
</li>
<li>
<p>线程安全问题：直接暴露为字段的属性（尤其是 var）在多线程环境下可能存在并发修改风险，需自行保证线程安全（如加锁或使用原子类）。</p>
</li>
</ol>
<h2 data-id="heading-8">典型应用场景</h2>
<p>• Java 互操作：当 Kotlin 类需要被 Java 频繁访问属性时（如配置类、数据模型），使用 @JvmField 可简化 Java 代码（避免调用 getter/setter）。</p>
<p>• 性能优化：直接访问字段比调用方法更快（尤其在高频场景下），适合对性能敏感的场景（如游戏引擎、实时系统）。</p>
<p>• 枚举或常量类：枚举常量的属性或配置常量通过 @JvmField 暴露为字段，更符合 Java 开发者的使用习惯。</p>
<h2 data-id="heading-9">总结</h2>
<p>@JvmField 是 Kotlin 与 JVM 平台互操作的重要注解，通过将 Kotlin 属性直接暴露为 JVM 字段，消除了 getter/setter 方法的调用开销，提升了跨语言代码的可读性和性能。合理使用 @JvmField 可使 Kotlin 代码在 Java 中调用时更自然、更高效，但需注意其使用限制（如非私有、无自定义访问器等）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[打造 GitHub 仓库智能推荐系统]]></title>    <link>https://juejin.cn/post/7603556326816120884</link>    <guid>https://juejin.cn/post/7603556326816120884</guid>    <pubDate>2026-02-06T12:41:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603556326816120884" data-draft-id="7603355275258478632" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="打造 GitHub 仓库智能推荐系统"/> <meta itemprop="keywords" content="GitHub,人工智能,开源"/> <meta itemprop="datePublished" content="2026-02-06T12:41:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gorse"/> <meta itemprop="url" content="https://juejin.cn/user/2682464100417854"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            打造 GitHub 仓库智能推荐系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464100417854/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gorse
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T12:41:40.000Z" title="Fri Feb 06 2026 12:41:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>为了测试和展示 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgorse-io%2Fgorse" target="_blank" title="https://github.com/gorse-io/gorse" ref="nofollow noopener noreferrer">Gorse 推荐系统</a>的基本功能，博主打造了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitrec.gorse.io" target="_blank" title="https://gitrec.gorse.io" ref="nofollow noopener noreferrer">GitRec</a>——专门为 GitHub 仓库设计的推荐系统。这个项目既可以展示 Gorse 的基本能力，也能帮助开发者们在海量的开源项目中发现有趣且有用的仓库。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitrec.gorse.io%2F%23%2F" target="_blank" title="https://gitrec.gorse.io/#/" ref="nofollow noopener noreferrer">GitRec</a> 已经运行了三年之久，但是在 2025 年针对 Gorse v0.5 进行了全面的升级和重构，本文介绍的内容均基于最新版本的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitrec.gorse.io%2F%23%2F" target="_blank" title="https://gitrec.gorse.io/#/" ref="nofollow noopener noreferrer">GitRec</a>。</p>
</blockquote>
<h2 data-id="heading-0">数据收集</h2>
<p>巧妇难为无米之炊，构建推荐系统的第一步是构造好物品、用户、反馈三种数据。</p>
<h3 data-id="heading-1">物品：GitHub 仓库</h3>
<ul>
<li><code>ItemId</code>：为了方便拼接URL，仓库名称中的<code>/</code>被替换为<code>:</code>并统一为小写。</li>
<li><code>Categories</code>：仓库的主要编程语言，用户可以使用编程语言过滤推荐结果。</li>
<li><code>Timestamp</code>：仓库的最后更新时间。</li>
<li><code>Labels</code>是由两个字段组成的JSON：
<ul>
<li><strong>话题</strong>：由仓库管理员添加的话题标签 (Topics)。</li>
<li><strong>描述的本文嵌入向量</strong>：GitRec 的一大亮点是它利用 OpenAI 的 <code>text-embedding-v3</code> 模型为每个仓库的描述（Description）生成了 512 维的向量嵌入。如果一个仓库没有描述，：GitRec 会使用 <code>gpt-5-nano</code> 大语言模型阅读其 <code>README.md</code> 文件，并生成一个单句摘要，然后再进行向量化。</li>
</ul>
</li>
</ul>
<p>以下是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgorse-io%2Fgorse" target="_blank" title="https://github.com/gorse-io/gorse" ref="nofollow noopener noreferrer">Gorse 仓库</a> 在 Gorse 中的物品记录，<code>Comment</code> 字段使用仓库描述作为备注方便后台查看。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ItemId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gorse-io:gorse"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"IsHidden"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Categories"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"go"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-05-24T19:41:09Z"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Labels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"embedding"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">-0.0913363918662071</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0101912319660187</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0.0689065530896187</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.0137317562475801</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"topics"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"recommender-system"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"collaborative-filtering"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"go"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"knn"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"machine-learning"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Comment"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Gorse open source recommender system engine"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>由于 GitHub 上的仓库数量庞大，GitRec 只收集 stars 数量超过 100 的仓库以在成本和覆盖率之间取得平衡。仓库主要由两种方式收集：</p>
<ol>
<li>每天爬取 GitHub trending 上的热门仓库。</li>
<li>接受用户反馈时，顺便将用户反馈涉及的仓库加入到物品库中。</li>
</ol>
<h3 data-id="heading-2">用户：放弃个人信息</h3>
<p>综合考虑之下，GitRec 选择不收集用户除了用户 ID 和反馈以外的任何个人信息，原因如下：</p>
<ol>
<li>GitHub 用户的个人信息非常多样化，除了公司、位置等少量结构化数据外，用户还可以在个人简介、README 文件等非结构化文本中提供信息。同时，也有非常多的用户只填写了极少量的信息甚至没有，这使得基于个人信息的推荐变得非常困难。</li>
<li>在注重隐私保护的当下，选择不收集个人信息是一个不错的选择。</li>
</ol>
<p>Gorse 中一条用户记录的<code>UserId</code>对应 GitHub 用户ID，而其他字段都为空。每当新用户登录 GitRec，系统会自动创建一条用户记录。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"UserId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zhenghaoz"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Labels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Comment"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">反馈：点赞和浏览</h3>
<p>通过 GitHub 的 API，实际上只能获取到用户对仓库的 <code>star</code> 行为，但是无法获取“已读”的行为。因此，GitRec 提供了一个浏览器插件，可以收集用户浏览仓库的记录。最终，GitRec 中的反馈定义如下：</p>
<p><strong>正向反馈</strong>：</p>
<ul>
<li><code>star</code>: 用户在 GitHub 上为一个仓库点赞。</li>
<li><code>like</code>: 用户在 GitRec 网站上::likefill::一个仓库。</li>
<li><code>read&gt;=3</code>: 用户查看一个仓库至少 3 次。</li>
</ul>
<p><strong>浏览反馈</strong>：</p>
<ul>
<li><code>read</code>: 用户查看一个仓库。</li>
</ul>
<p><code>read</code>反馈由浏览器插件收集，<code>like</code>反馈由 GitRec 网站收集，而<code>star</code>反馈通过 GitHub API 每天同步一次。<code>read</code>次数在每次用户访问仓库时累加，当次数达到 3 次时，系统会将其转换为正向反馈。</p>
<h2 data-id="heading-4">推荐流水线配置</h2>
<p>GitRec 推荐流水线的详细配置可以在仓库的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgorse-io%2Fgitrec%2Fblob%2Fmaster%2Fconfig.toml" target="_blank" title="https://github.com/gorse-io/gitrec/blob/master/config.toml" ref="nofollow noopener noreferrer">config.toml</a>文件中找到，主要内容为：</p>
<ul>
<li>非个性化推荐<code>most_starred_weekly</code>：分数由自定义公式计算，推荐本周收藏数最多的仓库。</li>
<li>物品到物品推荐<code>neighbors</code>：根据仓库描述的向量嵌入推荐相似的项目。</li>
<li>用户到物品推荐<code>neighbors</code>：推荐来自收藏仓库重叠程度较高的用户所喜欢的项目。</li>
<li>协同过滤推荐保持默认配置。</li>
</ul>
<p>排序阶段合并上述的推荐结果和最新物品后使用训练好的因子分解机进行最终排序。如果生成的推荐结果不足，会依次使用物品到物品推荐和最新物品进行补全。下图为可视化推荐流程编辑器中看到的推荐流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38fa194db8c543fd98c0e04bf48a15ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR29yc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770986500&amp;x-signature=1aVFqGD32spIpRJ%2Fj261qQ9gaz0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">用户界面和交互</h2>
<p>GitRec 通过两种方式为用户提供服务。</p>
<h3 data-id="heading-6">网站</h3>
<p>网站仿照抖音提供了一个沉浸式的仓库发现体验：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b60151aeab004f6586c541bc7d2c5cd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR29yc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770986500&amp;x-signature=bKYHMcE3%2FRMyAw94LoFpXne1xFQ%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>"发现页（Explore）</strong>：这是网站的核心功能，全屏展示仓库的 <code>README</code> 内容。你可以选择：
<ul>
<li>点击❤️按钮，这个行为会被记录为一次正向反馈。</li>
<li>点击▶️按钮，系统会将当前仓库标记为“已读”，并为你呈现下一个推荐。</li>
<li>页面上方可以选择编程语言过滤推荐结果。</li>
</ul>
</li>
<li><strong>收藏夹（Favorites）</strong>：这里包含了所有你在 GitHub 上 ⭐ 过或在 GitRec 网站上 ❤️过的仓库。</li>
</ul>
<h3 data-id="heading-7">浏览器插件</h3>
<p>浏览器插件将推荐无缝集成到 GitHub 页面中：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0af5aad4cbd7412bb8c63148481d452d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR29yc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770986500&amp;x-signature=%2F%2B1Xy1fGm6uOUxcjTkkrKbBWt1M%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>GitHub 主页的“探索”模块</strong>：在 GitHub 的主页，插件会注入一个“Explore repositories”模块，提供个性化的项目推荐。即使没有登录 GitRec，插件也能通过最近 <code>star</code> 的项目提供初步的个性化推荐。</li>
<li><strong>仓库页面的“相关仓库”</strong>：浏览任何一个 stars 超过 100的 GitHub 仓库时，插件会在页面右侧添加一个“Related repositories”栏目。这里会展示与当前仓库内容最相似的几个项目。</li>
<li><strong>浏览记录收集</strong>：插件会记录浏览过的仓库，并将这些信息发送回 GitRec 服务器，除此之外不会收集任何其他个人信息。</li>
</ul>
<h2 data-id="heading-8">规模和成本</h2>
<p>到 2025 年底，GitRec 的数据规模如下：</p>
<ul>
<li>超过 24 万个 GitHub 仓库</li>
<li>超过 3000 名注册用户</li>
<li>超过 30 万条用户反馈记录</li>
</ul>
<p>Gorse 推荐系统以及数据库部署在一台 2 核 CPU、8GB 内存的云服务器上，花费330人民币/月。</p>
<h2 data-id="heading-9">总结</h2>
<p>GitRec 不仅仅是一个 GitHub 仓库推荐系统，更是 Gorse 推荐系统的试验场。欢迎使用 GitRec <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitrec.gorse.io" target="_blank" title="https://gitrec.gorse.io" ref="nofollow noopener noreferrer">网站</a> 或安装浏览器插件（支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fchromewebstore.google.com%2Fdetail%2Fgitrec%2Feihokbaeiebdenibjophfipedicippfl" target="_blank" title="https://chromewebstore.google.com/detail/gitrec/eihokbaeiebdenibjophfipedicippfl" ref="nofollow noopener noreferrer">Chrome</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Faddons.mozilla.org%2Fzh-CN%2Ffirefox%2Faddon%2Fgitrec%2F" target="_blank" title="https://addons.mozilla.org/zh-CN/firefox/addon/gitrec/" ref="nofollow noopener noreferrer">Firefox</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fmicrosoftedge.microsoft.com%2Faddons%2Fdetail%2Fgitrec%2Fcpcfbfpnagiffgpmfljmcdokmfjffdpa" target="_blank" title="https://microsoftedge.microsoft.com/addons/detail/gitrec/cpcfbfpnagiffgpmfljmcdokmfjffdpa" ref="nofollow noopener noreferrer">Edge</a>），助力 Gorse 推荐系统的持续开发。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[心流不是天赋，是环境设计：一个程序员被低效折磨后的自救实验]]></title>    <link>https://juejin.cn/post/7603359026711904266</link>    <guid>https://juejin.cn/post/7603359026711904266</guid>    <pubDate>2026-02-06T12:48:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603359026711904266" data-draft-id="7603352117639987209" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="心流不是天赋，是环境设计：一个程序员被低效折磨后的自救实验"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-02-06T12:48:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="loonggg"/> <meta itemprop="url" content="https://juejin.cn/user/1750078239286167"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            心流不是天赋，是环境设计：一个程序员被低效折磨后的自救实验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1750078239286167/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    loonggg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T12:48:06.000Z" title="Fri Feb 06 2026 12:48:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我发现一个很有意思的现象：很多程序员都说自己最高效的时间是深夜。</p>
<p>不是因为深夜更聪明，而是因为深夜更“安静”。没有会议、没有消息轰炸、没有突然的需求变更。你终于可以沉下心来，进入那种“忘记时间”的状态。</p>
<p>这种状态有个专业名词，叫“心流”(Flow)。</p>
<p>心理学家米哈里·契克森米哈赖（Mihaly Csikszentmihalyi）研究了几十年，发现心流状态有几个特征：</p>
<ul>
<li>
<p>你完全专注于当前任务</p>
</li>
<li>
<p>时间感消失（一抬头发现过了 3 小时）</p>
</li>
<li>
<p>你感觉“刚好够难，但又能搞定”</p>
</li>
<li>
<p>你进入了一种“自动驾驶”的高效模式</p>
</li>
</ul>
<p>对程序员来说，心流就是那种“代码如流水般写出来”的状态。你不需要刻意思考每一行，整个逻辑在脑子里已经成型，手指只是在把它“翻译”出来。</p>
<p>但问题是：这种状态太难进入了，而且太容易被打断。</p>
<h2 data-id="heading-0">一、心流的三大杀手：为什么你总是“进不去”？</h2>
<p>我观察了很多程序员朋友，包括我自己，发现心流被打断通常来自三个层面：</p>
<h3 data-id="heading-1">1、外部干扰：环境不允许你专注</h3>
<p>最明显的杀手是“被打断”。</p>
<p>一个消息弹窗、一个同事过来问问题、一个突然的会议通知。每一次打断，你都需要重新“加载”之前的上下文。研究表明，被打断后平均需要 23 分钟才能重新进入深度工作状态。</p>
<p>但还有一种更隐蔽的干扰：环境噪音。</p>
<p>不是说你旁边有人在吵架，而是那种“低烈度的持续刺激”。空调的嗡嗡声、键盘的敲击声、显示器的轻微闪烁、办公室的日光灯。这些东西你可能意识不到，但你的大脑一直在处理它们，消耗着你的注意力预算。</p>
<h3 data-id="heading-2">2、视觉疲劳：你的眼睛在“抗议”</h3>
<p>程序员一天盯屏幕的时间，少说也有 8 小时。</p>
<p>但你有没有发现，写了 2-3 小时代码后，你会莫名其妙地“不想看屏幕”？不是累，是一种“视觉上的抵触”。</p>
<p>这不是你的问题，是屏幕的问题。</p>
<p>大多数显示器的色温、亮度、对比度，都是按照“通用场景”调校的，看视频、浏览网页、处理文档。但编程是一种极其特殊的场景：</p>
<ul>
<li>
<p>你需要长时间盯着高对比度的文本（黑底白字或白底黑字）</p>
</li>
<li>
<p>你需要快速识别不同颜色的语法高亮</p>
</li>
<li>
<p>你需要在 IDE 的多个区域之间快速切换视线</p>
</li>
<li>
<p>你经常在深夜或弱光环境下工作</p>
</li>
</ul>
<p>如果显示器不是为这种场景优化的，你的眼睛就会一直处于“对抗”状态。要么觉得刺眼，要么觉得模糊，要么觉得色彩“不对劲”。</p>
<p>这种视觉疲劳会直接拖垮你的专注力。你不是不想写代码，是你的眼睛在“抗议”。</p>
<h3 data-id="heading-3">3、心理阻力：你的大脑在“拖延”</h3>
<p>还有一种更微妙的打断，来自你自己。</p>
<p>你打开 IDE，准备开始写一个复杂的功能。但你发现自己：</p>
<ul>
<li>
<p>先去倒杯水</p>
</li>
<li>
<p>再刷一下手机</p>
</li>
<li>
<p>然后突然想起要回个消息</p>
</li>
<li>
<p>最后发现半小时过去了，代码一行没写</p>
</li>
</ul>
<p>这不是拖延症，是大脑的自我保护机制。</p>
<p>当一个任务“看起来很难”时，大脑会本能地寻找“更简单的事情”来做。这是因为进入心流需要一个“启动成本”。你需要把所有相关的上下文加载到工作记忆里，这个过程很耗能。</p>
<p>所以，大脑会找各种理由拖延这个“启动”过程。</p>
<p>但有意思的是，一旦你真正开始了，这种阻力就会消失。难的不是“做”，而是“开始做”。</p>
<h2 data-id="heading-4">二、如何保护心流？从“环境设计”开始</h2>
<p>既然心流这么脆弱，我们能做什么？</p>
<p>答案不是“更自律”或“更努力”，而是<strong>重新设计你的工作环境</strong>。</p>
<p>心理学有个概念叫“环境提示”(Environmental Cues)。你的环境会给大脑发送信号，告诉它“现在该做什么”。</p>
<p>比如：</p>
<ul>
<li>
<p>你躺在床上，大脑会自动进入“休息模式”</p>
</li>
<li>
<p>你坐在咖啡厅，大脑会进入“社交/轻度工作模式”</p>
</li>
<li>
<p>你坐在安静的图书馆，大脑会进入“深度学习模式”</p>
</li>
</ul>
<p>同样的道理，如果你的工作环境能给大脑发送“现在是深度编程时间”的信号，你就更容易进入心流。</p>
<p>这就是为什么很多程序员喜欢深夜编程。不是因为深夜更聪明，而是因为深夜的环境提示更清晰：</p>
<ul>
<li>
<p>光线变暗（视觉刺激减少）</p>
</li>
<li>
<p>噪音消失（听觉干扰减少）</p>
</li>
<li>
<p>没人打扰（社交压力消失）</p>
</li>
<li>
<p>时间感模糊（不会焦虑“还有多少事没做”）</p>
</li>
</ul>
<h2 data-id="heading-5">三、我的解决方案：用“仪式感”触发心流</h2>
<p>我最近换了一台显示器，明基 RD280U，它是一款专门为程序员设计的专业编程显示器。</p>
<p>用了一个多月后，我发现它最大的价值不是参数有多强（虽然参数确实很强），而是它帮我建立了一套“进入心流”的仪式感。</p>
<h3 data-id="heading-6">MoonHalo 光环系统：给大脑一个“开始”的信号</h3>
<p>这个功能一开始我觉得是噱头。显示器背后有一圈灯，可以发出柔和的光晕。</p>
<p>但用了几次后，我发现它的作用远不止“好看”。</p>
<p>当我准备开始深度编程时，我会：</p>
<ol>
<li>
<p>关掉书房的主灯</p>
</li>
<li>
<p>打开显示器的 MoonHalo 模式</p>
</li>
<li>
<p>戴上降噪耳机</p>
</li>
<li>
<p>开始写代码</p>
</li>
</ol>
<p>这个过程只需要 30 秒，但它给我的大脑发送了一个非常明确的信号：<strong>“现在是深度工作时间”</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57046c9dcdf347dd8a1eb6b7818a4b35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770986886&amp;x-signature=14NzgqNnS1KvI35g93%2BbNo%2BO2sI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">为什么 MoonHalo 能触发心流？</h4>
<p>这不是玄学，背后有扎实的科学原理。</p>
<p><strong>第一，它利用了“光线引导注意力”的心理学机制。</strong></p>
<p>人类的注意力天生会被光线吸引。当你坐在一个被柔和光晕包围的工作台前，你的视觉焦点会自然地“收缩”到屏幕区域，周围的环境逐渐“隐退”。</p>
<p>这种感觉就像在电影院看电影。当灯光暗下来，屏幕亮起来，你的注意力会自动聚焦到屏幕上，外界的干扰都消失了。</p>
<p>MoonHalo 创造的就是这种“聚焦效应”。</p>
<p><strong>第二，它降低了环境对比度，减少视觉疲劳。</strong></p>
<p>如果你在完全黑暗的房间里盯着一个亮屏幕，你的瞳孔会一直在“屏幕亮度”和“周围黑暗”之间来回调节。这种频繁调节会加剧视觉疲劳，让你很快就“不想看屏幕”。</p>
<p>而 MoonHalo 的背光提供了一个“过渡区”。它不是直射的强光，而是从显示器背后漫射出来的柔和光晕。这种光线会在屏幕和周围环境之间建立一个“缓冲带”，让你的瞳孔不需要频繁调节。</p>
<p>这就是为什么很多人用了 MoonHalo 后，会觉得“眼睛没那么累了”。不是因为屏幕变暗了，而是因为环境对比度降低了。</p>
<p><strong>第三，它创造了一种“仪式感”，帮助大脑切换状态。</strong></p>
<p>心理学研究发现，人类的大脑需要“仪式”来切换状态。</p>
<p>比如，运动员在比赛前会做热身动作，不仅是为了活动身体，更是为了让大脑进入“比赛模式”。作家在写作前会泡一杯咖啡、整理桌面，不仅是为了舒适，更是为了让大脑进入“创作模式”。</p>
<p>同样的道理，当你每次开始深度编程前都打开 MoonHalo，你的大脑会逐渐建立一个条件反射：<strong>MoonHalo 亮起 = 深度工作时间</strong>。</p>
<p>这种仪式感会大大降低“启动成本”。你不需要花半小时“进入状态”，而是一打开 MoonHalo，大脑就自动切换到“心流模式”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b0bde473d6c491488a7d4a2b824d16f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770986886&amp;x-signature=EO7l1IWF8TptjWjkDKZB1fohdlI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">MoonHalo 的细节设计：不只是“亮起来”那么简单</h4>
<p>很多人可能会说：“这不就是氛围灯吗？我自己买个台灯不行吗？”</p>
<p>可以，但效果完全不一样。</p>
<p>因为 MoonHalo 不是简单的“背景光”，而是一个<strong>为编程场景深度优化的光环系统</strong>。</p>
<p><strong>1. 可调节的色温和亮度</strong></p>
<p>MoonHalo 支持多种颜色和亮度调节。</p>
<p>这种“可调节性”是普通台灯做不到的。因为 MoonHalo 的光线是“围绕屏幕”的，而不是“照亮桌面”的。它的目标不是让你看清键盘，而是创造一个“沉浸式的视觉环境”。</p>
<p><strong>2. 自动调光功能和多种灯光模式选择</strong></p>
<p>更智能的是，MoonHalo 支持自动调光，自动给我最合适的光线环境。同时，还支持多种灯光模式供我们选择，总有一款适合你。</p>
<p>这就是“一键进入状态”的体验。</p>
<p><strong>3. 不会在屏幕上产生反光</strong></p>
<p>这是一个很容易被忽略的细节。</p>
<p>如果你用普通的台灯或落地灯，光线很容易在屏幕上产生反光，尤其是当你用的是镜面屏或半镜面屏的时候。这种反光会分散你的注意力，让你不自觉地调整坐姿或屏幕角度。</p>
<p>而 MoonHalo 的光线是从显示器背后漫射出来的，它的方向是“向外”的，而不是“向屏幕”的。这意味着它不会在屏幕上产生任何反光，也不会干扰你的视线。</p>
<p>这种“无感”才是最好的设计。你只会感受到“环境变舒服了”，而不会意识到“有一个灯在亮着”。</p>
<p>说实话，我一开始买 RD280U 的时候，完全没把 MoonHalo 当回事。我觉得这就是个“营销噱头”，实际用处不大。</p>
<p>但用了一周后，我发现自己已经离不开它了。</p>
<p>而且，我发现 MoonHalo 还有一个意外的好处：<strong>它帮我建立了“工作边界”</strong>。</p>
<p>比如，因为环境没有变化，我的大脑一直处于“工作模式”，很难放松。但现在，当我关掉 MoonHalo 的时候，我的大脑会自动切换到“休息模式”。这种“仪式感”帮我建立了清晰的工作边界，让我既能高效工作，也能彻底放松。</p>
<h3 data-id="heading-9">猫头鹰模式：让深夜编程不再“伤眼”</h3>
<p>如果说 MoonHalo 是帮你“进入心流”，那猫头鹰模式就是帮你“保持心流”。</p>
<p>很多程序员喜欢深夜编程，但深夜编程有个大问题：光线太暗，屏幕太亮，眼睛很容易疲劳。</p>
<p>你可能会说：“那我把屏幕亮度调低不就行了？”</p>
<p>可以，但远远不够。</p>
<p>因为“亮度”只是视觉舒适度的一个维度，还有色温、对比度、蓝光比例、色彩饱和度等等。如果你只是简单地降低亮度，你会发现：</p>
<ul>
<li>
<p>屏幕变“灰”了，代码的色彩识别度下降</p>
</li>
<li>
<p>你需要更用力地“盯”屏幕，反而更累</p>
</li>
<li>
<p>蓝光依然在抑制褪黑素分泌，让你“越看越精神”，但也让你睡不着</p>
</li>
</ul>
<p>猫头鹰模式的逻辑是：<strong>在保持代码清晰度的前提下，动态调整所有参数，让屏幕适应深夜环境</strong>。无论你的周边环境多暗，RD280U通过固件调整打破亮度限制，提供极低的亮度与色彩平衡方案，让你的眼睛始终保持舒适，深夜编程也无惧</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e4d97706fac4a2fb76cd8d1063dda40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770986886&amp;x-signature=UFk0r4ofPRYygakW7iES4ppukKQ%3D" alt="" loading="lazy"/></p>
<p>所以，猫头鹰模式，这不是简单的“降低亮度”，而是一套<strong>针对深夜编程场景的综合调校方案</strong>。</p>
<h2 data-id="heading-10">四、3:2 屏幕比例：为什么它特别适合“心流编程”？</h2>
<p>除了 MoonHalo 和猫头鹰模式，RD280U 还有一个很特别的设计：<strong>3:2 的屏幕比例</strong>。</p>
<p>这个比例看起来“不起眼”，但它对心流的影响远比你想象的大。</p>
<p>心流的一个关键特征是“注意力高度集中”。如果你需要频繁地上下滚动、左右切换，你的注意力就会被“打断”。</p>
<p>而 3:2 的屏幕比例，恰恰可以<strong>减少视线移动和上下文切换</strong>。</p>
<h3 data-id="heading-11">为什么 3:2 比 16:9 更适合心流编程？</h3>
<p>16:9 是“视频比例”，它天生是为“横向内容”设计的——看电影、看视频、玩游戏。</p>
<p>但编程是“纵向内容”，你需要看代码、看日志、看文档、看终端。这些内容都是“从上往下”的。</p>
<p>如果你用 16:9 的屏幕，你会发现：</p>
<ul>
<li>
<p>IDE 的代码区域很“矮”，你需要频繁上下滚动</p>
</li>
<li>
<p>终端和日志区域被挤到很小，你需要频繁切换标签页</p>
</li>
<li>
<p>文档和 API 参考没地方放，你需要来回切窗口</p>
</li>
</ul>
<p>这些“频繁切换”会不断打断你的心流。</p>
<p>而 3:2 的屏幕比例，比 16:9 多出了约 30% 的垂直空间。这意味着：</p>
<ul>
<li>
<p><strong>终端和日志可以常驻在底部</strong>，不需要频繁切换标签页</p>
</li>
<li>
<p><strong>文档和 API 参考可以并排显示</strong>，不需要来回切窗口</p>
</li>
<li>
<p><strong>diff 和 PR 页面可以一屏看完</strong>，不需要反复滚动</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7211b372caf54d0d90777bd380ca333a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9vbmdnZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770986886&amp;x-signature=0A63%2BwE72JBEPECyMbPHKJ0PTGM%3D" alt="" loading="lazy"/></p>
<p>这些看起来是“小优化”，但它们会直接影响你的心流体验。</p>
<p>因为心流的本质是：<strong>你的工作记忆里只有一件事</strong>。</p>
<p>如果你需要频繁地“切换上下文”（比如从代码切到文档，再切到终端，再切回代码），你的工作记忆就会被“污染”，心流就会中断。</p>
<p>而 3:2 的屏幕比例，配合 28 寸 4K 的分辨率（3840×2560），可以让你在一个屏幕上“看到所有相关信息”，减少上下文切换。</p>
<p>这种“一屏掌控”的感觉，会让你更容易进入心流，也更容易保持心流。</p>
<h2 data-id="heading-12">五、心流不是“天赋”，而是“环境设计”</h2>
<p>回到开头的问题：程序员的心流为什么总被打断？</p>
<p>答案很清楚了。<strong>不是你不够专注，而是你的环境在拖你后腿</strong>。</p>
<p>心流不是一种“天赋”，而是一种“状态”。这种状态需要三个条件：</p>
<ol>
<li>
<p><strong>足够的挑战</strong>（任务不能太简单，也不能太难）</p>
</li>
<li>
<p><strong>即时的反馈</strong>（你能清楚地知道自己在进步）</p>
</li>
<li>
<p><strong>无干扰的环境</strong>（外部干扰和内部阻力都要降到最低）</p>
</li>
</ol>
<p>前两个条件取决于你的工作内容，但第三个条件，完全可以通过“环境设计”来优化。</p>
<p>而一个好的显示器，恰恰是“环境设计”的核心。</p>
<p>因为它是你每天 8 小时都要盯着的东西，它决定了：</p>
<ul>
<li>
<p>你的眼睛会不会疲劳</p>
</li>
<li>
<p>你的注意力会不会分散</p>
</li>
<li>
<p>你的大脑会不会抵触</p>
</li>
</ul>
<p>如果这三个问题都解决了，心流就会自然而然地发生。</p>
<p>这就是为什么我会推荐明基 RD280U 这款显示器。它不是“参数最强”的显示器，但它是“最懂程序员心流”的显示器。</p>
<p>它知道你需要“仪式感”来触发心流（MoonHalo），它知道你需要“舒适度”来保持心流（猫头鹰模式），它知道你需要“视觉连续性”来减少心流中断（3:2 屏幕比例）。</p>
<p>这些细节加起来，就是“心流”和“被打断”的区别。</p>
<h2 data-id="heading-13">写在最后：投资你的“工作台”，而不只是你的“技能”</h2>
<p>很多程序员喜欢投资“技能”，学新框架、刷算法题、看技术书。</p>
<p>这些当然重要，但还有一件同样重要、却经常被忽略的事：<strong>投资你的工作环境</strong>。</p>
<p>因为再强的技能，也需要一个“能让你发挥出来”的环境。</p>
<p>如果你的显示器让你眼睛疲劳、注意力分散、心流中断，那你的技能就会被“打折扣”。</p>
<p>而一个好的显示器，可以让你：</p>
<ul>
<li>
<p>每天多写 2 小时高质量代码（因为眼睛不累了）</p>
</li>
<li>
<p>每周多进入 5 次心流状态（因为环境更沉浸了）</p>
</li>
<li>
<p>每个月少加几次班（因为效率更高了）</p>
</li>
</ul>
<p>这些收益，远远超过显示器本身的价格。</p>
<p>所以，如果你真的想提升编程效率、保护心流状态，别只盯着软件和技巧，先看看你的硬件配得上你的水平吗。</p>
<p>屏幕是你的“工作台”，而不是“装饰品”。</p>
<p>选对了，你会发现：心流不是“偶尔发生”的幸运，而是“每天都能进入”的常态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【转载】Introducing OpenAI Frontier]]></title>    <link>https://juejin.cn/post/7603567912592277531</link>    <guid>https://juejin.cn/post/7603567912592277531</guid>    <pubDate>2026-02-06T12:59:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603567912592277531" data-draft-id="7603584155784446002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【转载】Introducing OpenAI Frontier"/> <meta itemprop="keywords" content="OpenAI"/> <meta itemprop="datePublished" content="2026-02-06T12:59:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【转载】Introducing OpenAI Frontier
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T12:59:40.000Z" title="Fri Feb 06 2026 12:59:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI 让团队能够完成过去只会讨论却难以落地的事情。事实上，75% 的企业员工表示，AI 帮助他们完成了以前做不到的任务。我们从每个部门都听到这样的反馈，而不只是技术团队。工作的完成方式已经改变，企业正在以非常显著的方式感受到这种变化。过去几年里，我们在超过 100
万家企业客户中看到了这种变化的真实发生。</p>
<p>在一家大型制造商那里，智能体把生产优化工作从六周缩短到一天。在一家全球投资公司，智能体贯穿销售流程的端到端部署，为销售人员腾出了超过 90% 的时间，让他们能更多地与客户交流。而在一家大型能源生产商那里，智能体帮助将产量提高了最多 5%，这意味着额外增加超过 10 亿美元的收入。</p>
<p>这一切正在各行各业的 AI 领导者中发生，追赶的压力也在增加。真正拖慢他们的不是模型的智能水平，而是组织内部智能体是如何被构建和运行的。</p>
<p>今天，我们推出 Frontier——一个新的平台，帮助企业构建、部署与管理能够做“真实工作”的 AI 智能体。Frontier 让智能体具备人类在工作中成功所需的同类能力：共享上下文、入职培训、带反馈的实践学习，以及清晰的权限与边界。这样，团队才能从孤立的单点用例，迈向能跨业务协同的 AI 同事。</p>
<p>HP、Intuit、Oracle、State Farm、Thermo Fisher 和 Uber 是最早采用 Frontier 的企业之一；而包括 BBVA、Cisco 和 T-Mobile 在内的数十家现有客户，已经试点了 Frontier 的方法，用来驱动他们最复杂、最有价值的一些 AI 工作。</p>
<p>（引言）
“与 OpenAI 合作能帮助我们为成千上万的 State Farm 代理人与员工提供更好的工具来服务客户。把 OpenAI 的 Frontier 平台与部署专长同我们的团队结合起来，我们正在加速 AI 能力建设，并找到新的方式，帮助数百万人提前规划、守护重要事物，并在意外发生时更快恢复。”
—— Joe Park，State Farm 执行副总裁兼首席数字与信息官</p>
<p>────────────────────────────────────────────────────────────────────────────────</p>
<p>AI 机会鸿沟</p>
<p>企业已经被分散在不同云、数据平台与应用中的割裂系统与治理框架压得喘不过气。AI 让这种碎片化更明显，在很多情况下也更严重。</p>
<p>智能体正在被部署到各处，但每个智能体能够看到和能够做的事情都是孤立的。每新增一个智能体，可能不是在降低复杂度，反而在增加复杂度——因为它缺乏做好工作所需的上下文。</p>
<p>随着智能体能力提升，“模型能做什么”与“团队实际上能部署什么”之间的机会鸿沟正在扩大。这个鸿沟不仅由技术驱动。团队仍在建立把智能体从早期试点推进到真实工作的知识体系，而 AI 的进步速度更快。仅在 OpenAI
内部，几乎每三天就会发布一次新东西，而且节奏还在加快。要跟上，就必须在控制与实验之间取得平衡，而这很难把握。</p>
<p>企业现在感到必须立刻解决这个问题，因为早期领跑者与其他企业之间的差距正在迅速拉大。</p>
<p>────────────────────────────────────────────────────────────────────────────────</p>
<p>OpenAI Frontier</p>
<p>我们发现，团队不只是需要“能解决拼图某一块”的更好工具。他们需要一个端到端的方法，来把智能体真正带入生产环境：构建、部署与管理。</p>
<p>我们从企业如何扩展“人”的方式开始思考：他们会建立入职流程；教授制度性知识与内部语言；允许通过实践学习，并通过反馈提升表现；授予对正确系统的访问权，同时设定边界。AI 同事也需要同样的东西。</p>
<p>要让 AI 同事真正工作，有几件事很关键：</p>
<ul>
<li>他们必须理解跨系统的实际工作流程是如何运转的；</li>
<li>他们需要访问电脑与工具来规划、行动并解决现实问题；</li>
<li>他们需要理解“什么是好”，从而随着工作变化而持续提升质量；</li>
<li>他们需要一个可被信任的身份、权限与边界。</li>
</ul>
<p>而这一切必须能在分布于多云环境的众多系统中运作。</p>
<p>Frontier 与团队已有的系统协同工作，而不是强迫他们重新平台化。你可以在数据与 AI 所在之处直接接入它们，并使用开放标准集成你已经在用的应用——不需要新格式，也不需要放弃你已经部署的智能体或应用。</p>
<p>这种方法的“超能力”在于：AI 同事可以通过任何界面被访问并发挥作用，而不是被困在单一 UI 或单一应用背后。他们可以在工作的任何地方与人合作：无论是通过 ChatGPT 交互、通过 Atlas 的工作流，还是嵌入到既有的业务应用中。无论智能体是由企业内部开发、从 OpenAI
获得，还是由你已在用的其他供应商集成而来，都是如此。</p>
<p>────────────────────────────────────────────────────────────────────────────────</p>
<p>理解工作（Understand the work）</p>
<p>每位高效员工都了解业务如何运作、信息在哪里、以及什么样的决策是好的。Frontier 连接彼此孤立的数据仓库、CRM 系统、工单工具与内部应用，为 AI 同事提供同样的共享业务上下文。</p>
<p>他们理解信息如何流动、决策在哪里发生、以及哪些结果最重要。它成为企业的语义层，所有 AI 同事都能引用它来有效运作并沟通。</p>
<p>────────────────────────────────────────────────────────────────────────────────</p>
<p>规划、行动与解决问题（Plan, act, and solve problems）</p>
<p>有了共享上下文之后，智能体必须能够真正把工作做出来。组织内的技术与非技术团队都可以使用 Frontier 来“雇用”AI 同事，让他们承担许多人类在电脑上完成的任务。</p>
<p>Frontier 赋予 AI 同事在一个可靠、开放的智能体执行环境中推理数据并完成复杂任务的能力，例如：处理文件、运行代码、使用工具等。</p>
<p>随着 AI 同事运行，他们会建立记忆，把过去的交互转化为有用的上下文，从而随时间推移持续提升表现。部署后，AI 同事可以在本地环境、企业云基础设施与 OpenAI 托管运行时之间运行，而无需团队重造工作方式。对于时间敏感的工作，Frontier 优先提供对 OpenAI
模型的低延迟访问，以保持响应快速且一致。</p>
<p>────────────────────────────────────────────────────────────────────────────────</p>
<p>在真实工作上提升质量（Improve quality on real work）</p>
<p>智能体要长期有用，就必须像人一样从经验中学习。内置的评估与优化方式，能让人类管理者与 AI 同事清晰看到哪些有效、哪些无效，从而让良好行为随时间不断强化。</p>
<p>随着时间推移，AI 同事会学习“好”是什么样子，并在最重要的工作上变得更好。这就是智能体从惊艳的演示走向可靠队友的路径。</p>
<p>────────────────────────────────────────────────────────────────────────────────</p>
<p>身份、权限与边界（Identity, permissions, and boundaries）</p>
<p>Frontier 确保 AI 同事在清晰边界内运行。每个 AI 同事都有自己的身份，并具备明确的权限与护栏。这使得它们能够在敏感且受监管的环境中被放心使用。企业级安全与治理能力内置其中，帮助团队在扩展规模时不失控。</p>
<p>────────────────────────────────────────────────────────────────────────────────</p>
<p>将技术与方法论结合（Combining technology with know-how）</p>
<p>弥合机会鸿沟不仅是技术问题。多年来，我们与大型企业在复杂 AI 部署上紧密合作，见证了哪些有效、哪些无效。现在，我们正在帮助团队把这些经验用于最棘手的问题。</p>
<p>我们把 OpenAI 的 Forward Deployed Engineers（FDE，前线部署工程师）与客户团队配对，肩并肩工作，帮助你制定在生产环境中构建与运行智能体的最佳实践。FDE 也让团队与 OpenAI Research 建立直接连接。</p>
<p>当你部署智能体时，我们不仅学习如何改进围绕模型的系统，也学习模型本身需要如何演进，才能对你的工作更有用。这条从业务问题→部署→研究→再反馈回来的闭环，让双方都能更快前进。</p>
<p>（示例/案例：根因分析、数字零售助手、设备维护、用户个性化、营销活动等）
业务问题：数以百万计的硬件测试失败，工程师每年花费数千小时（几乎一半时间）通过翻日志、文档与代码来人工定位原因。
我们解决了什么：把每次失败的根因定位从约 4 小时缩短到几分钟，加速故障排查。
如何实现：AI 同事汇总仿真日志、内部文档、工作流与代码，运行端到端调查，找出最可能的根因以及下一步措施。
结果：调试从小时级降到分钟级，每年节省数千工程小时，并加快开发进度。</p>
<p>────────────────────────────────────────────────────────────────────────────────</p>
<p>打开 AI 生态（Opening the AI ecosystem）</p>
<p>在企业里，AI 要发挥最佳效果，平台与应用需要协同工作。由于 Frontier 基于开放标准，软件团队可以接入并构建智能体应用，使其受益于同一套共享上下文。</p>
<p>这很重要，因为许多智能体应用失败的原因很简单：缺少所需的上下文。数据分散在各个系统中，权限复杂，每次集成都可能变成一次性项目。Frontier 让应用更容易（在正确的控制下）访问业务上下文，因此从第一天起就能融入真实工作流。</p>
<p>对企业而言，这意味着更快的上线速度，而不必每次都经历漫长的集成周期。</p>
<p>我们也在与一小部分 Frontier Partners 合作——一些 AI 原生的构建者（例如 Abridge、Clay、Ambience、Decagon、Harvey、Sierra）——他们承诺与 Frontier 深度协作。他们将与 OpenAI 紧密合作，学习客户需求、设计解决方案并支持部署。随着时间推移，我们会扩大该计划，欢迎更多专注企业 AI
的构建者加入。</p>
<p>────────────────────────────────────────────────────────────────────────────────</p>
<p>一起构建（Let’s build）</p>
<p>现在的问题不再是 AI 是否会改变工作方式，而是你的组织能多快把智能体变成真正的优势。Frontier 目前已向一部分客户开放，未来几个月将更广泛可用。</p>
<p>如果你想探索与我们合作，请联系你的 OpenAI 团队。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习：Kotlin中的JvmStatic注解]]></title>    <link>https://juejin.cn/post/7603567912592113691</link>    <guid>https://juejin.cn/post/7603567912592113691</guid>    <pubDate>2026-02-06T11:28:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603567912592113691" data-draft-id="7603359026711756810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习：Kotlin中的JvmStatic注解"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2026-02-06T11:28:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习：Kotlin中的JvmStatic注解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T11:28:55.000Z" title="Fri Feb 06 2026 11:28:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>JvmStatic 是 Kotlin 中的一个注解（Annotation），专门用于标注在 Kotlin 对象（包括单例对象和伴生对象）中的方法或属性上，使其能够以类似 Java 静态成员的方式被 JVM 访问。</p>
<p>它的核心作用是消除 Kotlin 对象成员与 Java 静态成员之间的语法差异，让 Kotlin 代码在 Java 中调用时更符合 Java 的开发习惯。</p>
<h2 data-id="heading-0">基本定义与使用场景</h2>
<p>Kotlin 的对象（object）和伴生对象（companion object）本质上是单例实例，其成员在 Kotlin 中通过对象实例访问（如 MyObject.method()）。</p>
<p>但在 Java 中，静态成员直接通过类名访问（如 MyClass.staticMethod()）。为了让 Kotlin 对象中的成员在 Java 中表现为静态成员，JvmStatic 注解被引入。</p>
<h2 data-id="heading-1">具体用法与效果</h2>
<h3 data-id="heading-2">标注在伴生对象（companion object）的成员上</h3>
<p>伴生对象是 Kotlin 中为类提供“静态-like”功能的机制（如工厂方法、常量）。</p>
<p>默认情况下，伴生对象的成员在 Java 中需要通过 Companion 接口访问（如 MyClass.Companion.create()）。</p>
<p>使用 @JvmStatic 后，这些成员可以直接通过类名访问，如同 Java 静态方法。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 未使用 @JvmStatic：Java 中需通过 MyClass.Companion.getVersion()</span>
        <span class="hljs-keyword">val</span> version = <span class="hljs-string">"1.0"</span>
        
        <span class="hljs-comment">// 使用 @JvmStatic：Java 中可直接通过 MyClass.getVersion()</span>
        <span class="hljs-meta">@JvmStatic</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getVersion</span><span class="hljs-params">()</span></span>: String = version
        
        <span class="hljs-comment">// 未使用 @JvmStatic：Java 中需通过 MyClass.Companion.create()</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span>: MyClass = MyClass()
        
        <span class="hljs-comment">// 使用 @JvmStatic：Java 中可直接通过 MyClass.create()</span>
        <span class="hljs-meta">@JvmStatic</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createInstance</span><span class="hljs-params">()</span></span>: MyClass = MyClass()
    }
}
</code></pre>
<p>Java 调用效果：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 未使用 @JvmStatic 的版本（需通过 Companion）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> MyClass.Companion.getVersion(); 
<span class="hljs-type">MyClass</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> MyClass.Companion.create();

<span class="hljs-comment">// 使用 @JvmStatic 的版本（直接通过类名，类似 Java 静态方法）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> MyClass.getVersion(); 
<span class="hljs-type">MyClass</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> MyClass.createInstance(); 
</code></pre>
<h3 data-id="heading-3">标注在单例对象（object）的成员上</h3>
<p>Kotlin 的单例对象（非伴生对象的独立对象）默认在 Java 中表现为一个单例实例（如 MySingleton.INSTANCE），其成员需通过该实例访问。</p>
<p>使用 @JvmStatic 后，成员可直接通过对象名访问，如同 Java 静态成员。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> MySingleton {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 未使用 @JvmStatic：Java 中需通过 MySingleton.INSTANCE.increment()</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> { count++ }
    
    <span class="hljs-comment">// 使用 @JvmStatic：Java 中可直接通过 MySingleton.increment()</span>
    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">incrementCount</span><span class="hljs-params">()</span></span> { count++ }
    
    <span class="hljs-comment">// 未使用 @JvmStatic：Java 中需通过 MySingleton.INSTANCE.getCount()</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = count
    
    <span class="hljs-comment">// 使用 @JvmStatic：Java 中可直接通过 MySingleton.getCount()</span>
    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getTotalCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = count
}
</code></pre>
<p>Java 调用效果：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 未使用 @JvmStatic 的版本（需通过 INSTANCE）</span>
MySingleton.INSTANCE.increment(); 
<span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> MySingleton.INSTANCE.getCount();

<span class="hljs-comment">// 使用 @JvmStatic 的版本（直接通过对象名，类似 Java 静态方法）</span>
MySingleton.incrementCount(); 
<span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> MySingleton.getTotalCount(); 
</code></pre>
<h2 data-id="heading-4">关键注意事项</h2>
<p>• 仅对对象/伴生对象的成员有效：@JvmStatic 只能用于 object 或 companion object 内部的方法或属性，不能用于普通类（class）的成员。</p>
<p>• 属性与方法的差异：</p>
<pre><code class="hljs language-less" lang="less">• 对于方法：<span class="hljs-variable">@JvmStatic</span> 会让方法在 Java 中表现为静态方法（直接通过类名调用）。  

• 对于属性：<span class="hljs-variable">@JvmStatic</span> 会让属性的 getter/setter 方法在 Java 中表现为静态方法（如 Kotlin 的 val version 生成的 <span class="hljs-built_in">getVersion</span>() 会变成静态方法）。
</code></pre>
<p>• 与 @JvmField 的区别：@JvmField 用于将对象中的属性暴露为 Java 静态字段（直接访问字段值），而 @JvmStatic 是将属性的访问器（getter/setter）暴露为静态方法。两者可配合使用，但场景不同。</p>
<h2 data-id="heading-5">总结</h2>
<p>@JvmStatic 的核心价值是桥接 Kotlin 对象成员与 Java 静态成员的访问方式，提升跨语言调用的兼容性。</p>
<p>它让 Kotlin 的单例或伴生对象中的方法/属性在 Java 中调用时更符合 Java 开发者的直觉，避免了繁琐的 Companion 或 INSTANCE 中间层。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全模态、多引擎、一体化，阿里云DLF3.0构建Data+AI驱动的智能湖仓平台]]></title>    <link>https://juejin.cn/post/7603355275258445864</link>    <guid>https://juejin.cn/post/7603355275258445864</guid>    <pubDate>2026-02-06T11:54:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603355275258445864" data-draft-id="7603347438013759523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全模态、多引擎、一体化，阿里云DLF3.0构建Data+AI驱动的智能湖仓平台"/> <meta itemprop="keywords" content="大数据,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T11:54:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全模态、多引擎、一体化，阿里云DLF3.0构建Data+AI驱动的智能湖仓平台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T11:54:21.000Z" title="Fri Feb 06 2026 11:54:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">▌导读</h2>
<p>在AI时代,数据工程师和AI工程师的协作变得前所未有的重要。阿里云DLF产品负责人李鲁兵在本次分享中,详细介绍了全模态湖仓DLF 3.0的完整能力体系。这个平台不仅支持传统的结构化数据处理,更在业界首次实现了结构化、半结构化、非结构化数据的统一管理和处理,为Data+AI一体化提供了端到端的解决方案。</p>
<h2 data-id="heading-1">▌全模态平台的核心理念:数据统一、计算按需、工作流驱动</h2>
<p>全模态湖仓管理平台的设计理念可以概括为四个关键词:数据统一、计算按需、工作流驱动、多方协作。在AI时代,数据工程师负责数据准备和预处理,AI工程师专注于模型训练、推理和召回,两个角色需要在统一的平台上无缝协作,这对平台能力提出了更高的要求。</p>
<p>数据统一是基础。传统的数据平台往往将结构化数据、半结构化数据、非结构化数据分别存储在不同系统中,造成数据孤岛和管理复杂度的急剧上升。DLF 3.0通过统一的Omni Catalog,实现了对Paimon、Iceberg、Lance、Format Table、Object Table等多种格式的统一管理。无论是传统的数据库表,还是文本、音频、图片、视频等多模态数据,都可以在同一套元数据目录中进行管理,Data工程师和AI工程师可以基于同一份数据进行协作。</p>
<p>计算按需是核心。不同的应用场景需要不同的计算引擎。实时分析需要Flink和Hologres,离线分析依赖Spark和MaxCompute,全模态检索要用到Milvus和Elasticsearch/OpenSearch,模型训练则需要PAI和Ray。DLF 3.0支持所有这些计算引擎在统一的湖仓之上按需调用,一份数据,多个引擎共享,避免了数据的重复存储和迁移。</p>
<p>工作流驱动是保障。数据处理和AI应用往往涉及多个步骤:数据摄取、预处理、特征工程、模型训练、推理、召回等。DLF 3.0提供了完整的工作流编排能力,数据工程师和AI工程师可以通过工作流将各个环节串联起来,实现端到端的自动化流程。</p>
<p>多方协作是目标。通过统一的IDE/Notebook开发环境、Copilot代码辅助、自然语言分析、Agent智能助手等能力,DLF 3.0降低了开发门槛,提升了协作效率。数据工程师和AI工程师可以在同一个平台上使用各自熟悉的工具,同时又能无缝共享数据和成果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59d3d18f96a74481aac0a3a37f850eb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=VGuaEwlWd2EuW%2BZ7nxhsnouFY8w%3D" alt="幻灯片3.png" loading="lazy"/></p>
<h2 data-id="heading-2">▌产品方案大图:从结构化到全模态的能力升级</h2>
<p>DLF 3.0的产品方案大图清晰地展示了从结构化数据处理到全模态处理的能力演进。在传统的数据处理链路上,我们有CDC/Batch Ingestion(数据摄取)、Stream/Batch ETL(数据加工)、OLAP Analytic(分析查询)三个主要环节,对应的计算引擎包括Flink、Spark、Hologres、StarRocks、MaxCompute等。</p>
<p>在全模态处理链路上,新增了四个关键环节:数据集管理、数据预处理、数据训练、数据推理、数据检索召回。这些环节分别对应不同的计算引擎:数据预处理可以使用MaxFrame和PySpark,模型训练依赖PAI和Ray,数据检索召回则需要Milvus和Elasticsearch/OpenSearch等搜索引擎。</p>
<p>两条链路并非孤立存在,而是通过统一的Omni Catalog和DLF元数据服务实现了深度融合。底层的Lakehouse Managed Storage Service提供了统一的存储层,支持Virtual File System、生命周期管理、冷热分层、存储优化等能力。数据缓存加速服务CPFS进一步提升了GPU/CPU的数据读取效率,为AI训练和推理提供了高性能保障。</p>
<p>DLF作为统一的湖仓管理平台,提供了Rest Catalog Service、Lakehouse SDK(Paimon、Iceberg)、File SDK、权限管理、血缘追踪、监控日志等完整的企业级能力。这种架构设计使得同一份数据可以同时服务于传统的数据分析场景和新兴的AI应用场景,真正实现了Data+AI一体化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/247784032551427d8cef001e1e6ff326~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=NIo1tJc1CzTN0UaN4Z7FP0lvnxs%3D" alt="幻灯片4.png" loading="lazy"/></p>
<h2 data-id="heading-3">▌Omni Catalog:全模态管理的统一目录</h2>
<p>在全模态时代,元数据管理面临前所未有的挑战。传统的Catalog只需要管理Tables、Views、Functions等结构化对象,而在AI场景下,还需要管理各种文件(Files)、向量索引、Blob数据等非结构化对象。如果不同类型的数据使用不同的Catalog或System进行管理,就会产生新的数据孤岛,计算引擎需要跨不同的Catalog进行处理,大幅增加了复杂度。</p>
<p>DLF 3.0推出的Omni Catalog正是为了解决这一问题。它通过一套统一的元数据目录,同时管理Tables和Files,支持Paimon、Iceberg、Lance、Format Table(Parquet、ORC、Avro)、Object Table(Files)等多种格式。计算引擎无论是传统的大数据引擎(Flink、Spark、Hologres)还是新型的AI框架(Ray、PyTorch),都可以通过统一的Rest API、Open API、Paimon SDK、Iceberg SDK、VFS SDK进行数据访问。</p>
<p>Omni Catalog的核心优势在于降低了数据孤岛的风险。通过统一的目录,数据治理、权限控制、血缘追踪等能力可以覆盖所有类型的数据,而不需要在不同系统间切换。这对于企业级应用尤为重要,因为数据合规、安全审计等需求必须覆盖全域数据,而不能有盲区。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8c15d6f50a44631872794bbebf8303a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=NkF4TNMBwN0T%2FBPoYeiCi0rTIwA%3D" alt="幻灯片5.png" loading="lazy"/></p>
<h2 data-id="heading-4">▌DLF提供商业化Paimon全模态存储:统一管理异构数据</h2>
<p>Paimon作为DLF 3.0的核心表格式,在全模态存储方面进行了深度创新。全模态存储面临三大核心需求:统一管理异构数据的能力、支持结构化和多模态数据的顺序访问(用于大规模批式推理)、提供高性能的标签和向量检索(支持随机访问)。</p>
<p>Paimon通过Row ID机制实现了对不同列、不同格式数据的统一管理。每一行数据都有一个全局唯一的Row ID,通过Row ID可以关联该行在不同文件格式中的存储位置。对于结构化数据,Paimon使用Parquet Files存储,对于向量数据,可以使用Lance Files或Faiss Vector索引,对于大型Blob数据(图片、音频、视频),则使用Paimon Blob格式。</p>
<p>在索引构建方面,Paimon提供了多种索引类型。Btree和Bitmap索引用于快速的标量查询,Invert倒排索引支持全文检索,Vector Index则提供高效的向量相似度搜索。这些索引通过Index Manifests进行统一管理,建立了字段与Row ID之间的映射关系。</p>
<p>在数据访问方面,Paimon通过Data Manifests管理文件组,支持Row Ranges范围扫描。对于顺序访问场景(如模型训练),Paimon可以将多条数据打包成Virtual File Group,提供高吞吐的批量读取。对于随机访问场景(如实时检索),Paimon通过全局索引实现了毫秒级的点查性能。</p>
<p>通过这种灵活的File Formats组合和统一的Table Format封装,Paimon实现了在一张宽表上承载结构化、半结构化、非结构化所有类型数据的目标,为全模态应用提供了坚实的存储基础。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/078603b5f7c749daa5f375db65d502f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=Se4usRMUx0cjJgztV0vtvIh2rWE%3D" alt="幻灯片6.png" loading="lazy"/></p>
<h2 data-id="heading-5">▌DLF湖表管理与优化:智能化提升性能降低成本</h2>
<p>DLF 3.0提供了完整的湖表管理和优化能力,通过智能化的方式提升读写性能、降低存储成本。整个优化体系包括四大核心能力:自适应分桶、智能Compaction、快照管理清理、存储服务与冷热分层。</p>
<p>自适应分桶是一项创新性功能。传统的分桶策略需要用户在建表时指定分桶数,但随着数据量的变化,固定的分桶数可能导致性能问题。DLF 3.0支持根据数据量自适应地调整分桶数(Rescale),用户只需指定分桶Key,平台会自动维护最优的分桶配置,大幅降低了管理负担。</p>
<p>智能Compaction是性能优化的关键。随着数据的不断写入,湖表会产生大量小文件,影响读取性能。DLF 3.0提供了多种Compaction策略:动态资源模式支持延时优先、资源优先、均衡模式三种策略,平台会根据当前资源状况自动调整Compaction节奏;固定资源模式则允许用户自定义资源配置和参数,实现精细化控制。对于全模态数据,DLF 3.0还支持针对不同文件类型(结构化、半结构化、非结构化)采用不同的Compaction策略,保证整体效率。</p>
<p>快照管理和清理功能帮助用户有效管理数据生命周期。用户可以基于分区或快照设置自动清理策略,平台还会自动扫描Orphan Files(孤儿文件)并清理,避免存储空间的浪费。同时支持手动触发管理操作,满足特殊场景需求。</p>
<p>整个优化流程由DLF元数据服务、Event Store事件存储、Paimon存储优化服务协同完成。作业生成引擎、规则优化引擎、智能优化引擎共同组成了智能决策层,作业调度管理则负责在多个计算资源池上高效执行Compaction任务。这种架构设计实现了从元数据到数据文件的全链路优化,用户无需关心底层细节,即可享受高性能和低成本的双重优势。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32f7a8c2d5ab4eb48546938e350a2021~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=E1LzIycKddmUeF5YAggVY%2B7ccKc%3D" alt="幻灯片7.png" loading="lazy"/></p>
<h2 data-id="heading-6">▌智能冷热分层:大幅降低存储成本</h2>
<p>存储成本是企业在构建数据湖时的重要考量因素。DLF 3.0提供了智能的冷热分层能力,可以根据数据访问模式自动将数据在不同存储类型间迁移,在保证性能的同时大幅降低成本。</p>
<p>DLF 3.0支持四种存储类型:标准存储、低频存储、归档存储、冷归档存储。平台会根据数据的最近访问时间和最近更新时间,自动决定数据应该存储在哪个层级。对于频繁访问的热数据,保持在标准存储以保证高性能;对于访问频率降低的温数据,迁移到低频存储节省成本;对于长期不访问的冷数据,则可以归档到成本更低的归档存储或冷归档存储。</p>
<p>智能加热是冷热分层的重要补充功能。当归档的数据再次被访问时,平台会自动将其加热到更高性能的存储层级。加热策略支持Partition(分区)和File(文件)两层管理,可以针对分区级别或文件级别的访问进行精细化控制。这种设计既保证了数据访问的性能,又最大化地利用了低成本存储,实现了性能与成本的最佳平衡。</p>
<p>通过智能冷热分层,企业可以在不牺牲数据可用性的前提下,将长期存储成本降低数倍。对于PB级甚至EB级的数据湖,这种成本优化能力可以为企业节省大量资金,使得海量数据的长期保存成为可能。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eacc1c90e8314f0d83288c97fe808881~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=try%2FVa50gZQP%2BUsIIJAenxNnpx4%3D" alt="幻灯片8.png" loading="lazy"/></p>
<h2 data-id="heading-7">▌细粒度权限控制:企业级安全保障</h2>
<p>企业级数据平台必须具备完善的权限控制和安全审计能力。DLF 3.0提供了从用户管理、权限控制到审计治理的全链路安全保障体系。</p>
<p>在用户管理方面,DLF 3.0原生支持阿里云RAM用户体系,基于用户和角色进行权限管理。用户可以通过Open API和REST API进行编程式的权限配置,也可以通过控制台进行可视化管理。</p>
<p>权限控制方面,DLF 3.0支持对湖表设置ACL细粒度权限,可以精确到Catalog、Database、Table、Column(列)甚至Row(行)级别。列级权限允许用户只访问特定的列,行级权限则通过WHERE条件和AND、OR等逻辑运算符,实现对特定行范围的访问控制。列Masking功能可以对敏感字段进行脱敏处理,保护数据隐私。</p>
<p>Data Sharing能力支持跨主账号的数据协作。企业可以将特定的数据集授权给合作伙伴或其他部门,实现安全可控的数据共享。权限检索功能帮助管理员快速了解数据的授权情况,权限委托和授权管理则提供了灵活的权限分级体系。</p>
<p>审计和治理方面,DLF 3.0全面记录所有操作日志,满足生产环境的合规要求。审计管理功能支持漏洞发现和安全治理,帮助企业及时发现和修复安全隐患。这套完整的安全体系,使得DLF 3.0可以满足金融、医疗、政务等高安全要求行业的需求。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d315a473b6c482480dca3fd93946b34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=x8IENH5MQajCb9ywSg%2Bu5rFi5B0%3D" alt="幻灯片9.png" loading="lazy"/></p>
<h2 data-id="heading-8">▌实时湖仓与全模态处理:AI时代的两大刚需</h2>
<p>实时化和全模态化是AI时代数据平台的两大刚需。DLF 3.0在这两个方向上都实现了业界领先的能力。</p>
<p>在实时湖仓方面,DLF 3.0基于Paimon实现了三大核心能力:流式更新、流式订阅、实时查询。数据可以通过Flink等流计算引擎不断流式更新到湖仓中,支持大规模的增量更新和部分列更新。下游系统可以通过流式订阅的方式实时消费变更日志(Changelog),构建实时数据链路。查询层面,Paimon的数据可以被StarRocks、Hologres等OLAP引擎实时查询,延迟可以达到秒级甚至亚秒级。</p>
<p>与业界的Iceberg和Delta相比,Paimon在流式更新场景下具有明显优势。Iceberg和Delta主要面向日志场景,Compaction代价高、速度慢,难以支撑大规模流式增量更新。而中国市场的实时需求走在世界前列,Paimon正是为此而生,通过排序和文件组织优化,大幅降低了Compaction成本,实现了ODS、DWD、DWS全链路的实时更新。</p>
<p>在全模态处理方面,DLF 3.0提供了完整的多模态宽表能力。一张Paimon表可以同时存储id、url、vectors(向量)、labels(标签)、summary(文本摘要)、blobs(大型二进制对象)、meta(元数据)、json(半结构化数据)等多种类型的字段,避免了多表查询和治理负担。统一的存储底层使得数据工程师和AI工程师可以基于同一张表协作,通过高效的索引机制支持向量检索、全文检索、分析查询、模型推理、训练等多种应用场景。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f640430354942e1a42557d8844926a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=2hOuFZmPsNwNtYBfcHK7dnfhPZ4%3D" alt="幻灯片10.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7c535fedf084c0ca03036d9b863ae28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=ocDuzGLPtt7xN4ggqUmiXws7JaM%3D" alt="幻灯片11.png" loading="lazy"/></p>
<p>DLF 3.0还对接了主流的大数据处理和AI预处理框架,包括Spark、Flink、Ray、PyTorch等,提供了PyPaimon等Python原生接口,使得AI工程师可以像操作本地文件一样便捷地访问湖上数据。相比业界的LanceDB等方案,DLF 3.0具有生态丰富、统一性强、工业级验证等优势,已经在阿里巴巴集团和众多外部客户中大规模落地。</p>
<h2 data-id="heading-9">▌典型场景与客户案例:从理论到实践</h2>
<p>DLF 3.0已经在多个典型场景中得到了验证。在离线实时一体化湖仓场景中,通过Flink CDC实现数据库的实时摄取,支持Schema Evolution和整库同步,分钟级实时可查询。Flink在Paimon上进行流读流写,实现全链路实时湖仓,支持低成本的去重和部分列更新。Spark提供数仓级别的批处理性能,支持Filter/Min/Max/TopN/Limit等算子下推和Native计算加速。StarRocks和Hologres则通过Manifests缓存、删除向量、文件过滤等优化技术,实现了对Paimon湖表的极速查询,性能可以对标内表。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8125ae7d2f654e2e855c65f5b18e111e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=2W%2FmHG4XwX%2FKYJbFKYk74OlwFo8%3D" alt="幻灯片12.png" loading="lazy"/></p>
<p>在全模态数据管理和处理场景中,音频、文本、图片、视频等多模态数据通过统一的采集入湖,经过Spark或Ray进行预处理(如文本Chunking、Embedding等),将结构化标签、向量、Blob数据统一存储在一张Paimon表中。AI工程师可以通过Milvus或StarRocks进行向量检索和标量过滤,实现样本圈选和预览。PyPaimon直接对接Ray和PyTorch,支持数据加载和模型训练,整个流程端到端打通,数据无需跨系统迁移。</p>
<p>在客户案例方面,智能汽车向量湖是一个典型应用。自动驾驶场景产生海量的车载数据、地理信息、雷达数据、视频图片等多模态数据。通过DLF 3.0,这些数据统一采集并通过人工或机器打标生成Labels,经过预处理将图片、视频拆解为目标对象,再通过Embedding生成向量。Labels和向量数据构建成统一的向量湖,支持标量+向量混合检索召回,可以快速找到符合特定条件的数据样本,用于AI模型的迭代训练。整个方案实现了从数据采集到推理到检索的完整Pipeline,百亿级数据规模的混合检索性能表现优异。<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d75a9aeaf40d428db8a05c1f47193073~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=VD5RpAJvw95zH1KWHORdu5KCr%2BE%3D" alt="幻灯片13.png" loading="lazy"/></p>
<p>阿里巴巴集团内部的全模态湖也是重要实践。基于Paimon Blob字段,集团构建了EB级的多模态混合存储,支持视频、音频、图片等大型文件的高效管理。通过顺序读高吞吐的数据加载能力,GPU的数据利用率提升了10%,这对于大规模AI训练具有巨大的成本节省价值。这些真实案例充分验证了DLF 3.0全模态湖仓方案的技术先进性和商业价值。<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f355de9d818246e49e7158ec86095bcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770983660&amp;x-signature=TrJwZ%2FAaVkS%2BUFuYscKeuQ6ixHI%3D" alt="幻灯片15.png" loading="lazy"/></p>
<h2 data-id="heading-10">▌产品商业化与生态建设</h2>
<p>DLF产品已于2025年正式商业化,现在提供免费试用机会。阿里云还建立了DLF钉钉交流群(群号:106575000021),欢迎用户加入进行技术交流和问题反馈。</p>
<p>全模态湖仓代表了大数据和AI结合发展的下一阶段重要方向。随着多模态AI应用的普及,企业对统一管理和处理异构数据的需求将越来越强烈。DLF 3.0通过开放的架构、强大的性能、完善的企业级能力,为客户提供了一个面向未来的数据平台选择。无论是传统的大数据分析场景,还是新兴的AI训练推理场景,DLF 3.0都可以提供端到端的支持,帮助企业在AI时代保持竞争力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin中的JvmName注解]]></title>    <link>https://juejin.cn/post/7603556326816071732</link>    <guid>https://juejin.cn/post/7603556326816071732</guid>    <pubDate>2026-02-06T11:58:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603556326816071732" data-draft-id="7603444191448678434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin中的JvmName注解"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-02-06T11:58:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin中的JvmName注解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T11:58:30.000Z" title="Fri Feb 06 2026 11:58:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>@JvmName 是 Kotlin 中的一个注解（Annotation），主要用于自定义 Kotlin 声明（类、函数、属性等）在 JVM 平台上的名称。</p>
<p>它的核心作用是解决 Kotlin 与 Java 互操作时因命名规则差异导致的兼容性问题，让 Kotlin 代码在 Java 中调用时更灵活、更符合 Java 开发习惯。</p>
<h2 data-id="heading-0">核心作用</h2>
<p>Kotlin 的某些语法特性（如顶层函数、扩展函数、伴生对象方法等）在编译为 JVM 字节码时，默认的命名规则可能与 Java 的预期不一致。</p>
<p>例如：</p>
<p>• Kotlin 的顶层函数会被编译到名为 FileNameKt 的类中（如 Utils.kt 生成 UtilsKt 类），Java 中需通过 UtilsKt.method() 调用。</p>
<p>• Kotlin 的扩展函数在 JVM 中会生成一个静态方法，但方法名可能包含接收者类型信息（如 String.extension() 可能生成 extension(String)）。</p>
<p>@JvmName 允许开发者显式指定这些声明在 JVM 中的名称，避免默认的“不友好”命名，提升跨语言调用的可读性。</p>
<h2 data-id="heading-1">使用场景与示例</h2>
<h3 data-id="heading-2">标注顶层函数/属性（Top-level Declarations）</h3>
<p>Kotlin 的顶层函数（不在任何类或对象中定义的函数）会被编译到一个与文件名相关的类中（默认规则：文件名 + "Kt"）。使用 @JvmName 可以自定义这个类名。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 文件：StringUtils.kt</span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"StringHelper"</span>) <span class="hljs-comment">// 自定义 JVM 类名为 StringHelper（替代默认的 StringUtilsKt）</span>

<span class="hljs-keyword">package</span> com.example.utils

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isEmpty</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> = str.isEmpty()

<span class="hljs-comment">// 调用（Kotlin）：isEmpty("hello")</span>
<span class="hljs-comment">// 调用（Java，默认）：StringUtilsKt.isEmpty("hello") → 不直观</span>
<span class="hljs-comment">// 调用（Java，使用 @JvmName）：StringHelper.isEmpty("hello") → 更清晰</span>
</code></pre>
<p>说明：</p>
<p>@file:JvmName 需写在文件顶部（package 语句之前），作用于整个文件的顶层声明。value 参数为目标 JVM 类名（无需包名，包名由 package 语句决定）。</p>
<h3 data-id="heading-3">标注扩展函数/属性（Extension Declarations）</h3>
<p>Kotlin 的扩展函数在 JVM 中会生成一个静态方法，方法名默认格式为 扩展函数名(接收者类型)（如 String?.isNullOrEmpty() 生成 isNullOrEmpty(String)）。使用 @JvmName 可以自定义方法名。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 扩展函数：为 String? 添加判空扩展</span>
<span class="hljs-meta">@JvmName(<span class="hljs-string">"isStringNullOrEmpty"</span>)</span> <span class="hljs-comment">// 自定义 JVM 方法名为 isStringNullOrEmpty</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">isNullOrEmpty</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> = <span class="hljs-keyword">this</span> == <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.isEmpty()

<span class="hljs-comment">// 调用（Kotlin）：str.isNullOrEmpty()</span>
<span class="hljs-comment">// 调用（Java，默认）：StringUtilsKt.isNullOrEmpty(str) → 方法名不明确</span>
<span class="hljs-comment">// 调用（Java，使用 @JvmName）：StringUtilsKt.isStringNullOrEmpty(str) → 语义更清晰</span>
</code></pre>
<p>说明：</p>
<p>扩展函数的 @JvmName 需标注在函数上，value 参数为目标 JVM 方法名（需符合 Java 方法命名规范）。</p>
<h3 data-id="heading-4">标注伴生对象（Companion Object）的方法/属性</h3>
<p>伴生对象的成员默认在 JVM 中通过 Companion 接口访问（如 MyClass.Companion.create()）。结合 @JvmStatic 和 @JvmName，可以进一步自定义方法名。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 默认：Java 中需通过 MyClass.Companion.newInstance()</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span>: MyClass = MyClass()
        
        <span class="hljs-comment">// 使用 @JvmStatic + @JvmName：Java 中可直接通过 MyClass.newObj()</span>
        <span class="hljs-meta">@JvmStatic</span>
        <span class="hljs-meta">@JvmName(<span class="hljs-string">"newObj"</span>)</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createInstance</span><span class="hljs-params">()</span></span>: MyClass = MyClass()
    }
}

<span class="hljs-comment">// 调用（Java）：</span>
<span class="hljs-comment">// MyClass.Companion.create() → 原始方式</span>
<span class="hljs-comment">// MyClass.newObj() → 自定义名称和静态访问</span>
</code></pre>
<p>说明：</p>
<p>@JvmName 可与 @JvmStatic 配合使用，同时控制方法的 JVM 名称（静态化）和访问方式。</p>
<h3 data-id="heading-5">标注类/接口的别名（Type Aliases）</h3>
<p>Kotlin 的类型别名（typealias）在 JVM 中默认不直接暴露，但结合 @JvmName 可以为类型别名指定一个“虚拟”的 JVM 类名（通常用于文档或反射场景）。</p>
<p>示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@JvmName(<span class="hljs-string">"UserIdAlias"</span>)</span>
<span class="hljs-keyword">typealias</span> UserId = <span class="hljs-built_in">Long</span>

<span class="hljs-comment">// 反射时可通过 "UserIdAlias" 识别该类型别名（实际仍是 Long）</span>
</code></pre>
<h2 data-id="heading-6">注意事项</h2>
<p>• 避免名称冲突：自定义的 JVM 名称不能与同一包下的其他类/方法重名，否则会导致编译错误。</p>
<p>• 与 @JvmMultifileClass 配合：若多个 Kotlin 文件使用相同的 @file:JvmName，需添加 @file:JvmMultifileClass 注解，将这些文件的顶层声明合并到同一个 JVM 类中（适用于工具类拆分）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// File1.kt</span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"StringUtils"</span>)
<span class="hljs-meta">@file:JvmMultifileClass</span>
<span class="hljs-keyword">package</span> com.example.utils
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">func1</span><span class="hljs-params">()</span></span> {}

<span class="hljs-comment">// File2.kt</span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"StringUtils"</span>)
<span class="hljs-meta">@file:JvmMultifileClass</span>
<span class="hljs-keyword">package</span> com.example.utils
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">func2</span><span class="hljs-params">()</span></span> {}

<span class="hljs-comment">// Java 中可统一通过 StringUtils.func1() 和 StringUtils.func2() 调用</span>
</code></pre>
<p>• 注解位置限制：@JvmName 的位置需严格遵循语法规则（如 @file:JvmName 必须在文件顶部，@JvmName 标注函数/属性时需直接作用于声明）。</p>
<h2 data-id="heading-7">总结</h2>
<p>@JvmName 是 Kotlin 与 JVM 平台交互的重要工具，通过自定义声明在 JVM 上的名称，解决了 Kotlin 语法特性（如顶层函数、扩展函数）在 Java 中调用的兼容性问题。合理使用 @JvmName 可以显著提升跨语言代码的可读性和可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL 数据库中的锁有哪些？一篇文章给你讲明白]]></title>    <link>https://juejin.cn/post/7603561363571081279</link>    <guid>https://juejin.cn/post/7603561363571081279</guid>    <pubDate>2026-02-06T09:42:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603561363571081279" data-draft-id="7603383059152257066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL 数据库中的锁有哪些？一篇文章给你讲明白"/> <meta itemprop="keywords" content="数据库,后端"/> <meta itemprop="datePublished" content="2026-02-06T09:42:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="chlk123"/> <meta itemprop="url" content="https://juejin.cn/user/502907612446611"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL 数据库中的锁有哪些？一篇文章给你讲明白
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/502907612446611/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    chlk123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:42:43.000Z" title="Fri Feb 06 2026 09:42:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>做后端开发的朋友不管是在开发过程中还是在线上环境，亦或者是面试中，多多少少肯定都遇过 MySQL 锁相关的问题。</p>
<p>其实MySQL锁问题还挺常见的。比如线上业务突然卡顿、线上突然出现事务阻塞、死锁报错，这些问题查到最后发现基本都是 MySQL 锁冲突问题。是不是有时听别人说起行锁、表锁，自己却一头雾水？虽然MySQL 里的锁看起来五花八门，但其实 MySQL 的锁说复杂也复杂，说简单吧，理清分类逻辑就能理解了。</p>
<p>下面一张图告诉你从不同的维度理解MySQL的锁。
<img src="https://coze-coding-project.tos.coze.site/coze_storage_7603657844071661622/image/generate_image_738bf643-f355-425f-8d50-90a210ecfd63.jpeg?sign=1801902147-8517affaaf-0-52f8cb31ae23fdfa0d60cac7bc10977803d639a456ff5d9e54aee206563e2f20" alt="image" loading="lazy"/></p>
<h2 data-id="heading-0">先从分类维度理清楚</h2>
<p>MySQL 的锁说起来复杂，但其实按不同维度拆分一下就清晰多了。咱们可以从最常用的几个分类开始展开说：</p>
<h3 data-id="heading-1">1. 按锁定粒度分：表、行、页级锁</h3>
<p>这应该是最直观的分类了，毕竟锁定的范围直接影响并发性能。</p>
<ul>
<li><strong>表级锁</strong>：开销小，加锁快，也不会出现死锁，但架不住锁定粒度大啊，锁冲突概率直接拉满，并发度就高不起来了。像 MyISAM 引擎就只支持表锁，InnoDB 在特殊情况（比如全表扫描没用到索引）下也会触发表锁。</li>
<li><strong>行级锁</strong>：InnoDB 的看家本领，锁定粒度最小，锁冲突概率最低，并发度自然最高。但是吧，它开销大、加锁慢，还容易出现死锁，毕竟每个事务都盯着不同的行，一不小心就互相等对方释放锁了。</li>
<li><strong>页级锁</strong>：这个用得不多，开销和加锁时间介于表锁和行锁之间，并发度也就一般般，主要是 BDB 引擎在用，咱们日常开发接触得少，了解就行。</li>
</ul>
<h3 data-id="heading-2">2. 按锁的级别分：共享、排他、意向锁各司其职</h3>
<p>这个维度是围绕读写操作的权限来的，核心就是解决 "能不能同时读"、"能不能同时写" 的问题：</p>
<ul>
<li><strong>共享锁（S 锁 / 读锁）</strong>：顾名思义，就是多个事务可以同时加的锁，加了之后只能读不能改。比如执行<code>select ... lock in share mode</code>，其他事务也能加 S 锁读，但想加写锁就得等了。</li>
<li><strong>排他锁（X 锁 / 写锁）</strong>：这就霸道多了，一个事务加了 X 锁，其他事务啥锁都加不了，只能等着。像<code>update</code>、<code>delete</code>语句，InnoDB 会自动给涉及的行加 X 锁，<code>select ... for update</code>也能手动加。</li>
<li><strong>意向锁（IS/IX）</strong>：这个是 InnoDB 为了快速判断表中有没有行锁而搞的 "前置锁"。比如你要给某行加 S 锁，得先给表加 IS 意向共享锁；要加 X 锁，先加 IX 意向排他锁。这样当有人想加表锁的时候，不用逐行检查有没有锁，看一眼意向锁就知道了，省了不少事儿。</li>
</ul>
<h3 data-id="heading-3">3. 其他实用分类</h3>
<p>除了上面两个核心维度，还有几个分类也得知道：</p>
<ul>
<li><strong>按操作划分</strong>：DML 锁（针对数据增删改查）、DDL 锁（针对表结构修改），比如执行<code>alter table</code>的时候，就会加 DDL 写锁，阻塞所有 DML 操作。</li>
<li><strong>按加锁方式划分</strong>：自动锁（比如 InnoDB 执行<code>update</code>自动加 X 锁）和显示锁（比如手动执行<code>lock tables</code>或者<code>select ... for update</code>）。</li>
<li><strong>按并发策略划分</strong>：悲观锁和乐观锁。悲观锁就是默认觉得会有冲突，先加锁再操作，比如前面说的 X 锁、S 锁；乐观锁则是默认没冲突，用版本号或者时间戳来控制，比如更新的时候加个<code>where version = 1</code>，只有版本匹配才更新，适合并发冲突少的场景。</li>
</ul>
<h2 data-id="heading-4">几种具体的常用锁</h2>
<p>光说分类太抽象，咱们可以看看实际开发中经常遇到的锁：</p>
<h3 data-id="heading-5">全局锁：锁整个数据库实例</h3>
<p>听名字就知道范围有多大了，执行<code>flush tables with read lock</code>（FTWRL）就能给整个库加全局读锁，加了之后整个库就只读了，增删改、DDL、事务提交全都会被阻塞。
这个锁主要用在全库逻辑备份的时候，但要注意，InnoDB 可以用<code>mysqldump --single-transaction</code>来做一致性备份，不用加全局锁，因为它会启动一个事务，利用 MVCC 拿到一致性视图。但是吧，如果是 MyISAM 这种不支持事务的引擎，那还是得用 FTWRL。
这里要提个坑，别用<code>set global readonly = true</code>来代替 FTWRL，因为如果客户端异常断开，FTWRL 会自动释放锁，但<code>readonly</code>不会，搞不好就把库一直锁在那儿了。</p>
<h3 data-id="heading-6">元数据锁（MDL）：表结构守护者</h3>
<p>这个锁是 InnoDB 自动加的，你甚至感知不到它的存在，但它却很重要。比如你执行<code>select</code>、<code>update</code>这些 DML 操作，InnoDB 会自动加 MDL 读锁；执行<code>alter table</code>这种 DDL 操作，会加 MDL 写锁。
MDL 读锁之间不互斥，读锁和写锁、写锁和写锁是互斥的，这样就能防止一个事务在修改数据的时候，另一个事务突然改了表结构，导致数据不一致。
这里有个容易踩的坑：MDL 锁是在事务开始时申请，事务提交后才释放的。比如你开了一个事务，只是执行了一个<code>select</code>，这时候加了 MDL 读锁，然后你一直不提交事务，这时候别人要执行<code>alter table</code>就会被卡住，直到你提交事务。我之前就碰到过一次，排查了半天才发现是个没提交的事务占着 MDL 锁，真是血泪教训啊!
<img src="https://coze-coding-project.tos.coze.site/coze_storage_7603657844071661622/image/generate_image_db188797-e78c-40ee-ae6e-9309322da893.jpeg?sign=1801902180-a920b589c9-0-61bff1382cf2d94872609d7fd3349f6f4f6f1ddd2cd13bb461bc3fa916bd2003" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">行级锁的细分：记录锁、间隙锁、临键锁</h3>
<p>InnoDB 的行锁其实还有更细的划分，主要是为了解决幻读问题：</p>
<ul>
<li><strong>记录锁</strong>：就是给某一行记录加锁，比如<code>update user set name = '张三' where id = 1</code>，如果 id 是主键，那就是给 id=1 的这行加记录锁。</li>
<li><strong>间隙锁</strong>：这个是 InnoDB 在 RR（可重复读）隔离级别下才有的，它锁住的是两个索引记录之间的间隙，比如表中 id 有 1、3、5，执行<code>select * from user where id between 1 and 5 for update</code>，会锁住 (1,3)、(3,5) 这两个间隙，防止其他事务在中间插入 id=2 或 4 的记录，解决幻读问题。</li>
<li><strong>临键锁</strong>：这个是记录锁 + 间隙锁的组合，默认情况下 InnoDB 在 RR 隔离级别下加的行锁都是临键锁。比如执行<code>select * from user where id &gt; 3 for update</code>，会锁住 (3,5]、(5, +∞) 这些区间，既锁住了存在的记录，也锁住了可能插入的间隙。</li>
</ul>
<p><img src="https://coze-coding-project.tos.coze.site/coze_storage_7603657844071661622/image/generate_image_69f14d74-fee3-44bf-9607-fd38466ff54c.jpeg?sign=1801902160-0c1b954a34-0-dad0219fdee9363dfe53505b097bc986646edb0310e6d049b2edf17ad09a8dfe" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">最后聊聊锁的坑和优化建议</h2>
<p>说了这么多，再给大家提几个注意事项：</p>
<ol>
<li><strong>行锁变表锁</strong>：InnoDB 的行锁是基于索引的，如果你的查询没用到索引，或者索引失效了，那 InnoDB 就会退化成表锁，比如<code>update user set name = '张三' where name = '李四'</code>，如果 name 没有索引，那就是全表扫描，加表锁，并发瞬间就没了。</li>
<li><strong>死锁问题</strong>：行锁容易出现死锁，比如事务 A 锁住了行 1，等着行 2；事务 B 锁住了行 2，等着行 1，这就死锁了。InnoDB 默认会开启死锁检测，发现死锁后会回滚代价小的事务，也可以通过<code>innodb_lock_wait_timeout</code>设置等待超时时间，默认是 50 秒。</li>
<li><strong>合理选择隔离级别</strong>：如果你的业务能接受幻读，把隔离级别改成 RC（读已提交），那 InnoDB 就不会用间隙锁和临键锁了，能减少锁冲突，提升并发性能。</li>
</ol>
<p>其实吧，MySQL 的锁虽然多，但只要理清分类，理解每种锁的适用场景和底层逻辑，遇到问题的时候就能快速定位了。比如线上出现锁等待，先看看是表锁还是行锁，再看看是哪个事务占着锁，一步步排查总能解决的。</p>
<p>最后想问下，你在开发中遇到过最头疼的锁问题是什么？欢迎在评论区交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BigInt 与 Number 的爱恨情仇，为何大佬都劝你“能用 Number 就别用 BigInt”？]]></title>    <link>https://juejin.cn/post/7603393977477447706</link>    <guid>https://juejin.cn/post/7603393977477447706</guid>    <pubDate>2026-02-06T09:50:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603393977477447706" data-draft-id="7603321550247346226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BigInt 与 Number 的爱恨情仇，为何大佬都劝你“能用 Number 就别用 BigInt”？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T09:50:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gogo1121"/> <meta itemprop="url" content="https://juejin.cn/user/4162081326907051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BigInt 与 Number 的爱恨情仇，为何大佬都劝你“能用 Number 就别用 BigInt”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4162081326907051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gogo1121
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:50:29.000Z" title="Fri Feb 06 2026 09:50:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>最近在写业务逻辑时，遇到一个非常诡异的 Bug。</p>
<p>数据库里的 User ID 是 <code>101092432494557966</code>，但是前端请求回来的数据里，ID 竟然变成了 <code>101092432494557970</code>！</p>
<p>尾数的 <code>66</code> 变成了 <code>70</code>，导致前端拿这个 ID 去查详情时，直接报 404 Not Found。</p>
<p>这简直是“灵异事件”。查了一圈代码，发现罪魁祸首竟然是 <strong>JavaScript 的 Number 类型</strong>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟案发现场</span>
<span class="hljs-keyword">const</span> dbId = <span class="hljs-number">101092432494557966n</span>; <span class="hljs-comment">// BigInt 从数据库出来</span>
<span class="hljs-keyword">const</span> apiResponse = <span class="hljs-title class_">Number</span>(dbId); <span class="hljs-comment">// 手贱转成了 Number</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(apiResponse); 
<span class="hljs-comment">// 输出: 101092432494557970 😱</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>为什么会这样？这就引出了今天的主角：<strong>BigInt</strong> 与 <strong>Number</strong>。</p>
<hr/>
<h2 data-id="heading-0">🔍 原理剖析：Number 的“安全区”</h2>
<p>JavaScript 的 <code>Number</code> 类型本质上是 <strong>IEEE 754 双精度浮点数</strong>。</p>
<p>它不是无限精度的，它只有 <strong>53 个二进制位</strong> 用来存储有效数字（尾数）。</p>
<h3 data-id="heading-1">1. 安全整数范围</h3>
<p>JS 能“精准”表示的最大整数是 <code>Number.MAX_SAFE_INTEGER</code>，即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>53</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{53} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">53</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>。</p>
<p>数值为：<strong>9,007,199,254,740,991</strong>（约 9 千万亿）。</p>
<h3 data-id="heading-2">2. 精度丢失的真相</h3>
<p>一旦数字超过这个安全范围（比如上面的 18 位 ID），Number 的“刻度尺”就不够用了。它无法分辨 <code>...966</code> 和 <code>...970</code> 之间的微小差别，只能进行“四舍五入”，强制对齐到最近的一个可表示数值。</p>
<p>这就是为什么你的 ID 会变异。</p>
<hr/>
<h2 data-id="heading-3">⚔️ BigInt 的救赎与“三宗罪”</h2>
<p>为了解决这个问题，ES2020 推出了 <code>BigInt</code>。它可以表示任意大的整数。</p>
<p>看起来很美好对吧？数据库里的 <code>bigint</code> 字段直接映射成 JS 的 <code>BigInt</code> 好像很完美。</p>
<p><strong>但是，在实际工程中，BigInt 其实是个“刺头”。</strong> 很多资深开发者的原则是：<strong>除非迫不得已，尽量用 Number。</strong></p>
<p>为什么？因为 BigInt 有三大“工程痛点”：</p>
<h3 data-id="heading-4">痛点一：JSON 序列化炸弹（最致命）</h3>
<p>这是 Node.js/NestJS 开发中最容易踩的坑。</p>
<p><strong><code>JSON.stringify</code> 不支持 BigInt！</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> user = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">100n</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">"John"</span>
};

<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(user);
<span class="hljs-comment">// ❌ 报错: TypeError: Do not know how to serialize a BigInt</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>如果你的接口直接返回了包含 BigInt 的对象，整个请求会直接 500 挂掉。你必须手动处理每一个字段，或者配置全局拦截器，非常麻烦。</p>
<h3 data-id="heading-5">痛点二：生态隔离</h3>
<p>JavaScript 生态中 99% 的第三方库（Lodash, Chart.js, Mathjs, Excel 导出库等）都是基于 <code>Number</code> 设计的。</p>
<p>如果你传一个 <code>BigInt</code> 进去，它们大概率会报错，或者计算出奇怪的结果。为了兼容，你不得不转来转去，代码写得像通心粉。</p>
<h3 data-id="heading-6">痛点三：严苛的类型运算</h3>
<p>JS 不允许 BigInt 和 Number 混合运算，必须显式转换。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">money</span> = <span class="hljs-number">100</span>n<span class="hljs-comment">;</span>
const <span class="hljs-attr">tax</span> = <span class="hljs-number">0.1</span><span class="hljs-comment">;</span>

// ❌ 报错: Cannot mix BigInt and other types
const <span class="hljs-attr">total</span> = money + tax<span class="hljs-comment">; </span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这在业务逻辑复杂的代码中，会增加大量的心智负担。</p>
<hr/>
<h2 data-id="heading-7">💡 最佳实践：怎么选？怎么存？怎么传？</h2>
<p>既然 Number 有精度上限，BigInt 又难用，我们在项目中到底该怎么办？</p>
<p>以下是经过实战验证的 <strong>“黄金法则”</strong> 。</p>
<h3 data-id="heading-8">1. 什么时候必须用 BigInt？</h3>
<p>只有满足以下条件时，才引入 BigInt：</p>
<ul>
<li><strong>分布式 ID (Snowflake)</strong> ：如 Twitter 雪花算法生成的 ID（18-19 位），必超 Number 安全范围。</li>
<li><strong>高精度时间戳</strong>：纳秒级计时。</li>
<li><strong>加密货币/金融</strong>：涉及比特币等超大数值计算。</li>
</ul>
<h3 data-id="heading-9">2. 什么时候坚决用 Number？</h3>
<ul>
<li><strong>金额（分）</strong> ：只要业务不超过 <strong>9 千万亿</strong>（相信我，你公司的业务很难超过这个数），存“分”用 Number 绰绰有余。</li>
<li><strong>普通自增 ID</strong>：MySQL 的自增主键。</li>
<li><strong>数量、库存、点赞数</strong>。</li>
</ul>
<p><strong>理由</strong>：享受原生 JSON 支持，享受极致的 CPU 浮点运算速度，兼容所有第三方库。</p>
<h3 data-id="heading-10">3. 工程化解决方案（核心）</h3>
<p>针对“ID 精度丢失”和“JSON 报错”问题，标准的解决链路如下：</p>
<ul>
<li>
<p><strong>数据库层</strong>：必须用 <code>BIGINT</code> 或 <code>VARCHAR</code> 存储，确保源头不丢。</p>
</li>
<li>
<p><strong>后端计算层</strong>：</p>
<ul>
<li>如果是 ID：用 <code>BigInt</code> 或 <code>String</code> 传递。</li>
<li>如果是金额：用 <code>Number</code> 计算（在安全范围内）。</li>
</ul>
</li>
<li>
<p><strong>接口返回层（DTO）—— 关键一步！</strong></p>
</li>
</ul>
<p><strong>千万不要把 BigInt 直接丢给前端！</strong></p>
<p><strong>千万不要把 BigInt 转成 Number 丢给前端！</strong></p>
<p>✅ <strong>正确做法</strong>：在返回给前端的那一刻，把 <strong>大数 ID 转成 String</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// NestJS DTO 示例</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Transform</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-transformer'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDto</span> {
  <span class="hljs-comment">// 1. 数据库里是 BigInt</span>
  <span class="hljs-comment">// 2. 这里的 Transform 负责在序列化给前端时，转成 String</span>
  <span class="hljs-meta">@Transform</span>(<span class="hljs-function">(<span class="hljs-params">{ value }</span>) =&gt;</span> <span class="hljs-title class_">String</span>(value))
  <span class="hljs-attr">unionId</span>: <span class="hljs-built_in">string</span>; 

  <span class="hljs-comment">// 金额如果没超限，直接用 Number</span>
  <span class="hljs-attr">balance</span>: <span class="hljs-built_in">number</span>; 
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>前端 JavaScript 处理大数 ID 的唯一标准方案就是：<strong>把它当字符串处理</strong>。</p>
<hr/>
<h2 data-id="heading-11">📝 总结</h2>
<ol>
<li>
<p><strong>精度陷阱</strong>：超过 16 位的数字用 <code>Number</code> 存一定会丢精度，ID 会变异。</p>
</li>
<li>
<p><strong>序列化坑</strong>：<code>BigInt</code> 无法被 JSON 序列化，会导致接口报错。</p>
</li>
<li>
<p><strong>选型原则</strong>：</p>
<ul>
<li><strong>能用 Number 就用 Number</strong>（金额、计数、普通 ID）。</li>
<li><strong>超长 ID 必须用 BigInt/String</strong>。</li>
</ul>
</li>
<li>
<p><strong>传输原则</strong>：后端计算可以用 BigInt，但<strong>给前端的数据，必须是 String</strong>。</p>
</li>
</ol>
<p>以后再看到后端传回来的 ID 尾数不对，别犹豫，直接去检查是不是中间某一步被偷偷转成 <code>Number</code> 了！</p>
<hr/>
<p><em>觉得有用的话，点赞收藏防踩坑！</em> 👍</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多卡数据切换流程]]></title>    <link>https://juejin.cn/post/7603359026711592970</link>    <guid>https://juejin.cn/post/7603359026711592970</guid>    <pubDate>2026-02-06T09:39:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603359026711592970" data-draft-id="7603359026711576586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多卡数据切换流程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T09:39:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多卡数据切换流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:39:01.000Z" title="Fri Feb 06 2026 09:39:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1️⃣ <strong>整体流程架构</strong></h2>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│ 用户操作：在设置中选择默认数据卡                         │
└──────────────────┬──────────────────────────────────────┘
                   │ Settings<span class="hljs-selector-class">.Global</span><span class="hljs-selector-class">.putInt</span>(
                   │ MULTI_SIM_DATA_CALL_SUBSCRIPTION, subId)
                   ▼
┌─────────────────────────────────────────────────────────┐
│ SubscriptionManagerService 监听 WatchedInt 变化         │
│ mDefaultDataSubId<span class="hljs-selector-class">.set</span>(newValue)                         │
│ → Settings<span class="hljs-selector-class">.Global</span> 同步更新                             │
└──────────────────┬──────────────────────────────────────┘
                   │ mDefaultDataSubIdChangedRegistrants
                   │ <span class="hljs-selector-class">.notifyRegistrants</span>()
                   ▼
┌─────────────────────────────────────────────────────────┐
│ MultiSimSettingController                              │
│ EVENT_DEFAULT_DATA_SUBSCRIPTION_CHANGED                 │
│ → <span class="hljs-built_in">onDefaultDataSettingChanged</span>()                         │
└──────────────────┬──────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────┐
│ PhoneSwitcher                                           │
│ <span class="hljs-built_in">notifyDefaultDataSubChanged</span>()                           │
│ → <span class="hljs-built_in">onEvaluate</span>() 重新评估应该激活哪些 Modem              │
└──────────────────┬──────────────────────────────────────┘
                   │
         ┌─────────┴──────────────┐
         │                        │
         ▼                        ▼
    ┌──────────┐        ┌───────────────┐
    │ 旧数据卡  │        │ 新数据卡       │
    │ 停用      │        │ 激活           │
    │deactivate│        │activate        │
    └────┬─────┘        └────┬──────────┘
         │                    │
         ▼                    ▼
  ┌──────────────┐   ┌──────────────────┐
  │ setDataAllowed│  │ setDataAllowed    │
  │ (false)       │  │ (true)            │
  │ → RIL         │  │ → RIL             │
  └────┬─────────┘   └────┬─────────────┘
       │                   │
       ▼                   ▼
  ┌──────────────┐   ┌──────────────────┐
  │ 释放旧连接    │   │ 建立新连接        │
  │ PDP 去激活    │   │ PDP 激活          │
  │ 网络指示      │   │ 网络指示          │
  └────┬─────────┘   └────┬─────────────┘
       │                   │
       └─────────┬─────────┘
                 │
                 ▼
    ┌─────────────────────────┐
    │ ConnectivityService     │
    │ 更新默认网络            │
    │ 应用切换网络            │
    └─────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-1">2️⃣ <strong>详细执行步骤</strong></h2>
<h3 data-id="heading-2"><strong>Step 1: 用户设置变化 (Settings 层)</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 位置：frameworks_opt_telephony/src/java/com/android/internal/telephony/</span>
<span class="hljs-comment">// subscription/SubscriptionManagerService.java:505-519</span>

mDefaultDataSubId = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WatchedInt</span>(
    Settings.Global.getInt(
        mContext.getContentResolver(),
        Settings.Global.MULTI_SIM_DATA_CALL_SUBSCRIPTION,  ◄──── Key!
        SubscriptionManager.INVALID_SUBSCRIPTION_ID)) {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">set</span><span class="hljs-params">(<span class="hljs-type">int</span> newValue)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> mValue;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">super</span>.set(newValue)) {
            logl(<span class="hljs-string">"Default data subId changed from "</span> + oldValue + <span class="hljs-string">" to "</span> + newValue);
            <span class="hljs-comment">// 同步更新 Settings.Global</span>
            Settings.Global.putInt(mContext.getContentResolver(),
                    Settings.Global.MULTI_SIM_DATA_CALL_SUBSCRIPTION, newValue);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
};
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>WatchedInt</code> 是一个被 "监视" 的整数</li>
<li>当值改变时会自动触发注册的 registrant</li>
<li>同时同步更新到 Settings.Global 数据库</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>Step 2: MultiSimSettingController 响应 (协调器)</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 位置：MultiSimSettingController.java:319-350</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyDefaultDataSubChanged</span><span class="hljs-params">()</span> {
    obtainMessage(EVENT_DEFAULT_DATA_SUBSCRIPTION_CHANGED).sendToTarget();
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
    <span class="hljs-keyword">switch</span> (msg.what) {
        <span class="hljs-keyword">case</span> EVENT_DEFAULT_DATA_SUBSCRIPTION_CHANGED:
            onDefaultDataSettingChanged();  ◄──── 处理默认数据卡变化
            <span class="hljs-keyword">break</span>;
    }
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDefaultDataSettingChanged</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 验证数据卡有效性</span>
    <span class="hljs-comment">// 同步关联订阅的设置（如数据漫游）</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">defaultDataSubId</span> <span class="hljs-operator">=</span> mSubscriptionManagerService.getDefaultDataSubId();
    
    <span class="hljs-comment">// 通知 PhoneSwitcher</span>
    PhoneSwitcher.getInstance().notifyDefaultDataSubChanged();
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>协调多张卡的设置</li>
<li>确保同组订阅的设置一致</li>
<li>触发 PhoneSwitcher 的重新评估</li>
</ul>
<hr/>
<h3 data-id="heading-4"><strong>Step 3: PhoneSwitcher 评估 (决策点) ⭐</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 位置：PhoneSwitcher.java:1430-1480</span>

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updatePreferredDataPhoneId</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 优先级决策：</span>
    
    <span class="hljs-comment">// 1️⃣ 紧急情况：优先级最高</span>
    <span class="hljs-keyword">if</span> (mEmergencyOverride != <span class="hljs-literal">null</span>) {
        mPreferredDataPhoneId = mEmergencyOverride.mPhoneId;
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 2️⃣ 有通话时：如果启用了 "通话期间数据切换"</span>
    <span class="hljs-keyword">if</span> (isAnyVoiceCallActiveOnDevice() &amp;&amp; shouldSwitchDataDueToInCall()) {
        mPreferredDataPhoneId = mPhoneIdInVoiceCall;  <span class="hljs-comment">// 切换到通话卡</span>
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 3️⃣ 自动切换建议：CBRS 等</span>
    <span class="hljs-keyword">if</span> (mAutoSelectedDataSubId != DEFAULT_SUBSCRIPTION_ID) {
        mPreferredDataPhoneId = getPhoneIdBySubId(mAutoSelectedDataSubId);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 4️⃣ 用户选择的默认数据卡：最终方案</span>
    <span class="hljs-keyword">if</span> (SubscriptionManager.isUsableSubIdValue(mPrimaryDataSubId)) {
        mPreferredDataPhoneId = mSubscriptionManagerService.getPhoneId(mPrimaryDataSubId);
    }
}

<span class="hljs-comment">// 关键方法：评估是否需要改变激活的 Modem</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onEvaluate</span><span class="hljs-params">(<span class="hljs-type">boolean</span> requestsChanged, String evaluationReason)</span> {
    logl(<span class="hljs-string">"onEvaluate: "</span> + evaluationReason);
    
    <span class="hljs-keyword">if</span> (updatesIfPhoneInVoiceCallChanged()      ◄──── 通话状态
        || updatesIfSubscriptionChanged()         ◄──── 订阅变化
        || updatesIfActiveModemCountChanged()) {  ◄──── Modem 数
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    updatePreferredDataPhoneId();  ◄──── 更新偏好数据 Modem
    
    <span class="hljs-comment">// ... 计算应该激活哪些 Modem ...</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">phoneId</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; phoneId &lt; mActiveModemCount; phoneId++) {
        <span class="hljs-keyword">if</span> (!newActivePhones.contains(phoneId)) {
            deactivate(phoneId);   ◄──── 停用旧数据卡
        }
    }
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> phoneId : newActivePhones) {
        activate(phoneId);         ◄──── 激活新数据卡
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>决策流程</strong>（优先级从高到低）：</p>
<ol>
<li><strong>紧急通话</strong> - 必须优先</li>
<li><strong>有语音通话且启用通话期间数据切换</strong> - 防止数据丢失</li>
<li><strong>自动切换建议</strong>（如 CBRS）</li>
<li><strong>用户选择的默认数据卡</strong></li>
</ol>
<hr/>
<h3 data-id="heading-5"><strong>Step 4: 停用/激活 Modem (执行层)</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// PhoneSwitcher.java:1307-1322</span>

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">activate</span><span class="hljs-params">(<span class="hljs-type">int</span> phoneId)</span> {
    switchPhone(phoneId, <span class="hljs-literal">true</span>);
}

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deactivate</span><span class="hljs-params">(<span class="hljs-type">int</span> phoneId)</span> {
    switchPhone(phoneId, <span class="hljs-literal">false</span>);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">switchPhone</span><span class="hljs-params">(<span class="hljs-type">int</span> phoneId, <span class="hljs-type">boolean</span> active)</span> {
    <span class="hljs-type">PhoneState</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> mPhoneStates[phoneId];
    <span class="hljs-keyword">if</span> (state.active == active) <span class="hljs-keyword">return</span>;  ◄──── 避免重复操作
    
    state.active = active;
    logl((active ? <span class="hljs-string">"activate "</span> : <span class="hljs-string">"deactivate "</span>) + phoneId);
    state.lastRequested = System.currentTimeMillis();
    
    sendRilCommands(phoneId);  ◄──── 发送给 RIL
}

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendRilCommands</span><span class="hljs-params">(<span class="hljs-type">int</span> phoneId)</span> {
    <span class="hljs-keyword">if</span> (!SubscriptionManager.isValidPhoneId(phoneId)) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> Message.obtain(<span class="hljs-built_in">this</span>, EVENT_MODEM_COMMAND_DONE, phoneId);
    
    <span class="hljs-keyword">if</span> (mActiveModemCount &gt; <span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 调用 RIL 的 setDataAllowed</span>
        PhoneFactory.getPhone(phoneId)
            .mCi.setDataAllowed(isPhoneActive(phoneId), message);
                             ▲
                             │
                    ┌────────┴───────────┐
                    │                    │
                 <span class="hljs-literal">true</span> (激活)          <span class="hljs-literal">false</span> (停用)
    }
}
</code></pre>
<p><strong>关键：setDataAllowed 的含义</strong></p>
<ul>
<li><code>true</code> - 告诉 Modem："允许这个 SIM 卡建立数据连接"</li>
<li><code>false</code> - 告诉 Modem："禁止这个 SIM 卡建立数据连接"</li>
</ul>
<hr/>
<h3 data-id="heading-6"><strong>Step 5: RIL 处理 (通信层)</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RIL.java:4166-4182</span>

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDataAllowed</span><span class="hljs-params">(<span class="hljs-type">boolean</span> allowed, Message result)</span> {
    <span class="hljs-type">RadioDataProxy</span> <span class="hljs-variable">dataProxy</span> <span class="hljs-operator">=</span> getRadioServiceProxy(RadioDataProxy.class);
    <span class="hljs-keyword">if</span> (!canMakeRequest(<span class="hljs-string">"setDataAllowed"</span>, dataProxy, result, 
            RADIO_HAL_VERSION_1_4)) {
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-type">RILRequest</span> <span class="hljs-variable">rr</span> <span class="hljs-operator">=</span> obtainRequest(RIL_REQUEST_ALLOW_DATA, result, 
            mRILDefaultWorkSource);
    
    riljLog(rr.serialString() + <span class="hljs-string">"&gt; setDataAllowed allowed = "</span> + allowed);
    
    <span class="hljs-comment">// 通过 HIDL/AIDL 发送给 Radio HAL</span>
    radioServiceInvokeHelper(HAL_SERVICE_DATA, rr, <span class="hljs-string">"setDataAllowed"</span>, () -&gt; {
        dataProxy.setDataAllowed(rr.mSerial, allowed);
    });
}
</code></pre>
<hr/>
<h3 data-id="heading-7"><strong>Step 6: Modem 处理 (硬件层)</strong></h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// hardware_ril/libril/ril_service.cpp:2359-2363</span>

Return&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title function_">RadioImpl::setDataAllowed</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> serial, <span class="hljs-type">bool</span> allow)</span> {
    RLOGD(<span class="hljs-string">"setDataAllowed: serial %d"</span>, serial);
    
    <span class="hljs-comment">// 发送 RIL 请求到 RIL daemon</span>
    dispatchInts(serial, mSlotId, RIL_REQUEST_ALLOW_DATA, 
            <span class="hljs-number">1</span>, BOOL_TO_INT(allow));
    <span class="hljs-keyword">return</span> Void();
}

<span class="hljs-comment">// Modem 接收到后：</span>
<span class="hljs-comment">// - allow = true:  PDP 激活条件满足，启动连接</span>
<span class="hljs-comment">// - allow = false: PDP 停用，释放连接，断开网络</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">3️⃣ <strong>切换过程中避免网络断连的方案</strong></h2>
<h3 data-id="heading-9"><strong>问题分析</strong></h3>
<pre><code class="hljs language-makefile" lang="makefile">时间线：
<span class="hljs-section">0ms:    用户切换 SIM 卡</span>
<span class="hljs-section">10ms:   旧 SIM 卡 → setDataAllowed(false)</span>
<span class="hljs-section">20ms:   Modem 释放旧连接 ❌ 网络断连（&lt;1s）</span>
<span class="hljs-section">100ms:  新 SIM 卡 → setDataAllowed(true)</span>
<span class="hljs-section">300ms:  新连接建立 ✓ 网络恢复</span>

问题：中间的 80-280ms 内没有数据连接！
应用在这段时间的传输会失败。
</code></pre>
<h3 data-id="heading-10"><strong>优化方案 1: 快速序列（当前实现）</strong></h3>
<pre><code class="hljs language-makefile" lang="makefile">特点：依赖 Modem 的快速处理

时间线：
<span class="hljs-section">0ms:    旧 setDataAllowed(false)  + 新 setDataAllowed(true)</span>
        ↓ 同步发出 (几乎同时)
<span class="hljs-section">10ms:   Modem 收到两个命令</span>
<span class="hljs-section">20ms:   Modem 同时处理：</span>
        - 旧连接 DETACH
        - 新连接 ATTACH
        这个瞬间，新连接可能已经初始化！

优点：速度最快，断连时间 &lt; 100ms
缺点：依赖 Modem 实现，不同厂商行为不同
</code></pre>
<p><strong>代码实现（推荐）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 PhoneSwitcher 中修改 switchPhone 逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">switchPhoneOptimized</span><span class="hljs-params">(<span class="hljs-type">int</span> oldPhoneId, <span class="hljs-type">int</span> newPhoneId)</span> {
    <span class="hljs-comment">// 同步发送两个命令，而不是顺序发送</span>
    <span class="hljs-type">Message</span> <span class="hljs-variable">message1</span> <span class="hljs-operator">=</span> Message.obtain(<span class="hljs-built_in">this</span>, EVENT_MODEM_COMMAND_DONE, oldPhoneId);
    <span class="hljs-type">Message</span> <span class="hljs-variable">message2</span> <span class="hljs-operator">=</span> Message.obtain(<span class="hljs-built_in">this</span>, EVENT_MODEM_COMMAND_DONE, newPhoneId);
    
    PhoneFactory.getPhone(oldPhoneId).mCi.setDataAllowed(<span class="hljs-literal">false</span>, message1);
    PhoneFactory.getPhone(newPhoneId).mCi.setDataAllowed(<span class="hljs-literal">true</span>, message2);
    
    logl(<span class="hljs-string">"Simultaneous switch: "</span> + oldPhoneId + <span class="hljs-string">" -&gt; "</span> + newPhoneId);
}
</code></pre>
<h3 data-id="heading-11"><strong>优化方案 2: 带验证的切换</strong></h3>
<pre><code class="hljs language-makefile" lang="makefile">特点：确保新卡网络有效后再断开旧卡

流程：
<span class="hljs-section">0ms:    激活新 SIM 卡 → setDataAllowed(true)</span>
<span class="hljs-section">100ms:  等待 ConnectivityService 验证网络</span>
<span class="hljs-section">300ms:  验证成功 ✓</span>
<span class="hljs-section">400ms:  此时停用旧卡 → setDataAllowed(false)</span>

优点：保证网络连续性，无断连
缺点：延迟增加（通常 400-500ms）
       短期内有两个连接（费电）

实现位置：PhoneSwitcher.java
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 CellularNetworkValidator 验证网络</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">switchPhoneWithValidation</span><span class="hljs-params">(<span class="hljs-type">int</span> oldPhoneId, <span class="hljs-type">int</span> newPhoneId)</span> {
    <span class="hljs-comment">// 1️⃣ 先激活新卡</span>
    activate(newPhoneId);
    
    <span class="hljs-comment">// 2️⃣ 启动网络验证</span>
    mValidator.validate(getSubIdByPhoneId(newPhoneId),
            <span class="hljs-literal">true</span>,  <span class="hljs-comment">// needValidation</span>
            DataSwitch.Reason.DATA_SWITCH_REASON_USER,
            (validated, subId) -&gt; {
                <span class="hljs-keyword">if</span> (validated) {
                    <span class="hljs-comment">// 3️⃣ 验证成功，停用旧卡</span>
                    logl(<span class="hljs-string">"Network validated, deactivating old phone: "</span> + oldPhoneId);
                    deactivate(oldPhoneId);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// ❌ 验证失败，回滚到旧卡</span>
                    logl(<span class="hljs-string">"Validation failed, reverting to old phone: "</span> + oldPhoneId);
                    deactivate(newPhoneId);
                    activate(oldPhoneId);
                }
            });
}
</code></pre>
<h3 data-id="heading-12"><strong>优化方案 3: 应用缓冲</strong></h3>
<pre><code class="hljs">在应用层实现缓冲，减少切换影响：

1️⃣ 检测到网络切换（ConnectivityManager.NetworkCallback）
2️⃣ 缓冲待发送数据（100-300ms）
3️⃣ 新网络建立后，发送缓冲数据
4️⃣ 提高用户体验

优点：对系统无侵入，应用自主控制
缺点：每个应用都需要实现
</code></pre>
<hr/>
<h2 data-id="heading-13">4️⃣ <strong>应用正在传输数据时的切换处理</strong></h2>
<h3 data-id="heading-14"><strong>场景分析</strong></h3>
<pre><code class="hljs language-makefile" lang="makefile">应用场景：用户在下载时切换 SIM 卡

时间线：
<span class="hljs-section">0ms:    下载 file.bin (SIM1, 10MB, 进度 30%)</span>
<span class="hljs-section">100ms:  用户切换到 SIM2</span>
<span class="hljs-section">110ms:  旧连接断开 ❌</span>
<span class="hljs-section">120ms:  新连接建立</span>
<span class="hljs-section">130ms:  下载继续 (从头？从断点？)</span>

问题：连接中断，下载暂停甚至失败！
</code></pre>
<h3 data-id="heading-15"><strong>Android 系统处理机制</strong></h3>
<pre><code class="hljs language-scss" lang="scss">ConnectivityService 的自动恢复：

事件                    系统行为
─────────────────────────────────────────
<span class="hljs-number">1</span>. 数据连接丢失         DetectableConnectivityError
                        → 回调应用 <span class="hljs-built_in">onLost</span>()
                        
<span class="hljs-number">2</span>. 应用收到 <span class="hljs-built_in">onLost</span>()    应该：
                        - 暂停所有数据传输
                        - 保存进度信息
                        - 等待新网络
                        
<span class="hljs-number">3</span>. 新网络可用           <span class="hljs-built_in">onAvailable</span>()
                        → 应用恢复传输（从断点）
                        
<span class="hljs-number">4</span>. ConnectivityManager
   <span class="hljs-built_in">validateNetwork</span>()     确保新网络真的可用
</code></pre>
<h3 data-id="heading-16"><strong>推荐的应用处理方式</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 位置：应用代码</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataDownloadManager</span>(context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> connectivityManager = 
        context.getSystemService&lt;ConnectivityManager&gt;()!!
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> networkCallback = <span class="hljs-keyword">object</span> : ConnectivityManager.NetworkCallback() {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLost</span><span class="hljs-params">(network: <span class="hljs-type">Network</span>)</span></span> {
            <span class="hljs-comment">// 1️⃣ 检测到网络丢失</span>
            logg(<span class="hljs-string">"Network lost, pausing download"</span>)
            pauseAllDownloads()  <span class="hljs-comment">// 暂停下载</span>
            saveProgress()       <span class="hljs-comment">// 保存进度</span>
        }
        
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAvailable</span><span class="hljs-params">(network: <span class="hljs-type">Network</span>)</span></span> {
            <span class="hljs-comment">// 2️⃣ 新网络可用</span>
            logg(<span class="hljs-string">"Network available, resuming download"</span>)
            resumeDownloads()    <span class="hljs-comment">// 从断点恢复</span>
        }
        
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCapabilitiesChanged</span><span class="hljs-params">(
            network: <span class="hljs-type">Network</span>,
            caps: <span class="hljs-type">NetworkCapabilities</span>)</span></span> {
            <span class="hljs-comment">// 3️⃣ 检查网络是否已验证</span>
            <span class="hljs-keyword">if</span> (caps.hasCapability(NET_CAPABILITY_VALIDATED)) {
                logg(<span class="hljs-string">"Network validated"</span>)
                <span class="hljs-comment">// 现在安全发送数据</span>
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMonitoring</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> request = NetworkRequest.Builder()
            .addCapability(NET_CAPABILITY_INTERNET)
            .addCapability(NET_CAPABILITY_NOT_RESTRICTED)
            .build()
        
        connectivityManager.registerNetworkCallback(request, networkCallback)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">pauseAllDownloads</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 暂停所有下载任务</span>
        <span class="hljs-comment">// 记录当前位置</span>
        downloads.forEach { it.pause() }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveProgress</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 保存进度到数据库或文件</span>
        downloads.forEach { download -&gt;
            database.updateProgress(download.id, download.currentBytes)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">resumeDownloads</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 从保存的断点恢复</span>
        downloads.forEach { download -&gt;
            <span class="hljs-keyword">val</span> savedProgress = database.getProgress(download.id)
            download.resume(savedProgress)
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-17">5️⃣ <strong>两张卡都是 4G 时的切换延迟分析</strong></h2>
<h3 data-id="heading-18"><strong>延迟来源分解</strong></h3>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────────────────────────────────────────────┐
│ 多卡数据切换总延迟 = Δt<span class="hljs-emphasis">_total                          │
└─────────────────────────────────────────────────────────┘

Δt_</span>total 包含以下部分：

<span class="hljs-bullet">1.</span> 应用层感知 (10-50ms) 
   Settings.Global 变化 → SubscriptionManagerService

<span class="hljs-bullet">2.</span> MultiSimSettingController 处理 (5-20ms)
   事件分发 → 有效性校验

<span class="hljs-bullet">3.</span> PhoneSwitcher 评估 (20-100ms) ⭐⭐⭐ 最长
<span class="hljs-bullet">   -</span> onEvaluate() 遍历所有网络请求
<span class="hljs-bullet">   -</span> 更新所有优先级
<span class="hljs-bullet">   -</span> 决策激活/停用 Modem
   
<span class="hljs-bullet">4.</span> RIL 命令发送 (5-10ms)
   Java → C++ → HIDL/AIDL 消息传递

<span class="hljs-bullet">5.</span> Modem DETACH (旧卡) (200-500ms) ⭐⭐⭐ 关键
<span class="hljs-bullet">   -</span> 通知网络（NW：释放连接）
<span class="hljs-bullet">   -</span> 等待网络确认
<span class="hljs-bullet">   -</span> 关闭 PDP 上下文
<span class="hljs-bullet">   -</span> 两张都是 4G 时，这通常很快 (200-300ms)

<span class="hljs-bullet">6.</span> Modem ATTACH (新卡) (200-800ms) ⭐⭐⭐ 最不确定
   两张卡都是 4G 时的关键：
   
   a) 搜网 (50-200ms)
<span class="hljs-bullet">      -</span> 如果已经驻留，可能 0-50ms
<span class="hljs-bullet">      -</span> 如果需要搜网，可能 100-200ms
<span class="hljs-code">      
   b) 认证/附着 (100-300ms)
      - MME/HSS 认证
      - GUTI 分配等
      
   c) PDN 建立 (100-300ms)
      - PDP 激活
      - 获取 IP 地址
      
   总计：200-800ms
   
   两张 4G 时优化：
   - 如果两张都已驻留：可降至 200-300ms
   - 如果切换到信号弱的卡：可能 500-800ms
</span>
<span class="hljs-bullet">7.</span> ConnectivityService 检测 (0-100ms)
   onAvailable() 回调

<span class="hljs-bullet">8.</span> 应用感知 (0-1000ms+)
   取决于应用是否监听 NetworkCallback

────────────────────────────────────────────────

总合（最优情况）：
10 + 5 + 50 + 5 + 250 + 250 + 50 + 100 = 720ms

总合（最坏情况）：
50 + 20 + 100 + 10 + 500 + 800 + 100 + 1000 = 2580ms

两张 4G 时的期望值：500-800ms
</code></pre>
<h3 data-id="heading-19"><strong>可接受的延迟基准</strong></h3>
<pre><code class="hljs language-markdown" lang="markdown">应用类型               可接受延迟        说明
─────────────────────────────────────────────────
<span class="hljs-bullet">1.</span> 网页浏览            &lt; 3 秒           用户感知不强
<span class="hljs-bullet">2.</span> 实时通话(VoIP)      &lt; 1 秒           时延敏感，需验证
<span class="hljs-bullet">3.</span> 在线游戏            &lt; 500ms          关键，需回滚机制
<span class="hljs-bullet">4.</span> 视频流播放          &lt; 2 秒           需缓冲策略
<span class="hljs-bullet">5.</span> 文件下载            无限制           应用缓冲处理
<span class="hljs-bullet">6.</span> 短视频(抖音)        &lt; 2 秒           用户容忍度低

系统推荐：&lt; 1000ms (1秒)
</code></pre>
<h3 data-id="heading-20"><strong>优化建议（两张 4G）</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方案 1: 预附着优化（最激进）</span>
<span class="hljs-comment">// 在停用旧卡前，新卡已完全附着</span>
<span class="hljs-comment">// 优点：0ms 断连</span>
<span class="hljs-comment">// 缺点：短期两个活跃连接（耗电）</span>

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">optimizedSwitchWith4G</span><span class="hljs-params">(<span class="hljs-type">int</span> oldPhoneId, <span class="hljs-type">int</span> newPhoneId)</span> {
    <span class="hljs-comment">// 不需要等待验证，直接激活</span>
    logl(<span class="hljs-string">"4G → 4G switch, using fast track"</span>);
    
    <span class="hljs-comment">// 时刻 0ms：激活新卡，同时停用旧卡（并发）</span>
    PhoneFactory.getPhone(newPhoneId).mCi.setDataAllowed(<span class="hljs-literal">true</span>, msg1);
    PhoneFactory.getPhone(oldPhoneId).mCi.setDataAllowed(<span class="hljs-literal">false</span>, msg2);
    
    <span class="hljs-comment">// 预期延迟：200-300ms（纯 ATTACH 时间）</span>
}

<span class="hljs-comment">// 方案 2: 串联优化（平衡）</span>
<span class="hljs-comment">// 新卡 ATTACH 成功后再 DETACH 旧卡</span>

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">balancedSwitch4G</span><span class="hljs-params">(<span class="hljs-type">int</span> oldPhoneId, <span class="hljs-type">int</span> newPhoneId)</span> {
    PhoneFactory.getPhone(newPhoneId).mCi.setDataAllowed(<span class="hljs-literal">true</span>, 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleCallback</span><span class="hljs-params">()</span> {
                <span class="hljs-comment">// 新卡附着成功</span>
                logl(<span class="hljs-string">"New SIM attached, detaching old"</span>);
                PhoneFactory.getPhone(oldPhoneId)
                    .mCi.setDataAllowed(<span class="hljs-literal">false</span>, msg);
            }
        });
    
    <span class="hljs-comment">// 预期延迟：200-300ms (新) + 200-300ms (旧) = 400-600ms</span>
    <span class="hljs-comment">// 但提供了 100% 的连续性保障</span>
}

<span class="hljs-comment">// 方案 3: 验证优化（最安全）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validatedSwitch4G</span><span class="hljs-params">(<span class="hljs-type">int</span> oldPhoneId, <span class="hljs-type">int</span> newPhoneId)</span> {
    mValidator.setValidationCallback((validated, subId) -&gt; {
        <span class="hljs-keyword">if</span> (validated &amp;&amp; subId == getSubIdByPhoneId(newPhoneId)) {
            logl(<span class="hljs-string">"Network fully validated, safe to detach old"</span>);
            PhoneFactory.getPhone(oldPhoneId)
                .mCi.setDataAllowed(<span class="hljs-literal">false</span>, msg);
        }
    });
    
    <span class="hljs-comment">// 预期延迟：200-300ms (ATTACH) + 100-200ms (验证) = 300-500ms</span>
    <span class="hljs-comment">// 最大的延迟，但提供最强的保障</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-21">6️⃣ <strong>性能指标监控</strong></h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 监控数据切换延迟的实现</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSwitchMetrics</span> {
    
    <span class="hljs-keyword">private</span> fun <span class="hljs-title function_">logSwitchEvent</span><span class="hljs-params">(
        oldSubId: Int,
        newSubId: Int,
        startTime: Long,
        endTime: Long
    )</span> {
        <span class="hljs-type">val</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> endTime - startTime
        
        <span class="hljs-title function_">logg</span><span class="hljs-params">(<span class="hljs-string">""</span><span class="hljs-string">"
            Data Switch Metrics:
            Old SubId: $oldSubId
            New SubId: $newSubId
            Duration: ${duration}ms
            Network Continuous: ${duration &lt; 1000}
            
            Recommendation:
            ${when {
                duration &lt; 300 -&gt; "</span>⭐⭐⭐ Excellent<span class="hljs-string">"
                duration &lt; 500 -&gt; "</span>⭐⭐ Good<span class="hljs-string">"
                duration &lt; 1000 -&gt; "</span>⭐ Acceptable<span class="hljs-string">"
                else -&gt; "</span>❌ Poor - Review Modem<span class="hljs-string">"
            }}
        "</span><span class="hljs-string">""</span>.trimIndent()</span>)
        
        <span class="hljs-comment">// 上报到 metrics 系统</span>
        TelephonyMetrics.getInstance().writeDataSwitchEvent(
            mPhoneId,
            oldSubId,
            newSubId,
            duration,
            <span class="hljs-string">"success"</span>
        )
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-22">总结表格</h2>








































<table><thead><tr><th>方面</th><th>指标</th><th>说明</th></tr></thead><tbody><tr><td><strong>两张 4G 最优延迟</strong></td><td>200-300ms</td><td>仅 ATTACH 时间</td></tr><tr><td><strong>推荐延迟</strong></td><td>&lt; 1000ms</td><td>用户基本无感</td></tr><tr><td><strong>不可接受延迟</strong></td><td>&gt; 3000ms</td><td>需要优化系统</td></tr><tr><td><strong>可接受无网时间</strong></td><td>&lt; 500ms</td><td>大多数应用可容忍</td></tr><tr><td><strong>关键优化点</strong></td><td>Modem ATTACH</td><td>占总延迟 30-50%</td></tr><tr><td><strong>推荐切换方案</strong></td><td>验证+串联</td><td>平衡性能和安全</td></tr></tbody></table>
<p>这就是完整的<strong>多卡数据切换流程及优化方案</strong>！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝重复造轮子？我们偏偏花365天，用Vue3写了款AI协同的Word编辑器]]></title>    <link>https://juejin.cn/post/7603563317040021567</link>    <guid>https://juejin.cn/post/7603563317040021567</guid>    <pubDate>2026-02-06T10:07:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603563317040021567" data-draft-id="7603587738159874111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝重复造轮子？我们偏偏花365天，用Vue3写了款AI协同的Word编辑器"/> <meta itemprop="keywords" content="前端,Vue.js,GitHub"/> <meta itemprop="datePublished" content="2026-02-06T10:07:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="徐小夕"/> <meta itemprop="url" content="https://juejin.cn/user/3808363978429613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝重复造轮子？我们偏偏花365天，用Vue3写了款AI协同的Word编辑器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363978429613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    徐小夕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T10:07:56.000Z" title="Fri Feb 06 2026 10:07:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ps：开源版SDK已发布，github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMrXujiang%2Fjitword-sdk" target="_blank" title="https://github.com/MrXujiang/jitword-sdk" ref="nofollow noopener noreferrer">github.com/MrXujiang/j…</a></p>
<p>又到了我们定期AI创业复盘的时间了。今天和大家分享一下，我们决定花1年时间打造AI Word编辑器的理由，以及做AI文档创业过程中踩过的坑。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7c968f333be4232825b9e88109835e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=a3vfTbhdrEH1thzUfy93HtKLvyk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-0">为什么"偏偏"要造个Word轮子</h3>
<p>我们之所以下定决心做这件事，主要是因为前两年我们的一个产品，需要集成word能力对外服务，但是我们调研了一圈，得到的结论是：1. 大厂的文档产品集成成本过高，对外商业化受限头部大厂做的文档产品，要么是按次付费（并发次数）：<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/250035413bb04bbbb6635e4d472f3dd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=fpNuVcXMZr4M1ksBw9QRJpHZgwo%3D" alt="图片" loading="lazy"/>比如上面这张，如果高频使用，我们团队算了一笔账，每年api的调用基本都要花10-20w左右，更别说对外给客户服务了，那成本只有大公司能玩了。另一方面，国内B端客户大部分的Saas场景都需要私有化部署，国企事业金融企业更要求内网部署，所以基本上不可能集成大厂的SDK，这条商业模式已经被堵死了。2. 大厂的文档产品技术债过重，扩展度和开放程度受限这基本上是行业的共识了。普通企业只能用大厂的系统，如果要开发，要么动辄百万，要么就等“等更新”。但是我们的AI文档场景，并不需要很多冗余的功能，而是保留最核心的能力，其他的我们希望开发给企业自定义。同时，现有文档编辑器都是"互联网时代的产物"，为"人写给人看"设计。AI无法真正理解文档结构，只能当"高级搜索框"。我们结合这两年AI的发展，洞察的结果是：内容创作正在从"人驱动"转向"人机协作"，但工具没有跟上。所以综合上面分析，再结合我们团队大厂架构和文档产品的研发经验，我们毅然决定自研。</p>
<h3 data-id="heading-1">365天我们做了什么</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc3f8c610e2f44fb88d480ad8eaf1e9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=r3mRfY2H56GW%2FHQpHIAhhlyqC0k%3D" alt="图片" loading="lazy"/></p>
<p>说实话，规划了1年，其实并不是单纯的时间维度的概念，我们打算将 JitWord 打造成一个未来我们 all in 的一个产品长链路的方向：基于JitWord的文档引擎，扩展出企业共建版，JitOffice办公软件，JitCloud AI云服务生态。所以可能未来1-2年，我们还是会持续深耕在“知识内容传承”这个赛道。</p>
<h4 data-id="heading-2">第一步，架构重构：从"富文本"到"结构化数据"</h4>
<p>在做 JitWord 之前，我们对 Office 文档做了大量的调研，从docx格式到文档的复杂操作，都意味着传统的富文本格式（html）难以驾驭复杂的文档场景。</p>
<p>我们也调研了很多开源方案，比如 tiptap，quill，editorjs等。最终我们选择了tiptap的一个早期稳定的版本，作为我们的底层文档组件，并对 tiptap 的架构做了上层的优化，已支持复杂的文档操作。</p>
<p>下面是我们第一版的文档设计架构：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0cdf6f0d5754273bcf5a1dce1ec2ea0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=8KPZ9gQAbJ5e8VdtuHCrODpZ3V0%3D" alt="图片" loading="lazy"/></p>
<p>其实单纯实现类似 Office 的UI界面，难度不是很大，只需要花时间来开发，我相信每一个前端工程师都能实现，其难点在于：</p>
<ul>
<li>如何高效的做文档解析（需要对docx进行高精度格式还原）</li>
<li>如何基于文档做高性能协同（支持多人协同编辑）</li>
<li>如何在web文档处理复杂公式编辑和渲染</li>
<li>实现文档的复杂操作（划词评论，版本对比，高级排版，分页视图等）</li>
<li>实现文档的权限控制和高性能渲染（100w+字秒级渲染）</li>
</ul>
<p>等等，每一个骨头都比较硬，基本上都是我们花大量实现自研，比如：</p>
<p>基于文档做高性能协同（支持多人协同编辑）</p>
<p>目前市面上其实有些协同方案，比如CRDT算法驱动的YJS，当然我们也是基于YJS实现的文档协同算法。但是单纯使用Yjs，只能实现基础协同，在协同过程中我们需要考虑很多复杂场景：</p>
<ol>
<li><strong>操作可交换性</strong>不同用户的操作可以以任意顺序执行，最终结果一致</li>
<li><strong>操作可合并性</strong>多个操作可以智能合并，减少网络传输</li>
<li><strong>最终一致性</strong>所有客户端最终会收敛到相同的文档状态</li>
<li><strong>无需中央协调</strong>不依赖中央服务器进行冲突解决</li>
</ol>
<p>下面是我们设计的协同操作流程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28c6c8c06b4149e597eb04ff2e35f2e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=C9LIPYMBhVPSpts7v%2FqusAytdaA%3D" alt="图片" loading="lazy"/></p>
<p>在协同编辑的性能上，我们也做了进一步算法优化，保证我们在普通服务器上（2核4G）也能支持10-50人的高效协同编辑，如果扩大服务器性能和集群，我们将有可能支持数千上万人的协同编辑。</p>
<p>下面是我们的文档协同和存储架构数据流：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c8ceb434ec448419584ca467a240d44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=nHApwU752iGZ7cXFPbVQt5bs1WQ%3D" alt="图片" loading="lazy"/></p>
<p>实现在web端处理复杂公式编辑和渲染</p>
<p>基本上市面上的开源方案都达不到我们对复杂公式的极致追求，大部分是让用户直接编辑latex，但是到了导出docx后，公式要么无法导出，要么导出后无法二次编辑。</p>
<p>基于上面的痛点，我们对docx文件做了数据结构的分析和算法层的兼容，同时对用户编辑公式的体验也做了进一步升级：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b28bac938d7448fb0b52669e3f7eec9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=7Kj1imdkqyM6qDW%2FLN5v9DfmiHw%3D" alt="图片" loading="lazy"/></p>
<p>我们提供了数学公式的编辑面板，我们可以实时编辑和预览公式，同时我们内置了100+高频的数学和科研公式，方便大家更快速的编写复杂公式。</p>
<p>下面是渲染到 JitWord 中的公式效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/210501a4476545b68709edab391c0c39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=U6sej6uA6sRS9jkpKyYGEdQt0Rc%3D" alt="图片" loading="lazy"/></p>
<p>同时，我们也能直接导出带复杂公式的文档，并在 word 中二次编辑。</p>
<p>文档的高效渲染（100w字秒级渲染）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cd694d1a9694274a8caa8952a82878a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=hQv31Dznc0upvXxqzUXSu9K4BVo%3D" alt="图片" loading="lazy"/></p>
<p>上面是我们文档中渲染了100w字的效果，目前测试下来还是可以编辑文档，只有略微的延迟。</p>
<p>这一结果归功于我们对文档性能的极致追求，在文档渲染层我们做了极致的优化，并全方面测试了渲染协同稳定性能：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d351c797d3ee48d6a2e5d3b0a18b3684~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=jpoSwMsUcHsKFyuSjsGToqyk8u0%3D" alt="图片" loading="lazy"/></p>
<p>实现文档的复杂操作（划词评论，版本对比，高级排版，分页视图等）</p>
<p>任何一个富文本编辑器，都很难自带划词评论，版本对比，高级排版，分页视图这些高级操作功能。</p>
<p>我们研究这些功能花费了很多时间，也在每个月以2-3个版本的迭代速度更新着JitWord。</p>
<p>终于在2025年底实现了上面提到的这几个功能，下面我也给大家一一介绍一下。</p>
<ol>
<li>划词评论</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/714a3af6670c4738bbf9e7953ff70b53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=LWjeITslk7bHKze33wZ2vjslVFQ%3D" alt="图片" loading="lazy"/></p>
<p>当然大家可不要以为我们只是做了划词评论功能。我们在划词评论之后，还做了通信机制，在多人协同过程中可以实时通知给其他人，让协作者可以第一时间看到划词的内容，这个流程我们完全打通了。</p>
<ol start="2">
<li>版本管理功能</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2af625a2b4d2421184a9ef1a7dbc13fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=5c8cSgYGhhUqi28SFCBwabdIH00%3D" alt="图片" loading="lazy"/></p>
<p>我们的操作会定期存储，可以一键恢复，并支持版本的差异对比。这个功能基本上也是市面上web端文档独一份的，当然我们还在持续优化。</p>
<ol start="3">
<li>分页视图功能</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1272cefcd6e44ee6ae1233b0c013d61d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=GjpE88XMMBumcRO0h%2FSNRYP%2FFJk%3D" alt="图片" loading="lazy"/></p>
<p>这个功能是最难坑的，不容置疑。但是我们花了2个月 all in 这个功能，终于实现了类似 word 的分页功能。它的难点在于分页之后内容的排版和位置自动计算机制，需要消耗大量的 js 性能，所以我们各种性能优化的方式都用上了，结合我们设计的独有的dom组织模式，终于实现了分页能力。</p>
<p>大家可以在 JitWord 共建版体验到分页的功能。</p>
<p>当然，我们还会支持页眉页脚功能，全面对标 Office。</p>
<h4 data-id="heading-3">第二步，AI协作引擎：让文档"活"起来</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/634d1de9f8a548febde3c2055b9cd8f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=ZjGbLfQrJvHjFsWwoJEiNocpRA8%3D" alt="图片" loading="lazy"/></p>
<p>上面是我们设计的 AI Native 驱动的模式架构，保证我们在文档编辑的全生命周期里，都能体验AI创作的乐趣。</p>
<p>下面是演示效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/200058913ded48029f40438f675d9314~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=kkG%2FryVsDDhlVR5zww%2B8ixK5wSw%3D" alt="图片" loading="lazy"/></p>
<p>我们除了直接让AI创作内容，还可以基于文本和段落，进行二次AI优化，比如文本润色，纠错，续写等：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfd24db496274d5fbef315455238b6d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=A8N5N%2F1MoTEnN0PczeNx3akKsEc%3D" alt="图片" loading="lazy"/></p>
<p>最近我们还迭代上线了AI公文助手，可以通过AI一键生成合同和公文：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d9f222858304e2f95f2406e5bb1d523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=Y62ZGXAlvKcx9OGYeFU3%2BDE9ers%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1679d5973384d3d8549764c52681428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=VIJZEIArqtiXehXWNLF3Tw8OecI%3D" alt="图片" loading="lazy"/></p>
<p>当然后续会实现更多和AI结合的场景，提高用户办公的效率。</p>
<h4 data-id="heading-4">第三步，Vue3的执念：为什么死磕Vue？</h4>
<p>很多人问：文档编辑器为什么要强调Vue3？用React不是生态更好？</p>
<p>我们的回答是：<strong>响应式性能决定了AI协作的流畅度</strong>。</p>
<p><strong>技术细节：</strong></p>
<ul>
<li><strong>Proxy-based响应式</strong>：10万字符文档的实时协作，传统<code>Object.defineProperty</code>会卡成PPT，Vue3的Proxy实现了毫秒级更新</li>
<li><strong>Composition API</strong>：AI建议卡片、协作光标、公式渲染器……这些复杂组件的组合逻辑，用Composables管理比HOC清晰10倍</li>
<li><strong>Tree-shaking友好</strong>：最终打包体积比同类React方案小40%，SaaS嵌入时客户感知明显</li>
</ul>
<p><strong>一个真实案例：</strong></p>
<p>一个客户把我们的产品嵌入他们的CRM系统，原先用的React方案首屏加载3.2s，替换为 JitWord 后降到1.1s。客户CTO的原话："<strong>你们这个Vue3版本，让我们的SaaS看起来像原生应用。</strong> "</p>
<p>这就是"造轮子"的意义：<strong>不是为造而造，是为跑得更快。</strong></p>
<p><strong>并且国产化环境，很多客户都是更倾向用 Vue 技术栈，所以站在客户和用户体验的角度，我们Vue的策略是完全经得起考验的。</strong></p>
<h2 data-id="heading-5">拒绝自嗨，持续打磨应用场景</h2>
<p>技术人最容易犯的错：拿着锤子找钉子。</p>
<p>我们花了两个月时间，把产品扔到真实场景里验证，我们上线了我们开源SDK，让大家可以集成到自己的真实项目中来体验：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61cae120bad14e6794b3ec1c119bc845~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=Rol6Il4XpEMNHMHPj2%2BQanBdvwE%3D" alt="图片" loading="lazy"/></p>
<p>目前有各行各业的客户给我们反馈了大量的建议，我们也在持续排期优化，下面分享一下我们内部的需求列表：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a04b1c625d84216b3432ca23083da98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977276&amp;x-signature=Yf%2Buu65XpNIGSmtnBclkPpEzDHo%3D" alt="图片" loading="lazy"/></p>
<p>目前已经有100多个我们评估后觉得非常有价值的功能点，在今年的一年里，我们会陆续上线。</p>
<p>当然大家有好的建议，也欢迎随时交流反馈～</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMrXujiang%2Fjitword-sdk" target="_blank" title="https://github.com/MrXujiang/jitword-sdk" ref="nofollow noopener noreferrer">github.com/MrXujiang/j…</a></p>
<hr/>
<h2 data-id="heading-6">开源与商业化思考</h2>
<p>写到这里，必须回答那个最尖锐的问题：</p>
<blockquote>
<p><strong>你们最后要卖钱吗？还是说只是技术情怀？</strong></p>
</blockquote>
<p>我的答案是：<strong>部分开源，商业闭环。</strong></p>
<hr/>
<h3 data-id="heading-7">为什么开源？</h3>
<p>开源了基础的文档引擎SDK，包括：</p>
<ul>
<li>结构化文档模型</li>
<li>Vue3组件基础</li>
<li>公式渲染模块</li>
<li>docx导入导出功能</li>
</ul>
<p><strong>目的不是做慈善，是建立标准。</strong></p>
<p>如果 JitWord 的文档模型成为行业事实标准，第三方开发者自然会基于我们的格式开发插件。这等于用社区力量帮我们扩展生态——<strong>比招100个产品经理都有效</strong>。</p>
<hr/>
<h3 data-id="heading-8">为什么保留商业版？</h3>
<p>商业版包含：</p>
<ul>
<li>AI协作引擎（调用大模型API，成本敏感）</li>
<li>企业级协作功能（权限管理、审计日志）</li>
<li>SaaS嵌入解决方案</li>
</ul>
<p><strong>这不是"开源版阉割功能"，是"开源版定义基础，商业版解决复杂问题"。</strong></p>
<p>类比：Android开源，但GMS（Google服务）收费；MySQL开源，但企业版有高级监控。这是经过验证的商业模式。</p>
<p><strong>一个创业者的坦白：</strong></p>
<p>我们考虑过完全开源、靠服务变现。但过去一年和几十家企业聊过后，我发现<strong>B端客户真正付费的不是"软件"，是"确定性"</strong> ——出了问题能找到人、能签SLA、能定制开发。这些只能靠商业团队支撑。</p>
<p><strong>所以，造轮子不是目的。</strong></p>
<p><strong>让轮子跑得更快，让更多人用上更快的轮子，同时让造轮子的人能持续造下去——这才是目的。</strong></p>
<hr/>
<p><strong>关于作者</strong>：前大厂技术专家，现 JitWord 联合创始人。相信AI时代的生产力工具，应该由懂产品和技术的人重新做一遍。</p>
<p>我们团队均来自一线中大厂，资深工程师和技术专家，配合3个Agent，开启6人协作的创业之旅～</p>
<p>如果大家有好的建议，想法，欢迎留言反馈～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Telephony 数据恢复与容错机制详解]]></title>    <link>https://juejin.cn/post/7603347438013579299</link>    <guid>https://juejin.cn/post/7603347438013579299</guid>    <pubDate>2026-02-06T09:43:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603347438013579299" data-draft-id="7603309951227576370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Telephony 数据恢复与容错机制详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T09:43:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Telephony 数据恢复与容错机制详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:43:45.000Z" title="Fri Feb 06 2026 09:43:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、数据卡死检测机制</h3>
<h4 data-id="heading-1">1. 检测层次结构</h4>
<pre><code class="hljs language-scss" lang="scss">ConnectivityService (网络连接服务)
    ↓
NetworkMonitor (网络监控)
    ↓ (检测方法)
  ├─ DNS Events (DNS超时检测)
  ├─ TCP Metrics (TCP失败率检测)
  └─ IPv4/IPv6 探针 (ICMP Reachability)
    ↓
数据卡死判定
    ↓
DataStallRecoveryManager (DSRM - 数据卡死恢复管理器)
</code></pre>
<h4 data-id="heading-2">2. 数据卡死的定义</h4>
<p>根据代码注释，数据卡死是指：</p>
<ul>
<li><strong>DNS 事件</strong>：连续多个 DNS 超时</li>
<li><strong>TCP 指标</strong>：TCP 包失败率超过阈值</li>
<li><strong>网络探针失败</strong>：无法到达任何网关/DNS 服务器</li>
</ul>
<p>这些指标由 <code>NetworkMonitor</code> 实时监测，当条件触发时，通过以下路径上报：</p>
<pre><code class="hljs language-scss" lang="scss">NetworkMonitor
  → ConnectivityService<span class="hljs-selector-class">.notifyDataStallSuspected</span>()
  → DataStallRecoveryManager<span class="hljs-selector-class">.onInternetValidationStatusChanged</span>(NOT_VALID)
</code></pre>
<hr/>
<h3 data-id="heading-3">二、四级递进恢复机制详解</h3>
<h4 data-id="heading-4">恢复机制概览图</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│ 数据卡死被检测到 (VALIDATION_STATUS_NOT_VALID)                   │
└────────────────┬──────────────────────────────────────────────────┘
                 │
                 ↓
        ┌────────────────────┐
        │  Level <span class="hljs-number">0</span>           │
        │ GET_DATA_CALL_LIST │  ← 仅查询，不修改
        └────────┬───────────┘
                 │ (等待 <span class="hljs-number">180s</span>，检查验证状态)
                 ↓
        ┌────────────────────┐
        │  Level <span class="hljs-number">1</span>           │
        │    CLEANUP         │  ← 轻量级恢复，不涉及 Radio
        │(DEACTIVATE/SETUP)  │
        └────────┬───────────┘
                 │ (等待 <span class="hljs-number">180s</span>，检查验证状态)
                 ↓
        ┌────────────────────┐
        │  Level <span class="hljs-number">2</span>           │
        │  RADIO_RESTART     │  ← 中等级恢复，涉及 Radio Power 重启
        └────────┬───────────┘
                 │ (等待 <span class="hljs-number">180s</span>，检查验证状态)
                 ↓
        ┌────────────────────┐
        │  Level <span class="hljs-number">3</span>           │
        │  RESET_MODEM       │  ← 最终恢复，涉及 Modem 重启
        │(NV_RESET_CONFIG)   │
        └────────┬───────────┘
                 │
                 ↓
        验证通过或已尝试所有步骤 → 复位到初始状态
</code></pre>
<h4 data-id="heading-5">2.1 Level 0: GET_DATA_CALL_LIST</h4>
<p><strong>目的</strong>：查询当前数据连接列表，同步 RIL 和 Framework 的数据连接状态</p>
<p><strong>实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">720</span>|    <span class="hljs-comment">/** Recovery Action: RECOVERY_ACTION_GET_DATA_CALL_LIST */</span>
<span class="hljs-number">721</span>|    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getDataCallList</span><span class="hljs-params">()</span> {
<span class="hljs-number">722</span>|        log(<span class="hljs-string">"getDataCallList: request data call list"</span>);
<span class="hljs-number">723</span>|        mWwanDataServiceManager.requestDataCallList(<span class="hljs-literal">null</span>);
<span class="hljs-number">724</span>|    }
</code></pre>
<p><strong>调用链</strong>：</p>
<ul>
<li><code>DataStallRecoveryManager.getDataCallList()</code></li>
<li>→ <code>DataServiceManager.requestDataCallList(Message)</code></li>
<li>→ <code>IDataService.requestDataCallList(int phoneId, IDataServiceCallback callback)</code> (AIDL)</li>
<li>→ Modem → RIL 返回 <code>DataCallResponse[]</code></li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>当 Framework 认为数据连接出现问题，但 Modem 端可能正常</li>
<li>通过 RIL_REQUEST_GET_DATA_CALL_LIST 查询实际连接状态</li>
<li>可能发现 IP 地址或 DNS 服务器信息在 Modem 端已更新，但未上报给 Framework</li>
</ul>
<p><strong>关键配置</strong>：</p>
<ul>
<li>延迟：CarrierConfig <code>KEY_DATA_STALL_RECOVERY_TIMERS_LONG_ARRAY[0]</code> (默认 180000ms = 3分钟)</li>
<li>可跳过：CarrierConfig <code>KEY_DATA_STALL_RECOVERY_SHOULD_SKIP_ARRAY[0]</code></li>
</ul>
<hr/>
<h4 data-id="heading-6">2.2 Level 1: CLEANUP</h4>
<p><strong>目的</strong>：完全断开现有数据连接，随后重新建立连接（Channel 重建）</p>
<p><strong>实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">726</span>|    <span class="hljs-comment">/** Recovery Action: RECOVERY_ACTION_CLEANUP */</span>
<span class="hljs-number">727</span>|    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanUpDataNetwork</span><span class="hljs-params">()</span> {
<span class="hljs-number">728</span>|        log(<span class="hljs-string">"cleanUpDataNetwork: notify clean up data network"</span>);
<span class="hljs-number">729</span>|        mDataStallRecoveryManagerCallback.invokeFromExecutor(
<span class="hljs-number">730</span>|                mDataStallRecoveryManagerCallback::onDataStallReestablishInternet);
<span class="hljs-number">731</span>|    }
</code></pre>
<p><strong>调用链</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">DataStallRecoveryManager<span class="hljs-selector-class">.cleanUpDataNetwork</span>()
  → DataNetworkController<span class="hljs-selector-class">.onDataStallReestablishInternet</span>()
    → mDataNetworkList<span class="hljs-selector-class">.stream</span>()
        <span class="hljs-selector-class">.filter</span>(DataNetwork::isInternetSupported)
        <span class="hljs-selector-class">.forEach</span>(dataNetwork → 
          dataNetwork.tearDown(TEAR_DOWN_REASON_DATA_STALL)
        )
          → RIL_REQUEST_DEACTIVATE_DATA_CALL (所有 PDN)
          → 断开连接后，等待网络请求重新建立
          → RIL_REQUEST_SETUP_DATA_CALL
</code></pre>
<p><strong>具体步骤</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─ <span class="hljs-number">1</span>. 断开所有互联网数据连接 (DEACTIVATE_DATA_CALL)
│     ├─ 所有 <span class="hljs-built_in">isInternetSupported</span>() == true 的 DataNetwork
│     ├─ 发送 RIL_REQUEST_DEACTIVATE_DATA_CALL for each CID
│     └─ 等待 Modem 回复 DEACTIVATE 响应
│
├─ <span class="hljs-number">2</span>. 断开完成后，unsatisfied network requests 重新评估
│     └─ DataNetworkController 检查是否有待满足的网络请求
│
└─ <span class="hljs-number">3</span>. 根据网络请求重新建立连接 (SETUP_DATA_CALL)
      ├─ 发送 RIL_REQUEST_SETUP_DATA_CALL
      ├─ 建立新的 PDN
      └─ 获取新的 IP、DNS 等链接属性
</code></pre>
<p><strong>核心代码</strong>：</p>
<pre><code class="hljs language-3450|" lang="3450|">3451|        log("onDataStallReestablishInternet: Tear down data networks that support internet.");
3452|        // 断开所有支持互联网的数据网络
3453|        mDataNetworkList.stream()
3454|            .filter(DataNetwork::isInternetSupported)
3455|            .forEach(dataNetwork -&gt; dataNetwork.tearDown(
3456|                DataNetwork.TEAR_DOWN_REASON_DATA_STALL));
3457|    }
</code></pre>
<p><strong>为什么有效</strong>：</p>
<ul>
<li>断开-重建可以清除 Modem 与 Radio 之间的沟通错误</li>
<li>在某些情况下（如链接层异常），断开重建可强制 Modem 重新协商参数</li>
</ul>
<p><strong>关键配置</strong>：</p>
<ul>
<li>延迟：CarrierConfig[1] (默认 180000ms = 3分钟)</li>
<li>可跳过：CarrierConfig[1] (某些运营商的相同 APN 情况)</li>
</ul>
<hr/>
<h4 data-id="heading-7">2.3 Level 2: RADIO_RESTART</h4>
<p><strong>目的</strong>：关闭再打开 Radio（不涉及 Modem 重启），强制重新注册网络</p>
<p><strong>实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">733</span>|    <span class="hljs-comment">/** Recovery Action: RECOVERY_ACTION_RADIO_RESTART */</span>
<span class="hljs-number">734</span>|    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">powerOffRadio</span><span class="hljs-params">()</span> {
<span class="hljs-number">735</span>|        log(<span class="hljs-string">"powerOffRadio: Restart radio"</span>);
<span class="hljs-number">736</span>|        mPhone.getServiceStateTracker().powerOffRadioSafely();
<span class="hljs-number">737</span>|    }
</code></pre>
<p><strong>调用链</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">DataStallRecoveryManager.powerOffRadio()
  → ServiceStateTracker.powerOffRadioSafely()
    → RIL_REQUEST_RADIO_POWER (<span class="hljs-attr">power</span> = <span class="hljs-literal">false</span>)
    → (等待 Modem 响应，关闭 RF 发射)
    → <span class="hljs-section">[延迟 ~3 秒]</span>
    → RIL_REQUEST_RADIO_POWER (<span class="hljs-attr">power</span> = <span class="hljs-literal">true</span>)
    → (Modem 重新打开 RF，发起网络注册)
    → ServiceState 从 POWER_OFF → SEARCHING → IN_SERVICE
</code></pre>
<p><strong>状态转换</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─ <span class="hljs-number">1</span>. Radio 关闭
│     └─ <span class="hljs-built_in">RIL_REQUEST_RADIO_POWER</span>(false)
│        → Modem 关闭 RF 发射
│        → ServiceState → POWER_OFF
│
├─ <span class="hljs-number">2</span>. <span class="hljs-selector-attr">[系统等待物理重启]</span>
│     └─ ~<span class="hljs-number">100</span>-<span class="hljs-number">500ms</span> delay
│
├─ <span class="hljs-number">3</span>. Radio 打开
│     └─ <span class="hljs-built_in">RIL_REQUEST_RADIO_POWER</span>(true)
│        → Modem 重新打开 RF
│        → 重新发起网络注册过程
│
└─ <span class="hljs-number">4</span>. 网络重新注册
      ├─ CS domain attach (语音)
      ├─ PS domain attach (数据)
      ├─ 获取新的信号参数、LAC/TAC、小区信息
      └─ 重建 PDP context（如果需要）
</code></pre>
<p><strong>何时触发 Event_RADIO_STATE_CHANGED</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">377</span>|            <span class="hljs-keyword">case</span> EVENT_RADIO_STATE_CHANGED:
<span class="hljs-number">378</span>|                mRadioPowerState = mPhone.getRadioPowerState();
<span class="hljs-number">379</span>|                <span class="hljs-keyword">if</span> (mDataStalled) {
<span class="hljs-number">380</span>|                    <span class="hljs-comment">// 只在数据卡死时记录 Radio 状态改变</span>
<span class="hljs-number">381</span>|                    mRadioStateChangedDuringDataStall = <span class="hljs-literal">true</span>;
<span class="hljs-number">382</span>|                    ...
<span class="hljs-number">383</span>|                    setRecoveryAction(mLastAction);
<span class="hljs-number">384</span>|                }
</code></pre>
<p><strong>为什么有效</strong>：</p>
<ul>
<li>RF 关闭再打开强制 Modem 重新初始化 Radio 栈</li>
<li>清除可能的信号处理路径上的异常状态</li>
<li>强制重新获取网络参数和附着信息</li>
</ul>
<p><strong>关键配置</strong>：</p>
<ul>
<li>延迟：CarrierConfig[2] (默认 180000ms = 3分钟)</li>
<li>可跳过：CarrierConfig[2]</li>
</ul>
<hr/>
<h4 data-id="heading-8">2.4 Level 3: RESET_MODEM</h4>
<p><strong>目的</strong>：Modem 全系统重启，恢复 Modem 固件到初始状态</p>
<p><strong>实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">739</span>|    <span class="hljs-comment">/** Recovery Action: RECOVERY_ACTION_RESET_MODEM */</span>
<span class="hljs-number">740</span>|    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rebootModem</span><span class="hljs-params">()</span> {
<span class="hljs-number">741</span>|        log(<span class="hljs-string">"rebootModem: reboot modem"</span>);
<span class="hljs-number">742</span>|        mPhone.rebootModem(<span class="hljs-literal">null</span>);
<span class="hljs-number">743</span>|    }
</code></pre>
<p><strong>调用链</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">DataStallRecoveryManager<span class="hljs-selector-class">.rebootModem</span>()
  → Phone<span class="hljs-selector-class">.rebootModem</span>(Message)
    → RIL<span class="hljs-selector-class">.nvResetConfig</span>() 或其他 Modem 重启命令
      → NV_RESET_CONFIG (可选)
      → MODEM_RESET (通过 SoC reset 或 watchdog)
</code></pre>
<p><strong>Modem 重启过程</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─ <span class="hljs-number">1</span>. 发起 Modem 重启请求
│     └─ RIL_REQUEST_MODEM_RESET (AIDL)
│        或 NV_RESET_CONFIG
│
├─ <span class="hljs-number">2</span>. Modem 断电或被 SoC 强制重置
│     ├─ Modem 固件终止所有进程
│     ├─ 所有状态变量清空
│     ├─ 无线小区连接断开
│     └─ PDN 上下文丢弃
│
├─ <span class="hljs-number">3</span>. Modem 重启（Boot &amp; Initialization）
│     ├─ 固件加载和初始化
│     ├─ 硬件检测
│     ├─ NV Item 重载
│     └─ ~<span class="hljs-number">5</span>-<span class="hljs-number">30</span> 秒重启时间
│
└─ <span class="hljs-number">4</span>. Framework 重新初始化
      ├─ 监听 UNSOL_MODEM_RESTART indication
      ├─ ServiceState → POWER_OFF → SEARCHING → IN_SERVICE
      ├─ 重新建立所有数据连接
      └─ DataNetwork 重新 SETUP_DATA_CALL
</code></pre>
<p><strong>关键指示</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">hardware/radio/1.0/IRadioIndication.hal:
   oneway modemReset(RadioIndicationType <span class="hljs-built_in">type</span>, string reason);
   
当 Modem 重启完成时，该 indication 会被上报到 Framework
</code></pre>
<p><strong>为什么有效</strong>（最后的手段）：</p>
<ul>
<li>Modem 固件级别的完全恢复</li>
<li>清除所有可能的 memory leak、state machine 异常</li>
<li>重新加载 NV Item（可能包含故障的配置）</li>
</ul>
<p><strong>约束条件</strong>：</p>
<ul>
<li><strong>最终恢复步骤</strong>：仅在其他方式都失败后执行</li>
<li><strong>无限延迟</strong>：达到 RESET_MODEM 后，如果仍然失败，则标记 <code>mIsAttemptedAllSteps = true</code>，停止进一步恢复</li>
</ul>
<p><strong>关键配置</strong>：</p>
<ul>
<li>延迟：CarrierConfig[3] (默认 180000ms = 3分钟，实际上不再延迟，因为是最后步骤)</li>
<li>可跳过：CarrierConfig[3]</li>
</ul>
<hr/>
<h3 data-id="heading-9">三、恢复条件判断 &amp; 约束条件</h3>
<h4 data-id="heading-10">3.1 恢复是否需要的判定 (isRecoveryNeeded)</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">780</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isRecoveryNeeded</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isNeedToCheckTimer)</span> {
<span class="hljs-number">781</span>|        <span class="hljs-comment">// Skip if network is invalid and recovery was not started yet</span>
<span class="hljs-number">782</span>|        <span class="hljs-keyword">if</span> (!mIsValidNetwork &amp;&amp; !isRecoveryAlreadyStarted()) {
<span class="hljs-number">783</span>|            logl(<span class="hljs-string">"skip when network still remains invalid..."</span>);
<span class="hljs-number">784</span>|            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ← 网络仍然无效，恢复尚未开始</span>
<span class="hljs-number">785</span>|        }
<span class="hljs-number">786</span>|
<span class="hljs-number">787</span>|        <span class="hljs-comment">// Skip recovery if we have already attempted all steps.</span>
<span class="hljs-number">788</span>|        <span class="hljs-keyword">if</span> (mIsAttemptedAllSteps) {
<span class="hljs-number">789</span>|            logl(<span class="hljs-string">"skip retrying continue recovery action"</span>);
<span class="hljs-number">790</span>|            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ← 已尝试所有步骤，放弃</span>
<span class="hljs-number">791</span>|        }
<span class="hljs-number">792</span>|
<span class="hljs-number">793</span>|        <span class="hljs-comment">// To avoid back to back recovery, wait for a grace period</span>
<span class="hljs-number">794</span>|        <span class="hljs-keyword">if</span> (getElapsedTimeSinceRecoveryMs() &lt; getDataStallRecoveryDelayMillis(mLastAction)
<span class="hljs-number">795</span>|                &amp;&amp; isNeedToCheckTimer) {
<span class="hljs-number">796</span>|            logl(<span class="hljs-string">"skip back to back data stall recovery"</span>);
<span class="hljs-number">797</span>|            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ← 距离上次恢复时间不足，避免频繁触发</span>
<span class="hljs-number">798</span>|        }
<span class="hljs-number">799</span>|
<span class="hljs-number">800</span>|        <span class="hljs-comment">// Skip recovery if it can cause a call to drop</span>
<span class="hljs-number">801</span>|        <span class="hljs-keyword">if</span> (mPhone.getState() != PhoneConstants.State.IDLE
<span class="hljs-number">802</span>|                &amp;&amp; getRecoveryAction() &gt; RECOVERY_ACTION_CLEANUP) {
<span class="hljs-number">803</span>|            logl(<span class="hljs-string">"skip data stall recovery as there is an active call"</span>);
<span class="hljs-number">804</span>|            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ← 通话中，避免 RADIO_RESTART/RESET_MODEM</span>
<span class="hljs-number">805</span>|        }
<span class="hljs-number">806</span>|
<span class="hljs-number">807</span>|        <span class="hljs-comment">// Skip when poor signal strength</span>
<span class="hljs-number">808</span>|        <span class="hljs-keyword">if</span> (mPhone.getSignalStrength().getLevel() &lt;= CellSignalStrength.SIGNAL_STRENGTH_POOR) {
<span class="hljs-number">809</span>|            logl(<span class="hljs-string">"skip data stall recovery as in poor signal condition"</span>);
<span class="hljs-number">810</span>|            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ← 信号太差，恢复无意义</span>
<span class="hljs-number">811</span>|        }
<span class="hljs-number">812</span>|
<span class="hljs-number">813</span>|        <span class="hljs-keyword">if</span> (!mDataNetworkController.isInternetDataAllowed(...)) {
<span class="hljs-number">814</span>|            logl(<span class="hljs-string">"skip data stall recovery as data not allowed."</span>);
<span class="hljs-number">815</span>|            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ← 用户禁用了移动数据或网络策略不允许</span>
<span class="hljs-number">816</span>|        }
<span class="hljs-number">817</span>|
<span class="hljs-number">818</span>|        <span class="hljs-keyword">if</span> (!mIsInternetNetworkConnected) {
<span class="hljs-number">819</span>|            logl(<span class="hljs-string">"skip data stall recovery as data not connected"</span>);
<span class="hljs-number">820</span>|            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// ← 无互联网连接（可能是 IWLAN 等）</span>
<span class="hljs-number">821</span>|        }
<span class="hljs-number">822</span>|        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// ← 所有条件满足，允许恢复</span>
<span class="hljs-number">823</span>|    }
</code></pre>
<h4 data-id="heading-11">恢复触发的完整流程</h4>
<pre><code class="hljs language-scss" lang="scss">ConnectivityService 网络验证失败
  ↓
<span class="hljs-built_in">onInternetValidationStatusChanged</span>(NOT_VALID)
  ↓
<span class="hljs-built_in">setNetworkValidationState</span>(false)  <span class="hljs-comment">// 标记 mDataStalled = true</span>
  ↓
<span class="hljs-built_in">isRecoveryNeeded</span>(true)?
  ├─ Yes → 发送 EVENT_SEND_DATA_STALL_BROADCAST
  │         ↓
  │         <span class="hljs-selector-attr">[等待 DSRM_PREDICT_WAITING_MILLIS (1000ms)]</span>
  │         ↓
  │         <span class="hljs-built_in">doRecovery</span>() 执行当前恢复动作
  │         ↓
  │         <span class="hljs-built_in">startNetworkCheckTimer</span>(mLastAction)
  │         ↓
  │         <span class="hljs-selector-attr">[等待 getDataStallRecoveryDelayMillis(action) 时间]</span>
  │         ↓
  │         自动触发下一个 EVENT_SEND_DATA_STALL_BROADCAST
  │
  └─ No → 记录日志，等待下次网络验证
</code></pre>
<h4 data-id="heading-12">3.2 智能跳过恢复步骤</h4>
<p>某些运营商配置允许跳过特定步骤：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">620</span>|    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRecoveryAction</span><span class="hljs-params">(<span class="hljs-meta">@RecoveryAction</span> <span class="hljs-type">int</span> action)</span> {
<span class="hljs-number">621</span>|        ...
<span class="hljs-number">640</span>|        <span class="hljs-comment">// 检查配置是否需要跳过该步骤</span>
<span class="hljs-number">641</span>|        <span class="hljs-keyword">if</span> (shouldSkipRecoveryAction(mRecoveryAction)) {
<span class="hljs-number">642</span>|            <span class="hljs-keyword">switch</span> (mRecoveryAction) {
<span class="hljs-number">643</span>|                <span class="hljs-keyword">case</span> RECOVERY_ACTION_GET_DATA_CALL_LIST:
<span class="hljs-number">644</span>|                    setRecoveryAction(RECOVERY_ACTION_CLEANUP);  <span class="hljs-comment">// 直接跳到 CLEANUP</span>
<span class="hljs-number">645</span>|                    <span class="hljs-keyword">break</span>;
<span class="hljs-number">646</span>|                <span class="hljs-keyword">case</span> RECOVERY_ACTION_CLEANUP:
<span class="hljs-number">647</span>|                    setRecoveryAction(RECOVERY_ACTION_RADIO_RESTART);  <span class="hljs-comment">// 直接跳到 RADIO_RESTART</span>
<span class="hljs-number">648</span>|                    <span class="hljs-keyword">break</span>;
<span class="hljs-number">649</span>|                <span class="hljs-keyword">case</span> RECOVERY_ACTION_RADIO_RESTART:
<span class="hljs-number">650</span>|                    setRecoveryAction(RECOVERY_ACTION_RESET_MODEM);  <span class="hljs-comment">// 直接跳到 RESET_MODEM</span>
<span class="hljs-number">651</span>|                    <span class="hljs-keyword">break</span>;
<span class="hljs-number">652</span>|                <span class="hljs-keyword">case</span> RECOVERY_ACTION_RESET_MODEM:
<span class="hljs-number">653</span>|                    resetAction();  <span class="hljs-comment">// 放弃，复位</span>
<span class="hljs-number">654</span>|                    <span class="hljs-keyword">break</span>;
<span class="hljs-number">655</span>|            }
<span class="hljs-number">656</span>|        }
    ...
<span class="hljs-number">657</span>|    }
</code></pre>
<p><strong>何时跳过</strong>：</p>
<ul>
<li>某些运营商为相同 APN（如同时用于互联网和 IMS 的 APN）</li>
<li>CLEANUP 可能无效，因为 Modem 不会断开</li>
<li>此时配置会直接跳到 RADIO_RESTART</li>
</ul>
<hr/>
<h3 data-id="heading-13">四、恢复流程中的计时器与状态管理</h3>
<h4 data-id="heading-14">4.1 核心状态变量</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">165</span>-<span class="hljs-number">166</span>|    <span class="hljs-meta">@RecoveryAction</span>
<span class="hljs-number">166</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> mRecoveryAction;        <span class="hljs-comment">// 当前恢复动作</span>
<span class="hljs-number">183</span>|    <span class="hljs-meta">@RecoveryAction</span>
<span class="hljs-number">184</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> mLastAction;             <span class="hljs-comment">// 上次执行的恢复动作</span>
<span class="hljs-number">173</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mRecoveryTriggered;  <span class="hljs-comment">// 恢复是否已触发</span>
<span class="hljs-number">175</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mDataStalled;        <span class="hljs-comment">// 是否处于卡死状态</span>
<span class="hljs-number">177</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mLastActionReported; <span class="hljs-comment">// 上次动作是否已上报</span>
<span class="hljs-number">181</span>|    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> mDataStallStartMs;       <span class="hljs-comment">// 卡死开始时间</span>
<span class="hljs-number">189</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mNetworkCheckTimerStarted;  <span class="hljs-comment">// 计时器是否已启动</span>
<span class="hljs-number">190</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mRadioStateChangedDuringDataStall;  <span class="hljs-comment">// Radio 状态在卡死期间是否改变</span>
<span class="hljs-number">191</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mIsAirPlaneModeEnableDuringDataStall;  <span class="hljs-comment">// 卡死期间飞行模式是否启用</span>
<span class="hljs-number">195</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mMobileDataChangedToEnabledDuringDataStall;  <span class="hljs-comment">// 卡死期间移动数据是否从禁用变启用</span>
<span class="hljs-number">197</span>|    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mIsAttemptedAllSteps;  <span class="hljs-comment">// 是否已尝试所有步骤</span>
</code></pre>
<h4 data-id="heading-15">4.2 计时器逻辑</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">750</span>|    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startNetworkCheckTimer</span><span class="hljs-params">(<span class="hljs-meta">@RecoveryAction</span> <span class="hljs-type">int</span> action)</span> {
<span class="hljs-number">751</span>|        <span class="hljs-comment">// 最后一步（RESET_MODEM）不再设置计时器</span>
<span class="hljs-number">752</span>|        <span class="hljs-keyword">if</span> (action == RECOVERY_ACTION_RESET_MODEM) <span class="hljs-keyword">return</span>;
<span class="hljs-number">753</span>|
<span class="hljs-number">754</span>|        <span class="hljs-keyword">if</span> (!mNetworkCheckTimerStarted) {
<span class="hljs-number">755</span>|            mNetworkCheckTimerStarted = <span class="hljs-literal">true</span>;
<span class="hljs-number">756</span>|            mTimeLastRecoveryStartMs = SystemClock.elapsedRealtime();
<span class="hljs-number">757</span>|            <span class="hljs-comment">// 发送延迟消息，触发下一次恢复尝试</span>
<span class="hljs-number">758</span>|            sendMessageDelayed(
<span class="hljs-number">759</span>|                    obtainMessage(EVENT_SEND_DATA_STALL_BROADCAST),
<span class="hljs-number">760</span>|                    getDataStallRecoveryDelayMillis(action));  <span class="hljs-comment">// 默认 3 分钟</span>
<span class="hljs-number">761</span>|        }
<span class="hljs-number">762</span>|    }
</code></pre>
<p><strong>计时流程示例</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">时刻 T=<span class="hljs-number">0</span>
  └─ 检测到数据卡死 (VALIDATION_STATUS_NOT_VALID)
     └─ 触发 <span class="hljs-built_in">doRecovery</span>()
        └─ 执行 <span class="hljs-built_in">getDataCallList</span>()
        └─ 设置下一动作：mRecoveryAction = CLEANUP
        └─ <span class="hljs-built_in">startNetworkCheckTimer</span>(GET_DATA_CALL_LIST)
           └─ <span class="hljs-built_in">sendMessageDelayed</span>(..., <span class="hljs-number">180000ms</span>)

时刻 T=<span class="hljs-number">180s</span>
  └─ 网络验证再次失败
  │  └─ 触发 <span class="hljs-built_in">doRecovery</span>()
  │     └─ 执行 <span class="hljs-built_in">cleanUpDataNetwork</span>()
  │     └─ 设置下一动作：mRecoveryAction = RADIO_RESTART
  │     └─ <span class="hljs-built_in">startNetworkCheckTimer</span>(CLEANUP)
  │        └─ <span class="hljs-built_in">sendMessageDelayed</span>(..., <span class="hljs-number">180000ms</span>)
  │
  └─ 或者网络验证成功
     └─ 触发 <span class="hljs-built_in">reset</span>()
        └─ 恢复到初始状态
        └─ mDataStalled = false
        └─ mRecoveryAction = GET_DATA_CALL_LIST
</code></pre>
<h4 data-id="heading-16">4.3 恢复条件的动态调整</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">627</span>-<span class="hljs-number">639</span>|    <span class="hljs-keyword">if</span> (mMobileDataChangedToEnabledDuringDataStall
<span class="hljs-number">630</span>|            &amp;&amp; mRecoveryAction &lt; RECOVERY_ACTION_RADIO_RESTART) {
<span class="hljs-number">631</span>|        mRecoveryAction = RECOVERY_ACTION_RADIO_RESTART;  <span class="hljs-comment">// 直接跳到第二级</span>
<span class="hljs-number">632</span>|    }
<span class="hljs-number">633</span>|
<span class="hljs-number">634</span>|    <span class="hljs-keyword">if</span> (mRadioStateChangedDuringDataStall
<span class="hljs-number">636</span>|            &amp;&amp; mRadioPowerState == TelephonyManager.RADIO_POWER_ON) {
<span class="hljs-number">637</span>|        mRecoveryAction = RECOVERY_ACTION_RESET_MODEM;  <span class="hljs-comment">// 直接跳到第三级</span>
<span class="hljs-number">638</span>|    }
</code></pre>
<p><strong>含义</strong>：</p>
<ul>
<li><strong>用户启用移动数据</strong>（从禁用变启用）：跳过 CLEANUP，直接尝试 RADIO_RESTART</li>
<li><strong>Radio 在卡死期间重启</strong>：说明系统已经执行了 RADIO_RESTART，直接尝试 RESET_MODEM</li>
</ul>
<hr/>
<h3 data-id="heading-17">五、指标和诊断</h3>
<h4 data-id="heading-18">5.1 数据卡死恢复统计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">693</span>-<span class="hljs-number">717</span>|    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">broadcastDataStallDetected</span><span class="hljs-params">(<span class="hljs-meta">@RecoveryAction</span> <span class="hljs-type">int</span> recoveryAction)</span> {
<span class="hljs-number">694</span>|        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(TelephonyManager.ACTION_DATA_STALL_DETECTED);
<span class="hljs-number">697</span>|        intent.putExtra(TelephonyManager.EXTRA_RECOVERY_ACTION, recoveryAction);
<span class="hljs-number">699</span>|
<span class="hljs-number">700</span>|        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isRecovered</span> <span class="hljs-operator">=</span> !mDataStalled;
<span class="hljs-number">701</span>|        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (SystemClock.elapsedRealtime() - mDataStallStartMs);
<span class="hljs-number">702</span>|        <span class="hljs-meta">@RecoveredReason</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">reason</span> <span class="hljs-operator">=</span> getRecoveredReason(mIsValidNetwork);
<span class="hljs-number">703</span>|        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">durationOfAction</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) getDurationOfCurrentRecoveryMs();
<span class="hljs-number">704</span>|
<span class="hljs-number">710</span>|        <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> mStats.getDataStallRecoveryMetricsData(
<span class="hljs-number">711</span>|                recoveryAction, isRecovered, duration, reason, 
<span class="hljs-number">712</span>|                mValidationCount, mActionValidationCount, durationOfAction);
<span class="hljs-number">713</span>|        intent.putExtra(<span class="hljs-string">"EXTRA_DSRS_STATS_BUNDLE"</span>, bundle);
<span class="hljs-number">714</span>|
<span class="hljs-number">717</span>|        mPhone.getContext().sendBroadcast(intent, READ_PRIVILEGED_PHONE_STATE);
    }
</code></pre>
<p><strong>上报的关键指标</strong>：</p>
<ul>
<li><code>isRecovered</code>: 是否已恢复</li>
<li><code>duration</code>: 从卡死开始到恢复的总耗时</li>
<li><code>reason</code>: 恢复原因（DSRM、Modem、User、None）</li>
<li><code>validationCount</code>: 总验证次数</li>
<li><code>actionValidationCount</code>: 当前动作的验证次数</li>
<li><code>durationOfAction</code>: 当前恢复动作的执行耗时</li>
</ul>
<h4 data-id="heading-19">5.2 ConnectivityDiagnostics 集成</h4>
<p>数据卡死恢复统计会获取以下诊断数据：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">185</span>-<span class="hljs-number">191</span>|    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDataStallSuspected</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> DataStallReport report)</span> {
<span class="hljs-number">186</span>|        <span class="hljs-type">PersistableBundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> report.getStallDetails();
<span class="hljs-number">187</span>|        mTcpMetricsCollectionPeriodMillis =
<span class="hljs-number">188</span>|            bundle.getInt(KEY_TCP_METRICS_COLLECTION_PERIOD_MILLIS);
<span class="hljs-number">189</span>|        mTcpPacketFailRate = bundle.getInt(KEY_TCP_PACKET_FAIL_RATE);
<span class="hljs-number">190</span>|        mDnsConsecutiveTimeouts = bundle.getInt(KEY_DNS_CONSECUTIVE_TIMEOUTS);
<span class="hljs-number">191</span>|    }
</code></pre>
<p><strong>诊断信息</strong>：</p>
<ul>
<li><strong>DNS 连续超时数</strong>：连续 DNS 查询失败的次数</li>
<li><strong>TCP 包失败率</strong>：TCP 包送达失败的百分比</li>
<li><strong>TCP 指标收集周期</strong>：这些指标的统计周期</li>
</ul>
<hr/>
<h3 data-id="heading-20">六、完整流程图</h3>
<pre><code class="hljs language-ini" lang="ini">数据卡死场景
  ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 1: 检测阶段                                             │
│ - NetworkMonitor 监测到 DNS 超时或 TCP 失败率高              │
│ - ConnectivityService 通知验证失败                           │
│ - onInternetValidationStatusChanged(NOT_VALID)              │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────┐
│ Step 2: 触发检查                                             │
│ - <span class="hljs-attr">mDataStalled</span> = <span class="hljs-literal">true</span>                                        │
│ - isRecoveryNeeded() 判断是否满足恢复条件                    │
│   ├─ 有活跃通话？→ 跳过高级别恢复 (RADIO_RESTART+)          │
│   ├─ 用户禁用数据？→ 放弃恢复                                │
│   ├─ 信号太差？→ 放弃恢复                                    │
│   └─ 已尝试所有步骤？→ 放弃恢复                              │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
          ┌───────────────────────┐
          │ 恢复条件满足？         │
          └───┬─────────┬─────────┘
              │ YES     │ NO
              ↓         └─→ 等待下次验证
              ↓
┌──────────────────────────────────────────────────────────────┐
│ Step 3: 恢复执行 (doRecovery)                                │
│                                                               │
│ ┌─ Action 0: GET_DATA_CALL_LIST                             │
│ │  └─ requestDataCallList() 查询数据连接列表                │
│ │     └─ <span class="hljs-section">[等待 180s]</span>                                         │
│ │
│ ├─ Action 1: CLEANUP                                         │
│ │  └─ onDataStallReestablishInternet()                      │
│ │     ├─ 断开所有 Internet PDN (DEACTIVATE_DATA_CALL)       │
│ │     └─ 等待网络请求重建 (SETUP_DATA_CALL)                │
│ │        └─ <span class="hljs-section">[等待 180s]</span>                                      │
│ │
│ ├─ Action 2: RADIO_RESTART                                   │
│ │  └─ powerOffRadioSafely()                                 │
│ │     ├─ RIL_REQUEST_RADIO_POWER(false) 关闭 RF             │
│ │     ├─ <span class="hljs-section">[延迟 ~100-500ms]</span>                                   │
│ │     └─ RIL_REQUEST_RADIO_POWER(true) 打开 RF              │
│ │        └─ <span class="hljs-section">[等待 180s 或更长，重新注册网络]</span>                │
│ │
│ └─ Action 3: RESET_MODEM                                     │
│    └─ rebootModem()                                          │
│       ├─ RIL_REQUEST_MODEM_RESET                            │
│       ├─ Modem 完全重启 (~5-30s)                            │
│       ├─ Framework 监听 UNSOL_MODEM_RESTART                │
│       └─ 重建所有数据连接                                    │
│          └─ <span class="hljs-section">[不再等待，标记 mIsAttemptedAllSteps = true]</span>    │
└──────────────────────────────────────────────────────────────┘
                      ↓
┌──────────────────────────────────────────────────────────────┐
│ Step 4: 验证结果                                             │
│                                                               │
│ ┌─ 验证通过 (VALIDATION_STATUS_VALID)                       │
│ │  └─ reset() 恢复到初始状态                                 │
│ │     ├─ <span class="hljs-attr">mDataStalled</span> = <span class="hljs-literal">false</span>                               │
│ │     ├─ <span class="hljs-attr">mRecoveryAction</span> = GET_DATA_CALL_LIST               │
│ │     ├─ <span class="hljs-attr">mIsAttemptedAllSteps</span> = <span class="hljs-literal">false</span>                       │
│ │     └─ 发送 ACTION_DATA_STALL_DETECTED 广播               │
│ │
│ └─ 验证继续失败                                              │
│    └─ <span class="hljs-section">[延迟后]</span> 触发下一级恢复                                │
│       或 <span class="hljs-section">[已尝试所有步骤]</span> 放弃恢复                           │
└──────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-21">七、关键配置项</h3>
<pre><code class="hljs language-ini" lang="ini">CarrierConfigManager.KEY_DATA_STALL_RECOVERY_TIMERS_LONG_ARRAY
├─ <span class="hljs-section">[0]</span>: GET_DATA_CALL_LIST → CLEANUP 间隔 (默认 180000ms)
├─ <span class="hljs-section">[1]</span>: CLEANUP → RADIO_RESTART 间隔 (默认 180000ms)
├─ <span class="hljs-section">[2]</span>: RADIO_RESTART → RESET_MODEM 间隔 (默认 180000ms)
└─ <span class="hljs-section">[3]</span>: RESET_MODEM 后的间隔 (默认 180000ms，实际不用)

CarrierConfigManager.KEY_DATA_STALL_RECOVERY_SHOULD_SKIP_ARRAY
├─ <span class="hljs-section">[0]</span>: 是否跳过 GET_DATA_CALL_LIST
├─ <span class="hljs-section">[1]</span>: 是否跳过 CLEANUP (某些相同 APN 情况)
├─ <span class="hljs-section">[2]</span>: 是否跳过 RADIO_RESTART
└─ <span class="hljs-section">[3]</span>: 是否跳过 RESET_MODEM

Settings.Global.DSRM_ENABLED_ACTIONS
└─ "true,true,false,true" 格式，允许动态禁用特定恢复动作

Settings.Global.DSRM_DURATION_MILLIS
└─ "180000,180000,180000,180000" 格式，允许动态调整延迟
</code></pre>
<hr/>
<h3 data-id="heading-22">八、总结</h3>
<p>数据卡死恢复是一个精心设计的<strong>四级递进容错机制</strong>：</p>








































<table><thead><tr><th>级别</th><th>名称</th><th>作用范围</th><th>风险等级</th><th>恢复时间</th></tr></thead><tbody><tr><td>0</td><td>GET_DATA_CALL_LIST</td><td>状态查询、同步</td><td>无</td><td>&lt;1s</td></tr><tr><td>1</td><td>CLEANUP</td><td>连接重建、Channel 清理</td><td>低</td><td>&lt;10s</td></tr><tr><td>2</td><td>RADIO_RESTART</td><td>RF 重启、重新注册</td><td>中</td><td>~30-60s</td></tr><tr><td>3</td><td>RESET_MODEM</td><td>完全Modem重启</td><td>高</td><td>~5-30s + 重连</td></tr></tbody></table>
<p><strong>关键特性</strong>：</p>
<ul>
<li>✅ <strong>渐进式</strong>：从轻量级到重量级逐步升级</li>
<li>✅ <strong>自适应</strong>：根据运营商配置跳过不必要的步骤</li>
<li>✅ <strong>安全</strong>：通话中避免高风险恢复、信号差时放弃恢复</li>
<li>✅ <strong>可配置</strong>：每个步骤的延迟和是否执行都可动态配置</li>
<li>✅ <strong>可诊断</strong>：详细的上报恢复事件和诊断数据</li>
</ul>
<p>现在让我更新 TODO 列表：</p>
<p>完美！现在让我提供几个关键代码片段的详细分析，以供你进一步深入理解：</p>
<hr/>
<h2 data-id="heading-23">📌 关键代码深度分析</h2>
<h3 data-id="heading-24">1. 恢复循环的核心逻辑</h3>
<pre><code class="hljs language-357:401:frameworks_opt_telephony/src/java/com/android/internal/telephony/data/DataStallRecoveryManager.java" lang="357:401:frameworks_opt_telephony/src/java/com/android/internal/telephony/data/DataStallRecoveryManager.java">    @Override
    public void handleMessage(Message msg) {
        logv("handleMessage = " + msg);
        switch (msg.what) {
            case EVENT_SEND_DATA_STALL_BROADCAST:
                mRecoveryTriggered = true;
                // Verify that DSRM needs to process the recovery action
                if (!isRecoveryNeeded(false)) {
                    cancelNetworkCheckTimer();
                    startNetworkCheckTimer(getRecoveryAction());
                    return;
                }
                // Broadcast intent that data stall has been detected.
                broadcastDataStallDetected(getRecoveryAction());
                // Schedule the message to wait for the predicted value.
                sendMessageDelayed(
                        obtainMessage(EVENT_DO_RECOVERY), mPredictWaitingMillis);
                break;
            case EVENT_DO_RECOVERY:
                doRecovery();
                break;
            case EVENT_RADIO_STATE_CHANGED:
                mRadioPowerState = mPhone.getRadioPowerState();
                if (mDataStalled) {
                    // Store the radio state changed flag only when data stall occurred.
                    mRadioStateChangedDuringDataStall = true;
                    if (Settings.Global.getInt(
                                    mPhone.getContext().getContentResolver(),
                                    Settings.Global.AIRPLANE_MODE_ON,
                                    0) != 0) {
                        mIsAirPlaneModeEnableDuringDataStall = true;
                    }
                    setRecoveryAction(mLastAction);
                }
                break;
            case EVENT_CONTENT_DSRM_ENABLED_ACTIONS_CHANGED:
                updateGlobalConfigActions();
                break;
            case EVENT_CONTENT_DSRM_DURATION_MILLIS_CHANGED:
                updateGlobalConfigDurations();
                break;
            default:
                loge("Unexpected message = " + msg);
                break;
        }
    }
</code></pre>
<p><strong>关键点分析</strong>：</p>
<ul>
<li>
<p><strong>EVENT_SEND_DATA_STALL_BROADCAST</strong> 是恢复循环的关键触发点，它会：</p>
<ol>
<li>检查 <code>isRecoveryNeeded(false)</code> 判断是否真的需要恢复（不再等待延迟）</li>
<li>如果需要，发送 DSRS Broadcast（用于诊断）</li>
<li>延迟 <code>mPredictWaitingMillis</code>（通常 1000ms）后发送 EVENT_DO_RECOVERY</li>
</ol>
</li>
<li>
<p><strong>EVENT_RADIO_STATE_CHANGED</strong> 会自动升级恢复步骤，如果系统已经自己重启了 Radio（可能由其他模块触发），则直接跳到 RESET_MODEM</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-25">2. 验证状态变化处理</h3>
<pre><code class="hljs language-570:591:frameworks_opt_telephony/src/java/com/android/internal/telephony/data/DataStallRecoveryManager.java" lang="570:591:frameworks_opt_telephony/src/java/com/android/internal/telephony/data/DataStallRecoveryManager.java">    private void onInternetValidationStatusChanged(@ValidationStatus int status) {
        logl("onInternetValidationStatusChanged: " + DataUtils.validationStatusToString(status));
        final boolean isValid = status == NetworkAgent.VALIDATION_STATUS_VALID;
        if (mFeatureFlags.dsrsDiagnosticsEnabled()) {
            mValidationCount += 1;
            mActionValidationCount += 1;
        }
        setNetworkValidationState(isValid);
        if (isValid) {
            if (mFeatureFlags.dsrsDiagnosticsEnabled()) {
                // Broadcast intent that data stall recovered.
                broadcastDataStallDetected(mLastAction);
            }
            reset();
        } else if (isRecoveryNeeded(true)) {
            // Set the network as invalid, because recovery is needed
            mIsValidNetwork = false;
            log("trigger data stall recovery");
            mTimeLastRecoveryStartMs = SystemClock.elapsedRealtime();
            sendMessage(obtainMessage(EVENT_SEND_DATA_STALL_BROADCAST));
        }
    }
</code></pre>
<p><strong>验证流程</strong>：</p>
<ol>
<li>验证通过 → 立即 <code>reset()</code> 复位，恢复完成</li>
<li>验证失败 + 满足恢复条件 → 立即触发 <code>EVENT_SEND_DATA_STALL_BROADCAST</code> 进入恢复循环</li>
<li>验证失败 + 不满足恢复条件 → 记录日志，等待下次验证</li>
</ol>
<hr/>
<h3 data-id="heading-26">3. CLEANUP 的实际执行</h3>
<pre><code class="hljs language-3450:3459:frameworks_opt_telephony/src/java/com/android/internal/telephony/data/DataNetworkController.java" lang="3450:3459:frameworks_opt_telephony/src/java/com/android/internal/telephony/data/DataNetworkController.java">    private void onDataStallReestablishInternet() {
        log("onDataStallReestablishInternet: Tear down data networks that support internet.");
        // Tear down all data networks that support internet. After data disconnected, unsatisfied
        // network requests will be re-evaluate again and data network controller will attempt to
        // setup data networks to satisfy them.
        mDataNetworkList.stream()
                .filter(DataNetwork::isInternetSupported)
                .forEach(dataNetwork -&gt; dataNetwork.tearDown(
                        DataNetwork.TEAR_DOWN_REASON_DATA_STALL));
    }
</code></pre>
<p><strong>重要细节</strong>：</p>
<ul>
<li>仅断开 <code>isInternetSupported()</code> 的网络（通常是默认 APN）</li>
<li>不会断开 IMS、MMS 等特殊用途的 PDN</li>
<li>断开后，<code>DataNetworkController</code> 会根据待决的网络请求自动重建</li>
<li>这是一个"轻量级"恢复，因为没有涉及 Radio 或 Modem</li>
</ul>
<hr/>
<h3 data-id="heading-27">4. 动态调整恢复步骤</h3>
<pre><code class="hljs language-620:659:frameworks_opt_telephony/src/java/com/android/internal/telephony/data/DataStallRecoveryManager.java" lang="620:659:frameworks_opt_telephony/src/java/com/android/internal/telephony/data/DataStallRecoveryManager.java">    public void setRecoveryAction(@RecoveryAction int action) {
        // Reset the validation count for action change
        if (mFeatureFlags.dsrsDiagnosticsEnabled() &amp;&amp; mRecoveryAction != action) {
            mActionValidationCount = 0;
        }
        mRecoveryAction = action;

        // Check if the mobile data enabled is TRUE, it means that the mobile data setting changed
        // from DISABLED to ENABLED, we will set the next recovery action to
        // RECOVERY_ACTION_RADIO_RESTART due to already did the RECOVERY_ACTION_CLEANUP.
        if (mMobileDataChangedToEnabledDuringDataStall
                &amp;&amp; mRecoveryAction &lt; RECOVERY_ACTION_RADIO_RESTART) {
            mRecoveryAction = RECOVERY_ACTION_RADIO_RESTART;
        }
        // Check if the radio state changed from off to on, it means that the modem already
        // did the radio restart, we will set the next action to RECOVERY_ACTION_RESET_MODEM.
        if (mRadioStateChangedDuringDataStall
                &amp;&amp; mRadioPowerState == TelephonyManager.RADIO_POWER_ON) {
            mRecoveryAction = RECOVERY_ACTION_RESET_MODEM;
        }
        // To check the flag from DataConfigManager if we need to skip the step.
        if (shouldSkipRecoveryAction(mRecoveryAction)) {
            switch (mRecoveryAction) {
                case RECOVERY_ACTION_GET_DATA_CALL_LIST:
                    setRecoveryAction(RECOVERY_ACTION_CLEANUP);
                    break;
                case RECOVERY_ACTION_CLEANUP:
                    setRecoveryAction(RECOVERY_ACTION_RADIO_RESTART);
                    break;
                case RECOVERY_ACTION_RADIO_RESTART:
                    setRecoveryAction(RECOVERY_ACTION_RESET_MODEM);
                    break;
                case RECOVERY_ACTION_RESET_MODEM:
                    resetAction();
                    break;
            }
        }

        log("setRecoveryAction: " + recoveryActionToString(mRecoveryAction));
    }
</code></pre>
<p><strong>三层智能逻辑</strong>：</p>
<ol>
<li><strong>用户操作检测</strong>：如果用户在卡死期间启用数据 → 跳过已执行的步骤</li>
<li><strong>System Event 检测</strong>：如果 Radio 在卡死期间重启 → 说明系统已执行 RADIO_RESTART，直接尝试 RESET_MODEM</li>
<li><strong>运营商配置</strong>：根据运营商配置跳过不必要的步骤（递归调用）</li>
</ol>
<hr/>
<h3 data-id="heading-28">5. 运营商配置的动态更新</h3>
<pre><code class="hljs language-428:454:frameworks_opt_telephony/src/java/com/android/internal/telephony/data/DataStallRecoveryManager.java" lang="428:454:frameworks_opt_telephony/src/java/com/android/internal/telephony/data/DataStallRecoveryManager.java">    private void updateGlobalConfigActions() {
        String enabledActions = Settings.Global.getString(
                mPhone.getContext().getContentResolver(),
                Settings.Global.DSRM_ENABLED_ACTIONS);

        if (!TextUtils.isEmpty(enabledActions)) {
            String[] splitEnabledActions = enabledActions.split(",");
            boolean[] enabledActionsArray = new boolean[splitEnabledActions.length];
            for (int i = 0; i &lt; enabledActionsArray.length; i++) {
                enabledActionsArray[i] = Boolean.parseBoolean(splitEnabledActions[i].trim());
            }

            int minLength = Math.min(enabledActionsArray.length,
                    mSkipRecoveryActionArray.length);

            // Update the skip recovery action array.
            for (int i = 0; i &lt; minLength; i++) {
                mSkipRecoveryActionArray[i] = !enabledActionsArray[i];
            }
            log("SkipRecoveryAction: "
                    + Arrays.toString(mSkipRecoveryActionArray));
            mPredictWaitingMillis = DSRM_PREDICT_WAITING_MILLIS;
        } else {
            mPredictWaitingMillis = 0;
            log("Enabled actions is null");
        }
    }
</code></pre>
<p><strong>动态配置特性</strong>：</p>
<ul>
<li>支持运营商通过 <code>Settings.Global.DSRM_ENABLED_ACTIONS</code> 动态控制恢复步骤</li>
<li>格式：<code>"true,true,false,true"</code> 表示启用步骤 0、1、3，跳过步骤 2</li>
<li>也支持动态调整延迟时间：<code>Settings.Global.DSRM_DURATION_MILLIS</code></li>
</ul>
<hr/>
<h2 data-id="heading-29">🎯 实战应用指南</h2>
<h3 data-id="heading-30">问题排查</h3>
<ol>
<li>
<p><strong>数据卡死频繁发生</strong></p>
<ul>
<li>检查 NetworkMonitor 的 DNS/TCP 检测阈值</li>
<li>检查网络信号强度和网络质量</li>
<li>查看 DSRM 是否真的执行了恢复步骤（查看日志）</li>
</ul>
</li>
<li>
<p><strong>恢复步骤没有执行</strong></p>
<ul>
<li>检查 <code>shouldSkipRecoveryAction()</code> 是否因运营商配置跳过了</li>
<li>检查 <code>isRecoveryNeeded()</code> 的各个条件是否满足</li>
<li>查看用户是否处于通话中、飞行模式、或禁用数据</li>
</ul>
</li>
<li>
<p><strong>某个恢复步骤无效</strong></p>
<ul>
<li>对于 CLEANUP 无效 → 可能需要运营商配置跳过，直接尝试 RADIO_RESTART</li>
<li>对于 RADIO_RESTART 无效 → 可能是 Modem 固件问题，需要 RESET_MODEM</li>
<li>对于 RESET_MODEM 无效 → 可能是硬件或信号问题，超出 DSRM 范围</li>
</ul>
</li>
</ol>
<h3 data-id="heading-31">性能优化</h3>
<ol>
<li>
<p><strong>减少卡死误报</strong></p>
<ul>
<li>增加 NetworkMonitor 的检测阈值</li>
<li>减少检测频率</li>
</ul>
</li>
<li>
<p><strong>加快恢复速度</strong></p>
<ul>
<li>减少 DSRM 延迟配置（CarrierConfig）</li>
<li>对于某些运营商，可以跳过不必要的步骤</li>
</ul>
</li>
<li>
<p><strong>降低用户影响</strong></p>
<ul>
<li>在通话中不执行 RADIO_RESTART/RESET_MODEM</li>
<li>信号差时不执行恢复（避免无谓的操作）</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-32">📚 相关文件索引</h2>
<pre><code class="hljs language-scss" lang="scss">核心实现
├─ DataStallRecoveryManager<span class="hljs-selector-class">.java</span> (DSRM 主逻辑)
├─ DataNetworkController<span class="hljs-selector-class">.java</span> (数据网络管理)
├─ DataNetwork<span class="hljs-selector-class">.java</span> (单个 PDN 的连接管理)
└─ RIL<span class="hljs-selector-class">.java</span> (与 Modem 通信)

诊断和统计
├─ DataStallRecoveryStats<span class="hljs-selector-class">.java</span> (恢复统计)
├─ ConnectivityService<span class="hljs-selector-class">.java</span> (网络验证)
└─ NetworkMonitor (网络质量监测)

配置
├─ CarrierConfigManager<span class="hljs-selector-class">.java</span> (运营商配置)
├─ DataConfigManager<span class="hljs-selector-class">.java</span> (数据配置管理)
└─ Settings<span class="hljs-selector-class">.Global</span> (动态全局设置)
</code></pre>
<p>这就是 Android Telephony 中完整的<strong>数据恢复与容错机制</strong>！如有任何疑问，欢迎继续提问 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose BOM 2026.01.01 上新：1.10.2 稳定补丁 + Material 3 1.4.0 重点能力梳理]]></title>    <link>https://juejin.cn/post/7603321550247362610</link>    <guid>https://juejin.cn/post/7603321550247362610</guid>    <pubDate>2026-02-06T09:53:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603321550247362610" data-draft-id="7603309951227625522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose BOM 2026.01.01 上新：1.10.2 稳定补丁 + Material 3 1.4.0 重点能力梳理"/> <meta itemprop="keywords" content="Android Jetpack"/> <meta itemprop="datePublished" content="2026-02-06T09:53:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Nicko"/> <meta itemprop="url" content="https://juejin.cn/user/3791538512733501"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose BOM 2026.01.01 上新：1.10.2 稳定补丁 + Material 3 1.4.0 重点能力梳理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3791538512733501/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Nicko
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:53:38.000Z" title="Fri Feb 06 2026 09:53:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    69
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Compose BOM <code>2026.01.01</code> 上新：1.10.2 稳定补丁 + Material 3 <code>1.4.0</code> 重点能力梳理</h2>
<h3 data-id="heading-1">前言</h3>
<p>如果你在 Android 项目里使用 Jetpack Compose，<code>BOM</code>（Bill of Materials）是最稳的版本管理方式之一：</p>
<ul>
<li>只声明一个 BOM 版本，Compose 相关依赖就能自动对齐。</li>
<li>降低“某个模块偷偷升了版本，结果运行时出问题”的概率。</li>
</ul>
<p>截至 <strong>2026-02-06</strong>，Compose 官方文档中的示例 BOM 已更新到：</p>
<ul>
<li><code>androidx.compose:compose-bom:2026.01.01</code></li>
<li><code>androidx.compose:compose-bom-alpha:2026.01.01</code></li>
<li><code>androidx.compose:compose-bom-beta:2026.01.01</code></li>
</ul>
<p>这篇文章按“前言 → 版本速览 → 模块更新 → 迁移建议”的结构，快速讲清楚这个版本值不值得升、升了要注意什么。</p>
<hr/>
<h3 data-id="heading-2">Compose BOM <code>2026.01.01</code> 速览</h3>
<h4 data-id="heading-3">1）一句话结论</h4>
<p><code>2026.01.01</code> 是一个<strong>稳定补丁聚合版本</strong>：</p>
<ul>
<li>核心 Compose 组（<code>animation</code>/<code>foundation</code>/<code>runtime</code>/<code>ui</code>）对齐到 <code>1.10.2</code>。</li>
<li><code>material3</code> 对齐到稳定版 <code>1.4.0</code>。</li>
<li><code>material3.adaptive</code> 对齐到 <code>1.2.0</code>。</li>
</ul>
<h4 data-id="heading-4">2）关键映射（官方 BOM Mapping）</h4>





















































<table><thead><tr><th>Compose 组</th><th>代表 Artifact</th><th>BOM 对应版本</th><th>发布说明</th></tr></thead><tbody><tr><td>Animation</td><td><code>androidx.compose.animation:animation</code></td><td><code>1.10.2</code></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-animation%231.10.2" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-animation#1.10.2" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></td></tr><tr><td>Foundation</td><td><code>androidx.compose.foundation:foundation</code></td><td><code>1.10.2</code></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-foundation%231.10.2" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-foundation#1.10.2" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></td></tr><tr><td>Runtime</td><td><code>androidx.compose.runtime:runtime</code></td><td><code>1.10.2</code></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-runtime%231.10.2" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-runtime#1.10.2" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></td></tr><tr><td>UI</td><td><code>androidx.compose.ui:ui</code></td><td><code>1.10.2</code></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-ui%231.10.2" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-ui#1.10.2" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></td></tr><tr><td>Material (M2)</td><td><code>androidx.compose.material:material</code></td><td><code>1.10.2</code></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-material%231.10.2" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-material#1.10.2" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></td></tr><tr><td>Material3</td><td><code>androidx.compose.material3:material3</code></td><td><code>1.4.0</code></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-material3%231.4.0" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-material3#1.4.0" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></td></tr><tr><td>Material3 Adaptive</td><td><code>androidx.compose.material3.adaptive:adaptive</code></td><td><code>1.2.0</code></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-material3-adaptive%231.2.0" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-material3-adaptive#1.2.0" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></td></tr></tbody></table>
<blockquote>
<p>时间点参考：<code>1.10.2</code> 发布于 <strong>2026-01-28</strong>；<code>material3:1.4.0</code> 发布于 <strong>2025-09-24</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">主要更新（你真正会感知到的）</h3>
<h3 data-id="heading-6">1）Animation 1.10：共享元素能力明显增强</h3>
<p>虽然 BOM 映射到的是 <code>1.10.2</code>（补丁版），但 1.10 周期里动画能力升级很实用：</p>
<ul>
<li>Shared transition APIs 在 1.10 正式稳定。</li>
<li>新增 <code>Modifier.skipToLookaheadPosition()</code>，可在共享过渡中直接跳到目标位置。</li>
<li>支持动态启用/禁用 shared elements。</li>
<li>支持共享元素过渡的初速度（fling 场景更自然）。</li>
<li>为 <code>AnimatedVisibility</code> / <code>AnimatedContent</code> 增加 veil layer 动画能力。</li>
</ul>
<p>适用场景：详情页转场、卡片到全屏、图库过渡等“空间连续性”动画。</p>
<h3 data-id="heading-7">2）Foundation 1.10：性能和稳定性继续收敛</h3>
<p>值得关注的两类变化：</p>
<ul>
<li><strong>性能方向</strong>：<code>isPausableCompositionInPrefetchEnabled</code> 在 1.10 周期默认启用，Lazy 列表预取更平滑、主线程压力更可控。</li>
<li><strong>稳定性方向</strong>：<code>1.10.2</code> 修复了文本选择相关的崩溃（例如页面返回时有活动选区）。</li>
</ul>
<p>如果你有长列表 + 重 Item 组合，升级后通常更容易获得稳定帧率。</p>
<h3 data-id="heading-8">3）Runtime 1.10：<code>retain</code> 体系成熟，补丁版更稳</h3>
<p>Runtime 1.10 周期中，<code>RetainedValuesStore</code> 相关 API 经历了整理：</p>
<ul>
<li>更强调通过 provider/registry 管理 retained values。</li>
<li>自定义 retained store 的接入方式有迁移成本（命名和安装方式变化较多）。</li>
<li><code>1.10.2</code> 主要是补丁整合，重点在稳定性。</li>
</ul>
<p>如果你只是“正常使用 <code>retain</code>”，改动通常不大；如果你实现了自定义 store，建议对照 release notes 逐项迁移。</p>
<h3 data-id="heading-9">4）UI 1.10：焦点、测试与 Popup 行为更一致</h3>
<p>1.10 周期里 UI 侧有几项很实用：</p>
<ul>
<li>焦点分发优化（降低复杂焦点树下的额外开销）。</li>
<li>间接触控 API 命名统一到 indirect pointer 体系。</li>
<li>Compose UI Test 对 <code>effectContext</code>、<code>StandardTestDispatcher</code> 支持更清晰。</li>
<li><code>1.10.1</code> 修复了 <code>LookaheadScope</code> + pausable composition 崩溃，以及 <code>PopupPositionProvider</code> 坐标计算问题。</li>
</ul>
<p>如果你的项目有 TV/键盘焦点、复杂 Popup 定位、或 UI 测试稳定性问题，这部分收益会比较明显。</p>
<h3 data-id="heading-10">5）Material3 <code>1.4.0</code>：组件能力升级最明显</h3>
<p><code>material3:1.4.0</code> 的变化量很大，重点看这几类：</p>
<ul>
<li><strong>图标策略变化</strong>：不再推荐 <code>androidx.compose.material.icons</code> 作为主路径；且 Material3 不再自动依赖 <code>material-icons-core</code>。</li>
<li><strong>行为调整</strong>：<code>NavigationBarItem</code> / <code>NavigationRailItem</code> 的 active label 颜色策略有调整。</li>
<li><strong>动效体系</strong>：组件开始采用 <code>MotionScheme</code>。</li>
<li><strong>新组件/能力</strong>：
<ul>
<li><code>HorizontalCenteredHeroCarousel</code></li>
<li><code>VerticalDragHandle</code></li>
<li><code>SecureTextField</code> / <code>OutlinedSecureTextField</code></li>
<li><code>Text</code> 支持 <code>autoSize</code></li>
<li><code>TimePickerDialog</code></li>
<li>新的 SearchBar API 拆分与状态控制</li>
</ul>
</li>
</ul>
<p>结论：如果你正在做 Material3 设计系统迭代，这一块是 BOM <code>2026.01.01</code> 最值得关注的部分。</p>
<hr/>
<h3 data-id="heading-11">升级示例</h3>
<h3 data-id="heading-12">1）Gradle Kotlin DSL</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    <span class="hljs-keyword">val</span> composeBom = platform(<span class="hljs-string">"androidx.compose:compose-bom:2026.01.01"</span>)
    implementation(composeBom)
    androidTestImplementation(composeBom)

    implementation(<span class="hljs-string">"androidx.compose.ui:ui"</span>)
    implementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling-preview"</span>)
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling"</span>)

    implementation(<span class="hljs-string">"androidx.compose.material3:material3"</span>)

    androidTestImplementation(<span class="hljs-string">"androidx.compose.ui:ui-test-junit4"</span>)
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-test-manifest"</span>)
}
</code></pre>
<h3 data-id="heading-13">2）如果你用 Version Catalog</h3>
<p><code>libs.versions.toml</code> 中把 BOM 改到：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[versions]</span>
<span class="hljs-attr">compose-bom</span> = <span class="hljs-string">"2026.01.01"</span>

<span class="hljs-section">[libraries]</span>
<span class="hljs-attr">androidx-compose-bom</span> = { module = <span class="hljs-string">"androidx.compose:compose-bom"</span>, version.ref = <span class="hljs-string">"compose-bom"</span> }
</code></pre>
<hr/>
<h3 data-id="heading-14">迁移与排坑建议</h3>
<h3 data-id="heading-15">1）检查图标依赖</h3>
<p>如果你之前“隐式”用到了图标，升级后建议显式声明：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">implementation(<span class="hljs-string">"androidx.compose.material:material-icons-core"</span>)
</code></pre>
<h3 data-id="heading-16">2）检查 <code>retain</code> 的自定义用法</h3>
<p>有自定义 <code>RetainedValuesStore</code> 的项目，重点回看 Runtime 1.10 的 API 变更。</p>
<h3 data-id="heading-17">3）回归测试建议</h3>
<ul>
<li>重点回归 <code>Popup</code> 定位、文本选择、导航返回。</li>
<li>UI 测试项目可逐步尝试 <code>StandardTestDispatcher</code>，减少与生产调度模型差异。</li>
</ul>
<h3 data-id="heading-18">4）版本策略建议</h3>
<p>如果你追求稳定，优先跟 BOM 稳定版；
如果你要抢新特性（尤其 Material3 1.5.x alpha），建议单独分支验证再合入主干。</p>
<hr/>
<h3 data-id="heading-19">小结</h3>
<p>Compose BOM <code>2026.01.01</code> 的定位很清晰：</p>
<ul>
<li>用 <code>1.10.2</code> 把核心栈稳定性再打磨一轮；</li>
<li>让 Material3 <code>1.4.0</code> 的能力成为稳定可用基线。</li>
</ul>
<p>对大多数业务 App 来说，这个版本属于“可以计划升级，并且收益可见”的一档。</p>
<hr/>
<h3 data-id="heading-20">参考链接</h3>
<ul>
<li>Compose BOM：
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fdevelop%2Fui%2Fcompose%2Fbom" target="_blank" title="https://developer.android.com/develop/ui/compose/bom" ref="nofollow noopener noreferrer">developer.android.com/develop/ui/…</a></li>
</ul>
</li>
<li>BOM Mapping：
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fdevelop%2Fui%2Fcompose%2Fbom%2Fbom-mapping" target="_blank" title="https://developer.android.com/develop/ui/compose/bom/bom-mapping" ref="nofollow noopener noreferrer">developer.android.com/develop/ui/…</a></li>
</ul>
</li>
<li>Compose Release Notes：
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-animation" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-animation" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-foundation" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-foundation" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-runtime" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-runtime" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-ui" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-ui" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Fcompose-material3" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/compose-material3" ref="nofollow noopener noreferrer">developer.android.com/jetpack/and…</a></li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[sql]sql和nosql]]></title>    <link>https://juejin.cn/post/7603309951227707442</link>    <guid>https://juejin.cn/post/7603309951227707442</guid>    <pubDate>2026-02-06T10:08:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227707442" data-draft-id="7603393977477496858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[sql]sql和nosql"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-02-06T10:08:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [sql]sql和nosql
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T10:08:37.000Z" title="Fri Feb 06 2026 10:08:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1/核心概念</h2>
<ol>
<li>
<p><strong>SQL（Structured Query Language）</strong></p>
<ul>
<li><strong>本意</strong>：指 <strong>结构化查询语言</strong>，是与关系型数据库通信的标准语言。</li>
<li><strong>现在通常指代</strong>：<strong>关系型数据库</strong> 本身。它基于关系模型（使用表、行、列），数据模式是预定义且固定的，强调数据的 <strong>一致性</strong> 和 <strong>完整性</strong>。</li>
</ul>
</li>
<li>
<p><strong>NoSQL（Not Only SQL）</strong></p>
<ul>
<li><strong>本意</strong>：<strong>不仅仅是 SQL</strong>。</li>
<li><strong>现在通常指代</strong>：<strong>非关系型数据库</strong>。它是一个统称，涵盖所有不遵循传统关系模型的数据存储系统。NoSQL 数据库通常为 <strong>可扩展性</strong>、<strong>灵活的模式</strong> 和 <strong>高性能</strong> 等特定需求而设计。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-1">2/主要区别</h2>













































<table><thead><tr><th align="left">特性</th><th align="left">SQL（关系型数据库）</th><th align="left">NoSQL（非关系型数据库）</th></tr></thead><tbody><tr><td align="left"><strong>数据模型</strong></td><td align="left"><strong>结构化</strong>。预定义的模式（表结构），数据以<strong>行和列</strong>的形式存储在表中，表之间通过外键关联。</td><td align="left"><strong>灵活/非结构化</strong>。无固定模式。根据类型不同，可以是键值对、文档、图或宽列。</td></tr><tr><td align="left"><strong>查询语言</strong></td><td align="left">使用标准化的 <strong>SQL</strong> 语言进行增删改查。</td><td align="left">没有统一查询语言。每种数据库有自己的 API 或查询方法（如基于 JSON 的查询）。</td></tr><tr><td align="left"><strong>扩展性</strong></td><td align="left"><strong>垂直扩展</strong>为主。通过增加单台服务器的 CPU、内存、硬盘来提升性能。横向扩展（分库分表）较复杂。</td><td align="left"><strong>水平扩展</strong>为主。天然支持通过增加服务器节点（分布式集群）来分担负载，扩展性强。</td></tr><tr><td align="left"><strong>事务性（ACID）</strong></td><td align="left">强调 <strong>ACID 属性</strong>（原子性、一致性、隔离性、持久性），支持复杂事务。</td><td align="left">通常遵循 <strong>BASE 原则</strong>（基本可用、软状态、最终一致性），牺牲强一致性以获得高可用和分区容错性。但部分 NoSQL 现在也支持事务。</td></tr><tr><td align="left"><strong>主要优势</strong></td><td align="left">数据结构化，数据完整性好，支持复杂查询和多表关联操作，技术成熟。</td><td align="left">高并发读写性能好，扩展灵活，模式灵活易于迭代，能很好地处理海量数据和非结构化数据。</td></tr><tr><td align="left"><strong>主要劣势</strong></td><td align="left">扩展性相对困难，高并发下可能遇到瓶颈，固定的模式在需求频繁变化时不够灵活。</td><td align="left">不支持复杂的关联查询（Join），事务支持相对较弱（尤其在分布式下），不同产品特性差异大。</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">需要复杂查询、强一致性、事务支持的场景。如：金融系统、ERP、CRM、会计系统等。</td><td align="left">大数据量、高并发、模式多变、数据结构不固定的场景。如：社交网络、内容管理系统、物联网、实时分析、购物车缓存等。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">3/各自代表的数据库</h2>
<h5 data-id="heading-3"><strong>SQL（关系型数据库）代表</strong></h5>
<p>这些都是 <strong>基于表的、支持 SQL 标准</strong> 的成熟数据库。</p>
<ol>
<li><strong>MySQL / MariaDB</strong>： 最流行的开源关系数据库，广泛用于Web应用。MariaDB 是 MySQL 的一个分支。</li>
<li><strong>PostgreSQL</strong>： 功能强大的开源对象-关系型数据库，支持高级数据类型（如 JSON、GIS）和复杂查询，被誉为“最先进的开源关系数据库”。</li>
<li><strong>Oracle Database</strong>： 企业级商业数据库的王者，功能极其全面强大，常用于大型、关键业务系统。</li>
<li><strong>Microsoft SQL Server</strong>： 微软推出的商业数据库，与 Windows 生态和 .NET 平台集成紧密。</li>
<li><strong>SQLite</strong>： 轻量级的嵌入式数据库，整个数据库就是一个文件，常用于移动端和桌面应用。</li>
</ol>
<h5 data-id="heading-4"><strong>NoSQL（非关系型数据库）代表</strong></h5>
<p>NoSQL 通常分为以下几大类，每类解决不同问题：</p>
<p><strong>1. 文档型数据库</strong></p>
<ul>
<li><strong>特点</strong>： 数据以类似 JSON/BSON 的<strong>文档</strong>形式存储，每个文档可以有完全不同的结构。</li>
<li><strong>代表</strong>：
<ul>
<li><strong>MongoDB</strong>： 最流行的文档数据库，查询功能强大，适合内容管理、用户配置等。</li>
<li><strong>CouchDB</strong>： 使用 HTTP API，支持数据同步。</li>
</ul>
</li>
</ul>
<p><strong>2. 键值型数据库</strong></p>
<ul>
<li><strong>特点</strong>： 最简单的 NoSQL 模型，数据以 <strong>键-值对</strong> 形式存储，通过键快速访问值。性能极高。</li>
<li><strong>代表</strong>：
<ul>
<li><strong>Redis</strong>： 数据存储在内存中，速度极快，常用作缓存、消息队列、会话存储。</li>
<li><strong>Amazon DynamoDB</strong>： AWS 托管的键值/文档混合数据库，提供极高的可扩展性。</li>
<li><strong>etcd</strong>： 用于分布式系统配置共享和服务发现。</li>
</ul>
</li>
</ul>
<p><strong>3. 宽列存储数据库</strong></p>
<ul>
<li><strong>特点</strong>： 数据存储在 <strong>列族</strong> 中，可以动态添加列，非常适合<strong>海量数据</strong>的存储和查询（特别是读操作）。</li>
<li><strong>代表</strong>：
<ul>
<li><strong>Apache Cassandra</strong>： 高可用、无单点故障的分布式数据库，写性能优异。</li>
<li><strong>Apache HBase</strong>： 构建在 Hadoop HDFS 之上的分布式数据库，适合大数据分析。</li>
<li><strong>Google Bigtable</strong>： Cassandra 和 HBase 的设计灵感来源。</li>
</ul>
</li>
</ul>
<p><strong>4. 图数据库</strong></p>
<ul>
<li><strong>特点</strong>： 专门存储<strong>实体（节点）</strong> 和<strong>关系（边）</strong> 的信息，擅长处理复杂的关系网络。</li>
<li><strong>代表</strong>：
<ul>
<li><strong>Neo4j</strong>： 最著名的图数据库，使用 Cypher 查询语言。</li>
<li><strong>Amazon Neptune</strong>： AWS 托管的图数据库服务。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">4/总结与趋势</h2>
<ul>
<li><strong>不是替代关系，而是互补关系</strong>： SQL 和 NoSQL 适用于不同的场景。现代架构中经常 <strong>混合使用</strong>，例如用 MySQL 存储核心交易数据，用 Redis 做缓存，用 Elasticsearch（一种搜索引擎，常被归为 NoSQL）做全文检索。</li>
<li><strong>融合趋势</strong>： 出现了 <strong>“NewSQL”</strong> 数据库（如 Google Spanner, CockroachDB），试图结合 SQL 的强一致性和 NoSQL 的水平扩展性。同时，许多传统 SQL 数据库（如 PostgreSQL, MySQL）也开始支持 JSON 等非结构化数据，而 NoSQL 数据库（如 MongoDB）也增加了事务支持。</li>
<li><strong>如何选择</strong>：
<ul>
<li>如果你的数据<strong>结构化、关系复杂、需要强一致性</strong>，优先选择 <strong>SQL</strong>。</li>
<li>如果你需要处理<strong>海量数据、高并发、模式多变、或数据结构松散</strong>，优先考虑 <strong>NoSQL</strong>。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第14章：包管理与模块化开发——组织大型项目]]></title>    <link>https://juejin.cn/post/7603383311531048975</link>    <guid>https://juejin.cn/post/7603383311531048975</guid>    <pubDate>2026-02-06T10:12:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603383311531048975" data-draft-id="7603355275258118184" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第14章：包管理与模块化开发——组织大型项目"/> <meta itemprop="keywords" content="后端,Go,编程语言"/> <meta itemprop="datePublished" content="2026-02-06T10:12:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第14章：包管理与模块化开发——组织大型项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T10:12:25.000Z" title="Fri Feb 06 2026 10:12:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Golang开发中，从小脚本到大型分布式应用，最核心的转变之一就是「代码组织与依赖管理」。早期的GOPATH模式曾因依赖混乱、版本冲突等问题让开发者诟病，而Go 1.11正式推出的Go Modules，彻底解决了这一痛点，成为目前Golang大型项目的标准模块化方案。</p>
<h3 data-id="heading-0">一、包的作用</h3>
<p>包（Package）是Golang中<strong>组织代码的最小单元</strong>，本质是将功能相关的.go文件聚合在一起，实现“模块化拆分、代码复用、作用域隔离”，类比Java的Package、Python的Module，是大型项目分层、协作开发的基础。</p>
<p>简单来说，包的核心作用有3个，用表格清晰梳理（掘金常用呈现方式）：</p>





















<table><thead><tr><th><strong>核心作用</strong></th><th><strong>详细说明（直击痛点）</strong></th></tr></thead><tbody><tr><td>代码复用</td><td>将通用功能（如工具函数、常用结构体、加密逻辑）封装成包，多个项目或项目内多个模块可直接导入使用，避免重复编码（比如所有项目都需要的字符串处理，封装成utils包一次开发、多次复用）</td></tr><tr><td>作用域隔离</td><td>通过包名和公私访问控制，解决命名冲突（比如A模块和B模块都有Init()函数，通过包名a.Init()、b.Init()区分，无需担心同名覆盖）</td></tr><tr><td>项目结构化</td><td>大型项目可按功能拆分多个包（如路由包router、数据库包db、工具包utils、业务包service），让代码层次清晰，便于多人协作、后期维护（比如后端项目中，路由、业务、数据访问分层拆分，各司其职）</td></tr></tbody></table>
<h4 data-id="heading-1">1.1 极简代码示例（包的基本结构）</h4>
<p>假设我们创建一个简单的工具包utils，包含一个计算平方的函数，目录结构和代码如下（简化版，聚焦核心）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 目录结构：utils/square.go（单个文件即可构成一个包）</span>
<span class="hljs-keyword">package</span> utils <span class="hljs-comment">// 声明当前文件属于utils包（包名建议与目录名一致，便于识别）</span>

<span class="hljs-comment">// CalculateSquare 计算整数的平方（后续讲解私有公有，此处先聚焦包结构）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CalculateSquare</span><span class="hljs-params">(num <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> num * num
}

</code></pre>
<p>在项目的主文件中，我们可以直接导入这个utils包，复用CalculateSquare函数，无需重复编写计算逻辑：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 目录结构：main.go（与utils目录同级）</span>
<span class="hljs-keyword">package</span> main <span class="hljs-comment">// 主程序必须属于main包，且包含main()函数</span>

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"./utils"</span> <span class="hljs-comment">// 导入当前目录下的utils包（后续讲解导入规则的详细用法）</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    res := utils.CalculateSquare(<span class="hljs-number">5</span>) <span class="hljs-comment">// 通过「包名.函数名」调用包内功能</span>
    fmt.Printf(<span class="hljs-string">"5的平方是：%d\n"</span>, res) <span class="hljs-comment">// 输出：5的平方是：25</span>
}

</code></pre>
<h4 data-id="heading-2">1.2 关键补充（避坑重点）</h4>
<ul>
<li>
<p>一个目录下的所有.go文件，必须声明属于同一个包（比如utils目录下的所有文件，package声明都必须是utils，不能出现其他包名）；</p>
</li>
<li>
<p>包名可以与目录名不同，但不推荐（比如utils目录下的文件声明package util，会增加识别成本，不符合Go的简洁原则）；</p>
</li>
<li>
<p>main包是特殊包：只有main包可以包含main()函数（程序入口），非main包不能有main()函数，只能被其他包导入使用。</p>
</li>
</ul>
<h4 data-id="heading-3">1.3 参考链接</h4>
<ul>
<li>
<p>Go官方文档（包的基础概念）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdoc%2Fcode%23Packages" target="_blank" title="https://go.dev/doc/code#Packages" ref="nofollow noopener noreferrer">Organizing code with packages</a></p>
</li>
<li>
<p>掘金优质文（包的核心用法）：<a href="https://juejin.cn/post/6844903902202802189" target="_blank" title="https://juejin.cn/post/6844903902202802189">Go 包（Package）详解：从基础到实战</a></p>
</li>
</ul>
<h3 data-id="heading-4">二、导入规则</h3>
<p>导入（import）是Go中使用其他包的核心方式，本质是“引入其他包的公开功能”，支持多种导入语法，适用于不同场景（如标准库导入、自定义包导入、第三方包导入）。核心规则：导入路径必须能唯一定位到目标包，且导入后需通过「包名.功能名」调用。</p>
<p>下面按“导入语法分类+场景示例”的方式讲解，贴合掘金“实用优先”风格，每个示例都极简可运行。</p>
<h4 data-id="heading-5">2.1 三种核心导入语法（表格梳理）</h4>






























<table><thead><tr><th><strong>语法类型</strong></th><th><strong>语法格式</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>直接导入</td><td>import "包路径"</td><td>最常用，导入单个包，通过包名直接调用功能（如标准库fmt、自定义包utils）</td></tr><tr><td>批量导入</td><td>import ( "包1路径" "包2路径" )</td><td>导入多个包，代码更简洁（推荐，符合Go代码规范）</td></tr><tr><td>别名导入</td><td>import 别名 "包路径"</td><td>解决包名冲突，或简化过长的包名（如将复杂包名简化为简短别名）</td></tr><tr><td>匿名导入</td><td>import _ "包路径"</td><td>只执行包的init()函数，不使用包内其他功能（如数据库驱动包，只需初始化注册）</td></tr></tbody></table>
<h4 data-id="heading-6">2.2 极简代码示例（分场景）</h4>
<h5 data-id="heading-7">示例1：直接导入+批量导入（最常用）</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>          <span class="hljs-comment">// 批量导入：标准库fmt包（打印功能）</span>
    <span class="hljs-string">"math/rand"</span>    <span class="hljs-comment">// 批量导入：标准库math/rand包（随机数功能）</span>
    <span class="hljs-string">"./utils"</span>      <span class="hljs-comment">// 批量导入：自定义包utils（前文创建的工具包）</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"随机数："</span>, rand.Intn(<span class="hljs-number">100</span>)) <span class="hljs-comment">// 标准库包调用：rand包的Intn函数</span>
    fmt.Println(<span class="hljs-string">"3的平方："</span>, utils.CalculateSquare(<span class="hljs-number">3</span>)) <span class="hljs-comment">// 自定义包调用</span>
}

</code></pre>
<h5 data-id="heading-8">示例2：别名导入（解决包名冲突）</h5>
<p>假设我们导入两个包，包名都叫util（冲突），此时用别名区分：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    u1 <span class="hljs-string">"./util1"</span>   <span class="hljs-comment">// 别名u1，对应util1包</span>
    u2 <span class="hljs-string">"./util2"</span>   <span class="hljs-comment">// 别名u2，对应util2包（两个包名都是util，通过别名区分）</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(u1.GetName()) <span class="hljs-comment">// 调用util1包的功能（别名u1）</span>
    fmt.Println(u2.GetName()) <span class="hljs-comment">// 调用util2包的功能（别名u2）</span>
}

</code></pre>
<h5 data-id="heading-9">示例3：匿名导入（初始化包，不使用功能）</h5>
<p>典型场景：导入MySQL驱动包，只需执行其init()函数完成注册，无需直接调用包内功能：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"database/sql"</span>
    _ <span class="hljs-string">"github.com/go-sql-driver/mysql"</span> <span class="hljs-comment">// 匿名导入：MySQL驱动包（只执行init）</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 无需调用驱动包的功能，只需初始化后，即可使用sql包操作MySQL</span>
    db, _ := sql.Open(<span class="hljs-string">"mysql"</span>, <span class="hljs-string">"user:pass@tcp(127.0.0.1:3306)/dbname"</span>)
    <span class="hljs-keyword">defer</span> db.Close()
}

</code></pre>
<h4 data-id="heading-10">2.3 导入路径的3种类型（重点）</h4>
<p>导入路径是导入规则的核心，必须能唯一定位到包，分为3种类型，对应不同场景：</p>
<ol>
<li>
<p><strong>标准库路径</strong>：直接写包名（如fmt、math、os），Go会自动从标准库目录中查找（无需手动配置路径）；</p>
</li>
<li>
<p><strong>相对路径</strong>：以「./」或「../」开头，对应当前项目内的自定义包（如./utils、../common），适用于项目内包的导入；</p>
</li>
<li>
<p><strong>绝对路径（Go Modules）</strong>：以模块名开头（如github.com/yourname/yourproject/utils），适用于第三方包或跨项目导入（后续Go Modules章节详细讲解）。</p>
</li>
</ol>
<h4 data-id="heading-11">2.4 常见误区（避坑重点）</h4>
<ul>
<li>
<p>导入路径错误：相对路径必须正确（比如当前文件在src目录，utils在src/utils，导入路径写./utils，不能漏写./）；</p>
</li>
<li>
<p>导入未使用：Go不允许导入包后不使用（编译报错），若确实需要导入（如匿名导入），用_别名；</p>
</li>
<li>
<p>循环导入：两个包互相导入（如a导入b，b导入a），会导致编译报错，这是大型项目常见坑，需通过“拆分公共包”解决。</p>
</li>
</ul>
<h4 data-id="heading-12">2.5 参考链接</h4>
<ul>
<li>Go官方文档（导入规则）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Import_declarations" target="_blank" title="https://go.dev/ref/spec#Import_declarations" ref="nofollow noopener noreferrer">Import declarations</a></li>
</ul>
<h3 data-id="heading-13">三、私有公有</h3>
<p>Go中没有专门的关键字（如public、private）来定义私有/公有，而是通过<strong>标识符首字母大小写</strong>来区分，这是Go简洁设计的体现，规则极其简单，记住一句话即可：<strong>首字母大写=公有（可被其他包导入使用），首字母小写=私有（只能在当前包内使用）</strong>。</p>
<p>适用范围：函数、变量、结构体、结构体字段、接口等所有标识符，均遵循此规则。</p>
<h4 data-id="heading-14">3.1 极简代码示例（清晰区分）</h4>
<p>先创建一个utils包，包含公有和私有标识符，观察其他包能否导入使用：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 目录：utils/common.go</span>
<span class="hljs-keyword">package</span> utils

<span class="hljs-comment">// 1. 公有函数（首字母大写）：可被其他包导入使用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PublicFunc</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"我是公有函数，可被外部调用"</span>
}

<span class="hljs-comment">// 2. 私有函数（首字母小写）：只能在utils包内使用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">privateFunc</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"我是私有函数，外部包无法调用"</span>
}

<span class="hljs-comment">// 3. 公有结构体（首字母大写）</span>
<span class="hljs-keyword">type</span> PublicStruct <span class="hljs-keyword">struct</span> {
    PublicField <span class="hljs-type">string</span> <span class="hljs-comment">// 公有字段（首字母大写）</span>
    privateField <span class="hljs-type">string</span> <span class="hljs-comment">// 私有字段（首字母小写）</span>
}

<span class="hljs-comment">// 4. 私有结构体（首字母小写）</span>
<span class="hljs-keyword">type</span> privateStruct <span class="hljs-keyword">struct</span> {
    Name <span class="hljs-type">string</span>
}

<span class="hljs-comment">// 5. 公有变量（首字母大写）</span>
<span class="hljs-keyword">var</span> PublicVar = <span class="hljs-string">"我是公有变量"</span>

<span class="hljs-comment">// 6. 私有变量（首字母小写）</span>
<span class="hljs-keyword">var</span> privateVar = <span class="hljs-string">"我是私有变量"</span>

</code></pre>
<p>在main包中导入utils包，测试能否使用这些标识符：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"./utils"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 调用公有函数：正常使用</span>
    fmt.Println(utils.PublicFunc())

    <span class="hljs-comment">// 2. 调用私有函数：编译报错（undefined: utils.privateFunc）</span>
    <span class="hljs-comment">// fmt.Println(utils.privateFunc())</span>

    <span class="hljs-comment">// 3. 使用公有结构体和公有字段：正常使用</span>
    obj := utils.PublicStruct{
        PublicField: <span class="hljs-string">"测试公有字段"</span>,
        <span class="hljs-comment">// privateField: "无法赋值", // 编译报错：私有字段，外部无法访问</span>
    }
    fmt.Println(obj.PublicField)

    <span class="hljs-comment">// 4. 使用私有结构体：编译报错（undefined: utils.privateStruct）</span>
    <span class="hljs-comment">// var p utils.privateStruct</span>

    <span class="hljs-comment">// 5. 使用公有变量：正常使用</span>
    fmt.Println(utils.PublicVar)

    <span class="hljs-comment">// 6. 使用私有变量：编译报错（undefined: utils.privateVar）</span>
    <span class="hljs-comment">// fmt.Println(utils.privateVar)</span>
}

</code></pre>
<h4 data-id="heading-15">3.2 核心补充（避坑重点）</h4>
<ul>
<li>
<p>私有标识符的作用域：仅当前包内，即使是同一个项目的其他包，也无法访问；</p>
</li>
<li>
<p>结构体字段的特殊性：即使结构体是公有的，其私有字段（首字母小写）也无法被外部包访问（如示例中PublicStruct的privateField）；</p>
</li>
<li>
<p>访问私有标识符的间接方式：若需让外部包使用包内私有功能，可通过公有函数封装（比如在utils包中写一个公有函数，调用内部私有函数，外部包调用这个公有函数即可）。</p>
</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// utils/common.go 补充：用公有函数封装私有功能</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetPrivateData</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> privateFunc() <span class="hljs-comment">// 公有函数内部调用私有函数</span>
}

<span class="hljs-comment">// main.go 中调用：正常使用</span>
fmt.Println(utils.GetPrivateData()) <span class="hljs-comment">// 输出：我是私有函数，外部包无法调用</span>

</code></pre>
<h4 data-id="heading-16">3.3 参考链接</h4>
<ul>
<li>Go官方文档（标识符可见性）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Exported_identifiers" target="_blank" title="https://go.dev/ref/spec#Exported_identifiers" ref="nofollow noopener noreferrer">Exported identifiers</a></li>
</ul>
<h3 data-id="heading-17">四、Go Modules</h3>
<p>Go Modules（简称mod）是Go 1.11推出、Go 1.16强制启用的<strong>模块化包管理工具</strong>，核心目标是解决早期GOPATH模式的痛点（依赖混乱、版本冲突、无法跨环境复用），目前是Golang大型项目的标准包管理方案。</p>
<p>核心定义：一个Go Modules就是一个“模块”，对应一个项目，包含项目的所有代码、依赖配置，模块通过「模块名」唯一标识，便于依赖管理和跨项目复用。</p>
<h4 data-id="heading-18">4.1 为什么需要Go Modules？（痛点对比）</h4>
<p>早期GOPATH模式的3大痛点，Go Modules全部解决，用表格对比更清晰：</p>

























<table><thead><tr><th><strong>痛点</strong></th><th><strong>GOPATH模式</strong></th><th><strong>Go Modules模式</strong></th></tr></thead><tbody><tr><td>项目路径限制</td><td>所有项目必须放在GOPATH/src目录下，极其不便</td><td>项目可放在任意目录，无路径限制</td></tr><tr><td>依赖管理</td><td>无版本控制，依赖全部放在GOPATH/pkg，不同项目依赖冲突</td><td>每个项目独立管理依赖，支持版本控制，依赖隔离</td></tr><tr><td>跨项目复用</td><td>自定义包只能在GOPATH内复用，跨环境需手动复制</td><td>通过模块名导入，支持远程仓库（GitHub、GitLab）复用</td></tr></tbody></table>
<h4 data-id="heading-19">4.2 核心命令（高频使用，极简记忆）</h4>
<p>Go Modules的使用全靠命令行，核心命令只有5个，掌握即可应对90%的场景，每个命令配简短说明：</p>



































<table><thead><tr><th><strong>命令</strong></th><th><strong>功能说明</strong></th><th><strong>常用场景</strong></th></tr></thead><tbody><tr><td>go mod init 模块名</td><td>初始化模块，生成go.mod文件（模块的核心配置文件）</td><td>新建项目时，首次执行（必须）</td></tr><tr><td>go mod tidy</td><td>自动梳理依赖：添加缺失的依赖、删除无用的依赖</td><td>导入新依赖后、删除依赖后，执行（最常用）</td></tr><tr><td>go mod download</td><td>手动下载go.mod中声明的所有依赖</td><td>跨环境部署时，快速下载依赖</td></tr><tr><td>go mod vendor</td><td>将依赖复制到项目的vendor目录（本地依赖备份）</td><td>无网络环境部署、依赖版本固定</td></tr><tr><td>go mod verify</td><td>验证依赖的完整性（是否被篡改）</td><td>怀疑依赖被修改时，执行校验</td></tr></tbody></table>
<h4 data-id="heading-20">4.3 极简实战示例（初始化模块）</h4>
<p>全程模拟新建一个Go Modules项目，步骤清晰，可直接跟着操作：</p>
<ol>
<li>
<p><strong>新建项目目录</strong>（任意路径，无需在GOPATH）：
<code>mkdir go-mod-demo &amp;&amp; cd go-mod-demo</code></p>
</li>
<li>
<p><strong>初始化模块</strong>（模块名建议用远程仓库地址，便于后续发布，本地测试可自定义）：
<code>go mod init github.com/yourname/go-mod-demo</code>执行后，项目目录下会生成<strong>go.mod文件</strong>（核心配置文件），内容如下（极简）：`module github.com/yourname/go-mod-demo # 模块名（唯一标识）</p>
</li>
</ol>
<p>go 1.21 # 当前项目使用的Go版本`</p>
<ol start="3">
<li><strong>编写代码，导入依赖</strong>（比如导入标准库fmt和第三方包gin）：
`// main.go
package main</li>
</ol>
<p>import (
"fmt"
"github.com/gin-gonic/gin" // 第三方依赖（gin框架）
)</p>
<p>func main() {
r := gin.Default()
r.GET("/", func(c *gin.Context) {
c.String(200, "Hello Go Modules!")
})
fmt.Println("服务启动：localhost:8080")
r.Run()
}`</p>
<ol start="4">
<li>
<p><strong>梳理依赖</strong>（自动下载缺失的gin依赖）：
<code>go mod tidy</code>执行后，会发生两个变化：</p>
<ul>
<li>
<p>go.mod文件会自动添加gin的依赖声明（后续依赖配置章节详细讲）；</p>
</li>
<li>
<p>生成<strong>go.sum文件</strong>（依赖校验文件，记录依赖的版本和哈希值，防止篡改）。</p>
</li>
</ul>
</li>
<li>
<p><strong>运行程序</strong>（正常执行，依赖已自动处理）：
<code>go run main.go</code></p>
</li>
</ol>
<h4 data-id="heading-21">4.4 关键补充（核心概念）</h4>
<ul>
<li>
<p>go.mod：模块的核心配置文件，记录模块名、Go版本、依赖包的名称和版本，是Go Modules的核心；</p>
</li>
<li>
<p>go.sum：依赖校验文件，无需手动修改，Go会自动维护，用于验证依赖的完整性；</p>
</li>
<li>
<p>依赖存储路径：Go Modules下载的依赖，默认存储在 $GOPATH/pkg/mod 目录下，多个项目可共享依赖（避免重复下载）。</p>
</li>
</ul>
<h4 data-id="heading-22">4.5 参考链接</h4>
<ul>
<li>Go官方文档（Go Modules详解）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fmod" target="_blank" title="https://go.dev/ref/mod" ref="nofollow noopener noreferrer">Go Modules Reference</a></li>
</ul>
<h3 data-id="heading-23">五、版本管理</h3>
<p>Go Modules的版本管理遵循<strong>语义化版本（Semantic Versioning，简称SemVer）</strong>，核心是“用版本号区分依赖的迭代，避免版本冲突”，版本号格式固定，且支持多种版本选择方式，适配不同场景（如固定版本、兼容版本、最新版本）。</p>
<h4 data-id="heading-24">5.1 语义化版本格式（必须记住）</h4>
<p>Go Modules强制要求依赖包遵循语义化版本，格式为：<strong>v主版本.次版本.修订版本</strong>（如v1.2.3），每个部分的含义如下：</p>
<ul>
<li>
<p>主版本（Major）：v1、v2... ，当API发生不兼容的重大变更时，主版本号加1（如v1→v2）；</p>
</li>
<li>
<p>次版本（Minor）：v1.2、v1.3... ，当新增功能但API兼容时，次版本号加1（如v1.2→v1.3）；</p>
</li>
<li>
<p>修订版本（Patch）：v1.2.3、v1.2.4... ，当修复bug但不新增功能、不修改API时，修订版本号加1（如v1.2.3→v1.2.4）。</p>
</li>
</ul>
<p>补充：预发布版本（如v1.2.3-beta.1）、开发版本（如v1.2.3-20240501123456-abcdef123456）也被支持，但生产环境优先使用正式版本。</p>
<h4 data-id="heading-25">5.2 版本选择方式（4种高频场景）</h4>
<p>在go.mod中声明依赖版本时，支持多种写法，对应不同的版本选择策略，用表格梳理（结合示例，易懂好记）：</p>






























<table><thead><tr><th><strong>选择方式</strong></th><th><strong>写法示例</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>固定版本</td><td>github.com/gin-gonic/gin v1.9.1</td><td>强制使用指定版本（v1.9.1），不自动升级，最稳定（生产环境推荐）</td></tr><tr><td>兼容版本</td><td>github.com/gin-gonic/gin v1.9.0+incompatible</td><td>使用兼容指定版本的最新版本（如v1.9.1、v1.9.2，不超过v2.0.0）</td></tr><tr><td>最新版本</td><td>github.com/gin-gonic/gin latest</td><td>自动使用该依赖的最新正式版本（不推荐生产环境，可能有兼容性问题）</td></tr><tr><td>主版本兼容</td><td>github.com/gin-gonic/gin v1</td><td>使用v1主版本下的最新版本（如v1.9.1，不升级到v2）</td></tr></tbody></table>
<h4 data-id="heading-26">5.3 极简代码示例（版本操作）</h4>
<h5 data-id="heading-27">示例1：手动指定固定版本</h5>
<p>在go.mod中手动添加依赖，指定固定版本（v1.9.1）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// go.mod</span>
module github.com/yourname/<span class="hljs-keyword">go</span>-mod-demo

<span class="hljs-keyword">go</span> <span class="hljs-number">1.21</span>

<span class="hljs-comment">// 手动指定gin版本为v1.9.1（固定版本）</span>
require github.com/gin-gonic/gin v1<span class="hljs-number">.9</span><span class="hljs-number">.1</span>
</code></pre>
<p>执行go mod tidy，会自动下载v1.9.1版本的gin，且不会自动升级。</p>
<h5 data-id="heading-28">示例2：升级/降级依赖版本</h5>
<p>通过go get命令升级或降级依赖版本，无需手动修改go.mod：</p>
<pre><code class="hljs language-bash" lang="bash">// 1. 升级gin到最新版本
go get github.com/gin-gonic/gin@latest

// 2. 升级gin到指定版本（v1.9.2）
go get github.com/gin-gonic/gin@v1.9.2

// 3. 降级gin到指定版本（v1.9.0）
go get github.com/gin-gonic/gin@v1.9.0
</code></pre>
<p>执行后，go.mod和go.sum会自动更新为对应版本。</p>
<h5 data-id="heading-29">示例3：主版本变更的注意事项</h5>
<p>当依赖包的主版本变更（如v1→v2），API可能不兼容，Go Modules要求导入路径必须包含主版本号（如v2），示例：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 导入gin的v2版本（主版本变更，导入路径需加/v2）</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gin-gonic/gin/v2"</span>

<span class="hljs-comment">// go.mod中对应的依赖声明</span>
require github.com/gin-gonic/gin/v2 v2<span class="hljs-number">.0</span><span class="hljs-number">.0</span>
</code></pre>
<h4 data-id="heading-30">5.4 常见误区（避坑重点）</h4>
<ul>
<li>
<p>版本号必须以v开头：如v1.2.3（正确），1.2.3（错误），Go Modules不识别非v开头的版本；</p>
</li>
<li>
<p>主版本变更即不兼容：v1和v2是两个不兼容的版本，导入路径需加/v2，否则会报错；</p>
</li>
<li>
<p>避免使用latest版本：生产环境中，latest版本可能随时更新，导致项目不稳定，优先使用固定版本。</p>
</li>
</ul>
<h4 data-id="heading-31">5.5 参考链接</h4>
<ul>
<li>Go官方文档（版本管理）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fmod%23versions" target="_blank" title="https://go.dev/ref/mod#versions" ref="nofollow noopener noreferrer">Module versions</a></li>
</ul>
<h3 data-id="heading-32">六、依赖配置</h3>
<p>依赖配置的核心是<strong>go.mod文件</strong>，所有依赖相关的配置（依赖声明、版本约束、替换依赖、排除依赖）都在该文件中定义，Go会自动维护大部分内容，手动修改时需遵循固定语法，本节讲解go.mod中最常用的配置项。</p>
<p>先看一个完整的go.mod示例（包含所有常用配置），再逐一拆解：</p>
<pre><code class="hljs language-go" lang="go">module github.com/yourname/<span class="hljs-keyword">go</span>-mod-demo # 模块名

<span class="hljs-keyword">go</span> <span class="hljs-number">1.21</span> # Go版本

# 直接依赖（手动添加或<span class="hljs-keyword">go</span> mod tidy自动添加）
require (
    github.com/gin-gonic/gin v1<span class="hljs-number">.9</span><span class="hljs-number">.1</span>
    github.com/<span class="hljs-keyword">go</span>-sql-driver/mysql v1<span class="hljs-number">.7</span><span class="hljs-number">.1</span>
)

# 替换依赖（将远程依赖替换为本地依赖，便于开发调试）
replace github.com/gin-gonic/gin =&gt; ../gin

# 排除依赖（排除某个依赖的特定版本）
exclude github.com/<span class="hljs-keyword">go</span>-sql-driver/mysql v1<span class="hljs-number">.7</span><span class="hljs-number">.0</span>
</code></pre>
<h4 data-id="heading-33">6.1 核心配置项（分点详解）</h4>
<h5 data-id="heading-34">6.1.1 module（模块名）</h5>
<p>格式：module 模块名，是模块的唯一标识，必须放在go.mod文件的第一行，用于导入该模块（如其他项目导入当前模块，需使用该模块名作为导入路径）。</p>
<p>示例：module github.com/yourname/go-mod-demo（推荐用远程仓库地址，便于后续发布）。</p>
<h5 data-id="heading-35">6.1.2 go（Go版本）</h5>
<p>格式：go 版本号，声明当前模块使用的Go版本，用于指定编译该模块所需的最低Go版本，Go会根据该版本启用对应的语言特性。</p>
<p>示例：go 1.21（表示当前模块需用Go 1.21及以上版本编译）。</p>
<h5 data-id="heading-36">6.1.3 require（依赖声明）</h5>
<p>格式：require 依赖包路径 版本号，核心配置项，用于声明项目所需的依赖包及其版本，支持单个声明和批量声明（用括号包裹）。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 单个依赖声明</span>
require github.com/gin-gonic/gin v1<span class="hljs-number">.9</span><span class="hljs-number">.1</span>

<span class="hljs-comment">// 批量依赖声明（推荐，简洁）</span>
require (
    github.com/gin-gonic/gin v1<span class="hljs-number">.9</span><span class="hljs-number">.1</span>
    github.com/<span class="hljs-keyword">go</span>-sql-driver/mysql v1<span class="hljs-number">.7</span><span class="hljs-number">.1</span>
)
</code></pre>
<h5 data-id="heading-37">6.1.4 replace（替换依赖）</h5>
<p>格式：replace 原依赖路径 =&gt; 替换后的路径，核心用于“开发调试”，将远程依赖（如GitHub上的包）替换为本地依赖（本地目录中的包），无需修改代码中的导入路径。</p>
<p>示例（将远程gin包替换为本地gin包）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 格式：replace 原依赖路径 =&gt; 本地依赖目录（相对路径或绝对路径）</span>
replace github.com/gin-gonic/gin =&gt; ../gin
</code></pre>
<p>注意：replace配置仅在本地开发有效，发布模块时，需删除replace配置（否则其他项目导入会报错）。</p>
<h5 data-id="heading-38">6.1.5 exclude（排除依赖）</h5>
<p>格式：exclude 依赖包路径 版本号，用于排除某个依赖的特定版本（如某个版本有bug，不希望项目使用该版本）。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 排除mysql包的v1.7.0版本（项目不会使用该版本）</span>
exclude github.com/<span class="hljs-keyword">go</span>-sql-driver/mysql v1<span class="hljs-number">.7</span><span class="hljs-number">.0</span>
</code></pre>
<h4 data-id="heading-39">6.2 极简实战示例（依赖配置调试）</h4>
<p>模拟本地开发时，替换远程依赖为本地依赖，步骤如下：</p>
<ol>
<li>
<p>本地有两个项目：go-mod-demo（主项目）、gin（本地gin源码，用于调试），目录结构如下：
<code>├── go-mod-demo # 主项目（Go Modules模块） │   ├── go.mod │   └── main.go └── gin # 本地gin源码（用于替换远程依赖）</code></p>
</li>
<li>
<p>在主项目的go.mod中添加replace配置：
<code>replace github.com/gin-gonic/gin =&gt; ../gin</code></p>
</li>
<li>
<p>主项目代码中，正常导入远程gin包：
<code>import "github.com/gin-gonic/gin"</code></p>
</li>
<li>
<p>执行go mod tidy，Go会自动使用本地gin包（而非远程包），便于调试本地修改的gin源码。</p>
</li>
</ol>
<h4 data-id="heading-40">6.3 常见误区（避坑重点）</h4>
<ul>
<li>
<p>手动修改go.mod需谨慎：go.mod的语法严格，手动修改时，避免写错依赖路径、版本号（否则go mod tidy会报错）；</p>
</li>
<li>
<p>replace配置不可发布：发布模块前，必须删除replace配置，否则其他项目无法正常导入你的模块；</p>
</li>
<li>
<p>exclude配置仅作用于直接依赖：exclude无法排除间接依赖（即依赖的依赖），如需排除间接依赖，需使用replace替换。</p>
</li>
</ul>
<h4 data-id="heading-41">6.4 参考链接</h4>
<ul>
<li>Go官方文档（go.mod配置）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fmod%23go-mod-file" target="_blank" title="https://go.dev/ref/mod#go-mod-file" ref="nofollow noopener noreferrer">The go.mod file</a></li>
</ul>
<h3 data-id="heading-42">七、模块发布</h3>
<p>模块发布的核心是“将你的Go Modules模块，发布到远程代码仓库（如GitHub、GitLab），供其他项目导入使用”，发布流程简单，核心是“遵循语义化版本+打标签”，全程无需额外工具，只需使用Git命令即可完成。</p>
<p>前提：已创建远程代码仓库（如GitHub仓库），且本地模块的module名与远程仓库地址一致（如module github.com/yourname/yourmodule）。</p>
<h4 data-id="heading-43">7.1 模块发布的5个步骤（极简实战）</h4>
<p>以GitHub为例，全程可直接跟着操作，步骤清晰：</p>
<ol>
<li>
<p><strong>检查模块配置</strong>（关键第一步）：</p>
<ul>
<li>
<p>确保go.mod中的module名，与GitHub仓库地址一致（如GitHub仓库地址是<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyourname%2Fmyutil%25EF%25BC%258Cmodule%25E5%2590%258D%25E5%25BF%2585%25E9%25A1%25BB%25E6%2598%25AFgithub.com%2Fyourname%2Fmyutil%25EF%25BC%2589%25EF%25BC%259B" target="_blank" title="https://github.com/yourname/myutil%EF%BC%8Cmodule%E5%90%8D%E5%BF%85%E9%A1%BB%E6%98%AFgithub.com/yourname/myutil%EF%BC%89%EF%BC%9B" ref="nofollow noopener noreferrer">github.com/yourname/my…</a></p>
</li>
<li>
<p>删除go.mod中的replace配置（若有），避免影响其他项目导入；</p>
</li>
<li>
<p>执行go mod tidy，确保依赖完整、无无用依赖。</p>
</li>
</ul>
</li>
<li>
<p><strong>初始化Git仓库（本地）</strong>：
`# 初始化Git仓库
git init</p>
</li>
</ol>
<h2 data-id="heading-44">添加所有文件</h2>
<p>git add .</p>
<h2 data-id="heading-45">提交代码（提交信息建议规范，如"feat: 完成utils包核心功能"）</h2>
<p>git commit -m "feat: init module, add CalculateSquare function"`</p>
<ol start="3">
<li>
<p><strong>关联远程GitHub仓库</strong>：
<code># 关联远程仓库（替换为你的GitHub仓库地址） git remote add origin https://github.com/yourname/myutil.git</code></p>
</li>
<li>
<p><strong>打版本标签（核心步骤）</strong>：
遵循语义化版本，打标签（标签名必须以v开头，如v1.0.0），标签是Go Modules识别版本的核心：`# 打标签（v1.0.0，首次发布建议用v1.0.0）
git tag v1.0.0</p>
</li>
</ol>
<h2 data-id="heading-46">查看标签</h2>
<p>git tag`</p>
<ol start="5">
<li><strong>推送代码和标签到远程仓库</strong>：
`# 推送代码到远程master/main分支
git push origin master</li>
</ol>
<h2 data-id="heading-47">推送标签到远程（必须推送标签，否则其他项目无法获取版本）</h2>
<p>git push origin v1.0.0`</p>
<p>推送完成后，你的模块就发布成功了！其他项目可通过go get命令导入使用：</p>
<pre><code class="hljs language-bash" lang="bash">go get github.com/yourname/myutil@v1.0.0
</code></pre>
<h4 data-id="heading-48">7.2 版本更新（发布新版本）</h4>
<p>当模块功能迭代后，发布新版本只需两步：</p>
<ol>
<li>
<p>修改代码、提交代码（Git commit）；</p>
</li>
<li>
<p>打新的版本标签，推送标签到远程：
`# 迭代版本（如v1.0.1，修复bug）
git tag v1.0.1
git push origin v1.0.1</p>
</li>
</ol>
<h2 data-id="heading-49">若有重大变更，升级主版本（如v2.0.0）</h2>
<p>git tag v2.0.0
git push origin v2.0.0`</p>
<h4 data-id="heading-50">7.3 关键注意事项</h4>
<ul>
<li>
<p>标签必须以v开头：如v1.0.0（正确），1.0.0（错误），Go Modules无法识别非v开头的标签；</p>
</li>
<li>
<p>module名必须与远程仓库地址一致：否则其他项目go get会失败（无法定位模块）；</p>
</li>
<li>
<p>版本标签不可删除/修改：一旦推送标签到远程，不建议删除或修改（会导致依赖该版本的项目报错），如需回滚，可打新的版本标签。</p>
</li>
</ul>
<h4 data-id="heading-51">7.4 参考链接</h4>
<ul>
<li>Go官方文档（模块发布）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdoc%2Fmodules%2Fpublishing" target="_blank" title="https://go.dev/doc/modules/publishing" ref="nofollow noopener noreferrer">Publishing a module</a></li>
</ul>
<h3 data-id="heading-52">八、项目结构</h3>
<p>大型Golang项目的结构设计，核心是“按功能分层、职责单一”，遵循“高内聚、低耦合”的原则，便于多人协作、后期维护和扩展。Go没有强制的项目结构规范，但行业内有成熟的标准结构（适配大部分后端项目），本节给出通用结构示例，并拆解各目录的作用。</p>
<p>提示：以下结构适用于「大型后端项目」（如API服务、微服务），小型项目可简化（如只保留main.go和必要的包）。</p>
<h4 data-id="heading-53">8.1 大型Golang项目标准结构（目录树示例）</h4>
<pre><code class="hljs language-bash" lang="bash">your-project/                  <span class="hljs-comment"># 项目根目录（Go Modules模块，执行go mod init的目录）</span>
├── go.mod                     <span class="hljs-comment"># Go Modules核心配置文件（声明模块名、Go版本、依赖）</span>
├── go.sum                     <span class="hljs-comment"># 依赖校验文件（自动生成，记录依赖版本和哈希值，防篡改）</span>
├── main.go                    <span class="hljs-comment"># 简易程序入口（单可执行程序项目用，多可执行程序建议放cmd目录）</span>
├── cmd/                       <span class="hljs-comment"># 可执行程序目录（核心！多可执行程序分离存放，避免入口混乱）</span>
│   └── api/                   <span class="hljs-comment"># API服务可执行程序（后端核心服务入口）</span>
│       └── main.go            <span class="hljs-comment"># API服务入口（初始化路由、配置、依赖，启动服务）</span>
│   └── cli/                   <span class="hljs-comment"># 命令行工具入口（可选，如数据迁移、脚本执行等离线工具）</span>
│       └── main.go            <span class="hljs-comment"># CLI工具入口（处理命令行参数，执行对应离线逻辑）</span>
├── internal/                  <span class="hljs-comment"># 内部包（核心！只能被当前项目导入，外部项目无法访问，隔离内部逻辑）</span>
│   ├── service/               <span class="hljs-comment"># 业务逻辑层（核心业务处理，承上启下）</span>
│   │   ├── user_service.go    <span class="hljs-comment"># 用户相关业务（注册、登录、查询等核心逻辑）</span>
│   │   └── order_service.go   <span class="hljs-comment"># 订单相关业务（创建订单、支付回调、订单查询等）</span>
│   ├── dao/                   <span class="hljs-comment"># 数据访问层（与数据库、缓存交互，封装数据操作）</span>
│   │   ├── user_dao.go        <span class="hljs-comment"># 用户数据操作（查询用户、新增用户、更新用户信息）</span>
│   │   ├── order_dao.go       <span class="hljs-comment"># 订单数据操作（订单入库、状态更新、关联查询）</span>
│   │   └── db/                <span class="hljs-comment"># 数据库连接封装（初始化MySQL、Redis，提供连接池）</span>
│   ├── model/                 <span class="hljs-comment"># 数据模型层（结构体定义，与数据库表、接口参数对应）</span>
│   │   ├── user.go            <span class="hljs-comment"># 用户模型（与user表字段对应，包含结构体标签）</span>
│   │   ├── order.go           <span class="hljs-comment"># 订单模型（与order表字段对应，关联用户、商品模型）</span>
│   │   └── request.go         <span class="hljs-comment"># 接口请求模型（接收前端传入的参数，做参数校验）</span>
│   ├── router/                <span class="hljs-comment"># 路由层（API接口路由定义，关联路由与业务逻辑）</span>
│   │   ├── router.go          <span class="hljs-comment"># 路由初始化（注册所有接口路由，配置中间件）</span>
│   │   ├── user_router.go     <span class="hljs-comment"># 用户相关路由（/api/user/login、/api/user/info等）</span>
│   │   └── order_router.go    <span class="hljs-comment"># 订单相关路由（/api/order/create、/api/order/detail等）</span>
│   └── middleware/            <span class="hljs-comment"># 中间件层（拦截请求，处理通用逻辑）</span>
│       ├── auth.go            <span class="hljs-comment"># 权限校验中间件（验证Token、接口访问权限）</span>
│       ├── logger.go          <span class="hljs-comment"># 日志中间件（记录请求参数、响应结果、访问耗时）</span>
│       └── recover.go         <span class="hljs-comment"># 异常捕获中间件（捕获接口panic，返回统一错误信息）</span>
├── pkg/                       <span class="hljs-comment"># 公共包（可被外部项目导入复用，封装通用、无业务关联的功能）</span>
│   ├── utils/                 <span class="hljs-comment"># 工具包（通用工具函数，无业务依赖）</span>
│   │   ├── crypto.go          <span class="hljs-comment"># 加密解密（MD5、SHA256、AES等通用加密逻辑）</span>
│   │   ├── validator.go       <span class="hljs-comment"># 参数校验（通用校验规则，如手机号、邮箱、必填项校验）</span>
│   │   └── time.go            <span class="hljs-comment"># 时间工具（时间格式化、时间差计算等）</span>
│   ├── config/                <span class="hljs-comment"># 配置包（读取配置文件，提供全局配置访问）</span>
│   │   ├── config.go          <span class="hljs-comment"># 配置初始化（读取yaml/env配置，解析到结构体）</span>
│   │   └── config.yaml        <span class="hljs-comment"># 配置文件（存放MySQL、Redis、端口等配置信息）</span>
│   └── logger/                <span class="hljs-comment"># 日志包（封装日志打印、存储，全局复用）</span>
│       └── logger.go          <span class="hljs-comment"># 日志初始化（配置日志级别、输出路径、滚动策略）</span>
├── api/                       <span class="hljs-comment"># API接口定义（规范接口，便于前后端协作、跨服务调用）</span>
│   ├── api.pb                 <span class="hljs-comment"># Protobuf接口定义（微服务场景用，定义接口参数和返回值）</span>
│   └── swagger/               <span class="hljs-comment"># Swagger接口文档（自动生成，提供接口调试、文档查阅）</span>
├── assets/                    <span class="hljs-comment"># 静态资源目录（存放静态文件，可选）</span>
│   ├── html/                  <span class="hljs-comment"># 静态HTML文件（如后台管理页面静态页面）</span>
│   └── static/                <span class="hljs-comment"># 静态资源（CSS、JS、图片等）</span>
├── docs/                      <span class="hljs-comment"># 项目文档目录（存放项目相关文档，便于维护）</span>
│   ├── 架构设计.md            <span class="hljs-comment"># 项目架构设计文档（分层说明、模块交互逻辑）</span>
│   ├── 接口文档.md            <span class="hljs-comment"># 接口文档（非Swagger场景，手动维护接口说明）</span>
│   └── 部署文档.md            <span class="hljs-comment"># 部署文档（服务器配置、部署步骤、启停脚本）</span>
├── scripts/                   <span class="hljs-comment"># 脚本目录（存放部署、迁移等脚本，简化操作）</span>
│   ├── deploy.sh              <span class="hljs-comment"># 部署脚本（一键部署服务、重启服务）</span>
│   └── migrate.sh             <span class="hljs-comment"># 数据迁移脚本（数据库表创建、数据初始化）</span>
├── <span class="hljs-built_in">test</span>/                      <span class="hljs-comment"># 测试目录（存放单元测试、集成测试代码，规范测试）</span>
│   ├── internal/              <span class="hljs-comment"># 内部包测试（service、dao等层的单元测试）</span>
│   │   ├── service_test.go    <span class="hljs-comment"># 业务逻辑测试（模拟请求，验证业务逻辑正确性）</span>
│   │   └── dao_test.go        <span class="hljs-comment"># 数据访问测试（测试数据库操作正确性）</span>
│   └── pkg/                   <span class="hljs-comment"># 公共包测试（utils、config等包的单元测试）</span>
└── .gitignore                 <span class="hljs-comment"># Git忽略文件（指定无需提交到Git的文件/目录，如编译产物、日志）</span>
</code></pre>
<h4 data-id="heading-54">8.2 核心目录职责拆解（避坑重点）</h4>
<p>结合前文包管理、私有公有、Go Modules知识，重点拆解高频目录的核心作用，帮你理解“为什么这么设计”，避免踩结构混乱的坑：</p>
<ul>
<li>
<p><strong>cmd/</strong>：核心是“分离可执行程序入口”，比如后端API服务和离线数据迁移工具，分开放在cmd/api和cmd/cli下，各自有独立的main()函数，避免所有入口混在根目录main.go，后期维护困难。注意：cmd下的包可导入internal和pkg包，属于程序入口层。</p>
</li>
<li>
<p><strong>internal/</strong>：Go语言原生支持的“内部包”，其下的所有包只能被当前项目（your-project）导入，外部项目即使导入你的模块，也无法访问internal下的内容——这是隔离内部业务逻辑的关键，避免外部依赖你的内部实现，导致后期重构困难（贴合前文“私有公有”思想，相当于项目级别的“私有包”）。</p>
</li>
<li>
<p><strong>pkg/</strong>：与internal相反，是“公共包”，封装的是无业务依赖、可复用的功能（如工具函数、配置读取），可被外部项目导入复用。注意：pkg下的包必须遵循“公有标识符可访问”原则（首字母大写），内部不包含任何业务逻辑，确保通用性。</p>
</li>
<li>
<p><strong>model/</strong>：统一存放所有数据模型，避免模型分散在各个包中，导致结构体重复定义。模型分为三类：数据库模型（与表对应）、请求模型（接收前端参数）、响应模型（返回给前端数据），三者分离，便于参数校验和维护。</p>
</li>
<li>
<p><strong>service/ + dao/</strong>：分层设计的核心，遵循“单一职责”：dao层只负责数据操作（与MySQL、Redis交互），不处理任何业务逻辑；service层调用dao层，处理核心业务逻辑（如用户注册时，先校验参数，再调用dao新增用户，最后返回结果），避免业务逻辑与数据操作耦合，便于后期修改（如替换数据库时，只需修改dao层，不影响service层）。</p>
</li>
</ul>
<h4 data-id="heading-55">8.3 结构设计技巧（贴合模块化开发）</h4>
<ol>
<li>小型项目简化：如果是单可执行程序（如简单API服务），可删除cmd/目录，将main.go放在根目录，同时简化internal/目录（只保留service、dao、model核心子包）；</li>
<li>微服务适配：如果是微服务项目，可在api/目录下用Protobuf定义接口，同时新增rpc/目录，存放微服务间调用的客户端和服务端代码；</li>
<li>依赖隔离：internal/下的包可相互导入（如service导入dao、model），但尽量避免循环导入（前文导入规则的避坑点）；pkg/下的包不依赖internal/下的包（确保pkg的通用性）；</li>
<li>可扩展性：每个目录的职责单一，新增功能时，只需在对应目录下新增文件（如新增商品业务，在internal/service下新增goods_service.go，在internal/dao下新增goods_dao.go），不影响其他目录。</li>
</ol>
<h4 data-id="heading-56">8.4 参考链接</h4>
<p>Go官方文档（项目结构建议）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdoc%2Fcode%23Organization" target="_blank" title="https://go.dev/doc/code#Organization" ref="nofollow noopener noreferrer">Code organization</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React扩展]]></title>    <link>https://juejin.cn/post/7603587738159923263</link>    <guid>https://juejin.cn/post/7603587738159923263</guid>    <pubDate>2026-02-06T10:14:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603587738159923263" data-draft-id="7598947628467372078" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React扩展"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-06T10:14:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端马国成"/> <meta itemprop="url" content="https://juejin.cn/user/4471082537196452"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React扩展
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4471082537196452/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端马国成
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T10:14:48.000Z" title="Fri Feb 06 2026 10:14:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">CSS</h4>
<p>styled-components: yarn add styled-components</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// props透传</span>
<span class="hljs-comment">// attrs的使用</span>
<span class="hljs-comment">// 传入state作为props属性</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">StyledInput</span> = styled.<span class="hljs-property">input</span>.<span class="hljs-title function_">attrs</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'password'</span>,
  <span class="hljs-attr">placeholder</span>:<span class="hljs-string">'请输入'</span>,
  <span class="hljs-attr">bgColor</span>:<span class="hljs-string">'#000'</span>
})<span class="hljs-string">`
  color: <span class="hljs-subst">${props =&gt; props.color}</span>;
  background-color: <span class="hljs-subst">${props =&gt; props.bgColor}</span>;
`</span>

<span class="hljs-comment">// 继承</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">StyledInput2</span> = <span class="hljs-title function_">styled</span>(<span class="hljs-title class_">StyledInput</span>)<span class="hljs-string">`
  margin-top: 20px;
  padding: 10px;
`</span>
</code></pre>
<h4 data-id="heading-1">动画</h4>
<pre><code class="hljs language-js" lang="js">npm install react-transition-group --save

&lt;<span class="hljs-title class_">CSSTransition</span>
    nodeRef={<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeRef</span>}
    <span class="hljs-keyword">in</span>={<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">show</span>}
    timeout={<span class="hljs-number">500</span>}
    classNames=<span class="hljs-string">"fade"</span>
    unmountOnExit
    appear
&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.nodeRef}</span>&gt;</span>CSS Transition<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">CSSTransition</span>&gt;

.<span class="hljs-property">fade</span>-enter, .<span class="hljs-property">fade</span>-appear{
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>;
}

.<span class="hljs-property">fade</span>-enter-active, .<span class="hljs-property">fade</span>-appear-active{
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attr">transition</span>: opacity 500ms ease-<span class="hljs-keyword">in</span>-out;
}

.<span class="hljs-property">fade</span>-enter-done, .<span class="hljs-property">fade</span>-appear-done{
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span>;
}
.<span class="hljs-property">fade</span>-exit{
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span>;
}


.<span class="hljs-property">fade</span>-exit-active{
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attr">transition</span>: opacity 500ms ease-<span class="hljs-keyword">in</span>-out;
}

.<span class="hljs-property">fade</span>-exit-done{
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-2">Redux</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">import</span> { createStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux'</span>
<span class="hljs-keyword">import</span> reducer <span class="hljs-keyword">from</span> <span class="hljs-string">'./reducer'</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>(reducer)
store.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(store.<span class="hljs-title function_">getState</span>())
})
store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">addAction</span>(<span class="hljs-number">1</span>))
store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">subAction</span>(<span class="hljs-number">10</span>))

<span class="hljs-comment">// action.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">addAction</span>= (<span class="hljs-params">num</span>) =&gt; ({
  <span class="hljs-attr">type</span>: <span class="hljs-variable constant_">ADD_NUMBER</span>,
  num
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">subAction</span>= (<span class="hljs-params">num</span>) =&gt; ({
  <span class="hljs-attr">type</span>: <span class="hljs-variable constant_">SUB_NUMBER</span>,
  num
})

<span class="hljs-comment">// reducer.js</span>
<span class="hljs-keyword">const</span> defaultlState = {
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state = defaultlState, action</span>) {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-attr">ADD_NUMBER</span>:
      <span class="hljs-keyword">return</span> {
        ...state,
        <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + action.<span class="hljs-property">num</span>,
      } 
    <span class="hljs-keyword">case</span> <span class="hljs-attr">SUB_NUMBER</span>:
      <span class="hljs-keyword">return</span> {
        ...state,
        <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - action.<span class="hljs-property">num</span>,
      } 
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state
  }
}


<span class="hljs-comment">// 加入connect</span>
<span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">import</span> { createStore, applyMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux'</span>
**<span class="hljs-keyword">import</span> { thunk } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux-thunk'</span>**
<span class="hljs-keyword">import</span> reducer <span class="hljs-keyword">from</span> <span class="hljs-string">'./reducer'</span>

<span class="hljs-keyword">const</span> storeEnhancer = <span class="hljs-title function_">applyMiddleware</span>(thunk)

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>(reducer, storeEnhancer)    

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store

<span class="hljs-comment">// reducer.js</span>
<span class="hljs-keyword">import</span> { createStore, applyMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux'</span>
<span class="hljs-keyword">import</span> { thunk } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux-thunk'</span>
<span class="hljs-keyword">import</span> reducer <span class="hljs-keyword">from</span> <span class="hljs-string">'./reducer'</span>

<span class="hljs-keyword">const</span> storeEnhancer = <span class="hljs-title function_">applyMiddleware</span>(thunk)

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>(reducer, storeEnhancer)    

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store

<span class="hljs-comment">// actionCreator.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">ADD_NUMBER</span>, <span class="hljs-variable constant_">SUB_NUMBER</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./constans'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">addAction</span>= (<span class="hljs-params">num</span>) =&gt; ({
  <span class="hljs-attr">type</span>: <span class="hljs-variable constant_">ADD_NUMBER</span>,
  num
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">subAction</span>= (<span class="hljs-params">num</span>) =&gt; ({
  <span class="hljs-attr">type</span>: <span class="hljs-variable constant_">SUB_NUMBER</span>,
  num
})

**<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getBannerList</span> = (<span class="hljs-params">dispatch</span>) =&gt; (
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'getBannerList'</span>)
)**

<span class="hljs-comment">// connect.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PureComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'../store'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params">mapStateToProps, mapDispatchToProps</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">Component</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectedComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PureComponent</span> {
      <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
        <span class="hljs-variable language_">super</span>(props)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {
            <span class="hljs-attr">storeState</span>: <span class="hljs-title function_">mapStateToProps</span>(store.<span class="hljs-title function_">getState</span>()),
        }
      }
      <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">unsubscribe</span> = store.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({
            <span class="hljs-attr">storeState</span>: <span class="hljs-title function_">mapStateToProps</span>(store.<span class="hljs-title function_">getState</span>()),
          })
        })
      }
      <span class="hljs-title function_">componentWillUnmount</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unsubscribe</span>()
      }
      <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> (
          <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span>
            {<span class="hljs-attr">...this.props</span>}
            {<span class="hljs-attr">...this.state.storeState</span>}
            {<span class="hljs-attr">...mapDispatchToProps</span>(<span class="hljs-attr">store.dispatch</span>)}
          /&gt;</span></span>
        );
      }
    };
  };
}
<span class="hljs-comment">// home.js</span>
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/connect'</span>
<span class="hljs-keyword">import</span> { addAction, subAction, getBannerList } <span class="hljs-keyword">from</span> <span class="hljs-string">'../store/actionCreator'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">mapStateToProps</span> = (<span class="hljs-params">state</span>) =&gt; ({
  <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">mapDispatchToProps</span> = (<span class="hljs-params">dispatch</span>) =&gt; ({
  <span class="hljs-attr">addAction</span>: <span class="hljs-function">(<span class="hljs-params">num</span>) =&gt;</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">addAction</span>(num)),
  <span class="hljs-attr">subAction</span>: <span class="hljs-function">(<span class="hljs-params">num</span>) =&gt;</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">subAction</span>(num)),
  <span class="hljs-attr">getBannerList</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>(getBannerList)
})

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Home2</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>HOME<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>当前计数:{props.count}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> props.addAction(1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> props.subAction(1)}&gt;-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> props.getBannerList()}&gt;获取轮播图<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    ) 
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">connect</span>(mapStateToProps, mapDispatchToProps)(<span class="hljs-title class_">Home2</span>)
</code></pre>
<h4 data-id="heading-3">router</h4>
<pre><code class="hljs language-js" lang="js">npm install react-router-dom
<span class="hljs-title class_">BrowserRouter</span>: history模式
<span class="hljs-title class_">HashRouter</span>: hash模式

&lt;<span class="hljs-title class_">BrowserRouter</span>&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/a"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>关于<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/a"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>} /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">About</span> /&gt;</span>} /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">BrowserRouter</span>&gt;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Routes</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useRoutes</span>([    
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">'/home'</span>,
        <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Home</span> /&gt;</span></span>
      },
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>,
        <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">About</span> /&gt;</span></span>,
        <span class="hljs-attr">children</span>: [
          {
            <span class="hljs-attr">path</span>: <span class="hljs-string">'history'</span>,
            <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AboutHistory</span> /&gt;</span></span>
          },
          {
            <span class="hljs-attr">path</span>: <span class="hljs-string">'school'</span>,
            <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AboutSchool</span> /&gt;</span></span>
          },
          {
            <span class="hljs-attr">path</span>: <span class="hljs-string">'company'</span>,
            <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AboutCompany</span> /&gt;</span></span>
          }
        ]
      }
])}
</code></pre>
<h4 data-id="heading-4">Hooks</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span>组件比函数式组件的优势（没有hooks的时候）
    <span class="hljs-number">1.</span><span class="hljs-keyword">class</span>组件可以定义自己的state，用来保存组件自己内部的状态
      函数式组件不可以，因为函数每次调用都会产生新的临时变量
    <span class="hljs-number">2.</span><span class="hljs-keyword">class</span>组件有自己的生命周期，比如在componentDidMounted中发送网络请求，
      并且在生命周期函数只会执行一次
      在函数中发送网络请求，意味着每次重新渲染都会重新发送一次网络请求
    <span class="hljs-number">3.</span><span class="hljs-keyword">class</span>组件可以在状态改变时只会重新执行rendr函数以及生命周期componentDidUpdate
      函数式组件在重新渲染时，整个函数都会被执行
      
useState
本身是一个函数，来自react包
参数和返回值
    <span class="hljs-number">1.</span>参数：给创建出来的状态一个默认值
    <span class="hljs-number">2.</span>返回值：数组，元素<span class="hljs-number">1</span>：当前state的状态值，元素<span class="hljs-number">2</span>是更新状态的函数
只能在函数最外层调用<span class="hljs-title class_">Hook</span>，不要在循环，条件判断或者子函数中使用
只能在react的函数组件中调用hook，不能在其他js函数中调用

useCallback
<span class="hljs-comment">// memo 用于包裹函数组件，使其在 props 未发生变化时跳过重新渲染，从而提升性能。</span>
<span class="hljs-comment">// 父组件重新渲染，子组件也会重新渲染，但是如果子组件被 memo 包裹，且 props 未发生变化，那么子组件就不会重新渲染。</span>
<span class="hljs-comment">// HYBButton1的increment函数会重新创建，所以memo包裹的props发生变化，会重新渲染</span>
<span class="hljs-comment">// HYBButton2的increment函数不会重新创建，所以memo包裹的props没有发生变化，不会重新渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HYBButton</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{title, increment}</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'重新渲染'</span>, title)
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{increment}</span>&gt;</span>
      +1
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  )
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Callback</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> [isShow, setIsShow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick1</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>)
  }

  <span class="hljs-keyword">const</span> handleClick2 = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">222</span>)
  },[count])

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前显示状态: {isShow ? '显示' : '隐藏'}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">HYBButton</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"增加1"</span> <span class="hljs-attr">increment</span>=<span class="hljs-string">{handleClick1}</span>  /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">HYBButton</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"增加2"</span> <span class="hljs-attr">increment</span>=<span class="hljs-string">{handleClick2}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsShow(!isShow)}&gt;显示/隐藏<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

useContext
<span class="hljs-title class_">App</span>.<span class="hljs-property">js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title function_">createContext</span>()
&lt;<span class="hljs-title class_">React</span>.<span class="hljs-property">StrictMode</span>&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{name:</span> '<span class="hljs-attr">张三</span>', <span class="hljs-attr">age:</span> <span class="hljs-attr">18</span>}}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MemoDemo</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">UserContext.Provider</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">React</span>.<span class="hljs-property">StrictMode</span>&gt;

index.<span class="hljs-property">js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../index'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">User</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>)
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前用户: {user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前用户年龄: {user.age}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

useMemo
<span class="hljs-keyword">import</span> { useState,useMemo,memo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calcNum</span>(<span class="hljs-params">count</span>){
    <span class="hljs-keyword">let</span> total = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        total += i
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'total'</span>,total)
    }
    <span class="hljs-keyword">return</span> total
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">HYUser</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">HYUser</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">const</span> {name, age} = props
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'HYUser'</span>, name, age)
  <span class="hljs-keyword">return</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前用户: {name}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前年龄: {age}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MemoDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> [isShow, setIsShow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>)
<span class="hljs-comment">//   let total = 0</span>
<span class="hljs-comment">//   for(let i = 0; i &lt; count; i++) {</span>
<span class="hljs-comment">//     // 切换show每次都会执行for循环</span>
<span class="hljs-comment">//     total += i</span>
<span class="hljs-comment">//   }</span>
  <span class="hljs-keyword">const</span> total = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">calcNum</span>(count), [count])
  <span class="hljs-keyword">const</span> info = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({<span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}), []) <span class="hljs-comment">// 依赖项为空数组，只在组件挂载时执行一次</span>
<span class="hljs-comment">//const info = {name: '张三', age: 18} 每次重新渲染都创建一个新对象，会导致HYUser组件重新渲染</span>

  <span class="hljs-keyword">return</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前显示状态: {isShow ? '显示' : '隐藏'}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前total: {total}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">HYUser</span> <span class="hljs-attr">info</span>=<span class="hljs-string">{info}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsShow(!isShow)}&gt;切换显示状态<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
- useMemo ：缓存值 ，用于优化复杂计算
- useCallback ：缓存函数 ，用于优化子组件渲染
- useCallback 是 useMemo 的特例 ： <span class="hljs-title function_">useCallback</span>(fn, deps) 等价于 <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> fn, deps)

useReducer
<span class="hljs-keyword">import</span> { useReducer } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state, action</span>) {
  <span class="hljs-keyword">switch</span>(action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'increment'</span>:
      <span class="hljs-keyword">return</span> {<span class="hljs-attr">counter</span>: state.<span class="hljs-property">counter</span> + action.<span class="hljs-property">payload</span>}
    <span class="hljs-keyword">case</span> <span class="hljs-string">'decrement'</span>:
      <span class="hljs-keyword">return</span> {<span class="hljs-attr">counter</span>: state.<span class="hljs-property">counter</span> - action.<span class="hljs-property">payload</span>}
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">User</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, {<span class="hljs-attr">counter</span>: <span class="hljs-number">0</span>})
  <span class="hljs-keyword">return</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前状态: {state.counter}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({type: 'increment', payload: 1})}&gt;增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({type: 'decrement', payload: 1})}&gt;减少<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

useLayoutEffect
useEffect会在渲染的内容更新到<span class="hljs-variable constant_">DOM</span>上后执行，不会阻塞<span class="hljs-variable constant_">DOM</span>的更新
useLayoutEffect会在渲染的内容更新到<span class="hljs-variable constant_">DOM</span>上之前执行，会阻塞<span class="hljs-variable constant_">DOM</span>的更新
如果我们希望在某些操作发生之后再更新<span class="hljs-variable constant_">DOM</span>，那么应该将这个操作放到useLayoutEffect

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenClaw集成钉钉机器人应用配置]]></title>    <link>https://juejin.cn/post/7603556326815907892</link>    <guid>https://juejin.cn/post/7603556326815907892</guid>    <pubDate>2026-02-06T10:18:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603556326815907892" data-draft-id="7603383311531016207" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenClaw集成钉钉机器人应用配置"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-02-06T10:18:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="玹外之音"/> <meta itemprop="url" content="https://juejin.cn/user/2666763911448411"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenClaw集成钉钉机器人应用配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2666763911448411/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    玹外之音
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T10:18:48.000Z" title="Fri Feb 06 2026 10:18:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">钉钉机器人应用配置与OpenClaw集成指南</h2>
<p>本指南将帮助您完成钉钉机器人应用的创建、配置以及与 OpenClaw 的集成。</p>
<hr/>
<h3 data-id="heading-1">目录</h3>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E9%92%89%E9%92%89%E5%BA%94%E7%94%A8" title="#%E5%88%9B%E5%BB%BA%E9%92%89%E9%92%89%E5%BA%94%E7%94%A8">创建钉钉应用</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9" title="#%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9">配置选项</a></li>
<li><a href="#%E9%85%8D%E7%BD%AEopenclaw" title="#%E9%85%8D%E7%BD%AEopenclaw">配置OpenClaw</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">所需凭证</h3>
<ul>
<li>Client ID</li>
<li>Client Secret</li>
<li>Robot Code</li>
<li>Corp ID</li>
<li>Agent ID</li>
<li>卡片模板 ID</li>
</ul>
<hr/>
<h3 data-id="heading-3">相关链接</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen-dev.dingtalk.com" target="_blank" title="https://open-dev.dingtalk.com" ref="nofollow noopener noreferrer">钉钉开发者后台</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen-dev.dingtalk.com%2Ffe%2Fcard" target="_blank" title="https://open-dev.dingtalk.com/fe/card" ref="nofollow noopener noreferrer">钉钉卡片平台</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsoimy%2Fopenclaw-channel-dingtalk" target="_blank" title="https://github.com/soimy/openclaw-channel-dingtalk" ref="nofollow noopener noreferrer">插件GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.32zi.com" target="_blank" title="https://ai.32zi.com" ref="nofollow noopener noreferrer">AI API 聚合平台</a></li>
</ul>
<hr/>
<h3 data-id="heading-4">注意事项</h3>
<ul>
<li>必须加入组织才能使用钉钉开发者后台</li>
<li>发布应用前需填写版本详情</li>
<li>手动安装插件后需执行npm install</li>
<li>配置文件中需要填写正确的凭证信息</li>
</ul>
<hr/>
<h3 data-id="heading-5">创建钉钉应用</h3>
<h4 data-id="heading-6">步骤 1：打开钉钉开发者后台</h4>
<p>访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen-dev.dingtalk.com" target="_blank" title="https://open-dev.dingtalk.com" ref="nofollow noopener noreferrer">open-dev.dingtalk.com</a></p>
<blockquote>
<p><strong>注意</strong>：必须加入组织才能使用钉钉开发者后台。</p>
</blockquote>
<h4 data-id="heading-7">步骤 2：创建应用</h4>
<p>找到 <strong>应用开发</strong> → <strong>钉钉应用</strong> → <strong>创建应用</strong> → 填写相关信息</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/564d8c2c05af4f90845e39021092e493~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=M1gSlGg%2B7JQfmMyJk9AdiEYWrPE%3D" alt="屏幕截图 2026-02-06 092539.png" loading="lazy"/></p>
<h4 data-id="heading-8">步骤 3：添加机器人能力</h4>
<p>创建应用成功之后会自动打开新的标签页，在"添加应用能力"选择<strong>机器人</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db81bcae1ba44a08a5bae5a67be983ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=6oVxso2PmqjxPz2Iq0LSlhAtAHc%3D" alt="屏幕截图 2026-02-06 092819.png" loading="lazy"/></p>
<h4 data-id="heading-9">步骤 4：配置机器人</h4>
<p>把机器人配置打开，填写相关信息之后直接发布。</p>
<h4 data-id="heading-10">步骤 5：发布应用</h4>
<p>点击<strong>凭证与基础信息</strong> → <strong>查看版本详情</strong> → 第一次发布需要填写详情 → <strong>确认发布</strong>之后就能在钉钉里面搜索到机器人。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fb3919514c64f9986823f951099e58a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=yEOZYnPKCRctUKqzJC5B65oEGt0%3D" alt="屏幕截图 2026-02-06 101547.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29714bee60d74ec6b6051b3d17470fb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=66ACVfItBlGJrHC2%2FZ88RiPa3I8%3D" alt="屏幕截图 2026-02-06 102127.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/939c2a709949485f8d8b7cc01e3e4068~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=t9iDxX1CynLvta%2BlDUKiMqYIQyY%3D" alt="屏幕截图 2026-02-06 102519.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b88906c76194178ba15c471225ec4ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=pIVIQ6IR1oXZra0h%2BNnClgigpgo%3D" alt="屏幕截图 2026-02-06 102629.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/352d0da6290a446d9813054950cfa7c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=WOsRSzWMet1WrcLpe5AR3BcblTM%3D" alt="屏幕截图 2026-02-06 102841.png" loading="lazy"/></p>
<h4 data-id="heading-11">步骤 6：配置权限管理</h4>
<p>在应用的权限管理页面，需要开启以下权限：</p>
<ul>
<li><strong>✅ Card.Instance.Write</strong> — 创建和投放卡片实例</li>
<li><strong>✅ Card.Streaming.Write</strong> — 对卡片进行流式更新</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f28e5f9f00964d1fbdd81cc6cec7a8f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=8rgFS%2FnjPaf%2B8r0mgTHykcafT50%3D" alt="屏幕截图 2026-02-06 093616.png" loading="lazy"/></p>
<h4 data-id="heading-12">步骤 7：建立卡片模板</h4>
<p>如需使用 AI 互动卡片功能，需要在钉钉卡片平台创建模板：</p>
<ol>
<li>访问钉钉卡片平台：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen-dev.dingtalk.com%2Ffe%2Fcard%3Fspm%3Dding_open_doc.document.0.0.21544a97LNpJiA%26hash%3D%2523%252F%23%2F" target="_blank" title="https://open-dev.dingtalk.com/fe/card?spm=ding_open_doc.document.0.0.21544a97LNpJiA&amp;hash=%23%2F#/" ref="nofollow noopener noreferrer">open-dev.dingtalk.com/fe/card</a></li>
<li>点击「新建模板」</li>
<li>卡片模板场景选择 <strong>「AI 卡片」</strong></li>
<li>无需选择预设模板，直接点击保存</li>
<li>复制模板 ID（格式如：xxxxx-xxxxx-xxxxx.schema）</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab53c47147194d1ca4ac821020d8482a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=t304iJKd8ySD7h3eTGv1pdPAqsQ%3D" alt="屏幕截图 2026-02-06 094055.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f4a7915670942e3b420f95ba5bbaed6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=Kiz0V5KGHZDfSe1TdfN5lhM9O34%3D" alt="屏幕截图 2026-02-06 094225.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb71514f0ea04a8e93f1527f516756ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=suclTZ1KhHanIkGIAQJf7%2F52%2F8o%3D" alt="屏幕截图 2026-02-06 132741.png" loading="lazy"/></p>
<h4 data-id="heading-13">步骤 8：获取凭证</h4>
<p>从开发者后台获取以下凭证并保存下来：</p>
<ul>
<li><strong>Client ID (AppKey)</strong></li>
<li><strong>Client Secret (AppSecret)</strong></li>
<li><strong>Robot Code</strong> (与 Client ID 相同)</li>
<li><strong>Corp ID</strong> (企业 ID)</li>
<li><strong>Agent ID</strong> (应用 ID)</li>
<li><strong>模板 ID</strong> (卡片模板)</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca19ad352d3f4d22bb5ab6ae8712237d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=3oxcbph07xL%2FnL2yjqn0ac%2F%2BYAY%3D" alt="屏幕截图 2026-02-06 112517.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-14">配置选项</h3>



















































































<table><thead><tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>enabled</code></td><td>boolean</td><td>true</td><td>是否启用</td></tr><tr><td><code>clientId</code></td><td>string</td><td>必填</td><td>应用的 AppKey</td></tr><tr><td><code>clientSecret</code></td><td>string</td><td>必填</td><td>应用的 AppSecret</td></tr><tr><td><code>robotCode</code></td><td>string</td><td>-</td><td>机器人代码</td></tr><tr><td><code>corpId</code></td><td>string</td><td>-</td><td>企业 ID</td></tr><tr><td><code>agentId</code></td><td>string</td><td>-</td><td>应用 ID</td></tr><tr><td><code>dmPolicy</code></td><td>string</td><td>"open"</td><td>私聊策略：open/pairing/allowlist</td></tr><tr><td><code>groupPolicy</code></td><td>string</td><td>"open"</td><td>群聊策略：open/allowlist</td></tr><tr><td><code>allowFrom</code></td><td>string[]</td><td>[]</td><td>允许的发送者 ID 列表</td></tr><tr><td><code>messageType</code></td><td>string</td><td>"markdown"</td><td>消息类型：markdown/card</td></tr><tr><td><code>cardTemplateId</code></td><td>string</td><td>"382e4302-551d-4880-bf29-a30acfab2e71.schema"</td><td>AI 互动卡片模板 ID（仅当 messageType=card）</td></tr><tr><td><code>debug</code></td><td>boolean</td><td>false</td><td>是否开启调试日志</td></tr></tbody></table>
<h4 data-id="heading-15">安全策略</h4>
<h5 data-id="heading-16">私聊策略 (dmPolicy)</h5>
<ul>
<li><strong>open</strong> — 任何人都可以私聊机器人</li>
<li><strong>pairing</strong> — 新用户需要通过配对码验证</li>
<li><strong>allowlist</strong> — 只有 allowFrom 列表中的用户可以使用</li>
</ul>
<h5 data-id="heading-17">群聊策略 (groupPolicy)</h5>
<ul>
<li><strong>open</strong> — 任何群都可以 @机器人</li>
<li><strong>allowlist</strong> — 只有配置的群可以使用</li>
</ul>
<hr/>
<h3 data-id="heading-18">配置OpenClaw</h3>
<h4 data-id="heading-19">步骤 1：自动安装（推荐）</h4>
<p>如果有VPN可以直接执行：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw plugins install https://github.com/soimy/clawdbot-channel-dingtalk.git
</code></pre>
<p>没有VPN就用手动安装方式。</p>
<h4 data-id="heading-20">步骤 2：手动安装</h4>
<ol>
<li>执行 <code>openclaw plugins list</code> 找到系统插件所在的目录（如：<code>D:\Program Files\nodejs\node_global\node_modules\openclaw\extensions</code>）</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9252180a4b18431d8745ed4f248139c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=aZHYaqXSkRORZdrQeL7JqX7W7QY%3D" alt="屏幕截图 2026-02-06 101019.png" loading="lazy"/></p>
<ol start="2">
<li>
<p>创建dingtalk目录：<code>D:\Program Files\nodejs\node_global\node_modules\openclaw\extensions\dingtalk</code></p>
</li>
<li>
<p>把openclaw-channel-dingtalk下的文件复制到创建的dingtalk目录</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c5d71b559f94bf5bfdc1a35c83452e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=q%2B0YQgxtJi1j1TRtpku5GOVHGco%3D" alt="屏幕截图 2026-02-06 101244.png" loading="lazy"/></p>
<ol start="4">
<li>打开dingtalk目录，执行安装依赖：<code>npm install</code></li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e0baae09f564f7990c036ce33b5debb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=jwKb4mmDjJLwULqN2aXegTyax7k%3D" alt="屏幕截图 2026-02-06 104836.png" loading="lazy"/></p>
<ol start="5">
<li>运行 <code>openclaw plugins list</code> 确认 dingtalk 已显示在列表中</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4375eb19ddeb4a64ab781ce4e4a43632~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=wPguHlPwsEbq4PPb3ScxOJgHxmc%3D" alt="屏幕截图 2026-02-06 101139.png" loading="lazy"/></p>
<h4 data-id="heading-21">步骤 3：编辑配置文件</h4>
<p>可以通过 <code>openclaw gateway status</code> 查看配置文件目录</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6056cc622dda4240b939a9a09e8022e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=io6BPcu6yoih%2FRIpb5aSXgC7kSY%3D" alt="屏幕截图 2026-02-06 094621.png" loading="lazy"/></p>
<p>编辑文件 <code>~/.openclaw/openclaw.json</code>，添加 dingtalk 字段内容，将上面获取到的ID填入相应的字段：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  ...
  <span class="hljs-attr">"channels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"telegram"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

    <span class="hljs-attr">"dingtalk"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"clientId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dingvex0dgwcce9fexxd"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"clientSecret"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-app-secret"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"robotCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dingvex0dgwcce9fexxd"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"corpId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dingvex0dgwcce9fexxd"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"agentId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4250080956"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"dmPolicy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"open"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"groupPolicy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"open"</span><span class="hljs-punctuation">,</span>      
      <span class="hljs-attr">"messageType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"card"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cardTemplateId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1fd68835-1571-4b33-a5d1-1b0c969ae85e.schema"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"debug"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
  ...
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-22">步骤 4：重启服务</h4>
<p>重新启动：<code>openclaw gateway --port 18789 --verbose</code></p>
<p>或者重启 Gateway：<code>openclaw gateway restart</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2952d6191924487f9ef094e62d1b64dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=svRpBgJuVz1xvx4cKwmrz%2B%2FRJD0%3D" alt="屏幕截图 2026-02-06 104932.png" loading="lazy"/></p>
<h4 data-id="heading-23">步骤 5：⚠️ 常见问题提示</h4>
<p>如果通过 Git 拉取代码后，AI 回复无法显示卡片，并在日志中出现类似以下错误：</p>
<pre><code class="hljs language-ini" lang="ini">04:44:02 <span class="hljs-section">[dingtalk]</span> <span class="hljs-section">[AICard]</span> <span class="hljs-attr">conversationType</span>=<span class="hljs-number">1</span>, conversationId=<span class="hljs-number">20376554481106336</span>
04:44:02 <span class="hljs-section">[dingtalk]</span> <span class="hljs-section">[AICard]</span> POST /v1.0/card/instances/createAndDeliver <span class="hljs-attr">body</span>={<span class="hljs-string">"cardTemplateId"</span>:<span class="hljs-string">"daee59fc-bcf6-4669-873f-b38eec80eaff.schema"</span>,<span class="hljs-string">"outTrackId"</span>:<span class="hljs-string">"card_86f9c23a-906e-41f4-8f5b-fbe5f7a3650a"</span>,<span class="hljs-string">"cardData"</span>:{<span class="hljs-string">"cardParamMap"</span>:{}},<span class="hljs-string">"callbackType"</span>:<span class="hljs-string">"STREAM"</span>,<span class="hljs-string">"imGroupOpenSpaceModel"</span>:{<span class="hljs-string">"supportForward"</span>:<span class="hljs-literal">true</span>},<span class="hljs-string">"imRobotOpenSpaceModel"</span>:{<span class="hljs-string">"supportForward"</span>:<span class="hljs-literal">true</span>},<span class="hljs-string">"openSpaceId"</span>:<span class="hljs-string">"dtv1.card//IM_ROBOT.20376554481106336"</span>,<span class="hljs-string">"userIdType"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"imRobotOpenDeliverModel"</span>:{<span class="hljs-string">"spaceType"</span>:<span class="hljs-string">"IM_ROBOT"</span>}}
04:44:03 <span class="hljs-section">[dingtalk]</span> <span class="hljs-section">[AICard]</span> Create failed: Request failed with status code 400
04:44:03 <span class="hljs-section">[dingtalk]</span> <span class="hljs-section">[AICard]</span> Error response: <span class="hljs-attr">status</span>=<span class="hljs-number">400</span> data={<span class="hljs-string">"requestid"</span>:<span class="hljs-string">"D85C4B2D-E655-7412-9FFA-89341F737BAA"</span>,<span class="hljs-string">"code"</span>:<span class="hljs-string">"param.empty"</span>,<span class="hljs-string">"message"</span>:<span class="hljs-string">"param.empty"</span>}
</code></pre>
<p><strong>解决方案</strong>：编辑 <code>src/channel.ts</code> 文件，找到 <code>createAICard</code> 方法，将 <code>cardParamMap: {}</code> 替换为以下代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">cardParamMap</span>: {
  <span class="hljs-comment">// Provide default parameters to avoid empty param error</span>
  <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">toString</span>(),
},
</code></pre>
<p>然后重新重启服务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3977eb4115764f3e9b510483a6aef23f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=i19K5fDD5ftLVYeVKaMob%2BSLylU%3D" alt="屏幕截图 2026-02-06 133335.png" loading="lazy"/></p>
<h4 data-id="heading-24">最终结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cefa06ce47f34312ab82ad420e1c9d9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54655aSW5LmL6Z-z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770980169&amp;x-signature=BhPVHORzZWFbwNDjrIhIA0oT2IY%3D" alt="屏幕截图 2026-02-06 142551.png" loading="lazy"/></p>
<hr/>
<blockquote>
<p><strong>插件GitHub地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsoimy%2Fopenclaw-channel-dingtalk" target="_blank" title="https://github.com/soimy/openclaw-channel-dingtalk" ref="nofollow noopener noreferrer">github.com/soimy/openc…</a></p>
</blockquote>
<blockquote>
<p><strong>AI API 聚合平台</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.32zi.com" target="_blank" title="https://ai.32zi.com" ref="nofollow noopener noreferrer">快速、稳定、低价</a></p>
</blockquote>
<hr/>
<p><em>钉钉机器人应用配置与OpenClaw集成指南 | 最后更新: 2026年2月</em></p>
<p><em>注意：原创文章，转载请标明来处</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent Skills：智能 IDE 正在掀起一场“能力模块化”革命]]></title>    <link>https://juejin.cn/post/7603355275258167336</link>    <guid>https://juejin.cn/post/7603355275258167336</guid>    <pubDate>2026-02-06T10:27:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603355275258167336" data-draft-id="7603444191447973922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent Skills：智能 IDE 正在掀起一场“能力模块化”革命"/> <meta itemprop="keywords" content="Agent,Cursor,Trae"/> <meta itemprop="datePublished" content="2026-02-06T10:27:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="__不想说话__"/> <meta itemprop="url" content="https://juejin.cn/user/1626932940391191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent Skills：智能 IDE 正在掀起一场“能力模块化”革命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1626932940391191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    __不想说话__
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T10:27:38.000Z" title="Fri Feb 06 2026 10:27:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从“靠嘴指挥”到“直接上手”，AI 终于学会像工程师一样干活了。</p>
</blockquote>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc034a943f8c490b8bcd3f42bc89cdb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_kuI3mg7Por7Tor51fXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770978458&amp;x-signature=NCNNiX%2Bz99q0WoiJgYsJTnPpQ2k%3D" alt="AI 从聊天走向执行" loading="lazy"/></p>
<h2 data-id="heading-0">一、Agent Skills 是什么？🤔</h2>
<p>如果你最近频繁玩 <strong>Cursor、Claude Code、Gemini CLI、Codex CLI、Trae</strong> 这类“智能 IDE”，应该已经察觉到一个明显的趋势：</p>
<blockquote>
<p>AI 不再满足于“你问我答”了，它开始<strong>直接上手帮你把事做完</strong>。</p>
</blockquote>
<p>而让这一切成为可能的核心机制之一，就是 <strong>Agent Skills</strong>。</p>
<p>简单来说，<strong>Agent Skills 是一组可复用、可组合、能被 AI 主动调用的“技能包”</strong>。它不是一个简单的 Prompt，也不只是一个 API，而是：</p>
<ul>
<li>一套<strong>结构化的任务说明书（SOP）</strong></li>
<li>一组<strong>可以直接运行的脚本、模板或工具</strong></li>
<li>一种<strong>能被 IDE 或 AI 理解并随时调用的能力描述方式</strong></li>
</ul>
<p>你可以把它想象成：</p>
<blockquote>
<p><strong>扔给 AI 的一本「岗位职责 + 操作手册」</strong>。</p>
</blockquote>
<h3 data-id="heading-1">来看一个真实的 Skill 长啥样</h3>
<p>在 Claude / Cursor 的生态里，一个 Skill 其实就是一个文件夹，核心是里面的 <code>SKILL.md</code>：</p>
<pre><code class="hljs language-bash" lang="bash">.claude/skills/
  react-component-generator/
    SKILL.md
    templates/
    scripts/
</code></pre>
<p><code>SKILL.md</code> 的开头是 YAML 配置，后面跟着 Markdown 格式的执行指南：</p>
<pre><code class="hljs language-md" lang="md">---
name: react-component-generator
<span class="hljs-section">description: 根据需求生成 React 组件
---</span>

当用户描述一个 UI 或功能需求时：
<span class="hljs-bullet">1.</span> 分析组件的职责与结构
<span class="hljs-bullet">2.</span> 匹配合适的组件模板
<span class="hljs-bullet">3.</span> 生成符合当前项目规范的 React 组件代码
</code></pre>
<p>AI 不再是“随意发挥”，而是<strong>在明确流程约束下执行任务，大幅降低随机性</strong>。</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e749bf7bd88f426380cf0ea943909d97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_kuI3mg7Por7Tor51fXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770978458&amp;x-signature=0YEItQwNTNRxj7u1%2Fu4m36CPwEE%3D" alt="Skill = SOP + 工具箱" loading="lazy"/></p>
<h2 data-id="heading-2">二、技能进化史：Agent Skills 是怎么来的？📜</h2>
<p>Agent Skills 不是石头缝里蹦出来的，它的出现其实是一条清晰的技术演进路线的终点。</p>
<h3 data-id="heading-3">1️⃣ Prompt Engineering 时代：纯靠“嘴遁”</h3>
<p>早期我们只能靠 Prompt 来指挥 AI：</p>
<blockquote>
<p>“你是一个资深前端，请按以下规范生成代码……”</p>
</blockquote>
<p>但问题很明显：</p>
<ul>
<li>不稳定（上下文一变就跑偏）</li>
<li>难复用（每次都要重新说一遍）</li>
<li>团队经验无法沉淀</li>
</ul>
<h3 data-id="heading-4">2️⃣ Tool / Function Calling：AI 学会“用工具”了</h3>
<p>接着出现了 <strong>Toolformer、Function Calling</strong>：</p>
<ul>
<li>AI 能自己判断“什么时候该调用工具”</li>
<li>还能把参数整理好传给函数</li>
</ul>
<p>但依然存在一个短板：</p>
<blockquote>
<p><strong>工具只告诉 AI“你能做什么”，却没告诉它“你应该怎么做”</strong>。</p>
</blockquote>
<h3 data-id="heading-5">3️⃣ Agent + Skills：开始真正“像人一样工作”</h3>
<p>Agent Skills 补上了最后一块拼图：</p>
<ul>
<li>把<strong>人类工程师的工作流</strong>固化下来</li>
<li>让 AI 面对复杂任务时，有清晰的步骤可循</li>
<li>支持按需加载技能，避免“一次性吃成胖子”（上下文爆炸）</li>
</ul>
<p>这也是为什么 <strong>Claude、Cursor、VSCode Agent、Trae</strong> 都在 2024~2025 年间集体拥抱了 Skills 机制。</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28e811de3ef743c0b6417c9dd34ae161~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_kuI3mg7Por7Tor51fXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770978458&amp;x-signature=LYtIJ2bY7UhIzbbqbsUjzvAE1xs%3D" alt="Prompt vs Skill" loading="lazy"/></p>
<h2 data-id="heading-6">三、Skills vs MCP：别再傻傻分不清楚！🚨</h2>
<p>这是很多人容易搞混、但又必须弄清楚的一个点。</p>
<h3 data-id="heading-7">MCP 是什么？</h3>
<p><strong>MCP（Multi-agent / Model Context Protocol）</strong> 解决的是：</p>
<blockquote>
<p><strong>Agent 怎么“连接外部世界”</strong></p>
</blockquote>
<p>比如：</p>
<ul>
<li>读取数据库</li>
<li>调用搜索引擎</li>
<li>操作浏览器或文件系统</li>
</ul>
<p>你可以把它理解成：</p>
<blockquote>
<p><strong>接口协议 / 数据管道 / 外设驱动</strong></p>
</blockquote>
<h3 data-id="heading-8">Skills 又是什么？</h3>
<p>Skills 解决的则是另一件事：</p>
<blockquote>
<p><strong>Agent 应该“按照什么流程正确做事”</strong></p>
</blockquote>
<h3 data-id="heading-9">一个超形象的类比</h3>

















<table><thead><tr><th>角色</th><th>类比</th></tr></thead><tbody><tr><td>MCP</td><td>USB 接口 / API 网关</td></tr><tr><td>Skills</td><td>说明书 / 标准作业程序（SOP）</td></tr></tbody></table>
<p>👉 <strong>MCP 管的是“能不能做”</strong><br/>
👉 <strong>Skills 管的是“该怎么做”</strong></p>
<p>它们俩是<strong>互补关系</strong>，而不是谁替代谁。</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6ceb2bee6004074b2103a87f7d8e638~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_kuI3mg7Por7Tor51fXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770978458&amp;x-signature=OMlz1vBWVxJJGP31u0FLI8IA9y4%3D" alt="MCP vs Skills" loading="lazy"/></p>
<h2 data-id="heading-10">四、上手实战：在智能 IDE 里怎么玩转 Skills？🎮</h2>
<p>我们拿 <strong>Claude Code / Cursor</strong> 来举个完整的例子。</p>
<h3 data-id="heading-11">1️⃣ 安装 Skills 管理工具</h3>
<pre><code class="hljs language-bash" lang="bash">npm install -g openskills
</code></pre>
<h3 data-id="heading-12">2️⃣ 安装官方或社区的 Skills</h3>
<pre><code class="hljs language-bash" lang="bash">openskills install anthropics/skills
</code></pre>
<p>你可以挑着装，比如只装这几个：</p>
<ul>
<li>pptx-generator（自动做 PPT）</li>
<li>git-changelog-analyzer（分析 Git 日志）</li>
<li>code-review-helper（辅助代码审查）</li>
</ul>
<h3 data-id="heading-13">3️⃣ 生成 AGENTS.md 索引文件</h3>
<pre><code class="hljs language-bash" lang="bash">openskills <span class="hljs-built_in">sync</span>
</code></pre>
<p>这个文件非常关键：</p>
<blockquote>
<p><strong>它就像是 AI 的“技能清单”</strong>。</p>
</blockquote>
<h3 data-id="heading-14">4️⃣ 实际体验：一句话让 AI 干活</h3>
<p>在 Cursor / Claude Code 里直接输入：</p>
<blockquote>
<p>用 <code>pptx</code> skill，基于最近 10 次 git commit，生成一份技术周报 PPT</p>
</blockquote>
<p>接下来 AI 会自动：</p>
<ol>
<li>查看 AGENTS.md</li>
<li>找到 pptx 这个技能</li>
<li>拉取 git 日志</li>
<li>调用模板和脚本生成 PPT 文件</li>
</ol>
<p>全程<strong>无需你再手写任何一句 Prompt</strong>。</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbc50e73d6884fc7b1f45768d4208ad1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_kuI3mg7Por7Tor51fXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770978458&amp;x-signature=hBZmWXtFR6%2BdVj0dut5g7QMdEmM%3D" alt="Skill 调用流程" loading="lazy"/></p>
<h2 data-id="heading-15">五、真实场景：Skills 能用来做什么？💼</h2>
<p>这里才是 Agent Skills 真正让人兴奋（甚至有点吓人）的地方。</p>
<h3 data-id="heading-16">🧩 对开发者</h3>
<ul>
<li>统一项目代码风格（ESLint + Prettier 自动化）</li>
<li>自动生成组件、API 层、Mock 数据</li>
<li>一键补全单元测试</li>
<li>按团队规范批量重构代码</li>
</ul>
<h3 data-id="heading-17">📦 对产品与技术管理者</h3>
<ul>
<li>自动生成 PRD / 技术方案框架</li>
<li>版本发布自动生成变更说明</li>
<li>定期生成技术周报、月报</li>
</ul>
<h3 data-id="heading-18">🛠 对团队协作</h3>
<ul>
<li>把团队大佬的经验封装成 Skill</li>
<li>新人入职直接“加载技能包”</li>
<li>AI 化身真正能干的“虚拟同事”</li>
</ul>
<p>一句话总结：</p>
<blockquote>
<p><strong>只要你能写成标准流程的活儿，都有可能变成一个 Skill。</strong></p>
</blockquote>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5a3cac3ea0d4862870d1e3de88826f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX1_kuI3mg7Por7Tor51fXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770978458&amp;x-signature=j1DS9S3gwu3UFuoVpBdJu95lojs%3D" alt="Skills 应用场景" loading="lazy"/></p>
<h2 data-id="heading-19">六、冷静一下：Skills 的隐患与未来 ⚠️</h2>
<p>能力越强，责任越大，风险也越真实。</p>
<h3 data-id="heading-20">⚠️ 已经露头的风险</h3>
<ul>
<li>恶意 Skill 偷偷注入危险指令</li>
<li>一次授权，AI 就可能长期“失控”</li>
<li>诱导 AI 执行高权限操作（比如读 SSH Key、跑系统命令）</li>
</ul>
<p>现实中已有安全团队警告：</p>
<blockquote>
<p>部分 Skill 可在用户无感知的情况下，读取敏感文件或执行命令。</p>
</blockquote>
<h3 data-id="heading-21">🛡️ 必须补上的防护</h3>
<ul>
<li>Skill 权限分级管理</li>
<li>脚本在沙箱中执行</li>
<li>安全扫描与审核机制</li>
<li>关键操作需人类确认</li>
</ul>
<h3 data-id="heading-22">🌱 未来的想象空间</h3>
<ul>
<li>Skill 应用商店 &amp; 行业标准</li>
<li>一次开发，多 IDE 通用</li>
<li>企业私有 Skill 仓库</li>
<li>Skill + MCP + Agent 的完整工程体系</li>
</ul>
<hr/>
<h2 data-id="heading-23">写在最后 ✨</h2>
<p>如果你最近觉得：</p>
<blockquote>
<p>“AI 终于像个靠谱的工程师了”</p>
</blockquote>
<p>那很可能是因为：</p>
<blockquote>
<p><strong>它不再只是一个语言模型，而是一个装备了 Skills 的智能体。</strong></p>
</blockquote>
<p>下一阶段的竞争，或许不再是比谁的 Prompt 写得妙，
而是看谁<strong>更会给 AI 设计“技能架构”</strong>。</p>
<p>欢迎从今天开始，</p>
<blockquote>
<p><strong>少写 Prompt，多写 Skills。</strong> 🚀</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么建议把 map 换成 for loop？—— 聊聊 Side Effects 与语义化编程]]></title>    <link>https://juejin.cn/post/7603352117639168009</link>    <guid>https://juejin.cn/post/7603352117639168009</guid>    <pubDate>2026-02-06T08:55:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352117639168009" data-draft-id="7603309951227379762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么建议把 map 换成 for loop？—— 聊聊 Side Effects 与语义化编程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T08:55:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gogo1121"/> <meta itemprop="url" content="https://juejin.cn/user/4162081326907051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么建议把 map 换成 for loop？—— 聊聊 Side Effects 与语义化编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4162081326907051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gogo1121
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:55:12.000Z" title="Fri Feb 06 2026 08:55:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>在进行代码审查（Code Review）时，你是否收到过这样的评论：</p>
<blockquote>
<p><strong>“这里的 side effect 会不会考虑一下用 for loop？”</strong></p>
</blockquote>
<p>当时的我心里想：“反正代码都能跑，<code>map</code> 和 <code>for</code> 有什么区别吗？<code>map</code> 写起来不是更短更帅吗？”</p>
<p>这篇文章就是为了解答这个疑惑。这不仅仅是代码风格的问题，更关乎<strong>代码的可读性（语义）</strong> 、<strong>性能（内存）以及函数式编程的原则</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、 什么是 Side Effect（副作用）？</h2>
<p>首先，我们要听懂“行话”。在编程中，<strong>Side Effect</strong> 指的是一个函数在执行过程中，除了返回结果之外，还<strong>改变了外部的世界</strong>。</p>
<ul>
<li>
<p><strong>纯函数 (Pure Function)</strong> ：输入 <code>2</code>，输出 <code>4</code>。不修改任何外部变量，不读写数据库，不打印日志。像数学公式一样纯粹。</p>
</li>
<li>
<p><strong>有副作用 (Side Effect)</strong> ：</p>
<ul>
<li>修改了外部定义的变量（如 <code>total += 1</code>）。</li>
<li>写入数据库（DB Insert/Update）。</li>
<li>发送网络请求（API Call）。</li>
<li>打印日志（<code>console.log</code>）。</li>
</ul>
</li>
</ul>
<p><strong>Reviewer 的潜台词：</strong> “我看你在遍历数组时，并不是为了把 A 变成 B，而是为了拿 A 去做一些操作（比如存库）。这种情况，请不要用 <code>map</code>。”</p>
<hr/>
<h2 data-id="heading-1">二、 <code>map</code> vs <code>for</code>：看似一样，实则背道而驰</h2>
<p>虽然它们都能遍历数组，但它们在**设计初衷（语义）**上是完全不同的。</p>
<h3 data-id="heading-2">1. <code>map</code> 的契约：我只负责“转换”</h3>
<p><code>map</code> 是函数式编程（Functional Programming）的明星工具。它的名字来源于数学中的“映射”（Mapping）。</p>
<ul>
<li><strong>语义</strong>：给我一个数组 <code>[A, B, C]</code>，我给你返回一个新数组 <code>[A', B', C']</code>。</li>
<li><strong>潜规则</strong>：<strong>一定要有返回值</strong>，且<strong>不要修改原始数据</strong>。</li>
</ul>
<h3 data-id="heading-3">2. <code>for</code> / <code>forEach</code> 的契约：我只负责“执行”</h3>
<p><code>for</code> 循环（包括 <code>for...of</code>）是指令式编程（Imperative Programming）的工具。</p>
<ul>
<li><strong>语义</strong>：对着数组里的每一个元素，去<strong>执行</strong>一段逻辑。</li>
<li><strong>潜规则</strong>：我不关心返回值，我只关心过程（比如存库、发邮件）。</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、 为什么用 <code>map</code> 处理副作用被视为 Anti-pattern（反模式）？</h2>
<p>如果你写了这样的代码：</p>
<pre><code class="hljs language-ini" lang="ini">// ❌ 被吐槽的写法
const <span class="hljs-attr">userIds</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<span class="hljs-comment">;</span>

userIds.map(<span class="hljs-attr">id</span> =&gt; {
  db.updateStatus(id, 'active')<span class="hljs-comment">; // &lt;--- 这就是 Side Effect</span>
  // 没有 return，或者 return 了一个没用的东西
})<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>Reviewer 看到这段代码会有三个层面的担忧：</p>
<h3 data-id="heading-5">1. 误导阅读者（语义错误）</h3>
<p>代码是写给人看的。 当你使用 <code>map</code> 时，阅读代码的人会预期：“哦，这里在生成一个新的数据列表。” 结果看了一圈发现，你并没有使用 <code>map</code> 的返回值，只是在里面干活。这就像是你<strong>雇了一个顶级大厨（map），却让他去送快递（side effect）</strong> ——虽然他也能送，但让人觉得很违和。</p>
<h3 data-id="heading-6">2. 内存浪费（性能隐患）</h3>
<p>这是实打实的技术问题。 <code>map</code> 函数<strong>一定会</strong>在内存中分配一个新的数组。</p>
<ul>
<li>如果你用 <code>map</code> 遍历 10,000 个用户去发邮件，通过 <code>map</code> 你会隐式地创建了一个包含 10,000 个 <code>undefined</code>（因为你没 return）的数组。</li>
<li>这个数组创建完立刻就被扔掉等待垃圾回收（GC）。</li>
<li><strong>结论</strong>：你在浪费内存，给 GC 增加压力。</li>
</ul>
<h3 data-id="heading-7">3. Async/Await 的陷阱</h3>
<p>在后端开发中，这尤为致命。</p>
<pre><code class="hljs language-python" lang="python">// ❌ 危险的 <span class="hljs-built_in">map</span> 写法
ids.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">async</span> (<span class="hljs-built_in">id</span>) =&gt; {
  <span class="hljs-keyword">await</span> db.delete(<span class="hljs-built_in">id</span>);
});
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>上面这段代码<strong>不会</strong>等待数据库删除完成！<code>map</code> 会瞬间执行完，返回一堆 <code>Promise</code>，而你的主程序会继续往下跑。</p>
<p>如果要等待，必须配合 <code>Promise.all</code>：</p>
<pre><code class="hljs language-python" lang="python">// ✅ 如果要并发，且一定要用 <span class="hljs-built_in">map</span>
<span class="hljs-keyword">await</span> Promise.<span class="hljs-built_in">all</span>(ids.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">async</span> (<span class="hljs-built_in">id</span>) =&gt; <span class="hljs-keyword">await</span> db.delete(<span class="hljs-built_in">id</span>)));
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>但如果你想要<strong>按顺序</strong>一个一个删（避免把数据库打挂），<code>map</code> 做不到，必须用 <code>for...of</code>。</p>
<hr/>
<h2 data-id="heading-8">四、 最佳实践：如何修改？</h2>
<p>针对 Reviewer 的建议，可以根据场景选择以下两种改法：</p>
<h3 data-id="heading-9">场景 A：纯同步操作 / 不需要等待结果</h3>
<p>使用 <code>forEach</code> 或 <code>for...of</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 语义清晰：我在对每个 ID 执行操作</span>
userIds.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Processing user <span class="hljs-subst">${id}</span>`</span>);
});
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-10">场景 B：异步操作（数据库/API）—— <strong>最推荐</strong></h3>
<p>现代 JavaScript/TypeScript 开发中，<code>for...of</code> 是处理异步副作用的神器</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ✅ 语义清晰，且支持 await 顺序执行</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id of userIds) {
  <span class="hljs-comment">// 只有上一个 update 完成了，才会执行下一个</span>
  <span class="hljs-keyword">await</span> db.updateStatus(id, <span class="hljs-string">'active'</span>); 
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-11">五、 总结</h2>
<p>下次当你手指放在键盘上准备敲下 <code>.map</code> 时，停下来问自己一个问题：</p>
<p><strong>“我是想要根据旧数组【生成】一个新数组，还是想要用这些数据去【做】一些事情？”</strong></p>
<ul>
<li>如果是<strong>生成</strong>数据（转换）：请用 <code>map</code>。</li>
<li>如果是<strong>做</strong>事情（副作用）：请用 <code>for...of</code> 或 <code>forEach</code>。</li>
</ul>
<p>这不仅仅是代码能不能跑的区别，更是从“写代码的人”进阶到“工程师”的必经之路：<strong>精准地使用工具，表达清晰的意图。</strong></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你不知道的JS上-（八）]]></title>    <link>https://juejin.cn/post/7603444191447990306</link>    <guid>https://juejin.cn/post/7603444191447990306</guid>    <pubDate>2026-02-06T08:55:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191447990306" data-draft-id="7603444191447924770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你不知道的JS上-（八）"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-06T08:55:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户1443618340097"/> <meta itemprop="url" content="https://juejin.cn/user/2782223226650328"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你不知道的JS上-（八）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2782223226650328/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户1443618340097
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:55:26.000Z" title="Fri Feb 06 2026 08:55:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">this 和对象原型</h2>
<h3 data-id="heading-1">对象</h3>
<h4 data-id="heading-2">语法</h4>
<p>对象可以通过两种形式定义：声明（文字）形式和构造形式。</p>
<p>文字语法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObj = {
  <span class="hljs-attr">key</span>: value,
  <span class="hljs-comment">//...</span>
};
</code></pre>
<p>构造语法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
myObj.<span class="hljs-property">key</span> = value;
</code></pre>
<p>构造形式和文字形式的区别就是，文字声明中可以添加多个健/值对，构造语法只能逐个添加。</p>
<h4 data-id="heading-3">类型</h4>
<p>对象是JavaScript的基础。在JavaScript中一个有六种主要类型（术语是“语言类型”）：string、number、boolean、null、undefined、object</p>
<p>注意，简单基本类型本身并不是对象。null有时会被当作一种对象类型，但这是语言本身的一个bug，即对null执行typeof null时会返回字符串“object”。null本身是基本类型。</p>
<p>实际上，JS中有许多特殊的对象子类型，我们称之为复杂基本类型。</p>
<p>函数、数组都是对象的一种类型。</p>
<h5 data-id="heading-4">内置对象</h5>
<p>JS中还有一些对象子类型，通常被称为内置对象。有些内置对象的名字看起来和基础类型一样，不过它们的关系更加复杂。String、Number、Boolean、Object、Function、Array、Date、RegExp、Error。</p>
<p>这些内置对象从表现形式上和其他语言中的类型（type）或者类（class）很像，比如Java中的String类。</p>
<p>但在JS中，它们实际上只是一些内置函数。这些内置函数可以当作构造函数来使用，从而构造一个对应子类型的新对象。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> strPrimitive = <span class="hljs-string">"I am a String"</span>;
<span class="hljs-keyword">typeof</span> strPrimitive; <span class="hljs-comment">// "string"</span>
strPrimitive <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span>; <span class="hljs-comment">// false</span>

<span class="hljs-keyword">var</span> strObject = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">"I am a String"</span>);
<span class="hljs-keyword">typeof</span> strObject; <span class="hljs-comment">// "object"</span>
strObject <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span>; <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 检查sub-type对象</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(strObject); <span class="hljs-comment">// [object String]</span>
</code></pre>
<p>原始值"I am a String"并不是一个对象，它只是一个字面量，并且是一个不可变的值。语言会自动把字符串字面量转换成一个String对象以便对其执行一些操作，比如获取长度、访问其中某个字符等。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> strPrimitive = <span class="hljs-string">"I am a String"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strPrimitive.<span class="hljs-property">length</span>); <span class="hljs-comment">// 13</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strPrimitive.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">3</span>)); <span class="hljs-comment">// "m"</span>
</code></pre>
<p>同样的事也会发生在数值字面量和布尔字面量上。</p>
<p>null和undefined没有对应的构造形式，它们只有文字形式。相反，Date只有构造，没有文字形式。</p>
<p>对于Object、Array、Function和RegExp来说，无论使用文字还是构造形式，它们都是对象，不是字面量。</p>
<p>Error对象很少在代码中显示创建，一般是在抛出异常时被自动创建。也可以使用new Error(..)来创建。</p>
<h4 data-id="heading-5">内容</h4>
<p>对象的内容是由一些存储在特地命名位置的（任意类型的）值组成的，我们称之为属性。</p>
<p>在引擎内部，属性的存储方式是多种多样的，一般并不会存在对象容器内部。存储在对象容器内部的是这些属性的名称，它们就像指针（从技术角度来说就是引用）一样，指向这些值真正的存储位置。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
};

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>

myObject[<span class="hljs-string">"a"</span>]; <span class="hljs-comment">// 2</span>
</code></pre>
<p>“.a”语法通常被称为“属性访问”，“["a"]”语法通常被称为“键访问”。它们访问的都是同一个位置。</p>
<p>两种语法的主要区别为“.”操作符要求属性名满足标识符的命名规范，“[".."]”语法可以接受任意UTF-8/Unicode字符串作为属性名。</p>
<p>在对象中，属性名永远都是字符串。如果使用的是string（字面量）以外的其他值作为属性名，那它首先会被转换为一个字符串。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {};

myObject[<span class="hljs-literal">true</span>] = <span class="hljs-string">"foo"</span>;
myObject[<span class="hljs-number">3</span>] = <span class="hljs-string">"bar"</span>;
myObject[myObject] = <span class="hljs-string">"baz"</span>;

myObject[<span class="hljs-string">"true"</span>]; <span class="hljs-comment">// "foo"</span>
myObject[<span class="hljs-string">"3"</span>]; <span class="hljs-comment">// "bar"</span>
myObject[<span class="hljs-string">"[object Object]"</span>]; <span class="hljs-comment">// "baz"</span>
</code></pre>
<h5 data-id="heading-6">可计算属性名</h5>
<p>ES6 增加了可计算属性名：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> prefix = <span class="hljs-string">"foo"</span>;

<span class="hljs-keyword">var</span> myObject = {
  [prefix + <span class="hljs-string">"bar"</span>]: <span class="hljs-string">"hello"</span>,
  [prefix + <span class="hljs-string">"baz"</span>]: <span class="hljs-string">"world"</span>,
};

myObject[<span class="hljs-string">"foobar"</span>]; <span class="hljs-comment">// hello</span>
myObject[<span class="hljs-string">"foobaz"</span>]; <span class="hljs-comment">// world</span>
</code></pre>
<h5 data-id="heading-7">数组</h5>
<p>数组也支持[]访问形式。数组期望额是数值下标，也就是值存储的位置（通常被称为索引）是非负整数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myArray = [<span class="hljs-string">"foo"</span>, <span class="hljs-number">42</span>, <span class="hljs-string">"bar"</span>];

myArray.<span class="hljs-property">length</span>; <span class="hljs-comment">// 3</span>
myArray[<span class="hljs-number">0</span>]; <span class="hljs-comment">// "foo"</span>
myArray[<span class="hljs-number">2</span>]; <span class="hljs-comment">// "bar"</span>
</code></pre>
<p>数组也是对象，可以给数组添加属性（但不建议这么做）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myArray = [<span class="hljs-string">"foo"</span>, <span class="hljs-number">42</span>, <span class="hljs-string">"bar"</span>];

myArray.<span class="hljs-property">baz</span> = <span class="hljs-string">"baz"</span>;
myArray.<span class="hljs-property">length</span>; <span class="hljs-comment">// 3</span>
myArray.<span class="hljs-property">baz</span>; <span class="hljs-comment">// "baz"</span>
</code></pre>
<h5 data-id="heading-8">复制对象</h5>
<p>在JS中复制一个对象是复杂的，需要判断深复制还是浅复制。对于浅拷贝，会和旧对象使用相同的引用；对于深拷贝，存在循环引用的情况就会导致死循环。</p>
<p>许多JS框架都提出了自己的解决办法，但是JS采用的标准又不统一。</p>
<p>对于JSON安全（也就是可以被序列化为一个JSON字符串并且可以根据这个字符串解析出一个结构和值完全一样的对象）的对象来说：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> newObj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(someObj));
</code></pre>
<p>ES6定义了Object.assign(..)方法实现浅复制：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, myObject);
</code></pre>
<h5 data-id="heading-9">属性描述符</h5>
<p>ES5之前按，JS语言本身没有提供可以直接检测属性特性的方法，比如判断属性是否是只读。</p>
<p>ES5开始，所有的属性都具备了属性描述符。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyDescriptor</span>(myObject, <span class="hljs-string">"a"</span>);
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   value: 2,</span>
<span class="hljs-comment">//   writable: true,</span>
<span class="hljs-comment">//   enumerable: true,</span>
<span class="hljs-comment">//   configurable: true</span>
<span class="hljs-comment">// }</span>
</code></pre>
<p>如我们所见，该普通的对象属性对应的属性描述符（也被称为“数描述符”，因为它只能保存一个数据），不仅只是2。还有另外三个特性：writable（可写）、enumerable（可枚举）和configurable（可配置）。</p>
<p>我们可以使用Object.defineProperty(..)来添加一个新的属性或修改已有属性（如果它是configurable）对特性进行设置。</p>
<ol>
<li>writable
writable决定是否可以修改属性的值</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-string">"a"</span>， {
  <span class="hljs-attr">value</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">writable</span>: fasle, <span class="hljs-comment">// 不可写</span>
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
});

myObject.<span class="hljs-property">a</span> = <span class="hljs-number">3</span>;

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>

</code></pre>
<ol start="2">
<li>configurable
只要属性是可配置的，就可以使用defineProperty(..)方法来修改属性描述符</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>
};

myObject.<span class="hljs-property">a</span> = <span class="hljs-number">3</span>;
myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 3</span>

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-string">"a"</span>， {
  <span class="hljs-attr">value</span>: <span class="hljs-number">4</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">configurable</span>: fasle <span class="hljs-comment">// 不可配置</span>
});

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 4</span>
myObject.<span class="hljs-property">a</span> = <span class="hljs-number">5</span>;
myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 5</span>

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-string">"a"</span>， {
  <span class="hljs-attr">value</span>: <span class="hljs-number">6</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,wrai
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
}); <span class="hljs-comment">// TypeError</span>
</code></pre>
<p>可见将configurable修改为false是单向操作，无法撤销。</p>
<blockquote>
<p>要注意一个例外，即便属性是configurable: false,还是能够将 writable 的状态由 true 改为 false，但是无法由 fasle 改为 true。</p>
</blockquote>
<p>且configurable: false 还会禁止删除这个属性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>
};

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>

<span class="hljs-keyword">delete</span> myObject.<span class="hljs-property">a</span>;
myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// undefined</span>

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-string">"a"</span>， {
  <span class="hljs-attr">value</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">configurable</span>: fasle <span class="hljs-comment">// 不可配置</span>
});

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>
<span class="hljs-keyword">delete</span> myObject.<span class="hljs-property">a</span>;
myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>
</code></pre>
<ol start="3">
<li>enumerable</li>
</ol>
<p>该描述符控制属性是否会出现在对象的属性枚举中，比如for..in循环，如果设置enumerable为false，这个属性就不会出现在枚举中。</p>
<h5 data-id="heading-10">不变性</h5>
<p>有时我们希望属性或者对象是不可改变的，H5中可以通过很多方法实现，但所有的方法都是浅不变性，它们只会影响目标对象和它的直接属性。</p>
<ol>
<li>对象常量
结合 writable: false 和 configurable: fasle就可以创建一个真正的常量属性（不可修改、重新定义或者删除）：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-string">"FAVORITE_NUMBER"</span>， {
  <span class="hljs-attr">value</span>: <span class="hljs-number">42</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">configurable</span>: fasle
});
</code></pre>
<ol start="2">
<li>禁止拓展
可以使用Object.preventExtensions(..)：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">preventExtensions</span>(myObject);

myObject.<span class="hljs-property">b</span> = <span class="hljs-number">3</span>;
myObject.<span class="hljs-property">b</span>; <span class="hljs-comment">// undefined</span>
</code></pre>
<ol start="3">
<li>
<p>密封
Object.seal(..) 会创建一个“密封”的对象，这个方法会一个在现有的对象上调用Object.preventExtensions(..)，并把所有的属性标记为configurable: false。</p>
</li>
<li>
<p>冻结
Object.freeze(..) 会创建一个“冻结”的对象，这个方法会一个在现有的对象上调用Object.seal(..)，并把所有“数据访问”属性标记为writable: false，这样旧无法修改值。</p>
</li>
</ol>
<p>该方法是我们可以应用在对象上的最高的不可变性，它会禁止对象本身及其任意直接属性的修改（不过该对象引用的其他对象是不受影响的）。</p>
<h5 data-id="heading-11">[[Get]]</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObjedt = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
};
myObjedt.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>
</code></pre>
<p>myObjedt.a通过[[Get]]操作实现对a属性的访问。对象默认的内置[[Get]]操作会首先查找是否有同名的属性，有就返回该对象的值。没有就会遍历可能存在的[[Prototype]]链，还是没找到的话就会返回undefined。</p>
<h5 data-id="heading-12">[[Put]]</h5>
<p>[[Put]]被触发时，会取决于许多因素，包括对象中是否存在这个属性。</p>
<p>如果已经存在这个属性，[[Put]]算法大致会检查下面这些内容。</p>
<ol>
<li>属性是否是访问描述符？如何是并且存在setter就调用setter。</li>
<li>属性的数据描述符中writable是否是false？如果是，在非严格模式静默失败，在严格模式抛出TypeError异常。</li>
<li>如果都不是将值设为属性的值。</li>
</ol>
<p>如果对象中不存在这个属性，[[Put]]操作会更加复制。后续详细介绍。</p>
<h5 data-id="heading-13">Getter和Setter</h5>
<p>对象默认的[[Put]]和[[Get]]操作分别可以控制属性值的设置和获取。</p>
<p>在ES5中可以使用getter和setter部分改写默认操作，但是只能应用在单个属性上，无法应用在整个对象上。getter是一个隐藏函数，会在获取属性值时调用。setter也是一个隐藏函数，会在设置属性值时调用。</p>
<p>当你给一个属性定义getter、setter 或者两者都有时，这个属性会被定义为“访问描述符”（和“数据描述符”相对）。对于访问描述符来说，JavaScript 会忽略它们的value和
writable特性，取而代之的是关心set和get（还有configurable和enumerable）特性</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-comment">// 给a定义一个getter</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">a</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
  },
};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(
  myObject, <span class="hljs-comment">// 目标对象</span>
  <span class="hljs-string">"b"</span>, <span class="hljs-comment">// 属性名</span>
  {
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span> * <span class="hljs-number">2</span>;
    },
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
  },
);

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 2</span>

myObject.<span class="hljs-property">b</span>; <span class="hljs-comment">// 4</span>
</code></pre>
<p>通常getter和setter是成对出现的（只定义一个的话通常会产生意料之外的行为）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-comment">// 给a定义一个getter</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">a</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_a_</span>;
  }

  <span class="hljs-comment">// 给a定义一个setter</span>
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">a</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_a_</span> = val * <span class="hljs-number">2</span>;
  }
}

myObject.<span class="hljs-property">a</span> = <span class="hljs-number">2</span>;

myObject.<span class="hljs-property">a</span>; <span class="hljs-comment">// 4</span>
</code></pre>
<h5 data-id="heading-14">存在性</h5>
<p>当myObject.a的属性访问返回值为undefined时，这个值可能时属性中存储的undefined，也可能是属性不存在而返回undefined。我们可以在不访问属性值的情况下判断对象中是否存在这个属性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
};

<span class="hljs-string">"a"</span> <span class="hljs-keyword">in</span> myObject; <span class="hljs-comment">// true</span>
<span class="hljs-string">"b"</span> <span class="hljs-keyword">in</span> myObject; <span class="hljs-comment">// false</span>

myObject.<span class="hljs-title function_">hasOwnProhaperty</span>(<span class="hljs-string">"a"</span>); <span class="hljs-comment">// true</span>
myObject.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">"b"</span>); <span class="hljs-comment">// false</span>
</code></pre>
<p>in 操作符会检查属性是否在对象及其[[Prototype]]原型链中。</p>
<p>hasOwnproperty(..)只会检查属性是否在myObject对象中，不会检查[[Prototype]]链。</p>
<h6 data-id="heading-15">枚举</h6>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(
  myObject,
  <span class="hljs-string">"a"</span>,
  <span class="hljs-comment">// 让a可枚举</span>
  { <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">2</span> },
);

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(
  myObject,
  <span class="hljs-string">"b"</span>,
  <span class="hljs-comment">// 让b不可枚举</span>
  { <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">3</span> },
);

myObject.<span class="hljs-property">b</span>; <span class="hljs-comment">// 3</span>
<span class="hljs-string">"b"</span> <span class="hljs-keyword">in</span> myObject; <span class="hljs-comment">// true</span>
myObject.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">"b"</span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// .............</span>

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> myObject) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(k, myObject[k]);
} <span class="hljs-comment">// "a" 2</span>
</code></pre>
<p>可以看到myObject.b确实存在并且有访问值，但不会出现在for..in循环中。</p>
<p>也可以通过其他方式来区分属性是否可枚举：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(
  myObject,
  <span class="hljs-string">"a"</span>,
  <span class="hljs-comment">// 让a可枚举</span>
  { <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">2</span> },
);

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(
  myObject,
  <span class="hljs-string">"b"</span>,
  <span class="hljs-comment">// 让b不可枚举</span>
  { <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">3</span> },
);

myObject.<span class="hljs-title function_">propertyIsEnumerable</span>(<span class="hljs-string">"a"</span>); <span class="hljs-comment">// true</span>
myObject.<span class="hljs-title function_">propertyIsEnumerable</span>(<span class="hljs-string">"b"</span>); <span class="hljs-comment">// false</span>

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(myObject); <span class="hljs-comment">// ["a"]</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyNames</span>(myObject); <span class="hljs-comment">// ["a", "b"]</span>
</code></pre>
<h4 data-id="heading-16">遍历</h4>
<p>for..in 循环可以用来遍历对象的可枚举属性列表（包括[[Prototype]]链）</p>
<p>ES6中增加了 for..of 循环语法来遍历数组（如果对象本身定义了迭代器的话也可以遍历对象）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myArray = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> v <span class="hljs-keyword">of</span> myArray) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v);
}
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
</code></pre>
<p>for..of 循环首先会向被访问对象请求一个迭代器对象，然后通过调用迭代器对象的next()方法来遍历所有返回值。</p>
<p>数组内有内置的@@iterator，因此for..of可以直接应用在数组上。我们使用内置的@@iterator来手动遍历数组，看看它是怎么工作的：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myArray = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">var</span> it = myArray[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]();

it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value:1,done:false}</span>
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value:2,done:false}</span>
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value:3,done:false}</span>
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {done:true}</span>
</code></pre>
<p>和数组不同，普通的对象没有内置的@@iterator，所有无法自动完成for..of遍历。之所以要这样做，有许多复杂的原因，不过简单来说这样是为了避免影响未来的对象类型。</p>
<p>我们可以给想遍历的对象定义@@iterator：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> myObject = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">b</span>: <span class="hljs-number">3</span>,
};

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(myObject, <span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>, {
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> o = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">var</span> idx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> ks = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(o);
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">next</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">value</span>: o[ks[idx++]],
          <span class="hljs-attr">done</span>: idx &gt; ks.<span class="hljs-property">length</span>,
        };
      },
    };
  },
});

<span class="hljs-comment">// 手动遍历myObject</span>
<span class="hljs-keyword">var</span> it = myObject[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]();
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value: 2,done: false}</span>
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value: 3,done: false}</span>
it.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// {value: undefined,done: true}</span>

<span class="hljs-comment">// 用for..of遍历myObject</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> v <span class="hljs-keyword">of</span> myObject) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v);
}
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当 AI 学会了写博客：Cursor AI Skill 如何让你的开发效率翻倍]]></title>    <link>https://juejin.cn/post/7603383059151880234</link>    <guid>https://juejin.cn/post/7603383059151880234</guid>    <pubDate>2026-02-06T08:56:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603383059151880234" data-draft-id="7603383059151749162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当 AI 学会了写博客：Cursor AI Skill 如何让你的开发效率翻倍"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-06T08:56:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PTC"/> <meta itemprop="url" content="https://juejin.cn/user/3925713569717248"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当 AI 学会了写博客：Cursor AI Skill 如何让你的开发效率翻倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3925713569717248/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PTC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:56:58.000Z" title="Fri Feb 06 2026 08:56:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    43
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>你有没有想过，写完代码之后，AI 自动帮你把技术博客也写了？</p>
<p>这不是幻想。我在自己的博客系统 <strong>Ink &amp; Code</strong>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fptclove.com%2F" target="_blank" title="https://ptclove.com/" ref="nofollow noopener noreferrer">ptclove.com</a>）上实现了这个能力——通过 Cursor 的 AI Skill 机制，只需一句话，AI 就能分析代码、撰写文章、一键发布。</p>
<p>本文会深入介绍 AI Skill 的实际应用，以及支撑这一切的技术架构：<strong>Next.js 16 + Prisma + Tailwind CSS 4 + Tiptap</strong>。</p>
<h2 data-id="heading-1">什么是 Cursor AI Skill</h2>
<p>AI Skill 是 Cursor IDE 提供的一种扩展机制，本质上是一份 Markdown 格式的指令文件（<code>SKILL.md</code>），告诉 AI 在特定场景下该做什么、怎么做。</p>
<p>与普通的 Prompt 不同，Skill 有几个核心优势：</p>
<ol>
<li><strong>场景触发</strong>：当用户提到"写博客"、"发布文章"时自动激活</li>
<li><strong>结构化流程</strong>：定义清晰的多步骤工作流，而不是一次性提问</li>
<li><strong>工具集成</strong>：可以调用 Shell 脚本、API 接口，实现端到端的自动化</li>
</ol>
<h2 data-id="heading-2">实战：一个自动写博客的 Skill</h2>
<p>我在项目中创建了 <code>.cursor/skills/generate-blog/SKILL.md</code>，定义了博客生成的完整流程：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">generate-blog</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">生成技术博客并发布到</span> <span class="hljs-string">Ink</span> <span class="hljs-string">&amp;</span> <span class="hljs-string">Code</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># 生成博客文章</span>

<span class="hljs-comment">## 工作流程</span>

<span class="hljs-comment">### 1. 确定生成模式</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">commit</span> <span class="hljs-string">模式：根据</span> <span class="hljs-string">Git</span> <span class="hljs-string">提交改动生成</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">topic</span> <span class="hljs-string">模式：根据特定主题生成</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">repo</span> <span class="hljs-string">模式：介绍整个项目</span>

<span class="hljs-comment">### 2. 收集上下文</span>
<span class="hljs-string">根据模式收集相关代码上下文...</span>

<span class="hljs-comment">### 3. 生成博客内容</span>
<span class="hljs-string">撰写高质量技术博客，包含背景、方案、实现、总结...</span>

<span class="hljs-comment">### 4. 发布文章</span>
<span class="hljs-string">使用脚本发布到博客系统：</span>
</code></pre>
<p>关键在于第 4 步——Skill 不仅能生成内容，还能通过 Shell 脚本直接发布：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># publish.sh - 一键发布到博客</span>
TITLE=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
TAGS=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>

<span class="hljs-comment"># 读取内容（支持文件、stdin、剪贴板）</span>
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$CONTENT_FILE</span>"</span> ] &amp;&amp; [ -f <span class="hljs-string">"<span class="hljs-variable">$CONTENT_FILE</span>"</span> ]; <span class="hljs-keyword">then</span>
    CONTENT=$(<span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$CONTENT_FILE</span>"</span>)
<span class="hljs-keyword">elif</span> [ ! -t 0 ]; <span class="hljs-keyword">then</span>
    CONTENT=$(<span class="hljs-built_in">cat</span>)
<span class="hljs-keyword">else</span>
    CONTENT=$(pbpaste 2&gt;/dev/null || <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>)
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 构建 JSON 并调用 API</span>
jq -n --arg title <span class="hljs-string">"<span class="hljs-variable">$TITLE</span>"</span> --arg content <span class="hljs-string">"<span class="hljs-variable">$CONTENT</span>"</span> \
  <span class="hljs-string">'{title: $title, content: $content, published: false}'</span> \
  &gt; /tmp/blog_payload.json

curl -X POST <span class="hljs-string">"<span class="hljs-variable">${INK_AND_CODE_URL}</span>/api/article/create-from-commit"</span> \
  -H <span class="hljs-string">"Authorization: Bearer <span class="hljs-variable">$INK_AND_CODE_TOKEN</span>"</span> \
  -d @/tmp/blog_payload.json
</code></pre>
<p>这意味着从代码变更到文章发布，整个链路都是自动化的。</p>
<h2 data-id="heading-3">更进一步：GitHub Actions + AI 自动发文</h2>
<p>除了本地 Skill，我还配置了 GitHub Actions 实现 CI/CD 级别的博客自动化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/auto-blog.yml</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">generate-blog:</span>
    <span class="hljs-comment"># 只有提交信息包含 [blog] 时才触发</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">contains(github.event.head_commit.message,</span> <span class="hljs-string">'[blog]'</span><span class="hljs-string">)</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Gather</span> <span class="hljs-string">project</span> <span class="hljs-string">context</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          git diff HEAD~1 HEAD &gt; /tmp/commit_diff.txt
          # 收集项目结构、改动文件、配置文件...
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Generate</span> <span class="hljs-string">and</span> <span class="hljs-string">publish</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 将上下文发送给 AI，生成博客
          # 解析标题、内容、标签
          # 调用 API 发布
</span></code></pre>
<p><strong>工作原理</strong>：当我提交代码时，在 commit message 中加上 <code>[blog]</code> 标记，GitHub Actions 会自动收集项目上下文（diff、文件结构、配置文件），调用 DeepSeek/Claude/GPT 生成技术博客，最后通过 API 发布到网站。</p>
<p>整个过程无需人工干预，写完代码，博客就自动出现在网站上了。</p>
<h2 data-id="heading-4">支撑一切的技术架构</h2>
<p>这套自动化能跑通，离不开底层的技术架构。Ink &amp; Code 采用的是 <strong>Next.js 16 + Prisma + Tailwind CSS 4 + Tiptap</strong> 的组合。</p>
<h3 data-id="heading-5">Next.js 16 App Router</h3>
<p>项目使用 Next.js 16 的 App Router 架构，目录结构清晰：</p>
<pre><code class="hljs language-ini" lang="ini">app/
├── api/          <span class="hljs-comment"># API 路由</span>
│   ├── article/  <span class="hljs-comment"># 文章 CRUD</span>
│   ├── chat/     <span class="hljs-comment"># AI 聊天</span>
│   └── auth/     <span class="hljs-comment"># 认证</span>
├── admin/        <span class="hljs-comment"># 后台管理</span>
├── blog/         <span class="hljs-comment"># 博客页面</span>
├── components/   <span class="hljs-comment"># 组件</span>
└── u/<span class="hljs-section">[username]</span>/ <span class="hljs-comment"># 用户主页</span>
</code></pre>
<p>API 路由提供了完整的 RESTful 接口，支持两种认证方式：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Session 认证（用户登录）</span>
<span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> auth();

<span class="hljs-comment">// Token 认证（外部调用，如 GitHub Actions）</span>
<span class="hljs-keyword">const</span> token = request.headers
  .<span class="hljs-keyword">get</span>(<span class="hljs-string">'Authorization'</span>)?.replace(<span class="hljs-string">'Bearer '</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> hashedToken = hashToken(token);
<span class="hljs-keyword">const</span> apiToken = <span class="hljs-keyword">await</span> prisma.apiToken.findUnique({
  <span class="hljs-keyword">where</span>: { tokenHash: hashedToken }
});
</code></pre>
<p>这种双认证机制让博客系统既支持浏览器登录，又支持脚本和 CI/CD 的外部调用。</p>
<h3 data-id="heading-6">Prisma 数据建模</h3>
<p>数据层使用 Prisma ORM，核心模型设计：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">model Post {
  id         String    <span class="hljs-meta">@id</span> <span class="hljs-meta">@default(cuid())</span>
  title      String
  slug       String
  content    String    <span class="hljs-meta">@db</span>.Text  <span class="hljs-comment">// TipTap JSON</span>
  excerpt    String?
  coverImage String?
  published  <span class="hljs-built_in">Boolean</span>   <span class="hljs-meta">@default(false)</span>
  tags       String[]
  sortOrder  <span class="hljs-built_in">Int</span>       <span class="hljs-meta">@default(0)</span>

  user       User      <span class="hljs-meta">@relation(fields: [userId])</span>
  category   Category? <span class="hljs-meta">@relation(fields: [categoryId])</span>

  @<span class="hljs-meta">@unique([userId, slug])</span>
}

model Category {
  id       String     <span class="hljs-meta">@id</span> <span class="hljs-meta">@default(cuid())</span>
  name     String
  slug     String
  icon     String?
  parentId String?    <span class="hljs-comment">// 树形结构</span>
  parent   Category?  <span class="hljs-meta">@relation(<span class="hljs-string">"children"</span>, fields: [parentId])</span>
  children Category[] <span class="hljs-meta">@relation(<span class="hljs-string">"children"</span>)</span>

  @<span class="hljs-meta">@unique([userId, slug])</span>
}
</code></pre>
<p>文章内容以 TipTap JSON 格式存储，而非原始 Markdown。这意味着从外部（如 GitHub Actions）提交的 Markdown 内容需要经过转换：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// lib/markdown-to-tiptap.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">markdownToTiptap</span>(<span class="hljs-params">markdown: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">doc</span>: <span class="hljs-title class_">TiptapDoc</span> = { <span class="hljs-attr">type</span>: <span class="hljs-string">'doc'</span>, <span class="hljs-attr">content</span>: [] };
  <span class="hljs-keyword">const</span> lines = markdown.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);

  <span class="hljs-keyword">while</span> (i &lt; lines.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">const</span> line = lines[i];
    <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'```'</span>)) {
      <span class="hljs-comment">// 代码块 → codeBlock 节点</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^#{1,6}\s/</span>)) {
      <span class="hljs-comment">// 标题 → heading 节点</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^\d+.\s/</span>)) {
      <span class="hljs-comment">// 有序列表 → orderedList 节点</span>
    }
    <span class="hljs-comment">// ...更多格式处理</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(doc);
}
</code></pre>
<h3 data-id="heading-7">Tiptap 富文本编辑器</h3>
<p>后台管理使用 Tiptap 作为编辑器，支持丰富的内容格式：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> editor = <span class="hljs-built_in">useEditor</span>({
  extensions: [
    StarterKit,
    CodeBlockLowlight.<span class="hljs-built_in">configure</span>({
      lowlight  <span class="hljs-comment">// 代码高亮</span>
    }),
    Image,           <span class="hljs-comment">// 图片</span>
    Link,            <span class="hljs-comment">// 链接</span>
    Table,           <span class="hljs-comment">// 表格</span>
    Placeholder.<span class="hljs-built_in">configure</span>({
      placeholder: <span class="hljs-string">'开始写作...'</span>
    }),
  ],
});
</code></pre>
<p>编辑器还实现了自动保存、快捷键（Cmd+S）、图片上传（阿里云 OSS）等实用功能。</p>
<h3 data-id="heading-8">Tailwind CSS 4</h3>
<p>样式层使用最新的 Tailwind CSS 4，通过 CSS 变量实现主题切换：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--color-primary</span>: <span class="hljs-number">#b8860b</span>;
  <span class="hljs-attr">--color-background</span>: <span class="hljs-number">#faf8f5</span>;
  <span class="hljs-attr">--color-foreground</span>: <span class="hljs-number">#1a1a1a</span>;
}

<span class="hljs-selector-attr">[data-theme=<span class="hljs-string">'dark'</span>]</span> {
  <span class="hljs-attr">--color-primary</span>: <span class="hljs-number">#d4a537</span>;
  <span class="hljs-attr">--color-background</span>: <span class="hljs-number">#1a1a1a</span>;
  <span class="hljs-attr">--color-foreground</span>: <span class="hljs-number">#e8e8e8</span>;
}
</code></pre>
<p>配合 ThemeProvider 组件，实现了丝滑的明暗主题切换。</p>
<h2 data-id="heading-9">Ink &amp; Code 核心功能一览</h2>
<p>除了上面提到的技术架构，<a href="https://link.juejin.cn?target=https%3A%2F%2Fptclove.com%2F" target="_blank" title="https://ptclove.com/" ref="nofollow noopener noreferrer">ptclove.com</a> 还有这些核心功能：</p>
<ul>
<li><strong>AI 助手</strong>：内置 AI 聊天组件，基于 DeepSeek 实时流式响应，随时提问</li>
<li><strong>智能目录</strong>：自动从文章标题生成目录树，支持大标题折叠子标题、滚动高亮、点击跳转</li>
<li><strong>分类体系</strong>：支持树形分类结构，多层级管理文章</li>
<li><strong>文档树管理</strong>：后台采用树形文档管理，拖拽排序，所见即所得</li>
<li><strong>多用户支持</strong>：每个用户有独立主页（<code>/u/username</code>），独立分类和文章</li>
<li><strong>深色模式</strong>：跟随系统或手动切换，全站适配</li>
<li><strong>响应式设计</strong>：从手机到桌面端完美适配</li>
<li><strong>一键部署</strong>：GitHub Actions 自动构建、SSH 部署到服务器，PM2 进程管理</li>
</ul>
<h2 data-id="heading-10">总结</h2>
<p>Cursor AI Skill 的价值不在于它是一个多高深的技术，而在于它提供了一种思路：<strong>让 AI 不只是回答问题，而是融入你的工作流</strong>。</p>
<p>在 Ink &amp; Code 这个项目中，AI Skill 串联了从代码提交到博客发布的完整链路。而 Next.js + Prisma + Tiptap + Tailwind 这套技术栈，则提供了足够灵活的底层能力来支撑这种自动化。</p>
<p>如果你也想体验 AI 驱动的博客写作，欢迎访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fptclove.com%2F" target="_blank" title="https://ptclove.com/" ref="nofollow noopener noreferrer">ptclove.com</a> ，也欢迎在评论区交流你的 AI Skill 实践。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android稀奇古怪DNS异常之DNS数据获取]]></title>    <link>https://juejin.cn/post/7603383059152044074</link>    <guid>https://juejin.cn/post/7603383059152044074</guid>    <pubDate>2026-02-06T09:09:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603383059152044074" data-draft-id="7603301285476188202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android稀奇古怪DNS异常之DNS数据获取"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-06T09:09:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没有了遇见"/> <meta itemprop="url" content="https://juejin.cn/user/1521379826212983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android稀奇古怪DNS异常之DNS数据获取
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379826212983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没有了遇见
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:09:11.000Z" title="Fri Feb 06 2026 09:09:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b71a09fcc8a54a0e8e1f0b68a18444bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5pyJ5LqG6YGH6KeB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973751&amp;x-signature=6FfG0n8Y0Ap8O8FjFUtGbTV7wEs%3D" alt="image.png" loading="lazy"/></p>
<p>接着处理稀奇古怪问题之DNS异常导致网络不通!!!!</p>
<p>部分用户访问不通,后台说DNS问题,这不需求就来了.要求Android 搜集DNS数据,方便后台查询.....</p>
<h2 data-id="heading-0">需求:获取DNS数据和后台相应数据</h2>
<h2 data-id="heading-1">思路</h2>
<ul>
<li>获取网络配置中的DNS配置</li>
<li>获取网络请求时的DNS/HOST/响应的数据</li>
</ul>
<h2 data-id="heading-2">1:获取网络配置的DNS数据</h2>
<p><code>注意:</code></p>
<p>需要<code>&lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/&gt;</code> 权限</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 获取当前 WiFi 路由器或系统 DNS 服务器列表
 * <span class="hljs-doctag">@param</span> context Context
 * <span class="hljs-doctag">@return</span> List&lt;String&gt; DNS IP 列表
 */</span>


<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDnsServers</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: List&lt;String&gt; {
    <span class="hljs-keyword">val</span> connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) <span class="hljs-keyword">as</span> ConnectivityManager
    <span class="hljs-keyword">val</span> activeNetwork = connectivityManager.activeNetwork ?: <span class="hljs-keyword">return</span> emptyList()
    <span class="hljs-keyword">val</span> linkProperties = connectivityManager.getLinkProperties(activeNetwork) ?: <span class="hljs-keyword">return</span> emptyList()

    <span class="hljs-comment">// 获取 InetAddress 列表并转换为字符串</span>
    <span class="hljs-keyword">return</span> linkProperties.dnsServers.map { formatDnsType(it)}
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">formatDnsType</span><span class="hljs-params">(addr: <span class="hljs-type">InetAddress</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> type = <span class="hljs-keyword">when</span> (addr) {
        <span class="hljs-keyword">is</span> Inet4Address -&gt; <span class="hljs-string">"ipv4--&gt; "</span>
        <span class="hljs-keyword">is</span> Inet6Address -&gt; <span class="hljs-string">"ipv6--&gt; "</span>
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"unknown--&gt; "</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">"<span class="hljs-variable">$type</span>:<span class="hljs-subst">${addr.hostAddress}</span>"</span>
}
</code></pre>
<h2 data-id="heading-3">2:获取网络请求的响应以及DNS数据</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">DnsCheckCallback</span> {
    <span class="hljs-comment">/** 域名解析结果 */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDnsResolved</span><span class="hljs-params">(hostname: <span class="hljs-type">String</span>, ipList: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span>

    <span class="hljs-comment">/** HTTP 请求响应 */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onHttpResponse</span><span class="hljs-params">(code: <span class="hljs-type">Int</span>, body: <span class="hljs-type">String</span>)</span></span>

    <span class="hljs-comment">/** 请求或解析失败 */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(t: <span class="hljs-type">Throwable</span>)</span></span>
}

<span class="hljs-comment">/**
 * 使用系统 DNS 请求指定 URL 并通过回调返回 DNS 和 HTTP 信息
 * <span class="hljs-doctag">@param</span> url 请求的完整 URL，例如 https://xxx.xx.com  测试的域名
 * <span class="hljs-doctag">@param</span> callback 回调
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkDns</span><span class="hljs-params">(
    url: <span class="hljs-type">String</span>,
    callback: <span class="hljs-type">DnsCheckCallback</span>
)</span></span> {
    <span class="hljs-keyword">val</span> client = OkHttpClient.Builder()
        .dns(<span class="hljs-keyword">object</span> : Dns {
            <span class="hljs-meta">@Throws(UnknownHostException::class)</span>
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">lookup</span><span class="hljs-params">(hostname: <span class="hljs-type">String</span>)</span></span>: List&lt;InetAddress&gt; {
                <span class="hljs-keyword">val</span> addresses = Dns.SYSTEM.lookup(hostname)

                <span class="hljs-comment">// 回调 DNS 解析结果</span>
                <span class="hljs-keyword">val</span> ipList = addresses.map { hostname+<span class="hljs-string">" ---&gt; "</span>+formatDnsType(it) }
                callback.onDnsResolved(hostname, ipList)

                <span class="hljs-keyword">return</span> addresses
            }
        })
        .build()

    <span class="hljs-keyword">val</span> request = Request.Builder()
        .url(url)
        .<span class="hljs-keyword">get</span>()
        .build()

    client.newCall(request).enqueue(<span class="hljs-keyword">object</span> : Callback {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, e: <span class="hljs-type">IOException</span>)</span></span> {
            callback.onFailure(e)
        }

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, response: <span class="hljs-type">Response</span>)</span></span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> body = response.body?.string() ?: <span class="hljs-string">""</span>
                callback.onHttpResponse(response.code, body)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                callback.onFailure(e)
            }
        }
    })
}
</code></pre>
<h2 data-id="heading-4">3: 获取工具</h2>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.net.ConnectivityManager
<span class="hljs-keyword">import</span> android.net.wifi.WifiManager
<span class="hljs-keyword">import</span> android.os.Build
<span class="hljs-keyword">import</span> android.util.Log
<span class="hljs-keyword">import</span> okhttp3.*
<span class="hljs-keyword">import</span> java.io.IOException
<span class="hljs-keyword">import</span> java.net.Inet4Address
<span class="hljs-keyword">import</span> java.net.Inet6Address
<span class="hljs-keyword">import</span> java.net.InetAddress
<span class="hljs-keyword">import</span> java.net.UnknownHostException

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Author</span>: wkq
 * <span class="hljs-doctag">@Time</span>: 2026/2/6 12:15
 * <span class="hljs-doctag">@Desc</span>: 使用 OkHttp 请求指定 URL 并通过回调返回 DNS 和 HTTP 信息（简化版，只用系统 DNS）
 */</span>
<span class="hljs-keyword">object</span> DnsCheckUtil {

    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DnsCheckCallback</span> {
        <span class="hljs-comment">/** 域名解析结果 */</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDnsResolved</span><span class="hljs-params">(hostname: <span class="hljs-type">String</span>, ipList: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span>

        <span class="hljs-comment">/** HTTP 请求响应 */</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onHttpResponse</span><span class="hljs-params">(code: <span class="hljs-type">Int</span>, body: <span class="hljs-type">String</span>)</span></span>

        <span class="hljs-comment">/** 请求或解析失败 */</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(t: <span class="hljs-type">Throwable</span>)</span></span>
    }

    <span class="hljs-comment">/**
     * 使用系统 DNS 请求指定 URL 并通过回调返回 DNS 和 HTTP 信息
     * <span class="hljs-doctag">@param</span> url 请求的完整 URL，例如
     * <span class="hljs-doctag">@param</span> callback 回调
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkDns</span><span class="hljs-params">(
        url: <span class="hljs-type">String</span>,
        callback: <span class="hljs-type">DnsCheckCallback</span>
    )</span></span> {
        <span class="hljs-keyword">val</span> client = OkHttpClient.Builder()
            .dns(<span class="hljs-keyword">object</span> : Dns {
                <span class="hljs-meta">@Throws(UnknownHostException::class)</span>
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">lookup</span><span class="hljs-params">(hostname: <span class="hljs-type">String</span>)</span></span>: List&lt;InetAddress&gt; {
                    <span class="hljs-keyword">val</span> addresses = Dns.SYSTEM.lookup(hostname)

                    <span class="hljs-comment">// 回调 DNS 解析结果</span>
                    <span class="hljs-keyword">val</span> ipList = addresses.map { hostname+<span class="hljs-string">" ---&gt; "</span>+formatDnsType(it) }
                    callback.onDnsResolved(hostname, ipList)

                    <span class="hljs-keyword">return</span> addresses
                }
            })
            .build()

        <span class="hljs-keyword">val</span> request = Request.Builder()
            .url(url)
            .<span class="hljs-keyword">get</span>()
            .build()

        client.newCall(request).enqueue(<span class="hljs-keyword">object</span> : Callback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, e: <span class="hljs-type">IOException</span>)</span></span> {
                callback.onFailure(e)
            }

            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, response: <span class="hljs-type">Response</span>)</span></span> {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> body = response.body?.string() ?: <span class="hljs-string">""</span>
                    callback.onHttpResponse(response.code, body)
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    callback.onFailure(e)
                }
            }
        })
    }


    <span class="hljs-comment">/**
     * 获取当前 WiFi 路由器或系统 DNS 服务器列表
     * <span class="hljs-doctag">@param</span> context Context
     * <span class="hljs-doctag">@return</span> List&lt;String&gt; DNS IP 列表
     */</span>


    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDnsServers</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: List&lt;String&gt; {
        <span class="hljs-keyword">val</span> connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) <span class="hljs-keyword">as</span> ConnectivityManager
        <span class="hljs-keyword">val</span> activeNetwork = connectivityManager.activeNetwork ?: <span class="hljs-keyword">return</span> emptyList()
        <span class="hljs-keyword">val</span> linkProperties = connectivityManager.getLinkProperties(activeNetwork) ?: <span class="hljs-keyword">return</span> emptyList()

        <span class="hljs-comment">// 获取 InetAddress 列表并转换为字符串</span>
        <span class="hljs-keyword">return</span> linkProperties.dnsServers.map { formatDnsType(it)}
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">formatDnsType</span><span class="hljs-params">(addr: <span class="hljs-type">InetAddress</span>)</span></span>: String {
        <span class="hljs-keyword">val</span> type = <span class="hljs-keyword">when</span> (addr) {
            <span class="hljs-keyword">is</span> Inet4Address -&gt; <span class="hljs-string">"ipv4--&gt; "</span>
            <span class="hljs-keyword">is</span> Inet6Address -&gt; <span class="hljs-string">"ipv6--&gt; "</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"unknown--&gt; "</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"<span class="hljs-variable">$type</span>:<span class="hljs-subst">${addr.hostAddress}</span>"</span>
    }

}
</code></pre>
<h2 data-id="heading-5">总结</h2>
<p>DNS污染/VPN/运营商拉黑都会导致域名指向不对,这种问题需要前后端配合处理,暂时只进展到了DNS数据查询,后续有处理的相关进展会伴随更新</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MaxCompute Autoscale自动弹性功能上线：资源随需而动，成本精打细算]]></title>    <link>https://juejin.cn/post/7603308967125942272</link>    <guid>https://juejin.cn/post/7603308967125942272</guid>    <pubDate>2026-02-06T09:12:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603308967125942272" data-draft-id="7603355275257708584" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MaxCompute Autoscale自动弹性功能上线：资源随需而动，成本精打细算"/> <meta itemprop="keywords" content="大数据,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T09:12:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MaxCompute Autoscale自动弹性功能上线：资源随需而动，成本精打细算
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:12:09.000Z" title="Fri Feb 06 2026 09:12:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在云原生数据仓库的演进过程中，如何在<strong>保障作业SLA</strong>与<strong>优化资源成本</strong>之间取得平衡，始终是用户关注的核心问题。传统静态资源配置模式难以应对现代数据作业中普遍存在的<strong>突发性、非周期性、不可预测性</strong>负载特征。</p>
<p>MaxCompute 全新推出 <strong>自动弹性（Autoscale）功能</strong>——基于实时负载感知的秒级弹性扩缩容机制，结合按量计费模型，实现计算资源供给与业务需求的动态对齐。</p>
<h2 data-id="heading-0">一、背景：从静态预留到智能弹性</h2>
<p>过去，MaxCompute 用户主要依赖 <strong>包年包月预留资源</strong>：稳定可靠，但缺乏灵活性；面对突发需求，只能提前大量采购，造成大量闲置。</p>
<p>后来，基于推出的<strong>弹性预留</strong> 模式：用户可自定义时间计划和扩缩规则，适用于有明显周期性波动的场景（如每天凌晨跑批）。但这也要求用户具备较强的运维能力，且难以应对突发或不规则的负载变化。</p>
<p>现在，MaxCompute 全新推出 <strong>自动弹性（Autoscale）功能</strong> —— 通过系统的负载感知与调度策略，实现“无感扩缩”，填补了<strong>非稳态、高动态</strong>场景下的资源管理空白，真正做到“用多少，付多少”。</p>





























<table><thead><tr><th><strong>资源类型</strong></th><th><strong>扩缩机制</strong></th><th><strong>计费模型</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>包年包月预留</td><td>固定CU，长期持有</td><td>为购买量付费</td><td>负载稳定、无波动</td></tr><tr><td>弹性预留</td><td>用户自定义时间/CU规则扩缩</td><td>按用户分时配置的固定CU量计费</td><td>周期性波动、峰谷可预测、用户有精细化配置经验</td></tr><tr><td><strong>自动弹性</strong></td><td><strong>系统实时感知负载后自动扩缩容</strong></td><td><strong>按实际用量和使用时长付费</strong></td><td><strong>波动频繁、不可预测，追求成本效率</strong></td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cbbfef6d0ef43208687820584bf3eb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973929&amp;x-signature=YN8OMbza5jn8v5DuTU0UMJ6gFCg%3D" alt="5eecdaf48460cde50899366ff2de297027d88596f71c45df75b8339e1c4c2483d73fcbd75708105f8d68742cd653602a15464a86392b1bf5bbb40cca91051d59fb518341bbcfc52040cf883a4fe865182fc27d1bdab16641220e3dd3b60b5d1e.png" loading="lazy"/></p>
<p>三者可组合使用：以包年包月为基础保障，弹性预留应对可预测高峰，自动弹性兜底突发流量，构建MaxCompute Serverless 弹性资源体系。</p>
<h2 data-id="heading-1">二、自动弹性核心优势</h2>
<h3 data-id="heading-2">1. 开箱即用，低运维负担</h3>
<ul>
<li>
<p>用户只需设置 <code>AutoscaleLimitCU</code>（自动弹性上限），系统自动完成扩缩决策；</p>
</li>
<li>
<p>支持一级/二级 Quota 粒度配置，二级 Quota 共享一级自动弹性CU资源池，自动分配。</p>
</li>
</ul>
<h3 data-id="heading-3">2. 按需供给，按量计费</h3>
<ul>
<li>
<p>仅对实际使用的自动弹性CU（<code>AutoscaleUsedCU</code>）用量按秒计量，按小时统计出账；</p>
</li>
<li>
<p>单价：<strong>0.36元 / (CU·时)</strong>，无需预付，无最低消费。</p>
</li>
</ul>
<h3 data-id="heading-4">3. 秒级响应，保障作业SLA</h3>
<ul>
<li>
<p>相比小时级调度窗口，自动弹性支持<strong>秒级资源调整</strong>，有效应对突发作业排队；</p>
</li>
<li>
<p>后端基于历史负载与预测模型优化库存保障和资源调度，提升弹性资源可用性。</p>
</li>
</ul>
<p>⚠️ 注意：自动弹性依赖实时资源库存，无法100%保证极端突发场景下的资源可达性。对于强SLA要求场景（如大促），建议<strong>同步配置弹性预留</strong>作为资源兜底。</p>
<h2 data-id="heading-5">三、真实场景案例</h2>
<h3 data-id="heading-6">场景一：突发业务高峰下的作业SLA保障</h3>
<p>某电商平台客户，日常使用 <strong>50 CU 包年包月Quota</strong>，足以支撑日常数据加工分析任务。但每逢大促，作业量激增3倍，原有资源严重不足，作业排队超2小时，严重影响数据产出时效。</p>
<p>客户曾评估扩容包年包月Quota至150 CU，但大促仅占全年不到20%的时间，全年多花<strong>约18万元</strong>，长期持有高配资源性价比极低。</p>
<p><strong>启用 Autoscale 后</strong>：</p>
<ul>
<li>
<p>设置 自动弹性上限 AutoscaleLimit 为 <strong>100 CU</strong>（即最多可额外使用100 CU自动弹性CU）</p>
</li>
<li>
<p>系统在检测到作业队列积压后，<strong>秒级自动扩容，</strong> 动态将可用CU提升至140CU（50 CU包年包月 + 90CU自动弹性），作业完成时间恢复至30分钟内，满足业务SLA要求；</p>
</li>
</ul>
<p>“以前不敢做大促实时分析，现在敢了，而且花得更少！” —— 客户反馈</p>
<h3 data-id="heading-7">场景二：替代分时弹性，实现降本增效</h3>
<p>某金融客户每日需执行大量 T+1 批处理任务，用于全量交易对账、监管报送数据聚合等，长期采用 <strong>分时弹性预留策略</strong>：每日22:00–6:00 时段将 Quota 从 包月预留 50 CU 扩容至 100 CU。</p>
<p>但时常因业务活动、节假日调休、系统割接活上游产出延迟等，常出现“资源空转”或“容量不足”并存的问题，运维团队需频繁调整弹性计划，但人工干预滞后性强，且易出错。</p>
<p><strong>切换至 Autoscale 后</strong>：</p>
<ul>
<li>
<p>设置自动弹性上限 AutoscaleLimitCU 为 <strong>60 CU</strong> ，允许系统在 50 – 110 CU 范围内动态扩缩；</p>
</li>
<li>
<p>系统根据实际作业队列动态调整弹性CU，夜间平均仅使用 <strong>30 CU</strong> 自动弹性资源；</p>
</li>
<li>
<p>月度弹性费用从分时弹性CU <strong>3780元</strong> （50CU *0.315元/CU*8小时*30天）降至 <strong>2592元</strong>（30CU *0.36元/CU*小时*8小时*30天），<strong>降本32%</strong>，且作业完成时间更稳定。</p>
</li>
</ul>
<p>“不用再熬夜调配置了，系统自己会‘看饭下菜’！” —— 运维工程师点赞</p>
<h2 data-id="heading-8">四、快速启用</h2>
<h3 data-id="heading-9">概念说明</h3>
<p>自动弹性上限CU（AutoscalelimitCU）：指用户为Quota设置的弹性CU资源总上限。当该值 &gt; 0 时，则为启用自动弹性功能，系统可在此上限范围内按实际负载自动扩缩容。自动弹性使用CU（AutoscaleUsedCU）：指在启用自动弹性后，Quota中实际消耗的自动弹性CU资源使用量。系统将根据作业负载自动调整CU用量，并按此实际CU使用量计费。</p>
<h3 data-id="heading-10">使用须知</h3>
<p><strong>前提条件</strong>：必须已购买<strong>包年包月计算资源Quota</strong>；<strong>计费单位</strong>：CU·时，按秒采样、按小时聚合；<strong>自动弹性CU价格</strong>：0.36元 /(CU*时)；<strong>计费公式：</strong> 每小时的费用 = 该小时自动弹性CU用量（单位：CU*时）× 自动弹性CU价格。</p>
<h3 data-id="heading-11">谁适合用自动弹性？</h3>
<p>✅ <strong>业务负载波动频繁、难以预测</strong>（如营销活动、临时分析）
✅ <strong>希望保障作业性能，同时避免资源浪费</strong>
✅ <strong>已有包年包月Quota，想进一步补充/优化弹性资源</strong></p>
<p>登录 MaxCompute 控制台 → Quota管理 → 编辑基础配置 → 设置 <strong>AutoscaleLimitCU</strong></p>
<p>即可开启智能弹性之旅！</p>
<p>更多说明文档请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fmaxcompute%2Fuse-cases%2Fauto-elastic-usage-best-practices%3Fspm%3Da2c4g.11174283.help-menu-search-27797.d_0" target="_blank" title="https://help.aliyun.com/zh/maxcompute/use-cases/auto-elastic-usage-best-practices?spm=a2c4g.11174283.help-menu-search-27797.d_0" ref="nofollow noopener noreferrer">help.aliyun.com/zh/maxcompu…</a></p>
<h2 data-id="heading-12">五、总结</h2>
<p>自动弹性不是简单的“资源扩容”，而是 MaxCompute 在<strong>智能调度、成本治理、SLA保障</strong>三位一体方向上的重要演进。它让资源管理从“静态规划”走向“动态协同”，真正实现“<strong>用多少，付多少；要多少，给多少</strong>”。</p>
<p>欢迎您的试用并反馈您的生产实践。我们将持续优化弹性调度算法与资源保障能力，助力企业构建更高效、更经济的云原生数据基础设施。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI时代的开发者，需要的是“判断空间”]]></title>    <link>https://juejin.cn/post/7603309951227461682</link>    <guid>https://juejin.cn/post/7603309951227461682</guid>    <pubDate>2026-02-06T09:13:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227461682" data-draft-id="7603359026711314442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI时代的开发者，需要的是“判断空间”"/> <meta itemprop="keywords" content="后端,前端,程序员"/> <meta itemprop="datePublished" content="2026-02-06T09:13:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东东拿铁"/> <meta itemprop="url" content="https://juejin.cn/user/3808364011728392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI时代的开发者，需要的是“判断空间”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364011728392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东东拿铁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:13:59.000Z" title="Fri Feb 06 2026 09:13:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">引言</h3>
<p>在AI进展突飞猛进的今天，我的工作方式已经悄悄发生了许多改变。</p>
<p>比如，我花在“写代码”上的时间在变的越来越少，花在“判断方向、判断结果、判断是否符合预期”上的时间，却在明显变多。</p>
<p>代码本身，已经不再是最消耗精力的部分。</p>
<p>真正让人感到疲惫的，是不断地确认：</p>
<p>AI 给出的东西，是不是我想要的那个方向。</p>
<p>也正是在这样的工作状态下，我开始重新审视一些以前习以为常的工具——</p>
<p>比如，一台每天陪我坐在桌子前的显示器。</p>
<h3 data-id="heading-1">当“看”成为主要工作，屏幕就不再是背景</h3>
<p>在 AI 参与开发之后，我花在“看”上的时间，远比以前多。</p>
<p>看模型生成的代码结构是否合理，看逻辑有没有在某个分支上走偏，看它是不是在解决我真正想解决的问题。</p>
<p>在这个过程中，屏幕不再只是一个承载代码的背景，而是我理解信息的第一道过滤器。</p>
<p>如果屏幕本身在颜色、反光、层级上给我制造干扰，那判断就会变得更慢，也更容易出错。</p>
<p>这次我体验到了BenQ RD280UG这款产品，就是一台专为开发者设计的显示器：</p>
<p>3:2 的屏幕比例，把更多空间留给阅读和判断；针对深色、浅色 IDE 的专业编程模式，让代码层级更容易被识别；这次还升级了编程-彩纸模式和120Hz的高刷，让反复查看、对照不那么疲惫；</p>
<p>这些特性在 AI 时代，当“判断”成为我们的主要工作时，我发现它们开始变得很重要。</p>
<h3 data-id="heading-2">编程模式，其实是为“判断”服务的</h3>
<p>BenQ RD280UG提供了编程专用的色彩模式，针对高频使用的Idea、Vs Code等IDE主题环境，提供了深色、亮色两种主题模式。</p>
<p>在编程模式下，通过智能优化语法高亮，对多种代码元素进行色温，色彩，对比度的专项优化，极大的凸现了代码字符清晰度，提高代码区分度。</p>
<p>在面对 AI 生成的代码时，让不同层级的信息，在第一眼就能被区分出来，在当下的开发模式下，正在变得越来越重要。</p>
<p>我现在还不能完全信任AI的代码，因此需要快速判断：</p>
<ul>
<li>哪一段是关键逻辑</li>
<li>哪些地方需要我进一步介入</li>
</ul>
<p>也正是在这样的工作状态下，我重新理解了所谓的“编程模式”。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0aeee4b52aa451ba53a614fbdff054e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=Cqj5KTI5ldekYKWcjCK2LAHBAxI%3D" alt="2E0ED2A5-C2E1-4252-AD5E-72A871182CF6.jpg" loading="lazy"/>
(左侧是开启深色主题，右侧是不开深色主题)</p>
<p>当屏幕能够针对深色、浅色 IDE 做出适配，强化语义和结构差异时，判断这件事本身，就会变得更直接一些。</p>
<p>不是更快，而是更少绕路。</p>
<p>在AI时代，分屏工作已经成为了常态。</p>
<p>或许是一边看着文档，一边用大模型进行提问和总结，也可能是一边开着IDE开发，另一侧打开系统实时调试。</p>
<p>BenQ RD280UG采用3:2的屏幕比例，相比传统的16:9比例，提供了更大的垂直空间，能够在同一时间多显示约20%的内容， 非常适合编程和代码阅读。据我实际计算，16:9在我正常的工作模式下，可以展示40行代码，但是使用RD280UG可以展示50行。</p>
<p>不但如此，还提供了双色彩显示增强版，在分屏模式下，可以单独设置显示模式。</p>
<p>比如我在IDEA里面设置编码模式，而在浏览器里面设置M-Book模式，无论你的注意力在哪，都能让你感受到最好的体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d5d42913bb644e6beb5b967e545ed28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=CKdGrolKElBu3fXPeGXgye%2Bjrh4%3D" alt="3C2B0B4A-63DC-47BF-AD9C-C42C186E20F3.jpg" loading="lazy"/>
(左侧是开启电子书模式，右侧是深色编程模式)</p>
<h3 data-id="heading-3">彩纸模式</h3>
<p>RD280UG 这次新升级了一个编程模式——彩纸模式。</p>
<p>光看名字，我一开始把它理解成了某一种护眼模式，但是这一段时间体验下来，却成了我最常用的设置。</p>
<p>深色编程模式固然适合编码，可我们并不是所有时间，我都处在高强度判断和输出的状态。</p>
<p>有些时候，我只是想慢慢读一份技术规范，或者AI或者技术相关的文档；</p>
<p>也有些时候，是在晚上翻开一本电子书。</p>
<p>这类阅读，和写代码是完全不同的节奏。</p>
<p>如果屏幕依然保持着高对比、强刺激的显示风格，大脑会不自觉地被推向“赶紧处理完”的状态。</p>
<p>当我想慢下来看点东西的时候，我反而会切到彩纸模式。</p>
<p>RD280UG会自动调节色温和背景亮度，优化字符和底色的对比关系，最终让我有了一种更接近纸张阅读的观感。</p>
<p>很抱歉这里无法放出一个实际的效果图，相机拍出来的效果无法和眼睛相比，但是眼睛是不会骗人的，这里只有亲身体会才能看出区别。</p>
<p>但在需要耐心消化信息、允许自己慢下来阅读的时候，</p>
<p>彩纸模式能帮我完成一次状态切换——</p>
<p>从“马上判断”，切换到“先理解再说”。</p>
<p>而在 AI 不断生成内容的当下，从这种从输出节奏中抽离出来，帮助自己重新回到阅读本身的能力，不应该被忽视。</p>
<h3 data-id="heading-4">120Hz 高刷，是让反复确认没那么累</h3>
<p>这次升级到 120Hz，我的感受并不激烈。</p>
<p>它不会让我在某个瞬间意识到“升级了”，</p>
<p>但在长时间反复确认的过程中，它的存在感会慢慢显现出来。</p>
<p>比如这一次AI重构代码，一个文件有十几处改动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68f684e349474e21a392cc3a92088e7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=30NUQZArnDN5mRn8mBtyrla%2Bhuc%3D" alt="5CABD2D3-078F-4928-BFFB-482EC8D60531.png" loading="lazy"/>
在滚动长段代码、频繁跳转文件、来回比对结果时，120Hz 的高刷新率能让页面滚动和窗口拖拽的动画极其流畅，几乎没有拖影或跳跃感。</p>
<p>传统的60Hz屏幕在显示快速运动的画面时，可能会产生微小的闪烁或模糊，长时间观看容易导致眼睛疲劳、干涩甚至头痛。</p>
<p>这种流畅的视觉感受，能够有效缓解视觉压力，对于需要长时间面对屏幕的程序员至关重要。</p>
<h2 data-id="heading-5">保护双眼</h2>
<p>对做过飞秒手术的我来说，我对屏幕非常敏感。</p>
<p>白天还好，一旦到了晚上，尤其是只剩屏幕亮着的时候，</p>
<p>眼睛很容易开始不舒服——酸、胀、干，甚至会不自觉地流泪。</p>
<p>这种感觉更像是眼睛在提醒我：它已经扛不住这种夜晚的刺激了。</p>
<p>也正因为这样，我对显示器的护眼设计，其实一直很在意。</p>
<p>不是为了参数，而是为了能不能多坐一会。</p>
<p>RD 280UG在护眼这件事上，算是长期投入的一条线：无频闪、硬件级低蓝光、抗反射这些设计，再加上多项莱茵认证和智慧调光的专利。</p>
<p>就拿抗反射来说，是展示屏幕实力的重要体现。</p>
<p>BenQ RD280UG 在这点上做到了极致，面板全部覆盖了抗反射涂层，并且通过了TUV莱茵抗反射认证。</p>
<p>无论是白天窗外刺眼的阳光，还是深夜桌面上的台灯，屏幕就像是可以“吸光”一般，把影响降到最低，让你几乎看不到反射的东西。</p>
<p>即使我拿着手电去直接照射屏幕，屏幕也几乎没有影响，而我的Macbook Pro就像镜子一般，被照射的地方什么也看不到了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da74725ef3f446d8b1fe090873bdc1ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=aN%2Fju2xYy5nHyCOIQwqXisWw3ms%3D" alt="6A389846-A7BE-4AD7-B3A3-E16AA8C4F3DD.jpg" loading="lazy"/>
它们更多是在你意识不到的时候，默默把对你的影响降低。</p>
<p>我印象最深的，是它的夜间保护模式，也就是“猫头鹰模式”。</p>
<p>这个模式听名字就知道，很明显是为夜晚使用设计的。</p>
<p>毕竟只有等孩子睡了的那段时间，才是真正属于自己的。</p>
<p>在环境光非常低的情况下，它会通过固件调节，把亮度和色彩压到一个非常克制的水平。</p>
<p>即使深夜长时间看屏幕，眼睛不再需要在极暗和极亮之间反复适应。</p>
<p>对我来说，最直观的变化就是：</p>
<p>深夜工作时，眼睛干涩的情况明显缓解了，不会那么快产生“必须停下来”的信号。</p>
<p>另外一个很实用的细节是，当前是否开启了低蓝光、夜间模式，都会直接显示在屏幕下方。不用反复进菜单确认，这一点在晚上其实特别省心。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4d9ab2c78f9435aa7fc194dfc2d3578~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=d43rSnFfnZus3Co5mjNRjDv4F0I%3D" alt="DB4C3D9C-5607-4223-8025-F98C7DCAB7EF.jpg" loading="lazy"/></p>
<h3 data-id="heading-6">让屏幕设置更顺手</h3>
<p>说到调节显示器，很多人应该都有类似的经历：</p>
<p>为了调亮度、换模式，在显示器背后摸来摸去，一不小心还会按错键。</p>
<p>我以前一直觉得这件事挺反直觉的——</p>
<p>明明是很日常的操作，却非要通过实体按键完成。</p>
<p>RD 系列在软硬件结合这件事上，给了一个完美答案。</p>
<p>通过配套的 Display Pilot 2，很多原本需要在屏幕上折腾半天的设置，</p>
<p>现在都可以在软件里直接完成。</p>
<p>像显示模式切换、快捷键控制、桌面分区这些常用功能，都能集中在一个地方调好。</p>
<p>甚至可以按照自己的节奏，给不同时间段设定不同的工作流。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a253c09756b446ba39ccd7d2ebe66a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=j7YgfVy11rRLkDqcW4cLoSFE7ys%3D" alt="D924443D-DBA6-46E7-A3BD-8B21509E9EFD.png" loading="lazy"/>
我现在觉着最有用的工作流，是晚上十点半启动，把屏幕的色彩模式调成电子书模式。</p>
<p>屏幕显示成电子书模式后，无论我是在写代码，还是在打游戏或者刷视频，都能够立即把我从娱乐中打断，告诉自己：你现在该睡觉了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/072bbbcf1fff4f16a3dcfb2c5d3ecb27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Lic5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974039&amp;x-signature=xpKJK6YBvz863AKbYR25i14k2a8%3D" alt="AF6EAFEA-25B3-4CC9-BB5F-DEBA8BB40794.jpg" loading="lazy"/>
当然还有很多种玩法，比如不同应用设置不同的颜色模式，还能够设置模式的不同参数，便捷的分屏操作等。</p>
<p>什么时候专心工作，什么时候读东西，什么时候只是随便看看。</p>
<p>这些功能本身解决我一个很现实的问题——</p>
<p>不要在已经很消耗注意力的工作里，再把精力浪费在调屏幕这件事上。</p>
<h3 data-id="heading-7">体验总结</h3>
<p>这段时间用下来，我对 RD280UG 的感受，其实很简单：</p>
<p>它没有试图让我更兴奋，而是让我更容易坐下来。</p>
<p>在 AI 逐渐接管“写”的当下，开发者真正消耗精力的，变成了判断、理解和反复确认。</p>
<p>当屏幕比例、编程模式、阅读模式和护眼设计都围绕这些状态展开时，工具本身就不再抢注意力，而是慢慢退到背后。</p>
<p>拥有一台好的设备，不只是让事情变快，而是让你在需要慢下来思考的时候，依然愿意停留在那里。</p>
<p>也许，这才是我现在最需要的生产力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不止是写代码｜如何用 TRAE 进行复杂数据分析]]></title>    <link>https://juejin.cn/post/7603389033042378806</link>    <guid>https://juejin.cn/post/7603389033042378806</guid>    <pubDate>2026-02-06T09:20:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603389033042378806" data-draft-id="7603314759758741523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不止是写代码｜如何用 TRAE 进行复杂数据分析"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-02-06T09:20:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不止是写代码｜如何用 TRAE 进行复杂数据分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:20:06.000Z" title="Fri Feb 06 2026 09:20:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2614d47a9d2d4cc596e4bc73b405dd31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=1WIZxUdEAAT4RmoPdkNdtDrC7Ro%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：杨辉，TRAE 战略分析师</p>
</blockquote>
<p>本文来自 TRAE 团队的战略分析同学，他将从“什么是数据分析”以及“数据分析的常见痛点”这两个基本问题出发，结合两个真实数据分析场景，带大家实际操作如何使用 IDE 进行数据分析。让更多的非开发背景的同学也能轻松应对复杂的数据分析任务。</p>
<blockquote>
<p>本文实践操作版本：TRAE 中国版</p>
<p>模型选择：Auto 模式</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ed0f9030e164d7a97380a8531e867db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=0oYW9QTgzcg8LFSYvyB%2BYpS8lZA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>什么是数据分析？</strong></h2>
<p>数据分析是指通过<strong>收集、清洗、整理、分析和解读数据，提取有价值信息、挖掘数据规律</strong>，从而为决策提供依据的过程。它核心价值在于<strong>将零散的数据转化为可落地的洞察</strong>，助力不同领域解决问题、优化流程、提升效率。</p>
<p>在众多职业（例如咨询、金融、互联网）场景中，数据分析都是不可或缺的核心能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a826e4c238644d50a8e62c3144dbd868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=oAyyplziHav44VOQbFrQ5TQ7%2BGg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>数据分析常见痛点</strong></h2>
<p>在数据分析工具发展的早期阶段，<strong>Excel</strong> 是绝大多数从业者的首选工具。它<strong>操作门槛低、功能全面</strong>，既能完成<strong>数据的录入、清洗和计算</strong>，也能通过<strong>数据透视表快速汇总分析数据</strong> <strong>，还支持柱状图、折线图、饼图等多种图表制作</strong>，将复杂的数据结果可视化呈现，满足了日常工作中基础的数据分析需求。</p>
<p>对于简单的数据汇总（数据量级 &lt; 1 万行），Excel 通常较为流畅，操作响应秒级，但是当数据量级超过 1 万行甚至 10 万行时，Excel 开始变慢，<strong>筛选、排序、数据透视表等操作耗时延长（秒到分钟级）</strong> 。当表格里有大量<em><strong>VLOOKUP</strong></em>、<em><strong>SUMIFS</strong></em>、数组公式，或是跨表引用、嵌套函数时，甚至<strong>出现文件崩溃</strong>的情况，通常需要关闭自动计算（改为手动计算），并且频繁保存，否则文件崩溃会导致几个小时的工作量白费。</p>
<p>数据分析本是一项对技术能力有较高要求的专业工作，但在 AI 编程技术的赋能下，非技术背景的从业者也能借助 <strong>AI IDE</strong> 高效完成从数据处理、深度分析到可视化呈现的全流程，彻底突破 Excel 在复杂场景下的应用瓶颈。</p>
<p>例如，用户无需再记忆繁杂的公式或代码语法，只需用自然语言描述分析需求，AI 就能自动拆解任务、生成代码并输出精准结果。无论是基础的数据清洗（如读取 CSV 文件并处理重复值）、业务指标计算（如按区域汇总销售额），还是更复杂的可视化呈现（如用折线图展示月度趋势）与进阶的预测分析（如通过时间序列算法预测未来销量），都能通过简单的自然语言指令快速实现——而在过去，这些能力对非技术人员而言几乎是难以企及的。</p>
<blockquote>
<p>一言以蔽之，AI 让数据分析告别 “专业壁垒”，成为所有非专业人员都能零门槛上手的实用工具。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0bb89117ab74efbbd5e3ca1cd7bca46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=kUb1zA0MmbnXfNtq9xGii3iU81s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>为什么用 TRAE 做数据分析</strong></h2>
<p>我们把 Excel、ChatGPT、TRAE IDE 基于数据分析的场景进行了多维度对比，可以发现 IDE <strong>在效率、适配性与智能化上全面超越 Excel 与 Chatbot（例如 ChatGPT）：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97d87ed302aa446daaa4c2e7f7898def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=tBPHeJ2LSFjdETLEuuuvwC3Cj9M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3"><strong>和 Excel 相比</strong></h3>
<ul>
<li>
<p><strong>性能无上限：</strong> 轻松驾驭 10 万行甚至百万行数据，彻底告别 Excel 处理大数据时的卡顿、假死与崩溃风险。</p>
</li>
<li>
<p><strong>零代码分析范式：</strong> 告别复杂的 <em><strong>VLOOKUP</strong></em>、<em><strong>SUMIFS</strong></em> 嵌套或 VBA 脚本。通过自然语言指令即可驱动分析，让非技术人员也能完成高阶统计。</p>
</li>
<li>
<p><strong>端到端流程自动化：</strong> 实现从<strong>原始清洗、多维分析到可视化呈现</strong>的一键式串联，将原本碎片化的操作转化为自动化的数据流水线。</p>
</li>
<li>
<p><strong>逻辑沉淀：</strong> 分析过程不再是不可逆的手动点击，而是自动生成<strong>可复用的分析脚本</strong>。今年的分析模型，明年新数据只需一键运行即可复用。</p>
</li>
</ul>
<h3 data-id="heading-4"><strong>和 ChatBot 类型的产品相比</strong></h3>
<ul>
<li>
<p><strong>操作便捷灵活：</strong> 原生支持超大文件及多个分散文件的关联处理，无需手动切分或反复上传，直接在本地工作区起步。</p>
</li>
<li>
<p><strong>项目理解满分：</strong> 具备项目级上下文理解能力，深度关联历史分析逻辑与业务标签，避免了 Chatbot 常见的重复沟通与上下文断裂。</p>
</li>
<li>
<p><strong>中间逻辑可追溯、可追问：</strong> 拒绝“结果黑盒”，你可以针对分析过程中的<strong>任何中间步骤进行追问和校验</strong>（如：“为什么这么过滤？”），确保逻辑百分之百准确。</p>
</li>
<li>
<p><strong>分析产出持久化：</strong> 支持将图表与分析结果直接转化为<strong>多格式持久化文件</strong>。这种“产出即资产”的能力，为深度分析与跨工具协作提供了坚实的工程基础。</p>
</li>
<li>
<p><strong>多工具协同执行：</strong> 凭借智能推理与多工具协同，不仅精准识别需求，更能自动配置环境并执行代码，实现真正闭环的 AI 分析体验。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64c9db9b23be41e6b11e55dab085fe57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=6uFJV3CtxX79FJF1wW7ZIfwDxZk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>实操</strong></h2>
<p>Stack Overflow 开发者调研是一份面向全球开发者的问卷报告，调研当前开发领域的技术趋势与核心痛点等。他们每年会将源数据发布在其官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.stackoverflow.co%2F" target="_blank" title="https://survey.stackoverflow.co/" ref="nofollow noopener noreferrer">survey.stackoverflow.co/</a></p>
<p>本教程以 Stack Overflow 2025 年开发者调研数据为例，演示如何用 TRAE 完成全流程数据分析。</p>
<h3 data-id="heading-6"><strong>工具安装与数据准备</strong></h3>
<ol>
<li>
<p><strong>下载安装 TRAE ：</strong> 访问 TRAE 官网（<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.trae.com.cn%25EF%25BC%2589%25EF%25BC%258C%25E4%25B8%258B%25E8%25BD%25BD%25E5%25AE%2589%25E8%25A3%2585%25E5%258C%2585%25EF%25BC%258C%25E6%258C%2589%25E5%25BC%2595%25E5%25AF%25BC%25E5%25AE%258C%25E6%2588%2590%25E5%25AE%2589%25E8%25A3%2585%25EF%25BC%258C%25E7%2594%25A8%25E6%2589%258B%25E6%259C%25BA%25E5%258F%25B7%25E8%25B4%25A6%25E5%258F%25B7%25E7%2599%25BB%25E5%25BD%2595%25E5%258D%25B3%25E5%258F%25AF%25E3%2580%2582" target="_blank" title="http://www.trae.com.cn%EF%BC%89%EF%BC%8C%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85%EF%BC%8C%E6%8C%89%E5%BC%95%E5%AF%BC%E5%AE%8C%E6%88%90%E5%AE%89%E8%A3%85%EF%BC%8C%E7%94%A8%E6%89%8B%E6%9C%BA%E5%8F%B7%E8%B4%A6%E5%8F%B7%E7%99%BB%E5%BD%95%E5%8D%B3%E5%8F%AF%E3%80%82" ref="nofollow noopener noreferrer">www.trae.com.cn），下载安装包，按引导完成安装，用手机号账号登录即可。</a></p>
</li>
<li>
<p><strong>打开 TRAE SOLO 模式：</strong> TRAE 目前提供 SOLO 和 IDE 两种模式，本次我将选择 TRAE SOLO 模式来完成需求。</p>
</li>
</ol>
<h4 data-id="heading-7"><strong>SOLO 和 IDE 模式的区别：</strong></h4>
<ul>
<li>
<p>SOLO：AI 主导全流程，自动拆解任务、调度工具，开发者仅需提需求、审核成果</p>
</li>
<li>
<p>IDE：开发者主导，AI 提供代码补全、智能问答等辅助，保留传统开发流程，掌控感更强</p>
</li>
</ul>
<p>SOLO 有 2 个选项，分别为 SOLO Builder 和 SOLO Coder，我们本次选择 SOLO Coder，其中的 Plan 模式也为分析方案的讨论提供了很大便利。</p>
<h4 data-id="heading-8"><strong>SOLO Builder 和 SOLO Coder 的区别：</strong></h4>
<ul>
<li>
<p>SOLO Coder: 适合已有复杂项目的迭代、重构、Bug 修复，可自主规划、执行多步任务</p>
</li>
<li>
<p>SOLO Builder: 适合从 0 到 1 完整项目的快速原型验证，从需求分析到部署全流程自动化</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24dfd87d59064ff6a7fd0ca6d406b997~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=6P7Z3e7GYhJQR9fT%2BzBTNeu6%2Ba0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>单文件数据分析场景</strong></h3>
<h4 data-id="heading-10"><strong>数据准备</strong></h4>
<p>从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsurvey.stackoverflow.co%2F" target="_blank" title="https://survey.stackoverflow.co/" ref="nofollow noopener noreferrer">survey.stackoverflow.co/</a> <strong>下载 Stack Overflow 2025 调研数据集</strong>，包含「受访者基本信息、技术使用习惯、AI 工具态度」等维度，将数据集保存至本地文件夹（例如 “StackOverflow2025” ），方便后续 TRAE 进行读取。</p>
<p>需要注意的是，要单独创建一个文件夹，将下载下来的数据集保存在这个文件夹内，而不是直接打开excel文件。</p>
<p>选择「打开项目」，找到对应文件夹打开。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95fe1e4f569e45ef994488a7e4f172bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=5BPj3KwWA8YYeygUXvMTB5z2irI%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a0fd50bbb434aa68eeddad286e133ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=01JqVfcvqb15t5GP1VrkOrPn2WM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11"><strong>开始数据分析</strong></h4>
<p><strong>1.</strong> 直接在对话框里输入指令，<strong>指令可以简单（例如“帮我分析一下这个数据集”）</strong> ，也可以更细节具体，可以参考下方，这一步是为了让 AI 清晰自己的角色定位。</p>
<p>「我是数据分析师，需要分析Stack Overflow 2025开发者调研数据。 </p>
<p>请读取本地文件夹“StackOverflow2025”中的CSV文件，查看数据的前10行、字段列表、数据形状（行数/列数），统计各字段的缺失值数量，生成基础信息报告。 </p>
<p>注意处理中文编码问题，避免乱码。」</p>
<p><strong>2.</strong> 从官网下载的数据是 zip 文件，<strong>无需人工手动解压，</strong> AI 自己会解压并使用 Python 来读取和分析数据；大概经过 2 分钟，AI 会显示初步分析结果，例如 <strong>数据基本情况、开发者画像、AI 工具使用情况、薪资情况以及技术使用情况</strong>等多个方面</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0f5327e42284714860c827a90d49500~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=yRIDdu2kLiN1HFAgHsTS8HAL%2BXk%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>从初步的分析返回结果来看，我们可以发现一些<strong>有趣的下钻分析的维度</strong>，例如：</li>
</ol>
<p>  a. 年龄分布和薪资情况是否有关系</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b33a5902e8b54fa7b9f252217b59415c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=iKxRLAasAF45lJU4BuGsadJLx10%3D" alt="" loading="lazy"/></p>
<p>  b. 最常用的编程语言和薪资情况是否有关系</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f29edad37744030b09ccd8a95f44087~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=yxOnbMKxNhN5uVfOiWMYKYaKhQE%3D" alt="" loading="lazy"/></p>
<p>  c. 工作满意度和薪资情况是否有关系</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3d5b15528e443be925fd95a61dcfe15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=nM2jgBWFs4M%2FsLUUvVTeyw%2BRxbc%3D" alt="" loading="lazy"/></p>
<p><strong>4.</strong> 原始数据里有个字段是“国家”，因为字段较多，所以 AI 在最开始的描述性统计时没有提到，但如果期望补充更多下钻分析的维度，可以直接问 AI</p>
<p>「分析一下不同国家的薪资分布（看一下前10国家，按调研用户数量排序，薪资中位数，均值和25/75分位数，全部换算为美金）」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bf573ad448d4ab4b6d19f80d602c298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=btRUaac%2FZW5A8QytdJsTvAj%2FmhE%3D" alt="" loading="lazy"/></p>
<p><strong>5.</strong> 可以交叉“国家”和“开发者身份”，分析薪资分布情况</p>
<p>「分析一下不同国家、不同开发者身份的薪资分布（看一下前10国家，前一下前10开发者身份，按调研用户数量排序，薪资中位数，均值和25/75分位数，全部换算为美金）」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89b68c6fc42e4f36a14f92694e3514d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=xvXXVo3loZECV7al5ey5p6k5kmM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12"><strong>生成数据分析图表</strong></h4>
<blockquote>
<p>数据分析常常需要结合图表，可以更加直观展示数据情况。</p>
</blockquote>
<p>直接在对话框里输入指令，<strong>指令可以简单（例如“帮我画一个 XX 图”）</strong> ，也可以更细节具体，可以参考下方。</p>
<p>「帮我画一个热力表，横轴是国家（按中文名称），数轴是开发者类型（简写），数值是薪资平均值」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c3591dab4604119b89ba246834d7f6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=AqhOzHcwIK9A9Q3Vc9XX5Eta898%3D" alt="" loading="lazy"/></p>
<p>「帮我画一个图，展示每个国家的25/75/中位数 薪资，只需要展示前10国家即可」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0de4f0c2a28e4397aa57edd838845dbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=ZigVH5MVgWmS2cUhVe%2FMHbHQqjI%3D" alt="" loading="lazy"/></p>
<p>「帮我画一个气泡图，横轴是薪资均值（单位是美金），数轴是每日使用过AI的占比，大小是开发者调研用户数量，展示前10国家，气泡大小适中，注意美观」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa4ce3e77184d5ab2057b0cfcfaf296~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=x2KaWXCGG05ooc6RtP8wfyBY5wQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-13"><strong>数据分析结果导出</strong></h4>
<p>除了数据分析和画图外，我们也可以将分析结果储存为 <strong>CSV 、Excel 等格式方便后续阅读和处理数据，或者让其将完整报告存储为 MD、PDF、 PPT 等格式方便阅读文文字内容</strong>。以 csv 为例，</p>
<p>「帮我把每个国家的调研人数，薪资中位数，25/75分位数和均值导出为csv+」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5a61e53ad914a00801e56e2a729bfe9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=0i1V4FtyEKQPl2nRDRnKAIZyAtk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-14"><strong>总结</strong></h4>
<p>以上分析只是这个数据集的一部分，还有其他分析维度例如 AI 工具使用率分析、编程语言偏好分析、工具偏好与 AI 使用关联性等，大家可以自行修改提示词探索。</p>
<h3 data-id="heading-15"><strong>跨文件分析场景</strong></h3>
<p>有时候数据分散在不同的文件，而我们需要将不同文件之间的数据对比结合起来分析，因此会有跨文件分析的场景。</p>
<h4 data-id="heading-16"><strong>数据准备</strong></h4>
<p>从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kaggle.com%2Fdatasets%2Fretailrocket%2Fecommerce-dataset%2Fdata" target="_blank" title="https://www.kaggle.com/datasets/retailrocket/ecommerce-dataset/data" ref="nofollow noopener noreferrer">www.kaggle.com/datasets/re…</a>  <strong>下载 Retailrocket recommender system dataset 数据集</strong>；该数据集包含四个文件：一个存储用户行为数据的文件（events.csv）、两个存储商品属性数据的文件（item_properties_part1.csv 和 item_properties_part2.csv），以及一个描述类目层级结构的文件（category_tree.csv）；<strong>无需手动解压</strong>，可以直接把数据集保存至本地文件夹（例如 “电商推荐” ），方便后续 TRAE 进行读取。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c613c756eca4ac2823a4b4c0b8e14d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=CjJuP6qolYcuJrCay3vBMJsEzyE%3D" alt="" loading="lazy"/></p>
<p>选择「打开项目」，找到对应文件夹打开。</p>
<h4 data-id="heading-17"><strong>开始数据分析</strong></h4>
<p><strong>1.</strong> 直接在对话框里输入指令，<strong>指令可以简单（例如“帮我分析和总结一下这个数据集”）</strong> ；可以看到三个文件里，ategory_tree.csv 是商品类别树结构（1670 行）；events.csv 是户行为事件（276 万行），主要是三类事情：浏览、加入购物车和交易；item_properties 是商品属性（2000 万行），包含多种属性类型</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d98e200c3ab4144b816108b68405494~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=%2BisHqRg5qO%2F8N22CtFBMKmbKQ7c%3D" alt="" loading="lazy"/></p>
<p><strong>2.</strong> 我们可以先针对单个文件夹做一些下钻分析，例如：</p>
<p>a. 下钻分析商品类别树分布，可以看到顶级类别数量为 25 个，最深层级为 6 层，层级 3 和层级 4 是最主要的层级，共占 81.90%，平均每个父类别有 4.54 个子类别，中位数为 4，表明类别结构比较均衡</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bee50b986e6426c9b0fd87cef285458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=eBs2%2F84dtiYO1A9MVBgC1e52ypE%3D" alt="" loading="lazy"/></p>
<p>b. 下钻分析用户行为数据，可以看到共计 141 万个用户和 276 万条记录，平均一个用户有 1.96 条记录；71%的用户仅 1 条记录，27%的用户有 2-10 条记录，1.4%用户有超过 10 条记录；从事件类型看，浏览占比 96.67%，加入购物车为 2.52%，购买为 0.81%；浏览从加入购物车转化比例为 2.60%，加入购物车到交易为 32%</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ce6989af935499aabc42328bfdeefc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=kMa7q2te4bSJT943Flpr5SQmSLA%3D" alt="" loading="lazy"/></p>
<p>c. 下钻分析商品属性数据，可以看到共计 2000 万条属性记录，涉及 40 万商品，平均一个商品 3 个属性；除了库存（available）和类目（categoryid）这两个属性外，其他属性都被哈希；最常用的前 10 个属性使用占比基本都是 100%</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a5fc0b9a8ab41eab3c5acf38f68b985~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=ooZ3dXlxvBQxNpBUwGEWW33ub10%3D" alt="" loading="lazy"/></p>
<p><strong>3.</strong> 除了单个文件下钻分析外，我们也可以交叉三个文件进行分析，例如按顶级类别看下从浏览到加入购物车到交易的转化比例：可以看到平均转化率为 0.91%，3 个类别（140、1224、859）转化率高于 1%，11 个类别转化率低于 0.5%，其他介于 0.5-1%；7 个类目的浏览量低于 1000，其中 2 个浏览量为 0</p>
<p>​「按25个顶级类别看下从浏览到加入购物车到交易的转化比例（浏览事件粒度，不是商品或者用户粒度，如果一个商品的类别有过变化，用最新的类别）」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a28c2c512d524a939ffdef5290912e38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=IrK94tLElq0bj5XAScHzvBwvso0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18"><strong>生成数据分析图表</strong></h4>
<p>可以直接在对话框里输入指令，例如：</p>
<p>「帮我画一个图，按top 10顶级类别浏览到加入购物车，加入购物车到交易的比例，并在图表的上方，加上每个类目的浏览、加购、交易次数」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/529b91b1c68a474183265223414f8e7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=WKNaLeLQjtUWxNp2Qrz%2FX9Oot2k%3D" alt="" loading="lazy"/></p>
<p>「帮我画一个气泡图，横轴浏览到加购的转化，竖轴是加购到购买的转化，大小是浏览量级，只需要画按浏览量前10个顶级类别」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a9af24af731436c80fb260f2c3a6ff4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=XWU%2Fv%2BUYOXGwUw%2FCcwF4ZZc6Ztk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-19"><strong>数据分析结果导出</strong></h4>
<p>「把以上top 10 顶级类别的气泡图导出为ppt」</p>
<p>可以发现，TRAE 会使用 matplotlib 绘制相关气泡图，截屏然后插入ppt里面，而没有使用PPT原生画图能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb6d7c960edc4b2dbbfae97a44325081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=McIKZgVOTHnvrFUk4A7yEQlflhg%3D" alt="" loading="lazy"/></p>
<p>当然你也可以通过提示词「请帮我在 <strong>PPT</strong> 里面直接画图，而不是复制图片」，TRAE 也能调用 PPT 相关能力进行构图，但画出来的图片美观度略有不足，只能达到基本要求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88cfe1a4ecd94232816dd36b2c0cb8a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=RtCC0L%2FPUAzfyHOITQgPivc4TTM%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd85a44b7c6d4dbaa29f5bcc63a91ab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=YnkLpAKMOuZ%2BksHWbo9kCHwmuf4%3D" alt="" loading="lazy"/></p>
<p>以上分析只是这个数据集的一部分，还有其他分析维度例如其他属性对购买转化比例的影响等，大家可以自行修改提示词探索。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55679dac25b046d48545f45e41ce5bd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974409&amp;x-signature=xfkEDQvqBOVouH507g%2Fc7xbdpoY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20"><strong>写在最后</strong></h2>
<p>无论是咨询项目（例如银行压力测试、消费品市场趋势分析等），还是互联网场景下的数据任务（例如分国家用户留存分析、付费转化漏斗搭建等），基本都能通过 AI IDE 高效落地。<strong>AI IDE 在数据挖掘与深度分析环节的表现堪称出色，能精准完成核心任务</strong>；仅在最终数据可视化呈现的细节优化上，偶尔需要少量辅助调整，<strong>但其整体交付质量大多超出预期，大幅提升了数据分析的效率与专业性。</strong></p>
<p>IDE 从来不是专业开发者的专属工具，它可以离每个人的工作和生活都更近一些。借助 AI 的能力，我们不必精通复杂的编程语言，也能把一个个灵感和想法变成真正可落地的“数字小帮手”；不管你是产品、运营、数据分析、设计师，还是任何一一个角色，都可以用 AI Coding 去搭建属于自己的智能工作台。</p>
<p>期待多样化的你带来更多不一样的 AI Coding 实现！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端 AI Coding 落地指南（一）架构篇]]></title>    <link>https://juejin.cn/post/7603347438013480995</link>    <guid>https://juejin.cn/post/7603347438013480995</guid>    <pubDate>2026-02-06T09:26:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603347438013480995" data-draft-id="7603347438013333539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端 AI Coding 落地指南（一）架构篇"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2026-02-06T09:26:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AntonCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3966693684293240"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端 AI Coding 落地指南（一）架构篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693684293240/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AntonCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:26:13.000Z" title="Fri Feb 06 2026 09:26:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是也遇到过这些情况：AI 生成的代码风格和现有项目不一致；项目结构不符合预期，设计稿要么看不懂、要么分析漏项，页面 UI 还原度低；改来改去返工多，需求越走越偏，最后还得自己重写一版？</p>
<p>我在实际项目里经过多次迭代的实践，落地了一套</p>
<p><strong>以规范、能力扩展和流程为主线的 AI Coding 架构</strong></p>
<p>把「风格不一致、步骤漏、设计稿不会分析/验收、提案任务格式乱」都收进可控范围。落地之后最直观的效果是：</p>
<p><strong>前端页面可以做到 90% 还原设计稿，需求实现更准确，代码风格一致，结构设计合理</strong></p>
<hr/>
<h2 data-id="heading-0">架构简介</h2>
<p>架构运用了多种现下流行的 Agent 通用能力：</p>

























<table><thead><tr><th>架构组成</th><th>说明</th></tr></thead><tbody><tr><td>SDD</td><td>开发流程控制，保证需求不遗漏，开发不脱节，可进行需求分析/开发规划/验收测试/复盘归档</td></tr><tr><td>MCP</td><td>对接外部能力，如设计稿读取、浏览器访问页面查看实际效果、接口文档</td></tr><tr><td>Rules</td><td>约定「做什么、不做什么」，如保证 AI 遵循项目结构，规范约束，代码风格</td></tr><tr><td>Skills</td><td>约定「怎么做」，渐进披露按需指导 AI 怎么做，如怎么写UI，怎么验收UI</td></tr></tbody></table>
<p><strong>Rules 管「怎么才算对」，Skills 管「怎么一步步做」，MCP 让 Agent 能看到真实世界，而 SDD 负责记录「这次为什么要改、应该改成什么样」并把每次变更沉淀成新的真相</strong>，四者合在一起，才是真正稳定可演进的 AI Coding 底座。</p>
<p>从需求到归档的完整链路如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[需求输入] --&gt; B{有设计稿?}
    B --&gt;|是| C[设计稿 MCP 读稿]
    C --&gt; D[design-analysis 产出 UI 分析清单]
    B --&gt;|否| E[create-proposal + SDD]
    D --&gt; E
    E --&gt; F[proposal / tasks / spec 增量 校验]
    F --&gt; G[按 tasks 实施]
    G --&gt; H[Rules + create-route/component/theme 页面开发]
    H --&gt; I{有实现页?}
    I --&gt;|是| J[Browser MCP 打开页面]
    J --&gt; K[ui-verification 比对设计稿/清单]
    K --&gt; L[产出 UI 问题清单 修复再验]
    L --&gt; M[create-api/store + 接口/Context7 业务联调]
    G --&gt; M
    M --&gt; N[SDD 归档 更新 specs]
</code></pre>
<ol>
<li><strong>需求输入</strong>：明确是否有设计稿、是否有接口、交付形态（页面/组件/其它）。</li>
<li><strong>设计稿分析</strong>（有稿时）：用 Pencil（或 Figma）MCP 读稿 → 执行 design-analysis 技能 → 产出 UI 分析清单。</li>
<li><strong>创建提案</strong>：执行 create-proposal，产出 SDD 的 proposal、tasks、spec 增量；若有设计稿，在 tasks 中写明依据 UI 分析清单实现、实现后用 ui-verification 验收；validate 通过后进入实施。</li>
<li><strong>页面/UI 开发</strong>：按 tasks 顺序做；读 Rules（项目结构、组件、路由、样式等）+ Skills（create-route、create-component、theme-variables）；依据 UI 分析清单还原布局与样式。</li>
<li><strong>UI 验收</strong>：用 Cursor IDE Browser（或 Playwright）打开实现页，执行 ui-verification，与设计稿或分析清单比对，按 P0/P1/P2 产出问题清单；修复后再次用 Browser 验证。</li>
<li><strong>业务开发与联调</strong>：Rules（API、状态、通用约束）+ create-api、create-store；接口文档 MCP、Context7 按需使用。</li>
<li><strong>归档</strong>：tasks 全部勾选后执行 SDD archive，更新 specs，变更挪入 archive。</li>
</ol>
<hr/>
<h2 data-id="heading-1">主流 Agent 通用</h2>
<p>本套架构方案，适用所有支持 skills/mcp 的 Agent，且
<strong>只维护一份，所有 Agent 共用</strong>：</p>
<p>首先在你的项目根目录创建 <strong><code>.agents</code></strong>，下面放 <code>rules</code> 和 <code>skills</code>，然后根据你所使用的 Agent 或多个 Agent 做如下配置：</p>
<ul>
<li><strong>Cursor</strong>：在项目根创建 <code>.cursor</code> 目录，其下的 <code>rules</code>、<code>skills</code> 用 <strong>软链接</strong> 指到 <code>.agents/rules</code>、<code>.agents/skills</code>。</li>
<li><strong>Claude</strong>：同理，创建 <code>.claude</code>，将 <code>rules</code>、<code>skills</code> 软链到 <code>.agents</code> 下同名目录。</li>
<li><strong>OpenCode</strong>：创建 <code>.opencode</code>，同理软链。</li>
<li><strong>Gemini</strong>：创建 <code>.agent</code>，同理软链。</li>
<li><strong>Trae</strong>：创建 <code>.trae</code>，同理软链。</li>
</ul>
<p>这样只需维护 <code>.agents</code> 一份，即可同时支持上述所有 Agent。</p>
<p><strong>目录结构示例</strong>（仅展示与本文相关的部分）：</p>
<pre><code class="hljs language-text" lang="text">项目根/
├── .agents/                    # 唯一维护的规范与技能目录
│   ├── rules/                  # 规则
│   └── skills/                 # 技能
│
├── .cursor/                    # Cursor：内部 rules、skills 软链到 .agents
├── .claude/                    # Claude：同上
├── .opencode/                  # OpenCode：同上
├── .agent/                     # Gemini：同上
└── .trae/                      # Trae：同上
</code></pre>
<hr/>
<h2 data-id="heading-2">SDD</h2>
<p><strong>SDD 是什么</strong><br/>
Specification-Driven Development，用「规范/spec」来驱动开发：</p>
<ul>
<li><strong>先写 spec 再写代码</strong>：任何需求或变更，先写清楚需求，「现在是怎样 → 期望变成怎样」，再开干；</li>
<li><strong>变更可追踪</strong>：变更以「提案 + 任务 + spec 增量」管理，实施完归档，可回溯是谁、什么时候、为什么改了什么；</li>
<li><strong>验收有据可依</strong>：验收按 spec 来，而不是「感觉差不多」。</li>
</ul>
<p><strong>SDD 的选择</strong></p>
<p>Spec-kit 和 OpenSpec 是两个比较热门的 SDD 工具，我在尝试过两个工具后，最终选择使用 openspec 因为他比 speckit 简单很多，speckit 的流程更严谨，也更繁琐，其复杂度适合从 0 到 1 规划一个新项目。</p>
<p><strong>OpenSpec</strong></p>
<p>通过 <code>openspec init</code> 初始化项目后，你就会得到如下的一个典型的 OpenSpec 目录：</p>
<pre><code class="hljs language-text" lang="text">openspec/
├── project.md          # 项目约定与 AI 使用说明
├── specs/              # 当前「真相」：已经生效的能力与约束
└── changes/            # 进行中的变更：proposal、tasks、design、spec 增量
    ├── &lt;change-id&gt;/
    │   ├── proposal.md
    │   ├── tasks.md
    │   ├── design.md      # 可选：草图/交互/边界情况
    │   └── spec-delta.md  # 本次变更对 specs 的增量
    └── ...
</code></pre>
<p>首先你需要编写 <code>project.md</code>，将你项目的规范告诉 openspec，以此作为规范进行推动后续的工作，这是我项目的 <code>project.md</code>，起初也是一个庞大的文件，现在已经拆分到 rules 和 skills 了（后面会介绍）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目上下文</span>

<span class="hljs-section">## 项目概述</span>

当前项目是一个基于 React + TypeScript 的单页应用（SPA）。

<span class="hljs-section">## 技能与规范</span>

本项目定义了两层指导体系，统一存放在 <span class="hljs-code">`.agents/`</span> 目录下。

<span class="hljs-section">### `.agents/rules/` - 开发规范</span>

规范文件包含项目开发的核心规则，不会自动加载。当需要确认规范时，主动读取对应文件：

| 文件             | 何时读取                   |
| ---------------- | -------------------------- |
| <span class="hljs-code">`01-项目概述.md`</span> | 需要了解项目背景、技术栈时 |
| <span class="hljs-code">`02-编码规范.md`</span> | 编写或审查代码时           |
| <span class="hljs-code">`03-项目结构.md`</span> | 确定代码应放在哪个目录时   |
| <span class="hljs-code">`04-组件规范.md`</span> | 创建或拆分组件时           |
| <span class="hljs-code">`05-API规范.md`</span>  | 新增或修改接口时           |
| <span class="hljs-code">`06-路由规范.md`</span> | 新增页面或配置路由时       |
| <span class="hljs-code">`07-状态管理.md`</span> | 新增或重构状态管理时       |
| <span class="hljs-code">`08-通用约束.md`</span> | 确认通用约束时             |
| <span class="hljs-code">`09-样式规范.md`</span> | 编写组件样式或主题适配时   |
| <span class="hljs-code">`10-文档规范.md`</span> | 编写或审查代码注释时       |
| <span class="hljs-code">`11-测试规范.md`</span> | 确认测试要求时             |

<span class="hljs-section">### `.agents/skills/` - 实践技能</span>

技能文件包含具体落地步骤与示例代码，按需读取：

| 场景              | 技能文件                                   |
| ----------------- | ------------------------------------------ |
| 创建提案时        | <span class="hljs-code">`.agents/skills/create-proposal/SKILL.md`</span>  |
| 新增接口          | <span class="hljs-code">`.agents/skills/create-api/SKILL.md`</span>       |
| 创建/拆分组件     | <span class="hljs-code">`.agents/skills/create-component/SKILL.md`</span> |
| 新增页面路由      | <span class="hljs-code">`.agents/skills/create-route/SKILL.md`</span>     |
| 新增全局状态      | <span class="hljs-code">`.agents/skills/create-store/SKILL.md`</span>     |
| 编写样式/主题适配 | <span class="hljs-code">`.agents/skills/theme-variables/SKILL.md`</span>  |

技能索引文件：<span class="hljs-code">`.agents/skills/README.md`</span>

</code></pre>
<p>配置了规范后，就可以使用 openspec 的指令进行需求的实现，先是 <code>openspec proposal</code> 创建提案，Agent 会根据你的描述，生成详细的需求文档，规划开发任务，待你确认。</p>
<p>开发任务确认后，再执行 <code>openspec apply</code> 开始实施任务，任务完成 <code>openspec archive</code> 对本次需求归档，这会作为后续新需求的一个参考，让 Agent 对项目的现状更了解。</p>
<p><strong>OpenSpec 在这套架构里的作用</strong><br/>
结合前面讲的 Rules / Skills / MCP，这里的 OpenSpec 主要在三个环节发力：</p>
<ul>
<li><strong>需求 / 变更收敛</strong>：不管输入来自 PRD、口头、IM 还是设计稿，先用 OpenSpec 写一条变更（proposal + tasks + spec 增量），把「要改什么、影响到哪里」说清楚，避免 AI 直接在代码上「盲改」；</li>
<li><strong>开发执行对齐</strong>：开发时，Agent 读取对应变更的 proposal / tasks / spec 增量，再结合 Rules（项目级约束）、Skills（如 create-route / create-api / design-analysis）和 MCP（设计稿 / 浏览器 / 接口文档），按 tasks 一项项完成，实现过程始终围绕同一份 spec 展开；</li>
<li><strong>验收与归档</strong>：UI 验收阶段，ui-verification 会同时参考 UI 分析清单（design-analysis 产物）和 OpenSpec 中的 spec 增量，验证是否满足这次变更的业务与交互预期；验收通过后，将变更移动到 archive，并把 spec 增量合到 specs，下次再改同一块能力时，所有上下文都在这里。</li>
</ul>
<hr/>
<h2 data-id="heading-3">MCP</h2>
<p><strong>MCP 是什么</strong>：Model Context Protocol，模型通用的上下文协议，让模型能安全、结构化地调用外部能力。设计稿、浏览器、接口文档等通过 MCP 暴露成工具，Agent 按需调用，拿到真实数据或执行真实操作。</p>
<p>这套架构中用到如下的 MCP：</p>















































<table><thead><tr><th>MCP</th><th>用途</th><th>环节</th><th>说明</th></tr></thead><tbody><tr><td>Pencil</td><td>.pen 设计稿结构、布局、节点、截图</td><td>设计稿分析</td><td>设计稿分析首选，效果优于 Figma MCP</td></tr><tr><td>Figma</td><td>Figma 链接的截图与设计上下文</td><td>设计稿分析（Figma 稿时）</td><td>有 .pen 时优先 Pencil</td></tr><tr><td>Cursor IDE Browser</td><td>打开页面、快照、截图</td><td>UI 验收</td><td>Cursor 内优先，效果优于 Playwright</td></tr><tr><td>Playwright</td><td>页面打开、截图、自动化</td><td>UI 验收（非 Cursor 或脚本化）</td><td>可作为 Browser 的补充</td></tr><tr><td>ApiFox</td><td>OAS 等接口定义</td><td>业务开发/联调</td><td>按当前文档生成/校验请求</td></tr><tr><td>Context7</td><td>主流库最新文档与示例注入</td><td>页面/业务开发</td><td>避免过时 API、幻觉</td></tr></tbody></table>
<p><strong>设计稿类</strong></p>
<ul>
<li><strong>Pencil MCP</strong>：面向 <code>.pen</code> 设计稿。能读层级、节点、布局、截图（如 <code>snapshot_layout</code>、<code>get_screenshot</code>、<code>batch_get</code> 等），把设计稿里的元素尺寸、间距、字体、颜色直接触达 Agent。在「设计稿分析」环节作为主数据源，<strong>效果明显好于 Figma MCP</strong>——层级与细节更完整，分析清单更准，因此有 .pen 稿时优先用 Pencil。可以直接拷贝 Figma 粘贴到 Pencil 设计稿。</li>
<li><strong>Figma MCP</strong>：面向 Figma 链接。可解析 file key / node id、取截图与设计上下文，适合设计稿在 Figma 的场景，但 Figma 可复制到 Pencil ，95%+ 样式复制后还原，个别暂不支持的例如 Pencil 没有虚线边框。</li>
</ul>
<p><strong>浏览器类</strong></p>
<ul>
<li><strong>Cursor IDE Browser</strong>：在 Cursor 内打开目标页、拉快照、截图、简单交互。用于 UI 验收时「真实页面 vs 设计稿」比对。<strong>在 Cursor 里做 UI 验收时，优先用 Cursor IDE Browser，效果比 Playwright MCP 更好</strong>（集成度、稳定性、截图比对流程更顺）。</li>
<li><strong>Playwright MCP</strong>：同样可打开页面、截图、操作，适合不在 Cursor 或需要脚本化验收时使用。</li>
</ul>
<p><strong>接口与文档类</strong></p>
<ul>
<li><strong>接口文档 MCP（如 ApiFox）</strong>：读/刷新项目 OAS 等，在业务开发/联调时按当前文档生成或校验请求与类型，避免接口变更后模型用旧假设。</li>
<li><strong>Context7</strong>：按需注入当前版本的库文档与代码示例，在页面/业务开发时减少依赖过时、模型幻觉 API 的问题。</li>
</ul>
<hr/>
<h2 data-id="heading-4">Rules</h2>
<p><strong>Rules 是什么</strong>：写在项目里的持久化指导，约定规范、约束和惯例（项目概述、编码、结构、组件、API、路由、状态、样式、文档、测试等），让 Agent 遵守「做什么、不做什么」。</p>
<p><strong>实践中的演进历程</strong>：</p>
<ul>
<li>最初是一整个大 Rule.md，上下文过大、易丢记忆、难按场景聚焦；</li>
<li>后来按模块拆成多份（如 01～11），按需读；</li>
<li>Skills 加入后，Rules 只需要保留原则与约束，把步骤、检查点、模板、示例迁到 Skills，实现渐进式披露。</li>
</ul>
<p><strong>项目级 Rules 清单</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">.agents/rules/
├── 01-项目概述.md
├── 02-编码规范.md
├── 03-项目结构.md
├── 04-组件规范.md
├── 05-API规范.md
├── 06-路由规范.md
├── 07-状态管理.md
├── 08-通用约束.md
├── 09-样式规范.md
├── 10-文档规范.md
├── 11-测试规范.md
└── README.md
</code></pre>
<p><strong>Rules 目录下的 README 清晰的介绍了各个 rule 的作用和使用时机</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目规范索引</span>

本目录包含前端项目的开发规范，按模块分类组织，便于快速查找。

<span class="hljs-section">## 规范模块列表</span>

<span class="hljs-section">### 📋 [<span class="hljs-string">01-项目概述</span>](<span class="hljs-link">./01-项目概述.md</span>)</span>

<span class="hljs-bullet">-</span> 项目定位
<span class="hljs-bullet">-</span> 技术栈

<span class="hljs-section">### 💻 [<span class="hljs-string">02-编码规范</span>](<span class="hljs-link">./02-编码规范.md</span>)</span>

<span class="hljs-bullet">-</span> TypeScript 规范
<span class="hljs-bullet">-</span> 命名规范（文件夹、变量、常量、接口、组件等）
<span class="hljs-bullet">-</span> 业务函数命名（事件处理、内部处理）

<span class="hljs-section">### 📁 [<span class="hljs-string">03-项目结构</span>](<span class="hljs-link">./03-项目结构.md</span>)</span>

<span class="hljs-bullet">-</span> 目录结构概览
<span class="hljs-bullet">-</span> 各目录使用约束（禁止新建非标准目录）

<span class="hljs-section">### 🧩 [<span class="hljs-string">04-组件规范</span>](<span class="hljs-link">./04-组件规范.md</span>)</span>

<span class="hljs-bullet">-</span> 组件结构规范
<span class="hljs-bullet">-</span> 组件层级规划（通用 vs 页面级）

<span class="hljs-section">### 🌐 [<span class="hljs-string">05-API规范</span>](<span class="hljs-link">./05-API规范.md</span>)</span>

<span class="hljs-bullet">-</span> 接口请求规范
<span class="hljs-bullet">-</span> 接口函数命名（NON-NEGOTIABLE）
<span class="hljs-bullet">-</span> 接口错误处理（NON-NEGOTIABLE）

<span class="hljs-section">### 🛣️ [<span class="hljs-string">06-路由规范</span>](<span class="hljs-link">./06-路由规范.md</span>)</span>

<span class="hljs-bullet">-</span> 路由结构规范
<span class="hljs-bullet">-</span> 路由与菜单规范（NON-NEGOTIABLE）

<span class="hljs-section">### 🗄️ [<span class="hljs-string">07-状态管理</span>](<span class="hljs-link">./07-状态管理.md</span>)</span>

<span class="hljs-bullet">-</span> Zustand 使用规范
<span class="hljs-bullet">-</span> Store 组织规范
<span class="hljs-bullet">-</span> 持久化策略

<span class="hljs-section">### ⚙️ [<span class="hljs-string">08-通用约束</span>](<span class="hljs-link">./08-通用约束.md</span>)</span>

<span class="hljs-bullet">-</span> 语言规范（中文注释）
<span class="hljs-bullet">-</span> 可观测性与兜底
<span class="hljs-bullet">-</span> 约束汇总

<span class="hljs-section">### 🎨 [<span class="hljs-string">09-样式规范</span>](<span class="hljs-link">./09-样式规范.md</span>)</span>

<span class="hljs-bullet">-</span> SCSS Modules 使用规范
<span class="hljs-bullet">-</span> 主题色 CSS 变量（NON-NEGOTIABLE）

<span class="hljs-section">### 📝 [<span class="hljs-string">10-文档规范</span>](<span class="hljs-link">./10-文档规范.md</span>)</span>

<span class="hljs-bullet">-</span> 注释规范
<span class="hljs-bullet">-</span> JSDoc 使用

<span class="hljs-section">### ✅ [<span class="hljs-string">11-测试规范</span>](<span class="hljs-link">./11-测试规范.md</span>)</span>

<span class="hljs-bullet">-</span> 测试覆盖要求
<span class="hljs-bullet">-</span> 质量门禁

<span class="hljs-section">## 使用说明</span>

<span class="hljs-bullet">1.</span> 根据需要的规范类型，点击对应的模块链接查看详细内容
<span class="hljs-bullet">2.</span> 所有规范文件都包含 <span class="hljs-code">`alwaysApply: true`</span> 标记，确保规范自动应用
<span class="hljs-bullet">3.</span> 详细示例与落地步骤见 <span class="hljs-code">`.agents/skills/`</span> 目录下的技能文件

<span class="hljs-section">## 快速查找</span>

| 需求 | 规范文件 |
|------|----------|
| 项目背景是什么？使用哪些技术栈？ | 01-项目概述 |
| 如何命名函数/变量？ | 02-编码规范 |
| 代码放在哪个目录？ | 03-项目结构 |
| 如何创建/拆分组件？ | 04-组件规范 |
| 如何调用接口？ | 05-API规范 |
| 如何配置路由？ | 06-路由规范 |
| 如何使用 Zustand？ | 07-状态管理 |
| 有哪些通用约束？ | 08-通用约束 |
| 如何使用主题变量？ | 09-样式规范 |
| 如何写注释？ | 10-文档规范 |
| 有何测试要求？ | 11-测试规范 |

</code></pre>
<p>更详细的 rules 落地示例见：<a href="https://juejin.cn/post/7603444191448104994" target="_blank" title="https://juejin.cn/post/7603444191448104994"><strong>《前端 AI Coding 落地指南（二）Rules 篇》</strong></a>。</p>
<hr/>
<h2 data-id="heading-5">Skills</h2>
<p><strong>Skills 是什么</strong>：用 Markdown 写的技能文件，教会 Agent 完成某一类任务。一个技能一个目录，必有 <code>SKILL.md</code>（YAML 头 + 步骤 + 示例），可带子规则。</p>
<p><strong>Skills 有什么用</strong>：按场景加载、渐进披露，例如在 Rules 划好边界的前提下给「怎么做」的步骤与示例拆分成 skills，避免大量 rules 导致上下文庞大，模型无法集中，出现幻觉和记忆丢失问题。</p>
<p><strong>开源 Skills</strong>：</p>
<p>有许多开源的优质 skills，直接安装到你的项目中大有裨益，在我的 React 项目中就用到了以下开源 skills</p>



































<table><thead><tr><th>技能</th><th>简介</th><th>使用环节</th></tr></thead><tbody><tr><td>vercel-react-best-practices</td><td>React 代码编写的最佳实践</td><td>页面/业务开发时按需引用</td></tr><tr><td>vercel-composition-patterns</td><td>复合组件、状态提升、避免 boolean props 等</td><td>设计组件 API、组合与状态时</td></tr><tr><td>web-design-guidelines</td><td>通用 UI/UX 设计指南</td><td>UI 分析、实现时参考</td></tr><tr><td>find-skills</td><td>查找并选用可用技能</td><td>需要发现技能时</td></tr><tr><td>skill-creator</td><td>创建新技能的结构与规范</td><td>扩展能力、新增 Skills 时</td></tr></tbody></table>
<p><strong>自封装 Skills</strong>：</p>
<p>除了开源 skills，你还可以自己封装 skills，当有固定步骤流程且会反复做的任务时，就可以封装成 Skill。在我的项目中就有以下两类自封装的 skill：</p>
<ol>
<li>
<p>从 Rules「怎么做」拆出来的（create-route、create-component、create-api、create-store、theme-variables）；</p>
</li>
<li>
<p>可复用的流程，给予 Agent 指导（create-proposal、design-analysis、ui-verification）。</p>
</li>
</ol>
<p>像 design-analysis、ui-verification 这种内容多的技能，还可以再把细分工具能力等拆到技能下的 rules 子目录里，充分发挥渐进披露的优势，SKILL 只做入口说明。</p>
<pre><code class="hljs language-text" lang="text">.agents/skills/
├── create-proposal/     # 创建提案（SDD proposal、tasks、spec 增量）
│   └── SKILL.md
├── design-analysis/     # 设计稿分析 → UI 分析清单
│   ├── SKILL.md
│   └── rules/          # 分析顺序、四类重点、工作流、输出模板、工具等
├── ui-verification/    # UI 验收 → 问题清单
│   ├── SKILL.md
│   └── rules/          # 比对维度、常见错误、工作流、工具等
├── create-route/       # 新增路由、Page、Loader
├── create-api/         # 新增接口、类型、请求封装
├── create-store/       # 新增 Zustand store
├── create-component/   # 新增/拆分组件
├── theme-variables/    # 主题 CSS 变量使用
└── README.md
</code></pre>
<p><strong>skills 在 AI Coding 过程中发挥的作用</strong>：</p>
<ul>
<li>创建 SDD 提案时同时使用 create-proposal；</li>
<li>有设计稿时用 design-analysis 产出 UI 分析清单；</li>
<li>页面/UI 开发时用 create-route、create-component、theme-variables；</li>
<li>实现完成后用 ui-verification 做还原验收；</li>
<li>业务开发/联调时用 create-api、create-store。</li>
<li>其他开源第三方 skills 在写代码、做架构决策时按需引用。</li>
</ul>
<p><strong>skills 目录下的 README</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: huayiyi-skills-index
<span class="hljs-section">description: 前端项目的技能索引，帮助 Agent 在具体开发场景下选择合适的技能文件。
---</span>

<span class="hljs-section"># 画衣衣项目技能索引</span>

项目在 <span class="hljs-code">`.agents/skills`</span> 下定义了一些与 RULE 配套的技能，用于承载<span class="hljs-strong">**具体实践步骤与示例代码**</span>，避免在 RULE 中塞入过多细节。

<span class="hljs-section">## 当前技能列表</span>

<span class="hljs-bullet">-</span> <span class="hljs-code">`create-api`</span>：创建与维护 HTTP 接口（配合 <span class="hljs-code">`05-API规范`</span> 使用）
<span class="hljs-bullet">-</span> <span class="hljs-code">`create-component`</span>：创建与拆分通用组件/页面级组件（配合 <span class="hljs-code">`03/04`</span> 使用）
<span class="hljs-bullet">-</span> <span class="hljs-code">`create-route`</span>：创建与维护路由目录与 Loader/Page（配合 <span class="hljs-code">`06-路由规范`</span> 使用）
<span class="hljs-bullet">-</span> <span class="hljs-code">`create-store`</span>：使用 Zustand 创建与维护全局状态（配合 <span class="hljs-code">`07-状态管理`</span> 使用）
<span class="hljs-bullet">-</span> <span class="hljs-code">`theme-variables`</span>：正确使用 Antd 与自定义主题 CSS 变量（配合 <span class="hljs-code">`09-样式规范`</span> 使用）

后续如有新的实践场景（例如：测试用例编写、文档撰写模板等），也建议以新的技能目录形式补充到本目录中。

</code></pre>
<p>更详细的 Skills 落地示例见：<a href="https://juejin.cn/post/7603347438013497379" target="_blank" title="https://juejin.cn/post/7603347438013497379"><strong>《前端 AI Coding 落地指南（三）Skills 篇》</strong></a>。</p>
<hr/>
<h2 data-id="heading-6">总结</h2>
<p><strong>当下的局限性</strong>：要高接纳率、少返工，需要较好的模型与算力；在无限额度、高配模型下稳定性才有保障，成本不低。配合 git worktree + 多 Agent 多任务并行，不计成本时接近 100% AI Coding 在技术上可行，成本和流程需按团队权衡。</p>
<p><strong>AI Coding 展望</strong>：模型会更聪明，上下文管理会更智能，交互会更简洁。在这套 MCP + Rules + Skills + SDD 的底座上，只靠 AI Coding 完成日常前端开发不会太远；先跑通「需求 → 提案 → 分析 → 开发 → 验收」闭环，再逐步扩展，接纳率和效率都会有可见提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端 AI Coding 落地指南（二）Rules篇]]></title>    <link>https://juejin.cn/post/7603444191448104994</link>    <guid>https://juejin.cn/post/7603444191448104994</guid>    <pubDate>2026-02-06T09:27:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191448104994" data-draft-id="7603288778678517795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端 AI Coding 落地指南（二）Rules篇"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2026-02-06T09:27:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AntonCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3966693684293240"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端 AI Coding 落地指南（二）Rules篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693684293240/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AntonCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:27:35.000Z" title="Fri Feb 06 2026 09:27:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本篇是《前端 AI Coding 落地指南》的续作，专门讲 <strong>Rules</strong> 的实践：演进过程、设计原则、如何划分模块、何时写 Rules 何时写 Skills，以及项目级 Rules 的完整清单与每条 rule 的头部、介绍和通用化示例。首篇中已给出 Rules 的简要历程与清单，这里展开为可落地的细节。</p>
<hr/>
<h2 data-id="heading-0">Rules 是什么、解决什么问题</h2>
<p><strong>Rules</strong> 是写在项目里的持久化指导，用 Markdown 等形式约定项目的规范、约束和惯例。Agent 在「需要确认某类规范时」按需读取对应规则文件，从而在生成或审查代码时遵守「做什么、不做什么」——命名、目录、接口契约、样式变量、错误处理等有据可查。</p>
<p><strong>作用</strong>：统一边界（减少模型随意发挥）、按需加载（控制上下文长度）、提高接纳率（生成结果更符合项目既有约定）。<strong>能解决的 AI Coding 问题</strong>：规范不一致（没有规则时 AI 易按通用习惯写，与项目脱节）；约束缺失（如「接口必须放某目录」不写进规则就容易漏）；上下文漂移（规则按场景拆分，需要时只加载相关文件，避免一次性塞入整本规范导致注意力分散）。</p>
<hr/>
<h2 data-id="heading-1">演进过程</h2>
<p><strong>一开始：整个项目一个庞大的 Rules</strong><br/>
所有规范、步骤、示例都塞在一个或少数几个大文件里。带来的问题是：单次上下文过大（容易顶到上下文上限或挤占对话）、容易丢记忆/注意力分散（长文档里模型容易「看了后面忘前面」）、难以按场景聚焦（比如只想加个路由，却不得不带着 UI 验收、设计稿分析等无关内容）。结果是步骤漏、检查项漏，接纳率反而不稳定。</p>
<p><strong>中期：按模块拆成多个 Rules</strong><br/>
把「项目概述、编码、结构、组件、API、路由、状态、通用约束、样式、文档、测试」等拆成 01～11 这样的独立文件，需要哪类规范就读哪几个。按需加载效果好很多，上下文压力下来，也便于维护。但还有一个问题没解决：「如何落地」的步骤和示例仍然写在 Rules 里——例如「怎么加一个路由」的详细步骤、目录示例、检查清单，和「路由必须和菜单一致」这类约束混在一起，单文件仍然偏长，且步骤化、可复用工作流不好跨项目复用。</p>
<p><strong>最近：Skills 盛行，Rules 简化 + 实施指导迁到 Skills</strong><br/>
引入 Skills 之后，做了两件事：<strong>Rules 只保留「原则与约束」</strong>（做什么、不做什么、目录/命名/契约），<strong>把「如何一步步做、怎么写示例、产出长什么样」迁到 Skills</strong>，并利用 Skills 的<strong>渐进式披露</strong>（只在执行该任务时加载对应 SKILL 和技能内 rules）。这样 Rules 变薄、按需读；具体落地在 Skills 里按场景加载，既避免上下文爆炸，又避免模型在长文档里「抓不住重点」。<strong>Skills 的详细实践、何时封装、技能下 rules 如何拆分见<a href="https://juejin.cn/post/7603347438013497379" target="_blank" title="https://juejin.cn/post/7603347438013497379">《前端 AI Coding 落地指南（三）Skills 篇》</a>。</strong></p>
<hr/>
<h2 data-id="heading-2">设计原则：哪些写 Rules、哪些写 Skills</h2>
<p><strong>原则概括</strong>：<strong>Rules 回答「是什么 / 不能是什么」，Skills 回答「怎么做 / 先做什么再做什么」。</strong></p>
<p><strong>模块划分</strong>：按「开发时会被问到的决策类型」来拆，而不是按代码目录拆。例如：项目背景与技术栈（项目概述）、命名与风格（编码规范）、文件放哪（项目结构）、组件怎么拆（组件规范）、接口怎么定义和调用（API 规范）、路由和菜单怎么对（路由规范）、状态放哪怎么用（状态管理）、全局约定（通用约束）、样式和主题（样式规范）、注释与测试（文档/测试规范）。这样 Agent 在「要做一个什么类型的决策」时，能对应到某一个或少数几个规则文件。</p>
<p><strong>什么留在 Rules</strong>：原则、约束、契约、目录与命名约定。例如「接口必须放在某目录下」「路由配置必须和菜单配置一致」「错误必须用统一方式处理」「主题色必须走 CSS 变量」——这些是「是/否」判断，不涉及长步骤和大量示例，适合放在 Rules，篇幅可控。</p>
<p><strong>什么放到 Skills</strong>：多步骤流程、检查清单、产出模板、示例代码。例如「创建提案的 5 步」「设计稿分析的 4 步」「加一个路由要创建哪几个文件、每步检查什么」「UI 分析清单/问题清单长什么样」——这些一旦写进 Rules 会让单文件很长，且和「原则」混在一起，不利于按场景加载；放到 Skills 里，用 SKILL.md + 技能内 rules 做渐进披露更合适。</p>
<p><strong>判断方式</strong>：若一句话能说清且不需要示例，放 Rules；若需要「第一步、第二步、检查点、模板、示例」，放 Skills。</p>
<hr/>
<h2 data-id="heading-3">项目级 Rules 清单（目录结构）</h2>
<pre><code class="hljs language-text" lang="text">.agents/rules/
├── 01-项目概述.md
├── 02-编码规范.md
├── 03-项目结构.md
├── 04-组件规范.md
├── 05-API规范.md
├── 06-路由规范.md
├── 07-状态管理.md
├── 08-通用约束.md
├── 09-样式规范.md
├── 10-文档规范.md
├── 11-测试规范.md
└── README.md
</code></pre>
<p>由于篇幅问题，以下每条 rule 示例是简化后的，主要作为参考，后续会把完整的代码放到 github 上。</p>
<hr/>
<h3 data-id="heading-4">01-项目概述</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 项目定位与技术栈概览。当需要了解项目背景、使用的技术栈时读取此规则。
---</span>

<span class="hljs-section"># 项目概述</span>

<span class="hljs-section">## 项目定位</span>
一段话说明项目是什么、面向谁、核心能力。

<span class="hljs-section">## 技术栈</span>
| 领域 | 技术 | 说明 |
|------|------|------|
| UI 框架 | React x.x | 强制使用 |
| 类型系统 | TypeScript x.x | 强制使用，禁止 JavaScript |
| 状态管理 | Zustand / Redux 等 | 统一使用，禁止其他方案 |
| 组件库 | Ant Design / 其他 | 交互 UI 基于此二次封装 |
| 样式方案 | SCSS Modules | 强制使用，禁止全局样式 |
</code></pre>
<hr/>
<h3 data-id="heading-5">02-编码规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 编码规范，包括 TypeScript 使用、命名约定（变量、常量、接口、组件等）、业务函数命名。编写或审查代码时读取。
---</span>

<span class="hljs-section"># 编码规范</span>

<span class="hljs-section">## TypeScript 规范</span>
<span class="hljs-bullet">-</span> 所有代码必须使用 TypeScript，禁止使用 JavaScript
<span class="hljs-bullet">-</span> 禁止使用 <span class="hljs-code">`any`</span>（除非有明确理由并注释）
<span class="hljs-bullet">-</span> 接口、类型使用 PascalCase；组件 Props 必须定义清晰接口

<span class="hljs-section">## 命名规范</span>
| 类型 | 规则 | 示例 |
|------|------|------|
| 文件夹/路由 | kebab-case | user-profile |
| 变量/函数 | camelCase | userList, onSubmit |
| 常量 | UPPER<span class="hljs-emphasis">_CASE | API_</span>TIMEOUT |
| 接口/类 | PascalCase | UserInfo |
| React 组件 | PascalCase | UserProfile |
| 自定义 Hooks | use 开头 | useUserStore |

<span class="hljs-section">## 业务函数命名</span>
<span class="hljs-bullet">-</span> 事件处理：onXxx（如 onSubmit）
<span class="hljs-bullet">-</span> 内部处理：handleXxx（如 handleDelete）
</code></pre>
<hr/>
<h3 data-id="heading-6">03-项目结构</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 目录结构规范，各目录用途与约束（禁止新建非标准目录）。确定代码放哪时读取。
---</span>

<span class="hljs-section"># 项目结构（NON-NEGOTIABLE）</span>

<span class="hljs-section">## 目录结构</span>
src/
├── assets/        # 静态资源
├── components/    # 可复用 UI 组件
├── constants/     # 业务常量、枚举
├── hooks/         # 自定义 Hook
├── http/          # 请求封装
├── interfaces/    # 类型声明（model、api）
├── routes/        # 路由页面
├── stores/        # 全局状态，按业务拆分
├── utils/         # 工具函数
└── 根级入口文件

<span class="hljs-section">## 结构约束</span>
<span class="hljs-bullet">-</span> 常量 → constants/；状态 → stores/；接口类型 → interfaces/（每模块含 model.ts、api.ts）
<span class="hljs-bullet">-</span> 组件 → components/ 或 routes/<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span></span>/components/；路由 → routes/，每路由含 Page、Loader、index.module.scss
</code></pre>
<hr/>
<h3 data-id="heading-7">04-组件规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 组件目录结构、样式方案、通用 vs 页面级。创建或拆分组件时读取。
---</span>

<span class="hljs-section"># 组件规范</span>

<span class="hljs-section">## 组件结构</span>
<span class="hljs-bullet">-</span> 组件在 src/components 或路由下 components，每组件单独目录
<span class="hljs-bullet">-</span> 文件：index.tsx、index.module.scss；必须 SCSS Modules，禁止全局样式
<span class="hljs-bullet">-</span> Props 接口必须明确；使用 classnames 管理动态 class

<span class="hljs-section">## 组件层级</span>
<span class="hljs-bullet">-</span> 页面级：仅单页使用 → routes/<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">page</span>&gt;</span></span>/components/
<span class="hljs-bullet">-</span> 通用：跨页面复用 → src/components/
<span class="hljs-bullet">-</span> 单文件建议不超过 400 行（拆分参考）
</code></pre>
<hr/>
<h3 data-id="heading-8">05-API规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 接口请求封装、函数命名、错误处理。新增或修改接口时读取。
---</span>

<span class="hljs-section"># API 规范</span>

<span class="hljs-section">## 接口请求规范</span>
<span class="hljs-bullet">-</span> 请求使用 src/http 下封装；类型 Params/Body/Response 放在 src/interfaces/<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span></span>/api.ts
<span class="hljs-bullet">-</span> 所有接口集中在 src/http/<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span></span>.ts

<span class="hljs-section">## 接口函数命名（NON-NEGOTIABLE）</span>
| 操作 | 命名规则 | 示例 |
|------|----------|------|
| 获取列表 | getXxxList | getBannerList |
| 获取详情 | getXxxDetail | getBannerDetail |
| 创建/更新/删除 | createXxx / updateXxx / deleteXxx | 禁止 fetch 前缀 |

<span class="hljs-section">## 错误处理（NON-NEGOTIABLE）</span>
<span class="hljs-bullet">-</span> 接口错误由拦截器统一处理，业务代码只处理成功逻辑；禁止重复 message.error
</code></pre>
<hr/>
<h3 data-id="heading-9">06-路由规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 路由目录结构、Page/Loader 模式、路由配置集中管理。新增页面或配置路由时读取。
---</span>

<span class="hljs-section"># 路由规范（NON-NEGOTIABLE）</span>

<span class="hljs-section">## 路由结构</span>
<span class="hljs-bullet">-</span> 路由目录在 src/routes 下，每页单独目录，kebab-case
<span class="hljs-bullet">-</span> 必须包含：Page.tsx、Loader.tsx、index.module.scss
<span class="hljs-bullet">-</span> Loader 只负责懒加载对应 Page，不嵌套 Routes/Route

<span class="hljs-section">## 路由与菜单</span>
<span class="hljs-bullet">-</span> 禁止多处维护路由：全局唯一路由配置集中管理
<span class="hljs-bullet">-</span> 同一页面只在一处被 lazy 引入
</code></pre>
<hr/>
<h3 data-id="heading-10">07-状态管理</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 全局状态使用 Zustand（或项目约定方案）。新增或重构状态时读取。
---</span>

<span class="hljs-section"># 状态管理规范（NON-NEGOTIABLE）</span>

<span class="hljs-section">## 基础规范</span>
<span class="hljs-bullet">-</span> 必须使用项目约定的状态库（如 Zustand），所有 store 放在 src/stores
<span class="hljs-bullet">-</span> 禁止在 src 下新建其他目录存放 store

<span class="hljs-section">## Store 组织</span>
<span class="hljs-bullet">-</span> 按业务模块划分，每模块单独文件；暴露 useXxxStore Hook
<span class="hljs-bullet">-</span> Store 只存数据与业务行为，不耦合 UI 组件
<span class="hljs-bullet">-</span> 需持久化时使用 persist 等中间件
</code></pre>
<hr/>
<h3 data-id="heading-11">08-通用约束</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 语言、可观测性、占位元素等通用约束。确认通用约束时读取。
---</span>

<span class="hljs-section"># 通用约束</span>

<span class="hljs-section">## 语言规范（NON-NEGOTIABLE）</span>
<span class="hljs-bullet">-</span> 文档和代码注释使用中文；变量/函数命名仍用英文

<span class="hljs-section">## 可观测性与兜底</span>
<span class="hljs-bullet">-</span> 任务需完整链路：任务 ID、引用、日志；失败时兜底提示与重试

<span class="hljs-section">## 占位元素</span>
<span class="hljs-bullet">-</span> 图标/图片未定时：用占位 div + TODO 注释，禁止临时 svg/占位图服务；明确标记替换点
</code></pre>
<hr/>
<h3 data-id="heading-12">09-样式规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: SCSS Modules、主题 CSS 变量。编写样式或主题适配时读取。
---</span>

<span class="hljs-section"># 样式规范</span>

<span class="hljs-section">## 基础原则</span>
<span class="hljs-bullet">-</span> 样式采用 SCSS Modules（index.module.scss）；classnames 管理动态 class
<span class="hljs-bullet">-</span> 自定义样式必须使用主题色 CSS 变量，禁止硬编码颜色

<span class="hljs-section">## 主题变量（NON-NEGOTIABLE）</span>
<span class="hljs-bullet">-</span> 主色/文本/背景/边框等使用 var(--ant-color-xxx) 或项目自定义 var(--xxx)
<span class="hljs-bullet">-</span> 确保主题切换（浅色/暗色）一致
</code></pre>
<hr/>
<h3 data-id="heading-13">10-文档规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: JSDoc 与注释规范。编写或审查注释时读取。
---</span>

<span class="hljs-section"># 文档规范</span>

<span class="hljs-section">## 注释规范</span>
<span class="hljs-bullet">-</span> 使用 JSDoc（/** <span class="hljs-emphasis">*/），解释「为什么」而非「是什么」
- 文件头、函数/方法、复杂逻辑、类型定义均需必要说明
</span></code></pre>
<hr/>
<h3 data-id="heading-14">11-测试规范</h3>
<pre><code class="hljs language-markdown" lang="markdown">---
alwaysApply: false
<span class="hljs-section">description: 测试覆盖与质量门禁。确认测试要求时读取。
---</span>

<span class="hljs-section"># 测试规范</span>

<span class="hljs-section">## 测试要求</span>
<span class="hljs-bullet">-</span> 新增功能需必要类型定义，关键业务逻辑需测试用例
<span class="hljs-bullet">-</span> 所有代码通过 TypeScript 与 ESLint 检查
</code></pre>
<hr/>
<p>以上就是项目级 Rules 的完整清单与通用化示例。项目级 Skills 的逐条示例在<a href="https://juejin.cn/post/7603347438013497379" target="_blank" title="https://juejin.cn/post/7603347438013497379">《前端 AI Coding 落地指南（三）Skills 篇》</a>；<a href="https://juejin.cn/post/7603347438013480995#heading-4" target="_blank" title="https://juejin.cn/post/7603347438013480995#heading-4">架构篇</a>、Rules 篇、Skills 篇一起构成从架构到 Rules/Skills 落地的完整指南。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android应用冷启动优化：从测量方法到分层实践]]></title>    <link>https://juejin.cn/post/7603321550247100466</link>    <guid>https://juejin.cn/post/7603321550247100466</guid>    <pubDate>2026-02-06T09:07:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603321550247100466" data-draft-id="7593338828218531855" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android应用冷启动优化：从测量方法到分层实践"/> <meta itemprop="keywords" content="Android,性能优化,源码阅读"/> <meta itemprop="datePublished" content="2026-02-06T09:07:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光光跬步"/> <meta itemprop="url" content="https://juejin.cn/user/1286855157887751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android应用冷启动优化：从测量方法到分层实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1286855157887751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光光跬步
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:07:37.000Z" title="Fri Feb 06 2026 09:07:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>优化Android 应用启动速度是性能优化中重要的一环，当启动速度过慢时，用户可能不愿意等待，从而直接关闭应用。启动速度这不仅影响应用日活，还会影响应用的留存率。</p>
<blockquote>
<p>注意：本文出现的源码基于Android - 15.0.0_r1。另外本文关注主要逻辑，省略部分代码。</p>
</blockquote>
<h2 data-id="heading-1">本文大纲</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63f3fea9189f4a04b52d1186e432e048~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=gFgKCmkLJm%2F7dPTcFmZfeNgKxQQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">一、启动类型</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce2e6a580cb7461499f86c104cc23967~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=dcrw%2F81Uk9g3L0aU%2BnDo%2BOw3t7U%3D" alt="image.png" loading="lazy"/></p>
<p>Android App启动种类共3种：冷启动，温启动，热启动。<br/>
接下来，我们简要介绍这三种启动类型。</p>
<h4 data-id="heading-3">1.1 冷启动</h4>
<ul>
<li><strong>条件</strong>：应用进程完全不存在（被系统杀死或首次启动）</li>
<li><strong>过程</strong>：创建进程 → 初始化应用 → 创建Activity → 渲染界面</li>
<li><strong>特点</strong>：耗时最长，涉及完整启动链，是性能优化的主要目标</li>
</ul>
<h4 data-id="heading-4">1.2 温启动</h4>
<ul>
<li><strong>条件</strong>：应用进程存在，但Activity被销毁（如系统内存回收）</li>
<li><strong>过程</strong>：进程已存在 → 重新创建Activity → 渲染界面</li>
<li><strong>特点</strong>：耗时中等，跳过部分初始化，但仍需重建Activity</li>
</ul>
<h4 data-id="heading-5">1.3 热启动</h4>
<ul>
<li><strong>条件</strong>：应用进程和Activity都在内存中（如按Home键返回）</li>
<li><strong>过程</strong>：直接将Activity从后台带到前台</li>
<li><strong>特点</strong>：耗时最短，近乎瞬间，主要涉及界面切换</li>
</ul>
<h2 data-id="heading-6">二、测量指标</h2>
<p>要想知道启动速度优化的效果，我们就得知道优化前后冷启动时间，因此接下来看看测量指标。</p>
<p>启动时间分为2种: TTID 和 TTFD。</p>
<h3 data-id="heading-7">2.1 初始显示时间 (TTID)</h3>
<p>初始显示所用时间 (TTID) 是指显示应用界面的第一帧所用的时间。此指标用于测量应用生成第一帧所用的时间，包括冷启动期间的进程初始化、冷启动或温启动期间的 activity 创建，以及显示第一帧。包括以下事件序列的总经过时间：</p>
<ul>
<li>启动进程。</li>
<li>初始化对象。</li>
<li>创建并初始化 activity。</li>
<li>膨胀布局。</li>
<li>首次绘制应用。</li>
</ul>
<h3 data-id="heading-8">2.2 完全显示时间 (TTFD)</h3>
<p>完全显示时间 (TTFD) 是指应用达到可与用户互动的状态所用的时间。系统会报告显示应用界面的第一帧以及在显示第一帧后异步加载的内容所需的时间。一般情况下，这是从网络或磁盘加载的主要内容（由应用报告）。换句话说，TTFD 包括 TTID 以及应用可供使用所需的时间。</p>
<h3 data-id="heading-9">2.3 小结</h3>
<p>TTID : 显示应用界面的第一帧所用的时间<br/>
TTFD: 应用达到可与用户互动的状态所用的时间 (TTID + 应用可供使用所需的时间)</p>
<h2 data-id="heading-10">三、测量方法</h2>
<p>看完了测量指标，我们再看看有哪些测量启动时间的方法。</p>
<h3 data-id="heading-11">3.1 基础工具：AS日志与ADB命令</h3>
<h4 data-id="heading-12">3.1.1 Android Studio Logcat命令查看</h4>
<p>Android Studio中查看日志，过滤 tag:ActivityTaskManager Displayed
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/282fb8ecfa4e4945bcf54b547d42e089~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=fjjr5UVO4kiaXVmDOXWwQdZkFys%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>注：这个日志是显式的初始显示所用时间 (TTID)</p>
</blockquote>
<h4 data-id="heading-13">3.1.2 adb shell am start -W命令</h4>
<p>adb shell am start -W 包名/首屏Activity<br/>
比如：adb shell am start -W com.xxx.xxx/com.xxx.xxx.MainActivity
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acb40c82663c4932a0139a8a846e0541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=noM5dCMclx3NwTEa98DnQvx7JAs%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>ThisTime:：最后一个Activity启动耗时</li>
<li>TotalTime：所有Acitivity启动耗时</li>
<li>WaitTime：AMS启动Activity的总耗时</li>
</ul>
<p>注：ThisTime &lt;= TotalTime &lt; WaitTime</p>
<h3 data-id="heading-14">3.2 官方方案：Jetpack Macrobenchmark</h3>
<p>谷歌官方的 <strong>Jetpack Macrobenchmark</strong> 可以用来测量启动时间, 它的使用也是很方便的：
New -&gt; New Module -&gt; 选择Benchmark -&gt; 点击Finish即可
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/166d5ec97c384af9b79d7dd8f975b724~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=AQwK%2FJqi6iaUJQQMDwqORTjZMtQ%3D" alt="image.png" loading="lazy"/></p>
<p>如下是定义一个测试次数为5次的冷启动测试</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@RunWith(AndroidJUnit4::class)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleStartupBenchmark</span> {
    <span class="hljs-meta">@get:Rule</span>
    <span class="hljs-keyword">val</span> benchmarkRule = MacrobenchmarkRule()

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startup</span><span class="hljs-params">()</span></span> = benchmarkRule.measureRepeated(
        <span class="hljs-comment">// 被测应用的包名</span>
        packageName = <span class="hljs-string">"com.xxx.xxx"</span>,
        <span class="hljs-comment">// 基准测试中提取的主要信息类型</span>
        metrics = listOf(StartupTimingMetric()),
        <span class="hljs-comment">// 设置测试次数</span>
        iterations = <span class="hljs-number">5</span>,
        <span class="hljs-comment">// 设置启动模式为</span>
        startupMode = StartupMode.COLD
    ) {
        pressHome()
        startActivityAndWait()
    }
}
</code></pre>
<blockquote>
<p>如果要测量TTFD，记得在<strong>应用页面</strong>(不是在Macrobenchmark模块)中调用 ComponentActivity#reportFullyDrawn 方法</p>
</blockquote>
<p>测试完成后，会展示简略的测试结果，显示TTID TTFD
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e289de04465c4a859be7a3ea54224eca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=sHEvaxLA%2BNbChXah12pYtbU7QPI%3D" alt="image.png" loading="lazy"/></p>
<p>而在benchmark/build/outputs/connected_android_test_additional_output/benchmark/connected/设备名 下面会生成测试报告
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3c5ce7d29fe404da63b797a14c1423a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=BHz5Jl63ZiCHzUXh86Qy7tG5JOQ%3D" alt="image.png" loading="lazy"/></p>
<p>打开包名-benchmarkData.json可以看到此次测试的设备信息，每次测试的时间、
最长/短启动时间、P50</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 设备信息</span>
    ... 
    <span class="hljs-attr">"benchmarks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"startup"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"className"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.xxx.xxx"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"totalRunTimeNs"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">58688817257</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"metrics"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"timeToInitialDisplayMs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                    <span class="hljs-attr">"minimum"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">547.887593</span><span class="hljs-punctuation">,</span>
                    <span class="hljs-attr">"maximum"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">641.342603</span><span class="hljs-punctuation">,</span>
                    <span class="hljs-attr">"median"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">583.550673</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// P50</span>
                    <span class="hljs-attr">"coefficientOfVariation"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.05969737243251711</span><span class="hljs-punctuation">,</span>
                    <span class="hljs-attr">"runs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                        <span class="hljs-number">641.342603</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-number">612.770907</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-number">580.224135</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-number">583.550673</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-number">547.887593</span>
                    <span class="hljs-punctuation">]</span>
                <span class="hljs-punctuation">}</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            ...
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>生成的.perfetto-trace，我们可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fui.perfetto.dev%2F" target="_blank" title="https://ui.perfetto.dev/" ref="nofollow noopener noreferrer">ui.perfetto.dev/</a> 打开它，截图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b12be93e3b74432dbdd348dba58ab935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=itEGEi%2BIXOP%2FWQTvbLx9NYLukx8%3D" alt="image.png" loading="lazy"/></p>
<p>当然 Android Studio 也是可以打开(open-&gt;选择要打开的文件)这种类型的文件，截图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07bb20636a7d4eb4935c1a155fed4618~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=RzvupjMdHxQWmfqt5nKwFwDctsI%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>Macrobenchmark官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Ftopic%2Fperformance%2Fbenchmarking%2Fmacrobenchmark-overview%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/topic/performance/benchmarking/macrobenchmark-overview?hl=zh-cn" ref="nofollow noopener noreferrer">Jetpack Macrobenchmark</a>; Macrobenchmark官方Demo: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fperformance-samples" target="_blank" title="https://github.com/android/performance-samples" ref="nofollow noopener noreferrer">github.com/android/per…</a></p>
</blockquote>
<h3 data-id="heading-15">3.3 自动化测试脚本</h3>
<h4 data-id="heading-16">3.3.1 开发原因</h4>
<p>AS日志与ADB命令测试方便但只能测试一次，多次测试需要重复操作，且无法统计P50, P90等信息，也没有当前设备信息。</p>
<p>而官方的Macrobenchmark呢，笔者发现国内设备(测试华为Y9, iqoo13)上，使用Macrobenchmark无法测试。想使用一种更通用的方式，编写脚本不失为一种好的方式，脚本测试方便且通用。因脚本内容较长，故放在了github上。详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Fblob%2Fmain%2Fapp_launch_benchmark.sh" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/blob/main/app_launch_benchmark.sh" ref="nofollow noopener noreferrer">AndroidStartupOptimizationDemo</a></p>
<blockquote>
<p>注：此脚本参考了马哥的脚本，详见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FvW6-zag2CKrFgcYAPdeUFg" target="_blank" title="https://mp.weixin.qq.com/s/vW6-zag2CKrFgcYAPdeUFg" ref="nofollow noopener noreferrer">App冷启动优化测试干货分享（一）</a>。笔者做了以下改动：1.合并了app_launch_benchmark.sh 和 app_config.cfg。2.添加了P50, P90, P95和设备信息(如Android系统版本，内存信息等)；3.生成start_up_reports文件夹，将启动报告统一放在了此文件夹下；4.多次测试会卡住，添加adb server 重启策略和超时处理</p>
</blockquote>
<h4 data-id="heading-17">3.3.2 使用方式</h4>
<ol>
<li>复制脚本到项目根目录下</li>
<li>修改包名和MainActivity为当前应用</li>
</ol>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 内置默认配置（原 app_config.cfg）</span>
<span class="hljs-comment"># ============================================</span>
DEFAULT_CONFIG_CONTENT=$(<span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># App启动时间测试配置文件</span>
<span class="hljs-comment"># 格式：包名|Activity类名|显示名称|启动类型|备注</span>

<span class="hljs-comment"># 系统应用 - 冷启动测试</span>
<span class="hljs-comment"># com.android.settings|com.android.settings.Settings|系统设置|cold|冷启动测试</span>
<span class="hljs-comment"># com.android.dialer|com.android.dialer.main.impl.MainActivity|拨号器|cold|冷启动测试</span>

<span class="hljs-comment"># 第三方应用</span>
<span class="hljs-comment"># com.tencent.mm|com.tencent.mm.ui.LauncherUI|微信|cold|社交应用冷启动</span>
<span class="hljs-comment"># com.taobao.taobao|com.taobao.tao.homepage.MainActivity3|淘宝|warm|电商应用温启动</span>
<span class="hljs-comment"># 此处添加当前应用信息</span>
</code></pre>
<ol start="3">
<li>git命令行执行当前脚本</li>
</ol>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># 使用方式</span>
<span class="hljs-comment"># ============================================</span>
<span class="hljs-comment"># ./app_launch_benchmark.sh                     # 使用默认配置测试</span>
<span class="hljs-comment"># ./app_launch_benchmark.sh -n 5      # 测试5次</span>
<span class="hljs-comment"># ./app_launch_benchmark.sh -c xxx.cfg -n 5 # 自定义配置，测试5次</span>
</code></pre>
<h4 data-id="heading-18">3.3.3 测试截图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0288a98a4c1a4033a344de24eda0e1e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=dHw4dj96xZoUJ8oYW3vZOewUC0k%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-19">四、优化方法</h2>
<h3 data-id="heading-20">4.1 常规优化</h3>
<h4 data-id="heading-21">4.1.1 收敛ContentProviders</h4>
<h5 data-id="heading-22">原理</h5>
<p>在应用启动流程中，会安装ContentProvider。时序图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa0b5c1347f64e38b99b1a56493fd7f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=lVmFcHD%2BJUCjdbJPACsDTQXqgP4%3D" alt="image.png" loading="lazy"/></p>
<p>ActivityThread#installContentProviders的代码如下：</p>
<pre><code class="hljs language-Java" lang="Java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindApplication</span><span class="hljs-params">(AppBindData data)</span> {
        ...
        
        <span class="hljs-comment">// 安装ContentProvider</span>
        installContentProviders(app, data.providers);
        ...
    }
</code></pre>
<p>在应用启动的 ActivityThread#handleBindApplication 阶段，系统会调用 installContentProviders。如果 Manifest 中声明了多个 Provider（如 Firebase、Facebook SDK 各自带一个），系统会<strong>串行</strong>初始化它们，这会占用主线程几十到上百毫秒。</p>
<h5 data-id="heading-23">优化方案</h5>
<p>使用 Jetpack Startup 将多个 Provider 合并为一个初始化入口</p>
<p>首先要确定当前应用有哪些ContentProvider，使用 AS 打开 Apk/aab里面的Manifest</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>
    &lt;<span class="hljs-attr">application</span>
        <span class="hljs-attr">...</span>
        &lt;<span class="hljs-attr">provider</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.facebook.internal.FacebookInitProvider"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"com.xxx.xxx.FacebookInitProvider"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.google.mlkit.common.internal.MlKitInitProvider"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"com.xxx.xxx.mlkitinitprovider"</span>
            <span class="hljs-attr">android:initOrder</span>=<span class="hljs-string">"99"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.google.firebase.provider.FirebaseInitProvider"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"com.xxx.xxx.firebaseinitprovider"</span>
            <span class="hljs-attr">android:initOrder</span>=<span class="hljs-string">"100"</span>
            <span class="hljs-attr">android:directBootAware</span>=<span class="hljs-string">"true"</span> /&gt;</span>
         ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<p>比如当前示例App的Manifest中，未收敛时有3个ContentProvider,</p>
<p>官方提供了Jetpack StartUp, 我们可以用它来收敛ContentProvider，使用方法如下：<br/>
首先定义各个启动器</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FirebaseCombinedInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        <span class="hljs-comment">// 初始化 FirebaseApp, 防止未 initialize 报错</span>
        FirebaseApp.initializeApp(context)

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取 Firebase Analytics 的 appInstanceId</span>
            FirebaseAnalytics.getInstance(context).appInstanceId
                .addOnCompleteListener { task -&gt;
                    task.result?.let { id -&gt;
                        SpUtil.saveStringData(SpKeyConstants.FIREBASE_ID, id)
                    }
                }
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Timber.tag(<span class="hljs-string">"FirebaseInit"</span>).e(e, <span class="hljs-string">"获取 appInstanceId 失败"</span>)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; = emptyList()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FacebookManualInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        <span class="hljs-comment">// 使用协程在后台线程激活 App Events，避免阻塞</span>
        CoroutineScope(Dispatchers.IO).launch {
            <span class="hljs-keyword">try</span> {
                AppEventsLogger.activateApp(context <span class="hljs-keyword">as</span> Application)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                <span class="hljs-comment">// 忽略初始化失败，避免影响启动</span>
            }
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;?&gt;?&gt; = emptyList()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MlKitManualInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        MlKit.initialize(context)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;?&gt;?&gt; = emptyList()
}
</code></pre>
<p>然后修改Manifest</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"androidx.startup.InitializationProvider"</span>
    <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.androidx-startup"</span>
    <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Firebase 初始化，无依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.xxxr.FirebaseCombinedInitializer"</span>
        <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- ML Kit 初始化，无依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.xxx.MlKitManualInitializer"</span>
        <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- Facebook 初始化，无依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.xxx.FacebookManualInitializer"</span>
        <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">provider</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.google.firebase.provider.FirebaseInitProvider"</span>
    <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.firebaseinitprovider"</span>
    <span class="hljs-attr">tools:node</span>=<span class="hljs-string">"remove"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.facebook.internal.FacebookInitProvider"</span>
    <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.FacebookInitProvider"</span>
    <span class="hljs-attr">tools:node</span>=<span class="hljs-string">"remove"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.google.mlkit.common.internal.MlKitInitProvider"</span>
    <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.mlkitinitprovider"</span>
    <span class="hljs-attr">tools:node</span>=<span class="hljs-string">"remove"</span> /&gt;</span>
</code></pre>
<p>到这里就结束了，实际操作其实不复杂。</p>
<h5 data-id="heading-24">验证</h5>
<p>最后验证下是否生效了，我们打开收敛后Apk中的Mainfest文件</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>
    &lt;<span class="hljs-attr">application</span>
        <span class="hljs-attr">...</span>
        &lt;<span class="hljs-attr">provider</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">"androidx.startup.InitializationProvider"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"com.xxx.androidx-startup"</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
                <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.AppsFlyerInitializer"</span>
                <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
                <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.initializer.FirebaseCombinedInitializer"</span>
                <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
                <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.initializer.MlKitManualInitializer"</span>
                <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
                <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.initializer.FacebookManualInitializer"</span>
                <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>

            ...
        <span class="hljs-tag">&lt;/<span class="hljs-name">provider</span>&gt;</span>
        ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<p>可以看到，收敛后Apk的Manifest中，仅有1个ContentProvider</p>
<h5 data-id="heading-25">优化效果</h5>





























<table><thead><tr><th>时间类型</th><th>未优化</th><th>优化后</th><th>减少幅度</th></tr></thead><tbody><tr><td>P50</td><td>465ms</td><td>436ms</td><td>-29ms (-6.24%)</td></tr><tr><td>P90</td><td>476ms</td><td>446ms</td><td>-30ms (-6.30%)</td></tr><tr><td>P95</td><td>480<br/></td><td>451ms</td><td>-29ms (-6.04%)</td></tr></tbody></table>
<blockquote>
<p>详细的测试数据请看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Ftree%2Ffeature%2Fcontent-provider%2Fstart_up_reports" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/tree/feature/content-provider/start_up_reports" ref="nofollow noopener noreferrer">AndroidStartupOptimizationDemo/start_up_reports at feature/content-provider</a></p>
</blockquote>
<h4 data-id="heading-26">4.1.2 初始化优化与任务调度</h4>
<h5 data-id="heading-27">时机优化</h5>
<p><strong>a.延迟/按需初始化</strong></p>
<p>对于启动非必要的任务，我们可以延迟/按需它的初始化，减少初始化的任务，从而减少应用启动的时间。<br/>
比如上面的MlKitManualInitializer，它其实是非启动必需的任务，用户并不是每次使用应用，都需要用到人脸识别，因此我们可以在调用它之前的页面，去初始化它。还可以进一步根据后端返回字段，如果xx接口返回此次需要使用人脸识别，那么我们再初始化它。</p>
<p><strong>b.异步初始化</strong></p>
<p>对于启动必需但不需要同步的任务，我们可以通过异步初始化，这样就不会阻塞主线程，从而减少应用启动的时间。</p>
<p><strong>c.首屏数据加载策略</strong></p>
<p>对于启动后立即需要的首屏数据（如用户信息、配置列表），其加载也属于启动必需但无需阻塞主线程的任务。我们可以进一步优化：</p>
<ul>
<li><strong>并行请求</strong>：将多个独立的数据请求并行发起，而非串行等待。</li>
<li><strong>高效解析</strong>：选用性能更优的序列化库（如替换默认的Gson为Kotlin serialization或Moshi），减少数据反序列化的CPU耗时。详见<a href="https://juejin.cn/post/7287083662758379554" target="_blank" title="https://juejin.cn/post/7287083662758379554">常用 JSON 库性能对比: Gson VS Moshi VS Kotlin Serialization VS ...</a></li>
<li><strong>缓存优先</strong>：对于不要求实时数据的首屏页面，可以先展示缓存页面，后进行网络更新，即优先展示本地缓存数据，让UI快速可交互，后台再更新数据。</li>
</ul>
<p>这些策略虽不直接影响 TTID，但能显著缩短 TTFD，让用户更快地开始使用应用。</p>
<p><strong>d.优化效果</strong></p>
<p>在示例App中，使用收敛ContentProvider、异步初始化任务和延迟初始化后的优化前后对比如下：</p>





























<table><thead><tr><th>时间类型</th><th>未优化</th><th>优化后</th><th>减少幅度</th></tr></thead><tbody><tr><td>P50</td><td>465ms</td><td>436ms</td><td>-29ms (-6.23%)</td></tr><tr><td>P90</td><td>476ms</td><td>445ms</td><td>-31ms (-6.51%)</td></tr><tr><td>P95</td><td>480<br/></td><td>449ms</td><td>-31ms (-6.46%)</td></tr></tbody></table>
<blockquote>
<p>详细的测试数据请看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Ftree%2Ffeature%2Finit-optimization-strategy%2Fstart_up_reports" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/tree/feature/init-optimization-strategy/start_up_reports" ref="nofollow noopener noreferrer">AndroidStartupOptimizationDemo/start_up_reports at feature/init-optimization-strategy</a></p>
</blockquote>
<h5 data-id="heading-28">编排初始化任务</h5>
<p>在初始化任务时，应用可能会存在依赖的情况，如任务A的初始化完成后，任务B的初始化才能正常执行。我们先画出任务间依赖关系的有向图，先理清任务间的关系，后续使用官方的 <strong>StartUp</strong> 来编排任务。</p>
<p>举个例子，现有任务a,b,c,d,e，然后 c依赖a，d依赖b，然后 e依赖d，c。<br/>
先画出有向无环图，如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3925bc5a4e04a7295ac0069e1c2495c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=F8ScsZ1pdlWawvPq3k1o7Fg0KpE%3D" alt="image.png" loading="lazy"/></p>
<p>之后创建各个任务的启动器</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        Log.d(<span class="hljs-string">"AInitializer"</span>, <span class="hljs-string">"create: AInitializer"</span>)
    }

    <span class="hljs-comment">// A无依赖</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; = emptyList()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        Log.d(<span class="hljs-string">"BInitializer"</span>, <span class="hljs-string">"create: BInitializer"</span>)
    }

    <span class="hljs-comment">// B无依赖</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; = emptyList()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        Log.d(<span class="hljs-string">"CInitializer"</span>, <span class="hljs-string">"create: CInitializer"</span>)
    }

    <span class="hljs-comment">// C依赖A</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; =
        listOf(AInitializer::<span class="hljs-keyword">class</span>.java)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        Log.d(<span class="hljs-string">"DInitializer"</span>, <span class="hljs-string">"create: DInitializer"</span>)
    }

    <span class="hljs-comment">// D依赖B</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; =
        listOf(BInitializer::<span class="hljs-keyword">class</span>.java)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        Log.d(<span class="hljs-string">"EInitializer"</span>, <span class="hljs-string">"create: EInitializer"</span>)
    }

    <span class="hljs-comment">// E依赖C,D</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;Class&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; =
        listOf(CInitializer::<span class="hljs-keyword">class</span>.java, DInitializer::<span class="hljs-keyword">class</span>.java)
}
</code></pre>
<p>后续在manifest中，声明E的启动器即可，StartUp 会自动解析依赖关系</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">application</span>
        <span class="hljs-attr">...</span>
        &lt;<span class="hljs-attr">provider</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">"androidx.startup.InitializationProvider"</span>
            <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.androidx-startup"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">tools:node</span>=<span class="hljs-string">"merge"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
                <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.xxx.xxx.initializer.EInitializer"</span>
                <span class="hljs-attr">android:value</span>=<span class="hljs-string">"androidx.startup"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<p>后续运行代码，打印日志如下：<br/>
create: AInitializer<br/>
create: CInitializer<br/>
create: BInitializer<br/>
create: DInitializer<br/>
create: EInitializer</p>
<h4 data-id="heading-29">4.1.3 基准配置文件</h4>
<p>基准配置文件是官方推荐使用的一种优化方式，下面先看看它的原理吧。</p>
<h5 data-id="heading-30">原理</h5>
<p>我们可以通过一个生活中的例子来理解它的工作原理：第一次到朋友家，他让我们帮忙找东西。当没有使用基准配置文件时，就相当于我们不知道东西在哪里，那么只能每个房间、每个位置都翻找一遍；而使用基准配置文件后，就相当于朋友提前给了我们一份文件清单，上面清楚标明了每样东西的位置，我们按图索骥，就能快速找到目标。</p>
<p><strong>这个文件清单，对应的就是基准配置文件（Profile-Guided Optimization，PGO）技术生成的热点代码清单（baseline-prof.txt）。</strong></p>
<p>在技术层面，传统的AOT（提前）编译会试图编译所有代码，这往往导致应用安装缓慢且包体积增大。而PGO则反其道而行之：它通过在真实设备上运行应用，记录下实际使用时的关键执行路径（例如启动过程），从而生成一份针对性的“热点代码清单”。</p>
<p>ART运行时在<strong>两个时机</strong>使用这份清单：</p>
<ol>
<li><strong>安装时</strong>：对清单中的方法进行AOT编译</li>
<li><strong>后台优化</strong>：设备空闲时，根据实际使用情况进一步优化</li>
</ol>
<p>这样既减少了运行时解释/JIT开销，又避免了"全量编译"的弊端。</p>
<h5 data-id="heading-31">使用基准配置文件</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f39147c7018e471dbc965026b41a330e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=QnK31F10BrfyMV3NcvSqvSaxEdY%3D" alt="image.png" loading="lazy"/><br/>
在AS中选择 File -&gt; New -&gt; New Module</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87efbfcf8fb44acebeb95cd98f4040ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=lV8kXVMSIrssPKEH4Ver%2FJ4ZP6I%3D" alt="image.png" loading="lazy"/>
选择Baseline Profile Generator，点击Finish。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed716e0d8457490991e072d4d32948ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=OAdccydig1qR6I8nzn7eTcDD1L4%3D" alt="image.png" loading="lazy"/><br/>
之后会生成一个名为 BaselineProfile 的新模块。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aac78e2c87d41f9a63798d19ceea5cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=8QHxIgf0qcTs5C%2BWlvU%2BPD36FqQ%3D" alt="image.png" loading="lazy"/>
现在点击运行 Generate Baseline Profile for app，提示Error: Target module's selected variant is debuggable. Please use Build Variants tools window to change the variant of Dex.app。就是说需要使用 release 变体（非 debuggable 版本）。</p>
<p>这里就不介绍怎么生成 release 签名文件了，直接看 release 签名配置完成之后。</p>
<blockquote>
<p>详细签名步骤，请读者自行查看官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Fstudio%2Fpublish%2Fapp-signing%3Fhl%3Dzh-cn%23sign-apk" target="_blank" title="https://developer.android.google.cn/studio/publish/app-signing?hl=zh-cn#sign-apk" ref="nofollow noopener noreferrer">为应用签名</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/512418ff3ff24c8ca47d596595cd0bd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=TFu1uX1DysBEONZzZe3UvPjLMHU%3D" alt="image.png" loading="lazy"/><br/>
配置完签名，修改 <strong>App 模块的 Build Variant</strong>，再次点击图标，运行 Generate Baseline Profile for app</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd60518568dc43b3ac0b3eb72ba30add~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=QWqrojKEAEtt537AB9Jq2j1NL9I%3D" alt="image.png" loading="lazy"/><br/>
运行完成之后，我们会在 app/src/xxxRelease/generated 下面看到生成了 baseline-prof.text 和 startup-prof.text 文件</p>
<h4 data-id="heading-32">4.1.4 启动配置文件</h4>
<p>在上一节中，我们通过基准配置文件知道了“东西”的位置。本小节我们来了解另一个关键的优化文件——启动配置文件，看看它如何在此基础上进行更深层的优化。</p>
<h5 data-id="heading-33">原理</h5>
<p>我们可以继续用“找东西”的例子来理解它的工作原理：基准配置文件已经告诉我们东西在哪，但它们仍然分散在各个房间。<strong>启动配置文件</strong>则更进一步，相当于朋友提前把要用的所有东西打包进了几个背包，并把背包放在了门口。这样，你进门就能直接拿到所有必需品，省去了去各个房间的时间。</p>
<p>在技术上，启动配置文件的核心原理是 <strong>DEX布局优化</strong>，其根本目标是减少应用启动过程中的<strong>缺页中断</strong>，从而降低耗时的IO操作，最终显著缩短启动时间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f795a0f419f48068eadce55fe5d236a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=SIFqJ8DwdfehHQtj7z6wVAjtrTg%3D" alt="image.png" loading="lazy"/>
借用官网的一张图来说明:</p>
<ul>
<li>左侧：在apk中多个classes.dex，启动代码分散在各个classes.dex，且启动各个类非连续排列，此时就会有不必要的缺页中断，增加了多余的IO操作。</li>
<li>右侧：使用DEX布局优化，将原本分散在各个classes.dex中的启动代码放在了主classes.dex，并且连续排列。减少了缺页中断，也就减少了IO操作。</li>
</ul>
<p>也就是说通过优化DEX布局，使启动所需的类在dex中连续存储，然后就能顺序读取，减少磁盘寻道时间，并且减少缺页中断，也就减少了IO操作。我们知道IO操作是比较耗时的，当减少了它之后，启动时间自然也就减少了。</p>
<h5 data-id="heading-34">使用启动配置文件</h5>
<p>使用方式详见4.1.3小节，基准配置文件和启动配置文件会一起生成。</p>
<h5 data-id="heading-35">验证启动配置文件</h5>
<p>首先修改settings.gradle</p>
<pre><code class="hljs language-kts" lang="kts">pluginManagement {
    ...

    buildscript {
        repositories {
            mavenCentral()
            maven {
                url = uri(<span class="hljs-string">"https://storage.googleapis.com/r8-releases/raw"</span>)
            }
        }
        dependencies {
            classpath(<span class="hljs-string">"com.android.tools:r8:8.3.6-dev"</span>)
        }
    }
}
</code></pre>
<p>然后执行如下命令
./gradlew assembleRelease --info</p>
<p>等编译完成后，查看编译日志，可搜索关键字 <strong>Startup DEX</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f09e22c9e914b008f6a426e446449d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=SpJJeJHiq6zdvJQRfyVlc3GK4Kg%3D" alt="image.png" loading="lazy"/></p>
<p>INFO: R8: Startup DEX files contains 3398 classes and 14427 methods of which 7249 (50%) are non-startup methods. Distribution of classes by their number of startup methods:<br/>
0: 737 classes<br/>
1: 1026 classes<br/>
2-3: 1183 classes<br/>
4-5: 245 classes<br/>
6-10: 139 classes<br/>
11+: 68 classes</p>
<p>这表明了编译时，DEX布局已经成功优化了。</p>
<h5 data-id="heading-36">优化效果</h5>
<p>因为基准配置文件和启动配置文件是一起生成了，此处就不分开测试这2种文件了。</p>
<p>在同一设备上，测试同一应用，使用3.3小节的脚本，分别测试了200次未使用 和 使用这2种文件优化前后的冷启动时间，数据如下：</p>





























<table><thead><tr><th>时间类型</th><th>未优化</th><th>优化后</th><th>减少幅度</th></tr></thead><tbody><tr><td>P50</td><td>465ms</td><td>428ms</td><td>-37ms (-7.96%)</td></tr><tr><td>P90</td><td>476ms</td><td>438ms</td><td>-38ms (-7.98%)</td></tr><tr><td>P95</td><td>480<br/></td><td>447ms</td><td>-33ms (-6.88%)</td></tr></tbody></table>
<blockquote>
<p>详细的测试数据请看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Ftree%2Ffeature%2Fbaseline-startup-profiles%2Fstart_up_reports" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/tree/feature/baseline-startup-profiles/start_up_reports" ref="nofollow noopener noreferrer">StudyH2g/AndroidStartupOptimizationDemo at feature/baseline-startup-profiles</a></p>
</blockquote>
<h3 data-id="heading-37">4.2 激进优化</h3>
<p>激进优化的效果依赖于设备硬件、系统版本及实时负载，不具备普遍性，并且有一定的兼容性风险与维护成本。建议读者若有意尝试，务必在深入理解其原理的基础上，<strong>在目标设备上建立完善的测试与监控机制</strong>，谨慎评估其实际收益。</p>
<blockquote>
<p>注： 本节中提到的绑定CPU大核、抑制GC等实现思路与代码示例，主要参考了《Android性能优化之道：从底层原理到一线实践》一书中的方案。<br/>
想过这小节应该叫激进优化还是进阶优化，但考虑到此小节优化方法不具备普遍性，因此还是选择了激进优化。请读者一定要在充分验证后，再考虑上生产环境，并做好相应的兜底策略。</p>
</blockquote>
<h4 data-id="heading-38">4.2.1 <strong>绑定CPU大核</strong></h4>
<p>原理部分就简单说下，读取 /sys/devices/system/cpu/cpu/cpufreq/cpuinfo_max_freq 文件来比较每个核心的最大频率，就可以拿到最高频率的 CPU 核心索引，然后通过 sched_setaffinity 将主线程绑定到 CPU 大核上。</p>
<p>我们就着重看实现部分</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">/**
 * 获取最高频率的 CPU 核心索引（大核）
 * 通过读取 /sys/devices/system/cpu/cpu/cpufreq/cpuinfo_max_freq 文件来比较每个核心的最大频率
 *
 * @param env JNI 环境
 * @param clazz Java 类对象
 * @return 最高频率核心的索引, 如果获取失败则返回 -1
 */</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">JNIEXPORT jint JNICALL
<span class="hljs-title">Java_com_studyh2g_androidstartupoptimizationdemo_jni_JniHelper_getMaxFreqCpuIndex</span><span class="hljs-params">(
        JNIEnv* env,
        jclass clazz)</span> </span>{
    <span class="hljs-comment">// 统计 CPU 核心数量</span>
    <span class="hljs-type">int</span> cores = <span class="hljs-number">0</span>;
    DIR *dir;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dirent</span> *ent;
    <span class="hljs-keyword">if</span>((dir = <span class="hljs-built_in">opendir</span>(<span class="hljs-string">"/sys/devices/system/cpu"</span>)) != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">while</span>((ent = <span class="hljs-built_in">readdir</span>(dir)) != <span class="hljs-literal">NULL</span>) {
            std::string path = ent-&gt;d_name;
            <span class="hljs-comment">// 查找以 "cpu" 开头的目录</span>
            <span class="hljs-keyword">if</span>(path.<span class="hljs-built_in">find</span>(<span class="hljs-string">"cpu"</span>) == <span class="hljs-number">0</span>) {
                <span class="hljs-type">bool</span> isCore = <span class="hljs-literal">true</span>;
                <span class="hljs-comment">// 检查 "cpu" 后面是否全是数字（排除 cpufreq、cpuidle 等非核心目录）</span>
                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">3</span>; i &lt; path.<span class="hljs-built_in">length</span>(); i++) {
                    <span class="hljs-keyword">if</span>(path[i] &lt; <span class="hljs-string">'0'</span> || path[i] &gt; <span class="hljs-string">'9'</span>) {
                        isCore = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
                <span class="hljs-keyword">if</span>(isCore) {
                    cores++;
                }
            }
        }
        <span class="hljs-built_in">closedir</span>(dir);
    }
    <span class="hljs-comment">// 遍历所有核心，找出最高频率的核心</span>
    <span class="hljs-type">int</span> maxFreq = <span class="hljs-number">-1</span>;
    <span class="hljs-type">int</span> maxFreqCoreIndex = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">if</span> (cores != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; cores; i++) {
            <span class="hljs-comment">// 读取每个核心的最大频率文件</span>
            std::string filename = <span class="hljs-string">"/sys/devices/system/cpu/cpu"</span> + std::<span class="hljs-built_in">to_string</span>(i) + <span class="hljs-string">"/cpufreq/cpuinfo_max_freq"</span>;
            <span class="hljs-function">std::ifstream <span class="hljs-title">cpuInfoMaxFreqFile</span><span class="hljs-params">(filename)</span></span>;
            <span class="hljs-keyword">if</span> (cpuInfoMaxFreqFile.<span class="hljs-built_in">is_open</span>()) {
                std::string line;
                <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">getline</span>(cpuInfoMaxFreqFile, line)) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-type">int</span> freqBound = std::<span class="hljs-built_in">stoi</span>(line);
                        <span class="hljs-keyword">if</span> (freqBound &gt; maxFreq) {
                            maxFreq = freqBound;
                            maxFreqCoreIndex = i;
                        }
                    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::invalid_argument&amp; e) {
                        <span class="hljs-comment">// 频率值解析失败，跳过</span>
                    }
                }
                cpuInfoMaxFreqFile.<span class="hljs-built_in">close</span>();
            }
        }
    }
    <span class="hljs-keyword">return</span> maxFreqCoreIndex;
}

<span class="hljs-comment">/**
 * 将当前线程绑定到指定的 CPU 核心
 * 绑定后，当前线程只会在指定的核心上运行，可以利用大核提升性能
 *
 * @param env JNI 环境
 * @param clazz Java 类对象
 * @param coreNum 要绑定的 CPU 核心索引
 */</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">JNIEXPORT <span class="hljs-type">void</span> JNICALL
<span class="hljs-title">Java_com_studyh2g_androidstartupoptimizationdemo_jni_JniHelper_bindToCore</span><span class="hljs-params">(
        JNIEnv* env,
        jclass clazz,
        jint coreNum)</span> </span>{
    <span class="hljs-type">cpu_set_t</span> mask;
    <span class="hljs-comment">// 清空 CPU 集合</span>
    <span class="hljs-built_in">CPU_ZERO</span>(&amp;mask);
    <span class="hljs-comment">// 将指定核心加入集合</span>
    <span class="hljs-built_in">CPU_SET</span>(coreNum, &amp;mask);
    <span class="hljs-comment">// 获取当前线程 ID</span>
    <span class="hljs-type">pid_t</span> tid = <span class="hljs-built_in">gettid</span>();
    <span class="hljs-comment">// 设置线程的 CPU 亲和性（绑定到指定核心）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sched_setaffinity</span>(tid, <span class="hljs-built_in">sizeof</span>(mask), &amp;mask) == <span class="hljs-number">-1</span>) {
        <span class="hljs-comment">// 绑定失败</span>
    }
}

<span class="hljs-comment">/**
 * 获取当前线程绑定的 CPU 核心列表
 * 返回当前线程允许运行的所有 CPU 核心
 *
 * @param env JNI 环境
 * @param clazz Java 类对象
 * @return CPU 核心列表的字符串，如 "Current CPU affinity: 0 1 2 3 4 5 6 7 "
 */</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">JNIEXPORT jstring JNICALL
<span class="hljs-title">Java_com_studyh2g_androidstartupoptimizationdemo_jni_JniHelper_getBoundCores</span><span class="hljs-params">(
        JNIEnv* env,
        jclass clazz)</span> </span>{
    <span class="hljs-type">cpu_set_t</span> mask;
    <span class="hljs-comment">// 获取当前线程 ID</span>
    <span class="hljs-type">pid_t</span> tid = <span class="hljs-built_in">gettid</span>();
    <span class="hljs-comment">// 获取当前线程绑定的 CPU 核心列表（失败则返回错误）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sched_getaffinity</span>(tid, <span class="hljs-built_in">sizeof</span>(mask), &amp;mask) == <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">return</span> env-&gt;<span class="hljs-built_in">NewStringUTF</span>(<span class="hljs-string">"Failed to get affinity"</span>);
    }
    std::string result = <span class="hljs-string">"Current CPU affinity: "</span>;
    <span class="hljs-comment">// 遍历所有可能的 CPU 核心</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CPU_SETSIZE; i++) {
        <span class="hljs-comment">// 检查该核心是否在绑定集合中</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">CPU_ISSET</span>(i, &amp;mask)) {
            result += std::<span class="hljs-built_in">to_string</span>(i) + <span class="hljs-string">" "</span>;
        }
    }
    <span class="hljs-keyword">return</span> env-&gt;<span class="hljs-built_in">NewStringUTF</span>(result.<span class="hljs-built_in">c_str</span>());
}
</code></pre>
<p>然后在启动的Activity#attachBaseContext中调用方法就可以了</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">/**
 * 在应用启动的最早时机将主线程绑定到 CPU 大核
 *
 * attachBaseContext 是 Activity 生命周期中最早执行的回调，此时主线程还未开始执行繁重的初始化工作。
 * 将主线程绑定到大核可以充分利用大核的高性能，减少启动耗时。
 *
 * <span class="hljs-doctag">@param</span> newBase 新的 Context 基对象
 */</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">attachBaseContext</span><span class="hljs-params">(newBase: <span class="hljs-type">Context</span>?)</span></span> {
    <span class="hljs-keyword">super</span>.attachBaseContext(newBase)
    <span class="hljs-comment">// 打印绑定前的 CPU 核心列表（用于验证）</span>
    Log.d(tag, <span class="hljs-string">"attachBaseContext before: <span class="hljs-subst">${JniHelper.getBoundCores()}</span>"</span>)
    <span class="hljs-comment">// 获取最高频率的 CPU 核心索引（大核）</span>
    <span class="hljs-keyword">val</span> maxFreqCpuIndex = JniHelper.getMaxFreqCpuIndex()
    <span class="hljs-keyword">if</span> (maxFreqCpuIndex != -<span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 将主线程绑定到大核</span>
        JniHelper.bindToCore(maxFreqCpuIndex)
        <span class="hljs-comment">// 打印绑定后的 CPU 核心列表（用于验证绑定是否成功）</span>
        Log.d(tag, <span class="hljs-string">"attachBaseContext after: <span class="hljs-subst">${JniHelper.getBoundCores()}</span>"</span>)
    }
}
</code></pre>
<p>日志如下：<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/502fde811c2544f4bdd9d65f8976bbf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=uF3Fn1armpaIQBPjWd%2B%2FIdFBmUc%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>读者可拉取 feature/aggressive-bind-cpu 分支代码运行看看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Ftree%2Ffeature%2Faggressive-bind-cpu" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/tree/feature/aggressive-bind-cpu" ref="nofollow noopener noreferrer">StudyH2g/AndroidStartupOptimizationDemo at feature/aggressive-bind-cpu</a>； 如对JNI接触较少，可参阅<a href="https://juejin.cn/post/7521250344129429556" target="_blank" title="https://juejin.cn/post/7521250344129429556">Android JNI入门：从基础注册到集成第三方So库及源码分析</a></p>
</blockquote>
<p>现在主线程已经绑定到了 CPU 大核，但如果主线程一直绑定到 CPU 大核上，那么可能会<strong>导致功耗异常和系统调度问题</strong>，后续可以找一个恰当的时机解除绑定。</p>
<h4 data-id="heading-39">4.2.2 <strong>抑制GC</strong></h4>
<p>在启动期间抑制垃圾回收（GC）理论上可以减少因GC事件导致的线程停顿（Stop-The-World），从而优化TTID。这通常需要通过 Inline Hook（如使用 ShadowHook 库）拦截ART运行时中触发并发GC的关键函数（如ConcurrentGCTask::Run）来实现。</p>
<p>具体代码如下</p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* g_hook_stub = <span class="hljs-literal">nullptr</span>;

<span class="hljs-comment">// Hook 函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">newFunc</span><span class="hljs-params">(<span class="hljs-type">void</span>* self)</span> </span>{
    <span class="hljs-built_in">SHADOWHOOK_STACK_SCOPE</span>();
    <span class="hljs-comment">// 休眠2秒</span>
    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">2</span>);
    <span class="hljs-comment">// 执行原来的 Run 方法</span>
    <span class="hljs-built_in">SHADOWHOOK_CALL_PREV</span>(newFunc, self);
}

<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">JNIEXPORT jboolean JNICALL
<span class="hljs-title">Java_com_xxx_xxx_MainActivity_initGCHookNative</span><span class="hljs-params">(
        JNIEnv* env,
        jobject <span class="hljs-comment">/* this */</span>)</span> </span>{
    <span class="hljs-keyword">if</span> (g_hook_stub != <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-keyword">return</span> JNI_TRUE;
    }

    <span class="hljs-comment">// 开启调试日志</span>
    <span class="hljs-built_in">shadowhook_set_debuggable</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-comment">// 初始化 ShadowHook</span>
    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">shadowhook_init</span>(SHADOWHOOK_MODE_SHARED, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span> &amp;&amp; ret != <span class="hljs-number">2</span>) {
        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"ShadowHook init failed: %d"</span>, ret);
        <span class="hljs-keyword">return</span> JNI_FALSE;
    }

    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"ShadowHook initialized successfully"</span>);

    <span class="hljs-comment">// 使用 shadowhook_hook_sym_name</span>
    g_hook_stub = <span class="hljs-built_in">shadowhook_hook_sym_name</span>(
            <span class="hljs-string">"libart.so"</span>,
            <span class="hljs-string">"_ZN3art2gc4Heap16ConcurrentGCTask3RunEPNS_6ThreadE"</span>,
            <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(&amp;newFunc),
            <span class="hljs-literal">nullptr</span>
    );

    <span class="hljs-keyword">if</span> (g_hook_stub == <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-type">int</span> error_num = <span class="hljs-built_in">shadowhook_get_errno</span>();
        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* error_msg = <span class="hljs-built_in">shadowhook_to_errmsg</span>(error_num);
        <span class="hljs-built_in">LOGE</span>(<span class="hljs-string">"Hook failed: %d - %s"</span>, error_num, error_msg);
        <span class="hljs-keyword">return</span> JNI_FALSE;
    }

    <span class="hljs-type">int</span> error_num = <span class="hljs-built_in">shadowhook_get_errno</span>();
    <span class="hljs-keyword">if</span> (error_num == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"GC Hook successful!"</span>);
        <span class="hljs-keyword">return</span> JNI_TRUE;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error_num == <span class="hljs-number">1</span>) {
        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">"GC Hook pending (libart.so not loaded yet)"</span>);
        <span class="hljs-keyword">return</span> JNI_TRUE;
    }

    <span class="hljs-keyword">return</span> JNI_FALSE;
}
</code></pre>
<p>本小节代码请不要用于生产环境，是用于展示一种优化启动速度的方式，请读者一定要在充分测试的情况下，再考虑用抑制 GC 的方式。</p>
<blockquote>
<p>ShadowHook详细使用方法请阅读 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytedance%2Fandroid-inline-hook%2Fblob%2Fmain%2Fdoc%2Fmanual.zh-CN.md" target="_blank" title="https://github.com/bytedance/android-inline-hook/blob/main/doc/manual.zh-CN.md" ref="nofollow noopener noreferrer">shadowhook 手册</a></p>
</blockquote>
<h4 data-id="heading-40">4.2.3 <strong>提高核心线程优先级</strong></h4>
<p>Android 5开始，主线程负责测量和布局，渲染则由独立的渲染线程（RenderThread）负责。理论上，提高这两个线程的优先级可以让它们获得更多CPU时间，从而加速启动。</p>
<h5 data-id="heading-41">实现原理</h5>
<ol>
<li><strong>主线程</strong>：在 <strong>attachBaseContext</strong> 中直接设置优先级</li>
<li><strong>渲染线程</strong>：需要先获取其线程ID（TID），然后设置优先级</li>
</ol>
<h5 data-id="heading-42">关键代码实现</h5>
<p><strong>1. 提高主线程优先级</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">attachBaseContext</span><span class="hljs-params">(newBase: <span class="hljs-type">Context</span>?)</span></span> {
    <span class="hljs-keyword">super</span>.attachBaseContext(newBase)
    Process.setThreadPriority(startupPriority)
}
</code></pre>
<p><strong>2. 提高渲染线程优先级的两种方案</strong></p>
<p><strong>方案1：主动轮询（更早设置）</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">/**
 * 方案1：通过多次尝试主动查找 RenderThread 来设置优先级
 * 在 RenderThread 创建之前的任何时机都可能调用，如果找不到就定时重试
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">trySetupRenderThreadPriority</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 条件：最多尝试x次，且未设置成功</span>
    <span class="hljs-keyword">if</span> (renderThreadSetupAttempt++ &lt; attemptTimes &amp;&amp; !renderThreadPrioritySet) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> tid = getRenderThreadTid()
            <span class="hljs-keyword">if</span> (tid != -<span class="hljs-number">1</span>) {
                Process.setThreadPriority(tid, startupPriority)
                renderThreadPrioritySet = <span class="hljs-literal">true</span>
                Log.d(tag, <span class="hljs-string">"方案1：成功设置渲染线程优先级: <span class="hljs-variable">$startupPriority</span> (第<span class="hljs-subst">${renderThreadSetupAttempt}</span>次尝试)"</span>)
                <span class="hljs-comment">// 成功设置后，可设置一个较晚的兜底恢复（如5秒后），确保系统健康</span>
                handler.postDelayed({ safelyResetPriority() }, <span class="hljs-number">5000</span>)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 如果没找到，16ms后重试（约一帧时间）</span>
                handler.postDelayed(::trySetupRenderThreadPriority, <span class="hljs-number">16</span>)
                Log.d(tag, <span class="hljs-string">"方案1：第<span class="hljs-subst">${renderThreadSetupAttempt}</span>次尝试：未找到渲染线程，稍后重试"</span>)
            }
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(tag, <span class="hljs-string">"方案1：设置渲染线程优先级时发生异常"</span>, e)
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!renderThreadPrioritySet) {
        Log.w(tag, <span class="hljs-string">"方案1：已达到最大尝试次数，未能设置渲染线程优先级"</span>)
    }
}
<span class="hljs-comment">// 在onCreate中调用</span>
</code></pre>
<p><strong>方案2：等待首帧绘制后（更可靠）</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">window.decorView.viewTreeObserver.addOnPreDrawListener {
    <span class="hljs-keyword">val</span> tid = getRenderThreadTid()
    <span class="hljs-keyword">if</span> (tid != -<span class="hljs-number">1</span>) {
        Process.setThreadPriority(tid, startupPriority)
    }
}
</code></pre>
<p><strong>3. 恢复优先级</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">restorePriorities</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 恢复主线程</span>
    Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT)
    
    <span class="hljs-comment">// 恢复渲染线程</span>
    <span class="hljs-keyword">val</span> tid = getRenderThreadTid()
    <span class="hljs-keyword">if</span> (tid != -<span class="hljs-number">1</span>) {
        Process.setThreadPriority(tid, Process.THREAD_PRIORITY_DEFAULT)
    }
}
<span class="hljs-comment">// 在首帧绘制完成后调用</span>
</code></pre>
<p><strong>4. 获取渲染线程TID的工具函数</strong></p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">import</span> android.os.Process
<span class="hljs-keyword">import</span> java.io.BufferedReader
<span class="hljs-keyword">import</span> java.io.File
<span class="hljs-keyword">import</span> java.io.FileReader

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getRenderThreadTid</span><span class="hljs-params">()</span></span> : <span class="hljs-built_in">Int</span> {
   <span class="hljs-keyword">val</span> taskParentDir = File(<span class="hljs-string">"/proc/"</span> + Process.myPid() + <span class="hljs-string">"/task/"</span>)
   <span class="hljs-keyword">if</span> (taskParentDir.isDirectory()) {
       <span class="hljs-keyword">val</span> taskFiles = taskParentDir.listFiles()
       taskFiles?.let {
           <span class="hljs-keyword">for</span> (taskFile <span class="hljs-keyword">in</span> it) {
               <span class="hljs-keyword">var</span> br : BufferedReader? = <span class="hljs-literal">null</span>
               <span class="hljs-keyword">var</span> line: String?
               <span class="hljs-keyword">try</span> {
                   br = BufferedReader(FileReader(taskFile.getPath() + <span class="hljs-string">"/stat"</span>), <span class="hljs-number">100</span>)
                   line = br.readLine()
                   <span class="hljs-keyword">if</span> (line.isNotEmpty()) {
                       <span class="hljs-keyword">val</span> param = line.split(<span class="hljs-string">" "</span>)
                       <span class="hljs-keyword">if</span> (param.size &lt; <span class="hljs-number">2</span>) {
                           <span class="hljs-keyword">continue</span>
                       }
                       <span class="hljs-keyword">val</span> threadName: String = param[<span class="hljs-number">1</span>]
                       <span class="hljs-keyword">if</span> (threadName.contains(<span class="hljs-string">"RenderThread"</span>)) {
                           <span class="hljs-keyword">return</span> param[<span class="hljs-number">0</span>].toInt()
                       }
                   }
               } <span class="hljs-keyword">catch</span> (e : Exception) {

               } <span class="hljs-keyword">finally</span> {
                   br?.close()
               }
           }
       }
   }
   <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>
}
</code></pre>
<p>再次提醒，使用激进优化中的手段时，请进行充分的测试后，再考虑上生产环境。</p>
<blockquote>
<p>详细代码请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FStudyH2g%2FAndroidStartupOptimizationDemo%2Ftree%2Ffeature%2Faggressive-thread-priority" target="_blank" title="https://github.com/StudyH2g/AndroidStartupOptimizationDemo/tree/feature/aggressive-thread-priority" ref="nofollow noopener noreferrer">StudyH2g/AndroidStartupOptimizationDemo at feature/aggressive-thread-priority</a></p>
</blockquote>
<h3 data-id="heading-43">4.3 优化用户感官体验</h3>
<p>需要说明的是，此种方式<strong>不会优化启动速度</strong>，只是优化用户感官体验。</p>
<h4 data-id="heading-44">4.3.1 主题切换: 优化空白Window</h4>
<p>在启动流程中，会显示一个空白窗口。时序图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ccfadc265db4a1e8cb119fc2fd6b370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=9rxj0qtrLTgZJpig7RnLGNfFxzc%3D" alt="image.png" loading="lazy"/></p>
<p>ActivityStarter#recycleTask代码如下</p>
<pre><code class="hljs language-Java" lang="Java">    <span class="hljs-comment">// ActivityStarter#recycleTask</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">recycleTask</span><span class="hljs-params">()</span> {
        ...
        <span class="hljs-keyword">if</span> (mMovedToFront) {
            <span class="hljs-comment">// 冷启动 mMovedToFront 为 true, 显示空白窗口</span>
            targetTaskTop.showStartingWindow(<span class="hljs-literal">true</span> <span class="hljs-comment">/* taskSwitch */</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mDoResume) {
            <span class="hljs-comment">// Make sure the root task and its belonging display are moved to topmost.</span>
            mTargetRootTask.moveToFront(<span class="hljs-string">"intentActivityFound"</span>);
        }
        ...
    }
</code></pre>
<p>它的调用是在 Application#onCreate 之前的。我们可以用一张图片来替换掉这个空白Window，从而避免白屏，让用户体验更好。那么下面就详细说明具体做法：</p>
<p>首先定义要显示的图片</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">layer-list</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">"@android:color/white"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bitmap</span>
            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span>
            <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/ic_xxx"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">layer-list</span>&gt;</span>
</code></pre>
<p>再定义启动的主题</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Theme.Launcher"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"android:Theme.Material.Light.NoActionBar"</span> &gt;</span><span class="xml">
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowBackground"</span>&gt;</span>@drawable/ic_start_xxx<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>后续将Manifest中的主题替换为启动主题</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">application</span>
        <span class="hljs-attr">...</span>
        <span class="hljs-attr">android:theme</span>=<span class="hljs-string">"@style/Theme.Launcher"</span>&gt;</span>
        ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<p>最后我们在启动的首个 Activity#onCreate，设置为原本的主题，注意要<strong>在 super.onCreate 之前</strong>。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-comment">// 设置为原本的主题</span>
        setTheme(R.style.Theme_xxx)
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContent {
            xxx
        }
    }
}
</code></pre>
<p>这样做了之后，这个空白window就会变成我们设置的图片了。</p>
<p><strong>使用</strong>主题切换优化空白弹窗效果：<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be5df355f3d64e4cbd3eea010e30add2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=wWF%2BqfX2I8OmI8fSBcypw836Xqo%3D" alt="demo (online-video-cutter.com).gif" loading="lazy"/><br/>
为了更好的看优化效果，此处延迟了1.5S显示内容</p>
<p>再次提醒，这种方式仅仅优化了空白window，并<strong>不会优化启动速度</strong>。</p>
<h4 data-id="heading-45">4.3.2 骨架屏</h4>
<p>骨架屏就是正常页面的不带数据显示的空白版本，一般会使用灰色块来显示大体的外形。通过使用骨架屏，我们可以优化用户感官体验，从而提高用户的留存率和日活。</p>
<p><strong>骨架屏的实现根据对视觉还原度的要求，分为两种：</strong> 模块式骨架屏、真实UI式骨架屏</p>
<h5 data-id="heading-46">模块式骨架屏</h5>
<p>侧重于内容模块的<strong>布局位置</strong>，使用简单的灰色色块构成页面框架。其优势在于实现简单、复用性高，可以快速提升用户感官体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d1176182c8b4c6484a947f628d5ae13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=SACNzjVr2khHI17%2FSXZJnF86%2FUM%3D" alt="modelScreen.gif" loading="lazy"/></p>
<h5 data-id="heading-47">真实UI式骨架屏</h5>
<p>在内容加载前，显示与最终界面<strong>高度一致的视觉样式</strong>，包括图标、间距等细节。这种方案能提供丝滑的过渡体验，但实现和维护成本也相应更高。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ba06e458e3e43758789e88ed3d92495~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=ig1CkhuuIu3JaAijYJ1WUnY93rQ%3D" alt="SkeScreen.gif" loading="lazy"/></p>
<p>模块骨架屏和真实UI骨架屏在实现方式上是相同的，只是实现的细节程度的不同。我们就看看怎么实现Compose模块屏</p>
<h5 data-id="heading-48">实现骨架屏</h5>
<p>这里介绍下带闪烁效果的骨架屏，直接看代码吧</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shimmerBrush</span><span class="hljs-params">()</span></span>: Brush {
    <span class="hljs-comment">// 定义渐变色</span>
    <span class="hljs-keyword">val</span> gradient = listOf(
        Color.LightGray.copy(alpha = <span class="hljs-number">0.6f</span>),
        Color.LightGray.copy(alpha = <span class="hljs-number">0.2f</span>),
        Color.LightGray.copy(alpha = <span class="hljs-number">0.6f</span>)
    )
    <span class="hljs-comment">// 创建无限平移的动画</span>
    <span class="hljs-keyword">val</span> transition = rememberInfiniteTransition(label = <span class="hljs-string">"shimmer"</span>)
    <span class="hljs-keyword">val</span> translateAnimation = transition.animateFloat(
        initialValue = <span class="hljs-number">0f</span>,
        targetValue = <span class="hljs-number">1000f</span>,
        animationSpec = infiniteRepeatable(
            animation = tween(durationMillis = <span class="hljs-number">1000</span>, easing = LinearEasing),
            repeatMode = RepeatMode.Restart
        ),
        label = <span class="hljs-string">"shimmerTranslation"</span>
    )
    <span class="hljs-comment">// 返回计算好的 Brush</span>
    <span class="hljs-keyword">return</span> Brush.linearGradient(
        colors = gradient,
        start = Offset(x = translateAnimation.value - <span class="hljs-number">500</span>, y = <span class="hljs-number">0f</span>),
        end = Offset(x = translateAnimation.value, y = <span class="hljs-number">100f</span>)
    )
}
</code></pre>
<p>上面我们就定义好了一个从左到右的渐变的闪烁效果。然后我们只要在Modifier.
drawWithCache使用它就可以了，如下：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SkeletonBox</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> shimmerBrush = shimmerBrush()

    Box(
        modifier = Modifier
            .fillMaxWidth()
            .height(<span class="hljs-number">62.</span>dp)
            .clip(RoundedCornerShape(<span class="hljs-number">60</span>))
            .drawWithCache {
                onDrawBehind { drawRect(brush = shimmerBrush) }
            }
    )
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/610d8045835344a198e7caa4687dc8b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770973656&amp;x-signature=SeWDZavzpvCdmraW%2BC6PG2EYlFw%3D" alt="Screen_recording_20260130_143741 (online-video-cutter.com).gif" loading="lazy"/></p>
<p>我们现在就已经实现了一个带闪烁效果的按钮了。由于页面布局各异，核心是实现 shimmerBrush 并应用于Modifier。大家可根据自身UI结构复用此方法。</p>
<p>而在页面中肯定会有多个组件，我们可以通过状态提升，共用一个shimmerBrush</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SkeletonModel</span><span class="hljs-params">(navController: <span class="hljs-type">NavController</span>)</span></span> {
    <span class="hljs-comment">// 共用 shimmerBrush</span>
    <span class="hljs-keyword">val</span> shimmerBrush = shimmerBrush()
    Column(modifier = Modifier
        .padding(horizontal = <span class="hljs-number">16.</span>dp)
        .verticalScroll(rememberScrollState())
    ) {
        Spacer(modifier = Modifier.height(<span class="hljs-number">12.</span>dp))
        <span class="hljs-comment">// 1</span>
        ProductBrushItem(shimmerBrush)
        Spacer(modifier = Modifier.height(<span class="hljs-number">12.</span>dp))
        <span class="hljs-comment">// 2</span>
        AmountBrushItem(shimmerBrush)
        Spacer(modifier = Modifier.height(<span class="hljs-number">12.</span>dp))
        <span class="hljs-comment">// 3</span>
        ButtonBrushItem(shimmerBrush)
    }
}
</code></pre>
<p>还有一点是，页面中数据加载前后，组件没有变化 或 有明确含义的，可以直接用它们 或 它们代表的含义。比如上面示例 App 中，Choose a loan product文案，按钮下面的 Terms &amp; Service and Privacy Policy都直接用的它们，因为加载数据前后无变化，而min amount 和 max amount则是选择产品的最小/大值的含义。</p>
<p>最后说说选择页面的准则：个人认为应优先选择用户日常使用中，最频繁的那个页面（比如购物软件的首页），而次级的页面，可以先实现模块级骨架屏，后续再考虑改进。</p>
<h2 data-id="heading-49">五、总结</h2>
<p>优化冷启动， 可以按<strong>测量-分析-优化-验证</strong> 这样的环节去进行</p>
<ul>
<li><strong>测量</strong>：分清TTID（第一帧）与TTFD（可交互），用可靠工具（如脚本）获取优化前后数据。</li>
<li><strong>分析</strong>：弄清楚冷启动涉及到的所有环节，即<strong>代码层、编译层、体验层、系统层</strong> 。</li>
<li><strong>优化</strong>：分层优化，建议先从收敛Provider、初始化优化和任务调度做起，务必用上基准配置和启动配置；推荐使用感官优化手段；激进方式请慎重评估场景与风险，并进行充分测试后再考虑使用。</li>
<li><strong>验证</strong>：对优化前后进行测试，验证优化效果。<strong>（在我主导的项目中，通过实践这一闭环，我们将冷启动的P50时间成功降低了24%。）</strong></li>
</ul>
<p>感谢阅读，希望本文对你有所帮助，<strong>如有任何不对的地方，欢迎大家指正</strong>。</p>
<h2 data-id="heading-50">六、参考资料</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Ftopic%2Fperformance%2Fvitals%2Flaunch-time%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/topic/performance/vitals/launch-time?hl=zh-cn" ref="nofollow noopener noreferrer">应用启动时间</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Ftopic%2Fperformance%2Fbenchmarking%2Fmacrobenchmark-overview%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/topic/performance/benchmarking/macrobenchmark-overview?hl=zh-cn" ref="nofollow noopener noreferrer">Jetpack Macrobenchmark</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Ftopic%2Flibraries%2Fapp-startup%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/topic/libraries/app-startup?hl=zh-cn" ref="nofollow noopener noreferrer">App Startup</a></li>
<li>《Android性能优化之道：从底层原理到一线实践》</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FvW6-zag2CKrFgcYAPdeUFg" target="_blank" title="https://mp.weixin.qq.com/s/vW6-zag2CKrFgcYAPdeUFg" ref="nofollow noopener noreferrer">App冷启动优化测试干货分享（一）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcoding.imooc.com%2Fclass%2F308.html" target="_blank" title="https://coding.imooc.com/class/308.html" ref="nofollow noopener noreferrer">Top团队大牛带你玩转Android性能分析与优化</a></li>
<li><a href="https://juejin.cn/post/7287083662758379554" target="_blank" title="https://juejin.cn/post/7287083662758379554">常用 JSON 库性能对比: Gson VS Moshi VS Kotlin Serialization VS ...</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Subscription 管理]]></title>    <link>https://juejin.cn/post/7603321550247149618</link>    <guid>https://juejin.cn/post/7603321550247149618</guid>    <pubDate>2026-02-06T09:17:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603321550247149618" data-draft-id="7603359026711330826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Subscription 管理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T09:17:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Subscription 管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:17:50.000Z" title="Fri Feb 06 2026 09:17:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 核心概念</h3>
<h4 data-id="heading-1">什么是 Subscription（订阅）？</h4>
<p><strong>Subscription</strong> 是对设备上单个 SIM 卡或 eSIM 的逻辑表示。每个 Subscription 都有一个唯一的 <strong>SubId</strong>（Subscription ID），用来标识该订阅在系统中的身份。</p>
<p>关键概念：</p>
<ul>
<li><strong>SubId</strong>：订阅的逻辑标识符（整数），用于应用层和框架层通信</li>
<li><strong>PhoneId</strong>：物理调制解调器的索引，也称为逻辑 SIM 卡槽索引</li>
<li><strong>IccId</strong>：SIM 卡的集成电路卡标识符（集成电路卡号）</li>
<li><strong>Active Subscription</strong>：当前在 SIM 卡槽中加载并可用的订阅</li>
</ul>
<h4 data-id="heading-2">Subscription 的类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 本地 SIM：物理 SIM 或 eSIM</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUBSCRIPTION_TYPE_LOCAL_SIM</span> <span class="hljs-operator">=</span> SimInfo.SUBSCRIPTION_TYPE_LOCAL_SIM;

<span class="hljs-comment">// 远程 SIM：通过蓝牙等连接的外部设备的 SIM</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUBSCRIPTION_TYPE_REMOTE_SIM</span> <span class="hljs-operator">=</span> SimInfo.SUBSCRIPTION_TYPE_REMOTE_SIM;
</code></pre>
<h3 data-id="heading-3">2. 核心数据模型</h3>
<h4 data-id="heading-4">SubscriptionInfo（公开 API 类）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">38</span>:<span class="hljs-number">65</span>:frameworks_base/telephony/java/android/telephony/SubscriptionInfo.java
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mId;                           <span class="hljs-comment">// SubId</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mIccId;                     <span class="hljs-comment">// SIM 卡号</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mSimSlotIndex;                 <span class="hljs-comment">// SIM 槽位索引</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CharSequence mDisplayName;         <span class="hljs-comment">// 用户显示名称</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CharSequence mCarrierName;         <span class="hljs-comment">// 运营商名称</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mDisplayNameSource;            <span class="hljs-comment">// 显示名称来源</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mIconTint;                     <span class="hljs-comment">// 图标颜色</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mNumber;                    <span class="hljs-comment">// 电话号码</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mDataRoaming;                  <span class="hljs-comment">// 数据漫游设置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mMcc;                       <span class="hljs-comment">// 移动国家代码</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mMnc;                       <span class="hljs-comment">// 移动网络代码</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> mIsEmbedded;               <span class="hljs-comment">// 是否为 eSIM</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ParcelUuid mGroupUuid;             <span class="hljs-comment">// 订阅组 UUID</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mCarrierId;                    <span class="hljs-comment">// 运营商 ID</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> mIsOpportunistic;          <span class="hljs-comment">// 是否为机会性订阅</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> mAreUiccApplicationsEnabled;  <span class="hljs-comment">// UICC 应用是否启用</span>
</code></pre>
<h4 data-id="heading-5">SubscriptionInfoInternal（内部使用）</h4>
<p>这是框架内部使用的模型，完全对应 <code>SimInfo</code> 数据库表的每一列。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">318</span>:<span class="hljs-number">410</span>:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionInfoInternal.java
<span class="hljs-comment">// 包含所有数据库字段，如 IMSI、RCS 配置、网络类型权限等</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mImsi;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mEnabledMobileDataPolicies;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mIsRcsUceEnabled;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mIsCrossSimCallingEnabled;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] mRcsConfig;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mAllowedNetworkTypesForReasons;
<span class="hljs-comment">// ... 更多字段</span>
</code></pre>
<h3 data-id="heading-6">3. Subscription 数据库</h3>
<h4 data-id="heading-7">SimInfo 表</h4>
<p>所有订阅信息存储在 <code>TelephonyProvider</code> 的 <code>SimInfo</code> 表中，内容 URI 为 <code>content://telephony/siminfo</code>。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">4286</span><span class="hljs-symbol">:</span><span class="hljs-number">4300</span><span class="hljs-symbol">:frameworks_base/core/java/android/provider/Telephony</span>.java
<span class="hljs-keyword">public</span> static final <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimInfo</span> {
    <span class="hljs-keyword">public</span> static final <span class="hljs-title class_">Uri</span> <span class="hljs-variable constant_">CONTENT_URI</span> = <span class="hljs-title class_">Uri</span>.parse(<span class="hljs-string">"content://telephony/siminfo"</span>);
    <span class="hljs-regexp">//</span> 包含 <span class="hljs-number">50</span>+ 列，存储所有订阅相关数据
}
</code></pre>
<h4 data-id="heading-8">SubscriptionDatabaseManager</h4>
<p>负责 <code>SimInfo</code> 表的读写缓存，所有数据库访问都应通过此类进行。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-number">84</span>:<span class="hljs-number">678</span>:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/<span class="hljs-type">SubscriptionDatabaseManager</span>.java
<span class="hljs-comment">/**
 * The subscription database manager is the wrapper of {@link SimInfo} table.
 * It's a full memory cache of the entire subscription database.
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubscriptionDatabaseManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span> </span>{
    <span class="hljs-comment">// 内存缓存，使用读写锁保护</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">Map</span>&lt;<span class="hljs-type">Integer</span>, <span class="hljs-type">SubscriptionInfoInternal</span>&gt; mAllSubscriptionInfoInternalCache;
}
</code></pre>
<h3 data-id="heading-9">4. Subscription 生命周期</h3>
<h4 data-id="heading-10">4.1 Subscription 发现与创建流程</h4>
<pre><code class="hljs language-scss" lang="scss">                    ┌─────────────────────────────────┐
                    │      UiccController             │
                    │  (UICC 卡管理)                   │
                    └──────────────┬──────────────────┘
                                   │ <span class="hljs-built_in">updateSimState</span>()
                                   ▼
           ┌──────────────────────────────────────────┐
           │   SubscriptionManagerService             │
           │      <span class="hljs-built_in">updateSimState</span>()                     │
           └──────────────┬───────────────────────────┘
                          │
                    <span class="hljs-built_in">updateSubscription</span>()
                          │
        ┌─────────────────┼─────────────────┐
        ▼                 ▼                 ▼
    检查 IccId      查找现有订阅        创建新订阅
    是否存在         (数据库)            (若无则插入)
</code></pre>
<p>关键代码：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1499</span><span class="hljs-symbol">:</span><span class="hljs-number">1522</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionManagerService</span>.java
<span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TextUtils</span>.isEmpty(iccId)) {
    <span class="hljs-regexp">//</span> 检查订阅是否已存在
    subInfo = mSubscriptionDatabaseManager.getSubscriptionInfoInternalByIccId(iccId);
    int subId;
    <span class="hljs-keyword">if</span> (subInfo == null) {
        <span class="hljs-regexp">//</span> 这是新 <span class="hljs-variable constant_">SIM</span> 卡。插入新记录。
        subId = insertSubscriptionInfo(iccId, phoneId, null,
                <span class="hljs-title class_">SubscriptionManager</span>.<span class="hljs-variable constant_">SUBSCRIPTION_TYPE_LOCAL_SIM</span>);
        <span class="hljs-regexp">//</span> 设置显示名称
        mSubscriptionDatabaseManager.setDisplayName(subId,
                mContext.getResources().getString(R.string.default_card_name, getCardNumber(subId)));
    } <span class="hljs-keyword">else</span> {
        subId = subInfo.getSubscriptionId();
        log(<span class="hljs-string">"Found existing subscription. subId= "</span> + subId + <span class="hljs-string">", phoneId="</span> + phoneId);
    }
    
    /<span class="hljs-regexp">/ 更新 SIM 槽位索引，使订阅变为活跃状态
    if (subInfo != null &amp;&amp; subInfo.areUiccApplicationsEnabled()) {
        mSlotIndexToSubId.put(phoneId, subId);
        mSubscriptionDatabaseManager.setSimSlotIndex(subId, phoneId);
    }
}
</span></code></pre>
<h4 data-id="heading-11">4.2 插入新订阅</h4>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1092</span><span class="hljs-symbol">:</span><span class="hljs-number">1114</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionManagerService</span>.java
<span class="hljs-keyword">private</span> int insertSubscriptionInfo(<span class="hljs-variable">@NonNull</span> <span class="hljs-title class_">String</span> iccId, int slotIndex,
        <span class="hljs-variable">@Nullable</span> <span class="hljs-title class_">String</span> displayName, <span class="hljs-variable">@SubscriptionType</span> int subscriptionType) {
    <span class="hljs-title class_">String</span> defaultAllowNetworkTypes = <span class="hljs-title class_">Phone</span>.convertAllowedNetworkTypeMapIndexToDbName(...);
    <span class="hljs-title class_">SubscriptionInfoInternal</span>.<span class="hljs-title class_">Builder</span> builder = new <span class="hljs-title class_">SubscriptionInfoInternal</span>.<span class="hljs-title class_">Builder</span>()
            .setIccId(iccId)
            .setCardString(iccId)
            .setSimSlotIndex(slotIndex)
            .setType(subscriptionType)
            .setIconTint(getColor())
            .setAllowedNetworkTypesForReasons(defaultAllowNetworkTypes);
    
    int subId = mSubscriptionDatabaseManager.insertSubscriptionInfo(builder.build());
    <span class="hljs-keyword">return</span> subId;
}
</code></pre>
<h3 data-id="heading-12">5. Subscription 查询与访问</h3>
<h4 data-id="heading-13">5.1 公开 API（SubscriptionManager）</h4>
<p>应用通过 <code>SubscriptionManager</code> 类查询订阅信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取所有订阅信息</span>
List&lt;SubscriptionInfo&gt; allSubs = subscriptionManager.getAllSubscriptionInfoList();

<span class="hljs-comment">// 获取活跃订阅</span>
List&lt;SubscriptionInfo&gt; activeSubs = subscriptionManager.getActiveSubscriptionInfoList();

<span class="hljs-comment">// 通过 SubId 获取</span>
<span class="hljs-type">SubscriptionInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> subscriptionManager.getActiveSubscriptionInfo(subId);

<span class="hljs-comment">// 获取默认订阅</span>
<span class="hljs-type">int</span> <span class="hljs-variable">defaultDataSubId</span> <span class="hljs-operator">=</span> SubscriptionManager.getDefaultDataSubscriptionId();
<span class="hljs-type">int</span> <span class="hljs-variable">defaultVoiceSubId</span> <span class="hljs-operator">=</span> SubscriptionManager.getDefaultVoiceSubscriptionId();
</code></pre>
<h4 data-id="heading-14">5.2 内部访问（SubscriptionDatabaseManager）</h4>
<p>框架内部通过 <code>SubscriptionDatabaseManager</code> 直接访问数据库：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">2442</span><span class="hljs-symbol">:</span><span class="hljs-number">2463</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionDatabaseManager</span>.java
<span class="hljs-variable">@Nullable</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">SubscriptionInfoInternal</span> getSubscriptionInfoInternal(int subId) {
    mReadWriteLock.readLock().lock();
    try {
        <span class="hljs-keyword">return</span> mAllSubscriptionInfoInternalCache.get(subId);
    } finally {
        mReadWriteLock.readLock().unlock();
    }
}

<span class="hljs-variable">@NonNull</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">SubscriptionInfoInternal</span>&gt; getAllSubscriptions() {
    mReadWriteLock.readLock().lock();
    try {
        <span class="hljs-keyword">return</span> new <span class="hljs-title class_">ArrayList</span>&lt;&gt;(mAllSubscriptionInfoInternalCache.values());
    } finally {
        mReadWriteLock.readLock().unlock();
    }
}
</code></pre>
<h3 data-id="heading-15">6. 默认订阅（Default Subscriptions）</h3>
<h4 data-id="heading-16">6.1 三种默认订阅</h4>
<ul>
<li><strong>Default Voice SubId</strong>：用于语音通话的默认订阅</li>
<li><strong>Default Data SubId</strong>：用于移动数据的默认订阅</li>
<li><strong>Default SMS SubId</strong>：用于 SMS 的默认订阅</li>
</ul>
<h4 data-id="heading-17">6.2 默认值存储</h4>
<p>默认值存储在系统设置（Settings.Global）中：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">489</span><span class="hljs-symbol">:</span><span class="hljs-number">500</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionManagerService</span>.java
mDefaultVoiceSubId = new <span class="hljs-title class_">WatchedInt</span>(<span class="hljs-title class_">Settings</span>.<span class="hljs-title class_">Global</span>.getInt(mContext.getContentResolver(),
        <span class="hljs-title class_">Settings</span>.<span class="hljs-title class_">Global</span>.<span class="hljs-variable constant_">MULTI_SIM_VOICE_CALL_SUBSCRIPTION</span>,
        <span class="hljs-title class_">SubscriptionManager</span>.<span class="hljs-variable constant_">INVALID_SUBSCRIPTION_ID</span>)) {
    <span class="hljs-variable">@Override</span>
    <span class="hljs-keyword">public</span> boolean set(int newValue) {
        int oldValue = mValue;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">super</span>.set(newValue)) {
            logl(<span class="hljs-string">"Default voice subId changed from "</span> + oldValue + <span class="hljs-string">" to "</span> + newValue);
            <span class="hljs-title class_">Settings</span>.<span class="hljs-title class_">Global</span>.putInt(mContext.getContentResolver(), 
                <span class="hljs-title class_">Settings</span>.<span class="hljs-title class_">Global</span>.<span class="hljs-variable constant_">MULTI_SIM_VOICE_CALL_SUBSCRIPTION</span>, newValue);
            <span class="hljs-regexp">//</span> ... 广播变化
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
};
</code></pre>
<h4 data-id="heading-18">6.3 自动更新默认值</h4>
<p><code>MultiSimSettingController</code> 负责在多卡场景下自动更新默认值：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-number">619</span>:<span class="hljs-number">650</span>:frameworks_opt_telephony/src/java/com/android/<span class="hljs-keyword">internal</span>/telephony/MultiSimSettingController.java
<span class="hljs-comment">/**
 * Automatically update default settings (data / voice / sms).
 * 
 * 1) If the default subscription is still active, keep it unchanged.
 * 2) Or if there's another active primary subscription that's in the same group,
 *    make it the new default value.
 * 3) Or if there's only one active primary subscription, automatically set default
 *    data subscription on it.
 * 4) If none above is met, clear the default value to INVALID.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateDefaults</span>()</span> {
    <span class="hljs-keyword">if</span> (!isReadyToReevaluate()) <span class="hljs-keyword">return</span>;
    
    List&lt;SubscriptionInfo&gt; activeSubInfos = mSubscriptionManagerService
            .getActiveSubscriptionInfoList(...);
    
    <span class="hljs-keyword">if</span> (ArrayUtils.isEmpty(activeSubInfos)) {
        <span class="hljs-comment">// 无活跃订阅，清除默认值</span>
        mSubscriptionManagerService.setDefaultDataSubId(INVALID_SUBSCRIPTION_ID);
        mSubscriptionManagerService.setDefaultVoiceSubId(INVALID_SUBSCRIPTION_ID);
        mSubscriptionManagerService.setDefaultSmsSubId(INVALID_SUBSCRIPTION_ID);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 自动更新...</span>
}
</code></pre>
<h3 data-id="heading-19">7. 订阅组（Subscription Groups）</h3>
<h4 data-id="heading-20">7.1 订阅组概念</h4>
<p>订阅组用于关联多个订阅（通常是主订阅和机会性订阅），它们共享某些设置。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">200</span>:<span class="hljs-number">240</span>:frameworks_base/telephony/java/com/android/internal/telephony/ISub.aidl
<span class="hljs-comment">/**
 * Inform SubscriptionManager that subscriptions in the list are bundled as a group.
 * Typically it's a primary subscription and an opportunistic subscription.
 * Being in the same group means they might be activated or deactivated together.
 */</span>
<span class="hljs-function">ParcelUuid <span class="hljs-title">createSubscriptionGroup</span><span class="hljs-params">(in <span class="hljs-type">int</span>[] subIdList, <span class="hljs-type">String</span> callingPackage)</span></span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addSubscriptionsIntoGroup</span><span class="hljs-params">(in <span class="hljs-type">int</span>[] subIdList, in ParcelUuid groupUuid,
        <span class="hljs-type">String</span> callingPackage)</span></span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">removeSubscriptionsFromGroup</span><span class="hljs-params">(in <span class="hljs-type">int</span>[] subIdList, in ParcelUuid groupUuid,
        <span class="hljs-type">String</span> callingPackage)</span></span>;

<span class="hljs-function">List&lt;SubscriptionInfo&gt; <span class="hljs-title">getSubscriptionsInGroup</span><span class="hljs-params">(in ParcelUuid groupUuid,
        <span class="hljs-type">String</span> callingPackage, <span class="hljs-type">String</span> callingFeatureId)</span></span>;
</code></pre>
<h4 data-id="heading-21">7.2 组设置同步</h4>
<p>同组内的订阅必须共享相同的数据设置：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">372</span><span class="hljs-symbol">:</span><span class="hljs-number">394</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/MultiSimSettingController</span>.java
/**
 * <span class="hljs-title class_">Make</span> sure <span class="hljs-variable constant_">MOBILE_DATA</span> of subscriptions <span class="hljs-keyword">in</span> same group are synced.
 *<span class="hljs-regexp">/
private void onUserDataEnabled(int subId, boolean enable, boolean setDefaultData) {
    /</span><span class="hljs-regexp">/ 确保同组订阅的 MOBILE_DATA 设置同步
    setUserDataEnabledForGroup(subId, enable);
    
    SubscriptionInfo subInfo = mSubscriptionManagerService.getSubscriptionInfo(subId);
    int defaultDataSubId = mSubscriptionManagerService.getDefaultDataSubId();
    
    /</span><span class="hljs-regexp">/ 如果用户启用了非默认的非机会性订阅，将其设为默认
    if (defaultDataSubId != subId &amp;&amp; subInfo != null &amp;&amp; !subInfo.isOpportunistic() 
            &amp;&amp; enable &amp;&amp; subInfo.isActive() &amp;&amp; setDefaultData) {
        mSubscriptionManagerService.setDefaultDataSubId(subId);
    }
}
</span></code></pre>
<h3 data-id="heading-22">8. 活跃与非活跃订阅</h3>
<h4 data-id="heading-23">8.1 什么是活跃订阅？</h4>
<p>当且仅当以下条件都满足时，订阅才是活跃的：</p>
<ol>
<li><code>SimSlotIndex &gt;= 0</code>（已分配到 SIM 卡槽）</li>
<li>UICC 应用已启用（<code>areUiccApplicationsEnabled() == true</code>）</li>
</ol>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1517</span><span class="hljs-symbol">:</span><span class="hljs-number">1522</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionManagerService</span>.java
<span class="hljs-keyword">if</span> (subInfo != null &amp;&amp; subInfo.areUiccApplicationsEnabled()) {
    mSlotIndexToSubId.put(phoneId, subId);
    <span class="hljs-regexp">//</span> 更新 <span class="hljs-variable constant_">SIM</span> 槽位索引。这将使订阅变为活跃状态。
    mSubscriptionDatabaseManager.setSimSlotIndex(subId, phoneId);
}
</code></pre>
<h4 data-id="heading-24">8.2 非活跃订阅的 SimSlotIndex</h4>
<p>非活跃订阅的 <code>SimSlotIndex</code> 被设置为 <code>SubscriptionManager.INVALID_SIM_SLOT_INDEX (-1)</code>。</p>
<h3 data-id="heading-25">9. 机会性订阅（Opportunistic Subscriptions）</h3>
<p>机会性订阅是自动选择的订阅，用于特定场景（如某些地区有更便宜的数据计划）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">boolean</span> <span class="hljs-variable">isOpportunistic</span> <span class="hljs-operator">=</span> subscriptionInfo.isOpportunistic();

<span class="hljs-comment">// 机会性订阅不能是默认订阅</span>
<span class="hljs-comment">// 它们通常与主订阅组合使用</span>
</code></pre>
<h3 data-id="heading-26">10. 关键流程：SIM 插入/移除</h3>
<h4 data-id="heading-27">10.1 SIM 插入流程</h4>
<pre><code class="hljs language-scss" lang="scss">                    SIM Card Inserted
                           │
                           ▼
              UiccController detects state
                           │
                           ▼
          UiccController<span class="hljs-selector-class">.updateSimState</span>()
                           │
                           ▼
      SubscriptionManagerService<span class="hljs-selector-class">.updateSimState</span>()
                           │
              ┌────────────┼────────────┐
              ▼            ▼            ▼
        检查 IccId    数据库查询    创建/更新
        是否新 SIM     现有订阅      订阅记录
              │            │            │
              └────────────┼────────────┘
                           ▼
           <span class="hljs-built_in">updateSubscription</span>() completes
                           │
                ┌──────────┼──────────┐
                ▼          ▼          ▼
        更新显示名 更新运营商 广播变化
        更新位置代码 更新电话号码 通知应用
</code></pre>
<p>关键代码在 <code>updateSubscription()</code> 方法中：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1536</span><span class="hljs-symbol">:</span><span class="hljs-number">1558</span><span class="hljs-symbol">:frameworks_opt_telephony/src/java/com/android/internal/telephony/subscription/SubscriptionManagerService</span>.java
<span class="hljs-keyword">if</span> (simState == <span class="hljs-title class_">TelephonyManager</span>.<span class="hljs-variable constant_">SIM_STATE_LOADED</span>) {
    <span class="hljs-regexp">//</span> 获取 <span class="hljs-variable constant_">MCC</span>/<span class="hljs-variable constant_">MNC</span> 信息
    <span class="hljs-title class_">String</span> mccMnc = mTelephonyManager.getSimOperatorNumeric(subId);
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TextUtils</span>.isEmpty(mccMnc)) {
        <span class="hljs-keyword">if</span> (subId == getDefaultSubId()) {
            <span class="hljs-title class_">MccTable</span>.updateMccMncConfiguration(mContext, mccMnc);
        }
        setMccMnc(subId, mccMnc);
    }
    
    /<span class="hljs-regexp">/ 获取国家代码
    String iso = TelephonyManager.getSimCountryIsoForPhone(phoneId);
    if (!TextUtils.isEmpty(iso)) {
        setCountryIso(subId, iso);
    }
    
    /</span><span class="hljs-regexp">/ 获取电话号码
    String msisdn = PhoneFactory.getPhone(phoneId).getLine1Number();
    if (!TextUtils.isEmpty(msisdn)) {
        setDisplayNumber(msisdn, subId);
    }
}
</span></code></pre>
<h4 data-id="heading-28">10.2 SIM 移除流程</h4>
<pre><code class="hljs language-scss" lang="scss">                    SIM Card Removed
                           │
                           ▼
          UiccController detects ABSENT
                           │
                           ▼
      SubscriptionManagerService<span class="hljs-selector-class">.updateSimState</span>()
                           │
                           ▼
          <span class="hljs-built_in">markSubscriptionsInactive</span>(phoneId)
                           │
            ┌──────────────┼──────────────┐
            ▼              ▼              ▼
      设置 SimSlotIndex  清除显示名  清除运营商
      为 <span class="hljs-built_in">INVALID</span>(-<span class="hljs-number">1</span>)    清除位置信息    通知更新
</code></pre>
<h3 data-id="heading-29">11. 权限和访问控制</h3>
<h4 data-id="heading-30">11.1 权限要求</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 读取订阅信息</span>
<span class="hljs-meta">@RequiresPermission(anyOf = {
    Manifest.permission.READ_PHONE_STATE,
    "carrier privileges"
})</span>

<span class="hljs-comment">// 修改订阅信息</span>
<span class="hljs-meta">@RequiresPermission(Manifest.permission.MODIFY_PHONE_STATE)</span>

<span class="hljs-comment">// 读取设备标识符（获取 IccId、GroupUuid）</span>
<span class="hljs-meta">@RequiresPermission(Manifest.permission.READ_PHONE_NUMBERS)</span>
</code></pre>
<h4 data-id="heading-31">11.2 运营商特权访问</h4>
<p>具有运营商特权的应用可以访问相关订阅的更多信息。</p>
<h3 data-id="heading-32">12. SubscriptionManager 缓存机制</h3>
<p>为了提高性能，<code>SubscriptionManager</code> 使用了 <code>PropertyInvalidatedCache</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> PropertyInvalidatedCache&lt;Integer, Integer&gt; sGetSubIdCache = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyInvalidatedCache</span>&lt;Integer, Integer&gt;(<span class="hljs-number">16</span>, CACHE_PROPERTY_PREFIX + <span class="hljs-string">"subscription"</span>) {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> Integer <span class="hljs-title function_">recompute</span><span class="hljs-params">(Integer slotIndex)</span> {
            <span class="hljs-comment">// 查询数据库或从 SubscriptionManagerService 获取</span>
        }
    };
</code></pre>
<p>当订阅信息变化时，缓存会被自动清除。</p>
<h3 data-id="heading-33">13. 实践：查询和使用订阅</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取 SubscriptionManager</span>
<span class="hljs-type">SubscriptionManager</span> <span class="hljs-variable">subscriptionManager</span> <span class="hljs-operator">=</span> 
    context.getSystemService(SubscriptionManager.class);

<span class="hljs-comment">// 获取所有活跃订阅</span>
List&lt;SubscriptionInfo&gt; activeSubscriptions = 
    subscriptionManager.getActiveSubscriptionInfoList();

<span class="hljs-keyword">for</span> (SubscriptionInfo subInfo : activeSubscriptions) {
    <span class="hljs-type">int</span> <span class="hljs-variable">subId</span> <span class="hljs-operator">=</span> subInfo.getSubscriptionId();
    <span class="hljs-type">String</span> <span class="hljs-variable">displayName</span> <span class="hljs-operator">=</span> subInfo.getDisplayName().toString();
    <span class="hljs-type">int</span> <span class="hljs-variable">simSlotIndex</span> <span class="hljs-operator">=</span> subInfo.getSimSlotIndex();
    <span class="hljs-type">String</span> <span class="hljs-variable">iccId</span> <span class="hljs-operator">=</span> subInfo.getIccId();
    <span class="hljs-type">String</span> <span class="hljs-variable">carrierName</span> <span class="hljs-operator">=</span> subInfo.getCarrierName().toString();
    
    Log.d(TAG, <span class="hljs-string">"SubId: "</span> + subId + <span class="hljs-string">", Name: "</span> + displayName 
        + <span class="hljs-string">", Slot: "</span> + simSlotIndex + <span class="hljs-string">", Carrier: "</span> + carrierName);
}

<span class="hljs-comment">// 为特定订阅创建 TelephonyManager</span>
<span class="hljs-type">TelephonyManager</span> <span class="hljs-variable">telManager</span> <span class="hljs-operator">=</span> 
    context.getSystemService(TelephonyManager.class)
           .createForSubscriptionId(subId);

<span class="hljs-comment">// 获取该订阅的网络运营商</span>
<span class="hljs-type">String</span> <span class="hljs-variable">operatorName</span> <span class="hljs-operator">=</span> telManager.getNetworkOperatorName();
</code></pre>
<h3 data-id="heading-34">14. 关键类总结</h3>









































<table><thead><tr><th>类</th><th>作用</th></tr></thead><tbody><tr><td><code>SubscriptionManager</code></td><td>公开 API，应用端查询订阅信息</td></tr><tr><td><code>SubscriptionManagerService</code></td><td>系统服务，管理所有订阅的后端</td></tr><tr><td><code>SubscriptionDatabaseManager</code></td><td>订阅数据库管理，缓存和访问 <code>SimInfo</code> 表</td></tr><tr><td><code>SubscriptionInfo</code></td><td>公开订阅信息模型</td></tr><tr><td><code>SubscriptionInfoInternal</code></td><td>内部订阅信息模型，完整对应数据库</td></tr><tr><td><code>MultiSimSettingController</code></td><td>多卡设置协调，确保同组订阅设置同步</td></tr><tr><td><code>ISub</code></td><td>AIDL 接口，定义 SubscriptionManagerService 的 IPC 方法</td></tr><tr><td><code>PhoneSwitcher</code></td><td>多卡数据连接管理（详见多卡管理章节）</td></tr></tbody></table>
<hr/>
<p>这就是 Android 电话框架中 Subscription 管理的完整体系。它是 DSDS（双卡双待）管理的基础，为系统如何跟踪、访问和协调多个 SIM 卡提供了数据模型和操作框架。</p>
<p>有任何关于 Subscription 管理的具体问题吗？我可以深入解释任何特定的部分。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android RIL 中 HIDL 和 AIDL 的区别]]></title>    <link>https://juejin.cn/post/7603309951227543602</link>    <guid>https://juejin.cn/post/7603309951227543602</guid>    <pubDate>2026-02-06T09:26:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227543602" data-draft-id="7603309951227527218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android RIL 中 HIDL 和 AIDL 的区别"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-06T09:26:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android RIL 中 HIDL 和 AIDL 的区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:26:08.000Z" title="Fri Feb 06 2026 09:26:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 历史背景</h3>





























<table><thead><tr><th>时期</th><th>语言</th><th>Android 版本</th><th>说明</th></tr></thead><tbody><tr><td><strong>Android 7.0 - 12</strong></td><td><strong>HIDL</strong> (HAL Interface Definition Language)</td><td>Nougat - S</td><td>首个现代 HAL 接口语言</td></tr><tr><td><strong>Android 13+</strong></td><td><strong>AIDL</strong> (Android Interface Definition Language)</td><td>T 及以后</td><td>统一的 IPC 接口语言</td></tr><tr><td><strong>过渡期</strong></td><td><strong>两者共存</strong></td><td>S/T</td><td>兼容性层支持 HIDL 驱动</td></tr></tbody></table>
<h3 data-id="heading-1">2. 核心架构差异</h3>
<h4 data-id="heading-2">2.1 接口定义方式</h4>
<p><strong>HIDL（旧）- <code>.hal</code> 文件：</strong></p>
<pre><code class="hljs language-scss" lang="scss">hardware_interfaces/radio/<span class="hljs-number">1.4</span>/IRadio<span class="hljs-selector-class">.hal</span>
package android<span class="hljs-selector-class">.hardware</span><span class="hljs-selector-class">.radio</span>@<span class="hljs-number">1.4</span>;

interface IRadio {
    oneway <span class="hljs-built_in">dial</span>(int32_t serial, Dial dialInfo);
    oneway <span class="hljs-built_in">hangupConnection</span>(int32_t serial, uint32_t gsmCallNumber);
    oneway <span class="hljs-built_in">setResponseFunctions</span>(IRadioResponse radioResponse, IRadioIndication radioIndication);
}
</code></pre>
<p><strong>AIDL（新）- <code>.aidl</code> 文件：</strong></p>
<pre><code class="hljs language-java" lang="java">hardware_interfaces/radio/aidl/android/hardware/radio/voice/IRadioVoice.aidl
<span class="hljs-keyword">package</span> android.hardware.radio.voice;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRadioVoice</span> {
    oneway <span class="hljs-keyword">void</span> <span class="hljs-title function_">dial</span><span class="hljs-params">(in <span class="hljs-type">int</span> serial, in Dial dialInfo)</span>;
    oneway <span class="hljs-keyword">void</span> <span class="hljs-title function_">hangupConnection</span><span class="hljs-params">(in <span class="hljs-type">int</span> serial, in <span class="hljs-type">int</span> gsmCallNumber)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setResponseFunctions</span><span class="hljs-params">(in IRadioVoiceResponse radioVoiceResponse,
                              in IRadioVoiceIndication radioVoiceIndication)</span>;
}
</code></pre>
<h4 data-id="heading-3">2.2 接口颗粒度</h4>
<p><strong>HIDL：单体接口</strong></p>
<ul>
<li>一个 <code>IRadio</code> 接口包含所有功能（voice, data, network, messaging, sim, config）</li>
<li>版本号递增：1.0 → 1.1 → 1.2 → ... → 1.6</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">hardware_interfaces/radio/1.0/IRadio.hal    (2000+ 行)
    ├─ Voice 功能
    ├─ Data 功能
    ├─ Network 功能
    ├─ Messaging 功能
    ├─ SIM 功能
    └─ Config 功能
</code></pre>
<p><strong>AIDL：模块化接口</strong></p>
<ul>
<li>按功能域分离成多个接口</li>
<li>每个模块独立版本控制</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">hardware_interfaces/radio/aidl/android/hardware/radio/
├─ voice/IRadioVoice.aidl
├─ data/IRadioData.aidl
├─ network/IRadioNetwork.aidl
├─ messaging/IRadioMessaging.aidl
├─ sim/IRadioSim.aidl
├─ modem/IRadioModem.aidl
└─ config/IRadioConfig.aidl
</code></pre>
<h3 data-id="heading-4">3. 响应和指示机制</h3>
<h4 data-id="heading-5">3.1 HIDL 响应流程</h4>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">Framework</span> (<span class="hljs-title class_">Java</span>)
    │
    ├─ setResponseFunctions(<span class="hljs-title class_">IRadioResponse</span>, <span class="hljs-title class_">IRadioIndication</span>)
    │
<span class="hljs-variable constant_">RIL</span> (<span class="hljs-variable constant_">JNI</span>/C++)
    │
    ├─ <span class="hljs-title class_">IRadio</span><span class="hljs-variable">@1</span>.<span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:dial</span>()
    │
    └─ <span class="hljs-title class_">IRadioResponse</span><span class="hljs-variable">@1</span>.<span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:dialResponse</span>()
       <span class="hljs-title class_">IRadioIndication</span><span class="hljs-variable">@1</span>.<span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:callStateChanged</span>()
</code></pre>
<p>响应和指示通过同一对接口处理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">44</span>:<span class="hljs-number">60</span>:hardware_interfaces/radio/<span class="hljs-number">1.0</span>/IRadio.hal
interface IRadio {
    <span class="hljs-built_in">setResponseFunctions</span>(IRadioResponse radioResponse, IRadioIndication radioIndication);
    oneway <span class="hljs-built_in">dial</span>(int32_t serial, Dial dialInfo);
    <span class="hljs-comment">// ...</span>
}

interface IRadioResponse {
    <span class="hljs-built_in">dialResponse</span>(RadioResponseInfo info);
}

interface IRadioIndication {
    <span class="hljs-built_in">callStateChanged</span>(RadioIndicationType type);
}
</code></pre>
<h4 data-id="heading-6">3.2 AIDL 响应流程</h4>
<pre><code class="hljs language-scss" lang="scss">Framework (Java)
    │
    ├─ <span class="hljs-built_in">setResponseFunctions</span>(IRadioVoiceResponse, IRadioVoiceIndication)
    │
RIL (C++)
    │
    ├─ IRadioVoice::<span class="hljs-built_in">dial</span>()
    │
    └─ IRadioVoiceResponse::<span class="hljs-built_in">dialResponse</span>()
       IRadioVoiceIndication::<span class="hljs-built_in">callStateChanged</span>()
</code></pre>
<p>AIDL 采用<strong>分离的响应接口</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">hardware_interfaces/radio/aidl/android/hardware/radio/voice/IRadioVoice.aidl
<span class="hljs-keyword">interface</span> <span class="hljs-title">IRadioVoice</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setResponseFunctions</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> IRadioVoiceResponse radioVoiceResponse,
                              <span class="hljs-keyword">in</span> IRadioVoiceIndication radioVoiceIndication</span>)</span>;
    <span class="hljs-function">oneway <span class="hljs-keyword">void</span> <span class="hljs-title">dial</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> <span class="hljs-built_in">int</span> serial, <span class="hljs-keyword">in</span> Dial dialInfo</span>)</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title">IRadioVoiceResponse</span> {
    <span class="hljs-function">oneway <span class="hljs-keyword">void</span> <span class="hljs-title">dialResponse</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> RadioResponseInfo info</span>)</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title">IRadioVoiceIndication</span> {
    <span class="hljs-function">oneway <span class="hljs-keyword">void</span> <span class="hljs-title">callStateChanged</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> RadioIndicationType type</span>)</span>;
}
</code></pre>
<h3 data-id="heading-7">4. 数据结构定义</h3>
<h4 data-id="heading-8">4.1 HIDL - 复杂的继承体系</h4>
<pre><code class="hljs language-ini" lang="ini">hardware_interfaces/radio/1.0/types.hal
struct Dial {
    string address<span class="hljs-comment">;</span>
    Clir clir<span class="hljs-comment">;</span>
    vec&lt;UusInfo&gt; uusInfo<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

struct RadioResponseInfo {
    RadioResponseType type<span class="hljs-comment">;</span>
    int32_t serial<span class="hljs-comment">;</span>
    RadioError error<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p>HIDL 支持联合（union）和层级继承。</p>
<h4 data-id="heading-9">4.2 AIDL - 扁平的数据结构</h4>
<pre><code class="hljs language-ini" lang="ini">hardware_interfaces/radio/aidl/android/hardware/radio/voice/Dial.aidl
package android.hardware.radio.voice<span class="hljs-comment">;</span>
parcelable Dial {
    String address<span class="hljs-comment">;</span>
    int clir<span class="hljs-comment">;</span>
    UusInfo<span class="hljs-section">[]</span> uusInfo<span class="hljs-comment">;</span>
}

hardware_interfaces/radio/aidl/android/hardware/radio/RadioResponseInfo.aidl
package android.hardware.radio<span class="hljs-comment">;</span>
parcelable RadioResponseInfo {
    RadioResponseType type<span class="hljs-comment">;</span>
    int serial<span class="hljs-comment">;</span>
    RadioError error<span class="hljs-comment">;</span>
}
</code></pre>
<p>AIDL 使用 <code>parcelable</code> 而非 <code>struct</code>。</p>
<h3 data-id="heading-10">5. RIL Java 层的适配</h3>
<p>RIL 框架通过代理类适配两种接口：</p>
<pre><code class="hljs language-ini" lang="ini">53:100:frameworks_opt_telephony/src/java/com/android/internal/telephony/RadioServiceProxy.java
/**
 * A holder for IRadio services.
 * Use getHidl to get the HIDL IRadio service or getAidl to get the corresponding AIDL service.
 */
public abstract class RadioServiceProxy {
    boolean mIsAidl<span class="hljs-comment">;                                    // 标志：是否为 AIDL</span>
    HalVersion <span class="hljs-attr">mHalVersion</span> = RIL.RADIO_HAL_VERSION_UNKNOWN<span class="hljs-comment">;</span>
    volatile android.hardware.radio.V1_4.IRadio <span class="hljs-attr">mRadioProxy</span> = null<span class="hljs-comment">;</span>

    /**
     * Set IRadio as the HIDL implementation for RadioServiceProxy
     */
    public void setHidl(HalVersion halVersion, android.hardware.radio.V1_4.IRadio radio) {
        <span class="hljs-attr">mHalVersion</span> = halVersion<span class="hljs-comment">;</span>
        <span class="hljs-attr">mRadioProxy</span> = radio<span class="hljs-comment">;</span>
        <span class="hljs-attr">mIsAidl</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }

    /**
     * Set IRadio as the AIDL implementation for RadioServiceProxy
     */
    public void setAidl(android.hardware.radio.IRadio radioAidl) {
        <span class="hljs-attr">mAidlRadioProxy</span> = radioAidl<span class="hljs-comment">;</span>
        <span class="hljs-attr">mIsAidl</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    }

    public boolean isAidl() {
        return mIsAidl<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-11">6. 兼容性层：libradiocompat</h3>
<p>Android 13 引入了兼容性层，允许在 AIDL 框架中使用旧的 HIDL HAL 实现。</p>
<h4 data-id="heading-12">6.1 架构</h4>
<pre><code class="hljs language-scss" lang="scss">         Framework (AIDL)
               │
     ┌─────────┴─────────┐
     │                   │
  AIDL HAL          libradiocompat
  (Native)          (Converter)
                        │
                   HIDL HAL (Legacy)
</code></pre>
<h4 data-id="heading-13">6.2 数据结构转换</h4>
<p>libradiocompat 提供了双向转换函数：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">19</span><span class="hljs-symbol">:</span><span class="hljs-number">45</span><span class="hljs-symbol">:hardware_interfaces/radio/aidl/compat/libradiocompat/commonStructs</span>.cpp
namespace android::hardware::radio::compat {

<span class="hljs-regexp">//</span> <span class="hljs-variable constant_">HIDL</span> to <span class="hljs-variable constant_">AIDL</span> conversion
aidl::<span class="hljs-title class_">RadioResponseInfo</span> toAidl(const <span class="hljs-variable constant_">V1_0</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:RadioResponseInfo&amp;</span> info) {
    <span class="hljs-keyword">return</span> {
            .type = toAidl(info.type),
            .serial = info.serial,
            .error = toAidl(info.error),
    };
}

/<span class="hljs-regexp">/ AIDL to HIDL conversion
V1_0::RadioCapability toHidl(const aidl::RadioCapability&amp; capa) {
    return {
            .session = capa.session,
            .phase = static_cast&lt;V1_0::RadioCapabilityPhase&gt;(capa.phase),
            .raf = toHidlBitfield&lt;V1_0::RadioAccessFamily&gt;(capa.raf),
            .logicalModemUuid = capa.logicalModemUuid,
            .status = static_cast&lt;V1_0::RadioCapabilityStatus&gt;(capa.status),
    };
}

}
</span></code></pre>
<h4 data-id="heading-14">6.3 集合转换</h4>
<p>支持向量和数组的自动转换：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">23</span>:<span class="hljs-number">56</span>:hardware_interfaces/radio/aidl/compat/libradiocompat/collections.h
<span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">toAidl</span><span class="hljs-params">(<span class="hljs-type">const</span> hidl_vec&lt;T&gt;&amp; inp)</span> </span>{
    <span class="hljs-function">std::vector&lt;<span class="hljs-title">decltype</span><span class="hljs-params">(toAidl(T{}))</span>&gt; <span class="hljs-title">out</span><span class="hljs-params">(inp.size())</span></span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; inp.<span class="hljs-built_in">size</span>(); i++) {
        out[i] = <span class="hljs-built_in">toAidl</span>(inp[i]);
    }
    <span class="hljs-keyword">return</span> out;
}

<span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">toHidl</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;T&gt;&amp; inp)</span> </span>{
    <span class="hljs-function">hidl_vec&lt;<span class="hljs-title">decltype</span><span class="hljs-params">(toHidl(T{}))</span>&gt; <span class="hljs-title">out</span><span class="hljs-params">(inp.size())</span></span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; inp.<span class="hljs-built_in">size</span>(); i++) {
        out[i] = <span class="hljs-built_in">toHidl</span>(inp[i]);
    }
    <span class="hljs-keyword">return</span> out;
}
</code></pre>
<h3 data-id="heading-15">7. 关键差异对比表</h3>























































<table><thead><tr><th>特性</th><th>HIDL</th><th>AIDL</th></tr></thead><tbody><tr><td><strong>引入时间</strong></td><td>Android 7.0 (Nougat)</td><td>Android 13 (Tiramisu)</td></tr><tr><td><strong>定义文件</strong></td><td><code>.hal</code></td><td><code>.aidl</code></td></tr><tr><td><strong>接口粒度</strong></td><td>单体（IRadio 包含所有）</td><td>模块化（IRadioVoice, IRadioData 等）</td></tr><tr><td><strong>版本管理</strong></td><td>整体版本（1.0-1.6）</td><td>按模块版本（各模块独立）</td></tr><tr><td><strong>类型系统</strong></td><td>复杂继承体系</td><td>简洁的 parcelable 类型</td></tr><tr><td><strong>代码生成</strong></td><td>HIDL 编译器</td><td>AIDL 编译器</td></tr><tr><td><strong>二进制兼容性</strong></td><td>使用 HIDL 运行时</td><td>使用 Binder</td></tr><tr><td><strong>兼容性支持</strong></td><td>原生支持 HIDL</td><td>通过 libradiocompat</td></tr><tr><td><strong>性能特征</strong></td><td>针对 HAL 优化</td><td>通用 IPC 优化</td></tr></tbody></table>
<h3 data-id="heading-16">8. 版本管理对比</h3>
<p><strong>HIDL 版本演进：</strong></p>
<pre><code class="hljs language-ruby" lang="ruby">android.hardware.radio<span class="hljs-variable">@1</span>.<span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span>
    ├─ dial()
    ├─ hangupConnection()
    └─ ...

android.hardware.radio<span class="hljs-variable">@1</span>.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span> extends <span class="hljs-variable">@1</span>.<span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span>
    └─ setCarrierInfoForImsiEncryption()  (新增)

android.hardware.radio<span class="hljs-variable">@1</span>.<span class="hljs-number">2</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span> extends <span class="hljs-variable">@1</span>.<span class="hljs-number">1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span>
    └─ startNetworkScan()                 (新增)

...

android.hardware.radio<span class="hljs-variable">@1</span>.<span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span> extends <span class="hljs-variable">@1</span>.<span class="hljs-number">5</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadio</span>
    └─ setSimCardPower()                  (新增)
</code></pre>
<p><strong>AIDL 模块化版本：</strong></p>
<pre><code class="hljs language-ruby" lang="ruby">android.hardware.radio.voice<span class="hljs-variable">@1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadioVoice</span>
    ├─ dial()
    ├─ hangupConnection()
    └─ ...

android.hardware.radio.data<span class="hljs-variable">@1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadioData</span>
    ├─ setupDataCall()
    ├─ deactivateDataCall()
    └─ ...

android.hardware.radio.sim<span class="hljs-variable">@1</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:IRadioSim</span>
    ├─ getIccCardStatus()
    ├─ supplyIccPin()
    └─ ...
</code></pre>
<h3 data-id="heading-17">9. 实际通信流程</h3>
<h4 data-id="heading-18">9.1 HIDL 请求/响应</h4>
<pre><code class="hljs language-less" lang="less">┌─────────────────┐
│ <span class="hljs-selector-tag">RIL</span> (Java/JNI)  │
└────────┬────────┘
         │ <span class="hljs-number">1</span>. <span class="hljs-selector-tag">mRadioProxy</span><span class="hljs-selector-class">.dial</span>(serial, dialInfo)
         ▼
┌─────────────────────────────────┐
│ <span class="hljs-selector-tag">HIDL</span> <span class="hljs-selector-tag">Service</span> (radio<span class="hljs-variable">@1</span>.<span class="hljs-number">4</span>::IRadio)│ (Native HAL)
└────────┬────────────────────────┘
         │ <span class="hljs-number">2</span>. 内部处理
         │ <span class="hljs-number">3</span>. 调用响应回调
         ▼
┌──────────────────────────────────┐
│ <span class="hljs-selector-tag">HIDL</span> <span class="hljs-selector-tag">Callback</span> (IRadioResponse)    │
└────────┬─────────────────────────┘
         │ <span class="hljs-number">4</span>. <span class="hljs-selector-tag">response-</span>&gt;<span class="hljs-selector-tag">dialResponse</span>(responseInfo)
         ▼
┌─────────────────────┐
│ <span class="hljs-selector-tag">RIL</span> <span class="hljs-selector-tag">Callback</span> <span class="hljs-selector-tag">Handler</span>│
└─────────────────────┘
</code></pre>
<h4 data-id="heading-19">9.2 AIDL 请求/响应</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────┐
│ RIL (Java/JNI)  │
└────────┬────────┘
         │ <span class="hljs-number">1</span>. mRadioProxy<span class="hljs-selector-class">.dial</span>(serial, dialInfo)
         ▼
┌─────────────────────────────────┐
│ AIDL Service (IRadioVoice)       │ (Native HAL or Compat Layer)
└────────┬────────────────────────┘
         │ <span class="hljs-number">2</span>. 内部处理
         │ <span class="hljs-number">3</span>. 调用响应回调
         ▼
┌──────────────────────────────────┐
│ AIDL Callback (IRadioVoiceResponse)
└────────┬─────────────────────────┘
         │ <span class="hljs-number">4</span>. response-&gt;<span class="hljs-built_in">dialResponse</span>(responseInfo)
         ▼
┌─────────────────────┐
│ RIL Callback Handler│
└─────────────────────┘
</code></pre>
<h3 data-id="heading-20">10. 构建系统差异</h3>
<p><strong>HIDL 编译：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">hidl_interface {
    name: <span class="hljs-string">"android.hardware.radio"</span>,
    root: <span class="hljs-string">"android.hardware"</span>,
    srcs: [
        <span class="hljs-string">"1.4/IRadio.hal"</span>,
        <span class="hljs-string">"1.4/IRadioResponse.hal"</span>,
        <span class="hljs-string">"1.4/IRadioIndication.hal"</span>,
        <span class="hljs-string">"1.4/types.hal"</span>,
    ],
    interfaces: [
        <span class="hljs-string">"android.hardware.base@1.0"</span>,
    ],
}
</code></pre>
<p><strong>AIDL 编译：</strong></p>
<pre><code class="hljs language-blueprint" lang="blueprint">aidl_interface {
    name: "android.hardware.radio",
    vendor_available: true,
    srcs: [
        "android/hardware/radio/voice/*.aidl",
        "android/hardware/radio/data/*.aidl",
        "android/hardware/radio/network/*.aidl",
        "android/hardware/radio/sim/*.aidl",
        "android/hardware/radio/modem/*.aidl",
        "android/hardware/radio/messaging/*.aidl",
    ],
    stability: "vintf",
    backend: {
        cpp: { enabled: true; },
        java: { enabled: true; },
    },
    versions_with_info: [
        { version: "1"; },
        { version: "2"; },
        { version: "3"; },
    ],
    frozen: true,
}
</code></pre>
<h3 data-id="heading-21">11. 性能和稳定性考量</h3>



































<table><thead><tr><th>方面</th><th>HIDL</th><th>AIDL</th></tr></thead><tbody><tr><td><strong>内存占用</strong></td><td>较小（C++ 优化）</td><td>相同或稍大</td></tr><tr><td><strong>IPC 延迟</strong></td><td>优化的 Binder 使用</td><td>标准 Binder 延迟</td></tr><tr><td><strong>类型安全</strong></td><td>强类型检查</td><td>强类型检查</td></tr><tr><td><strong>向后兼容</strong></td><td>通过继承链</td><td>通过版本管理</td></tr><tr><td><strong>热修复</strong></td><td>困难（版本锁定）</td><td>更容易（模块独立）</td></tr></tbody></table>
<h3 data-id="heading-22">12. 迁移建议</h3>
<p><strong>从 HIDL 迁移到 AIDL 的好处：</strong></p>
<ol>
<li><strong>模块化</strong> - 各功能模块独立演进</li>
<li><strong>统一 IPC</strong> - 不再有特殊的 HAL IPC 机制</li>
<li><strong>灵活版本管理</strong> - 每个模块独立版本</li>
<li><strong>更好的工具</strong> - 统一使用 AIDL 工具链</li>
<li><strong>长期支持</strong> - AIDL 是未来方向</li>
</ol>
<p><strong>兼容性策略：</strong></p>
<ul>
<li>Android 13-14：HIDL 和 AIDL 并存，通过 libradiocompat 支持旧 HAL</li>
<li>Android 15+：可能逐步淘汰 HIDL 支持</li>
</ul>
<hr/>
<p>总结来说，<strong>HIDL 是针对 HAL 的专用接口语言</strong>，而 <strong>AIDL 是通用的系统服务接口语言</strong>。RIL 从 HIDL 迁移到 AIDL 反映了 Android 系统架构向更统一、模块化方向的演进。</p>
<p>有任何关于 HIDL/AIDL 在 RIL 中的实现细节的问题吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Modem 向系统上报的无线指示（Unsolicited Indication）的完整列表]]></title>    <link>https://juejin.cn/post/7603359026711478282</link>    <guid>https://juejin.cn/post/7603359026711478282</guid>    <pubDate>2026-02-06T09:29:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603359026711478282" data-draft-id="7603393977477365786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Modem 向系统上报的无线指示（Unsolicited Indication）的完整列表"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-06T09:29:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Modem 向系统上报的无线指示（Unsolicited Indication）的完整列表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:29:59.000Z" title="Fri Feb 06 2026 09:29:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Modem 向系统上报的无线指示共分为 <strong>7 个大类</strong>，总计约 <strong>70+ 种具体指示</strong>，分布如下：</p>
<hr/>
<h2 data-id="heading-0">1️⃣ <strong>语音指示（Voice Indications）- 13 种</strong></h2>
<p>来自 <code>IRadioVoiceIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> callRing                          - 来电铃声（来电响铃指示）
<span class="hljs-bullet">2.</span> callStateChanged                  - 通话状态变化
<span class="hljs-bullet">3.</span> cdmaCallWaiting                   - CDMA 呼叫等待
<span class="hljs-bullet">4.</span> cdmaInfoRec                       - CDMA 信息记录
<span class="hljs-bullet">5.</span> cdmaOtaProvisionStatus            - CDMA OTA 配置状态
<span class="hljs-bullet">6.</span> currentEmergencyNumberList        - 紧急号码列表
<span class="hljs-bullet">7.</span> enterEmergencyCallbackMode        - 进入紧急回调模式
<span class="hljs-bullet">8.</span> exitEmergencyCallbackMode         - 退出紧急回调模式
<span class="hljs-bullet">9.</span> indicateRingbackTone              - 指示回铃音
<span class="hljs-bullet">10.</span> onSupplementaryServiceIndication - 补充服务指示
<span class="hljs-bullet">11.</span> onUssd                           - USSD 消息
<span class="hljs-bullet">12.</span> resendIncallMute                 - 重新发送通话中静音
<span class="hljs-bullet">13.</span> srvccStateNotify                 - SRVCC 状态变化
<span class="hljs-bullet">14.</span> stkCallControlAlphaNotify        - STK 呼叫控制字母通知
<span class="hljs-bullet">15.</span> stkCallSetup                     - STK 设置呼叫
</code></pre>
<hr/>
<h2 data-id="heading-1">2️⃣ <strong>数据指示（Data Indications）- 5 种</strong></h2>
<p>来自 <code>IRadioDataIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> dataCallListChanged     - 数据连接列表变化
<span class="hljs-bullet">2.</span> keepaliveStatus         - 保活会话状态
<span class="hljs-bullet">3.</span> pcoData                 - PCO 数据（运营商配置数据）
<span class="hljs-bullet">4.</span> unthrottleApn           - 解除 APN 限流
<span class="hljs-bullet">5.</span> slicingConfigChanged    - 网络切片配置变化
</code></pre>
<hr/>
<h2 data-id="heading-2">3️⃣ <strong>网络指示（Network Indications）- 14 种</strong></h2>
<p>来自 <code>IRadioNetworkIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> barringInfoChanged              - 禁用信息变化
<span class="hljs-bullet">2.</span> cdmaPrlChanged                  - CDMA PRL 版本变化
<span class="hljs-bullet">3.</span> cellInfoList                    - 小区信息列表
<span class="hljs-bullet">4.</span> currentLinkCapacityEstimate     - 链路容量估计
<span class="hljs-bullet">5.</span> currentPhysicalChannelConfigs   - 物理信道配置
<span class="hljs-bullet">6.</span> currentSignalStrength           - 信号强度
<span class="hljs-bullet">7.</span> imsNetworkStateChanged          - IMS 网络状态变化
<span class="hljs-bullet">8.</span> networkScanResult               - 网络扫描结果
<span class="hljs-bullet">9.</span> networkStateChanged             - 网络状态变化
<span class="hljs-bullet">10.</span> nitzTimeReceived               - NITZ 时间接收
<span class="hljs-bullet">11.</span> registrationFailed             - 注册失败
<span class="hljs-bullet">12.</span> restrictedStateChanged         - 受限状态变化
<span class="hljs-bullet">13.</span> suppSvcNotify                  - 补充服务通知
<span class="hljs-bullet">14.</span> voiceRadioTechChanged          - 语音无线技术变化
<span class="hljs-bullet">15.</span> emergencyNetworkScanResult     - 紧急网络扫描结果
</code></pre>
<hr/>
<h2 data-id="heading-3">4️⃣ <strong>SIM/卡指示（SIM Indications）- 10 种</strong></h2>
<p>来自 <code>IRadioSimIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> carrierInfoForImsiEncryption    - 运营商 IMSI 加密信息
<span class="hljs-bullet">2.</span> cdmaSubscriptionSourceChanged   - CDMA 订阅源变化
<span class="hljs-bullet">3.</span> simPhonebookChanged             - SIM 电话簿变化
<span class="hljs-bullet">4.</span> simPhonebookRecordsReceived     - SIM 电话簿记录接收
<span class="hljs-bullet">5.</span> simRefresh                      - SIM 刷新
<span class="hljs-bullet">6.</span> simStatusChanged                - SIM 状态变化
<span class="hljs-bullet">7.</span> stkEventNotify                  - STK 事件通知
<span class="hljs-bullet">8.</span> stkProactiveCommand             - STK 主动命令
<span class="hljs-bullet">9.</span> stkSessionEnd                   - STK 会话结束
<span class="hljs-bullet">10.</span> subscriptionStatusChanged      - 订阅状态变化
<span class="hljs-bullet">11.</span> uiccApplicationsEnablementChanged - UICC 应用启用/禁用变化
</code></pre>
<hr/>
<h2 data-id="heading-4">5️⃣ <strong>消息指示（Messaging Indications）- 6 种</strong></h2>
<p>来自 <code>IRadioMessagingIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> cdmaNewSms               - 新 CDMA 短信
<span class="hljs-bullet">2.</span> cdmaRuimSmsStorageFull   - CDMA RUIM 短信存储满
<span class="hljs-bullet">3.</span> newBroadcastSms          - 新广播短信
<span class="hljs-bullet">4.</span> newSms                   - 新 GSM 短信
<span class="hljs-bullet">5.</span> newSmsOnSim              - SIM 卡上新短信
<span class="hljs-bullet">6.</span> newSmsStatusReport       - 短信状态报告
<span class="hljs-bullet">7.</span> simSmsStorageFull        - SIM 短信存储满
</code></pre>
<hr/>
<h2 data-id="heading-5">6️⃣ <strong>Modem/调制解调器指示（Modem Indications）- 6 种</strong></h2>
<p>来自 <code>IRadioModemIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> hardwareConfigChanged    - 硬件配置变化
<span class="hljs-bullet">2.</span> modemReset               - Modem 重启
<span class="hljs-bullet">3.</span> radioCapabilityIndication - Radio 能力指示
<span class="hljs-bullet">4.</span> radioStateChanged        - Radio 状态变化
<span class="hljs-bullet">5.</span> rilConnected             - RIL 连接
<span class="hljs-bullet">6.</span> onImeiMappingChanged     - IMEI 映射变化
</code></pre>
<hr/>
<h2 data-id="heading-6">7️⃣ <strong>IMS 指示（IMS Indications）- 3 种</strong></h2>
<p>来自 <code>IRadioImsIndication</code> 接口：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> onConnectionSetupFailure - IMS 连接设置失败
<span class="hljs-bullet">2.</span> notifyAnbr               - 接收网络速率建议 (ANBR)
<span class="hljs-bullet">3.</span> triggerImsDeregistration - 触发 IMS 去注册
</code></pre>
<hr/>
<h2 data-id="heading-7">额外信息：Config 指示（Config Indications）</h2>
<p>除了上述主要指示，还有 <strong>Config 相关指示</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">来自 IRadioConfigIndication 接口：
<span class="hljs-bullet">1.</span> simSlotsStatusChanged      - SIM 槽状态变化
<span class="hljs-bullet">2.</span> enabledLogicalSlots        - 启用的逻辑槽变化
</code></pre>
<hr/>
<h2 data-id="heading-8">📊 总体分类</h2>


















































<table><thead><tr><th>类别</th><th>指示数</th><th>主要功能</th></tr></thead><tbody><tr><td>Voice</td><td>13</td><td>通话、CDMA、紧急呼叫、STK</td></tr><tr><td>Data</td><td>5</td><td>数据连接、PCO、APN 限流</td></tr><tr><td>Network</td><td>15</td><td>网络注册、信号、小区信息</td></tr><tr><td>SIM</td><td>11</td><td>SIM 卡、STK、订阅</td></tr><tr><td>Messaging</td><td>7</td><td>SMS、广播短信</td></tr><tr><td>Modem</td><td>6</td><td>Radio 状态、硬件配置、RIL</td></tr><tr><td>IMS</td><td>3</td><td>IMS 连接、速率建议</td></tr><tr><td><strong>总计</strong></td><td><strong>~60+</strong></td><td>—</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">🔑 关键点</h2>
<ol>
<li>
<p><strong>HIDL vs AIDL</strong>：</p>
<ul>
<li><strong>HIDL 1.0-1.6</strong>：所有指示通过单一 <code>IRadioIndication</code> 接口</li>
<li><strong>AIDL</strong>：指示分为 7 个专项接口，实现了模块化设计</li>
</ul>
</li>
<li>
<p><strong>指示触发时机</strong>：</p>
<ul>
<li>某些指示需要确认（如 SMS）</li>
<li>某些指示只在状态变化时触发（如 networkStateChanged）</li>
<li>某些指示可能定期触发（如 signalStrength）</li>
</ul>
</li>
<li>
<p><strong>Wake Lock 策略</strong>：在 HIDL 中，每个指示都关联一个 wake lock 策略（<code>WAKE_PARTIAL</code>、<code>DONT_WAKE</code> 等）</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一夜变天！OpenAI紧急甩出GPT-5.3-Codex，强得让人头皮发麻（附国内使用方法）]]></title>    <link>https://juejin.cn/post/7603581886148919350</link>    <guid>https://juejin.cn/post/7603581886148919350</guid>    <pubDate>2026-02-06T09:28:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603581886148919350" data-draft-id="7603383059152224298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一夜变天！OpenAI紧急甩出GPT-5.3-Codex，强得让人头皮发麻（附国内使用方法）"/> <meta itemprop="keywords" content="OpenAI,ChatGPT"/> <meta itemprop="datePublished" content="2026-02-06T09:28:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱吃的小肥羊"/> <meta itemprop="url" content="https://juejin.cn/user/2637045249608064"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一夜变天！OpenAI紧急甩出GPT-5.3-Codex，强得让人头皮发麻（附国内使用方法）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2637045249608064/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱吃的小肥羊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:28:23.000Z" title="Fri Feb 06 2026 09:28:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>同样是竞争，国内外的方法还真的不一样！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e172ac7f95b745b1abec9c2f336e89cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=f9jseoJdtFLZ3%2BmKM25FH8CsbEk%3D" alt="" loading="lazy"/></p>
<p>今天凌晨，大事件一个接一个。</p>
<p>Anthropic和OpenAI这对"老冤家"，又同一个夜晚玩了次惊天大反转，开始集体扎堆发布模型，你还在回味Claude Opus 4.6的能力。</p>
<p>OpenAI就甩出了GPT-5.3-Codex，一个专为开发者设计的编程帮手，奥特曼称其拥有目前最佳的编码性能，进一步释放了 Codex 的潜能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb9ed97be55448ecadc755679217eaaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=LHjJ4vjMyWK8e3KFnkyKeuabXvo%3D" alt="" loading="lazy"/></p>
<p>那这款新模型到底有多强？国内能不能用以及如何使用？今天这篇文章给大家一次性讲清楚！</p>
<p>OpenAI直接甩出了数据：SWE-Bench Pro达到56.8%（这是实际软件工程场景的难题集），Terminal-Bench 2.0达到77.3%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/645e9bf8089743349a962092de9a72d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=yV%2BCMR71iUV%2BQbLhC%2BXTo9GwkeE%3D" alt="" loading="lazy"/></p>
<p>这两个成绩是什么概念？简单说，这是OpenAI在当前编程模型中表现突出的成绩。相比GPT-5.2-Codex，速度快了25%，消耗的token还更少。</p>
<p>而且这一次，GPT-5.3-Codex还做到了一个特别有意思的事儿：它本身的训练和优化，用的就是Codex的早期版本。</p>
<p>也就是说，OpenAI的团队用上个月的Codex去打磨这个月的Codex，自我迭代的效率显著提升，两个月内，整个公司的工作方式都被它改造了。</p>
<p><strong>从编码助手变成工作智能体，这次GPT-5.3-Codex能力范围扩大十倍。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/203086cb123449b184a3a76da8f3bd3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=w3ZdJiC3YWK7HbhXUN47vXfiQWA%3D" alt="" loading="lazy"/></p>
<p>GPT-5.3-Codex不再只会"写代码、审代码"，它还能处理财务分析、生成演示稿、制作数据表格、调试异常、部署上线、写PRD、做用户研究……</p>
<p>听起来有点夸张，但这就是OpenAI所说的"Beyond Coding"的真实含义。</p>
<p>换句话说，整个项目周期里，所有涉及到屏幕、鼠标、代码、文档的事儿，它都能参与。</p>
<p>OpenAI在GDPval基准（测试专业知识工作能力的标准）上证明了这一点。</p>
<p>GPT-5.3-Codex的表现跟GPT-5.2持平，都处于顶尖水准。在计算机操作基准OSWorld上，它的表现也远超之前的GPT模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4dfd91e0c1e471f9de5ee961805e57c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=PjTGLoiSlrqGumb2u9G9LL9bINI%3D" alt="" loading="lazy"/></p>
<p>离发布会不到12个小时，国内外的用户已经开始玩疯了。</p>
<p>比如这位大佬就表示， GPT-5。3 Codex 其实在 Three.js 方面相当疯狂，非常轻松就制作出我的世界，但Opus 4.6就不太行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88e9ed89745d48c18c1067bdf250dffa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=9be%2FKRMXjzRYzlLWgd0hd28sFSY%3D" alt="" loading="lazy"/></p>
<p>还有用户表示，GPT-5.3 Codex相比GPT 5.2有着巨大的提升</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e49f7e9c0d1471b8d8d41b598992cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=V%2FbN0iNXvNtT20lPymwrdZuA5Qo%3D" alt="" loading="lazy"/></p>
<p>OpenAI在测试中让GPT-5.3-Codex用几天时间从零开始制作了两个游戏。</p>
<p>赛车游戏经过完整重做，加入了不同赛手、八张地图和丰富任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9a2880acc324be2a1b3dad5a4b566e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=hBNhXpmUI81H0RikvQO8nPSShu0%3D" alt="图片" loading="lazy"/>潜水游戏让玩家探索珊瑚礁并收集鱼类标本。两个游戏整个迭代过程中，Codex自主改进优化，人工干预需求显著减少。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b107e72386554742a69d88f6a3a67dcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=8zjpMjfJRyA1OTuDiZ%2B46log904%3D" alt="图片" loading="lazy"/></p>
<p>更直观的例子来自OpenAI的内部应用。</p>
<p>研究员想了解Codex每个回合能完成多少工作。他让Codex自动编写正则表达式分类器，分析用户澄清请求的频率、反馈质量和任务进度，然后系统地应用到整个会话日志，输出了完整的数据报告。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00643107bd2d423fb837c9eae20b3069~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770974903&amp;x-signature=1HxJ1K9JAzqB%2F7IBsBFJCJ%2FRAgU%3D" alt="" loading="lazy"/></p>
<p>这种工作量通常需要人类花费几小时的细致分析和编程。Codex只用三分钟。当AI开始加速自己领域的工作时，效率提升才真正开始。</p>
<p>那大家要如何使用呢，目前GPT-5.3-Codex 已包含在 ChatGPT 的付费套餐中，但 API 还需要等待一段时间。</p>
<p>如果你还不会订阅GPT的话，可以去看我之前的文章。里面有详细的介绍。</p>
<p>相关阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzE5MTgzNDg3OA%3D%3D%26mid%3D2247484177%26idx%3D1%26sn%3D798401a8bce3207e86958dd9a20bf8ce%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzE5MTgzNDg3OA==&amp;mid=2247484177&amp;idx=1&amp;sn=798401a8bce3207e86958dd9a20bf8ce&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">2025全新ChatGPT Plus订阅的六种方法，实测有效！</a></p>
<p>话说，Claude Opus 4.6和GPT-5.3-Codex到底谁更厉害呢？欢迎在评论区聊聊！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[挣脱上下文的枷锁：OpenViking，为 AI Agent 而生的开源上下文数据库]]></title>    <link>https://juejin.cn/post/7603308967126122496</link>    <guid>https://juejin.cn/post/7603308967126122496</guid>    <pubDate>2026-02-06T09:42:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603308967126122496" data-draft-id="7603581886148952118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="挣脱上下文的枷锁：OpenViking，为 AI Agent 而生的开源上下文数据库"/> <meta itemprop="keywords" content="数据库,开源,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T09:42:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节跳动开源"/> <meta itemprop="url" content="https://juejin.cn/user/1227510999971086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            挣脱上下文的枷锁：OpenViking，为 AI Agent 而生的开源上下文数据库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1227510999971086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    字节跳动开源
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:42:30.000Z" title="Fri Feb 06 2026 09:42:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p> “We are swimming in a sea of information, and we need to learn to navigate.” — Norbert Wiener</p>
<p> “我们正畅游在信息的海洋中，我们需要学会航行。” — 诺伯特·维纳</p>
</blockquote>
<p>AI Agent 的浪潮已至，它正从简单的任务执行者，演变为能够感知环境、自主规划、并调用工具完成复杂目标的智能实体。然而，在这片充满无限可能的机遇之海中，开发者们却普遍遭遇了一座难以逾越的冰山——<strong>上下文管理</strong>。</p>
<p>随着模型能力飞速提升，Agent 不再满足于处理单轮对话或短文本，而是开始面对长周期任务、海量多模态数据和复杂的协同需求。记忆、资源、技能……这些原本分散各处的上下文，管理起来愈发混乱。然而，如何高效管理和利用这些上下文，已成为开发者们普遍遭遇的瓶颈：</p>
<ul>
<li><strong>上下文无序且割裂</strong>：记忆在代码中，资源在向量库，技能分散在各个角落，关联和维护成本极高。</li>
<li><strong>长程任务需要更多上下文</strong>：Agent 逐渐从处理单轮对话转向执行长周期任务，会涉及多工具、多 Agent 间的复杂协同。每一轮任务执行都会给上下文窗口和模型理解带来压力，如果简单的截断或压缩，本质上是“丢卒保帅”，会带来不可逆的信息损失和高昂的模型成本。</li>
<li><strong>朴素 RAG 检索效果局限</strong>：朴素 RAG 的数据切片是平铺式存储，缺乏全局视野，面对海量、多模态且有信息组织的数据越来越力不从心，可能会错失关键信息。同时，它过于关注语义相关性，在需要兴趣泛化和探索的开放式场景中表现不佳。</li>
<li><strong>上下文缺乏观测和调试：</strong> 从 DeepSeek 和 Manus 的爆火能发现，在 AI 越来越强大时，用户更渴望白盒化的体验，能看到其思考与决策的轨迹。而传统 RAG 隐式的检索链路如同黑箱，出错时难以归因和调试，改进门槛高。</li>
<li><strong>记忆成为核心资产</strong>：模型本身是通用的，大家越发意识到沉淀的记忆才是 Agent 的核心资产，但这不止包括使用用户的记忆，还包括 Agent 自身的经验和偏好记忆。记忆需要在开发初期就建设起来，这样才能形成使用时间越长，体验越好的<strong>复利效果</strong>。</li>
</ul>
<p>而近年来，业界也关于 Context Engineering 有一些探索实践：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmanus.im%2Fzh-cn%2Fblog%2FContext-Engineering-for-AI-Agents-Lessons-from-Building-Manus%3Fref%3Dblog.langchain.com" target="_blank" title="https://manus.im/zh-cn/blog/Context-Engineering-for-AI-Agents-Lessons-from-Building-Manus?ref=blog.langchain.com" ref="nofollow noopener noreferrer">Manus</a> 提出文件系统是上下文的终极形态；<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FshareAI-lab%2Fanalysis_claude_code" target="_blank" title="https://github.com/shareAI-lab/analysis_claude_code" ref="nofollow noopener noreferrer">Claude Code 的成功</a>验证了文件系统 + Bash 的简洁方案在特定场景下超越复杂向量索引的潜力；而 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fequipping-agents-for-the-real-world-with-agent-skills%3Ff_link_type%3Df_linkinlinenote%26flow_extra%3DeyJpbmxpbmVfZGlzcGxheV9wb3NpdGlvbiI6MCwiZG9jX3Bvc2l0aW9uIjowLCJkb2NfaWQiOiIyZmU3MmRlZTEyNTU3NmM0LWZjZjk2Y2Q0MjM2MzI5ZTUifQ%253D%253D" target="_blank" title="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills?f_link_type=f_linkinlinenote&amp;flow_extra=eyJpbmxpbmVfZGlzcGxheV9wb3NpdGlvbiI6MCwiZG9jX3Bvc2l0aW9uIjowLCJkb2NfaWQiOiIyZmU3MmRlZTEyNTU3NmM0LWZjZjk2Y2Q0MjM2MzI5ZTUifQ%3D%3D" ref="nofollow noopener noreferrer">Anthropic 的 Skills 系统</a>也巧妙地以文件夹来组织能力模块。这些实践给了我们启发，但也反映了一个问题：文件系统是上下文一种很好的组织方式，但并没有一个类似数据库能有效管理Agent所需所有上下文并解决上述问题。</p>
<p>为此，我们正式开源 <strong>OpenViking</strong>——专为 AI Agent 设计的上下文数据库。</p>
<p><strong>我们旨在为 Agent 定义一套极简的上下文交互范式，让开发者彻底告别上下文管理的烦恼。</strong> OpenViking 摒弃了传统 RAG 的碎片化向量存储模式，创新性地采用“文件系统范式” <strong>，</strong> 将 Agent 所需的记忆、资源和技能进行统一的结构化组织。</p>
<p><em><strong>Memory, Resource, Skill. Everything is a File.</strong></em></p>
<p><strong>记忆、资源、技能，皆为文件。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de9f4ca871ca43b796d60b3753c1955f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=qyhj6QCPUh%2Bg0RScoMCA7gTwruc%3D" alt="" loading="lazy"/></p>
<p>借助 OpenViking，上下文不再是散落一地的拼图，而是一个层次分明、井然有序的认知系统。它能够实现上下文的<strong>分层供给</strong>，在保障信息完整性的前提下，将 Token 成本降至最低；它提供<strong>协同写入</strong>与<strong>自我迭代</strong>机制，让 Agent 的“知识”与“经验”在与世界的交互中持续成长，开发者可以像管理本地文件一样构建 Agent 的大脑：</p>
<ul>
<li>
<p><strong>文件系统管理范式 → 解决碎片化问题：</strong> 基于文件系统范式，将记忆、资源、技能进行统一上下文管理</p>
</li>
<li>
<p><strong>分层上下文按需加载 → 降低 Token 消耗：</strong> L0/L1/L2 三层结构，按需加载，大幅节省成本</p>
</li>
<li>
<p><strong>目录递归检索 → 提升检索效果：</strong> 支持原生文件系统检索方式，融合目录定位与语义搜索，实现递归式精准上下文获取</p>
</li>
<li>
<p><strong>可视化检索轨迹 → 上下文可观测：</strong> 支持可视化目录检索轨迹，让用户能够清晰观测问题根源并指导检索逻辑优化</p>
</li>
<li>
<p><strong>会话自动管理 → 上下文自迭代：</strong> 自动压缩对话中的内容、资源引用、工具调用等信息，提取长期记忆，让 Agent 越用越聪明</p>
</li>
</ul>
<p>现在，让我们一起深入了解 OpenViking，看看它如何挣脱上下文的枷锁，助您在 AI Agent 的浪潮中扬帆远航。</p>
<h2 data-id="heading-0">OpenViking 核心理念</h2>
<p>OpenViking 的设计哲学围绕四大核心理念构建，旨在将复杂的上下文管理流程化繁为简，让开发者能将宝贵的精力聚焦于业务创新。</p>
<h3 data-id="heading-1">文件系统管理范式</h3>
<p>我们不再将上下文视为扁平的文本切片，而是将其统一抽象并组织于一个<strong>虚拟文件系统</strong>中。无论是记忆、资源还是能力，都会被映射到 <code>viking://</code> 协议下的虚拟目录，拥有唯一的 URI。这种范式赋予了 Agent 前所未有的上下文操控能力，使其能像开发者一样，通过 <code>list</code>、<code>find</code> 等标准指令来精确、确定性地定位、浏览和操作信息，让上下文的管理从模糊的语义匹配演变为直观、可追溯的“文件操作”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46a84972cea94b42bc51aa1b78a698ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=lcu0JVa7uCBfS4DaPIyeyrYDEOc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">分层上下文按需加载</h3>
<p>将海量上下文一次性塞入提示词，不仅成本高昂，更容易超出模型窗口并引入噪声。OpenViking 借鉴业界前沿实践，在上下文写入时便自动将其处理为三个层级：</p>
<ul>
<li><strong>L0 (摘要)</strong> ：一句话概括，用于快速判断。</li>
<li><strong>L1 (概述)</strong> ：包含核心信息和使用场景，供 Agent 在规划阶段进行决策。</li>
<li><strong>L2 (详情)</strong> ：完整的原始数据，供 Agent 在确有必要时深入读取。</li>
</ul>
<p>OpenViking 的设计使其能够灵活适配各类 AI Agent 的开发场景。无论是简单的问答机器人，还是复杂的自动化工作流，它都能作为坚实的上下文底座，提供稳定、高效的支撑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9a339372b374559b86ff73c1c0ad646~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=kbjVKQzmWsbxGlYPyqHObSLFQy0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">目录递归检索</h3>
<p>单一的向量检索难以应对复杂的查询意图。OpenViking 设计了一套创新的<strong>目录递归检索</strong>策略，它深度融合了多种检索方式的优点：首先，通过<strong>意图分析生成多个检索条件</strong>；然后，利用向量检索快速定位初始切片所在的<strong>高分目录</strong>；接着，在该目录下进行<strong>二次检索</strong>，并将高分结果更新至候选集合；若目录下仍存在子目录，则<strong>逐层递归</strong>重复上述二次检索步骤；最终，拿到最相关上下文返回。这种 “先锁定高分目录、再精细探索内容” 的策略，不仅能找到语义最匹配的片段，更能理解信息所在的完整语境，从而提升检索的全局性与准确性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95d56e8c09624b8c81c2db549f0cef37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=OGHEgTVRbuarmGtIrELMgTBlQUo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">可观测与自迭代</h3>
<p>OpenViking 的组织方式采用层次化虚拟文件系统结构，所有上下文均以统一格式整合且每个条目对应唯一 URI（如 viking:// 路径），打破传统扁平黑箱式管理模式，层次分明易于理解；同时检索过程采用目录递归策略，每次检索的目录浏览、文件定位轨迹均被完整留存，能够清晰观测问题根源并指导检索逻辑优化。</p>
<p>此外，OpenViking 内置了记忆自迭代闭环。在每次会话结束时，通过 <code>session.commit()</code> 主动触发，系统会异步分析任务执行结果与用户反馈，并自动更新至 User 和 Agent 的 /memory 目录下。既能更新用户偏好相关记忆，使 Agent 回应更贴合用户需求，又能从任务执行经验中提取操作技巧、工具使用经验等核心内容，助力后续任务高效决策实现自我进化，让 Agent 在与世界的交互中“越用越聪明”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f212e81f0d094753a073abecc5f04fd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=S9ZE%2FsXk%2F5h46%2B6R80pUnAwUwF8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">快速上手：三分钟运行 OpenViking</h2>
<p>OpenViking 的一大核心优势是其极简的集成方式。我们深知开发者的宝贵时间不应浪费在繁琐的配置上。您无需部署复杂的服务或学习新的 DSL，只需通过几行 Python 代码，即可为您的 Agent 装上强大的“上下文大脑”。</p>
<p>以下示例是以OpenViking的Readme英文版作为文件进行写入，展示处理后的上下文目录结构，以及对应文档的分层信息，并进行简单问题的回复。</p>
<h4 data-id="heading-6"><strong>第一步：安装 OpenViking</strong></h4>
<p>暂时无法在飞书文档外展示此内容</p>
<h4 data-id="heading-7"><strong>第二步：获取模型服务</strong></h4>
<p>OpenViking 需要VLM模型（用于多模态内容理解）和Embedding 模型（用于向量化）能力的API Key：</p>
<p>我们支持多种模型服务：</p>
<ul>
<li>OpenAI 模型：支持 GPT-4V 等 VLM 模型和 OpenAI Embedding 模型</li>
<li>火山引擎（豆包模型）：推荐使用，成本低、性能好，新用户有免费额度。如需购买和开通，请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.byted.org%2Fdata-arch%2FOpenViking%2Fblob%2Fadd_readme%2Fdocs%2Fzh%2Fguides%2Fvolcengine-purchase-guide.md" target="_blank" title="https://code.byted.org/data-arch/OpenViking/blob/add_readme/docs/zh/guides/volcengine-purchase-guide.md" ref="nofollow noopener noreferrer">火山引擎购买指南</a></li>
<li>其他自定义模型服务：支持兼容 OpenAI API 格式的模型服务</li>
</ul>
<h4 data-id="heading-8"><strong>第三步：配置环境</strong></h4>
<p>创建配置文件 <code>ov.conf</code>：</p>
<blockquote>
<p>⚠️ 重要提示：请将下方配置中的 <code>&lt;your-volcengine-api-key&gt;</code> 替换为你在第二步获取的真实 API Key！</p>
</blockquote>
<p>暂时无法在飞书文档外展示此内容</p>
<p>并设置环境变量：</p>
<p>暂时无法在飞书文档外展示此内容</p>
<h4 data-id="heading-9"><strong>第四步：运行体验</strong></h4>
<p>创建简单的 Python 脚本 <code>example.py</code>并运行，通过写入 OpenViking README 文档来体验写入-检索-读取的全过程：</p>
<p>暂时无法在飞书文档外展示此内容</p>
<p>运行脚本：</p>
<p>暂时无法在飞书文档外展示此内容</p>
<p><strong>若您得到检索结果，恭喜！你已成功运行 OpenViking 🎉</strong></p>
<h2 data-id="heading-10">开源共建，定义下一代 Agent 上下文标准</h2>
<p>我们坚信，开放与协作是推动技术创新的核心动力。将 OpenViking 开源，是我们回馈社区、并与全球开发者共同探索 AI Agent 未来的第一步。</p>
<p>这不仅仅是一次代码的分享，更是一次理念的传播。我们希望通过 OpenViking，能够为业界提供一个关于 Agent 上下文管理的全新范式，一个能够有效降低开发门槛、激发业务创新的坚实底座。</p>
<p>我们深知，OpenViking 目前还处于早期阶段，有许多需要完善和探索的地方。但这正是开源的魅力所在——它允许我们汇聚最广泛的智慧，应对最前沿的挑战。</p>
<p>在此，我们诚挚地邀请每一位对 AI Agent 技术充满热情的开发者：</p>
<ul>
<li><strong>访问我们的GitHub 仓库</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvolcengine%2FOpenViking" target="_blank" title="https://github.com/volcengine/OpenViking" ref="nofollow noopener noreferrer">github.com/volcengine/…</a> ，为我们点亮一颗宝贵的 Star，给予我们前行的动力。</li>
<li><strong>访问我们的网站</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenviking.ai" target="_blank" title="https://openviking.ai" ref="nofollow noopener noreferrer">openviking.ai</a> ，了解我们传递的理念，并通过文档使用它，在您的项目中感受它带来的改变，并向我们反馈最真实的体验。</li>
<li><strong>扫描下方二维码加入我们的社区</strong>，分享您的洞见，帮助解答他人的疑问，共同营造一个开放、互助的技术氛围。</li>
</ul>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/775f10b745c34bd68a963c5500d35b05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=zGFX210fblKjiIlnybc6Vi9sh5w%3D" alt="" width="50%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6beeccf881f45aab88e5eb1dc26e408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975750&amp;x-signature=o3osuu%2BDGLiPIPPFIOny7Epav3w%3D" alt="" width="50%" loading="lazy"/>
<ul>
<li><strong>成为我们的</strong> <strong>贡献者</strong>，无论是提交一个 Bug 修复，还是贡献一个新功能，您的每一行代码都将是 OpenViking 成长的重要基石。</li>
</ul>
<p>让我们一起，共同定义和构建 AI Agent 上下文管理的未来。旅程已经开始，期待您的加入！</p>
<h2 data-id="heading-11">关于我们：字节跳动 Viking 团队</h2>
<p>我们用 C 端产品的体验标准打造能够重塑企业生产力的产品和技术。在上下文工程领域具有深厚的技术积累与商业化实践，我们的愿景是提供用户友好的上下文工程产品矩阵。</p>
<p><strong>我们的产品历程</strong></p>
<ul>
<li><strong>2019 年</strong>：VikingDB 向量数据库支撑字节内部全业务大规模使用</li>
<li><strong>2023 年</strong>：VikingDB 在火山引擎公有云售卖</li>
<li><strong>2024 年</strong>：推出面向开发者的产品矩阵：VikingDB 向量数据库、Viking 知识库、Viking 记忆库</li>
<li><strong>2025 年</strong>：打造 AI 搜索、vaka 知识助手等上层应用产品</li>
<li><strong>2025 年 10 月</strong>：开源 MineContext <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvolcengine%2FMineContext" target="_blank" title="https://github.com/volcengine/MineContext" ref="nofollow noopener noreferrer">github.com/volcengine/…</a> ，主动式 AI 应用探索</li>
<li><strong>2026 年 1 月</strong>：开源 <strong>OpenViking</strong>，为 AI Agent 提供底层上下文数据库支撑</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[85.9k Star 认证！Mermaid：每个开发者都需要的“图表即代码”神器]]></title>    <link>https://juejin.cn/post/7603444191448236066</link>    <guid>https://juejin.cn/post/7603444191448236066</guid>    <pubDate>2026-02-06T09:42:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191448236066" data-draft-id="7603383311530950671" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="85.9k Star 认证！Mermaid：每个开发者都需要的“图表即代码”神器"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-02-06T09:42:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            85.9k Star 认证！Mermaid：每个开发者都需要的“图表即代码”神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:42:53.000Z" title="Fri Feb 06 2026 09:42:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在软件开发、系统设计与项目管理领域，图表是沟通复杂思想的重要桥梁。作为程序员，无论是在撰写技术文档、编写博客，还是进行方案设计，一款得力的图表工具都能显著提升效率。Mermaid 正是这样一款优秀的软件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec6b418ee9f044e8a697369173adfc9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=rc4tuU3gaPULZBye56ke0hqxxWw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">🎯 Mermaid 是什么？</h2>
<p>Mermaid 是一个基于 JavaScript 的图表绘制工具库，它的核心哲学是 “图表即代码” 。它通过解析类似 Markdown 的简洁文本语法，让你可以用写代码的方式，动态地生成和修改各种专业图表。</p>
<p>想象一下，你的流程图、时序图、类图不再是一个个难以更新的静态图片文件，而是和你的项目文档（如 README、Wiki）或源码注释生活在一起的、可版本控制的文本片段。当需求变更时，你只需修改几行描述文本，图表就会自动更新！</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmermaid-js%2Fmermaid" target="_blank" title="https://github.com/mermaid-js/mermaid" ref="nofollow noopener noreferrer">github.com/mermaid-js/…</a></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.js.org%2F" target="_blank" title="https://mermaid.js.org/" ref="nofollow noopener noreferrer">mermaid.js.org/</a></p>
<p>文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.js.org%2Fintro%2F" target="_blank" title="https://mermaid.js.org/intro/" ref="nofollow noopener noreferrer">mermaid.js.org/intro/</a></p>
<p>在线编辑地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.ai%2Flive%2Fedit" target="_blank" title="https://mermaid.ai/live/edit" ref="nofollow noopener noreferrer">mermaid.ai/live/edit</a></p>
<p>编辑器github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmermaid-js%2Fmermaid-live-editor" target="_blank" title="https://github.com/mermaid-js/mermaid-live-editor" ref="nofollow noopener noreferrer">github.com/mermaid-js/…</a></p>
<p>该项目目前在github上已有<strong>85.9k</strong>⭐star</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b73e39efbe6e4deba749edf596468fcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=dxb2jtTliJb8%2F4%2FzlE6QhkAAgiU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">🌟 Mermaid 的核心优势</h2>
<h3 data-id="heading-2">✨ 告别“文档滞后”</h3>
<p>Mermaid 诞生的初衷就是为了解决 Doc-Rot 难题。它让图表维护变得和写代码一样简单，确保你的设计与文档永远能跟上开发节奏。</p>
<h3 data-id="heading-3">🚀 无缝集成</h3>
<p>Mermaid 可以轻松集成到你的工作流中：</p>
<ul>
<li>• 文档工具：已集成到 GitHub/GitLab Markdown、Typora 等众多工具中。</li>
<li>• 编译器插件：IntelliJ IDEA、Visual Studio Code等主流编辑器中可以使用插件集成。</li>
<li>• 博客/网站：可通过简单的脚本引入。</li>
<li>• 开发流程：图表可以直接作为生产脚本的一部分，实现自动化。</li>
</ul>
<h3 data-id="heading-4">👨‍💻 对开发者友好</h3>
<p>使用纯文本定义图表，意味着你可以：</p>
<ul>
<li>• 轻松地进行复用和重构。</li>
<li>• 享受代码高亮、补全等编辑器的便利。</li>
<li>• 可以使用ai高效的完成代码编制。</li>
</ul>
<h2 data-id="heading-5">🐳Docker 部署 Mermaid编辑器</h2>
<p>编辑器github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmermaid-js%2Fmermaid-live-editor" target="_blank" title="https://github.com/mermaid-js/mermaid-live-editor" ref="nofollow noopener noreferrer">github.com/mermaid-js/…</a></p>
<p>创建docker-compose.yml文件</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">mermaid-live-editor:</span>
    <span class="hljs-string">image:</span> <span class="hljs-string">ghcr.io/mermaid-js/mermaid-live-editor</span>
    <span class="hljs-string">container_name:</span> <span class="hljs-string">mermaid-live-editor</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-string">-</span> <span class="hljs-string">"6080:8080"</span>
    <span class="hljs-string">restart:</span> <span class="hljs-string">unless-stopped</span>
</code></pre>
<p>启动服务</p>
<pre><code class="hljs">docker-compose up -d 
</code></pre>
<p>使用Docker部署比较简单，到此，我们就已经完成私有化部署了。</p>
<h2 data-id="heading-6">🛠️使用</h2>
<h3 data-id="heading-7">🌐在线编辑器中使用</h3>
<p>我们打开官方提供的在线编辑器或者我们自己部私有化署的编辑器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16de6b6dc14a46fe94c417372ea99649~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=mOV3gCukhyIFw%2FC3KXRQmIyWqTM%3D" alt="" loading="lazy"/></p>
<p>选择自己需要的图表类型开始编写，官方文档语法、示例提供的比较齐全，有不太清楚的可以查阅文档。以下是部分示例截图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/840938a121ab4cdfb4b817fd5e54f312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=wtX5D7fv6tsi22zyZmyM6%2BGR%2BXk%3D" alt="" loading="lazy"/></p>
<p><img src="" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c8e9adbc7ed4bfe8ce4a2a8b7fd12c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=jBlw8O2vkbAHZj63nSfZ7mgTBKA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b73ccec0706143538e97ad511d895776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=ayzRHbqZ2IxFd8wqKrddp4nHOpA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84cecd88f6104e3ab3e37255ab87059a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=R39NQvUZ5QMfg7%2BD5IrJuJF9f8A%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">📄MarkDown中使用</h3>
<p>在markdown中使用的适合将代码类型设置为<code>mermaid</code>即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d25618ff9f045afa2b3cf5846a6da97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975776&amp;x-signature=E9H%2FylQmx8EmoKLBR7HIpbHsOAk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">🧩编译器插件</h3>
<p>IntelliJ IDEA、Visual Studio Code等主流编辑器：众多扩展提供实时预览和智能提示。</p>
<h2 data-id="heading-10">📝结语</h2>
<p>在 GitHub 的星海之中，能够收获超过 <strong>85.9k</strong>⭐ star 的项目凤毛麟角。这一数字承载着全球开发者最真实的认可与最迫切的需求。<br/>
如果你已厌倦在 Visio、Draw.io 和各种文档之间反复切换，如果你期待让技术图表像代码一样易于创建、维护与协作——那么，是时候拥抱 Mermaid 了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[双 11 大促峰值不翻车：淘天集团 Paimon + StarRocks 大规模 OLAP 查询实战与优化]]></title>    <link>https://juejin.cn/post/7603444191448252450</link>    <guid>https://juejin.cn/post/7603444191448252450</guid>    <pubDate>2026-02-06T09:46:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191448252450" data-draft-id="7603383311530819599" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="双 11 大促峰值不翻车：淘天集团 Paimon + StarRocks 大规模 OLAP 查询实战与优化"/> <meta itemprop="keywords" content="大数据,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T09:46:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            双 11 大促峰值不翻车：淘天集团 Paimon + StarRocks 大规模 OLAP 查询实战与优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T09:46:14.000Z" title="Fri Feb 06 2026 09:46:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：朱奥（盖可）/ 淘天集团高级数据工程师</p>
<h2 data-id="heading-0">导读：</h2>
<p>双 11 等大促场景会在短时间内集中爆发：运营与业务 BI 在开卖后的窗口期密集访问数据产品，瞬时请求量陡增，对查询引擎的稳定性、成本与治理体系提出极高要求。与此同时，业务对近实时数据产品的诉求持续增强，传统“多存储、多链路、依赖回刷”的模式在研发效率、回刷成本与响应速度上逐步暴露瓶颈。</p>
<p>本文围绕 Paimon 与 StarRocks 的组合实践，梳理淘天在大规模 OLAP 查询场景下的架构演进与双 11 保障体系：通过实时与离线统一入湖，消除数据同步链路与多份存储成本；基于稳定中间层叠加在线现算与维表实时关联，将高消耗回刷转化为秒级查询，核心场景回刷效率提升约 80%，年化节省成本接近 1000 万；同时结合 StarRocks + RoaringBitmap 低成本解决跨天交叉实时 UV 计算难题，满足大促近实时决策需求。</p>
<h2 data-id="heading-1">1、淘天集团营销活动 OLAP 查询的探索背景与核心策略</h2>
<h3 data-id="heading-2">1.1 业务诉求与核心痛点当前数据架构</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7b10417ca904466b316db16f9de2f8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=xQx8y%2FDle%2B077Q3mtUXHRNE9euw%3D" alt="5a7bb2fdd2234116b9ffa58f4a5aa606.png" loading="lazy"/></p>
<p>首先，简要介绍当前的数据架构与数据流转方式。</p>
<p>从 DWD 层开始，我们的数据分为实时与离线两条主链路：</p>
<ul>
<li>
<p>实时数据主要存储在 TT中，在业界可类比为 Kafka 一类的消息队列；</p>
</li>
<li>
<p>离线数据主要存储在 ODPS 中。</p>
</li>
</ul>
<p>在数据加工与写入层面，我们会启动 Flink 流批一体任务：</p>
<ul>
<li>
<p>实时侧持续消费 TT 中的数据；</p>
</li>
<li>
<p>离线侧消费 ODPS 中的数据；</p>
</li>
<li>
<p>在计算过程中，任务会关联多类 ODPS 维表，例如类目维表、商家分层等维度信息。</p>
</li>
<li>
<p>计算完成后，结果统一写入 ADS 层的 Holo 表中，并在数据服务层对外透出。</p>
</li>
</ul>
<p>在纯离线场景下，我们会通过 ODPS 任务读取 ODPS 数据，同时写入 ADS 层对应的 ODPS 表。这里既包含历史天级数据，也包含历史小时级数据。当存在查询加速需求时，我们还会将 ODPS 数据进一步导入到 Holo 中。</p>
<p>在数据服务层，我们主要通过 Holo 或 MC 对外提供数据服务。我们会根据查询时延要求选择不同的服务路径：当业务对响应速度要求更高、需要达到毫秒级时，通常通过 Holo 提供查询服务；当时延要求相对宽松，例如百毫秒级或秒级，则更多通过 MC 来承载查询请求。</p>
<h3 data-id="heading-3">1.2 业务诉求与核心痛点</h3>
<p>随着业务发展，我们当前面临的诉求主要来自两个方向：一是业务侧希望获得更多实时数据产品；二是业务 BI 的实时分析需求持续增长。这对数据研发提出了新的挑战：进一步提升研发效率。</p>
<p>回到现有架构，其核心痛点主要体现在两方面：</p>
<ul>
<li>
<p><strong>流批存储不统一</strong>：实时数据存储在 TT 中，离线数据存储在 ODPS 中；当存在查询加速需求时，部分数据还需要进一步落到 Holo 表中。</p>
</li>
<li>
<p><strong>整体开发架构较为复杂</strong>：数据需要在多个存储介质之间流转，导致端到端链路拉长。</p>
</li>
</ul>
<p>在查询特性上，Holo 在点查场景具备更突出的性能优势，且整体稳定性较强，在淘天历年大促期间的表现也相对稳定。</p>
<p>但在更常见的 Shuffle 场景下，整体查询性能相对一般。尤其当 OLAP 查询负载更重、需要进行更复杂的计算，或需要关联规模较大的维表时，Shuffle 相关的执行效率会成为瓶颈，导致查询耗时明显拉长。</p>
<p>数据更新与维护上也存在较高成本。以 ODPS 中的维表为例（如类目维表、商家分层维表等），当维表发生业务变更时，往往需要触发 ADS 层任务的回刷，从而带来额外的回刷开销。</p>
<p>业务对“近实时”的诉求在部分场景下出现了被动降级。例如在跨天实时 UV 等场景中，由于 state 规模较大、成本较高等原因，方案不得不从实时级别降级到小时级别。从业务视角看，近实时能力仍然是明确存在的需求。</p>
<h3 data-id="heading-4">1.3 核心策略</h3>
<p><strong>1）架构简化提效</strong></p>
<ul>
<li>
<p>架构上实现<strong>存储介质的统一</strong>：将实时与离线数据统一沉淀到 Paimon 的湖存储中。在此基础上，<strong>StarRocks 可以直接面向湖存储进行高性能分析查询</strong>，从而能够消除数据同步链路以及多份存储带来的成本。</p>
</li>
<li>
<p><strong>降低使用门槛</strong>，让数据更容易被上层分析与 BI 使用。以实时链路为例，原本实时数据存储在 TT 中，而 TT 的数据形态具有明显特征：每行数据是一个字符串、缺少 schema。在这种形态下，数据虽然可以被消费，但如果要面向 BI 分析使用，往往还需要额外进行反序列化与解析，这会带来不可忽视的工程与使用成本。</p>
</li>
</ul>
<p>在统一存储之后，Paimon 将实时与离线数据沉淀在同一张表中，并提供明确的 schema。这意味着，上层使用方可以直接面向结构化数据开展分析：即使分析师的数据开发能力不强，也可以基于 Paimon 的近实时中间层，通过 <strong>StarRocks</strong> 自助完成对近实时数据的分析。</p>
<p>在这种模式下，过去一些相对简单的取数与分析需求，可以由 BI 或分析师通过自助方式直接完成，不再必须提交给数据研发排期处理，从而在一定程度上减少数据开发侧的需求量与交付压力。</p>
<p><strong>2）业务难点攻坚</strong></p>
<p>通过稳定的中间层 Paimon，以及“OLAP 实时关联易变维度”的模式，将原本高消耗的 ADS 回刷任务转化为秒级查询来完成。在后续内容中，我会进一步展开这一改造如何将高消耗回刷去掉，并带来显著的成本收益——每年可节省近千万元级别的回刷成本。</p>
<p>同时，我们通过 StarRocks + RoaringBitmap 的方案，高性能解决了跨天交叉实时 UV 的计算难题，以更低成本的方式满足大促期间对近实时能力的诉求。</p>
<h3 data-id="heading-5">1.4 新数据架构</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b8a10449fa64391bc1cb1367e6c9af7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=RoxruLrk3rVI8vXD3ZSNb7lpSus%3D" alt="be42fb67ef9846c08fa064277e5a73fc.png" loading="lazy"/></p>
<p>在秒级数据链路上，我们通过实时 Flink 任务消费 DWD 层的 Fluss（秒级实时数据），并将结果写入 ADS 层的 Fluss。</p>
<p>Fluss 提供“湖流一体”的同步开关。开启后，Fluss 中的数据会按配置周期自动同步到 Paimon 表中，默认周期可以是每 3 分钟，且该时间间隔支持用户自定义配置。同步完成后，Paimon 表中会形成当天分钟级数据（t 当天）以及 t−n 的历史数据。</p>
<p>在此基础上，我们会启动 Flink 流批一体任务，同时消费 DWD 层 Paimon 的 t 当天数据与 t−n 历史数据，并将加工结果写入 Paimon 表的 ADS 层与 DWD 层，分别沉淀 t 当天与历史数据。</p>
<p>此外，基于 Paimon 的 partial-update 能力，我们也可以构建离线大宽表，用于承载同一业务对象的多状态聚合。以订单为例，订单存在支付、确收、退款等多种状态，可以构建一张以 order_id 为主键的 Paimon 大宽表，将这些状态写入同一行记录。这样在使用侧只需读取对应 order_id 的一条记录，即可获取该订单的多种状态信息，使用成本与分析便利性都会更高。</p>
<p>在 ADS 层，我们沉淀的计算结果主要面向“叶子粒度”的维度：例如类目侧以叶子类目为主；若涉及商家分层维表，则对应叶子商家分层。在数据服务层，我们通过 StarRocks 对外提供数据服务。具体而言，在 StarRocks 层既可以直接读取 ADS 层数据进行点查，也可以直接读取 DWD 层的中间层数据进行在线计算。后一种方式的查询负载通常更重、数据量更大，但在当前实践中，StarRocks 仍然能够将查询时延控制在秒级范围内，在查询量较大的情况下保持较快响应。在查询过程中，我们也可以进一步关联 Paimon 维表，最终将查询结果在数据产品端进行展示与交付。</p>
<p>在我们的业务场景中，一般来说，DWD 层的中间层事实数据相对稳定；真正“易变”的往往是维度侧的数据，例如 Paimon 维表（类目维表、商家分层维表等）。当业务规则或口径发生调整时，通常只需要更新维表即可。相较于回刷大规模中间层数据，维表更新的成本更低、执行也更快。</p>
<p>更关键的是，我们在查询侧采用现算方式：维表更新后，查询会在读取中间层数据的基础上实时关联最新维表，因此中间层数据无需随业务变更反复回刷。由于中间层计算量较重，如果依赖回刷来响应业务调整，整体周期往往较长——快则一到两天，慢则可能需要一周。通过“更新维表 + 查询现算”的方式，业务变更后可以更快在数据产品侧看到最新结果。</p>
<p>在数据服务层，我们进一步利用 StarRocks 的 Warehouse 机制，对读集群进行隔离与分级保障，避免不同业务互相影响。我们按照业务重要性划分为三类：</p>
<ul>
<li>
<p>默认 Warehouse：保障级别相对一般；</p>
</li>
<li>
<p>重保 Warehouse：承载最核心业务，保障级别最高；</p>
</li>
<li>
<p>业务 BI 专用 Warehouse：面向业务 BI 或其他业务的专用资源池，保障级别相对一般。</p>
</li>
</ul>
<h2 data-id="heading-6">2、Paimon+StarRocks 在双11大规模 OLAP 查询场景下的实践与优化</h2>
<h3 data-id="heading-7">2.1 业务背景</h3>
<p>在日常情况下，运营和业务 BI 往往在不同时间访问数据产品，因此 StarRocks的瞬时请求量（RPS）整体较低，压力相对平稳。</p>
<p>但在大促期间情况会明显不同。以开卖时段为例，运营和业务 BI 通常会在接下来的一小时内集中访问数据产品，导致 StarRocks 的瞬时请求 RPS 急剧升高，对 StarRocks 集群带来显著挑战。</p>
<p>因此，本部分的实践与优化工作主要围绕“大促场景稳定运行”这一目标展开。</p>
<h3 data-id="heading-8">2.2 集群侧保障</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/004d2ccbabb04b20ab32a7ac98a235f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=GKsQsn53kAfXMbcHMxaWnHmVya4%3D" alt="5b0f2bb0168249bc98beaa726abd5806.png" loading="lazy"/></p>
<p><strong>1）在应用层面推广数据集缓存策略：</strong></p>
<p>目前配置 180 秒的查询缓存窗口。也就是说，同一条查询在 180 秒内被多次触发时，实际下发到 StarRocks 执行的仅为首次请求；后续请求直接复用首次查询结果。通过该策略，可以有效降低大促高峰期 StarRocks 集群的瞬时压力。</p>
<p><strong>2）集群层面的保护机制：</strong></p>
<p>集群侧设置了 30 秒的全局超时：如果一条 SQL 在 30 秒内仍未执行完成，会被自动终止。该机制属于 StarRocks 的集群保护能力，当查询执行时间超过 30 秒，即可判定该 SQL 需要进一步优化，不适合直接上线，需要回退并完成优化后再进入生产环境。对于少量确有必要、且在 30 秒内无法完成的特殊 SQL，也支持为单条 SQL 配置更长的超时时间。但此类 SQL 数量通常极少，上线评估也会更加严格，以确保不会对整体集群稳定性产生影响。整体目标是避免单条慢 SQL 拖垮集群。</p>
<p><strong>3）架构层隔离：按业务重要性划分只读实例。</strong></p>
<p>基于业务重要性对只读查询资源进行分层，将不同业务的读请求隔离到不同的只读实例上，避免相互干扰。</p>
<p><strong>4）集群初始化配置</strong></p>
<p>在新的 StarRocks 集群初始化时，比较推荐先设置一套基础参数，如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">set global cbo_cte_reuse_rate=0; 
</code></pre>
<p>当 CTE 被多处引用时，可能触发同一数据源的重复读取。例如，一个表在 select 中读取三次，那么 StarRocks会对同一张 Paimont 表执行三次读取，读 I/O 开销相当于被放大为 3 倍。将该参数设置为 0 后，可使同一张表在同一条查询中只读取一次。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">set global query_timeout=30; 
</code></pre>
<p>设置 30 秒的集群全局查询超时**，**避免单条慢 SQL 拖垮集群。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">set global new_planner_optimize_timeout=10000;
</code></pre>
<p>适当调大执行图优化器的超时时间。如果该参数设置过小，SQL 在调度过程中更容易直接失败；适当增大后，可降低 SQL 失败的频率。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">set global pipeline_dop=8; 
</code></pre>
<p>调整 pipeline 的 DOP，用于控制每台机器上拉起的 driver 数量。压测结果显示，在大促场景中 SQL 请求高度集中，若 DOP 设置过大（例如 64），单条 SQL 在每台机器上会拉起大量 driver，带来调度开销飙升，甚至可能打满 driver 阻塞队列，导致 CPU 利用率反而上不去，集群进入不可用状态。</p>
<p>在我们 StarRocks 集群的双 11 压测中，DOP 调整到 8 时整体查询表现最优，因此给出 DOP=8 作为建议值。需要强调的是，该值是经验建议，最终仍应以各自集群的压测结果为准进行配置。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">set global scan_paimon_partition_num_limit=100;  
</code></pre>
<p>限制 scan paimon外表的最大分区，用于杜绝因条件缺失或下推失败导致的全表/超大范围扫描。</p>
<h3 data-id="heading-9">2.3 核心指标监控</h3>
<p>通过观察 StarRocks 核心指标的水位变化，可以持续评估实例健康状况。常用的核心指标如图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d519ee20fb74e1eb36d20430d3ebeab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=1vHNeAgPxSRNnFEwcEOpGnPaKd8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">2.4 报警规则</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68d49b80230340b0902ab71e68a38baf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=0pa6uy2qdu7aD0AiR%2B%2B9skh5j9M%3D" alt="cdb33b569699410c9cb33cc79cee25fb.png" loading="lazy"/></p>
<p>建立 StarRocks 实例的异常报警机制非常关键，它能够帮助及时发现实例异常并快速介入处理。报警项的设置通常围绕“资源水位、节点可用性、调度拥塞、查询失败与时延”几类核心信号展开，其中有一部分阈值来自大促压测与实战探索，具有较强参考价值：</p>
<ul>
<li>
<p>BE/CN 的 CPU 与内存使用率设置阈值，例如当使用率持续高于 70% 时触发告警；</p>
</li>
<li>
<p>FE 的 CPU 与内存使用率同样设置 70% 的告警阈值；</p>
</li>
<li>
<p>在可用性方面，可以监控 BE/CN 或 FE 的可用率是否低于 100%，一旦出现低于 100% 的情况，通常意味着有节点不可用或发生故障。</p>
</li>
<li>
<p>当 BE 阻塞队列数超过 2000 时，StarRocks 集群的查询时延可能出现陡增；</p>
</li>
<li>
<p>在查询侧，可以增加查询失败次数与查询时延分位数的告警，例如“查询失败次数大于 n”“查询延迟 TP99 大于 n”。其中 n 的取值需要结合业务特性与可接受的服务水平目标进行配置。</p>
</li>
</ul>
<h3 data-id="heading-11">2.5 元数据监控</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a52d0f431e94c13bf5ee643f782df43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=HhgtqySGrmmia0808EDujkzVmjw%3D" alt="73cea218e8ee4922b80e8b5ecba11fbf.png" loading="lazy"/></p>
<p>为更有效地治理 StarRocks的各类查询请求，可以实时获取审计日志，并基于审计日志构建元数据监控大盘，为后续的慢查询 SQL 治理提供数据支撑与定位依据。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">select * from _starrocks_audit_db_.starrocks_audit_tbl;
</code></pre>
<p>审计日志相关数据落在 <strong>StarRocks</strong> 的内表中，对应信息可实时查询。也就是说，某条 SQL 执行完成后，可以立即在该内表中查到这条 SQL 的执行耗时等关键字段。基于这一基础能力，如果需要进一步做更细的源数据与查询行为监控，也可以围绕审计日志中记录的 SQL 信息进行扩展。</p>
<p>在监控大盘的组织方式上，支持按 Warehouse 维度拆分（例如划分为多个 Warehouse），同时也可以按数据集进行过滤。在筛选完成后，重点关注的数据字段通常包括：数据集名称、总 CPU 消耗、总查询大小、查询次数、查询行数、失败率与失败次数、单次查询的 CU 消耗、查询时间以及查询发起人等。这些指标支持排序与聚合，便于在优化过程中选取特定时间窗口，对总 CPU 消耗、总查询大小、总查询行数等维度进行 Top SQL 排查与治理。通过优先治理这些“高消耗/高影响”的 SQL，往往能够显著改善集群整体健康状况，因为在许多情况下，集群不稳定的根因来自少量高风险的“坏 SQL”。</p>
<h3 data-id="heading-12">2.6 大促保障</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fdd5e52849a4179a02c546ef0c14d1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=5T8j5FXFgKWdluzEYhhk%2BGsBtNo%3D" alt="image.png" loading="lazy"/>
大促保障的目标，是把不确定性尽量前置消化，确保开卖高峰期间查询链路稳定可控。</p>
<ul>
<li>
<p><strong>在资源侧</strong>，会结合历史数据与业务预测，在大促开始前对 StarRocks 集群进行主动扩容，并在大促结束后主动缩容。</p>
</li>
<li>
<p><strong>在需求侧</strong>，提前与业务负责人对齐本次大促的核心变更点，重点关注改造或新增页面，并将核心页面的 QPS 进行量化，为全链路压测与容量评估做准备。</p>
</li>
<li>
<p><strong>针对重保页面</strong>，我们还会建立一套智能应急机制，分为实例级与查询级两层。实例级故障切换方面，当 StarRocks 主实例不可用时，可通过自动化预案工具（FBI）将重保页面的查询请求批量切换到备库 Warehouse，完成实例级容灾；查询级自动容错方面，当重保页面出现单次查询失败或超时，系统会将该查询自动路由到备库 Warehouse 重试，尽量做到用户无感，为关键 SQL 增加一次“二次机会”，提升整体稳定性。</p>
</li>
</ul>
<h3 data-id="heading-13">2.7 大促压测</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ce7b5f831cb4a5baed3deabae647b97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=d5XCduc7HHWXrin98SG7MLKUJV0%3D" alt="ec2dd45519bb480d8784695847ee4629.png" loading="lazy"/></p>
<p>大促压测通常分为两层：<strong>核心页面单压与全链路压测。</strong></p>
<p>在核心页面单压阶段，会先梳理大促期间的核心页面及新增页面，并对这些页面进行单独压测。这样做的目的，是尽可能在活动前置暴露并解决单点问题导致的性能瓶颈，为后续上线留出精细化优化空间。</p>
<p>在全链路压测阶段，会模拟“所有页面同时达到流量峰值”的极限场景，用以验证 StarRocks 集群在峰值冲击下的整体资源水位与关键性能指标是否符合预期。重点关注的资源水位通常包括 CPU、内存与 I/O，同时结合查询时延等指标，评估集群在极端并发与高负载下的稳定性与承载边界。</p>
<h3 data-id="heading-14">2.8 压测发现的问题和优化方案</h3>
<p><strong>1）分区裁剪失效或缺少分区过滤，导致扫全表</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12d2dab27cd14feb8ccb2578e02cef2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=dYuRlUJ10iXunvN41SJzPDhlkEE%3D" alt="1e442b8c79984e2a85440c9c085d46c5.png" loading="lazy"/></p>
<p>压测中发现，部分 SQL 因分区裁剪失效或未配置分区过滤条件，出现扫描范围过大甚至扫全表的风险。针对该类问题，治理原则是必须启用分区过滤并确保分区裁剪生效，不允许存在扫全表 SQL 在线运行。</p>
<p>分区裁剪生效的常见写法包括：对分区字段进行日期传参，直接基于分区字段触发裁剪；或使用日期函数触发裁剪，例如 date_format、date_add 等函数也可以触发分区裁剪。</p>
<p>分区裁剪失效的典型场景是分区字段与子查询结果进行比较，例如将分区字段与子查询返回的最小活动时间进行对比时，分区裁剪会失效。原因在于分区裁剪发生在 FE 阶段，而子查询需要到 BE 执行，FE 在规划阶段无法获得子查询结果，从而无法生成有效的分区裁剪信息。</p>
<p><strong>2）读取 Paimon 生表时小文件过多，导致读取数据块数过大</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2de3bbc8d89d4cfd93fdf7b32327179c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770975973&amp;x-signature=UR9mUct%2F8jSOXhe%2FGih1sSbULcc%3D" alt="f7565bca02374c3a9dd1ae6e94058b02.png" loading="lazy"/></p>
<p>压测还发现，读取 Paimon 表时存在小文件过多的问题。</p>
<p><strong>定位方法</strong>：在 StarRocks 执行 SQL 时可开启 profile（通过 hint：/*+ SET_VAR(enable_profile = true) */）生成 profile 文件；在 profile 中搜索 “metadata”，其中 nativeReaderReadNum 表示读取的数据块数，nativeReaderReadBytes 表示读取的字节数。实践中，当单个分区的 nativeReaderReadNum 大于 200 时，通常建议考虑对表进行排序治理。</p>
<p><strong>优化方案</strong>：在构建流批排序Paimon表时，建议采用分支表模式：离线分支将 bucket 设为 -1，实时分支按需设置 bucket。离线分支表通过 clustering columns 指定排序字段，可支持指定多个字段（如 f1、f2），一般选择 OLAP 查询中最常用的过滤字段，以提升过滤命中与读取效率。该能力仅支持 Flink 批写入，不支持 ODPS 写入；写入表时需要使用 hint：<strong>/*+ OPTIONS('sink.parallelism' = '64') */</strong>。对于 ODPS 写入的 Paimon 表，则需要在任务下挂一个单独的 compact 排序任务。</p>
<p><strong>为何有效</strong>：在双 11 场景下，活动周期往往持续数十天。当天数据属于实时增量，而从活动开始到昨天的历史数据占比更大；因此对离线数据进行表排序收益显著。压测实测显示，排序后读取的数据块数约为排序前的 1/1000。  离线分支完成排序后，活动开始到昨天（占比最大的历史数据）基本都处于“已排序、数据块读取量很小”的状态；实时分支由于无法排序，读取的数据块会相对多一些，但实时数据通常只存在于当天，整体占比小，因此对整条 SQL 的查询时延影响相对有限。</p>
<p><strong>3）检查是否命中 MapJoin：小维表建议显式 broadcast</strong></p>
<p>当 SQL 需要 join 小表（例如小于 10MB 的维表）时，建议在维表前显式加 broadcast，以触发类似离线 MapJoin 的执行策略。实测显示，引入 broadcast 后查询时延可显著下降，典型场景下可从十几秒优化到约 3 秒，整体查询时延约为原先的 1/3。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">SELECT xxx
FROM table_a t0
LEFT JOIN [broadcast] dim_table_b t1 
ON t0.cate_id = t1.slr_main_cate_id
AND t1.ds = 'xxx'
</code></pre>
<p><strong>4）检查跨地域访问：计算与存储尽量同地域部署</strong></p>
<p>还需要确认 StarRocks 实例与所读取的 Paimon 表是否处于同一地域。若不在同一地域，查询时延会明显增加。建议将 StarRocks 的部署地域与 Paimon 表存储地域保持一致。</p>
<p><strong>5）主键表建议开启 deletion vectors：减少无效数据读取</strong></p>
<p>对于 Paimon 主键表，建议开启 'deletion-vectors.enabled' = 'true'参数。该能力会在写入阶段记录哪些主键数据已被删除；读取时可跳过已删除数据，减少无效扫描，从而提升查询性能。非主键表不需要开启该参数。</p>
<h2 data-id="heading-15">3、阶段成果与未来规划</h2>
<h3 data-id="heading-16">3.1 阶段成果</h3>
<p>整体来看，该方案带来了四方面阶段性成果。</p>
<ul>
<li>
<p><strong>数据链路得到简化</strong>：通过统一存储与统一查询面，消除了数据同步链路，并降低了多份存储带来的成本与复杂度。</p>
</li>
<li>
<p>**数据使用门槛显著降低：**基于 Paimon 的实时/离线中间层，不仅数据开发人员可以使用，业务分析师也可以通过 StarRocks 自助消费近实时数据，从而减少部分简单需求对数据研发排期的依赖。</p>
</li>
<li>
<p><strong>回刷开销得到明显削减</strong>：**核心场景的回刷效率提升约 80%，年化节省成本接近 1000 万。**其关键在于查询可以直接读取 Paimon 公共层并关联 Paimon 维表，业务变更时只需刷新维表，无需回刷与该维表相关的整条数据链路。</p>
</li>
<li>
<p><strong>在高性能实时分析方面，低成本解决了跨天交叉维度实时 UV 的计算难题，满足大促期间近实时决策需求。</strong> 具体做法是将可累加指标（如订单数、订单支付金额等）与不可累加指标（如 user_id）分开处理：可累加指标在查询侧直接聚合；不可累加指标则将 user_id 做 RB 化后存入中间层，StarRocks 读取 Paimon 表时通过 RB 相关函数计算 UV。</p>
</li>
</ul>
<h3 data-id="heading-17">3.2 未来规划</h3>
<p>面向下一阶段，规划主要集中在四个方向。</p>
<p>第一，<strong>希望 StarRocks 具备更强的自动物化能力</strong>：针对用户高频查询的 SQL 自动生成物化结果，并在后续查询中自动完成改写，直接命中物化表。由于物化表往往已经完成聚合，其数据量相较直接查询中间层可以小很多个量级，从而显著降低扫描与计算开销，进一步提升查询速度与稳定性。</p>
<p>第二，计划进一步<strong>丰富 StarRocks 的元数据能力</strong>。</p>
<p>第三，<strong>优化 StarRocks 的调度策略</strong>，重点是调度层面的 CPU 负载均衡能力。</p>
<p>第四，希望 <strong>StarRocks 具备直接读取 Fluss 的能力</strong>，从而支持秒级查询场景。目前 Paimon 仍以分钟级链路为主，如果能够在读取侧进一步下探到 Fluss，将更好覆盖对秒级实时性有明确诉求的业务场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rspress 2.0 发布：面向体验与 AI 的全新升级]]></title>    <link>https://juejin.cn/post/7603556326815842356</link>    <guid>https://juejin.cn/post/7603556326815842356</guid>    <pubDate>2026-02-06T10:01:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603556326815842356" data-draft-id="7603444191448317986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rspress 2.0 发布：面向体验与 AI 的全新升级"/> <meta itemprop="keywords" content="前端,JavaScript,开源"/> <meta itemprop="datePublished" content="2026-02-06T10:01:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节跳动开源"/> <meta itemprop="url" content="https://juejin.cn/user/1227510999971086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rspress 2.0 发布：面向体验与 AI 的全新升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1227510999971086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    字节跳动开源
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T10:01:29.000Z" title="Fri Feb 06 2026 10:01:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19675bd1aa934a068cadbd825aeb47b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=dEFyzgW6mq71FbNhjvHiotUZxa4%3D" alt="Rspress 2.0 Banner" loading="lazy"/></p>
<hr/>
<p>我们很高兴地宣布 Rspress 2.0 的正式发布！</p>
<p>Rspress 是基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2F" target="_blank" title="https://rsbuild.rs/" ref="nofollow noopener noreferrer">Rsbuild</a> 的静态站点生成器，专为开发者打造的文档站工具。自 2023 年正式发布以来，Rspress 1.x 累计迭代 <strong>144 个版本</strong>，共有 <strong>125 位贡献者</strong> 参与项目开发。越来越多的开发者选择 Rspress，借助其<strong>高效的编译性能、约定式路由和组件库预览</strong>等功能，搭建美观可靠的文档站点。</p>
<p>基于社区的反馈和建议，Rspress 2.0 在 <a href="#brand-new-theme" title="#brand-new-theme"><strong>主题美观度</strong></a>、<a href="#llms-txt-ssg-md" title="#llms-txt-ssg-md"><strong>AI-native</strong></a>、<a href="#doc-dx" title="#doc-dx"><strong>文档开发体验</strong></a>、<a href="#rslib-rspress" title="#rslib-rspress"><strong>与 Rslib 一起使用</strong></a> 等方面更进一步。</p>
<h2 data-id="heading-0">为什么是 Rspress 2.0</h2>
<p>Rspress 1.x 已经解决了文档站框架编译性能的问题，但仍存在一些问题影响着作为一个文档开发工具的核心体验。2.0 版本将不止于对编译性能的追求，也聚焦于文档站体验的其他方面：</p>
<ul>
<li>
<p><strong>主题样式</strong>：一套<strong>更美观的默认主题</strong>，并提供了多种 <a href="/zh/guide/basic/custom-theme.md" target="_blank" title="/zh/guide/basic/custom-theme.md">自定义主题</a> 方式，解决了 1.x 在主题定制上缺乏稳定 API 的问题。</p>
</li>
<li>
<p><strong>AI-native</strong>：文档不仅服务于人类读者，也需要被 Agent 更好地理解和使用。Rspress 现在内置了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fllmstxt.org%2F" target="_blank" title="https://llmstxt.org/" ref="nofollow noopener noreferrer">llms.txt</a> 生成和从 SSG 衍生出的 <a href="/zh/guide/basic/ssg-md.md" target="_blank" title="/zh/guide/basic/ssg-md.md"><strong>SSG-MD</strong></a> 功能，生成高质量的 Markdown 渲染内容供 Agent 读取。</p>
</li>
<li>
<p><strong>按需编译，瞬间启动</strong>：默认启用 <a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2Fguide%2Ffeatures%2Flazy-compilation" target="_blank" title="https://rspack.rs/guide/features/lazy-compilation" ref="nofollow noopener noreferrer">lazyCompilation</a>，配合链接 hover 时对资源的 preload 功能，仅在访问特定路由时构建所需文件，实现无论项目规模多大，dev 也可<strong>瞬间启动</strong>。</p>
</li>
<li>
<p><strong>Shiki 代码高亮</strong>：默认集成 Shiki，在<strong>构建时完成语法高亮</strong>，支持主题切换、transformer 扩展，比如 <a href="/zh/plugin/official-plugins/twoslash.md" target="_blank" title="/zh/plugin/official-plugins/twoslash.md">@rspress/plugin-twoslash</a>，带来更丰富的代码块展示效果。</p>
</li>
<li>
<p><strong>文档开发体验</strong>：优化 <code>_nav.json</code>、<code>_meta.json</code> 等文件的 HMR 并新增 <a href="/zh/guide/basic/auto-nav-sidebar.md#json-schema-%E7%B1%BB%E5%9E%8B%E6%8F%90%E7%A4%BA" target="_blank" title="/zh/guide/basic/auto-nav-sidebar.md#json-schema-%E7%B1%BB%E5%9E%8B%E6%8F%90%E7%A4%BA">json schema</a> 用于 IDE 内的代码提示；默认开启死链检查功能；新增文件代码块语法，支持引用外部文件；<a href="/zh/plugin/official-plugins/preview.md" target="_blank" title="/zh/plugin/official-plugins/preview.md">@rspress/plugin-preview</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Frspress.rs%2Fplugin%2Fofficial-plugins%2Fplayground" target="_blank" title="https://rspress.rs/plugin/official-plugins/playground" ref="nofollow noopener noreferrer">@rspress/plugin-playground</a> 支持同时使用等。</p>
</li>
<li>
<p><strong>Rslib 集成</strong>：现在可以在使用 <code>create-rslib</code> 创建组件库项目时，选择 Rspress 作为文档工具，快速搭建组件文档站点。</p>
</li>
</ul>
<p>这是一次对现有架构的全面升级，下面将介绍 Rspress 2.0 和它的 <strong>全新主题、高质量 llms.txt 生成、集成 Shiki、按需编译</strong>等重要功能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f557e1ef9966415b908aced97781eee2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=6uSUM%2FW7SLKjWBaHUsVLvO2m%2FwQ%3D" alt="Rspress 2.0 Features" loading="lazy"/></p>
<h2 data-id="heading-1">2.0 新特性</h2>
<h3 data-id="heading-2">全新主题 {#brand-new-theme}</h3>
<p>2.0 默认主题迎来了一次系统性升级，它由团队设计师 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fwei_zhong41532" target="_blank" title="https://x.com/wei_zhong41532" ref="nofollow noopener noreferrer">@Zovn Wei</a> 整体设计，在视觉效果和阅读体验上都有较大幅度提升，并且每个组件均可独立替换，拥有很高的可定制性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c0d695e7f1b47f6b91ce443360f738d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=qsFKdCh6E5%2B1%2FPeTzeaUARsmViE%3D" alt="New Theme" loading="lazy"/></p>
<h4 data-id="heading-3">主题定制</h4>
<p>按照定制化程度从低到高，有 CSS 变量、BEM 类名、ESM 重导出覆盖、组件 eject 四种<a href="/zh/guide/basic/custom-theme.md" target="_blank" title="/zh/guide/basic/custom-theme.md">自定义主题</a>方式。</p>
<ul>
<li><strong>CSS 变量</strong>：新主题暴露了更多 CSS 变量，覆盖主题色、代码块、首页等样式。你可以在 <a href="/zh/ui/vars.md" target="_blank" title="/zh/ui/vars.md">CSS 变量</a> 页面交互式地预览和调整所有 CSS 变量，找到满意的配置后直接复制到项目中使用。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 自定义主题色 */</span>
  <span class="hljs-attr">--rp-c-brand</span>: <span class="hljs-number">#3451b2</span>;
  <span class="hljs-attr">--rp-c-brand-dark</span>: <span class="hljs-number">#2e4599</span>;
  <span class="hljs-comment">/* 自定义代码块样式 */</span>
  <span class="hljs-attr">--rp-code-block-bg</span>: <span class="hljs-number">#1e1e1e</span>;
}
</code></pre>
<ul>
<li><strong>BEM 类名</strong>：内置组件现在均采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgetbem.com%2F" target="_blank" title="https://getbem.com/" ref="nofollow noopener noreferrer">BEM 命名规范</a>。这是一个十分 Old School 的选择，但也是我们深思熟虑的决定。用户可以通过 CSS 选择器精准调整样式，HTML 结构更加清晰；同时与 Rspress 用户自身使用的 CSS 框架解耦，用户可以任意选择 CSS 框架（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2F" target="_blank" title="https://tailwindcss.com/" ref="nofollow noopener noreferrer">Tailwind</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Flesscss.org%2F" target="_blank" title="https://lesscss.org/" ref="nofollow noopener noreferrer">Less</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fsass-lang.com%2F" target="_blank" title="https://sass-lang.com/" ref="nofollow noopener noreferrer">Sass</a> 等），比如使用 Tailwind V4 或 V3 而不用担心版本，也不用担心与 Rspress 内置 CSS 产生冲突。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* BEM 命名规范 */</span>
<span class="hljs-selector-class">.rp-</span><span class="hljs-selector-attr">[component-name]</span>__<span class="hljs-selector-attr">[element-name]</span>--<span class="hljs-selector-attr">[modifier-name]</span> {
}

<span class="hljs-comment">/* 根据 BEM 类名轻松覆盖组件样式 */</span>
<span class="hljs-selector-class">.rp-nav__title</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">32px</span>;
}
<span class="hljs-selector-class">.rp-nav-menu__item--active</span> {
  <span class="hljs-attribute">color</span>: purple;
}
</code></pre>
<ul>
<li><strong>ESM 重导出覆盖</strong>：如果 CSS 上的修改无法满足定制需求，可以通过 JS 进行更深度的定制。在 <code>theme/index.tsx</code> 中利用 <a href="/zh/guide/basic/custom-theme.md#reexport" target="_blank" title="/zh/guide/basic/custom-theme.md#reexport">ESM 重导出</a>，可以<strong>覆盖</strong>任意一个 Rspress 的内置组件。</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Layout</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">BasicLayout</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rspress/core/theme-original'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Layout</span> = (<span class="hljs-params"/>) =&gt; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">BasicLayout</span> <span class="hljs-attr">beforeNavTitle</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>some content<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>} /&gt;</span>;

<span class="hljs-keyword">export</span> { <span class="hljs-title class_">Layout</span> }; <span class="hljs-comment">//[!code highlight]</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'@rspress/core/theme-original'</span>; <span class="hljs-comment">//[!code highlight]</span>
</code></pre>
<ul>
<li><strong>组件 eject</strong>：你可以使用全新的 <a href="/zh/api/commands.md#rspress-eject" target="_blank" title="/zh/api/commands.md#rspress-eject"><code>rspress eject [component]</code></a> 命令，这个命令会将指定组件的源代码复制到 <code>theme/components/</code> 目录下，你可以自由修改这些代码，甚至直接交给 AI 修改，来实现深度定制。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将 DocFooter 组件导出到 theme 目录</span>
rspress eject DocFooter
</code></pre>
<h4 data-id="heading-4">导航栏、侧边栏 tag</h4>
<p>Rspress 2.0 实现了 <a href="/zh/ui/layout-components/tag.md" target="_blank" title="/zh/ui/layout-components/tag.md">Tag 组件</a>，现在可以使用 frontmatter 中的 tag 属性，在侧边栏或导航栏进行 UI 标注。</p>
<pre><code class="hljs language-mdx" lang="mdx">---
tag: new, experimental # 会在 H1 和 Sidebar 进行显示
---

import { Tag } from '@rspress/core/theme';

# Tag

## Common tags &lt;Tag tag="new" /&gt; {/* 会在右侧 outline 进行显示 */}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28c24c7d07cd47f5b204d71e6126dcfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=9Q06Wn07DMSgnfM9rdf5OYyZI%2B0%3D" alt="Tag 组件在侧边栏中的显示效果" loading="lazy"/></p>
<h4 data-id="heading-5">内置多语言支持</h4>
<p>在 1.x 版本中，Rspress 仅内置了英文文本，如果使用其他语言例如 zh，必须对所有的文本都进行配置，使用起来较为繁琐。现在 2.0 主题内置了 zh、en、ja、ko、ru 等多种语言的翻译文本，系统会根据语言配置自动进行 "Tree Shaking"，仅打包你使用到的文本及语言，未内置的语言会兜底到 en 文本。你也可以通过 <a href="/zh/api/config/config-basic.md#i18nsource" target="_blank" title="/zh/api/config/config-basic.md#i18nsource"><code>i18nSource</code></a> 配置项扩展或覆盖翻译文本。</p>
<p>Rspress 未来会支持更多内置语言，如果你有兴趣，请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fweb-infra-dev%2Frspress%2Fpull%2F2827" target="_blank" title="https://github.com/web-infra-dev/rspress/pull/2827" ref="nofollow noopener noreferrer">这位贡献者的 Pull Request</a>。</p>
<h3 data-id="heading-6">llms.txt：SSG-MD 渲染高质量的 Markdown 内容 {#llms-txt-ssg-md}</h3>
<p>Rspress 现在将 <a href="https://link.juejin.cn?target=https%3A%2F%2Fllmstxt.org%2F" target="_blank" title="https://llmstxt.org/" ref="nofollow noopener noreferrer">llms.txt</a> 生成能力集成到 core 中，并实现了全新的 SSG-MD（Static Site Generation to Markdown，静态站点 Markdown 生成）能力。</p>
<p>在基于 React 动态渲染的前端框架中，往往存在静态信息难以提取的问题，Rspress 也面临同样的挑战。Rspress 允许用户通过 <a href="/zh/guide/use-mdx/components.md" target="_blank" title="/zh/guide/use-mdx/components.md">MDX 片段</a>、React 组件、Hooks 以及 TSX 路由等动态特性来增强文档表现力。但这些动态内容在转换为 Markdown 文本时会面临以下问题：</p>
<ul>
<li>直接将 MDX 输入给 AI 会包含大量代码语法噪音，并丢失 React 组件内容</li>
<li>将 HTML 转为 Markdown 往往效果不佳，信息质量难以保证</li>
</ul>
<p>为了解决这个问题，Rspress 2.0 引入了 <a href="/zh/guide/basic/ssg-md.md" target="_blank" title="/zh/guide/basic/ssg-md.md">SSG-MD</a> 特性。这是一个全新的功能，它类似于 <a href="/zh/guide/basic/ssg.md" target="_blank" title="/zh/guide/basic/ssg.md">静态站点生成（SSG）</a>，但不同之处在于它将你的页面渲染为 Markdown 文件，而非 HTML 文件，并生成 <a href="https://link.juejin.cn?target=https%3A%2F%2Fllmstxt.org%2F" target="_blank" title="https://llmstxt.org/" ref="nofollow noopener noreferrer">llms.txt</a> 及 llms-full.txt 相关文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ee0a03b95f74055b32ccca957d6b0c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=5svyheCzMYW%2FOT8mp0Cac1eBtzk%3D" alt="SSG-MD 功能概览示意图" loading="lazy"/>
相比于将 HTML 转化为 Markdown 等传统方式，SSG-MD 在渲染期间拥有更优质的信息源，比如 React 虚拟 DOM，从而保证更高的静态信息质量和灵活性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c16273823b414fdc8efeebd1beea838d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=uPifZh6gaaTBmX4a5eOvlF2MgCw%3D" alt="SSG-MD 渲染流程示意图" loading="lazy"/>
启用方式非常简单：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rspress/core'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">llms</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<p>构建后将生成如下结构：</p>
<pre><code class="hljs language-tree" lang="tree">doc_build
├── llms.txt
├── llms-full.txt
├── guide
│   └── start
│       └── introduction.md
└── ...
</code></pre>
<p>若想定制自定义组件的渲染内容，可通过环境变量控制：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Tab</span>(<span class="hljs-params">{ label }: { label: <span class="hljs-built_in">string</span> }</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">SSG_MD</span>) {
    <span class="hljs-comment">// SSG-MD 模式下输出纯文本描述</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>{`**Tab: ${label}**`}<span class="hljs-tag">&lt;/&gt;</span></span>;
  }
  <span class="hljs-comment">// 正常渲染交互式组件</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tab"</span>&gt;</span>{label}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>这样既保证了文档的交互体验，也能帮助 AI 理解组件的语义信息。</p>
<blockquote>
<p>详见 <a href="/zh/guide/basic/ssg-md.md" target="_blank" title="/zh/guide/basic/ssg-md.md">SSG-MD 使用指南</a></p>
</blockquote>
<h3 data-id="heading-7">Shiki 编译时代码块高亮 {#shiki-code-highlighting}</h3>
<p>Rspress 2.0 默认使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fshiki.style%2F" target="_blank" title="https://shiki.style/" ref="nofollow noopener noreferrer">Shiki</a> 进行代码高亮。相比 1.x 的 prism 运行时高亮方案，Shiki 在编译时完成高亮处理。</p>
<ol>
<li>支持多种主题样式，比如在 <a href="/zh/ui/vars.md" target="_blank" title="/zh/ui/vars.md">CSS 变量</a> 页面可以交互式地切换和预览不同的 Shiki 主题。</li>
<li>同时 Shiki 也允许使用自定义的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fshiki.style%2Fguide%2Ftransformers" target="_blank" title="https://shiki.style/guide/transformers" ref="nofollow noopener noreferrer">transformer</a> 进行扩展来丰富写作，例如 twoslash 等。</li>
<li>按需引入编程语言，不增加运行时开销和包体积。</li>
<li>基于 TextMate 语法实现与 VS Code 一致的准确语法高亮。</li>
</ol>
<p>下面是一些 Shiki transformer 的示例，直观感受一下 Shiki 带来的文档创造力：</p>
<blockquote>
<p>使用 <a href="/zh/plugin/official-plugins/twoslash.md" target="_blank" title="/zh/plugin/official-plugins/twoslash.md">@rspress/plugin-twoslash</a></p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> hi = <span class="hljs-string">'Hello'</span>;
<span class="hljs-keyword">const</span> msg = <span class="hljs-string">`<span class="hljs-subst">${hi}</span>, world`</span>;
<span class="hljs-comment">//    ^?</span>
</code></pre>
<blockquote>
<p>使用 <a href="/zh/guide/use-mdx/code-blocks.md#transformernotationfocus" target="_blank" title="/zh/guide/use-mdx/code-blocks.md#transformernotationfocus">transformerNotationFocus</a></p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Not focused'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Focused'</span>); <span class="hljs-comment">// [!code focus]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Not focused'</span>);
</code></pre>
<blockquote>
<p>详见 <a href="/zh/guide/use-mdx/code-blocks.md#shiki-transformers" target="_blank" title="/zh/guide/use-mdx/code-blocks.md#shiki-transformers">代码块</a></p>
</blockquote>
<h3 data-id="heading-8">构建性能：按需编译和持久化缓存 {#build-performance-lazy-compilation-cache}</h3>
<p>Rspress 2.0 底层由 Rsbuild 和 Rspack 2.0 预览版本驱动，同时默认开启了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2Fzh%2Fguide%2Ffeatures%2Flazy-compilation" target="_blank" title="https://rspack.rs/zh/guide/features/lazy-compilation" ref="nofollow noopener noreferrer">按需编译</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2Fzh%2Fconfig%2Fperformance%2Fbuild-cache" target="_blank" title="https://rsbuild.rs/zh/config/performance/build-cache" ref="nofollow noopener noreferrer">持久化缓存</a>。</p>
<h4 data-id="heading-9">按需编译</h4>
<p>默认开启 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2Fzh%2Fconfig%2Fdev%2Flazy-compilation" target="_blank" title="https://rsbuild.rs/zh/config/dev/lazy-compilation" ref="nofollow noopener noreferrer">dev.lazyCompilation</a>，只有当你访问某个页面时，该页面才会被编译，大幅提升了开发启动速度，甚至实现毫秒级的冷启动。Rspress 同时实现了路由的 preload 策略，当鼠标悬停在链接上时会预先加载目标路由页面，搭配 lazyCompilation 实现无损的开发体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a62db08abff4b1b90531ee6b0a246a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=BogryjmXU%2FtzfkF97elPlGjsGYI%3D" alt="lazyCompilation 按需编译效果演示" loading="lazy"/></p>
<h4 data-id="heading-10">持久化缓存</h4>
<p>2.0 同时默认开启了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2Fzh%2Fconfig%2Fperformance%2Fbuild-cache" target="_blank" title="https://rsbuild.rs/zh/config/performance/build-cache" ref="nofollow noopener noreferrer">持久化缓存</a>，在热启动中复用上次编译的结果，提升 30%-60% 的构建速度。这意味着在首次运行 <code>rspress dev</code> 或 <code>rspress build</code> 后，后续启动速度都会明显提升。</p>
<h3 data-id="heading-11">文档开发体验 {#doc-dx}</h3>
<h4 data-id="heading-12">默认开启死链检查</h4>
<p>Rspress 2.0 默认开启死链检查功能。在构建过程中，会自动检测文档中的无效链接，帮助你及时发现和修复。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rspress/core'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">markdown</span>: {
    <span class="hljs-attr">link</span>: {
      <span class="hljs-attr">checkDeadLinks</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 默认开启，可通过 false 关闭</span>
    },
  },
});
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/288d1e9e607447b88e23220fe0959405~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo5byA5rqQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770977032&amp;x-signature=cfJ8FsL%2Fwm9%2B4bDZUTCC7L6HTzY%3D" alt="死链检查功能示例" loading="lazy"/></p>
<blockquote>
<p>详见 <a href="/zh/guide/use-mdx/link.md" target="_blank" title="/zh/guide/use-mdx/link.md">链接</a></p>
</blockquote>
<h4 data-id="heading-13">文件代码块</h4>
<p>你可以使用 <code>file="./path/to/file"</code> 属性来引用外部文件作为代码块的内容，将示例代码放在单独的文件中维护。</p>
<pre><code class="hljs language-mdx" lang="mdx">```ts file="./_demo.ts"

```
</code></pre>
<pre><code class="hljs language-mdx" lang="mdx">```tsx file="&lt;root&gt;/src/components/Button.tsx"

```
</code></pre>
<blockquote>
<p>详见 <a href="/zh/guide/use-mdx/code-blocks.md#file-code-block" target="_blank" title="/zh/guide/use-mdx/code-blocks.md#file-code-block">文件代码块</a></p>
</blockquote>
<h4 data-id="heading-14">preview 更灵活的 meta 用法</h4>
<p><a href="/zh/plugin/official-plugins/preview.md" target="_blank" title="/zh/plugin/official-plugins/preview.md">@rspress/plugin-preview</a> 现在基于 meta 属性使用，更加灵活，也可以配合文件代码块。</p>
<p>下面是一个使用 iframe 预览代码块的示例：</p>
<pre><code class="hljs language-mdx" lang="mdx">```tsx preview="iframe-follow" file="./_demo.ts"

```
</code></pre>
<p>它将会渲染为：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count - 1)}&gt;-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>并且 <a href="/zh/plugin/official-plugins/playground.md" target="_blank" title="/zh/plugin/official-plugins/playground.md">@rspress/plugin-playground</a> 现在支持和 plugin-preview 一起使用，通过 meta 属性切换即可，例如 <code>```tsx playground</code></p>
<h4 data-id="heading-15">支持若干配置文件的 HMR</h4>
<p>基于 Rsbuild 重新设计的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frstackjs%2Frsbuild-plugin-virtual-module" target="_blank" title="https://github.com/rstackjs/rsbuild-plugin-virtual-module" ref="nofollow noopener noreferrer">虚拟模块插件</a>，现在支持 <code>i18n.json</code>、<code>_nav.json</code>、<code>_meta.json</code>、文件代码块以及 <code>@rspress/plugin-preview</code> 中 iframe 相关的 HMR。修改这些配置文件后，页面会自动热更新，无需手动刷新。</p>
<h3 data-id="heading-16">Rslib &amp; Rspress {#rslib-rspress}</h3>
<p>在使用 <code>create-rslib</code> 创建项目时，你现在可以选择 Rspress 工具。这让你能够在开发组件库的同时，快速搭建配套的文档站点，用于编写组件的使用说明、展示 API 参考，或实时预览组件效果。</p>
<p>执行 <code>npm create rslib@latest</code> 并选中 Rspress，会生成下方的文件结构：</p>
<pre><code class="hljs language-tree" lang="tree">├── docs
│   └── index.mdx
├── src
│   └── Button.tsx
├── package.json
├── tsconfig.json
├── rslib.config.ts
└── rspress.config.ts
</code></pre>
<p>模版中内置了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frstackjs%2Frsbuild-plugin-workspace-dev" target="_blank" title="https://github.com/rstackjs/rsbuild-plugin-workspace-dev" ref="nofollow noopener noreferrer">rsbuild-plugin-workspace-dev</a> 插件，可在启动 Rspress 开发服务器的同时自动运行 Rslib 的 watch 命令。</p>
<p>直接运行 <code>npm run doc</code> 启动 Rspress 的开发服务器对 Rslib 组件库进行预览：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rslib build --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"doc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rspress dev"</span> <span class="hljs-comment">// 执行该命令</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-17">更多 Rspress 官方插件</h3>
<p>Rspress 2.0 新增了多个官方插件：</p>
<ul>
<li><a href="/zh/plugin/official-plugins/algolia.md" target="_blank" title="/zh/plugin/official-plugins/algolia.md"><strong>@rspress/plugin-algolia</strong></a>：支持替换 Rspress 的内置搜索为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocsearch.algolia.com%2F" target="_blank" title="https://docsearch.algolia.com/" ref="nofollow noopener noreferrer">Algolia DocSearch</a>（感谢 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Falgolia" target="_blank" title="https://x.com/algolia" ref="nofollow noopener noreferrer">@algolia</a> 团队的协助）。</li>
<li><a href="/zh/plugin/official-plugins/twoslash.md" target="_blank" title="/zh/plugin/official-plugins/twoslash.md"><strong>@rspress/plugin-twoslash</strong></a>：为 TypeScript 代码块添加类型提示。</li>
<li><a href="/zh/plugin/official-plugins/llms.md" target="_blank" title="/zh/plugin/official-plugins/llms.md"><strong>@rspress/plugin-llms</strong></a>：为不支持 SSG 和 SSG-MD 的项目提供 llms.txt 生成能力。</li>
<li><a href="/zh/plugin/official-plugins/sitemap.md" target="_blank" title="/zh/plugin/official-plugins/sitemap.md"><strong>@rspress/plugin-sitemap</strong></a>：自动生成 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitemaps.org" target="_blank" title="https://www.sitemaps.org" ref="nofollow noopener noreferrer">Sitemap</a> 文件，用于优化 SEO。</li>
</ul>
<hr/>
<h2 data-id="heading-18">其他 Breaking changes</h2>
<h3 data-id="heading-19">从 Rspress 1.x 迁移</h3>
<p>如果你是 1.x 项目的用户，我们准备了一份详尽的迁移文档，帮助你从 1.x 升级到 2.0。</p>
<p>你可以直接使用页面中的 "复制 Markdown" 功能，将其输入给你常用的编码 agent（如 Claude Code 等）来完成迁移。</p>
<blockquote>
<p>请参考 <a href="/zh/guide/migration/rspress-1-x.md" target="_blank" title="/zh/guide/migration/rspress-1-x.md">迁移指南</a>。</p>
</blockquote>
<h3 data-id="heading-20">移除 <code>mdxRs</code> 配置</h3>
<p>我们注意到很大一部分 1.x 用户为了使用 Shiki、组件库预览功能和自定义 remark/rehype 插件，而主动关闭 <code>mdxRs</code>，并且在开启按需编译和持久化缓存后，即使使用 JS 版本的 mdx 解析器，性能优化效果已经非常显著。</p>
<p>为了换取更好的扩展性和维护性，我们决定在 Markdown/MDX 编译流程中不再使用 Rust 版本的 MDX 解析器（<code>@rspress/mdx-rs</code>）。这使得 Rspress 能够更好地集成 Shiki 等 JavaScript 生态的工具。</p>
<h3 data-id="heading-21">Node.js 与上游依赖版本要求</h3>
<p>Rspress 2.0 要求 Node.js 版本 <strong>20+</strong>，React 版本 <strong>18+</strong>。</p>



































<table><thead><tr><th>依赖</th><th>允许范围</th><th>默认版本</th><th>说明</th></tr></thead><tbody><tr><td><code>react</code></td><td><code>^18.0.0 || ^19.0.0</code></td><td>19</td><td>不再支持 React 17，如项目已安装则使用项目版本</td></tr><tr><td><code>react-dom</code></td><td><code>^18.0.0 || ^19.0.0</code></td><td>19</td><td>与 react 版本保持一致</td></tr><tr><td><code>react-router-dom</code></td><td><code>^6.0.0 || ^7.0.0</code></td><td>7</td><td>如项目已安装则使用项目版本</td></tr><tr><td><code>unified</code></td><td><code>^11.0.0</code></td><td>11</td><td>自定义 remark/rehype 插件需兼容</td></tr></tbody></table>
<h3 data-id="heading-22">包名及导入路径变更</h3>
<p>Rspress 将 <code>rspress</code>、<code>@rspress/runtime</code>、<code>@rspress/shared</code>、<code>@rspress/theme-default</code> 都整合进了 <code>@rspress/core</code> 中，项目和插件现在均只需安装一个 <code>@rspress/core</code> 包即可。</p>
<pre><code class="hljs language-diff" lang="diff">{
  "dependencies": {
<span class="hljs-deletion">-   "rspress": "1.x"</span>
<span class="hljs-deletion">-   "@rspress/shared": "1.x"</span>
<span class="hljs-addition">+   "@rspress/core": "^2.0.0"</span>
  }
}
</code></pre>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- import { defineConfig } from 'rspress/config';</span>
<span class="hljs-addition">+ import { defineConfig } from '@rspress/core';</span>
</code></pre>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- import { useDark } from 'rspress/runtime'</span>
<span class="hljs-deletion">- import { PackageManagerTabs } from 'rspress/theme';</span>
<span class="hljs-addition">+ import { useDark } from '@rspress/core/runtime'</span>
<span class="hljs-addition">+ import { PackageManagerTabs } from '@rspress/core/theme';</span>
</code></pre>
<p>如果你开发了 Rspress 插件，请将插件的 peerDependencies 从 <code>rspress</code> 变更为 <code>@rspress/core</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"peerDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@rspress/core"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-23">下一步</h2>
<p>Rspress 2.0 的发布只是一个新的起点。本次发布后，Rspress 将持续迭代：</p>
<ul>
<li>
<p><strong>推进生态集成</strong>：与 Rslib、Rstest 更深度地结合，提供前端项目和组件库项目的一体化开发体验。</p>
</li>
<li>
<p><strong>探索 AI 与文档更深度集成</strong>：如智能问答、自动摘要等；完善 SSG-MD 使其稳定并更加易用。</p>
</li>
</ul>
<p>感谢所有为 Rspress 做出贡献的开发者和用户！如果你在使用过程中遇到问题或有任何建议，欢迎在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fweb-infra-dev%2Frspress%2Fissues" target="_blank" title="https://github.com/web-infra-dev/rspress/issues" ref="nofollow noopener noreferrer">GitHub Issues</a> 中反馈。</p>
<p>立即使用或升级到 Rspress 2.0，体验全新的文档开发之旅！</p>
<pre><code class="hljs language-sh" lang="sh">npm create rspress@latest
</code></pre>
<pre><code class="hljs language-sh" lang="sh">yarn create rspress
</code></pre>
<pre><code class="hljs language-sh" lang="sh">pnpm create rspress@latest
</code></pre>
<pre><code class="hljs language-sh" lang="sh">bun create rspress@latest
</code></pre>
<pre><code class="hljs language-sh" lang="sh">deno init --npm rspress@latest
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-create-app使用cesium并且渲染3d倾斜摄影]]></title>    <link>https://juejin.cn/post/7603359026711068682</link>    <guid>https://juejin.cn/post/7603359026711068682</guid>    <pubDate>2026-02-06T07:57:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603359026711068682" data-draft-id="7603263490341912585" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-create-app使用cesium并且渲染3d倾斜摄影"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-06T07:57:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="scorpioop"/> <meta itemprop="url" content="https://juejin.cn/user/2683248842638445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-create-app使用cesium并且渲染3d倾斜摄影
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2683248842638445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    scorpioop
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:57:02.000Z" title="Fri Feb 06 2026 07:57:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>先上效果
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d91986db1cd44a3c979695e2cf4cc046~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2NvcnBpb29w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969423&amp;x-signature=8Rk0mVxuB45LwCSZrCSZ8D910CQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、cesium在react-create-app中的引用</h2>
<p>首先
<code>yarn add cesium</code>然后<code>yarn add copy-webpack-plugin -D</code>然后<code>yarn add customize-cra react-app-rewired --dev </code></p>
<p>设置了customize-cra react-app-rewired就可以改写webpack</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e9ed1316b54ea38f0ac111b027805d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2NvcnBpb29w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969423&amp;x-signature=xMHtx8ofQT2ZjbL66C%2BQjDieF%2FQ%3D" alt="image.png" loading="lazy"/>
新建一个这个文件，在里面改写webpack</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> {
  override,
 
  addWebpackPlugin,
} = <span class="hljs-built_in">require</span>(<span class="hljs-string">"customize-cra"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CopyWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"copy-webpack-plugin"</span>);
<span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">"webpack"</span>);


<span class="hljs-keyword">const</span> cesiumSource = <span class="hljs-string">'node_modules/cesium/Source'</span>;
<span class="hljs-keyword">const</span> cesiumWorkers = <span class="hljs-string">'../Build/Cesium/Workers'</span>;



<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">override</span>(
  
 
  <span class="hljs-title function_">addWebpackPlugin</span>(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyWebpackPlugin</span>({
      <span class="hljs-attr">patterns</span>: [
        
        { <span class="hljs-attr">from</span>: path.<span class="hljs-title function_">join</span>(cesiumSource, cesiumWorkers), <span class="hljs-attr">to</span>: <span class="hljs-string">'cesium/Workers'</span> },
        { <span class="hljs-attr">from</span>: path.<span class="hljs-title function_">join</span>(cesiumSource, <span class="hljs-string">'Assets'</span>), <span class="hljs-attr">to</span>: <span class="hljs-string">'cesium/Assets'</span> },
        { <span class="hljs-attr">from</span>: path.<span class="hljs-title function_">join</span>(cesiumSource, <span class="hljs-string">'Widgets'</span>), <span class="hljs-attr">to</span>: <span class="hljs-string">'cesium/Widgets'</span> }
      ],
    })
  ),
  <span class="hljs-title function_">addWebpackPlugin</span>(
    <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DefinePlugin</span>({
      <span class="hljs-comment">// Define relative base path in cesium for loading assets</span>
      <span class="hljs-attr">CESIUM_BASE_URL</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-string">"/cesium"</span>),
    })
  )
  <span class="hljs-comment">// addWebpackPlugin(new BundleAnalyzerPlugin())</span>
);


</code></pre>
<p>package.json里的打包脚本变成</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"react-app-rewired start"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"react-app-rewired build"</span>,
    
  },
</code></pre>
<p>这样就会走我们新设定的webpack，将将node_modules/cesium/Source/Assets, node_modules/cesium/Source/Widgets, node_modules/cesium/Build/Cesium/Workers自动文件打包到build文件里，如图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6bc758eb20240eb81ece4677f2bd6cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2NvcnBpb29w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969423&amp;x-signature=4ihE51DCKx%2BnZpHT8Efe4jvzVlo%3D" alt="image.png" loading="lazy"/>
这样yarn start 或者yarn build就可以正常使用cesium了</p>
<p>下面这篇我直接按<strong>可发布到掘金的技术文章结构</strong>帮你整理好了：有背景、有思路、有代码拆解、有优化建议，基本不需要再大改就能发 👍</p>
<h2 data-id="heading-1">二、创建 Viewer 且必须只创建一次！</h2>
<p>否则：</p>
<ul>
<li>内存暴涨</li>
<li>WebGL context 丢失</li>
<li>页面卡死</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!containerRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">if</span> (viewerRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> viewer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Viewer</span>(containerRef.<span class="hljs-property">current</span>, {
    <span class="hljs-attr">timeline</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">animation</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">infoBox</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">fullscreenButton</span>: <span class="hljs-literal">false</span>,
  });

  viewerRef.<span class="hljs-property">current</span> = viewer;

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    viewerRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">destroy</span>();
    viewerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
  };
}, []);
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{containerRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"cesium-container"</span> /&gt;</span></span>
</code></pre>
<p>这是 <strong>Cesium + React 的标准写法</strong>。</p>
<hr/>
<h2 data-id="heading-2">三、加载倾斜摄影模型（3DTiles）</h2>
<pre><code class="hljs language-scss" lang="scss">Cesium<span class="hljs-selector-class">.Cesium3DTileset</span><span class="hljs-selector-class">.fromUrl</span>("tileset.json")
  <span class="hljs-selector-class">.then</span>((tileset) =&gt; {
    viewer<span class="hljs-selector-class">.scene</span><span class="hljs-selector-class">.primitives</span><span class="hljs-selector-class">.add</span>(tileset);
    viewer<span class="hljs-selector-class">.zoomTo</span>(tileset);
  });
</code></pre>
<h4 data-id="heading-3">一个强烈建议 ⭐⭐⭐⭐⭐</h4>
<p>建议监听瓦片失败：</p>
<pre><code class="hljs language-go" lang="go">tileset.tileFailed.addEventListener((<span class="hljs-type">error</span>) =&gt; {
  console.<span class="hljs-type">error</span>(<span class="hljs-string">"瓦片加载失败:"</span>, <span class="hljs-type">error</span>);
});
</code></pre>
<p>否则生产环境排查问题会非常痛苦。</p>
<hr/>
<h2 data-id="heading-4">四、动态绘制监测点（核心）</h2>
<p>很多人喜欢用：</p>
<p>👉 Primitive<br/>
👉 PointPrimitive</p>
<p>但在业务系统中，我更推荐：</p>
<h2 data-id="heading-5">⭐ Entity</h2>
<p>因为：</p>
<ul>
<li>开发简单</li>
<li>支持属性绑定</li>
<li>支持 pick</li>
<li>易维护</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createColorIcon</span>(<span class="hljs-params">color: string</span>) {
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"canvas"</span>);
    <span class="hljs-keyword">const</span> size = <span class="hljs-number">48</span>;
    canvas.<span class="hljs-property">width</span> = size;
    canvas.<span class="hljs-property">height</span> = size;
    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);
    <span class="hljs-keyword">if</span> (ctx) {
      <span class="hljs-keyword">const</span> cx = size / <span class="hljs-number">2</span>;
      <span class="hljs-keyword">const</span> r = <span class="hljs-number">12</span>;
      <span class="hljs-keyword">const</span> tipY = size - <span class="hljs-number">6</span>;



      <span class="hljs-comment">// 图钉形状（圆 + 尖）</span>
      ctx.<span class="hljs-title function_">beginPath</span>();
      ctx.<span class="hljs-title function_">moveTo</span>(cx, tipY);
      ctx.<span class="hljs-title function_">quadraticCurveTo</span>(cx + r, r + <span class="hljs-number">12</span>, cx + r, r + <span class="hljs-number">4</span>);
      ctx.<span class="hljs-title function_">arc</span>(cx, r + <span class="hljs-number">4</span>, r, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-literal">true</span>);
      ctx.<span class="hljs-title function_">quadraticCurveTo</span>(cx - r, r + <span class="hljs-number">12</span>, cx, tipY);
      ctx.<span class="hljs-title function_">closePath</span>();
      ctx.<span class="hljs-property">fillStyle</span> = color;
      ctx.<span class="hljs-title function_">fill</span>();



      ctx.<span class="hljs-title function_">fill</span>();
    }

    <span class="hljs-keyword">return</span> canvas;
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getWarningColor</span> = (<span class="hljs-params">p: any</span>) =&gt; {
    <span class="hljs-keyword">const</span> level =
      p?.<span class="hljs-property">alarmLevel</span> ?? <span class="hljs-number">0</span>;
    <span class="hljs-keyword">switch</span> (<span class="hljs-title class_">Number</span>(level)) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#D7263D99"</span>; <span class="hljs-comment">// 红色预警（约 60% 不透明）</span>
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#FF6B0099"</span>; <span class="hljs-comment">// 橙色预警</span>
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#C7A20099"</span>; <span class="hljs-comment">// 黄色预警</span>
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#00BEFF99"</span>; <span class="hljs-comment">// 蓝色预警</span>
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"#d3f26199"</span>; <span class="hljs-comment">// 约 60% 不透明</span>
    }
  };
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> viewer = viewerRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (!viewer) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (dataSource &amp;&amp; dataSource?.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      pointEntityIdsRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          viewer.<span class="hljs-property">entities</span>.<span class="hljs-title function_">removeById</span>(id);
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-comment">// ignore</span>
        }
      });
      pointEntityIdsRef.<span class="hljs-property">current</span> = [];
     
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'dataSource'</span>, dataSource);
     

      (dataSource || []).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">p: any</span>) =&gt;</span> {


        <span class="hljs-keyword">const</span> lng = <span class="hljs-title class_">Number</span>(p.<span class="hljs-property">longitude</span>);
        <span class="hljs-keyword">const</span> lat = <span class="hljs-title class_">Number</span>(p.<span class="hljs-property">latitude</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(lng) || <span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(lat)) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">const</span> id = <span class="hljs-string">`point-<span class="hljs-subst">${p.id}</span>`</span>;
        viewer.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>({
          id,
          <span class="hljs-attr">position</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromDegrees</span>(lng, lat, <span class="hljs-title class_">Number</span>(p.<span class="hljs-property">height</span>) || <span class="hljs-number">0</span>),
          <span class="hljs-attr">billboard</span>: {
            <span class="hljs-attr">image</span>: <span class="hljs-title function_">createColorIcon</span>(<span class="hljs-title function_">getWarningColor</span>(p)),
            <span class="hljs-attr">verticalOrigin</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">VerticalOrigin</span>.<span class="hljs-property">BOTTOM</span>,
            <span class="hljs-comment">// 防止被倾斜摄影挡住</span>
            <span class="hljs-attr">disableDepthTestDistance</span>: <span class="hljs-title class_">Number</span>.<span class="hljs-property">POSITIVE_INFINITY</span>
          },
          <span class="hljs-attr">label</span>: {
            <span class="hljs-attr">text</span>: p.<span class="hljs-property">pointName</span> || <span class="hljs-string">""</span>,
            <span class="hljs-attr">font</span>: <span class="hljs-string">"bold 15px sans-serif"</span>,
            <span class="hljs-attr">fillColor</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-title function_">fromCssColorString</span>(<span class="hljs-string">"rgba(68, 229, 255, 0.92)"</span>),
            <span class="hljs-attr">outlineColor</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Color</span>.<span class="hljs-title function_">fromCssColorString</span>(<span class="hljs-string">"rgba(124, 121, 121, 0.9)"</span>).<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">0.85</span>),
            <span class="hljs-attr">outlineWidth</span>: <span class="hljs-number">2</span>,
            <span class="hljs-attr">style</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">LabelStyle</span>.<span class="hljs-property">FILL_AND_OUTLINE</span>,
            <span class="hljs-attr">verticalOrigin</span>: <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">VerticalOrigin</span>.<span class="hljs-property">BOTTOM</span>,
            <span class="hljs-attr">pixelOffset</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian2</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">50</span>),
            <span class="hljs-attr">disableDepthTestDistance</span>: <span class="hljs-title class_">Number</span>.<span class="hljs-property">POSITIVE_INFINITY</span>,
            <span class="hljs-attr">distanceDisplayCondition</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">DistanceDisplayCondition</span>(
              <span class="hljs-number">0</span>,
              <span class="hljs-number">5000</span>
            ),
          },
          <span class="hljs-attr">properties</span>: {
            <span class="hljs-attr">pickable</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">pointId</span>: p.<span class="hljs-property">id</span>,
            <span class="hljs-attr">pointType</span>: p?.<span class="hljs-property">pointType</span>,
            <span class="hljs-attr">pointName</span>: p?.<span class="hljs-property">pointName</span>,
          }
        });

        pointEntityIdsRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">push</span>(id);
      });
      <span class="hljs-keyword">const</span> handler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">ScreenSpaceEventHandler</span>(viewer.<span class="hljs-property">scene</span>.<span class="hljs-property">canvas</span>);

      handler.<span class="hljs-title function_">setInputAction</span>(<span class="hljs-function">(<span class="hljs-params">movement: any</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> picked = viewer.<span class="hljs-property">scene</span>.<span class="hljs-title function_">pick</span>(movement.<span class="hljs-property">endPosition</span>);


        <span class="hljs-keyword">if</span> (
          <span class="hljs-title class_">Cesium</span>.<span class="hljs-title function_">defined</span>(picked) &amp;&amp;
          picked.<span class="hljs-property">id</span> &amp;&amp;                     <span class="hljs-comment">// Entity</span>
          picked?.<span class="hljs-property">id</span>?.<span class="hljs-property">properties</span>?.<span class="hljs-property">pickable</span>?.<span class="hljs-title function_">getValue</span>()
        ) {

          viewer.<span class="hljs-property">canvas</span>.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">'pointer'</span>;


        } <span class="hljs-keyword">else</span> {
          viewer.<span class="hljs-property">canvas</span>.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">'default'</span>;


        }
      }, <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">ScreenSpaceEventType</span>.<span class="hljs-property">MOUSE_MOVE</span>);
      <span class="hljs-comment">// 点击测点</span>
      handler.<span class="hljs-title function_">setInputAction</span>(<span class="hljs-function">(<span class="hljs-params">click: any</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> picked = viewer.<span class="hljs-property">scene</span>.<span class="hljs-title function_">pick</span>(click.<span class="hljs-property">position</span>);

        <span class="hljs-keyword">if</span> (
          <span class="hljs-title class_">Cesium</span>.<span class="hljs-title function_">defined</span>(picked) &amp;&amp;
          picked.<span class="hljs-property">id</span> &amp;&amp;
          picked.<span class="hljs-property">id</span>.<span class="hljs-property">billboard</span>
        ) {
          <span class="hljs-keyword">const</span> entity = picked.<span class="hljs-property">id</span>;

          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'点到了:'</span>, entity.<span class="hljs-property">id</span>, picked?.<span class="hljs-property">id</span>?.<span class="hljs-property">properties</span>?.<span class="hljs-property">pointId</span>?.<span class="hljs-title function_">getValue</span>());

         

          <span class="hljs-comment">// 示例：相机飞过去</span>
          viewer.<span class="hljs-title function_">flyTo</span>(entity);
          
        }
      }, <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">ScreenSpaceEventType</span>.<span class="hljs-property">LEFT_CLICK</span>);


    }


  }, [dataSource]);
</code></pre>
<hr/>
<h2 data-id="heading-6">五、点击测点飞行定位</h2>
<h3 data-id="heading-7">pick 实体</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> picked = viewer.scene.<span class="hljs-built_in">pick</span>(click.position);
</code></pre>
<p>判断：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">if</span> (Cesium.<span class="hljs-built_in">defined</span>(picked) &amp;&amp; picked.id?.billboard) {
</code></pre>
<p>然后：</p>
<pre><code class="hljs language-ini" lang="ini">viewer.flyTo(entity)<span class="hljs-comment">;</span>
</code></pre>
<p>体验直接拉满。</p>
<hr/>
<h3 data-id="heading-8">鼠标 Hover 手型</h3>
<p>细节决定高级感：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">viewer.canvas.style.cursor</span> = <span class="hljs-string">'pointer'</span><span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">六、相机环绕动画</h2>
<p>核心思路：</p>
<h4 data-id="heading-10">👉 clock.onTick</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> remove = viewer.<span class="hljs-property">clock</span>.<span class="hljs-property">onTick</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-function">() =&gt;</span> {
  heading += <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">toRadians</span>(<span class="hljs-number">0.2</span>);

  viewer.<span class="hljs-property">camera</span>.<span class="hljs-title function_">lookAt</span>(
    center,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">HeadingPitchRange</span>(
      heading,
      <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">toRadians</span>(-<span class="hljs-number">30</span>),
      range
    )
  );
<span class="hljs-comment">// 转满一圈停止</span>
  <span class="hljs-keyword">if</span> (heading &gt;= <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-property">TWO_PI</span>) {
    <span class="hljs-title function_">remove</span>();
    viewer.<span class="hljs-property">camera</span>.<span class="hljs-title function_">lookAtTransform</span>(<span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-property">IDENTITY</span>);
  }
});
</code></pre>
<p>本质：</p>
<p>👉 每帧改变 heading。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详解 IEEE 754 标准定义的 JavaScript 64 位浮点数]]></title>    <link>https://juejin.cn/post/7603309951227232306</link>    <guid>https://juejin.cn/post/7603309951227232306</guid>    <pubDate>2026-02-06T08:20:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227232306" data-draft-id="7603352117639036937" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详解 IEEE 754 标准定义的 JavaScript 64 位浮点数"/> <meta itemprop="keywords" content="前端,JavaScript,数学"/> <meta itemprop="datePublished" content="2026-02-06T08:20:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="斟茶递水黄师傅"/> <meta itemprop="url" content="https://juejin.cn/user/3720403078610952"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详解 IEEE 754 标准定义的 JavaScript 64 位浮点数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3720403078610952/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    斟茶递水黄师傅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:20:46.000Z" title="Fri Feb 06 2026 08:20:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>JavaScript 使用 IEEE 754 标准定义的 64 位浮点格式表示数值。</p>
<p><strong>64位 = 1位符号位(S) + 11位指数位(E) + 52位尾数位(M)</strong></p>
<ul>
<li>符号位（S）：0表示正数，1表示负数，决定数值的正负；</li>
<li>指数位（E）：存储指数的偏移值（偏移量1023），决定数值的数量级；</li>
<li>尾数位（M）：存储数值的有效数字（二进制），且有一个隐含的1位（规格化数，也叫归一化数，normalized number），所以实际有效位数是 52 + 1 = 53位。</li>
</ul>
<p>指数位（E）的偏移量 1023 是标准人为规定的，为的是让原本的 11 位无符号位的二进制指数位能表示正负指数，并且正负指数尽可能对称（-1022 ~ 1023）。</p>
<p>尾数位（M）的隐藏位 1 也是标准人为规定的，利用了非零二进制数归一化后整数位必为 1 的特性。</p>
<p>任何一个非零的二进制数，都能唯一表示为 <code>1.xx × 2^e</code> 的形式。</p>
<ul>
<li>e 是二进制的指数（整数，可正可负）；</li>
<li>归一化后整数位必然是固定不变的 1，这是二进制的特性。</li>
</ul>
<p>IEEE 754 标准正是利用了「归一化后整数位必为 1」的特性，做了一个巧妙设计：</p>
<p>既然这个 1 是所有非零浮点数的固定前缀，那就不用在 64 位中实际存储它，而是「默认存在这个 1」，仅将小数点后的 xx 有效数字部分存入 52 位的尾数位（M）中。</p>
<p>原本尾数位只有 52 位，加上这 1 位隐藏的固定不变的 1 后，实际可用的有效数字位就变成了 53 位（1 + 52），直接提升了浮点数的精度，且没有占用额外的存储空间。</p>
<p><strong>只有非零的归一化浮点数才有隐藏位。对于接近 0 的极小值（非归一化数），IEEE 754 会放弃归一化</strong>，此时没有隐藏位，只有 52 位有效数字。</p>
<h3 data-id="heading-0">推导：53 位二进制能表示的最大整数是 2^53 - 1</h3>
<p>当 53 位二进制尾数位（M）（包含隐藏位 1），所有位都为 1 时，就是它能表示的最大数，计算如下：</p>
<pre><code class="hljs language-ini" lang="ini">111...111（53个1） = 2^52 + 2^51 + ... + 2^1 + 2^<span class="hljs-attr">0</span> = <span class="hljs-number">2</span>^<span class="hljs-number">53</span> - <span class="hljs-number">1</span>
</code></pre>
<p>这个数就是 JS 中能精确表示的最大安全整数 <code>Number.MAX_SAFE_INTEGER</code>。</p>
<p><strong>一个整数 n 被称为安全整数，当且仅当：它自身和前后相邻的两个整数（n−1、n、n+1），都能被唯一且精确地存储表示</strong>，三者的 64 位浮点数编码互不重复，且不存在截断舍入后的失真情况。</p>
<p>在 2^53 ~ 2^1023 这区间内的 2 的整数次幂能精确表示，但都是「孤立的精确数」（相邻数失真，无连续性）。</p>
<h3 data-id="heading-1">少数能<strong>精确存储</strong>的特殊十进制小数</h3>
<p>绝大多数小数的二进制，都是无限循环的小数形式，都不能精确存储，只能截断舍入近似存储。</p>
<p>如果一个十进制小数转二进制后是「有限位小数」，就能被 64 位浮点数精确存储，这类小数有明确的数学规则：</p>
<blockquote>
<p><strong>十进制小数能精确转为有限位二进制的充要条件：小数部分转化成最简分数形式后，它的分母仅包含质因子 2（即分母是 2 的正整数次幂：2¹、2²、2³...）。</strong></p>
</blockquote>
<p>简单说：小数部分是 <code>0.5(1/2)、0.25(1/4)、0.125(1/8)、0.0625(1/16)...</code> 的组合，就能精确存储。</p>
<h3 data-id="heading-2"><strong>浮点数的「可表示值步长」随数值增大而变大</strong>（精度衰减规律）</h3>
<p>64 位浮点数的可表示值不是连续的，而是离散的、等步长的（同一量级内步长固定），且数值越大，量级越高，步长越大。这是整数和小数的精度都会随数值增大而衰减的根本原因。</p>
<p><strong>步长是（同一量级内）相邻两个可表示的浮点数之间的差值，由归一化后的指数 e 决定</strong>：</p>
<p><strong>步长 = 2^(e-52)</strong> （52 是尾数位 M 的位数）。</p>
<ul>
<li>步长越小，可表示值越密集，精度越高；</li>
<li>步长越大，可表示值越稀疏，精度越低。</li>
</ul>
<p>步长对整数和小数的影响：</p>
<p><strong>- 安全整数区（e≤52）：步长 = 2^(e-52) ≤1 → 整数的步长为 1，能连续精确表示；小数的步长极小，误差可忽略；</strong></p>
<ul>
<li>2⁵³~2¹⁰²³ 区：步长≥2 → 整数的步长大于 1，无法连续精确表示（相邻整数重叠）；小数的步长极大，几乎无法区分相近小数；</li>
<li>2¹⁰²³ 以上：超出指数范围，直接变成 Infinity，无法表示为常规数。</li>
</ul>
<h3 data-id="heading-3">MAX_VALUE 和 MIN_VALUE</h3>
<p>最大正值：<code>Number.MAX_VALUE = 1.7976931348623157×10³⁰⁸</code></p>
<p>指数位取归一化数的最大存储值 2046（实际指数 1023），尾数位 52 位全 1（此时浮点数取到归一化数的最大极值，再大就超出指数范围，变成<code>Infinity</code>）；</p>
<p>最小正值：<code>Number.MIN_VALUE = 5×10⁻³²⁴</code>（无限接近 0）</p>
<p>指数位取全 0（非归一化数，实际指数 -1023），尾数位仅最后 1 位为 1、其余全 0（此时浮点数取到能表示的最小非 0 正值，再小就会被舍入为 0）。</p>
<p>这是 64 位双精度浮点数基于 IEEE 754 标准的硬件存储极限，是浮点数能表示的所有数值（整数 + 小数）的整体边界，而非专门针对整数的范围。</p>
<h3 data-id="heading-4">±Infinity 和 NaN 如何表示</h3>



































<table><thead><tr><th/><th><strong>Infinity（正无穷）</strong></th><th><strong>-Infinity（负无穷）</strong></th><th><strong>NaN（非数）</strong></th></tr></thead><tbody><tr><td>1位符号位（S）</td><td>0表示正数</td><td>1表示负数</td><td>0和1都可，无意义</td></tr><tr><td>11位指数位（E）</td><td>11位全1</td><td>11位全1</td><td>11位全1</td></tr><tr><td>52位尾数位（M）</td><td>52位全0</td><td>52位全0</td><td>52位非全0（即任意1位是1即可）</td></tr><tr><td/><td><strong>S0 + E全1 + M全0</strong></td><td><strong>S1 + E全1 + M全0</strong></td><td><strong>S01 + E全1 + M非0</strong></td></tr></tbody></table>
<p><strong>E全1 表示 ±Infinity 和 NaN 的特殊值，而 E全0 表示非归一化数（接近 0 的极小值，无隐藏位）。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS自定义TabBar]]></title>    <link>https://juejin.cn/post/7603352117638922249</link>    <guid>https://juejin.cn/post/7603352117638922249</guid>    <pubDate>2026-02-06T07:46:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352117638922249" data-draft-id="7603309951226921010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS自定义TabBar"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-06T07:46:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恰少年"/> <meta itemprop="url" content="https://juejin.cn/user/1591748567509486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS自定义TabBar
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748567509486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恰少年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:46:53.000Z" title="Fri Feb 06 2026 07:46:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">DDTabBar 自定义 TabBar</h2>
<h3 data-id="heading-1">概述</h3>
<p>DDTabBar 模块底部导航栏的自定义实现，</p>
<ul>
<li>支持 <strong>普通样式</strong> 与 <strong>液态玻璃（Liquid Glass）样式</strong> 双形态切换。</li>
<li>支持暗黑模式和长辈模式</li>
<li>支持Lottie，gif，png图片资源</li>
<li>支持自定义角标，小红点</li>
<li>根据接口动态更新item数量，顺序</li>
</ul>
<hr/>
<h3 data-id="heading-2">效果</h3>
<p>液态玻璃-暗黑</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff8cf5d212c14acfaf8f20bfd750453b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968812&amp;x-signature=4sZQdJHdYjmKV66UAGqTETqJiok%3D" alt="暗黑" width="30%" loading="lazy"/>
<p>液态玻璃-白天</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/957e679003cf4fab875759695a895144~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968812&amp;x-signature=YYPkWCeAhQMazKXdVrJn3L9I%2Byg%3D" width="30%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/684ee7a68095432aa4879cc6b7db7434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968812&amp;x-signature=%2FaBRiNfkwauFsmiA1TCmsB5h8EQ%3D" width="30%" loading="lazy"/>
<p>普通模式</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b13fde133acb41e4b929d74c259d9dbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968812&amp;x-signature=AJWcmW7bLWcDmkKOcYimhbHIy4c%3D" width="30%" loading="lazy"/>
<p>长辈版</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/997cccb5b897401f866d6e3513d11cae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGw5bCR5bm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968812&amp;x-signature=r76eHLLelwWiFz63RagoH%2BZM5vU%3D" width="30%" loading="lazy"/>
<hr/>
<h3 data-id="heading-3">目录结构</h3>
<pre><code class="hljs language-bash" lang="bash">DDTabBar/
├── Manager/                    <span class="hljs-comment"># 管理与加载</span>
│   ├── DDTabBarManager.swift           <span class="hljs-comment"># TabBar 单例、数据与配置</span>
│   ├── DDTabBarItemOperationBadgeView.swift  <span class="hljs-comment"># 运营角标</span>
│   ├── TabBarCacheManager.swift        <span class="hljs-comment"># 配置缓存</span>
│   ├── TabBarResourceLoader.swift      <span class="hljs-comment"># 图标/Lottie 资源加载</span>
│   └── TabbarRNRouterInterceptor.swift <span class="hljs-comment"># RN 路由拦截</span>
├── Model/
│   ├── DDTabBarItem.swift              <span class="hljs-comment"># (预留) Item 定义</span>
│   └── TabBarModel.swift               <span class="hljs-comment"># TabBar 与 Item 数据模型</span>
├── Util/
│   ├── DDTaBarEnum.h                   <span class="hljs-comment"># 枚举：场景、Item 类型、图片类型</span>
│   └── DDTabBarUtil.swift              <span class="hljs-comment"># 工具：曝光埋点、数据比较等</span>
└── View/
    ├── DDTabBar.swift                  <span class="hljs-comment"># 主入口：双样式容器与切换逻辑</span>
    ├── DDTabBarItemBadgeView.swift     <span class="hljs-comment"># 角标视图</span>
    ├── DDTabBarItemContainer.swift     <span class="hljs-comment"># 单个 Tab 容器（可点击）</span>
    ├── DDTabBarItemContentView.swift   <span class="hljs-comment"># Tab 内容（图标+文案+角标）</span>
    ├── TabbarWebViewController.swift   <span class="hljs-comment"># Web Tab 落地页</span>
    └── README.md                       <span class="hljs-comment"># 本文档</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">双样式架构</h3>
<h4 data-id="heading-5">1. 样式类型</h4>




















<table><thead><tr><th>样式</th><th>类名</th><th>说明</th></tr></thead><tbody><tr><td><strong>普通样式</strong></td><td><code>DDTabBarNormalView</code></td><td>全宽 TabBar，毛玻璃 + 背景图/背景色，常规布局</td></tr><tr><td><strong>液态玻璃</strong></td><td><code>DDTabBarLiquidGlassView</code></td><td>圆角胶囊容器，iOS 26 下使用 <code>UIGlassEffect</code>，支持暗黑适配</td></tr></tbody></table>
<h4 data-id="heading-6">2. 切换条件</h4>
<p>液态玻璃是否展示由 <code>DDTabBar.isLiquidGlassActive()</code> 决定：</p>
<ul>
<li><code>DDLiquidGlassManager.shared.isLiquidGlassActive == true</code></li>
<li><strong>且</strong> 非长辈版：<code>!DDBasicInfoManager.shared.isAPVersion</code></li>
</ul>
<p>满足时显示 <code>DDTabBarLiquidGlassView</code>，否则显示 <code>DDTabBarNormalView</code>。</p>
<h4 data-id="heading-7">3. 状态同步</h4>
<ul>
<li>通过通知监听并刷新当前展示的样式：
<ul>
<li><code>DDLiquidGlassManager.StateDidChangedNotification</code>：液态玻璃开关变化</li>
<li><code>.DDDarkModeShowDarkChanged</code>：暗黑模式变化</li>
<li><code>kChangeToAPVersionNotification</code>：长辈版切换</li>
</ul>
</li>
<li>两种视图的数据与选中索引会同时更新，保证切换样式时状态一致。</li>
</ul>
<hr/>
<h3 data-id="heading-8">主入口实现细节（DDTabBar）</h3>
<ul>
<li>** 默认数据，缓存数据，接口数据 调用update时更新DDTabBarLiquidGlassView 和DDTabBarNormalView，更新时先判断内存中是否有该tab，只更新tab数据不影响飘红角标，没有则创建tab的view；</li>
<li>**更新前为每个 Item 设置暗黑图（<code>checkDataDark</code> / <code>uncheckDataDark</code> 按 itemType 取本地图名）。</li>
<li><strong>布局</strong>：<code>layoutSubviews</code> 中 <code>normalView.frame = bounds</code>、<code>liquidGlassView.frame = bounds</code>，两套视图始终叠在同一区域，通过 <code>isHidden</code> 切换显示。</li>
<li><strong>长辈版高度</strong>：<code>sizeThatFits</code> 在 <code>DDBasicInfoManager.shared.isAPVersion</code> 时高度 +17pt。</li>
</ul>
<hr/>
<h3 data-id="heading-9">普通样式（DDTabBarNormalView）</h3>
<h4 data-id="heading-10">视图层级与布局</h4>
<ul>
<li>
<p><strong>子视图顺序</strong>（自底向上）：<code>visualEffectView</code>（全 bounds）→ <code>backgroundImageView</code>（全 bounds）→ <code>contentView</code>（全 bounds）。</p>
</li>
<li>
<p><strong>Item 布局</strong>：全宽均分布局，<code>itemHeight</code> 默认 48。</p>
</li>
<li>
<p><strong>首页小火箭</strong>：对第一个 item 容器附加首页“小火箭”视图（<code>HomeTabBarItem</code>），用于首页特殊动效/回到顶部能力的承载。</p>
</li>
<li>
<p><strong>暗黑</strong>：不支持暗黑</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-11">液态玻璃样式（DDTabBarLiquidGlassView）</h3>
<h4 data-id="heading-12">1. 视觉与层级</h4>
<ul>
<li><strong>容器</strong>：圆角胶囊，宽度 <code>kScreenWidth - 30</code>，水平居中，高度 62pt（<code>containerH</code>）</li>
<li><strong>层级</strong>（自底向上）：
<ul>
<li><code>shadowView</code>：暗色模糊视图，用于阴影/暗黑增强</li>
<li><code>effectView</code>：使用系统新增的玻璃效果（<code>UIGlassEffect</code>），并开启交互能力（interactive）以获得更自然的玻璃触感与动态反馈）</li>
<li><code>contentView</code>：放置各个tabItem</li>
<li><code>segmentControl</code>：iOS 26<code>UISegmentedControl</code>具有点击拖动有放大镜效果，用于事件响应，UISegmentedControl有valueChanged，但我们还要求再次点击同一个item业务，切换到目标item时，若是拦截的需要把selectedSegmentIndex设置为上一个lastSelectedIndex</li>
</ul>
</li>
</ul>
<p>虽然给
<code>segmentControl.insertSegment(withTitle: "", at: idx, animated: false)</code></p>
<p>但仍需要设置，不然会有灰色的背景</p>
<pre><code class="hljs language-python" lang="python">DispatchQueue.main.<span class="hljs-keyword">async</span> {
            <span class="hljs-keyword">for</span> subview <span class="hljs-keyword">in</span> self.segmentControl.subviews {
                <span class="hljs-keyword">if</span> subview <span class="hljs-keyword">is</span> UIImageView &amp;&amp; subview != self.segmentControl.subviews.last {
                    subview.alpha = <span class="hljs-number">0</span>
                }
            }
        }
</code></pre>
<h4 data-id="heading-13">3. 暗黑与选中态</h4>
<ul>
<li><code>isCurrentShowDark</code> 控制：
<ul>
<li>选中槽背景色：暗黑时为 <code>RGBA(0x000000, 0.2)</code>，否则为 <code>gray.withAlphaComponent(0.15)</code></li>
<li>暗黑时显示 <code>shadowView</code>，非暗黑时隐藏</li>
</ul>
</li>
<li>Item 使用 <code>isSupportDark = true</code>，会使用模型中的 <code>checkDataDark</code> / <code>uncheckDataDark</code> 等暗黑资源。</li>
</ul>
<hr/>
<h3 data-id="heading-14">DDTabBarItemContentView</h3>
<h4 data-id="heading-15">ContentView（DDTabBarItemContentView）</h4>
<ul>
<li><strong>子视图</strong>：<code>iconImageView</code>（DDIconImageView，支持 Lottie/静图/Gif）、<code>titleLabel</code>、<code>businessBadgeView</code>（运营角标）、<code>badgeView</code>（数字/红点角标）。</li>
<li><strong>两种展示模式</strong>（<code>itemData.style</code>）：
<ul>
<li><strong>style 0（小图）</strong>：图片和文字的形式。</li>
<li><strong>style 1（大图）</strong>：只有一个大图；<code>titleLabel.isHidden = true</code>，<code>iconImageView.isHidden = false</code>。</li>
</ul>
</li>
<li><strong>选中/未选</strong>：根据 <code>selected</code> 与 <code>DDDarkModeManager.shared.isCurrentShowDark</code>、<code>isSupportDark</code> 选择 <code>checkResource</code>/<code>checkDataDark</code>、<code>uncheckResource</code>/<code>uncheckDataDark</code> 及对应文字颜色，调用 <code>iconImageView.setData(data:type:style)</code> 与 <code>iconImageView.play()</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-16">数据与展示</h3>
<h4 data-id="heading-17">1. 数据流概览</h4>
<ul>
<li><strong>配置来源</strong>：<code>DDTabBarManager.getTabBarConfigData(scene:parmars:aipComplet:)</code> 拉取接口，经 <code>TabBarResourceLoader</code> 下载图标/Lottie 后，由 <code>dealTabBarData</code> 更新 <code>tabBarModel</code> 并调用 <code>tabBar.update(data:items:)</code>。</li>
<li><strong>模型</strong>：
<ul>
<li><code>TabBarModel</code>：整条 Tab 配置（背景色/图、<code>bottom_list</code>、场景、来源等）</li>
<li><code>TabBarItemModel</code>：单个 Tab（类型、文案、选中/未选资源、链接、角标等）</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-18">与系统 UITabBar 的配合</h3>
<ul>
<li>
<p><code>DDTabBar</code> 作为自定义视图加在 TabBarController 的 tabBar 上，系统自带的 Tab 按钮需隐藏。代码中通过 <code>UITabBar</code> 的 extension 重写 <code>addGestureRecognizer</code>，对名为 <code>_UIContinuousSelectionGestureRecognizer</code> 的类禁用；</p>
</li>
<li>
<p>并暴露 <code>recursiveFindTabButtons(in:)</code>，递归查找 <code>_UITabBarButton</code> 与 <code>_UITabButton</code> 设为 <code>isHidden = true</code>，以及 <code>_UITabBarPlatterView</code> 隐藏，从而只展示自定义的 DDTabBar 内容。</p>
</li>
</ul>
<p>此处会对私有属性怎混淆处理</p>
<hr/>
<h3 data-id="heading-19">小结</h3>





























<table><thead><tr><th>能力</th><th>说明</th></tr></thead><tbody><tr><td>双样式</td><td>普通样式（全宽毛玻璃+背景）与液态玻璃样式（圆角胶囊 + iOS26 玻璃效果）</td></tr><tr><td>切换</td><td>由液态玻璃开关 + 是否长辈版决定，通过通知自动刷新</td></tr><tr><td>iOS 26</td><td>液态玻璃使用 <code>UIGlassEffect</code> + 染色层，暗黑下配合阴影与暗色选中槽</td></tr><tr><td>数据</td><td>接口 → TabBarModel/TabBarItemModel → 两套 View 同步更新与选中索引</td></tr><tr><td>埋点</td><td>点击/曝光均带 <code>liquidGlassState</code> 区分 liquid / other</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RadioIndication 的历史 - HIDL 时代就已存在]]></title>    <link>https://juejin.cn/post/7603444191447777314</link>    <guid>https://juejin.cn/post/7603444191447777314</guid>    <pubDate>2026-02-06T08:23:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603444191447777314" data-draft-id="7603383311530639375" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RadioIndication 的历史 - HIDL 时代就已存在"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T08:23:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RadioIndication 的历史 - HIDL 时代就已存在
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:23:21.000Z" title="Fri Feb 06 2026 08:23:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、时间线</h3>
<h4 data-id="heading-1">1. HIDL 时代（2016年起）</h4>
<p>RadioIndication 在 HIDL 时代就已存在，作为 IRadioIndication 接口的实现：</p>
<pre><code class="hljs language-1.0/IRadioIndication.hal" lang="1.0/IRadioIndication.hal">package android.hardware.radio@1.0;

interface IRadioIndication {
    oneway radioStateChanged(RadioIndicationType type, RadioState radioState);
    oneway callStateChanged(RadioIndicationType type);
    oneway networkStateChanged(RadioIndicationType type);
    // ... 更多回调方法
}
</code></pre>
<p>HIDL 版本的 RadioIndication 实现（用于测试）：</p>
<pre><code class="hljs language-412:462:hardware_interfaces/radio/1.0/vts/functional/radio_hidl_hal_utils_v1_0.h" lang="412:462:hardware_interfaces/radio/1.0/vts/functional/radio_hidl_hal_utils_v1_0.h">class RadioIndication : public IRadioIndication {
   protected:
    RadioHidlTest&amp; parent;

   public:
    RadioIndication(RadioHidlTest&amp; parent);
    virtual ~RadioIndication() = default;

    Return&lt;void&gt; radioStateChanged(RadioIndicationType type, RadioState radioState);
    Return&lt;void&gt; callStateChanged(RadioIndicationType type);
    Return&lt;void&gt; networkStateChanged(RadioIndicationType type);
    Return&lt;void&gt; newSms(RadioIndicationType type, const hidl_vec&lt;uint8_t&gt;&amp; pdu);
    // ...
}
</code></pre>
<h4 data-id="heading-2">2. HIDL 版本演进</h4>
<p>从 Android 7.0 到 12，HIDL 持续演进：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.0</span>  (<span class="hljs-number">2016</span>, Android <span class="hljs-number">7.0</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.1</span>  (<span class="hljs-number">2017</span>, Android <span class="hljs-number">8.0</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.2</span>  (<span class="hljs-number">2018</span>, Android <span class="hljs-number">9.0</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.3</span>  (<span class="hljs-number">2019</span>, Android <span class="hljs-number">10</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.4</span>  (<span class="hljs-number">2019</span>, Android <span class="hljs-number">10</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.5</span>  (<span class="hljs-number">2020</span>, Android <span class="hljs-number">11</span>)
<span class="hljs-symbol">IRadioIndication@</span><span class="hljs-number">1.6</span>  (<span class="hljs-number">2020</span>, Android <span class="hljs-number">12</span>)
</code></pre>
<h4 data-id="heading-3">3. AIDL 时代（从 Android 13 开始）</h4>
<p>Android 13 开始迁移到 AIDL，但为了兼容，系统提供了<strong>兼容层</strong>：</p>
<pre><code class="hljs language-33:243:hardware_interfaces/radio/aidl/compat/libradiocompat/include/libradiocompat/RadioIndication.h" lang="33:243:hardware_interfaces/radio/aidl/compat/libradiocompat/include/libradiocompat/RadioIndication.h">class RadioIndication : public V1_6::IRadioIndication {
    std::shared_ptr&lt;DriverContext&gt; mContext;

    // AIDL 回调接口
    GuaranteedCallback&lt;
        ::aidl::android::hardware::radio::data::IRadioDataIndication,
        ::aidl::android::hardware::radio::data::IRadioDataIndicationDefault, true&gt;
        mDataCb;
    GuaranteedCallback&lt;
        ::aidl::android::hardware::radio::messaging::IRadioMessagingIndication,
        ::aidl::android::hardware::radio::messaging::IRadioMessagingIndicationDefault, true&gt;
        mMessagingCb;
    // ... 更多 AIDL 回调接口
        
    // 继承自 HIDL V1.6 的方法实现
    Return&lt;void&gt; radioStateChanged(V1_0::RadioIndicationType type,
                                   V1_0::RadioState radioState) override;
    Return&lt;void&gt; callStateChanged(V1_0::RadioIndicationType type) override;
    // ...
}
</code></pre>
<h3 data-id="heading-4">二、HIDL vs AIDL 的核心区别</h3>



































<table><thead><tr><th>特性</th><th>HIDL</th><th>AIDL</th></tr></thead><tbody><tr><td><strong>定义语言</strong></td><td>HAL (Hardware Abstraction Language) - .hal文件</td><td>Android Interface Definition Language - .aidl文件</td></tr><tr><td><strong>版本管理</strong></td><td>内置版本控制 (@1.0, @1.1, ...)</td><td>接口版本字符串</td></tr><tr><td><strong>模块分裂</strong></td><td>单一 IRadioIndication 接口包含所有回调</td><td>拆分为多个独立接口：<br/>- IRadioDataIndication<br/>- IRadioMessagingIndication<br/>- IRadioModemIndication<br/>- IRadioNetworkIndication<br/>- IRadioSimIndication<br/>- IRadioVoiceIndication<br/>- IRadioImsIndication</td></tr><tr><td><strong>类型系统</strong></td><td>C++ 为主，类型映射复杂</td><td>Java 为主，更清晰的类型定义</td></tr><tr><td><strong>性能</strong></td><td>二进制协议</td><td>基于 Binder</td></tr></tbody></table>
<h3 data-id="heading-5">三、Java 层的 RadioIndication</h3>
<p>在 Java 层，只有 <strong>一个</strong> RadioIndication 实现（无论 HIDL 还是 AIDL）：</p>
<pre><code class="hljs language-126:148:frameworks_opt_telephony/src/java/com/android/internal/telephony/RadioIndication.java" lang="126:148:frameworks_opt_telephony/src/java/com/android/internal/telephony/RadioIndication.java">public class RadioIndication extends IRadioIndication.Stub {
    RIL mRil;

    RadioIndication(RIL ril) {
        mRil = ril;
    }

    public void radioStateChanged(int indicationType, int radioState) {
        mRil.processIndication(HAL_SERVICE_RADIO, indicationType);
        int state = RILUtils.convertHalRadioState(radioState);
        mRil.setRadioState(state, false);
    }

    public void callStateChanged(int indicationType) {
        // ...
    }
    // ... 所有其他回调方法
}
</code></pre>
<p>这个 Java RadioIndication 既兼容 HIDL 版本，也兼容 AIDL 版本。</p>
<h3 data-id="heading-6">四、AIDL 兼容层的作用</h3>
<p>在 AIDL 时代，C++ 兼容层将 HIDL 接口适配到 AIDL：</p>
<pre><code class="hljs language-59:76:hardware_interfaces/radio/aidl/compat/libradiocompat/modem/RadioIndication-modem.cpp" lang="59:76:hardware_interfaces/radio/aidl/compat/libradiocompat/modem/RadioIndication-modem.cpp">Return&lt;void&gt; RadioIndication::radioStateChanged(V1_0::RadioIndicationType t, 
                                                 V1_0::RadioState st) {
    LOG_CALL &lt;&lt; t;
    // 将 HIDL 的回调转发到 AIDL 的 mModemCb
    modemCb()-&gt;radioStateChanged(toAidl(t), aidl::RadioState(st));
    return {};
}

Return&lt;void&gt; RadioIndication::modemReset(V1_0::RadioIndicationType type, 
                                          const hidl_string&amp; reasn) {
    LOG_CALL &lt;&lt; type;
    modemCb()-&gt;modemReset(toAidl(type), reasn);
    return {};
}
</code></pre>
<h3 data-id="heading-7">五、RIL 指示的架构演变</h3>
<pre><code class="hljs language-css" lang="css">【HIDL 时代】                    【AIDL 时代】
IRadioIndication<span class="hljs-keyword">@1</span>.6      →      RadioIndication (兼容层)
├─ IRadioIndication                  ├─ IRadioDataIndication
├─ IRadioResponse                    ├─ IRadioMessagingIndication
└─ IRadio                            ├─ IRadioModemIndication
                                     ├─ IRadioNetworkIndication
                                     ├─ IRadioSimIndication
                                     ├─ IRadioVoiceIndication
                                     └─ IRadioImsIndication
</code></pre>
<h3 data-id="heading-8">总结</h3>
<ul>
<li><strong>RadioIndication 是 HIDL 时代的产物</strong>，从 Android 7.0 就开始使用</li>
<li><strong>AIDL 时代没有"新增"RadioIndication</strong>，而是通过<strong>兼容层</strong>继续使用</li>
<li><strong>AIDL 改变的是内部实现和模块分割</strong>，但对外部接口（Java RIL）的影响最小</li>
<li><strong>Java 层的 RadioIndication 保持不变</strong>，既支持 HIDL 也支持 AIDL</li>
</ul>
<p>这是 Android HAL 从 HIDL 迁移到 AIDL 的典型演变方式——通过兼容层保证向后兼容，同时新系统采用更现代的 AIDL 接口。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[移动数据始终开启功能]]></title>    <link>https://juejin.cn/post/7603376587651792946</link>    <guid>https://juejin.cn/post/7603376587651792946</guid>    <pubDate>2026-02-06T08:04:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603376587651792946" data-draft-id="7603321550246772786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="移动数据始终开启功能"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T08:04:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            移动数据始终开启功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:04:06.000Z" title="Fri Feb 06 2026 08:04:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. <strong>功能定义和原理</strong></h3>
<p>移动数据始终开启是一个系统设置，它允许移动数据连接在 WiFi 等高优先级网络活跃时<strong>继续保持连接和活跃</strong>。</p>
<pre><code class="hljs language-arduino" lang="arduino">工作模式：

关闭始终开启：
<span class="hljs-built_in">WiFi</span> 连接 → 移动数据自动断开 ✗
    
开启始终开启：
<span class="hljs-built_in">WiFi</span> 连接 + 移动数据 → 都保持连接 ✓
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>更快的网络切换（两个网络都活跃）</li>
<li>应用可以在 WiFi 和移动数据间灵活切换</li>
<li>降低网络延迟和中断</li>
</ul>
<hr/>
<h3 data-id="heading-1">2. <strong>设置存储 (ConnectivitySettingsManager)</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 常量定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MOBILE_DATA_ALWAYS_ON</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mobile_data_always_on"</span>;

<span class="hljs-comment">// 读取设置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getMobileDataAlwaysOn</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-type">boolean</span> def)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">enable</span> <span class="hljs-operator">=</span> Settings.Global.getInt(
            context.getContentResolver(), 
            MOBILE_DATA_ALWAYS_ON,      <span class="hljs-comment">// 全局设置键</span>
            (def ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>));              <span class="hljs-comment">// 默认值</span>
    <span class="hljs-keyword">return</span> (enable != <span class="hljs-number">0</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// 写入设置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMobileDataAlwaysOn</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-type">boolean</span> enable)</span> {
    Settings.Global.putInt(
            context.getContentResolver(), 
            MOBILE_DATA_ALWAYS_ON, 
            (enable ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>));           <span class="hljs-comment">// 1 = 开启，0 = 关闭</span>
}
</code></pre>
<p><strong>存储位置：</strong></p>
<ul>
<li>数据库：<code>Settings.Global</code>（系统全局设置）</li>
<li>键：<code>mobile_data_always_on</code></li>
<li>值：0 (关闭) 或 1 (开启)</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. <strong>连接服务实现 (ConnectivityService)</strong></h3>
<h4 data-id="heading-3"><strong>核心组件</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 移动数据的"始终开启"网络请求</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NetworkRequest mDefaultMobileDataRequest;

<span class="hljs-comment">// 该请求的信息</span>
<span class="hljs-comment">// 当设置为开启时，这个请求始终存在</span>
<span class="hljs-comment">// 当设置为关闭时，这个请求被撤销</span>
</code></pre>
<h4 data-id="heading-4"><strong>初始化流程</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建移动数据的始终开启请求</span>
mDefaultMobileDataRequest = createDefaultInternetRequestForTransport(
        NetworkCapabilities.TRANSPORT_CELLULAR,    <span class="hljs-comment">// 仅 4G/5G</span>
        NetworkRequest.Type.BACKGROUND_REQUEST);   <span class="hljs-comment">// 后台请求</span>

<span class="hljs-comment">// 在系统就绪时配置</span>
onSystemReady() {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// 根据设置创建网络请求</span>
    mHandler.sendMessage(mHandler.obtainMessage(EVENT_CONFIGURE_ALWAYS_ON_NETWORKS));
}
</code></pre>
<h4 data-id="heading-5"><strong>设置监听</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSettingsCallbacks</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 监听 MOBILE_DATA_ALWAYS_ON 设置变更</span>
    mSettingsObserver.observe(
            Settings.Global.getUriFor(
                ConnectivitySettingsManager.MOBILE_DATA_ALWAYS_ON),
            EVENT_CONFIGURE_ALWAYS_ON_NETWORKS);  <span class="hljs-comment">// 触发重新配置</span>
    
    <span class="hljs-comment">// 监听 WiFi 始终请求设置</span>
    mSettingsObserver.observe(
            Settings.Global.getUriFor(
                ConnectivitySettingsManager.WIFI_ALWAYS_REQUESTED),
            EVENT_CONFIGURE_ALWAYS_ON_NETWORKS);
}
</code></pre>
<hr/>
<h3 data-id="heading-6">4. <strong>动态配置机制</strong></h3>
<h4 data-id="heading-7"><strong>配置处理 (handleConfigureAlwaysOnNetworks)</strong></h4>
<pre><code class="hljs language-scss" lang="scss">Setting 改变
        ↓
EVENT_CONFIGURE_ALWAYS_ON_NETWORKS
        ↓
<span class="hljs-built_in">handleConfigureAlwaysOnNetworks</span>()
        ├─ 检查 MOBILE_DATA_ALWAYS_ON 设置值
        ├─ 检查 WIFI_ALWAYS_REQUESTED 设置值
        └─ 检查 config_vehicleInternalNetworkAlwaysRequested 配置值
</code></pre>
<p><strong>核心代码：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleConfigureAlwaysOnNetworks</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 处理移动数据始终开启</span>
    handleAlwaysOnNetworkRequest(
            mDefaultMobileDataRequest,
            ConnectivitySettingsManager.MOBILE_DATA_ALWAYS_ON, 
            <span class="hljs-literal">true</span> <span class="hljs-comment">/* defaultValue */</span>);      <span class="hljs-comment">// 默认开启</span>
    
    <span class="hljs-comment">// 处理 WiFi 始终请求</span>
    handleAlwaysOnNetworkRequest(
            mDefaultWifiRequest,
            ConnectivitySettingsManager.WIFI_ALWAYS_REQUESTED,
            <span class="hljs-literal">false</span> <span class="hljs-comment">/* defaultValue */</span>);     <span class="hljs-comment">// 默认关闭</span>
    
    <span class="hljs-comment">// 处理车辆内部网络</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">vehicleAlwaysRequested</span> <span class="hljs-operator">=</span> mResources.get().getBoolean(
            R.bool.config_vehicleInternalNetworkAlwaysRequested);
    handleAlwaysOnNetworkRequest(mDefaultVehicleRequest, vehicleAlwaysRequested);
}
</code></pre>
<hr/>
<h3 data-id="heading-8">5. <strong>网络请求管理</strong></h3>
<h4 data-id="heading-9"><strong>启用始终开启 (设置 ON)</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleAlwaysOnNetworkRequest</span><span class="hljs-params">(
        NetworkRequest networkRequest, 
        <span class="hljs-type">boolean</span> enable)</span> {
    
    <span class="hljs-comment">// 检查请求是否已存在</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isEnabled</span> <span class="hljs-operator">=</span> (mNetworkRequests.get(networkRequest) != <span class="hljs-literal">null</span>);
    
    <span class="hljs-comment">// 如果状态已匹配，无需操作</span>
    <span class="hljs-keyword">if</span> (enable == isEnabled) {
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 启用：注册网络请求</span>
    <span class="hljs-keyword">if</span> (enable) {
        handleRegisterNetworkRequest(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequestInfo</span>(
                Process.myUid(),
                networkRequest,
                <span class="hljs-literal">null</span> <span class="hljs-comment">/* messenger */</span>,
                <span class="hljs-literal">null</span> <span class="hljs-comment">/* binder */</span>,
                NetworkCallback.FLAG_INCLUDE_LOCATION_INFO,
                <span class="hljs-literal">null</span> <span class="hljs-comment">/* attributionTags */</span>));
    } 
    <span class="hljs-comment">// 禁用：释放网络请求</span>
    <span class="hljs-keyword">else</span> {
        handleReleaseNetworkRequest(
                networkRequest, 
                Process.SYSTEM_UID,
                <span class="hljs-literal">false</span> <span class="hljs-comment">/* callOnUnavailable */</span>);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-10">6. <strong>完整执行流程</strong></h3>
<pre><code class="hljs language-scss" lang="scss">用户打开设置
        ↓
更改 MOBILE_DATA_ALWAYS_ON 为 ON
        ↓
调用 ConnectivitySettingsManager<span class="hljs-selector-class">.setMobileDataAlwaysOn</span>()
        ↓
Settings<span class="hljs-selector-class">.Global</span> 数据库更新
        ↓
ContentObserver 检测到变更
        ↓
发送 EVENT_CONFIGURE_ALWAYS_ON_NETWORKS
        ↓
<span class="hljs-built_in">handleConfigureAlwaysOnNetworks</span>()
        ↓
<span class="hljs-built_in">handleAlwaysOnNetworkRequest</span>(mDefaultMobileDataRequest, true)
        ↓
<span class="hljs-built_in">handleRegisterNetworkRequest</span>()
        ↓
在网络管理中注册 "CELLULAR + INTERNET" 请求
        ↓
ConnectivityService 确保移动数据网络始终活跃
        ↓
即使 WiFi 连接，移动数据仍保持活跃 ✓
</code></pre>
<hr/>
<h3 data-id="heading-11">7. <strong>网络请求类型详解</strong></h3>
<h4 data-id="heading-12"><strong>mDefaultMobileDataRequest 的特性</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建始终开启请求</span>
<span class="hljs-keyword">private</span> NetworkRequest <span class="hljs-title function_">createDefaultInternetRequestForTransport</span><span class="hljs-params">(
        <span class="hljs-type">int</span> transportType, 
        NetworkRequest.Type type)</span> {
    
    <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">netCap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCapabilities</span>();
    netCap.clearAll();
    netCap.addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET);
    netCap.addTransportType(NetworkCapabilities.TRANSPORT_CELLULAR);  <span class="hljs-comment">// 仅移动数据</span>
    netCap.setRequestorUidAndPackageName(Process.myUid(), mContext.getPackageName());
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>(netCap, TYPE_NONE, nextNetworkRequestId(), type);
}

<span class="hljs-comment">// 网络请求特性：</span>
<span class="hljs-comment">// - 类型：BACKGROUND_REQUEST（后台请求）</span>
<span class="hljs-comment">// - 优先级：低（不会抢占用户请求）</span>
<span class="hljs-comment">// - 持久性：始终存在（当设置开启时）</span>
<span class="hljs-comment">// - 作用：保持移动数据网络连接</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">8. <strong>与其他功能的关系</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">移动数据始终开启
        │
        ├─ <span class="hljs-built_in">WiFi</span> 始终请求 (WIFI_ALWAYS_REQUESTED)
        │   ├─ 类似机制，用于 <span class="hljs-built_in">WiFi</span> 网络
        │   └─ 优先级：<span class="hljs-built_in">WiFi</span> &gt; 移动数据
        │
        ├─ 网络请求 (NetworkRequest)
        │   ├─ 应用可以发起自己的网络请求
        │   └─ 系统基于优先级选择最优网络
        │
        └─ 网络切换 (Network Switching)
            ├─ 两个网络都活跃时更快切换
            └─ 应用可以在 <span class="hljs-built_in">WiFi</span>/移动数据间灵活选择
</code></pre>
<hr/>
<h3 data-id="heading-14">9. <strong>实际工作流程图</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">网络状态变化时序：

事件 <span class="hljs-number">1</span>：只有移动数据连接
移动数据活跃 → 应用使用移动数据 ✓

事件 <span class="hljs-number">2</span>：<span class="hljs-built_in">WiFi</span> 连接上
│
├─ 移动数据始终开启 = OFF
│   → 移动数据断开 ✗
│   → 应用切换到 <span class="hljs-built_in">WiFi</span> ✓
│   → 网络切换延迟较大
│
└─ 移动数据始终开启 = ON
    → 移动数据保持连接 ✓
    → <span class="hljs-built_in">WiFi</span> 也连接 ✓
    → 应用可瞬间在两网间切换 ✓
    → 网络切换延迟极小

事件 <span class="hljs-number">3</span>：<span class="hljs-built_in">WiFi</span> 断开
│
├─ 移动数据始终开启 = OFF
│   → 移动数据已断开，需重新连接
│   → 恢复延迟：<span class="hljs-number">1</span><span class="hljs-number">-3</span> 秒
│
└─ 移动数据始终开启 = ON
    → 移动数据已保持连接
    → 恢复延迟：几毫秒 ✓
</code></pre>
<hr/>
<h3 data-id="heading-15">10. <strong>性能和电池影响</strong></h3>























<table><thead><tr><th>设置状态</th><th>电池消耗</th><th>网络延迟</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>关闭</strong></td><td>⬇️ 低</td><td>⬆️ 高（需重连）</td><td>省电，偶尔使用</td></tr><tr><td><strong>开启</strong></td><td>⬆️ 中等</td><td>⬇️ 低（已连接）</td><td>实时应用，视频通话</td></tr></tbody></table>
<p><strong>电池消耗主要来自：</strong></p>
<ul>
<li>保持无线电活跃</li>
<li>定期信号强度查询</li>
<li>网络数据包保活</li>
</ul>
<hr/>
<h3 data-id="heading-16">总结</h3>
<p>移动数据始终开启是一个<strong>智能网络管理</strong>功能：</p>
<ol>
<li><strong>存储层</strong>：全局设置 <code>MOBILE_DATA_ALWAYS_ON</code></li>
<li><strong>监听层</strong>：ContentObserver 监测设置变更</li>
<li><strong>请求层</strong>：通过 NetworkRequest 机制向 ConnectivityService 注册请求</li>
<li><strong>执行层</strong>：ConnectivityService 确保移动网络始终活跃</li>
<li><strong>结果</strong>：WiFi 和移动数据可同时连接，应用可无缝切换</li>
</ol>
<p>这个设计体现了 Android 系统<strong>模块化、事件驱动</strong>的架构特点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅学进程间通信4(Android Binder)]]></title>    <link>https://juejin.cn/post/7603301285475778602</link>    <guid>https://juejin.cn/post/7603301285475778602</guid>    <pubDate>2026-02-06T07:18:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603301285475778602" data-draft-id="7594682922685005833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅学进程间通信4(Android Binder)"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-06T07:18:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="煤球王子"/> <meta itemprop="url" content="https://juejin.cn/user/4088439235949739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅学进程间通信4(Android Binder)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4088439235949739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    煤球王子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:18:21.000Z" title="Fri Feb 06 2026 07:18:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Binder 的基本原理</h2>
<p>网上有很多介绍Binder的文章，这里不过多介绍，
首先要明确一点 <code>Binder 是一个 RPC（Remote Procedure Call） 框架</code>，也就是说借助于 Binder，我们可以在 A 进程中访问 B 进程中的函数</p>
<blockquote>
<p>RPC 一般基于 IPC（Inter-Process Communication） 来实现的，IPC 就是跨进程数据传输(通信)</p>
</blockquote>
<p>Binder 的 RPC 是如何实现的：</p>
<p>一般来说，A 进程访问 B 进程函数，我们需要：</p>
<ul>
<li>
<p>在 A 进程中按照固定的规则打包数据，这些数据包含了：</p>
<ul>
<li>数据发给那个进程，Binder 中是一个整型变量 Handle</li>
<li>要调用目标进程中的那个函数，Binder 中用一个整型变量 Code 表示</li>
<li>目标函数的参数</li>
<li>要执行具体什么操作，也就是 Binder 协议</li>
</ul>
</li>
<li>
<p>进程 B 收到数据，按照固定的格式解析出数据，调用函数，并使用相同的格式将函数的返回值传递给进程 A。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17f684abd3e44907bad7316e8bde9f5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770967184&amp;x-signature=YCGXQwm3Q0bwTctYdZ9grZ2ORQk%3D" alt="binder_rpc.png" loading="lazy"/></p>
<h2 data-id="heading-1">Binder 应用层工作流程</h2>
<p>Binder 是一个 <strong>RPC</strong>（Remote Procedure Call） 框架，翻译成中文就是<strong>远程过程调用</strong>。也就是说通过 Binder：</p>
<ul>
<li>可以在 A 进程中访问 B 进程中定义的函数</li>
<li>进程 B 中的这些等待着被远程调用的函数的集合，我们称其为 Binder 服务（Binder Service）</li>
<li>进程 A 称之为 <strong><code>Binder 客户端（Binder Client）</code></strong> ，进程 B 称之为 <strong><code>Binder 服务端（Binder Server）</code></strong></li>
<li>通常，系统中的服务很多，我们需要一个管家来管理它们，<strong><code>服务管家（ServiceManager）</code></strong>  是 Android 系统启动时，启动的一个用于管理 <strong>Binder 服务（Binder Service）</strong>  的进程。通常，<strong>服务（Service）</strong>  需要事先注册到<strong>服务管家（ServiceManager）</strong> ，其他进程向<strong>服务管家（ServiceManager）</strong>  查询服务后才能使用服务。</li>
<li>Binder 的 RPC 能力通过 **<code>Binder 驱动</code>**实现</li>
</ul>
<p>通常一个完整的 Binder 程序涉及 4 个流程：</p>
<ol>
<li>在 Binder Server 端定义好服务</li>
<li>然后向 ServiceManager 注册服务</li>
<li>在 Binder Client 中向 ServiceManager 获取到服务</li>
<li>发起远程调用，调用 Binder Server 中定义好的服务</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/630bdb0c07ba4eeaaefa95872029f67e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770967184&amp;x-signature=vhbxb60eJG6SAgRoEXWIUBv2ZG8%3D" alt="binder概图.png" loading="lazy"/></p>
<p>学习与参考: <a href="https://link.juejin.cn?target=http%3A%2F%2Fahaoframework.tech%2Fpages%2F062131%2F%23_1-2-rpc-%25E5%258E%259F%25E7%2590%2586" target="_blank" title="http://ahaoframework.tech/pages/062131/#_1-2-rpc-%E5%8E%9F%E7%90%86" ref="nofollow noopener noreferrer">002.Binder 基本原理 | Ahao's Technical Blog</a></p>
<h2 data-id="heading-2">AIDL（Android Interface Definition Language）</h2>
<p><code>AIDL</code>(安卓接口定义语言) 是 Android 中最常用的跨进程通信机制，主要用于应用层进程间的通信。</p>
<p><strong>主要特点</strong></p>
<ul>
<li><strong>应用层IPC</strong>：主要用于应用之间的通信</li>
<li><strong>基于Binder</strong>：底层使用 Binder 机制</li>
<li><strong>支持复杂数据类型</strong>：基本类型、String、List、Map、Parcelable 对象等</li>
<li><strong>同步/异步调用</strong>：默认同步，可通过 oneway 实现异步</li>
</ul>
<p>Android的AIDL（Android接口定义语言）是一套完整的跨进程通信API体系。它不仅支持基础数据类型和接口回调，还提供了同步/异步调用、权限控制、服务管理等一系列核心功能。</p>
<h2 data-id="heading-3"><strong>核心API与关键概念</strong></h2>
<p>下表为你梳理了AIDL的核心功能模块：</p>



















































































































<table><thead><tr><th align="left">模块</th><th align="left">主要API/概念</th><th align="left">说明与用途</th></tr></thead><tbody><tr><td align="left"><strong>1. 接口定义</strong></td><td align="left"><strong>AIDL文件</strong> (<code>.aidl</code>)</td><td align="left">使用AIDL语法声明跨进程的接口契约。</td></tr><tr><td align="left"><strong>2. 核心通信对象</strong></td><td align="left"><strong><code>IBinder</code></strong></td><td align="left">所有IPC通信的底层句柄。<code>Service.onBind</code>返回它。</td></tr><tr><td align="left"/><td align="left"><strong><code>IInterface</code></strong></td><td align="left">所有AIDL接口的根基，定义了与<code>IBinder</code>交互的能力。</td></tr><tr><td align="left"/><td align="left"><strong><code>Binder</code> 类</strong></td><td align="left">服务端的基类，实现了<code>IBinder</code>，用于处理远程调用。</td></tr><tr><td align="left"/><td align="left"><strong><code>Stub</code> 类</strong> (抽象类)</td><td align="left">由AIDL编译器生成的服务器存根，继承自<code>Binder</code>并实现主接口。</td></tr><tr><td align="left"/><td align="left"><strong><code>Proxy</code> 类</strong> (内部类)</td><td align="left">由AIDL编译器生成的客户端代理，封装了跨进程调用序列化逻辑。</td></tr><tr><td align="left"><strong>3. 类型系统</strong></td><td align="left"><strong>基本类型</strong></td><td align="left"><code>int</code>, <code>long</code>, <code>char</code>, <code>boolean</code>, <code>double</code>, <code>byte</code>, <code>float</code>。</td></tr><tr><td align="left"/><td align="left"><strong><code>String</code></strong></td><td align="left">字符串，支持UTF-8编码。</td></tr><tr><td align="left"/><td align="left"><strong><code>CharSequence</code></strong></td><td align="left">可直接传递<code>SpannableString</code>等。</td></tr><tr><td align="left"/><td align="left"><strong><code>Parcelable</code></strong></td><td align="left">通过实现该接口，自定义可序列化的复杂对象。</td></tr><tr><td align="left"/><td align="left"><strong><code>List</code> / <code>Map</code></strong></td><td align="left">集合类型，其元素必须为AIDL支持的类型。</td></tr><tr><td align="left"/><td align="left"><strong>定向Tag</strong></td><td align="left"><code>in</code>(输入), <code>out</code>(输出), <code>inout</code>(双向)，修饰非基本类型参数。</td></tr><tr><td align="left"><strong>4. 接口回调</strong></td><td align="left"><strong><code>RemoteCallbackList</code></strong></td><td align="left">用于在服务端安全地管理并回调多个客户端监听器。</td></tr><tr><td align="left"><strong>5. 调用模式</strong></td><td align="left"><strong>同步调用</strong></td><td align="left">默认模式，客户端线程会阻塞直至服务端返回。</td></tr><tr><td align="left"/><td align="left"><strong>异步调用</strong></td><td align="left">使用<code>oneway</code>关键字修饰接口方法，调用不阻塞。</td></tr><tr><td align="left"><strong>6. 异常处理</strong></td><td align="left"><strong><code>RemoteException</code></strong></td><td align="left">所有跨进程调用都可能抛出的根异常，如进程死亡、通信失败等。</td></tr><tr><td align="left"/><td align="left"><strong><code>SecurityException</code></strong></td><td align="left">绑定服务或调用时，权限校验失败会抛出。</td></tr><tr><td align="left"><strong>7. 服务绑定</strong></td><td align="left"><strong><code>Service</code></strong></td><td align="left">承载AIDL接口的服务组件。</td></tr><tr><td align="left"/><td align="left"><strong><code>ServiceConnection</code></strong></td><td align="left">客户端用于监听与服务的连接状态。</td></tr><tr><td align="left"/><td align="left"><strong><code>bindService()</code> / <code>unbindService()</code></strong></td><td align="left">绑定与解绑服务的方法。</td></tr><tr><td align="left"/><td align="left"><strong><code>Context.BIND_AUTO_CREATE</code></strong></td><td align="left">绑定标志，服务不存在时自动创建。</td></tr></tbody></table>
<h3 data-id="heading-4">💻 <strong>深度解析与最佳实践</strong></h3>
<h4 data-id="heading-5"><strong>1. 通信核心：Binder、Stub与Proxy</strong></h4>
<p>这是AIDL工作的基石。服务端实现 <code>Stub</code>，客户端通过 <code>Proxy</code> 调用，两者通过Binder驱动进行数据交换。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 服务端实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IMyService.<span class="hljs-type">Stub</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IMyService</span>.Stub() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> <span class="hljs-keyword">throws</span> RemoteException {
            <span class="hljs-keyword">return</span> a + b;
        }
    };
    
  <span class="hljs-meta">@Override</span> 
  <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> { 
      <span class="hljs-keyword">return</span> binder; 
  }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 客户端调用</span>
<span class="hljs-type">ServiceConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConnection</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName name, IBinder service)</span> {
        <span class="hljs-comment">// 关键：将IBinder转换为接口代理对象</span>
        <span class="hljs-type">IMyService</span> <span class="hljs-variable">myService</span> <span class="hljs-operator">=</span> IMyService.Stub.asInterface(service);
        myService.calculate(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);
    }
};
</code></pre>
<h4 data-id="heading-6">2. 高级数据类型与方向Tag</h4>
<p><strong>Parcelable</strong> 是实现复杂数据传输的关键。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 定义 Parcelable 数据类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Parcelable</span> {
    <span class="hljs-keyword">public</span> String name;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> id;
    <span class="hljs-comment">// ... 必须实现 writeToParcel, describeContents, CREATOR</span>
}

<span class="hljs-comment">// 2. 为 Parcelable 创建对应的 .aidl 文件 (User.aidl)</span>
<span class="hljs-comment">// parcelable User;</span>

<span class="hljs-comment">// 3. 在接口AIDL中引用</span>
<span class="hljs-comment">// import com.example.User; // 显式导入</span>
<span class="hljs-comment">// void updateUser(in User user);</span>
</code></pre>
<p><strong>方向Tag (<code>in</code>, <code>out</code>, <code>inout</code>)</strong> 直接影响性能和逻辑：</p>
<ul>
<li><code>in</code>：数据从客户端流向服务端，服务端修改不会影响客户端对象。</li>
<li><code>out</code>：对象从服务端“返回”给客户端。客户端传入的对象字段不会被发送，但服务端可以创建或修改对象并传回。</li>
<li><code>inout</code>：双向传输，开销最大，应谨慎使用。
方向修饰符（仅对 “非基本类型 &amp; 非 String/CharSequence” 参数生效）</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">printUser</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> User u</span>)</span>; <span class="hljs-comment">// 客户端把 User 序列化传过来  </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">fillUser</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> User u</span>)</span>; <span class="hljs-comment">// 服务端 new 一个 User 写回去  </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateUser</span>(<span class="hljs-params">inout User u</span>)</span>; <span class="hljs-comment">// 两端都可改</span>
</code></pre>
<h4 data-id="heading-7">3. 管理接口回调：RemoteCallbackList</h4>
<p>在服务端，不能直接保存客户端传来的 <code>IBinder</code> 回调接口，因为Binder对象可能因进程死亡而失效。<code>RemoteCallbackList</code> 能自动管理这种生命周期。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RemoteCallbackList&lt;ICallback&gt; callbackList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteCallbackList</span>&lt;&gt;();

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IMyService.<span class="hljs-type">Stub</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IMyService</span>.Stub() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerCallback</span><span class="hljs-params">(ICallback cb)</span> {
            callbackList.register(cb);
        }
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unregisterCallback</span><span class="hljs-params">(ICallback cb)</span> {
            callbackList.unregister(cb);
        }
    };

    <span class="hljs-comment">// 向所有客户端广播事件</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">broadcastEvent</span><span class="hljs-params">(String event)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> callbackList.beginBroadcast();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; i++) {
            <span class="hljs-keyword">try</span> {
                callbackList.getBroadcastItem(i).onEvent(event);
            } <span class="hljs-keyword">catch</span> (RemoteException e) {
                <span class="hljs-comment">// 客户端可能已死亡，忽略</span>
            }
        }
        callbackList.finishBroadcast();
    }
}
</code></pre>
<h4 data-id="heading-8">4. 同步 (<code>two-way</code>) 与异步 (<code>oneway</code>)</h4>
<ul>
<li><strong>同步</strong>：客户端线程会阻塞，适用于需要立即结果的调用。</li>
<li><strong>异步</strong>：在接口方法前加 <code>oneway</code> 关键字，不等待返回，也没有返回值。适用于通知型操作，能有效避免客户端阻塞，但需注意其“至多一次 (at-most-once)”的语义，调用可能因进程死亡而丢失。</li>
</ul>
<pre><code class="hljs language-aidl" lang="aidl">// 同步方法
int calculate(in int a, in int b);

// 异步方法（无返回值，不抛RemoteException）
oneway void notifySomethingHappened(in String event);
</code></pre>
<h4 data-id="heading-9">5. 权限控制与安全</h4>
<p>可在 <code>AndroidManifest.xml</code> 中为服务声明自定义权限，并在 <code>onBind</code> 或具体方法内校验。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">service</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MyService"</span>
    <span class="hljs-attr">android:permission</span>=<span class="hljs-string">"com.example.MY_PERMISSION"</span>
    <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"true"</span>&gt;</span> <span class="hljs-comment">&lt;!-- 允许其他应用绑定 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在服务端的onBind或方法实现中校验</span>
<span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> {
    <span class="hljs-keyword">if</span> (checkCallingOrSelfPermission(<span class="hljs-string">"com.example.MY_PERMISSION"</span>) 
        != PackageManager.PERMISSION_GRANTED) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 绑定失败</span>
    }
    <span class="hljs-keyword">return</span> binder;
}
</code></pre>
<h3 data-id="heading-10">🎯 <strong>性能与稳定性最佳实践</strong></h3>
<ol>
<li><strong>减少跨进程调用次数</strong>：设计接口时，尽量将多个操作合并为一次调用（如传递一个<code>User</code>对象，而非多次调用设置<code>name</code>、<code>id</code>）。</li>
<li><strong>注意线程模型</strong>：AIDL调用在服务端默认运行在 <strong>Binder线程池</strong> 中（非主线程），因此需要进行线程同步。使用 <code>oneway</code> 调用时，服务端方法仍会在Binder线程池中执行。</li>
<li><strong>妥善处理 <code>RemoteException</code></strong>：所有跨进程调用都必须捕获此异常，它意味着连接已断开。</li>
<li><strong>及时解绑</strong>：在客户端（如<code>Activity</code>）的 <code>onDestroy</code> 中调用 <code>unbindService</code>，防止内存泄漏。</li>
<li><strong>接口版本兼容</strong>：为已发布的AIDL接口添加新方法时，考虑向后兼容，例如使用默认实现或版本号协商。</li>
</ol>
<h2 data-id="heading-11">Demo 示例</h2>
<p>IRemoteService.aidl</p>
<pre><code class="hljs language-csharp" lang="csharp">package com.example.aidl;
import com.example.aidl.User;   <span class="hljs-comment">// 自定义 Parcelable</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title">IRemoteService</span> {
    <span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">add</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> a, <span class="hljs-built_in">int</span> b</span>)</span>;                <span class="hljs-comment">// 基本类型</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">printUser</span>(<span class="hljs-params"><span class="hljs-keyword">in</span> User u</span>)</span>;            <span class="hljs-comment">// in 方向</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getUser</span>(<span class="hljs-params"><span class="hljs-keyword">out</span> User u</span>)</span>;             <span class="hljs-comment">// out 方向</span>
    <span class="hljs-function">oneway <span class="hljs-keyword">void</span> <span class="hljs-title">fireCallback</span>()</span>;           <span class="hljs-comment">// 非阻塞</span>
}
</code></pre>
<p>User.aidl</p>
<pre><code class="hljs language-ini" lang="ini">package com.example.aidl<span class="hljs-comment">;</span>
parcelable User<span class="hljs-comment">;</span>
</code></pre>
<p>服务端实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Service</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IRemoteService.<span class="hljs-type">Stub</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IRemoteService</span>.Stub() {
    
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> { <span class="hljs-keyword">return</span> a + b; }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printUser</span><span class="hljs-params">(User u)</span> { Log.d(<span class="hljs-string">"AIDL"</span>, u.name); }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getUser</span><span class="hljs-params">(User u)</span> {
            u.name = <span class="hljs-string">"server"</span>; u.age = <span class="hljs-number">18</span>;   <span class="hljs-comment">// 填充 out 参数</span>
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fireCallback</span><span class="hljs-params">()</span> { <span class="hljs-comment">/* 单向，无返回 */</span> }
    };
    
    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent i)</span> { <span class="hljs-keyword">return</span> binder; }
}
</code></pre>
<p>客户端调用</p>
<pre><code class="hljs language-ini" lang="ini">IRemoteService <span class="hljs-attr">s</span> = IRemoteService.Stub.asInterface(service)<span class="hljs-comment">;</span>
int <span class="hljs-attr">r</span> = s.add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Rust + Bevy 打造修仙卡牌游戏：从零上架 Windows 商店的技术复盘]]></title>    <link>https://juejin.cn/post/7603314759758200851</link>    <guid>https://juejin.cn/post/7603314759758200851</guid>    <pubDate>2026-02-06T07:31:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603314759758200851" data-draft-id="7603352061506273286" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Rust + Bevy 打造修仙卡牌游戏：从零上架 Windows 商店的技术复盘"/> <meta itemprop="keywords" content="Rust,游戏开发"/> <meta itemprop="datePublished" content="2026-02-06T07:31:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="peterfei"/> <meta itemprop="url" content="https://juejin.cn/user/2700056287782663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Rust + Bevy 打造修仙卡牌游戏：从零上架 Windows 商店的技术复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056287782663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    peterfei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:31:40.000Z" title="Fri Feb 06 2026 07:31:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4be013d0dfb454d99164212a7b954c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGV0ZXJmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770972870&amp;x-signature=FVZ3zP4Bgv%2Bfb6ufcGcqhVZ5xig%3D" alt="4v63r2n7b1rmt0cw3getasz2q8_result_.gif" loading="lazy"/></p>
<blockquote>
<p>一名独立开发者如何用 Rust 和 Bevy 引擎，打造出拥有四相位终极特效的修仙肉鸽卡牌游戏《九界：渡劫》，并成功登陆 Windows 商店。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、项目缘起：为什么选择 Rust + Bevy？</h2>
<p>作为一名技术博主，我一直想挑战游戏开发。当决定要做一款修仙题材的肉鸽卡牌游戏时，我面临一个关键选择：用什么技术栈？</p>
<p>Unity？太重，而且个人版有启动画面限制。Godot？学习曲线尚可，但性能调优不够透明。最终，我选择了 <strong>Rust + Bevy 0.15</strong>，这个决定让我受益匪浅。</p>
<h3 data-id="heading-1">为什么是 Rust？</h3>
<ul>
<li><strong>内存安全</strong>：不用担心悬垂指针和内存泄漏</li>
<li><strong>零成本抽象</strong>：高级特性不会带来运行时开销</li>
<li><strong>生态活跃</strong>：crates.io 上有丰富的游戏开发库</li>
</ul>
<h3 data-id="heading-2">为什么是 Bevy？</h3>
<ul>
<li><strong>ECS 架构</strong>：数据驱动的实体组件系统，性能卓越</li>
<li><strong>热重载开发</strong>：代码改动即时生效，开发体验丝滑</li>
<li><strong>现代渲染</strong>：基于 WGPU，跨平台支持优秀</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、项目架构：模块化设计全览</h2>
<pre><code class="hljs language-bash" lang="bash">bevy-card-battler/
├── src/
│   ├── main.rs          <span class="hljs-comment"># 主入口，窗口初始化</span>
│   ├── lib.rs           <span class="hljs-comment"># 库入口，模块导出</span>
│   ├── components/      <span class="hljs-comment"># 组件定义</span>
│   ├── systems/         <span class="hljs-comment"># 系统实现</span>
│   ├── plugins/         <span class="hljs-comment"># 插件封装</span>
│   ├── resources/       <span class="hljs-comment"># 全局资源</span>
│   └── states/          <span class="hljs-comment"># 游戏状态</span>
├── assets/              <span class="hljs-comment"># 游戏资源</span>
├── tests/               <span class="hljs-comment"># 集成测试</span>
└── docs/                <span class="hljs-comment"># 技术文档</span>
</code></pre>
<p><strong>核心设计原则</strong>：</p>
<ol start="0">
<li><strong>插件化</strong>：每个功能模块都是独立 Plugin</li>
<li><strong>状态驱动</strong>：使用 Bevy State 管理游戏流程</li>
<li><strong>资源池化</strong>：纹理、材质统一管理</li>
</ol>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a67707d0a23439f8960fccab6a98e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGV0ZXJmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770972870&amp;x-signature=Zifx%2BullezMIzi8ztGijslhTuEU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">三、核心亮点：万剑归宗四相位特效</h2>
<p>这是游戏最震撼的技能特效，我将其拆分为四个艺术相位：</p>
<h3 data-id="heading-5">第一相位：万剑齐鸣 (0% ~ 20%)</h3>
<p>飞剑从虚空中"撕裂"而出，斜插向天际。核心是<strong>后坐力算法</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">// 先沉一下，再极速弹射
let <span class="hljs-attr">progress</span> = strike_t / <span class="hljs-number">0.2</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">recoil</span> = if progress &lt; <span class="hljs-number">0.3</span> {
    -30.0 * (progress / 0.3)  // 下沉
} else {
    -30.0 + 350.0 * ((progress - 0.3) / 0.7)  // 弹射
}<span class="hljs-comment">;</span>
<span class="hljs-attr">p.position.y</span> = start_y + recoil<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-6">第二相位：八卦剑轮 (20% ~ 45%)</h3>
<p>立体三层圆锥形剑阵，每层有不同的旋转速度和呼吸节奏：</p>
<pre><code class="hljs language-ini" lang="ini">// 三层圆锥结构
for layer in 0..3 {
    let <span class="hljs-attr">base_angle</span> = layer_angle * layer as f32<span class="hljs-comment">;</span>
    let <span class="hljs-attr">radius</span> = layer_radius * (layer + <span class="hljs-number">1</span>) as f32<span class="hljs-comment">;</span>
​
    // 呼吸颤动效果
    let <span class="hljs-attr">breathing</span> = (time * <span class="hljs-number">8.0</span> + layer as f32).sin() * <span class="hljs-number">15.0</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">p.position.x</span> = center_x + (angle + breathing).cos() * radius<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-7">第三相位：瞬狱锁定 (45% ~ 55%)</h3>
<p>全屏突然静止，飞剑调头指向敌人，背景变暗。关键是<strong>减速曲线</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">// 3次贝塞尔减速
let <span class="hljs-attr">ease_t</span> = cubic_bezier((strike_t - <span class="hljs-number">0.45</span>) / <span class="hljs-number">0.1</span>)<span class="hljs-comment">;</span>
let <span class="hljs-attr">slowdown</span> = <span class="hljs-number">1.0</span> - ease_t * <span class="hljs-number">0.95</span><span class="hljs-comment">;  // 降至 5% 速度</span>
p.velocity *= slowdown<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-8">第四相位：极速穿心 (55% ~ 100%)</h3>
<p>极长残影流光，切向突刺。使用<strong>三次贝塞尔曲线</strong>实现轨迹：</p>
<pre><code class="hljs language-ini" lang="ini">// 贝塞尔曲线轨迹
let <span class="hljs-attr">p0</span> = current_pos<span class="hljs-comment">;</span>
let <span class="hljs-attr">p1</span> = current_pos + tangent * <span class="hljs-number">200.0</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">p2</span> = enemy_pos - tangent * <span class="hljs-number">100.0</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">p3</span> = enemy_pos<span class="hljs-comment">;</span>
​
let <span class="hljs-attr">t</span> = (strike_t - <span class="hljs-number">0.55</span>) / <span class="hljs-number">0.45</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">curve_pos</span> = cubic_bezier_point(p0, p1, p2, p3, t)<span class="hljs-comment">;</span>
<span class="hljs-attr">p.position</span> = curve_pos<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">四、程序化粒子系统：告别美术资源依赖</h2>
<p>传统游戏开发需要美术提供大量粒子贴图，我用<strong>程序化生成</strong>解决了这个问题：</p>
<h3 data-id="heading-10">水墨写意晕染贴图</h3>
<pre><code class="hljs language-ini" lang="ini">// 运行时生成 128x128 晕染贴图
for y in 0..height {
    for x in 0..width {
        let <span class="hljs-attr">dx</span> = x as f32 - <span class="hljs-number">63.5</span><span class="hljs-comment">;</span>
        let <span class="hljs-attr">dy</span> = y as f32 - <span class="hljs-number">63.5</span><span class="hljs-comment">;</span>
        let <span class="hljs-attr">dist</span> = (dx*dx + dy*dy).sqrt() / <span class="hljs-number">64.0</span><span class="hljs-comment">;</span>
​
        // 边缘扰动模拟自然墨迹
        let <span class="hljs-attr">angle</span> = dy.atan2(dx)<span class="hljs-comment">;</span>
        let <span class="hljs-attr">noise</span> = (angle * <span class="hljs-number">4.0</span>).sin() * <span class="hljs-number">0.12</span>
                  + (angle * 7.0).cos() * 0.08<span class="hljs-comment">;</span>
​
        let <span class="hljs-attr">alpha</span> = (<span class="hljs-number">1.0</span> - dist * dist).powi(<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
        data<span class="hljs-section">[idx + 3]</span> = (alpha * 255.0) as u8<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-11">灵气烧灼特效（雷击）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 多层频率噪声模拟雷击分叉</span>
let noise = (angle * <span class="hljs-number">5.0</span>)<span class="hljs-selector-class">.sin</span>() * <span class="hljs-number">0.15</span>
          + (angle * <span class="hljs-number">13.0</span>)<span class="hljs-selector-class">.cos</span>() * <span class="hljs-number">0.07</span>
          + (angle * <span class="hljs-number">27.0</span>)<span class="hljs-selector-class">.sin</span>() * <span class="hljs-number">0.03</span>;
​
<span class="hljs-comment">// 中心深紫，向外烟熏扩散</span>
scorch_data<span class="hljs-selector-attr">[i]</span> = (intensity.powf(<span class="hljs-number">2.5</span>) * <span class="hljs-number">40.0</span>) as u8;   <span class="hljs-comment">// R</span>
scorch_data<span class="hljs-selector-attr">[i+1]</span> = (intensity.powf(<span class="hljs-number">3.0</span>) * <span class="hljs-number">15.0</span>) as u8; <span class="hljs-comment">// G</span>
scorch_data<span class="hljs-selector-attr">[i+2]</span> = (intensity.powf(<span class="hljs-number">1.8</span>) * <span class="hljs-number">70.0</span>) as u8; <span class="hljs-comment">// B</span>
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>零美术依赖，全代码生成</li>
<li>动态调整参数，即时预览</li>
<li>体积小，整包仅 50MB</li>
</ul>
<hr/>
<h2 data-id="heading-12">五、AI 模型集成：固有偏差补偿机制</h2>
<p>游戏中的 3D 角色模型使用 AI 生成，但 AI 模型存在<strong>固有朝向偏差</strong>。我实现了一套实时补偿算法：</p>
<pre><code class="hljs language-ini" lang="ini">// 检测玩家与敌人的相对位置
let <span class="hljs-attr">to_enemy</span> = (enemy_pos - player_pos).normalize()<span class="hljs-comment">;</span>
let <span class="hljs-attr">to_enemy_angle</span> = to_enemy.y.atan2(to_enemy.x)<span class="hljs-comment">;</span>
​
// 应用固有偏差补偿（AI 模型特性）
const BIAS_COMPENSATION: <span class="hljs-attr">f32</span> = std::f32::consts::PI / <span class="hljs-number">2.0</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">target_angle</span> = to_enemy_angle + BIAS_COMPENSATION<span class="hljs-comment">;</span>
​
// 平滑旋转插值
<span class="hljs-attr">transform.rotation</span> = Quat::from_rotation_z(
    lerp_angle(current_angle, target_angle, 0.15)
)<span class="hljs-comment">;</span>
</code></pre>
<p>这样确保角色始终正确朝向敌人，不受 AI 模型原始朝向影响。</p>
<hr/>
<h2 data-id="heading-13">六、TDD 开发实践：17/17 测试全覆盖</h2>
<p>为了确保特效质量，我采用 TDD（测试驱动开发）模式：</p>
<h3 data-id="heading-14">测试覆盖矩阵</h3>








































<table><thead><tr><th>测试类型</th><th>用例数</th><th>覆盖内容</th></tr></thead><tbody><tr><td>时间区间验证</td><td>4</td><td>四相位边界检测</td></tr><tr><td>后坐力函数</td><td>2</td><td>沉降弹射曲线</td></tr><tr><td>圆锥结构</td><td>2</td><td>三层螺旋排列</td></tr><tr><td>呼吸颤动</td><td>2</td><td>正弦波偏移</td></tr><tr><td>NaN 防护</td><td>4</td><td>边界值保护</td></tr><tr><td>位置验证</td><td>3</td><td>坐标有效性</td></tr></tbody></table>
<h3 data-id="heading-15">关键 Bug 修复</h3>
<p><strong>Bug #1: 负数 delay 导致 NaN</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ❌ 问题代码</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">delay</span> = <span class="hljs-number">0.06</span> - (i <span class="hljs-keyword">as</span> <span class="hljs-type">f32</span> * <span class="hljs-number">0.015</span>);  <span class="hljs-comment">// i=11 时 = -0.105</span>
​
<span class="hljs-comment">// ✅ 修复方案</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">delay</span> = (<span class="hljs-number">0.06</span> - (i <span class="hljs-keyword">as</span> <span class="hljs-type">f32</span> * <span class="hljs-number">0.015</span>)).<span class="hljs-title function_ invoke__">max</span>(<span class="hljs-number">0.0</span>);
</code></pre>
<p><strong>Bug #2: 实体删除后仍更新 Transform</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ❌ 错误顺序</span>
if <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.is_dead</span>() {
    commands<span class="hljs-selector-class">.entity</span>(entity)<span class="hljs-selector-class">.despawn_recursive</span>();
}
<span class="hljs-comment">// ... 后续代码仍尝试访问 entity</span>
​
<span class="hljs-comment">// ✅ 正确顺序</span>
<span class="hljs-comment">// 先更新 Transform</span>
if let <span class="hljs-built_in">Some</span>(mut ec) = commands<span class="hljs-selector-class">.get_entity</span>(entity) {
    ec<span class="hljs-selector-class">.insert</span>(Transform::from_rotation(...));
}
<span class="hljs-comment">// 再检查死亡</span>
if <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.is_dead</span>() {
    commands<span class="hljs-selector-class">.entity</span>(entity)<span class="hljs-selector-class">.despawn_recursive</span>();
}
</code></pre>
<hr/>
<h2 data-id="heading-16">七、Windows 商店上架经验</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b504cba02f4432fb327d2d5c0bfcbc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGV0ZXJmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770972870&amp;x-signature=pde7AjhaYUQ42PNcueL25BiM1xo%3D" alt="屏幕截图(1).png" loading="lazy"/></p>
<h3 data-id="heading-17">打包配置</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Cargo.toml</span>
<span class="hljs-section">[profile.release]</span>
<span class="hljs-attr">opt-level</span> = <span class="hljs-number">3</span>      <span class="hljs-comment"># 最高优化</span>
<span class="hljs-attr">lto</span> = <span class="hljs-string">"fat"</span>        <span class="hljs-comment"># 链接时优化</span>
<span class="hljs-attr">codegen-units</span> = <span class="hljs-number">1</span>  <span class="hljs-comment"># 单编译单元</span>
<span class="hljs-attr">strip</span> = <span class="hljs-literal">true</span>       <span class="hljs-comment"># 去除调试符号</span>
</code></pre>
<h3 data-id="heading-18">MSIX 打包脚本</h3>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># build_msix.bat</span>
cargo build --release
makemsix <span class="hljs-keyword">pack</span> ...
</code></pre>
<h3 data-id="heading-19">上架清单</h3>
<ul>
<li>✅ 应用图标（多尺寸）</li>
<li>✅ 截图（4-8 张）</li>
<li>✅ 隐私政策（本地存储声明）</li>
<li>✅ 内容评级</li>
<li>✅ 年龄分级</li>
</ul>
<hr/>
<h2 data-id="heading-20">八、性能优化技巧</h2>
<h3 data-id="heading-21">1. 精准控制 Bevy 特性</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 移除默认特性，按需加载</span>
<span class="hljs-attr">bevy</span> = { version = <span class="hljs-string">"0.15"</span>, default-features = <span class="hljs-literal">false</span>, features = [
    <span class="hljs-string">"animation"</span>, <span class="hljs-string">"bevy_asset"</span>, <span class="hljs-string">"bevy_audio"</span>, <span class="hljs-string">"bevy_render"</span>,
    <span class="hljs-string">"multi_threaded"</span>, <span class="hljs-string">"png"</span>, <span class="hljs-string">"jpeg"</span>, <span class="hljs-string">"vorbis"</span>, <span class="hljs-string">"mp3"</span>,
    <span class="hljs-string">"tonemapping_luts"</span>, <span class="hljs-string">"bevy_pbr"</span>, <span class="hljs-string">"bevy_picking"</span>, <span class="hljs-string">"bevy_state"</span>
] }
</code></pre>
<h3 data-id="heading-22">2. 渲染设置优化</h3>
<pre><code class="hljs language-c" lang="c">RenderPlugin {
    render_creation: WgpuSettings {
        power_preference: PowerPreference::HighPerformance,
        ..<span class="hljs-keyword">default</span>()
    }.into(),
    ..<span class="hljs-keyword">default</span>()
}
</code></pre>
<h3 data-id="heading-23">3. 日志系统分层</h3>
<pre><code class="hljs language-css" lang="css">// 文件 + 控制台双层日志
let file_appender = RollingFileAppender::<span class="hljs-built_in">new</span>(Rotation::DAILY, &amp;log_dir, <span class="hljs-string">"jiujie.log"</span>);
let <span class="hljs-attribute">filter</span> = EnvFilter::<span class="hljs-built_in">try_from_default_env</span>()
    .<span class="hljs-built_in">unwrap_or_else</span>(|_| <span class="hljs-string">"wgpu=error,bevy=info,jiujie=debug"</span>.<span class="hljs-built_in">into</span>());
</code></pre>
<hr/>
<h2 data-id="heading-24">九、技术栈总结</h2>








































<table><thead><tr><th>技术</th><th>版本</th><th>用途</th></tr></thead><tbody><tr><td>Rust</td><td>2021 Edition</td><td>核心语言</td></tr><tr><td>Bevy</td><td>0.15</td><td>游戏引擎</td></tr><tr><td>rand</td><td>0.8</td><td>随机数生成</td></tr><tr><td>serde</td><td>1.0</td><td>序列化</td></tr><tr><td>image</td><td>0.25</td><td>图像处理</td></tr><tr><td>winit</td><td>0.30</td><td>窗口管理</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-25">十、未来规划</h2>
<ul>
<li>移植到 Steam 平台</li>
<li>添加云存档同步</li>
<li>实现成就系统</li>
<li>支持模组加载</li>
<li>推出 Linux 版本</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-232 离线数仓Hive 离线数仓新增与留存计算：DWS 明细 + ADS 汇总一套跑通]]></title>    <link>https://juejin.cn/post/7603309951227215922</link>    <guid>https://juejin.cn/post/7603309951227215922</guid>    <pubDate>2026-02-06T08:18:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227215922" data-draft-id="7603393977477038106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-232 离线数仓Hive 离线数仓新增与留存计算：DWS 明细 + ADS 汇总一套跑通"/> <meta itemprop="keywords" content="后端,大数据,Apache Hive"/> <meta itemprop="datePublished" content="2026-02-06T08:18:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-232 离线数仓Hive 离线数仓新增与留存计算：DWS 明细 + ADS 汇总一套跑通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:18:26.000Z" title="Fri Feb 06 2026 08:18:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：离线数仓按天计算“新增会员”，并为后续“会员留存”提供口径一致的数据底座</li>
<li>结论：用“全量会员表(含首日dt)”做去重锚点，DWS 产新增明细，ADS 产新增计数，脚本串行即可</li>
<li>产出：可复用的 Hive SQL/脚本模板：新增识别（left join is null）+ 会员全量表增量维护 + 每日新增指标表</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37b66db62d09440083a0f943624ec51e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=Pfb9ECM147qA4yCMTTQUf%2ByLcRI%3D" alt="大数据-232 离线数仓Hive 离线数仓新增会员与留存计算：DWS 明细 + ADS 汇总一套跑通" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56e62770ac3c4c259c9a549a1e3c5200~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=S6mtWywl%2Bgxdh7gIlVVrxMS2AjQ%3D" alt="离线数仓架构图" loading="lazy"/></p>
<h2 data-id="heading-1">新增会员</h2>
<ul>
<li>留存会员：某段时间的新增会员，经过一段时间后，仍然使用应用认为是留存的会员。</li>
<li>新增会员：第一次使用应用的用户，定义为新增会员，卸载再次安装的设备，不会被算作是新增用户</li>
</ul>
<p>新增会员先计算 =&gt; 计算会员留存</p>
<h3 data-id="heading-2">需求描述</h3>
<p>每日新增会员数
08-02：DWD，会员每日启动明细（95-110）；所有会员信息（1-100）</p>
<ul>
<li>新增会员 101-110</li>
<li>新增会员数据+旧的会员的信息 = 新的所有会员信息（1-110）</li>
</ul>
<p>08-03：DWD，会员每日启动明细（100-120）；所有会员的信息（1-110）</p>
<ul>
<li>新增会员：111-120</li>
<li>新增会员数据 + 旧的所有会员的信息 = 新的所有会员的信息（1-120）</li>
</ul>
<p>计算步骤：</p>
<ul>
<li>计算新增会员</li>
<li>更新所有会员信息</li>
</ul>
<p>改进后方法：</p>
<ul>
<li>在所有会员信息中增加时间列，表示这个会员是哪一天成为新增会员</li>
<li>只需要一张表：所有会员的信息（id，dt）</li>
<li>将新增会员插入所有会员表中</li>
</ul>
<h3 data-id="heading-3">案例：如何计算新增会员</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- t1.dat 的数据如下</span>
<span class="hljs-number">4</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>
<span class="hljs-number">5</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>
<span class="hljs-number">6</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>
<span class="hljs-number">7</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>
<span class="hljs-number">8</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>
<span class="hljs-number">9</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-02</span>

<span class="hljs-comment">-- 日启动表 =&gt; DWS</span>
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> t1;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t1(id <span class="hljs-type">int</span>, dt string) <span class="hljs-type">row</span> format delimited fields terminated <span class="hljs-keyword">by</span> <span class="hljs-string">','</span>;
load data <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/opt/wzk/hive/data/t1.dat'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> t1;
</code></pre>
<p>执行如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baa6787e7bd842faa26b2dbfe1d2c00a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=7UCv9n3jVCprPMy2rInzFOKPvrk%3D" alt="离线数仓Hive 创建表" loading="lazy"/></p>
<p>继续执行</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- t2.dat 的数据如下</span>
<span class="hljs-number">1</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>
<span class="hljs-number">2</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>
<span class="hljs-number">3</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>
<span class="hljs-number">4</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>
<span class="hljs-number">5</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>
<span class="hljs-number">6</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-01</span>

<span class="hljs-comment">-- 全量数据 =&gt; DWS</span>
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> t2;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t2(id <span class="hljs-type">int</span>, dt string)
<span class="hljs-type">row</span> format delimited fields terminated <span class="hljs-keyword">by</span> <span class="hljs-string">','</span>;
load data <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/opt/wzk/hive/data/t2.dat'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> t2;
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77530146ce2b41ad9ace2bcc24a768cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=Bsuv3A3RfCzElvu6KYm8WjcJ6iw%3D" alt="离线数仓Hive丢弃表" loading="lazy"/></p>
<p>继续执行：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 找出 2020-08-02 的新用户</span>
<span class="hljs-keyword">select</span> t1.id, t1.dt, t2.id, t2.dt
<span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> t1.id<span class="hljs-operator">=</span>t2.id
<span class="hljs-keyword">where</span> t1.dt<span class="hljs-operator">=</span>"2020-08-02";
<span class="hljs-keyword">select</span> t1.id, t1.dt
<span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> t1.id<span class="hljs-operator">=</span>t2.id
<span class="hljs-keyword">where</span> t1.dt<span class="hljs-operator">=</span>"2020-08-02"
<span class="hljs-keyword">and</span> t2.id <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/554a0331db8a4384b0c4972a2e6c8c43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=tRtSRdZnCeNvW5mx5KnwtUToKTY%3D" alt="离线数仓Hive 查询表" loading="lazy"/>
继续运行：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 将找到 2020-08-02 新用户数据插入t2表中</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> t2
<span class="hljs-keyword">select</span> t1.id, t1.dt
<span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> t1.id<span class="hljs-operator">=</span>t2.id
<span class="hljs-keyword">where</span> t1.dt<span class="hljs-operator">=</span>"2020-08-02"
<span class="hljs-keyword">and</span> t2.id <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>;
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f44ca4aae8d40bfaf1dc50242e0c588~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=0yaZAoIzNwmzbDo6TbeaZNg1bXQ%3D" alt="离线数仓Hive 插入数据到表格" loading="lazy"/>
目前t2的数据有：</p>
<pre><code class="hljs language-shell" lang="shell">hive (default)&gt; select * from t2;
OK
t2.id   t2.dt
7       2020-08-02
8       2020-08-02
9       2020-08-02
1       2020-08-01
2       2020-08-01
3       2020-08-01
4       2020-08-01
5       2020-08-01
6       2020-08-01
Time taken: 0.137 seconds, Fetched: 9 row(s)
hive (default)&gt; 
</code></pre>
<p>我们继续加载新的数据进去，整体的思路如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- t3.dat的数据，t1 加载 2020-08-03 的数据</span>
<span class="hljs-number">14</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>
<span class="hljs-number">15</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>
<span class="hljs-number">16</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>
<span class="hljs-number">17</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>
<span class="hljs-number">18</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>
<span class="hljs-number">19</span>,<span class="hljs-number">2020</span><span class="hljs-number">-08</span><span class="hljs-number">-03</span>

load data <span class="hljs-keyword">local</span> inpath <span class="hljs-string">'/opt/wzk/hive/data/t3.dat'</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> t1;

<span class="hljs-comment">-- 同样的思路</span>
<span class="hljs-comment">-- 将找到 2020-08-03 新用户数据插入t2表中</span>
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-keyword">table</span> t2
<span class="hljs-keyword">select</span> t1.id, t1.dt
<span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> t2 <span class="hljs-keyword">on</span> t1.id<span class="hljs-operator">=</span>t2.id
<span class="hljs-keyword">where</span> t1.dt<span class="hljs-operator">=</span>"2020-08-03"
<span class="hljs-keyword">and</span> t2.id <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>;
<span class="hljs-comment">-- 检查结果</span>
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t2;
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b29d3c8c831471e946be75d99a34658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=GWJgzy02g4XuqFEgyCmhAflDVJE%3D" alt="离线数仓Hive查询数据" loading="lazy"/></p>
<h3 data-id="heading-4">DWS作用</h3>
<h4 data-id="heading-5">统一数据模型</h4>
<p>将原始数据（ODS层）按照一定的逻辑模型进行整合、清洗、加工，形成标准化的数据结构。
支持对数据的多维度、多粒度分析。</p>
<h4 data-id="heading-6">支持业务场景</h4>
<p>满足企业对历史数据的查询和分析需求。
支持 OLAP（在线分析处理）操作，如聚合查询、钻取和切片。</p>
<h4 data-id="heading-7">数据细化与分类</h4>
<p>将数据按照主题域（如销售、财务、库存等）分类，便于管理和查询。
通常保持较高的细节粒度，便于灵活扩展。</p>
<h4 data-id="heading-8">数据准确性与一致性</h4>
<p>经过处理的数据经过校验，确保逻辑关系正确，能够为下游提供准确的一致性数据。</p>
<h3 data-id="heading-9">创建DWS层表</h3>
<pre><code class="hljs language-sql" lang="sql">use dws;
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> if <span class="hljs-keyword">exists</span> dws.dws_member_add_day;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> dws.dws_member_add_day
(
  `device_id` string,
  `uid` string,
  `app_v` string,
  `os_type` string,
  `<span class="hljs-keyword">language</span>` string,
  `channel` string,
  `area` string,
  `brand` string,
  `dt` string
) COMMENT <span class="hljs-string">'每日新增会员明细'</span>
stored <span class="hljs-keyword">as</span> parquet;
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5977b9d54cda41818a422e7dfd78e65d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=Wjcw%2FPq%2FnUp8S5CAMOWFrYltrw4%3D" alt="离线数仓 DWS 层" loading="lazy"/></p>
<h3 data-id="heading-10">加载DWS层数据</h3>
<p>我们编写脚本：</p>
<pre><code class="hljs language-shell" lang="shell">vim /opt/wzk/hive/dws_load_member_add_day.sh
</code></pre>
<p>写入内容如下：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
source /etc/profile
if [ -n "$1" ]
then
do_date=$1
else
do_date=`date -d "-1 day" +%F`
fi
sql="
insert into table dws.dws_member_add_day
select t1.device_id,
t1.uid,
t1.app_v,
t1.os_type,
t1.language,
t1.channel,
t1.area,
t1.brand,
'$do_date'
from dws.dws_member_start_day t1 left join
dws.dws_member_add_day t2
on t1.device_id=t2.device_id
where t1.dt='$do_date'
and t2.device_id is null;
"
hive -e "$sql"
</code></pre>
<p>写入的内容如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7453f2ae3fb49d0bd0f4d73e8f686e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=60xl14xxAFxWR9SaMGk0zFiMuVw%3D" alt="离线数仓加载 DWS 层" loading="lazy"/></p>
<h3 data-id="heading-11">ADS 作用</h3>
<h4 data-id="heading-12">聚合和简化数据</h4>
<p>将 DWS 层中多表、多主题域的数据聚合成简单易用的表或视图。
直接输出满足业务需求的数据结果。</p>
<h4 data-id="heading-13">面向业务应用</h4>
<p>通过设计宽表或高性能视图，直接支持具体的业务场景和报表需求。
响应快速查询需求，如实时数据的展示。</p>
<h4 data-id="heading-14">数据分发与集成</h4>
<p>为前端的 BI 工具、报表系统或 API 服务提供高效的查询接口。
能够通过缓存机制或物化视图加速查询性能。</p>
<h4 data-id="heading-15">轻量化与高性能</h4>
<p>尽量减少数据量，保留业务最关心的关键指标。
采用预聚合、预计算等技术提升查询效率。</p>
<h3 data-id="heading-16">创建ADS层表</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> if <span class="hljs-keyword">exists</span> ads.ads_new_member_cnt;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> ads.ads_new_member_cnt(
  `cnt` string
)
partitioned <span class="hljs-keyword">by</span>(dt string)
<span class="hljs-type">row</span> format delimited fields terminated <span class="hljs-keyword">by</span> <span class="hljs-string">','</span>;
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215a2c64b9e9452496ca1dbdb1df504b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=XOZFZ4nRok%2FvOKW80F8WSB8K1vg%3D" alt="离线数仓 Hive DWS 层" loading="lazy"/></p>
<h3 data-id="heading-17">加载ADS层数据</h3>
<p>编写数据加载的脚本：</p>
<pre><code class="hljs language-shell" lang="shell">vim /opt/wzk/hive/ads_load_member_add.sh
</code></pre>
<p>编写对应的脚本如下所示：</p>
<pre><code class="hljs language-sql" lang="sql">#<span class="hljs-operator">!</span><span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>bash
source <span class="hljs-operator">/</span>etc<span class="hljs-operator">/</span>profile
if [ <span class="hljs-operator">-</span>n "$1" ] ;<span class="hljs-keyword">then</span>
do_date<span class="hljs-operator">=</span>$<span class="hljs-number">1</span>
<span class="hljs-keyword">else</span>
do_date<span class="hljs-operator">=</span>`<span class="hljs-type">date</span> <span class="hljs-operator">-</span>d "-1 day" <span class="hljs-operator">+</span><span class="hljs-operator">%</span>F`
fi
<span class="hljs-keyword">sql</span><span class="hljs-operator">=</span>"
insert overwrite table ads.ads_new_member_cnt
partition (dt='$do_date')
select count(1)
from dws.dws_member_add_day
where dt = '$do_date'
"
hive <span class="hljs-operator">-</span>e "$sql"
</code></pre>
<h3 data-id="heading-18">暂时小结</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19e374a5a01c4f5aa0de17db7df9fc82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770971436&amp;x-signature=k6ukLTDL%2BkO4O84GTTM64I1gnYE%3D" alt="离线数仓 ADS 层" loading="lazy"/>
调用脚本的次序是：</p>
<pre><code class="hljs language-shell" lang="shell">dws_load_member_add_day.sh
ads_load_member_add.sh
</code></pre>
<h2 data-id="heading-19">错误速查</h2>













































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>当日新增数忽高忽低</td><td>新增锚点不稳定（device_id 会变/uid 会变）</td><td>对比同日 uid 与 device_id 去重后的基数差异；明确新增口径：优先选稳定主键；必要时做 device_id↔uid 绑定表</td></tr><tr><td>新增明细重复出现</td><td>同一用户多天全量会员表未成功增量写入或写入失败回滚</td><td>检查 t2/全量表中是否存在该 id 的历史 dt；先保证“插入全量表”成功再产出下游；给插入加幂等约束（分区/去重）</td></tr><tr><td>新增明细为 0，但启动明细有数据</td><td>join 条件/字段类型不一致导致全匹配</td><td>抽样检查 t1.id 与 t2.id 的类型、是否有空格/格式差；统一字段类型与清洗规则；必要时 trim/cast 后再 join</td></tr><tr><td>ADS 分区覆盖错误或数据跑到错误日期</td><td>do_date 传参/默认日期取值不符合调度时间</td><td>打印脚本 do_date 与 SQL where dt；统一调度时间基准；强制调度传参，避免默认 -1 day 误差</td></tr><tr><td>ADS 结果累加而非覆盖</td><td>insert into 用错，或分区未指定导致追加</td><td>检查是否使用 insert overwrite + partition(dt=)；指标表用 insert overwrite 覆盖当日分区；明细表按需求决定追加</td></tr><tr><td>新增口径与“卸载重装不算新增”不一致</td><td>仅靠 device_id 无法识别“同设备卸载重装”边界</td><td>统计同 device_id 的首次/多次出现模式；以 device_id 为主键维护首次 dt；若设备重置导致变化，需风控/埋点补强</td></tr><tr><td>DWS/ADS 串行执行仍出现空结果</td><td>DWS 表 dt 字段写入与 where dt 不一致</td><td>核对 DWS 插入时 dt 取值是否为 ‘$do_date’；保证 DWS 写入 dt 与查询 dt 同源；避免混用 t1.dt 与脚本 dt</td></tr></tbody></table>
<h2 data-id="heading-20">其他系列</h2>
<h3 data-id="heading-21">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-22">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-23">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>