<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[手把手教你测试VPS网络质量：详解测试IP与LookingGlass用法 (以RackNerd洛杉矶DC02为例)]]></title>    <link>https://juejin.cn/post/7591465142452043828</link>    <guid>https://juejin.cn/post/7591465142452043828</guid>    <pubDate>2026-01-05T08:00:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591465142452043828" data-draft-id="7591413526709485568" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你测试VPS网络质量：详解测试IP与LookingGlass用法 (以RackNerd洛杉矶DC02为例)"/> <meta itemprop="keywords" content="网络协议,后端"/> <meta itemprop="datePublished" content="2026-01-05T08:00:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你测试VPS网络质量：详解测试IP与LookingGlass用法 (以RackNerd洛杉矶DC02为例)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T08:00:40.000Z" title="Mon Jan 05 2026 08:00:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在购买VPS（虚拟专用服务器）之前，最担心的莫过于买到“断流”、“高延迟”或者“绕路”的机器。光看商家的广告词是不够的，我们需要掌握硬核的测试方法。</p>
<p>本文将带你深入了解 <strong>测试IP</strong> 和 <strong>LookingGlass</strong> 的作用，并以热门的 <strong>RackNerd 洛杉矶 DC02 机房</strong> 为演示对象，教你如何像老手一样评估一台VPS的网络质量。</p>
<h2 data-id="heading-0">什么是测试IP和LookingGlass？</h2>
<p>在开始之前，我们需要明白这两个核心概念：</p>
<ol>
<li><strong>测试IP (Test IP)</strong>：<br/>
商家提供的一个特定IP地址，用于给用户测试从<strong>本地（你家）到服务器</strong>的连接质量。通过它，我们可以得知延迟（Ping值）、丢包率以及路由走向。</li>
<li><strong>LookingGlass (LG)</strong>：<br/>
这是一个Web工具，可以理解为服务器端的“透视镜”。它允许你直接在商家的服务器上执行网络命令（如Ping、Traceroute），或者从服务器下载文件。它的作用是测试<strong>从服务器到外部</strong>的网络质量，以及测试<strong>服务器的真实下行带宽</strong>。</li>
</ol>
<blockquote>
<p><strong>哪里可以找到这些信息？</strong><br/>
大多数商家会在官网隐藏角落发布，为了方便大家查找，我的<strong>传家宝VPS监控站</strong>整理了主流商家的测试信息。</p>
<p>比如本文演示的RackNerd，你可以直接在这里获取：<br/>
<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Flegacyvps.com%2Fscanidc%3Fproviders%3DRackNerd" target="_blank" title="https://legacyvps.com/scanidc?providers=RackNerd" ref="nofollow noopener noreferrer">点击查看 RackNerd 实时监控与测试信息</a></strong></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/279acf429197448497f8a3099d2aa9f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768204988&amp;x-signature=I355rzqwJQ4Nhyt7GiQHJ3YlozI%3D" alt="image-PFxd.webp" loading="lazy"/></p>
<h2 data-id="heading-1">第一阶段：使用测试IP评估延迟与稳定性</h2>
<p>我们要做的第一件事，就是看看这台服务器“卡不卡”。我们将使用 RackNerd 洛杉矶 DC02 的官方测试IP进行演示。</p>
<blockquote>
<p>不同的时间测试的结果可能不一样，晚高峰的一般能反映出服务器的真实网络情况。</p>
</blockquote>
<h3 data-id="heading-2">1. 单次测试：使用 itdog.cn (IT狗)</h3>
<p>IT狗是一个非常优秀的在线测试工具，它可以模拟全国不同地区、不同运营商（电信、联通、移动）访问该IP的情况。</p>
<ul>
<li><strong>操作步骤</strong>：打开 <code>https://www.itdog.cn/ping/</code>，输入 RackNerd 的测试IP。</li>
<li><strong>关注重点</strong>：
<ul>
<li><strong>平均延迟</strong>：美国西海岸（如洛杉矶）到中国大陆，平均延迟在 <strong>130ms - 180ms</strong> 之间属于优秀表现。</li>
<li><strong>地区差异</strong>：查看你所在的地区（比如广东电信）的延迟是多少，这比全国平均值更重要。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec299d4e84f2465393895f1356055bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768204988&amp;x-signature=1dVNeZYtgrTlCJZ7Wwq7mgndI2k%3D" alt="image-TnvY.webp" loading="lazy"/></p>
<h3 data-id="heading-3">2. 持续测试与路由分析：使用 ping.pe</h3>
<p>单次Ping只能看到瞬间状态，想要知道网络稳不稳定，是否存在“晚高峰丢包”，我们需要使用 <code>https://ping.pe/</code>。</p>
<ul>
<li><strong>操作步骤</strong>：打开网站，在顶部输入框输入测试IP，点击 <code>Go</code>。</li>
<li><strong>如何看图（初级玩法）</strong>：
<ul>
<li>页面上方会出现色彩斑斓的图表。</li>
<li><strong>绿色部分</strong>：代表连接顺畅，延迟稳定。绿色越多，说明网络越平稳。</li>
<li><strong>红色部分</strong>：代表<strong>丢包 (Packet Loss)</strong>。红色方块越多，说明数据包在传输过程中丢失了，这会导致网页打不开、SSH断开。如果红色密集，说明该线路极不稳定。</li>
</ul>
</li>
</ul>
<p><img src="https://www.legacyvps.com/upload/img_zpT4Dm5T.png" alt="img_zpT4Dm5T.png" loading="lazy"/></p>
<ul>
<li><strong>查看路由（高级玩法）</strong>：
<ul>
<li>不要只看上面的图，往下滑动页面。ping.pe 会自动显示 <strong>MTR (My Traceroute)</strong> 数据。</li>
<li>观察最后几跳（最后几行），看IP归属地。你可以清晰地看到数据包是从国内哪个出口出去的（是北京出口、上海出口还是广州出口），以及是否绕道了其他国家（比如去美国洛杉矶，却先绕道了日本或欧洲）。直连线路通常优于绕路。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3497d99cf07742deb28fc98af3f519e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768204988&amp;x-signature=Ok4H3DogkdtkVrlLZiJWef8AawU%3D" alt="image-ycij.webp" loading="lazy"/></p>
<h2 data-id="heading-4">第二阶段：使用 LookingGlass 测试真实网速与路由</h2>
<p>延迟低不代表速度快。要测试这台VPS能跑多宽的带宽，LookingGlass 是最权威的工具。</p>
<p><strong>演示地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flg-lax02.racknerd.com%2F" target="_blank" title="https://lg-lax02.racknerd.com/" ref="nofollow noopener noreferrer">RackNerd DC02 Looking Glass (lg-lax02.racknerd.com)</a></p>
<h3 data-id="heading-5">1. 真实下载测速</h3>
<p>这是最直观的“测速”方法。LookingGlass 通常提供 100MB、1GB 等大小的测试文件。</p>
<ul>
<li><strong>操作建议</strong>：在点击下载之前，<strong>请务必关闭你电脑上所有占用带宽的软件</strong>（如迅雷、Steam下载、挂着的视频、以及其他代理软件），以确保测试出的速度是你的宽带与服务器之间的真实上限。</li>
<li><strong>开始测试</strong>：点击下载 <code>1000MB.test</code> 文件。观察浏览器的下载速度。
<ul>
<li>如果你是 300M 的宽带，下载速度能达到 30MB/s 左右，说明线路质量极佳，带宽充足。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c0d862262794e4c8dbf6778190054be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768204988&amp;x-signature=y4vW8AuX%2Bv6gI4XKT18cCUQ%2BO0g%3D" alt="image-oOHp.webp" loading="lazy"/></p>
<h3 data-id="heading-6">2. LookingGlass 的三大法宝：Ping, Traceroute, MTR</h3>
<p>LookingGlass 界面通常包含这三个选项，它们是用来从服务器端发起测试的。</p>
<h4 data-id="heading-7">A. Ping (连通性测试)</h4>
<p>最基础的命令，测试服务器到你本地IP的延迟。</p>
<ul>
<li>
<p><strong>Windows/Linux 通用命令</strong>：</p>
<pre><code class="hljs language-xml" lang="xml">ping <span class="hljs-tag">&lt;<span class="hljs-name">你的本地IP</span>&gt;</span>
</code></pre>
<p>(注意：LookingGlass网页版里只需要输入你的IP，选择Ping即可)</p>
</li>
</ul>
<h4 data-id="heading-8">B. Traceroute (路由追踪)</h4>
<p>用于查看数据包从服务器出发，经过了哪些节点才到达你的电脑。这可以帮你判断回程路由是否绕路（有时候去程直连，回程绕路，依然会卡）。</p>
<ul>
<li>
<p><strong>Linux 下安装与使用</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># Ubuntu/Debian 安装</span>
apt-<span class="hljs-keyword">get</span> install traceroute
<span class="hljs-meta"># 使用</span>
traceroute www.google.com
</code></pre>
</li>
<li>
<p><strong>Windows 下使用</strong>：</p>
<pre><code class="hljs">tracert www.google.com
</code></pre>
</li>
</ul>
<h4 data-id="heading-9">C. MTR (网络诊断专家)</h4>
<p>MTR 是 Ping 和 Traceroute 的结合体。它会列出经过的所有节点，并持续对每个节点进行 Ping，能精准定位是哪个节点（骨干网还是机房网关）出现了丢包。</p>
<ul>
<li>
<p><strong>Linux 下安装与使用</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># Ubuntu/Debian 安装</span>
apt-<span class="hljs-keyword">get</span> install mtr
<span class="hljs-meta"># 使用 (通常需要root权限)</span>
mtr -r -c <span class="hljs-number">10</span> &lt;你的本地IP&gt;
<span class="hljs-meta"># -r 表示生成报告模式，-c 10 表示发送10个包</span>
</code></pre>
</li>
<li>
<p><strong>LookingGlass 中使用</strong>：选择 MTR 选项，输入你的IP，点击 Run。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2fb3498f7b04b0085682a05a9690b61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768204988&amp;x-signature=NekctMo087zLZYzF43fJzY9r8T4%3D" alt="image-RlgH.webp" loading="lazy"/></p>
<h2 data-id="heading-10">综合评价与总结</h2>
<p>通过以上两套组合拳，我们就能给 RackNerd 洛杉矶 DC02 做一个完整的体检：</p>
<ol>
<li><strong>看 Ping.pe</strong>：如果全绿，说明不丢包，连接稳定。</li>
<li><strong>看 IT狗</strong>：如果平均延迟在 160ms 左右，且你的运营商延迟没有飙红，说明响应速度合格。</li>
<li><strong>看 LookingGlass 下载</strong>：如果下载速度能跑满你的本地带宽，说明商家没有虚标带宽，且邻居没有滥用网络。</li>
<li><strong>看 MTR</strong>：如果回程路由直连无绕路，说明线路优化较好。</li>
</ol>
<p>掌握了这些方法，你就不再是看运气买VPS的“小白”了。无论是 RackNerd 还是其他商家，记得在下单前，先去我的监控站找找测试IP验证一番！</p>
<p><strong>相关资源：</strong></p>
<ul>
<li><strong>LegacyVPS 监控站 (RackNerd 专区)</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Flegacyvps.com%2Fscanidc%3Fproviders%3DRackNerd" target="_blank" title="https://legacyvps.com/scanidc?providers=RackNerd" ref="nofollow noopener noreferrer">legacyvps.com/scanidc?pro…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再瞎转Base64了！一文打通前端二进制任督二脉]]></title>    <link>https://juejin.cn/post/7591681023907610633</link>    <guid>https://juejin.cn/post/7591681023907610633</guid>    <pubDate>2026-01-05T08:13:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591681023907610633" data-draft-id="7591670569910304814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再瞎转Base64了！一文打通前端二进制任督二脉"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-05T08:13:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端大鱼"/> <meta itemprop="url" content="https://juejin.cn/user/395479916219517"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再瞎转Base64了！一文打通前端二进制任督二脉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479916219517/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端大鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T08:13:38.000Z" title="Mon Jan 05 2026 08:13:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发一个图片上传功能时，小王遇到了这样的需求：用户上传图片后，需要在前端预览，同时将图片转为Base64传给后端。面对Base64、Blob、File这些概念，小王陷入了困惑。这其实是很多前端开发者都会遇到的场景。</p>
<p>今天，我们就来彻底搞懂这些二进制数据处理的核心概念，让你在工作中游刃有余。</p>
<h2 data-id="heading-0">一、核心概念：它们都是什么？</h2>
<h3 data-id="heading-1">1. ArrayBuffer：最底层的二进制容器</h3>
<p>ArrayBuffer是最基础的二进制数据容器，它本身不提供任何操作数据的方法，只是一个“原始二进制数据缓冲区”。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建一个16字节的ArrayBuffer</span>
<span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">16</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buffer.<span class="hljs-property">byteLength</span>); <span class="hljs-comment">// 16</span>

<span class="hljs-comment">// 需要通过视图（TypedArray）来操作</span>
<span class="hljs-keyword">const</span> int32View = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int32Array</span>(buffer);
int32View[<span class="hljs-number">0</span>] = <span class="hljs-number">42</span>;
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>固定长度，创建后大小不可变</li>
<li>不能直接读写，需要借助TypedArray或DataView</li>
<li>内存中的原始二进制数据</li>
</ul>
<h3 data-id="heading-2">2. Blob：不可变的类文件对象</h3>
<p>Blob（Binary Large Object）表示不可变的原始数据，更像是“文件”的抽象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建一个文本Blob</span>
<span class="hljs-keyword">const</span> textBlob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-string">'Hello, World!'</span>], { <span class="hljs-attr">type</span>: <span class="hljs-string">'text/plain'</span> });

<span class="hljs-comment">// 创建一个图片Blob（通常来自Canvas）</span>
canvas.<span class="hljs-title function_">toBlob</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">blob</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(blob.<span class="hljs-property">size</span>); <span class="hljs-comment">// blob大小</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(blob.<span class="hljs-property">type</span>); <span class="hljs-comment">// 例如 'image/png'</span>
});

<span class="hljs-comment">// 从ArrayBuffer创建Blob</span>
<span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">8</span>);
<span class="hljs-keyword">const</span> blobFromBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([buffer]);
</code></pre>
<p><strong>实际应用场景</strong>：</p>
<ul>
<li>文件下载</li>
<li>图片预览</li>
<li>分片上传大文件</li>
</ul>
<h3 data-id="heading-3">3. File：特殊的Blob，来自用户文件系统</h3>
<p>File继承自Blob，增加了文件名、最后修改时间等信息。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 通常来自&lt;input type="file"&gt;</span>
<span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fileInput'</span>);
fileInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(file.<span class="hljs-property">name</span>);     <span class="hljs-comment">// 文件名</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(file.<span class="hljs-property">size</span>);     <span class="hljs-comment">// 文件大小</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(file.<span class="hljs-property">type</span>);     <span class="hljs-comment">// MIME类型</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(file.<span class="hljs-property">lastModified</span>); <span class="hljs-comment">// 最后修改时间</span>
});
</code></pre>
<h3 data-id="heading-4">4. Base64：二进制数据的文本表示</h3>
<p>Base64是一种将二进制数据编码为ASCII字符串的方法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 将字符串转为Base64</span>
<span class="hljs-keyword">const</span> base64 = <span class="hljs-title function_">btoa</span>(<span class="hljs-string">'Hello World!'</span>); <span class="hljs-comment">// "SGVsbG8gV29ybGQh"</span>

<span class="hljs-comment">// 解码Base64</span>
<span class="hljs-keyword">const</span> original = <span class="hljs-title function_">atob</span>(base64); <span class="hljs-comment">// "Hello World!"</span>

<span class="hljs-comment">// 将二进制数据转为Base64</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">arrayBufferToBase64</span>(<span class="hljs-params">buffer</span>) {
  <span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer);
  <span class="hljs-keyword">let</span> binary = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; bytes.<span class="hljs-property">byteLength</span>; i++) {
    binary += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(bytes[i]);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">btoa</span>(binary);
}
</code></pre>
<h3 data-id="heading-5">5. FileReader：读取文件内容的桥梁</h3>
<p>FileReader用于异步读取File或Blob对象的内容。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();
<span class="hljs-keyword">const</span> file = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fileInput'</span>).<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];

<span class="hljs-comment">// 读取为ArrayBuffer</span>
reader.<span class="hljs-title function_">readAsArrayBuffer</span>(file);
reader.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">const</span> arrayBuffer = e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
};

<span class="hljs-comment">// 读取为DataURL（Base64格式）</span>
reader.<span class="hljs-title function_">readAsDataURL</span>(file);
reader.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">const</span> dataURL = e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>; <span class="hljs-comment">// data:image/png;base64,...</span>
  img.<span class="hljs-property">src</span> = dataURL; <span class="hljs-comment">// 直接用于图片预览</span>
};

<span class="hljs-comment">// 读取为文本</span>
reader.<span class="hljs-title function_">readAsText</span>(file, <span class="hljs-string">'UTF-8'</span>);
</code></pre>
<h2 data-id="heading-6">二、实战应用：它们如何协同工作？</h2>
<h3 data-id="heading-7">场景1：图片上传预览</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用户选择图片后预览</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleImageUpload</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-keyword">const</span> file = event.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
  
  <span class="hljs-keyword">if</span> (!file.<span class="hljs-property">type</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'image/'</span>)) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请选择图片文件'</span>);
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-comment">// 方式1：使用URL.createObjectURL（性能更好）</span>
  <span class="hljs-keyword">const</span> objectURL = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(file);
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'preview'</span>).<span class="hljs-property">src</span> = objectURL;
  
  <span class="hljs-comment">// 方式2：使用FileReader转为Base64</span>
  <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();
  reader.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">const</span> base64 = e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'preview'</span>).<span class="hljs-property">src</span> = base64;
    <span class="hljs-comment">// 可以发送到后端</span>
    <span class="hljs-title function_">uploadToServer</span>(base64);
  };
  reader.<span class="hljs-title function_">readAsDataURL</span>(file);
}
</code></pre>
<h3 data-id="heading-8">场景2：文件下载</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建并下载文件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">downloadFile</span>(<span class="hljs-params">content, filename, contentType</span>) {
  <span class="hljs-comment">// 创建Blob</span>
  <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([content], { <span class="hljs-attr">type</span>: contentType });
  
  <span class="hljs-comment">// 创建下载链接</span>
  <span class="hljs-keyword">const</span> url = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(blob);
  <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'a'</span>);
  a.<span class="hljs-property">href</span> = url;
  a.<span class="hljs-property">download</span> = filename;
  
  <span class="hljs-comment">// 触发下载</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(a);
  a.<span class="hljs-title function_">click</span>();
  
  <span class="hljs-comment">// 清理</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(a);
    <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">revokeObjectURL</span>(url);
  }, <span class="hljs-number">100</span>);
}

<span class="hljs-comment">// 使用示例：下载JSON数据</span>
<span class="hljs-keyword">const</span> data = { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> };
<span class="hljs-title function_">downloadFile</span>(
  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>),
  <span class="hljs-string">'user-data.json'</span>,
  <span class="hljs-string">'application/json'</span>
);
</code></pre>
<h3 data-id="heading-9">场景3：处理二进制数据流</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 从网络获取二进制数据并处理</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processBinaryData</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-comment">// 1. 获取ArrayBuffer</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url);
  <span class="hljs-keyword">const</span> arrayBuffer = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">arrayBuffer</span>();
  
  <span class="hljs-comment">// 2. 转为TypedArray进行处理</span>
  <span class="hljs-keyword">const</span> uint8Array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(arrayBuffer);
  
  <span class="hljs-comment">// 3. 处理数据（例如，查找特定字节）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; uint8Array.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">if</span> (uint8Array[i] === <span class="hljs-number">0xFF</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`找到FF字节在位置: <span class="hljs-subst">${i}</span>`</span>);
    }
  }
  
  <span class="hljs-comment">// 4. 转为Blob用于下载或显示</span>
  <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([uint8Array], { <span class="hljs-attr">type</span>: <span class="hljs-string">'application/octet-stream'</span> });
  
  <span class="hljs-comment">// 5. 或者转为Base64</span>
  <span class="hljs-keyword">const</span> base64 = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();
    reader.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(reader.<span class="hljs-property">result</span>);
    reader.<span class="hljs-title function_">readAsDataURL</span>(blob);
  });
  
  <span class="hljs-keyword">return</span> { arrayBuffer, blob, base64 };
}
</code></pre>
<h2 data-id="heading-10">三、性能与最佳实践</h2>
<h3 data-id="heading-11">1. 内存管理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示例：不释放Blob URL会导致内存泄漏</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">memoryLeakExample</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> file = <span class="hljs-title function_">getSomeFile</span>();
  <span class="hljs-keyword">const</span> url = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(file);
  <span class="hljs-comment">// 使用后必须释放！</span>
}

<span class="hljs-comment">// 正确做法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">correctExample</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> file = <span class="hljs-title function_">getSomeFile</span>();
  <span class="hljs-keyword">const</span> url = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(file);
  
  <span class="hljs-comment">// 使用...</span>
  img.<span class="hljs-property">src</span> = url;
  
  <span class="hljs-comment">// 不再需要时立即释放</span>
  img.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">revokeObjectURL</span>(url);
  };
}
</code></pre>
<h3 data-id="heading-12">2. 大文件处理</h3>
<p>对于大文件，避免一次性读取到内存：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 分片读取大文件</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readLargeFileInChunks</span>(<span class="hljs-params">file, chunkSize = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span></span>) { <span class="hljs-comment">// 1MB</span>
  <span class="hljs-keyword">const</span> chunks = [];
  <span class="hljs-keyword">let</span> offset = <span class="hljs-number">0</span>;
  
  <span class="hljs-keyword">while</span> (offset &lt; file.<span class="hljs-property">size</span>) {
    <span class="hljs-keyword">const</span> chunk = file.<span class="hljs-title function_">slice</span>(offset, offset + chunkSize);
    <span class="hljs-keyword">const</span> arrayBuffer = <span class="hljs-keyword">await</span> chunk.<span class="hljs-title function_">arrayBuffer</span>();
    
    <span class="hljs-comment">// 处理每个分片</span>
    <span class="hljs-title function_">processChunk</span>(arrayBuffer);
    
    chunks.<span class="hljs-title function_">push</span>(arrayBuffer);
    offset += chunkSize;
  }
  
  <span class="hljs-keyword">return</span> chunks;
}

<span class="hljs-comment">// 使用流API（更现代的方式）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processFileWithStream</span>(<span class="hljs-params">file</span>) {
  <span class="hljs-keyword">const</span> stream = file.<span class="hljs-title function_">stream</span>();
  <span class="hljs-keyword">const</span> reader = stream.<span class="hljs-title function_">getReader</span>();
  
  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
    <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;
    
    <span class="hljs-comment">// value是Uint8Array</span>
    <span class="hljs-title function_">processChunk</span>(value);
  }
}
</code></pre>
<h2 data-id="heading-13">四、常见问题解答</h2>
<h3 data-id="heading-14">Q1: 什么时候用Base64，什么时候用Blob URL？</h3>
<ul>
<li><strong>Base64</strong>：需要文本格式传输时使用，如：
<ul>
<li>存储到localStorage</li>
<li>通过JSON传输</li>
<li>内嵌到CSS/HTML中</li>
</ul>
</li>
<li><strong>Blob URL</strong>：需要临时引用文件时使用，如：
<ul>
<li>图片/视频预览</li>
<li>文件下载</li>
<li>音频播放</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">Q2: ArrayBuffer和Blob有什么区别？</h3>






























<table><thead><tr><th>特性</th><th>ArrayBuffer</th><th>Blob</th></tr></thead><tbody><tr><td>可变性</td><td>可通过视图修改</td><td>不可变</td></tr><tr><td>用途</td><td>底层数据处理</td><td>文件表示</td></tr><tr><td>大小</td><td>创建时固定</td><td>可动态创建</td></tr><tr><td>方法</td><td>无直接方法</td><td>有slice等方法</td></tr></tbody></table>
<h3 data-id="heading-16">Q3: 大文件处理要注意什么？</h3>
<ol>
<li><strong>分片处理</strong>：避免一次性读取大文件到内存</li>
<li><strong>及时释放</strong>：使用完Blob URL后立即调用<code>revokeObjectURL()</code></li>
<li><strong>使用流API</strong>：现代浏览器支持Streams API，更高效</li>
<li><strong>Web Worker</strong>：在后台线程处理，避免阻塞UI</li>
</ol>
<h2 data-id="heading-17">总结</h2>
<p>掌握这些二进制数据处理技术，你就能轻松应对前端开发中的各种文件处理需求：</p>
<ul>
<li><strong>ArrayBuffer</strong>是基石，处理原始二进制数据</li>
<li><strong>Blob</strong>是文件的抽象，用于存储和传输</li>
<li><strong>File</strong>是用户文件的接口</li>
<li><strong>Base64</strong>是兼容文本系统的编码方式</li>
<li><strong>FileReader</strong>是读取文件的桥梁</li>
</ul>
<p>记住选择合适的技术栈：小文件用Base64方便，大文件用Blob高效，底层操作用ArrayBuffer。合理使用这些技术，能让你的应用性能更优，用户体验更好。</p>
<hr/>
<p>关注微信公众号" <strong>大前端历险记</strong>"，掌握更多前端开发干货姿势！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[掌握SOQL For Loops：高效处理大量Salesforce数据的艺术]]></title>    <link>https://juejin.cn/post/7591635567588769838</link>    <guid>https://juejin.cn/post/7591635567588769838</guid>    <pubDate>2026-01-05T08:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591635567588769838" data-draft-id="7591681023907217417" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="掌握SOQL For Loops：高效处理大量Salesforce数据的艺术"/> <meta itemprop="keywords" content="面试,后端"/> <meta itemprop="datePublished" content="2026-01-05T08:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="UrbanJazzerati"/> <meta itemprop="url" content="https://juejin.cn/user/550205947391389"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            掌握SOQL For Loops：高效处理大量Salesforce数据的艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/550205947391389/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    UrbanJazzerati
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T08:19:05.000Z" title="Mon Jan 05 2026 08:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SOQL For Loops的实际价值：不仅仅是循环中的DML操作</h2>
<blockquote>
<p>确实，我们很少建议在循环内执行DML操作。但SOQL For Loops的真正价值远不止于此。</p>
</blockquote>
<p>最佳实践通常不鼓励在循环内执行DML操作。但SOQL For Loops的真正价值其实在于它处理<strong>大量数据查询</strong>的能力，而不仅仅是关于DML操作。让我们重新审视这个功能的核心优势。</p>
<h3 data-id="heading-1">重新认识SOQL For Loops的价值</h3>
<h4 data-id="heading-2">1. 处理超大型数据集的关键工具</h4>
<p>想象一下这样的场景：你需要遍历5万条客户记录来生成一份分析报告。标准SOQL查询会一次性加载所有记录，很快就会触发堆大小限制（6MB或12MB，取决于环境）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 这将导致堆溢出！</span>
List&lt;Account&gt; allAccounts = [SELECT Id, Name, AnnualRevenue FROM Account];
<span class="hljs-keyword">for</span>(Account acc : allAccounts) {
    <span class="hljs-comment">// 处理逻辑</span>
}
</code></pre>
<p>SOQL For Loops优雅地解决了这个问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不会触发堆限制</span>
<span class="hljs-keyword">for</span> (List&lt;Account&gt; acc : [SELECT Id, Name, AnnualRevenue FROM Account]) {
    <span class="hljs-comment">// 逐批处理，每批200条记录</span>
    performAnalysis(acc);
}
</code></pre>
<h4 data-id="heading-3">2. 复杂数据处理的理想选择</h4>
<p>当处理涉及多个对象或复杂计算时，SOQL For Loops的价值更加明显：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 处理机会及其相关产品</span>
<span class="hljs-type">Decimal</span> <span class="hljs-variable">totalRevenue</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">for</span> (Opportunity opp : [
    SELECT Id, Amount, 
           (SELECT UnitPrice, Quantity FROM OpportunityLineItems) <span class="hljs-comment">// 如果OPPLineItems超过200个，会出错！</span>
    FROM Opportunity 
    <span class="hljs-type">WHERE</span> <span class="hljs-variable">CloseDate</span> <span class="hljs-operator">=</span> THIS_YEAR
]) {
    <span class="hljs-comment">// 复杂计算逻辑</span>
    <span class="hljs-type">Decimal</span> <span class="hljs-variable">oppTotal</span> <span class="hljs-operator">=</span> opp.Amount != <span class="hljs-literal">null</span> ? opp.Amount : <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (OpportunityLineItem oli : opp.OpportunityLineItems) {
        oppTotal += oli.UnitPrice * oli.Quantity;
    }
    
    totalRevenue += oppTotal;
}
</code></pre>
<h3 data-id="heading-4">为什么不在循环中执行DML？</h3>
<p>最佳实践是：</p>
<ol>
<li><strong>收集数据，批量处理</strong></li>
<li><strong>避免在循环内单个执行DML</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐：在循环内单个更新</span>
<span class="hljs-keyword">for</span> (Account acc : [SELECT Id, Name FROM Account <span class="hljs-type">WHERE</span> <span class="hljs-variable">Type</span> <span class="hljs-operator">=</span> <span class="hljs-string">'Prospect'</span>]) {
    acc.Status__c = <span class="hljs-string">'Converted'</span>;
    update acc; <span class="hljs-comment">// ❌ 每次循环都执行DML</span>
}

<span class="hljs-comment">// 推荐：收集后批量更新</span>
List&lt;Account&gt; accountsToUpdate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">List</span>&lt;Account&gt;();
<span class="hljs-keyword">for</span> (Account acc : [SELECT Id, Name FROM Account <span class="hljs-type">WHERE</span> <span class="hljs-variable">Type</span> <span class="hljs-operator">=</span> <span class="hljs-string">'Prospect'</span>]) {
    acc.Status__c = <span class="hljs-string">'Converted'</span>;
    accountsToUpdate.add(acc);
}
update accountsToUpdate; <span class="hljs-comment">// ✅ 一次批量更新</span>
</code></pre>
<h3 data-id="heading-5">SOQL For Loops的真正应用场景</h3>
<h4 data-id="heading-6">1. 数据导出和报表生成</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateCSVReport</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">csvData</span> <span class="hljs-operator">=</span> <span class="hljs-string">'Id,Name,AnnualRevenue,EmployeeCount\n'</span>;
    
    <span class="hljs-comment">// 处理数5万条记录而不会溢出</span>
    <span class="hljs-keyword">for</span> (Account acc : [
        SELECT Id, Name, AnnualRevenue, NumberOfEmployees 
        FROM Account 
        <span class="hljs-type">WHERE</span> <span class="hljs-variable">CreatedDate</span> <span class="hljs-operator">=</span> LAST_YEAR
    ]) {
        csvData += acc.Id + <span class="hljs-string">','</span> 
                 + acc.Name + <span class="hljs-string">','</span> 
                 + (acc.AnnualRevenue != <span class="hljs-literal">null</span> ? String.valueOf(acc.AnnualRevenue) : <span class="hljs-string">'0'</span>) + <span class="hljs-string">','</span>
                 + (acc.NumberOfEmployees != <span class="hljs-literal">null</span> ? String.valueOf(acc.NumberOfEmployees) : <span class="hljs-string">'0'</span>)
                 + <span class="hljs-string">'\n'</span>;
    }
    
    <span class="hljs-keyword">return</span> csvData;
}
</code></pre>
<h4 data-id="heading-7">2. 实时数据验证和清理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateAccountData</span><span class="hljs-params">()</span> {
    List&lt;String&gt; invalidRecords = <span class="hljs-keyword">new</span> <span class="hljs-title class_">List</span>&lt;String&gt;();
    
    <span class="hljs-comment">// 扫描大量数据，只收集问题记录</span>
    <span class="hljs-keyword">for</span> (Account acc : [
        SELECT Id, Name, Website, Phone 
        FROM Account 
        <span class="hljs-type">WHERE</span> <span class="hljs-variable">CreatedDate</span> <span class="hljs-operator">=</span> LAST_90_DAYS
    ]) {
        <span class="hljs-keyword">if</span> (!isValidWebsite(acc.Website) &amp;&amp; !isValidPhone(acc.Phone)) {
            invalidRecords.add(acc.Name + <span class="hljs-string">' ('</span> + acc.Id + <span class="hljs-string">')'</span>);
        }
    }
    
    <span class="hljs-comment">// 批量处理或发送通知</span>
    <span class="hljs-keyword">if</span> (!invalidRecords.isEmpty()) {
        sendValidationAlert(invalidRecords);
    }
}
</code></pre>
<h4 data-id="heading-8">3. 数据迁移和转换</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">migrateLegacyData</span><span class="hljs-params">()</span> {
    Map&lt;Id, Contact&gt; contactsToCreate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;Id, Contact&gt;();
    
    <span class="hljs-comment">// 处理旧系统中的大量联系人数据</span>
    <span class="hljs-keyword">for</span> (Legacy_Contact__c legacy : [
        SELECT Id, First_Name__c, Last_Name__c, Email__c, 
               Account__c, Legacy_Id__c 
        FROM Legacy_Contact__c 
        <span class="hljs-type">WHERE</span> <span class="hljs-variable">Migrated__c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
        LIMIT <span class="hljs-number">50000</span>
    ]) {
        <span class="hljs-type">Contact</span> <span class="hljs-variable">newContact</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Contact</span>(
            FirstName = legacy.First_Name__c,
            LastName = legacy.Last_Name__c,
            Email = legacy.Email__c,
            AccountId = legacy.Account__c,
            Legacy_Id__c = legacy.Legacy_Id__c
        );
        
        contactsToCreate.put(legacy.Id, newContact);
    }
    
    <span class="hljs-comment">// 批量创建新记录</span>
    insert contactsToCreate.values();
    
    <span class="hljs-comment">// 批量更新迁移状态</span>
    List&lt;Legacy_Contact__c&gt; toUpdate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">List</span>&lt;Legacy_Contact__c&gt;();
    <span class="hljs-keyword">for</span> (Id legacyId : contactsToCreate.keySet()) {
        toUpdate.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Legacy_Contact__c</span>(
            Id = legacyId,
            Migrated__c = <span class="hljs-literal">true</span>
        ));
    }
    update toUpdate;
}
</code></pre>
<h3 data-id="heading-9">性能对比：标准查询 vs SOQL For Loops</h3>



































<table><thead><tr><th>场景</th><th>标准查询</th><th>SOQL For Loops</th></tr></thead><tbody><tr><td>1,000条记录</td><td>✅ 适合</td><td>✅ 适合</td></tr><tr><td>50,000条记录</td><td>❌ 可能堆溢出</td><td>✅ 适合</td></tr><tr><td>复杂对象关系</td><td>❌ 风险高</td><td>✅ 适合</td></tr><tr><td>内存密集型操作</td><td>❌ 不适合</td><td>✅ 适合</td></tr><tr><td>实时API响应</td><td>✅ 适合</td><td>❌ 不适合（较慢）</td></tr></tbody></table>
<h3 data-id="heading-10">最佳实践总结</h3>
<ol>
<li><strong>使用SOQL For Loops处理超过10,000条记录的数据集</strong></li>
<li><strong>避免在循环内执行DML - 收集到列表后批量处理</strong></li>
<li><strong>对于子查询结果，使用嵌套循环处理</strong></li>
<li><strong>结合Batch Apex处理数百万级数据</strong></li>
<li><strong>在异步上下文中（如@future、Batchable）使用，避免同步超时</strong></li>
</ol>
<h3 data-id="heading-11">结论</h3>
<p>SOQL For Loops的真正价值不在于循环内的DML操作（我们确实应该避免这样做），而在于它提供了一种<strong>安全、高效处理大量数据</strong>的机制。它是Salesforce开发者工具箱中处理大数据场景的必备工具。</p>
<p>当你需要：</p>
<ul>
<li>处理超过堆限制的数据</li>
<li>执行复杂的数据遍历和计算</li>
<li>迁移或清理大量记录</li>
<li>生成大规模报表</li>
</ul>
<p>这时，SOQL For Loops就是你的最佳选择。</p>
<p>记住，优秀的工具需要正确的使用方式。SOQL For Loops不是用来在循环内执行DML的，而是用来<strong>安全地遍历大量数据</strong>，然后<strong>批量处理</strong>这些数据的聪明工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 AI 自动写 SQL、读文档，前端也能玩转 Agent！ langchain chains 模块解析]]></title>    <link>https://juejin.cn/post/7591680281905446939</link>    <guid>https://juejin.cn/post/7591680281905446939</guid>    <pubDate>2026-01-05T08:40:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591680281905446939" data-draft-id="7589250237069525002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 AI 自动写 SQL、读文档，前端也能玩转 Agent！ langchain chains 模块解析"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-05T08:40:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 AI 自动写 SQL、读文档，前端也能玩转 Agent！ langchain chains 模块解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T08:40:38.000Z" title="Mon Jan 05 2026 08:40:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>注，langchain 更新速度很快，本文所有案例都经过试验，在 2025年12月可用！并且所有案例的 python 和 node.js 版本我都测试通过。</p>
<p>这是「写给小白学 AI」系列的第 5 篇文章，这个系列专门为刚接触人工智能的前端开发者和编程新手打造。如果你错过了之前的精彩内容，可以在这里补课：</p>
<ul>
<li><a href="https://juejin.cn/post/7573592127299108914" target="_blank" title="https://juejin.cn/post/7573592127299108914">打包票！前端和小白一定能明白的人工智能基础概念</a></li>
<li><a href="https://juejin.cn/post/7575162322241077248" target="_blank" title="https://juejin.cn/post/7575162322241077248">不易懂你打我！写给前端和小白的 大模型(ChatGPT) 工作基本原理！</a></li>
<li><a href="https://juejin.cn/post/7578416583213645874" target="_blank" title="https://juejin.cn/post/7578416583213645874">前端角度学 AI - 15 分钟入门 Python</a></li>
<li><a href="https://juejin.cn/post/7579935414423027758" target="_blank" title="https://juejin.cn/post/7579935414423027758">Prompt 还能哄女朋友！你真的知道如何问 ai 问题吗？</a></li>
<li><a href="https://juejin.cn/post/7582021506189328430" target="_blank" title="https://juejin.cn/post/7582021506189328430"> 神兵在手，AI Agent 起步不愁：写给小白的 LangChain 入门指南</a></li>
<li><a href="https://juejin.cn/post/7586657335881383963" target="_blank" title="https://juejin.cn/post/7586657335881383963">前端和小白都能看懂的 LangChain Model 模块核心实战指南</a></li>
</ul>
<p><strong>学习提示</strong>：案例使用的 node.js</p>
<p>LangChain Chains中的 Chains 模块，主要作用就是串联基础模块的功能，简单来说如果你用过 linux，你一定知道管道操作符，作用也是一模一样的，我们举个例子你就马上明白了。</p>
<p>下面是没有用 chains 模块，我们需要经历如下过程才能得到结果（使用了 json 解析器）伪代码：</p>
<pre><code class="hljs language-rust" lang="rust">定义 template <span class="hljs-punctuation">-&gt;</span> 将 template 的结果传入到大模型 <span class="hljs-punctuation">-&gt;</span> 调用大模型, 得到结果 <span class="hljs-punctuation">-&gt;</span> 传入 json解析器解析结果
</code></pre>
<p>我们拿一个 node.js 版本代码举例：</p>
<h2 data-id="heading-1"/>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">"dotenv"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ChatPromptTemplate</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/prompts"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">StructuredOutputParser</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/output_parsers"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

dotenv.<span class="hljs-title function_">config</span>();

<span class="hljs-comment">/**
 * 1. 定义结构（强烈推荐）
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserSchema</span> = z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">name</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"用户姓名"</span>),
  <span class="hljs-attr">age</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"用户年龄"</span>),
});

<span class="hljs-comment">/**
 * 2. 创建 Parser
 * 本质：JsonOutputParser + Zod 校验
 */</span>
<span class="hljs-keyword">const</span> parser = <span class="hljs-title class_">StructuredOutputParser</span>.<span class="hljs-title function_">fromZodSchema</span>(<span class="hljs-title class_">UserSchema</span>);

<span class="hljs-comment">/**
 * 3. Prompt（必须注入 format instructions）
 */</span>
<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个后端 API，请严格返回 JSON.\n${instructions}"</span>],
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>],
]);

<span class="hljs-comment">/**
 * 4. 模型
 */</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
  <span class="hljs-attr">modelName</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">MODEL_NAME</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">openAIApiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_API_KEY</span>,
  <span class="hljs-attr">baseUrl</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_BASE_URL</span>,
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">printResult</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> template = <span class="hljs-keyword">await</span> prompt.<span class="hljs-title function_">invoke</span>({
    <span class="hljs-attr">input</span>: <span class="hljs-string">"生成一个用户对象"</span>,
    <span class="hljs-attr">instructions</span>: parser.<span class="hljs-title function_">getFormatInstructions</span>(),
  });

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">invoke</span>(template);

}

<span class="hljs-title function_">printResult</span>();
</code></pre>
<p>上面的代码如果改为 chains 语法（链式语法），主要变化体现在 printResult 函数上：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 2. 创建 Parser
 * 本质：JsonOutputParser + Zod 校验
 */</span>
<span class="hljs-keyword">const</span> parser = StructuredOutputParser.fromZodSchema(UserSchema);

<span class="hljs-keyword">const</span> prompt = ChatPromptTemplate.fromMessages([
  [<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个后端 API，请严格返回 JSON.\n${instructions}"</span>],
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>],
]);

<span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">printResult</span>()</span> {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> prompt.pipe(llm).pipe(parser).invoke({
    input: <span class="hljs-string">"生成一个用户对象"</span>,
    instructions: parser.getFormatInstructions(),
  });

</code></pre>
<p>如上，通过 prompt 的pipe方法，将 prompt（提示词模板），交接给 大模型（llm）,然后将大模型的输出，通过 pipe 方法传递给 parser，这里我们定义的其实是一个json parser，本质就是从大模型返回的数据中提取 json 数据（大模型返回的字段很多，json parser 只提取 返回的我们需要的 json 格式数据）。</p>
<p>其实这里基础的 chains 模块的知识就讲完了。也就是liangchain 把各个模块通过链式语法简化了使用方式。接下来我们介绍一些有意思的也是 chains 模块的方法。</p>
<h2 data-id="heading-2">create_sql_query_chain</h2>
<p>我们都说前端已死，意思是 ai 能替代很多前端工作，这里介绍的这个 chain，其实能替代不少后端工作。它就是：</p>
<p><code>create_sql_query_chain</code> 的职责非常单一、清晰：</p>
<blockquote>
<p><strong>将自然语言问题 → 转换为 SQL 查询语句（字符串）</strong></p>
</blockquote>
<p>这个完全可以当做一个业务上的辅助模块，帮助后端开发自动生成对应的 sql 语句。简单来说：我们直接用 langchain 中的 <code>create_sql_query_chain</code> 结合大模型，问：“最近 7 天每天新增的用户数量”，然后就会返回真正查询数据库的 sql 语句。</p>
<p>注：langchain文档变化非常快，以至于很多包导入方式跟文档不一样（最新文档也不行）。以下代码是看了源码才知道如何导入的。。。费了很大力气。</p>
<p>以下需要使用导入新的包 <code>@langchain/classic</code>, <code>typeorm</code>, 因为我本地起了一个 postgresql，所以还要下载 <code>pg</code> 这个 npm 包（导入适合你使用的数据库）。</p>
<p>其中我用的 new ChatOpenAI 的参数不知道的，请参考我之前的文章，</p>
<ul>
<li><a href="https://juejin.cn/post/7586657335881383963" target="_blank" title="https://juejin.cn/post/7586657335881383963">前端和小白都能看懂的 LangChain Model 模块核心实战指南</a></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">"dotenv"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SqlDatabase</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/classic/sql_db"</span>;
<span class="hljs-keyword">import</span> { createSqlQueryChain } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/classic/chains/sql_db"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"typeorm"</span>;

dotenv.<span class="hljs-title function_">config</span>();

<span class="hljs-keyword">const</span> datasource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSource</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">"postgres"</span>,
  <span class="hljs-attr">host</span>: <span class="hljs-string">"localhost"</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-number">5432</span>,
  <span class="hljs-attr">username</span>: <span class="hljs-string">"xxx"</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">"xxx"</span>,
  <span class="hljs-attr">database</span>: <span class="hljs-string">"xxx"</span>,
  <span class="hljs-comment">// schema: "public", // 默认为 public，如果使用其他 schema 请指定</span>
});

<span class="hljs-comment">// 2. 初始化 LangChain 数据库包装类</span>
<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SqlDatabase</span>.<span class="hljs-title function_">fromDataSourceParams</span>({
  <span class="hljs-attr">appDataSource</span>: datasource,
});


<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
  <span class="hljs-attr">modelName</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">MODEL_NAME</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">openAIApiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_API_KEY</span>,
  <span class="hljs-attr">baseUrl</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_BASE_URL</span>,
});

<span class="hljs-comment">// 4. 创建 SQL 生成链</span>
<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createSqlQueryChain</span>({
  llm,
  db,
  <span class="hljs-attr">dialect</span>: <span class="hljs-string">"postgres"</span>, <span class="hljs-comment">// 显式指定为 postgres</span>
});

<span class="hljs-comment">// 5. 测试生成</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({
  <span class="hljs-attr">question</span>: <span class="hljs-string">"User 表中有多少用户？"</span>,
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"生成的 SQL:"</span>, response);

</code></pre>
<p>生成的 SQL 如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"SELECT COUNT(*) FROM "</span>public<span class="hljs-string">"."</span>Use<span class="hljs-string">r""</span>
</code></pre>
<p>是不是还是挺方便的，哈哈。其实上面的代码拓展一下，在某种程度上能实现一个辅助程序员的 sql 生成库。在开发环境可用，生产环境肯定是不建议的，因为你不能百分百相信大模型的生成结果。</p>
<h2 data-id="heading-3">createStuffDocumentsChain</h2>
<p><code>createStuffDocumentsChain</code> 是一个用于将多个文档（Documents）“塞进”提示词（Prompt）中并发送给大模型（LLM）的辅助函数。它是构建 RAG（检索增强生成）应用的核心步骤之一。</p>
<p>以下是一个案例，一看就懂！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">"dotenv"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>;
<span class="hljs-keyword">import</span> { createStuffDocumentsChain } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/classic/chains/combine_documents"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Document</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/documents"</span>;


dotenv.<span class="hljs-title function_">config</span>();

<span class="hljs-comment">// 创建提示词模板给大模型</span>
<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromTemplate</span>(<span class="hljs-string">`
    使用以下上下文回答用户的问题。
    如果你不知道答案，就说你不知道，不要尝试虚构。
    
    上下文: {context}
    
    问题: {input}
  `</span>);

<span class="hljs-comment">// 初始话大模型（我们用的 deepseek，充值10元能用很久）</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
  <span class="hljs-attr">modelName</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">MODEL_NAME</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">openAIApiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_API_KEY</span>,
  <span class="hljs-attr">baseUrl</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_BASE_URL</span>,
});

<span class="hljs-comment">// 创建文档chain</span>
<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createStuffDocumentsChain</span>({
  llm,
  prompt,
});

<span class="hljs-comment">// 模拟一些文档数据</span>
<span class="hljs-keyword">const</span> docs = [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>({
    <span class="hljs-attr">pageContent</span>: <span class="hljs-string">"LangChain 是一个用于开发由语言模型驱动的应用的框架。"</span>,
  }),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>({
    <span class="hljs-attr">pageContent</span>: <span class="hljs-string">"它支持 Python 和 JavaScript/TypeScript 两种语言。"</span>,
  }),
];

<span class="hljs-comment">// 5. 测试生成</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>({
  <span class="hljs-attr">input</span>: <span class="hljs-string">"LangChain 支持哪些编程语言？"</span>,
  <span class="hljs-attr">context</span>: docs,
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response);

</code></pre>
<p>返回的结果是：</p>
<pre><code class="hljs">根据上下文，LangChain 支持 Python 和 JavaScript/TypeScript 两种编程语言。
</code></pre>
<h2 data-id="heading-4">欢迎一起交流</h2>
<p>欢迎大家一起进群讨论前端全栈技术和 ai agent ，一起进步！</p>
<p>我的微信: a2298613245</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis映射器模块详解]]></title>    <link>https://juejin.cn/post/7591304659131138086</link>    <guid>https://juejin.cn/post/7591304659131138086</guid>    <pubDate>2026-01-04T07:33:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591304659131138086" data-draft-id="7590469811408945179" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis映射器模块详解"/> <meta itemprop="keywords" content="MyBatis"/> <meta itemprop="datePublished" content="2026-01-04T07:33:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis映射器模块详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T07:33:55.000Z" title="Sun Jan 04 2026 07:33:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从源码层面深入理解MyBatis Mapper的设计与实现</p>
</blockquote>
<h2 data-id="heading-0">一、MyBatis整体架构与映射器模块</h2>
<p>在深入映射器模块之前，我们先了解MyBatis的整体架构，以及映射器模块在其中的重要地位。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d998a12ef98f4a55ae7c66ea134914a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768116835&amp;x-signature=uhRWk7utzEkhyO58TuHgEZBmiWw%3D" alt="" loading="lazy"/></p>
<p>从架构图可以看出，MyBatis采用了分层架构设计，而<strong>映射器模块（Mapper Interface）位于接口层</strong>，是用户与MyBatis交互的主要入口。它通过接口定义数据库操作，结合XML或注解配置SQL语句，利用动态代理技术自动实现接口，让开发者以面向对象的方式操作数据库。</p>
<h2 data-id="heading-1">1.1 映射器模块的核心职责</h2>
<p>映射器模块主要承担以下核心职责：</p>
<pre><code class="hljs language-sql" lang="sql">✅ 定义数据库操作接口 <span class="hljs-operator">-</span> 通过Java接口定义CRUD操作
✅ <span class="hljs-keyword">SQL</span>语句映射 <span class="hljs-operator">-</span> 将接口方法与<span class="hljs-keyword">SQL</span>语句关联
✅ 参数映射 <span class="hljs-operator">-</span> 将方法参数转换为<span class="hljs-keyword">SQL</span>参数
✅ 结果映射 <span class="hljs-operator">-</span> 将查询结果映射为Java对象
✅ 动态代理实现 <span class="hljs-operator">-</span> 自动生成接口实现类
</code></pre>
<h2 data-id="heading-2">1.2 为什么需要Mapper？</h2>
<p>传统的JDBC编程存在以下问题：</p>
<pre><code class="hljs language-ini" lang="ini">//传统JDBC方式
String <span class="hljs-attr">sql</span> = <span class="hljs-string">"SELECT * FROM t_user WHERE id = ?"</span><span class="hljs-comment">;</span>
PreparedStatement <span class="hljs-attr">stmt</span> = conn.prepareStatement(sql)<span class="hljs-comment">;</span>
stmt.setInt(1, userId)<span class="hljs-comment">;</span>
ResultSet <span class="hljs-attr">rs</span> = stmt.executeQuery()<span class="hljs-comment">;</span>
// 手动解析ResultSet并映射为对象...
</code></pre>
<p>这种方式的问题：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-number">1</span>、<span class="hljs-keyword">SQL</span>分散在代码中，难以维护
<span class="hljs-number">2</span>、参数设置和结果映射都是手工操作
<span class="hljs-number">3</span>、容易出现类型转换错误
<span class="hljs-number">4</span>、代码重复度高
</code></pre>
<p>使用Mapper后：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//Mapper方式</span>
<span class="hljs-meta">@Select("SELECT * FROM t_user WHERE id = #{id}")</span>
User <span class="hljs-title function_">selectById</span><span class="hljs-params">(Long id)</span>;

<span class="hljs-comment">// 使用</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">1L</span>);
</code></pre>
<p>优势：</p>
<pre><code class="hljs language-sql" lang="sql">✅ <span class="hljs-keyword">SQL</span>与代码分离，易于维护
✅ 自动参数映射和结果映射
✅ 类型安全
✅ 代码简洁
</code></pre>
<h2 data-id="heading-3">1.3 Mapper的使用方式</h2>
<p>MyBatis支持两种Mapper配置方式：</p>




















<table><thead><tr><th>配置方式</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>XML配置</td><td>SQL语句在XML文件中</td><td>复杂SQL、需要动态SQL</td></tr><tr><td>注解配置</td><td>SQL语句在注解中</td><td>简单SQL、快速开发</td></tr></tbody></table>
<h2 data-id="heading-4">二、Mapper接口架构</h2>
<p>MyBatis的映射器模块采用了接口+配置的设计模式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75c8e50cccba47ea8982290ff203ea76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768116835&amp;x-signature=kj5%2Fsl1CSgdPimZOABaV2eFLm%2Bo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">2.1 Mapper接口定义</h2>
<p>Mapper是一个<strong>普通的Java接口，无需实现类</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">UserMapper</span> {
    <span class="hljs-comment">// 查询单个对象</span>
    <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">selectById</span>(Long id);

    <span class="hljs-comment">// 查询列表</span>
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">User</span>&gt; <span class="hljs-selector-tag">selectAll</span>();

    <span class="hljs-comment">// 插入</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">insert</span>(User user);

    <span class="hljs-comment">// 更新</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">update</span>(User user);

    <span class="hljs-comment">// 删除</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">deleteById</span>(Long id);

    <span class="hljs-comment">// 复杂查询</span>
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">User</span>&gt; <span class="hljs-selector-tag">selectByCondition</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"name"</span>) String name,
                                  <span class="hljs-variable">@Param</span>(<span class="hljs-string">"age"</span>) Integer age);
}
</code></pre>
<h2 data-id="heading-6">2.2 Mapper接口特点</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-number">1</span>️⃣ 无需实现类 - <span class="hljs-title class_">MyBatis</span>通过动态代理自动生成实现
<span class="hljs-number">2</span>️⃣ 方法名与<span class="hljs-variable constant_">SQL</span> <span class="hljs-variable constant_">ID</span>对应 - 接口方法名即为<span class="hljs-title class_">MappedStatement</span>的<span class="hljs-variable constant_">ID</span>
<span class="hljs-number">3</span>️⃣ 参数灵活 - 支持单参数、多参数、对象参数
<span class="hljs-number">4</span>️⃣ 返回值多样 - 支持单对象、集合、<span class="hljs-title class_">Map</span>等
</code></pre>
<h2 data-id="heading-7">2.3 MapperRegistry注册中心</h2>
<p>MyBatis维护了Mapper接口的注册中心：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperRegistry</span> {
    <span class="hljs-comment">// Configuration对象</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Configuration</span> config;
    <span class="hljs-comment">// Mapper接口与代理工厂的映射</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Class</span>&lt;?&gt;, <span class="hljs-title class_">MapperProxyFactory</span>&lt;?&gt;&gt; knownMappers = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MapperRegistry</span>(<span class="hljs-title class_">Configuration</span> config) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config;
    }

    <span class="hljs-comment">// 添加Mapper接口</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-built_in">void</span> <span class="hljs-title function_">addMapper</span>(<span class="hljs-params">Class&lt;T&gt; <span class="hljs-keyword">type</span></span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span>.<span class="hljs-title function_">isInterface</span>()) {
            <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasMapper</span>(<span class="hljs-keyword">type</span>)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(
                    <span class="hljs-string">"Type "</span> + <span class="hljs-keyword">type</span> + <span class="hljs-string">" is already known to the MapperRegistry."</span>
                );
            }
            <span class="hljs-built_in">boolean</span> loadCompleted = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 创建MapperProxyFactory</span>
                knownMappers.<span class="hljs-title function_">put</span>(<span class="hljs-keyword">type</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxyFactory</span>&lt;&gt;(<span class="hljs-keyword">type</span>));
                <span class="hljs-comment">// 解析Mapper注解</span>
                <span class="hljs-title class_">MapperAnnotationBuilder</span> parser = 
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperAnnotationBuilder</span>(config, <span class="hljs-keyword">type</span>);
                parser.<span class="hljs-title function_">parse</span>();
                loadCompleted = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-keyword">if</span> (!loadCompleted) {
                    knownMappers.<span class="hljs-title function_">remove</span>(<span class="hljs-keyword">type</span>);
                }
            }
        }
    }

    <span class="hljs-comment">// 获取Mapper实例</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getMapper</span>(<span class="hljs-params">Class&lt;T&gt; <span class="hljs-keyword">type</span>, SqlSession sqlSession</span>) {
        final <span class="hljs-title class_">MapperProxyFactory</span>&lt;T&gt; mapperProxyFactory = 
            (<span class="hljs-title class_">MapperProxyFactory</span>&lt;T&gt;) knownMappers.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>);
        <span class="hljs-keyword">if</span> (mapperProxyFactory == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(
                <span class="hljs-string">"Type "</span> + <span class="hljs-keyword">type</span> + <span class="hljs-string">" is not known to the MapperRegistry."</span>
            );
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> mapperProxyFactory.<span class="hljs-title function_">newInstance</span>(sqlSession);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(
                <span class="hljs-string">"Error getting mapper instance. Cause: "</span> + e, e
            );
        }
    }

    <span class="hljs-comment">// 检查是否已注册</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">hasMapper</span>(<span class="hljs-params">Class&lt;T&gt; <span class="hljs-keyword">type</span></span>) {
        <span class="hljs-keyword">return</span> knownMappers.<span class="hljs-title function_">containsKey</span>(<span class="hljs-keyword">type</span>);
    }

    <span class="hljs-comment">// 获取所有Mapper接口</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Collection</span>&lt;<span class="hljs-title class_">Class</span>&lt;?&gt;&gt; <span class="hljs-title function_">getMappers</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Collections</span>.<span class="hljs-title function_">unmodifiableCollection</span>(knownMappers.<span class="hljs-title function_">keySet</span>());
    }
}
</code></pre>
<h2 data-id="heading-8">三、SQL语句映射</h2>
<p>MyBatis提供了灵活的SQL映射方式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdbb120167124078a7130ed8b114d4e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768116835&amp;x-signature=AhiaxNkP8QTM239HDTa0UfDNzq4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">3.1 XML配置方式</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
    <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.mapper.UserMapper"</span>&gt;</span>

    <span class="hljs-comment">&lt;!--结果映射 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.example.entity.User"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"BIGINT"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"create_time"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"createTime"</span> 
                <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"TIMESTAMP"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-comment">&lt;!--查询单个用户 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectById"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span>&gt;</span>
        SELECT id, name, email, age, create_time
        FROM t_user
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 查询所有用户 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectAll"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span>&gt;</span>
        SELECT id, name, email, age, create_time
        FROM t_user
        ORDER BY id
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 插入用户 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.example.entity.User"</span> 
            <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span>&gt;</span>
        INSERT INTO t_user (name, email, age, create_time)
        VALUES (#{name}, #{email}, #{age}, NOW())
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

    <span class="hljs-comment">&lt;!--更新用户 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"update"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.example.entity.User"</span>&gt;</span>
        UPDATE t_user
        SET name = #{name},
            email = #{email},
            age = #{age}
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>

    <span class="hljs-comment">&lt;!--删除用户 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteById"</span>&gt;</span>
        DELETE FROM t_user
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>

    <span class="hljs-comment">&lt;!--动态SQL查询 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByCondition"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span>&gt;</span>
        SELECT id, name, email, age, create_time
        FROM t_user
        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"name != null and name != ''"</span>&gt;</span>
                AND name LIKE CONCAT('%', #{name}, '%')
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"age != null"</span>&gt;</span>
                AND age = #{age}
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span>
        ORDER BY id
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>


















































<table><thead><tr><th>元素</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>select</td><td>查询语句</td><td>...</td></tr><tr><td>insert</td><td>插入语句</td><td>...</td></tr><tr><td>update</td><td>更新语句</td><td>...</td></tr><tr><td>delete</td><td>删除语句</td><td>...</td></tr><tr><td>resultMap</td><td>结果映射</td><td>...</td></tr><tr><td>sql</td><td>可重用的SQL片段</td><td>...</td></tr><tr><td>cache</td><td>缓存配置</td><td/></tr><tr><td>cache-ref</td><td>引用缓存</td><td/></tr></tbody></table>
<h2 data-id="heading-10">3.2 注解配置方式</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">UserMapper</span> {

    <span class="hljs-variable">@Select</span>(<span class="hljs-string">"SELECT * FROM t_user WHERE id = #{id}"</span>)
    <span class="hljs-variable">@Results</span>(id = <span class="hljs-string">"userResult"</span>, value = {
        <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">"id"</span>, column = <span class="hljs-string">"id"</span>, id = true),
        <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">"name"</span>, column = <span class="hljs-string">"name"</span>),
        <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">"email"</span>, column = <span class="hljs-string">"email"</span>),
        <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">"age"</span>, column = <span class="hljs-string">"age"</span>),
        <span class="hljs-variable">@Result</span>(property = <span class="hljs-string">"createTime"</span>, column = <span class="hljs-string">"create_time"</span>)
    })
    User <span class="hljs-built_in">selectById</span>(Long id);

    <span class="hljs-variable">@Select</span>(<span class="hljs-string">"SELECT * FROM t_user ORDER BY id"</span>)
    List&lt;User&gt; <span class="hljs-built_in">selectAll</span>();

    <span class="hljs-variable">@Insert</span>(<span class="hljs-string">"INSERT INTO t_user (name, email, age, create_time) "</span> +
            <span class="hljs-string">"VALUES (#{name}, #{email}, #{age}, NOW())"</span>)
    <span class="hljs-variable">@Options</span>(useGeneratedKeys = true, keyProperty = <span class="hljs-string">"id"</span>)
    int <span class="hljs-built_in">insert</span>(User user);

    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE t_user SET name = #{name}, email = #{email}, "</span> +
            <span class="hljs-string">"age = #{age} WHERE id = #{id}"</span>)
    int <span class="hljs-built_in">update</span>(User user);

    <span class="hljs-variable">@Delete</span>(<span class="hljs-string">"DELETE FROM t_user WHERE id = #{id}"</span>)
    int <span class="hljs-built_in">deleteById</span>(Long id);

    <span class="hljs-variable">@Select</span>(<span class="hljs-string">"&lt;script&gt;"</span> +
            <span class="hljs-string">"SELECT * FROM t_user "</span> +
            <span class="hljs-string">"&lt;where&gt;"</span> +
            <span class="hljs-string">"&lt;if test='name != null'&gt;"</span> +
            <span class="hljs-string">"AND name LIKE CONCAT('%', #{name}, '%')"</span> +
            <span class="hljs-string">"&lt;/if&gt;"</span> +
            <span class="hljs-string">"&lt;if test='age != null'&gt;AND age = #{age}&lt;/if&gt;"</span> +
            <span class="hljs-string">"&lt;/where&gt;"</span> +
            <span class="hljs-string">"&lt;/script&gt;"</span>)
    List&lt;User&gt; <span class="hljs-built_in">selectByCondition</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"name"</span>) String name, 
                                  <span class="hljs-variable">@Param</span>(<span class="hljs-string">"age"</span>) Integer age);
}
</code></pre>
<h2 data-id="heading-11">3.3 混合配置方式</h2>
<p>XML和注解可以混合使用：</p>
<pre><code class="hljs language-xml" lang="xml">public interface UserMapper {
    //注解方式：简单查询
    @Select("SELECT * FROM t_user WHERE id = #{id}")
    User selectById(Long id);

    //XML方式：复杂查询
    List<span class="hljs-tag">&lt;<span class="hljs-name">User</span>&gt;</span> selectByCondition(UserQuery query);
}
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.mapper.UserMapper"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 复杂查询使用XML --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByCondition"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span>&gt;</span>
        SELECT * FROM t_user
        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"name != null"</span>&gt;</span>
                AND name LIKE CONCAT('%', #{name}, '%')
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"age != null"</span>&gt;</span>
                AND age = #{age}
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h2 data-id="heading-12">四、动态代理实现</h2>
<p>MyBatis通过JDK动态代理自动实现Mapper接口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e2714b0021d488fb25a9c490468ba56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768116835&amp;x-signature=XPKSrAFbSmIz4O54Pd8ltK0%2Bt7o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">4.1 MapperProxyFactory代理工厂</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxyFactory</span>&lt;T&gt; {
    <span class="hljs-comment">// Mapper接口类型</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Class</span>&lt;T&gt; mapperInterface;
    <span class="hljs-comment">// 方法缓存</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Method</span>, <span class="hljs-title class_">MapperMethod</span>&gt; methodCache = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MapperProxyFactory</span>(<span class="hljs-title class_">Class</span>&lt;T&gt; mapperInterface) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">mapperInterface</span> = mapperInterface;
    }

    <span class="hljs-comment">//创建代理实例</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">newInstance</span>(<span class="hljs-params">SqlSession sqlSession</span>) {
        final <span class="hljs-title class_">MapperProxy</span>&lt;T&gt; mapperProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxy</span>&lt;&gt;(
            sqlSession, mapperInterface, methodCache
        );
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">newInstance</span>(mapperProxy);
    }

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    <span class="hljs-keyword">protected</span> T <span class="hljs-title function_">newInstance</span>(<span class="hljs-params">MapperProxy&lt;T&gt; mapperProxy</span>) {
        <span class="hljs-comment">// 使用JDK动态代理创建代理对象</span>
        <span class="hljs-keyword">return</span> (T) <span class="hljs-title class_">Proxy</span>.<span class="hljs-title function_">newProxyInstance</span>(
            mapperInterface.<span class="hljs-title function_">getClassLoader</span>(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{mapperInterface},
            mapperProxy
        );
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Class</span>&lt;T&gt; <span class="hljs-title function_">getMapperInterface</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> mapperInterface;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Method</span>, <span class="hljs-title class_">MapperMethod</span>&gt; <span class="hljs-title function_">getMethodCache</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> methodCache;
    }
}
</code></pre>
<h2 data-id="heading-14">4.2 MapperProxy代理类</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxy</span>&lt;<span class="hljs-type">T</span>&gt; <span class="hljs-title">implements</span> <span class="hljs-title">InvocationHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSession sqlSession;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache;

    <span class="hljs-keyword">public</span> MapperProxy(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, 
                       Map&lt;Method, MapperMethod&gt; methodCache) {
        <span class="hljs-keyword">this</span>.sqlSession = sqlSession;
        <span class="hljs-keyword">this</span>.mapperInterface = mapperInterface;
        <span class="hljs-keyword">this</span>.methodCache = methodCache;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object invoke(Object proxy, Method method, Object[] args) 
        throws Throwable {
        <span class="hljs-comment">// 1.如果是Object类的方法，直接执行</span>
        <span class="hljs-keyword">if</span> (Object.<span class="hljs-keyword">class</span>.equals(method.getDeclaringClass())) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>, args);
            } <span class="hljs-keyword">catch</span> (Throwable t) {
                <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);
            }
        }

        <span class="hljs-comment">//2.获取MapperMethod并执行</span>
        <span class="hljs-keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method);
        <span class="hljs-keyword">return</span> mapperMethod.execute(sqlSession, args);
    }

    <span class="hljs-comment">//缓存MapperMethod</span>
    <span class="hljs-keyword">private</span> MapperMethod cachedMapperMethod(Method method) {
        <span class="hljs-keyword">return</span> methodCache.computeIfAbsent(method, 
            k -&gt; new MapperMethod(mapperInterface, method, 
                                  sqlSession.getConfiguration())
        );
    }
}
</code></pre>
<h2 data-id="heading-15">4.3 MapperMethod方法执行器</h2>
<pre><code class="hljs language-ini" lang="ini">public class MapperMethod {
    // SqlCommand封装了SQL命令信息
    private final SqlCommand command<span class="hljs-comment">;</span>
    // MethodSignature封装了方法签名信息
    private final MethodSignature method<span class="hljs-comment">;</span>

    public MapperMethod(Class&lt;?&gt; mapperInterface, Method method, 
                       Configuration config) {
        <span class="hljs-attr">this.command</span> = new SqlCommand(config, mapperInterface, method)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.method</span> = new MethodSignature(config, mapperInterface, method)<span class="hljs-comment">;</span>
    }

    public Object execute(SqlSession sqlSession, Object<span class="hljs-section">[]</span> args) {
        Object result<span class="hljs-comment">;</span>

        switch (command.getType()) {
            case INSERT: {
                //插入操作
                Object <span class="hljs-attr">param</span> = method.convertArgsToSqlCommandParam(args)<span class="hljs-comment">;</span>
                <span class="hljs-attr">result</span> = rowCountResult(
                    sqlSession.insert(command.getName(), param)
                )<span class="hljs-comment">;</span>
                break<span class="hljs-comment">;</span>
            }
            case UPDATE: {
                //更新操作
                Object <span class="hljs-attr">param</span> = method.convertArgsToSqlCommandParam(args)<span class="hljs-comment">;</span>
                <span class="hljs-attr">result</span> = rowCountResult(
                    sqlSession.update(command.getName(), param)
                )<span class="hljs-comment">;</span>
                break<span class="hljs-comment">;</span>
            }
            case DELETE: {
                //删除操作
                Object <span class="hljs-attr">param</span> = method.convertArgsToSqlCommandParam(args)<span class="hljs-comment">;</span>
                <span class="hljs-attr">result</span> = rowCountResult(
                    sqlSession.delete(command.getName(), param)
                )<span class="hljs-comment">;</span>
                break<span class="hljs-comment">;</span>
            }
            case SELECT:
                if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) {
                    // 有ResultHandler的查询
                    executeWithResultHandler(sqlSession, args)<span class="hljs-comment">;</span>
                    <span class="hljs-attr">result</span> = null<span class="hljs-comment">;</span>
                } else if (method.returnsMany()) {
                    //返回集合
                    <span class="hljs-attr">result</span> = executeForMany(sqlSession, args)<span class="hljs-comment">;</span>
                } else if (method.returnsMap()) {
                    //返回Map
                    <span class="hljs-attr">result</span> = executeForMap(sqlSession, args)<span class="hljs-comment">;</span>
                } else if (method.returnsCursor()) {
                    //返回Cursor
                    <span class="hljs-attr">result</span> = executeForCursor(sqlSession, args)<span class="hljs-comment">;</span>
                } else {
                    //返回单个对象
                    Object <span class="hljs-attr">param</span> = method.convertArgsToSqlCommandParam(args)<span class="hljs-comment">;</span>
                    <span class="hljs-attr">result</span> = sqlSession.selectOne(command.getName(), param)<span class="hljs-comment">;</span>
                    if (method.returnsOptional() &amp;&amp; 
                        (<span class="hljs-attr">result</span> == null || 
                         !method.getReturnType().equals(result.getClass()))) {
                        <span class="hljs-attr">result</span> = Optional.ofNullable(result)<span class="hljs-comment">;</span>
                    }
                }
                break<span class="hljs-comment">;</span>
            case FLUSH:
                <span class="hljs-attr">result</span> = sqlSession.flushStatements()<span class="hljs-comment">;</span>
                break<span class="hljs-comment">;</span>
            default:
                throw new BindingException(
                    "Unknown execution method for: " + command.getName()
                )<span class="hljs-comment">;</span>
        }

        if (<span class="hljs-attr">result</span> == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; 
            !method.returnsVoid()) {
            throw new BindingException(
                "Mapper method '" + command.getName() + 
                "' attempted to return null from a method with " +
                "a primitive return type (" + method.getReturnType() + ")."
            )<span class="hljs-comment">;</span>
        }
        return result<span class="hljs-comment">;</span>
    }

    // 执行返回多条的查询
    private &lt;E&gt; Object executeForMany(SqlSession sqlSession, Object<span class="hljs-section">[]</span> args) {
        List&lt;E&gt; result<span class="hljs-comment">;</span>
        Object <span class="hljs-attr">param</span> = method.convertArgsToSqlCommandParam(args)<span class="hljs-comment">;</span>
        if (method.hasRowBounds()) {
            RowBounds <span class="hljs-attr">rowBounds</span> = method.extractRowBounds(args)<span class="hljs-comment">;</span>
            <span class="hljs-attr">result</span> = sqlSession.selectList(
                command.getName(), param, rowBounds
            )<span class="hljs-comment">;</span>
        } else {
            <span class="hljs-attr">result</span> = sqlSession.selectList(command.getName(), param)<span class="hljs-comment">;</span>
        }
        return result<span class="hljs-comment">;</span>
    }

    // 执行返回Map的查询
    private &lt;K, V&gt; Map&lt;K, V&gt; executeForMap(SqlSession sqlSession, 
                                            Object<span class="hljs-section">[]</span> args) {
        Object <span class="hljs-attr">param</span> = method.convertArgsToSqlCommandParam(args)<span class="hljs-comment">;</span>
        Map&lt;K, V&gt; result<span class="hljs-comment">;</span>
        if (method.hasRowBounds()) {
            RowBounds <span class="hljs-attr">rowBounds</span> = method.extractRowBounds(args)<span class="hljs-comment">;</span>
            <span class="hljs-attr">result</span> = sqlSession.selectMap(
                command.getName(), param, method.getMapKey(), rowBounds
            )<span class="hljs-comment">;</span>
        } else {
            <span class="hljs-attr">result</span> = sqlSession.selectMap(
                command.getName(), param, method.getMapKey()
            )<span class="hljs-comment">;</span>
        }
        return result<span class="hljs-comment">;</span>
    }

    // 处理行数结果
    private Object rowCountResult(int rowCount) {
        final Object result<span class="hljs-comment">;</span>
        if (method.returnsVoid()) {
            <span class="hljs-attr">result</span> = null<span class="hljs-comment">;</span>
        } else if (Integer.TYPE.equals(method.getReturnType()) || 
                   Integer.class.equals(method.getReturnType())) {
            <span class="hljs-attr">result</span> = rowCount<span class="hljs-comment">;</span>
        } else if (Long.TYPE.equals(method.getReturnType()) || 
                   Long.class.equals(method.getReturnType())) {
            <span class="hljs-attr">result</span> = (long) rowCount<span class="hljs-comment">;</span>
        } else if (Boolean.TYPE.equals(method.getReturnType()) || 
                   Boolean.class.equals(method.getReturnType())) {
            <span class="hljs-attr">result</span> = rowCount &gt; <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        } else {
            throw new BindingException(
                "Mapper method '" + command.getName() + 
                "' has an unsupported return type: " + 
                method.getReturnType()
            )<span class="hljs-comment">;</span>
        }
        return result<span class="hljs-comment">;</span>
    }

    //内部类：SqlCommand
    public static class SqlCommand {
        private final String name<span class="hljs-comment">;</span>
        private final SqlCommandType type<span class="hljs-comment">;</span>

        public SqlCommand(Configuration configuration, 
                         Class&lt;?&gt; mapperInterface, Method method) {
            final String <span class="hljs-attr">methodName</span> = method.getName()<span class="hljs-comment">;</span>
            final Class&lt;?&gt; <span class="hljs-attr">declaringClass</span> = method.getDeclaringClass()<span class="hljs-comment">;</span>

            // 解析MappedStatement
            MappedStatement <span class="hljs-attr">ms</span> = resolveMappedStatement(
                mapperInterface, methodName, declaringClass, configuration
            )<span class="hljs-comment">;</span>

            if (<span class="hljs-attr">ms</span> == null) {
                if (method.getAnnotation(Flush.class) != null) {
                    <span class="hljs-attr">name</span> = null<span class="hljs-comment">;</span>
                    <span class="hljs-attr">type</span> = SqlCommandType.FLUSH<span class="hljs-comment">;</span>
                } else {
                    throw new BindingException(
                        "Invalid bound statement (not found): " + 
                        mapperInterface.getName() + "." + methodName
                    )<span class="hljs-comment">;</span>
                }
            } else {
                <span class="hljs-attr">name</span> = ms.getId()<span class="hljs-comment">;</span>
                <span class="hljs-attr">type</span> = ms.getSqlCommandType()<span class="hljs-comment">;</span>
                if (<span class="hljs-attr">type</span> == SqlCommandType.UNKNOWN) {
                    throw new BindingException(
                        "Unknown execution method for: " + name
                    )<span class="hljs-comment">;</span>
                }
            }
        }

        private MappedStatement resolveMappedStatement(
            Class&lt;?&gt; mapperInterface, String methodName, 
            Class&lt;?&gt; declaringClass, Configuration configuration) {
            String <span class="hljs-attr">statementId</span> = mapperInterface.getName() + <span class="hljs-string">"."</span> + methodName<span class="hljs-comment">;</span>
            if (configuration.hasStatement(statementId)) {
                return configuration.getMappedStatement(statementId)<span class="hljs-comment">;</span>
            }
            return null<span class="hljs-comment">;</span>
        }

        public String getName() {
            return name<span class="hljs-comment">;</span>
        }

        public SqlCommandType getType() {
            return type<span class="hljs-comment">;</span>
        }
    }

    //内部类：MethodSignature
    public static class MethodSignature {
        private final boolean returnsMany<span class="hljs-comment">;</span>
        private final boolean returnsMap<span class="hljs-comment">;</span>
        private final boolean returnsVoid<span class="hljs-comment">;</span>
        private final boolean returnsCursor<span class="hljs-comment">;</span>
        private final boolean returnsOptional<span class="hljs-comment">;</span>
        private final Class&lt;?&gt; returnType<span class="hljs-comment">;</span>
        private final String mapKey<span class="hljs-comment">;</span>
        private final Integer resultHandlerIndex<span class="hljs-comment">;</span>
        private final Integer rowBoundsIndex<span class="hljs-comment">;</span>
        private final ParamNameResolver paramNameResolver<span class="hljs-comment">;</span>

        public MethodSignature(Configuration configuration, 
                              Class&lt;?&gt; mapperInterface, Method method) {
            Type <span class="hljs-attr">resolvedReturnType</span> = typeParameterResolver(method)<span class="hljs-comment">;</span>

            // 解析返回类型
            if (resolvedReturnType instanceof Void) {
                <span class="hljs-attr">this.returnsVoid</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            } else if (Collection.class.isAssignableFrom(
                (Class&lt;?&gt;) resolvedReturnType) || 
                resolvedReturnType.isArray()) {
                <span class="hljs-attr">this.returnsMany</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            } else if (Map.class.isAssignableFrom(
                (Class&lt;?&gt;) resolvedReturnType)) {
                <span class="hljs-attr">this.returnsMap</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            } else {
                <span class="hljs-attr">this.returnsMany</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
                <span class="hljs-attr">this.returnsMap</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            }
            // ... 省略其他初始化代码
        }

        public Object convertArgsToSqlCommandParam(Object<span class="hljs-section">[]</span> args) {
            return paramNameResolver.getNamedParams(args)<span class="hljs-comment">;</span>
        }

        public boolean hasRowBounds() {
            return rowBoundsIndex != null<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h2 data-id="heading-16">4.4 代理执行流程</h2>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 调用Mapper接口方法
   ↓
<span class="hljs-bullet">2.</span> 触发MapperProxy.invoke()
   ↓
<span class="hljs-bullet">3.</span> 获取或创建MapperMethod
   ↓
<span class="hljs-bullet">4.</span> 执行MapperMethod.execute()
   ↓
<span class="hljs-bullet">5.</span> 根据SQL类型调用SqlSession方法
   ↓
<span class="hljs-bullet">6.</span> Executor执行SQL
   ↓
<span class="hljs-bullet">7.</span> 返回结果
</code></pre>
<h2 data-id="heading-17">五、Mapper注册流程</h2>
<p>Mapper接口需要注册到MyBatis才能使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e56894344dc4462bd1b15684e20d0e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768116835&amp;x-signature=C%2BAfBqxlMS2uJWvlPoc%2F%2BYPanh8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-18">5.1 注册方式</h2>
<pre><code class="hljs language-typescript" lang="typescript">&lt;configuration&gt;
    &lt;!-- 注册<span class="hljs-title class_">Mapper</span>接口 --&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span>
        <span class="hljs-comment">&lt;!--使用类路径 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.mapper.UserMapper"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!--使用包扫描 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.mapper"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!--使用XML资源路径 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"com/example/mapper/UserMapper.xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span></span>
&lt;/configuration&gt;
<span class="hljs-comment">// 创建Configuration</span>
<span class="hljs-title class_">Configuration</span> configuration = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();

<span class="hljs-comment">// 注册Mapper接口</span>
configuration.<span class="hljs-title function_">addMapper</span>(<span class="hljs-title class_">UserMapper</span>.<span class="hljs-property">class</span>);
configuration.<span class="hljs-title function_">addMapper</span>(<span class="hljs-title class_">OrderMapper</span>.<span class="hljs-property">class</span>);

<span class="hljs-comment">// 或者通过MapperRegistry</span>
<span class="hljs-title class_">MapperRegistry</span> mapperRegistry = configuration.<span class="hljs-title function_">getMapperRegistry</span>();
mapperRegistry.<span class="hljs-title function_">addMapper</span>(<span class="hljs-title class_">UserMapper</span>.<span class="hljs-property">class</span>);
<span class="hljs-title class_">SqlSessionFactoryBuilder</span> builder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>();

<span class="hljs-comment">// 通过InputStream</span>
<span class="hljs-title class_">SqlSessionFactory</span> factory = builder.<span class="hljs-title function_">build</span>(inputStream);

<span class="hljs-comment">// 通过Configuration</span>
<span class="hljs-title class_">Environment</span> environment = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Environment</span>(<span class="hljs-string">"development"</span>, ...);
<span class="hljs-title class_">Configuration</span> configuration = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(environment);
configuration.<span class="hljs-title function_">addMapper</span>(<span class="hljs-title class_">UserMapper</span>.<span class="hljs-property">class</span>);
<span class="hljs-title class_">SqlSessionFactory</span> factory = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().<span class="hljs-title function_">build</span>(configuration);
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span> {
    <span class="hljs-keyword">protected</span> final <span class="hljs-title class_">MapperRegistry</span> mapperRegistry = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperRegistry</span>(<span class="hljs-variable language_">this</span>);

    <span class="hljs-comment">// 添加Mapper</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-built_in">void</span> <span class="hljs-title function_">addMapper</span>(<span class="hljs-params">Class&lt;T&gt; <span class="hljs-keyword">type</span></span>) {
        mapperRegistry.<span class="hljs-title function_">addMapper</span>(<span class="hljs-keyword">type</span>);
    }

    <span class="hljs-comment">// 获取Mapper</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getMapper</span>(<span class="hljs-params">Class&lt;T&gt; <span class="hljs-keyword">type</span>, SqlSession sqlSession</span>) {
        <span class="hljs-keyword">return</span> mapperRegistry.<span class="hljs-title function_">getMapper</span>(<span class="hljs-keyword">type</span>, sqlSession);
    }

    <span class="hljs-comment">// 检查Mapper是否存在</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">hasMapper</span>(<span class="hljs-params">Class&lt;?&gt; <span class="hljs-keyword">type</span></span>) {
        <span class="hljs-keyword">return</span> mapperRegistry.<span class="hljs-title function_">hasMapper</span>(<span class="hljs-keyword">type</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MapperRegistry</span> <span class="hljs-title function_">getMapperRegistry</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> mapperRegistry;
    }
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperScannerConfigurer</span> {
    <span class="hljs-comment">// 扫描包路径</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> basePackage;

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span>(<span class="hljs-params">
        BeanDefinitionRegistry registry</span>) {
        <span class="hljs-comment">// 创建扫描器</span>
        <span class="hljs-title class_">ClassPathMapperScanner</span> scanner = 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathMapperScanner</span>(registry);

        <span class="hljs-comment">// 设置扫描包</span>
        scanner.<span class="hljs-title function_">scan</span>(<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">tokenizeToStringArray</span>(
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">basePackage</span>,
            <span class="hljs-title class_">ConfigurableApplicationContext</span>.<span class="hljs-property">CONFIG_LOCATION_DELIMITERS</span>
        ));
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassPathMapperScanner</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ClassPathBeanDefinitionScanner</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">BeanDefinitionHolder</span>&gt; <span class="hljs-title function_">doScan</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>... basePackages</span>) {
        <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">BeanDefinitionHolder</span>&gt; beanDefinitions = 
            <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">doScan</span>(basePackages);

        <span class="hljs-keyword">if</span> (beanDefinitions.<span class="hljs-title function_">isEmpty</span>()) {
            logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"No MyBatis mapper was found in '"</span> + 
                <span class="hljs-title class_">Arrays</span>.<span class="hljs-title function_">toString</span>(basePackages) + 
                <span class="hljs-string">"' package. Please check your configuration."</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 处理BeanDefinition</span>
            <span class="hljs-title function_">processBeanDefinitions</span>(beanDefinitions);
        }

        <span class="hljs-keyword">return</span> beanDefinitions;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processBeanDefinitions</span>(<span class="hljs-params">
        <span class="hljs-built_in">Set</span>&lt;BeanDefinitionHolder&gt; beanDefinitions</span>) {
        <span class="hljs-title class_">GenericBeanDefinition</span> definition;
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">BeanDefinitionHolder</span> holder : beanDefinitions) {
            definition = (<span class="hljs-title class_">GenericBeanDefinition</span>) holder.<span class="hljs-title function_">getBeanDefinition</span>();

            <span class="hljs-comment">// 设置BeanClass为MapperFactoryBean</span>
            definition.<span class="hljs-title function_">getConstructorArgumentValues</span>()
                .<span class="hljs-title function_">addGenericArgumentValue</span>(definition.<span class="hljs-title function_">getBeanClassName</span>());
            definition.<span class="hljs-title function_">setBeanClass</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mapperFactoryBean</span>.<span class="hljs-title function_">getClass</span>());

            <span class="hljs-comment">// ... 省略其他配置</span>
        }
    }
}
</code></pre>
<h2 data-id="heading-19">六、Mapper执行流程</h2>
<p>理解Mapper的执行流程对于调试和优化至关重要。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/175c30a73fe44186ab69deb68a0fafc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768116835&amp;x-signature=N%2Fi4UDa9YNZCjW89O%2BXz%2Fcpw80Q%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20">6.1 完整执行流程</h2>
<pre><code class="hljs language-ini" lang="ini">//1.获取SqlSession
SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession()<span class="hljs-comment">;</span>
try {
    //2.获取Mapper代理对象
    UserMapper <span class="hljs-attr">userMapper</span> = session.getMapper(UserMapper.class)<span class="hljs-comment">;</span>
    //3.调用Mapper方法
    User <span class="hljs-attr">user</span> = userMapper.selectById(<span class="hljs-number">1</span>L)<span class="hljs-comment">;</span>
    //4.使用结果
    System.out.println(user)<span class="hljs-comment">;</span>
    //5.提交事务
    session.commit()<span class="hljs-comment">;</span>
} finally {
    //6.关闭Session
    session.close()<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-21">6.2 详细执行步骤</h2>
<pre><code class="hljs language-css" lang="css">步骤<span class="hljs-number">1</span>: 获取Mapper代理对象
    session.<span class="hljs-built_in">getMapper</span>(UserMapper.class)
    ↓
    configuration.<span class="hljs-built_in">getMapper</span>(UserMapper.class, this)
    ↓
    mapperRegistry.<span class="hljs-built_in">getMapper</span>(UserMapper.class, this)
    ↓
    mapperProxyFactory.<span class="hljs-built_in">newInstance</span>(this)
    ↓
    Proxy.<span class="hljs-built_in">newProxyInstance</span>(...) → 创建代理对象
步骤<span class="hljs-number">2</span>: 调用Mapper方法
    userMapper.<span class="hljs-built_in">selectById</span>(<span class="hljs-number">1</span>L)
    ↓
    MapperProxy.<span class="hljs-built_in">invoke</span>(proxy, method, args)
    ↓
    <span class="hljs-built_in">cachedMapperMethod</span>(method)
    ↓
    mapperMethod.<span class="hljs-built_in">execute</span>(sqlSession, args)
步骤<span class="hljs-number">3</span>: 执行SQL
    SqlCommandType.SELECT
    ↓
    sqlSession.<span class="hljs-built_in">selectOne</span>(statementId, param)
    ↓
    executor.<span class="hljs-built_in">query</span>(ms, param, rowBounds, resultHandler)
    ↓
    创建CacheKey
    ↓
    查询缓存
    ↓
    查询数据库
    ↓
    映射结果
步骤<span class="hljs-number">4</span>: 返回结果
    处理ResultSet
    ↓
    ObjectFactory创建对象
    ↓
    ResultHandler映射
    ↓
    返回User对象
</code></pre>
<h2 data-id="heading-22">6.3 执行时序图</h2>
<pre><code class="hljs">应用 → MapperProxy → MapperMethod → SqlSession → 
Executor → StatementHandler → Database
</code></pre>
<h2 data-id="heading-23">6.4 异常处理</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">1L</span>);
} <span class="hljs-keyword">catch</span> (PersistenceException e) {
    <span class="hljs-comment">// 持久化异常</span>
    <span class="hljs-type">Throwable</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> e.getCause();
    <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> SQLException) {
        <span class="hljs-comment">// 处理SQL异常</span>
        <span class="hljs-type">SQLException</span> <span class="hljs-variable">sqlEx</span> <span class="hljs-operator">=</span> (SQLException) cause;
        System.out.println(<span class="hljs-string">"SQL Error: "</span> + sqlEx.getMessage());
    }
} <span class="hljs-keyword">catch</span> (BindingException e) {
    <span class="hljs-comment">// 绑定异常：Mapper方法未找到</span>
    System.out.println(<span class="hljs-string">"Mapper method not found: "</span> + e.getMessage());
}
</code></pre>
<h2 data-id="heading-24">七、最佳实践</h2>
<h2 data-id="heading-25">7.1 Mapper设计建议</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>️⃣ 单一职责 - 每个Mapper对应一张表
<span class="hljs-number">2</span>️⃣ 命名规范 - 接口名与实体名对应
<span class="hljs-number">3</span>️⃣ 方法命名 - 使用语义化的方法名
<span class="hljs-number">4</span>️⃣ 参数设计 - 使用<span class="hljs-keyword">@Param</span>注解明确参数名
</code></pre>
<h2 data-id="heading-26">7.2 性能优化建议</h2>
<pre><code class="hljs">1️⃣ 合理使用缓存 - 二级缓存提升性能
2️⃣ 避免N+1查询 - 使用关联查询
3️⃣ 分页查询 - 使用RowBounds或PageHelper
4️⃣ 批量操作 - 使用BatchExecutor
</code></pre>
<h2 data-id="heading-27">7.3 常见问题解决</h2>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span>错误：多参数未使用<span class="hljs-variable">@Param</span>
List<span class="hljs-operator">&lt;</span><span class="hljs-keyword">User</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span>(String name, <span class="hljs-type">Integer</span> age);

<span class="hljs-operator">/</span><span class="hljs-operator">/</span>正确：使用<span class="hljs-variable">@Param</span>
List<span class="hljs-operator">&lt;</span><span class="hljs-keyword">User</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span>(<span class="hljs-variable">@Param</span>("name") String name,
                 <span class="hljs-variable">@Param</span>("age") <span class="hljs-type">Integer</span> age);
<span class="hljs-operator">&lt;</span><span class="hljs-operator">!</span><span class="hljs-comment">--正确：使用resultMap --&gt;</span>
<span class="hljs-operator">&lt;</span>resultMap id<span class="hljs-operator">=</span>"BaseResultMap" type<span class="hljs-operator">=</span>"User"<span class="hljs-operator">&gt;</span>
    <span class="hljs-operator">&lt;</span>id <span class="hljs-keyword">column</span><span class="hljs-operator">=</span>"id" property<span class="hljs-operator">=</span>"id"<span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
    <span class="hljs-operator">&lt;</span><span class="hljs-keyword">result</span> <span class="hljs-keyword">column</span><span class="hljs-operator">=</span>"user_name" property<span class="hljs-operator">=</span>"name"<span class="hljs-operator">/</span><span class="hljs-operator">&gt;</span>
<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span>resultMap<span class="hljs-operator">&gt;</span>

<span class="hljs-operator">&lt;</span><span class="hljs-keyword">select</span> id<span class="hljs-operator">=</span>"selectById" resultMap<span class="hljs-operator">=</span>"BaseResultMap"<span class="hljs-operator">&gt;</span>
    <span class="hljs-keyword">SELECT</span> id, user_name <span class="hljs-keyword">FROM</span> t_user <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> #{id}
<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span><span class="hljs-keyword">select</span><span class="hljs-operator">&gt;</span>
</code></pre>
<h2 data-id="heading-28">八、总结</h2>
<p>MyBatis的映射器模块通过接口+配置的方式，实现了优雅的数据库操作。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-number">1</span>️⃣ Mapper接口 <span class="hljs-operator">-</span> 定义数据库操作方法
<span class="hljs-number">2</span>️⃣ <span class="hljs-keyword">SQL</span>映射 <span class="hljs-operator">-</span> XML或注解配置<span class="hljs-keyword">SQL</span>语句
<span class="hljs-number">3</span>️⃣ 动态代理 <span class="hljs-operator">-</span> JDK动态代理自动实现接口
<span class="hljs-number">4</span>️⃣ MapperProxy <span class="hljs-operator">-</span> 拦截方法调用并执行<span class="hljs-keyword">SQL</span>
<span class="hljs-number">5</span>️⃣ MapperMethod <span class="hljs-operator">-</span> 封装方法执行逻辑
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告警的艺术：从 node_exporter 指标到生产级规则]]></title>    <link>https://juejin.cn/post/7590330924002312255</link>    <guid>https://juejin.cn/post/7590330924002312255</guid>    <pubDate>2026-01-04T02:45:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924002312255" data-draft-id="7590283328177504299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告警的艺术：从 node_exporter 指标到生产级规则"/> <meta itemprop="keywords" content="后端,监控,架构"/> <meta itemprop="datePublished" content="2026-01-04T02:45:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告警的艺术：从 node_exporter 指标到生产级规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:45:43.000Z" title="Sun Jan 04 2026 02:45:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>凌晨 3 点，手机震动。</p>
<pre><code class="hljs language-makefile" lang="makefile">告警：server-01 CPU 使用率超过 80%
<span class="hljs-section">触发时间：03:12:45</span>
持续时长：2 分钟
</code></pre>
<p>你睁开惺忪的眼睛，登录服务器查看，发现只是 Jenkins 在跑定时编译任务。</p>
<p>这已经是本周第 12 次误报。</p>
<p>问题不在 Prometheus，也不在 node_exporter，而在<strong>告警规则的设计</strong>。</p>
<hr/>
<p>在<a href="https://juejin.cn/post/7589481566424596534" target="_blank" title="https://juejin.cn/post/7589481566424596534">《从 node-exporter 学如何写出可复用的监控指标》</a>中，我们学习了 node_exporter 的设计哲学：暴露事实，不是观点。</p>
<ul>
<li>CPU 暴露的是累计时间，不是使用率</li>
<li>内存暴露的是多个 Gauge，不是一个"使用率"</li>
<li>磁盘容量和 IO 分开设计</li>
</ul>
<p>这些"事实"很完整，但问题来了：<strong>有了指标，怎么变成告警？</strong></p>
<p>这不是简单设个阈值就行。你真的需要在 CPU 达到 80% 时立即告警吗？还是应该等它持续 10 分钟再打扰你？</p>
<p>本文聚焦一个核心问题：**基于 node_exporter 的数据，如何设计一套生产级的虚拟机告警规则？</p>
<h2 data-id="heading-0">1. 为什么需要告警规则的设计智慧</h2>
<h3 data-id="heading-1">1.1 Alertmanager 的局限</h3>
<p>很多人觉得 Prometheus 有 Alertmanager，为什么还要自研告警引擎？</p>
<p><strong>Alertmanager 的三个痛点：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Alertmanager 的配置</span>
<span class="hljs-attr">route:</span>
  <span class="hljs-attr">group_by:</span> [<span class="hljs-string">'alertname'</span>]
  <span class="hljs-attr">group_wait:</span> <span class="hljs-string">30s</span>
  <span class="hljs-attr">group_interval:</span> <span class="hljs-string">5m</span>
  <span class="hljs-attr">repeat_interval:</span> <span class="hljs-string">4h</span>
  <span class="hljs-attr">receiver:</span> <span class="hljs-string">'team-pager'</span>
</code></pre>

























<table><thead><tr><th>问题</th><th>表现</th><th>影响</th></tr></thead><tbody><tr><td><strong>配置复杂</strong></td><td>YAML 难理解</td><td>运维成本高，改规则要重启</td></tr><tr><td><strong>无状态可见</strong></td><td>不知道当前有哪些告警</td><td>无法追溯告警历史</td></tr><tr><td><strong>难以扩展</strong></td><td>加功能要改源码</td><td>无法融入业务逻辑</td></tr></tbody></table>
<p><strong>一个真实场景：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">运维：<span class="hljs-string">"CPU 使用率高的告警触发了多少次？"</span>
Alertmanager：<span class="hljs-string">"不知道，我不存历史。"</span>

运维：<span class="hljs-string">"这个告警持续多久了？"</span>
Alertmanager：<span class="hljs-string">"不知道，我只管通知。"</span>

运维：<span class="hljs-string">"能不能在发布窗口屏蔽告警？"</span>
Alertmanager：<span class="hljs-string">"可以，但要写复杂的 YAML。"</span>
</code></pre>
<p><strong>自研的价值：</strong></p>
<ul>
<li>Web UI 管理规则，不用改 YAML</li>
<li>数据库存储历史，可以分析趋势</li>
<li>灵活扩展，融入业务场景（如发布窗口自动静默）</li>
</ul>
<h3 data-id="heading-2">1.2 Google 的两个方法论</h3>
<p>Google SRE 给了我们两个黄金法则：</p>
<p><strong>USE 方法（资源监控）：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[Utilization&lt;br/&gt;利用率] --&gt; B[提前预警]
    C[Saturation&lt;br/&gt;饱和度] --&gt; D[确认拥塞]
    E[Errors&lt;br/&gt;错误] --&gt; F[确认故障]
    
    style A fill:#fff4e1
    style C fill:#ffe1f5
    style E fill:#ffcccc
</code></pre>
<ul>
<li><strong>Utilization</strong>：资源用了多少？（CPU 80% → 需要关注）</li>
<li><strong>Saturation</strong>：是否有排队？（IO 队列长 → 性能下降）</li>
<li><strong>Errors</strong>：是否有错误？（磁盘错误 → 硬件故障）</li>
</ul>
<p><strong>四个黄金信号（服务监控）：</strong></p>
<p>虽然虚拟机不是"服务"，但可以映射：</p>
<ul>
<li><strong>Latency</strong>：IO 延迟高 → 影响上层应用</li>
<li><strong>Traffic</strong>：网络流量异常 → 可能被攻击</li>
<li><strong>Errors</strong>：硬件错误 → 需要介入</li>
<li><strong>Saturation</strong>：资源饱和 → 需要扩容</li>
</ul>
<p><strong>启示：告警不是简单设阈值，而是要理解系统在不同阶段的表现。</strong></p>
<h3 data-id="heading-3">1.3 从指标到告警的核心挑战</h3>
<p>node_exporter 给了我们"事实"：</p>
<pre><code class="hljs language-ini" lang="ini">node_cpu_seconds_total{<span class="hljs-attr">mode</span>=<span class="hljs-string">"user"</span>} <span class="hljs-number">123456</span>   <span class="hljs-comment"># CPU 累计时间</span>
node_memory_MemAvailable_bytes 8388608000    <span class="hljs-comment"># 可用内存</span>
node_filesystem_avail_bytes 53687091200      <span class="hljs-comment"># 磁盘可用空间</span>
</code></pre>
<p>但这些是 Counter 和 Gauge，怎么变成告警？</p>
<p><strong>三个核心问题：</strong></p>
<ol>
<li><strong>阈值怎么定？</strong> —— 80% 合适还是 90% 合适？</li>
<li><strong>怎么过滤毛刺？</strong> —— 短暂峰值要不要告警？</li>
<li><strong>如何提前预警？</strong> —— 等到真出问题才告是不是太晚了？</li>
</ol>
<p>接下来，我们用 CPU、内存、磁盘、网络四个维度，看看如何设计告警规则。</p>
<hr/>
<h2 data-id="heading-4">2. CPU 告警：不只是设个 80%</h2>
<h3 data-id="heading-5">2.1 错误示例</h3>
<p>很多人第一反应是这样：</p>
<pre><code class="hljs language-promql" lang="promql"># 错误示例：CPU 使用率 &gt; 80% 就告警
(1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m]))) * 100 &gt; 80
</code></pre>
<p><strong>会发生什么？</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">10:00 - CPU 85%（代码编译，正常）  → 告警</span>
<span class="hljs-section">10:01 - CPU 60%（编译结束）        → 恢复</span>
<span class="hljs-section">10:05 - CPU 85%（定时任务，正常）  → 告警</span>
<span class="hljs-section">10:06 - CPU 50%                    → 恢复</span>

一天收到几十条告警，都是正常的业务波动。
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>没有时间维度，瞬时峰值也告警</li>
<li>80% 的阈值太低，正常繁忙就会触发</li>
<li>不区分"临时忙"和"持续忙"</li>
</ul>
<h3 data-id="heading-6">2.2 正确示例 1：加上时间维度</h3>
<pre><code class="hljs language-promql" lang="promql"># 正确示例：CPU 持续 10 分钟 &gt; 90%
(1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) by (instance)) * 100 &gt; 90
for: 10m
</code></pre>
<p><strong>改进点：</strong></p>

























<table><thead><tr><th>参数</th><th>值</th><th>作用</th></tr></thead><tbody><tr><td><code>[5m]</code></td><td>评估窗口</td><td>平滑 15 秒抓取间隔的抖动</td></tr><tr><td><code>&gt; 90</code></td><td>阈值提高</td><td>留 10% 缓冲，避免误报</td></tr><tr><td><code>for: 10m</code></td><td>持续时长</td><td>过滤临时波动（编译、备份）</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[首次超过 90%] --&gt; B[观察 10 分钟]
    B --&gt; C{持续超过?}
    C --&gt;|是| D[触发告警]
    C --&gt;|否| E[取消]
    
    style A fill:#fff4e1
    style D fill:#ffcccc
    style E fill:#ccffcc
</code></pre>
<p><strong>效果：</strong></p>
<ul>
<li>短暂的编译、备份不会告警</li>
<li>只有真正持续繁忙才告警</li>
<li>误报率从 80% 降到 &lt; 10%</li>
</ul>
<h3 data-id="heading-7">2.3 正确示例 2：区分 CPU 模式</h3>
<p>整机 CPU 告诉你"忙不忙"，但不知道"为什么忙"。</p>
<pre><code class="hljs language-promql" lang="promql"># 用户态 CPU 过高 → 应用代码效率问题
avg(rate(node_cpu_seconds_total{mode="user"}[5m])) by (instance) &gt; 0.8
for: 10m

# 系统态 CPU 过高 → 系统调用过多（网络/磁盘 IO）
avg(rate(node_cpu_seconds_total{mode="system"}[5m])) by (instance) &gt; 0.3
for: 10m

# iowait 过高 → 磁盘 IO 瓶颈
avg(rate(node_cpu_seconds_total{mode="iowait"}[5m])) by (instance) &gt; 0.2
for: 5m
</code></pre>
<p><strong>价值：不只知道"CPU 高"，还知道"为什么高"。</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景 <span class="hljs-number">1</span>：整机 CPU <span class="hljs-number">90</span><span class="hljs-comment">%，同时 user 高</span>
→ 运维：应用代码有问题，去排查业务

场景 <span class="hljs-number">2</span>：整机 CPU <span class="hljs-number">90</span><span class="hljs-comment">%，同时 iowait 高</span>
→ 运维：磁盘 IO 慢，去排查磁盘

场景 <span class="hljs-number">3</span>：整机 CPU <span class="hljs-number">90</span><span class="hljs-comment">%，同时 system 高</span>
→ 运维：系统调用多，可能是网络问题
</code></pre>
<p>这就是区分模式的价值：同样是 CPU 90%，但问题的根因完全不同，处理方式也不同。</p>
<hr/>
<h2 data-id="heading-8">3. 内存告警：Linux 的内存不是你想的那样</h2>
<h3 data-id="heading-9">3.1 错误示例</h3>
<pre><code class="hljs language-promql" lang="promql"># 错误示例：用 MemFree 计算使用率
(1 - node_memory_MemFree_bytes / node_memory_MemTotal_bytes) * 100 &gt; 90
</code></pre>
<p><strong>会发生什么？</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">16G 内存的服务器：
<span class="hljs-section">MemTotal: 16G</span>
<span class="hljs-section">MemFree:  1G   (真正空闲)</span>
<span class="hljs-section">Cached:   8G   (文件缓存，可释放)</span>

错误计算：使用率 = (16 - 1) / 16 = 93.75%
→ 告警：<span class="hljs-string">"内存不足！"</span>
→ 运维登录查看
→ 发现 8G 是 cache，随时可以释放
→ 误报！
</code></pre>
<p><strong>问题：不理解 Linux 内存管理机制。</strong></p>
<p>Linux 会把空闲内存用来做 cache，提升文件读取性能。这些 cache 在应用需要内存时会自动释放，不应该算作"已使用"。</p>
<h3 data-id="heading-10">3.2 正确示例 1：用 MemAvailable</h3>
<pre><code class="hljs language-promql" lang="promql"># 正确示例：用 MemAvailable 计算
(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 &gt; 90
for: 5m
</code></pre>
<p><strong>MemAvailable 是什么？</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">MemAvailable</span> = MemFree + 可回收的 Cache + 可回收的 Buffer
</code></pre>
<p>这才是真正可用的内存。</p>
<blockquote>
<p>注意：<code>node_memory_MemAvailable_bytes</code> 在 node_exporter v0.16+ 版本才可用。如果你的版本较旧，需要先升级。</p>
</blockquote>
<p><strong>对比：</strong></p>
<pre><code class="hljs language-ini" lang="ini">场景：16G 内存服务器

MemFree:      1G
Cached:       8G (可回收)
MemAvailable: 9G

用 MemFree：
使用率 = (16 - 1) / <span class="hljs-attr">16</span> = <span class="hljs-number">93.75</span>%  → 误报

用 MemAvailable：
使用率 = (16 - 9) / <span class="hljs-attr">16</span> = <span class="hljs-number">43.75</span>%  → 正确
</code></pre>
<h3 data-id="heading-11">3.3 正确示例 2：预测未来耗尽</h3>
<p>当前可用内存充足，但如果有内存泄漏，迟早会耗尽。</p>
<pre><code class="hljs language-promql" lang="promql"># 预测 4 小时后可用内存是否耗尽
predict_linear(node_memory_MemAvailable_bytes[1h], 4*3600) &lt; 0
for: 10m
</code></pre>
<p><strong>predict_linear 的原理：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[过去 1 小时数据] --&gt; B[线性回归]
    B --&gt; C[预测 4 小时后]
    C --&gt; D{&lt; 0?}
    D --&gt;|是| E[告警]
    
    style A fill:#e1f5ff
    style E fill:#ffcccc
</code></pre>
<p><strong>案例：</strong></p>
<pre><code class="hljs language-ini" lang="ini">10:00 - <span class="hljs-attr">MemAvailable</span> = <span class="hljs-number">10</span>G
10:30 - <span class="hljs-attr">MemAvailable</span> = <span class="hljs-number">8</span>G
11:00 - <span class="hljs-attr">MemAvailable</span> = <span class="hljs-number">6</span>G

每小时下降 4G
→ 预测 4 小时后：6G - <span class="hljs-attr">16G</span> = -<span class="hljs-number">10</span>G &lt; <span class="hljs-number">0</span>
→ 触发告警："预计 4 小时后内存耗尽"
</code></pre>
<p><strong>价值：提前 4 小时发现风险，而不是等到真的耗尽。</strong></p>
<p>这就是 <code>predict_linear()</code> 的威力：从"被动应对"变成"主动预防"。</p>
<hr/>
<h2 data-id="heading-12">4. 磁盘告警：当前值和未来趋势</h2>
<h3 data-id="heading-13">4.1 错误示例</h3>
<pre><code class="hljs language-promql" lang="promql"># 错误示例：磁盘使用率 &gt; 85% 就告警
(1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 &gt; 85
</code></pre>
<p><strong>会发生什么？</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景 <span class="hljs-number">1</span>：磁盘使用率 <span class="hljs-number">86</span><span class="hljs-comment">%，但日志增长很快</span>
→ 触发告警
→ 运维去清理日志
→ 但 <span class="hljs-number">2</span> 小时后磁盘满了
→ 服务挂了

为什么？因为 <span class="hljs-number">85</span><span class="hljs-comment">% 的阈值太晚了！</span>
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>不知道磁盘增长速度</li>
<li>等到 85% 再告警，可能来不及处理</li>
<li>没有考虑"未来会怎样"</li>
</ul>
<h3 data-id="heading-14">4.2 正确示例 1：预测式告警</h3>
<pre><code class="hljs language-promql" lang="promql"># 基于过去 6 小时数据，预测 24 小时后磁盘是否满
predict_linear(node_filesystem_avail_bytes[6h], 24*3600) &lt; 0
for: 1h
</code></pre>
<p><strong>价值：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景 <span class="hljs-number">1</span>：磁盘使用率 <span class="hljs-number">82</span><span class="hljs-comment">%，但增长很快</span>
→ 规则 <span class="hljs-number">1</span> 告警：<span class="hljs-string">"预测 24h 后满"</span>
→ 运维：优先处理，明天就会满

场景 <span class="hljs-number">2</span>：磁盘使用率 <span class="hljs-number">82</span><span class="hljs-comment">%，但增长很慢</span>
→ 规则 <span class="hljs-number">1</span> 不告警：预测 <span class="hljs-number">7</span> 天后才满
→ 运维：不紧急，排期清理即可
</code></pre>
<p><strong>同样是 82%，但处理优先级完全不同。</strong></p>
<h3 data-id="heading-15">4.3 正确示例 2：容量和 IO 分开</h3>
<p>磁盘有两类问题：</p>
<ul>
<li><strong>容量问题</strong>：快满了</li>
<li><strong>性能问题</strong>：IO 慢了</li>
</ul>
<pre><code class="hljs language-promql" lang="promql"># 容量告警：使用率 &gt; 90%
# 注意：过滤掉临时目录和虚拟文件系统
(1 - node_filesystem_avail_bytes{
    fstype=~"ext4|xfs",
    mountpoint!~"/tmp|/var/lib/docker|/boot"
  } / node_filesystem_size_bytes) * 100 &gt; 90
for: 10m

# 性能告警：IO 使用率 &gt; 80%
rate(node_disk_io_time_seconds_total{device=~"sd.*|vd.*"}[5m]) &gt; 0.8
for: 10m

# 性能告警：IO 队列长度 &gt; 10
rate(node_disk_io_time_weighted_seconds_total{device=~"sd.*|vd.*"}[5m]) &gt; 10
for: 5m
</code></pre>
<p><strong>为什么要过滤路径？</strong></p>
<pre><code class="hljs language-diff" lang="diff">不需要告警的挂载点：
<span class="hljs-deletion">- /tmp：临时目录，满了也无所谓</span>
<span class="hljs-deletion">- /var/lib/docker：容器存储，由 Docker 管理</span>
<span class="hljs-deletion">- /boot：引导分区，通常很小且不会变化</span>

只关注业务数据盘：
<span class="hljs-deletion">- /：根分区</span>
<span class="hljs-deletion">- /data：数据分区</span>
<span class="hljs-deletion">- /home：用户目录</span>
</code></pre>
<p><strong>为什么要分开？</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">场景</span> <span class="hljs-number">1</span><span class="hljs-string">：磁盘使用率</span> <span class="hljs-number">50</span><span class="hljs-string">%，但</span> <span class="hljs-string">IO</span> <span class="hljs-string">队列很长</span>
<span class="hljs-string">→</span> <span class="hljs-string">容量充足，但性能差</span>
<span class="hljs-string">→</span> <span class="hljs-string">需要优化</span> <span class="hljs-string">IO（换</span> <span class="hljs-string">SSD、减少小文件操作）</span>

<span class="hljs-string">场景</span> <span class="hljs-number">2</span><span class="hljs-string">：磁盘使用率</span> <span class="hljs-number">95</span><span class="hljs-string">%，但</span> <span class="hljs-string">IO</span> <span class="hljs-string">正常</span>
<span class="hljs-string">→</span> <span class="hljs-string">容量不足，但性能正常</span>
<span class="hljs-string">→</span> <span class="hljs-string">需要清理磁盘或扩容</span>

<span class="hljs-string">两类问题，两种处理方式。</span>

<span class="hljs-string">**运维口诀**：容量看趋势，性能看队列。</span>

<span class="hljs-meta">---
</span>
<span class="hljs-comment">## 5. 网络告警：流量和错误</span>

<span class="hljs-comment">### 5.1 错误示例</span>

<span class="hljs-string">```promql</span>
<span class="hljs-comment"># 错误示例：网络流量 &gt; 100MB/s 就告警</span>
<span class="hljs-string">rate(node_network_receive_bytes_total[5m])</span> <span class="hljs-string">/</span> <span class="hljs-number">1024</span> <span class="hljs-string">/</span> <span class="hljs-number">1024</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">100</span>
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>100MB/s 对千兆网卡是正常的（125MB/s 满载）</li>
<li>没有区分"流量大"和"异常流量"</li>
<li>没有考虑错误率</li>
</ul>
<h3 data-id="heading-16">5.2 正确示例：流量 + 错误率</h3>
<pre><code class="hljs language-promql" lang="promql"># 网络流量超过带宽的 80%
# 注意：排除回环接口和虚拟接口
rate(node_network_receive_bytes_total{
    device!~"lo|docker.*|veth.*|br-.*"
  }[5m]) / (node_network_speed_bytes * 0.8) &gt; 1
for: 5m

# 网络错误率 &gt; 0.1%
rate(node_network_receive_errs_total{
    device!~"lo|docker.*|veth.*|br-.*"
  }[5m]) 
/ 
rate(node_network_receive_packets_total{
    device!~"lo|docker.*|veth.*|br-.*"
  }[5m]) &gt; 0.001
for: 5m
</code></pre>
<p><strong>为什么要过滤接口？</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">不需要监控的网络接口：
<span class="hljs-bullet">-</span> lo：回环接口，本地通信
<span class="hljs-bullet">-</span> docker0, br-<span class="hljs-emphasis">*：Docker 网桥
- veth*</span>：容器虚拟网卡

只监控物理网卡：
<span class="hljs-bullet">-</span> eth0, eth1：传统命名
<span class="hljs-bullet">-</span> ens<span class="hljs-emphasis">*, enp*</span>：systemd 命名
<span class="hljs-bullet">-</span> bond<span class="hljs-emphasis">*：网卡绑定
</span></code></pre>
<p><strong>改进点：</strong></p>
<ul>
<li>相对阈值（带宽的 80%）而不是绝对值</li>
<li>关注错误率，不只是流量</li>
<li>错误率 0.1% 很小，但可能是硬件问题的信号</li>
</ul>
<p><strong>场景：</strong></p>
<pre><code class="hljs">场景 1：流量高，错误率正常
→ 业务正常繁忙，无需告警

场景 2：流量正常，错误率高
→ 网卡/交换机有问题，需要排查硬件

场景 3：流量高，错误率也高
→ 可能是 DDoS 攻击或网络故障
</code></pre>
<hr/>
<h2 data-id="heading-17">6. 告警规则设计方法论</h2>
<p>基于上面的案例，可以总结出告警规则设计的三个维度：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    A[告警规则设计] --&gt; B[时间维度]
    A --&gt; C[严重程度]
    A --&gt; D[业务上下文]
    
    B --&gt; E[评估窗口: 5m/15m&lt;br/&gt;平滑抖动]
    B --&gt; F[持续时长: for 10m&lt;br/&gt;过滤毛刺]
    
    C --&gt; G[P0: 服务不可用&lt;br/&gt;立即处理]
    C --&gt; H[P1: 性能下降&lt;br/&gt;1小时内]
    C --&gt; I[P2: 资源紧张&lt;br/&gt;当天处理]
    
    D --&gt; J[区分场景&lt;br/&gt;生产/测试]
    D --&gt; K[关联指标&lt;br/&gt;多维度判断]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffcccc
    style D fill:#ccffcc
</code></pre>
<h3 data-id="heading-18">6.1 时间维度</h3>
<p><strong>评估窗口 <code>[5m]</code>：</strong></p>
<ul>
<li>作用：平滑 15 秒抓取间隔的抖动</li>
<li>选择：CPU/内存用 5m，磁盘用 6h（变化慢）</li>
</ul>
<p><strong>持续时长 <code>for: 10m</code>：</strong></p>
<ul>
<li>作用：过滤短暂峰值</li>
<li>选择：CPU 用 10m，磁盘用 1h（不需要那么敏感）</li>
</ul>
<h3 data-id="heading-19">6.2 严重程度</h3>
<p><strong>三个级别：</strong></p>





























<table><thead><tr><th>级别</th><th>含义</th><th>响应时间</th><th>典型场景</th></tr></thead><tbody><tr><td>P0</td><td>服务不可用</td><td>立即</td><td>磁盘满、OOM</td></tr><tr><td>P1</td><td>性能下降</td><td>1 小时内</td><td>CPU 95%、内存 95%</td></tr><tr><td>P2</td><td>资源紧张</td><td>当天</td><td>CPU 85%、磁盘 80%</td></tr></tbody></table>
<p><strong>设计原则：</strong></p>
<ul>
<li>P0 的 <code>for</code> 更短（5m），不能等太久</li>
<li>P2 的 <code>for</code> 更长（30m），避免误报</li>
</ul>
<h3 data-id="heading-20">6.3 业务上下文</h3>
<p><strong>区分场景：</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 生产环境 90% 告警
cpu_usage{env="prod"} &gt; 0.9

# 测试环境 95% 告警（更宽松）
cpu_usage{env="test"} &gt; 0.95
</code></pre>
<p><strong>关联指标：</strong></p>
<pre><code class="hljs language-promql" lang="promql"># CPU 高 + iowait 高 → 可能是磁盘慢
cpu_usage &gt; 0.9 and cpu_iowait &gt; 0.2

# CPU 高 + 网络流量高 → 可能是网络处理
cpu_usage &gt; 0.9 and network_traffic &gt; 100MB/s
</code></pre>
<p>这就是"因地制宜"的价值：不同场景用不同规则，不能一刀切。</p>
<hr/>
<h2 data-id="heading-21">7. 好的告警系统应该解决什么问题</h2>
<p>有了规则，还需要一个引擎来执行。好的告警系统应该解决这些问题：</p>
<h3 data-id="heading-22">7.1 Fingerprint：告警实例的唯一标识</h3>
<p>同一个规则可能命中多个实例：</p>
<pre><code class="hljs language-ini" lang="ini">规则: CPU 使用率 &gt; 90%

命中:
- {<span class="hljs-attr">instance</span>=<span class="hljs-string">"server-01"</span>, env=<span class="hljs-string">"prod"</span>} → Fingerprint = <span class="hljs-string">"abc123"</span>
- {<span class="hljs-attr">instance</span>=<span class="hljs-string">"server-02"</span>, env=<span class="hljs-string">"prod"</span>} → Fingerprint = <span class="hljs-string">"def456"</span>
</code></pre>
<p><strong>Fingerprint = hash(rule_id + labels)</strong></p>
<p>每个 Fingerprint 是一个独立的告警，需要单独追踪：</p>
<ul>
<li>什么时候开始的？</li>
<li>触发了几次？</li>
<li>现在状态如何？</li>
</ul>
<h3 data-id="heading-23">7.2 防抖动：避免告警风暴</h3>
<p><strong>两层防抖：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[首次命中] --&gt; B[pending&lt;br/&gt;观察期]
    B --&gt; C{持续 &gt;= for?}
    C --&gt;|是| D[firing&lt;br/&gt;确认告警]
    C --&gt;|否| A
    D --&gt; E{5分钟内重复?}
    E --&gt;|是| F[跳过处理]
    E --&gt;|否| G[写库/通知]
    
    style B fill:#fff4e1
    style D fill:#ffcccc
    style F fill:#cccccc
    style G fill:#ccffcc
</code></pre>
<p><strong>第一层：for_duration（规则层）</strong></p>
<ul>
<li>持续 10 分钟才从 pending 转为 firing</li>
<li>过滤短暂毛刺</li>
</ul>
<p><strong>第二层：时间窗口去重（消费层）</strong></p>
<ul>
<li>5 分钟内同一告警只处理一次</li>
<li>避免频繁写库和通知</li>
</ul>
<h3 data-id="heading-24">7.3 可扩展：插件化数据源</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[告警引擎] --&gt; B[Prometheus&lt;br/&gt;指标]
    A --&gt; C[日志扫描&lt;br/&gt;关键字]
    A --&gt; D[SQL 查询&lt;br/&gt;数据库]
    A --&gt; E[黑盒探测&lt;br/&gt;HTTP/TCP]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#ffcccc
    style E fill:#ccffcc
</code></pre>
<p>不只是 Prometheus 指标，还可以扩展：</p>
<ul>
<li>日志关键字（如"OutOfMemoryError"）</li>
<li>SQL 规则（如"超时订单 &gt; 100"）</li>
<li>黑盒探测（如"API 5xx 错误"）</li>
</ul>
<h3 data-id="heading-25">7.4 静默管理：计划性维护</h3>
<p><strong>场景：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">晚上 <span class="hljs-number">22</span>:<span class="hljs-number">00</span>-<span class="hljs-number">23</span>:<span class="hljs-number">00</span> 发布新版本
→ 服务会重启
→ CPU 会短暂 <span class="hljs-number">100</span><span class="hljs-comment">%</span>
→ 不应该告警
</code></pre>
<p><strong>解决方案：时间窗口静默</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">静默规则:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"发布窗口"</span>
  <span class="hljs-attr">start:</span> <span class="hljs-string">"22:00"</span>
  <span class="hljs-attr">end:</span> <span class="hljs-string">"23:00"</span>
  <span class="hljs-attr">match:</span>
    <span class="hljs-attr">env:</span> <span class="hljs-string">"prod"</span>
    <span class="hljs-attr">service:</span> <span class="hljs-string">"api"</span>
</code></pre>
<p>在发布窗口内，匹配的告警自动静默，不发通知。</p>
<h3 data-id="heading-26">7.5 告警历史：可追溯和分析</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 历史告警表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> history_alerts (
  fingerprint <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>),
  rule_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),
  start_at DATETIME,
  end_at DATETIME,
  duration <span class="hljs-type">INT</span>,
  trigger_count <span class="hljs-type">INT</span>
);
</code></pre>
<p><strong>价值：</strong></p>
<ul>
<li>查看某台服务器过去一周的告警次数</li>
<li>分析哪些规则误报率高</li>
<li>计算平均恢复时间（MTTR）</li>
</ul>
<p>告警历史不只是记录，更是持续改进的基础。没有数据就没有优化，好的系统要能自我进化。</p>
<hr/>
<h2 data-id="heading-27">8. 总结</h2>
<h3 data-id="heading-28">8.1 从指标到告警的核心思想</h3>
<p><strong>不是简单设阈值，而是：</strong></p>
<ol>
<li>
<p><strong>理解指标的本质</strong></p>
<ul>
<li>CPU 是累计时间，要用 rate() 转成使用率</li>
<li>内存要用 MemAvailable，不是 MemFree</li>
<li>磁盘要看趋势，不只看当前值</li>
</ul>
</li>
<li>
<p><strong>加上时间维度</strong></p>
<ul>
<li>评估窗口 <code>[5m]</code> 平滑抖动</li>
<li>持续时长 <code>for: 10m</code> 过滤毛刺</li>
</ul>
</li>
<li>
<p><strong>考虑业务上下文</strong></p>
<ul>
<li>区分生产和测试环境</li>
<li>关联多个指标（CPU + iowait）</li>
<li>预测未来（predict_linear）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-29">8.2 好的告警规则长什么样</h3>






























<table><thead><tr><th>维度</th><th>坏规则</th><th>好规则</th></tr></thead><tbody><tr><td><strong>阈值</strong></td><td>CPU &gt; 80%</td><td>CPU &gt; 90%，for: 10m</td></tr><tr><td><strong>指标</strong></td><td>只看一个指标</td><td>关联多个指标</td></tr><tr><td><strong>时间</strong></td><td>只看当前值</td><td>看趋势（predict_linear）</td></tr><tr><td><strong>上下文</strong></td><td>一刀切</td><td>区分场景（生产/测试）</td></tr></tbody></table>
<h3 data-id="heading-30">8.3 好的告警系统解决什么问题</h3>
<p><strong>五个核心能力：</strong></p>
<ol>
<li><strong>Fingerprint</strong> —— 每个告警实例有唯一标识</li>
<li><strong>防抖动</strong> —— 两层过滤（for + 时间窗口去重）</li>
<li><strong>可扩展</strong> —— 不只是 Prometheus，还能接其他数据源</li>
<li><strong>静默管理</strong> —— 计划性维护不告警</li>
<li><strong>历史追溯</strong> —— 可分析、可改进</li>
</ol>
<h3 data-id="heading-31">8.4 三个核心洞察</h3>
<p>看完这篇文章，记住这三点就够了：</p>
<p><strong>1. 好的告警要能定位问题</strong></p>
<p>不只说"CPU 高"，还要说"是 user 高还是 iowait 高"。不只告诉你有问题，还要告诉你什么问题。</p>
<p><strong>2. 好的告警要能预测未来</strong></p>
<p>用 <code>predict_linear()</code> 提前 4 小时、24 小时发现风险，而不是等到真的出问题才知道。从"被动应对"变成"主动预防"。</p>
<p><strong>3. 好的系统要能自我进化</strong></p>
<p>记录告警历史，分析误报率，持续优化规则。没有数据就没有改进，没有历史就没有进化。</p>
<hr/>
<h2 data-id="heading-32">附录：告警规则自查清单</h2>
<p>在上线告警规则前，用这个清单检查一遍：</p>
<h3 data-id="heading-33">CPU 告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了 <code>rate()</code> 而不是直接用 Counter 值？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 阈值是否 &gt;= 90%（而不是 80%）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否设置了 <code>for: 10m</code> 持续时长？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否区分了 user/system/iowait 模式？</li>
</ul>
<h3 data-id="heading-34">内存告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了 <code>MemAvailable</code> 而不是 <code>MemFree</code>？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 版本是否 &gt;= node_exporter v0.16？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了 <code>predict_linear()</code> 预测未来？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> P0 告警阈值是否 &gt;= 95%？</li>
</ul>
<h3 data-id="heading-35">磁盘告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 容量告警是否使用了 <code>predict_linear()</code>？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否过滤了 <code>/tmp</code>、<code>/boot</code> 等临时目录？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否只监控 <code>ext4</code> 和 <code>xfs</code> 文件系统？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否分别设置了容量告警和 IO 告警？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> IO 告警是否过滤了设备类型（如 <code>device=~"sd.*|vd.*"</code>）？</li>
</ul>
<h3 data-id="heading-36">网络告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否过滤了 <code>lo</code>、<code>docker0</code>、<code>veth*</code> 等虚拟接口？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 流量告警是否使用了相对阈值（带宽的 80%）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否同时监控了流量和错误率？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 错误率阈值是否足够敏感（如 0.1%）？</li>
</ul>
<h3 data-id="heading-37">通用检查</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 所有规则是否都设置了 <code>for</code> 持续时长？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> P0/P1/P2 的严重级别是否合理？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否区分了生产和测试环境？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 规则名称是否清晰表达了告警内容？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否添加了 <code>annotations</code> 描述？</li>
</ul>
<hr/>
<h2 data-id="heading-38">快速参考：核心规则速查</h2>











































































<table><thead><tr><th>监控项</th><th>推荐规则</th><th>阈值</th><th>for</th><th>说明</th></tr></thead><tbody><tr><td><strong>CPU 整机</strong></td><td><code>(1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m]))) &gt; 0.9</code></td><td>90%</td><td>10m</td><td>基础告警</td></tr><tr><td><strong>CPU iowait</strong></td><td><code>avg(rate(node_cpu_seconds_total{mode="iowait"}[5m])) &gt; 0.2</code></td><td>20%</td><td>5m</td><td>磁盘瓶颈</td></tr><tr><td><strong>内存可用</strong></td><td><code>(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) &gt; 0.9</code></td><td>90%</td><td>5m</td><td>基础告警</td></tr><tr><td><strong>内存预测</strong></td><td><code>predict_linear(node_memory_MemAvailable_bytes[1h], 4*3600) &lt; 0</code></td><td>-</td><td>10m</td><td>提前预警</td></tr><tr><td><strong>磁盘容量</strong></td><td><code>(1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) &gt; 0.9</code></td><td>90%</td><td>10m</td><td>基础告警</td></tr><tr><td><strong>磁盘预测</strong></td><td><code>predict_linear(node_filesystem_avail_bytes[6h], 24*3600) &lt; 0</code></td><td>-</td><td>1h</td><td>提前预警</td></tr><tr><td><strong>磁盘 IO</strong></td><td><code>rate(node_disk_io_time_seconds_total[5m]) &gt; 0.8</code></td><td>80%</td><td>10m</td><td>性能问题</td></tr><tr><td><strong>网络流量</strong></td><td><code>rate(node_network_receive_bytes_total[5m]) / node_network_speed_bytes &gt; 0.8</code></td><td>80%</td><td>5m</td><td>带宽瓶颈</td></tr><tr><td><strong>网络错误</strong></td><td><code>rate(node_network_receive_errs_total[5m]) / rate(node_network_receive_packets_total[5m]) &gt; 0.001</code></td><td>0.1%</td><td>5m</td><td>硬件问题</td></tr></tbody></table>
<hr/>
<p><strong>从 node_exporter 的指标，到生产级的告警规则，核心是一套设计思想：</strong></p>
<ul>
<li>理解本质（指标的含义）</li>
<li>加上时间（评估窗口 + 持续时长）</li>
<li>结合上下文（业务场景 + 关联指标）</li>
<li>持续迭代（追踪历史 + 质量改进）</li>
</ul>
<p>这不是一篇操作手册，而是一套方法论。掌握了这套思想，你就能设计出适合自己业务的告警规则。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot LiquibasePlus 数据库版本管理工具加强使用指南]]></title>    <link>https://juejin.cn/post/7590403249561583631</link>    <guid>https://juejin.cn/post/7590403249561583631</guid>    <pubDate>2026-01-04T01:59:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249561583631" data-draft-id="7540566577622614079" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot LiquibasePlus 数据库版本管理工具加强使用指南"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-04T01:59:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="昵称为空C"/> <meta itemprop="url" content="https://juejin.cn/user/1267096172897005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot LiquibasePlus 数据库版本管理工具加强使用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1267096172897005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    昵称为空C
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:59:52.000Z" title="Sun Jan 04 2026 01:59:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：本文主要介绍了基于<code>springboot</code>+<code>liquibase</code>的数据库版本管理工具的使用说明；案例封装了<code>liquibase</code>的功能进行了业务增强，让实际生成环境使用更省心。</p>
<h2 data-id="heading-0">直接使用会遇到的问题</h2>
<ul>
<li>异常退出导致<code>databasechangeloglock</code>锁表，需要手动清理数据。</li>
<li>无法满足多租户使用。</li>
<li>无法满足多数据库适配。</li>
</ul>
<h2 data-id="heading-1"><code>LiquibasePlus</code>封装案例</h2>
<blockquote>
<p>只是在<code>Liquibase</code>上做了功能增强。</p>
</blockquote>
<h3 data-id="heading-2"><code>pom.xml</code></h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.liquibase<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>liquibase-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3"><code>LiquibaseApplication</code></h3>
<blockquote>
<p>启动类</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LiquibaseApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">LiquibaseApplication</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<h3 data-id="heading-4"><code>application.yml</code></h3>
<blockquote>
<p>配置文件</p>
</blockquote>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.8.134:30635/test_1?useSSL=false&amp;serverTimezone=UTC</span>
  <span class="hljs-attr">liquibase:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">liquibase-plus:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://192.168.8.134:30635/test_1?useSSL=false&amp;serverTimezone=UTC</span>
    <span class="hljs-attr">change-log:</span> <span class="hljs-string">classpath*:sql/mysql/changelog.xml</span>
</code></pre>
<h3 data-id="heading-5"><code>SpringLiquibasePlusProperties</code></h3>
<blockquote>
<p>属性配置类</p>
</blockquote>
<pre><code class="hljs language-arduino" lang="arduino">@Data
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringLiquibasePlusProperties</span> {

    <span class="hljs-comment">/** 是否开启 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enabled;
    <span class="hljs-comment">/** 驱动名称 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> driverClassName;
    <span class="hljs-comment">/** 链接地址 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> jdbcUrl;
    <span class="hljs-comment">/** 用户名 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> username;
    <span class="hljs-comment">/** 密码 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> password;
    <span class="hljs-comment">/** 数据库schema */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> schema;
    <span class="hljs-comment">/** 变更日志 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> changeLog;

}
</code></pre>
<h3 data-id="heading-6"><code>SpringLiquibasePlusExecutor</code></h3>
<blockquote>
<p><code>liquibase</code>执行器</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Slf</span>4j
public class SpringLiquibasePlusExecutor {

    private final ResourceLoader resourceLoader;

    public <span class="hljs-built_in">SpringLiquibasePlusExecutor</span>(ResourceLoader resourceLoader) {
        this<span class="hljs-selector-class">.resourceLoader</span> = resourceLoader;
    }

    <span class="hljs-comment">/**
     * 初始化数据库
     * @param properties
     */</span>
    public void <span class="hljs-built_in">execute</span>(SpringLiquibasePlusProperties properties) throws Exception{
        <span class="hljs-built_in">try</span>(HikariDataSource hikariDataSource = this.buildDataSource(properties)) {
            SpringLiquibase liquibase = new <span class="hljs-built_in">SpringLiquibase</span>();
            liquibase<span class="hljs-selector-class">.setDataSource</span>(hikariDataSource);
            liquibase<span class="hljs-selector-class">.setResourceLoader</span>(resourceLoader);
            liquibase<span class="hljs-selector-class">.setDatabaseChangeLogTable</span>("databasechangelog");
            liquibase<span class="hljs-selector-class">.setDatabaseChangeLogLockTable</span>("databasechangeloglock");
            <span class="hljs-comment">//指定changelog的位置，这里使用的一个master文件引用其他文件的方式</span>
            liquibase<span class="hljs-selector-class">.setChangeLog</span>(properties.getChangeLog());
            liquibase<span class="hljs-selector-class">.setShouldRun</span>(true);
            <span class="hljs-comment">// 检查锁表的情况</span>
            <span class="hljs-built_in">removeTimeoutLock</span>(hikariDataSource, liquibase.getDatabaseChangeLogLockTable());
            liquibase<span class="hljs-selector-class">.afterPropertiesSet</span>();
        }
    }

    <span class="hljs-comment">/**
     * 构建数据源
     * @param properties
     * @return
     */</span>
    private HikariDataSource <span class="hljs-built_in">buildDataSource</span>(SpringLiquibasePlusProperties properties){
        HikariDataSource hikariDataSource = new <span class="hljs-built_in">HikariDataSource</span>();
        hikariDataSource<span class="hljs-selector-class">.setDriverClassName</span>(properties.getDriverClassName());
        hikariDataSource<span class="hljs-selector-class">.setJdbcUrl</span>(properties.getJdbcUrl());
        hikariDataSource<span class="hljs-selector-class">.setUsername</span>(properties.getUsername());
        hikariDataSource<span class="hljs-selector-class">.setPassword</span>(properties.getPassword());
        hikariDataSource<span class="hljs-selector-class">.setSchema</span>(properties.getSchema());
        hikariDataSource<span class="hljs-selector-class">.setMinimumIdle</span>(<span class="hljs-number">1</span>);
        hikariDataSource<span class="hljs-selector-class">.setMaximumPoolSize</span>(<span class="hljs-number">1</span>);
        return hikariDataSource;
    }

    <span class="hljs-comment">/**
     * 移除超时的锁
     * 如果要写得更好，先判断表存在没有，存在了再执行SQL语句，我这里捕获异常处理的
     * @param dataSource
     * @param tableName
     */</span>
    public void <span class="hljs-built_in">removeTimeoutLock</span>(DataSource dataSource, String tableName){
        <span class="hljs-comment">// 超时5分钟就认为超时，这里可以自己自定义</span>
        Timestamp lastDBLockTime = new <span class="hljs-built_in">Timestamp</span>(new java.util.Date()<span class="hljs-selector-class">.getTime</span>() - (<span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>));
        <span class="hljs-comment">// 这里的SQL语句需要按照自己的数据库方式来，现阶段我就遇到`oracle`写法不一样</span>
        String sql = String<span class="hljs-selector-class">.format</span>("UPDATE %s SET LOCKED = <span class="hljs-number">0</span>, LOCKGRANTED = NULL, LOCKEDBY = NULL WHERE LOCKED = <span class="hljs-number">1</span> AND LOCKGRANTED &lt; '%s'", tableName, lastDBLockTime);

        try (Connection connection = dataSource.getConnection(); Statement stmt = connection<span class="hljs-selector-class">.createStatement</span>()) {
            int updateCount = stmt<span class="hljs-selector-class">.executeUpdate</span>(sql);
            <span class="hljs-built_in">if</span>(updateCount &gt; <span class="hljs-number">0</span>){
                log<span class="hljs-selector-class">.info</span>("liquibase异常锁解除成功");
            }else {
                log<span class="hljs-selector-class">.info</span>("liquibase无异常锁");
            }
        } catch (Exception ex) {
            <span class="hljs-built_in">if</span>(!(ex instanceof SQLException)){
                <span class="hljs-comment">// 直接跳过不用处理异常了</span>
                log<span class="hljs-selector-class">.error</span>("liquibase解锁异常", ex);
            }else {
                log<span class="hljs-selector-class">.warn</span>("liquibase初次加载");
            }
        }
    }

}
</code></pre>
<h3 data-id="heading-7"><code>SpringLiquibasePlusConfig</code>启动配置</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Slf4j</span>
<span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@ConditionalOnProperty</span>(
        prefix = <span class="hljs-string">"spring.liquibase-plus"</span>,
        name = {<span class="hljs-string">"enabled"</span>}
)
public class SpringLiquibasePlusConfig {

    <span class="hljs-variable">@Autowired</span>
    private ResourceLoader resourceLoader;
    <span class="hljs-variable">@Autowired</span>
    private List&lt;CustomTaskChange&gt; customTaskChanges;

    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.liquibase-plus"</span>,ignoreUnknownFields = false)
    public SpringLiquibasePlusProperties <span class="hljs-built_in">springLiquibasePlusProperties</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SpringLiquibasePlusProperties</span>();
    }

    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">SpringLiquibasePlusExecutor</span> <span class="hljs-selector-tag">springLiquibasePlusExecuter</span>(SpringLiquibasePlusProperties springLiquibasePlusProperties) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Exception</span> {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"Liquibase CustomTaskChange size: {}, names: {}"</span>, customTaskChanges.<span class="hljs-built_in">size</span>(), customTaskChanges.<span class="hljs-built_in">stream</span>().<span class="hljs-built_in">map</span>(<span class="hljs-attribute">CustomTaskChange</span>::getClass).<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toSet</span>()));
        <span class="hljs-selector-tag">customTaskChanges</span><span class="hljs-selector-class">.forEach</span>(<span class="hljs-attribute">CustomChange</span>::getConfirmationMessage);
        <span class="hljs-selector-tag">SpringLiquibasePlusExecutor</span> <span class="hljs-selector-tag">springLiquibasePlusExecutor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SpringLiquibasePlusExecutor</span>(resourceLoader);
        <span class="hljs-selector-tag">springLiquibasePlusExecutor</span><span class="hljs-selector-class">.execute</span>(springLiquibasePlusProperties);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">springLiquibasePlusExecutor</span>;
    }

}
</code></pre>
<h3 data-id="heading-8"><code>V1_00_00_ClearCustomTaskChange</code></h3>
<blockquote>
<p><code>sql</code>中解决不了的，需要用<code>java</code>代码来进行版本管理的业务。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">V1_00_00_ClearCustomTaskChange</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CustomTaskChange</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">JdbcTemplate</span> jdbcTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setJdbcTemplate</span>(<span class="hljs-params">JdbcTemplate jdbcTemplate</span>) {
        V1_00_00_ClearCustomTaskChange.<span class="hljs-property">jdbcTemplate</span> = jdbcTemplate;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">execute</span>(<span class="hljs-title class_">Database</span> database) throws <span class="hljs-title class_">CustomChangeException</span> {
        <span class="hljs-comment">// 这里写liquibase简单的sql语句做不了的复杂写法，我这里只做简单演示，这里强烈建议用jdbcTemplate查询其他的表，并且只查询自己需要的字段</span>
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt;&gt; mapList = jdbcTemplate.<span class="hljs-title function_">queryForList</span>(<span class="hljs-string">"select * from school_01 where name = 'A'"</span>);
        <span class="hljs-keyword">if</span>(<span class="hljs-title class_">CollectionUtils</span>.<span class="hljs-title function_">isEmpty</span>(mapList)) {
            <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
                jdbcTemplate.<span class="hljs-title function_">update</span>(<span class="hljs-string">"insert into school_01(id, name) values (?, ?)"</span>, i, <span class="hljs-string">"A"</span> + i);
            }
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getConfirmationMessage</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"SUCCESS"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUp</span>() throws <span class="hljs-title class_">SetupException</span> {

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setFileOpener</span>(<span class="hljs-params">ResourceAccessor resourceAccessor</span>) {

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ValidationErrors</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">Database database</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h3 data-id="heading-9"><code>changelog.xml</code></h3>
<blockquote>
<p>主要的数据库版本管理文件</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">databaseChangeLog</span>
        <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.liquibase.org/xml/ns/dbchangelog"</span>
        <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd"</span>&gt;</span>

    <span class="hljs-comment">&lt;!--  初始化表结构  --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">"/sql/mysql/V1.00.00.sql"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">changeSet</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"V1.00.00-003-1"</span> <span class="hljs-attr">author</span>=<span class="hljs-string">"huzhihui"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">customChange</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.sp3.liquibase.config.custom.V1_00_00_ClearCustomTaskChange"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">changeSet</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">"/sql/mysql/V1.00.01.sql"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">databaseChangeLog</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10"><code>V1.00.00.sql</code></h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--liquibase formatted sql</span>

<span class="hljs-comment">--changeset huzhihui:V1.00.00-001-1</span>
<span class="hljs-comment">--preconditions onFail:MARK_RAN onError:MARK_RAN</span>
<span class="hljs-comment">--precondition-sql-check expectedResult:0 select count(1) from information_schema.tables where table_schema = (select database()) and table_name = 'school_01';</span>
<span class="hljs-comment">--comment 测试表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `school_01` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_zone` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_no_zone` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;

<span class="hljs-comment">--changeset huzhihui:V1.00.00-002-1</span>
<span class="hljs-comment">--preconditions onFail:MARK_RAN onError:MARK_RAN</span>
<span class="hljs-comment">--precondition-sql-check expectedResult:0 select count(1) from information_schema.tables where table_schema = (select database()) and table_name = 'school_02';</span>
<span class="hljs-comment">--comment 测试表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `school_02` (
 `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
 `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 `time_zone` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 `time_no_zone` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;
</code></pre>
<h3 data-id="heading-11"><code>V1.00.01.sql</code></h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--liquibase formatted sql</span>

<span class="hljs-comment">--changeset huzhihui:V1.00.01-001-1</span>
<span class="hljs-comment">--preconditions onFail:MARK_RAN onError:MARK_RAN</span>
<span class="hljs-comment">--precondition-sql-check expectedResult:0 select count(1) from information_schema.tables where table_schema = (select database()) and table_name = 'school_03';</span>
<span class="hljs-comment">--comment 测试表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `school_03` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_zone` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_no_zone` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;
</code></pre>
<h2 data-id="heading-12">最终执行结果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71a3c708cc564645a333c548df64f9c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=%2FpDEi12m%2FVVZqTA0Y2RruqahNkQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3990f674ad474230ae6f8dc51bf5e86d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=60J%2FmmJaMwC%2FWXwv%2BsoX2zrDP6w%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1cb86741334a758c66d34fde76e30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=vEsepQ2L%2FEe7G0lkUZSCBE1W%2Bns%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5dff566ad5a4cfebd8e63bb9c540d84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=Os8ZEHQ4dF7QUm7Q5IR%2Fq5yam4w%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[复刻网页彩虹🌈镭射效果]]></title>    <link>https://juejin.cn/post/7591497387245436964</link>    <guid>https://juejin.cn/post/7591497387245436964</guid>    <pubDate>2026-01-05T08:54:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591497387245436964" data-draft-id="7591680281905365019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="复刻网页彩虹🌈镭射效果"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-05T08:54:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="龙在天"/> <meta itemprop="url" content="https://juejin.cn/user/3760787883819464"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            复刻网页彩虹🌈镭射效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3760787883819464/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    龙在天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T08:54:18.000Z" title="Mon Jan 05 2026 08:54:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">效果展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9771f1228eb94fae82ef24cceb403a33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768208057&amp;x-signature=8Q88gjQ1Zmm9xhhzDbWTu6Euvi0%3D" alt="1.gif" loading="lazy"/></p>
<h2 data-id="heading-1">拆解代码</h2>
<h3 data-id="heading-2">容器布局</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">svg</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"outer-glow"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"center"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- SVG箭头图标 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">search-bar</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">search-bar</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">中心svg元素</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M10 90 L50 10 L90 90 M50 75 A5 5 0 1 1 50 85 A5 5 0 1 1 50 75"</span> 
      <span class="hljs-attr">stroke</span>=<span class="hljs-string">"#4CAF50"</span> <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"12"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"none"</span> /&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b0c31131eb940b3a462e6eac3ae640e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768208057&amp;x-signature=htGue0xdsiEqmoPltCL%2BZYsHY%2Bk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">功能开关</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 检查URL参数</span>
<span class="hljs-keyword">const</span> beta = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>).<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">"beta"</span>);
<span class="hljs-keyword">if</span> (beta) <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">"beta"</span>, beta);

<span class="hljs-comment">// 判断是否为beta版本</span>
<span class="hljs-keyword">const</span> isBeta = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">"beta"</span>);

<span class="hljs-comment">// 根据版本状态替换搜索栏</span>
<span class="hljs-keyword">if</span> (!isBeta) {
    <span class="hljs-keyword">const</span> comingSoon = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"div"</span>);
    comingSoon.<span class="hljs-property">id</span> = <span class="hljs-string">'coming'</span>;
    comingSoon.<span class="hljs-property">innerText</span> = <span class="hljs-string">"Coming Soon..."</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'search-bar'</span>).<span class="hljs-title function_">replaceWith</span>(comingSoon);
}
</code></pre>
<h2 data-id="heading-5">数据配置</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> logos = [
    { 
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'fa-google'</span>, 
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#4285F4'</span>, 
        <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Search for images using a SERP provider'</span> 
    },
    { 
        <span class="hljs-attr">src</span>: <span class="hljs-string">'logos/vercel.svg'</span>, 
        <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Add a domain to a project on Vercel'</span> 
    },
    <span class="hljs-comment">// ... 更多工具配置</span>
];
</code></pre>
<h2 data-id="heading-6">动态图标</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createLogo</span>(<span class="hljs-params">logo, x, y</span>) {
    <span class="hljs-keyword">const</span> logoElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(logo.<span class="hljs-property">icon</span> ? <span class="hljs-string">'i'</span> : <span class="hljs-string">'img'</span>);
    logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${x}</span>px`</span>;
    logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${y}</span>px`</span>;
    
    <span class="hljs-comment">// 移动端适配</span>
    <span class="hljs-keyword">if</span> (isMobile) {
        logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <span class="hljs-string">'16px'</span>;
        logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'16px'</span>;
        logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">'16px'</span>;
    }
    
    <span class="hljs-comment">// 添加交互事件</span>
    logoElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> searchInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'search-bar'</span>);
        searchInput.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'value'</span>, logo.<span class="hljs-property">placeholder</span>);
    });
}
</code></pre>
<h2 data-id="heading-7">曲线创建</h2>
<p>生成200条从中心向外辐射的贝塞尔曲线：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCurves</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> curves = [];
    <span class="hljs-keyword">const</span> numCurves = <span class="hljs-number">200</span>;
    <span class="hljs-keyword">const</span> centerX = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> centerY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / <span class="hljs-number">2</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; numCurves; i++) {
        <span class="hljs-keyword">const</span> angle = (i / numCurves) * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
        <span class="hljs-keyword">const</span> radius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>) * <span class="hljs-number">0.4</span>;
        <span class="hljs-keyword">const</span> x = centerX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle) * radius;
        <span class="hljs-keyword">const</span> y = centerY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * radius;
        
        <span class="hljs-keyword">const</span> path = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElementNS</span>(<span class="hljs-string">'http://www.w3.org/2000/svg'</span>, <span class="hljs-string">'path'</span>);
        <span class="hljs-keyword">const</span> d = <span class="hljs-string">`M <span class="hljs-subst">${centerX}</span> <span class="hljs-subst">${centerY}</span> Q <span class="hljs-subst">${centerX}</span> <span class="hljs-subst">${centerY}</span> <span class="hljs-subst">${x}</span> <span class="hljs-subst">${y}</span>`</span>;
        path.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'d'</span>, d);
        path.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'stroke'</span>, <span class="hljs-string">`hsl(<span class="hljs-subst">${(i / numCurves) * <span class="hljs-number">360</span>}</span>, 70%, 50%)`</span>);
        svg.<span class="hljs-title function_">appendChild</span>(path);
        curves.<span class="hljs-title function_">push</span>({ path, <span class="hljs-attr">endX</span>: x, <span class="hljs-attr">endY</span>: y });
    }
    <span class="hljs-keyword">return</span> curves;
}
</code></pre>
<h3 data-id="heading-8">鼠标改曲线</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateCurves</span>(<span class="hljs-params">curves, mouseX, mouseY</span>) {
    <span class="hljs-keyword">const</span> centerX = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> centerY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / <span class="hljs-number">2</span>;
    
    curves.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">curve, index</span>) =&gt;</span> {
        <span class="hljs-comment">// 计算中点偏移</span>
        <span class="hljs-keyword">const</span> dx = curve.<span class="hljs-property">endX</span> - centerX;
        <span class="hljs-keyword">const</span> dy = curve.<span class="hljs-property">endY</span> - centerY;
        <span class="hljs-keyword">const</span> distance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(dx * dx + dy * dy);
        
        <span class="hljs-keyword">const</span> midX = centerX + dx * <span class="hljs-number">0.5</span> + (mouseX - centerX) * <span class="hljs-number">0.1</span> * (distance / <span class="hljs-number">100</span>);
        <span class="hljs-keyword">const</span> midY = centerY + dy * <span class="hljs-number">0.5</span> + (mouseY - centerY) * <span class="hljs-number">0.1</span> * (distance / <span class="hljs-number">100</span>);
        
        <span class="hljs-comment">// 更新贝塞尔曲线路径</span>
        <span class="hljs-keyword">const</span> d = <span class="hljs-string">`M <span class="hljs-subst">${centerX}</span> <span class="hljs-subst">${centerY}</span> Q <span class="hljs-subst">${midX}</span> <span class="hljs-subst">${midY}</span> <span class="hljs-subst">${curve.endX}</span> <span class="hljs-subst">${curve.endY}</span>`</span>;
        curve.<span class="hljs-property">path</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'d'</span>, d);
        
        <span class="hljs-comment">// 动态颜色变化</span>
        <span class="hljs-keyword">const</span> hue = (index / curves.<span class="hljs-property">length</span> * <span class="hljs-number">360</span> + (mouseX + mouseY) / <span class="hljs-number">5</span>) % <span class="hljs-number">360</span>;
        curve.<span class="hljs-property">path</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'stroke'</span>, <span class="hljs-string">`hsl(<span class="hljs-subst">${hue}</span>, 70%, 50%)`</span>);
    });
}
</code></pre>
<h3 data-id="heading-9">鼠标区域检测</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isPointInsideCircle</span>(<span class="hljs-params">x, y, centerX, centerY, radius</span>) {
    <span class="hljs-keyword">const</span> dx = x - centerX;
    <span class="hljs-keyword">const</span> dy = y - centerY;
    <span class="hljs-keyword">return</span> dx * dx + dy * dy &lt;= radius * radius;
}
</code></pre>
<h3 data-id="heading-10">自动动画</h3>
<p>鼠标离开交互区域，启动自动旋转动画：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">autoAnimate</span>(<span class="hljs-params">curves</span>) {
    <span class="hljs-keyword">const</span> centerX = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> centerY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> radius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>) * <span class="hljs-number">0.2</span>;
    
    autoAnimationAngle += <span class="hljs-number">0.02</span>;
    <span class="hljs-keyword">const</span> mouseX = centerX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(autoAnimationAngle) * radius;
    <span class="hljs-keyword">const</span> mouseY = centerY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(autoAnimationAngle) * radius;
    
    <span class="hljs-title function_">updateCurves</span>(curves, mouseX, mouseY);
    animationFrame = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">autoAnimate</span>(curves));
}
</code></pre>
<h3 data-id="heading-11">初始化与响应式处理</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建曲线和图标</span>
    <span class="hljs-keyword">const</span> curves = <span class="hljs-title function_">createCurves</span>();
    <span class="hljs-keyword">const</span> centerX = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> centerY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> circleRadius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>) * <span class="hljs-number">0.38</span>;
    
    <span class="hljs-comment">// 创建工具图标</span>
    logos.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">logo, index</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> angle = (index / logos.<span class="hljs-property">length</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
        <span class="hljs-keyword">const</span> x = centerX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle) * circleRadius - <span class="hljs-number">16</span>;
        <span class="hljs-keyword">const</span> y = centerY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * circleRadius - <span class="hljs-number">16</span>;
        <span class="hljs-title function_">createLogo</span>(logo, x, y);
    });
    
    <span class="hljs-comment">// 添加鼠标事件监听</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-comment">// 鼠标交互逻辑</span>
    });
}

<span class="hljs-comment">// 窗口大小变化时重新初始化</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
    svg.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
    container.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.logo'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">logo</span> =&gt;</span> logo.<span class="hljs-title function_">remove</span>());
    <span class="hljs-title function_">cancelAnimationFrame</span>(animationFrame);
    <span class="hljs-title function_">init</span>();
});
</code></pre>
<h2 data-id="heading-12">完整代码</h2>
<h3 data-id="heading-13">html 部分</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">svg</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"outer-glow"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"center"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"h-16 w-16"</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 100 100"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M10 90 L50 10 L90 90 M50 75 A5 5 0 1 1 50 85 A5 5 0 1 1 50 75"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"#4CAF50"</span>
                    <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"12"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"none"</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">search-bar</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">search-bar</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> beta = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>).<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">"beta"</span>)
        <span class="hljs-keyword">if</span> (beta) {
            <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">"beta"</span>, beta)
        }

        <span class="hljs-keyword">const</span> isBeta = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">"beta"</span>)

        <span class="hljs-keyword">if</span> (!isBeta) {
            <span class="hljs-keyword">const</span> beta = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"div"</span>)
            beta.<span class="hljs-property">id</span> = <span class="hljs-string">'coming'</span>
            beta.<span class="hljs-property">innerText</span> = <span class="hljs-string">"Coming Soon..."</span>;
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'search-bar'</span>).<span class="hljs-title function_">replaceWith</span>(beta);
        }

        <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container'</span>);
        <span class="hljs-keyword">const</span> svg = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'svg'</span>);
        <span class="hljs-keyword">const</span> center = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'center'</span>);

        <span class="hljs-keyword">const</span> isMobile = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> &lt; <span class="hljs-number">1024</span>;

        <span class="hljs-keyword">const</span> logos = [
            { <span class="hljs-attr">icon</span>: <span class="hljs-string">'fa-google'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#4285F4'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Search for images using a SERP provider'</span> },
            { <span class="hljs-attr">icon</span>: <span class="hljs-string">'fa-slack'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#4A154B'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Create a new channel in slack'</span> },
            { <span class="hljs-attr">icon</span>: <span class="hljs-string">'fa-npm'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#CB3837'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Search for a package on npm'</span> },
            { <span class="hljs-attr">icon</span>: <span class="hljs-string">'fa-youtube'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#FF0000'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'YouTube get videos of a channel'</span> },
            { <span class="hljs-attr">icon</span>: <span class="hljs-string">'fa-twitter'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#1DA1F2'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Get all my tweets'</span> },
            { <span class="hljs-attr">icon</span>: <span class="hljs-string">'fa-stripe-s'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#008CDD'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Create payment link on stripe'</span> },
            { <span class="hljs-attr">icon</span>: <span class="hljs-string">'fa-github'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#181717'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Create a new repository'</span> },
            { <span class="hljs-attr">icon</span>: <span class="hljs-string">'fa-cloudflare'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#F38020'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Configure DNS settings'</span> },
            { <span class="hljs-attr">src</span>: <span class="hljs-string">'logos/vercel.svg'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Add a domain to a project on Vercel'</span> },
            { <span class="hljs-attr">src</span>: <span class="hljs-string">'logos/anthropic.png'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Send a message to claude of Anthropic'</span> },
            { <span class="hljs-attr">src</span>: <span class="hljs-string">'logos/groq.jpeg'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Create a groq chat completion for LLama 3.1'</span> },
            { <span class="hljs-attr">src</span>: <span class="hljs-string">'logos/notion.png'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Create a new Notion Database'</span> },
            { <span class="hljs-attr">src</span>: <span class="hljs-string">'logos/openai.svg'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Run text to speech on OpenAI'</span> },
            { <span class="hljs-attr">src</span>: <span class="hljs-string">'logos/replicate.webp'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'List all my models on Replicate'</span> },
            { <span class="hljs-attr">src</span>: <span class="hljs-string">'logos/supabase.png'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Show my supabase projects'</span> },
            { <span class="hljs-attr">src</span>: <span class="hljs-string">'logos/google-analytics.svg'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'Find my realtime statistics'</span> },
            { <span class="hljs-attr">src</span>: <span class="hljs-string">'logos/gmail.png'</span>, <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'List Gmail messages from a sender'</span> },

            <span class="hljs-comment">// not good enough yet!</span>

            <span class="hljs-comment">// { icon: 'fa-apple', color: '#A2AAAD', placeholder: 'Check iPhone battery health' },</span>
            <span class="hljs-comment">// { icon: 'fa-microsoft', color: '#00A4EF', placeholder: 'Schedule a Teams meeting' },</span>
            <span class="hljs-comment">// { icon: 'fa-amazon', color: '#FF9900', placeholder: 'Track my package' },</span>
            <span class="hljs-comment">// { icon: 'fa-jira', color: '#0052CC', placeholder: 'Create a new sprint' },</span>
            <span class="hljs-comment">// { icon: 'fa-trello', color: '#0052CC', placeholder: 'Add a new card to board' },</span>
            <span class="hljs-comment">// { icon: 'fa-linkedin', color: '#0A66C2', placeholder: 'Update my work experience' },</span>
            <span class="hljs-comment">// { icon: 'fa-whatsapp', color: '#25D366', placeholder: 'Start a group video call' },</span>
            <span class="hljs-comment">// { icon: 'fa-spotify', color: '#1ED760', placeholder: 'Create a workout playlist' },</span>
            <span class="hljs-comment">// { icon: 'fa-aws', color: '#232F3E', placeholder: 'Add a new object in simple storage service (s3)' },</span>

        ];

        <span class="hljs-keyword">let</span> animationFrame;
        <span class="hljs-keyword">let</span> isMouseInside = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">let</span> autoAnimationAngle = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">createLogo</span>(<span class="hljs-params">logo, x, y</span>) {
            <span class="hljs-keyword">const</span> logoElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(logo.<span class="hljs-property">icon</span> ? <span class="hljs-string">'i'</span> : <span class="hljs-string">'img'</span>);
            logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${x}</span>px`</span>;
            logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${y}</span>px`</span>;
            <span class="hljs-keyword">if</span> (isMobile) {
                logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <span class="hljs-string">'16px'</span>
                logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'16px'</span>
                logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">'16px'</span>
            }

            <span class="hljs-keyword">if</span> (logo.<span class="hljs-property">icon</span>) {

                logoElement.<span class="hljs-property">className</span> = <span class="hljs-string">`fab <span class="hljs-subst">${logo.icon}</span> logo`</span>;
                logoElement.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = logo.<span class="hljs-property">color</span>;
            } <span class="hljs-keyword">else</span> {
                logoElement.<span class="hljs-property">src</span> = logo.<span class="hljs-property">src</span>;
                logoElement.<span class="hljs-property">className</span> = <span class="hljs-string">`logo-image`</span>;
            }

            logoElement.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-placeholder'</span>, logo.<span class="hljs-property">placeholder</span>);

            container.<span class="hljs-title function_">appendChild</span>(logoElement);

            logoElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">const</span> searchInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'search-bar'</span>);
                searchInput.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'value'</span>, logo.<span class="hljs-property">placeholder</span>);
            })

            <span class="hljs-keyword">if</span> (isBeta) {


                logoElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseenter'</span>, <span class="hljs-function">() =&gt;</span> {


                    <span class="hljs-keyword">const</span> searchInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'search-bar'</span>);
                    searchInput.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'placeholder'</span>, logo.<span class="hljs-property">placeholder</span>);
                });

                logoElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseleave'</span>, <span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-keyword">const</span> searchInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'search-bar'</span>);
                    searchInput.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'placeholder'</span>, <span class="hljs-string">'Search 5829+ Tools'</span>);
                });
            } <span class="hljs-keyword">else</span> {

                logoElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseenter'</span>, <span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'coming'</span>).<span class="hljs-property">innerText</span> = logo.<span class="hljs-property">placeholder</span>;
                });

                logoElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseleave'</span>, <span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'coming'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">'Coming soon...'</span>;
                });

            }

        }

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">createCurves</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> curves = [];
            <span class="hljs-keyword">const</span> numCurves = <span class="hljs-number">200</span>;
            <span class="hljs-keyword">const</span> centerX = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">const</span> centerY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / <span class="hljs-number">2</span>;

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; numCurves; i++) {
                <span class="hljs-keyword">const</span> angle = (i / numCurves) * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
                <span class="hljs-keyword">const</span> radius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>) * <span class="hljs-number">0.4</span>;
                <span class="hljs-keyword">const</span> x = centerX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle) * radius;
                <span class="hljs-keyword">const</span> y = centerY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * radius;

                <span class="hljs-keyword">const</span> path = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElementNS</span>(<span class="hljs-string">'http://www.w3.org/2000/svg'</span>, <span class="hljs-string">'path'</span>);
                <span class="hljs-keyword">const</span> d = <span class="hljs-string">`M <span class="hljs-subst">${centerX}</span> <span class="hljs-subst">${centerY}</span> Q <span class="hljs-subst">${centerX}</span> <span class="hljs-subst">${centerY}</span> <span class="hljs-subst">${x}</span> <span class="hljs-subst">${y}</span>`</span>;
                path.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'d'</span>, d);
                path.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'stroke'</span>, <span class="hljs-string">`hsl(<span class="hljs-subst">${(i / numCurves) * <span class="hljs-number">360</span>}</span>, 70%, 50%)`</span>);
                svg.<span class="hljs-title function_">appendChild</span>(path);
                curves.<span class="hljs-title function_">push</span>({ path, <span class="hljs-attr">endX</span>: x, <span class="hljs-attr">endY</span>: y });
            }

            <span class="hljs-keyword">return</span> curves;
        }

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateCurves</span>(<span class="hljs-params">curves, mouseX, mouseY</span>) {
            <span class="hljs-keyword">const</span> centerX = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">const</span> centerY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / <span class="hljs-number">2</span>;

            curves.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">curve, index</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> dx = curve.<span class="hljs-property">endX</span> - centerX;
                <span class="hljs-keyword">const</span> dy = curve.<span class="hljs-property">endY</span> - centerY;
                <span class="hljs-keyword">const</span> distance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(dx * dx + dy * dy);

                <span class="hljs-keyword">const</span> midX = centerX + dx * <span class="hljs-number">0.5</span> + (mouseX - centerX) * <span class="hljs-number">0.1</span> * (distance / <span class="hljs-number">100</span>);
                <span class="hljs-keyword">const</span> midY = centerY + dy * <span class="hljs-number">0.5</span> + (mouseY - centerY) * <span class="hljs-number">0.1</span> * (distance / <span class="hljs-number">100</span>);

                <span class="hljs-keyword">const</span> d = <span class="hljs-string">`M <span class="hljs-subst">${centerX}</span> <span class="hljs-subst">${centerY}</span> Q <span class="hljs-subst">${midX}</span> <span class="hljs-subst">${midY}</span> <span class="hljs-subst">${curve.endX}</span> <span class="hljs-subst">${curve.endY}</span>`</span>;
                curve.<span class="hljs-property">path</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'d'</span>, d);

                <span class="hljs-keyword">const</span> hue = (index / curves.<span class="hljs-property">length</span> * <span class="hljs-number">360</span> + (mouseX + mouseY) / <span class="hljs-number">5</span>) % <span class="hljs-number">360</span>;
                curve.<span class="hljs-property">path</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'stroke'</span>, <span class="hljs-string">`hsl(<span class="hljs-subst">${hue}</span>, 70%, 50%)`</span>);
            });
        }

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">isPointInsideCircle</span>(<span class="hljs-params">x, y, centerX, centerY, radius</span>) {
            <span class="hljs-keyword">const</span> dx = x - centerX;
            <span class="hljs-keyword">const</span> dy = y - centerY;
            <span class="hljs-keyword">return</span> dx * dx + dy * dy &lt;= radius * radius;
        }

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">autoAnimate</span>(<span class="hljs-params">curves</span>) {
            <span class="hljs-keyword">const</span> centerX = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">const</span> centerY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">const</span> radius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>) * <span class="hljs-number">0.2</span>;

            autoAnimationAngle += <span class="hljs-number">0.02</span>;
            <span class="hljs-keyword">const</span> mouseX = centerX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(autoAnimationAngle) * radius;
            <span class="hljs-keyword">const</span> mouseY = centerY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(autoAnimationAngle) * radius;

            <span class="hljs-title function_">updateCurves</span>(curves, mouseX, mouseY);
            animationFrame = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">autoAnimate</span>(curves));
        }

        <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> curves = <span class="hljs-title function_">createCurves</span>();
            <span class="hljs-keyword">const</span> centerX = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">const</span> centerY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / <span class="hljs-number">2</span>;
            <span class="hljs-keyword">const</span> circleRadius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>) * <span class="hljs-number">0.38</span>;

            logos.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">logo, index</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> angle = (index / logos.<span class="hljs-property">length</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
                <span class="hljs-keyword">const</span> x = centerX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle) * circleRadius - <span class="hljs-number">16</span>;
                <span class="hljs-keyword">const</span> y = centerY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * circleRadius - <span class="hljs-number">16</span>;
                <span class="hljs-title function_">createLogo</span>(logo, x, y);
            });

            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
                <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isPointInsideCircle</span>(e.<span class="hljs-property">clientX</span>, e.<span class="hljs-property">clientY</span>, centerX, centerY, circleRadius)) {
                    <span class="hljs-keyword">if</span> (!isMouseInside) {
                        isMouseInside = <span class="hljs-literal">true</span>;
                        <span class="hljs-title function_">cancelAnimationFrame</span>(animationFrame);
                    }
                    <span class="hljs-title function_">updateCurves</span>(curves, e.<span class="hljs-property">clientX</span>, e.<span class="hljs-property">clientY</span>);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (isMouseInside) {
                        isMouseInside = <span class="hljs-literal">false</span>;
                        <span class="hljs-title function_">autoAnimate</span>(curves);
                    }
                }
            });

            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseleave'</span>, <span class="hljs-function">() =&gt;</span> {
                isMouseInside = <span class="hljs-literal">false</span>;
                <span class="hljs-title function_">autoAnimate</span>(curves);
            });



            <span class="hljs-comment">// Start with auto animation</span>
            <span class="hljs-title function_">autoAnimate</span>(curves);
        }

        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
            svg.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
            container.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.logo'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">logo</span> =&gt;</span> logo.<span class="hljs-title function_">remove</span>());
            container.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.logo-image'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">logo</span> =&gt;</span> logo.<span class="hljs-title function_">remove</span>());
            <span class="hljs-title function_">cancelAnimationFrame</span>(animationFrame);
            <span class="hljs-title function_">init</span>();
        });


        <span class="hljs-title function_">init</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<h3 data-id="heading-14">css 部分</h3>
<pre><code class="hljs language-css" lang="css">&lt;style&gt;<span class="hljs-selector-tag">body</span>,
        <span class="hljs-selector-tag">html</span> {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
            <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
        }

        <span class="hljs-selector-id">#container</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">flex-direction</span>: column;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">position</span>: relative;
        }

        <span class="hljs-selector-id">#center</span> {
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">150px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">150px</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.8</span>);
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
        }

        <span class="hljs-selector-class">.logo</span> {
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">32px</span>;
            <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> ease;
            <span class="hljs-attribute">z-index</span>: <span class="hljs-number">5</span>;
            <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">drop-shadow</span>(<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.8</span>));
            <span class="hljs-attribute">cursor</span>: pointer;
        }

        <span class="hljs-selector-class">.logo-image</span> {
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">32px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">32px</span>;
            <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> ease;
            <span class="hljs-attribute">z-index</span>: <span class="hljs-number">5</span>;
            <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">drop-shadow</span>(<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.8</span>));
            <span class="hljs-attribute">cursor</span>: pointer;
        }

        <span class="hljs-selector-class">.logo</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.2</span>);
        }

        <span class="hljs-selector-class">.logo-image</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.2</span>);
        }

        svg {
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">pointer-events</span>: none;
        }

        path {
            fill: none;
            stroke-<span class="hljs-attribute">width</span>: <span class="hljs-number">2</span>;
            <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.3</span>;
        }

        <span class="hljs-selector-id">#outer-glow</span> {
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">76%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">76%</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">radial-gradient</span>(circle, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.8</span>) <span class="hljs-number">0%</span>, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>) <span class="hljs-number">70%</span>);
            <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>;
        }
&lt;/style&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS App 中 SSL Pinning 场景下代理抓包失效的原因]]></title>    <link>https://juejin.cn/post/7591635567589015598</link>    <guid>https://juejin.cn/post/7591635567589015598</guid>    <pubDate>2026-01-05T09:02:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591635567589015598" data-draft-id="7591687981687685166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS App 中 SSL Pinning 场景下代理抓包失效的原因"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-05T09:02:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是谁的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2390811467846089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS App 中 SSL Pinning 场景下代理抓包失效的原因
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2390811467846089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是谁的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T09:02:19.000Z" title="Mon Jan 05 2026 09:02:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我第一次认真面对 SSL Pinning，并不是因为想研究安全，而是因为一个接口问题卡了两天。</p>
<p>App 在测试环境一切正常，到了准生产环境，功能偶尔失效。日志没报错，接口返回码是 200，但页面状态明显不对。
习惯性打开抓包工具，却发现 HTTPS 请求连内容都看不到。</p>
<p>证书装了，信任也点了，该做的都做了。
这时候再说抓不到包，已经有点不准确了，更像是抓包路径本身被绕开了。</p>
<hr/>
<h2 data-id="heading-0"><strong>先确认一件事：你面对的是 Pinning，还是别的问题</strong></h2>
<p>在很多案例里，SSL Pinning 绕过这个判断来得太早。</p>
<p>我通常会先做三件很具体的事：</p>
<ul>
<li>在模拟器上跑一遍，看同一接口是否可抓</li>
<li>在真机上切不同网络环境（Wi-Fi / 热点），观察行为是否变化</li>
<li>打开最基础的网络日志，确认请求是否真的发出</li>
</ul>
<p>如果这些信息彼此矛盾，问题往往还没到 Pinning 这一层。</p>
<hr/>
<h2 data-id="heading-1"><strong>代理抓包失败，其实已经给了线索</strong></h2>
<p>当 Charles、Fiddler 这类代理工具表现为：</p>
<ul>
<li>只能看到 CONNECT</li>
<li>TLS 握手直接失败</li>
<li>或者请求完全不出现</li>
</ul>
<p>而 App 本身又能正常工作时，基本可以确认<strong>客户端对证书链有额外校验逻辑。</strong></p>
<p>这时继续折腾代理设置，意义不大。</p>
<hr/>
<h2 data-id="heading-2"><strong>换一个问题问法：不解密，能不能继续查</strong></h2>
<p>在这个节点，我会刻意放弃“马上看到明文”的目标，而是转向更基础的问题：</p>
<blockquote>
<p>这个请求在什么时间发出？
发了几次？
是否存在重试或异常断开？</p>
</blockquote>
<p>这类问题，不依赖 HTTPS 解密。</p>
<hr/>
<h2 data-id="heading-3"><strong>设备侧抓包，是继续推进的第一步</strong></h2>
<p>我在这一步使用 **抓包大师（Sniff Master）**的其中暴力抓取HTTPS，这并不是为了破解什么，而是为了确认通信行为是否存在。</p>
<p>暴力抓取HTTPS无需设置代理即可获取iOS设备上的HTTPS请求，并且能够自动解密HTTPS请求。要求被抓取的App必须使用iOS开发证书签名；</p>
<p>对于未重签名的应用（如iOS系统应用或部分第三方应用），只能看到请求地址和请求头，无法查看请求和返回的body部分。</p>
<p>软件的PIN码检测和双向证书验证无法阻止暴力抓包，也无法感知暴力抓包的使用。</p>
<p>具体做法很简单：</p>
<ul>
<li>
<p>iOS设备通过USB连接电脑，选择要抓包的设备后，在功能选择区选择HTTPS暴力抓包，然后在暴力抓包界面点击开始按钮。</p>
</li>
<li>
<p>如果只关注某个App，可以点击选择App按钮进行过滤。更多关于暴力抓包的设置与使用查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sniffmaster.net%2Ftutorial%2Fzh%2F2%2F2.html" target="_blank" title="https://www.sniffmaster.net/tutorial/zh/2/2.html" ref="nofollow noopener noreferrer">暴力抓包详细教程</a></p>
</li>
</ul>
<p>不需要设置代理，也不需要让系统信任任何证书。</p>
<p>如果在这里能看到稳定的数据流，至少可以确认：<strong>Pinning 没有阻断通信，只是阻断了中间人解密。</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d31a97763334188bda5bacfad13a307~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768208538&amp;x-signature=dignL6rcVXh99MvjrNPyxoCX7ac%3D" alt="https暴力抓包" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4"><strong>只看 HTTPS 层，很容易误判问题位置</strong></h2>
<p>有一次问题中，HTTPS 请求本身没有任何异常。
真正的问题在于，App 在 HTTPS 返回后，通过 TCP 长连接同步状态。</p>
<p>代理抓包工具只能看到“接口成功”，但功能仍然异常。
设备侧数据流抓包却能看到连接频繁中断。</p>
<p>这类问题，如果只纠结 SSL Pinning，很容易走偏。</p>
<hr/>
<h2 data-id="heading-5"><strong>数据流分析，让问题变得“可定位”</strong></h2>
<p>抓包大师支持查看 TCP / UDP 数据流，并能导出原始数据。
在这个阶段，我并不急着解析协议，而是关注几个指标：</p>
<ul>
<li>连接是否持续</li>
<li>数据包大小是否异常</li>
<li>是否存在规律性的断开</li>
</ul>
<p>这些信息，可以直接指导下一步是去看客户端逻辑，还是服务端行为。</p>
<hr/>
<h2 data-id="heading-6"><strong>拦截和修改，更像验证假设</strong></h2>
<p>当我已经大致判断问题原因时，才会用到请求/响应修改。</p>
<p>比如：</p>
<ul>
<li>模拟接口延迟</li>
<li>修改返回字段，观察客户端分支逻辑</li>
</ul>
<p>抓包大师支持通过拦截器和脚本完成这些操作，更适合在真机环境下验证判断，而不是用来“突破安全”。、
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc8ddc914cea4ae19ea3089ae81cef68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768208538&amp;x-signature=waAoTM9rTE2OTyOwe2Nvz3TUl4w%3D" alt="拦截器" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 中的 useMemo 与 useCallback：性能优化的利器]]></title>    <link>https://juejin.cn/post/7591348605867278371</link>    <guid>https://juejin.cn/post/7591348605867278371</guid>    <pubDate>2026-01-05T04:50:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591348605867278371" data-draft-id="7591382440583004200" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 中的 useMemo 与 useCallback：性能优化的利器"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-05T04:50:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冻梨政哥"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 中的 useMemo 与 useCallback：性能优化的利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冻梨政哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:50:31.000Z" title="Mon Jan 05 2026 04:50:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 中的 useMemo 与 useCallback：性能优化的利器</h2>
<p>在 React 开发中，随着组件复杂度提升，性能优化逐渐成为不可忽视的问题。当组件状态更新时，函数组件会重新执行，这可能导致不必要的计算或子组件重渲染。React 提供的<code>useMemo</code>和<code>useCallback</code>两个 Hooks，正是解决这类性能问题的关键工具。本文将结合实际代码，详细讲解它们的作用、用法及应用场景。</p>
<h3 data-id="heading-1">为什么需要性能优化？</h3>
<p>在 React 中，当组件的状态（<code>useState</code>）或上下文（<code>useContext</code>）发生变化时，组件会重新执行其函数体。这一机制确保了 UI 与数据的同步，但也可能带来副作用：</p>
<ul>
<li>组件内的计算逻辑会被重复执行（即使计算结果不变）</li>
<li>传递给子组件的 props （尤其是函数）会被重新创建，导致子组件不必要的重渲染</li>
</ul>
<p>例如，在未优化的情况下，当一个与计算逻辑无关的状态变化时，过滤列表或复杂计算会被重复执行；父组件传递的回调函数每次都会是新的引用，导致使用<code>memo</code>包装的子组件依然重渲染。
<code>useMemo</code>和<code>useCallback</code>正是为解决这些问题而生。</p>
<h3 data-id="heading-2">useMemo：缓存计算结果</h3>
<h4 data-id="heading-3">作用</h4>
<p><code>useMemo</code>用于缓存<strong>计算结果</strong>，避免组件重渲染时重复执行昂贵的计算逻辑。只有当依赖项发生变化时，才会重新计算结果。</p>
<h4 data-id="heading-4">用法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> 缓存的结果 = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> { 
    <span class="hljs-comment">// 计算逻辑（可能是昂贵的操作） </span>
    <span class="hljs-keyword">return</span> 计算结果; 
}, [依赖项数组]); <span class="hljs-comment">// 依赖项变化时，重新执行计算</span>
</code></pre>
<ul>
<li>第一个参数：一个函数，封装需要缓存结果的计算逻辑</li>
<li>第二个参数：依赖项数组，只有数组中的值发生变化时，才会重新执行第一个函数</li>
</ul>
<h4 data-id="heading-5">代码示例</h4>
<ol>
<li><strong>过滤列表优化</strong></li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-section">[count,setCount]</span> = useState(0)<span class="hljs-comment">;</span>
const <span class="hljs-attr">list</span> = [<span class="hljs-string">'apple'</span>,<span class="hljs-string">'banana'</span>,<span class="hljs-string">'orange'</span>,<span class="hljs-string">'pear'</span>]<span class="hljs-comment">; </span>
const <span class="hljs-section">[keyword,setKeyword]</span> = useState('')<span class="hljs-comment">;</span>
// 用useMemo缓存过滤结果，仅当keyword变化时重新过滤 
const <span class="hljs-attr">filterList</span> = useMemo(() =&gt; { 
    return list.filter(<span class="hljs-attr">item</span> =&gt; item.includes(keyword)) 
}, <span class="hljs-section">[keyword]</span>)
return (
    &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> value={keyword} <span class="hljs-literal">on</span>Change={e =&gt; setKeyword(e.target.value)}/&gt;
     {
        filterList.map(<span class="hljs-attr">item</span> =&gt; (
          &lt;li <span class="hljs-attr">key</span>={item}&gt;{item}&lt;/li&gt;
        ))
      }
    &lt;button <span class="hljs-attr">onClick</span>={() =&gt; setCount(count + <span class="hljs-number">1</span>)}&gt;count + <span class="hljs-number">1</span>&lt;/button&gt;
)
</code></pre>
<p>若不使用<code>useMemo</code>，每次组件重渲染（即使<code>count</code>变化，与过滤逻辑无关），<code>filter</code>都会重新执行。使用<code>useMemo</code>后，只有<code>keyword</code>变化时才会重新过滤，减少了不必要的计算。</p>
<ol start="2">
<li><strong>昂贵计算优化</strong></li>
</ol>
<pre><code class="hljs language-ini" lang="ini">// 模拟一个昂贵的计算（循环100万次） 
function slowSum(n) { 
    console.log('计算中...')<span class="hljs-comment">; </span>
    let <span class="hljs-attr">sum</span> = <span class="hljs-number">0</span><span class="hljs-comment">; </span>
    for(let <span class="hljs-attr">i</span>=<span class="hljs-number">0</span><span class="hljs-comment">;i&lt;n*1000000;i++){ </span>
        sum+=i<span class="hljs-comment">; </span>
    } 
    return sum<span class="hljs-comment">; </span>
} 
// 用useMemo缓存计算结果，仅当num变化时重新计算 
const <span class="hljs-attr">result</span> = useMemo(() =&gt; { 
    return slowSum(num)<span class="hljs-comment">; </span>
}, <span class="hljs-section">[num]</span>)
</code></pre>
<p><code>slowSum</code>是一个耗时计算，若不缓存，每次组件重渲染（如<code>count</code>或<code>keyword</code>变化）都会触发它。使用<code>useMemo</code>后，只有<code>num</code>变化时才会重新执行，显著提升性能。</p>
<h4 data-id="heading-6">应用场景</h4>
<ul>
<li>包含<strong>昂贵计算</strong>的逻辑（如大量循环、复杂数据处理）</li>
<li>需要作为<code>props</code>传递的<strong>计算属性</strong>（避免子组件因值频繁变化而重渲染）</li>
<li>依赖多个状态 / 变量的推导值（确保仅在依赖变化时更新）</li>
</ul>
<h3 data-id="heading-7">useCallback：缓存回调函数</h3>
<h4 data-id="heading-8">作用</h4>
<p><code>useCallback</code>用于缓存<strong>函数引用</strong>，避免组件重渲染时重复创建相同逻辑的函数。常与<code>memo</code>配合使用，防止子组件因接收的函数<code>props</code>变化而不必要地重渲染。</p>
<h4 data-id="heading-9">用法</h4>
<pre><code class="hljs language-scss" lang="scss">const 缓存的函数 = <span class="hljs-built_in">useCallback</span>(() =&gt; { 
    <span class="hljs-comment">// 函数逻辑 </span>
}, <span class="hljs-selector-attr">[依赖项数组]</span>); <span class="hljs-comment">// 依赖项变化时，重新创建函数</span>
</code></pre>
<ul>
<li>第一个参数：需要缓存的回调函数</li>
<li>第二个参数：依赖项数组，只有数组中的值发生变化时，才会重新创建函数</li>
</ul>
<h4 data-id="heading-10">代码示例</h4>
<ol>
<li><strong>子组件优化</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用memo包装子组件，使其仅在props真正变化时重渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{count,handleClick}</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'child 重新渲染'</span>);
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>
            子组件{count}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
})
</code></pre>
<ol start="2">
<li><strong>缓存回调函数</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用useCallback缓存handleClick，仅当count变化时重新创建 </span>
<span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> { 
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'click'</span>); 
}, [count])
</code></pre>
<p>若不使用<code>useCallback</code>，每次父组件重渲染，<code>handleClick</code>都会是新的函数引用。即使<code>memo</code>包装了<code>Child</code>，由于<code>handleClick</code>变化，子组件依然会重渲染。使用<code>useCallback</code>后，只有<code>count</code>变化时<code>handleClick</code>才更新，因此当<code>num</code>变化时，子组件不会重新渲染。</p>
<h4 data-id="heading-11">应用场景</h4>
<ul>
<li>传递给子组件的<strong>回调函数</strong>（如<code>onClick</code>、<code>onChange</code>）</li>
<li>作为依赖项传入<code>useEffect</code>等 Hooks 的函数（避免<code>useEffect</code>不必要地触发）</li>
<li>配合<code>memo</code>、<code>useMemo</code>等优化手段，确保子组件仅在必要时重渲染</li>
</ul>
<h3 data-id="heading-12">总结</h3>
<p><code>useMemo</code>和<code>useCallback</code>都是 React 性能优化的核心工具，它们的本质是<strong>缓存</strong>：</p>
<ul>
<li><code>useMemo</code>缓存<strong>计算结果</strong>，解决 “重复计算” 问题</li>
<li><code>useCallback</code>缓存<strong>函数引用</strong>，解决 “子组件不必要重渲染” 问题</li>
</ul>
<p>使用时需注意：</p>
<ul>
<li>不要过度优化：简单计算或不频繁重渲染的组件无需使用，缓存本身也有开销</li>
<li>依赖项数组必须正确：遗漏依赖会导致缓存结果 / 函数过时，引发逻辑错误</li>
<li>结合场景使用：昂贵计算用<code>useMemo</code>，回调函数用<code>useCallback</code>配合<code>memo</code></li>
</ul>
<p>合理使用这两个 Hooks，能有效提升 React 应用的性能，尤其在复杂组件或高频更新场景中效果显著。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js基本概念理解]]></title>    <link>https://juejin.cn/post/7591544356001087498</link>    <guid>https://juejin.cn/post/7591544356001087498</guid>    <pubDate>2026-01-05T06:14:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591544356001087498" data-draft-id="7591510174047944755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js基本概念理解"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2026-01-05T06:14:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cj8140"/> <meta itemprop="url" content="https://juejin.cn/user/958429869388990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js基本概念理解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/958429869388990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cj8140
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T06:14:19.000Z" title="Mon Jan 05 2026 06:14:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。 Node.js 使用了一个事件驱动、非阻塞式 I/O 的模型，使其轻量又高效。</p>
</blockquote>
<p>这句话是 Node.js 的核心设计理念，我用<strong>餐厅服务员</strong>的比喻来帮你拆解理解：</p>
<hr/>
<h3 data-id="heading-0">一、整体比喻：Node.js 是一家"超高效快餐店"</h3>
<ul>
<li><strong>传统服务器</strong>（如PHP）：一个服务员从头到尾服务一桌客人（点单→做菜→上菜→结账），期间不能服务其他桌</li>
<li><strong>Node.js</strong>：一个服务员<strong>快速记录</strong>所有桌的订单，交给后厨（I/O操作）后，立刻服务下一桌，<strong>做好了通知他</strong>再去端菜</li>
</ul>
<hr/>
<h3 data-id="heading-1">二、分句详解</h3>
<h4 data-id="heading-2"><strong>1. "基于 Chrome V8 引擎"</strong></h4>
<p><strong>理解</strong>：Node.js 用 Chrome 浏览器的"发动机"来跑 JS 代码</p>

















<table><thead><tr><th>场景</th><th>解释</th></tr></thead><tbody><tr><td><strong>浏览器中的JS</strong></td><td>V8引擎解析JS → 操作DOM → 渲染页面</td></tr><tr><td><strong>Node.js中的JS</strong></td><td>V8引擎解析JS → <strong>操作文件/网络/数据库</strong> → 返回数据</td></tr></tbody></table>
<p><strong>好处</strong>：V8是C++写的，性能极高（JIT编译、垃圾回收优化），让JS运行速度接近原生代码</p>
<hr/>
<h4 data-id="heading-3"><strong>2. "事件驱动"</strong></h4>
<p><strong>理解</strong>：代码不是按顺序死板执行，而是 <strong>"有事我叫你，没事别管我"</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 传统方式：主动等待（阻塞）</span>
<span class="hljs-keyword">const</span> data = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'/file.txt'</span>); <span class="hljs-comment">// 干等文件读完</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);                         <span class="hljs-comment">// 才能执行这行</span>

<span class="hljs-comment">// ✅ Node.js方式：注册回调（事件驱动）</span>
fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'/file.txt'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {  <span class="hljs-comment">// 告诉Node：读完文件"叫"我</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文件读完了！'</span>, data);        <span class="hljs-comment">// 这个函数是"事件处理函数"</span>
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'我先去干别的了...'</span>);          <span class="hljs-comment">// 不等待，立即执行</span>
</code></pre>
<p><strong>输出顺序</strong>：</p>
<pre><code class="hljs language-css" lang="css">我先去干别的了...
文件读完了！ <span class="hljs-selector-attr">[文件内容]</span>
</code></pre>
<p><strong>类比</strong>：你点外卖后<strong>不需要在门口干等</strong>，而是继续工作，外卖到了小哥<strong>打电话通知你</strong>（事件触发）</p>
<hr/>
<h4 data-id="heading-4"><strong>3. "非阻塞式 I/O"</strong></h4>
<p><strong>理解</strong>：I/O操作（文件、网络、数据库）就像<strong>烧水</strong>，Node.js 不会<strong>傻等水开</strong></p>
<ul>
<li><strong>阻塞式</strong>（同步）：站在水壶前，啥也不干，水开了才走</li>
<li><strong>非阻塞式</strong>（异步）：按下烧水按钮，<strong>立刻去做别的事</strong>，水壶响了（事件）再回来</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 同时发起1000个网络请求</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
  http.<span class="hljs-title function_">get</span>(<span class="hljs-string">'http://api.example.com'</span>, <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> { <span class="hljs-comment">// 非阻塞：发出请求就下一循环</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`请求<span class="hljs-subst">${i}</span>完成`</span>); <span class="hljs-comment">// 响应返回后自动执行回调</span>
  });
}
<span class="hljs-comment">// 1000个请求几乎瞬间发完，不需要等任何一个返回</span>
</code></pre>
<p><strong>关键</strong>：单线程的 Node.js 能同时处理数万个连接，<strong>不是靠多线程，而是靠不等待</strong></p>
<hr/>
<h3 data-id="heading-5">三、三者如何协同工作？</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 完整事件循环示意图</span>
┌─────────────────────────────────────┐
│        <span class="hljs-title class_">Node</span>.<span class="hljs-property">js</span> 主线程（单线程）       │
│  不断检查<span class="hljs-string">"事件队列"</span>（像前台接待员）    │
└─────────────────────────────────────┘
         ↑               ↓
    有新事件吗？       执行回调函数
         ↑               ↓
┌────────┴────────┬────────┴────────┐
│  文件系统完成   │   网络响应到达   │   数据库查询完成
│  (<span class="hljs-variable constant_">V8</span>不管这些)    │  (<span class="hljs-variable constant_">V8</span>不管这些)    │   (<span class="hljs-variable constant_">V8</span>不管这些)
└─────────────────┴─────────────────┘
</code></pre>
<p><strong>工作流程</strong>：</p>
<ol>
<li><strong>V8引擎</strong>：快速执行你的JS代码，注册回调函数</li>
<li><strong>非阻塞I/O</strong>：遇到耗时操作，交给<strong>操作系统内核</strong>或<strong>线程池</strong>处理，主线程立即继续</li>
<li><strong>事件驱动</strong>：操作完成后，内核通知 Node.js，V8执行对应的回调函数</li>
</ol>
<hr/>
<h3 data-id="heading-6">四、为什么"轻量又高效"？</h3>

























<table><thead><tr><th>传统多线程服务器 (Apache)</th><th>Node.js</th></tr></thead><tbody><tr><td>每个请求 = 一个线程（约2MB内存）</td><td>所有请求 = 一个线程（几KB内存）</td></tr><tr><td>10000个连接 ≈ 20GB内存</td><td>10000个连接 ≈ 几十MB内存</td></tr><tr><td>线程切换CPU开销大</td><td>无线程切换，CPU只做有用功</td></tr><tr><td>适合CPU密集型（如图像处理）</td><td>适合I/O密集型（API、聊天室、实时推送）</td></tr></tbody></table>
<p><strong>代价</strong>：如果回调函数里有<code>for(let i=0; i&lt;1000000000; i++)</code>这种CPU重计算，会<strong>卡住整个事件循环</strong>，后续所有请求都等待（这叫"阻塞事件循环"）。</p>
<hr/>
<h3 data-id="heading-7">五、一句话总结</h3>
<p><strong>Node.js = 用V8引擎跑JS + 单线程不等待 + 有事call back</strong></p>
<p>它就像一家<strong>只有一个服务员但永不空闲</strong>的餐厅，通过"事件通知"机制，用极少的资源处理海量并发，但<strong>不适合做需要长时间占用CPU的复杂计算</strong>（那种任务要交给其他语言或用Worker Threads）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise状态机与状态流转]]></title>    <link>https://juejin.cn/post/7591403124327645247</link>    <guid>https://juejin.cn/post/7591403124327645247</guid>    <pubDate>2026-01-05T06:44:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591403124327645247" data-draft-id="7591410544928735274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise状态机与状态流转"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-05T06:44:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise状态机与状态流转
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T06:44:29.000Z" title="Mon Jan 05 2026 06:44:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本专栏聚焦Promise的核心原理与高级应用，包含：
✓ Promise A+规范深度解读
✓ 手写实现与源码分析
✓ 异步编程设计模式
✓ 性能调优与错误处理</p>
</blockquote>
<blockquote>
<p>适合有JavaScript基础，希望深入异步编程的开发者。我们将用最少的篇幅，讲透最核心的知识。</p>
</blockquote>
<h2 data-id="heading-0">引言：Promise状态机</h2>
<p>在之前的文章中，我们曾提到Promise三种状态：<code>pending（待定）</code>、<code>fulfilled（兑现）</code>、<code>rejected（拒绝）</code>。而且还有一个关键特性：</p>
<ul>
<li>状态不可逆：一旦状态从pending变为fulfilled或rejected，就永远不会再改变。</li>
</ul>
<p>这是什么意思呢？我们可以举一个简单的例子来帮助大家理解：
我们可以把Promise当做一台自动贩卖机：我们投币（发起请求）后，贩卖机进入"pending"状态，最终要么出货（fulfilled），要么退币（rejected）。一旦出货或退币完成，状态就固定了，不会突然又变回处理中。</p>
<h2 data-id="heading-1">Promise的三态模型：状态流转</h2>
<h3 data-id="heading-2">状态定义与转换关系</h3>
<p>Promise规范明确定义了三种状态：<code>pending（待定）</code>、<code>fulfilled（兑现）</code>、<code>rejected（拒绝）</code>，它们构成了一个完整的有限状态机。我们先通过一段简单的代码示例，来观察Promise的状态流程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 状态流转示意图</span>
<span class="hljs-comment">// 创建时 → pending</span>
<span class="hljs-comment">// pending → fulfilled (通过resolve)</span>
<span class="hljs-comment">// pending → rejected (通过reject)</span>

<span class="hljs-comment">// 创建Promise时的初始状态</span>
<span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Promise创建，状态: pending'</span>);
    
    <span class="hljs-comment">// 1秒后状态转换</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>;
        
        <span class="hljs-keyword">if</span> (success) {
            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'操作成功'</span>);  <span class="hljs-comment">// pending → fulfilled</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'状态已变为: fulfilled'</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'操作失败'</span>));  <span class="hljs-comment">// pending → rejected</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'状态已变为: rejected'</span>);
        }
        
        <span class="hljs-comment">// 注意：以下代码不会生效！</span>
        <span class="hljs-keyword">if</span> (!success) {
            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'重新尝试成功'</span>);  <span class="hljs-comment">// 无效！状态已锁定</span>
        }
    }, <span class="hljs-number">1000</span>);
});
</code></pre>
<h3 data-id="heading-3">状态详解</h3>
<h4 data-id="heading-4">Pending（待定状态）</h4>
<p><strong>Pending</strong> 为Promise的初始状态，也可以称为过渡状态，它可能被转为fulfilled或rejected，通常在创建Promise时默认即为pending状态，类似于订单已下单，但商家尚未发货。我们可以看下面一个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">() =&gt;</span> { })
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myPromise)
</code></pre>
<p>上述代码中，我们创建了一个空函数对象，其输出结果为：<code>Promise { &lt;pending&gt; }</code>。这是Promise对象的最初始状态，在<code>pending</code>状态下，Promise可以被转换成<code>fulfilled</code>或<code>rejected</code>。</p>
<blockquote>
<p>注：Promise并不是一开始就必须处于<code>pending</code>状态，通过<code>Promise.resolve()</code>等静态方法，可以直接实例化一个<code>resolved</code>状态的Promise对象。</p>
</blockquote>
<blockquote>
<p>Promise相关实例化方法和静态方法在后面的文章中会详细讲解。</p>
</blockquote>
<h4 data-id="heading-5">Fulfilled（兑现状态）</h4>
<p>当 <code>resolve(value)</code> 被调用时，Promise对象的状态会被转换成<code>fulfilled</code>，同时会携带一个不可变的结果值，就好比订单已发货并签收。我们可以看下面一个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Hello, World!'</span>))
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myPromise)
</code></pre>
<p>上述代码中，我们在Promise中产生了一个<code>resolve('Hello, World!')</code>的回调函数，其输出结果是：<code>Promise {&lt;fulfilled&gt;: 'Hello, World!'}</code> 。</p>
<blockquote>
<p>注：在不同的编辑器中，解析结果可能不一样，比如node.js环境中，会直接输出<code>Promise { 'Hello, World!'}</code> 。</p>
</blockquote>
<h4 data-id="heading-6">Rejected（拒绝状态）</h4>
<p>当<code>reject(reason)</code>被调用时，或同步抛出异常问题，Promise对象的状态会被转换成<code>rejected</code>，同时会携带一个拒绝原因（通常是Error对象），就好比订单因缺货等原因无法完成。我们可以看下面一个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'直接拒绝'</span>)))
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myPromise)
</code></pre>
<p>上述代码中，我们在Promise中产生了一个<code>reject(new Error('直接拒绝'))</code>的回调函数，其输出结果是：<code>Promise {&lt;rejected&gt;: Error: 直接拒绝</code> 。</p>
<blockquote>
<p>注：在不同的编辑器中，解析结果可能不一样，比如node.js环境中，会直接输出<code>Promise {&lt;rejected&gt;: Error: 直接拒绝}</code> 外，还是打印出堆栈跟踪信息。</p>
</blockquote>
<p>除了上述代码示例外，下面两种情况也会自动转成<code>rejected</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'同步异常导致拒绝'</span>);  <span class="hljs-comment">// 会被自动转换为reject</span>
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myPromise)
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">'无效的JSON'</span>)
        } <span class="hljs-keyword">catch</span> (err) {
            <span class="hljs-title function_">reject</span>(err)  <span class="hljs-comment">// 捕获异常并明确拒绝</span>
        }
    }, <span class="hljs-number">0</span>)
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myPromise)
</code></pre>
<h3 data-id="heading-7">不可变原则</h3>
<h4 data-id="heading-8">状态不可逆性</h4>
<p>这是Promise最重要的特性之一：状态一旦从 <code>pending</code> 变为 <code>fulfilled</code> 或 <code>rejected</code> ，就永远不会再次改变。我们可以看下面一个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 状态不可逆的证明</span>
<span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 第一次状态改变</span>
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'第一次成功'</span>);

    <span class="hljs-comment">// 以下所有尝试都不会生效</span>
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'第二次成功'</span>);  <span class="hljs-comment">// 忽略</span>
    <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'尝试失败'</span>));  <span class="hljs-comment">// 忽略</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'延迟的成功'</span>);  <span class="hljs-comment">// 忽略</span>
    }, <span class="hljs-number">1000</span>);

    <span class="hljs-comment">// 甚至抛出异常也不会影响</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'异常被忽略'</span>);
});

myPromise
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'只会收到:'</span>, value);  <span class="hljs-comment">// 输出: 第一次成功</span>
        <span class="hljs-keyword">return</span> value;
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'永远不会执行这里'</span>);  <span class="hljs-comment">// 因为状态已经是fulfilled</span>
    });
</code></pre>
<p>上述代码的执行结果只会是：<code>只会收到: 第一次成功</code> 。</p>
<h4 data-id="heading-9">值不可变性</h4>
<p>当Promise被决议后，其状态就会被确定，同时它所携带的值就固定不变了，无法从外部修改。我们来看下面一个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'第一次设置的值'</span>) <span class="hljs-comment">// 有效</span>
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'尝试覆盖的值'</span>)   <span class="hljs-comment">// 被忽略</span>
    <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'尝试拒绝'</span>)) <span class="hljs-comment">// 被忽略</span>
})

myPromise.<span class="hljs-title function_">then</span>(
    <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'成功:'</span>, value), <span class="hljs-comment">// 输出: 成功: 第一次设置的值</span>
    <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'失败:'</span>, error.<span class="hljs-property">message</span>) <span class="hljs-comment">// 不会执行</span>
)
</code></pre>
<p>上述代码的执行结果只会是：<code>成功: 第一次设置的值</code> 。</p>
<h2 data-id="heading-10">结语</h2>
<p>本文主要介绍了Promise状态机与状态流转的相关概念，如果你在理解状态机模型或不可变原则时有任何疑问，或对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 缓存三剑客：useMemo、useCallback 与 memo 的正确打开方式]]></title>    <link>https://juejin.cn/post/7591439305261039651</link>    <guid>https://juejin.cn/post/7591439305261039651</guid>    <pubDate>2026-01-05T06:50:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591439305261039651" data-draft-id="7591465142451683380" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" React 缓存三剑客：useMemo、useCallback 与 memo 的正确打开方式"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-05T06:50:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             React 缓存三剑客：useMemo、useCallback 与 memo 的正确打开方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T06:50:29.000Z" title="Mon Jan 05 2026 06:50:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React 应用开发中，随着组件复杂度的提升，性能问题逐渐显现。尤其当组件中包含大量计算逻辑或频繁触发重渲染时，应用响应速度会明显下降。React 提供了 <code>useMemo</code> 和 <code>useCallback</code> 两个核心 Hook，配合 <code>React.memo</code>，可以有效避免不必要的重复计算和组件重渲染，显著提升应用性能。本文将通过三个典型 Demo，深入剖析这两个 Hook 的使用场景、原理及最佳实践。</p>
<hr/>
<h2 data-id="heading-0">一、昂贵计算的缓存：useMemo 的作用</h2>
<h3 data-id="heading-1">1.1 问题场景：无意义的重复计算</h3>
<p>考虑以下组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'xxx'</span>);
  <span class="hljs-comment">// 模拟大量的计算</span>
  <span class="hljs-keyword">let</span> a = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">100000000</span>; j++) {
    a += j;
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'xxx'</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>x: {x}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>y: {y}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>a: {a}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setX(x + 1)}&gt;x + 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setY(y + 1)}&gt;y + 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p>在这个组件中，每次点击按钮（无论是 <code>x + 1</code> 还是 <code>y + 1</code>），都会触发组件重新渲染。而每次渲染时，都会执行一次耗时的循环计算（1亿次加法）。然而，这个计算结果 <code>a</code> 实际上与 <code>x</code> 和 <code>y</code> 无关——它始终是固定的值（即 0 到 99999999 的累加和）。因此，这种重复计算完全是无意义的，严重浪费 CPU 资源。</p>
<h3 data-id="heading-2">1.2 解决方案：使用 useMemo 缓存结果</h3>
<p><code>useMemo</code> 的核心思想是<strong>记忆化（memoization）</strong> ：将计算结果缓存起来，只有当依赖项发生变化时才重新计算。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'xxx'</span>);
  <span class="hljs-keyword">const</span> memoA = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> a = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">100000000</span>; j++) {
      a += j;
    }
    <span class="hljs-keyword">return</span> a;
  }, []); <span class="hljs-comment">// 依赖项为空数组</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'xxx'</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>x: {x}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>y: {y}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>a: {memoA}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setX(x + 1)}&gt;x + 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setY(y + 1)}&gt;y + 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p>关键点在于 <code>useMemo</code> 的第二个参数——<strong>依赖数组</strong>。这里传入空数组 <code>[]</code>，表示该计算<strong>不依赖任何外部变量</strong>，因此只在组件首次挂载时执行一次。后续无论 <code>x</code> 或 <code>y</code> 如何变化，<code>memoA</code> 都直接返回缓存的值，不再执行耗时循环。控制台输出的时间将从几百毫秒降至几乎为 0。</p>
<blockquote>
<p><strong>注意</strong>：<code>useMemo</code> 返回的是<strong>计算结果本身</strong>，而非副作用函数（这与 <code>useEffect</code> 不同）。必须用变量接收其返回值才能使用。</p>
</blockquote>
<h3 data-id="heading-3">1.3 动态依赖：让缓存“聪明”起来</h3>
<p>如果计算逻辑依赖于状态变量，就必须将该变量加入依赖数组：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">memoA</span> = useMemo(() =&gt; {
  let <span class="hljs-attr">a</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  for (let <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; 100000000; j++) {</span>
    a += y<span class="hljs-comment">; // 计算依赖 y</span>
  }
  return a<span class="hljs-comment">;</span>
}, <span class="hljs-section">[y]</span>)<span class="hljs-comment">; // 依赖项为 [y]</span>
</code></pre>
<p>此时：</p>
<ul>
<li>当点击 <strong>x + 1</strong> 时，<code>y</code> 未变 → <code>useMemo</code> 返回缓存值 → 无计算开销。</li>
<li>当点击 <strong>y + 1</strong> 时，<code>y</code> 发生变化 → <code>useMemo</code> 重新执行计算 → 产生时间消耗。</li>
</ul>
<p>若错误地将依赖数组设为空 <code>[]</code>，则即使 <code>y</code> 改变，<code>useMemo</code> 仍会返回首次计算的旧值（因为闭包捕获了初始的 <code>y</code>），导致<strong>数据不一致</strong>。这就是典型的“闭包陷阱”——<strong>依赖数组必须包含回调函数中用到的所有外部变量</strong>。</p>
<hr/>
<h2 data-id="heading-4">二、避免子组件无谓重渲染：useCallback + React.memo</h2>
<h3 data-id="heading-5">2.1 问题根源：函数引用变化</h3>
<p>在组件通信中，父组件常需向子组件传递回调函数。但每次父组件重渲染时，都会创建一个<strong>全新的函数引用</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件每次渲染都会生成新函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'click'</span>);
};
</code></pre>
<p>即使函数逻辑完全相同，JavaScript 也会将其视为不同对象。当子组件使用 <code>React.memo</code> 优化时，浅比较会认为 <code>props</code> 发生了变化，从而触发不必要的重渲染。</p>
<h3 data-id="heading-6">2.2 React.memo：子组件的“守门员”</h3>
<p><code>React.memo</code> 是一个高阶组件，用于包裹函数组件。它通过<strong>浅比较 props</strong> 来决定是否跳过渲染：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ count, handleClick }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'child 重新渲染'</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>{count} 子组件<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
});
</code></pre>
<ul>
<li>若 <code>count</code> 和 <code>handleClick</code> 的引用均未改变 → 跳过渲染。</li>
<li>若任一 prop 引用改变 → 重新渲染。</li>
</ul>
<h3 data-id="heading-7">2.3 useCallback：稳定函数引用</h3>
<p>为解决函数引用变化问题，<code>useCallback</code> 应运而生。它专门用于<strong>缓存函数引用</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">handleClick</span> = useCallback(() =&gt; {
  console.log('click')<span class="hljs-comment">;</span>
}, <span class="hljs-section">[count]</span>)<span class="hljs-comment">; // 依赖项为 [count]</span>
</code></pre>
<p>工作原理：</p>
<ul>
<li>
<p>首次渲染：创建函数并缓存。</p>
</li>
<li>
<p>后续渲染：</p>
<ul>
<li>若 <code>count</code> 未变 → 返回缓存的函数引用。</li>
<li>若 <code>count</code> 改变 → 创建新函数并更新缓存。</li>
</ul>
</li>
</ul>
<p>结合 <code>React.memo</code>，可实现精准渲染控制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'click'</span>);
  }, [count]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {count}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;count + 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {num}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setNum(num + 1)}&gt;num + 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{count}</span> <span class="hljs-attr">handleClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>测试行为：</p>
<ul>
<li>点击 <strong>num + 1</strong>：<code>count</code> 不变 → <code>handleClick</code> 引用不变 → <code>Child</code> 不重渲染。</li>
<li>点击 <strong>count + 1</strong>：<code>count</code> 改变 → <code>handleClick</code> 生成新引用 → <code>Child</code> 重渲染。</li>
</ul>
<blockquote>
<p><strong>关键点</strong>：<code>useCallback(fn, deps)</code> 等价于 <code>useMemo(() =&gt; fn, deps)</code>。前者是后者的语法糖，专用于函数缓存。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">三、核心概念对比与最佳实践</h2>
<h3 data-id="heading-9">3.1 useMemo vs useCallback</h3>






























<table><thead><tr><th>特性</th><th>useMemo</th><th>useCallback</th></tr></thead><tbody><tr><td><strong>用途</strong></td><td>缓存<strong>计算结果</strong>（值）</td><td>缓存<strong>函数引用</strong></td></tr><tr><td><strong>返回值</strong></td><td>回调函数的返回值</td><td>回调函数本身</td></tr><tr><td><strong>典型场景</strong></td><td>昂贵计算（如大数据处理、复杂过滤）</td><td>传递给子组件的回调函数</td></tr><tr><td><strong>等价写法</strong></td><td>—</td><td><code>useMemo(() =&gt; fn, deps)</code></td></tr></tbody></table>
<h3 data-id="heading-10">3.2 依赖数组的黄金法则</h3>
<p>无论是 <code>useMemo</code> 还是 <code>useCallback</code>，依赖数组都必须遵循：</p>
<ol>
<li><strong>完整性</strong>：包含回调中用到的所有外部变量（状态、props、其他 Hooks 的返回值等）。</li>
<li><strong>必要性</strong>：仅包含真正影响计算/函数行为的变量，避免过度依赖导致缓存失效。</li>
</ol>
<p>违反完整性会导致闭包陷阱（使用过期值）；过度依赖则削弱缓存效果。</p>
<h3 data-id="heading-11">3.3 性能优化的边界</h3>
<ul>
<li><strong>不要过早优化</strong>：仅对已知的性能瓶颈使用 <code>useMemo</code>/<code>useCallback</code>。简单计算或小型组件无需优化。</li>
<li><strong>避免滥用空依赖</strong>：<code>[]</code> 仅适用于完全静态的值。若计算涉及 props 或状态，必须正确声明依赖。</li>
<li><strong>React.memo 的局限性</strong>：仅对 props 进行浅比较。若 prop 是对象/数组，需确保其引用稳定（同样可用 <code>useMemo</code> 缓存）。</li>
</ul>
<hr/>
<h2 data-id="heading-12">四、总结</h2>
<p><code>useMemo</code> 和 <code>useCallback</code> 是 React 性能优化体系中的重要工具：</p>
<ul>
<li><strong><code>useMemo</code></strong> 通过缓存昂贵计算的结果，避免重复执行相同逻辑。</li>
<li><strong><code>useCallback</code></strong> 通过稳定函数引用，配合 <code>React.memo</code> 阻止子组件无谓重渲染。</li>
</ul>
<p>二者的核心机制均依赖于<strong>依赖数组的精确声明</strong>——这是避免 bug 与发挥性能优势的关键。在实际开发中，应结合具体场景判断是否需要优化，并始终遵循依赖声明的完整性原则。合理运用这些 Hook，能让 React 应用在保持代码简洁的同时，获得流畅的用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端虚拟列表滚动功能实现与核心知识点详解]]></title>    <link>https://juejin.cn/post/7591420438850519076</link>    <guid>https://juejin.cn/post/7591420438850519076</guid>    <pubDate>2026-01-05T06:59:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591420438850519076" data-draft-id="7591407298414706694" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端虚拟列表滚动功能实现与核心知识点详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-05T06:59:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端er小Z"/> <meta itemprop="url" content="https://juejin.cn/user/871279852264302"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端虚拟列表滚动功能实现与核心知识点详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/871279852264302/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端er小Z
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T06:59:15.000Z" title="Mon Jan 05 2026 06:59:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>虚拟列表（Virtual List）是前端解决<strong>长列表渲染性能问题</strong>的核心方案，其核心思想是「只渲染可视区域内的列表项，而非全部数据」，可将上万条数据的列表渲染耗时从秒级降至毫秒级。本文从「<strong>核心原理→实现步骤→知识点拆解→进阶优化</strong>」全维度讲解，附完整可运行代码。</p>
<h2 data-id="heading-0">一、虚拟列表核心原理</h2>
<h3 data-id="heading-1">1. 为什么需要虚拟列表？</h3>
<p>普通长列表渲染的问题：</p>
<ul>
<li>DOM 节点过多：10000 条数据会生成 10000 个 DOM 节点，导致首次渲染慢、滚动卡顿（重排 / 重绘成本高）；</li>
<li>内存占用大：大量 DOM 节点占用浏览器内存，易引发页面崩溃。</li>
</ul>
<p>虚拟列表的解决思路：</p>
<ol>
<li><strong>固定容器高度</strong>：列表外层容器设置固定高度并开启滚动（<code>overflow: auto</code>）；</li>
<li><strong>计算可视区域</strong>：根据容器高度、列表项高度，计算「可视区域能显示的列表项数量」；</li>
<li><strong>只渲染可视项</strong>：从全量数据中截取可视区域内的部分数据，仅渲染这些数据对应的 DOM；</li>
<li><strong>滚动偏移模拟</strong>：通过「空白占位容器」模拟列表的整体滚动高度，通过「定位可视项容器」实现滚动时的位置对齐。</li>
</ol>
<h3 data-id="heading-2">2. 核心术语与公式</h3>


















































<table><thead><tr><th>术语</th><th>说明</th><th>核心公式</th></tr></thead><tbody><tr><td>容器可视高度（viewHeight）</td><td>列表外层容器的可见高度（如 500px）</td><td>-</td></tr><tr><td>列表项高度（itemHeight）</td><td>单个列表项的固定高度（如 50px，简化版虚拟列表假设高度固定）</td><td>-</td></tr><tr><td>可视项数量（visibleCount）</td><td>可视区域能显示的列表项数量（向上取整避免留白）</td><td><code>visibleCount = Math.ceil(viewHeight / itemHeight) + 2</code>（+2 为缓冲项）</td></tr><tr><td>滚动偏移量（scrollTop）</td><td>容器的滚动距离（<code>container.scrollTop</code>）</td><td>-</td></tr><tr><td>起始索引（startIndex）</td><td>可视区域第一个列表项的索引</td><td><code>startIndex = Math.floor(scrollTop / itemHeight)</code></td></tr><tr><td>结束索引（endIndex）</td><td>可视区域最后一个列表项的索引</td><td><code>endIndex = startIndex + visibleCount</code></td></tr><tr><td>占位高度（totalHeight）</td><td>模拟整个列表的高度（让滚动条显示正确）</td><td><code>totalHeight = 总数据长度 * itemHeight</code></td></tr><tr><td>可视项偏移（offsetTop）</td><td>可视项容器的垂直偏移（让可视项显示在正确位置）</td><td><code>offsetTop = startIndex * itemHeight</code></td></tr></tbody></table>
<h2 data-id="heading-3">二、基础版虚拟列表实现（固定高度）</h2>
<h3 data-id="heading-4">1. 完整代码（原生 JS 版）</h3>
<pre><code class="hljs language-js" lang="js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>基础版虚拟列表<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-comment">/* 1. 列表容器：固定高度、开启滚动、相对定位 */</span>
    <span class="hljs-selector-class">.virtual-list-container</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>; <span class="hljs-comment">/* 可视区域高度 */</span>
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e6e6e6</span>;
      <span class="hljs-attribute">overflow</span>: auto;
      <span class="hljs-attribute">position</span>: relative;
    }
    <span class="hljs-comment">/* 2. 占位容器：模拟整个列表的高度，让滚动条正常显示 */</span>
    <span class="hljs-selector-class">.virtual-list-placeholder</span> {
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-comment">/* 高度由JS动态计算：总数据长度 * 列表项高度 */</span>
    }
    <span class="hljs-comment">/* 3. 可视项容器：绝对定位，通过top偏移显示在正确位置 */</span>
    <span class="hljs-selector-class">.virtual-list-items</span> {
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    }
    <span class="hljs-comment">/* 4. 列表项：固定高度 */</span>
    <span class="hljs-selector-class">.list-item</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>; <span class="hljs-comment">/* 单个列表项高度 */</span>
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#f5f5f5</span>;
      <span class="hljs-attribute">box-sizing</span>: border-box;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 外层容器，固定高度 + 滚动 + 相对定位（作为子元素的定位参考） --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtual-list-container"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 占位容器：模拟总高度 --&gt;</span>
     <span class="hljs-comment">&lt;!-- 占位容器，高度等于「总数据长度 × 列表项高度」，目的是让滚动条的长度和滚动范围与真实长列表一致 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtual-list-placeholder"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"placeholder"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 可视项容器：只渲染可视区域的列表项 --&gt;</span>
     <span class="hljs-comment">&lt;!-- 可视项容器，绝对定位，通过top属性偏移到当前滚动位置对应的区域，只渲染可视数据。 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtual-list-items"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"items"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 1. 模拟海量数据（10万条）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TOTAL_DATA</span> = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> ({
      <span class="hljs-attr">id</span>: index,
      <span class="hljs-attr">content</span>: <span class="hljs-string">`列表项 <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>`</span>
    }));

    <span class="hljs-comment">// 2. 核心配置</span>
    <span class="hljs-keyword">const</span> config = {
      <span class="hljs-attr">viewHeight</span>: <span class="hljs-number">500</span>, <span class="hljs-comment">// 容器可视高度（px）</span>
      <span class="hljs-attr">itemHeight</span>: <span class="hljs-number">50</span>,  <span class="hljs-comment">// 单个列表项高度（px）</span>
      <span class="hljs-attr">buffer</span>: <span class="hljs-number">2</span>        <span class="hljs-comment">// 缓冲项数量（避免滚动时出现空白）</span>
    };

    <span class="hljs-comment">// 3. 获取DOM元素</span>
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container'</span>);
    <span class="hljs-keyword">const</span> placeholder = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'placeholder'</span>);
    <span class="hljs-keyword">const</span> items = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'items'</span>);

    <span class="hljs-comment">// 4. 初始化：设置占位容器高度</span>
    placeholder.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${TOTAL_DATA.length * config.itemHeight}</span>px`</span>;

    <span class="hljs-comment">// 5. 核心渲染函数：根据滚动位置渲染可视项</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderVisibleItems</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 5.1 获取滚动偏移量 container.scrollTop 表示容器向上滚动的距离</span>
      <span class="hljs-keyword">const</span> scrollTop = container.<span class="hljs-property">scrollTop</span>;
      
      <span class="hljs-comment">// 5.2 计算可视项的起始/结束索引</span>
      <span class="hljs-comment">// 滚动偏移 150px → startIndex = 150/50 = 3（第 4 项）；</span>
      <span class="hljs-comment">// endIndex = 3+12 = 15（第 16 项）；</span>
      <span class="hljs-keyword">const</span> visibleCount = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(config.<span class="hljs-property">viewHeight</span> / config.<span class="hljs-property">itemHeight</span>) + config.<span class="hljs-property">buffer</span>;
      <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop / config.<span class="hljs-property">itemHeight</span>)); <span class="hljs-comment">// 避免负数</span>
      <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable constant_">TOTAL_DATA</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>, startIndex + visibleCount);
      
      <span class="hljs-comment">// 5.3 截取可视区域的数据</span>
      <span class="hljs-comment">// 从 10 万条数据中截取第 3~15 项（仅 13 条）；</span>
      <span class="hljs-keyword">const</span> visibleData = <span class="hljs-variable constant_">TOTAL_DATA</span>.<span class="hljs-title function_">slice</span>(startIndex, endIndex + <span class="hljs-number">1</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"scrollTop:"</span>,scrollTop)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"visibleCount:"</span>,visibleCount)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"startIndex:"</span>,startIndex)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"endIndex:"</span>,endIndex)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"======"</span>)
      
      <span class="hljs-comment">// 5.4 计算可视项容器的偏移（让可视项显示在正确位置）</span>
      <span class="hljs-comment">// 设置可视项偏移：items.style.top = 3×50 = 150px，让可视项容器对齐滚动位置</span>
      items.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${startIndex * config.itemHeight}</span>px`</span>;
      
      <span class="hljs-comment">// 5.5 渲染可视项（innerHTML简化版，实际可优化为DOM复用）</span>
      items.<span class="hljs-property">innerHTML</span> = visibleData.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`
        &lt;div class="list-item" data-id="<span class="hljs-subst">${item.id}</span>"&gt;
          <span class="hljs-subst">${item.content}</span>
        &lt;/div&gt;
      `</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
    }

    <span class="hljs-comment">// 6. 监听滚动事件：滚动时重新渲染可视项</span>
    container.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-title function_">debounce</span>(renderVisibleItems));

    <span class="hljs-comment">// 7. 初始化渲染</span>
    <span class="hljs-title function_">renderVisibleItems</span>();


    <span class="hljs-comment">// 防抖函数 如果在16ms内多次执行滚动，则会重新计算时间</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay = <span class="hljs-number">16</span></span>) {
      <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-built_in">clearTimeout</span>(timer);
        timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), delay);
      };
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</span></code></pre>
<h3 data-id="heading-5">2. 核心逻辑拆解</h3>
<h4 data-id="heading-6">（1）DOM 结构设计</h4>
<ul>
<li><code>virtual-list-container</code>：外层容器，固定高度 + 滚动 + 相对定位（作为子元素的定位参考）；</li>
<li><code>virtual-list-placeholder</code>：占位容器，高度等于「总数据长度 × 列表项高度」，目的是让滚动条的长度和滚动范围与真实长列表一致；</li>
<li><code>virtual-list-items</code>：可视项容器，绝对定位，通过<code>top</code>属性偏移到当前滚动位置对应的区域，只渲染可视数据。</li>
</ul>
<h4 data-id="heading-7">（2）渲染函数核心步骤</h4>
<ol>
<li>
<p><strong>获取滚动偏移量</strong>：<code>container.scrollTop</code> 表示容器向上滚动的距离；</p>
</li>
<li>
<p><strong>计算可视项数量</strong>：<code>Math.ceil(500/50)+2 = 12</code>，即可视区域能显示 10 项，额外加 2 项缓冲（避免快速滚动时出现空白）；</p>
</li>
<li>
<p><strong>计算起始 / 结束索引</strong>：</p>
<ul>
<li>滚动偏移 150px → <code>startIndex = 150/50 = 3</code>（第 4 项）；</li>
<li><code>endIndex = 3+12 = 15</code>（第 16 项）；</li>
</ul>
</li>
<li>
<p><strong>截取可视数据</strong>：从 10 万条数据中截取第 3~15 项（仅 13 条）；</p>
</li>
<li>
<p><strong>设置可视项偏移</strong>：<code>items.style.top = 3×50 = 150px</code>，让可视项容器对齐滚动位置；</p>
</li>
<li>
<p><strong>渲染可视项</strong>：仅渲染 13 项 DOM，而非 10 万项。</p>
</li>
</ol>
<h2 data-id="heading-8">三、虚拟列表核心知识点拆解</h2>
<h3 data-id="heading-9">1. 滚动事件与性能优化</h3>
<ul>
<li><strong>scroll 事件的特性</strong>：滚动时会高频触发（每秒数十次），直接在事件回调中操作 DOM 会导致性能问题；</li>
<li><strong>优化方案</strong>：防抖（Debounce），减少渲染频率（如每 16ms 渲染一次，对应 60fps）：</li>
</ul>
<h3 data-id="heading-10">2. 定位方式与偏移计算</h3>
<ul>
<li><strong>绝对定位的作用</strong>：可视项容器（<code>virtual-list-items</code>）脱离文档流，仅在可视区域渲染，不影响占位容器的高度；</li>
<li><strong>top 偏移的意义</strong>：<code>startIndex × itemHeight</code> 保证可视项容器始终对齐滚动位置，例如滚动到第 100 项时，<code>top = 100×50 = 5000px</code>，可视项容器会定位到 5000px 位置，显示第 100~112 项。</li>
</ul>
<h3 data-id="heading-11">3. 固定高度 vs 动态高度</h3>
<p>基础版假设列表项高度固定，实际场景中列表项高度可能动态（如内容换行、不同类型项高度不同），解决方案：</p>
<h4 data-id="heading-12">（1）预估高度 + 修正</h4>
<ol>
<li>先按「预估高度」计算占位高度和偏移；</li>
<li>渲染后获取真实高度（<code>getBoundingClientRect()</code>）；</li>
<li>记录每个项的真实高度，滚动时用真实高度修正偏移。</li>
</ol>
<h4 data-id="heading-13">（2）核心代码示例（动态高度）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 存储每个项的真实高度（初始为预估高度）</span>
<span class="hljs-keyword">const</span> itemHeights = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-variable constant_">TOTAL_DATA</span>.<span class="hljs-property">length</span>).<span class="hljs-title function_">fill</span>(config.<span class="hljs-property">itemHeight</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderVisibleItems</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> scrollTop = container.<span class="hljs-property">scrollTop</span>;
  
  <span class="hljs-comment">// 计算累计高度（替代固定高度的startIndex计算）</span>
  <span class="hljs-keyword">let</span> cumulativeHeight = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> startIndex = <span class="hljs-number">0</span>;
  <span class="hljs-comment">// 找到滚动位置对应的起始索引</span>
  <span class="hljs-keyword">for</span> (; startIndex &lt; <span class="hljs-variable constant_">TOTAL_DATA</span>.<span class="hljs-property">length</span>; startIndex++) {
    <span class="hljs-keyword">if</span> (cumulativeHeight &gt;= scrollTop) <span class="hljs-keyword">break</span>;
    cumulativeHeight += itemHeights[startIndex];
  }
  
  <span class="hljs-comment">// 计算可视项结束索引（累计高度超过可视高度）</span>
  <span class="hljs-keyword">let</span> endIndex = startIndex;
  <span class="hljs-keyword">let</span> visibleHeight = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (endIndex &lt; <span class="hljs-variable constant_">TOTAL_DATA</span>.<span class="hljs-property">length</span> &amp;&amp; visibleHeight &lt; config.<span class="hljs-property">viewHeight</span> + config.<span class="hljs-property">buffer</span> * config.<span class="hljs-property">itemHeight</span>) {
    visibleHeight += itemHeights[endIndex];
    endIndex++;
  }
  
  <span class="hljs-comment">// 截取可视数据</span>
  <span class="hljs-keyword">const</span> visibleData = <span class="hljs-variable constant_">TOTAL_DATA</span>.<span class="hljs-title function_">slice</span>(startIndex, endIndex);
  
  <span class="hljs-comment">// 计算可视项容器的偏移（累计到startIndex的高度）</span>
  <span class="hljs-keyword">const</span> offsetTop = cumulativeHeight - itemHeights[startIndex];
  items.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${offsetTop}</span>px`</span>;
  
  <span class="hljs-comment">// 渲染后修正真实高度</span>
  items.<span class="hljs-property">innerHTML</span> = visibleData.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, idx</span>) =&gt;</span> <span class="hljs-string">`
    &lt;div class="list-item" data-id="<span class="hljs-subst">${item.id}</span>"&gt;<span class="hljs-subst">${item.content}</span>&lt;/div&gt;
  `</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
  
  <span class="hljs-comment">// 渲染完成后获取真实高度并更新</span>
  <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(items.<span class="hljs-property">children</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">el, idx</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> realHeight = el.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">height</span>;
    <span class="hljs-keyword">const</span> realIndex = startIndex + idx;
    itemHeights[realIndex] = realHeight;
  });
  
  <span class="hljs-comment">// 更新占位容器的总高度（动态累加）</span>
  <span class="hljs-keyword">const</span> totalHeight = itemHeights.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, height</span>) =&gt;</span> sum + height, <span class="hljs-number">0</span>);
  placeholder.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${totalHeight}</span>px`</span>;
}
</code></pre>
<h3 data-id="heading-14">4. 缓冲项（Buffer）的作用</h3>
<ul>
<li><strong>问题</strong>：快速滚动时，可视项还未渲染完成，会出现短暂空白；</li>
<li><strong>解决方案</strong>：在可视项前后各加 N 个缓冲项（通常 2~5 项），提前渲染部分数据，覆盖滚动的 “视觉延迟”；</li>
<li><strong>注意</strong>：缓冲项过多会增加 DOM 数量，过少则无法解决空白问题，需根据业务调整（一般 2~5 项）。</li>
</ul>
<h3 data-id="heading-15">5. DOM 复用（进阶优化）</h3>
<p>基础版每次渲染都用<code>innerHTML</code>重新生成 DOM，会销毁旧 DOM 并创建新 DOM，存在性能损耗。<strong>DOM 复用</strong>是更优方案：</p>
<ol>
<li>初始化时创建「可视项数量 + 缓冲项」的空 DOM 节点池；</li>
<li>滚动时仅更新节点的内容，而非销毁 / 创建节点；</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 初始化DOM池</span>
<span class="hljs-keyword">const</span> domPool = [];
<span class="hljs-keyword">const</span> visibleCount = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(config.<span class="hljs-property">viewHeight</span> / config.<span class="hljs-property">itemHeight</span>) + config.<span class="hljs-property">buffer</span>;
<span class="hljs-comment">// 创建空节点池</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; visibleCount; i++) {
  <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  el.<span class="hljs-property">className</span> = <span class="hljs-string">'list-item'</span>;
  domPool.<span class="hljs-title function_">push</span>(el);
  items.<span class="hljs-title function_">appendChild</span>(el);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderVisibleItems</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ... 计算startIndex/endIndex/visibleData ...</span>
  
  <span class="hljs-comment">// 复用DOM节点：仅更新内容，不创建新节点</span>
  visibleData.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, idx</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> el = domPool[idx];
    el.<span class="hljs-property">dataset</span>.<span class="hljs-property">id</span> = item.<span class="hljs-property">id</span>;
    el.<span class="hljs-property">textContent</span> = item.<span class="hljs-property">content</span>;
  });
  
  <span class="hljs-comment">// 隐藏超出可视数据的节点（可选）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = visibleData.<span class="hljs-property">length</span>; i &lt; domPool.<span class="hljs-property">length</span>; i++) {
    domPool[i].<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
  }
}
</code></pre>
<h2 data-id="heading-16">四、框架版虚拟列表（Vue3 示例）</h2>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
    <span class="hljs-attr">class</span>=<span class="hljs-string">"virtual-list-container"</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"containerRef"</span>
    @<span class="hljs-attr">scroll</span>=<span class="hljs-string">"handleScroll"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtual-list-placeholder"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: totalHeight + 'px' }"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtual-list-items"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ top: offsetTop + 'px' }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
        <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in visibleData"</span> 
        <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"list-item"</span>
      &gt;</span>
        {{ item.content }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, computed, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 配置</span>
<span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">viewHeight</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">itemHeight</span>: <span class="hljs-number">50</span>,
  <span class="hljs-attr">buffer</span>: <span class="hljs-number">2</span>
};

<span class="hljs-comment">// DOM引用</span>
<span class="hljs-keyword">const</span> containerRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
<span class="hljs-comment">// 响应式数据</span>
<span class="hljs-keyword">const</span> totalData = <span class="hljs-title function_">ref</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({ <span class="hljs-attr">id</span>: i, <span class="hljs-attr">content</span>: <span class="hljs-string">`列表项 <span class="hljs-subst">${i+<span class="hljs-number">1</span>}</span>`</span> })));
<span class="hljs-keyword">const</span> scrollTop = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-comment">// 计算属性：总高度</span>
<span class="hljs-keyword">const</span> totalHeight = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> totalData.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> * config.<span class="hljs-property">itemHeight</span>);
<span class="hljs-comment">// 计算属性：可视项相关</span>
<span class="hljs-keyword">const</span> visibleData = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> visibleCount = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(config.<span class="hljs-property">viewHeight</span> / config.<span class="hljs-property">itemHeight</span>) + config.<span class="hljs-property">buffer</span>;
  <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop.<span class="hljs-property">value</span> / config.<span class="hljs-property">itemHeight</span>));
  <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(totalData.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>, startIndex + visibleCount);
  <span class="hljs-keyword">return</span> totalData.<span class="hljs-property">value</span>.<span class="hljs-title function_">slice</span>(startIndex, endIndex + <span class="hljs-number">1</span>);
});
<span class="hljs-comment">// 计算属性：可视项偏移</span>
<span class="hljs-keyword">const</span> offsetTop = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop.<span class="hljs-property">value</span> / config.<span class="hljs-property">itemHeight</span>));
  <span class="hljs-keyword">return</span> startIndex * config.<span class="hljs-property">itemHeight</span>;
});

<span class="hljs-comment">// 滚动事件处理</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleScroll</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (containerRef.<span class="hljs-property">value</span>) {
    scrollTop.<span class="hljs-property">value</span> = containerRef.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span>;
  }
};

<span class="hljs-comment">// 初始化</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 防抖优化（可选）</span>
  <span class="hljs-keyword">const</span> debouncedHandleScroll = <span class="hljs-title function_">debounce</span>(handleScroll, <span class="hljs-number">16</span>);
  containerRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, debouncedHandleScroll);
});

<span class="hljs-comment">// 防抖函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay = <span class="hljs-number">16</span></span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timer);
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), delay);
  };
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.virtual-list-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e6e6e6</span>;
  <span class="hljs-attribute">overflow</span>: auto;
  <span class="hljs-attribute">position</span>: relative;
}
<span class="hljs-selector-class">.virtual-list-placeholder</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
}
<span class="hljs-selector-class">.virtual-list-items</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
}
<span class="hljs-selector-class">.list-item</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#f5f5f5</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-17">五、常见问题与避坑指南</h2>
<h3 data-id="heading-18">1. 滚动时出现空白</h3>
<ul>
<li>
<p><strong>原因</strong>：缓冲项不足、滚动防抖延迟过高、动态高度预估偏差；</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>增加缓冲项数量（如从 2 增至 5）；</li>
<li>降低防抖延迟（如 16ms，对应 60fps）；</li>
<li>动态高度场景下提前渲染更多缓冲项。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-19">2. 滚动条抖动</h3>
<ul>
<li>
<p><strong>原因</strong>：动态高度场景下，真实高度与预估高度偏差导致总高度频繁变化；</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>初始化时尽可能精准预估高度；</li>
<li>批量更新总高度（而非每次渲染都更新）；</li>
<li>限制总高度的更新频率。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-20">3. 大数据初始化卡顿</h3>
<ul>
<li>
<p><strong>原因</strong>：初始渲染时计算累计高度遍历全量数据；</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>分段初始化（先渲染前 100 项，后续滚动时再计算）；</li>
<li>使用 Web Worker 计算累计高度（避免阻塞主线程）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-21">4. 移动端滚动不流畅</h3>
<ul>
<li>
<p><strong>原因</strong>：移动端滚动有惯性，scroll 事件触发更频繁；</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用<code>passive: true</code>优化滚动事件（避免浏览器阻塞默认行为）：</li>
<li>开启硬件加速（<code>transform: translateZ(0)</code>）：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js">container.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, debouncedHandleScroll, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> });
</code></pre>
<pre><code class="hljs language-js" lang="js">.<span class="hljs-property">virtual</span>-list-items { <span class="hljs-attr">transform</span>: <span class="hljs-title function_">translateZ</span>(<span class="hljs-number">0</span>); }
</code></pre>
<h2 data-id="heading-22">六、总结</h2>
<p>虚拟列表的核心是「空间换时间」：用「占位容器 + 可视项容器」的 DOM 结构，换取「仅渲染可视区域 DOM」的性能提升。核心知识点可归纳为：</p>
<ol>
<li><strong>核心原理</strong>：可视区域计算 + 数据截取 + 偏移定位；</li>
<li><strong>性能优化</strong>：防抖、DOM 复用、缓冲项、硬件加速；</li>
<li><strong>适配场景</strong>：固定高度（简单）、动态高度（复杂）、加载更多（业务常用）；</li>
<li><strong>框架适配</strong>：利用响应式数据封装计算属性，简化滚动状态管理。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis常见问题排查手册]]></title>    <link>https://juejin.cn/post/7591670569910140974</link>    <guid>https://juejin.cn/post/7591670569910140974</guid>    <pubDate>2026-01-05T07:28:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591670569910140974" data-draft-id="7591635567588409390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Redis常见问题排查手册"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-05T07:28:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嘻哈baby"/> <meta itemprop="url" content="https://juejin.cn/user/485305583405066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Redis常见问题排查手册
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/485305583405066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嘻哈baby
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T07:28:52.000Z" title="Mon Jan 05 2026 07:28:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>Redis用着用着总会遇到各种问题：连接超时、内存暴涨、主从不同步、缓存雪崩...</p>
<p>这篇整理Redis常见问题的排查思路和解决方案，线上出问题时能快速定位。</p>
<hr/>
<h2 data-id="heading-1">一、连接问题</h2>
<h3 data-id="heading-2">1.1 连接超时</h3>
<p><strong>现象</strong>：客户端报<code>Connection timed out</code>或<code>JedisConnectionException</code></p>
<p><strong>排查步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查Redis是否存活</span>
redis-cli ping

<span class="hljs-comment"># 2. 检查端口是否监听</span>
ss -tlnp | grep 6379

<span class="hljs-comment"># 3. 检查连接数</span>
redis-cli info clients
<span class="hljs-comment"># connected_clients:150  ← 当前连接数</span>

<span class="hljs-comment"># 4. 查看最大连接数配置</span>
redis-cli config get maxclients
<span class="hljs-comment"># maxclients: 10000</span>

<span class="hljs-comment"># 5. 检查是否有慢查询阻塞</span>
redis-cli slowlog get 10
</code></pre>
<p><strong>常见原因</strong>：</p>
<ol>
<li><strong>连接数打满</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看客户端列表</span>
redis-cli client list

<span class="hljs-comment"># 找到空闲时间长的连接</span>
redis-cli client list | awk -F<span class="hljs-string">'[ =]'</span> <span class="hljs-string">'{print $4, $10}'</span> | <span class="hljs-built_in">sort</span> -k2 -rn | <span class="hljs-built_in">head</span>
</code></pre>
<p>解决：增大maxclients，或检查客户端连接池配置。</p>
<ol start="2">
<li><strong>网络问题</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试网络延迟</span>
redis-cli --latency

<span class="hljs-comment"># 持续监控</span>
redis-cli --latency-history
</code></pre>
<ol start="3">
<li><strong>Redis阻塞</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查阻塞操作</span>
redis-cli info stats | grep blocked
</code></pre>
<h3 data-id="heading-3">1.2 连接被拒绝</h3>
<p><strong>现象</strong>：<code>Connection refused</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查绑定地址</span>
redis-cli config get <span class="hljs-built_in">bind</span>
<span class="hljs-comment"># 如果是 127.0.0.1，远程无法连接</span>

<span class="hljs-comment"># 修改配置</span>
<span class="hljs-comment"># /etc/redis/redis.conf</span>
<span class="hljs-built_in">bind</span> 0.0.0.0  <span class="hljs-comment"># 或具体IP</span>

<span class="hljs-comment"># 检查防火墙</span>
iptables -L -n | grep 6379
firewall-cmd --list-ports | grep 6379
</code></pre>
<hr/>
<h2 data-id="heading-4">二、内存问题</h2>
<h3 data-id="heading-5">2.1 内存暴涨</h3>
<p><strong>排查步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看内存使用</span>
redis-cli info memory
<span class="hljs-comment"># used_memory_human: 2.5G</span>
<span class="hljs-comment"># used_memory_peak_human: 3.1G</span>
<span class="hljs-comment"># maxmemory_human: 4G</span>

<span class="hljs-comment"># 2. 查看各类型key的内存占用</span>
redis-cli memory doctor

<span class="hljs-comment"># 3. 分析大key</span>
redis-cli --bigkeys

<span class="hljs-comment"># 4. 扫描特定前缀的key数量</span>
redis-cli keys <span class="hljs-string">"user:*"</span> | <span class="hljs-built_in">wc</span> -l
<span class="hljs-comment"># 注意：生产环境用 scan 代替 keys</span>
redis-cli scan 0 match <span class="hljs-string">"user:*"</span> count 1000
</code></pre>
<p><strong>找出大key</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 分析RDB文件（推荐）</span>
<span class="hljs-comment"># 安装 rdb-tools</span>
pip install rdbtools python-lzf

<span class="hljs-comment"># 导出大key报告</span>
rdb -c memory /var/lib/redis/dump.rdb --bytes 10240 -f memory.csv
</code></pre>
<p>或者用Redis自带命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看某个key的内存占用</span>
redis-cli memory usage mykey

<span class="hljs-comment"># 批量分析</span>
redis-cli --bigkeys -i 0.1  <span class="hljs-comment"># 每100ms扫描一次，降低影响</span>
</code></pre>
<h3 data-id="heading-6">2.2 内存淘汰</h3>
<p><strong>现象</strong>：写入失败，报<code>OOM command not allowed</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看淘汰策略</span>
redis-cli config get maxmemory-policy
<span class="hljs-comment"># volatile-lru / allkeys-lru / noeviction 等</span>

<span class="hljs-comment"># 查看淘汰统计</span>
redis-cli info stats | grep evicted
<span class="hljs-comment"># evicted_keys: 12345</span>
</code></pre>
<p><strong>淘汰策略说明</strong>：</p>

































<table><thead><tr><th>策略</th><th>说明</th></tr></thead><tbody><tr><td>noeviction</td><td>不淘汰，内存满了报错</td></tr><tr><td>volatile-lru</td><td>淘汰有过期时间的key（LRU）</td></tr><tr><td>allkeys-lru</td><td>淘汰所有key（LRU）</td></tr><tr><td>volatile-ttl</td><td>淘汰TTL最短的key</td></tr><tr><td>volatile-random</td><td>随机淘汰有过期时间的key</td></tr><tr><td>allkeys-random</td><td>随机淘汰</td></tr></tbody></table>
<p><strong>建议配置</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># redis.conf</span>
maxmemory 4gb
maxmemory-policy allkeys-lru
</code></pre>
<h3 data-id="heading-7">2.3 内存碎片</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看碎片率</span>
redis-cli info memory | grep mem_fragmentation_ratio
<span class="hljs-comment"># mem_fragmentation_ratio: 1.52</span>

<span class="hljs-comment"># 大于1.5说明碎片较多</span>
</code></pre>
<p>解决方案：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Redis 4.0+ 支持在线碎片整理</span>
redis-cli config <span class="hljs-built_in">set</span> activedefrag <span class="hljs-built_in">yes</span>

<span class="hljs-comment"># 或者重启Redis</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">三、主从问题</h2>
<h3 data-id="heading-9">3.1 主从不同步</h3>
<p><strong>现象</strong>：从库数据和主库不一致</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看复制状态</span>
redis-cli info replication

<span class="hljs-comment"># 主库显示</span>
role:master
connected_slaves:1
slave0:ip=192.168.1.2,port=6379,state=online,offset=123456,lag=0

<span class="hljs-comment"># 从库显示</span>
role:slave
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
</code></pre>
<p><strong>关键指标</strong>：</p>
<ul>
<li><code>master_link_status</code>：up正常，down断开</li>
<li><code>master_last_io_seconds_ago</code>：与主库最后通信时间</li>
<li><code>lag</code>：复制延迟</li>
</ul>
<p><strong>常见原因</strong>：</p>
<ol>
<li><strong>网络问题</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从库上检查</span>
redis-cli info replication | grep master_link_down_since_seconds
</code></pre>
<ol start="2">
<li><strong>复制缓冲区溢出</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 主库配置</span>
redis-cli config get repl-backlog-size
<span class="hljs-comment"># 默认1MB，高并发写入需要调大</span>

<span class="hljs-comment"># 建议配置</span>
repl-backlog-size 256mb
</code></pre>
<ol start="3">
<li><strong>从库复制超时</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查超时配置</span>
redis-cli config get repl-timeout
<span class="hljs-comment"># 默认60秒</span>

<span class="hljs-comment"># 大数据量同步可能需要调大</span>
repl-timeout 300
</code></pre>
<h3 data-id="heading-10">3.2 主从切换后数据丢失</h3>
<p><strong>原因</strong>：异步复制导致主库写入未同步到从库就宕机了</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置最少从库数量</span>
min-replicas-to-write 1
min-replicas-max-lag 10

<span class="hljs-comment"># 含义：至少1个从库延迟不超过10秒，否则主库拒绝写入</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">四、性能问题</h2>
<h3 data-id="heading-12">4.1 慢查询</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看慢查询日志</span>
redis-cli slowlog get 10

<span class="hljs-comment"># 输出示例</span>
1) 1) (<span class="hljs-built_in">integer</span>) 123          <span class="hljs-comment"># ID</span>
   2) (<span class="hljs-built_in">integer</span>) 1609459200   <span class="hljs-comment"># 时间戳</span>
   3) (<span class="hljs-built_in">integer</span>) 15000        <span class="hljs-comment"># 耗时（微秒）</span>
   4) 1) <span class="hljs-string">"keys"</span>              <span class="hljs-comment"># 命令</span>
      2) <span class="hljs-string">"*"</span>

<span class="hljs-comment"># 配置慢查询阈值（微秒）</span>
redis-cli config <span class="hljs-built_in">set</span> slowlog-log-slower-than 10000  <span class="hljs-comment"># 10ms</span>
redis-cli config <span class="hljs-built_in">set</span> slowlog-max-len 1000
</code></pre>
<p><strong>常见慢操作</strong>：</p>



































<table><thead><tr><th>命令</th><th>问题</th><th>替代方案</th></tr></thead><tbody><tr><td>keys *</td><td>全库扫描</td><td>scan</td></tr><tr><td>hgetall</td><td>大hash</td><td>hscan / 只取需要的字段</td></tr><tr><td>smembers</td><td>大set</td><td>sscan</td></tr><tr><td>lrange 0 -1</td><td>大list</td><td>分页获取</td></tr><tr><td>del bigkey</td><td>阻塞删除</td><td>unlink（异步删除）</td></tr></tbody></table>
<h3 data-id="heading-13">4.2 热点key</h3>
<p><strong>现象</strong>：QPS很高但集群负载不均</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开启热点key统计（Redis 4.0+）</span>
redis-cli --hotkeys

<span class="hljs-comment"># 或者用monitor采样（生产慎用）</span>
redis-cli monitor | <span class="hljs-built_in">head</span> -10000 &gt; monitor.log
awk <span class="hljs-string">'{print $4}'</span> monitor.log | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -rn | <span class="hljs-built_in">head</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>本地缓存</strong>：热点数据在应用层缓存</li>
<li><strong>读写分离</strong>：读请求分散到从库</li>
<li><strong>key拆分</strong>：<code>hotkey</code> → <code>hotkey:1</code>, <code>hotkey:2</code>...</li>
</ol>
<h3 data-id="heading-14">4.3 大key删除阻塞</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看key元素数量</span>
redis-cli llen mylist
redis-cli hlen myhash
redis-cli scard myset

<span class="hljs-comment"># 异步删除（Redis 4.0+）</span>
redis-cli <span class="hljs-built_in">unlink</span> bigkey

<span class="hljs-comment"># 或者分批删除</span>
<span class="hljs-comment"># Hash</span>
redis-cli hscan myhash 0 count 100
<span class="hljs-comment"># 然后 hdel 分批删</span>

<span class="hljs-comment"># List</span>
redis-cli ltrim mylist 0 -1001  <span class="hljs-comment"># 每次删1000个</span>
</code></pre>
<hr/>
<h2 data-id="heading-15">五、持久化问题</h2>
<h3 data-id="heading-16">5.1 RDB持久化失败</h3>
<p><strong>现象</strong>：日志报<code>Background saving error</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看最近一次持久化状态</span>
redis-cli info persistence
<span class="hljs-comment"># rdb_last_bgsave_status: ok/err</span>
<span class="hljs-comment"># rdb_last_bgsave_time_sec: 5</span>

<span class="hljs-comment"># 查看日志</span>
<span class="hljs-built_in">tail</span> -100 /var/log/redis/redis-server.log
</code></pre>
<p><strong>常见原因</strong>：</p>
<ol>
<li><strong>磁盘空间不足</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">df</span> -h
</code></pre>
<ol start="2">
<li><strong>fork失败（内存不足）</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查overcommit配置</span>
<span class="hljs-built_in">cat</span> /proc/sys/vm/overcommit_memory
<span class="hljs-comment"># 0: 默认，可能导致fork失败</span>
<span class="hljs-comment"># 1: 允许overcommit</span>

<span class="hljs-comment"># 修改</span>
<span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/vm/overcommit_memory
<span class="hljs-comment"># 或永久修改 /etc/sysctl.conf</span>
vm.overcommit_memory = 1
</code></pre>
<ol start="3">
<li><strong>透明大页导致延迟</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 禁用透明大页</span>
<span class="hljs-built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled
</code></pre>
<h3 data-id="heading-17">5.2 AOF重写阻塞</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看AOF状态</span>
redis-cli info persistence | grep aof

<span class="hljs-comment"># 手动触发重写</span>
redis-cli bgrewriteaof

<span class="hljs-comment"># 配置自动重写</span>
auto-aof-rewrite-percentage 100  <span class="hljs-comment"># 增长100%触发</span>
auto-aof-rewrite-min-size 64mb   <span class="hljs-comment"># 最小64MB才触发</span>
</code></pre>
<hr/>
<h2 data-id="heading-18">六、集群问题</h2>
<h3 data-id="heading-19">6.1 集群状态异常</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看集群状态</span>
redis-cli cluster info
<span class="hljs-comment"># cluster_state:ok/fail</span>
<span class="hljs-comment"># cluster_slots_assigned:16384</span>
<span class="hljs-comment"># cluster_slots_ok:16384</span>
<span class="hljs-comment"># cluster_slots_fail:0</span>

<span class="hljs-comment"># 查看节点</span>
redis-cli cluster nodes
</code></pre>
<p><strong>常见问题</strong>：</p>
<ol>
<li><strong>slot未分配</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查slot覆盖</span>
redis-cli cluster slots

<span class="hljs-comment"># 手动分配</span>
redis-cli cluster addslots 0 1 2 ...
</code></pre>
<ol start="2">
<li><strong>节点故障</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看失败节点</span>
redis-cli cluster nodes | grep fail

<span class="hljs-comment"># 手动故障转移</span>
redis-cli cluster failover
</code></pre>
<h3 data-id="heading-20">6.2 MOVED/ASK错误</h3>
<p>客户端报<code>MOVED</code>或<code>ASK</code>错误，说明请求到了错误的节点。</p>
<p><strong>解决</strong>：使用集群模式的客户端</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 命令行用-c参数</span>
redis-cli -c -h host -p port

<span class="hljs-comment"># 客户端库要用cluster模式</span>
<span class="hljs-comment"># Java: JedisCluster</span>
<span class="hljs-comment"># Python: redis-py-cluster</span>
</code></pre>
<h3 data-id="heading-21">6.3 跨机房/跨网络访问</h3>
<p>多个机房部署的Redis需要互通，或者本地开发需要连远程Redis。</p>
<p><strong>方案1：SSH隧道</strong></p>
<pre><code class="hljs language-bash" lang="bash">ssh -L 6379:redis-server:6379 user@跳板机 -N
redis-cli -h 127.0.0.1
</code></pre>
<p><strong>方案2：VPN/组网</strong></p>
<p>如果经常需要访问多个内网Redis，用组网工具更方便。WireGuard、ZeroTier、星空组网这类工具配置一次，后续直接用内网IP访问，不用每次建隧道。</p>
<hr/>
<h2 data-id="heading-22">七、快速诊断脚本</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># redis_check.sh</span>

REDIS_CLI=<span class="hljs-string">"redis-cli"</span>
HOST=<span class="hljs-variable">${1:-127.0.0.1}</span>
PORT=<span class="hljs-variable">${2:-6379}</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== Redis诊断 <span class="hljs-variable">$HOST</span>:<span class="hljs-variable">$PORT</span> ==="</span>

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n[1] 连通性"</span>
<span class="hljs-variable">$REDIS_CLI</span> -h <span class="hljs-variable">$HOST</span> -p <span class="hljs-variable">$PORT</span> ping

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n[2] 内存使用"</span>
<span class="hljs-variable">$REDIS_CLI</span> -h <span class="hljs-variable">$HOST</span> -p <span class="hljs-variable">$PORT</span> info memory | grep -E <span class="hljs-string">"used_memory_human|maxmemory_human|mem_fragmentation_ratio"</span>

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n[3] 连接数"</span>
<span class="hljs-variable">$REDIS_CLI</span> -h <span class="hljs-variable">$HOST</span> -p <span class="hljs-variable">$PORT</span> info clients | grep connected_clients

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n[4] 复制状态"</span>
<span class="hljs-variable">$REDIS_CLI</span> -h <span class="hljs-variable">$HOST</span> -p <span class="hljs-variable">$PORT</span> info replication | grep -E <span class="hljs-string">"role|master_link_status|connected_slaves"</span>

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n[5] 持久化"</span>
<span class="hljs-variable">$REDIS_CLI</span> -h <span class="hljs-variable">$HOST</span> -p <span class="hljs-variable">$PORT</span> info persistence | grep -E <span class="hljs-string">"rdb_last_bgsave_status|aof_enabled"</span>

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n[6] 慢查询（最近5条）"</span>
<span class="hljs-variable">$REDIS_CLI</span> -h <span class="hljs-variable">$HOST</span> -p <span class="hljs-variable">$PORT</span> slowlog get 5

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n[7] Key数量"</span>
<span class="hljs-variable">$REDIS_CLI</span> -h <span class="hljs-variable">$HOST</span> -p <span class="hljs-variable">$PORT</span> dbsize

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n[8] QPS"</span>
<span class="hljs-variable">$REDIS_CLI</span> -h <span class="hljs-variable">$HOST</span> -p <span class="hljs-variable">$PORT</span> info stats | grep instantaneous_ops_per_sec

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n=== 诊断完成 ==="</span>
</code></pre>
<hr/>
<h2 data-id="heading-23">总结</h2>
<p>Redis问题排查思路：</p>








































<table><thead><tr><th>问题类型</th><th>排查命令</th><th>关键指标</th></tr></thead><tbody><tr><td>连接问题</td><td>info clients</td><td>connected_clients</td></tr><tr><td>内存问题</td><td>info memory</td><td>used_memory, fragmentation</td></tr><tr><td>主从问题</td><td>info replication</td><td>master_link_status, lag</td></tr><tr><td>性能问题</td><td>slowlog get</td><td>慢查询命令</td></tr><tr><td>持久化</td><td>info persistence</td><td>rdb/aof状态</td></tr><tr><td>集群问题</td><td>cluster info</td><td>cluster_state</td></tr></tbody></table>
<p>核心命令：</p>
<pre><code class="hljs language-bash" lang="bash">redis-cli info          <span class="hljs-comment"># 整体状态</span>
redis-cli info memory   <span class="hljs-comment"># 内存</span>
redis-cli info clients  <span class="hljs-comment"># 连接</span>
redis-cli info replication  <span class="hljs-comment"># 主从</span>
redis-cli slowlog get 10    <span class="hljs-comment"># 慢查询</span>
redis-cli --bigkeys     <span class="hljs-comment"># 大key分析</span>
redis-cli monitor       <span class="hljs-comment"># 实时命令监控（慎用）</span>
</code></pre>
<p>遇到问题先看<code>info</code>，90%的问题都能从这里找到线索。</p>
<hr/>
<p>有问题评论区交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 KuiklyUI Canvas 打造天气预测图表]]></title>    <link>https://juejin.cn/post/7591544356000661514</link>    <guid>https://juejin.cn/post/7591544356000661514</guid>    <pubDate>2026-01-05T04:06:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591544356000661514" data-draft-id="7591403124327039039" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 KuiklyUI Canvas 打造天气预测图表"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-05T04:06:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我有与与症"/> <meta itemprop="url" content="https://juejin.cn/user/4466629837071787"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 KuiklyUI Canvas 打造天气预测图表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4466629837071787/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我有与与症
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:06:55.000Z" title="Mon Jan 05 2026 04:06:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent-TDS%2FKuiklyUI%2Ftree%2Fmain%2Fdemo%2Fsrc%2FcommonMain%2Fkotlin%2Fcom%2Ftencent%2Fkuikly%2Fdemo%2Fpages%2FWeatherCanvasPage.kt" target="_blank" title="https://github.com/Tencent-TDS/KuiklyUI/tree/main/demo/src/commonMain/kotlin/com/tencent/kuikly/demo/pages/WeatherCanvasPage.kt" ref="nofollow noopener noreferrer">GitHub</a></p>
<p>从最早的 Android 入门教程，到 iOS SwiftUI 官方示例，再到 React、Flutter、鸿蒙... 天气应用几乎是所有 UI 框架的"Hello World Plus"——它足够简单，能让你快速上手；又足够丰富，涵盖了数据展示、图表绑定等核心技能。</p>
<p>今天，我们用 Kuikly 来完成这个demo：<strong>用一套 Kotlin 代码，画一个能在 Android、iOS、鸿蒙三端运行的雨量预测图表</strong>。</p>
<p>别担心，这篇文章专门为新手准备，我们会从最基础的概念讲起。准备好了吗？Let's go！</p>
<h2 data-id="heading-0">我们要做什么？</h2>
<p>先看看最终效果：一张带毛玻璃效果的卡片，上面有一条蓝色的曲线，展示未来 90 分钟的雨量变化。左边是雨量等级（暴雨、大雨、中雨、小雨），底部是时间轴（现在、30分钟、60分钟、90分钟）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7c68b1f0aa84d8ca10c0cbe4dc07e15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5pyJ5LiO5LiO55eH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768190816&amp;x-signature=lpiki8bpadK%2BWe4vRMHG%2BlBULh4%3D" alt="image.png" loading="lazy"/></p>
<p>是不是很眼熟？没错，这就是各大天气 App 里那个"分钟级降水预报"的同款！</p>
<h2 data-id="heading-1">第一步：搭建页面骨架</h2>
<p>在 Kuikly 中，一个页面就是一个继承自 <code>BasePager</code> 的类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Page(<span class="hljs-string">"WeatherCanvasPage"</span>)</span>  <span class="hljs-comment">// 给页面取个名字，用于路由跳转</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherCanvasPage</span> : <span class="hljs-type">BasePager</span>() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">()</span></span>: ViewBuilder {
        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">// 页面内容写在这里</span>
        }
    }
}
</code></pre>
<p><strong>tips</strong>：</p>
<ul>
<li>
<p><code>@Page("xxx")</code> 就像给页面起了个门牌号</p>
</li>
<li>
<p><code>body()</code> 方法返回页面的 UI 结构，所有组件都写在大括号里</p>
</li>
</ul>
<h2 data-id="heading-2">第二步：铺一张好看的背景图</h2>
<p>天气应用嘛，氛围感很重要！</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">()</span></span>: ViewBuilder {
    <span class="hljs-keyword">return</span> {
        attr {
            flex(<span class="hljs-number">1f</span>)  <span class="hljs-comment">// flex 弹性布局</span>
            backgroundColor(Color(<span class="hljs-number">0x436082</span>, <span class="hljs-number">1f</span>))  <span class="hljs-comment">// 蓝灰色底色</span>
        }

        <span class="hljs-comment">// 背景图</span>
        Image {
            attr {
                src(<span class="hljs-string">"https://qq-weather.cdn-go.cn/weather/latest/rain-bg/rain-comming.png"</span>)
                positionAbsolute()  <span class="hljs-comment">// 绝对定位</span>
                left(<span class="hljs-number">0f</span>); right(<span class="hljs-number">0f</span>); top(<span class="hljs-number">0f</span>); bottom(<span class="hljs-number">0f</span>)  <span class="hljs-comment">// 铺满全屏</span>
            }
        }
    }
}
</code></pre>
<p><strong>tips</strong>：</p>
<ul>
<li>
<p><code>attr { }</code> 用来设置组件样式，类似 CSS</p>
</li>
<li>
<p><code>positionAbsolute()</code> + 四边为 0 = 铺满父容器</p>
</li>
</ul>
<h2 data-id="heading-3">第三步：自定义组件</h2>
<p>接下来我们要添加图表卡片。但 <code>RainFallNodeCanvas</code> 不是内置组件，而是我们自己造的！</p>
<p>这就是 Kuikly 的魅力：<strong>把复杂 UI 封装成可复用的积木块</strong>。</p>
<p>一个自定义组件需要三样东西：</p>





















<table><thead><tr><th>组成部分</th><th>作用</th></tr></thead><tbody><tr><td>属性类 (Attr)</td><td>定义组件接收什么数据</td></tr><tr><td>组件类 (ComposeView)</td><td>定义组件长什么样</td></tr><tr><td>扩展函数</td><td>让组件用起来更顺手</td></tr></tbody></table>
<h3 data-id="heading-4">3.1 定义属性：这个组件需要什么数据？</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RainFallNodeAttr</span> : <span class="hljs-type">ComposeAttr</span>() {
    <span class="hljs-comment">// 雨量数据：24个点，代表未来90分钟的降水量</span>
    <span class="hljs-keyword">var</span> nodes: List&lt;<span class="hljs-built_in">Float</span>&gt; <span class="hljs-keyword">by</span> observable(
        listOf(<span class="hljs-number">1.3f</span>, <span class="hljs-number">2.6f</span>, <span class="hljs-number">4.2f</span>, <span class="hljs-number">5.1f</span>, <span class="hljs-number">3.5f</span>, ...)
    )
    
    <span class="hljs-comment">// 顶部提示文字</span>
    <span class="hljs-keyword">var</span> title: String <span class="hljs-keyword">by</span> observable(<span class="hljs-string">"雨渐大，30分钟后雨会停"</span>)
    
    <span class="hljs-comment">// Y轴标签</span>
    <span class="hljs-keyword">var</span> rainLevel1Title: String <span class="hljs-keyword">by</span> observable(<span class="hljs-string">"暴雨"</span>)
    <span class="hljs-keyword">var</span> rainLevel2Title: String <span class="hljs-keyword">by</span> observable(<span class="hljs-string">"大雨"</span>)
    <span class="hljs-keyword">var</span> rainLevel3Title: String <span class="hljs-keyword">by</span> observable(<span class="hljs-string">"中雨"</span>)
    <span class="hljs-keyword">var</span> rainLevel4Title: String <span class="hljs-keyword">by</span> observable(<span class="hljs-string">"小雨"</span>)
}
</code></pre>
<p><strong>划重点</strong>：<code>by observable(...)</code> 是 Kuikly 的响应式魔法！数据一变，UI 自动刷新，不用手动调用任何刷新方法。</p>
<h3 data-id="heading-5">3.2 定义组件：它长什么样？</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherRainFallNodeCanvas</span> : <span class="hljs-type">ComposeView</span>&lt;<span class="hljs-type">RainFallNodeAttr, ComposeEvent</span>&gt;() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> nodeAttr = RainFallNodeAttr()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">()</span></span>: ViewBuilder {
        <span class="hljs-keyword">val</span> ctx = <span class="hljs-keyword">this</span>
        <span class="hljs-keyword">return</span> {
            attr {
                size(<span class="hljs-number">335f</span>, <span class="hljs-number">250f</span>)  <span class="hljs-comment">// 卡片大小</span>
                borderRadius(BorderRectRadius(<span class="hljs-number">16f</span>, <span class="hljs-number">16f</span>, <span class="hljs-number">16f</span>, <span class="hljs-number">16f</span>))  <span class="hljs-comment">// 圆角</span>
            }

            <span class="hljs-comment">// 1. 毛玻璃背景</span>
            Blur {
                attr {
                    absolutePosition(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>)
                    blurRadius(<span class="hljs-number">10.0f</span>)
                }
            }

            <span class="hljs-comment">// 2. 顶部提示文字</span>
            Text { attr { text(ctx.nodeAttr.title) } }

            <span class="hljs-comment">// 3. Canvas 画布（核心！）</span>
            Canvas({ ... }) { context, width, height -&gt;
                <span class="hljs-comment">// 在这里画曲线</span>
            }

            <span class="hljs-comment">// 4. Y轴标签：暴雨、大雨...</span>
            <span class="hljs-comment">// 5. X轴标签：现在、30分钟...</span>
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createAttr</span><span class="hljs-params">()</span></span> = nodeAttr
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createEvent</span><span class="hljs-params">()</span></span> = ComposeEvent()
}
</code></pre>
<h2 data-id="heading-6">第四步：用 Canvas 画曲线（核心！）</h2>
<p>Canvas 就是一块"画布"，你可以在上面画任何东西。</p>
<h3 data-id="heading-7">4.1 Canvas 基本用法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Canvas(
    { attr { absolutePosition(<span class="hljs-number">55f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">24f</span>, <span class="hljs-number">0f</span>) } }
) { context, width, height -&gt;
    <span class="hljs-comment">// context = 画笔</span>
    <span class="hljs-comment">// width, height = 画布尺寸</span>
}
</code></pre>
<h3 data-id="heading-8">4.2 画一条丝滑的曲线</h3>
<p>直接用直线连接数据点会很丑（像心电图），我们用<strong>贝塞尔曲线</strong>让它丝滑：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 设置画笔</span>
context.beginPath()
context.strokeStyle(Color(<span class="hljs-number">0x0085FF</span>, <span class="hljs-number">1f</span>))  <span class="hljs-comment">// 天空蓝</span>
context.lineWidth(<span class="hljs-number">5.0f</span>)                    <span class="hljs-comment">// 线条粗细</span>
context.lineCapRound()                     <span class="hljs-comment">// 圆头端点</span>
context.moveTo(<span class="hljs-number">0f</span>, height)                 <span class="hljs-comment">// 起点：左下角</span>

<span class="hljs-comment">// 2. 遍历数据点，画曲线</span>
<span class="hljs-keyword">for</span> ((index, node) <span class="hljs-keyword">in</span> nodeAttr.nodes.withIndex()) {
    <span class="hljs-keyword">val</span> x = index * width / <span class="hljs-number">24</span>                  <span class="hljs-comment">// X坐标</span>
    <span class="hljs-keyword">val</span> y = height - node * height / <span class="hljs-number">10</span>         <span class="hljs-comment">// Y坐标（数据映射）</span>
    
    <span class="hljs-comment">// 用贝塞尔曲线连接，比直线更丝滑</span>
    context.quadraticCurveTo(controlX, controlY, nextX, nextY)
}

<span class="hljs-comment">// 3. 完成绑定</span>
context.stroke()
</code></pre>
<p><strong>什么是贝塞尔曲线？</strong> 简单说：</p>
<ul>
<li>
<p>直线：A → B，走直线</p>
</li>
<li>
<p>贝塞尔：A → B，但要"绕过"控制点 C，形成弧线</p>
</li>
</ul>
<h3 data-id="heading-9">4.3 画虚线（参考线）</h3>
<p>没有虚线 API？没关系，手搓一个：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">renderDashLine</span><span class="hljs-params">(context: <span class="hljs-type">CanvasContext</span>, width: <span class="hljs-type">Float</span>, y: <span class="hljs-type">Float</span>)</span></span> {
    context.beginPath()
    context.strokeStyle(Color(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.2f</span>))  <span class="hljs-comment">// 半透明白</span>
    
    <span class="hljs-keyword">var</span> x = <span class="hljs-number">10f</span>
    <span class="hljs-keyword">while</span> (x &lt; width) {
        context.lineTo(x + <span class="hljs-number">5f</span>, y)   <span class="hljs-comment">// 画 5 像素</span>
        x += <span class="hljs-number">7.5f</span>
        context.moveTo(x, y)        <span class="hljs-comment">// 跳过 2.5 像素</span>
    }
    context.stroke()
}
</code></pre>
<p>原理：画一段、跳一段、画一段、跳一段...</p>
<h2 data-id="heading-10">第五步：让组件更好用</h2>
<p>写个扩展函数，让自定义组件用起来和内置组件一样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> ViewContainer<span class="hljs-type">&lt;*, *&gt;</span>.<span class="hljs-title">RainFallNodeCanvas</span><span class="hljs-params">(
    <span class="hljs-keyword">init</span>: <span class="hljs-type">WeatherRainFallNodeCanvas</span>.() -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    addChild(WeatherRainFallNodeCanvas(), <span class="hljs-keyword">init</span>)
}
</code></pre>
<p>现在可以这样用了：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">RainFallNodeCanvas {
    attr {
        positionAbsolute()
        top(<span class="hljs-number">178.5f</span>)
        left(<span class="hljs-number">20f</span>)
    }
}
</code></pre>
<p>和 <code>Text</code>、<code>Image</code> 一模一样的写法！</p>
<h2 data-id="heading-11">总结</h2>
<p>恭喜完成 Kuikly "天气App"！回顾一下核心技能：</p>





































<table><thead><tr><th>技能</th><th>总结</th></tr></thead><tbody><tr><td>页面定义</td><td>继承 <code>BasePager</code> + <code>@Page</code> 注解</td></tr><tr><td>布局系统</td><td><code>attr { }</code> 设样式，<code>positionAbsolute()</code> 绝对定位</td></tr><tr><td>自定义组件</td><td>继承 <code>ComposeView</code>，定义 Attr + body()</td></tr><tr><td>响应式数据</td><td><code>by observable()</code> 数据变 → UI 自动刷新</td></tr><tr><td>Canvas bindbindbindbindbindbindbindind</td><td>回调式 API，拿到 context 就能画</td></tr><tr><td>贝塞尔曲线</td><td><code>quadraticCurveTo()</code> 让曲线更丝滑</td></tr><tr><td>毛玻璃效果</td><td><code>Blur</code> 组件一行搞定</td></tr></tbody></table>
<p>下次产品经理甩给你"参考天气 App 做个图表"的需求，你就可以自信地说：<strong>小场面！</strong></p>
<p>代码已经躺在 GitHub 上了，还不快去 Clone 下来跑一跑？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【车载Android】多媒体开发入门（上） - MediaSession]]></title>    <link>https://juejin.cn/post/7591407298414247942</link>    <guid>https://juejin.cn/post/7591407298414247942</guid>    <pubDate>2026-01-05T04:48:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591407298414247942" data-draft-id="7591334602427318335" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【车载Android】多媒体开发入门（上） - MediaSession"/> <meta itemprop="keywords" content="Android,Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-05T04:48:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林栩link"/> <meta itemprop="url" content="https://juejin.cn/user/870468939434039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【车载Android】多媒体开发入门（上） - MediaSession
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/870468939434039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林栩link
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:48:58.000Z" title="Mon Jan 05 2026 04:48:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{font-family:-apple-system,BlinkMacSystemFont,PingFang SC,Helvetica Neue,Helvetica,Arial,sans-serif;word-break:break-word;line-height:1.75;font-weight:200;font-size:16px;overflow-x:hidden;color:#666;letter-spacing:.5px}.markdown-body a{text-decoration:none;color:#0064c8;position:relative}.markdown-body a:after{content:"";position:absolute;bottom:-2px;left:0;width:100%;height:1px;background-color:rgba(0,100,200,.7);transform:scale(0);transition:all .4s ease-in-out}.markdown-body a:link:hover:after{transform:scale(1)}.markdown-body code{padding:2px 4px;font-size:.9em;font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px;background-color:rgba(0,46,70,.0431);color:#39f}.markdown-body strong{font-weight:400}.markdown-body em{color:#ff6a00}.markdown-body del,.markdown-body s{color:#bbb}.markdown-body small{font-size:.8em;color:#bbb}.markdown-body kbd{margin:0 .1em;padding:5px 8px 3px;border:1px solid #d1d5d9;border-radius:3px;box-shadow:0 1px 0 0 #e3e4e6,inset 0 0 0 2px #fff;background-color:#eee;font-weight:600;font-size:.8em;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;white-space:nowrap;color:#666}.markdown-body kbd:first-child{margin-left:0}.markdown-body kbd:last-child{margin-right:0}.markdown-body img{display:block;border:0;max-width:calc(100% - 20px);min-width:20px;min-height:20px;margin:0 10px;box-shadow:0 2px 8px 2px rgba(0,0,0,.2);transition:all .25s ease-in-out}.markdown-body img:hover{transform:translateY(-4px)}.markdown-body blockquote,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{line-height:inherit;font-size:inherit;color:inherit}.markdown-body blockquote:first-child,.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child,.markdown-body ol:first-child,.markdown-body p:first-child,.markdown-body pre:first-child,.markdown-body table:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body blockquote:last-child,.markdown-body h1:last-child,.markdown-body h2:last-child,.markdown-body h3:last-child,.markdown-body h4:last-child,.markdown-body h5:last-child,.markdown-body h6:last-child,.markdown-body ol:last-child,.markdown-body p:last-child,.markdown-body pre:last-child,.markdown-body table:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:1.6em 0 .6em;color:#333;font-weight:400;position:relative}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:-2em}.markdown-body h1{font-size:1.75em}.markdown-body h1:before{content:"#"}.markdown-body h1:first-child{margin-top:0}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.35em}.markdown-body h4{font-size:1.2em}.markdown-body h5{font-size:1.1em}.markdown-body h6{font-size:1em}.markdown-body blockquote,.markdown-body ol,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:1em 0}.markdown-body p{margin:.7em 0;word-break:break-word}.markdown-body pre{padding:8px 12px;color:#666;background-color:rgba(0,46,70,.0431);border:1px solid #ebebeb;tab-size:4;white-space:pre-wrap;line-height:1.4}.markdown-body pre code{color:inherit;background-color:transparent;padding:0}.markdown-body ol,.markdown-body ul{margin:1em 0 1em 2em;padding:0;line-height:1.5!important;font-size:inherit;color:inherit}.markdown-body ol:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body ol:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body ol li,.markdown-body ul li{margin:.5em 0;list-style:inherit}.markdown-body ul{list-style:disc outside}.markdown-body ul ul{list-style-type:circle}.markdown-body ul ul ul{list-style-type:square}.markdown-body ol{list-style:decimal outside}.markdown-body ol ol{list-style-type:lower-alpha}.markdown-body ol ol ol{list-style-type:lower-roman}.markdown-body blockquote{font-size:.9em;padding:8px 20px 8px 15px;color:#666;border-left:5px solid rgba(0,100,200,.7);background-color:rgba(0,100,200,.1)}.markdown-body table{border-collapse:collapse;border-spacing:0;max-width:100%;min-width:50%;word-wrap:break-word;color:inherit}.markdown-body table thead tr{background-color:#f4f6f7}.markdown-body table td,.markdown-body table th{padding:4px 16px;font-size:.95em;text-align:left;color:inherit;border:0;min-width:72px}.markdown-body table td[align=center],.markdown-body table th[align=center]{text-align:center}.markdown-body table td[align=right],.markdown-body table th[align=right]{text-align:right}.markdown-body table th{border-bottom:2px solid #e3e4e6;color:#333;font-weight:400;white-space:nowrap}.markdown-body table td{border-bottom:1px solid #ebebeb}.markdown-body hr{margin:1.5em 0;padding:0;border:0;background:linear-gradient(90deg,rgba(0,46,70,.0431),#ebebeb 50%,rgba(0,46,70,.0431));height:1px}.markdown-body br{content:"";display:block}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>随着车载 Android 生态的成熟，多媒体已从独立的 App 演变为一项全局协同的服务，需实时联动桌面卡片、控制中心及语音助手，以实现无缝流转与智能交互。</p>
<p>在这套复杂的交互体系下，<strong>MediaSession</strong> 是 Android 媒体框架中连接播放端与控制端的核心组件。它是确保跨进程状态同步、响应全局指令的基石。本文将结合具体开发实践，探讨 MediaSession 在车载开发中的核心应用。</p>
<h2 data-id="heading-0">一、为什么必须用 MediaSession？</h2>
<p>你可能有这样一个问题，为什么多媒体开发建议使用<code>MediaSession</code>？很简单，如果不使用<code>MediaSession</code>，你会失去：</p>
<ul>
<li>锁屏播放控件</li>
<li>通知栏媒体通知（新版强制要求 MediaStyle + MediaSession）</li>
<li>耳机/蓝牙媒体键控制（播放、暂停、切歌）</li>
<li>Android Auto / Car App 支持</li>
<li>Wear OS 手表控制</li>
<li>Google Assistant 语音控制（如“嘿 Google，播放下一首”）</li>
<li>系统音量键独立控制媒体音量</li>
<li>PiP（画中画）视频控件联动</li>
</ul>
<p>一句话，如果你做音视频播放，不用 <code>MediaSession</code> 就等于放弃了 80% 的系统集成能力。</p>
<p>本文基于 Media3 框架编写，使用的类库如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">media3</span> = <span class="hljs-string">"1.8.0"</span>

<span class="hljs-attr">media3-exoplayer</span> = { group = <span class="hljs-string">"androidx.media3"</span>, name = <span class="hljs-string">"media3-exoplayer"</span>, version.ref = <span class="hljs-string">"media3"</span> }

<span class="hljs-attr">media3-ui</span> = { group = <span class="hljs-string">"androidx.media3"</span>, name = <span class="hljs-string">"media3-ui"</span>, version.ref = <span class="hljs-string">"media3"</span> }

<span class="hljs-attr">media3-session</span> = { group = <span class="hljs-string">"androidx.media3"</span>, name = <span class="hljs-string">"media3-session"</span>, version.ref = <span class="hljs-string">"media3"</span> }
</code></pre>
<h2 data-id="heading-1">二、核心组件一览</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee164566497e470ca9e13c6ddd30da88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6X5qCpbGluaw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768193338&amp;x-signature=Img%2B99lpAjkvBekk3f5dAE7YbYc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">服务端核心组件</h3>
<p><strong>MediaSessionService</strong></p>
<p>Media3 新增的 Service 基类，是整个音频后台运行的载体。它管理着 <code>MediaSession</code> 的生命周期。当系统（如蓝牙、通知栏）需要访问媒体信息时，它负责按需启动服务。</p>
<p>通过重写 <code>onGetSession(controllerInfo)</code>，可以精细控制哪些客户端（如 Auto、WearOS）有权连接你的会话。</p>
<p><strong>MediaSession</strong></p>
<p>媒体会话服务端的核心类，它是 <code>Player</code> 与外界沟通的桥梁。它将 Player 的状态（播放中、进度、音量）广播给系统，并接收来自外部的 <code>SessionCommand</code>（如锁屏点击）。</p>
<p><code>MediaSession</code> 是新项目首选。对于老项目，Media3 内部通过适配器自动处理了与 <code>MediaSessionCompat</code> 的兼容，开发者无需再手动处理繁琐的兼容逻辑。</p>
<p><strong>Player</strong></p>
<p><code>Player</code>是实际执行音视频解码、缓冲与渲染的核心组件。</p>
<p><code>MediaSession</code>并不限制 <code>Player</code> 的具体实现，只要实现了 <code>androidx.media3.common.Player</code> 接口即可，这使得切换不同播放引擎变得极其简单。</p>
<p><strong>MediaItem</strong></p>
<p>播放队列中的原子单元，不仅仅是数据的载体。通过内部的 <code>MediaMetadata</code>，它直接决定了锁屏界面的 UI 展示（标题、歌手、封面 URI）。</p>
<p>此外，它还承载了 DRM 加密配置、媒体流格式声明（MimeType）以及剪辑播放区域（Clipping）等逻辑。</p>
<hr/>
<h3 data-id="heading-3">客户端核心组件</h3>
<p><strong>SessionToken</strong></p>
<p><code>MediaSession</code> 的“身份识别令牌”。系统利用它在不同进程间定位你的 <code>MediaSessionService</code>。</p>
<p><strong>MediaController</strong></p>
<p>播放控制的控制器。通过 <code>SessionToken</code> 异步连接到服务端。一旦连接成功，它会镜像服务端 <code>Player</code> 的所有状态。</p>
<p>不仅是 App 内部的播放页 UI，系统层面的通知栏、锁屏控件、蓝牙车载协议、甚至 Google Assistant 的底层实现都是一个 <code>MediaController</code>。</p>
<hr/>
<h2 data-id="heading-4">三、入门级音视频播放器</h2>
<h3 data-id="heading-5">服务端</h3>
<p>实现 <code>MediaSessionService</code> 服务端代码通常分为四个核心步骤：<strong>搭建后台载体 -&gt; 初始化播放引擎 -&gt; 建立会话桥梁 -&gt; 注册服务。</strong></p>
<h4 data-id="heading-6">1. 创建 Service 并继承 <code>MediaSessionService</code></h4>
<p>这是服务端的基础，需要重写 <code>onGetSession</code> 方法，可以决定哪些客户端连接到你的会话。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PlaybackService</span> : <span class="hljs-type">MediaSessionService</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> mediaSession: MediaSession
    
    <span class="hljs-comment">// 当有控制器（如通知栏、锁屏或你的 Activity）尝试连接时调用</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onGetSession</span><span class="hljs-params">(controllerInfo: <span class="hljs-type">MediaSession</span>.<span class="hljs-type">ControllerInfo</span>)</span></span>: MediaSession? {
        <span class="hljs-keyword">return</span> mediaSession
    }
}
</code></pre>
<h4 data-id="heading-7">2. 初始化 Player (如 ExoPlayer)</h4>
<p>在 <code>onCreate</code> 生命周期中初始化真正的播放器引擎。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.onCreate()
    <span class="hljs-comment">// 这里初始化视频播放器</span>
    <span class="hljs-keyword">val</span> player = ExoPlayer.Builder(<span class="hljs-keyword">this</span>).build()
}
</code></pre>
<h4 data-id="heading-8">3. 构建并关联 <code>MediaSession</code></h4>
<p>将 <code>Player</code> 实例交给 <code>MediaSession</code> 托管，并设置 <code>SessionActivity</code>（点击通知栏跳转的页面）。</p>
<pre><code class="hljs language-scss" lang="scss">mediaSession = MediaSession<span class="hljs-selector-class">.Builder</span>(this, player)
            <span class="hljs-selector-class">.setId</span>(SESSION_ID)
            <span class="hljs-selector-class">.setCallback</span>(mediaSessionCallback)
            <span class="hljs-selector-class">.build</span>()
</code></pre>
<h4 data-id="heading-9">4. 初始化播放资源</h4>
<p>构建<code>MediaItem</code>。仅作示例, 实际应用中, 应根据业务逻辑, 从本地数据库或网络获取音视频信息后, 动态构建 <code>MediaItem</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initMediaItem</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 构建 MediaItem, 并设置到 ExoPlayer</span>
        <span class="hljs-keyword">val</span> mediaItem = MediaItem.Builder()
            .setUri(<span class="hljs-string">"https://media.w3.org/2010/05/sintel/trailer.mp4"</span>.toUri())
            .setMediaId(<span class="hljs-string">"123456"</span>)
            .setMediaMetadata(
                MediaMetadata.Builder()
                    .setTitle(<span class="hljs-string">"视频标题"</span>)
                    .build(),
            )
            .build()
        player.setMediaItem(mediaItem)
        player.prepare()
        player.playWhenReady = <span class="hljs-literal">true</span>
    }
</code></pre>
<h4 data-id="heading-10">5. 在 <code>AndroidManifest.xml</code> 中注册服务</h4>
<p><strong>这是最关键的一步</strong>。必须声明权限、Action 以及 <code>foregroundServiceType</code>（Android 10+ 要求）。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;uses-permission android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.FOREGROUND_SERVICE"</span> /&gt;
&lt;uses-permission android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK"</span> /&gt;

&lt;service
    android:<span class="hljs-attr">name</span>=<span class="hljs-string">".PlaybackService"</span>
    android:<span class="hljs-attr">foregroundServiceType</span>=<span class="hljs-string">"mediaPlayback"</span>
    android:<span class="hljs-attr">exported</span>=<span class="hljs-string">"true"</span>&gt;
    &lt;intent-filter&gt;
        &lt;action android:<span class="hljs-attr">name</span>=<span class="hljs-string">"androidx.media3.session.MediaSessionService"</span> /&gt;
    &lt;/intent-filter&gt;
&lt;/service&gt;
</code></pre>
<h4 data-id="heading-11">6. 生命周期管理</h4>
<p>为了防止内存泄漏，务必在 <code>onDestroy</code> 中释放资源。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
    player.release()
    mediaSession.release()
    <span class="hljs-keyword">super</span>.onDestroy()
}
</code></pre>
<p>完成上述步骤后，<code>Media3</code>会自动处理以下逻辑：</p>
<ul>
<li>
<p><strong>自动生成通知</strong>：只要 <code>Player</code> 开始播放，系统会自动弹出媒体通知和锁屏控件。</p>
</li>
<li>
<p><strong>状态同步</strong>：锁屏上的进度条、暂停按钮会自动响应 <code>Player</code> 的状态变化。</p>
</li>
</ul>
<h4 data-id="heading-12">7. 完整实现</h4>
<p>服务端<code>MediaSessionService</code>完整代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> SESSION_ID = <span class="hljs-string">"session_multimedia"</span>

<span class="hljs-meta">@OptIn(UnstableApi::class)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PlaybackService</span> : <span class="hljs-type">MediaSessionService</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> mediaSession: MediaSession
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> player: ExoPlayer
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mediaSessionCallback = <span class="hljs-keyword">object</span> : MediaSession.Callback {

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPlaybackResumption</span><span class="hljs-params">(
            mediaSession: <span class="hljs-type">MediaSession</span>,
            controller: <span class="hljs-type">MediaSession</span>.<span class="hljs-type">ControllerInfo</span>,
        )</span></span>: ListenableFuture&lt;MediaSession.MediaItemsWithStartPosition&gt; {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.onPlaybackResumption(mediaSession, controller)
        }

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onConnect</span><span class="hljs-params">(
            session: <span class="hljs-type">MediaSession</span>,
            controller: <span class="hljs-type">MediaSession</span>.<span class="hljs-type">ControllerInfo</span>,
        )</span></span>: MediaSession.ConnectionResult {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.onConnect(session, controller)
        }

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCustomCommand</span><span class="hljs-params">(
            session: <span class="hljs-type">MediaSession</span>,
            controller: <span class="hljs-type">MediaSession</span>.<span class="hljs-type">ControllerInfo</span>,
            customCommand: <span class="hljs-type">SessionCommand</span>,
            args: <span class="hljs-type">Bundle</span>,
        )</span></span>: ListenableFuture&lt;SessionResult&gt; {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.onCustomCommand(session, controller, customCommand, args)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        initPlayer()
        initMediaSession()
        initMediaItem()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onGetSession</span><span class="hljs-params">(controllerInfo: <span class="hljs-type">MediaSession</span>.<span class="hljs-type">ControllerInfo</span>)</span></span>: MediaSession? {
        <span class="hljs-keyword">return</span> mediaSession
    }


    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initPlayer</span><span class="hljs-params">()</span></span> {
        player = ExoPlayer.Builder(<span class="hljs-keyword">this</span>)
            .build()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initMediaSession</span><span class="hljs-params">()</span></span> {
        mediaSession = MediaSession.Builder(<span class="hljs-keyword">this</span>, player)
            .setId(SESSION_ID)
            .setCallback(mediaSessionCallback)
            .build()
    }

    <span class="hljs-comment">// 仅作示例, 实际应用中, 应根据业务逻辑, 从本地数据库或网络获取音视频信息后, 动态构建 MediaItem</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initMediaItem</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 构建 MediaItem, 并设置到 ExoPlayer</span>
        <span class="hljs-keyword">val</span> mediaItem = MediaItem.Builder()
            .setUri(<span class="hljs-string">"https://media.w3.org/2010/05/sintel/trailer.mp4"</span>.toUri())
            .setMediaId(<span class="hljs-string">"123456"</span>)
            .setMediaMetadata(
                MediaMetadata.Builder()
                    .setTitle(<span class="hljs-string">"视频标题"</span>)
                    .build(),
            )
            .build()
        player.setMediaItem(mediaItem)
        player.prepare()
        player.playWhenReady = <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
        player.release()
        mediaSession.release()
        <span class="hljs-keyword">super</span>.onDestroy()
    }
}
</code></pre>
<h3 data-id="heading-13">UI 端 / 客户端</h3>
<p>实现 Media3 客户端（通常是的 UI 界面，如 <code>Activity</code> 或 <code>Fragment</code>）主要围绕 <strong><code>MediaController</code></strong> 展开。</p>
<p>客户端的职责是：<strong>通过 Token 找到服务 -&gt; 建立连接 -&gt; 控制播放 -&gt; 监听状态并刷新 UI</strong>。</p>
<h4 data-id="heading-14">1. 定义 SessionToken</h4>
<p>首先，需要创建一个“令牌”来定位后台服务。</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">sessionToken</span> = SessionToken(context, ComponentName(context.packageName, <span class="hljs-string">"com.wj.player.PlaybackService"</span>)) // 服务端的包名、MediasessionService类名
</code></pre>
<h4 data-id="heading-15">2. 建立异步连接</h4>
<p><code>MediaController</code> 的创建是异步的，需要监听它的连接成功回调。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> controllerFuture: ListenableFuture&lt;MediaController&gt;? = <span class="hljs-literal">null</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mediaController: MediaController? = <span class="hljs-literal">null</span>

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.onStart()
    controllerFuture = MediaController.Builder(context, sessionToken).buildAsync()
    controllerFuture?.addListener({
        <span class="hljs-comment">// 连接成功后，获取 controller 实例</span>
        mediaController = controllerFuture?.<span class="hljs-keyword">get</span>()
        <span class="hljs-comment">// 此时可以绑定监听器或直接控制播放</span>
        updateUI()
    }, MoreExecutors.directExecutor())
}
</code></pre>
<h4 data-id="heading-16">3. 控制播放 (如同操控本地 Player)</h4>
<p><code>MediaController</code>实现了<code>Player</code>接口，使用方式与 <code>ExoPlayer</code> 几乎完全一致，一些需要传入播放器才能使用的UI控件，可以直接传<code>MediaController</code>。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 播放</span>
mediaController?<span class="hljs-selector-class">.play</span>()

<span class="hljs-comment">// 切换下一曲</span>
mediaController?<span class="hljs-selector-class">.seekToNext</span>()

<span class="hljs-comment">// 调整进度</span>
mediaController?<span class="hljs-selector-class">.seekTo</span>(<span class="hljs-number">10000</span>L)
</code></pre>
<h4 data-id="heading-17">4. 监听状态更新 UI</h4>
<p>通过向 <code>mediaController</code> 添加 <code>Player.Listener</code>，可以实时感知歌曲切换、进度改变或播放状态变化。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">mediaController?.addListener(<span class="hljs-keyword">object</span> : Player.Listener {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMediaItemTransition</span><span class="hljs-params">(mediaItem: <span class="hljs-type">MediaItem</span>?, reason: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 当歌曲切换时，刷新界面的歌名、歌手和封面</span>
        updateSongInfo(mediaItem)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onIsPlayingChanged</span><span class="hljs-params">(isPlaying: <span class="hljs-type">Boolean</span>)</span></span> {
        <span class="hljs-comment">// 当播放/暂停状态改变时，切换播放按钮图标</span>
        playButton.setImageResource(<span class="hljs-keyword">if</span> (isPlaying) R.drawable.ic_pause <span class="hljs-keyword">else</span> R.drawable.ic_play)
    }
})
</code></pre>
<h4 data-id="heading-18">5. 断开连接与释放</h4>
<p>为了避免内存泄漏，在适当时机释放连接。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onStop</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.onStop()
    controllerFuture?.let {
        MediaController.releaseFuture(it)
    }
    mediaController = <span class="hljs-literal">null</span>
}
</code></pre>
<h4 data-id="heading-19">6. 完整实现</h4>
<p>Compose UI 简要实现代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PlayerScreen</span><span class="hljs-params">(viewModel: <span class="hljs-type">PlayerViewModel</span>, onBack: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> mediaItems <span class="hljs-keyword">by</span> viewModel.mediaItems.collectAsState()
    <span class="hljs-keyword">val</span> playerState <span class="hljs-keyword">by</span> viewModel.playerState.collectAsState()
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-keyword">val</span> mediaController = remember { mutableStateOf&lt;MediaController?&gt;(<span class="hljs-literal">null</span>) }
<span class="hljs-keyword">val</span> isControllerReady = remember { mutableStateOf(<span class="hljs-literal">false</span>) }

LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
<span class="hljs-keyword">val</span> sessionToken = SessionToken(context, ComponentName(context, PlaybackService::<span class="hljs-keyword">class</span>.java))
        <span class="hljs-keyword">val</span> controllerFuture = MediaController.Builder(context, sessionToken).buildAsync()
        controllerFuture.addListener(
            {
<span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> controller = controllerFuture.<span class="hljs-keyword">get</span>()
                    mediaController.value = controller
                    <span class="hljs-comment">// 添加监听器观察播放状态（仅在就绪后添加）</span>
                    controller.addListener(
                        <span class="hljs-keyword">object</span> : Player.Listener {
                            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onIsPlayingChanged</span><span class="hljs-params">(playing: <span class="hljs-type">Boolean</span>)</span></span> {
                                Log.e(<span class="hljs-string">"PlayScreen"</span>, <span class="hljs-string">"onIsPlayingChanged: <span class="hljs-variable">$playing</span>"</span>)
                            }

                            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPlaybackStateChanged</span><span class="hljs-params">(state: <span class="hljs-type">Int</span>)</span></span> {
                                Log.e(<span class="hljs-string">"PlayScreen"</span>, <span class="hljs-string">"onPlaybackStateChanged: <span class="hljs-variable">$state</span>"</span>)
                            }
                        },
                    )
                    isControllerReady.value = <span class="hljs-literal">true</span>  <span class="hljs-comment">// 标记就绪</span>
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    Log.e(<span class="hljs-string">"PlayerScreen"</span>, <span class="hljs-string">"MediaController build failed: <span class="hljs-subst">${e.message}</span>"</span>)
                    <span class="hljs-comment">// 在这里处理 UI 反馈，如显示错误 Toast</span>
                }
            } ,
            ContextCompat.getMainExecutor(context),
        )
    }

DisposableEffect(<span class="hljs-built_in">Unit</span>) {
onDispose {
mediaController.value?.release()
            isControllerReady.value = <span class="hljs-literal">false</span>
        }
}

<span class="hljs-comment">// 仅当控制器就绪时显示 PlayerControlView，否则显示加载 UI</span>
    <span class="hljs-keyword">if</span> (isControllerReady.value &amp;&amp; mediaController.value != <span class="hljs-literal">null</span>) {
        mediaController.value?.let { controller -&gt;
PlayerControlView(
                modifier = Modifier
                    .fillMaxSize()
                    .background(Color.Black),
                mediaPlayer = controller,
                onPlayPause = {
<span class="hljs-keyword">if</span> (playerState == PlayerState.Playing) {
                        controller.pause()
                        viewModel.pause()
                    } <span class="hljs-keyword">else</span> {
                        controller.play()
                        viewModel.play(mediaItems.first())
                    }
                } ,
                onSeek = { positionMs -&gt;
controller.seekTo(positionMs)
                } ,
                currentTime = controller.currentPosition,
                duration = controller.duration,
            )
        }
} <span class="hljs-keyword">else</span> {
        Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
CircularProgressIndicator()
            Text(<span class="hljs-string">"Loading player..."</span>)
        }
}
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PlayerControlView</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    mediaPlayer: <span class="hljs-type">Player</span>? = <span class="hljs-literal">null</span>,
)</span></span> {
    <span class="hljs-comment">// 中间播放区域</span>
    Box(
        modifier = modifier
            .fillMaxSize()
            .background(Color.Black)
            .padding(<span class="hljs-number">16.</span>dp),
    ) {
<span class="hljs-comment">// 视频区域 (使用AndroidView嵌入PlayerView)</span>
        AndroidView(
            modifier = Modifier.fillMaxSize(),
            factory = { context -&gt;
PlayerView(context).apply {
 player = mediaPlayer
                }
} ,
        )
    }
}
</code></pre>
<h2 data-id="heading-20">四、高级功能开发</h2>
<h3 data-id="heading-21">1. 锁屏控件增加自定义按钮</h3>
<p>首先，需要明确一个概念，在 Media3 (MediaSession) 中，锁屏控件的展示由系统根据<code>MediaSession</code>的状态自动处理，不需要多媒体应用实现自定义的<code>Notification</code>。所以要在锁屏界面或通知栏增加自定义按钮，核心思路是通过 <strong><code>CommandButton</code></strong> 定义按钮，并将其添加到 <strong><code>MediaSession</code></strong> 的布局中。</p>
<p><strong>第一步：自定义SessionCommand</strong></p>
<p>首先，需要为每个自定义按钮定义一个唯一的 <code>SessionCommand</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义按钮的 ID</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CUSTOM_COMMAND_FAVORITE = <span class="hljs-string">"ACTION_FAVORITE"</span>

<span class="hljs-comment">// 创建自定义 SessionCommand</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> favoriteCommand = SessionCommand(CUSTOM_COMMAND_FAVORITE, Bundle.EMPTY)
</code></pre>
<p><strong>第二步：创建 CommandButton</strong></p>
<p>使用 <code>CommandButton.Builder</code> 来配置按钮的图标、文字和对应的命令。</p>
<pre><code class="hljs language-scss" lang="scss">val favoriteButton = CommandButton<span class="hljs-selector-class">.Builder</span>()
    <span class="hljs-selector-class">.setDisplayName</span>("收藏")
    <span class="hljs-selector-class">.setIconResId</span>(R.drawable.ic_favorite) <span class="hljs-comment">// 你的图标资源</span>
    <span class="hljs-selector-class">.setSessionCommand</span>(favoriteCommand)
    <span class="hljs-selector-class">.build</span>()
</code></pre>
<p><strong>第三步：设置 MediaSession 的自定义布局</strong></p>
<p>在构建 <code>MediaSession</code> 时，或者在运行时动态更新，需要通过 <code>setCustomLayout</code> 方法将按钮告诉系统。</p>
<pre><code class="hljs language-scss" lang="scss">val mediaSession = MediaSession<span class="hljs-selector-class">.Builder</span>(context, player)
    <span class="hljs-selector-class">.setCallback</span>(sessionCallback())
    <span class="hljs-selector-class">.setCustomLayout</span>(ImmutableList.of(favoriteButton)) <span class="hljs-comment">// 在这里添加自定义按钮列表</span>
    <span class="hljs-selector-class">.build</span>()
</code></pre>
<p><strong>第四步：处理按钮点击事件</strong></p>
<p>重写 <code>MediaSession.Callback</code> 中的 <code>onConnect</code> 、<code>onCustomCommand</code> 方法，来设置自定义<code>SessionCommand</code>以及响应用户的点击操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> mediaSessionCallback = <span class="hljs-keyword">object</span> : MediaSession.Callback {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onConnect</span><span class="hljs-params">(
        session: <span class="hljs-type">MediaSession</span>,
        controller: <span class="hljs-type">MediaSession</span>.<span class="hljs-type">ControllerInfo</span>,
    )</span></span>: MediaSession.ConnectionResult {
        <span class="hljs-keyword">val</span> sessionCommands = MediaSession.ConnectionResult.DEFAULT_SESSION_COMMANDS.buildUpon()
            .add(favoriteCommand)
            .build()
        <span class="hljs-keyword">return</span> MediaSession.ConnectionResult.AcceptedResultBuilder(session)
            .setAvailableSessionCommands(sessionCommands)
            .build()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCustomCommand</span><span class="hljs-params">(
        session: <span class="hljs-type">MediaSession</span>,
        controller: <span class="hljs-type">MediaSession</span>.<span class="hljs-type">ControllerInfo</span>,
        customCommand: <span class="hljs-type">SessionCommand</span>,
        args: <span class="hljs-type">Bundle</span>,
    )</span></span>: ListenableFuture&lt;SessionResult&gt; {

        <span class="hljs-keyword">if</span> (customCommand.customAction == CUSTOM_COMMAND_FAVORITE) {
            <span class="hljs-comment">// 执行你的逻辑，比如收藏歌曲</span>
            doFavorite()
        }

        <span class="hljs-keyword">return</span> Futures.immediateFuture(SessionResult(SessionResult.RESULT_SUCCESS))
    }
}
</code></pre>
<h3 data-id="heading-22">2. 细粒度的连接管理 (Access Control)</h3>
<p>多数时候我们不一定希望所有的外部设备（如所有的蓝牙手表或第三方助手）都能<strong>控制</strong>你的播放器。通过重写 <code>MediaSession.Callback</code> 中的 <code>onConnect</code>，可以进行权限校验。</p>
<ul>
<li><strong>实现方式</strong>：检查 <code>ControllerInfo</code> 中的包名或 UID。</li>
<li><strong>场景</strong>：只允许特定的 App 远程控制你的媒体，或者为不同的客户端（如 Android Auto 与 手机通知栏）提供不同的自定义按钮布局。</li>
</ul>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onConnect</span><span class="hljs-params">(
    session: <span class="hljs-type">MediaSession</span>,
    controller: <span class="hljs-type">MediaSession</span>.<span class="hljs-type">ControllerInfo</span>,
)</span></span>: MediaSession.ConnectionResult {
    Log.e(<span class="hljs-string">"PlaybackService"</span>, <span class="hljs-string">"onConnect <span class="hljs-subst">${controller.packageName}</span>"</span>)
    <span class="hljs-keyword">val</span> sessionCommands = MediaSession.ConnectionResult.DEFAULT_SESSION_COMMANDS.buildUpon()

    <span class="hljs-keyword">if</span> (controller.packageName != packageName) {
        sessionCommands.add(favoriteCommand)
    }

    <span class="hljs-keyword">return</span> MediaSession.ConnectionResult.AcceptedResultBuilder(session)
        .setAvailableSessionCommands(sessionCommands.build())
        .build()
}
</code></pre>
<h3 data-id="heading-23">3. MediaButtonReceiver 重定向 (媒体按键处理)</h3>
<p><code>MediaButtonReceiver</code> 是 Android 中处理媒体按键（如耳机线控、蓝牙遥控器上的播放/暂停键）的关键组件。在 Jetpack Media3 中，它的使用变得非常自动化。当用户按下媒体按键时，系统会发出一个 <code>ACTION_MEDIA_BUTTON</code> 的广播。</p>
<ul>
<li><strong>如果应用正在运行</strong>：<code>MediaSession</code> 会直接接收并处理。</li>
<li><strong>如果应用已被杀死</strong>：系统会根据清单文件（Manifest）中的配置，寻找能处理该广播的组件，从而<strong>重启你的后台服务</strong>，实现“一键恢复播放”。</li>
</ul>
<p>在 Media3 中，不需要手动编写广播接收器类，库已经内置了处理逻辑。</p>
<p><strong>第一步：在 AndroidManifest.xml 中注册</strong></p>
<p>需要让系统知道你的 <code>MediaSessionService</code> 能够处理媒体按键广播。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;service
    android:<span class="hljs-attr">name</span>=<span class="hljs-string">".PlaybackService"</span>
    android:<span class="hljs-attr">exported</span>=<span class="hljs-string">"true"</span>
    android:<span class="hljs-attr">foregroundServiceType</span>=<span class="hljs-string">"mediaPlayback"</span>&gt;
    &lt;intent-filter&gt;
        &lt;action android:<span class="hljs-attr">name</span>=<span class="hljs-string">"androidx.media3.session.MediaSessionService"</span> /&gt;
        &lt;action android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.intent.action.MEDIA_BUTTON"</span> /&gt;
    &lt;/intent-filter&gt;
&lt;/service&gt;

&lt;receiver android:<span class="hljs-attr">name</span>=<span class="hljs-string">"androidx.media3.session.MediaButtonReceiver"</span>
    android:<span class="hljs-attr">exported</span>=<span class="hljs-string">"true"</span>&gt;
    &lt;intent-filter&gt;
        &lt;action android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.intent.action.MEDIA_BUTTON"</span> /&gt;
    &lt;/intent-filter&gt;
&lt;/receiver&gt;
</code></pre>
<p><strong>第二步：在 Service 中处理恢复逻辑</strong></p>
<p>当用户在应用关闭时按下播放键，<code>MediaSessionService</code> 会被系统唤醒。此时，需要告诉系统“播放什么”。在 <code>MediaSession.Callback</code> 中重写 <code>onPlaybackResumption</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">inner</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySessionCallback</span> : <span class="hljs-type">MediaSession.Callback</span> {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPlaybackResumption</span><span class="hljs-params">(
        session: <span class="hljs-type">MediaSession</span>,
        controller: <span class="hljs-type">MediaSession</span>.<span class="hljs-type">ControllerInfo</span>
    )</span></span>: ListenableFuture&lt;MediaSession.ConnectionResult&gt; {
       
        <span class="hljs-comment">// 1. 在这里加载用户上次退出的播放列表、进度等数据</span>
        <span class="hljs-keyword">val</span> lastMediaItems = loadLastPlayedList() 
        <span class="hljs-keyword">val</span> lastIndex = loadLastIndex()
        <span class="hljs-keyword">val</span> lastPosition = loadLastPosition()

        <span class="hljs-comment">// 2. 将数据设置给 Player</span>
        session.player.setMediaItems(lastMediaItems, lastIndex, lastPosition)
        session.player.prepare()

        <span class="hljs-comment">// 3. 返回接受连接的结果，告知系统已准备好恢复</span>
        <span class="hljs-keyword">return</span> Futures.immediateFuture(
            MediaSession.ConnectionResult.AcceptedResultBuilder(session).build()
        )
    }
}
</code></pre>
<h2 data-id="heading-24">五、附录</h2>
<h3 data-id="heading-25">MediaSession 常用API与使用场景说明</h3>
<hr/>
<h4 data-id="heading-26">1. 核心身份与回调</h4>
<ul>
<li>
<p><strong><code>setCallback(MediaSession.Callback callback)</code></strong></p>
<ul>
<li><strong>含义</strong>：设置会话回调，用于处理外部指令（如：点击锁屏的自定义按钮、搜索请求、尝试连接等）。</li>
<li><strong>场景</strong>：<strong>必用</strong>。如果你需要处理自定义按钮点击、鉴权、或者对特定的播放控制逻辑进行拦截，就必须实现并设置此回调。</li>
</ul>
</li>
<li>
<p><strong><code>setId(String id)</code></strong></p>
<ul>
<li><strong>含义</strong>：为 <code>MediaSession</code> 设置一个 ID。</li>
<li><strong>场景</strong>：同一个应用开启多个 <code>MediaSession</code> 时（例如一个播音乐，一个播播客），用于区分不同的会话。如果不设置，默认是空字符串。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-27">2. 界面展示与交互</h4>
<ul>
<li>
<p><strong><code>setSessionActivity(PendingIntent pendingIntent)</code></strong></p>
<ul>
<li><strong>含义</strong>：设置一个点击通知栏或锁屏界面时跳转的 <code>Activity</code>。</li>
<li><strong>场景</strong>：<strong>强烈建议设置</strong>。当用户在锁屏界面点击歌曲名称或封面时，系统会调用这个 <code>PendingIntent</code> 调起你的 App 播放界面。</li>
</ul>
</li>
<li>
<p><strong><code>setCustomLayout(List&lt;CommandButton&gt; buttons)</code></strong></p>
<ul>
<li><strong>含义</strong>：定义要在通知栏或锁屏上显示的自定义按钮列表。</li>
<li><strong>场景</strong>：当你除了“播放/暂停/上一曲/下一曲”之外，还想要“收藏”、“倍速”或“循环模式”按钮时使用。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-28">3. 数据与状态管理</h4>
<ul>
<li>
<p><strong><code>setExtras(Bundle extras)</code></strong></p>
<ul>
<li><strong>含义</strong>：存放自定义的元数据或配置信息。</li>
<li><strong>场景</strong>：用于向 <code>MediaController</code>（控制器端）传递一些非标准的数据信息。</li>
</ul>
</li>
<li>
<p><strong><code>setBitmapLoader(BitmapLoader bitmapLoader)</code></strong></p>
<ul>
<li><strong>含义</strong>：自定义图片加载逻辑。</li>
<li><strong>场景</strong>：默认情况下 Media3 使用简单的网络加载。如果你使用了 <strong>Glide</strong> 或 <strong>Coil</strong> 加载封面图，可以通过此方法集成，以确保封面能高效地显示在锁屏上。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-29">4. 周期管理</h4>
<ul>
<li>
<p><strong><code>setSessionExtras(Bundle extras)</code></strong></p>
<ul>
<li><strong>含义</strong>：与 <code>setExtras</code> 类似，但更侧重于在 Session 级别传递初始配置。</li>
</ul>
</li>
<li>
<p><strong><code>setPeriodicSessionExtrasInfoRefreshIntervalMs(long interval)</code></strong></p>
<ul>
<li>
<p><strong>含义</strong>：设置定期刷新 Session Extras 的时间间隔。</p>
</li>
<li>
<p><strong>场景</strong>：当你的会话状态（如特定的自定义业务状态）需要定时同步给所有连接的控制器时使用。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-30">5. 典型使用示例</h4>
<pre><code class="hljs language-scss" lang="scss">val session = MediaSession<span class="hljs-selector-class">.Builder</span>(context, player)
    <span class="hljs-comment">// 1. 设置点击通知跳转到哪个页面</span>
    <span class="hljs-selector-class">.setSessionActivity</span>(createPendingIntent()) 
    <span class="hljs-comment">// 2. 设置回调处理逻辑</span>
    <span class="hljs-selector-class">.setCallback</span>(MySessionCallback()) 
    <span class="hljs-comment">// 3. 设置锁屏/通知栏的自定义按钮</span>
    <span class="hljs-selector-class">.setCustomLayout</span>(listOf(favoriteButton, speedButton)) 
    <span class="hljs-comment">// 4. 定义 ID 方便调试或多实例管理</span>
    <span class="hljs-selector-class">.setId</span>("MusicSession") 
    <span class="hljs-selector-class">.build</span>()
</code></pre>
<hr/>
<h3 data-id="heading-31">MediaItem 常用API与使用场景说明</h3>
<h4 data-id="heading-32">1. 基础资源定位</h4>
<p>这是最常用的部分，用于告诉播放器“播什么”。</p>
<ul>
<li>
<p><strong><code>setMediaId(String mediaId)</code></strong></p>
<ul>
<li><strong>含义</strong>：为媒体项设置唯一标识符。</li>
<li><strong>场景</strong>：在播放列表管理、从数据库恢复播放状态、或在 <code>MediaSession</code> 回调中识别歌曲时非常重要。如果不设置，默认使用 <code>URI</code>。</li>
</ul>
</li>
<li>
<p><strong><code>setUri(Uri uri / String uri)</code></strong></p>
<ul>
<li><strong>含义</strong>：媒体内容的实际路径。</li>
<li><strong>场景</strong>：指向本地文件路径、网络 HTTP 链接或 ContentProvider 的 URI。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-33">2. 媒体元数据</h4>
<p>用于 UI 展示，如锁屏界面、通知栏和蓝牙车载界面。</p>
<ul>
<li>
<p><strong><code>setMediaMetadata(MediaMetadata metadata)</code></strong></p>
<ul>
<li><strong>含义</strong>：传入一个 <code>MediaMetadata</code> 对象。</li>
<li><strong>常用内部属性</strong>：<code>setTitle()</code> (标题), <code>setArtist()</code> (艺术家), <code>setArtworkUri()</code> (封面图片地址)。</li>
<li><strong>场景</strong>：当你需要让锁屏控件显示歌曲名和封面图时使用。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-34">3. 自适应与高级配置</h4>
<p>用于处理加密视频、流媒体协议或特定类型的文件。</p>
<ul>
<li>
<p><strong><code>setDrmConfiguration(MediaItem.DrmConfiguration drmConfig)</code></strong></p>
<ul>
<li><strong>含义</strong>：设置数字版权管理（DRM）配置。</li>
<li><strong>场景</strong>：播放受保护的付费内容（如 Widevine, PlayReady 加密的视频）。</li>
</ul>
</li>
<li>
<p><strong><code>setMimeType(String mimeType)</code></strong></p>
<ul>
<li><strong>含义</strong>：显式指定媒体类型（如 <code>application/x-mpegURL</code> 对应 HLS）。</li>
<li><strong>场景</strong>：当 URI 后缀无法直接判断类型时（例如一个没有扩展名的流链接），设置此项能加快播放器解析速度。</li>
</ul>
</li>
<li>
<p><strong><code>setLiveConfiguration(MediaItem.LiveConfiguration liveConfig)</code></strong></p>
<ul>
<li><strong>含义</strong>：配置直播流参数（如最大/最小偏移偏移量、播放倍速）。</li>
<li><strong>场景</strong>：低延迟直播（Low-latency live streaming）。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-35">4. 剪辑与部分播放</h4>
<ul>
<li>
<p><strong><code>setClippingConfiguration(MediaItem.ClippingConfiguration config)</code></strong></p>
<ul>
<li><strong>含义</strong>：设置播放的起始和结束位置。</li>
<li><strong>场景</strong>：你只想播放长视频中的某一段（例如：从第 10 秒播到第 30 秒），而不需要手动去监听进度并停止。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-36">5. 附加组件</h4>
<ul>
<li>
<p><strong><code>setSubtitleConfigurations(List&lt;SubtitleConfiguration&gt; subtitles)</code></strong></p>
<ul>
<li><strong>含义</strong>：外挂字幕配置。</li>
<li><strong>场景</strong>：视频文件本身不含字幕，需要加载外部的 <code>.vtt</code> 或 <code>.srt</code> 文件时。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-37">6. 自定义数据</h4>
<ul>
<li>
<p><strong><code>setTag(Object tag)</code></strong></p>
<ul>
<li><strong>含义</strong>：挂载一个自定义的 Java/Kotlin 对象。</li>
<li><strong>场景</strong>：在 <code>onMediaItemTransition</code> 监听器中，你想快速获取该媒体项关联的业务模型对象（比如数据库里的 <code>User</code> 对象），而不想通过 <code>mediaId</code> 重新查询。</li>
</ul>
</li>
<li>
<p><strong><code>setCustomCacheKey(String cacheKey)</code></strong></p>
<ul>
<li><strong>含义</strong>：自定义缓存键。</li>
<li><strong>场景</strong>：如果多个不同 URI 指向同一个物理文件，通过设置相同的 Key 可以避免重复下载缓存。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-38">7. 典型使用示例</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">val</span> <span class="hljs-selector-tag">mediaItem</span> = <span class="hljs-selector-tag">MediaItem</span><span class="hljs-selector-class">.Builder</span>()
    <span class="hljs-selector-class">.setMediaId</span>(<span class="hljs-string">"song_101"</span>)
    <span class="hljs-selector-class">.setUri</span>(<span class="hljs-string">"https://example.com/music.mp3"</span>)
    <span class="hljs-selector-class">.setMediaMetadata</span>(
        MediaMetadata.<span class="hljs-built_in">Builder</span>()
            .<span class="hljs-built_in">setTitle</span>(<span class="hljs-string">"江南"</span>)
            .<span class="hljs-built_in">setArtist</span>(<span class="hljs-string">"林俊杰"</span>)
            .<span class="hljs-built_in">setArtworkUri</span>(Uri.<span class="hljs-built_in">parse</span>(<span class="hljs-string">"https://example.com/cover.jpg"</span>))
            .<span class="hljs-built_in">build</span>()
    )
    <span class="hljs-comment">// 假设只播前 30 秒作为试听</span>
    <span class="hljs-selector-class">.setClippingConfiguration</span>(
        MediaItem.ClippingConfiguration.<span class="hljs-built_in">Builder</span>()
            .<span class="hljs-built_in">setEndPositionMs</span>(<span class="hljs-number">30000</span>)
            .<span class="hljs-built_in">build</span>()
    )
    <span class="hljs-selector-class">.setTag</span>(myCustomObject) <span class="hljs-comment">// 绑定自定义业务数据</span>
    <span class="hljs-selector-class">.build</span>()

<span class="hljs-selector-tag">player</span><span class="hljs-selector-class">.setMediaItem</span>(mediaItem)
</code></pre>
<h2 data-id="heading-39">六、总结</h2>
<p>以上就是<code>MediaSession</code>入门级的知识总结，在车载应用开发中，大多数情况下都是开发一个客户端应用连接到<code>MediaSessionService</code>上，用于控制媒体中心的行为，那么本文涉及的内容已经基本够用。</p>
<p>下一篇，我们来讲讲多媒体开发过程最常见的<code>音频焦点</code>的处理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OKHTTP连接保持]]></title>    <link>https://juejin.cn/post/7591681023906988041</link>    <guid>https://juejin.cn/post/7591681023906988041</guid>    <pubDate>2026-01-05T06:21:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591681023906988041" data-draft-id="7591670569909665838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OKHTTP连接保持"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-05T06:21:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GoldenPlayer"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453948119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OKHTTP连接保持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453948119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GoldenPlayer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T06:21:44.000Z" title="Mon Jan 05 2026 06:21:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Retrofit2 本身并不包含缓存功能，且代码中目前也没有开启 OkHttp 的磁盘缓存功能</strong></p>
<p>观察到的“第二次请求特别快”，<strong>并不是因为数据被缓存了</strong>，而是因为 <strong>OkHttp 的连接池复用机制（Connection Pooling / Keep-Alive）</strong>。</p>
<p>下面详细解释为什么会这样，以及如果真的想要“缓存”该怎么做</p>
<h3 data-id="heading-0">1. 为什么第二次请求变快了？（连接复用）</h3>
<p>在网络请求中，建立连接是最耗时的步骤之一。</p>
<ul>
<li><strong>第一次请求</strong>：DNS 解析 -&gt; 建立 TCP 连接 (三次握手) -&gt; SSL/TLS 握手 (加密验证) -&gt; 发送数据 -&gt; 接收数据。</li>
<li><strong>第二次请求</strong>：由于 OkHttp 默认开启了<strong>连接池</strong>，它发现还在请求同一个域名（<code>BASE_URL</code>），且之前的连接还没有断开，它会直接跳过前面的握手步骤：<strong>直接利用已有连接发送数据 -&gt; 接收数据</strong>。</li>
</ul>
<p>这省去了几百毫秒甚至上秒的握手时间，所以会感觉“特别快”</p>
<p><strong>注意</strong>：这并不意味着数据被缓存了。如果手机断网，第二次请求依然会失败</p>
<h3 data-id="heading-1">2. Retrofit 和 OkHttp 的关系</h3>
<ul>
<li><strong>Retrofit</strong>：只是一个外壳（Wrapper），它负责把 Interface 方法转换成 HTTP 请求，解析 JSON 数据等。它不负责底层的网络传输，也不负责缓存。</li>
<li><strong>OkHttp</strong>：是 Retrofit 底下的引擎，它负责真正的网络传输和缓存</li>
</ul>
<h3 data-id="heading-2">3. 代码中为何没有缓存？</h3>
<p>在 HTTP 协议中，标准的缓存是基于磁盘的（Disk Cache）。要启用它，需要显式地给 <code>OkHttpClient</code> 配置一个 <code>Cache</code> 对象。</p>
<p>查看代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">return</span> OkHttpClient.Builder()
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// 这里缺少了 .cache(cache) 的配置</span>
    .addInterceptor(logging)
    .addInterceptor(TokenHeaderInterceptor())
    .build()
</code></pre>
<p>因为没有配置 <code>.cache()</code>，OkHttp 不会将服务器返回的数据写入手机存储</p>
<h3 data-id="heading-3">4. 还有一个关键点：POST 请求通常不被缓存</h3>
<p><code>ApiService</code>，大部分请求是 <code>@POST</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@POST(<span class="hljs-string">"/v1/media/getRecapInfo"</span>)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getRecapInfo</span><span class="hljs-params">(...)</span></span>
</code></pre>
<p><strong>HTTP 标准缓存协议通常只针对 <code>GET</code> 请求有效。</strong>
对于 <code>POST</code> 请求（通常代表提交数据或获取非幂等数据），浏览器和 OkHttp 默认都不会去缓存结果</p>
<p>所以，即便开启了 OkHttp 的缓存， <code>getRecapInfo</code> 这种 POST 请求依然不会被缓存。这进一步印证感觉到的“快”纯粹是因为<strong>网络连接复用</strong></p>
<hr/>
<h3 data-id="heading-4">5. 如果想要真正的“数据缓存”该怎么做？</h3>
<p>如果希望在<strong>没网的时候也能读取上次的数据</strong>，或者减少服务器压力，有两种选择：</p>
<h4 data-id="heading-5">方案 A：开启 OkHttp 标准缓存（仅对 GET 有效）</h4>
<p>需要修改 <code>buildOkHttpClient</code>，传入 <code>Context</code> 来获取缓存路径：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 需要传入 context</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildOkHttpClient</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: OkHttpClient {
    <span class="hljs-comment">// 设置缓存大小，比如 10MB</span>
    <span class="hljs-keyword">val</span> cacheSize = <span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024L</span> 
    <span class="hljs-keyword">val</span> cache = Cache(File(context.cacheDir, <span class="hljs-string">"http_cache"</span>), cacheSize)

    <span class="hljs-keyword">return</span> OkHttpClient.Builder()
        .cache(cache) <span class="hljs-comment">// 开启缓存</span>
        <span class="hljs-comment">// ... 其他配置</span>
        .build()
}
</code></pre>
<p><em>前提：后端接口必须是 <code>GET</code> 请求，并且后端返回的 Header 中包含 <code>Cache-Control</code> 信息（比如 <code>max-age=60</code>）。</em></p>
<h4 data-id="heading-6">方案 B：业务层缓存（推荐，适合 POST 和复杂业务）</h4>
<p>既然接口多是 POST，且业务逻辑较重，建议不要依赖 HTTP 协议缓存，而是自己控制：</p>
<ol>
<li><strong>数据库缓存 (Room)</strong>：请求成功后，把 JSON 数据存入本地数据库（SQLite/Room）。下次请求前，先读数据库显示旧数据，同时去请求网络更新。</li>
<li><strong>RxJava 内存缓存</strong>：如果只是想在页面没销毁前缓存，可以使用 RxJava 的操作符。
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例：使用 replay(1).autoConnect() 让流变热，从而缓存最近一次的结果</span>
<span class="hljs-keyword">val</span> cachedObservable = apiService.getRecapInfo(req).replay(<span class="hljs-number">1</span>).autoConnect()
</code></pre>
</li>
</ol>
<h3 data-id="heading-7">总结</h3>
<p>目前的框架<strong>没有缓存</strong>。</p>
<ul>
<li>第一次慢：建立连接 + 传输数据</li>
<li>第二次快：<strong>复用连接</strong> + 传输数据</li>
</ul>
<p>这就是 HTTP 协议中的 <strong>Keep-Alive（HTTP 持久连接）</strong> 机制</p>
<p>在 OkHttp 中，这个机制是通过 <strong><code>ConnectionPool</code>（连接池）</strong> 来实现的</p>
<h3 data-id="heading-8">1. 为什么叫“类似长连接”？</h3>
<p>严格来说，它不是像 WebSocket 那种一直不断的“永久长连接”，而是 <strong>“在一段时间内保持连接不断开”</strong>。</p>
<ul>
<li><strong>没有复用（短连接）</strong>：请求 -&gt; 建立连接(3次握手+TLS) -&gt; 传输 -&gt; <strong>断开连接</strong>。下次再请求，重新建立。</li>
<li><strong>连接池复用（Keep-Alive）</strong>：请求 -&gt; 建立连接 -&gt; 传输 -&gt; <strong>连接闲置放入池中</strong>（不断开）。
<ul>
<li>如果在 <strong>5分钟</strong>（默认）内又有请求 -&gt; <strong>直接复用该连接</strong>。</li>
<li>如果超过 5分钟 没人用 -&gt; 自动断开并回收。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">2. 配置在哪里？（默认配置）</h3>
<p>在代码中，没有显式配置它，因为 OkHttp <strong>默认</strong>已经帮你配置好了</p>
<p><strong>源码位置：</strong> <code>okhttp3.OkHttpClient.Builder</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// OkHttp 源码片段 (Kotlin 版本)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">var</span> connectionPool: ConnectionPool = ConnectionPool() <span class="hljs-comment">// 这里！默认创建了一个连接池</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>如果点进去看 <code>ConnectionPool</code> 的无参构造函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// okhttp3.ConnectionPool 源码</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPool</span>(
    maxIdleConnections: <span class="hljs-built_in">Int</span> = <span class="hljs-number">5</span>, <span class="hljs-comment">// 默认最大闲置连接数：5个</span>
    keepAliveDuration: <span class="hljs-built_in">Long</span> = <span class="hljs-number">5</span>, <span class="hljs-comment">// 默认保持存活时间：5</span>
    timeUnit: TimeUnit = TimeUnit.MINUTES <span class="hljs-comment">// 单位：分钟</span>
) {
    <span class="hljs-comment">// 这意味着：默认情况下，OkHttp 会维护最多 5 个空闲连接，</span>
    <span class="hljs-comment">// 每个空闲连接如果不被使用，5 分钟后会被自动清理。</span>
}
</code></pre>
<p>如果想修改这个配置（比如为了优化性能，想让连接保持更久，或者允许更多并发闲置连接），可以这样写：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildOkHttpClient</span><span class="hljs-params">()</span></span>: OkHttpClient {
    <span class="hljs-comment">// 自定义连接池</span>
    <span class="hljs-keyword">val</span> myConnectionPool = ConnectionPool(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, TimeUnit.MINUTES)

    <span class="hljs-keyword">return</span> OkHttpClient.Builder()
        .connectionPool(myConnectionPool) <span class="hljs-comment">// 显式传入</span>
        <span class="hljs-comment">// ... 其他配置</span>
        .build()
}
</code></pre>
<hr/>
<h3 data-id="heading-10">3. 源码探究：它是如何“偷偷”复用的？</h3>
<p>既然对源码好奇，来看看 OkHttp 是如何管理这些连接的。核心逻辑在 <code>okhttp3.internal.connection</code> 包下。</p>
<h4 data-id="heading-11">A. 存：请求结束后不关连接</h4>
<p>当请求（比如 <code>getRecapInfo</code>）执行完毕拿到数据后，OkHttp 的底层流处理类（<code>StreamAllocation</code> 或新版的 <code>Exchange</code>）会调用 <code>release</code> 方法。</p>
<p>正常逻辑是关闭 Socket，但 OkHttp 做了一个判断：
<strong>“如果是 HTTP/1.1 且 header 里有 keep-alive，我不关 Socket，而是把它标记为 <code>idle</code>（闲置），放回 <code>ConnectionPool</code> 的双端队列（Deque）中。”</strong></p>
<h4 data-id="heading-12">B. 取：请求开始前先找连接</h4>
<p>当发起<strong>第二次</strong>请求时，OkHttp 不会立刻 <code>new Socket()</code></p>
<p>它会去 <code>ConnectionPool</code> 里找（源码类 <code>ExchangeFinder</code>）：</p>
<ol>
<li><strong>遍历池子</strong>：看有没有 host 和 port 都匹配的、而且是可以复用的连接</li>
<li><strong>找到了</strong>：直接返回这个 <code>RealConnection</code> 对象</li>
<li><strong>没找到</strong>：才去执行 TCP 三次握手和 TLS 握手（就是觉得耗时的那部分）</li>
</ol>
<h4 data-id="heading-13">C. 清理：后台线程自动打扫</h4>
<p>OkHttp 怎么知道什么时候关闭那些 5 分钟没用的连接？</p>
<p>在 <code>ConnectionPool</code> 内部，有一个<strong>静态的线程池</strong>（executor），专门运行一个 <code>cleanupRunnable</code> 任务。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ConnectionPool 伪代码逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cleanupRunnable = Runnable {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// 1. 计算下一个连接多久过期</span>
        <span class="hljs-keyword">val</span> waitNanos = cleanup(System.nanoTime())
        
        <span class="hljs-comment">// 2. 如果池子空了，退出循环，线程结束</span>
        <span class="hljs-keyword">if</span> (waitNanos == -<span class="hljs-number">1L</span>) <span class="hljs-keyword">return</span>
        
        <span class="hljs-comment">// 3. 还没到期，线程挂起等待（wait），到时间再醒来检查</span>
        <span class="hljs-keyword">if</span> (waitNanos &gt; <span class="hljs-number">0</span>) {
            lock.wait(waitNanos) 
        }
    }
}
</code></pre>
<p>这个设计非常精妙：<strong>如果没有空闲连接，清理线程是不运行的，完全不占资源。一旦有了空闲连接，它才会启动并计时。</strong></p>
<h3 data-id="heading-14">4. 为什么握手这么耗时？（直观对比）</h3>
<p>感觉到的“第一次慢，第二次快”，在 HTTPS 请求中差异巨大</p>
<p><strong>第一次请求（冷启动）：</strong></p>
<ol>
<li><strong>DNS</strong>：域名 -&gt; IP （几毫秒到几百毫秒）</li>
<li><strong>TCP 握手</strong>：SYN -&gt; SYN/ACK -&gt; ACK （1个 RTT，往返时延）</li>
<li><strong>TLS 握手</strong>（最贵）：
<ul>
<li>Client Hello</li>
<li>Server Hello + Certificate</li>
<li>Key Exchange</li>
<li>Finished</li>
<li><em>(如果是 TLS 1.2，这里至少消耗 2个 RTT。跨国网络下，这可能就是 500ms+ 的时间)</em></li>
</ul>
</li>
<li><strong>发送 HTTP 数据</strong></li>
<li><strong>接收数据</strong></li>
</ol>
<p><strong>第二次请求（复用）：</strong></p>
<ol>
<li>(跳过 DNS)</li>
<li>(跳过 TCP 握手)</li>
<li>(跳过 TLS 握手) -&gt; <strong>省下了最耗时的部分！</strong></li>
<li><strong>发送 HTTP 数据</strong></li>
<li><strong>接收数据</strong></li>
</ol>
<p>所以，在移动端开发中，保持 <code>OkHttpClient</code> 单例（像代码里做的 <code>object NetworkApi</code> + <code>lazy</code>）是非常重要的，这样才能利用连接池。如果每次请求都 <code>new OkHttpClient()</code>，连接池就会失效，每次都要重新握手，速度就会很慢</p>
<br/>
<p><strong>不需要显式设置，header中Keep-Alive默认是开启的。</strong> 而且，<strong>目前的日志里可能看不到这个 Header，是因为拦截器的位置原因</strong></p>
<p>下面一步步验证和揭秘</p>
<h3 data-id="heading-15">1. 为什么不需要设置？（协议默认值）</h3>
<ul>
<li><strong>HTTP/1.1 协议规定</strong>：只要是 HTTP/1.1，默认就是 <code>Keep-Alive</code>（持久连接）。除非显式发送 <code>Connection: close</code>，否则服务器和客户端都默契地保持连接。</li>
<li><strong>HTTP/2 协议规定</strong>：在 HTTP/2 中，连接复用是核心特性（Multiplexing），<code>Connection</code> header 甚至被视为非法或被忽略，因为连接默认就是持久且多路复用的。</li>
</ul>
<h3 data-id="heading-16">2. 为什么日志里可能看不到？（拦截器陷阱）</h3>
<p>现在的代码是这样写的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ...</span>
.addInterceptor(logging) <span class="hljs-comment">// &lt;--- 注意这里</span>
<span class="hljs-comment">// ...</span>
</code></pre>
<p>这叫做 <strong>Application Interceptor（应用拦截器）</strong>。</p>
<p><strong>OkHttp 的工作流程是这样的：</strong></p>
<ol>
<li><strong>应用拦截器 (Application Interceptor)</strong>：就是 <code>logging</code>。这时候请求还是“原始”的，是代码里写的样子。<strong>OkHttp 还没来得及加默认 Header。</strong></li>
<li><strong>桥接拦截器 (BridgeInterceptor)</strong>：<strong>OkHttp 内部的一个拦截器。它负责补全 Header（比如 <code>Host</code>, <code>User-Agent</code>, <code>Gzip</code>, <code>Connection: Keep-Alive</code>）。</strong></li>
<li><strong>网络拦截器 (Network Interceptor)</strong>：在真正发包之前。</li>
<li><strong>发送网络请求</strong>。</li>
</ol>
<p><strong>结论</strong>：因为日志拦截器在第 1 步，而添加 <code>Keep-Alive</code> 发生在第 2 步，所以在日志里看不到它</p>
<h3 data-id="heading-17">3. 如何亲眼看到它？（两个方法）</h3>
<h4 data-id="heading-18">方法一：临时修改代码（最快验证）</h4>
<p>把代码中的 <code>addInterceptor(logging)</code> 改为 <code>addNetworkInterceptor(logging)</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// NetworkApi.kt 修改</span>

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildOkHttpClient</span><span class="hljs-params">()</span></span>: OkHttpClient {
    <span class="hljs-comment">// ... 前面省略</span>
    <span class="hljs-keyword">return</span> OkHttpClient.Builder()
        <span class="hljs-comment">// ...</span>
        <span class="hljs-comment">// 删掉这行 .addInterceptor(logging)</span>
        <span class="hljs-comment">// 改用下面这行：</span>
        .addNetworkInterceptor(logging) 
        .addInterceptor(TokenHeaderInterceptor())
        .build()
}
</code></pre>
<p><strong>重新运行并看日志：</strong>
会在 Header 里清晰地看到：
<code>Connection: Keep-Alive</code>
<code>Accept-Encoding: gzip</code> (OkHttp 也会自动帮加这个，之前看不到，现在能看到了)
<code>User-Agent: okhttp/4.x.x</code></p>
<p><em>验证完记得改回来，通常我们开发用 <code>addInterceptor</code> 就够了，<code>addNetworkInterceptor</code> 会打印一些底层的、解压前的数据，有时候比较乱</em></p>
<h4 data-id="heading-19">方法二：使用 Android Studio Network Inspector（不用改代码）</h4>
<ol>
<li>运行 App。</li>
<li>打开 Android Studio 底部的 <strong>App Inspection</strong> 或 <strong>Network Inspector</strong> 标签页。</li>
<li>点击发起一个网络请求。</li>
<li>点击左侧列表里的请求，查看右侧的 <strong>Request Headers</strong>。</li>
<li>会看到 <code>Connection: Keep-Alive</code> 赫然在列。这是最真实的、发给服务器的数据。</li>
</ol>
<hr/>
<h3 data-id="heading-20">4. 源码验证（核心证据）</h3>
<p>既然想看源码实现，这个逻辑在 <code>okhttp3.internal.http.BridgeInterceptor</code> 类中</p>
<p>OkHttp 的责任链模式中，<code>BridgeInterceptor</code> 专门负责把用户的请求转换为网络友好的请求</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// OkHttp 源码：BridgeInterceptor.kt</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BridgeInterceptor</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cookieJar: CookieJar) : Interceptor {

  <span class="hljs-meta">@Throws(IOException::class)</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">intercept</span><span class="hljs-params">(chain: <span class="hljs-type">Interceptor</span>.<span class="hljs-type">Chain</span>)</span></span>: Response {
    <span class="hljs-keyword">val</span> userRequest = chain.request()
    <span class="hljs-keyword">val</span> requestBuilder = userRequest.newBuilder()

    <span class="hljs-comment">// ... 省略其他 Header 设置 (Content-Type, Content-Length 等)</span>

    <span class="hljs-comment">// 重点在这里！！！</span>
    <span class="hljs-keyword">if</span> (userRequest.header(<span class="hljs-string">"Connection"</span>) == <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 如果用户没有自己设置 Connection Header，OkHttp 帮加上 Keep-Alive</span>
      requestBuilder.header(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"Keep-Alive"</span>)
    }

    <span class="hljs-comment">// ... 省略 Gzip 设置 (Accept-Encoding)</span>

    <span class="hljs-keyword">val</span> networkResponse = chain.proceed(requestBuilder.build())
    
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p><strong>代码逻辑解读：</strong>
它检查 <code>userRequest.header("Connection") == null</code>。
没有设置，所以它确实是空的
于是它执行 <code>requestBuilder.header("Connection", "Keep-Alive")</code>。</p>
<p>这就是为什么没写，但它确实存在，且 OkHttp 会帮助维护连接池的原因</p>
<br/>
<p><strong>设定：</strong></p>
<ul>
<li><strong>某个App</strong>：OkHttp 配置了 100 年的连接超时，极其自信地认为连接活着</li>
<li><strong>Server</strong>：现实且冷酷，60秒没收到数据，直接踢人</li>
<li><strong>Android 底层</strong>：负责搬运 TCP 数据包的系统内核</li>
</ul>
<p>当 Server 销毁连接（发送 TCP <code>FIN</code> 包）后，你的 App 会经历以下几个阶段的“挣扎”和“幻灭”：</p>
<hr/>
<h3 data-id="heading-21">第一阶段：Server 动手了（TCP FIN）</h3>
<ol>
<li><strong>服务器端</strong>：计时器到了，Nginx 发送一个 <strong><code>FIN</code></strong> (Finish) 包给你的手机，意思是：“我不玩了，挂电话吧”</li>
<li><strong>手机操作系统（Linux内核）</strong>：收到了 <code>FIN</code> 包
<ul>
<li>内核自动回复一个 <code>ACK</code></li>
<li>内核把这个 Socket 的状态标记为 <strong><code>CLOSE_WAIT</code></strong>（被动关闭等待）</li>
<li><strong>关键点</strong>：此时，你的 <strong>App 进程（Java层/OkHttp）可能还完全不知情！</strong> 除非 App 此时此刻正好在读写这个 Socket。如果 App 只是把它放在连接池里睡觉，App 根本收不到通知</li>
</ul>
</li>
</ol>
<h3 data-id="heading-22">第二阶段：App 醒来，取出“僵尸连接”</h3>
<p>过了 10 分钟，用户点了一个按钮。OkHttp 接到任务，去连接池找连接</p>
<ol>
<li><strong>OkHttp</strong>：看了一眼连接池：“嘿，这有个连接，过期时间是 2125 年。太棒了，还没过期！”</li>
<li><strong>健康检查（Crucial Step）</strong>：OkHttp 其实很鸡贼，它拿出来之前会<strong>试探性</strong>地检查一下连接是否健康（<code>isHealthy</code> 方法）。
<ul>
<li>它会尝试读取一下 Socket 的状态，或者判断 <code>socket.isClosed()</code>。</li>
<li><strong>悲剧的分岔路</strong>：
<ul>
<li><strong>情况 A（运气好）</strong>：OkHttp 发现 Socket 已经是 <code>CLOSE_WAIT</code> 或者输入流已经关闭了。它会叹口气：“唉，虽然没到 100 年，但它死了。” —— <strong>动作：默默销毁，重新建立新连接。</strong>（用户无感知，只是稍微慢一点点）。</li>
<li><strong>情况 B（运气差/竞态条件）</strong>：如果操作系统还没来得及同步状态，或者检测机制漏网，OkHttp 会误判它是健康的。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-23">第三阶段：向“僵尸”尸体开枪（写入数据）</h3>
<p>假设 OkHttp 误判连接是活的（或者连接被取出的那一毫秒是活的，下一毫秒 Server 的 FIN 到了）：</p>
<ol>
<li><strong>写入请求（Write）</strong>：OkHttp 开始往 <code>OutputStream</code> 里写 HTTP 请求头（GET /v1/...）。</li>
<li><strong>系统内核反应</strong>：
<ul>
<li>因为 Socket 处于 <code>CLOSE_WAIT</code> 或类似状态，或者 Server 那边已经发送了 <code>RST</code> (Reset，表示你发错人了，我不认识这个连接)</li>
<li>当试图往一个对方已经关闭的连接里写数据时，会触发 <strong><code>SocketException: Broken pipe</code></strong> （管道破裂）或者 <strong><code>SocketException: Software caused connection abort</code></strong>。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-24">第四阶段：惊慌与补救（Retry）</h3>
<p>这时候 App 抛出了异常 <strong>会 Crash 吗？</strong></p>
<p><strong>通常不会 Crash，但会经历一次“剧烈震荡”</strong></p>
<p>OkHttp 默认开启了 <strong><code>retryOnConnectionFailure</code></strong>（失败重试）</p>
<ol>
<li><strong>捕获异常</strong>：OkHttp 的拦截器链条捕获到了这个 <code>SocketException</code>。</li>
<li><strong>判定</strong>：它会分析：“这是一个网络层面的路由故障？还是我复用的这个旧连接有问题？”
<ul>
<li>结论：“这大概率是因为我复用了旧连接，但旧连接坏了。”</li>
</ul>
</li>
<li><strong>亡羊补牢</strong>：
<ul>
<li>OkHttp 会<strong>立刻把这个 100 年的连接丢进垃圾桶（关闭 Socket）</strong>。</li>
<li><strong>重新走冷启动流程</strong>：DNS 解析 -&gt; TCP 握手 -&gt; TLS 握手 -&gt; 建立<strong>全新</strong>的连接。</li>
<li><strong>再次发送请求</strong>。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-25">最终结果：用户的感知</h3>
<p>虽然设置了 100 年缓存想让 App 变快，但结果适得其反：</p>
<ol>
<li>
<p><strong>延迟增加（抖动）</strong>：</p>
<ul>
<li>正常复用：50ms。</li>
<li>正常新建：300ms。</li>
<li><strong>你的“僵尸”复用</strong>：50ms (尝试复用) + 10ms (报错) + 300ms (新建重试) = <strong>360ms</strong>。</li>
<li><strong>结论</strong>：比不缓存还要慢！</li>
</ul>
</li>
<li>
<p><strong>潜在的“请求失败”风险（POST 请求）</strong>：</p>
<ul>
<li>如果是 <code>GET</code> 请求，OkHttp 敢大胆重试。</li>
<li>如果是 <strong><code>POST</code> 请求</strong>（比如提交订单）：
<ul>
<li>OkHttp 可能会犹豫：“刚才那半截数据发出去了吗？服务器收到了吗？如果我重试，会不会导致用户重复下单？”</li>
<li>为了安全，OkHttp 有时会<strong>放弃重试</strong>，直接抛出异常给业务层。</li>
<li><strong>用户界面</strong>：弹出 Toast “网络请求失败”，用户一脸懵逼（明明信号满格）。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-26">总结</h3>
<p>如果设置 100 年超时：</p>
<ol>
<li><strong>服务端</strong>会无视你，到时间就把连接掐断（Close FD）。</li>
<li><strong>Android 底层</strong>知道连接断了，标记为不可用。</li>
<li><strong>App (OkHttp)</strong> 可能会被“连接池里的过期时间”欺骗，拿出一个<strong>已经死掉的连接</strong>试图使用。</li>
<li><strong>结果</strong>：写入失败 -&gt; 触发异常 -&gt; 触发重试（或者直接报错）。</li>
</ol>
<p>这就像保存了一张 100 年有效期的“餐厅订座券”，但去的时候，那家餐厅早就倒闭或者换锁了。你拿着券在门口干瞪眼（报错），最后还得重新找一家新餐厅（重建连接）</p>
<p><strong>所以，OkHttp 默认的 5 分钟，是经过精确计算的“保鲜期”。</strong> 超过 5 分钟，它假设这盘菜大概率馊了，宁愿倒掉也不给你吃，免得你拉肚子（报错）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[百度百舸面向百度天池超节点的大模型推理引擎优化，持续降低昆仑芯 XPU 的 token 成本]]></title>    <link>https://juejin.cn/post/7591403124327563327</link>    <guid>https://juejin.cn/post/7591403124327563327</guid>    <pubDate>2026-01-05T06:30:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591403124327563327" data-draft-id="7591407298414608390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="百度百舸面向百度天池超节点的大模型推理引擎优化，持续降低昆仑芯 XPU 的 token 成本"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-05T06:30:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百度智能云技术站"/> <meta itemprop="url" content="https://juejin.cn/user/3472695814005120"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            百度百舸面向百度天池超节点的大模型推理引擎优化，持续降低昆仑芯 XPU 的 token 成本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3472695814005120/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百度智能云技术站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T06:30:01.000Z" title="Mon Jan 05 2026 06:30:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>1. 背景</strong></h3>
<p>超节点作为一种创新的硬件架构，通过构建大规模全互联的 Scale-up 网络，有效突破了传统 8 卡节点在通信上的「互联墙」瓶颈，为上层业务提供了极致的互联带宽与统一显存池化能力，从而实现大模型推理服务性能的跨越式提升。</p>
<p>结合新硬件架构的特性，AI Infra 团队可以基于对上层模型算法特性的深度理解，进一步做 AI 工程上的软件优化，充分释放硬件潜能，在吞吐量、首 Token 延迟（TTFT）、每 Token 处理时间（TPOT）等核心指标上实现突破性增长。 这些 AI Infra 优化不仅显著提升了系统整体效率，更大幅降低了硬件的 Token 的成本，成为企业落地大模型的关键胜负手。</p>
<p>本文将深入拆解百度百舸在超节点部署方案设计与软件优化方面的技术实践，聚焦推理引擎策略、核心算子调优、高效通信调度等关键维度，全面揭示软硬协同如何释放昆仑芯超节点的澎湃算力的底层逻辑与工程密码。</p>
<h3 data-id="heading-1"><strong>2.</strong>  <strong>百度天池超节点部署方案</strong></h3>
<p>百度天池超节点将 32 张昆仑芯 XPU 全互联为更大的 Scale-up 域。在此基础上，为了规划 DeepSeek R1 模型在百度天池超节点的部署方案，我们综合考虑性能要求和资源使用，并在 SLA 与硬件资源上找到配置最优解。</p>
<p>在百度天池超节点上，百度百舸团队基于 SGLang 推理框架和 PD 分离的部署架构，对 DeepSeek R1 模型的推理服务进行深度适配与调优。</p>
<p>通过在部署层面对计算单元、并行策略与资源配比进行精细化规划，使模型计算特性与超节点硬件形态形成高度匹配，从而在严格满足 SLA 约束的前提下，最大化释放硬件算力效率，为后续推理全链路优化奠定基础。</p>
<ul>
<li>在 Prefill 侧，在线服务通常要求 TTFT 控制在 1s 以内，因此需要核算 Prefill 的配置能否满足这个要求，如果不能满足，则需要使用并行策略满足要求。此外，在平衡时延时还需要考虑吞吐，如果吞吐不达标也会造成 Decode 打不满的情况，进而降低 Decode 的吞吐性能；</li>
<li>在 Decode 侧，对单步生成时延（TPOT, Time Per Output Token）要求更为严苛，需低于 50ms 以保证流畅的用户体验，因此需要设计合适的并行策略以及 EP 规模，平衡性能与成本。除此之外，在 PD 分离架构下，Decode 节点需要承载大量的 KV Cache，KV Cache 的预留空间直接决定了系统能支持的最大上下文长度（Context Length）和最大并发数（Batch Size），因此在确保每张卡能放得下模型权重以外，也要为 KV Cache 预留足够的显存容量。</li>
</ul>
<p>综合上述计算特性与资源约束，我们制定了如下部署策略：</p>
<p><strong>Prefill 阶段：</strong></p>
<ul>
<li>
<p>高并行度换取低时延，采用 16 卡作为一个计算单元，使用 TP4（Tensor Parallelism = 4） + SP4（Sequence Parallelism = 4）并行策略。由于 DeepSeek R1 规模巨大，单卡执行大 Batch 的 Prefill 计算耗时极易突破 1s 阈值。通过 TP4 + SP4 将计算负载切分到 4 张卡上并行处理，可以近乎线性地降低单次前向计算时间，从而在保证 TTFT 达标的基础上，留出算力余量来提升 Batch Size，实现高吞吐；</p>
</li>
<li>
<p>对于 128K 等超长文本，我们会采用 TP16 + SP16 或者 TP32 + SP32 等更大的 TP 规模，降低 TTFT；</p>
</li>
<li>
<p>开启 Chunk Prefill，避免长序列请求影响短序列请求的 TTFT。</p>
</li>
</ul>
<p><strong>Decode 阶段：</strong></p>
<ul>
<li>最大化访存效率与通信优化，采用 32 卡作为一个计算单元（占满一个 P900 超节点），使用 TP1（不切分 Tensor Parallel）和 EP32（Expert Parallel）并行策略。由于 Decode 阶段是访存敏感型，且算子计算密度低，过高的 TP 会引入频繁的跨卡 AllReduce 通信，导致通信开销占比过高，严重拖累 TPOT。因此，我们策略性地放弃 TP 切分（TP1），转而利用 P900 的 32 卡大显存池，通过数据并行（DP）和专家并行（EP）来保证计算密度和显存容量，最大限度减少小算子的通信损耗。</li>
</ul>
<p><strong>在资源配比与专家策略上：</strong></p>
<ul>
<li>
<p>采用 2P1D 架构。即 1 个 P900 超节点（32 卡）承载 2 个 Prefill 实例（各 16 卡）；另 1 个 P900 超节点承载 1 个 Decode 实例（32 卡）；</p>
</li>
<li>
<p>在专家并行（EP）配置：Prefill (EP16)：单卡承载 16 个专家，利用高计算密度掩盖专家路由开销；Decode (EP32)：单卡承载 8 个专家。通过扩大 EP 规模至 32 卡，将模型专家分散存储，大幅降低了单卡权重显存占用，从而为 KV Cache 腾出宝贵的显存空间，支持更长的上下文；</p>
</li>
<li>
<p>共享专家（Shared Experts）：在 Decode 阶段采用全 DP（Data Parallel） 策略，即共享专家在每张卡上都有一份完整副本，确保这些高频访问的专家无需跨卡通信即可直接调用，进一步降低 TPOT。</p>
</li>
</ul>
<p><strong>量化与精度策略：</strong></p>
<ul>
<li>
<p>量化方案：在算子层面，整体采用 A8W8C16 (Activation 8-bit, Weight 8-bit, Compute / Accumulation 16-bit) 的量化方案，在保证精度稳定性的前提下提升推理性能；</p>
</li>
<li>
<p>MLA 优化：针对 MLA （Multi-Head Latent Attention）架构中的 FlashAttention （FA）算子，我们采用 FP16 精度，以确保长序列下注意力分数的数值稳定性，避免量化带来的精度溢出问题。</p>
</li>
</ul>
<p><strong>调度层面：</strong></p>
<ul>
<li>配合精细化 DP 均衡调度，最大程度的消除 idle batch 占比，避免因为调度问题导致 DP 负载不均，减少 Prefill 侧产生 idle batch 的比例，避免出现大量请求排队的问题，从而提高 Prefill 单卡吞吐。</li>
</ul>
<h3 data-id="heading-2"><strong>3. 百度天池超节点推理性能优化</strong></h3>
<p>基于上述部署方案，在满足 SLA 约束的前提下，为进一步提高 Prefill 和 Decode 的吞吐性能，我们根据各阶段的特性针对性地实施了优化策略：</p>
<ul>
<li>
<p>对于 Prefill 阶段，核心目标是降低 TTFT。由于其计算特性以大规模矩阵计算为主，整体属于计算密集型负载，在超节点架构下算子效率本身并非主要瓶颈。真正限制 Prefill 性能释放的，是计算与通信在时间轴上的串行排布。因此，Prefill 优化的核心思路是通过双流优化与通信优化，将通信开销掩盖在计算过程中，从而在 TTFT 达标的前提下提升整体吞吐；</p>
</li>
<li>
<p>而 Decode 阶段，核心目标是将 TPOT 稳定控制在 50ms 以下，这意味着 run batch 中每一层、每一个算子的执行时间都必须受到严格约束。在这一阶段，推理性能不再取决于单个算子是否足够快，而取决于整个执行链路中是否存在被放大的「微小空泡」。这就需要我们将 Decode 的执行流程进一步拆解为「主模型运行前的组 batch 过程、主模型运行、以及 MTP 投机推理」，再根据不同阶段的性能特征和瓶颈来源，采用相应的优化策略。</p>
</li>
</ul>
<p>基于上述思路，下面将分别对 Prefill 与 Decode 两个阶段的具体优化方法与效果进行详细展开。</p>
<h3 data-id="heading-3"><strong>3.1. Prefill 优化</strong></h3>
<h4 data-id="heading-4"><strong>3.1.1. Prefill Overlap 优化</strong></h4>
<p>Prefill 阶段因上下文长度较长，attention 与 MoE 模块的计算耗时较长，而 MLP 模块中 dispatch 与 combine 两次通信的耗时，与 Attention、MoE 的计算耗时相当。并且在昆仑芯算子的实现中，计算算子与通信算子可在独立资源上并行调度，因此 Prefill 阶段可通过开启双流优化，利用计算耗时掩盖通信耗时，从而缩短整体执行时间。</p>
<p>以「4K 定长上下文、batch=2」的请求为例，开启双流优化后，会将总计 8K 的输入 token（4K×2）拆分为两个 4K 的 micro batch。在 run batch 过程中，两个 micro batch 的 attention 与 MLP 计算交替执行；与此同时，当第一个 micro batch 进行计算时，第二个 micro batch 可同步执行 dispatch 或 combine 通信操作，具体流程如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec6a6b7220ae4c18b8ac7e0db21f6404~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=zC3FVBDOX4JM%2FeofibC10URd%2BaY%3D" alt="" loading="lazy"/></p>
<p>这种计算与通信 overlap 的双流优化，在非超节点模式下虽能提升性能，但面对短序列场景时，计算耗时可能不足以完全掩盖通信耗时，便会导致计算资源的闲置，优化效果无法最大化体现。而在超节点模式下，通信耗时显著降低，attention 与 MLP 的计算耗时可完全覆盖 dispatch 与 combine 的通信耗时，便可减少性能空转（bubble），双流优化效果更优。</p>
<p>通过上述双流优化，Prefill 阶段的整体吞吐可提升约 20%。</p>
<h4 data-id="heading-5"><strong>3.1.2. Prefill 通信优化</strong></h4>
<p>由于 Prefill 采用 TP4，因此必然会引入通信过程，我们在通信策略优化的迭代过程如下图所示：</p>
<ul>
<li>
<p>方案一：q_down 和 kv_down 不做序列切分，重复计算；q_up 和 kv_up 按照 num_head 切 TP；MHA 部分也按照 num_head 切分；o_proj 切 TP；最后使用 AllReduce；MLP 部分使用序列切分，MLP 计算完成后 AllGather 聚合结果。</p>
</li>
<li>
<p>方案二：采用 TP + SP，q_down 和 kv_down 采用序列切分；然后 AllGather 汇聚 BS；q_up 和 kv_up 切 TP；MHA 部分按照 num_head 切分；o_proj 切 TP；最后使用 ReduceScatter；进入 MLP 后使用序列切分。</p>
</li>
<li>
<p>方案三：在方案二的基础上，MHA 后使用 AlltoAll；o_proj 不做 TP 切分，采用序列切分。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8067027cedd046a0bde89b2f89dc1059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=QWVTV5K%2Bue0P%2FgAMqAkiWJR8oUA%3D" alt="" loading="lazy"/></p>
<p>使用方案一：</p>
<ul>
<li>q_down 和 kv_down 存在冗余计算，这部分单卡计算量是方案二和方案三的 4 倍；</li>
<li>通信的部分引入 AllReduce + AllGather，总通信量为: <strong>BS x 16128</strong></li>
<li>
<ul>
<li>AllReduce：</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4de97dd36694bd9a8b046c176b636ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=jmd2QD6kZ7QTfdeKty6kjLr0ddI%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<ul>
<li>AllGather：</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7636d1365514fbcb2661428297a9c64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=x96S8mSVzEV4i9eMHNOccmFwmTA%3D" alt="" loading="lazy"/></p>
<p>使用方案二：</p>
<ul>
<li>通信的部分引入 AllGather + ReduceScatter，总通信量为: <strong>BS x 5772</strong></li>
<li>
<ul>
<li>AllGather <strong>：</strong></li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dfd19defbc1449da1bb83a0ad67e1d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=J0eh8usIl76yWKeQwuZMy7Qo9CM%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<ul>
<li>ReduceScatter：</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/350a6d711a714f4695be836c4e345635~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=hqebGwQzn1VEY1bpM2YKkNNkSpQ%3D" alt="" loading="lazy"/></p>
<p>使用方案三：</p>
<ul>
<li>通信的部分引入了 AllGather + AlltoAll，总通信量为: <strong>BS x 3468</strong></li>
<li>
<ul>
<li>AllGather：</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e09df2a90720474d9d0284f5c93ad063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=V1XVijyoIsshtGcIxV%2BK9E%2BfgMU%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<ul>
<li>AlltoAll <strong>：</strong></li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27e7fe38e54b4b879af48a45803a0ddf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=unsqCaoTQrMQAIpngFKSJg3EML8%3D" alt="" loading="lazy"/></p>
<p>可以看到：方案三的通信量最少，这也是我们所采用的 Prefill 通信方案。</p>
<h4 data-id="heading-6"><strong>3.1.3. Prefill 长序列优化</strong></h4>
<p>面向 128K 的长序列输入时，Prefill 的计算压力异常大。为此，我们充分利用了超节点更大 Scale up 域的优势，针对长序列 Prefill 使用了更大的 TP 范围（如 TP16 + SP16、TP32 + SP32）。借此，一方面可以减少单卡的计算量，缩短整体计算时间，从而降低 TTFT，另一方面可以降低单卡的显存使用量，提高 chunk size 的大小，从而进一步提高单卡吞吐。</p>
<p>在128K 长序列场景中，TTFT 可缩小 5 倍以上，单卡吞吐可提高 80%。</p>
<h3 data-id="heading-7"><strong>3.2. Decode 优化</strong></h3>
<p>Decode 阶段包含「主模型运行前的组 batch 过程、主模型运行、以及 MTP 投机推理」三个部分。基于各部分的业务逻辑分析，我们针对「主模型运行阶段」进行了主模型 Overlap 和算子优化，并针对「组 batch 和 MTP 投机推理」阶段进行了算子缝隙优化。</p>
<h4 data-id="heading-8"><strong>3.2.1. Decode 主模型 Overlap 优化</strong></h4>
<p>Decode 侧未开启双流优化，核心基于两方面考量：</p>
<ul>
<li>受 TPOT 约束，Decode 侧的 batch 通常较小，并且 Decode 属于访存密集型，小 batch 下 GEMM 运算的 TFLOPS 本就较低，拆分 batch 不仅难以获得显著收益，反而可能出现负收益；</li>
<li>依托百度天池超节点更高的通信效率，通信耗时在单层执行时间的占比不足 15%，且与计算耗时差距显著。此时通过双流优化掩盖通信耗时的收益有限，不足以抵消算子效率下降带来的额外开销。</li>
</ul>
<p>因此，Decode 侧未采用拆 batch 的方式，转而探索单流执行场景下的优化空间：寻找互不依赖、且可调度至不同资源并行执行（overlap）的算子组合。依此，我们将运行在 cluster 上的 combine 算子与运行在 SDNN 的共享专家（shared expert）计算进行并行调度：在 combine 算子执行期间，同步运行共享专家的计算逻辑，待二者均完成后，再执行路由专家与共享专家的结果合并。</p>
<p>下图中黄色表示运行在 cluster 上的算子，蓝色表示运行在 SDNN 上的算子。优化前所有的通信和计算算子都在一条 stream1 上运行；优化后 stream1 在 cluster 资源上运行 combine 通信算子的同时，并行的 stream2 在 SDNN 资源上运行共享专家，以实现资源的最大化复用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fc3ee4674a8499091db9db7904e4324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=h5HCZwJTwo1khQ8W4wWsCbMKG5k%3D" alt="" loading="lazy"/></p>
<p>通过上述主模型的 Overlap 优化，Decode 阶段的TPOT 降低约 7%。</p>
<h4 data-id="heading-9"><strong>3.2.2. Decode 主模型算子优化</strong></h4>
<p>百度天池超节点更大的 Scale-up 域为大规模并行计算提供了极致的通信效率，因此计算算子的耗时会更加凸显。</p>
<h5 data-id="heading-10"><strong>3.2.2.1. Decode 主模型计算算子优化</strong></h5>
<p>除了前面提到的部分计算算子可以被通信 overlap 之外，我们针对 Decode 单层执行的所有算子做了 Trace 分析，尝试找出哪些算子存在瓶颈，及其是否有优化空间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a8bc4e57b5b49e1a575cc9bd4afd3ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=ktwiNl44U51DGnmUaRD8QJbF7RU%3D" alt="" loading="lazy"/></p>
<p>该表格主要列举了：Decode 单层执行的所有算子中，attention 所有算子在 attention 整体时间的占比。</p>
<p><em>特别说明：</em></p>
<ul>
<li><em>对照 DeepSeek 官方发布的在 H 卡的 decode trace 信息；</em></li>
<li><em>由于 DeepSeek 官方在 H 卡上 Decode 使用了双 micro batch overlap，而且 EP 规模与我们配置不同，因此我们只对比 attention 部分的算子占比；</em></li>
<li><em>虽然两个场景的 batch 大小不一样，但是输入长度一致，因此 attention 部分的算子占比也能说明各算子的性能表现。</em></li>
</ul>
<p>通过对比和分析，我们看到：</p>
<ul>
<li>q_k_up_absorb: bmm 和 v_up_absorb: bmm 这两个矩阵的吸收算子，百度天池超节点算子占比明显高于 H 卡表现。经过进一步分析，我们发现这两个部分的小算子太多，于是我们进行了算子融合优化，最终合成一个 fc_batch 的算子，节省了一倍以上的算子执行时间；<br/>
优化后的效果体现如下图所示：q_k_up_absorb: bmm 的算子占比从 7.422% 下降到 5.803%；v_up_absorb: bmm 的占比从 6.901% 下降到 4.910%</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/979d729d85314b0281dfd042bfb04442~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=RhhFKX8OF6EuuYb89UhVL7jLrvk%3D" alt="" loading="lazy"/></p>
<ul>
<li>attn_mqa 算子的耗时显著高于其它算子，基于我们的过往经验判断，该算子具有一定的优化空间。对此，在做 fa 计算之前我们消除掉了不必要的 memcpy 操作和 reshape 等小算子；在 fa 计算之后，我们消除掉了量化 cast 操作，让后续 GEMM 算子的输入匹配 fa 算子的输出；</li>
<li>针对所有的 GEMM 算子，我们使用 autotune，让 GEMM 算子在不同的 batch size 和 sequence length 下自动使用最佳配置，保持最佳性能。</li>
</ul>
<p>通过主模型的计算算子优化，attention 部分总体时延降低 11.5%，Decode 阶段的 TPOT 降低约 8%。</p>
<h5 data-id="heading-11"><strong>3.2.2.2. Decode EP 通信算子优化</strong></h5>
<p>我们在通信算子的优化措施主要包括两方面：</p>
<ul>
<li>
<p>combine 及 dispatch 的数据传输优化：针对不同 EP 规模与传输 token 数量，算子自动选择最优发送策略，充分释放硬件资源潜力；</p>
</li>
<li>
<p>combine 算子优化：在 reduce 计算过程中，通过消除中间结果的冗余量化与存储步骤，直接提升 reduce 计算效率。</p>
</li>
</ul>
<p>经过以上优化，再结合硬件性能提升，通信时间在单层执行时间的占比从 40% 降到 15%，而整个 Decode 要进行 59 次（ 58 个 MoE 层 + 1 个 MTP 层）这样的通信，耗时可被显著压缩。</p>
<p>下图展示了 dispatch 与 combine 在不同 token 数量、EP 规模场景下的通信时延。从数据可见：在 EP32、96token 的典型场景中（该场景满足 TPOT &lt; 50ms)，dispatch 时延仅 80.419μs，combine 时延仅 105.466μs。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/383ca572e3874f5fb39fe2e3bb8d8861~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=yEcVteD%2F1KCR%2FVjJUjxtn7JJhfk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12"><strong>3.2.3. Decode 算子缝隙优化</strong></h4>
<h5 data-id="heading-13"><strong>3.2.3.1. MTP 层缝隙优化</strong></h5>
<p>MTP 投机推理是 Decode 阶段降低 TPOT 的成熟且高效的技术路径：通过在主模型前引入 draft 模型，从而在 Decode 阶段可一次生成多个 token，降低 TPOT、提升吐字率，优化用户交互体验。</p>
<p>在我们的 MTP 方案实现中，主模型运行结束后会执行 verify 校验 —— 对比本次主模型输出 token 与上一轮 draft 模型的预测 token：若二者一致，则说明上一轮 draft 模型预测准确，且主模型基于该预测 token 生成的 token 同样有效，此时可将两个 token 同步输出。</p>
<p>整体流程如下图所示，由于 verify 的校验逻辑涉及大量 CPU 的 H2D 和 D2H 等同步操作，当下图中 CPU 执行 D2H-1 操作时，需等待 XPU 侧执行完 D2H-1 后才能执行 D2H-2 操作，此时会造成 D2H-2 的启动 （Launch）开销无法被掩盖，因此产生算子缝隙，同理，后续 MTP 层由于也无法被提前启动，同样会产生算子缝隙。</p>
<p>对此，我们对 verify 的过程进行优化 —— 消除掉一些 H2D 和 D2H 操作，并将 verify 过程拆成两个部分：将无法消除掉的包含 H2D 和 D2H 的 verify2 部分移动到 MTP 层后面，剩余 verify1 的部分和 MTP 层可被提前启动，以此消除掉算子缝隙。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9808bdad5d6482bbeb5b618b77b8bd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=FXJQ0UFbqoeNY%2BOsrkZo56XUNxs%3D" alt="" loading="lazy"/></p>
<p>经过优化后，TPOT 可降低约 5%。</p>
<h5 data-id="heading-14"><strong>3.2.3.2. 组 batch 缝隙优化</strong></h5>
<p>Decode 阶段在运行主模型前需执行组 batch 操作，该过程包含大量 CPU 操作且难以剔除。为此，我们通过提前启动下一个 batch 的 XPU 算子，使组 batch 操作与本次 batch 的 XPU 运算（run batch）重叠执行，从而掩盖组 batch 的耗时。</p>
<p>具体方案如下图所示（同一种颜色代表一个请求）：</p>
<ul>
<li>Process: CPU 侧的组 batch + 主模型启动操作；</li>
<li>Schedule: XPU 侧的主模型 + MTP 模型运算；</li>
<li>Post Process: 请求完全结束后的 CPU 后续处理。</li>
</ul>
<p>流程优化逻辑如下：当第一个请求的 XPU 算子执行时，提前启动下一个请求的组 batch 与算子启动流程，此时组 batch 耗时可被完全掩盖；第一个 batch 的 XPU 运算完成后，CPU 执行后续处理，随后触发已提前启动的下一个 XPU 算子。依此循环，组 batch 耗时可被彻底消除。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c55234dc85524118a40d72428e138867~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5pm66IO95LqR5oqA5pyv56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768199401&amp;x-signature=5ONphNH8ad3Fa1PNNgjz2mn1hSQ%3D" alt="" loading="lazy"/></p>
<p>经过优化后，TPOT 可降低约 10%。</p>
<h2 data-id="heading-15"><strong>4. 总结与展望</strong></h2>
<p><strong>百度天池超节点推理性能优化实战成效</strong></p>
<p>百度天池超节点通过「PD 分离架构 - 硬件升级 - 软件深耕」的三阶优化路径，实现大模型推理性能的跨越式突破，充分验证了昆仑芯与百度百舸的软硬协同优势：</p>
<ul>
<li>
<p>第一阶段以架构革新破除性能瓶颈，在大规模部署场景下，通过 EP 分离 + PD 分离的创新架构设计，直接实现推理性能 10 倍跃升，为后续优化奠定坚实基础；</p>
</li>
<li>
<p>第二阶段聚焦硬件潜能释放与软件深度适配，将传统 8 卡全互联架构升级为 32 卡超节点全互联，并通过算子融合、通信调度等全栈软件优化，彻底激活硬件算力。</p>
</li>
</ul>
<p>在 4K 输入上下文场景下：</p>
<p>Prefill 阶段单卡吞吐达 4.1K，较 PD 分离架构下非超节点硬件形态的 P800 提升 45%；Decode 阶段单卡吞吐突破 1.006K，较前者实现了 168%的性能提升，且核心延迟指标 TPOT 仅为 47.6ms。</p>
<p><strong>未来展望</strong></p>
<p>在当前市场阶段，千亿参数级模型仍是主流。我们认为，32/64 卡规模的超节点能够很好的承载推理及训练对算力的需求 —— 它不仅通过大幅扩展 Scale-up 域显著提升了 EP 并行效率，更在成本控制上展现了极高的性价比。百度天池超节点是将极致性能与可落地性深度融合：以高稳定性、快速部署、极简运维构建高效交付闭环，真正实现「以 8 卡机的部署运维体验，兑现超节点的极致算力」。</p>
<p>未来，随着模型的发展与软硬件技术的日趋成熟，更大规模的超节点落地将是必然趋势。面对显存容量瓶颈、KV Cache 空间压力等挑战，我们将通过软硬件深度协同创新，持续支撑更大集群规模与更多样化模型部署需求。</p>
<p>在硬件层面，昆仑芯全新一代产品即将陆续面世，百度天池超节点的 Scale-up 域将进一步扩展至 512 卡规模，全力支撑万亿参数模型的极限挑战；而在软件层面，面向刚刚发布的 DeepSeek V3.2，以及未来大量模型的持续迭代，软件优化工作也将永不停歇。</p>
<p>通过硬件与软件的协同创新，百度智能云将不断突破超节点性能上限、下探每 Token 算力成本，既支撑企业快速落地超节点，更通过长期技术迭代与企业共同兑现超节点「越用越优」的业务价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent案例实践：三种智能体开发模式详解之一（手写代码）]]></title>    <link>https://juejin.cn/post/7591407298414493702</link>    <guid>https://juejin.cn/post/7591407298414493702</guid>    <pubDate>2026-01-05T06:04:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591407298414493702" data-draft-id="7591403124327399487" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent案例实践：三种智能体开发模式详解之一（手写代码）"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2026-01-05T06:04:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木昆子"/> <meta itemprop="url" content="https://juejin.cn/user/825103640698564"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent案例实践：三种智能体开发模式详解之一（手写代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/825103640698564/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木昆子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T06:04:30.000Z" title="Mon Jan 05 2026 06:04:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大模型与智能体应用场景层出不穷的今天，作为一名不断学习的信息化数字化从业者，我们可以实践一下AI Agent基本开发流程，理论联系实践，以加深我们对AI Agent的了解。</p>
<h2 data-id="heading-0">一、案例描述</h2>
<h3 data-id="heading-1">1.1. 业务场景</h3>
<p>这里我们设计一个简单的场景：2025年，一位高三的同学在高考结束之后，借助AI Agent简单的查询了解一下2016年到2024的考生人数、录取人数、复读人数、普通高校数量、本科录取人数、专科录取人数这些基本信息，对历年高考考生规模做一个基本了解，借助小助手做一个简单分析预测。</p>
<p>基于这个场景，我们梳理一下我们的Agent需要实现的功能：用户输入自然语言查询高考录取相关信息，Agent自动生成查询SQL，查询完毕后附带简要分析输出，具体如下：</p>
<ul>
<li>结构化的数据需要后台运维，进行持久化存储，采用Mysql存储，涉及多张表的数据；</li>
<li>元数据结构采用ElasticSearch8存储，可向量化KNN匹配；</li>
<li>自然语言解析出查询SQL需要借助大模型匹配元数据结构，然后编写提示词生成SQL；</li>
<li>生成的SQL需要到Mysql查询数据；</li>
<li>查询完毕的数据还需要借助大模型分析一下返回。</li>
</ul>
<h3 data-id="heading-2">1.2. 数据准备</h3>
<p>对于高考信息，我们需要存储到Mysql的结构化的表中，以便搜索查询数据，表结构如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> college_entrance_examination;  
droptable college_entrance_admission;  
createtable college_entrance_examination (  
    examination_year              integerNOTNULL COMMENT <span class="hljs-string">'高考年份'</span>,  
    candidates_count              <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) NOTNULL COMMENT <span class="hljs-string">'考生人数(万人)'</span>,  
    retake_count                  <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'复读人数(万人)'</span>,  
    <span class="hljs-keyword">primary</span> key (examination_year)  
) comment <span class="hljs-string">'考生人数与复读人数信息表，包含字段：高考年份(主键)、考生人数(万人)、复读人数(万人)'</span>;  
  
createtable college_entrance_admission (  
    admission_year              integerNOTNULL COMMENT <span class="hljs-string">'录取年份'</span>,  
    admission_count               <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) NOTNULL COMMENT <span class="hljs-string">'录取人数(万人)'</span>,  
    university_count              <span class="hljs-type">integer</span> COMMENT <span class="hljs-string">'普通高中招生高校数'</span>,  
    undergraduate_admission_count    <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'本科录取人数(万人)'</span>,  
    specialty_admission_count   <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'专科录取人数(万人)'</span>,  
    <span class="hljs-keyword">primary</span> key (admission_year)  
) comment <span class="hljs-string">'录取人数与普通高校数信息表，包含字段：录取年份(主键)、录取人数(万人)、普通高中招生高校数、本科录取人数(万人)、专科录取人数(万人)'</span>;
</code></pre>
<p>数据如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> college_entrance_examination(  
    examination_year,candidates_count,retake_count  
) <span class="hljs-keyword">values</span>  
(<span class="hljs-number">2016</span>,<span class="hljs-number">940</span>,<span class="hljs-number">117</span>),  
(<span class="hljs-number">2017</span>,<span class="hljs-number">940</span>,<span class="hljs-number">143.39</span>),  
(<span class="hljs-number">2018</span>,<span class="hljs-number">975</span>,<span class="hljs-number">172.1</span>),  
(<span class="hljs-number">2019</span>,<span class="hljs-number">1031</span>,<span class="hljs-number">230.95</span>),  
(<span class="hljs-number">2020</span>,<span class="hljs-number">1071</span>,<span class="hljs-number">242.2</span>),  
(<span class="hljs-number">2021</span>,<span class="hljs-number">1078</span>,<span class="hljs-number">187</span>),  
(<span class="hljs-number">2022</span>,<span class="hljs-number">1193</span>,<span class="hljs-number">316.56</span>),  
(<span class="hljs-number">2023</span>,<span class="hljs-number">1291</span>,<span class="hljs-number">210</span>),  
(<span class="hljs-number">2024</span>,<span class="hljs-number">1342</span>,<span class="hljs-number">413</span>)  
;  
  
insertinto college_entrance_admission(  
    admission_year,admission_count,university_count,  
    undergraduate_admission_count,specialty_admission_count  
) <span class="hljs-keyword">values</span>  
(<span class="hljs-number">2016</span>,<span class="hljs-number">772</span>,<span class="hljs-number">2595</span>,<span class="hljs-number">405</span>,<span class="hljs-number">367</span>),  
(<span class="hljs-number">2017</span>,<span class="hljs-number">761.49</span>,<span class="hljs-number">2631</span>,<span class="hljs-number">410</span>,<span class="hljs-number">351</span>),  
(<span class="hljs-number">2018</span>,<span class="hljs-number">790.99</span>,<span class="hljs-number">2663</span>,<span class="hljs-number">422</span>,<span class="hljs-number">369</span>),  
(<span class="hljs-number">2019</span>,<span class="hljs-number">820</span>,<span class="hljs-number">2688</span>,<span class="hljs-number">431</span>,<span class="hljs-number">389</span>),  
(<span class="hljs-number">2020</span>,<span class="hljs-number">967.45</span>,<span class="hljs-number">2740</span>,<span class="hljs-number">443</span>,<span class="hljs-number">524.45</span>),  
(<span class="hljs-number">2021</span>,<span class="hljs-number">1001.32</span>,<span class="hljs-number">2759</span>,<span class="hljs-number">448.74</span>,<span class="hljs-number">552.58</span>),  
(<span class="hljs-number">2022</span>,<span class="hljs-number">1014.54</span>,<span class="hljs-number">2760</span>,<span class="hljs-number">467.18</span>,<span class="hljs-number">547.36</span>),  
(<span class="hljs-number">2023</span>,<span class="hljs-number">1058.21</span>,<span class="hljs-number">2820</span>,<span class="hljs-number">482.89</span>,<span class="hljs-number">575.32</span>),  
(<span class="hljs-number">2024</span>,<span class="hljs-number">1068.9</span>,<span class="hljs-number">2868</span>,<span class="hljs-number">478.16</span>, <span class="hljs-number">590.74</span>)  
;
</code></pre>
<p>注1：上述高考考生基本数据来源于互联网、教育局网站。</p>
<p>注2：具体业务上可能远远不止一个数据源、两张表，需要根据用户问题使用RAG检索匹配具体使用哪个数据源的哪个表，本次实践仅仅使用两张表模拟多数据源的业务场景，为语义匹配流程开发做一个学习与了解！</p>
<p>接下来我们分别用手写代码、基于LangChain框架、基于QwenAgent框架等三种不同的模式进行AI Agent的实践探索。</p>
<h2 data-id="heading-3">二、开发实践（手写代码）</h2>
<h3 data-id="heading-4">2.1. 总体架构</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87faecf36c9b4246a6fc6c5eff5d2a7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5piG5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768197870&amp;x-signature=oyaFsbxV0WKWV1tHKrBmcFNejW4%3D" alt="" loading="lazy"/></p>
<p>1、API服务(API Service)对智能体提供类似MCP的工具服务；</p>
<p>2、智能体(AI Data Analysis Agent)对用户输入的自然语言查数进行回答，执行过程中调用相应的API服务；</p>
<p>3、同时智能体具有简单的容错流程：未匹配到元数据时结束流程并进行提示、生成的SQL未查询到数据时结束流程并进行提示；</p>
<h3 data-id="heading-5">2.2. 实现流程</h3>
<p>按照我们上面的核心业务梳理实现流程，手写一个Workflow，主要是根据用户问题，先匹配数据源的表结构，再生成SQL、查数和分析。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cce8ff1f3c894390acaa8d6f295286ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5piG5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768197870&amp;x-signature=QQU3UdRknnUxIkDrlE%2FKEctgwt0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">2.3. 智能体代码实践</h4>
<p>具体开发实现如下(agent_service.py)：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sys  
<span class="hljs-keyword">import</span> re  
<span class="hljs-keyword">import</span> json  
<span class="hljs-keyword">from</span> api_service <span class="hljs-keyword">import</span> QueryService,SemanticServce,AnalysisService  
  
<span class="hljs-comment"># metadata init  元数据初始向量化过程  </span>
definit():  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始执行方法init"</span>)  
    queryService = QueryService()  
    semanticService = SemanticServce()  
    <span class="hljs-comment"># 1. 从mysql中获取表结构元数据信息  </span>
    results = queryService.query(  
        <span class="hljs-string">"""  
        SELECT  
            t.TABLE_NAME AS '表名',  
            t.TABLE_COMMENT AS '表备注',  
            c.COLUMN_NAME AS '字段名',  
            c.COLUMN_TYPE AS '字段类型',  
            c.COLUMN_COMMENT AS '字段备注'  
        FROM  
            INFORMATION_SCHEMA.TABLES t  
        INNER JOIN  
            INFORMATION_SCHEMA.COLUMNS c  
            ON t.TABLE_NAME = c.TABLE_NAME AND t.TABLE_SCHEMA = c.TABLE_SCHEMA  
        WHERE  
            t.TABLE_SCHEMA = 'chaiys'  
            and t.table_name in ('college_entrance_admission','college_entrance_examination')  
        ORDER BY  
            t.TABLE_NAME,  
            c.ORDINAL_POSITION  
        """</span>  
    )  
    table_data = {}  
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> results:  
        table_name = row[<span class="hljs-number">0</span>]  
        <span class="hljs-keyword">if</span> table_name notin table_data:  
            table_data[table_name] = {  
                <span class="hljs-string">'表名'</span>: table_name,  
                <span class="hljs-string">'表备注'</span>: row[<span class="hljs-number">1</span>],  
                <span class="hljs-string">'字段列表'</span>: []  
            }  
          
        <span class="hljs-comment"># 添加字段信息  </span>
        table_data[table_name][<span class="hljs-string">'字段列表'</span>].append({  
            <span class="hljs-string">'字段名'</span>: row[<span class="hljs-number">2</span>],  
            <span class="hljs-string">'字段类型'</span>: row[<span class="hljs-number">3</span>],  
            <span class="hljs-string">'字段备注'</span>: row[<span class="hljs-number">4</span>]  
        })  
      
    <span class="hljs-built_in">print</span>(table_data)  
    semanticService.create_index()  
    <span class="hljs-comment"># 转换为列表形式  </span>
    <span class="hljs-keyword">for</span> table_name inlist(table_data.keys()):  
        table = table_data[table_name]  
        <span class="hljs-comment"># 2. 向量化表结构元数据信息并插入ES索引  </span>
        semanticService.vectorize_and_index(table_name, json.dumps(table, ensure_ascii=<span class="hljs-literal">False</span>))  
  
<span class="hljs-comment"># agent flow  智能体核心流程  </span>
defchat(user_query):  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"执行方法chat"</span>)  
    queryService = QueryService()  
    semanticService = SemanticServce()  
    analysisService = AnalysisService()  
    <span class="hljs-comment"># 1. 语义匹配  </span>
    table = semanticService.hybrid_search(user_query, <span class="hljs-number">1</span>)  
    ifnot table:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"未匹配到字段"</span>)  
        <span class="hljs-keyword">return</span>  
    table_list = [t[<span class="hljs-string">"table_info"</span>] <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> table]  
    prompt = <span class="hljs-string">f"""  
        你是一个MySQL专家。根据以下表结构信息：  
        <span class="hljs-subst">{table_list}</span>  
          
        用户查询："<span class="hljs-subst">{user_query}</span>"  
          
        生成标准MYSQL查询语句。  
        要求：  
        1. 只输出MYSQL语句，不要额外解释  
        2. 根据语义和字段类型，使用COUNT/SUM/AVG等聚合函数进行计算，非必须  
        3. 给生成的字段取一个简短的中文名称  
        输出格式：使用[]包含sql文本即可，不需要其他输出，便于解析，例如:[select 1 from dual]  
    """</span>  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PROMPT=<span class="hljs-subst">{prompt}</span>"</span>)  
    <span class="hljs-comment"># 2. 大模型生成SQL  </span>
    str1 = analysisService.analysis(prompt)  
    sql = re.search(<span class="hljs-string">r'\[(.*?)\]'</span>, str1, re.DOTALL).group(<span class="hljs-number">1</span>).strip()  
      
    <span class="hljs-comment"># 3. 执行查询  </span>
    <span class="hljs-keyword">if</span> sql:  
        resultSet = queryService.query_with_column(sql)  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"resultSet=<span class="hljs-subst">{resultSet}</span>"</span>)  
          
        <span class="hljs-comment"># 基础分析  </span>
        prompt2 = <span class="hljs-string">f"""  
            根据以下表结构信息：  
            <span class="hljs-subst">{table_list}</span>  
            查询SQL：  
            <span class="hljs-subst">{sql}</span>  
            和以下数据信息：  
            <span class="hljs-subst">{resultSet}</span>  
              
            用户查询："<span class="hljs-subst">{user_query}</span>"  
              
            生成一段简要分析，加上一些预测总结的内容  
        """</span>  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PROMPT=<span class="hljs-subst">{prompt2}</span>"</span>)  
        analysisService.analysis(prompt2)  
  
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
    <span class="hljs-comment"># 获取命令行参数  </span>
    args = sys.argv[<span class="hljs-number">1</span>:]  <span class="hljs-comment"># 第一个参数是脚本名，跳过  </span>
      
    ifnot args:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请提供参数：init或者chat+user_query"</span>)  
    <span class="hljs-keyword">elif</span> args[<span class="hljs-number">0</span>] == <span class="hljs-string">"init"</span>:  
        init()  
    <span class="hljs-keyword">elif</span> args[<span class="hljs-number">0</span>] == <span class="hljs-string">"chat"</span>:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"user_query=<span class="hljs-subst">{args[<span class="hljs-number">1</span>]}</span>"</span>)  
        chat(args[<span class="hljs-number">1</span>])  
    <span class="hljs-keyword">else</span>:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"未知参数: <span class="hljs-subst">{args[<span class="hljs-number">0</span>]}</span>"</span>)
</code></pre>
<h3 data-id="heading-7">2.4. API服务代码实践</h3>
<p>这里的API服务，指的是为智能体的实现提供服务调用，文件名称api_service.py。</p>
<h4 data-id="heading-8">2.4.1. 语义检索服务(Semantics API)</h4>
<p>语义服务有两个功能：</p>
<p>1、将元数据向量化到ES8，调用文本嵌入向量模型llama2向量化自然语言，生成4096高维向量;</p>
<p>2、自然语言匹配元数据返回，调用文本嵌入向量模型llama2向量化后，调用ES8使用KNN检索topK数据+分词检索topK数据，混合计算得分后返回最终topK,即简化版的外置检索增强生成(RAG);</p>
<p>具体开发实现如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests  
<span class="hljs-keyword">import</span> json  
<span class="hljs-keyword">from</span> elasticsearch <span class="hljs-keyword">import</span> Elasticsearch  
  
<span class="hljs-comment"># Semantics API  </span>
classSemanticServce:  
    def__init__(self):  
        self.es_client = Elasticsearch(  
            hosts=[<span class="hljs-string">"https://localhost:9200"</span>],  
            basic_auth=(<span class="hljs-string">"elastic"</span>, <span class="hljs-string">"FxCZQXMLEoZLAIvsghQy"</span>),  
            ca_certs=<span class="hljs-string">"./es_http_ca.crt"</span>,  
            verify_certs=<span class="hljs-literal">True</span>  
        )  
        <span class="hljs-comment"># 向量化模型  </span>
        self.ollama_host = <span class="hljs-string">"http://localhost:11434/api/embeddings"</span>  
        self.metadata_index = <span class="hljs-string">"metadata_index"</span>  
        self.modal_name = <span class="hljs-string">"llama2"</span>  
        self.mapping = {  
            <span class="hljs-string">"mappings"</span>: {  
                <span class="hljs-string">"properties"</span>: {  
                    <span class="hljs-string">"table_info"</span>: {  
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,  
                        <span class="hljs-string">"analyzer"</span>: <span class="hljs-string">"ik_max_word"</span>,  <span class="hljs-comment"># 中文分词  </span>
                        <span class="hljs-string">"search_analyzer"</span>: <span class="hljs-string">"ik_smart"</span>  
                    },  
                    <span class="hljs-string">"nomic_embedding"</span>: {  
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"dense_vector"</span>,  
                        <span class="hljs-string">"dims"</span>: <span class="hljs-number">4096</span>,  
                        <span class="hljs-string">"index"</span>: <span class="hljs-literal">True</span>,  
                        <span class="hljs-string">"similarity"</span>: <span class="hljs-string">"cosine"</span>,  
                    }  
                }  
            }  
        }  
  
    defget_embedding(self, text):  
        <span class="hljs-string">"""使用 Ollama 生成文本嵌入向量"""</span>  
        <span class="hljs-keyword">try</span>:  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"调用大模型llama2向量化：<span class="hljs-subst">{text}</span>"</span>)  
            response = requests.post(self.ollama_host, json={<span class="hljs-string">"model"</span>: self.modal_name, <span class="hljs-string">"prompt"</span>: text})  
            response.raise_for_status()  
            embedding = response.json()[<span class="hljs-string">"embedding"</span>]  
            <span class="hljs-keyword">return</span> embedding  
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:  
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f"嵌入生成失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)  
      
    defdelete_index(self):  
        <span class="hljs-string">"""安全删除索引"""</span>  
        <span class="hljs-keyword">try</span>:  
            ifself.es_client.indices.exists(index=self.metadata_index):  
                self.es_client.indices.delete(index=self.metadata_index)  
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"索引 <span class="hljs-subst">{self.metadata_index}</span> 删除成功"</span>)  
                returnTrue  
            returnNone  
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"删除索引失败: <span class="hljs-subst">{<span class="hljs-built_in">type</span>(e).__name__}</span>: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)  
            returnFalse  
  
    defcreate_index(self):  
        self.delete_index()  
        <span class="hljs-string">"""创建支持nomic向量的索引"""</span>  
        self.es_client.indices.create(index=self.metadata_index, body=self.mapping)  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"索引 <span class="hljs-subst">{self.metadata_index}</span> 创建成功"</span>)  
      
    defvectorize_and_index(self, prompt, content):  
        <span class="hljs-string">"""生成文本嵌入向量并插入索引"""</span>  
        doc = {  
            <span class="hljs-string">"table_info"</span>: content,  
            <span class="hljs-string">"nomic_embedding"</span>: self.get_embedding(prompt)  
        }  
        self.es_client.index(index=self.metadata_index, document=doc)  
        self.es_client.indices.refresh(index=self.metadata_index)  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"表信息 <span class="hljs-subst">{prompt}</span>:<span class="hljs-subst">{content}</span> 向量化成功"</span>)  
      
    defsemantic_search(self, user_query, k):  
        <span class="hljs-string">"""执行语义相似度搜索"""</span>  
        query_embedding = self.get_embedding(user_query)  
          
        knn_query = {  
            <span class="hljs-string">"knn"</span>: {  
                <span class="hljs-string">"field"</span>: <span class="hljs-string">"nomic_embedding"</span>,  
                <span class="hljs-string">"query_vector"</span>: query_embedding,  
                <span class="hljs-string">"k"</span>: k,  
                <span class="hljs-string">"num_candidates"</span>: <span class="hljs-number">100</span><span class="hljs-comment"># 这就是ef_search参数  </span>
            },  
            <span class="hljs-string">"_source"</span>: [<span class="hljs-string">"table_info"</span>]  <span class="hljs-comment"># 返回原始问题  </span>
        }  
          
        response = self.es_client.search(index=self.metadata_index, body=knn_query)  
        table_info = [  
            {  
                <span class="hljs-string">"score"</span>: hit[<span class="hljs-string">"_score"</span>],  
                <span class="hljs-string">"table_info"</span>: hit[<span class="hljs-string">"_source"</span>][<span class="hljs-string">"table_info"</span>],  
                <span class="hljs-string">"id"</span>: hit[<span class="hljs-string">"_id"</span>]  
            }  
            <span class="hljs-keyword">for</span> hit <span class="hljs-keyword">in</span> response[<span class="hljs-string">"hits"</span>][<span class="hljs-string">"hits"</span>]  
        ]  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"自然语言语义检索字段成功，匹配到的元数据信息：<span class="hljs-subst">{table_info}</span>"</span>)  
        <span class="hljs-keyword">return</span> table_info  
  
    defkeyword_search(self, user_query: <span class="hljs-built_in">str</span>, k) -&gt; <span class="hljs-built_in">list</span>:  
        <span class="hljs-string">"""基于分词的关键词匹配搜索"""</span>  
        search_query = {  
            <span class="hljs-string">"query"</span>: {  
                <span class="hljs-string">"bool"</span>: {  
                    <span class="hljs-string">"should"</span>: [  
                        {  
                            <span class="hljs-string">"match"</span>: {  
                                <span class="hljs-string">"table_info"</span>: {  
                                    <span class="hljs-string">"query"</span>: user_query,  
                                    <span class="hljs-string">"analyzer"</span>: <span class="hljs-string">"ik_smart"</span>,  <span class="hljs-comment"># 使用IK中文分词器  </span>
                                    <span class="hljs-string">"boost"</span>: <span class="hljs-number">1.0</span>  
                                }  
                            }  
                        },  
                        {  
                            <span class="hljs-string">"match_phrase"</span>: {  
                                <span class="hljs-string">"table_info"</span>: {  
                                    <span class="hljs-string">"query"</span>: user_query,  
                                    <span class="hljs-string">"slop"</span>: <span class="hljs-number">2</span>,  <span class="hljs-comment"># 允许短语间隔  </span>
                                    <span class="hljs-string">"boost"</span>: <span class="hljs-number">0.5</span>  
                                }  
                            }  
                        }  
                    ]  
                }  
            },  
            <span class="hljs-string">"size"</span>: k,  
            <span class="hljs-string">"_source"</span>: [<span class="hljs-string">"table_info"</span>],  
            <span class="hljs-string">"highlight"</span>: {  
                <span class="hljs-string">"fields"</span>: {  
                    <span class="hljs-string">"table_info"</span>: {}  <span class="hljs-comment"># 返回高亮片段  </span>
                }  
            }  
        }  
  
        response = self.es_client.search(index=self.metadata_index, body=search_query)  
  
        table_info = [  
            {  
                <span class="hljs-string">"score"</span>: hit[<span class="hljs-string">"_score"</span>],  
                <span class="hljs-string">"table_info"</span>: hit[<span class="hljs-string">"_source"</span>][<span class="hljs-string">"table_info"</span>],  
                <span class="hljs-string">"id"</span>: hit[<span class="hljs-string">"_id"</span>],  
                <span class="hljs-string">"highlight"</span>: hit.get(<span class="hljs-string">"highlight"</span>, {}).get(<span class="hljs-string">"table_info"</span>, [])  
            }  
            <span class="hljs-keyword">for</span> hit <span class="hljs-keyword">in</span> response[<span class="hljs-string">"hits"</span>][<span class="hljs-string">"hits"</span>]  
        ]  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"自然语言分词搜索字段成功，匹配到的元数据信息：<span class="hljs-subst">{table_info}</span>"</span>)  
        <span class="hljs-keyword">return</span> table_info  
  
    defhybrid_search(self, user_query: <span class="hljs-built_in">str</span>, k, alpha: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.7</span>) -&gt; <span class="hljs-built_in">list</span>:  
        <span class="hljs-string">"""混合搜索（语义+关键词）"""</span>  
        <span class="hljs-comment"># 语义搜索  </span>
        semantic_results = self.semantic_search(user_query, k * <span class="hljs-number">2</span>)  
        semantic_map = {hit[<span class="hljs-string">"id"</span>]: hit <span class="hljs-keyword">for</span> hit <span class="hljs-keyword">in</span> semantic_results}  
  
        <span class="hljs-comment"># 关键词搜索  </span>
        keyword_results = self.keyword_search(user_query, k * <span class="hljs-number">2</span>)  
        keyword_map = {hit[<span class="hljs-string">"id"</span>]: hit <span class="hljs-keyword">for</span> hit <span class="hljs-keyword">in</span> keyword_results}  
  
        <span class="hljs-comment"># 合并结果  </span>
        all_ids = <span class="hljs-built_in">set</span>(semantic_map.keys()) | <span class="hljs-built_in">set</span>(keyword_map.keys())  
        combined = []  
  
        <span class="hljs-keyword">for</span> doc_id <span class="hljs-keyword">in</span> all_ids:  
            semantic_score = semantic_map.get(doc_id, {}).get(<span class="hljs-string">"score"</span>, <span class="hljs-number">0</span>)  
            keyword_score = keyword_map.get(doc_id, {}).get(<span class="hljs-string">"score"</span>, <span class="hljs-number">0</span>)  
  
            combined.append({  
                <span class="hljs-string">"id"</span>: doc_id,  
                <span class="hljs-string">"table_info"</span>: semantic_map.get(doc_id, keyword_map.get(doc_id))[<span class="hljs-string">"table_info"</span>],  
                <span class="hljs-string">"semantic_score"</span>: semantic_score,  
                <span class="hljs-string">"keyword_score"</span>: keyword_score,  
                <span class="hljs-string">"combined_score"</span>: alpha * semantic_score + (<span class="hljs-number">1</span> - alpha) * keyword_score,  
                <span class="hljs-string">"highlight"</span>: keyword_map.get(doc_id, {}).get(<span class="hljs-string">"highlight"</span>, [])  
            })  
  
        <span class="hljs-comment"># 按综合分数排序  </span>
        combined.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">"combined_score"</span>], reverse=<span class="hljs-literal">True</span>)  
  
        table_info = combined[:k]  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"自然语言混合检索字段成功，匹配到的元数据信息：<span class="hljs-subst">{table_info}</span>"</span>)  
        <span class="hljs-keyword">return</span> table_info
</code></pre>
<h4 data-id="heading-9">2.4.2. 大模型调用服务(Analysis API)</h4>
<p>大模型调用服务中，我们直接调用本地部署的deepseek-r1:32b大模型，根据传入的提示词进行处理，可以用于根据自然语言生成SQL即NL2SQL，也可以用于对查询结果数据进行简单总结和分析，具体开发实现如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests  
<span class="hljs-keyword">import</span> json  
<span class="hljs-comment"># Analysis API  </span>
classAnalysisService:  
    def__init__(self):  
        self.ollama_host = <span class="hljs-string">"http://localhost:11434/api/chat"</span>  
      
    defanalysis(self, prompt):  
        <span class="hljs-comment"># 发送POST请求  </span>
        <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>  
        <span class="hljs-comment"># 请求数据  </span>
        data = {  
            <span class="hljs-string">"model"</span>: <span class="hljs-string">"deepseek-r1:32b"</span>,  
            <span class="hljs-string">"messages"</span>: [  
                {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}  
            ],  
            <span class="hljs-string">"stream"</span>: <span class="hljs-literal">True</span>  
        }  
        <span class="hljs-keyword">with</span> requests.post(self.ollama_host, json=data, stream=<span class="hljs-literal">True</span>) <span class="hljs-keyword">as</span> response:  
            <span class="hljs-comment"># 处理流式响应  </span>
            <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> response.iter_lines():  
                <span class="hljs-keyword">if</span> line:  
                    decoded_line = line.decode(<span class="hljs-string">'utf-8'</span>)  
                    <span class="hljs-keyword">try</span>:  
                        <span class="hljs-comment"># 解析JSON数据  </span>
                        chunk = json.loads(decoded_line)  
                        <span class="hljs-built_in">str</span> += chunk[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>]  
                        <span class="hljs-comment"># 打印消息内容  </span>
                        <span class="hljs-built_in">print</span>(chunk[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>], end=<span class="hljs-string">''</span>, flush=<span class="hljs-literal">True</span>)  
                    <span class="hljs-keyword">except</span> json.JSONDecodeError:  
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"无法解析JSON: <span class="hljs-subst">{decoded_line}</span>"</span>)  
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>
</code></pre>
<h4 data-id="heading-10">2.4.3. 数据查询服务(Query API)</h4>
<p>本服务主要是根据输入SQL连接数据库进行实际查询，智能体利用大模型服务生成SQL后，还需要调用此服务查询数据，具体开发实现如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pymysql  
<span class="hljs-keyword">import</span> requests  
<span class="hljs-keyword">import</span> json  
<span class="hljs-keyword">import</span> decimal  
<span class="hljs-keyword">from</span> elasticsearch <span class="hljs-keyword">import</span> Elasticsearch  
  
<span class="hljs-comment"># Query API  </span>
classQueryService:  
    def__init__(self):  
        self.host = <span class="hljs-string">"127.0.0.1"</span>  
        self.username = <span class="hljs-string">"root"</span>  
        self.password = <span class="hljs-string">"XXXXX"</span>  
        self.database = <span class="hljs-string">"chaiys"</span>  
      
    defquery(self, sql):  
        <span class="hljs-keyword">global</span> conn  
        <span class="hljs-keyword">try</span>:  
            <span class="hljs-comment"># 连接MySQL获取表结构  </span>
            conn = pymysql.connect(host=self.host, port=<span class="hljs-number">3306</span>, user=self.username, password=self.password, database=self.database)  
            cursor = conn.cursor()  
            cursor.execute(sql)  
              
            <span class="hljs-comment"># 返回字段列表  </span>
            <span class="hljs-keyword">return</span> cursor.fetchall()  
        <span class="hljs-keyword">finally</span>:  
            conn.close()  
  
    defquery_with_column(self, sql):  
        <span class="hljs-keyword">global</span> conn  
        <span class="hljs-keyword">try</span>:  
            <span class="hljs-comment"># 连接MySQL获取表结构  </span>
            conn = pymysql.connect(  
                host=self.host,   
                user=self.username,   
                password=self.password,   
                database=self.database  
            )  
            cursor = conn.cursor()  
            cursor.execute(sql)  
              
            <span class="hljs-comment"># 获取字段名称  </span>
            columns = [col[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> cursor.description]  
            <span class="hljs-comment"># 获取数据  </span>
            data = cursor.fetchall()  
              
            <span class="hljs-comment"># 将数据转换为字典列表格式  </span>
            <span class="hljs-comment"># 将数据转换为字典列表格式  </span>
            result = []  
            <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> data:  
                <span class="hljs-comment"># 处理每个字段的值  </span>
                processed_row = []  
                <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> row:  
                    ifisinstance(value, decimal.Decimal):  
                        <span class="hljs-comment"># 转换为 float 或 str  </span>
                        processed_row.append(<span class="hljs-built_in">float</span>(value))  <span class="hljs-comment"># 或 str(value)  </span>
                    <span class="hljs-keyword">else</span>:  
                        processed_row.append(value)  
                result.append(<span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(columns, processed_row)))  
                  
            <span class="hljs-keyword">return</span> result  
        <span class="hljs-keyword">finally</span>:  
            conn.close()
</code></pre>
<h3 data-id="heading-11">2.5. 测试结果</h3>
<p>我们设计一些简单的相关问题，进行提问测试：</p>
<p>问题1：2016年的考生人数有多少？</p>
<p>运行python agent_service.py chat '2016年的考生人数有多少？'，主要输出结果如下：</p>
<pre><code class="hljs language-text" lang="text">######### 第一步：元数据RAG检索结果 ##########  
[{'table_info': '{"表名": "college_entrance_examination", "表备注": "考生人数与复读人数信息表，包含字段：高考年份(主键)、考生人数(万人)、复读人数(万人)，考生人数是指参加高考的学生的数量，复读人数是指参加高考的复读学生的数量", "字段列表": [{"字段名": ...省略若干字段信息...}]}']}]  
  
########## 第二步：大模型调用NL2SQL ##########  
########## 提示词 ##########  
    你是一个MySQL专家。根据以下表结构信息：  
    ['{"表名": "college_entrance_examination", "表备注": "考生人数与复读人数信息表，包含字段：...省略...}]}']  
      
    用户查询："'2016年的考生人数有多少？'"  
      
    生成标准MYSQL查询语句。  
    要求：  
    1. 只输出MYSQL语句，不要额外解释  
    2. 根据语义和字段类型，使用COUNT/SUM/AVG等聚合函数进行计算，非必须  
    3. 给生成的字段取一个简短的中文名称  
    输出格式：使用[]包含sql文本即可，不需要其他输出，便于解析，例如:[select 1from dual]  
########## 结果 ##########  
&lt;think&gt;  
好，我来想想怎么解决这个问题。用户的问题是：“2016年的考生人数有多少？”首先，我需要理解问题中的关键词和要求。  
  
表名是college_entrance_examination，里面有关于高考的数据。字段有三个：examination_year（高考年份），candidates_count（考生人数，单位是万人），retake_count（复读人数，也是万人）。主键是examination_year，所以每个年份只有一条记录。  
  
用户问的是2016年的考生人数，也就是要查询candidates_count这一字段。因为这是一个具体的数值，并不需要聚合函数计算，直接查就可以了。  
  
所以，我需要写一个SELECT语句，从这个表中选取candidates_count，条件是examination_year等于2016年。同时，给结果的字段取个简短的名字，比如“考生人数”。  
  
检查一下数据类型，candidates_count是decimal(10,2)，所以不需要处理，直接显示就可以了。  
  
最后，拼装SQL语句就是：SELECT candidates_count AS 考生人数 FROM college_entrance_examination WHERE examination_year = 2016;  
  
这样就能准确地返回用户需要的信息了。  
&lt;/think&gt;  
  
[select candidates_count as 考生人数 from college_entrance_examination where examination_year=2016]执行SQL：select candidates_count as 考生人数 from college_entrance_examination where examination_year=2016  
  
########## 第三步：查询数据结果 ##########  
[{'考生人数': 940.0}]  
  
########## 第四步：数据分析 ##########  
########## 提示词 ##########  
        根据以下表结构信息：  
        ['{"表名": "college_entrance_examination", "表备注": "考生人数与复读人数信息表，包含字段：高考... 省略若干字段信息... "}]}']  
        查询SQL：  
        select candidates_count as 考生人数 from college_entrance_examination where examination_year=2016  
        和以下数据信息：  
        [{'考生人数': 940.0}]  
          
        用户查询："'2016年的考生人数有多少？'"  
          
        生成一段简要分析，加上一些预测总结的内容  
########## 结果 ##########  
&lt;think&gt;  
好的，我现在需要帮用户生成一个关于2016年高考考生人数的分析和预测。首先，我得仔细理解用户提供的信息。  
  
用户给出了表结构，里面包括了高考年份、考生人数和复读人数。查询语句是选中2016年的考生人数，结果得到940.0万人。那用户的问题就是问“2016年的考生人数有多少？”  
  
接下来，我需要分析这个数据。首先，...省略...  
  
然后，思考为什么用户会问这个问题...省略...政策影响等。  
  
接下来是预测部分。我需要基于2016年的数据进行合理的...省略...趋势。  
  
还要考虑可能的因素，比如...省略...  
  
最后，要总结一下。2016年的数据是...省略...  
&lt;/think&gt;  
  
### 数据分析与预测总结  
  
1. **数据分析**：  
   - 2016 年高考考生人数为 940 万人，这一数据反映了当年参加高考的学生总数。  
   - 高考考生人数的变化受多种因素影响，例如人口结构、教育政策调整以及复读人数的变化等。  
  
2. **预测总结**：  
   - 根据近年来高考报名人数的趋势，预计未来几年高考考生人数可能会继续保持增长趋势。这主要是由于适龄人口数量的增加以及教育资源普及率的提高。  
   - 复读人数也可能对总考生人数产生一定影响。如果复读人数逐年减少，可能会影响高考考生人数的增长速度。  
  
综上所述，2016 年高考考生人数为 940 万人，这一数据为我们了解当年高考的基本情况提供了重要参考。未来，高考考生人数可能会继续增长，但增速可能会趋于平稳。
</code></pre>
<p>可以看到，语义混合检索返回的一个表结构命中元数据考生人数信息表，正常生成SQL，并查询到考生人数，最后调用大模型简单分析返回。</p>
<p>问题2：2016年的录取人数有多少？</p>
<p>运行python agent_service.py chat '2016年的录取人数有多少？'，主要输出结果如下：</p>
<pre><code class="hljs language-text" lang="text">########## 第一步：元数据RAG检索结果 ##########
[{'table_info': '{"表名":"college_entrance_admission","表备注":"录取人数与普通高校数信息表，包含字段：录取年份(主键)、录取人数(万人)、普通高中招生高校数、本科录取人数(万人)、专科录取人数(万人)，录取人数是指录取或者招收、招录的学生的数量"...省略若干字

为了减少文字，表结构信息这里省略了，用户这个问题通过语义检索到的表（college_entrance_admission），和前面一个问题检索到的表（college_entrance_examination）不同，

########## 第二步：大模型调用NL2SQL ##########
########## 提示词 ##########
    你是一个MySQL专家。根据以下表结构信息：...省略若干字prompt和think过程
   
[select admission_count as 录取人数 from college_entrance_admission where admission_year=2016]执行SQL：select admission_count as 录取人数 from college_entrance_admission where admission_year=2016

########## 第三步：查询数据结果 ##########
[{'录取人数': 772.0}]

########## 第四步：数据分析 ##########
########## 提示词 ##########
    根据以下表结构信息：...省略若干字Prompt和think过程

2016年高考的录取人数为772.0万人。这一数据反映了当年全国范围内普通高校招生的整体情况。

**分析：**
- 从历史趋势来看，...省略若干字
- 录取人数的变化还可能...省略若干字

**预测总结：**
- 预计未来几年高考录取人数可能...省略若干字
</code></pre>
<p>可以看到，语义混合检索返回的一个表结构命中元数据录取人数信息表，正常生成SQL，并查询到录取人数的信息，最后调用大模型简单分析数据返回。</p>
<p>本文说明：本文因为太长所以分成三篇文章，这是第一篇，还有两篇分别描述基于LangChain 框架和QwenAgent框架的实践过程。</p>
<p>本文作者：Chaiys</p>
<p>本文原载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FT1FxAIlraY6mRPjOQ54raA" target="_blank" title="https://mp.weixin.qq.com/s/T1FxAIlraY6mRPjOQ54raA" ref="nofollow noopener noreferrer">公众号“木昆子记录AI”</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我司最近在招聘：AI提示词工程师AI Prompt Engineer，有意者来]]></title>    <link>https://juejin.cn/post/7591670569910222894</link>    <guid>https://juejin.cn/post/7591670569910222894</guid>    <pubDate>2026-01-05T07:36:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591670569910222894" data-draft-id="7591403124327301183" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我司最近在招聘：AI提示词工程师AI Prompt Engineer，有意者来"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-05T07:36:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="龙在天"/> <meta itemprop="url" content="https://juejin.cn/user/3760787883819464"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我司最近在招聘：AI提示词工程师AI Prompt Engineer，有意者来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3760787883819464/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    龙在天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T07:36:21.000Z" title="Mon Jan 05 2026 07:36:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是AI提示词工程师</h2>
<p>更好地帮人类与AI互动。依托AI大模型创作内容的工具来说，都离不开专业的AI提示词工程师。</p>
<p>科技进步 最直观 的 新工作岗位。</p>
<p>从名字上看，<code>提示词工程</code>。但是会更偏向 "杂家"。<br/>
懂<code>文学</code>、<code>计算机科学</code>、<code>数学</code>。还要有丰富的想象力，否则制作出来的内容会千篇一律。</p>
<p>大语言模型（LLM：Language Model）。关注提示词开发和优化，帮助用户将大语言模型，用于各场景和研究领域。</p>
<hr/>
<h2 data-id="heading-1">岗位重要性</h2>
<p>提升工程来<code>提升大语言模型</code>处理复杂任务场景的能力：<code>问答</code>和<code>算术推理</code>能力。可通过<code>提示工程设计</code>、研发强大的<code>工程技术</code>、实现和<code>大语言模型</code>和<code>其他生态工具</code>的高效接轨。</p>
<p>提示工程不仅仅是关于<code>设计</code>和<code>研发</code>提示词。<br/>
包含了与<code>大语言模型交互和研发</code>的各种技能和技术。</p>
<p>提示词<code>万能公式</code>:</p>
<pre><code class="hljs">角色（告诉AI工具需要完成什么工作）+
任务（在提示词中清楚地指明你希望生成的文本的目标或任务，如描述、解释、比较、总结等）+
要求（限定范围或主题、指定格式或结构、确定语气或风格、指定关键信息或要素）+
细节（个性化的风格、不同的口吻、不同的视角等）
</code></pre>
<p>基本逻辑：告诉AI<br/>
你是谁？<br/>
要做什么？<br/>
怎么做？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31deef0c913a4895b85f7de8f59ffdfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768203380&amp;x-signature=yOSBmOuRboTtwiV7%2BoVIgsofbbY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f24fe51b77794b85a72a6056cc89b81a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768203380&amp;x-signature=ClgosQa%2FfdRPS67ZVgZtyp84mSw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8e1406f77d345cd818235f797179dfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768203380&amp;x-signature=Z5p9VbZ9obplZkmQBbWJbD0fwW0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">学习路线</h2>
<h3 data-id="heading-3">成长路线图 &amp; 学习规划</h3>
<h4 data-id="heading-4">L1级别</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/193bfb5ceb6a4404b6d0e987497497a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768203380&amp;x-signature=76ZQZm9GnKjNVMUrGuj4HZvnsw4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">L2级别</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a41961b827b4a448e568cc7a8a17933~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768203380&amp;x-signature=fg1YR%2BQnyb8DKUqt3OFzL2NV9Ro%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">L3级别</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c4f4fac805941d5a7e728c6ce561e4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768203380&amp;x-signature=Fz65dZASYvSLja5tQvd8ZGb1DGU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">L4级别</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b47cbb21ab7e4cdaa8bcca3d98d4579d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768203380&amp;x-signature=6Jnmmu%2FJfoHcUe3q6W9uxuFpSPw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">书籍推荐</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18a12883ec7b40afbeefb50c28c93694~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z5Zyo5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768203380&amp;x-signature=yQfFSfMokDIbqidCcxftTESEOvA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">模型设置</h2>
<p>通过<code>API</code>或直接与大语言模型进行交互，用<code>提示词</code>。通过<code>配置一些参数</code>以获得不同的提示结果。<br/>
调整这些设置对于提高响应的可靠性。需要进行一些实验才能找出<code>适合的用例</code>的<code>正确设置</code>。</p>
<h3 data-id="heading-10">不同的LLM提供程序时会遇到的常见设置：</h3>
<h4 data-id="heading-11"><code>Temperature</code></h4>
<p><code>temperature</code>的参数值越小，模型就会返回越确定的一个结果。<br/>
如果调高该参数值，大语言模型可能会返回更随机的结果，也就是说这可能会带来更多样化或更具创造性的产出。<br/>
（调小<code>temperature</code>）实质上，你是在增加其他可能的<code>token</code>的权重。<br/>
在实际应用方面，对于质量保障（QA）等任务，我们可以设置更低的<code>temperature</code>值，以促使模型基于事实返回更真实和简洁的结果。<br/>
对于诗歌生成或其他创造性任务，适度地调高<code>temperature</code>参数值可能会更好。</p>
<h4 data-id="heading-12">Top_p</h4>
<p>使用<code>top_p</code>（与<code>temperature</code>一起称为核采样的技术），可以用来控制模型返回结果的确定性。要准确的或者事实的答案，就把参数值调低。<br/>
找更多样化的响应，将其值调高点。</p>
<p>用<code>Top P</code>意味着 <code>tokens</code> 中 包含 <code>top_p</code>概率质量 才会被考虑用于响应，较低的<code>top_p</code>值会选择最有信心的响应。这意味着较高的<code>top_p</code>值将使模型考虑更多可能的词语，包括不太可能的词语，从而导致更多样的输出。</p>
<p>一般，改 <code>Temperature</code>或者<code>Top P</code>其中一个参数就行，不用两个都改。</p>
<h4 data-id="heading-13">Max Length</h4>
<p>可以通过调整<code>max length</code>来控制大模型生成的<code>token</code>数。指定<code>Max Length</code>有助于防止大模型生成冗长或不相关的响应并控制成本。</p>
<h4 data-id="heading-14">Stop Sequences</h4>
<p><code>stop sequence</code>是一个字符串，可以阻止模型生成<code>token</code>，指定<code>stop sequences</code>是控制大模型响应长度和结构的另一种方法。例如，您可以通过添加“11”作为<code>stop sequence</code>去告诉模型生成不超过<code>10</code>个项的列表。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂 useRef：它到底在“存”什么？]]></title>    <link>https://juejin.cn/post/7591687981686997038</link>    <guid>https://juejin.cn/post/7591687981686997038</guid>    <pubDate>2026-01-05T07:39:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591687981686997038" data-draft-id="7589907831199432730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂 useRef：它到底在“存”什么？"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-05T07:39:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟袅破辰"/> <meta itemprop="url" content="https://juejin.cn/user/1845419006243504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂 useRef：它到底在“存”什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1845419006243504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟袅破辰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T07:39:20.000Z" title="Mon Jan 05 2026 07:39:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React 中，<code>useRef</code> 是一个看似简单却非常强大的 Hook。很多初学者会把它和 <code>useState</code> 混为一谈，认为它们都是“存储数据”的工具。但事实并非如此。</p>
<p>今天我们就通过两个实际例子，深入剖析 <code>useRef</code> 的真正作用：它不是一个状态容器，而是一个“跨渲染周期的引用容器”。</p>
<hr/>
<h2 data-id="heading-0">一、useRef 到底是用来干什么的？</h2>
<p>我们先看一段代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    inputRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">focus</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;
        count++
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前值: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p>这段代码中，<code>inputRef</code> 被用来获取 <code>&lt;input&gt;</code> 元素的 DOM 引用，并在组件挂载后自动聚焦。</p>
<p>这里的关键是：<br/>
<code>inputRef.current</code> 在组件重新渲染时不会被重置。即使 <code>count</code> 改变导致组件重新渲染，<code>inputRef</code> 依然指向同一个 DOM 节点。</p>
<p>这正是 <code>useRef</code> 的核心能力：持久化引用，不随渲染而销毁。</p>
<hr/>
<h2 data-id="heading-1">二、useRef 和 useState 的本质区别</h2>
<p>很多人会问：“既然都能存东西，为什么不直接用 useState？”</p>
<p>我们来对比一下：</p>






























<table><thead><tr><th>特性</th><th>useState</th><th>useRef</th></tr></thead><tbody><tr><td>是否触发重渲染</td><td>是</td><td>否</td></tr><tr><td>是否响应式</td><td>是</td><td>否</td></tr><tr><td>存储内容类型</td><td>状态数据（如用户输入、计数）</td><td>任意值（DOM、定时器、函数等）</td></tr><tr><td>使用场景</td><td>需要 UI 更新的数据</td><td>不需要 UI 更新的临时或持久引用</td></tr></tbody></table>
<p>示例 1：用 useRef 存储定时器 ID</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> intervalId = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    intervalId.<span class="hljs-property">current</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'tick~~'</span>);
    }, <span class="hljs-number">1000</span>);
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearInterval</span>(intervalId.<span class="hljs-property">current</span>);
  }

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前 intervalId:'</span>, intervalId.<span class="hljs-property">current</span>);
  }, [count]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{start}</span>&gt;</span>开始<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{stop}</span>&gt;</span>停止<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p>在这个例子中：</p>
<ul>
<li><code>intervalId.current</code> 保存了 <code>setInterval</code> 返回的 ID。</li>
<li>即使组件因为 <code>count</code> 变化而重新渲染，<code>intervalId.current</code> 仍然保留着原来的值。</li>
<li>因此 <code>stop()</code> 函数可以正确清除定时器。</li>
</ul>
<p>如果你改用 <code>useState</code> 来存这个 ID，每次更新都会触发重渲染，造成不必要的性能损耗。</p>
<hr/>
<h2 data-id="heading-2">三、如果不使用 useRef 会发生什么？</h2>
<p>我们来看一个错误版本：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> intervalId = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'tick~~'</span>);
    }, <span class="hljs-number">1000</span>);
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearInterval</span>(intervalId);
  }

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前 intervalId:'</span>, intervalId);
  }, [count]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{start}</span>&gt;</span>开始<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{stop}</span>&gt;</span>停止<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p>问题分析：</p>
<ol>
<li>点击「开始」→ 创建定时器，<code>intervalId</code> 被赋值为某个 ID（比如 12345）。</li>
<li>点击「+1」→ 组件重新渲染 → <code>let intervalId = null;</code> 执行 → <code>intervalId</code> 变成 <code>null</code>。</li>
<li>再点击「停止」→ <code>clearInterval(null)</code> → 无效！</li>
<li>定时器仍在运行，无法清除 → 内存泄漏！</li>
</ol>
<p>这就是为什么不能用普通变量或 <code>useState</code> 来存储非状态数据。</p>
<hr/>
<h2 data-id="heading-3">四、useRef 的三大典型应用场景</h2>
<ol>
<li>获取 DOM 节点引用</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">inputRef</span> = useRef(null)<span class="hljs-comment">;</span>
&lt;input <span class="hljs-attr">ref</span>={inputRef} /&gt;
</code></pre>
<p>用于操作 DOM，比如聚焦、滚动、获取值等。</p>
<ol start="2">
<li>存储可变对象（如定时器、WebSocket）</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">timerRef</span> = useRef()<span class="hljs-comment">;</span>
<span class="hljs-attr">timerRef.current</span> = setInterval(() =&gt; {}, <span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>避免重复创建，确保能正确清理。</p>
<ol start="3">
<li>创建“持久化”的引用对象</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">prevValueRef</span> = useRef()<span class="hljs-comment">;</span>

function handleChange(value) {
  console.log('上一次的值:', prevValueRef.current)<span class="hljs-comment">;</span>
  <span class="hljs-attr">prevValueRef.current</span> = value<span class="hljs-comment">;</span>
}
</code></pre>
<p>在闭包中保持对旧值的访问。</p>
<hr/>
<h2 data-id="heading-4">五、总结：useRef 是什么？</h2>
<p><code>useRef</code> 并不是“状态”，而是 一个跨渲染周期的引用容器。</p>
<p>你可以把它想象成一个“保险箱”：</p>
<ul>
<li>组件反复重建，但保险箱一直存在；</li>
<li>你可以往里面放任何东西（DOM、ID、对象、函数）；</li>
<li>它不会触发重渲染，也不会影响 UI；</li>
<li>但它能帮你记住那些“不该被遗忘”的东西。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么"计算机网络"需要分层设计？——从物理层到应用层]]></title>    <link>https://juejin.cn/post/7591456613535121408</link>    <guid>https://juejin.cn/post/7591456613535121408</guid>    <pubDate>2026-01-05T07:45:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591456613535121408" data-draft-id="7591456613535105024" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么&quot;计算机网络&quot;需要分层设计？——从物理层到应用层"/> <meta itemprop="keywords" content="后端,面试,程序员"/> <meta itemprop="datePublished" content="2026-01-05T07:45:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么"计算机网络"需要分层设计？——从物理层到应用层
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T07:45:38.000Z" title="Mon Jan 05 2026 07:45:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🔗 为什么"计算机网络"需要分层设计？——从物理层到应用层 🌐</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>想象一下：你在电脑上输入 <code>www.baidu.com</code>，几秒钟后就看到了百度首页——这个简单的操作背后，其实是<strong>几百个网络设备</strong>在协同工作！而支撑这些设备高效协作的，正是计算机网络的"分层设计"。</p>
<h3 data-id="heading-1">🤔 核心问题：网络分层的好处是什么？OSI 七层模型和 TCP/IP 四层模型有何区别？</h3>
<p>很多人觉得"网络分层"是个复杂的技术概念，其实它的本质很简单：<strong>把复杂的网络通信问题拆分成多个简单的小问题，每个层次负责解决一个特定的问题</strong>。</p>
<h4 data-id="heading-2">网络分层的"魔法"在哪里？</h4>
<ul>
<li>🧩 <strong>简化问题</strong>：把复杂的网络通信拆分成多个简单的层次</li>
<li>🔄 <strong>标准化</strong>：每个层次有明确的标准，不同厂商的设备可以互相通信</li>
<li>📦 <strong>模块化</strong>：每个层次可以独立发展，不用影响其他层次</li>
<li>🔧 <strong>易于维护</strong>：出现问题时，只需要排查对应的层次</li>
<li>🚀 <strong>提高效率</strong>：不同层次可以并行工作</li>
</ul>
<h3 data-id="heading-3">📜 从"混乱"到"有序"：网络分层的进化史</h3>
<h4 data-id="heading-4">1. 🌪️ 早期网络："一团糟"</h4>
<p>在计算机网络的早期，每个公司都有自己的网络协议，就像"每个国家都有自己的语言"：</p>
<ul>
<li><strong>IBM</strong>：使用 SNA 协议</li>
<li><strong>DEC</strong>：使用 DECnet 协议</li>
<li><strong>Apple</strong>：使用 AppleTalk 协议</li>
</ul>
<p><strong>结果</strong>：不同公司的网络设备无法互相通信，形成了一个个"网络孤岛"。</p>
<h4 data-id="heading-5">2. 📋 OSI 七层模型："完美的理论模型"</h4>
<p>1977年，国际标准化组织（ISO）提出了<strong>OSI七层模型</strong>，这是一个"完美的理论模型"，它将网络通信分为7个层次：</p>













































<table><thead><tr><th>层次</th><th>名称</th><th>主要功能</th></tr></thead><tbody><tr><td>7</td><td>应用层</td><td>为用户应用程序提供网络服务</td></tr><tr><td>6</td><td>表示层</td><td>数据格式转换、加密解密</td></tr><tr><td>5</td><td>会话层</td><td>建立、维护和管理会话</td></tr><tr><td>4</td><td>传输层</td><td>端到端的可靠传输</td></tr><tr><td>3</td><td>网络层</td><td>路由选择、IP地址</td></tr><tr><td>2</td><td>数据链路层</td><td>帧的封装与解封装、MAC地址</td></tr><tr><td>1</td><td>物理层</td><td>物理介质、比特流传输</td></tr></tbody></table>
<p><strong>理想很丰满，现实很骨感</strong>：</p>
<ul>
<li>OSI模型太复杂，实现成本高</li>
<li>标准制定过程太慢，跟不上技术发展</li>
<li>厂商们更愿意采用已有的TCP/IP协议</li>
</ul>
<h4 data-id="heading-6">3. 🚀 TCP/IP 四层模型："实用为王"</h4>
<p>在OSI模型提出的同时，美国国防部高级研究计划局（DARPA）正在开发<strong>TCP/IP协议栈</strong>，这是一个"实用主义"的设计：</p>






























<table><thead><tr><th>层次</th><th>名称</th><th>主要协议</th></tr></thead><tbody><tr><td>4</td><td>应用层</td><td>HTTP、FTP、SMTP、DNS</td></tr><tr><td>3</td><td>传输层</td><td>TCP、UDP</td></tr><tr><td>2</td><td>网络层</td><td>IP、ICMP、ARP</td></tr><tr><td>1</td><td>网络接口层</td><td>以太网、Wi-Fi、PPP</td></tr></tbody></table>
<p><strong>TCP/IP协议的优势</strong>：</p>
<ul>
<li>简单实用，易于实现</li>
<li>已经在ARPANET（互联网的前身）上得到验证</li>
<li>开放性好，免费使用</li>
<li>支持多种网络类型</li>
</ul>
<h4 data-id="heading-7">4. 🌐 现代网络："TCP/IP协议的天下"</h4>
<p>到了20世纪90年代，TCP/IP协议已经成为<strong>互联网的标准协议</strong>，几乎所有的网络设备都支持TCP/IP协议。</p>
<p>现在，当我们提到"网络分层"时，通常指的是<strong>TCP/IP四层模型</strong>，或者是结合了OSI七层模型优点的"TCP/IP五层模型"：</p>



































<table><thead><tr><th>五层模型</th><th>对应OSI层次</th><th>对应TCP/IP层次</th></tr></thead><tbody><tr><td>应用层</td><td>应用层、表示层、会话层</td><td>应用层</td></tr><tr><td>传输层</td><td>传输层</td><td>传输层</td></tr><tr><td>网络层</td><td>网络层</td><td>网络层</td></tr><tr><td>数据链路层</td><td>数据链路层</td><td>网络接口层</td></tr><tr><td>物理层</td><td>物理层</td><td>网络接口层</td></tr></tbody></table>
<h3 data-id="heading-8">🔧 技术原理：网络分层的"秘密武器"</h3>
<h4 data-id="heading-9">1. 📡 物理层："比特流的搬运工"</h4>
<p><strong>核心功能</strong>：负责在物理介质上传输原始的比特流（0和1）。</p>
<p><strong>物理层的"工具"</strong>：</p>
<ul>
<li>📱 物理介质：双绞线、光纤、无线电磁波</li>
<li>🛠️ 物理设备：网卡、交换机、路由器的物理接口</li>
<li>⚡ 传输技术：调制解调、编码解码、同步传输</li>
</ul>
<p><strong>举个例子</strong>：当你用网线连接电脑和路由器时，物理层负责把电脑发送的二进制数据转换成电信号，通过网线传输到路由器。</p>
<h4 data-id="heading-10">2. 🔗 数据链路层："帧的组装工"</h4>
<p><strong>核心功能</strong>：负责将网络层的数据包封装成"帧"，并在相邻节点之间传输。</p>
<p><strong>数据链路层的"工具"</strong>：</p>
<ul>
<li>📦 帧格式：以太网帧、PPP帧</li>
<li>🔍 MAC地址：每个网络设备的唯一标识符（比如 <code>00:11:22:33:44:55</code>）</li>
<li>🛡️ 差错控制：CRC校验</li>
<li>🔄 流量控制：防止发送方发送过快</li>
</ul>
<p><strong>举个例子</strong>：当电脑要发送数据时，数据链路层会给网络层的IP数据包加上"帧头"和"帧尾"，形成一个完整的"以太网帧"，然后通过物理层发送出去。</p>
<h4 data-id="heading-11">3. 🌍 网络层："数据包的导航员"</h4>
<p><strong>核心功能</strong>：负责将数据包从源主机发送到目标主机，主要解决"如何选择最佳路径"的问题。</p>
<p><strong>网络层的"工具"</strong>：</p>
<ul>
<li>🌐 IP地址：互联网上每个主机的唯一标识符（比如 <code>192.168.1.1</code>）</li>
<li>🗺️ 路由协议：RIP、OSPF、BGP</li>
<li>📡 ICMP协议：网络控制消息协议（比如 ping 命令）</li>
<li>🔄 ARP协议：地址解析协议（将IP地址转换为MAC地址）</li>
</ul>
<p><strong>举个例子</strong>：当你访问 <code>www.baidu.com</code> 时，网络层会负责找到从你的电脑到百度服务器的最佳路径，可能要经过多个路由器。</p>
<h4 data-id="heading-12">4. 🚚 传输层："端到端的可靠传输"</h4>
<p><strong>核心功能</strong>：负责在源主机和目标主机之间建立可靠的"端到端"连接，确保数据能够完整、有序地传输。</p>
<p><strong>传输层的"两大法宝"</strong>：</p>
<ul>
<li><strong>TCP协议</strong>：可靠的、面向连接的协议，适合传输重要数据（比如网页、邮件）</li>
<li><strong>UDP协议</strong>：不可靠的、无连接的协议，适合传输实时数据（比如视频、音频）</li>
</ul>
<p><strong>TCP协议的"可靠机制"</strong>：</p>
<ul>
<li>🔗 三次握手：建立可靠连接</li>
<li>📦 数据分段：将大数据分成多个小数据段</li>
<li>✅ 确认机制：收到数据后发送确认</li>
<li>🔄 重传机制：数据丢失后自动重传</li>
<li>⚡ 流量控制：根据接收方的能力调整发送速度</li>
<li>📊 拥塞控制：根据网络状况调整发送速度</li>
</ul>
<h4 data-id="heading-13">5. 🎮 应用层："用户的直接接口"</h4>
<p><strong>核心功能</strong>：为用户应用程序提供网络服务，是用户直接接触的层次。</p>
<p><strong>常见的应用层协议</strong>：</p>
<ul>
<li>🌐 HTTP/HTTPS：万维网服务</li>
<li>📧 SMTP/POP3/IMAP：电子邮件服务</li>
<li>📁 FTP/SFTP：文件传输服务</li>
<li>📱 DNS：域名解析服务</li>
<li>💬 SSH/Telnet：远程登录服务</li>
</ul>
<p><strong>举个例子</strong>：当你用浏览器访问网页时，浏览器会使用HTTP协议向服务器请求数据，服务器收到请求后，会返回HTML、CSS、JavaScript等文件，浏览器再把这些文件渲染成网页。</p>
<h3 data-id="heading-14">💻 代码实例：用Python实现简单的网络通信</h3>
<h4 data-id="heading-15">1. UDP通信示例</h4>
<p><strong>服务器端</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> socket

<span class="hljs-comment"># 创建UDP套接字</span>
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

<span class="hljs-comment"># 绑定IP和端口</span>
s.bind((<span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-number">8888</span>))

<span class="hljs-built_in">print</span>(<span class="hljs-string">"UDP服务器已启动，等待客户端连接..."</span>)

<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-comment"># 接收数据</span>
    data, addr = s.recvfrom(<span class="hljs-number">1024</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到来自 <span class="hljs-subst">{addr}</span> 的消息：<span class="hljs-subst">{data.decode(<span class="hljs-string">'utf-8'</span>)}</span>"</span>)
  
    <span class="hljs-comment"># 发送数据</span>
    s.sendto(<span class="hljs-string">f"你好，我是UDP服务器，我收到了你的消息：<span class="hljs-subst">{data.decode(<span class="hljs-string">'utf-8'</span>)}</span>"</span>.encode(<span class="hljs-string">'utf-8'</span>), addr)
</code></pre>
<p><strong>客户端</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> socket

<span class="hljs-comment"># 创建UDP套接字</span>
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

<span class="hljs-comment"># 服务器IP和端口</span>
server_addr = (<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">8888</span>)

<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-comment"># 输入消息</span>
    message = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入要发送的消息（输入'quit'退出）："</span>)
  
    <span class="hljs-keyword">if</span> message == <span class="hljs-string">'quit'</span>:
        <span class="hljs-keyword">break</span>
  
    <span class="hljs-comment"># 发送数据</span>
    s.sendto(message.encode(<span class="hljs-string">'utf-8'</span>), server_addr)
  
    <span class="hljs-comment"># 接收数据</span>
    data, addr = s.recvfrom(<span class="hljs-number">1024</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到服务器的消息：<span class="hljs-subst">{data.decode(<span class="hljs-string">'utf-8'</span>)}</span>"</span>)

<span class="hljs-comment"># 关闭套接字</span>
s.close()
</code></pre>
<h4 data-id="heading-16">2. TCP通信示例</h4>
<p><strong>服务器端</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> socket

<span class="hljs-comment"># 创建TCP套接字</span>
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

<span class="hljs-comment"># 绑定IP和端口</span>
s.bind((<span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-number">9999</span>))

<span class="hljs-comment"># 监听连接</span>
s.listen(<span class="hljs-number">5</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"TCP服务器已启动，等待客户端连接..."</span>)

<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-comment"># 接受连接</span>
    client_socket, client_addr = s.accept()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"客户端 <span class="hljs-subst">{client_addr}</span> 已连接"</span>)
  
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-comment"># 接收数据</span>
        data = client_socket.recv(<span class="hljs-number">1024</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
            <span class="hljs-keyword">break</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到来自 <span class="hljs-subst">{client_addr}</span> 的消息：<span class="hljs-subst">{data.decode(<span class="hljs-string">'utf-8'</span>)}</span>"</span>)
      
        <span class="hljs-comment"># 发送数据</span>
        client_socket.send(<span class="hljs-string">f"你好，我是TCP服务器，我收到了你的消息：<span class="hljs-subst">{data.decode(<span class="hljs-string">'utf-8'</span>)}</span>"</span>.encode(<span class="hljs-string">'utf-8'</span>))
  
    <span class="hljs-comment"># 关闭客户端连接</span>
    client_socket.close()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"客户端 <span class="hljs-subst">{client_addr}</span> 已断开连接"</span>)
</code></pre>
<p><strong>客户端</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> socket

<span class="hljs-comment"># 创建TCP套接字</span>
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

<span class="hljs-comment"># 服务器IP和端口</span>
server_addr = (<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">9999</span>)

<span class="hljs-comment"># 连接服务器</span>
s.connect(server_addr)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"已连接到TCP服务器"</span>)

<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-comment"># 输入消息</span>
    message = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入要发送的消息（输入'quit'退出）："</span>)
  
    <span class="hljs-keyword">if</span> message == <span class="hljs-string">'quit'</span>:
        <span class="hljs-keyword">break</span>
  
    <span class="hljs-comment"># 发送数据</span>
    s.send(message.encode(<span class="hljs-string">'utf-8'</span>))
  
    <span class="hljs-comment"># 接收数据</span>
    data = s.recv(<span class="hljs-number">1024</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到服务器的消息：<span class="hljs-subst">{data.decode(<span class="hljs-string">'utf-8'</span>)}</span>"</span>)

<span class="hljs-comment"># 关闭套接字</span>
s.close()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已断开与服务器的连接"</span>)
</code></pre>
<h3 data-id="heading-17">📊 趣味对比：OSI七层模型 vs TCP/IP四层模型</h3>























































<table><thead><tr><th>对比项</th><th>OSI七层模型</th><th>TCP/IP四层模型</th></tr></thead><tbody><tr><td><strong>提出时间</strong></td><td>1977年</td><td>1970年代中期</td></tr><tr><td><strong>提出组织</strong></td><td>国际标准化组织（ISO）</td><td>美国国防部高级研究计划局（DARPA）</td></tr><tr><td><strong>设计理念</strong></td><td>理论优先，完美主义</td><td>实用优先，渐进主义</td></tr><tr><td><strong>层次数量</strong></td><td>7层</td><td>4层</td></tr><tr><td><strong>实现难度</strong></td><td>复杂，实现成本高</td><td>简单，实现成本低</td></tr><tr><td><strong>应用范围</strong></td><td>主要用于教学和理论研究</td><td>广泛应用于实际网络</td></tr><tr><td><strong>灵活性</strong></td><td>不够灵活，修改困难</td><td>灵活，容易扩展</td></tr><tr><td><strong>厂商支持</strong></td><td>有限</td><td>几乎所有厂商都支持</td></tr><tr><td><strong>标准成熟度</strong></td><td>标准完善但过于复杂</td><td>标准实用且不断发展</td></tr></tbody></table>
<h3 data-id="heading-18">🏢 网络分层的应用场景：无处不在的网络分层</h3>








































<table><thead><tr><th>应用场景</th><th>举例</th><th>网络分层的作用</th></tr></thead><tbody><tr><td>🌐 互联网</td><td>全球互联网</td><td>确保不同国家、不同厂商的设备可以互相通信</td></tr><tr><td>🛒 电商平台</td><td>淘宝、京东</td><td>确保订单数据、支付数据的可靠传输</td></tr><tr><td>📱 移动网络</td><td>4G、5G</td><td>确保手机可以随时随地接入互联网</td></tr><tr><td>🖥️ 企业网络</td><td>公司内部网络</td><td>确保公司内部设备的安全通信</td></tr><tr><td>🎮 游戏网络</td><td>王者荣耀、英雄联盟</td><td>确保游戏数据的实时传输</td></tr><tr><td>📺 视频直播</td><td>抖音、快手</td><td>确保视频流的流畅传输</td></tr></tbody></table>
<h3 data-id="heading-19">📈 数据支撑：网络分层的"硬核实力"</h3>
<ul>
<li>🌐 全球每天有超过<strong>50亿设备</strong>连接到互联网</li>
<li>📊 TCP/IP协议占互联网流量的<strong>95%以上</strong></li>
<li>⚡ 全球每天传输的数据量超过<strong>200亿GB</strong></li>
<li>🔄 平均每个网页加载需要<strong>100-200个HTTP请求</strong></li>
<li>📱 全球有超过<strong>60亿</strong>移动互联网用户</li>
</ul>
<h3 data-id="heading-20">⚠️ 常见误区纠正：网络分层不是"银弹"！</h3>
<h4 data-id="heading-21">1. "OSI七层模型是最好的？"</h4>
<p><strong>错！</strong> OSI七层模型是一个"完美的理论模型"，但在实际应用中，TCP/IP四层模型更实用。</p>
<h4 data-id="heading-22">2. "网络分层越多越好？"</h4>
<p><strong>错！</strong> 分层过多会导致效率降低，因为每个层次都需要添加额外的头部信息，增加了数据传输的开销。</p>
<h4 data-id="heading-23">3. "TCP协议比UDP协议好？"</h4>
<p><strong>不一定！</strong> TCP适合传输重要数据（比如网页、邮件），但UDP适合传输实时数据（比如视频、音频），因为UDP的延迟更低。</p>
<h4 data-id="heading-24">4. "IP地址就是MAC地址？"</h4>
<p><strong>错！</strong> IP地址是网络层的地址，用于在互联网上标识主机；MAC地址是数据链路层的地址，用于在局域网内标识设备。</p>
<h4 data-id="heading-25">5. "网络分层只适用于有线网络？"</h4>
<p><strong>错！</strong> 网络分层同样适用于无线网络，比如Wi-Fi网络也采用了OSI七层模型或TCP/IP四层模型。</p>
<h3 data-id="heading-26">🔮 未来展望：网络分层的发展趋势</h3>
<h4 data-id="heading-27">1. 🚀 软件定义网络（SDN）</h4>
<p>SDN将网络的"控制平面"和"数据平面"分离，实现了网络的"软件化"管理：</p>
<ul>
<li>🎮 集中式控制：通过控制器统一管理网络</li>
<li>📝 可编程性：网络可以通过软件进行编程</li>
<li>🚀 灵活性：可以快速调整网络配置</li>
</ul>
<h4 data-id="heading-28">2. 🔒 网络功能虚拟化（NFV）</h4>
<p>NFV将传统的网络设备（比如路由器、防火墙）虚拟化，运行在通用服务器上：</p>
<ul>
<li>💰 降低成本：不需要购买专用硬件</li>
<li>🚀 快速部署：可以快速部署新的网络功能</li>
<li>🔄 弹性扩展：可以根据需求动态扩展网络功能</li>
</ul>
<h4 data-id="heading-29">3. ☁️ 云原生网络</h4>
<p>随着云计算的普及，云原生网络将成为未来的发展方向：</p>
<ul>
<li>🌐 容器网络：Docker、Kubernetes的网络方案</li>
<li>🛡️ 服务网格：Istio、Linkerd等服务网格技术</li>
<li>🚀 Serverless网络：无需管理服务器的网络服务</li>
</ul>
<h4 data-id="heading-30">4. 5G/6G网络</h4>
<p>5G和6G网络将带来更高的速度、更低的延迟和更多的连接数：</p>
<ul>
<li>⚡ 5G速度可达10Gbps，延迟低至1ms</li>
<li>📱 6G速度可达100Gbps，延迟低至0.1ms</li>
<li>🔗 支持大规模物联网设备连接</li>
</ul>
<h3 data-id="heading-31">🎓 互动小测验：你答对了吗？</h3>


















































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>OSI七层模型的最底层是什么？</td><td>物理层</td><td>✅/❌</td></tr><tr><td>TCP/IP四层模型的最高层是什么？</td><td>应用层</td><td>✅/❌</td></tr><tr><td>负责可靠传输的协议是什么？</td><td>TCP</td><td>✅/❌</td></tr><tr><td>负责域名解析的协议是什么？</td><td>DNS</td><td>✅/❌</td></tr><tr><td>IP地址属于哪个层次？</td><td>网络层</td><td>✅/❌</td></tr><tr><td>MAC地址属于哪个层次？</td><td>数据链路层</td><td>✅/❌</td></tr><tr><td>ping命令使用的是什么协议？</td><td>ICMP</td><td>✅/❌</td></tr><tr><td>网页浏览使用的是什么协议？</td><td>HTTP/HTTPS</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-32">🎯 结语：网络分层——计算机网络的"骨架"</h3>
<p>计算机网络的分层设计，就像<strong>建筑物的骨架</strong>，它为整个网络提供了"结构支撑"，让复杂的网络通信变得"有序"和"高效"。</p>
<p><strong>记住</strong>：网络分层的核心思想是"分而治之"——把复杂的问题拆分成多个简单的小问题，每个层次负责解决一个特定的问题。</p>
<p>下次当你使用电脑上网、用手机刷短视频、用平板看电影时，不妨想想背后的网络分层设计——正是这些看不见的"层次"，让我们的数字生活变得更加便捷和丰富！</p>
<h3 data-id="heading-33">💬 互动话题</h3>
<ol>
<li>你知道你家的网络是如何连接到互联网的吗？</li>
<li>你觉得未来的网络会是什么样子？</li>
<li>你遇到过最奇葩的网络问题是什么？最后是怎么解决的？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次 Druid 慢查询超时问题的源码排查]]></title>    <link>https://juejin.cn/post/7591687981687062574</link>    <guid>https://juejin.cn/post/7591687981687062574</guid>    <pubDate>2026-01-05T07:45:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591687981687062574" data-draft-id="7591670569909960750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次 Druid 慢查询超时问题的源码排查"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-05T07:45:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="橙熟"/> <meta itemprop="url" content="https://juejin.cn/user/993614243042766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次 Druid 慢查询超时问题的源码排查
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614243042766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    橙熟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T07:45:33.000Z" title="Mon Jan 05 2026 07:45:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">现象</h2>
<p>生产环境遇到以下报错：</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">Error</span> querying database.  Cause: com.mysql.cj.jdbc.exceptions.CommunicationsException: Communications link failure
The last packet successfully received from the <span class="hljs-built_in">server</span> was <span class="hljs-number">18</span>,<span class="hljs-number">860</span> milliseconds ago. 
The last packet sent successfully <span class="hljs-keyword">to</span> the <span class="hljs-built_in">server</span> was <span class="hljs-number">18</span>,<span class="hljs-number">868</span> milliseconds ago.
</code></pre>
<blockquote>
<p>询问 AI 后，得到的分析是"链接长时间未使用，被回收了"。</p>
</blockquote>
<h2 data-id="heading-1">复现</h2>
<p>根据报错信息，猜测可能是超过 10 秒的慢 SQL 就会报错。
为了验证，准备了一个测试接口，只执行一个耗时 30 秒的查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> SLEEP(<span class="hljs-number">30</span>)
</code></pre>
<blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ede18873c3f94ec5b195c6bf2f2311c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ54af:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768204770&amp;x-signature=C7VUpsSSIYDw1O1dFcEM8mnhaAk%3D" alt="image.png" loading="lazy"/>
<strong>测试结果：</strong> 每次执行到 10 秒左右，果然报错，复现成功！</p>
</blockquote>
<h2 data-id="heading-2">初步解决</h2>
<p>咨询 AI 后，尝试通过设置 <code>socketTimeout</code> 来解决。在 JDBC 连接串中增加 <code>socketTimeout=60000</code>（60 秒）配置后，问题确实消失了。
但问题是：<strong>为什么？</strong> 追问 AI 具体原因，得到的回答却含糊不清，解释不清根本原因。于是决定自己翻源码。</p>
<h2 data-id="heading-3">深入源码</h2>
<p>首先查看 Druid 源码中的 <code>socketTimeout</code> 配置，发现默认值是 0，理论上应该没有超时限制：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> socketTimeout; <span class="hljs-comment">// milliSeconds</span>
</code></pre>
<p>于是猜测是在启动时通过 <code>setSocketTimeout</code> 进行了赋值。在所有调用处打断点 debug 启动，发现并没有走进这些设置方法。
然而，进入 <code>com.alibaba.druid.pool.DruidAbstractDataSource#createPhysicalConnection()</code> 创建连接时，发现 <code>socketTimeout</code> 的值已经是 <code>10000</code>（10秒）了！</p>
<blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f115af41f94944d0b827dbce11b9d66f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ54af:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768204770&amp;x-signature=Jcr3lOp6vRfk6Ccjctr1dRNrv3c%3D" alt="image.png" loading="lazy"/>
既然不是运行时赋值的，那只能是<strong>类加载时成员变量的默认值</strong>了。</p>
</blockquote>
<p>终于，在 <code>com.alibaba.druid.pool.DruidDataSource.java</code> 的 <code>init()</code> 方法中，找到了以下代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (socketTimeout == <span class="hljs-number">0</span>) {
    socketTimeout = DEFAULT_TIME_SOCKET_TIMEOUT_MILLIS;
}
</code></pre>
<blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61de556118614cce9f42b95ca11600e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ54af:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768204770&amp;x-signature=HFJ1QxNlC9hKZM240dB%2FssZcWLk%3D" alt="image.png" loading="lazy"/>
这就是罪魁祸首了，那么Druid是从什么时候开始加入的这个默认配置呢，以及为什么要加呢？</p>
</blockquote>
<h2 data-id="heading-4">版本考古</h2>
<p>是从哪个版本开始有了这个默认 10 秒的配置呢？于是开始了版本追溯。</p>
<h3 data-id="heading-5">1. 从 1.2.20 追溯</h3>
<p>由于我当前使用的是1.2.20，所以从此版本往前对比源码，发现官方源码是从 1.2.15 增加的默认值设置逻辑，于是想当然地认为：<strong>1.2.14 版本应该没有这个限制</strong>。但测试 1.2.14 发现依然会 10 秒超时，debug 到createPhysicalConnection()中发现socketTimeout值仍然是 10 秒。</p>
<h3 data-id="heading-6">2. 从 1.2.14 继续往前追溯</h3>
<p>继续查找，发现 1.2.14的<code>DruidAbstractDataSource</code> 类中，直接在成员变量声明时就设置了默认值：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">socketTimeout</span> <span class="hljs-operator">=</span> DEFAULT_TIME_SOCKET_TIMEOUT_MILLIS; <span class="hljs-comment">// milliSeconds</span>
</code></pre>
<blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5ded0ca02dd46108575f90b0db5796b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ54af:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768204770&amp;x-signature=LIKqG95Oc75DzSOd2vnauPudOZU%3D" alt="image.png" loading="lazy"/>
PS: 1.2.13之后的源码仓库都有个core层，1.2.12之前的源码仓库是没有的，当时还以为1.2.12没有这个类呢<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fdruid%2Fblob%2F1.2.13%2Fcore%2Fsrc%2Fmain%2Fjava%2Fcom%2Falibaba%2Fdruid%2Fpool%2FDruidAbstractDataSource.java" target="_blank" title="https://github.com/alibaba/druid/blob/1.2.13/core/src/main/java/com/alibaba/druid/pool/DruidAbstractDataSource.java" ref="nofollow noopener noreferrer">druid/<strong>core</strong>/src/main/java/com/alibaba/druid/pool/DruidAbstractDataSource.java at 1.2.13 · alibaba/druid · GitHub</a>，结果1.2.12也有，继续往前找。</p>
</blockquote>
<h3 data-id="heading-7">3. 终于找到“清白”版本</h3>
<p>继续往前追溯，在 <strong>1.2.11</strong> 版本中，终于没找到这个默认配置！
测试验证：</p>
<ul>
<li>使用 <strong>1.2.11</strong>：执行 <code>SELECT SLEEP(30)</code>，正常等待 30 秒后返回结果。</li>
<li>使用 <strong>1.2.12+</strong>：10 秒超时报错。</li>
</ul>
<h2 data-id="heading-8">结论与思考</h2>
<p>最终确认：<strong>Druid 从 1.2.12 版本开始，默认将 <code>socketTimeout</code> 设置为 10 秒。</strong>
为什么 Druid 要加这个默认配置呢？查看官方 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fdruid%2Freleases" target="_blank" title="https://github.com/alibaba/druid/releases" ref="nofollow noopener noreferrer">Release Notes</a>：</p>
<blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e46ca4c501be40929b13abf39b21193a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ54af:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768204770&amp;x-signature=pL%2FlHzQvZlB5TFHm7t1VDpv2uIc%3D" alt="image.png" loading="lazy"/>
官方说明明确提到：<strong>增加默认 10 秒超时，是为了减少因为网络丢包时导致的连接池无法创建链接的问题。</strong>
这是一个为了提升连接池健壮性的防御性配置，但在某些需要执行长耗时 SQL 的场景下，反而导致了超时问题。</p>
</blockquote>
<h2 data-id="heading-9">解决方案</h2>
<p>在 Druid 配置中显式设置 <code>socketTimeout</code> 为更大的值即可解决：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">druid:</span>
      <span class="hljs-attr">socket-timeout:</span> <span class="hljs-number">60000</span> <span class="hljs-comment"># 60秒</span>
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p>这次排查从现象复现，到 AI 辅助定位，再到源码调试和版本考古，最终找到了问题的根本原因。技术问题的排查，往往需要一点"考古"精神，追根溯源，才能知其然更知其所以然。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[英语学废了？这个让10万+用户上瘾的神器，让我2个月从哑巴英语到流利对话！]]></title>    <link>https://juejin.cn/post/7591670569910272046</link>    <guid>https://juejin.cn/post/7591670569910272046</guid>    <pubDate>2026-01-05T07:51:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591670569910272046" data-draft-id="7591687981687078958" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="英语学废了？这个让10万+用户上瘾的神器，让我2个月从哑巴英语到流利对话！"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-05T07:51:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="indieAI"/> <meta itemprop="url" content="https://juejin.cn/user/4488643649743614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            英语学废了？这个让10万+用户上瘾的神器，让我2个月从哑巴英语到流利对话！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4488643649743614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    indieAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T07:51:18.000Z" title="Mon Jan 05 2026 07:51:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>不知道大家有没有这种感觉：英语学了十几年，六级证书都泛黄了，一见到老外还是只会"How are you? I'm fine, thank you, and you?" 这个无限循环？背单词书背到abandon就真的abandon了，看美剧不带字幕跟看天书一样，在会议上被点名说"Can you share your thoughts?"时，恨不得找个地缝钻进去...</p>
<p>别问我怎么知道的，问就是我经历过！作为一名英语学渣，我曾经尝试过：</p>
<ul>
<li>百词斩打卡300天，结果只记得打卡动作</li>
<li>花2万报线下班，结果去了20次就放在那里吃灰</li>
<li>逼自己看《经济学人》，结果5分钟刷3次手机</li>
<li>收藏了100个学习方法，结果收藏夹成了英语公墓</li>
</ul>
<p>直到有一天，我无意间在GitHub trending上刷到了一个叫"earthworm"的开源项目，它的官网julebu.co彻底颠覆了我对英语学习的认知——<strong>原来学英语可以像打游戏一样上瘾！</strong> 从那天起，我每天的快乐从刷抖音变成了"刷英语"，2个月后，我居然能跟外国客户开30分钟的会不卡壳！今天必须把这个宝藏分享给大家！</p>
<hr/>
<h2 data-id="heading-0">一、句乐部（julebu.co）到底是个啥玩意儿？</h2>
<p>说白了，<strong>句乐部就是一个把英语学习变成消除类游戏的在线平台</strong>。它的名字就很妙——"句乐部"，谐音"俱乐部"，意思是让你乐在其中的句子练习社区。</p>
<p>它背后的理念超级硬核：基于语言学大佬Stephen Krashen的"i+1"理论（在你现有水平上增加一点点难度）、"以终为始"的逆向学习法，以及通过高频重复建立"肌肉记忆"。但用起来却简单到爆——就是让你像玩《开心消消乐》一样，把零散的单词连成正确的句子。</p>
<p><strong>官网地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjulebu.co%2Faff%2FRQH6MRYL" target="_blank" title="https://julebu.co/aff/RQH6MRYL" ref="nofollow noopener noreferrer">julebu.co/</a> （点进去记得收藏，不然你会后悔的！）</p>
<p><strong>GitHub开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcuixueshe%2Fearthworm" target="_blank" title="https://github.com/cuixueshe/earthworm" ref="nofollow noopener noreferrer">github.com/cuixueshe/e…</a> （ star数已经破万了，程序员兄弟们可以去瞻仰代码）</p>
<hr/>
<h2 data-id="heading-1">二、让我彻底沦陷的5大变态功能</h2>
<h3 data-id="heading-2">1. <strong>游戏化设计：学习=打怪升级</strong></h3>
<p>一打开julebu.co，你会发现这界面跟百词斩那种枯燥的flashcard完全不同！它有：</p>
<ul>
<li><strong>连词成句的消除玩法</strong>：单词像方块一样掉下来，你得按正确顺序点击，完成句子后会有"combo"连击特效</li>
<li><strong>即时反馈音效</strong>：每点对一个词都有"叮"的爽感音效，错了会有震动提示，支持自定义键盘音效</li>
<li><strong>进度可视化</strong>：清晰的学习路径，看着自己的等级从Lv.1菜鸟升到Lv.20高手，成就感爆棚</li>
</ul>
<p>我媳妇最开始还笑话我："多大的人了还玩游戏？"结果她在我旁边看了10分钟，第二天偷偷问我："那个...julebu.co叫啥来着？我也想试试..."</p>
<h3 data-id="heading-3">2. <strong>情境化学习：告别"哑巴英语"</strong></h3>
<p>传统背单词最大的坑是啥？就是背了"apple"只知道是"苹果"，但开会时想说"问题的核心"死活想不起来用"the core of the issue"。</p>
<p>julebu.co的句子库涵盖了：</p>
<ul>
<li><strong>商务场景</strong>：negotiate terms, facilitate communication, streamline processes</li>
<li><strong>日常对话</strong>：catch up over coffee, weather small talk, express empathy</li>
<li><strong>学术写作</strong>：the study demonstrates, empirical evidence suggests, contrary to popular belief</li>
<li><strong>考试高频</strong>：四六级、雅思托福的真题句式拆解</li>
</ul>
<p>每个句子都有真实语境，学完就能用。我上周给老板写邮件，顺手用了个"streamline the workflow"，老板还以为我去偷师了MBA课程！</p>
<h3 data-id="heading-4">3. <strong>肌肉记忆训练：重复到脱口而出</strong></h3>
<p>最变态的是它的重复机制。你以为点过一次就完事了？Too naive！</p>
<p>一个句子会<strong>在不同场景下变着花样出现5-8次</strong>：</p>
<ul>
<li>第一次：给你中文提示，连英文</li>
<li>第二次：给出首字母填空</li>
<li>第三次：完全听音频默写</li>
<li>第四次：换个相似句式让你举一反三</li>
<li>第五次：在段落中识别这个句型</li>
</ul>
<p>这种"螺旋式重复"让我的大脑形成了条件反射。现在听到"既然..."，嘴比脑子快，直接蹦出"Since..."，而不是先想"既然=since"。</p>
<h3 data-id="heading-5">4. <strong>开源免费+社区驱动</strong></h3>
<p>作为程序员，我必须吹爆它的开源属性！julebu.co背后的earthworm项目完全开源，意味着：</p>
<ul>
<li><strong>免费使用</strong>：所有核心功能不收一分钱</li>
<li><strong>数据透明</strong>：你的学习数据完全属于自己</li>
<li><strong>社区贡献</strong>：有能力的可以提交PR改进功能</li>
<li><strong>私有化部署</strong>：企业或学校可以搭建自己的版本</li>
</ul>
<p>我同事他们公司就给团队部署了一套内网版，每天午休时间大家PK积分榜，办公室学习氛围直接拉满！</p>
<h3 data-id="heading-6">5. <strong>碎片化时间+跨平台同步</strong></h3>
<p>等电梯的3分钟、地铁上的15分钟、蹲坑的5分钟...这些原本被短视频侵占的时间，现在都能刷几个句子。而且<strong>手机、平板、电脑进度实时同步</strong>，我上班在电脑上刷的，下班路上手机接着来，无缝衔接。</p>
<hr/>
<h2 data-id="heading-7">三、真实案例：他们是怎么用julebu.co逆袭的</h2>
<h3 data-id="heading-8"><strong>案例1：二本学渣逆袭雅思7.5，拿下UCL offer</strong></h3>
<p>主角：小李，某二本院校大三学生
背景：英语四级428分飘过，词汇量测试3500词，目标申请英国G5</p>
<p><strong>血泪史</strong>：
小李第一次雅思模考5分，听力听不懂，阅读做不完，写作只会简单句。他报过某哥的网课，买过*维机经，光资料就花了5000+，但成绩一直卡在5.5上不去。最崩溃的是，他发现自己连"increase steadily"和"increase sharply"都分不清。</p>
<p><strong>julebu.co逆袭之路</strong>  ：</p>
<ol>
<li><strong>第1周</strong>：每天2小时，刷完基础句型200句，发现原来自己连主谓宾结构都不扎实</li>
<li><strong>第2-4周</strong>：主攻雅思高频句型，把《剑桥真题》里的长难句拆解成julebu.co的练习题，每天重复50句</li>
<li><strong>第5-8周</strong>：配合听力跟读，把句乐部里练熟的句子主动用在口语和写作中</li>
<li><strong>第9-12周</strong>：模考发现阅读速度提升2倍，写作能自然使用复杂句式</li>
</ol>
<p><strong>成果</strong>：
3个月后雅思首考7.5分（听力8，阅读7.5，写作7，口语7）！他总结说："julebu.co让我建立了句型库，考试时不是现场造句，而是直接调用现成的句式，反应速度快了3倍！"</p>
<p>现在小李在UCL读硕士，还成了校园里的julebu.co推广大使，说每次写论文卡壳时，还会去刷几遍学术句型找找感觉。</p>
<h3 data-id="heading-9"><strong>案例2：30岁打工人从"英语恐惧症"到跨国项目组长</strong></h3>
<p>主角：张哥，某互联网公司运营，30岁
背景：工作6年，英语荒废，每次跨国会议都开静音+闭麦，被领导暗示"职业发展受限"</p>
<p><strong>血泪史</strong>：
张哥大学时英语还行，但工作后完全用不上。去年公司被外企收购，所有会议变双语。他最怕的就是那句："Can you give us a brief update?" 每次都得提前写好稿子念，被外国同事评价"too scripted"（太生硬）。</p>
<p>最尴尬的是有一次，他想表达"这个数据有问题"，结果说成"This data has some problems"，对方一脸懵逼。后来才知道地道说法是"There seems to be a discrepancy in the data."</p>
<p><strong>julebu.co逆袭之路</strong>  ：</p>
<ol>
<li><strong>第1个月</strong>：利用通勤时间刷商务场景句型，把《商务英语900句》导入julebu.co定制课程</li>
<li><strong>第2个月</strong>：在句乐部社区找到"外企会议"专题，每天模拟跟读20个会议高频句</li>
<li><strong>第3个月</strong>：开始主动在会议中套用练过的句式，比如"Let me loop back to..." "To piggyback on what [同事] said..."</li>
<li><strong>第4个月</strong>：能即兴发言3-5分钟，不再需要提前写逐字稿</li>
</ol>
<p><strong>成果</strong>：
半年后，张哥被提拔为亚太区项目协调人，薪资涨了40%！他说："julebu.co最牛的是让我形成了'句型直觉'，现在开会时脑子里是成块的句子，而不是单个单词。"</p>
<p>现在他每天早上8点准时在julebu.co打卡，还拉了个"打工人英语自救"微信群，每天分享学习心得。</p>
<h3 data-id="heading-10"><strong>案例3：全职宝妈零基础，6个月能陪娃读英文绘本</strong></h3>
<p>主角：王姐，35岁，全职妈妈
背景：高中毕业，十几年没碰英语，娃上双语幼儿园，她想陪读但力不从心</p>
<p><strong>血泪史</strong>：
王姐说最怕娃问她："妈妈，这个单词怎么读？" 她只能搪塞："妈妈去给你倒杯水...". 看着别的家长用英语跟娃无障碍交流，她既羡慕又焦虑。报过线下班，但接送孩子+家务根本坚持不下来。</p>
<p><strong>julebu.co逆袭之路</strong>  ：</p>
<ol>
<li><strong>第1-2周</strong>：从julebu.co的"kids"主题开始，每天利用娃午睡时间刷30分钟</li>
<li><strong>第1个月</strong>：掌握200个亲子生活高频句，如"Put on your shoes" "Let's tidy up the toys"</li>
<li><strong>第2-3个月</strong>：进阶到绘本句型，把《Brown Bear》《The Very Hungry Caterpillar》里的句子拆成练习</li>
<li><strong>第4-6个月</strong>：能完整读下分级读物RAZ Level D，娃的英语老师都惊讶"妈妈进步好大"</li>
</ol>
<p><strong>成果</strong>：
现在王姐是幼儿园家长圈的"英语达人"，还开了个公众号分享"宝妈英语速成法"。她说："julebu.co就像我的私人外教，随时随地能练，而且句子都特实用，娃一听就知道啥意思。"</p>
<p>最让她感动的是，娃现在会说："Mommy, you speak English so well!" 这句话她可是在julebu.co上练了20遍才说顺溜的！</p>
<hr/>
<h2 data-id="heading-11">四、julebu.co vs 传统工具：碾压级对比</h2>



























































<table><thead><tr><th>维度</th><th>传统背单词APP</th><th>线下培训班</th><th>julebu.co</th></tr></thead><tbody><tr><td><strong>价格</strong></td><td>部分收费</td><td>几千到几万</td><td>完全免费（开源）</td></tr><tr><td><strong>时间灵活性</strong></td><td>碎片时间可用</td><td>固定时间地点</td><td>随时随地，3分钟也能练</td></tr><tr><td><strong>学习方法</strong></td><td>孤立记单词</td><td>老师讲解</td><td>情境化句子，肌肉记忆</td></tr><tr><td><strong>坚持难度</strong></td><td>容易放弃</td><td>容易缺课</td><td>游戏化上瘾机制</td></tr><tr><td><strong>实用性</strong></td><td>会背不会用</td><td>理论偏多</td><td>直接掌握整句输出</td></tr><tr><td><strong>反馈速度</strong></td><td>延迟反馈</td><td>课上反馈</td><td>即时音效+可视化</td></tr><tr><td><strong>数据所有权</strong></td><td>平台控制</td><td>-</td><td>开源，数据可导出</td></tr><tr><td><strong>社区氛围</strong></td><td>较弱</td><td>线下同学</td><td>GitHub+Discord活跃社区</td></tr></tbody></table>
<p><strong>一句话总结</strong>：传统工具是"学英语"，julebu.co是"用英语"。前者给你一堆砖头，后者直接给你盖好的房子，拎包入住！</p>
<hr/>
<h2 data-id="heading-12">五、不同人群的定制化打法</h2>
<h3 data-id="heading-13"><strong>🎓 学生党（四六级/考研/雅思托福）</strong></h3>
<p><strong>核心策略</strong>：把真题长难句导入julebu.co</p>
<ul>
<li><strong>四六级</strong>：刷完近10年真题的阅读长难句，保证阅读速度提升50%</li>
<li><strong>考研英语</strong>：重点攻克唐迟《阅读的逻辑》里的典型句型</li>
<li><strong>雅思托福</strong>：配合听力材料，把听不懂的句子变成julebu.co练习题</li>
</ul>
<p><strong>每日时长</strong>：1-2小时，考前一个月可增至3小时</p>
<p><strong>效果预期</strong>：3个月阅读从错10个到错2个，写作从5分到7分</p>
<h3 data-id="heading-14"><strong>💼 职场人士（外企/跨境电商/国际业务）</strong></h3>
<p><strong>核心策略</strong>：场景化突击</p>
<ul>
<li><strong>会议场景</strong>：练熟"表态""打断""总结"三大功能句</li>
<li><strong>邮件写作</strong>：掌握20个高分替换句型（如用"kindly remind"代替"please remember"）</li>
<li><strong>谈判场景</strong>：背诵30个缓和语气的缓冲句</li>
</ul>
<p><strong>每日时长</strong>：通勤30分钟+工作间隙15分钟</p>
<p><strong>效果预期</strong>：2个月能主动发言，6个月能主导会议</p>
<h3 data-id="heading-15"><strong>👶 家长（陪娃英语/亲子互动）</strong></h3>
<p><strong>核心策略</strong>：生活化场景</p>
<ul>
<li><strong>早晨起床</strong>：Put on your clothes/Brush your teeth/Breakfast is ready</li>
<li><strong>晚上睡前</strong>：Let's read a story/Time for bed/Sweet dreams</li>
<li><strong>情绪管理</strong>：Don't worry/It's okay to make mistakes/I'm proud of you</li>
</ul>
<p><strong>每日时长</strong>：娃看动画片时刷15分钟</p>
<p><strong>效果预期</strong>：1个月能简单指令，3个月能陪读绘本</p>
<hr/>
<h2 data-id="heading-16">六、高手私藏的使用技巧（建议收藏）</h2>
<h3 data-id="heading-17"><strong>技巧1：DIY专属词库</strong></h3>
<p>julebu.co支持自定义导入！把你工作中常用的句子整理成CSV：</p>
<pre><code class="hljs language-arduino" lang="arduino">中文,英文
<span class="hljs-string">"这个项目有风险"</span>,<span class="hljs-string">"There are potential risks associated with this project"</span>
<span class="hljs-string">"需要高层批准"</span>,<span class="hljs-string">"This requires approval from senior management"</span>
</code></pre>
<p>导入后就成了你的专属课程，针对性MAX！</p>
<h3 data-id="heading-18"><strong>技巧2：利用"遗忘曲线"设置复习</strong></h3>
<p>julebu.co会自动记录你的错误句子。每周日把本周错题导出，用Anki再复习一遍，形成双重保险。我保证你忘不掉！</p>
<h3 data-id="heading-19"><strong>技巧3：社群PK提升动力</strong></h3>
<p>加入julebu.co的Discord社区，参与"30天打卡挑战"。有陌生人监督，坚持成功率提升300%！而且社区里有大神分享《经济学人》句型包、《老友记》台词包等稀缺资源。</p>
<h3 data-id="heading-20"><strong>技巧4：跟读模式练口语</strong></h3>
<p>别只盯着屏幕点！julebu.co每个句子都有音频，点完句子后跟着读3遍。我用这招练了1个月，口音从Chinglish变成了"有点意思的国际范"。</p>
<h3 data-id="heading-21"><strong>技巧5：生产化输出</strong></h3>
<p>学过100个句子后，强迫自己每天用5个新句子发朋友圈（设为自己可见也行）。输出是检验输入的唯一标准！</p>
<hr/>
<h2 data-id="heading-22">七、如何开始你的逆袭之路？（手把手教程）</h2>
<p><strong>第一步：访问官网</strong>
直接戳这里 → <a href="https://link.juejin.cn?target=https%3A%2F%2Fjulebu.co%2Faff%2FRQH6MRYL" target="_blank" title="https://julebu.co/aff/RQH6MRYL" ref="nofollow noopener noreferrer">julebu.co/</a>（建议PC端体验更佳）</p>
<p><strong>第二步：注册账号</strong>
5秒搞定，支持GitHub一键登录（程序员福音）</p>
<p><strong>第三步：选择起点</strong></p>
<ul>
<li><strong>新手</strong>：从"基础句型"开始</li>
<li><strong>中级</strong>：直接刷"商务场景"</li>
<li><strong>高手</strong>：导入专业材料（法律文书、医学文献等）</li>
</ul>
<p><strong>第四步：设置每日目标</strong>
建议新手设为20句/天，适应后增至50句。记住：<strong>慢就是快，少即是多</strong>！</p>
<p><strong>第五步：加入社区</strong>
官网底部有Discord链接，进去先打个招呼#introduce-yourself，会有人带你飞</p>
<p><strong>第六步：坚持使用30天</strong>
这是最关键的！前3天可能没感觉，第7天开始上头，第30天你会来感谢我！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我和TRAE的这一年：2025年从初识到羁绊的AI编程梦幻之旅]]></title>    <link>https://juejin.cn/post/7591465142451486772</link>    <guid>https://juejin.cn/post/7591465142451486772</guid>    <pubDate>2026-01-05T05:43:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591465142451486772" data-draft-id="7591330139083784207" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我和TRAE的这一年：2025年从初识到羁绊的AI编程梦幻之旅"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-05T05:43:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="熊猫钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1303344484202867"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我和TRAE的这一年：2025年从初识到羁绊的AI编程梦幻之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1303344484202867/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    熊猫钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T05:43:52.000Z" title="Mon Jan 05 2026 05:43:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我和TRAE的这一年：2025年从初识到羁绊的AI编程梦幻之旅</h2>
<p>2025年我初识TRAE，也是这一年刚刚加入掘金社区，认识了很多热心的小伙伴，有你们相伴的感觉真好。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9145f6881a9432b927a3460a07eee26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=4CFOMKnTOPu5UloMKAhY0jRFxaQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>今年的年终总结应该是特别的，这一年TRAE带给我的收获满满。</p>
<p>回首2025年，我不仅用TRAE编写了大量的代码，开发出了好几款应用，同时也用它撰写报告和制作分析图表，它总是能一次又一次带给我震撼和惊喜。</p>
<p>我相信，TRAE使我相信，AI的时代真的到来了！</p>
<h3 data-id="heading-1">一、TRAE ：开发与创作同行</h3>
<p>我初次使用TRAE是在VS Code IDE中安装Trae插件。开发了一款简单实用的Excel合并工具。</p>
<p>这是我第一次用TRAE，使用VibeCoding的感觉太奇妙了!~</p>
<p>因为我在日常办公和数据处理中，经常会需要对Excel文件资料进行合并，汇总分散在不同文件中的数据，这是一个常见但繁琐的任务，耗时耗力，传统的手动操作不仅效率低下，而且容易出错。专门写代码也需要花费不小的功夫去开发和调试，显得有些鸡肋，因此，我想利用AI工具快速开发一个Excel多文件多表合并工具。</p>
<p>我只是简单在Trae的聊天框中输入：
"请帮我在当前工程下完成一个Excel多文件多表合并工具。该工具支持Windows系统，无需安装，打开即可使用。"
Trae立即响应，建议使用Python的pandas库来处理Excel文件，并自动创建了一个新的Python脚本。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8881e20e18fc49a08253f16a52541884~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=FCKxd4fWymZPutHk7iz0c2mIH04%3D" alt="在这里插入图片描述" loading="lazy"/>
Trae Builder模式初体验，我觉得它能够理解自然语言描述的项目需求，并自动生成可运行的代码框架，而且速度特别快，只用了十来分钟就完成了可用的程序功能。</p>
<p>感谢掘金社区这么一个平台的存在。</p>
<p>我把我的经历和感悟都写出了博客进行分享。</p>
<p>5月19日，我首次发布了两篇文章，心情忐忑又激动。
《对话即编程：如何用 Trae 的 @智能体 5 分钟修复一个复杂 Bug？》《从编程助手到AI工程师：Trae插件Builder模式实战Excel合并工具开发》</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a93df564f4a422e8062f8b5675de077~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=DQHfGoZJyxEHh9xFwo0Q0cenqZ0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>以及之后创作了《 超快速开发！手把手教你基于Trae IDE 04.22构建智能磁盘清理工具——AI原生开发范式实践 》等文章，很快就都被推荐到掘金社区的首页。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35ef31d1109040b08ede7f9c30706a12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=Y7aSU9OI6BJ0JjMYBN2bGRx2nNI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>随后，更是获得了社区的多篇征文奖励，使我备受鼓舞。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d801475ebad44dba98bacdeff70f057~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=cgGl6ZXThmj8UgBRxw4MYilrios%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ae41ea9c2804c4f8cb595cc4f4ebdd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=%2FcCcrgjsn1LVIRH1fEGcDiGKQes%3D" alt="w6.jpg" loading="lazy"/></p>
<p>社区的分享讨论，使我更加有信心利用先进的AI编程工具解决代码难题，提升工作效率。同时增加了与志同道合的小伙伴们的交流，社区的朋友们总是热情地解答我的问题，给予了我大量无私的帮助。</p>
<p>这一年我给TRAE.ai的公众号写了几篇文章，被授予了“年度创作之星”。这项珍贵的荣誉，给我的2025年画上了一个完美的句号。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09896cdba7884bb3a3b881bf693ddcce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=W7hupuERNh2rciHlQ6LeNwJdTJc%3D" alt="w4.jpg" loading="lazy"/></p>
<h3 data-id="heading-2">二、TRAE 年度报告：MVP书写感动！</h3>
<p>看到年度报告的那一刻，我有些惊讶。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f094ce9ae77241508c07ba3556459b92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=4pQ4KamvQGEUGkBFgScUR0iuGsk%3D" alt="w3.png" loading="lazy"/></p>
<p>创世神。全场MVP。超越99%用户的代码量。这些词组合在一起，我觉得对于我有些不可思议。</p>
<p>我真的只是一个新人，没想到这一年来，自己已经走过了这么远的路。</p>
<p>但屏幕上那个数字——172,106行代码，又实实在在地摆在那里。十倍于FC版《超级玛丽》的代码量，原来真的是TRAE伴随我一路风霜，它帮我一行一行敲出来的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59b48e9b9e754dc78c1456787bef820c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=qi00f%2FPTzRlMD619Mahus%2BQbJLA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>2026年1月4日，我写下这篇总结的最终版。距离我第一次使用TRAE，已经过去了220天。这220天里，TRAE不仅是我的开发工具，更像是我的伙伴，见证了我的成长与蜕变。</p>
<h3 data-id="heading-3">三、与TRAE朝夕相伴的日夜</h3>
<p>在这220天里，我见证了TRAE SOLO功能的多次更新：</p>
<ul>
<li><strong>AI代码补全增强</strong>：从简单的代码片段补全，到支持完整函数、类的生成，甚至能够理解项目上下文</li>
<li><strong>多语言支持优化</strong>：最初只支持Python、JavaScript等主流语言，现在已经支持Go、Java、Rust等多种语言</li>
<li><strong>调试能力提升</strong>：从只能生成代码，到能够协助调试、分析错误日志、提供修复方案</li>
<li><strong>项目管理功能</strong>：新增了项目模板、版本控制、协作功能，让SOLO开发也能享受团队级别的管理体验</li>
</ul>
<p>每次更新都让我感受到TRAE团队的用心，他们真正理解开发者的需求，并且快速响应。这种持续进化的能力，是TRAE最吸引我的地方之一。</p>
<p>90天的年度活跃天数，说多不多，说少也不少。但那些深夜里敲代码的时光，那些被bug折磨到抓狂的时刻，那些终于跑通程序时的兴奋，都真实地发生着。</p>
<p>6月2日那天，我写了12435行代码。现在回想起来，那天应该是在做"智能会议纪要助手"的第一个版本。为了实现实时转录功能，我和TRAE反复调试，从深夜10点一直到凌晨3点。当第一个完整的会议纪要生成出来时，我兴奋得像个孩子，立刻给朋友发了截图分享。</p>
<p>8月3日凌晨1点04分，我还沉迷在TRAE的世界里。那天是在修复项目中的一个bug。我和TRAE一起分析日志、调试代码，终于找到了问题所在：对话历史管理模块的缓存机制有问题。当我修复这个bug，夜色已深，我在疲倦中入睡，心情却异常安稳踏实。</p>
<p>10月26日那天，我在IDE里待了384分钟。那天是在优化"智能会议纪要助手"的性能，原来的模型处理长会议时会卡顿。我和TRAE一起尝试了多种优化方案，最终采用了分段处理和增量生成的方式，让系统能够流畅处理长达4小时的会议。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a444e077d34432783b75a05496b618f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=kpfVuIqFHSh1CwPDUcF6FW%2FgQNg%3D" alt="w4.png" loading="lazy"/></p>
<p>回想这一年，我的技能结构发生了巨大的变化。年初时，我还在为代码自动补全工具的小幅提升感到欣喜；到年中的TRAE黑客松，我已经能够利用AI平台在短时间内构建完整的应用；而到了年末，AI已经从单纯的辅助工具变成了我的"开发伙伴"。</p>
<p>黑客松之后，我开始认真思考如何将Demo转化为可用的产品。在开发项目的过程中，我经历了思维方式的深刻转变。</p>
<p>传统软件开发追求的是确定性和可控性——相同输入必须产生相同输出，每一步操作都应当可预测。而AI开发则建立在概率性基础上——相同的输入可能产生略有不同的输出，我们需要接受这种不确定性，并学会如何控制和优化它。</p>
<p>刚开始，这种不确定性让我很不适应。我习惯了精确控制每一行代码的执行结果，现在却要接受AI输出的"随机性"。但慢慢地，我发现这种不确定性其实是AI的魅力所在。它能够产生意想不到的创意，提供多样化的解决方案，让产品变得更加灵活和智能。</p>
<p>我学会了如何设计"容错"的系统，如何通过提示词工程引导AI输出期望的结果，如何建立质量评估机制来筛选AI生成的内容。这些经验成为了我2025年技术成长中最宝贵的财富。</p>
<p>更有趣的是，我发现独立开发者在AI应用方面表现最为积极。这主要得益于AI工具降低了技术门槛，使个人开发者也能实现原本需要团队才能完成的功能。这种趋势正在重塑整个软件开发生态，为更多创新提供了可能。</p>
<h3 data-id="heading-4">四、TRAE SOLO Hackathon线下活动：头脑风暴展示TRAE SOLO的魅力</h3>
<p>真正让我对TRAE产生质的认知的，是那场武汉场的TRAE SOLO黑客松。现在回想起来，TRAE SOLO功能的设计理念，其实早已预示了Vibe Coding的未来。</p>
<p>11月16日是一个值得纪念的周末，我有幸受邀参加了武汉场的TRAE SOLO Hackathon线下活动。当天上午的老师们的分享非常有趣，下午是我们battle的主场，武汉场的TRAE用户同伴也都很nice!</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d7e627048f3401cb85e39f42d66ecd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=GLrwBvukS3W3rtZaZS80wY0Vk9k%3D" alt="image.png" loading="lazy"/></p>
<p>值得一提的是，中午的盒饭和餐点真的很好吃！
晒一下我当天的伙食。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e05cb4cb1ba14b6188958e8b761389b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=4n%2B6jQC6qZvJIjlT2CT3QZLcYgY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在黑客松中，我仅用了半天3个小时就开发出了一个基本完整的应用：</p>
<p><strong>TRAE SOLO环游世界游戏轻应用</strong>：包含景点打卡系统、道具收集机制、道具交易系统、AI智能向导、成就系统等丰富功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/889668422e95419f803c04e4cdbee09a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=i0iVuLf0ZS4%2F2UvYT5tYKNwL0yE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b643070db7704433acedd1e01b5685d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=gmdnktAEQMpxcALhAaAKPnUTXsk%3D" alt="2.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5d71ba9c6474c4ebe72d51cb780306d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=JiYOxg8rfrvFFZcucKqQkChIWow%3D" alt="3.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07842f276cc546929d7207ae2f24f3b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=cOO7M2JjdZnm1quWeCedTCI%2F%2BWs%3D" alt="image.png" loading="lazy"/></p>
<p>"环游世界"是一个与我以往开发办公应用实用工具为主相反的完全不同的尝试。</p>
<p>我想做一个游戏，让玩家通过对话的方式，在虚拟世界中旅行、探索、学习。这个想法听起来很简单，但实现起来需要复杂的对话系统、状态管理、内容生成。在传统开发模式下，这几乎是一个独立开发者无法完成的任务。</p>
<p>但TRAE SOLO改变了这一切。我能够快速集成智能对话系统，让NPC有自己的个性和记忆；能够轻松生成多样化的场景描述，从巴黎的埃菲尔铁塔到亚马逊的热带雨林；能够实现个性化的游戏体验，根据玩家的选择调整剧情走向。最让我感动的是，有玩家反馈说："这个游戏让我在屏幕前就感受到了世界的广阔"。</p>
<p>这个应用让我获得了二等奖的殊荣。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e3a440dc5d94a6597c8a4f4daa3d04d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54aK54yr6ZKT6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196632&amp;x-signature=ur5g8hejqnlDefYcDY7PSqWDA6o%3D" alt="w5.jpg" loading="lazy"/></p>
<p>TRAE SOLO真正吸引我的地方，是它"一人即团队"的设计理念。在传统开发中，一个完整的项目需要前端、后端、测试等多个角色配合，而TRAE SOLO让我一个人就能完成整个开发流程。</p>
<p>最让我惊喜的是，TRAE SOLO不仅提供了强大的开发能力，还内置了<strong>轻应用发布</strong>功能，让我能够快速将作品分享给其他用户。这种"开发-发布-反馈"的闭环体验，极大地提升了我的开发热情。</p>
<h3 data-id="heading-5">写在最后：未来的展望</h3>
<p>创世神这个称号，听起来很厉害，但我知道，真正的"创世"不是写了多少代码，而是这些代码最终变成了什么。"智能会议纪要助手"帮助了很多人提高工作效率，"环游世界"游戏给玩家带来了快乐和启发，这些才是真正有价值的东西。</p>
<p>在这一年里，TRAE见证了我的技术成长。</p>
<p>新的一年就要来了，我对未来充满期待。我会继续写代码，继续学习，继续创造。我相信，在TRAE的陪伴下，我会创造出更多有价值的产品，结识更多有趣的人，经历更多精彩的故事。</p>
<p>就像TRAE说的，我们的冒险已经启程。220天只是开始，后面的路还很长。</p>
<p>——熊猫钓鱼，2026年1月5日</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python迭代器与生成器：优雅的惰性计算艺术]]></title>    <link>https://juejin.cn/post/7591506455972528182</link>    <guid>https://juejin.cn/post/7591506455972528182</guid>    <pubDate>2026-01-05T07:49:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591506455972528182" data-draft-id="7591497387245142052" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python迭代器与生成器：优雅的惰性计算艺术"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-05T07:49:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python迭代器与生成器：优雅的惰性计算艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T07:49:23.000Z" title="Mon Jan 05 2026 07:49:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、迭代器协议：<code>__iter__</code>和<code>__next__</code>的魔法</h2>
<h3 data-id="heading-1">迭代器的本质</h3>
<p>Python中的迭代器不是存储所有元素的容器，而是<strong>惰性计算</strong>的协议实现。核心在于两个方法：</p>
<ul>
<li><code>__iter__()</code>：返回迭代器自身</li>
<li><code>__next__()</code>：返回下一个元素，耗尽时抛出<code>StopIteration</code></li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CountDown</span>:
    <span class="hljs-string">"""自定义迭代器：倒计时"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, start</span>):
        self.current = start
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self  <span class="hljs-comment"># 迭代器必须返回自身</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__next__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">if</span> self.current &lt;= <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> StopIteration
        num = self.current
        self.current -= <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> num

<span class="hljs-comment"># 使用</span>
<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> CountDown(<span class="hljs-number">5</span>):
    <span class="hljs-built_in">print</span>(num)  <span class="hljs-comment"># 输出: 5 4 3 2 1</span>
</code></pre>
<h3 data-id="heading-2">迭代器的优势</h3>
<ul>
<li><strong>内存高效</strong>：不一次性加载所有数据</li>
<li><strong>无限序列</strong>：可以表示无限长的序列</li>
<li><strong>通用接口</strong>：统一的<code>for</code>循环处理方式</li>
</ul>
<h2 data-id="heading-3">二、生成器：<code>yield</code>的暂停与恢复魔法</h2>
<h3 data-id="heading-4">生成器函数</h3>
<p>生成器是创建迭代器的<strong>语法糖</strong>，使用<code>yield</code>暂停函数执行并返回值：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci_generator</span>(<span class="hljs-params">limit</span>):
    <span class="hljs-string">"""生成斐波那契数列"""</span>
    a, b = <span class="hljs-number">0</span>, <span class="hljs-number">1</span>
    count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> count &lt; limit:
        <span class="hljs-keyword">yield</span> a  <span class="hljs-comment"># 暂停执行，返回a</span>
        a, b = b, a + b
        count += <span class="hljs-number">1</span>

<span class="hljs-comment"># 生成器对象</span>
fib_gen = fibonacci_generator(<span class="hljs-number">10</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(fib_gen))  <span class="hljs-comment"># 0</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(fib_gen))  <span class="hljs-comment"># 1</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>(fib_gen))  <span class="hljs-comment"># [1, 2, 3, 5, 8, 13, 21, 34]</span>
</code></pre>
<h3 data-id="heading-5">生成器表达式</h3>
<p>更简洁的生成器创建方式：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 传统列表推导（立即计算）</span>
squares_list = [x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>)]  <span class="hljs-comment"># 占用大量内存</span>

<span class="hljs-comment"># 生成器表达式（惰性计算）</span>
squares_gen = (x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>))  <span class="hljs-comment"># 几乎不占内存</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(squares_gen))  <span class="hljs-comment"># 0</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(squares_gen))  <span class="hljs-comment"># 1</span>
</code></pre>
<h2 data-id="heading-6">三、<code>yield from</code>：生成器的委派机制</h2>
<h3 data-id="heading-7">简化嵌套生成器</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">chain_generators</span>(<span class="hljs-params">*iterables</span>):
    <span class="hljs-string">"""连接多个可迭代对象"""</span>
    <span class="hljs-keyword">for</span> iterable <span class="hljs-keyword">in</span> iterables:
        <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> iterable  <span class="hljs-comment"># 委派给子生成器</span>

<span class="hljs-comment"># 等效于：</span>
<span class="hljs-comment"># for item in iterable:</span>
<span class="hljs-comment">#     yield item</span>

result = <span class="hljs-built_in">list</span>(chain_generators([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], <span class="hljs-string">'ab'</span>, (<span class="hljs-literal">True</span>, <span class="hljs-literal">False</span>)))
<span class="hljs-comment"># [1, 2, 'a', 'b', True, False]</span>
</code></pre>
<h2 data-id="heading-8">四、生成器的高级用法</h2>
<h3 data-id="heading-9">1. 协程：双向通信</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">coroutine_generator</span>():
    <span class="hljs-string">"""接收外部数据的生成器"""</span>
    total = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        value = <span class="hljs-keyword">yield</span> total  <span class="hljs-comment"># 暂停并接收发送的值</span>
        <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">break</span>
        total += value

coro = coroutine_generator()
<span class="hljs-built_in">next</span>(coro)  <span class="hljs-comment"># 启动生成器（预激）</span>
<span class="hljs-built_in">print</span>(coro.send(<span class="hljs-number">10</span>))  <span class="hljs-comment"># 10</span>
<span class="hljs-built_in">print</span>(coro.send(<span class="hljs-number">20</span>))  <span class="hljs-comment"># 30</span>
coro.close()  <span class="hljs-comment"># 关闭生成器</span>
</code></pre>
<h3 data-id="heading-10">2. 上下文管理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager

<span class="hljs-meta">@contextmanager</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">managed_resource</span>():
    <span class="hljs-string">"""生成器实现的上下文管理器"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"获取资源"</span>)
    resource = <span class="hljs-string">"资源对象"</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> resource
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"释放资源"</span>)

<span class="hljs-keyword">with</span> managed_resource() <span class="hljs-keyword">as</span> r:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"使用 <span class="hljs-subst">{r}</span>"</span>)
</code></pre>
<h2 data-id="heading-11">五、性能对比：迭代器 vs 列表</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> sys

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_memory_usage</span>():
    <span class="hljs-string">"""内存使用对比"""</span>
    <span class="hljs-comment"># 列表：一次性加载所有数据</span>
    list_data = [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>)]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"列表内存: <span class="hljs-subst">{sys.getsizeof(list_data):,}</span> bytes"</span>)
    
    <span class="hljs-comment"># 生成器：惰性计算</span>
    gen_data = (i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成器内存: <span class="hljs-subst">{sys.getsizeof(gen_data):,}</span> bytes"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_performance</span>():
    <span class="hljs-string">"""性能对比"""</span>
    n = <span class="hljs-number">10_000_000</span>
    
    <span class="hljs-comment"># 列表推导</span>
    start = time.time()
    _ = [x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n)]
    list_time = time.time() - start
    
    <span class="hljs-comment"># 生成器表达式</span>
    start = time.time()
    _ = (x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n))
    gen_time = time.time() - start
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"列表推导: <span class="hljs-subst">{list_time:<span class="hljs-number">.3</span>f}</span>s"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成器表达式: <span class="hljs-subst">{gen_time:<span class="hljs-number">.3</span>f}</span>s"</span>)

test_memory_usage()
test_performance()
</code></pre>
<h2 data-id="heading-12">六、实用模式与陷阱</h2>
<h3 data-id="heading-13">1. 生成器的一次性使用</h3>
<pre><code class="hljs language-python" lang="python">gen = (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>(gen))  <span class="hljs-comment"># [0, 1, 2]</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>(gen))  <span class="hljs-comment"># [] ！已耗尽</span>
</code></pre>
<h3 data-id="heading-14">2. <code>itertools</code>模块的迭代器工具</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> itertools <span class="hljs-keyword">import</span> islice, count, cycle

<span class="hljs-comment"># 无限序列的切片</span>
first_10 = <span class="hljs-built_in">list</span>(islice(count(<span class="hljs-number">10</span>), <span class="hljs-number">5</span>))  <span class="hljs-comment"># [10, 11, 12, 13, 14]</span>

<span class="hljs-comment"># 循环迭代器</span>
cycler = cycle(<span class="hljs-string">'ABC'</span>)
<span class="hljs-built_in">print</span>([<span class="hljs-built_in">next</span>(cycler) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>)])  <span class="hljs-comment"># ['A', 'B', 'C', 'A', 'B', 'C']</span>
</code></pre>
<h3 data-id="heading-15">3. 自定义可迭代对象</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchProcessor</span>:
    <span class="hljs-string">"""分批处理大数据集"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, data, batch_size</span>):
        self.data = data
        self.batch_size = batch_size
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""返回生成器迭代器"""</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(self.data), self.batch_size):
            <span class="hljs-keyword">yield</span> self.data[i:i + self.batch_size]

data = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>))
batcher = BatchProcessor(data, <span class="hljs-number">10</span>)
<span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> batcher:
    process(batch)  <span class="hljs-comment"># 每次处理10个元素</span>
</code></pre>
<h2 data-id="heading-16">总结</h2>
<p>迭代器和生成器是Python<strong>惰性计算哲学</strong>的体现，它们通过：</p>
<ol>
<li><strong>按需计算</strong>节省内存</li>
<li><strong>统一的迭代协议</strong>简化API设计</li>
<li><strong>生成器协程</strong>实现复杂控制流</li>
<li><strong>优雅的语法</strong>让代码更清晰</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python描述符协议：属性访问的底层魔法]]></title>    <link>https://juejin.cn/post/7591407298415149062</link>    <guid>https://juejin.cn/post/7591407298415149062</guid>    <pubDate>2026-01-05T07:53:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591407298415149062" data-draft-id="7591403124328153151" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python描述符协议：属性访问的底层魔法"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-05T07:53:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python描述符协议：属性访问的底层魔法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T07:53:16.000Z" title="Mon Jan 05 2026 07:53:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、描述符协议：<code>__get__</code>、<code>__set__</code>、<code>__delete__</code></h2>
<h3 data-id="heading-1">描述符的本质</h3>
<p>描述符是实现了特定协议的类，它控制对其他对象属性的访问。这是Python属性、方法、静态方法等特性的基础：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidatedAttribute</span>:
    <span class="hljs-string">"""数据验证描述符"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, validator</span>):
        self.validator = validator
        self.attr_name = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 稍后由__set_name__设置</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set_name__</span>(<span class="hljs-params">self, owner, name</span>):
        <span class="hljs-string">"""在描述符被赋值给类属性时调用（Python 3.6+）"""</span>
        self.attr_name = name
        self.storage_name = <span class="hljs-string">f"_<span class="hljs-subst">{name}</span>"</span>  <span class="hljs-comment"># 实际存储的私有属性名</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, obj, objtype=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""获取属性值时调用"""</span>
        <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> self  <span class="hljs-comment"># 通过类访问时返回描述符本身</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(obj, self.storage_name, <span class="hljs-literal">None</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, obj, value</span>):
        <span class="hljs-string">"""设置属性值时调用"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.validator(value):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Invalid value for <span class="hljs-subst">{self.attr_name}</span>: <span class="hljs-subst">{value}</span>"</span>)
        <span class="hljs-built_in">setattr</span>(obj, self.storage_name, value)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__delete__</span>(<span class="hljs-params">self, obj</span>):
        <span class="hljs-string">"""删除属性时调用"""</span>
        <span class="hljs-built_in">delattr</span>(obj, self.storage_name)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">is_positive_number</span>(<span class="hljs-params">value</span>):
    <span class="hljs-string">"""验证函数：必须是正数"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">isinstance</span>(value, (<span class="hljs-built_in">int</span>, <span class="hljs-built_in">float</span>)) <span class="hljs-keyword">and</span> value &gt; <span class="hljs-number">0</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>:
    <span class="hljs-comment"># 使用描述符</span>
    price = ValidatedAttribute(is_positive_number)
    quantity = ValidatedAttribute(is_positive_number)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, price, quantity</span>):
        self.name = name
        self.price = price  <span class="hljs-comment"># 触发__set__</span>
        self.quantity = quantity  <span class="hljs-comment"># 触发__set__</span>

<span class="hljs-comment"># 使用</span>
<span class="hljs-keyword">try</span>:
    p = Product(<span class="hljs-string">"Apple"</span>, <span class="hljs-number">10.5</span>, <span class="hljs-number">5</span>)
    <span class="hljs-built_in">print</span>(p.price)  <span class="hljs-comment"># 10.5，触发__get__</span>
    
    p.price = -<span class="hljs-number">5</span>  <span class="hljs-comment"># 触发__set__，抛出ValueError</span>
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"验证错误: <span class="hljs-subst">{e}</span>"</span>)

p.quantity = <span class="hljs-number">20</span>  <span class="hljs-comment"># 正常设置</span>
</code></pre>
<h2 data-id="heading-2">二、描述符的类型</h2>
<h3 data-id="heading-3">1. 数据描述符（实现<code>__set__</code>或<code>__delete__</code>）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggedAttribute</span>:
    <span class="hljs-string">"""记录所有访问的数据描述符"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.data = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, obj, objtype</span>):
        <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> self
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"读取 <span class="hljs-subst">{obj}</span>.<span class="hljs-subst">{self.attr_name}</span>"</span>)
        <span class="hljs-keyword">return</span> self.data.get(<span class="hljs-built_in">id</span>(obj))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, obj, value</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"设置 <span class="hljs-subst">{obj}</span>.<span class="hljs-subst">{self.attr_name}</span> = <span class="hljs-subst">{value}</span>"</span>)
        self.data[<span class="hljs-built_in">id</span>(obj)] = value
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set_name__</span>(<span class="hljs-params">self, owner, name</span>):
        self.attr_name = name
</code></pre>
<h3 data-id="heading-4">2. 非数据描述符（只实现<code>__get__</code>）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedProperty</span>:
    <span class="hljs-string">"""属性缓存描述符（非数据描述符）"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, func</span>):
        self.func = func
        self.name = func.__name__
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, obj, objtype</span>):
        <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> self
        
        <span class="hljs-comment"># 计算并缓存结果</span>
        value = self.func(obj)
        obj.__dict__[self.name] = value  <span class="hljs-comment"># 存储在实例字典中</span>
        <span class="hljs-keyword">return</span> value


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, radius</span>):
        self.radius = radius
    
<span class="hljs-meta">    @CachedProperty</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">area</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"计算面积..."</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-number">3.14159</span> * self.radius ** <span class="hljs-number">2</span>
    
<span class="hljs-meta">    @CachedProperty</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">circumference</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"计算周长..."</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * <span class="hljs-number">3.14159</span> * self.radius

c = Circle(<span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(c.area)  <span class="hljs-comment"># 计算面积... 78.53975</span>
<span class="hljs-built_in">print</span>(c.area)  <span class="hljs-comment"># 78.53975（从缓存读取，不再打印"计算面积..."）</span>
</code></pre>
<h2 data-id="heading-5">三、Python内置描述符的实现</h2>
<h3 data-id="heading-6">1. <code>property</code>装饰器的实现原理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyProperty</span>:
    <span class="hljs-string">"""简化版的property实现"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, fget=<span class="hljs-literal">None</span>, fset=<span class="hljs-literal">None</span>, fdel=<span class="hljs-literal">None</span></span>):
        self.fget = fget
        self.fset = fset
        self.fdel = fdel
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, obj, objtype=<span class="hljs-literal">None</span></span>):
        <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> self
        <span class="hljs-keyword">if</span> self.fget <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">"unreadable attribute"</span>)
        <span class="hljs-keyword">return</span> self.fget(obj)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, obj, value</span>):
        <span class="hljs-keyword">if</span> self.fset <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">"can't set attribute"</span>)
        self.fset(obj, value)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__delete__</span>(<span class="hljs-params">self, obj</span>):
        <span class="hljs-keyword">if</span> self.fdel <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">"can't delete attribute"</span>)
        self.fdel(obj)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setter</span>(<span class="hljs-params">self, fset</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">type</span>(self)(self.fget, fset, self.fdel)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">deleter</span>(<span class="hljs-params">self, fdel</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">type</span>(self)(self.fget, self.fset, fdel)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name</span>):
        self._name = name
    
<span class="hljs-meta">    @MyProperty</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self._name
    
<span class="hljs-meta">    @name.setter</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">self, value</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> value:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Name cannot be empty"</span>)
        self._name = value

p = Person(<span class="hljs-string">"Alice"</span>)
<span class="hljs-built_in">print</span>(p.name)  <span class="hljs-comment"># Alice</span>
p.name = <span class="hljs-string">"Bob"</span>
<span class="hljs-built_in">print</span>(p.name)  <span class="hljs-comment"># Bob</span>
</code></pre>
<h3 data-id="heading-7">2. 方法和静态方法的描述符实现</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> types

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMethod</span>:
    <span class="hljs-string">"""模拟方法描述符"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, func</span>):
        self.func = func
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, obj, objtype</span>):
        <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> self.func  <span class="hljs-comment"># 通过类访问</span>
        <span class="hljs-comment"># 绑定方法：将实例作为第一个参数</span>
        <span class="hljs-keyword">return</span> types.MethodType(self.func, obj)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyStaticMethod</span>:
    <span class="hljs-string">"""模拟静态方法描述符"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, func</span>):
        self.func = func
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, obj, objtype=<span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># 始终返回原始函数</span>
        <span class="hljs-keyword">return</span> self.func


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span>:
<span class="hljs-meta">    @MyMethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">instance_method</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"实例方法，self=<span class="hljs-subst">{self}</span>"</span>
    
<span class="hljs-meta">    @MyStaticMethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">static_method</span>():
        <span class="hljs-keyword">return</span> <span class="hljs-string">"静态方法"</span>

obj = MyClass()
<span class="hljs-built_in">print</span>(obj.instance_method())  <span class="hljs-comment"># 实例方法，self=&lt;__main__.MyClass object&gt;</span>
<span class="hljs-built_in">print</span>(MyClass.static_method())  <span class="hljs-comment"># 静态方法</span>
</code></pre>
<h2 data-id="heading-8">四、描述符的应用场景</h2>
<h3 data-id="heading-9">1. ORM（对象关系映射）框架</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Field</span>:
    <span class="hljs-string">"""数据库字段描述符"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, field_type, nullable=<span class="hljs-literal">True</span>, default=<span class="hljs-literal">None</span></span>):
        self.field_type = field_type
        self.nullable = nullable
        self.default = default
        self.name = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set_name__</span>(<span class="hljs-params">self, owner, name</span>):
        self.name = name
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, obj, objtype</span>):
        <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> self
        <span class="hljs-comment"># 从实例的__dict__中获取值</span>
        <span class="hljs-keyword">return</span> obj.__dict__.get(self.name, self.default)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, obj, value</span>):
        <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> self.nullable:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span> cannot be null"</span>)
        <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(value, self.field_type):
            <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span> must be <span class="hljs-subst">{self.field_type}</span>"</span>)
        obj.__dict__[self.name] = value


<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelMeta</span>(<span class="hljs-title class_ inherited__">type</span>):
    <span class="hljs-string">"""元类，用于收集描述符"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">cls, name, bases, attrs</span>):
        <span class="hljs-comment"># 收集所有Field描述符</span>
        fields = {}
        <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> attrs.items():
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(value, Field):
                fields[key] = value
        
        attrs[<span class="hljs-string">'_fields'</span>] = fields
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().__new__(cls, name, bases, attrs)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(metaclass=ModelMeta):
    <span class="hljs-built_in">id</span> = Field(<span class="hljs-built_in">int</span>, nullable=<span class="hljs-literal">False</span>)
    name = Field(<span class="hljs-built_in">str</span>, nullable=<span class="hljs-literal">False</span>)
    email = Field(<span class="hljs-built_in">str</span>, default=<span class="hljs-string">""</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, **kwargs</span>):
        <span class="hljs-keyword">for</span> field_name, field <span class="hljs-keyword">in</span> self._fields.items():
            value = kwargs.get(field_name, field.default)
            <span class="hljs-built_in">setattr</span>(self, field_name, value)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_dict</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> {name: <span class="hljs-built_in">getattr</span>(self, name) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> self._fields}

<span class="hljs-comment"># 使用</span>
user = User(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>, name=<span class="hljs-string">"Alice"</span>)
<span class="hljs-built_in">print</span>(user.to_dict())  <span class="hljs-comment"># {'id': 1, 'name': 'Alice', 'email': ''}</span>
</code></pre>
<h3 data-id="heading-10">2. 类型检查和自动转换</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TypedAttribute</span>:
    <span class="hljs-string">"""类型检查和自动转换描述符"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, expected_type, converter=<span class="hljs-literal">None</span></span>):
        self.expected_type = expected_type
        self.converter = converter
        self.storage_name = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set_name__</span>(<span class="hljs-params">self, owner, name</span>):
        self.storage_name = <span class="hljs-string">f"_<span class="hljs-subst">{name}</span>"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, obj, objtype</span>):
        <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> self
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(obj, self.storage_name, <span class="hljs-literal">None</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, obj, value</span>):
        <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-built_in">setattr</span>(obj, self.storage_name, <span class="hljs-literal">None</span>)
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-comment"># 尝试类型转换</span>
        <span class="hljs-keyword">if</span> self.converter <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(value, self.expected_type):
            <span class="hljs-keyword">try</span>:
                value = self.converter(value)
            <span class="hljs-keyword">except</span> (ValueError, TypeError):
                <span class="hljs-keyword">pass</span>
        
        <span class="hljs-comment"># 类型检查</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(value, self.expected_type):
            <span class="hljs-keyword">raise</span> TypeError(
                <span class="hljs-string">f"Expected <span class="hljs-subst">{self.expected_type.__name__}</span>, "</span>
                <span class="hljs-string">f"got <span class="hljs-subst">{<span class="hljs-built_in">type</span>(value).__name__}</span>"</span>
            )
        
        <span class="hljs-built_in">setattr</span>(obj, self.storage_name, value)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
    port = TypedAttribute(<span class="hljs-built_in">int</span>, converter=<span class="hljs-built_in">int</span>)
    timeout = TypedAttribute(<span class="hljs-built_in">float</span>, converter=<span class="hljs-built_in">float</span>)
    debug = TypedAttribute(<span class="hljs-built_in">bool</span>, converter=<span class="hljs-built_in">bool</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, **kwargs</span>):
        <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> kwargs.items():
            <span class="hljs-built_in">setattr</span>(self, key, value)

cfg = Config(port=<span class="hljs-string">"8080"</span>, timeout=<span class="hljs-string">"30.5"</span>, debug=<span class="hljs-string">"true"</span>)
<span class="hljs-built_in">print</span>(cfg.port)    <span class="hljs-comment"># 8080 (int)</span>
<span class="hljs-built_in">print</span>(cfg.timeout) <span class="hljs-comment"># 30.5 (float)</span>
<span class="hljs-built_in">print</span>(cfg.debug)   <span class="hljs-comment"># True (bool)</span>
</code></pre>
<h2 data-id="heading-11">五、描述符的查找顺序</h2>
<h3 data-id="heading-12">Python的属性查找链</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span>:
    <span class="hljs-string">"""演示属性查找顺序"""</span>
    class_descriptor = <span class="hljs-string">"类属性（描述符）"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.instance_attr = <span class="hljs-string">"实例属性"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattr__</span>(<span class="hljs-params">self, name</span>):
        <span class="hljs-string">"""找不到属性时调用"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"__getattr__: <span class="hljs-subst">{name}</span>"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattribute__</span>(<span class="hljs-params">self, name</span>):
        <span class="hljs-string">"""总是首先调用"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"__getattribute__: <span class="hljs-subst">{name}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().__getattribute__(name)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataDescriptor</span>:
    <span class="hljs-string">"""数据描述符"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, obj, objtype</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据描述符"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__set__</span>(<span class="hljs-params">self, obj, value</span>):
        <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NonDataDescriptor</span>:
    <span class="hljs-string">"""非数据描述符"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__get__</span>(<span class="hljs-params">self, obj, objtype</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"非数据描述符"</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>:
    data_desc = DataDescriptor()
    non_data_desc = NonDataDescriptor()

obj = Test()
obj.non_data_desc = <span class="hljs-string">"实例属性覆盖非数据描述符"</span>

<span class="hljs-built_in">print</span>(obj.data_desc)  <span class="hljs-comment"># "数据描述符"（优先于实例属性）</span>
<span class="hljs-built_in">print</span>(obj.non_data_desc)  <span class="hljs-comment"># "实例属性覆盖非数据描述符"</span>
</code></pre>
<h2 data-id="heading-13">总结</h2>
<p>描述符协议是Python最强大的特性之一，它实现了：</p>
<ol>
<li><strong>属性访问控制</strong>：验证、转换、记录属性访问</li>
<li><strong>方法绑定机制</strong>：将函数转换为绑定方法</li>
<li><strong>内置装饰器基础</strong>：<code>@property</code>、<code>@classmethod</code>、<code>@staticmethod</code></li>
<li><strong>框架和库的核心</strong>：Django的Model字段、SQLAlchemy的Column等</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 开发代码规范（优化完善版）]]></title>    <link>https://juejin.cn/post/7591687981687193646</link>    <guid>https://juejin.cn/post/7591687981687193646</guid>    <pubDate>2026-01-05T08:00:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591687981687193646" data-draft-id="7591544356001071114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 开发代码规范（优化完善版）"/> <meta itemprop="keywords" content="Flutter,代码规范"/> <meta itemprop="datePublished" content="2026-01-05T08:00:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卖火箭的小男孩"/> <meta itemprop="url" content="https://juejin.cn/user/4457847613830523"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 开发代码规范（优化完善版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4457847613830523/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卖火箭的小男孩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T08:00:46.000Z" title="Mon Jan 05 2026 08:00:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 开发代码规范（优化完善版）</h2>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li><a href="#%E4%B8%80%E8%A7%84%E8%8C%83%E7%9B%AE%E6%A0%87" title="#%E4%B8%80%E8%A7%84%E8%8C%83%E7%9B%AE%E6%A0%87">一、规范目标</a></li>
<li><a href="#%E4%BA%8C%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6" title="#%E4%BA%8C%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6">二、目录结构规范（强制）</a></li>
<li><a href="#%E4%B8%89%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6" title="#%E4%B8%89%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6">三、命名规范（强制）</a></li>
<li><a href="#%E5%9B%9B%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6%E5%BB%BA%E8%AE%AE" title="#%E5%9B%9B%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6%E5%BB%BA%E8%AE%AE">四、代码风格规范（强制+建议）</a></li>
<li><a href="#%E4%BA%94%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6%E5%BB%BA%E8%AE%AE" title="#%E4%BA%94%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6%E5%BB%BA%E8%AE%AE">五、状态管理规范（强制+建议）</a></li>
<li><a href="#%E5%85%ADgetx%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6%E5%BB%BA%E8%AE%AE" title="#%E5%85%ADgetx%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6%E5%BB%BA%E8%AE%AE">六、GetX使用规范（强制+建议）</a></li>
<li><a href="#%E4%B8%83%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6" title="#%E4%B8%83%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6">七、性能优化规范（强制）</a></li>
<li><a href="#%E5%85%AB%E8%B5%84%E6%BA%90%E4%B8%8E%E9%85%8D%E7%BD%AE%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6" title="#%E5%85%AB%E8%B5%84%E6%BA%90%E4%B8%8E%E9%85%8D%E7%BD%AE%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6">八、资源与配置规范（强制）</a></li>
<li><a href="#%E4%B9%9D%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%B4%A8%E9%87%8F%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6%E5%BB%BA%E8%AE%AE" title="#%E4%B9%9D%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%B4%A8%E9%87%8F%E8%A7%84%E8%8C%83%E5%BC%BA%E5%88%B6%E5%BB%BA%E8%AE%AE">九、测试与质量规范（强制+建议）</a></li>
<li><a href="#%E5%8D%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%BB%BA%E8%AE%AE" title="#%E5%8D%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%BB%BA%E8%AE%AE">十、最佳实践（建议）</a></li>
<li><a href="#%E5%8D%81%E4%B8%80%E8%A7%84%E8%8C%83%E8%90%BD%E5%9C%B0%E4%B8%8E%E7%BB%B4%E6%8A%A4" title="#%E5%8D%81%E4%B8%80%E8%A7%84%E8%8C%83%E8%90%BD%E5%9C%B0%E4%B8%8E%E7%BB%B4%E6%8A%A4">十一、规范落地与维护</a></li>
</ul>
<h3 data-id="heading-2">一、规范目标</h3>
<ol>
<li><strong>统一团队开发风格</strong>，降低协作成本，提升代码可读性、可维护性；</li>
<li><strong>规避常见性能问题</strong>，保障应用流畅性与稳定性；</li>
<li>符合 <strong>Dart/Flutter 官方最佳实践</strong>，兼容生态工具链（静态分析、测试、文档生成）；</li>
<li>明确<strong>边界规则</strong>（强制约束+建议规范），平衡规范严谨性与开发效率。</li>
</ol>
<h3 data-id="heading-3">二、目录结构规范（强制）</h3>
<p>基于 Flutter 工程特性，采用 <strong>功能+分层</strong> 混合结构，核心目录集中在 <code>lib/</code> 下。</p>
<h4 data-id="heading-4">项目结构示例</h4>
<pre><code class="hljs language-perl" lang="perl">lib/
├── app/                  <span class="hljs-comment"># 应用入口与全局配置</span>
│   ├── app.dart          <span class="hljs-comment"># 根组件（MyApp）</span>
│   ├── routes.dart       <span class="hljs-comment"># 路由配置（路由表+守卫）</span>
│   ├── theme.dart        <span class="hljs-comment"># 主题配置（亮色/暗色模式、全局样式）</span>
│   └── config.dart       <span class="hljs-comment"># 全局常量（环境变量、接口域名、第三方密钥）</span>
├── core/                 <span class="hljs-comment"># 核心能力层（通用业务+基础依赖）</span>
│   ├── network/          <span class="hljs-comment"># 网络请求（封装、拦截器、接口定义）</span>
│   │   ├── api.dart      <span class="hljs-comment"># 接口方法（按业务模块拆分，如 user_api.dart）</span>
│   │   ├── client.dart   <span class="hljs-comment"># dio 实例封装（拦截器、超时配置）</span>
│   │   └── model/        <span class="hljs-comment"># 接口模型（请求/响应实体，用 freezed/json_serializable）</span>
│   ├── storage/          <span class="hljs-comment"># 本地存储（统一封装）</span>
│   │   ├── sp_utils.dart <span class="hljs-comment"># SharedPreferences 封装</span>
│   │   └── hive_utils.dart <span class="hljs-comment"># Hive 数据库封装</span>
│   ├── <span class="hljs-keyword">state</span>/            <span class="hljs-comment"># 全局状态管理（如 AppBloc、UserProvider）</span>
│   └── utils/            <span class="hljs-comment"># 工具类（无业务依赖）</span>
│       ├── log_utils.dart <span class="hljs-comment"># 日志工具（替代 print）</span>
│       ├── toast_utils.dart <span class="hljs-comment"># 提示工具</span>
│       └── date_utils.dart <span class="hljs-comment"># 日期工具</span>
├── features/             <span class="hljs-comment"># 业务功能模块（按功能拆分，内部自治）</span>
│   ├── home/             <span class="hljs-comment"># 首页模块</span>
│   │   ├── presentation/ <span class="hljs-comment"># UI 层（页面+组件）</span>
│   │   │   ├── home_page.dart <span class="hljs-comment"># 页面组件</span>
│   │   │   └── widgets/  <span class="hljs-comment"># 模块内私有组件</span>
│   │   ├── <span class="hljs-keyword">state</span>/        <span class="hljs-comment"># 模块内状态（如 HomeBloc、HomeProvider）</span>
│   │   └── domain/       <span class="hljs-comment"># 业务逻辑（实体、仓库接口）</span>
│   └── user/             <span class="hljs-comment"># 用户模块（登录/注册/个人中心）</span>
│       ├── presentation/
│       ├── <span class="hljs-keyword">state</span>/
│       └── domain/
├── common/               <span class="hljs-comment"># 全局公共资源</span>
│   ├── widgets/          <span class="hljs-comment"># 全局复用组件（如 Button、Input、EmptyView）</span>
│   ├── res/              <span class="hljs-comment"># 静态资源（集中管理，避免硬编码）</span>
│   │   ├── images.dart   <span class="hljs-comment"># 图片路径常量（AssetImage 封装）</span>
│   │   ├── strings.dart  <span class="hljs-comment"># 字符串常量（支持国际化）</span>
│   │   ├── colors.dart   <span class="hljs-comment"># 颜色常量（主题色+功能色）</span>
│   │   └── dimens.dart   <span class="hljs-comment"># 尺寸常量（间距、字体大小）</span>
│   └── styles/           <span class="hljs-comment"># 全局样式（文本样式、圆角、阴影）</span>
└── main.dart             <span class="hljs-comment"># 程序入口（仅初始化 App 根组件）</span>
</code></pre>
<h4 data-id="heading-5">目录规范说明</h4>
<ol>
<li><strong>禁止</strong>在 <code>lib/</code> 根目录直接存放业务代码（仅保留 <code>main.dart</code>）；</li>
<li><code>features/</code> 按业务模块拆分，模块内遵循 <strong>UI-状态-业务</strong> 分层，确保高内聚低耦合；</li>
<li>公共组件/工具需区分 <strong>全局（common）</strong> 与 <strong>模块私有（features/xxx/widgets）</strong>，避免滥用全局；</li>
<li>静态资源（图片、字符串等）必须通过常量类引用，<strong>禁止硬编码</strong>（如 <code>Image.asset('images/icon.png')</code> → <code>Image.asset(Images.icon)</code>）。</li>
</ol>
<h3 data-id="heading-6">三、命名规范（强制）</h3>
<p>完全遵循 Dart 官方命名约定，补充 Flutter 特有场景规则：</p>



























































<table><thead><tr><th>类型</th><th>命名规则</th><th>示例</th><th>禁止示例</th></tr></thead><tbody><tr><td>类（Class/Widget）</td><td>大驼峰（PascalCase），名词/名词短语</td><td><code>HomePage</code>、<code>CustomButton</code>、<code>UserModel</code></td><td><code>home_page</code>、<code>custom_button</code></td></tr><tr><td>函数/方法</td><td>小驼峰（camelCase），动词/动词短语</td><td><code>getUserInfo()</code>、<code>showToast()</code></td><td><code>get_user_info()</code>、<code>ShowToast()</code></td></tr><tr><td>变量/参数</td><td>小驼峰（camelCase），名词/名词短语</td><td><code>userName</code>、<code>isLogin</code>、<code>itemCount</code></td><td><code>user_name</code>、<code>IsLogin</code></td></tr><tr><td>常量（const/final）</td><td>全大写+下划线（UPPER_SNAKE_CASE）</td><td><code>const MAX_COUNT = 10;</code>、<code>final API_BASE_URL = 'xxx'</code></td><td><code>maxCount</code>、<code>apiBaseUrl</code></td></tr><tr><td>枚举（enum）</td><td>枚举名：大驼峰；枚举值：小驼峰</td><td><code>enum LoginType { phone, wechat, qq }</code></td><td><code>enum login_type { Phone, Wechat }</code></td></tr><tr><td>路由名称</td><td>小写+下划线，格式：<code>/模块/页面</code></td><td><code>/user/login</code>、<code>/home/index</code></td><td><code>/User/Login</code>、<code>homeLogin</code></td></tr><tr><td>文件名</td><td>小写+下划线（snake_case），与类名对应</td><td><code>home_page.dart</code>（对应 <code>HomePage</code>）</td><td><code>HomePage.dart</code>、<code>homePage.dart</code></td></tr><tr><td>包名（package）</td><td>小写+下划线，全小写无大写</td><td><code>package:my_app/features/user</code></td><td><code>package:MyApp/Features/User</code></td></tr></tbody></table>
<h4 data-id="heading-7">特殊命名补充</h4>
<ol>
<li><strong>布尔变量</strong>建议前缀：<code>is</code>、<code>has</code>、<code>can</code>、<code>should</code>（如 <code>isVisible</code>、<code>hasPermission</code>）；</li>
<li><strong>回调函数</strong>命名：后缀 <code>Callback</code>，如 <code>OnLoginCallback</code>、<code>OnItemClickCallback</code>；</li>
<li><strong>状态管理</strong>相关：Bloc 类名后缀 <code>Bloc</code>（如 <code>CounterBloc</code>），状态类后缀 <code>State</code>（如 <code>CounterState</code>）；</li>
<li><strong>GetX控制器</strong>：类名后缀 <code>Controller</code>（如 <code>HomeController</code>、<code>UserController</code>）；</li>
<li>避免使用<strong>缩写</strong>（除非是通用缩写如 <code>API</code>、<code>UI</code>），<strong>禁止拼音</strong>命名（如 <code>shouyePage</code> → <code>homePage</code>）。</li>
</ol>
<h3 data-id="heading-8">四、代码风格规范（强制+建议）</h3>
<h4 data-id="heading-9">4.1 基础格式（强制）</h4>
<ol>
<li><strong>缩进</strong>：2 个空格（Dart 官方标准），禁止使用 Tab；</li>
<li><strong>行宽</strong>：单行长不超过 120 字符（超出需换行），IDE 开启自动换行；</li>
<li><strong>空行</strong>：
<ul>
<li>类/函数之间留 1 个空行；</li>
<li>函数内部逻辑块之间留 1 个空行；</li>
<li>避免连续空行（最多 1 个）；</li>
</ul>
</li>
<li><strong>括号</strong>：
<ul>
<li>类、函数、条件语句的左括号与声明在同一行，右括号单独成行；</li>
<li>单行条件语句可省略括号（但逻辑复杂时必须加）；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 正确</span>
<span class="hljs-keyword">if</span> (isLogin) {
  navigateToHome();
}

<span class="hljs-comment">// 允许（单行简单逻辑）</span>
<span class="hljs-keyword">if</span> (isLogin) navigateToHome();

<span class="hljs-comment">// 错误</span>
<span class="hljs-keyword">if</span> (isLogin)
{
  navigateToHome();
}
</code></pre>
</li>
<li><strong>分号</strong>：每条语句必须加分号（Dart 不是 JavaScript）；</li>
<li><strong>逗号</strong>：对象/数组最后一个元素后建议加逗号（IDE 自动格式化时更整洁）；
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> user = User(
  name: <span class="hljs-string">'张三'</span>,
  age: <span class="hljs-number">20</span>, <span class="hljs-comment">// 末尾逗号建议保留</span>
);
</code></pre>
</li>
</ol>
<h4 data-id="heading-10">4.2 Widget 开发规范（强制）</h4>
<ol>
<li><strong>优先使用 StatelessWidget</strong>：无状态组件性能更优，仅当需要维护状态时使用 StatefulWidget；</li>
<li><strong>Widget 拆分原则</strong>：
<ul>
<li>单个 Widget 代码不超过 100 行，超出则拆分为子 Widget（私有组件放 <code>widgets/</code> 目录）；</li>
<li>重复出现的 UI 片段（如列表项、按钮）必须提取为公共组件；</li>
<li>避免嵌套过深（建议不超过 4 层），使用 <code>Padding</code>/<code>SizedBox</code> 替代嵌套 <code>Container</code>，用 <code>Wrap</code> 替代多层 <code>Row/Column</code>；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 错误（嵌套过深）</span>
Container(
  child: Padding(
    padding: EdgeInsets.all(<span class="hljs-number">16</span>),
    child: Row(
      children: [
        Container(
          child: Text(<span class="hljs-string">'标题'</span>),
        ),
      ],
    ),
  ),
);

<span class="hljs-comment">// 正确（拆分+简化嵌套）</span>
Padding(
  padding: EdgeInsets.all(Dimens.p16),
  child: Row(
    children: [
      _buildTitleText(),
    ],
  ),
);

Widget _buildTitleText() =&gt; Text(Strings.title);
</code></pre>
</li>
<li><strong>build 方法规范</strong>：
<ul>
<li>禁止在 <code>build</code> 中执行耗时操作（如网络请求、数据库查询、复杂计算）；</li>
<li>禁止在 <code>build</code> 中创建临时对象（如 <code>List</code>、<code>Map</code>、<code>Style</code>），需缓存为 <code>final</code> 变量或提取为常量；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 错误（build 中创建 List）</span>
<span class="hljs-meta">@override</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> ListView(
    children: [Text(<span class="hljs-string">'1'</span>), Text(<span class="hljs-string">'2'</span>)], <span class="hljs-comment">// 每次 build 重建 List</span>
  );
}

<span class="hljs-comment">// 正确（缓存为 final）</span>
<span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; _listItems = [Text(<span class="hljs-string">'1'</span>), Text(<span class="hljs-string">'2'</span>)];

<span class="hljs-meta">@override</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> ListView(children: _listItems);
}
</code></pre>
</li>
<li><strong>const 构造函数</strong>：
<ul>
<li>无状态 Widget 且构造参数均为常量时，必须使用 <code>const</code> 构造函数（减少重建开销）；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 正确</span>
<span class="hljs-keyword">const</span> CustomButton({<span class="hljs-keyword">super</span>.key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.onTap});

<span class="hljs-comment">// 调用时也需加 const（除非父组件非 const）</span>
<span class="hljs-keyword">const</span> CustomButton(onTap: _handleTap);
</code></pre>
</li>
<li><strong>命名参数</strong>：
<ul>
<li>Widget 构造函数仅使用命名参数（<code>{}</code> 包裹），必填参数加 <code>required</code> 关键字；</li>
<li>参数顺序：核心功能参数（如 <code>onTap</code>、<code>data</code>）在前，样式参数（如 <code>color</code>、<code>size</code>）在后；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 正确</span>
<span class="hljs-keyword">const</span> CustomButton({
  <span class="hljs-keyword">super</span>.key,
  <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.onTap, <span class="hljs-comment">// 必填参数在前</span>
  <span class="hljs-keyword">this</span>.text = <span class="hljs-string">''</span>,
  <span class="hljs-keyword">this</span>.color = Colors.blue, <span class="hljs-comment">// 样式参数在后</span>
  <span class="hljs-keyword">this</span>.radius = <span class="hljs-number">8.0</span>,
});
</code></pre>
</li>
</ol>
<h4 data-id="heading-11">4.3 语法规范（强制）</h4>
<ol>
<li><strong>Null Safety 强制启用</strong>：
<ul>
<li>禁止使用 <code>dynamic</code> 类型（除非与第三方库兼容必须使用）；</li>
<li>可空类型必须显式声明（<code>String?</code>），非空类型必须初始化（或用 <code>late</code> 延迟初始化）；</li>
<li>避免滥用 <code>!</code> 空断言（优先用 <code>??</code>、<code>?.</code>、<code>if (xxx != null)</code> 安全访问）；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 错误</span>
<span class="hljs-built_in">String</span> name; <span class="hljs-comment">// 非空类型未初始化</span>
<span class="hljs-built_in">print</span>(user!.name); <span class="hljs-comment">// 滥用 ! 断言</span>

<span class="hljs-comment">// 正确</span>
<span class="hljs-built_in">String?</span> name;
<span class="hljs-built_in">print</span>(user?.name ?? <span class="hljs-string">'默认名称'</span>); <span class="hljs-comment">// 安全访问+默认值</span>
</code></pre>
</li>
<li><strong>集合使用</strong>：
<ul>
<li>优先使用不可变集合（<code>const List</code>、<code>const Map</code>），可变集合需显式声明 <code>var</code> 或 <code>List&lt;T&gt;</code>；</li>
<li>禁止使用 <code>List()</code> 无参构造，用 <code>[]</code> 替代（更简洁）；</li>
</ul>
</li>
<li><strong>循环与条件</strong>：
<ul>
<li>简单条件用 <code>??</code>、<code>?.</code>、<code>if-else</code>，复杂条件提取为布尔变量（提升可读性）；</li>
<li>列表遍历优先用 <code>forEach</code>（简单逻辑）或 <code>map</code>（转换场景），避免嵌套循环；</li>
</ul>
</li>
<li><strong>扩展方法</strong>：
<ul>
<li>复用逻辑优先用 <code>extension</code> 扩展（如 <code>StringExtension</code>、<code>DateTimeExtension</code>），替代工具类静态方法；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 正确（扩展方法）</span>
<span class="hljs-keyword">extension</span> StringExtension <span class="hljs-keyword">on</span> <span class="hljs-built_in">String</span> {
  <span class="hljs-built_in">String</span> capitalize() =&gt; isEmpty ? <span class="hljs-keyword">this</span> : <span class="hljs-string">'<span class="hljs-subst">${<span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>].toUpperCase()}</span><span class="hljs-subst">${substring(<span class="hljs-number">1</span>)}</span>'</span>;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-string">'hello'</span>.capitalize(); <span class="hljs-comment">// 比 StringUtils.capitalize('hello') 更简洁</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-12">4.4 注释规范（强制+建议）</h4>
<ol>
<li><strong>文档注释（强制）</strong>：
<ul>
<li>公开类、函数、常量必须加文档注释（<code>///</code> 开头，支持 DartDoc 生成文档）；</li>
<li>注释需说明 <strong>功能用途</strong> + <strong>参数含义</strong> + <strong>返回值</strong> + <strong>异常场景</strong>（必要时）；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">自定义按钮组件</span></span>
<span class="hljs-comment">/// </span>
<span class="hljs-comment">/// <span class="markdown">[onTap]：点击回调（必填）</span></span>
<span class="hljs-comment">/// <span class="markdown">[text]：按钮文本（默认空字符串）</span></span>
<span class="hljs-comment">/// <span class="markdown">[color]：按钮背景色（默认蓝色）</span></span>
<span class="hljs-comment">/// <span class="markdown">返回：无</span></span>
<span class="hljs-keyword">const</span> CustomButton({
  <span class="hljs-keyword">super</span>.key,
  <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.onTap,
  <span class="hljs-keyword">this</span>.text = <span class="hljs-string">''</span>,
  <span class="hljs-keyword">this</span>.color = Colors.blue,
});
</code></pre>
</li>
<li><strong>单行注释（建议）</strong>：
<ul>
<li>复杂逻辑、特殊处理（如兼容适配、临时方案）需加单行注释（<code>//</code> 开头）；</li>
<li>注释说明 <strong>为什么这么做</strong>，而非 <strong>做了什么</strong>（代码本身应体现做了什么）；</li>
</ul>
</li>
<li><strong>注释禁忌</strong>：
<ul>
<li>禁止注释无用代码（直接删除，版本控制可回溯）；</li>
<li>禁止冗余注释（如 <code>// 定义名称变量</code> → <code>String name;</code>）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-13">五、状态管理规范（强制+建议）</h3>
<h4 data-id="heading-14">5.1 方案选择（建议）</h4>
<p>根据项目复杂度选择合适的状态管理方案，团队统一使用一种核心方案：</p>






























<table><thead><tr><th>项目规模</th><th>推荐方案</th><th>适用场景</th></tr></thead><tbody><tr><td>小型项目</td><td>StatefulWidget + setState</td><td>仅需局部状态（如单个页面开关、计数器）</td></tr><tr><td>中型项目</td><td>Provider/Riverpod</td><td>跨组件状态共享（如用户信息、主题）</td></tr><tr><td>大型项目</td><td>Bloc/Cubit</td><td>复杂业务逻辑（如表单提交、流程控制）</td></tr><tr><td>快速迭代</td><td><strong>GetX（推荐使用）</strong></td><td>个人项目或小团队，需简化模板代码</td></tr></tbody></table>
<h4 data-id="heading-15">5.2 分层原则（强制）</h4>
<p>无论使用哪种方案，必须遵循 <strong>UI 层-状态层-数据层</strong> 分离：</p>
<ol>
<li><strong>UI 层（Widget）</strong>：仅负责渲染，不包含业务逻辑，通过状态层获取数据；</li>
<li><strong>状态层（Bloc/Provider/Controller）</strong>：管理状态，处理业务逻辑，不直接操作数据源；</li>
<li><strong>数据层（Repository/API）</strong>：负责数据获取（网络、本地存储），提供统一接口给状态层；</li>
</ol>
<h4 data-id="heading-16">5.3 状态管理禁忌（强制）</h4>
<ol>
<li>禁止在 Widget 中直接调用网络/存储接口（必须通过数据层）；</li>
<li>禁止全局状态滥用（优先使用局部状态，跨组件共享才用全局状态）；</li>
<li>禁止状态层持有 Widget 引用（如 <code>BuildContext</code>），通过回调/事件通信；</li>
<li><strong>Bloc 规范</strong>：
<ul>
<li>事件（Event）命名后缀 <code>Event</code>（如 <code>LoginEvent</code>），状态（State）命名后缀 <code>State</code>；</li>
<li>一个 Bloc 对应一个业务场景，避免超大 Bloc（拆分多个子 Bloc）；</li>
<li>状态必须是不可变的（使用 <code>freezed</code> 生成不可变类）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-17">六、GetX使用规范（强制+建议）</h3>
<h4 data-id="heading-18">6.1 项目结构适配</h4>
<p>当使用GetX时，建议在<code>features/</code>模块内调整目录结构，遵循GetX推荐的三层架构：</p>
<pre><code class="hljs language-bash" lang="bash">features/user/
├── data/                  <span class="hljs-comment"># 数据层</span>
│   ├── models/           <span class="hljs-comment"># 数据模型</span>
│   ├── repositories/     <span class="hljs-comment"># 数据仓库</span>
│   └── datasources/      <span class="hljs-comment"># 数据源（本地/远程）</span>
├── domain/               <span class="hljs-comment"># 业务逻辑层</span>
│   ├── usecases/        <span class="hljs-comment"># 用例</span>
│   └── repositories/    <span class="hljs-comment"># 仓库接口</span>
└── presentation/         <span class="hljs-comment"># 表现层</span>
    ├── controllers/     <span class="hljs-comment"># 控制器</span>
    ├── views/          <span class="hljs-comment"># 页面视图</span>
    ├── widgets/        <span class="hljs-comment"># 私有组件</span>
    └── bindings/       <span class="hljs-comment"># 绑定类</span>
</code></pre>
<h4 data-id="heading-19">6.2 Controller规范</h4>
<ol>
<li>
<p><strong>控制器命名与位置</strong>：</p>
<ul>
<li>控制器类名后缀必须为<code>Controller</code>（如<code>UserController</code>）；</li>
<li>控制器文件存放在对应模块的<code>presentation/controllers/</code>目录；</li>
<li>每个页面/功能对应一个控制器，避免超大控制器；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// features/user/presentation/controllers/user_controller.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetxController</span> </span>{
  <span class="hljs-comment">// 状态变量</span>
  <span class="hljs-keyword">final</span> RxString userName = <span class="hljs-string">''</span>.obs;
  <span class="hljs-keyword">final</span> RxBool isLoading = <span class="hljs-keyword">false</span>.obs;
  <span class="hljs-keyword">final</span> RxList&lt;User&gt; userList = &lt;User&gt;[].obs;
  
  <span class="hljs-comment">// 计算属性</span>
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> formattedName =&gt; userName.value.toUpperCase();
  
  <span class="hljs-comment">// 生命周期</span>
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onInit() {
    <span class="hljs-keyword">super</span>.onInit();
    loadUserData();
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onClose() {
    <span class="hljs-comment">// 清理资源</span>
    <span class="hljs-keyword">super</span>.onClose();
  }
  
  <span class="hljs-comment">// 方法</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; loadUserData() <span class="hljs-keyword">async</span> {
    isLoading.value = <span class="hljs-keyword">true</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> users = <span class="hljs-keyword">await</span> userRepository.getUsers();
      userList.assignAll(users);
    } <span class="hljs-keyword">catch</span> (e) {
      Get.snackbar(<span class="hljs-string">'错误'</span>, <span class="hljs-string">'加载用户数据失败'</span>);
    } <span class="hljs-keyword">finally</span> {
      isLoading.value = <span class="hljs-keyword">false</span>;
    }
  }
}
</code></pre>
</li>
<li>
<p><strong>状态管理</strong>：</p>
<ul>
<li>使用<code>.obs</code>创建响应式变量，变量名使用<code>Rx</code>前缀约定；</li>
<li>私有状态使用<code>_</code>前缀，公开状态提供getter方法；</li>
<li>使用<code>update()</code>方法触发UI更新（非响应式变量变更时）；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetxController</span> </span>{
  <span class="hljs-comment">// 响应式变量</span>
  <span class="hljs-keyword">final</span> RxInt _counter = <span class="hljs-number">0.</span>obs;
  <span class="hljs-built_in">int</span> <span class="hljs-keyword">get</span> counter =&gt; _counter.value;
  
  <span class="hljs-comment">// 非响应式变量</span>
  <span class="hljs-built_in">String</span> _searchKeyword = <span class="hljs-string">''</span>;
  
  <span class="hljs-keyword">void</span> increment() {
    _counter.value++;
  }
  
  <span class="hljs-keyword">void</span> updateKeyword(<span class="hljs-built_in">String</span> keyword) {
    _searchKeyword = keyword;
    update(); <span class="hljs-comment">// 手动触发更新</span>
  }
}
</code></pre>
</li>
</ol>
<h4 data-id="heading-20">6.3 路由管理规范</h4>
<ol>
<li>
<p><strong>路由定义</strong>：</p>
<ul>
<li>使用GetX的路由管理系统，集中管理路由；</li>
<li>路由名称使用小写+下划线格式，与页面路径对应；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// app/routes.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppRoutes</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> splash = <span class="hljs-string">'/'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> home = <span class="hljs-string">'/home'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> login = <span class="hljs-string">'/login'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> userDetail = <span class="hljs-string">'/user/detail'</span>;
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;GetPage&gt; pages = [
    GetPage(
      name: splash,
      page: () =&gt; SplashScreen(),
      binding: SplashBinding(),
    ),
    GetPage(
      name: home,
      page: () =&gt; HomeScreen(),
      bindings: [HomeBinding(), UserBinding()],
      transition: Transition.fadeIn,
    ),
    GetPage(
      name: userDetail,
      page: () =&gt; UserDetailScreen(),
      binding: UserDetailBinding(),
      transition: Transition.rightToLeft,
    ),
  ];
}
</code></pre>
</li>
<li>
<p><strong>路由跳转</strong>：</p>
<ul>
<li>使用GetX提供的路由方法，保持统一；</li>
<li>带参数跳转时使用<code>arguments</code>传递对象；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 页面跳转</span>
Get.toNamed(AppRoutes.home);
Get.offNamed(AppRoutes.login); <span class="hljs-comment">// 关闭当前页面</span>
Get.offAllNamed(AppRoutes.home); <span class="hljs-comment">// 关闭所有页面</span>

<span class="hljs-comment">// 带参数跳转</span>
Get.toNamed(
  AppRoutes.userDetail,
  arguments: User(id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'张三'</span>),
  parameters: {<span class="hljs-string">'from'</span>: <span class="hljs-string">'home'</span>}, <span class="hljs-comment">// URL参数</span>
);

<span class="hljs-comment">// 获取参数</span>
<span class="hljs-keyword">final</span> user = Get.arguments <span class="hljs-keyword">as</span> User;
<span class="hljs-keyword">final</span> from = Get.parameters[<span class="hljs-string">'from'</span>];
</code></pre>
</li>
</ol>
<h4 data-id="heading-21">6.4 依赖管理规范</h4>
<ol>
<li>
<p><strong>Binding类使用</strong>：</p>
<ul>
<li>每个控制器对应一个Binding类，处理依赖注入；</li>
<li>Binding类名后缀为<code>Binding</code>，与控制器对应；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// features/user/presentation/bindings/user_binding.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserBinding</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bindings</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dependencies() {
    <span class="hljs-comment">// 懒加载注入</span>
    Get.lazyPut&lt;UserRepository&gt;(
      () =&gt; UserRepositoryImpl(Get.find&lt;ApiClient&gt;()),
      fenix: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 页面关闭后不会被销毁，下次进入时重用</span>
    );
    
    <span class="hljs-comment">// 立即注入</span>
    Get.put&lt;UserController&gt;(
      UserController(Get.find&lt;UserRepository&gt;()),
      permanent: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 全局单例</span>
    );
  }
}
</code></pre>
</li>
<li>
<p><strong>依赖获取</strong>：</p>
<ul>
<li>使用<code>Get.find&lt;T&gt;()</code>获取依赖，避免直接new对象；</li>
<li>在控制器构造函数中注入依赖；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetxController</span> </span>{
  <span class="hljs-keyword">final</span> UserRepository userRepository;
  
  UserController(<span class="hljs-keyword">this</span>.userRepository);
  
  <span class="hljs-comment">// 或者使用Get.find()延迟获取</span>
  UserRepository <span class="hljs-keyword">get</span> repo =&gt; Get.find&lt;UserRepository&gt;();
}
</code></pre>
</li>
</ol>
<h4 data-id="heading-22">6.5 Widget使用规范</h4>
<ol>
<li>
<p><strong>响应式Widget</strong>：</p>
<ul>
<li>使用<code>Obx()</code>、<code>GetX()</code>或<code>GetBuilder</code>包裹响应式部分；</li>
<li>最小化响应范围，避免整个页面重建；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProfile</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> UserController controller = Get.find&lt;UserController&gt;();
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        <span class="hljs-comment">// 使用Obx响应式更新</span>
        Obx(() =&gt; Text(
          <span class="hljs-string">'用户数: <span class="hljs-subst">${controller.userCount.value}</span>'</span>,
          style: TextStyle(
            color: controller.isLoading.value 
              ? Colors.grey 
              : Colors.black,
          ),
        )),
        
        <span class="hljs-comment">// 使用GetBuilder手动更新</span>
        GetBuilder&lt;UserController&gt;(
          builder: (controller) {
            <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'用户名: <span class="hljs-subst">${controller.userName}</span>'</span>);
          },
        ),
        
        <span class="hljs-comment">// 列表使用Obx</span>
        Obx(() =&gt; ListView.builder(
          shrinkWrap: <span class="hljs-keyword">true</span>,
          itemCount: controller.userList.length,
          itemBuilder: (context, index) {
            <span class="hljs-keyword">final</span> user = controller.userList[index];
            <span class="hljs-keyword">return</span> UserItem(user: user);
          },
        )),
      ],
    );
  }
}
</code></pre>
</li>
<li>
<p><strong>页面Widget规范</strong>：</p>
<ul>
<li>页面继承<code>GetView&lt;T&gt;</code>获取控制器；</li>
<li>使用<code>Get.put()</code>初始化控制器；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// features/user/presentation/views/user_screen.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserScreen</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetView</span>&lt;<span class="hljs-title">UserController</span>&gt; </span>{
  <span class="hljs-keyword">const</span> UserScreen({<span class="hljs-keyword">super</span>.key});
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 自动获取控制器</span>
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: Obx(() =&gt; Text(<span class="hljs-string">'用户(<span class="hljs-subst">${controller.userCount}</span>)'</span>)),
      ),
      body: controller.obx(
        (state) =&gt; _buildUserList(),
        onLoading: <span class="hljs-keyword">const</span> CircularProgressIndicator(),
        onError: (error) =&gt; ErrorView(error: error),
        onEmpty: <span class="hljs-keyword">const</span> EmptyView(),
      ),
    );
  }
  
  Widget _buildUserList() {
    <span class="hljs-keyword">return</span> RefreshIndicator(
      onRefresh: controller.loadUsers,
      child: ListView.builder(
        itemCount: controller.userList.length,
        itemBuilder: (context, index) {
          <span class="hljs-keyword">return</span> UserItem(user: controller.userList[index]);
        },
      ),
    );
  }
}
</code></pre>
</li>
</ol>
<h4 data-id="heading-23">6.6 工具类使用规范</h4>
<ol>
<li>
<p><strong>GetX工具类</strong>：</p>
<ul>
<li>统一使用GetX提供的工具方法；</li>
<li>禁止混用原生方法与GetX方法；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 正确</span>
Get.snackbar(<span class="hljs-string">'标题'</span>, <span class="hljs-string">'消息内容'</span>);
Get.dialog(ConfirmDialog());
Get.bottomSheet(OptionsSheet());
Get.toNamed(<span class="hljs-string">'/detail'</span>);

<span class="hljs-comment">// 避免混用</span>
<span class="hljs-comment">// 错误：混用GetX和原生方法</span>
showDialog(context: context, builder: ...); <span class="hljs-comment">// 避免使用</span>
Navigator.push(context, ...); <span class="hljs-comment">// 避免使用</span>
</code></pre>
</li>
<li>
<p><strong>国际化</strong>：</p>
<ul>
<li>使用GetX的国际化方案；</li>
<li>统一管理翻译文件；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用</span>
Text(<span class="hljs-string">'title'</span>.tr);
Text(<span class="hljs-string">'greeting'</span>.trParams({<span class="hljs-string">'name'</span>: <span class="hljs-string">'张三'</span>}));

<span class="hljs-comment">// 切换语言</span>
Get.updateLocale(Locale(<span class="hljs-string">'zh'</span>, <span class="hljs-string">'CN'</span>));
</code></pre>
</li>
</ol>
<h4 data-id="heading-24">6.7 GetX最佳实践</h4>
<ol>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>使用<code>worker</code>监听状态变化，执行副作用；</li>
<li>使用<code>debounce</code>、<code>interval</code>避免频繁更新；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SearchController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetxController</span> </span>{
  <span class="hljs-keyword">final</span> RxString searchKeyword = <span class="hljs-string">''</span>.obs;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onInit() {
    <span class="hljs-keyword">super</span>.onInit();
    
    <span class="hljs-comment">// 监听搜索关键词变化，延迟500ms执行搜索</span>
    debounce(
      searchKeyword,
      (_) =&gt; performSearch(),
      time: <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">500</span>),
    );
    
    <span class="hljs-comment">// 每隔1秒执行一次</span>
    interval(
      searchKeyword,
      (_) =&gt; logSearch(),
      time: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>),
    );
  }
  
  <span class="hljs-keyword">void</span> performSearch() {
    <span class="hljs-comment">// 执行搜索逻辑</span>
  }
}
</code></pre>
</li>
<li>
<p><strong>状态持久化</strong>：</p>
<ul>
<li>使用<code>GetStorage</code>进行轻量级数据持久化；</li>
<li>重要数据使用<code>shared_preferences</code>或<code>hive</code>；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> box = GetStorage();

<span class="hljs-comment">// 保存数据</span>
box.write(<span class="hljs-string">'user_token'</span>, <span class="hljs-string">'abc123'</span>);

<span class="hljs-comment">// 读取数据</span>
<span class="hljs-built_in">String</span> token = box.read(<span class="hljs-string">'user_token'</span>);

<span class="hljs-comment">// 监听数据变化</span>
box.listen(() {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'数据发生变化'</span>);
});
</code></pre>
</li>
<li>
<p><strong>错误处理</strong>：</p>
<ul>
<li>统一使用GetX的错误处理机制；</li>
<li>全局异常捕获；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 全局配置</span>
<span class="hljs-keyword">void</span> main() {
  <span class="hljs-comment">// 全局错误处理</span>
  Get.config(
    enableLog: <span class="hljs-keyword">true</span>,
    defaultPopGesture: <span class="hljs-keyword">true</span>,
    defaultTransition: Transition.cupertino,
  );
  
  <span class="hljs-comment">// 异常处理</span>
  FlutterError.onError = (details) {
    Get.snackbar(<span class="hljs-string">'错误'</span>, details.exception.toString());
  };
  
  runApp(MyApp());
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-25">七、性能优化规范（强制）</h3>
<h4 data-id="heading-26">7.1 渲染优化</h4>
<ol>
<li><strong>列表优化</strong>：
<ul>
<li>长列表必须使用 <code>ListView.builder</code>/<code>GridView.builder</code>（懒加载），禁止使用 <code>ListView(children: [...])</code>（一次性加载所有子项）；</li>
<li>列表项高度固定时，设置 <code>itemExtent</code> 提升性能；</li>
</ul>
</li>
<li><strong>图片优化</strong>：
<ul>
<li>图片资源按分辨率适配（<code>mipmap-mdpi</code>/<code>mipmap-hdpi</code> 等），避免使用超大图；</li>
<li>网络图片使用缓存（如 <code>cached_network_image</code>），设置占位图/错误图；</li>
<li>本地图片使用 <code>AssetImage</code> 而非 <code>FileImage</code>，并通过 <code>images.dart</code> 常量引用；</li>
</ul>
</li>
<li><strong>减少重绘</strong>：
<ul>
<li>频繁变化的 Widget 用 <code>RepaintBoundary</code> 包裹（隔离重绘区域）；</li>
<li>避免在 <code>AnimatedBuilder</code> 外部构建无关 Widget；</li>
</ul>
</li>
</ol>
<h4 data-id="heading-27">7.2 内存优化</h4>
<ol>
<li><strong>资源释放</strong>：
<ul>
<li>订阅流（Stream）、Bloc 必须在 <code>dispose</code> 中取消订阅（使用 <code>cancel()</code> 或 <code>BlocListener</code> 自动管理）；</li>
<li>大文件（如视频、音频）使用后及时释放，避免内存泄漏；</li>
</ul>
</li>
<li><strong>避免内存泄漏场景</strong>：
<ul>
<li>禁止匿名函数/闭包持有 <code>BuildContext</code> 长期引用（如异步回调中）；</li>
<li>禁止静态变量持有 Widget/State 实例；</li>
</ul>
</li>
</ol>
<h4 data-id="heading-28">7.3 代码执行优化</h4>
<ol>
<li><strong>异步操作</strong>：
<ul>
<li>网络请求、文件读写必须用异步（<code>async/await</code>），禁止同步阻塞；</li>
<li>多个独立异步任务用 <code>Future.wait</code> 并行执行（而非串行 <code>await</code>）；</li>
</ul>
</li>
<li><strong>计算优化</strong>：
<ul>
<li>复杂计算（如数据解析、加密）放在 <code>isolate</code> 中执行（避免阻塞 UI 线程）；</li>
<li>重复计算结果缓存（如 <code>final</code> 变量、<code>memoizer</code> 工具）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-29">八、资源与配置规范（强制）</h3>
<h4 data-id="heading-30">8.1 静态资源管理</h4>
<ol>
<li><strong>图片</strong>：
<ul>
<li>存放路径：<code>assets/images/</code>（按模块拆分，如 <code>assets/images/user/</code>）；</li>
<li>引用方式：通过 <code>common/res/images.dart</code> 常量封装，禁止硬编码路径；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// common/res/images.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Images</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> userAvatar = <span class="hljs-string">'assets/images/user/avatar.png'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> iconHome = <span class="hljs-string">'assets/images/home/icon_home.png'</span>;
}

<span class="hljs-comment">// 使用</span>
Image.asset(Images.userAvatar);
</code></pre>
</li>
<li><strong>字符串</strong>：
<ul>
<li>存放路径：<code>common/res/strings.dart</code>（支持国际化时用 <code>flutter_localizations</code>）；</li>
<li>禁止硬编码字符串（便于统一修改和国际化）；</li>
</ul>
</li>
<li><strong>颜色/尺寸</strong>：
<ul>
<li>颜色：区分主题色（<code>primaryColor</code>）、功能色（<code>successColor</code>/<code>errorColor</code>），禁止直接使用 <code>Colors.blue</code>（统一维护）；</li>
<li>尺寸：统一间距（<code>p8</code>/<code>p16</code>）、字体大小（<code>font14</code>/<code>font18</code>），避免魔法数字；</li>
</ul>
</li>
</ol>
<h4 data-id="heading-31">8.2 路由管理</h4>
<ol>
<li><strong>路由配置</strong>：
<ul>
<li>集中管理路由表（<code>app/routes.dart</code>），使用命名路由（禁止直接 <code>Navigator.push(Builder...)</code>）；</li>
<li>路由名称格式：<code>/模块/页面</code>（如 <code>/user/login</code>、<code>/order/detail</code>）；</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// app/routes.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Routes</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> home = <span class="hljs-string">'/home/index'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> login = <span class="hljs-string">'/user/login'</span>;
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, WidgetBuilder&gt; routes = {
    home: (context) =&gt; <span class="hljs-keyword">const</span> HomePage(),
    login: (context) =&gt; <span class="hljs-keyword">const</span> LoginPage(),
  };
}
</code></pre>
</li>
<li><strong>路由跳转</strong>：
<ul>
<li>使用封装后的路由工具（如 <code>RouterUtils.push(context, Routes.login)</code>），统一处理动画、参数传递；</li>
<li>路由参数传递：优先使用强类型（如通过 <code>ModalRoute.of(context)?.settings.arguments</code> 封装模型），避免 <code>Map</code> 动态类型；</li>
</ul>
</li>
<li><strong>路由守卫</strong>：
<ul>
<li>全局路由守卫（如未登录拦截跳登录页）统一在 <code>MaterialApp.onGenerateRoute</code> 中处理；</li>
</ul>
</li>
</ol>
<h4 data-id="heading-32">8.3 依赖管理</h4>
<ol>
<li><strong><code>pubspec.yaml</code> 规范</strong>：
<ul>
<li>依赖分组（<code>dependencies</code>/<code>dev_dependencies</code>），并按功能排序（如网络、状态管理、工具类）；</li>
<li>版本约束：核心依赖（如 <code>flutter_bloc</code>、<code>dio</code>）指定稳定版本（如 <code>^8.1.0</code>），避免使用 <code>any</code>；</li>
<li>定期更新依赖（<code>flutter pub upgrade</code>），并移除未使用的依赖（<code>flutter pub clean</code> + <code>dart pub deps</code> 检查）；</li>
</ul>
</li>
<li>禁止重复依赖：如已使用 <code>dio</code>，禁止再引入 <code>http</code> 库（统一网络请求工具）。</li>
</ol>
<h3 data-id="heading-33">九、测试与质量规范（强制+建议）</h3>
<h4 data-id="heading-34">9.1 测试规范（建议）</h4>
<ol>
<li><strong>测试分层</strong>：
<ul>
<li><strong>单元测试</strong>：测试工具类、业务逻辑（如 <code>utils/</code>、<code>domain/</code> 层），覆盖率≥80%；</li>
<li><strong>Widget 测试</strong>：测试核心 UI 组件（如 <code>common/widgets/</code>），验证渲染正确性；</li>
<li><strong>集成测试</strong>：测试关键业务流程（如登录→首页→下单）；</li>
</ul>
</li>
<li><strong>测试文件存放</strong>：
<ul>
<li>单元测试/Widget 测试：与被测试文件同目录，命名为 <code>xxx_test.dart</code>；</li>
<li>集成测试：放在 <code>integration_test/</code> 目录下；</li>
</ul>
</li>
</ol>
<h4 data-id="heading-35">9.2 静态代码检查（强制）</h4>
<ol>
<li><strong>启用 lint 规则</strong>：
<ul>
<li>基础规则：使用 <code>flutter_lints</code>（官方推荐）；</li>
<li>增强规则：集成 <code>dart_code_metrics</code>，自定义强制规则（如禁止 <code>print</code>、禁止 <code>build</code> 中创建对象）；</li>
</ul>
</li>
<li><strong>配置文件</strong>：在 <code>analysis_options.yaml</code> 中配置规则，示例：
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">include:</span> <span class="hljs-string">package:flutter_lints/flutter.yaml</span>

<span class="hljs-attr">linter:</span>
  <span class="hljs-attr">rules:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">avoid_print</span> <span class="hljs-comment"># 禁止使用 print（用 log_utils 替代）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">prefer_const_constructors</span> <span class="hljs-comment"># 强制使用 const 构造函数</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">no_logic_in_create_state</span> <span class="hljs-comment"># 禁止在 createState 中写逻辑</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">unused_import</span> <span class="hljs-comment"># 禁止未使用的导入</span>

<span class="hljs-attr">analyzer:</span>
  <span class="hljs-attr">exclude:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">build/</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">.dart_tool/</span>
</code></pre>
</li>
<li><strong>提交前检查</strong>：
<ul>
<li>必须执行 <code>flutter analyze</code>（静态分析无错误）；</li>
<li>必须执行 <code>flutter format .</code>（自动格式化代码）；</li>
</ul>
</li>
</ol>
<h4 data-id="heading-36">9.3 版本控制规范（强制）</h4>
<ol>
<li><strong>分支管理</strong>：
<ul>
<li><code>master</code>：生产环境分支（仅合并 <code>release</code>/<code>hotfix</code> 分支）；</li>
<li><code>feature</code>：开发分支（日常开发、合并 <code>feature</code> 分支）；</li>
<li><code>release/xxx</code>：上线分支（从 <code>master</code> 拉出，完成后合并回 <code>feature</code>）；</li>
<li><code>hotfix/xxx</code>：紧急修复分支（从 <code>master</code> 拉出，修复后合并 <code>master</code>）；</li>
<li><code>release</code>/<code>hotfix</code>：分支发布成功后合并到 <code>master</code>；</li>
</ul>
</li>
<li><strong>提交信息规范</strong>：
<ul>
<li>格式：<code>类型: 描述（英文，首字母小写）</code>；</li>
<li>类型：<code>feat</code>（新增功能）、<code>fix</code>（修复 bug）、<code>docs</code>（文档）、<code>style</code>（格式调整）、<code>refactor</code>（重构）、<code>test</code>（测试）、<code>chore</code>（依赖/构建调整）；</li>
<li>示例：<code>feat: add login page</code>、<code>fix: resolve login button unclickable issue</code>；</li>
</ul>
</li>
<li><strong>提交粒度</strong>：单次提交仅包含一个功能/修复，代码量不超过 300 行（便于 Code Review）。</li>
</ol>
<h3 data-id="heading-37">十、最佳实践（建议）</h3>
<ol>
<li><strong>国际化</strong>：使用 <code>flutter_localizations</code> + <code>intl</code> 库，字符串按语言拆分（<code>strings_en.dart</code>/<code>strings_zh.dart</code>）；</li>
<li><strong>主题适配</strong>：支持深色模式，全局样式通过 <code>Theme.of(context)</code> 获取（如 <code>Theme.of(context).primaryColor</code>）；</li>
<li><strong>错误处理</strong>：
<ul>
<li>统一网络错误（如 401 未授权、500 服务器错误）拦截处理；</li>
<li>全局异常捕获（<code>FlutterError.onError</code> + <code>runZonedGuarded</code>），收集崩溃日志；</li>
</ul>
</li>
<li><strong>代码复用</strong>：
<ul>
<li>公共逻辑提取为 <code>mixin</code>（如 <code>ToastMixin</code>、<code>LoadingMixin</code>），避免继承冗余；</li>
<li>表单验证逻辑封装为工具类（如 <code>FormValidator.validatePhone()</code>）；</li>
</ul>
</li>
<li><strong>工具推荐</strong>：
<ul>
<li>序列化：<code>freezed</code> + <code>json_serializable</code>（自动生成模型代码）；</li>
<li>路由：<code>auto_route</code>（类型安全路由，避免手动配置）；</li>
<li>日志：<code>logger</code>（替代 <code>print</code>，支持分级日志、格式化输出）；</li>
<li>代码生成：<code>build_runner</code>（自动化生成模板代码）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-38">十一、规范落地与维护</h3>
<ol>
<li><strong>工具保障</strong>：IDE 安装 <code>Flutter</code>/<code>Dart</code> 插件，开启自动格式化、lint 实时检查；</li>
<li><strong>CI/CD 集成</strong>：提交代码时触发 CI 流程（执行 <code>flutter analyze</code>、<code>flutter test</code>），不通过则禁止合并；</li>
<li><strong>定期复盘</strong>：每季度更新规范（适配 Flutter 新版本特性），团队内部分享违规案例与优化方案；</li>
<li><strong>新人培训</strong>：将规范纳入新人入职培训，配套示例项目（展示规范落地效果）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go（GoLang）语言基础、知识速查]]></title>    <link>https://juejin.cn/post/7591635567588065326</link>    <guid>https://juejin.cn/post/7591635567588065326</guid>    <pubDate>2026-01-05T06:46:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591635567588065326" data-draft-id="7591544356001251338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go（GoLang）语言基础、知识速查"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2026-01-05T06:46:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="gitboyzcf"/> <meta itemprop="url" content="https://juejin.cn/user/853651045488455"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go（GoLang）语言基础、知识速查
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/853651045488455/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    gitboyzcf
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T06:46:25.000Z" title="Mon Jan 05 2026 06:46:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读33分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bd58667e8fa4304aae9a0872b9add3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ2l0Ym95emNm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200384&amp;x-signature=0r%2B%2BJ7%2FFwW6zHm7b2IWYchSQgMw%3D" alt="1" loading="lazy"/></p>
<h2 data-id="heading-0">Go语言基础</h2>
<h3 data-id="heading-1">认识</h3>
<p><strong>Go（又称Golang）</strong> 由Google开发，于2009年首次公开发布。它旨在解决C++编译慢、并发复杂等问题以及提供简洁、高效、可靠的软件开发解决方案。</p>
<p>Golang由Google工程师Robert Griesemer、Rob Pike和Ken Thompson于2007年设计，2009年正式开源。</p>
<p>Golang是一种静态强类型、编译型、并发型 编程语言，特别适合 云计算、微服务、分布式系统 等领域。</p>
<p>支持最强大的<strong>并发、内存管理、垃圾回收机制</strong>等。</p>
<h4 data-id="heading-2">下载安装</h4>
<p>官网： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2F" target="_blank" title="https://go.dev/" ref="nofollow noopener noreferrer">go.dev/（英）</a></p>
<p>可访问 中国镜像站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgolang.google.cn%2F" target="_blank" title="https://golang.google.cn/" ref="nofollow noopener noreferrer">golang.google.cn/</a></p>
<blockquote>
<p>安装教程参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fzh-cn%2Fazure%2Fdeveloper%2Fgo%2Fconfigure-visual-studio-code" target="_blank" title="https://learn.microsoft.com/zh-cn/azure/developer/go/configure-visual-studio-code" ref="nofollow noopener noreferrer">learn.microsoft.com/zh-cn/azure…</a></p>
</blockquote>
<p>以上步骤操作完重新打开VSCode就可以使用了</p>
<h3 data-id="heading-3">Go语言声明</h3>
<ul>
<li><strong>var（声明变量）</strong>
变量意为 可变的东西，就是赋值完还能继续赋值改变这个值
<blockquote>
<p>Go语言的变量声明格式为：var 变量名 变量类型 = 值</p>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">var</span> a <span class="hljs-type">int</span> = <span class="hljs-number">10</span> <span class="hljs-comment">// 声明一个整型变量a并赋值为10</span>
	<span class="hljs-keyword">var</span> b <span class="hljs-type">int</span> <span class="hljs-comment">// 声明一个整型变量b，未赋值，默认值为0</span>
	<span class="hljs-keyword">var</span> c = <span class="hljs-number">20</span> <span class="hljs-comment">// 为声明类型，go会根据值自动推断类型</span>
	<span class="hljs-comment">// 短声明（语法糖 :=  与上面意思一致）</span>
	d := <span class="hljs-string">"短声明d"</span> <span class="hljs-comment">// 短声明一个d变量，赋值为字符串类型</span>
	<span class="hljs-comment">// 一行声明个多，相同类型或不同类型的变量</span>
	<span class="hljs-keyword">var</span> aa,bb,cc <span class="hljs-type">int</span> = <span class="hljs-number">11</span>,<span class="hljs-string">"22"</span>,<span class="hljs-number">33</span>
	<span class="hljs-comment">// 批量声明</span>
	<span class="hljs-keyword">var</span> (
	  e <span class="hljs-type">int</span> = <span class="hljs-number">1</span>
	  f = <span class="hljs-number">2</span>
	)
}
</code></pre>
变量作用域
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
)
<span class="hljs-comment">// 全局变量m</span>
<span class="hljs-keyword">var</span> m = <span class="hljs-number">100</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    n := <span class="hljs-number">10</span>
    m := <span class="hljs-number">200</span> <span class="hljs-comment">// 此处声明局部变量m</span>
    fmt.Println(m, n)
}
</code></pre>
</li>
<li><strong>const（声明常量）</strong>
相对于变量，常量是恒定不变的值，多用于定义程序运行期间不会改变的那些值。只是把var换成了const，常量在定义的时候必须赋值。
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">const</span> pi = <span class="hljs-number">3.1415</span>
 <span class="hljs-keyword">const</span> e = <span class="hljs-number">2.7182</span>
 <span class="hljs-comment">// 批量声明</span>
 <span class="hljs-keyword">const</span> (
    pi = <span class="hljs-number">3.1415</span>
    e = <span class="hljs-number">2.7182</span>
	)
 <span class="hljs-comment">// 使用iota 关键字进行递增计数</span>
 <span class="hljs-comment">//  iota 在const关键字出现时将被重置为 0</span>
  <span class="hljs-keyword">const</span> (
		n1 = <span class="hljs-literal">iota</span> <span class="hljs-comment">//0</span>
		n2        <span class="hljs-comment">//1</span>
		n3        <span class="hljs-comment">//2</span>
		n4        <span class="hljs-comment">//3</span>
	)
</code></pre>
</li>
</ul>
<h3 data-id="heading-4">关键字</h3>
<p>关键字是 Go 语言中预先保留的单词，在程序中有特殊含义，不能用来定义变量或常量名字。</p>















































<table><thead><tr><th/><th/><th/><th/><th/></tr></thead><tbody><tr><td>break</td><td>default</td><td>func</td><td>interface</td><td>select</td></tr><tr><td>case</td><td>defer</td><td>go</td><td>map</td><td>struct</td></tr><tr><td>chan</td><td>else</td><td>goto</td><td>package</td><td>switch</td></tr><tr><td>const</td><td>fallthrough</td><td>if</td><td>range</td><td>type</td></tr><tr><td>continue</td><td>for</td><td>import</td><td>return</td><td>var</td></tr></tbody></table>
<h3 data-id="heading-5">数据类型</h3>
<p>Go 语言中数据类型分为：<strong>基本数据类型</strong>和<strong>复合数据类型</strong></p>
<ul>
<li><strong>基本数据类型</strong>
整型、浮点型、布尔型、字符串</li>
<li><strong>复合数据类型</strong>
数组、切片、结构体、函数、map、通道（channel）、接口等</li>
</ul>
<h4 data-id="heading-6">基本数据类型</h4>
<h5 data-id="heading-7">整型</h5>
<p>整型的类型有很多中。我们可以根据具体的情况来进行定义
<strong>有符号整型</strong> ：<code>int8，int16，int32，int64</code>
<strong>无符号整型</strong> : <code>uint8, uint16, uint32, uint64</code></p>
<blockquote>
<p>提示！</p>
<ul>
<li><strong>有符号（Signed）</strong> → <strong>能赋值正数负数</strong>，但正数范围小。</li>
<li><strong>无符号（Unsigned）</strong> → <strong>只能赋值正数</strong>，但能存更大的正数。</li>
</ul>
</blockquote>
<p>如果我们直接写<code>int</code>也是可以的，它在不同的电脑操作系统中，<code>int</code>的大小是不一样的</p>
<p>32位操作系统：int -&gt; int32
64位操作系统：int -&gt; int64</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08b20b705c564b90b8d3dc3db52f51be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ2l0Ym95emNm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200384&amp;x-signature=bgjc0THknMHA%2Fnvn5aS7O2d8lSQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> num8 <span class="hljs-type">uint8</span> = <span class="hljs-number">128</span>
<span class="hljs-keyword">var</span> num16 <span class="hljs-type">uint16</span> = <span class="hljs-number">32768</span>
<span class="hljs-keyword">var</span> num32 <span class="hljs-type">uint32</span> = math.MaxUint32
<span class="hljs-keyword">var</span> num64 <span class="hljs-type">uint64</span> = math.MaxUint64
</code></pre>
<h5 data-id="heading-8">浮点型</h5>
<p>浮点型表示存储的数据是实数，如3.145</p>
<p>32位操作系统：<strong>float32</strong>
64位操作系统：<strong>float64</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> num1 <span class="hljs-type">float32</span> = math.MaxFloat32
<span class="hljs-keyword">var</span> num2 <span class="hljs-type">float64</span> = math.MaxFloat64
</code></pre>
<blockquote>
<p><strong>提示：</strong>
我们知道浮点数能表示的数值很大，但是浮点数的精度却没有那么大:</p>
<ul>
<li>float32 的精度只能提供大约 6 个十进制数(表示小数点后 6 位)的精度。</li>
<li>float64 的精度能提供大约 15 个十进制数(表示小数点后 15 位)的精度。</li>
</ul>
</blockquote>
<h5 data-id="heading-9">布尔值</h5>
<p>Go语言中以bool类型进行声明布尔型数据，布尔型数据只有<code>true</code>（真）<code>和false</code>（假）两个值。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> d <span class="hljs-type">bool</span> = <span class="hljs-literal">true</span>
f := <span class="hljs-literal">false</span>
</code></pre>
<blockquote>
<p><strong>注意</strong>
       布尔类型变量的默认值为false。<br/>
Go 语言中不允许将整型强制转换为布尔型.<br/>
布尔型无法参与数值运算，也无法与其他类型进行转换。</p>
</blockquote>
<h5 data-id="heading-10">字符串</h5>
<p>字符串的值为双引号(" ")中的内容</p>
<pre><code class="hljs language-go" lang="go">s1 := <span class="hljs-string">"hello"</span>
s2 := <span class="hljs-string">"你好"</span>
</code></pre>
<h4 data-id="heading-11">复合数据类型</h4>
<h5 data-id="heading-12">数组</h5>
<p>是一种数据类型固定长度的序列，可以理解为一个存放数据的容器。</p>
<blockquote>
<ul>
<li>数组定义：<code>var a [len]int</code>，比如：<code>var a [5]int</code>，一旦定义，长度不能变。</li>
<li>数组可以通过下标进行访问，下标是从0开始，最后一个元素下标是：len-1</li>
<li>数组是<strong>值类型</strong>，<strong>赋值和传参会复制整个数组，而不是指针</strong>。因此改变副本的值，不会改变本身的值。</li>
</ul>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 数组初始化</span>
<span class="hljs-keyword">var</span> arr1 = [<span class="hljs-number">3</span>]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>}
fmt.Println(arr1) <span class="hljs-comment">// [1, 2, 3]</span>

<span class="hljs-comment">// 短声明</span>
arr2 := [<span class="hljs-number">3</span>]<span class="hljs-type">int</span>{<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>}
fmt.Println(arr2) <span class="hljs-comment">// [4, 5, 6]</span>

<span class="hljs-comment">// 部分初始化，为初始化为0值</span>
arr3 := [<span class="hljs-number">5</span>]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>}
fmt.Println(arr3) <span class="hljs-comment">// [1, 2, 0, 0, 0]</span>

<span class="hljs-comment">// 通过指定索引，方便对数组某几个元素赋值</span>
arr4 := [<span class="hljs-number">5</span>]<span class="hljs-type">int</span>{<span class="hljs-number">0</span>: <span class="hljs-number">1</span>, <span class="hljs-number">3</span>: <span class="hljs-number">4</span>}
fmt.Println(arr4) <span class="hljs-comment">// [1, 0, 0, 4, 0]</span>

<span class="hljs-comment">// 根据初始化的值，指定长度</span>
arr5 := [...]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>}
fmt.Println(arr5) <span class="hljs-comment">// [1, 2, 3]</span>

<span class="hljs-comment">// 多维数组</span>
<span class="hljs-keyword">var</span> arr6 = [<span class="hljs-number">2</span>][<span class="hljs-number">3</span>]<span class="hljs-type">int</span>{{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>}, {<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>}}
fmt.Println(arr6) <span class="hljs-comment">// [[1 2 3] [4 5 6]]</span>
</code></pre>
<h5 data-id="heading-13">切片</h5>
<p>切片（Slice）是一个拥有相同类型元素的<strong>可变长度的序列</strong>。它是基于数组类型做的一层封装。它非常灵活，支持自动扩容。</p>
<p>切片是一个引用类型，它的内部结构包含<strong>指针、长度和容量</strong>。切片一般用于快速地操作一块数据集合。</p>
<blockquote>
<p><strong>格式</strong>：<code>var name []T</code></p>
<ul>
<li><strong>name</strong>：表示变量名</li>
<li><strong>T</strong>：表示切片中的元素类型</li>
</ul>
</blockquote>
<p>切片的定义方式与数组的定义方式的区别在于，数组在初始化的时候我们将一个具体大小给他设定了，而切片没有定义大小。</p>
<blockquote>
<p>使用内置<code>len()</code>函数求长度
使用内置<code>cap()</code>函数求容量</p>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">var</span> a []<span class="hljs-type">string</span>              <span class="hljs-comment">//声明一个字符串切片</span>
	<span class="hljs-keyword">var</span> b = []<span class="hljs-type">int</span>{}             <span class="hljs-comment">//声明一个整型切片并初始化</span>
	<span class="hljs-keyword">var</span> c = []<span class="hljs-type">bool</span>{<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>} <span class="hljs-comment">//声明一个布尔切片并初始化</span>
	<span class="hljs-comment">// 使用内置 make([]T, len, cap) 定义切片</span>
	numList := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>)
	fmt.Println(numList) <span class="hljs-comment">// [0 0 0]</span>
	fmt.Println(<span class="hljs-built_in">len</span>(numList)) <span class="hljs-comment">// 3</span>
	fmt.Println(<span class="hljs-built_in">cap</span>(numList)) <span class="hljs-comment">// 5</span>
	<span class="hljs-comment">// 通过数组进行切片截取</span>
	a := [<span class="hljs-number">5</span>]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>}
	<span class="hljs-comment">// 切片的底层就是一个数组，所以我们可以基于数组通过切片表达式得到切片（通过索引截取）</span>
	<span class="hljs-comment">// 格式：数组变量[起始位置:结束位置]</span>
	<span class="hljs-comment">// 切片中不包含结束位置的元素</span>
	s := a[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>]
	fmt.Println(s) <span class="hljs-comment">// [2 3]</span>
	
	<span class="hljs-comment">/*
		a[2:]  // 等同于 a[2:len(a)]
		a[:3]  // 等同于 a[0:3]
		a[:]   // 等同于 a[0:len(a)]
	*/</span>
	
	<span class="hljs-comment">// 创建多维切片</span>
	nameList := [][]<span class="hljs-type">string</span>{
		{<span class="hljs-string">"1"</span>, <span class="hljs-string">"张三"</span>},
		{<span class="hljs-string">"2"</span>, <span class="hljs-string">"李四"</span>},
		{<span class="hljs-string">"3"</span>, <span class="hljs-string">"王二"</span>},
		{<span class="hljs-string">"4"</span>, <span class="hljs-string">"麻子"</span>},
	}	
	fmt.Println(nameList) <span class="hljs-comment">// [[1 张三] [2 李四] [3 王二] [4 麻子]]</span>
}
</code></pre>
<h6 data-id="heading-14">用append内置函数操作切片（切片追加）</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
)
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> a = []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>}
    fmt.Printf(<span class="hljs-string">"slice a : %v\n"</span>, a) <span class="hljs-comment">// [1 2 3]</span>
    <span class="hljs-keyword">var</span> b = []<span class="hljs-type">int</span>{<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>}
    fmt.Printf(<span class="hljs-string">"slice b : %v\n"</span>, b) <span class="hljs-comment">// [4 5 6]</span>
    c := <span class="hljs-built_in">append</span>(a, b...)
    fmt.Printf(<span class="hljs-string">"slice c : %v\n"</span>, c) <span class="hljs-comment">// [1 2 3 4 5 6]</span>
    d := <span class="hljs-built_in">append</span>(c, <span class="hljs-number">7</span>)
    fmt.Printf(<span class="hljs-string">"slice d : %v\n"</span>, d) <span class="hljs-comment">// [1 2 3 4 5 6 7]</span>
    e := <span class="hljs-built_in">append</span>(d, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>)
    fmt.Printf(<span class="hljs-string">"slice e : %v\n"</span>, e) <span class="hljs-comment">// [1 2 3 4 5 6 7 8 9 10]</span>
}
</code></pre>
<p>超出原 slice.cap 限制，就会重新分配底层数组，即便<strong>原数组并未填满， 通常以 2 倍容量重新分配底层数组</strong>。</p>
<h5 data-id="heading-15">指针</h5>
<p>指针也是一种类型，也可以创建变量，称之为指针变量。指针变量的类型为 <code>*Type</code>，该指针指向一个 Type 类型的变量。指针变量最大的特点就是存储的某个实际变量的内存地址，通过记录某个变量的地址，从而间接的操作该变量。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/659d7ffe2a7140baafe34b50e97bcebd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ2l0Ym95emNm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200384&amp;x-signature=Wi6iaU11NN5UQNzv4uaH1B%2F1Sps%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p><strong>指针声明获取格式</strong></p>
<ul>
<li>var 变量名 *类型 = new(类型)</li>
<li>填入值：*变量名 = 值</li>
<li>获取指针：&amp;变量名</li>
<li>获取值：*变量名</li>
</ul>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
)
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">var</span> num <span class="hljs-type">int</span> = <span class="hljs-number">10</span>
	p := &amp;num <span class="hljs-comment">// 将地址值指针赋值给p变量</span>
	fmt.Println(p) <span class="hljs-comment">// 输出地址值指针 0x14000010230</span>
	fmt.Println(*p) <span class="hljs-comment">// 通过指针访问值  // 10</span>
	fmt.Println(&amp;num) <span class="hljs-comment">// 0x14000010230</span>
	fmt.Println(num) <span class="hljs-comment">// 10</span>
	

	<span class="hljs-comment">// 修改指针指向的值</span>
	*p = <span class="hljs-number">20</span>
	fmt.Println(num) <span class="hljs-comment">// 20</span>

	<span class="hljs-comment">// new 先创建指针分配好内存，再给指针写入值</span>
	<span class="hljs-keyword">var</span> p1 *<span class="hljs-type">int</span> = <span class="hljs-built_in">new</span>(<span class="hljs-type">int</span>)
	*p1 = <span class="hljs-number">30</span>
	fmt.Println(*p1) <span class="hljs-comment">// 30</span>
}
</code></pre>
<p>只需要记住两个符号：<code>&amp;</code>（取地址）和<code>*</code>（根据地址取值）。
<strong>总结</strong>： 取地址操作符&amp;和取值操作符<code>*</code>是一对互补操作符，<code>&amp;</code>取出地址，<code>*</code>根据地址取出地址指向的值。</p>
<blockquote>
<p><strong>变量、指针地址、指针变量、取地址、取值的相互关系和特性如下</strong>:</p>
<ol>
<li>对变量进行取地址（&amp;）操作，可以获得这个变量的指针变量。
&gt;2. 指针变量的值是指针地址。
&gt;3. 对指针变量进行取值（*）操作，可以获得指针变量指向的原变量的值。</li>
</ol>
</blockquote>
<h6 data-id="heading-16">空指针</h6>
<p>当一个指针被定义后没有分配到任何变量时，它的值为 <code>nil</code></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> p *<span class="hljs-type">string</span>
    fmt.Println(p)
    fmt.Printf(<span class="hljs-string">"p的值是%s/n"</span>, p)
    <span class="hljs-keyword">if</span> p != <span class="hljs-literal">nil</span> {
        fmt.Println(<span class="hljs-string">"非空"</span>)
    } <span class="hljs-keyword">else</span> {
        fmt.Println(<span class="hljs-string">"空值"</span>)
    }
}
</code></pre>
<h5 data-id="heading-17">Map</h5>
<p><code>map</code>是一种无序的基于key-value的数据结构，Go语言中的map是引用类型。它类似于其他编程语言中的哈希表或字典，提供了快速的插入、删除和查找操作</p>
<p>map中的数据是<strong>无序排列</strong>
map中的key只能是<code>string|int</code>类型</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
)
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 定义方式</span>
	<span class="hljs-comment">// make方式  格式：name := make(map[KeyType]ValueType) 或者 make(map[KeyType]ValueType, [cap])</span>
	<span class="hljs-comment">// KeyType:表示键的类型。 ValueType:表示键对应的值的类型。 cap表示容量</span>
	make1 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>) 
	fmt.Printf(make1) <span class="hljs-comment">// map[]</span>
	
	<span class="hljs-comment">// 通过字面量</span>
	<span class="hljs-keyword">var</span> userInfo1 <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> = <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{
        <span class="hljs-string">"username"</span>: <span class="hljs-string">"zhangsan"</span>,
        <span class="hljs-string">"password"</span>: <span class="hljs-string">"123456"</span>,
    }
	<span class="hljs-comment">// 通过短声明</span>
	userInfo2 := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{
        <span class="hljs-string">"username"</span>: <span class="hljs-string">"zhangsan"</span>,
        <span class="hljs-string">"password"</span>: <span class="hljs-string">"123456"</span>,
    }
    fmt.Printf(userInfo2) <span class="hljs-comment">// map[username:zhangsan password:123456]</span>
    
    userList := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">string</span>{
	    <span class="hljs-number">1</span>: <span class="hljs-string">'张三'</span>,
	    <span class="hljs-number">2</span>: <span class="hljs-string">'李四'</span>,
	    <span class="hljs-number">3</span>: <span class="hljs-string">'王二'</span>,
    }
    <span class="hljs-comment">// 添加元素到map</span>
	userList[<span class="hljs-number">4</span>] = <span class="hljs-string">"麻子"</span>
	fmt.Println(userList) <span class="hljs-comment">// map[1:张三 2:李四 3:王二 4:麻子]</span>
	<span class="hljs-comment">// 更新map</span>
	userList[<span class="hljs-number">4</span>] = <span class="hljs-string">"mazi"</span>
	fmt.Println(userList) <span class="hljs-comment">// map[1:张三 2:李四 3:王二 4:mazi]</span>
	<span class="hljs-comment">// 获取元素</span>
	fmt.Println(userList[<span class="hljs-number">4</span>]) <span class="hljs-comment">// mazi</span>
	<span class="hljs-comment">// 删除元素</span>
	<span class="hljs-built_in">delete</span>(userList, <span class="hljs-number">4</span>)
	fmt.Println(userList) <span class="hljs-comment">// map[1:张三 2:李四 3:王二]</span>
	
	<span class="hljs-comment">//判断键值是否存在  value,ok := map[key]</span>
	u3, ok := userList[<span class="hljs-number">3</span>]
	fmt.Println(ok) <span class="hljs-comment">// true</span>
	fmt.Println(u3) <span class="hljs-comment">// 张三</span>

	u4, ok := userList[<span class="hljs-number">4</span>]
	fmt.Println(ok) <span class="hljs-comment">// false</span>
	fmt.Println(u4) <span class="hljs-comment">// </span>
	
	<span class="hljs-comment">// 循环map</span>
	<span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> m1 {
		<span class="hljs-comment">/*
		%s、%d都是占位符，%s是用于插入字符串类型，%d用于插入整数类型的值
		*/</span>
		fmt.Printf(<span class="hljs-string">"key: %s, value: %d\n"</span>, key, value)
	}
	
}

</code></pre>
<h3 data-id="heading-18">结构体</h3>
<blockquote>
<p><strong>理解</strong></p>
<ul>
<li>Go语言中没有“类”的概念，也不支持“类”的继承等面向对象的概念。Go语言中通过<strong>结构体</strong>的内嵌再配合接口比面向对象具有更高的扩展性和灵活性。</li>
<li>Go语言提供了一种自定义数据类型，可以封装多个基本数据类型，这种数据类型叫结构体，英文名称<strong>struct</strong>。 也就是我们可以通过struct来定义自己的类型了。</li>
</ul>
</blockquote>
<p>简单理解就是go语言中的类成为结构体，用<code>type</code>和<code>struct</code>关键字进行实现</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> 类型名 <span class="hljs-keyword">struct</span> {
	字段名 字段类型
	字段名 字段类型
	…
}
<span class="hljs-comment">/*
1.类型名：标识自定义结构体的名称，在同一个包内不能重复。
2.字段名：表示结构体字段名。结构体中的字段名必须唯一。
3.字段类型：表示结构体字段的具体类型。
*/</span>
</code></pre>
<p>结构体中字段大写开头表示可公开访问，小写表示私有（仅在定义当前结构体的包中可访问）。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 创建结构体</span>
<span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> {
	name <span class="hljs-type">string</span> <span class="hljs-comment">// 姓名</span>
	age  <span class="hljs-type">int</span>    <span class="hljs-comment">// 年龄</span>
}

<span class="hljs-keyword">type</span> Person2 <span class="hljs-keyword">struct</span> {
	name, age <span class="hljs-type">string</span> <span class="hljs-comment">// 声明多个同类型字段</span>
	sex       <span class="hljs-type">int</span>
}




<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
	<span class="hljs-comment">// 实例化结构体</span>
	<span class="hljs-comment">// 按字段名称对每个字段进行初始化</span>
	persion := Person{name: <span class="hljs-string">"张三"</span>, age: <span class="hljs-number">30</span>}
	fmt.Println(persion) <span class="hljs-comment">// {张三 30}</span>

	<span class="hljs-comment">// 按字段顺序进行初始化</span>
	persion2 := Person2{<span class="hljs-string">"李四"</span>, <span class="hljs-string">"30"</span>, <span class="hljs-number">1</span>}
	fmt.Println(persion2) <span class="hljs-comment">// {李四 30 1}</span>
	
	
	<span class="hljs-comment">// 创建并实例化结构体</span>
	persion3 := <span class="hljs-keyword">struct</span> {
	  name <span class="hljs-type">string</span>
	  age <span class="hljs-type">int</span>
	  sex <span class="hljs-type">string</span>
	}{
	  name: <span class="hljs-string">"王二"</span>,
	  age: <span class="hljs-number">20</span>,
	  sex: <span class="hljs-string">"男"</span>
	}
	fmt.Println(persion3) <span class="hljs-comment">// {王二 20 男}</span>
	
	<span class="hljs-comment">// 实例化时未给值</span>
	<span class="hljs-keyword">var</span> person22 = Person2{}
	fmt.Println(person22) <span class="hljs-comment">// {  0}</span>
	
	<span class="hljs-comment">// 实例化未给全值</span>
	<span class="hljs-keyword">var</span> person222 = Person2{<span class="hljs-string">"李四"</span>, <span class="hljs-string">"30"</span>}
	fmt.Println(person22) <span class="hljs-comment">// {李四 30 0}</span>
	
	<span class="hljs-comment">// 通过 . 的方式对实例化后的结构体 进行改 删 查</span>
	person22.name = <span class="hljs-string">"李四"</span>
	person22.age = <span class="hljs-string">"30"</span>
	person22.sex = <span class="hljs-number">1</span>
	fmt.Println(person22) <span class="hljs-comment">// {李四 30 1}</span>
	
	<span class="hljs-comment">// 匿名属性结构体 多个相同类型会报错</span>
	<span class="hljs-keyword">type</span> Person3 <span class="hljs-keyword">struct</span> {
		<span class="hljs-type">string</span>
		<span class="hljs-type">int</span>
	}
	
	<span class="hljs-keyword">var</span> person33 = Person3{<span class="hljs-string">"王五"</span>, <span class="hljs-number">40</span>}
	fmt.Println(person33.<span class="hljs-type">string</span>) <span class="hljs-comment">// 王五</span>
	fmt.Println(person33.<span class="hljs-type">int</span>) <span class="hljs-comment">// 40</span>
	fmt.Println(person33) <span class="hljs-comment">// {王五 40}</span>
	
	<span class="hljs-comment">// 获取指针指针地址</span>
	<span class="hljs-keyword">var</span> person333 = &amp;Person33{<span class="hljs-string">"王五"</span>, <span class="hljs-number">30</span>}
	fmt.Println(person333) <span class="hljs-comment">// {王五 30}</span>
	fmt.Println((*person333).<span class="hljs-type">int</span>) <span class="hljs-comment">// 30</span>
	fmt.Println(person333.<span class="hljs-type">int</span>) <span class="hljs-comment">// 30</span>
	
}
</code></pre>
<h4 data-id="heading-19">方法和接收者</h4>
<p>Go语言中的方法（<em>Method</em>）是一种作用于特定类型变量的函数。这种特定类型变量叫做接收者（<em>Receiver</em>）。
<strong>接收者的概念就类似于其他语言中的this或者 self。</strong></p>
<p><strong>定义格式</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(接收者变量 接收者类型)</span></span> 方法名(参数列表) (返回参数) {
	函数体
}
</code></pre>
<p><strong>解析</strong>：</p>
<ul>
<li>接收者类型  就是定义的结构体</li>
<li>接收者变量   与定义普通变量相似就是随意定义一个名字，建议使用接收者类型的第一个字母 小写</li>
<li>方法名、参数列表、返回参数：具体格式与函数定义相同。函数后面会细讲</li>
</ul>
<p><strong>例子</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">//Person 结构体</span>
<span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> {
    name <span class="hljs-type">string</span>
    age  <span class="hljs-type">int8</span>
}


<span class="hljs-comment">// 将Dream方法 绑定到Person 结构体下；可以理解为  Dream方法是属于Person的</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> Dream() {
    fmt.Printf(<span class="hljs-string">"%s的梦想是学好Go语言！\n"</span>, p.name)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> SetName(n <span class="hljs-type">string</span>) {
 <span class="hljs-comment">// 这种方式不会修改实例后结构体的数据</span>
 p.name = n
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Person)</span></span> SetName2(n <span class="hljs-type">string</span>) {
 <span class="hljs-comment">// 这种使用指针接收器可以直接修改原实例数据</span>
 p.name = n
}



<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">var</span> p1 = Person{name: <span class="hljs-string">"zhangsan"</span>, age: <span class="hljs-number">24</span>}
    p1.Dream()
}
</code></pre>
<blockquote>
<p>方法与函数的区别是，函数不属于任何类型，方法属于特定的类型。</p>
</blockquote>
<h3 data-id="heading-20">函数</h3>
<p>函数用于功能代码块的封装，使用<code>func</code>关键字定义
<strong>格式</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> 函数名<span class="hljs-params">(参数列表, ...)</span></span> 返回值类型 {
	函数体
}
</code></pre>
<p><strong>参数解析</strong>：</p>
<ul>
<li>函数名：随便起名字，通常以小驼峰命名，比如：<code>funcName</code></li>
<li>参数列表：由一个或多个<strong>参数名 参数类型</strong>组成，比如: <code>a int,b string</code>；函数可以没有参数或接受多个参数。<strong>定义的这些参数相当于定义的变量，只有在当前函数内部使用</strong>；可以传递任意类型的参数</li>
<li>返回值类型：函数可以返回任意数量的返回值</li>
<li>函数体：编写正常的go语言代码即可</li>
</ul>
<p><strong>例子</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">test</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>, s <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">string</span>) {
    <span class="hljs-comment">// 类型相同的相邻参数，参数类型可合并。可以返回多个结果 多返回值必须用括号。</span>
    n := x + y          
    <span class="hljs-keyword">return</span> n, fmt.Sprintf(s, n)
}


<span class="hljs-comment">// 一个返回值类型可以省略括号</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sum</span><span class="hljs-params">(x <span class="hljs-type">int</span>, y <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {
	<span class="hljs-keyword">return</span> x + y
}

<span class="hljs-comment">//无参数和返回值</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printNum</span><span class="hljs-params">()</span></span> {
	fmt.Println(<span class="hljs-string">"go go go"</span>)
}


<span class="hljs-comment">// 以下方式的args都是一个slice（切片），可以用切片的方式去操作</span>
<span class="hljs-comment">// 注意点：在参数类型前面加 ... 表示一个切片，用来接收调用者传入的参数，切片参数必须放在参数列表最后</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">myfunc1</span><span class="hljs-params">(args ...<span class="hljs-type">int</span>)</span></span> {    <span class="hljs-comment">//0个或多个int参数</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add1</span><span class="hljs-params">(a <span class="hljs-type">int</span>, args…<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {    <span class="hljs-comment">//1个或多个int参数</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add2</span><span class="hljs-params">(a <span class="hljs-type">int</span>, b <span class="hljs-type">int</span>, args…<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {    <span class="hljs-comment">//2个或多个int参数</span>
}

<span class="hljs-comment">// 使用...interface{}的方式可以传递多个任意类型的参数</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">myfunc2</span><span class="hljs-params">(args ...<span class="hljs-keyword">interface</span>{})</span></span> {
}

<span class="hljs-comment">// 返回值添加变量</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">test2</span><span class="hljs-params">(a, b <span class="hljs-type">int</span>)</span></span> (sum <span class="hljs-type">int</span>, avg <span class="hljs-type">int</span>) {
	sum = a + b
	avg = sum / <span class="hljs-number">2</span>
	<span class="hljs-keyword">return</span>
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	testReturn, testStr := test(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"3"</span>)
	fmt.Println(testReturn, testStr) <span class="hljs-comment">// 3 3</span>
	fmt.Println(sum(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)) <span class="hljs-comment">// 3</span>
	printNum()
	myfunc1()
	myfunc2(<span class="hljs-number">1</span>, <span class="hljs-literal">true</span>, <span class="hljs-string">"张三"</span>)
	
	sum, avg := test2(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)
	fmt.Println(sum, avg) <span class="hljs-comment">// 30 15</span>
}
</code></pre>
<blockquote>
<p><strong>注意点</strong>：</p>
<ul>
<li><strong>基本类型参数传递</strong>：指在调用函数时将实际参数复制一份传递到函数中，这样在函数中如果对参数进行修改，将不会影响到实际参数。</li>
<li><strong>引用类型参数传递</strong>：是指在调用函数时将实际参数的地址传递到函数中，那么在函数中对参数所进行的修改，将影响到实际参数。</li>
</ul>
</blockquote>
<blockquote>
<p><strong>函数可见性</strong>：</p>
<ul>
<li>函数名首字母大写，对所有的包都是public，其他包可以导入当前包使用</li>
<li>函数名首字母小写，当前函数是private，其他包无法访问</li>
</ul>
</blockquote>
<h4 data-id="heading-21">匿名函数</h4>
<p><strong>格式</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(参数列表, ...)</span></span> 返回值类型 {
	函数体
}
</code></pre>
<p>多用于创建变量在把匿名函数赋值，函数当参数进行传递时</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"math"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    getSqrt := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(a <span class="hljs-type">float64</span>)</span></span> <span class="hljs-type">float64</span> {
        <span class="hljs-keyword">return</span> math.Sqrt(a)
    }
    fmt.Println(getSqrt(<span class="hljs-number">4</span>)) <span class="hljs-comment">// 2</span>
    
    <span class="hljs-comment">// 匿名函数并自执行</span>
    result := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(a, b <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {
	    <span class="hljs-keyword">return</span> a + b
	}(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)
	fmt.Println(result) <span class="hljs-comment">// 输出 7</span>
	
	<span class="hljs-comment">// 命名返回值</span>
	<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fun4</span><span class="hljs-params">()</span></span> (res <span class="hljs-type">string</span>) {
	  <span class="hljs-keyword">return</span> <span class="hljs-comment">// 相当于先定义再赋值</span>
	  <span class="hljs-comment">//return "abc"</span>
	}
}
</code></pre>
<h4 data-id="heading-22">闭包、递归</h4>
<p><strong>闭包</strong>：与其他语言闭包概念一致，函数嵌套函数，内部函数引用外部函数的变量形成引用环境</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
)
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(base <span class="hljs-type">int</span>)</span></span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {
        base += i
        <span class="hljs-keyword">return</span> base
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	tmp1 := add(<span class="hljs-number">10</span>)
	fmt.Println(tmp1(<span class="hljs-number">1</span>), tmp1(<span class="hljs-number">2</span>)) <span class="hljs-comment">// 11 13</span>
}

</code></pre>
<p><strong>递归</strong>：就是在运行的过程中调用自己。 一个函数调用自己，就叫做递归函数。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">factorial</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {
    <span class="hljs-keyword">if</span> i &lt;= <span class="hljs-number">1</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
    }
    <span class="hljs-keyword">return</span> i * factorial(i<span class="hljs-number">-1</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> i <span class="hljs-type">int</span> = <span class="hljs-number">7</span>
    fmt.Printf(<span class="hljs-string">"Factorial of %d is %d\n"</span>, i, factorial(i)) <span class="hljs-comment">// Factorial of 7 is 5040</span>
}
</code></pre>
<h4 data-id="heading-23">延迟调用（defer）</h4>
<p>简单点说就是 <code>defer</code> 语句后面跟着的函数会延迟到当前函数执行完后再执行。</p>
<p>只能用于<strong>函数、结构体方法</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">bookPrint</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"bookPrint方法"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">defer</span> bookPrint()
    fmt.Println(<span class="hljs-string">"main函数..."</span>)
}
<span class="hljs-comment">/*
 会先输出 main函数...
 在输出   bookPrint方法
*/</span>

</code></pre>
<p>注意点：</p>
<ul>
<li>使用 <code>defer</code> 只是延时调用函数，传递给函数里的变量，不应该受到后续程序的影响。</li>
<li><code>defer</code> 不仅能够延迟<strong>函数</strong>的执行，也能延迟<strong>方法</strong>的执行。</li>
<li>当一个函数内多次调用 <code>defer</code> 时，Go 会把 <code>defer</code> 调用放入到一个栈中，随后按照 <strong>后进先出</strong> 的顺序执行。</li>
</ul>
<h3 data-id="heading-24">包（package）</h3>
<p>Go 语言是使用包来<strong>组织源代码</strong>的， **包（package）**是多个 Go 源码的集合，一个包可以简单理解为一个存放多个.go 文件的文件夹。该文件夹下面的所有 go 文件都要在代码的第一行添加如下代码，声明该文件归属的包。</p>
<p><strong>Golang 中的包可以分为三种</strong>：1、系统内置包 2、自定义包 3、第三方包</p>
<blockquote>
<p><strong>系统内置包</strong>: Golang 语言给我们提供的内置包，引入后可以直接使用，如 fmt、strconv、strings、 sort、errors、time、encoding/json、os、io 等。
<strong>自定义包</strong>：开发者自己写的包
<strong>第三方包</strong>：属于自定义包的一种，需要下载安装到本地后才可以使用，如 "github.com/shopspring/decimal"包解决 float 精度丢失问题。</p>
</blockquote>
<p>在上面讲述的代码中都会看到，<code>package main</code>这段代码，这就是声明当前.go文件的包名</p>
<blockquote>
<p><strong>格式</strong></p>
<ul>
<li>声明当前.go文件的包名： <code>package pacakgeName</code></li>
<li>在当前文件中导入其他包时：<code>import "a/b/c"</code>，import后面是包的相对路径，从当前项目的根目录下指定</li>
</ul>
</blockquote>
<h4 data-id="heading-25">标识符可见性</h4>
<p>如果想在一个包中引用另外一个包里的标识符（如变量、常量、类型、函数等）时，该标识 符必须是对外可见的（public）。</p>
<p>在 Go 语言中只需要将标识符的<strong>首字母大写</strong>就可以让标识符对外可见了。</p>
<p>定义一个名为calc 的包</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> calc
 
<span class="hljs-comment">//首字母大小表示公有，首字母小写表示私有</span>
 
<span class="hljs-keyword">var</span> a = <span class="hljs-number">100</span> <span class="hljs-comment">//私有变量</span>
<span class="hljs-keyword">var</span> Age = <span class="hljs-number">20</span> <span class="hljs-comment">//公有变量</span>
 
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Add</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> x + y
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Sum</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> x - y
}
</code></pre>
<p>main.go中引入这个包</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
 
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"demo02/calc"</span>
    ca <span class="hljs-string">"demo02/calc"</span> <span class="hljs-comment">// 有别名的包</span>
)
 
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    c := calc.Add(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>)
    c2 := ca.Add(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>)
    fmt.Println(c)
}
</code></pre>
<h4 data-id="heading-26">init() 函数</h4>
<p>每个包文件都有个固定的，init函数此函数没有参数也没有返回值 ，充当每个包的生命周期初始化，不能在代码中主动调用它。</p>
<p>编译执行顺序⬇️
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/512f202bd72445daaff9832cabd7e4cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ2l0Ym95emNm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200384&amp;x-signature=3s3fbFAPBQZQAdk3iSMfMCHqqqQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35768698cb1c479b83e5a15cd9543ee7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ2l0Ym95emNm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200384&amp;x-signature=lhqqd3W5CHplBzTcI8g1rKVIaCg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-27">流程控制</h3>
<h4 data-id="heading-28">条件语句</h4>
<blockquote>
<p><strong>格式</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> 布尔表达式 {
<span class="hljs-comment">/* 在布尔表达式为 true 时执行 */</span>
}
</code></pre>
</blockquote>
<p>例子</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {

   <span class="hljs-comment">/* 定义局部变量 */</span>
   <span class="hljs-keyword">var</span> a <span class="hljs-type">int</span> = <span class="hljs-number">10</span>
   <span class="hljs-comment">/* 使用 if 语句判断布尔表达式 */</span>
   <span class="hljs-keyword">if</span> a &lt; <span class="hljs-number">20</span> {
       <span class="hljs-comment">/* 如果条件为 true 则执行以下语句 */</span>
       fmt.Printf(<span class="hljs-string">"a 小于 20\n"</span> ) <span class="hljs-comment">//  a 小于 20</span>
   }
   fmt.Printf(<span class="hljs-string">"a 的值为 : %d\n"</span>, a) <span class="hljs-comment">// a 的值为 : 10</span>

	score := <span class="hljs-number">88</span>  
	<span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">90</span> {  
	    fmt.Println(<span class="hljs-string">"成绩等级为A"</span>)  
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">80</span> {  
	    fmt.Println(<span class="hljs-string">"成绩等级为B"</span>)  
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">70</span> {  
	    fmt.Println(<span class="hljs-string">"成绩等级为C"</span>)  
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">60</span> {  
	    fmt.Println(<span class="hljs-string">"成绩等级为D"</span>)  
	} <span class="hljs-keyword">else</span> {  
	    fmt.Println(<span class="hljs-string">"成绩等级为E 成绩不及格"</span>)  
	}
	
	<span class="hljs-comment">// 简便用法</span>
	<span class="hljs-keyword">if</span> score := <span class="hljs-number">88</span>; score &gt;= <span class="hljs-number">60</span> {  
	    fmt.Println(<span class="hljs-string">"成绩及格"</span>)  
	}

}
</code></pre>
<h4 data-id="heading-29">选择语句</h4>
<p>与其他语言的<code>switch</code>相似</p>
<blockquote>
<p><strong>格式</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">switch</span> var1 {
  <span class="hljs-keyword">case</span> val1:
  ...
  <span class="hljs-keyword">case</span> val2:
  ...
  <span class="hljs-keyword">default</span>:
  ...
}
</code></pre>
</blockquote>
<p>例子</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
   <span class="hljs-comment">/* 定义局部变量 */</span>
   <span class="hljs-keyword">var</span> grade <span class="hljs-type">string</span> = <span class="hljs-string">"B"</span>
   <span class="hljs-keyword">var</span> marks <span class="hljs-type">int</span> = <span class="hljs-number">90</span>

   <span class="hljs-keyword">switch</span> marks {
      <span class="hljs-keyword">case</span> <span class="hljs-number">90</span>: grade = <span class="hljs-string">"A"</span>
      <span class="hljs-keyword">case</span> <span class="hljs-number">80</span>: grade = <span class="hljs-string">"B"</span>
      <span class="hljs-keyword">case</span> <span class="hljs-number">50</span>,<span class="hljs-number">60</span>,<span class="hljs-number">70</span> : grade = <span class="hljs-string">"C"</span>
      <span class="hljs-keyword">default</span>: grade = <span class="hljs-string">"D"</span>  
   }

	<span class="hljs-comment">//无表达式的switch</span>
   <span class="hljs-keyword">switch</span> {
      <span class="hljs-keyword">case</span> grade == <span class="hljs-string">"A"</span> :
         fmt.Printf(<span class="hljs-string">"优秀!\n"</span> )     
      <span class="hljs-keyword">case</span> grade == <span class="hljs-string">"B"</span>, grade == <span class="hljs-string">"C"</span> :
         fmt.Printf(<span class="hljs-string">"良好\n"</span> )      
      <span class="hljs-keyword">case</span> grade == <span class="hljs-string">"D"</span> :
         fmt.Printf(<span class="hljs-string">"及格\n"</span> )      
      <span class="hljs-keyword">case</span> grade == <span class="hljs-string">"F"</span>:
         fmt.Printf(<span class="hljs-string">"不及格\n"</span> )
      <span class="hljs-keyword">default</span>:
         fmt.Printf(<span class="hljs-string">"差\n"</span> )
   }
   fmt.Printf(<span class="hljs-string">"你的等级是 %s\n"</span>, grade )
   
   
   <span class="hljs-comment">// 结合fallthrough关键字</span>
    <span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>
    <span class="hljs-keyword">switch</span> k {
	    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
	        <span class="hljs-built_in">println</span>(<span class="hljs-string">"fallthrough"</span>)
	        <span class="hljs-keyword">fallthrough</span>
	        <span class="hljs-comment">/*
	            Go的switch非常灵活，表达式不必是常量或整数，执行的过程从上至下，直到找到匹配项；
	            而如果switch没有表达式，它会匹配true。
	            Go里面switch默认相当于每个case最后带有break，
	            匹配成功后不会自动向下执行其他case，而是跳出整个switch,
	            但是可以使用fallthrough强制执行后面的case代码。
	        */</span>
	    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
	        fmt.Println(<span class="hljs-string">"1"</span>)
	    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
	        fmt.Println(<span class="hljs-string">"2"</span>)
	    <span class="hljs-keyword">default</span>:
	        fmt.Println(<span class="hljs-string">"def"</span>)
    }
   
   
   <span class="hljs-comment">// 简便用法</span>
   <span class="hljs-keyword">switch</span> month := <span class="hljs-number">5</span>; month {
		<span class="hljs-keyword">case</span> <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">12</span>:
		    fmt.Println(<span class="hljs-string">"该月份有 31 天"</span>)
		<span class="hljs-keyword">case</span> <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">9</span>, <span class="hljs-number">11</span>:
		    fmt.Println(<span class="hljs-string">"该月份有 30 天"</span>)
		<span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
		    fmt.Println(<span class="hljs-string">"该月份闰年为 29 天，非闰年为 28 天"</span>)
		<span class="hljs-keyword">default</span>:
		    fmt.Println(<span class="hljs-string">"输入有误！"</span>)
	}
}
</code></pre>
<h4 data-id="heading-30">循环语句</h4>
<p>在Go语言中只有一种循环<code>for</code></p>
<p>以下是常用的几种格式</p>
<blockquote>
<p><strong>格式</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">for</span> initialisation; condition; post {
  code
}
<span class="hljs-comment">// for 接一个条件表达式</span>
<span class="hljs-keyword">for</span> condition {
  code
}
<span class="hljs-comment">// for 接一个 range 表达式</span>
<span class="hljs-keyword">for</span> range_expression {
  code
}
<span class="hljs-comment">// for 不接表达式</span>
<span class="hljs-keyword">for</span> {
  code
}
</code></pre>
</blockquote>
<p>例子</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 定义变量、条件判断、变量自增/自减 都放在一起，与其他语言类似</span>
	<span class="hljs-keyword">for</span> num := <span class="hljs-number">0</span>; num &lt; <span class="hljs-number">4</span>; num++ {
	    fmt.Println(num)
	}
	
	<span class="hljs-comment">// 接一个条件表达式</span>
	num := <span class="hljs-number">0</span>
	<span class="hljs-keyword">for</span> num &lt; <span class="hljs-number">4</span> {
	    fmt.Println(num)
	    num++
	}
	
	<span class="hljs-comment">// 接一个 range 表达式</span>
	<span class="hljs-comment">// for 循环的 range 格式可以对 切片(slice)、map、数组、字符串等进行迭代循环。</span>
	 s := <span class="hljs-string">"abc"</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> s {
        <span class="hljs-built_in">println</span>(s[i])
    }
    
    <span class="hljs-comment">// 忽略 index </span>
    <span class="hljs-keyword">for</span> _, c := <span class="hljs-keyword">range</span> s {
        <span class="hljs-built_in">println</span>(c)
    }
    
    <span class="hljs-comment">// 忽略全部返回值，仅迭代。</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> s {

    }
	
    m := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>{<span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">2</span>}
    <span class="hljs-comment">// 返回 (key, value)。</span>
    <span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> m {
        <span class="hljs-built_in">println</span>(k, v)
    }
    
    <span class="hljs-comment">// ！！注意，因a变量是数组，修改操作不会改变原数组。======</span>
    a := [<span class="hljs-number">3</span>]<span class="hljs-type">int</span>{<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>}

    <span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> a { <span class="hljs-comment">// index、value 都是从复制品中取出。</span>

        <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> { <span class="hljs-comment">// 在修改前，我们先修改原数组。</span>
            a[<span class="hljs-number">1</span>], a[<span class="hljs-number">2</span>] = <span class="hljs-number">999</span>, <span class="hljs-number">999</span>
            fmt.Println(a) <span class="hljs-comment">// 确认修改有效，输出 [0, 999, 999]。</span>
        }

        a[i] = v + <span class="hljs-number">100</span> <span class="hljs-comment">// 使用复制品中取出的 value 修改原数组。</span>

    }

    fmt.Println(a) <span class="hljs-comment">// 输出 [100, 101, 102]。</span>
	
	<span class="hljs-comment">//for 不接表达式，以下写法会无限循环，可以使用 break 关键字结束</span>
	<span class="hljs-comment">// 第一种写法</span>
	<span class="hljs-keyword">for</span> {
	    code
	}
	<span class="hljs-comment">// 第二种写法</span>
	<span class="hljs-keyword">for</span> ;; {
	    code
	}
}
</code></pre>
<ul>
<li>循环语句支持以下控制关键字
<ol>
<li><code>break</code></li>
<li><code>continue</code></li>
</ol>
</li>
</ul>
<h4 data-id="heading-31">goto语句</h4>
<p><code>goto</code>语句用于无条件跳转，可以无条件地转移到程序中指定的行；它通过标签进行代码间的无条件跳转。</p>
<p><code>goto</code>后面接一个标签，这个标签的意义是告诉Go程序下一步要执行哪行的代码，</p>
<blockquote>
<p>格式</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">goto</span> 标签;
...
...
标签: 表达式;
</code></pre>
</blockquote>
<p>例子</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {

    <span class="hljs-keyword">goto</span> flag
    fmt.Println(<span class="hljs-string">"B"</span>)
flag:
    fmt.Println(<span class="hljs-string">"A"</span>)

}
</code></pre>
<pre><code class="hljs language-css" lang="css">执行结果，并不会输出 <span class="hljs-selector-tag">B</span> ，而只会输出 <span class="hljs-selector-tag">A</span>
</code></pre>
<p>构成循环</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    i := <span class="hljs-number">1</span>
 flag:
    <span class="hljs-keyword">if</span> i &lt;= <span class="hljs-number">5</span> {
        fmt.Println(i)
        i++
        <span class="hljs-keyword">goto</span> flag
    }
}
</code></pre>
<p>goto语句与标签之间不能有变量声明，否则编译错误。</p>
<h3 data-id="heading-32">接口</h3>
<p>**接口（interface）**定义了一个对象的行为规范，只定义规范不实现，由具体的对象来实现规范的细节。</p>
<blockquote>
<p>格式</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> 接口类型名 <span class="hljs-keyword">interface</span>{
  方法名<span class="hljs-number">1</span>( 参数列表<span class="hljs-number">1</span> ) 返回值列表<span class="hljs-number">1</span>
  方法名<span class="hljs-number">2</span>( 参数列表<span class="hljs-number">2</span> ) 返回值列表<span class="hljs-number">2</span>
  …
}
</code></pre>
</blockquote>
<p>我们来定义一个Sayer接口：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Sayer 接口</span>
<span class="hljs-keyword">type</span> Sayer <span class="hljs-keyword">interface</span> {
    say()
}
</code></pre>
<p>定义dog和cat两个结构体：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> dog <span class="hljs-keyword">struct</span> {}

<span class="hljs-keyword">type</span> cat <span class="hljs-keyword">struct</span> {}
</code></pre>
<p>因为Sayer接口里只有一个say方法，所以我们只需要给dog和cat 分别实现say方法就可以实现Sayer接口了。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// dog实现了Sayer接口</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d dog)</span></span> say() {
    fmt.Println(<span class="hljs-string">"汪汪汪"</span>)
}

<span class="hljs-comment">// cat实现了Sayer接口</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c cat)</span></span> say() {
    fmt.Println(<span class="hljs-string">"喵喵喵"</span>)
}
</code></pre>
<p>接口的实现就是这么简单，只要实现了接口中的所有方法，就实现了这个接口。</p>
<h4 data-id="heading-33">接口类型变量</h4>
<p><strong>接口类型变量能够存储所有实现了该接口的实例</strong>。 例如上面的示例中，Sayer类型的变量能够存储dog和cat类型的变量。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> x Sayer <span class="hljs-comment">// 声明一个Sayer类型的变量x</span>
    a := cat{}  <span class="hljs-comment">// 实例化一个cat</span>
    b := dog{}  <span class="hljs-comment">// 实例化一个dog</span>
    x = a       <span class="hljs-comment">// 可以把cat实例直接赋值给x</span>
    x.say()     <span class="hljs-comment">// 喵喵喵</span>
    x = b       <span class="hljs-comment">// 可以把dog实例直接赋值给x</span>
    x.say()     <span class="hljs-comment">// 汪汪汪</span>
}
</code></pre>
<p><strong>值接收者实现接口</strong> 接口类型变量 可以接受，普通结构体类型和指针结构体类型的赋值操作</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 值接收者实现接口</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d dog)</span></span> move() {
    fmt.Println(<span class="hljs-string">"狗会动"</span>)
}
</code></pre>
<p><strong>指针接收者实现接口</strong> 接口类型变量  只能接受，指针结构体类型的赋值操作</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *dog)</span></span> move() {
    fmt.Println(<span class="hljs-string">"狗会动"</span>)
}
</code></pre>
<h4 data-id="heading-34">空接口</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> i <span class="hljs-keyword">interface</span>{}
fmt.Println(<span class="hljs-string">"类型：%T，值：%v\n"</span>, i, i) <span class="hljs-comment">// 类型：&lt;nil&gt;，值：&lt;nil&gt;</span>

i = <span class="hljs-number">123</span>
i = <span class="hljs-string">"123"</span>
i = <span class="hljs-literal">true</span>
i = <span class="hljs-number">3.14</span>
</code></pre>
<p>可以借助这一特性，使上面的 <code>i</code>变量<strong>可以接受任何类型的赋值操作</strong>，反之拥有<code>interface{}</code>类型的变量<strong>不能赋值</strong>给其他类型</p>
<h5 data-id="heading-35">类型断言</h5>
<p>判断空接口是什么类型，使用<code>x.(T)</code>语法</p>
<ul>
<li>x：表示类型为interface{}的变量</li>
<li>T：表示断言x可能是的类型。</li>
</ul>
<p>例子</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> x <span class="hljs-keyword">interface</span>{}
    x = <span class="hljs-string">"zhangsan"</span>
    v, ok := x.(<span class="hljs-type">string</span>)
    <span class="hljs-keyword">if</span> ok {
        fmt.Println(v)
    } <span class="hljs-keyword">else</span> {
        fmt.Println(<span class="hljs-string">"类型断言失败"</span>)
    }
}
</code></pre>
<p>返回两个参数 ，第一个v是实际值，第二个ok是布尔值，<strong>意为当前x的值是否为string类型</strong></p>
<h3 data-id="heading-36">协程</h3>
<p><strong>协程（Coroutine）</strong> 是一种强大的<strong>程序设计结构</strong>，它允许多个任务在单个<strong>线程</strong><sup><a href="#user-content-fn-1" id="user-content-user-content-fnref-1" data-footnote-ref="" aria-describedby="footnote-label" title="#user-content-fn-1">1</a></sup>内<strong>并发</strong><sup><a href="#user-content-fn-2" id="user-content-user-content-fnref-2" data-footnote-ref="" aria-describedby="footnote-label" title="#user-content-fn-2">2</a></sup>执行，通过协作式的任务切换来提高程序的性能和响应性。在<strong>Go语言中，协程被称为Goroutines</strong>，是语言层面的原生支持，使得并发编程变得异常简单和高效。</p>
<p><strong>一个线程上可以跑多个协程，协程是轻量级的线程。</strong></p>
<p>go语言中的<code>main</code>函数称为<strong>主协程</strong>，可以将协程理解为一个主协程中的多个子协程，主协程结束，子协程函数跟着结束</p>
<p>Goroutine是Go运行时管理的轻量级线程</p>
<h4 data-id="heading-37">如何开启goroutine</h4>
<p>调用函数的时候在前面加上<code>go关键字</code>，就可以为一个函数创建一个goroutine。</p>
<p>例子</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"fmt"</span>
  <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sing</span><span class="hljs-params">()</span></span> {
  fmt.Println(<span class="hljs-string">"唱歌"</span>)
  time.Sleep(<span class="hljs-number">1</span> * time.Second)
  fmt.Println(<span class="hljs-string">"唱歌结束"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">go</span> sing()
  <span class="hljs-keyword">go</span> sing()
  <span class="hljs-keyword">go</span> sing()
  <span class="hljs-keyword">go</span> sing()
  time.Sleep(<span class="hljs-number">2</span> * time.Second)
}

</code></pre>
<p>如果我把这个主线程中的延时去掉之后，你会发现程序没有任何输出就结束了</p>
<p>这是为什么呢</p>
<p>那是因为主线程结束协程自动结束，主线程不会等待协程的结束</p>
<h4 data-id="heading-38">WaitGroup</h4>
<p>我们只需要让主线程等待协程就可以了，它的用法是这样的</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"fmt"</span>
  <span class="hljs-string">"sync"</span>
  <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">var</span> (
  wait = sync.WaitGroup{}
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sing</span><span class="hljs-params">()</span></span> {
  fmt.Println(<span class="hljs-string">"唱歌"</span>)
  time.Sleep(<span class="hljs-number">1</span> * time.Second)
  fmt.Println(<span class="hljs-string">"唱歌结束"</span>)
  wait.Done()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
  wait.Add(<span class="hljs-number">4</span>) <span class="hljs-comment">// 不能为负数</span>
  <span class="hljs-keyword">go</span> sing()
  <span class="hljs-keyword">go</span> sing()
  <span class="hljs-keyword">go</span> sing()
  <span class="hljs-keyword">go</span> sing()
  wait.Wait()
  fmt.Println(<span class="hljs-string">"主线程结束"</span>)
}

</code></pre>
<h3 data-id="heading-39">channel</h3>
<p>单纯地将函数并发执行是没有意义的。函数与函数间需要交换数据才能体现并发执行函数的意义。</p>
<p><strong>channel（通道）</strong> 是golang在goroutine之间的通讯方式</p>
<blockquote>
<p><strong>通道格式</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> 变量 <span class="hljs-keyword">chan</span> 元素类型
</code></pre>
</blockquote>
<h4 data-id="heading-40">创建channel</h4>
<p>通道是引用类型，通道类型的空值是<code>nil</code></p>
<p>声明的通道后需要使用<code> make(chan 元素类型, [缓冲大小])</code>函数初始化之后才能使用。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">var</span> ch <span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>
	fmt.Println(ch) <span class="hljs-comment">// &lt;nil&gt;</span>
	
	<span class="hljs-comment">// 初始化通道</span>
	ch = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">//  初始化一个 有一个缓冲位的通道</span>
	
	<span class="hljs-comment">// 可以用短声明简写</span>
	ch2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">bool</span>, <span class="hljs-number">2</span>)
}
</code></pre>
<h4 data-id="heading-41">操作channel</h4>
<p>通道有发送（send）、接收(receive）和关闭（close）三种操作</p>
<p><strong>注意：发送和接收都使用<code>&lt;</code>和<code>-</code> 拼接在一起的<code>&lt;-</code>操作符，只是通道变量在操作符的位置不同</strong></p>
<ul>
<li><strong>发送</strong>
将指定类型的值发送到此通道中</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 初始化通道</span>
	ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">1</span>) 
	ch &lt;- <span class="hljs-number">10</span> <span class="hljs-comment">// 把10发送到ch中</span>
}
</code></pre>
<ul>
<li><strong>接收</strong>
从一个通道中接收值，获取值</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 初始化通道</span>
	ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">1</span>) 
	ch &lt;- <span class="hljs-number">10</span>
	
	x := &lt;- ch <span class="hljs-comment">// 从ch中接收值并赋值给变量x</span>
	&lt;-ch       <span class="hljs-comment">// 从ch中接收值，忽略结果</span>
}
</code></pre>
<ul>
<li><strong>关闭</strong>
我们通过调用内置的<code>close</code>函数来关闭通道</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 初始化通道</span>
	ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">1</span>) 
	ch &lt;- <span class="hljs-number">10</span>
	
	x := &lt;- ch 
	&lt;-ch 
	
	<span class="hljs-built_in">close</span>(ch) <span class="hljs-comment">// 关闭当前ch通道</span>
}
</code></pre>
<h4 data-id="heading-42">无缓冲的通道</h4>
<p>在创建channel时使用<code>make()</code>创建，此方法的第二个参数不传则是<strong>无缓冲通道</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf8c7fb7a268495e9157ba98332a09af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ2l0Ym95emNm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200384&amp;x-signature=TPlX32jkX%2F0A8i44qPDF1su%2BrLc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>无缓冲的通道只有在有人接收值的时候才能发送值。<strong>就像你住的小区没有快递柜和代收点，快递员给你打电话必须要把这个物品送到你的手中</strong>，简单来说就是无缓冲的通道必须有接收才能发送。</p>
<p>没有接收者，可以被编译成功，但会报一个<strong>死锁</strong>的错误<code> fatal error: all goroutines are asleep - deadlock!</code></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
    ch &lt;- <span class="hljs-number">10</span>
    fmt.Println(<span class="hljs-string">"发送成功"</span>)
    <span class="hljs-comment">// fatal error: all goroutines are asleep - deadlock!</span>
}
</code></pre>
<p>上面的代码会阻塞在<code>ch &lt;- 10</code>这一行代码形成死锁，那如何解决这个问题呢？</p>
<p>一种方法是启用一个goroutine去接收值，例如：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">recv</span><span class="hljs-params">(c <span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> {
    ret := &lt;-c
    fmt.Println(<span class="hljs-string">"接收成功"</span>, ret)
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
    <span class="hljs-keyword">go</span> recv(ch) <span class="hljs-comment">// 启用goroutine从通道接收值</span>
    ch &lt;- <span class="hljs-number">10</span>
    fmt.Println(<span class="hljs-string">"发送成功"</span>)
}
</code></pre>
<h4 data-id="heading-43">有缓冲的通道</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd9b604ad80b4c2aad8ef837de0b837f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ2l0Ym95emNm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200384&amp;x-signature=dOFu%2FPaMm5Rw%2B7QQzzopkhB6e8o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我们可以在使用<code>make</code>函数初始化通道的时候为其指定通道的容量
例如：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// 创建一个容量为1的有缓冲区通道</span>
    ch &lt;- <span class="hljs-number">10</span>
    fmt.Println(<span class="hljs-string">"发送成功"</span>)
}
</code></pre>
<p>只要通道的容量大于零，那么该通道就是有缓冲的通道，通道的容量表示通道中能存放元素的数量。<strong>就像你小区的快递柜只有那么个多格子，格子满了就装不下了，就阻塞了，等到别人取走一个快递员就能往里面放一个</strong>。</p>
<h4 data-id="heading-44">单向通道</h4>
<p>就是限制通道在函数中只能发送或只能接收</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">counter</span><span class="hljs-params">(out <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ {
        out &lt;- i
    }
    <span class="hljs-built_in">close</span>(out)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">squarer</span><span class="hljs-params">(out <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">int</span>, in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> in {
        out &lt;- i * i
    }
    <span class="hljs-built_in">close</span>(out)
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printer</span><span class="hljs-params">(in &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> in {
        fmt.Println(i)
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch1 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
    ch2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
    <span class="hljs-keyword">go</span> counter(ch1)
    <span class="hljs-keyword">go</span> squarer(ch2, ch1)
    printer(ch2)
}
</code></pre>
<pre><code class="hljs language-go" lang="go"><span class="hljs-number">1.</span><span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">int</span>是一个只能发送的通道，可以发送但是不能接收；
<span class="hljs-number">2.</span>&lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>是一个只能接收的通道，可以接收但是不能发送。
</code></pre>
<p>在函数传参及任何赋值操作中将双向通道转换为单向通道是可以的，但反过来是不可以的</p>
<h4 data-id="heading-45">select</h4>
<p>在某些场景下我们需要同时从多个通道接收数据。通道在接收数据时，如果没有数据可以接收将会发生阻塞。</p>
<p>Go内置了<code>select</code>关键字，可以同时响应多个通道的操作。</p>
<p>select的使用类似于switch语句，下面是格式：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> &lt;-chan1:
       <span class="hljs-comment">// 如果chan1成功读到数据，则进行该case处理语句</span>
    <span class="hljs-keyword">case</span> chan2 &lt;- <span class="hljs-number">1</span>:
       <span class="hljs-comment">// 如果成功向chan2写入数据，则进行该case处理语句</span>
    <span class="hljs-keyword">default</span>:
       <span class="hljs-comment">// 如果上面都没有成功，则进入default处理流程</span>
}
</code></pre>
<h3 data-id="heading-46">并发安全和锁</h3>
<p>当进行并发协程同时操作一个资源时，导致两者出现竞争，最后输出结果不一，称为<strong>并发不安全</strong></p>
<p>这是为什么呢？</p>
<blockquote>
<p>根本原因是CPU的调度方法为抢占式执行，随机调度</p>
</blockquote>
<p>怎样才能做到并发安全呢？可以使用<strong>锁（Lock）</strong> 的方式</p>
<p>举个并发不安全的例子：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"fmt"</span>
  <span class="hljs-string">"sync"</span>
)

<span class="hljs-keyword">var</span> num <span class="hljs-type">int</span>
<span class="hljs-keyword">var</span> wait sync.WaitGroup

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ {
    num++
  }
  wait.Done()
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reduce</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ {
    num--
  }
  wait.Done()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
  wait.Add(<span class="hljs-number">2</span>)
  <span class="hljs-keyword">go</span> add()
  <span class="hljs-keyword">go</span> reduce()
  wait.Wait()
  fmt.Println(num) <span class="hljs-comment">// ?</span>

}
</code></pre>
<p>可以看出两个协程函数<code>add、reduce</code> 对<code>num</code>同时去加减操作，正常情况下结果应该为 0，但是每次运行结果都不一样。</p>
<h4 data-id="heading-47">互斥锁</h4>
<p>Go语言中使用<code>sync</code>包的<code>Mutex</code>类型来实现互斥锁。 使用互斥锁来修复上面代码的问题</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"fmt"</span>
  <span class="hljs-string">"sync"</span>
)

<span class="hljs-keyword">var</span> num <span class="hljs-type">int</span>
<span class="hljs-keyword">var</span> wait  sync.WaitGroup
<span class="hljs-keyword">var</span> lock  sync.Mutex

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span> {
  <span class="hljs-comment">// 谁先抢到了这把锁，谁就把它锁上，一旦锁上，其他的线程就只能等着</span>
  lock.Lock()
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ {
    num++
  }
  lock.Unlock()
  wait.Done()
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reduce</span><span class="hljs-params">()</span></span> {
  lock.Lock()
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ {
    num--
  }
  lock.Unlock()
  wait.Done()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
  wait.Add(<span class="hljs-number">2</span>)
  <span class="hljs-keyword">go</span> add()
  <span class="hljs-keyword">go</span> reduce()
  wait.Wait()
  fmt.Println(num)
}
</code></pre>
<h4 data-id="heading-48">读写互斥锁</h4>
<p>当我们读取一个资源时没有对资源进行写操作，不需要加锁；反之，有读取也有写入操作时可以使用<strong>读写互斥锁</strong></p>
<p><strong>读写锁适合读多写少的场景</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
 
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"sync"</span>
	<span class="hljs-string">"time"</span>
)
 
<span class="hljs-keyword">var</span> x <span class="hljs-type">int64</span>
<span class="hljs-keyword">var</span> wg sync.WaitGroup
<span class="hljs-keyword">var</span> lock sync.Mutex
<span class="hljs-keyword">var</span> rwlock sync.RWMutex
 
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">write</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">defer</span> wg.Done()
	<span class="hljs-comment">// lock.Lock() //加互斥锁</span>
	rwlock.Lock() <span class="hljs-comment">//加写锁</span>
	x++
	time.Sleep(time.Microsecond * <span class="hljs-number">10</span>)
	rwlock.Unlock() <span class="hljs-comment">//解写锁</span>
	<span class="hljs-comment">// lock.Unlock() //解互斥锁</span>
}
 
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">defer</span> wg.Done()
	<span class="hljs-comment">// lock.Lock()  //加互斥锁</span>
	rwlock.RLock() <span class="hljs-comment">//加读锁</span>
	time.Sleep(time.Millisecond)
	rwlock.RUnlock() <span class="hljs-comment">//解读锁</span>
	<span class="hljs-comment">// lock.Unlock() //解互斥锁</span>
}
 
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	start := time.Now()
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ {
		wg.Add(<span class="hljs-number">1</span>)
		<span class="hljs-keyword">go</span> write()
	}
	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ {
		wg.Add(<span class="hljs-number">1</span>)
		<span class="hljs-keyword">go</span> read()
	}
	wg.Wait()
	end := time.Now()
	fmt.Println(end.Sub(start))
}
</code></pre>
<h4 data-id="heading-49">线程安全下的map</h4>
<p>如果我们在一个协程函数下，读写map就会引发一个错误</p>
<p>concurrent map read and map write</p>
<p>希望大家见到这个错误，就能知道，这个就是map的线程安全错误</p>
<p>Go语言的<code>sync</code>包中提供了一个开箱即用的并发安全版map——<code>sync.Map</code></p>
<p>sync.Map内置了诸如<code>Store、Load、LoadOrStore、Delete、Range</code>等操作方法。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"fmt"</span>
  <span class="hljs-string">"sync"</span>
  <span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">var</span> wait sync.WaitGroup
<span class="hljs-keyword">var</span> mp = sync.Map{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reader</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">for</span> {

    fmt.Println(mp.Load(<span class="hljs-string">"time"</span>))
  }
  wait.Done()
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">writer</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">for</span> {
    mp.Store(<span class="hljs-string">"time"</span>, time.Now().Format(<span class="hljs-string">"15:04:05"</span>))
  }
  wait.Done()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
  wait.Add(<span class="hljs-number">2</span>)
  <span class="hljs-keyword">go</span> reader()
  <span class="hljs-keyword">go</span> writer()
  wait.Wait()
}

</code></pre>
<h3 data-id="heading-50">内置函数</h3>
<h4 data-id="heading-51">new</h4>
<p>new是一个内置的函数，用于分配内存</p>
<blockquote>
<p>*<em>函数签名：func new(Type) <em>Type</em></em></p>
<ol>
<li>Type表示类型，new函数只接受一个参数，这个参数是一个类型</li>
<li>*Type表示类型指针，new函数返回一个指向该类型内存地址的指针。</li>
</ol>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> a *<span class="hljs-type">int</span>
    a = <span class="hljs-built_in">new</span>(<span class="hljs-type">int</span>)
    *a = <span class="hljs-number">10</span>
    fmt.Println(*a) <span class="hljs-comment">// 10</span>
}
</code></pre>
<h4 data-id="heading-52">make</h4>
<p>make也是用于内存分配的，区别于new，它只用于**切片（slice）、map以及通道（channel）**的内存创建，它返回的类型就是这三个类型本身，而不是他们的指针类型，因为这三种类型就是引用类型，所以就没有必要返回他们的指针了</p>
<blockquote>
<p><strong>函数签名：func make(t Type, size ...IntegerType) Type</strong></p>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> b <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>
    b = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>, <span class="hljs-number">10</span>)
    b[<span class="hljs-string">"测试"</span>] = <span class="hljs-number">100</span>
    fmt.Println(b) <span class="hljs-comment">// map[测试:100]</span>
}
</code></pre>
<blockquote>
<p><strong>new与make的区别</strong></p>
<ol>
<li>二者都是用来做内存分配的。</li>
<li>make只用于slice、map以及channel的初始化，返回的还是这三个引用类型本身；</li>
<li>而new用于类型的内存分配，并且内存对应的值为类型零值，返回的是指向类型的指针。</li>
</ol>
</blockquote>
<h2 data-id="heading-53">常用库解析</h2>
<h3 data-id="heading-54">fmt</h3>
<p>用于格式化输出文本</p>
<ol>
<li>%v：通用类型占位符。可以表示任意值的类型。</li>
<li>%d：10进制整数</li>
<li>%f：浮点数</li>
<li>%s：字符串</li>
<li>%t：布尔值</li>
<li>%c：字符（Unicode码点）</li>
<li>%p：指针地址</li>
<li>%e/%E：科学计数法</li>
<li>%b：二进制整数</li>
<li>%o：八进制整数</li>
<li>%x/%X：十六进制整数</li>
<li>%U：Unicode格式，表示为U+十六进制数</li>
<li>%T：打印值的类型</li>
</ol>
<h2 data-id="heading-55">Go Modules</h2>
<p>Go Module（go mod）是Go语言官方依赖管理工具，从<code>Go 1.11</code>版本开始引入，取代GOPATH模式，用于管理项目依赖、版本控制和模块发布。
‌</p>
<h3 data-id="heading-56">初始化模块</h3>
<p>在项目根目录下终端执行以下命令来初始化一个新的模块：</p>
<pre><code class="hljs language-bash" lang="bash">go mod init 项目名

<span class="hljs-comment"># 例如</span>
go mod init myproject
</code></pre>
<h3 data-id="heading-57">添加依赖</h3>
<p>当你在代码中导入外部包并运行<code>go build</code>或<code>go run</code>时，Go会自动下载依赖并记录到<code>go.mod</code>文件中。</p>
<pre><code class="hljs language-bash" lang="bash">go get 包名

<span class="hljs-comment"># 例如</span>
go get github.com/gin-gonic/gin <span class="hljs-comment"># 这会下载最新版本</span>

<span class="hljs-comment"># 指定版本可用</span>
go get github.com/gin-gonic/gin@v1.9.1
</code></pre>
<h3 data-id="heading-58">依赖管理常用命令</h3>
<p>日常开发中常用的<code>go mod</code>命令包括：</p>
<ul>
<li><strong>go mod tidy</strong>：清理未使用的依赖，补全缺失的依赖</li>
<li><strong>go mod download</strong>：下载所有<code>go.mod</code>中的依赖</li>
<li><strong>go mod vendor</strong>：将依赖复制到<code>vendor/</code>目录（可选）</li>
<li><strong>go mod verify</strong>：验证依赖是否被篡改</li>
<li><strong>go list -m all</strong>：列出当前模块的所有依赖</li>
<li><strong>go list -m -u all</strong>：检查依赖是否有新版本</li>
</ul>
<p><br/><br/><br/><br/>
<strong>到这里就结束了，后续还会更新 go 系列相关，还请持续关注！</strong>
<strong>感谢阅读，若有错误可以在下方评论区留言哦！！！</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e3acee0de1a47da9d1b3a0a1399ab2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ2l0Ym95emNm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200384&amp;x-signature=qRD2t47CI3atpPGQoLeMYD%2BtcnE%3D" alt="111" loading="lazy"/></p>
<h3 class="sr-only" id="user-content-footnote-label" data-id="heading-59">Footnotes</h3>
<ol>
<li id="user-content-user-content-fn-1">
<blockquote>
<p>线程是进程的一个执行实体,是CPU调度和分派的基本单位,它是比进程更小的能独立运行的基本单位。
一个进程可以创建和撤销多个线程;同一个进程中的多个线程之间可以并发执行。</p>
</blockquote>
<a href="#user-content-fnref-1" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content" title="#user-content-fnref-1">↩</a>
</li>
<li id="user-content-user-content-fn-2">
<blockquote>
<p>多线程程序在一个核的cpu上运行，就是<strong>并发</strong>。
多线程程序在多个核的cpu上运行，就是<strong>并行</strong>。</p>
</blockquote>
<a href="#user-content-fnref-2" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content" title="#user-content-fnref-2">↩</a>
</li>
</ol>
</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JuiceFS 2025：迈入千亿文件规模，开源第五年持续高速增长]]></title>    <link>https://juejin.cn/post/7591544356001316874</link>    <guid>https://juejin.cn/post/7591544356001316874</guid>    <pubDate>2026-01-05T06:51:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591544356001316874" data-draft-id="7591670569909846062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JuiceFS 2025：迈入千亿文件规模，开源第五年持续高速增长"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-05T06:51:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JuiceFS"/> <meta itemprop="url" content="https://juejin.cn/user/2665636828032446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JuiceFS 2025：迈入千亿文件规模，开源第五年持续高速增长
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2665636828032446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JuiceFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T06:51:57.000Z" title="Mon Jan 05 2026 06:51:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>又到了给大家汇报全年社区工作的时候。2025 年， JuiceFS 企业版发布的第九年，社区版的第五年。这一年，我们专注一如既往，打造一款高效易用的文件系统。</p>
<p>各项使用指标延续了上一年的增长势头，<strong>社区版数据量增长 89%，超 1.3 EB；营收连续第三年 100% 增长</strong>，是我们持续投入社区的坚实保障。</p>
<p>2025 年，JuiceFS 社区版继续聚焦通用性，尤其在支持各类  AI 场景的需求。发布了 Python SDK、增强 Windows 客户端可用性，并加强了对云原生生态的支持；此外，元数据引擎 SQL 和 TiKV 也进行了针对性优化。今年，团队与社区成员一道推动了 JuiceFS 的持续迭代，共有 60 位贡献者参与，新增了 305 个 Issue，合并了 601 个 PR。</p>
<p>在企业版的开发过程中，团队今年面临的最大挑战来自于<strong>超大规模数据的管理</strong>。随着自动驾驶等 AI 技术逐渐融入日常生活，数据规模的增长是空前的，在千亿文件级别下，元数据管理、数据一致性等方面的管理复杂度指数级增加。为应对这些难题，企业版在元数据分区、网络性能等核心特性上进行了全面升级。<strong>上半年发布的企业版 5.2 已支持单卷千亿规模，即将发布的 5.3 版本更将支持 5,000 亿规模</strong>，让用户不必再为数据规模发愁，JuiceFS 的性能和稳定性也都能够稳妥保障。</p>
<h2 data-id="heading-0">01 社区版：支持 Python SDK、 Windows 客户端可用性大幅提升</h2>
<p>JuiceFS 自开源以来已在企业生产环境中得到了长时间的验证，核心功能逐步趋于稳定。全年发布了 9 个版本，其中 1.3 版本是继 2021 年开源以来的第四个重要版本，并作为长期支持版本（LTS）。该版本的主要优化包括：</p>
<ul>
<li><strong>支持 Python SDK</strong> ，提升了 AI 和数据科学场景下的灵活性和性能；</li>
<li><strong>Windows 客户端的优化</strong>，增强了工具支持和系统服务挂载能力；</li>
<li><strong>备份机制优化</strong>，1 亿文件备份分钟级完成；</li>
<li><strong>集成 Apache Ranger</strong>，JuiceFS 支持大数据场景中的细粒度的权限管理；</li>
<li><strong>元数据引擎方面，SQL 和 TiKV 的性能提升</strong>，在超大规模场景下表现更加高效。</li>
</ul>
<p>下半年，团队开始积极筹备 1.4 ，计划新增多个特性，包括用户和用户组 Quota 支持、Redis 客户端缓存支持、LRU 缓存支持、SMB/CIFS 支持、Hadoop Kerberos 支持、S3 Gateway 优化、Sync 工具断点续传，数据商业算法加密支持，预读策略优化、批量删除优化和周边工具优化等 ，以进一步提升系统的性能和稳定性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fd27085916a4cc292bd15eb108334a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200716&amp;x-signature=dYBtenw0b9mQVX%2BJe%2BgdXDGz6t8%3D" alt="" loading="lazy"/></p>
<p>JuiceFS CSI Driver 在过去一年发布了 18 个版本，持续优化 JuiceFS 在 Kubernetes 等环境中的存储效率和稳定性。新增功能包括卷路径健康状态检测、同一文件系统共享 Mount Pod 功能、支持 Kubernetes 原生 Sidecar，以及 Dashboard 的 CacheGroup 管理。此外，还进行了性能和可靠性优化，不仅提升了稳定性，同时改进了多 Pod 配置和容器化应用的兼容性。</p>
<p>JuiceFS Operator，新增了定时缓存预热 功能，提升业务访问数据的性能；支持按副本部署的 CacheGroup，实现了缓存高可用性；并引入 Sync 功能，在 Kubernetes 环境中高效同步数据，确保一致性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e115e6a39324afe85d29b3331092d35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200716&amp;x-signature=DRCFKuEDlMP90eOxZWbWYPnCJP0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">02 企业版：单卷千亿规模文件，强劲性能与稳定性保障</h2>
<p>2025 年上半年，JuiceFS 企业版 5.2 版本发布，单个文件系统突破千亿文件的规模，并显著提升了超大规模集群的稳定性和分布式缓存的网络性能。为了实现这一目标，团队投入了大量时间和精力进行优化，特别是在处理超大数据集和高并发访问时的性能提升。<strong>该版本已在多个企业的生产环境中得到验证，单卷千亿文件规模下保持 1 毫秒元数据时延水平</strong>。同时，分布式缓存网络性能优化，TCP 网络下大幅减少 CPU 开销，同时提升网络带宽利用率。<strong>在 100 台 GCP 100Gbps 节点的环境下，聚合读带宽达到 1.2 TB/s，接近满负荷利用 TCP/IP 网络带宽</strong>。</p>
<p>此外， Python SDK 实现了 fsspec 兼容、按需导入对象存储文件，可以更方便的访问对象存储存量数据、解决特殊场景中的读放大问题以及提升全局 QoS 能力，进一步增强了系统的灵活性和性能。</p>
<p>多分区架构是 JuiceFS 应对千亿文件规模的关键技术之一，保证了系统的高扩展性和高并发处理能力。<strong>下半年我们的核心工作集中在 5.3 版本，对多分区架构进行了全面优化，分区限制从 256 个提升至 1,024 个，可实现单卷超过 5,000 亿文件的存储和访问需求</strong>。</p>
<p>这背后是一系列复杂的工作，包括系统化整理跨分区链接实现，并实现后台自检机制，提升集群的可靠性与稳定性；开发热点监测与自动迁移工具，高效处理热点问题；优化分布式缓存管理，减少缓存冲突并提高并发性能；此外，为了进一步优化分布式网络的性能，在这个版本中首次引入了 RDMA 技术，目前处于实验阶段，测试结果显示其在稳定性和 CPU 使用率方面优于 TCP 协议。5.3 版本将于 1 月发布，更多细节，欢迎关注。</p>
<h2 data-id="heading-2">03 社区发展，第 5 年高速成长，数据总量超 1.3EB</h2>
<p>目前，JuiceFS GitHub star 超 12.6K；JuiceFS 下载量突破了 5 万次，CSI Driver 的下载量超过了 500 万次；中文社区已经有 10 个微信群组，Slack 英文社区也达千人。</p>
<p>社区版开源的第 5 年，也是快速增长的第 5 个年头。用户上报数据显示，JuiceFS 的各项关键数据延续了增长趋势：</p>
<ul>
<li>文件系统 590K+，增长 82%</li>
<li>活跃客户端 150K+，增长 46%</li>
<li>文件数量 4000 亿+，增长 43%</li>
<li>数据总量 1.3EiB+，增长 89%</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35da60df9823409d94145791ff464c2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768200716&amp;x-signature=6vSuYg9f1a%2BPtKIo61q2JjVEcFY%3D" alt="" loading="lazy"/></p>
<p>今年，我们在多个行业大会分享实践，KCD 、开源年会、CommunityOverCode Asia 等，感谢这些大会主办方对 JuiceFS 的认可；在海外行业会议也展露头脚，参与了 KubeCon+CloudNative Con North America、Opensource Summit Japan、SNIA Developer Conference 等。</p>
<p>为了更好地为用户提供支持，我们定期举办 Office Hours，介绍新功能、解答疑问；同时，举办了 11 场 Meetup，帮助不同行业的用户更有信心地将 JuiceFS 应用于生产环境。案例涵盖自动驾驶、生成式 AI、AI 基础平台、量化投资、生命医药等多个领域。（查看所有<a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2Fblog%2Fuser-stories" target="_blank" title="https://juicefs.com/zh-cn/blog/user-stories" ref="nofollow noopener noreferrer">案例</a>）</p>
<p>特别感谢以下今年参与分享的用户，他们的实践经验为社区提供了宝贵的参考：</p>
<ol>
<li>丁聪，Lepton AI，<a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2Fblog%2Fuser-stories%2Flepton-ai-build-multi-tenant-low-latency-cloud-storage-platform" target="_blank" title="https://juicefs.com/zh-cn/blog/user-stories/lepton-ai-build-multi-tenant-low-latency-cloud-storage-platform" ref="nofollow noopener noreferrer">加速 AI 训推：构建多租户、低延迟云存储平台 </a></li>
<li>孙玮，中国科学院计算所，<a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2Fblog%2Fuser-stories%2Fnfs-vs-juicefs-llm-storage" target="_blank" title="https://juicefs.com/zh-cn/blog/user-stories/nfs-vs-juicefs-llm-storage" ref="nofollow noopener noreferrer">基于 JuiceFS 的大模型训推平台存储演进之路</a></li>
<li>郑泽东，百图生科，<a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2Fblog%2Fuser-stories%2Fbiomap-juicefs-building-llm-storage" target="_blank" title="https://juicefs.com/zh-cn/blog/user-stories/biomap-juicefs-building-llm-storage" ref="nofollow noopener noreferrer">基于 JuiceFS 构建生命科学大模型存储平台，成本降 90%</a></li>
<li>吴松林，携程，<a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2Fblog%2Fuser-stories%2Ftrip-10pb-level-llm-stroage-juicefs-practice" target="_blank" title="https://juicefs.com/zh-cn/blog/user-stories/trip-10pb-level-llm-stroage-juicefs-practice" ref="nofollow noopener noreferrer">稳定且高性价比的大模型存储：携程 10PB 级 JuiceFS 工程实践</a></li>
<li>唐义凡，合合信息，<a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2Fblog%2Fuser-stories%2Fintsig-use-juicefs-build-unified-storage-support-pb-ai-training" target="_blank" title="https://juicefs.com/zh-cn/blog/user-stories/intsig-use-juicefs-build-unified-storage-support-pb-ai-training" ref="nofollow noopener noreferrer">基于 JuiceFS 构建统一存储，支撑 PB 级 AI 训练</a></li>
<li>缪昌新，阶跃星辰，<a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2Fblog%2Fuser-stories%2Fstepfun-ai-use-juicefs-create-multimodal-learning-storage-platform" target="_blank" title="https://juicefs.com/zh-cn/blog/user-stories/stepfun-ai-use-juicefs-create-multimodal-learning-storage-platform" ref="nofollow noopener noreferrer">如何利用 JuiceFS 打造高效经济的大模型存储平台</a></li>
<li>可加，稿定科技，<a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2Fblog%2Fuser-stories%2Fgaoding-ai-storage-challenges-multi-cloud-juicefs" target="_blank" title="https://juicefs.com/zh-cn/blog/user-stories/gaoding-ai-storage-challenges-multi-cloud-juicefs" ref="nofollow noopener noreferrer">多云架构下的 AI 存储挑战与 JuiceFS 实践</a></li>
<li>邓君宇，九识智能，<a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2Fblog%2Fuser-stories%2Fintsig-juicefs-autonomous-driving-multi-cloud-storage" target="_blank" title="https://juicefs.com/zh-cn/blog/user-stories/intsig-juicefs-autonomous-driving-multi-cloud-storage" ref="nofollow noopener noreferrer">基于 JuiceFS 的自动驾驶多云亿级文件存储</a></li>
<li>高玉堂， Ariste AI，<a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2Fblog%2Fuser-stories%2Fjuicefs-minio-ariste-ai-quant-storage" target="_blank" title="https://juicefs.com/zh-cn/blog/user-stories/juicefs-minio-ariste-ai-quant-storage" ref="nofollow noopener noreferrer">JuiceFS + MinIO：量化投资高性能存储实践</a></li>
<li>李威宇，光影焕像，基于 JuiceFS 搭建 3D AIGC 存储平台，数据性能 2 倍提升</li>
<li>刘道全，始智 AI，基于 JuiceFS 打造高性能、低成本 AI 模型管理存储平台</li>
<li>高杨，酷睿程，自动驾驶百 PB 级云原生存储案例</li>
<li>曾奥涵，智谱 AI，大模型训练基础设施落地实践</li>
</ol>
<p>亲爱的社区伙伴们，我们一起度过了充实的一年。JuiceFS 从一个开源新秀，成长为今天 AI 业务中备受信任的选择，衷心感谢每一位社区成员的参与与支持，感谢你们在群里解答问题、分享实践、贡献代码！</p>
<p>新的一年里，JuiceFS 将继续为你的工作带来更高效、更轻松的体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Prometheus 动态指标可视化的深度优化：Counter 与 Gauge 的差异化处理]]></title>    <link>https://juejin.cn/post/7591420438850109476</link>    <guid>https://juejin.cn/post/7591420438850109476</guid>    <pubDate>2026-01-05T05:05:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591420438850109476" data-draft-id="7591410544928276522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Prometheus 动态指标可视化的深度优化：Counter 与 Gauge 的差异化处理"/> <meta itemprop="keywords" content="后端,架构,监控"/> <meta itemprop="datePublished" content="2026-01-05T05:05:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Prometheus 动态指标可视化的深度优化：Counter 与 Gauge 的差异化处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T05:05:39.000Z" title="Mon Jan 05 2026 05:05:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文是《<a href="https://juejin.cn/post/7589544380518465546" target="_blank" title="https://juejin.cn/post/7589544380518465546">告别 Grafana 手搓 Dashboard：基于指标分组的 Prometheus 可视化新方案</a>》的深度实践篇</p>
</blockquote>
<h2 data-id="heading-0">一、一个让人困惑的监控图</h2>
<h3 data-id="heading-1">16:05 发生了什么？</h3>
<p>下午 4 点，订单团队的小王收到告警：<strong>订单创建失败</strong>。他立刻打开监控平台，点击"订单监控"菜单，看到这样一张图：</p>
<pre><code class="hljs language-scss" lang="scss">alarm_log_error_total (订单创建失败)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 <span class="hljs-number">1</span> |                    ╭─╮
   |                    │ │
   |                    │ │
 <span class="hljs-number">0</span> |────────────────────╯ ╰─────────
   └──────────────────────────────────
   <span class="hljs-number">16</span>:<span class="hljs-number">00</span>  <span class="hljs-number">16</span>:<span class="hljs-number">05</span>  <span class="hljs-number">16</span>:<span class="hljs-number">10</span>  <span class="hljs-number">16</span>:<span class="hljs-number">15</span>  <span class="hljs-number">16</span>:<span class="hljs-number">20</span>
</code></pre>
<p>小王懵了：<strong>"16:05 明明发生了错误，为什么图上显示的是 0？"</strong></p>
<h3 data-id="heading-2">查看 Prometheus 原始数据</h3>
<p>他去 Prometheus 查询 <code>alarm_log_error_total</code>，看到：</p>
<pre><code class="hljs language-makefile" lang="makefile">时间      原始值
<span class="hljs-section">16:00     (不存在)</span>
<span class="hljs-section">16:01     (不存在)</span>
<span class="hljs-section">16:05     1        ← 第一次出现，错误已发生</span>
<span class="hljs-section">16:06     1        ← 保持不变</span>
<span class="hljs-section">16:07     1</span>
<span class="hljs-section">16:10     2        ← 又增加了1次</span>
<span class="hljs-section">16:11     2</span>
</code></pre>
<p><strong>原始数据清楚地记录了：16:05 发生了第一次错误，16:10 发生了第二次错误。</strong></p>
<p>可为什么图上看不出来？</p>
<hr/>
<h2 data-id="heading-3">二、问题根源：Prometheus 的 increase() 不适合这个场景</h2>
<h3 data-id="heading-4">传统做法：使用 increase()</h3>
<p>在 Grafana 或其他可视化工具中，监控 Counter 指标的标准做法是：</p>
<pre><code class="hljs language-promql" lang="promql">increase(alarm_log_error_total[1m])
</code></pre>
<p>这个查询的结果是：</p>
<pre><code class="hljs language-makefile" lang="makefile">时间      原始值    increase(1m)
<span class="hljs-section">16:05     1         0           ← 因为没有"前值"，无法计算增量</span>
<span class="hljs-section">16:06     1         0           ← 从 1 到 1，增量为 0</span>
<span class="hljs-section">16:07     1         0</span>
<span class="hljs-section">16:08     1         0</span>
<span class="hljs-section">16:09     1         0</span>
<span class="hljs-section">16:10     2         1           ← 从 1 到 2，增量为 1</span>
<span class="hljs-section">16:11     2         0</span>
</code></pre>
<p><strong>结果：除了 16:10 这个点，其他全是 0。</strong></p>
<p>小王看到的图就是基于这个结果画的——一条几乎全是 0 的线，只在 16:10 有一个小凸起。</p>
<h3 data-id="heading-5">为什么 increase() 会这样？</h3>
<p>Prometheus 的 <code>increase()</code> 函数计算的是<strong>时间窗口内的变化量</strong>：</p>
<ul>
<li>如果 Counter 从 0 变成 1，<code>increase()</code> = 1 ✓</li>
<li>如果 Counter 保持为 1，<code>increase()</code> = 0 ✗</li>
</ul>
<p>但在告警场景中：</p>
<ul>
<li>16:05 指标第一次被采集时，值就已经是 1（错误已经发生了）</li>
<li>后续几分钟没有新错误，值保持为 1</li>
<li><code>increase()</code> 认为"没有变化"，所以返回 0</li>
</ul>
<p><strong>Prometheus 的设计理念</strong>：关注的是"速率"和"累计趋势"，不是"瞬时事件"。</p>
<p>但业务团队要的是：<strong>"我就想知道每个时刻发生了几次错误"</strong>。</p>
<hr/>
<h2 data-id="heading-6">三、我们想要什么样的图？</h2>
<h3 data-id="heading-7">理想效果</h3>
<p>小王期望看到的图应该是这样：</p>
<pre><code class="hljs language-scss" lang="scss">alarm_log_error_total (订单创建失败次数)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 <span class="hljs-number">1</span> |     ╭─╮         ╭─╮
   |     │ │         │ │
   |     │ │         │ │
 <span class="hljs-number">0</span> |─────╯ ╰─────────╯ ╰──────────
   └──────────────────────────────────
   <span class="hljs-number">16</span>:<span class="hljs-number">00</span>  <span class="hljs-number">16</span>:<span class="hljs-number">05</span>  <span class="hljs-number">16</span>:<span class="hljs-number">10</span>  <span class="hljs-number">16</span>:<span class="hljs-number">15</span>  <span class="hljs-number">16</span>:<span class="hljs-number">20</span>
          ↑            ↑
       第一次错误    第二次错误
</code></pre>
<p><strong>清晰地看到</strong>：</p>
<ul>
<li>16:05 有一个波峰，值为 1</li>
<li>16:10 有一个波峰，值为 1</li>
<li>其他时刻值为 0（没有新增错误）</li>
</ul>
<h3 data-id="heading-8">对比两种图</h3>



































<table><thead><tr><th>时刻</th><th>Prometheus 原始值</th><th>传统 increase()</th><th>我们想要的</th></tr></thead><tbody><tr><td>16:05</td><td>1</td><td>0 ✗</td><td>1 ✓</td></tr><tr><td>16:06</td><td>1</td><td>0 ✓</td><td>0 ✓</td></tr><tr><td>16:10</td><td>2</td><td>1 ✓</td><td>1 ✓</td></tr><tr><td>16:11</td><td>2</td><td>0 ✓</td><td>0 ✓</td></tr></tbody></table>
<p><strong>关键差异</strong>：16:05 这个时刻，<code>increase()</code> 返回 0，但我们想要的是 1。</p>
<hr/>
<h2 data-id="heading-9">四、解决方案：计算相邻点的差值</h2>
<h3 data-id="heading-10">核心思路</h3>
<p>不使用 Prometheus 的 <code>increase()</code>，而是：</p>
<ol>
<li>查询原始 Counter 值</li>
<li>在后端计算相邻两个点的差值</li>
<li>把差值返回给前端</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">原始值:   <span class="hljs-section">[0, 0, 0, 1, 1, 1, 2, 2, 2]</span>
时间:    <span class="hljs-section">[t1,t2,t3,t4,t5,t6,t7,t8,t9]</span>

计算差值:
t2: 0 - <span class="hljs-attr">0</span> = <span class="hljs-number">0</span>
t3: 0 - <span class="hljs-attr">0</span> = <span class="hljs-number">0</span>
t4: 1 - <span class="hljs-attr">0</span> = <span class="hljs-number">1</span>  ← 第一次错误
t5: 1 - <span class="hljs-attr">1</span> = <span class="hljs-number">0</span>
t6: 1 - <span class="hljs-attr">1</span> = <span class="hljs-number">0</span>
t7: 2 - <span class="hljs-attr">1</span> = <span class="hljs-number">1</span>  ← 第二次错误
t8: 2 - <span class="hljs-attr">2</span> = <span class="hljs-number">0</span>
t9: 2 - <span class="hljs-attr">2</span> = <span class="hljs-number">0</span>

返回前端: <span class="hljs-section">[0, 0, 1, 0, 0, 1, 0, 0]</span>
时间:    <span class="hljs-section">[t2,t3,t4,t5,t6,t7,t8,t9]</span>
         ↑ 注意：第一个点 t1 被丢弃
</code></pre>
<p><strong>为什么丢弃第一个点？</strong></p>
<p>因为第一个点没有"前值"可比较，无法计算差值。丢弃它之后，每个返回的点都表示"相对于前一时刻的变化"。</p>
<h3 data-id="heading-11">技术架构</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Prometheus&lt;br/&gt;存储原始Counter] --&gt;|QueryRange| B[后端服务]
    B --&gt;|1.补齐时间点| C[完整时序]
    C --&gt;|2.计算差值| D[相邻点相减]
    D --&gt;|3.移除首点| E[返回增量值]
    E --&gt;|JSON| F[前端ECharts]
    F --&gt; G[波峰图]
    
    style D fill:#ff9999
    style G fill:#99ff99
</code></pre>
<hr/>
<h2 data-id="heading-12">五、后端核心实现（3 步搞定）</h2>
<h3 data-id="heading-13">步骤 1：查询原始 Counter 值</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 直接查询指标，不使用 increase() 或 rate()</span>
query := <span class="hljs-string">"alarm_log_error_total"</span>

result, _, err := promAPI.QueryRange(ctx, query, v1.Range{
    Start: startTime,
    End:   endTime,
    Step:  <span class="hljs-number">30</span> * time.Second,  <span class="hljs-comment">// 30秒采样一次</span>
})

<span class="hljs-comment">// 返回: [[timestamp, value], ...]</span>
<span class="hljs-comment">// 例如: [[1736049600, 0], [1736049630, 0], [1736049660, 1], ...]</span>
</code></pre>
<h3 data-id="heading-14">步骤 2：补齐缺失的时间点</h3>
<p>Prometheus 不保证每个时间点都有数据（指标可能还未创建），需要补 0：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fillMissingPoints</span><span class="hljs-params">(points [][]<span class="hljs-type">float64</span>, start, end time.Time, step time.Duration)</span></span> [][]<span class="hljs-type">float64</span> {
    pointMap := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]<span class="hljs-type">float64</span>)
    <span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> points {
        pointMap[<span class="hljs-type">int64</span>(p[<span class="hljs-number">0</span>])] = p[<span class="hljs-number">1</span>]
    }

    <span class="hljs-keyword">var</span> result [][]<span class="hljs-type">float64</span>
    <span class="hljs-keyword">for</span> t := start.Unix(); t &lt;= end.Unix(); t += <span class="hljs-type">int64</span>(step.Seconds()) {
        <span class="hljs-keyword">if</span> val, exists := pointMap[t]; exists {
            result = <span class="hljs-built_in">append</span>(result, []<span class="hljs-type">float64</span>{<span class="hljs-type">float64</span>(t), val})
        } <span class="hljs-keyword">else</span> {
            result = <span class="hljs-built_in">append</span>(result, []<span class="hljs-type">float64</span>{<span class="hljs-type">float64</span>(t), <span class="hljs-number">0</span>})  <span class="hljs-comment">// 补0</span>
        }
    }
    <span class="hljs-keyword">return</span> result
}
</code></pre>
<h3 data-id="heading-15">步骤 3：计算相邻差值（Counter 专用）</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processCounter</span><span class="hljs-params">(points [][]<span class="hljs-type">float64</span>)</span></span> [][]<span class="hljs-type">float64</span> {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(points) &lt;= <span class="hljs-number">1</span> {
        <span class="hljs-keyword">return</span> [][]<span class="hljs-type">float64</span>{}
    }
    
    result := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">float64</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(points)<span class="hljs-number">-1</span>)
    
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(points); i++ {
        prevValue := points[i<span class="hljs-number">-1</span>][<span class="hljs-number">1</span>]
        currValue := points[i][<span class="hljs-number">1</span>]
        timestamp := points[i][<span class="hljs-number">0</span>]
        
        diff := currValue - prevValue
        
        <span class="hljs-comment">// 处理 Counter 重置（服务重启）</span>
        <span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0</span> {
            diff = currValue
        }
        
        result = <span class="hljs-built_in">append</span>(result, []<span class="hljs-type">float64</span>{timestamp, diff})
    }
    
    <span class="hljs-keyword">return</span> result  <span class="hljs-comment">// 注意：长度比原始数据少1</span>
}
</code></pre>
<h3 data-id="heading-16">完整数据流</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant P as Prometheus
    participant B as 后端
    participant F as 前端

    F-&gt;&gt;B: 查询"订单监控"，时间范围1小时
    B-&gt;&gt;P: QueryRange(alarm_log_error_total)
    P--&gt;&gt;B: [0,0,0,1,1,1,2,2,2]
    
    Note over B: 补齐缺失时间点
    Note over B: 计算相邻差值
    Note over B: 移除第一个点
    
    B--&gt;&gt;F: [[t2,0], [t3,0], [t4,1], [t5,0], [t6,0], [t7,1], [t8,0], [t9,0]]
    
    Note over F: 渲染图表
    F-&gt;&gt;F: 16:05和16:10出现波峰
</code></pre>
<hr/>
<h2 data-id="heading-17">六、Gauge 指标怎么办？</h2>
<h3 data-id="heading-18">场景对比</h3>
<p>假设我们还有一个 SQL 查询规则，统计"待处理订单数"：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'pending'</span>
</code></pre>
<p>这个指标是 <strong>Gauge 类型</strong>（可增可减的瞬时值）：</p>
<pre><code class="hljs language-makefile" lang="makefile">时间      查询结果
<span class="hljs-section">16:00     100</span>
<span class="hljs-section">16:05     150</span>
<span class="hljs-section">16:10     120</span>
<span class="hljs-section">16:15     180</span>
</code></pre>
<p>业务团队想看的是：<strong>"当前有多少待处理订单"</strong>，而不是"相对于上一时刻增加了多少"。</p>
<h3 data-id="heading-19">Gauge 不需要计算差值</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processGauge</span><span class="hljs-params">(points [][]<span class="hljs-type">float64</span>)</span></span> [][]<span class="hljs-type">float64</span> {
    <span class="hljs-comment">// 直接返回原始值，不做任何处理</span>
    <span class="hljs-keyword">return</span> points
}
</code></pre>
<p>返回前端：<code>[[16:00, 100], [16:05, 150], [16:10, 120], [16:15, 180]]</code></p>
<p>前端渲染出一条平滑的曲线，清晰展示数值变化趋势。</p>
<h3 data-id="heading-20">Counter vs Gauge 对比</h3>






























<table><thead><tr><th>维度</th><th>Counter</th><th>Gauge</th></tr></thead><tbody><tr><td>语义</td><td>累计值（只增不减）</td><td>当前值（可增可减）</td></tr><tr><td>业务关心</td><td><strong>增量</strong>：这一分钟新增了几次</td><td><strong>绝对值</strong>：现在是多少</td></tr><tr><td>处理方式</td><td>计算相邻差值</td><td>保持原值</td></tr><tr><td>示例</td><td>错误次数、请求总数</td><td>连接数、队列长度、SQL查询结果</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-21">七、前端：零负担渲染</h2>
<h3 data-id="heading-22">前端只做 3 件事</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 接收后端数据</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getMetricData</span>(groupId, timeRange)

<span class="hljs-comment">// 2. 转换时间格式（秒 → 毫秒）</span>
<span class="hljs-keyword">const</span> chartData = response.<span class="hljs-property">series</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> ({
  <span class="hljs-attr">name</span>: <span class="hljs-title function_">formatLegend</span>(s.<span class="hljs-property">metric</span>),
  <span class="hljs-attr">type</span>: <span class="hljs-string">'line'</span>,
  <span class="hljs-attr">data</span>: s.<span class="hljs-property">points</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> [p[<span class="hljs-number">0</span>] * <span class="hljs-number">1000</span>, p[<span class="hljs-number">1</span>]])  <span class="hljs-comment">// 秒转毫秒</span>
}))

<span class="hljs-comment">// 3. 渲染图表</span>
chart.<span class="hljs-title function_">setOption</span>({
  <span class="hljs-attr">xAxis</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'time'</span> },
  <span class="hljs-attr">yAxis</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'value'</span> },
  <span class="hljs-attr">series</span>: chartData
})
</code></pre>
<p><strong>不做任何差值计算、不做任何业务逻辑</strong>——所有复杂处理都在后端完成。</p>
<h3 data-id="heading-23">后端返回的数据格式</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"alarm_log_error_total"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"counter"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"series"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"metric"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"service"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"order-service"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"level"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"points"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">[</span><span class="hljs-number">1736049660</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">[</span><span class="hljs-number">1736049720</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">[</span><span class="hljs-number">1736049780</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 16:05 波峰</span>
      <span class="hljs-punctuation">[</span><span class="hljs-number">1736049840</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">[</span><span class="hljs-number">1736049900</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">[</span><span class="hljs-number">1736049960</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">]</span>   <span class="hljs-comment">// 16:10 波峰</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">八、效果对比</h2>
<h3 data-id="heading-25">改造前（使用 increase()）</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">16:05 发生错误 → 图上显示 0</span>
<span class="hljs-section">16:10 又发生错误 → 图上显示 1</span>
</code></pre>
<p>业务团队：看不懂</p>
<h3 data-id="heading-26">改造后（计算相邻差值）</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">16:05 发生错误 → 图上显示 1（波峰）</span>
<span class="hljs-section">16:10 又发生错误 → 图上显示 1（波峰）</span>
</code></pre>
<p>业务团队：一目了然</p>
<hr/>
<h2 data-id="heading-27">九、关键设计点</h2>
<h3 data-id="heading-28">1. 采样粒度自适应</h3>
<p>根据查询时间长度，自动调整采样间隔：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">calculateStep</span><span class="hljs-params">(timeRange <span class="hljs-type">string</span>)</span></span> time.Duration {
    <span class="hljs-keyword">switch</span> timeRange {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"15m"</span>:  <span class="hljs-keyword">return</span> <span class="hljs-number">15</span> * time.Second  <span class="hljs-comment">// 15分钟 / 60点</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"1h"</span>:   <span class="hljs-keyword">return</span> <span class="hljs-number">30</span> * time.Second  <span class="hljs-comment">// 1小时 / 120点</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"3h"</span>:   <span class="hljs-keyword">return</span> <span class="hljs-number">60</span> * time.Second  <span class="hljs-comment">// 3小时 / 180点</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"6h"</span>:   <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * time.Minute   <span class="hljs-comment">// 6小时 / 180点</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"12h"</span>:  <span class="hljs-keyword">return</span> <span class="hljs-number">4</span> * time.Minute   <span class="hljs-comment">// 12小时 / 180点</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"24h"</span>:  <span class="hljs-keyword">return</span> <span class="hljs-number">8</span> * time.Minute   <span class="hljs-comment">// 24小时 / 180点</span>
    }
}
</code></pre>
<p><strong>设计原则</strong>：每个图表 60~180 个数据点，平衡精度与性能。</p>
<h3 data-id="heading-29">2. 指标类型识别</h3>
<p>从规则类型推断指标类型：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getMetricType</span><span class="hljs-params">(rule Rule)</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">if</span> rule.Type == <span class="hljs-string">"keyword"</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"counter"</span>  <span class="hljs-comment">// 日志关键词规则 → Counter</span>
    }
    <span class="hljs-keyword">if</span> rule.Type == <span class="hljs-string">"query"</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"gauge"</span>    <span class="hljs-comment">// SQL 查询规则 → Gauge</span>
    }
}
</code></pre>
<h3 data-id="heading-30">3. 前后端职责分离</h3>




















<table><thead><tr><th>层次</th><th>职责</th><th>为什么</th></tr></thead><tbody><tr><td><strong>后端</strong></td><td>指标类型识别、差值计算、数据补齐</td><td>理解业务语义，处理复杂逻辑</td></tr><tr><td><strong>前端</strong></td><td>时间格式转换、图表渲染</td><td>专注展示，保持简洁</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-31">十、处理边界情况</h2>
<h3 data-id="heading-32">Counter 重置</h3>
<p>服务重启时，Counter 从大值重置为 0：</p>
<pre><code class="hljs language-makefile" lang="makefile">时间      原始值    天真计算     修正后
<span class="hljs-section">16:00     100       -            -</span>
<span class="hljs-section">16:01     150       50 ✓        50 ✓</span>
<span class="hljs-section">16:02     0         -150 ✗      0 ✓</span>
<span class="hljs-section">16:03     5         5 ✓         5 ✓</span>
</code></pre>
<p>修正逻辑：</p>
<pre><code class="hljs language-go" lang="go">diff := currValue - prevValue
<span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0</span> {
    diff = currValue  <span class="hljs-comment">// 负数说明重置，用当前值</span>
}
</code></pre>
<h3 data-id="heading-33">指标首次出现</h3>
<p>指标第一次被采集时，前面的时间点都补 0：</p>
<pre><code class="hljs language-makefile" lang="makefile">时间      原始值    补齐后     差值
<span class="hljs-section">15:55     (无)      0          -</span>
<span class="hljs-section">15:56     (无)      0          0</span>
<span class="hljs-section">15:57     (无)      0          0</span>
<span class="hljs-section">15:58     1         1          1  ← 第一次出现的增量</span>
</code></pre>
<hr/>
<h2 data-id="heading-34">十一、与 Grafana 对比</h2>






























<table><thead><tr><th>维度</th><th>Grafana + increase()</th><th>本方案</th></tr></thead><tbody><tr><td>Counter 首次出现</td><td>显示 0（看不出来）</td><td>显示 1（清晰波峰）</td></tr><tr><td>学习成本</td><td>需要懂 PromQL</td><td>点击菜单即可</td></tr><tr><td>Dashboard 配置</td><td>手动配置 Panel</td><td>自动生成</td></tr><tr><td>适用场景</td><td>通用监控平台</td><td>业务告警可视化</td></tr></tbody></table>
<p><strong>Grafana 的优势</strong>：灵活、强大、通用</p>
<p><strong>本方案的优势</strong>：简单、直观、符合业务直觉</p>
<hr/>
<h2 data-id="heading-35">十二、实践建议</h2>
<h3 data-id="heading-36">1. 何时使用这个方案？</h3>
<p>适合：</p>
<ul>
<li>告警系统的指标可视化</li>
<li>业务团队日常巡检</li>
<li>非技术人员查看监控</li>
</ul>
<p>不适合：</p>
<ul>
<li>需要复杂 PromQL 查询（rate、histogram_quantile）</li>
<li>高度自定义图表布局</li>
<li>专业运维团队的深度分析</li>
</ul>
<h3 data-id="heading-37">2. 性能优化建议</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 1. 限制数据点数量</span>
<span class="hljs-keyword">if</span> pointCount &gt; <span class="hljs-number">180</span> {
    step = calculateAdaptiveStep(timeRange, <span class="hljs-number">180</span>)
}

<span class="hljs-comment">// 2. 缓存查询结果</span>
cache.Set(cacheKey, result, <span class="hljs-number">30</span>*time.Second)

<span class="hljs-comment">// 3. 并发查询多个指标</span>
<span class="hljs-keyword">var</span> wg sync.WaitGroup
<span class="hljs-keyword">for</span> _, metric := <span class="hljs-keyword">range</span> metrics {
    wg.Add(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">go</span> queryMetric(metric)
}
</code></pre>
<h3 data-id="heading-38">3. 前端渲染优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 虚拟滚动（图表数量 &gt; 20）</span>
&lt;virtual-list :data=<span class="hljs-string">"metrics"</span> :item-height=<span class="hljs-string">"400"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ item }"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Chart</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"item"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
&lt;/virtual-list&gt;

<span class="hljs-comment">// 懒加载（点击展开才渲染）</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-collapse</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-collapse-item</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"metric in metrics"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Chart</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"expanded"</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"metric"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-collapse-item</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-collapse</span>&gt;</span></span>
</code></pre>
<hr/>
<h2 data-id="heading-39">十三、总结</h2>
<h3 data-id="heading-40">核心解决的问题</h3>
<p><strong>Prometheus 的 <code>increase()</code> 无法展示 Counter 首次出现时的值</strong> → 通过计算相邻差值解决</p>
<h3 data-id="heading-41">技术亮点</h3>
<ol>
<li><strong>后端做重活</strong>：指标类型识别、差值计算、数据补齐</li>
<li><strong>前端很轻松</strong>：接收数据、转时间、渲染图表</li>
<li><strong>配置即生效</strong>：新增指标关联到指标组，立即可视化</li>
</ol>
<h3 data-id="heading-42">与上一篇的关系</h3>
<ul>
<li>上一篇：解决了"指标分组 + 动态菜单"问题</li>
<li>本篇：解决了"Counter 可视化"问题</li>
</ul>
<p>两者结合 = 完整的"零配置、业务化"监控方案</p>
<h3 data-id="heading-43">适用场景</h3>
<ul>
<li>告警系统指标可视化 ✓</li>
<li>业务团队自助查看 ✓</li>
<li>非技术人员使用 ✓</li>
<li>复杂 PromQL 查询 ✗</li>
<li>高度自定义图表 ✗</li>
</ul>
<hr/>
<p><strong>效果</strong>：业务团队不再问"为什么图上看不到"，而是问"能不能多加几个指标"。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 12 SplashScreen 一种另类的适配方案]]></title>    <link>https://juejin.cn/post/7591348605867343907</link>    <guid>https://juejin.cn/post/7591348605867343907</guid>    <pubDate>2026-01-05T05:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591348605867343907" data-draft-id="7591413526708518912" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 12 SplashScreen 一种另类的适配方案"/> <meta itemprop="keywords" content="Android,GitHub"/> <meta itemprop="datePublished" content="2026-01-05T05:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android轮子哥"/> <meta itemprop="url" content="https://juejin.cn/user/712139265815144"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 12 SplashScreen 一种另类的适配方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139265815144/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android轮子哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T05:10:11.000Z" title="Mon Jan 05 2026 05:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">问题背景</h4>
<ul>
<li>某天公司产品找到我，问我某些机型上面打开后闪屏页会出现 App 的 Logo</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbeb8ab7fc9049bb86a230c2b2b6e9fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcm9pZOi9ruWtkOWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768194734&amp;x-signature=qDGVlmKmznXA7kwr8UIlhB4jDbc%3D" alt="" loading="lazy"/></p>
<ul>
<li>上面说太丑了，有没有办法去掉这个闪屏页的 App Logo 呢？</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c1ed6edac22484cb3b0844d7d3bd71a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcm9pZOi9ruWtkOWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768194734&amp;x-signature=mj7sJLffI7UKiFBip1aTGm%2FkB%2FU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-1">解决方案</h4>
<ul>
<li>
<p>可以确定的是这个问题是 Android 12 的 SplashScreen 特性，几乎找遍了所有的适配文章和官方文档，这些文章或者文档无一例外，都是教你怎么适配 Android 12 的 SplashScreen 特性，并没有说怎么去除 SplashScreen 特性自带的图标，我自己也尝试调用相关 api 测试是否能去除，结果一无所获。</p>
</li>
<li>
<p>问题正处于一筹莫展的时候，我脑子突然有了一个大胆的想法，既然没办法干掉它，就想办法把它隐藏起来总可以了吧？</p>
</li>
<li>
<p>说干就干，于是我找到闪屏页的主题，并加入以下属性：</p>
</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 闪屏页主题样式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"SplashTheme"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"FullScreenTheme"</span>&gt;</span><span class="xml">
    ......
    <span class="hljs-comment">&lt;!-- 适配 Android 12 SplashScreen 特性  --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowSplashScreenBackground"</span> <span class="hljs-attr">tools:targetApi</span>=<span class="hljs-string">"31"</span>&gt;</span>@color/transparent<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowSplashScreenIconBackgroundColor"</span> <span class="hljs-attr">tools:targetApi</span>=<span class="hljs-string">"31"</span>&gt;</span>@color/transparent<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowSplashScreenAnimatedIcon"</span> <span class="hljs-attr">tools:targetApi</span>=<span class="hljs-string">"31"</span>&gt;</span>@color/transparent<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowSplashScreenBrandingImage"</span> <span class="hljs-attr">tools:targetApi</span>=<span class="hljs-string">"31"</span>&gt;</span>@color/transparent<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<ul>
<li>
<p>有人会说，这几个属性是 Android 12 才有的属性，你加个 <code>tools:targetApi="31"</code> 来抑制警告在低版本下面真的没有问题吗？我非常确定来回答没有问题，因为系统读取 App 主题的时候，是通过读取 xml 文件来获取属性的，在这种情况下，低版本并不会去读取高版本的属性，因为它压根不知道有这几个属性，所以不会有任何问题，经过验证也确实如此。</p>
</li>
<li>
<p>废话不多说，来看看加上这几个属性之后的效果吧，上图：</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/645fb7ca9632412f8473fb02dfb80715~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcm9pZOi9ruWtkOWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768194734&amp;x-signature=6qjlEHxQAOoD3vDQ5jQrC2VYmhU%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>成功解决问题，你看看解决这个问题的方法并没有多难，一个脑筋急转弯而已，解决难题的方式总是那么朴实无华。</p>
</li>
<li>
<p>截止目前，我是行业第一个也是唯一一个解决此问题并将解决方案开源出来的人，当然我的粉丝们都提前知道了，在前一阵更新了 AndroidProject（App 架构 + App 模板），同时也将这个优秀的技术方案纳入到这个项目中，但实际这个项目有很多优秀的技术方案并没有写成文章，你如果感兴趣，可以通过阅读源码来知晓：</p>
<ul>
<li>
<p>Java 版本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FgetActivity%2FAndroidProject" target="_blank" title="https://github.com/getActivity/AndroidProject" ref="nofollow noopener noreferrer">AndroidProject</a></p>
</li>
<li>
<p>Kotlin 版本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FgetActivity%2FAndroidProject-Kotlin" target="_blank" title="https://github.com/getActivity/AndroidProject-Kotlin" ref="nofollow noopener noreferrer">AndroidProject-Kotlin</a></p>
</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 设计模式 - PlanAndExecute 模式]]></title>    <link>https://juejin.cn/post/7591420438850191396</link>    <guid>https://juejin.cn/post/7591420438850191396</guid>    <pubDate>2026-01-05T05:24:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591420438850191396" data-draft-id="7591510174047617075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 设计模式 - PlanAndExecute 模式"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-05T05:24:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子洋"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359835015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 设计模式 - PlanAndExecute 模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359835015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子洋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T05:24:54.000Z" title="Mon Jan 05 2026 05:24:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#2c3e50;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;font-weight:600;margin-top:35px;margin-bottom:8px;padding-bottom:5px}.markdown-body h1 :before,.markdown-body h2 :before,.markdown-body h3 :before,.markdown-body h4 :before,.markdown-body h5 :before,.markdown-body h6 :before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:8px;margin-top:50px;font-size:24px;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #eaecef;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;font-weight:400;background-color:rgba(27,31,35,.05);color:#476582;margin:0;font-size:.85em;border-radius:3px;font-size:.87em;padding:.165em .5em}.markdown-body code,.markdown-body pre{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.6;padding:20px 24px;background-color:#282c34;border-radius:6px}.markdown-body pre&gt;code{font-size:14px;padding:0;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff}.markdown-body a{text-decoration:none;color:#3eaf7c;font-weight:500}.markdown-body a:active,.markdown-body a:hover{color:#42b983;border-bottom:1px solid #42b983}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;margin:16px 0;border-collapse:collapse}.markdown-body thead{background:#f6f6f6;background:#3eaf7c;color:#000;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f6f8fa}.markdown-body td,.markdown-body th{border:1px solid #dfe2e5;padding:10px 16px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{font-size:14px;padding:6px 23px;margin:22px 0;border-left:6px solid #42b983;background-color:#f3f5f7;font-weight:400}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body p,.markdown-body ul{line-height:1.7}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="tomorrow-night">.hljs-comment,.hljs-quote{color:#969896}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c66}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#de935f}.hljs-attribute{color:#f0c674}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#b5bd68}.hljs-section,.hljs-title{color:#81a2be}.hljs-keyword,.hljs-selector-tag{color:#b294bb}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1d1f21;color:#c5c8c6}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在前两篇中，我们已经比较系统地梳理了 AI Agent 的发展历程，也对 AI Agent 和 AI Workflow 之间的区别做过一次完整的拆解，同时重点讲解了目前最经典、也是被讨论最多的 ReAct 模式。这一篇我们继续介绍另一个在工程实践中同样非常重要、并且经常和 ReAct 搭配使用的模式：Plan and Execute（简称 P&amp;E）。</p>
<p>P&amp;E 的核心思想其实并不复杂，本质就是一句话：<strong>先计划，再执行</strong>。但正是这一步<code>先计划</code>，在很多真实场景中，往往会决定一个 Agent 系统最终能不能跑通。</p>
<p>如果你实际用过 ReAct，就会很容易遇到一个问题：一个标准的 ReAct Agent，几乎在每一轮都会把整个任务的执行过程和执行结果重新喂回给模型，从而让模型始终持有完整的上下文。这个机制在短任务中非常好用，但当任务本身无法在几步之内完成时，上下文就会持续膨胀，尤其是在涉及文件读写、长文本处理或者多轮工具调用的情况下，这种膨胀几乎是不可避免的。</p>
<p>从表面上看，模型的上下文窗口已经越来越大，128k 早已不是极限，200k 甚至 1M 的模型也已经出现。但在工程实践中，一个很现实的问题是：上下文变大，并不会线性提升效果，反而在很多情况下，会让模型更容易偏离最初的目标。当上下文中无关信息的比例不断上升时，信噪比会明显下降，模型对早期约束的关注度会逐渐被稀释，从而更容易出现目标偏移、遗漏约束，甚至产生不必要的幻觉。因此，在实际系统中，通常会尽量将单轮上下文控制在一个相对安全的范围内（例如 100k 左右?），避免无限逼近模型的上下文上限。</p>
<p>除了上下文规模的问题，在面对复杂任务、强约束任务时，ReAct 还存在一个常见的问题：对长期目标和多重约束的保持能力不足。比如下面这个需求，本身并不模糊，甚至可以说写得非常清楚：</p>
<pre><code class="hljs">请为我制定一份7天6晚的山水主题旅游计划，包含往返交通，总预算严格控制在10000元以内。
目的地需具备明显的山水景观，并避开旅游高峰期，请说明该地的最佳出行时间及是否需避开节假日。
行程安排需详细到每日景点顺序、活动建议与交通衔接，合理融合自然与人文体验。
同时，请结合目的地气候提供1月的温湿度、降水概率及相应穿衣指南，介绍当地重要的文化习俗、礼仪禁忌与特色美食，并给出预算分项估算、住宿区域建议、必备物品及安全提示。
希望整体计划注重可操作性，并适当体现地方特色。
</code></pre>
<p>上面这个可以说是一个非常完整的提示词，但如果你真的让一个单 Agent、基于 ReAct 的模型去完整执行这个任务，执行到后半段时，往往会发现它开始只关注“最近正在生成的内容”，而对前面提出的一些硬约束，比如预算上限、时间避峰、文化禁忌等，逐渐变得不那么敏感。最终的结果通常不是完全错误，而是只满足了一部分要求。</p>
<p>这里需要强调的是，这并不是 ReAct 本身的问题，而是当一个 Agent 同时承担全局目标管理和具体执行这两种职责时，在长链路任务中很容易顾此失彼。</p>
<p>这一点其实和我们自己做项目非常像。如果你接到一个稍微复杂一点的需求，一上来就直接开始写代码，哪怕经验再丰富，做到后面也很容易发现有些功能漏了、有些约束没对齐，甚至前后端和产品的理解并不完全一致。所以在真实的开发过程中，我们往往会先做一些看似“很浪费时间”的事，比如列 TODO、写方案、拆阶段目标，把整个任务先在脑子里走一遍。</p>
<p>P&amp;E 模式，本质上就是把这种人类项目管理式的思考方式，显式地引入到了 Agent 系统中。</p>
<p>在 P&amp;E 中，我们不再指望一个 Agent 从头到尾既想清楚全局、又把所有细节一次性做好，而是先让模型生成一份明确的执行计划，然后再让执行 Agent 按计划逐步完成。每一次执行，只需要关注当前这个子目标，而不需要同时背负所有约束。这也是 P&amp;E 能够在长任务中显著提升稳定性的根本原因。</p>
<p>需要提前说明的一点是：P&amp;E 本质上是一种控制和编排模式，而不是必须使用多个 Agent。你完全可以用同一个模型，通过不同的 system prompt 来分别扮演 Planner 和 Executor；是否拆成多 Agent，更多是工程层面的选择，而不是模式本身的前提。</p>
<p>当然，P&amp;E 也不是没有代价。对于非常简单的任务，引入规划阶段本身就是额外开销，不管是 token 消耗还是系统复杂度，都会比直接用 ReAct 更高。因此，它更适合用在那些任务链路长、约束多、失败成本高的场景中。</p>
<h2 data-id="heading-1">Plan And Execute 模式</h2>
<h3 data-id="heading-2">核心思想</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22d702ea285748e1afca6ba8da3e8ae5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196300&amp;x-signature=iPZdirUvODF8zstx4%2F0igJm9des%3D" alt="" loading="lazy"/></p>
<p>这张图来自 LangChain 博客，对 Plan and Execute 模式给出了一个非常工程化的抽象。从流程上看，它并没有试图强调模型怎么思考，而是把注意力放在<strong>任务是如何在不同阶段之间流转的</strong>：用户问题先进入规划阶段，被拆解成一组明确的步骤；随后这些步骤被依次交给执行模块处理；执行过程中持续产生中间结果，并由上层进行监控；一旦某一步失败，就会触发重新规划，再次回到 Plan 阶段。</p>
<p>我个人比较喜欢这张图的一点在于，它几乎完全是从系统视角出发的。你可以把它理解成一条控制流，而不是一段 Prompt 技巧。它回答的不是模型该怎么想，而是一个复杂任务在系统中应该如何被组织和调度。在实际工程中，这种视角往往比单纯讨论 prompt 更有价值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7679eadd968a46b4b8b34a5abfaa2de1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768196300&amp;x-signature=ZtiIUX6WgrYROLrmnWkUrQ%2FJhBo%3D" alt="Pasted image 20260103230844.png" loading="lazy"/></p>
<p>相比之下，P&amp;E 论文中的这张图关注点就不太一样了。它并不是在强调系统流程，而是在强调 <strong>Plan 本身的作用</strong>。图中可以看到，模型并不是一开始就直接进入逐步推理或执行，而是先生成一个高层次的计划结构，然后再围绕这个计划逐步完成任务。</p>
<p>这张图想表达的核心，其实是：通过显式的规划阶段，把原本隐含在模型推理过程中的全局结构提前抽象出来，从而减少执行阶段的负担。执行模型不需要时刻记住所有目标，只需要在当前步骤下，把事情做好即可。这也是为什么 P&amp;E 在长任务、强约束任务中，往往比单纯依赖逐步推理的方式更加稳定。</p>
<p>如果说前一张图更像是在描述<strong>系统怎么跑</strong>，那这张图更像是在回答<strong>为什么要先规划</strong>。</p>
<h3 data-id="heading-3">核心实现</h3>
<h4 data-id="heading-4">三层架构设计</h4>
<p>在工程实现上，P&amp;E 通常可以抽象为三个角色：规划、执行和监控。规划阶段负责生成一份高层次的 TODO 列表，它只关心要完成什么，而不关心具体怎么做；执行阶段负责完成每一个具体步骤，可以使用 ReAct，也可以使用其他形式的 Agent；监控阶段则负责判断执行是否成功，并在失败时触发重规划。</p>
<p>通过下面这段伪代码可以清晰地体现这一点：Plan Agent 只负责生成计划，Execute Agent 专注于执行当前步骤，而在失败时，会把失败上下文重新交给 Planner，让它生成一份新的、完整的计划。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 1. 规划层 - 生成蓝图</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generatePlan</span>(<span class="hljs-params">task</span>) {
    <span class="hljs-comment">// 提示词强调"做什么"，而不是"怎么做"</span>
    <span class="hljs-keyword">const</span> prompt = <span class="hljs-string">`你是一位项目经理，请将任务分解为3-6个可执行的步骤。
    任务：<span class="hljs-subst">${task}</span>
    
    要求：
    - 每个步骤描述要达到的目标
    - 不要描述具体实现细节
    - 步骤间有逻辑顺序
    
    输出格式：{ "steps": [{"step": "描述"}] }`</span>;
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmGenerate</span>(prompt);
}

<span class="hljs-comment">// 2. 执行层 - 执行每个步骤（可用ReAct）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeStep</span>(<span class="hljs-params">step</span>) {
    <span class="hljs-comment">// 对每个步骤使用ReAct执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">runReAct</span>({ <span class="hljs-attr">task</span>: step.<span class="hljs-property">step</span> });
}

<span class="hljs-comment">// 3. 监控层 - 处理失败和重规划</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">monitorExecution</span>(<span class="hljs-params">plan, results</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; plan.<span class="hljs-property">steps</span>.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">const</span> result = results[i];
        
        <span class="hljs-keyword">if</span> (result.<span class="hljs-property">failed</span>) {
            <span class="hljs-comment">// 触发重规划</span>
            <span class="hljs-keyword">const</span> newPlan = <span class="hljs-keyword">await</span> <span class="hljs-title function_">replan</span>({
                originalTask,
                <span class="hljs-attr">failedStep</span>: plan.<span class="hljs-property">steps</span>[i],
                <span class="hljs-attr">failureReason</span>: result.<span class="hljs-property">error</span>,
                <span class="hljs-attr">completedSteps</span>: results.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, i)
            });
            
            <span class="hljs-comment">// 用新计划重新开始</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">executePlan</span>(newPlan);
        }
    }
}
</code></pre>
<h4 data-id="heading-5">重规划机制详解</h4>
<p>RePlan 并不是简单地再生成一次计划，而是一次<strong>基于当前状态的条件规划</strong>。一个有效的 RePlan，至少需要考虑以下信息：哪些步骤已经成功完成、当前失败的具体步骤是什么、失败的原因或异常信息、是否需要改变执行顺序或策略等等，否则，模型很容易生成一个看似不同、实则重复失败路径的新计划。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">replan</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">const</span> prompt = <span class="hljs-string">`原任务：<span class="hljs-subst">${context.originalTask}</span>
    
    执行情况：
    - 已完成：<span class="hljs-subst">${context.completedSteps.length}</span>个步骤
    - 失败步骤：<span class="hljs-subst">${context.failedStep.step}</span>
    - 失败原因：<span class="hljs-subst">${context.failureReason}</span>
    
    请生成新的计划，避免同样的失败。`</span>;
    
    <span class="hljs-comment">// LLM会分析失败原因，调整后续步骤</span>
    <span class="hljs-keyword">const</span> newPlan = <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmGenerate</span>(prompt);
    
    <span class="hljs-keyword">return</span> {
        ...newPlan,
        <span class="hljs-comment">// 保留已成功的步骤</span>
        <span class="hljs-attr">completedSteps</span>: context.<span class="hljs-property">completedSteps</span>
    };
}
</code></pre>
<h3 data-id="heading-6">具体实现</h3>
<p>下面这份代码，是一个简化但逻辑完整的 P&amp;E Agent 实现。但这里的实现更多是为了说明 P&amp;E 的整体结构，而不是一个可以直接在生产环境使用的最终方案。在真实系统中，通常还需要对重规划次数、token 预算以及最终 Summary 阶段的幻觉风险进行更严格的控制。</p>
<p>不过，即便如此，这个实现已经完整覆盖了 P&amp;E 的核心流程，也很好地展示了 Planner、Executor 和 RePlanner 之间的职责边界。</p>
<h4 data-id="heading-7">P&amp;E 主逻辑</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { llmGenerate } <span class="hljs-keyword">from</span> <span class="hljs-string">"../llm/provider.js"</span>;
<span class="hljs-keyword">import</span> { runReAct } <span class="hljs-keyword">from</span> <span class="hljs-string">"./react-agent.js"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SYSTEM</span> = <span class="hljs-string">`You are a professional Planner in a Plan-and-Execute agent architecture.

Your responsibility is to analyze the user's task and produce a clear, minimal,
and executable high-level plan.

Rules and constraints:
- You ONLY generate the plan. You do NOT execute any step.
- You MUST NOT call tools or mention tool names.
- You MUST NOT describe implementation details or low-level actions.
- Each step should describe WHAT needs to be achieved, not HOW it is done.
- Steps must be logically ordered and independent when possible.
- Prefer fewer, clearer steps (3–6 steps).
- Each step should be actionable, unambiguous, and verifiable by an executor.

Output format (strict JSON only):
{
  "steps": [
    { "step": "..." }
  ]
}

Do not include any explanation, commentary, or extra text outside the JSON.`</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">planAndExecute</span>(<span class="hljs-params">{
  task,
  options = {},
  replanOnFailure = <span class="hljs-literal">true</span>,
  availableTools,
} = {}</span>) {
  <span class="hljs-keyword">const</span> { text } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmGenerate</span>({
    <span class="hljs-attr">system</span>: <span class="hljs-variable constant_">SYSTEM</span>,
    <span class="hljs-attr">prompt</span>: <span class="hljs-string">`Task: <span class="hljs-subst">${task}</span>`</span>,
  });
  <span class="hljs-keyword">let</span> plan;
  <span class="hljs-keyword">try</span> {
    plan = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(text);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Plan:\n"</span>, plan);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">final</span>: <span class="hljs-string">"Plan parse failed"</span>, <span class="hljs-attr">error</span>: <span class="hljs-title class_">String</span>(e), <span class="hljs-attr">raw</span>: text };
  }

  <span class="hljs-keyword">const</span> trace = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [idx, s] <span class="hljs-keyword">of</span> plan.<span class="hljs-property">steps</span>.<span class="hljs-title function_">entries</span>()) {
    <span class="hljs-keyword">const</span> reactRes = <span class="hljs-keyword">await</span> <span class="hljs-title function_">runReAct</span>({ <span class="hljs-attr">task</span>: s.<span class="hljs-property">step</span>, <span class="hljs-attr">maxLoops</span>: <span class="hljs-number">10</span> });

    <span class="hljs-keyword">const</span> observation = reactRes.<span class="hljs-property">final</span>
      ? { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: reactRes.<span class="hljs-property">final</span> }
      : { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-string">"No final from ReAct"</span> };

    trace.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">idx</span>: idx + <span class="hljs-number">1</span>,
      <span class="hljs-attr">step</span>: s.<span class="hljs-property">step</span>,
      observation,
      <span class="hljs-attr">reactTrace</span>: reactRes.<span class="hljs-property">trace</span>,
    });

    <span class="hljs-keyword">if</span> (replanOnFailure &amp;&amp; !observation.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">const</span> replanPrompt = <span class="hljs-string">`Original task:
      <span class="hljs-subst">${task}</span>

      The previous plan failed.

      Failure details:
      - Failed step index: <span class="hljs-subst">${idx + <span class="hljs-number">1</span>}</span>
      - Failed step description: <span class="hljs-subst">${s.step}</span>
      - Observation at failure:
      <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(observation)}</span>

      Execution trace so far:
      <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(reactRes.trace || [])}</span>

      Your task:
      Generate a revised plan that resolves the failure and allows the task to complete successfully.

      Output requirements:
      - Respond with a single valid JSON object only
      - Do NOT include any explanations, comments, or Markdown
      - The JSON must represent a complete revised plan, not a partial patch
      - The revised plan must avoid repeating the failed step in the same form

      Return JSON only.`</span>;
      <span class="hljs-keyword">const</span> { <span class="hljs-attr">text</span>: newPlanText } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmGenerate</span>({
        <span class="hljs-attr">system</span>: <span class="hljs-variable constant_">SYSTEM</span>,
        <span class="hljs-attr">prompt</span>: replanPrompt,
      });
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> newPlan = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(newPlanText);
        plan = newPlan;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"New Plan:\n"</span>, newPlan);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">planAndExecute</span>({
          task,
          options,
          replanOnFailure,
          availableTools,
        });
      } <span class="hljs-keyword">catch</span> (e) {
        trace.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">idx</span>: idx + <span class="hljs-number">1</span>,
          <span class="hljs-attr">step</span>: <span class="hljs-string">"REPLAN_FAILED"</span>,
          <span class="hljs-attr">error</span>: <span class="hljs-title class_">String</span>(e),
          <span class="hljs-attr">raw</span>: newPlanText,
        });
      }
    }
  }

  <span class="hljs-keyword">const</span> summaryPrompt = <span class="hljs-string">`Given the plan execution trace, summarize final result for task: <span class="hljs-subst">${task}</span>.\nTRACE:\n<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(trace, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)}</span>`</span>;
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">text</span>: final } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmGenerate</span>({
    <span class="hljs-attr">system</span>: <span class="hljs-string">"Summarizer"</span>,
    <span class="hljs-attr">prompt</span>: summaryPrompt,
  });
  <span class="hljs-keyword">return</span> { final, plan, trace };
}
</code></pre>
<h2 data-id="heading-8">结语</h2>
<p>这篇文章里介绍的 P&amp;E 模式，本质上并不是某种 更高级 的 Agent，而是我们在工程实践中，为了解决长任务和复杂约束问题，总结出来的一种更稳妥的组织方式。不同的模式并不存在绝对的优劣，更多是取决于你面对的是什么样的问题。</p>
<p>原本我是打算下一篇继续写 Reflexion 模式的，但最近有一些其他事情要做，也有一些目前更感兴趣的方向，比如 Spec Coding、Agent Skill、Mem0 这一类的技术，再加上 25 年 Qwen 团队在 NeurIPS 上获得最佳论文的关于门控注意力机制的研究，也都值得花时间去看一看。Agent 这条线本身还远没有收敛到一个稳定范式，有太多东西值得慢慢拆、慢慢写，所以这部分内容就先告一段落，后面有时间再继续展开。</p>
<p>上面的实现代码已经开源在 GitHub，可以下载到本地进行运行调试 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAlessandro-Pang%2Fagent-desgin-pattern-demo" target="_blank" title="https://github.com/Alessandro-Pang/agent-desgin-pattern-demo" ref="nofollow noopener noreferrer">github.com/Alessandro-…</a></p>
<h2 data-id="heading-9">相关资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAlessandro-Pang%2Fagent-desgin-pattern-demo" target="_blank" title="https://github.com/Alessandro-Pang/agent-desgin-pattern-demo" ref="nofollow noopener noreferrer">Demo GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FpaperId%3D867791094102885122%26publicationId%3D108592%26activeReadTab%3Dchat" target="_blank" title="https://www.bohrium.com/paper/read?paperId=867791094102885122&amp;publicationId=108592&amp;activeReadTab=chat" ref="nofollow noopener noreferrer">Plan-and-Solve Prompting</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.langchain.com%2Fplanning-agents%2F" target="_blank" title="https://blog.langchain.com/planning-agents/" ref="nofollow noopener noreferrer">Plan-and-Execute Agents</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fshort.pangcy.cn%2Fu%2F139a9efccce1fce2" target="_blank" title="https://short.pangcy.cn/u/139a9efccce1fce2" ref="nofollow noopener noreferrer">AI Agent 介绍</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fshort.pangcy.cn%2Fu%2FNUxypq" target="_blank" title="https://short.pangcy.cn/u/NUxypq" ref="nofollow noopener noreferrer">ReAct 模式</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别让 AI 成了你的“后门”：一个被忽视的安全盲区]]></title>    <link>https://juejin.cn/post/7591510174047633459</link>    <guid>https://juejin.cn/post/7591510174047633459</guid>    <pubDate>2026-01-05T05:27:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591510174047633459" data-draft-id="7591544356000923658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别让 AI 成了你的“后门”：一个被忽视的安全盲区"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-05T05:27:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别让 AI 成了你的“后门”：一个被忽视的安全盲区
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T05:27:30.000Z" title="Mon Jan 05 2026 05:27:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天看到了一篇讲述 <code>Claude Code Skills</code> “投毒”的文章。</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F2zZ1RTY5tNvt-mwKdArg7A" target="_blank" title="https://mp.weixin.qq.com/s/2zZ1RTY5tNvt-mwKdArg7A" ref="nofollow noopener noreferrer">Claude Code Skills 投毒事件全解析</a>》</p>
<p>忽然发现，虽然自己一直都在注意 AI 使用的工程化，但却没怎么关注安全方面的内容。</p>
<p>今天就和大家聊聊 AI 安全方面的思考。</p>
<h2 data-id="heading-0">不要中了 AI 的毒</h2>
<p>首先就是我看到的文章里提到的 <code>Claude Code Skills</code> “投毒”的内容。</p>
<p>原来，病毒是通过软件下载、脚本嵌入等方式给我们植入，现在有了 AI，就有了新的传播途径。</p>
<p>比如，我看的文章中提到的例子。</p>
<p><code>Claude Code</code> 限制了 <code>/app/workspace</code> 开头的文件访问，但攻击者可以构造 <code>/app/workspace/../../../etc/passwd</code> 这样的路径。</p>
<p>路径确实符合 <code>/app/workspace</code> 开头，但实际却获取到了根目录下的关键文件 <code>/etc/passwd</code>。</p>
<p>虽然，这个漏洞非常容易被修复，但 AI 的出现无疑是开辟了另一个攻防的战场，这个战场还有很多远比这个漏洞严重的情形。</p>
<p>但目前来看，目前防守方的研究似乎远落后于攻击者。</p>
<p>因此大家使用各类复杂的提示词、开源 <code>Agent</code>，一定要注意甄别，不要中了 AI 的毒。</p>
<h2 data-id="heading-1">提升自己的保障手段</h2>
<p>上面聊了对于外来风险的防护，接下来，我们聊一下，万一发生风险，如何降低损失。</p>
<p>最关键的一句话大家一定要谨记：<strong>AI 并不可靠，因此，不要完全相信 AI</strong>。</p>
<p>虽然，我是一个 AI 乐观主义者，并且，AI 已经深深地影响了我的各类工作。</p>
<p>但我依然要提醒大家，使用 AI 不能完全放手，我们必须要通过各种工程化手段不分解、把控、审阅。</p>
<p>拿我应用最多的 AI 编程来说。</p>
<p>第一，我不期望 AI 直接完成一个系统，不仅仅是因为担心现有模型能力无法完成，更多的是考虑不分解工作，我可能没有能力或精力去把控生成的代码质量。</p>
<p>第二，即使是分解后的任务，我依然会通过多次审查确认（<code>Cursor/TRAE</code> 等 <code>IDE</code> 提供）、多步快跑提交 <code>Git</code> 等方式保证每次的不稳定代码最小化。</p>
<blockquote>
<p>注：其实，现有模型很多都可以工作10个小时以上，完全可以一口气完成一项工作。</p>
</blockquote>
<p>因此，对于我们的重要资料，还是建议大家采用一些传统方式去保护，比如版本控制、物理备份等。</p>
<h2 data-id="heading-2">结语</h2>
<p>今天，仅仅是我意识到 AI 的安全问题后，给大家同步提个醒。</p>
<p>后续会再给大家详细分享下 AI 安全相关的具体措施，敬请期待~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[没有人比我更懂Flutter第三方依赖鸿蒙化了之Sqflite]]></title>    <link>https://juejin.cn/post/7591439305260744739</link>    <guid>https://juejin.cn/post/7591439305260744739</guid>    <pubDate>2026-01-05T05:35:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591439305260744739" data-draft-id="7591456613534334976" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="没有人比我更懂Flutter第三方依赖鸿蒙化了之Sqflite"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-05T05:35:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            没有人比我更懂Flutter第三方依赖鸿蒙化了之Sqflite
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T05:35:20.000Z" title="Mon Jan 05 2026 05:35:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近又折腾了一波鸿蒙，发现鸿蒙的数据库支持SQLite，于是乎，就想着把Sqflite鸿蒙化，于是乎，就有了这个系列。</p>
<p>在此之前先打个广告，有鸿蒙5+的设备朋友帮我刷个下载量，在AppGallery下载以下app打开并运行一下子，感谢：</p>
<ul>
<li>乐活伴侣</li>
<li>阿默宠物</li>
</ul>
<h2 data-id="heading-0">和Sqflite无关的东西</h2>
<p>先说点和鸿蒙相关的其他的小知识点，不算什么新知识，但是可能会帮到你。
作为后起之秀，鸿蒙算是站在不少巨人的肩膀上的，因此，一些权限管理的相对比较严格，以下内容仅对上架华为应用市场的手机app有效，对于非上架华为应用市场的app及其他类型设备本人没有研究。</p>
<h3 data-id="heading-1">应用读取剪贴板</h3>
<p>对剪切板的主动读取，不像Android那样，直接调用ClipboardManager就可以。
在鸿蒙中，应用读取剪贴板是不仅要在<code>module.json5</code>中申请权限：</p>
<pre><code class="hljs language-json" lang="json">      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.READ_PASTEBOARD"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"$string:request_paste_reason"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"usedScene"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"EntryAbility"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"when"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"inuse"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>还要在申请Profile时申请ACL权限，得等ACL权限申请通过后，才能使用这个权限。目前，官方允许使用该权限的只有符合以下场景：</p>
<ul>
<li>银行卡号复制：银行类应用需要读取剪贴板中的银行卡号自动生成卡片。</li>
<li>口令复制：应用需要读取剪贴板中特定格式口令，自动打开应用内对应页面。</li>
<li>文档编辑类应用。</li>
<li>输入法：系统级输入法需要读取剪贴板信息实现自动填充。应用内置输入法不能申请此权限。</li>
</ul>
<p>同时，官方也给出了一个解决方案，使用“粘贴控件”读取剪贴板数据，使用方式请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fpastebutton" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/pastebutton" ref="nofollow noopener noreferrer">使用粘贴控件</a>，但这是一个原生组件，Flutter中似乎无法使用（当然我也没有试过）。</p>
<p>以下是我在申请时，给我的答复：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">审核意见: 开发者您好：</span>

受限权限仅少量符合特殊场景的应用可在通过审批后使用，您的场景不符合权限使用要求，请使用非权限的替代方案实现功能。

粘贴场景ArkUI输入框支持长按拉起toolbar，可以直接粘贴剪切板内的第一条内容，无需申请ohos.permission.READ_PASTEBOARD权限，如您使用的是三方框架，请在申请理由中描述并重新提交申请，感谢您的理解与支持！
</code></pre>
<h3 data-id="heading-2">其他权限</h3>
<p>还有一些权限，在我看起来好像并不需要声明，但实际上你还是要在<code>module.json5</code>中声明一下，比如调用系统的打印服务：</p>
<pre><code class="hljs language-bash" lang="bash"> {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.PRINT"</span>,
        <span class="hljs-string">"reason"</span>: <span class="hljs-string">"<span class="hljs-variable">$string</span>:request_print_reason"</span>,
        <span class="hljs-string">"usedScene"</span>: {
          <span class="hljs-string">"abilities"</span>: [<span class="hljs-string">"EntryAbility"</span>],
          <span class="hljs-string">"when"</span>: <span class="hljs-string">"inuse"</span>
        }
      }
</code></pre>
<p>不声明是无法使用的。关于权限具体可以参看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fapp-permission-mgmt" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-permission-mgmt" ref="nofollow noopener noreferrer">应用权限管控
</a>，文档说的很详细了，不赘述了。</p>
<h2 data-id="heading-3">Sqflite鸿蒙化</h2>
<p>起初，我以为<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fopenharmony-sig%2Fflutter_sqflite%2Ftree%2Fbr_v2.4.1_ohos" target="_blank" title="https://gitcode.com/openharmony-sig/flutter_sqflite/tree/br_v2.4.1_ohos" ref="nofollow noopener noreferrer">flutter_sqflite</a>已经支持鸿蒙了，那理应问题不大，但是，当我尝试使用时，还是给我了一些小小的惊喜。</p>
<h3 data-id="heading-4">INTEGER变blob了？</h3>
<p>用flutter_sqflite库建表时候，字段为INTEGER，理论上sqlite的INTEGER兼容long型。并且dart中 int也是兼容long。但是现在dart模型中int字段（比如：DateTime.now().millisecondsSinceEpoch），存入数据库，会被强制转成blob类型，然后查询上来的数据是unmodifiableUint8arrayview。</p>
<p>如何解决？</p>
<p>答：像时间戳这种比较大的数据类型字段要用UNLIMITED INT，不能用INTEGER ，例如：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> $_tableName(id <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">PRIMARY</span> KEY, name TEXT, age <span class="hljs-type">INTEGER</span>, create_t UNLIMITED <span class="hljs-type">INT</span>)
</code></pre>
<h3 data-id="heading-5">不支持REAL</h3>
<p>有一个字段的类型是REAL，在鸿蒙中是不支持的，因此，我又把其类型改成DOUBLE类型。结果我发现，我取出来的值全成成了整数，精度全部丢失了，我不太清楚是哪个环节出现了问题，是数据库本身的问题还是插件层的代码出现了问题，总之，精度确实丢了。评论区如果有知道原因的，可以告诉我。没办法，我又把其类型改成TEXT类型，用字符串存储，然后在dart层进入解析才算完事。</p>
<h2 data-id="heading-6">兼容性</h2>
<p>我从<code>flutter_sqflite</code>中摘抄了部分文档，大家可以参考一下：</p>
<h3 data-id="heading-7">属性</h3>
<blockquote>
<p>[!TIP] "ohos Support"列为 yes 表示 ohos 平台支持该属性；no 则表示不支持；partially 表示部分支持。使用方法跨平台一致，效果对标 iOS 或 Android 的效果。</p>
</blockquote>
<h4 data-id="heading-8"><strong>存储类型</strong></h4>















































<table><thead><tr><th>Name</th><th>Description</th><th>Type</th><th><strong>ohos Support</strong></th></tr></thead><tbody><tr><td>String</td><td>存储字符串值</td><td>String</td><td>yes</td></tr><tr><td>int</td><td>存储整数值</td><td>int</td><td>yes</td></tr><tr><td>real</td><td>存储浮点数值</td><td>double</td><td>no</td></tr><tr><td>bool</td><td>存储布尔值</td><td>bool</td><td>yes</td></tr><tr><td>null</td><td>空</td><td>null</td><td>yes</td></tr><tr><td>date_time</td><td>储存时间值</td><td>date_time</td><td>yes</td></tr></tbody></table>
<h4 data-id="heading-9">OpenDatabaseOptions</h4>



























































<table><thead><tr><th>Name</th><th>Description</th><th>Type</th><th><strong>ohos Support</strong></th></tr></thead><tbody><tr><td>version</td><td>数据库版本</td><td>int?</td><td>yes</td></tr><tr><td>onConfigure</td><td>数据库配置回调</td><td>OnDatabaseConfigureFn?</td><td>yes</td></tr><tr><td>onCreate</td><td>数据库首次创建回调</td><td>OnDatabaseCreateFn?</td><td>yes</td></tr><tr><td>onUpgrade</td><td>数据库版本升级回调</td><td>OnDatabaseVersionChangeFn?</td><td>yes</td></tr><tr><td>onDowngrade</td><td>数据库版本降级回调</td><td>OnDatabaseVersionChangeFn?</td><td>yes</td></tr><tr><td>onOpen</td><td>数据库成功打开回调</td><td>OnDatabaseOpenFn?</td><td>yes</td></tr><tr><td>readOnly</td><td>是否以只读模式打开数据库</td><td>bool?</td><td>yes</td></tr><tr><td>singleInstance</td><td>是否强制单例模式</td><td>bool?</td><td>yes</td></tr></tbody></table>
<h3 data-id="heading-10">API</h3>
<blockquote>
<p>[!TIP] "ohos Support"列为 yes 表示 ohos 平台支持该属性；no 则表示不支持；partially 表示部分支持。使用方法跨平台一致，效果对标 iOS 或 Android 的效果。</p>
</blockquote>
<h4 data-id="heading-11">DatabaseFactory</h4>















































<table><thead><tr><th>Name</th><th><strong>return value</strong></th><th>Description</th><th>Type</th><th><strong>ohos Support</strong></th></tr></thead><tbody><tr><td>openDatabase(String path, {OpenDatabaseOptions? options})</td><td>Future</td><td>打开指定路径的数据库，可配置打开选项</td><td>function</td><td>yes</td></tr><tr><td>getDatabasesPath</td><td>Future</td><td>获取数据库默认存储路径</td><td>function</td><td>yes</td></tr><tr><td>setDatabasesPath(String path)</td><td>Future</td><td>设置默认数据库存储路径</td><td>function</td><td>yes</td></tr><tr><td>deleteDatabase(String path)</td><td>Future</td><td>删除指定路径的数据库</td><td>function</td><td>yes</td></tr><tr><td>databaseExists(String path)</td><td>Future</td><td>检查指定路径的数据库是否存在</td><td>function</td><td>yes</td></tr></tbody></table>
<h4 data-id="heading-12">DatabaseExecutor</h4>







































































































<table><thead><tr><th>Name</th><th><strong>return value</strong></th><th>Description</th><th>Type</th><th><strong>ohos Support</strong></th></tr></thead><tbody><tr><td>execute(String sql, [List&lt;Object?&gt;? arguments])</td><td>Future</td><td>执行 SQL 语句</td><td>function</td><td>yes</td></tr><tr><td>rawInsert(String sql, [List&lt;Object?&gt;? arguments])</td><td>Future</td><td>直接执行插入 SQL 返回行数</td><td>function</td><td>yes</td></tr><tr><td>insert(String table, Map&lt;String, Object?&gt; values, {String?  nullColumnHack,ConflictAlgorithm? conflictAlgorithm})</td><td>Future</td><td>插入 SQL 返回行数</td><td>function</td><td>yes</td></tr><tr><td>query(String table,<br/>      {bool? distinct,<br/>      List? columns,<br/>      String? where,<br/>      List&lt;Object?&gt;? whereArgs,<br/>      String? groupBy,<br/>      String? having,<br/>      String? orderBy,<br/>      int? limit,<br/>      int? offset});</td><td>Future&lt;List&lt;Map&lt;String, Object?&gt;&gt;&gt;</td><td>查询返回结果集列表</td><td>function</td><td>yes</td></tr><tr><td>rawQuery(String sql,      [List&lt;Object?&gt;? arguments])</td><td>Future&lt;List&lt;Map&lt;String, Object?&gt;&gt;&gt;</td><td>直接执行 SQL 查询返回结果集列表</td><td>function</td><td>yes</td></tr><tr><td>rawQueryCursor(String sql, List&lt;Object?&gt;? arguments, {int? bufferSize})</td><td>Future</td><td>执行原始 SQL 查询返回游标对象</td><td>function</td><td>yes</td></tr><tr><td>queryCursor(String table,<br/>      {bool? distinct,<br/>      List? columns,<br/>      String? where,<br/>      List&lt;Object?&gt;? whereArgs,<br/>      String? groupBy,<br/>      String? having,<br/>      String? orderBy,<br/>      int? limit,<br/>      int? offset,<br/>      int? bufferSize})</td><td>Future</td><td>查询返回游标对象</td><td>function</td><td>yes</td></tr><tr><td>rawUpdate(String sql, [List&lt;Object?&gt;? arguments])</td><td>Future</td><td>直接执行更新 SQL 返回影响行数</td><td>function</td><td>yes</td></tr><tr><td>update(String table, Map&lt;String, Object?&gt; values,<br/>      {String? where,<br/>      List&lt;Object?&gt;? whereArgs,<br/>      ConflictAlgorithm? conflictAlgorithm})</td><td>Future</td><td>执行更新 SQL 返回影响行数</td><td>function</td><td>yes</td></tr><tr><td>rawDelete(String sql, [List&lt;Object?&gt;? arguments])</td><td>Future</td><td>直接执行SQL删除符合条件的数据行</td><td>function</td><td>yes</td></tr><tr><td>delete(String table, {String? where, List&lt;Object?&gt;? whereArgs})</td><td>Future</td><td>删除符合条件的数据行</td><td>function</td><td>yes</td></tr><tr><td>batch</td><td>Batch</td><td>获取批处理操作对象</td><td>function</td><td>yes</td></tr><tr><td>get database</td><td>Database</td><td>获取底层数据库实例</td><td>function</td><td>yes</td></tr></tbody></table>
<h4 data-id="heading-13"><strong>Batch</strong></h4>
































































































<table><thead><tr><th>Name</th><th><strong>return value</strong></th><th>Description</th><th>Type</th><th><strong>ohos Support</strong></th></tr></thead><tbody><tr><td>commit({<br/>    bool? exclusive,<br/>    bool? noResult,<br/>    bool? continueOnError,<br/>  })</td><td>Future&lt;List&lt;Object?&gt;&gt;</td><td>提交批量操作</td><td>function</td><td>yes</td></tr><tr><td>apply({bool? noResult, bool? continueOnError})</td><td>Future&lt;List&lt;Object?&gt;&gt;</td><td>执行批量操作并自动提交</td><td>function</td><td>yes</td></tr><tr><td>rawInsert(String sql, [List&lt;Object?&gt;? arguments])</td><td>void</td><td>执行SQL插入语句</td><td>function</td><td>yes</td></tr><tr><td>insert(String table, Map&lt;String, Object?&gt; values,<br/>      {String? nullColumnHack, ConflictAlgorithm? conflictAlgorithm})</td><td>void</td><td>执行SQL插入语句</td><td>function</td><td>yes</td></tr><tr><td>rawUpdate(String sql, [List&lt;Object?&gt;? arguments])</td><td>void</td><td>执行SQL更新语句</td><td>function</td><td>yes</td></tr><tr><td>update(String table, Map&lt;String, Object?&gt; values,<br/>      {String? where,<br/>      List&lt;Object?&gt;? whereArgs,<br/>      ConflictAlgorithm? conflictAlgorithm})</td><td>void</td><td>执行SQL更新语句</td><td>function</td><td>yes</td></tr><tr><td>rawDelete(String sql, [List&lt;Object?&gt;? arguments])</td><td>void</td><td>执行SQL删除语句</td><td>function</td><td>yes</td></tr><tr><td>delete(String table, {String? where, List&lt;Object?&gt;? whereArgs})</td><td>void</td><td>执行SQL删除语句</td><td>function</td><td>yes</td></tr><tr><td>execute(String sql, [List&lt;Object?&gt;? arguments])</td><td>void</td><td>执行通用SQL语句</td><td>function</td><td>yes</td></tr><tr><td>query(String table,<br/>      {bool? distinct,<br/>      List? columns,<br/>      String? where,<br/>      List&lt;Object?&gt;? whereArgs,<br/>      String? groupBy,<br/>      String? having,<br/>      String? orderBy,<br/>      int? limit,<br/>      int? offset})</td><td>void</td><td>执行 SQL 查询语句</td><td>function</td><td>yes</td></tr><tr><td>rawQuery(String sql, [List&lt;Object?&gt;? arguments])</td><td>void</td><td>执行 SQL 查询语句</td><td>function</td><td>yes</td></tr><tr><td>get length</td><td>int</td><td>获取累计操作数量</td><td>function</td><td>yes</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[需要独立的作业队列？看看Quartz增强框架Quartz Plus]]></title>    <link>https://juejin.cn/post/7591348605867261987</link>    <guid>https://juejin.cn/post/7591348605867261987</guid>    <pubDate>2026-01-05T04:15:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591348605867261987" data-draft-id="7591382440583036968" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="需要独立的作业队列？看看Quartz增强框架Quartz Plus"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2026-01-05T04:15:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武斌"/> <meta itemprop="url" content="https://juejin.cn/user/4441682704607517"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            需要独立的作业队列？看看Quartz增强框架Quartz Plus
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682704607517/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武斌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:15:55.000Z" title="Mon Jan 05 2026 04:15:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    82
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一个增强 Quartz 调度器的库，支持多个独立的 <code>SchedulerFactoryBean</code>，从而实现多个独立的作业队列。</p>
<h2 data-id="heading-0">项目简介</h2>
<p>Quartz Plus 是对 Spring Boot 中 Quartz 调度器的增强，允许你在同一个应用中创建多个独立的调度器实例。每个调度器拥有独立的线程池和数据库表，互不干扰，非常适合需要隔离不同业务场景的定时任务场景。</p>
<h2 data-id="heading-1">技术栈</h2>
<ul>
<li>Spring Boot 2.7.18</li>
<li>Spring Boot Starter Quartz</li>
<li>Quartz Scheduler</li>
<li>JDBC JobStore（支持集群模式）</li>
<li>Java 1.8+</li>
</ul>
<h2 data-id="heading-2">Maven 坐标</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.unionj-cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>quartz-plus-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-3">项目结构</h2>
<pre><code class="hljs language-bash" lang="bash">quartz-plus/
├── quartz-plus-core/          <span class="hljs-comment"># 核心模块</span>
│   ├── dto/                   <span class="hljs-comment"># 数据传输对象</span>
│   │   ├── JobRequest.java    <span class="hljs-comment"># 作业请求对象</span>
│   │   └── GroupRequest.java  <span class="hljs-comment"># 作业组请求对象</span>
│   ├── quartz/                <span class="hljs-comment"># Quartz 工具类</span>
│   │   └── QuartzUtils.java   <span class="hljs-comment"># Quartz 工具类，管理多个调度器</span>
│   ├── service/               <span class="hljs-comment"># 服务层</span>
│   │   ├── QuartzPlusBaseService.java           <span class="hljs-comment"># 作业管理服务接口</span>
│   │   └── impl/
│   │       └── DefaultQuartzPlusBaseServiceImpl.java  <span class="hljs-comment"># 默认实现</span>
│   ├── spring/                <span class="hljs-comment"># Spring 集成</span>
│   │   ├── QuartzPlusJob.java              <span class="hljs-comment"># 作业标识注解</span>
│   │   ├── QuartzPlusJobScan.java          <span class="hljs-comment"># 包扫描注解</span>
│   │   ├── QuartzPlusJobFactoryBean.java   <span class="hljs-comment"># 调度器工厂Bean</span>
│   │   ├── AutowiringSpringBeanJobFactory.java  <span class="hljs-comment"># 自动装配Job工厂</span>
│   │   └── SchedulerConfig.java            <span class="hljs-comment"># 调度器配置类</span>
│   └── QuartzPlusCoreAutoConfiguration.java  <span class="hljs-comment"># 自动配置类</span>
└── quartz-plus-boot/          <span class="hljs-comment"># 示例模块（仅用于演示）</span>
</code></pre>
<h2 data-id="heading-4">核心模块说明</h2>
<h3 data-id="heading-5">QuartzPlusCoreAutoConfiguration</h3>
<p>自动配置类，自动注册 <code>QuartzPlusBaseService</code> Bean。</p>
<h3 data-id="heading-6">QuartzPlusBaseService</h3>
<p>作业管理服务接口，提供以下功能：</p>
<ul>
<li><code>addScheduleJob(JobRequest jobRequest)</code> - 添加定时作业</li>
<li><code>updateScheduleJob(JobRequest jobRequest)</code> - 更新定时作业</li>
<li><code>deleteScheduleJob(JobRequest jobRequest)</code> - 删除定时作业</li>
<li><code>pauseScheduleJob(JobRequest jobRequest)</code> - 暂停定时作业</li>
<li><code>resumeScheduleJob(JobRequest jobRequest)</code> - 恢复定时作业</li>
<li><code>immediatelyJob(JobRequest jobRequest)</code> - 立即执行作业</li>
<li><code>isJobRunning(JobRequest jobRequest)</code> - 检查作业是否正在运行</li>
<li><code>isJobExists(JobRequest jobRequest)</code> - 检查作业是否存在</li>
<li><code>getScheduleState(JobRequest jobRequest)</code> - 获取作业调度状态</li>
<li><code>pauseGroup(GroupRequest groupRequest)</code> - 暂停作业组</li>
<li><code>resumeGroup(GroupRequest groupRequest)</code> - 恢复作业组</li>
<li><code>stopRunningJob(JobRequest jobRequest)</code> - 停止正在运行的作业</li>
</ul>
<h3 data-id="heading-7">JobRequest</h3>
<p>作业请求对象，包含以下属性：</p>
<ul>
<li><code>schedName</code> - 调度器名称（由系统自动设置）</li>
<li><code>jobGroup</code> - 作业组名称（默认：DEV）</li>
<li><code>jobName</code> - 作业名称</li>
<li><code>jobClass</code> - 作业类全限定名</li>
<li><code>cronExpression</code> - Cron 表达式（用于 CronTrigger）</li>
<li><code>startDateAt</code> - 开始时间（用于 SimpleTrigger）</li>
<li><code>repeatIntervalInSeconds</code> - 重复间隔（秒，用于 SimpleTrigger）</li>
<li><code>repeatCount</code> - 重复次数（用于 SimpleTrigger）</li>
<li><code>jobDataMap</code> - 作业数据映射</li>
<li><code>retry</code> - 重试标识（默认：N）</li>
<li><code>desc</code> - 描述信息</li>
<li><code>reason</code> - 原因说明</li>
</ul>
<h3 data-id="heading-8">GroupRequest</h3>
<p>作业组请求对象，包含以下属性：</p>
<ul>
<li><code>jobGroup</code> - 作业组名称（默认：DEV）</li>
<li><code>jobClass</code> - 作业类全限定名</li>
</ul>
<h3 data-id="heading-9">QuartzUtils</h3>
<p>工具类，负责管理多个调度器实例：</p>
<ul>
<li><code>addSchedulerFactoryBean(String jobBeanClassName, SchedulerFactoryBean schedulerFactoryBean)</code> - 注册调度器</li>
<li><code>getScheduler(JobRequest jobRequest)</code> - 根据作业请求获取对应的调度器</li>
<li><code>getScheduler(GroupRequest groupRequest)</code> - 根据组请求获取对应的调度器</li>
<li><code>createJob(JobRequest jobRequest, Class&lt;? extends Job&gt; jobClass, ApplicationContext context)</code> - 创建 JobDetail</li>
<li><code>createTrigger(JobRequest jobRequest)</code> - 创建 Trigger（支持 CronTrigger 和 SimpleTrigger）</li>
</ul>
<h3 data-id="heading-10">@QuartzPlusJob</h3>
<p>标识一个类为 Quartz Plus 作业。该注解可以指定调度器的名称（通过 value 属性），如果不指定，则使用类名转换为 kebab-case。</p>
<h3 data-id="heading-11">@QuartzPlusJobScan</h3>
<p>包扫描注解，用于扫描指定包下的 <code>@QuartzPlusJob</code> 注解的类。用法类似 Spring 的 <code>@ComponentScan</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@QuartzPlusJobScan("com.example.job")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-12">QuartzPlusJobFactoryBean</h3>
<p>工厂Bean，为每个 <code>@QuartzPlusJob</code> 注解的作业类创建一个独立的 <code>SchedulerFactoryBean</code>。根据配置创建调度器，支持以下配置项：</p>
<ul>
<li>调度器实例名称</li>
<li>线程池线程数</li>
<li>线程名称前缀</li>
<li>数据库表前缀</li>
<li>集群模式</li>
<li>自动启动</li>
</ul>
<h3 data-id="heading-13">SchedulerConfig</h3>
<p>调度器配置类，包含以下配置项：</p>
<ul>
<li><code>enabled</code> - 是否启用该调度器（默认：false）</li>
<li><code>instanceName</code> - 调度器实例名称</li>
<li><code>threadCount</code> - 线程池线程数（默认：3）</li>
<li><code>threadNamePrefix</code> - 线程名称前缀</li>
<li><code>tablePrefix</code> - 数据库表前缀</li>
<li><code>clustered</code> - 是否开启集群模式（默认：false）</li>
<li><code>description</code> - 调度器描述</li>
<li><code>autoStartup</code> - 是否自动启动（默认：false）</li>
</ul>
<h2 data-id="heading-14">集成和使用说明</h2>
<h3 data-id="heading-15">1. 添加依赖</h3>
<p>在 <code>pom.xml</code> 中添加依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.unionj-cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>quartz-plus-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-16">2. 配置数据源</h3>
<p>在 <code>application.properties</code> 或 <code>application.yml</code> 中配置数据源和 Quartz 基本配置：</p>
<pre><code class="hljs language-properties" lang="properties"># 数据源配置
spring.datasource.url=jdbc:mysql://localhost:3306/quartz-plus?useSSL=false&amp;serverTimezone=Asia/Shanghai
spring.datasource.username=root
spring.datasource.password=123456
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# Quartz 基本配置
spring.quartz.job-store-type=jdbc
spring.quartz.jdbc.initialize-schema=always # 自动创建所需的表
spring.quartz.properties.org.quartz.jobStore.class=org.springframework.scheduling.quartz.LocalDataSourceJobStore
spring.quartz.properties.org.quartz.jobStore.driverDelegateClass=org.quartz.impl.jdbcjobstore.StdJDBCDelegate
spring.quartz.properties.org.quartz.jobStore.useProperties=false
spring.quartz.properties.org.quartz.jobStore.misfireThreshold=5000
spring.quartz.properties.org.quartz.jobStore.clusterCheckinInterval=15000
</code></pre>
<h3 data-id="heading-17">3. 创建作业类</h3>
<p>创建继承自 <code>QuartzJobBean</code> 的作业类，并使用 <code>@QuartzPlusJob</code> 注解标识：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.quartz.JobExecutionContext;
<span class="hljs-keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;
<span class="hljs-keyword">import</span> quartzplus.core.spring.QuartzPlusJob;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@QuartzPlusJob("simpleJobA")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestSimpleJobA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">QuartzJobBean</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeInternal</span><span class="hljs-params">(JobExecutionContext context)</span> {
        log.info(<span class="hljs-string">"执行 TestSimpleJobA"</span>);
    }
}
</code></pre>
<p><code>@QuartzPlusJob</code> 注解的 value 属性指定了调度器的配置前缀，对应配置文件中的 <code>quartz.scheduler.{value}.*</code> 配置项。</p>
<h3 data-id="heading-18">4. 配置调度器</h3>
<p>在配置文件中为每个作业类配置对应的调度器：</p>
<pre><code class="hljs language-properties" lang="properties"># 配置名为 simple-job-a 的调度器（@QuartzPlusJob 的 value 值会转换为 kebab-case）
quartz.scheduler.simple-job-a.enabled=true
quartz.scheduler.simple-job-a.instance-name=SimpleJobAScheduler
quartz.scheduler.simple-job-a.thread-count=8
quartz.scheduler.simple-job-a.thread-name-prefix=SimpleJobA_
quartz.scheduler.simple-job-a.table-prefix=QRTZ_
quartz.scheduler.simple-job-a.clustered=true
quartz.scheduler.simple-job-a.description=simple job a
quartz.scheduler.simple-job-a.auto-startup=true
</code></pre>
<p>配置说明：</p>
<ul>
<li><code>enabled</code> - 是否启用该调度器（必须为 true，否则不会创建调度器）</li>
<li><code>instance-name</code> - 调度器实例名称，如果不配置，则使用类名 + "Scheduler"</li>
<li><code>thread-count</code> - 线程池线程数，默认为 3</li>
<li><code>thread-name-prefix</code> - 线程名称前缀，如果不配置，则使用调度器名称 + "_"</li>
<li><code>table-prefix</code> - 数据库表前缀，如果不配置，则使用 "QRTZ_" + 调度器名称（去掉"Scheduler"） + "<em>"，不同作业队列的数据将持久化到不同的数据库表，这些数据库表需自行创建。建议配置为"QRTZ</em>"，可以直接使用框架自动创建的表</li>
<li><code>clustered</code> - 是否开启集群模式，默认为 false</li>
<li><code>description</code> - 调度器描述</li>
<li><code>auto-startup</code> - 是否自动启动，默认为 false</li>
</ul>
<h3 data-id="heading-19">5. 启用包扫描</h3>
<p>在启动类或配置类上使用 <code>@QuartzPlusJobScan</code> 注解指定作业类的扫描路径：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> quartzplus.core.spring.QuartzPlusJobScan;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@QuartzPlusJobScan("com.example.job")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(Application.class, args);
    }
}
</code></pre>
<h3 data-id="heading-20">6. 使用服务管理作业</h3>
<p>注入 <code>QuartzPlusBaseService</code> 来管理作业：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.boot.context.event.ApplicationReadyEvent;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationListener;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> quartzplus.core.dto.JobRequest;
<span class="hljs-keyword">import</span> quartzplus.core.service.QuartzPlusBaseService;

<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> QuartzPlusBaseService quartzPlusBaseService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onApplicationEvent</span><span class="hljs-params">(ApplicationReadyEvent event)</span> {
        <span class="hljs-comment">// 创建作业请求</span>
        <span class="hljs-type">JobRequest</span> <span class="hljs-variable">jobRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobRequest</span>();
        jobRequest.setJobName(<span class="hljs-string">"testSimpleJobA"</span> + UUID.randomUUID());
        jobRequest.setJobClass(<span class="hljs-string">"com.example.job.TestSimpleJobA"</span>);
        jobRequest.setJobGroup(<span class="hljs-string">"DEV"</span>);
        jobRequest.setCronExpression(<span class="hljs-string">"0/10 * * * * ?"</span>);  <span class="hljs-comment">// 每10秒执行一次</span>
        jobRequest.setDesc(<span class="hljs-string">"测试作业"</span>);
        
        <span class="hljs-comment">// 添加定时作业</span>
        quartzPlusBaseService.addScheduleJob(jobRequest);
    }
}
</code></pre>
<h3 data-id="heading-21">7. 作业类型</h3>
<p>支持两种作业触发方式：</p>
<h4 data-id="heading-22">Cron 表达式触发</h4>
<p>使用 <code>cronExpression</code> 属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">JobRequest</span> <span class="hljs-variable">jobRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobRequest</span>();
jobRequest.setJobName(<span class="hljs-string">"cronJob"</span>);
jobRequest.setJobClass(<span class="hljs-string">"com.example.job.MyJob"</span>);
jobRequest.setCronExpression(<span class="hljs-string">"0 0 12 * * ?"</span>);  <span class="hljs-comment">// 每天12点执行</span>
quartzPlusBaseService.addScheduleJob(jobRequest);
</code></pre>
<h4 data-id="heading-23">Simple 触发</h4>
<p>使用 <code>startDateAt</code>、<code>repeatIntervalInSeconds</code>、<code>repeatCount</code> 属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">JobRequest</span> <span class="hljs-variable">jobRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobRequest</span>();
jobRequest.setJobName(<span class="hljs-string">"simpleJob"</span>);
jobRequest.setJobClass(<span class="hljs-string">"com.example.job.MyJob"</span>);
jobRequest.setStartDateAt(LocalDateTime.now().plusMinutes(<span class="hljs-number">1</span>));
jobRequest.setRepeatIntervalInSeconds(<span class="hljs-number">60</span>);  <span class="hljs-comment">// 每60秒执行一次</span>
jobRequest.setRepeatCount(<span class="hljs-number">10</span>);  <span class="hljs-comment">// 执行10次</span>
quartzPlusBaseService.addScheduleJob(jobRequest);
</code></pre>
<h2 data-id="heading-24">注意事项</h2>
<ol>
<li>
<p><strong>作业类必须实现 <code>QuartzJobBean</code></strong>：所有作业类必须继承自 <code>org.springframework.scheduling.quartz.QuartzJobBean</code>。</p>
</li>
<li>
<p><strong>必须配置 <code>enabled=true</code></strong>：如果某个调度器的 <code>enabled</code> 配置为 <code>false</code> 或未配置，则该调度器不会被创建。</p>
</li>
<li>
<p><strong>作业类名与配置的映射</strong>：<code>@QuartzPlusJob</code> 注解的 value 值会转换为 kebab-case，对应配置文件中的 <code>quartz.scheduler.{kebab-case}.*</code> 配置项。如果注解的 value 为空，则使用类名转换为 kebab-case。</p>
</li>
<li>
<p><strong>数据库表前缀</strong>：每个调度器使用独立的表前缀，确保不同调度器的数据隔离。</p>
</li>
<li>
<p><strong>集群模式</strong>：如果需要集群模式，需要配置 <code>clustered=true</code>，并确保多个应用实例连接到同一个数据库。</p>
</li>
<li>
<p><strong>作业类全限定名</strong>：在使用 <code>QuartzPlusBaseService</code> 添加作业时，<code>jobClass</code> 必须使用作业类的全限定名（如：<code>com.example.job.MyJob</code>）。</p>
</li>
</ol>
<h2 data-id="heading-25">示例代码</h2>
<p>完整的示例代码请参考 <code>quartz-plus-boot</code> 模块，该模块展示了如何使用 <code>quartz-plus-core</code> 模块。</p>
<h2 data-id="heading-26">项目地址</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funionj-cloud%2Fquartz-plus" target="_blank" title="https://github.com/unionj-cloud/quartz-plus" ref="nofollow noopener noreferrer">github.com/unionj-clou…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[上线不背锅：三种主流发布策略原理、优劣与实战建议]]></title>    <link>https://juejin.cn/post/7591382440583151656</link>    <guid>https://juejin.cn/post/7591382440583151656</guid>    <pubDate>2026-01-05T05:10:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591382440583151656" data-draft-id="7591413526708535296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="上线不背锅：三种主流发布策略原理、优劣与实战建议"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-05T05:10:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喝茶与编码"/> <meta itemprop="url" content="https://juejin.cn/user/3378136041922423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            上线不背锅：三种主流发布策略原理、优劣与实战建议
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3378136041922423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喝茶与编码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T05:10:45.000Z" title="Mon Jan 05 2026 05:10:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>三种主流发布策略——<strong>蓝绿发布、灰度发布、滚动发布</strong>。它们就像软件上线的“三件套”，目标都是：<strong>让新版本上线时用户无感、服务不崩、老板不慌</strong>。</p>
<hr/>
<h3 data-id="heading-0">🌊 一、蓝绿发布（Blue-Green Deployment）</h3>
<blockquote>
<p><strong>关键词：两套环境、一键切换、秒级回滚</strong></p>
</blockquote>
<p>想象你有两套完全一样的房子：</p>
<ul>
<li><strong>蓝色房子</strong>：正在住人（当前线上版本）</li>
<li><strong>绿色房子</strong>：刚装修好（新版本）</li>
</ul>
<p>你先把新功能悄悄部署到<strong>绿色房子</strong>里，测试 OK 后，<strong>瞬间把所有住户（流量）从蓝色切到绿色</strong>。如果发现新房子漏水（出 bug），立马切回蓝色，毫发无损！</p>
<p>✅ <strong>优点</strong>：</p>
<ul>
<li>切换快、回滚快（秒级）</li>
<li>用户全程无感知</li>
<li>风险可控（老环境保留）</li>
</ul>
<p>❌ <strong>缺点</strong>：</p>
<ul>
<li><strong>资源翻倍</strong>！要同时跑两套系统（不过云时代成本低多了）</li>
<li>数据库迁移/兼容问题要提前处理（比如新版本改了表结构）</li>
</ul>
<p>🔧 <strong>适合场景</strong>：</p>
<ul>
<li>对停机零容忍的关键业务（如支付、金融）</li>
<li>自动化能力一般，但希望简单可靠的团队</li>
</ul>
<hr/>
<h3 data-id="heading-1">🕊️ 二、灰度发布（Gray Release / Canary Release）</h3>
<blockquote>
<p><strong>关键词：小步试错、逐步放量、金丝雀探路</strong></p>
</blockquote>
<p>灵感来自矿工带金丝雀下井——<strong>先让一小撮用户当“小白鼠”</strong>，比如 1% 的流量走新版本，99% 还在老版本。</p>
<p>如果新版本稳定、性能好、没报错，就慢慢放大比例：5% → 20% → 50% → 100%。一旦出问题，只影响那 1%，赶紧回滚就行。</p>
<p>✅ <strong>优点</strong>：</p>
<ul>
<li><strong>风险极小</strong>，影响范围可控</li>
<li>可结合用户特征做定向灰度（比如只对内部员工 or iOS 用户开放）</li>
<li>能真实验证新功能在生产环境的表现</li>
</ul>
<p>❌ <strong>缺点</strong>：</p>
<ul>
<li>需要<strong>强大的流量调度能力</strong>（比如 Istio、Nginx 动态路由）</li>
<li>自动化要求高（监控、告警、自动回滚）</li>
<li>新老版本共存，需做好<strong>接口兼容性设计</strong></li>
</ul>
<p>🔧 <strong>适合场景</strong>：</p>
<ul>
<li>新功能不确定是否稳定（比如 AI 推荐算法）</li>
<li>用户体验敏感型产品（如抖音、淘宝）</li>
<li>有 A/B 测试需求</li>
</ul>
<blockquote>
<p>💡 小知识：“金丝雀发布”其实是灰度发布的一种，特指<strong>先放极小流量（比如1台机器）做先锋测试</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">🔄 三、滚动发布（Rolling Update）</h3>
<blockquote>
<p><strong>关键词：渐进替换、资源节省、K8s 原生支持</strong></p>
</blockquote>
<p>这是最“经济实惠”的方式：<strong>不搞两套环境，而是边升级边替换</strong>。</p>
<p>比如你有 10 个服务实例，每次只下线 2 个，升级成新版本，等它们健康了再继续下一批。像滚雪球一样，逐步把旧版本全换成新的。</p>
<p>✅ <strong>优点</strong>：</p>
<ul>
<li><strong>省资源</strong>！不需要双倍服务器</li>
<li>Kubernetes 原生支持（<code>kubectl rollout</code> 一套命令搞定）</li>
<li>用户基本无感（只要配置好就绪探针）</li>
</ul>
<p>❌ <strong>缺点</strong>：</p>
<ul>
<li><strong>回滚慢</strong>（得一个个实例换回来）</li>
<li>升级过程中新老版本<strong>同时运行</strong>，容易出现兼容问题</li>
<li>如果中途失败，状态比较混乱（“一半新一半旧”）</li>
</ul>
<p>🔧 <strong>适合场景</strong>：</p>
<ul>
<li>资源紧张的中小团队</li>
<li>使用 Kubernetes 等容器编排平台</li>
<li>版本兼容性做得比较好（比如 REST API 向下兼容）</li>
</ul>
<hr/>
<h3 data-id="heading-3">🧩 总结对比表：</h3>





































<table><thead><tr><th>策略</th><th>资源消耗</th><th>回滚速度</th><th>风险控制</th><th>自动化要求</th><th>典型使用</th></tr></thead><tbody><tr><td><strong>蓝绿发布</strong></td><td>高（2倍）</td><td>⚡ 极快</td><td>中（全量切换）</td><td>中</td><td>金融、核心系统</td></tr><tr><td><strong>灰度发布</strong></td><td>中</td><td>快</td><td>✅ 极高</td><td>高</td><td>互联网产品、新功能验证</td></tr><tr><td><strong>滚动发布</strong></td><td>低</td><td>慢</td><td>中（逐步暴露）</td><td>中高</td><td>K8s 环境、常规迭代</td></tr></tbody></table>
<hr/>
<p>🎯 <strong>怎么选？</strong></p>
<ul>
<li>想<strong>简单粗暴又安全</strong> → 蓝绿</li>
<li>想<strong>小步快跑、数据驱动</strong> → 灰度</li>
<li>想<strong>省钱省事、用 K8s</strong> → 滚动</li>
</ul>
<p>其实现在很多大厂是<strong>组合拳</strong>：先灰度 1% → 滚动发布到 50% → 全量切蓝绿。灵活搭配，稳字当头！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ralph Wiggum: Claude Code 的自主循环]]></title>    <link>https://juejin.cn/post/7591406441203826722</link>    <guid>https://juejin.cn/post/7591406441203826722</guid>    <pubDate>2026-01-05T04:04:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591406441203826722" data-draft-id="7591508100664066099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ralph Wiggum: Claude Code 的自主循环"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-05T04:04:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ralph Wiggum: Claude Code 的自主循环
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:04:53.000Z" title="Mon Jan 05 2026 04:04:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpaddo.dev%2Fblog%2Fralph-wiggum-autonomous-loops%2F" target="_blank" title="https://paddo.dev/blog/ralph-wiggum-autonomous-loops/" ref="nofollow noopener noreferrer">转载</a></p>
<p>Claude Code 的官方插件市场中有一个引人注目的条目:<strong>ralph-wiggum</strong>。它以《辛普森一家》中的角色命名,实现了自主开发循环,让 Claude 在没有人类干预的情况下工作数小时。</p>
<p>这个插件很简单。但其意义深远。</p>
<h2 data-id="heading-0">它的作用</h2>
<p>Ralph Wiggum 将 Claude Code 变成一个持久循环。你给它一个提示词,它会一直工作直到完成(或直到你停止它)。</p>
<pre><code class="hljs language-arduino" lang="arduino">/ralph-loop <span class="hljs-string">"将所有测试从 Jest 迁移到 Vitest"</span> --max-iterations <span class="hljs-number">50</span> --completion-promise <span class="hljs-string">"所有测试已完成迁移"</span>
</code></pre>
<p>Claude 尝试进行迁移。当它认为完成时,插件的 Stop hook 会拦截退出,重新注入原始提示词,Claude 继续工作。每次迭代都能看到之前运行修改的文件和 git 历史。循环持续进行,直到满足完成标准或达到迭代次数上限。</p>
<p>Stop hook 的工作原理</p>
<p>我之前详细介绍了 Stop hook 机制。Ralph Wiggum 使用退出代码 2 来阻止 Claude 停止并重新注入原始提示词。</p>
<h2 data-id="heading-1">背后的理念</h2>
<p>这个技术来自 Geoffrey Huntley,他简单地描述道:"Ralph 就是一个 Bash 循环。"</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">while</span> :; <span class="hljs-keyword">do</span> <span class="hljs-built_in">cat</span> PROMPT.md | claude ; <span class="hljs-keyword">done</span>
</code></pre>
<p>官方插件用安全控制和更好的用户体验包装了这个模式,但核心思想保持不变:让 Claude 反复失败直到成功。(软件工程的本质。)</p>
<blockquote>
<p>这种技术在不确定的世界中是确定性糟糕的。可预测的失败胜过不可预测的成功。</p>
<p>— Geoffrey Huntley</p>
</blockquote>
<p>这颠覆了通常的 AI 编码工作流程。你不是仔细审查每一步,而是预先定义成功标准,让 agent 向这些标准迭代。失败变成数据。每次迭代根据出现的问题改进方法。</p>
<p>技能从"一步步指导 Claude"转变为"编写能收敛到正确解决方案的提示词"。</p>
<h2 data-id="heading-2">何时自主循环大放异彩</h2>
<p>Ralph Wiggum 最适用于具有明确完成标准和机械执行的任务:</p>
<ul>
<li><strong>大型重构</strong>:框架迁移、依赖升级、跨数百个文件的 API 版本升级</li>
<li><strong>批量操作</strong>:支持工单分类、文档生成、代码标准化</li>
<li><strong>测试覆盖率</strong>: "为 src/ 中所有未覆盖的函数添加测试"</li>
<li><strong>全新构建</strong>:通过迭代改进进行的过夜项目脚手架</li>
</ul>
<p>共同点:明确定义的成功指标。如果你能精确描述"完成",Ralph 就可以向着它迭代。</p>
<h3 data-id="heading-3">真实成果</h3>
<p>Huntley 用一个提示词连续运行了三个月的循环:"给我做一个像 Golang 这样的编程语言,但用 Gen Z 俚语作为关键字。"结果是 Cursed:一个功能完整的编译器,有两种执行模式,LLVM 编译为原生二进制文件,标准库和部分编辑器支持。关键字包括 <code>slay</code>(函数)、<code>sus</code>(变量)和 <code>based</code>(真)。</p>
<p>在 Y Combinator 黑客马拉松上,使用该技术的团队 overnight 交付了 6+ 个仓库,API 成本为 297 美元。这些工作如果由承包商完成将花费 5 万美元。</p>
<p>一位开发人员将集成测试迁移到单元测试,将测试运行时间从 4 分钟减少到 2 秒。循环在他们睡觉时处理机械转换。</p>
<p>这些是精挑细选的成功案例。对于每个 overnight 胜利,都有循环在未收敛的情况下耗尽了迭代次数。失败的尝试仍然花费金钱。当你能够以编程方式验证成功(测试通过、构建成功),而不是依赖 Claude 自我评估完成时,该技术效果最好。</p>
<p>成本意识</p>
<p>自主循环会消耗大量 token。在大型代码库上运行 50 次迭代的循环,根据上下文大小,很容易花费 50-100+ 美元的 API 积分。在 Claude Code 订阅上,你会更快达到使用限制。保守设置 —max-iterations 并监控使用情况。</p>
<h2 data-id="heading-4">何时不应使用它</h2>
<p>我之前写过关于在追求自动化之前先掌握核心循环。这个建议仍然成立。Ralph Wiggum 不会取代人类判断:它自动化机械执行。</p>
<p><strong>不要将自主循环用于:</strong></p>
<ul>
<li><strong>模糊的需求</strong>:如果你不能精确定义"完成",循环就不会收敛</li>
<li><strong>架构决策</strong>:新颖的抽象需要人类推理,而不是迭代</li>
<li><strong>安全敏感代码</strong>:Auth、支付、数据处理需要每一步的人工审查</li>
<li><strong>探索</strong>:理解代码库需要人类的好奇心,而不是自动化处理</li>
</ul>
<blockquote>
<p>自主循环自动化机械执行。它们不自动化关于值得构建什么的决策。</p>
</blockquote>
<p>agent harness 的模式也适用于此。</p>
<h2 data-id="heading-5">更广阔的背景</h2>
<p>Ralph Wiggum 是更大转变的一种实现。正如我在《SDLC 正在崩溃》中所写,agent 现在能够维持多小时的推理。规划、构建、测试和部署之间的传统阶段边界正在溶解为连续流动。</p>
<p>自主循环是这种流动的基础设施。不是在人类会话之间进行交接,agent 在迭代之间维护上下文。进度持续存在于 git 历史和修改的文件中。每个"会话"从上一个会话停止的地方继续。</p>
<p>社区在这个模式基础上构建:</p>
<ul>
<li><strong>ralph-claude-code</strong> 添加了速率限制、tmux 仪表板和用于故障恢复的断路器</li>
<li><strong>ralph-orchestrator</strong> 添加了 token 追踪、支出限制、git 检查点和多 AI 支持</li>
</ul>
<p>这些实现解决了运营挑战:成本控制、状态恢复、监控。官方插件提供核心机制。生态系统构建生产包装器。</p>
<h2 data-id="heading-6">安装</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加官方市场</span>
/plugin marketplace add anthropics/claude-code

<span class="hljs-comment"># 安装插件</span>
/plugin install ralph-wiggum@claude-code-plugins

<span class="hljs-comment"># 重启 Claude Code</span>
</code></pre>
<p>安装后可用的命令:</p>
<ul>
<li><code>/ralph-loop "&lt;prompt&gt;" --max-iterations N</code> - 启动循环</li>
<li><code>/ralph-loop "&lt;prompt&gt;" --max-iterations N --completion-promise "text"</code> - 当 Claude 输出确切文本时停止</li>
<li><code>/cancel-ralph</code> - 终止活动循环</li>
</ul>
<p>安全第一</p>
<p>始终设置 —max-iterations。—completion-promise 标志使用精确字符串匹配,这是不可靠的。迭代限制是你真正的安全网。</p>
<h2 data-id="heading-7">自己试试</h2>
<p>选择一个具有明确成功标准的机械任务:</p>
<ol>
<li>安装插件(30 秒)</li>
<li>从小范围开始:"为 src/utils/ 中所有导出的函数添加 JSDoc 注释"</li>
<li>设置保守的迭代次数:<code>--max-iterations 10</code></li>
<li>完成后查看 git diff</li>
</ol>
<p>该技术奖励提示词工程。如果第一次尝试没有收敛,改进你的成功标准并重试。</p>
<p>睡觉时写代码</p>
<p>对于需要大量判断的工作,坚持使用基础方法。对于具有明确完成标准的批量机械工作,Ralph Wiggum 让你醒来时看到可工作的代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI还原设计稿方法]]></title>    <link>https://juejin.cn/post/7591413526708469760</link>    <guid>https://juejin.cn/post/7591413526708469760</guid>    <pubDate>2026-01-05T04:10:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591413526708469760" data-draft-id="7591375103521177640" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI还原设计稿方法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-05T04:10:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="暖阳_"/> <meta itemprop="url" content="https://juejin.cn/user/1662117312465406"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI还原设计稿方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1662117312465406/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    暖阳_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:10:42.000Z" title="Mon Jan 05 2026 04:10:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI还原设计稿方法</h2>
<p><strong>今天给大家分享一个超级简单但是特别有用的AI还原设计稿的方法。</strong></p>
<p>我前段时间被一个问题折磨了很久：每次拿到设计稿，我都想直接截图丢给AI，让它给我生成代码，结果每次都是失望而归。AI给我生成了一堆乱七八糟的代码，根本没法使用，气得我差点把键盘砸了。</p>
<p>后来我意识到一个问题：我们开发的时候，是不是先搭框架，再填内容，最后调细节？那为什么不让AI也这样去做呢？</p>
<p>我把这个方法总结成了六步，终于总结形成了一个sop流程。今天分享给大家，建议反复多看两遍，把它变成你使用AI的日常工作方式。</p>
<hr/>
<h3 data-id="heading-1">开发步骤</h3>
<p>在前端开发过程中，大家肯定都无数次有过冲动，想把设计稿截个图，直接丢给AI，让它直接帮我们生成代码，对吧？但是每次都失望而归，是不是？</p>
<p>我刚开始也是这样，每次看到设计稿，心里想：哎呀，这还不简单？截图一丢，AI直接给我代码不就完事了？结果呢？AI给我生成了一堆乱七八糟的代码，根本不能用。气得我差点把键盘砸了。</p>
<p>但是你停下来仔细想一下，我们开发的时候，步骤是怎么样的呢？是不是需要先搭建页面的整体布局，再不断填充里面的各个模块内容？你看，我们人都是这样做的，那为什么不让AI也这样去做呢？</p>
<p>我后来就想明白了，AI不是万能的，你得教它怎么做事。就像教新人一样，你不能说"给我做个页面"，你得一步步告诉他：先搭框架，再填内容，最后调细节。</p>
<p>我把整个过程总结成了六步，这个方法我已经在项目里验证过了，真的特别好用。现在我用这个方法，还原设计稿的效率提升了至少三倍。</p>
<p><strong>步骤一：原型分析</strong></p>
<p>首先，你不要急着让AI直接生成代码。先让它帮你分析一下这个设计稿，拆分页面结构，获取模块的宽高和间距信息。这一步很关键，因为AI需要先理解整个页面的布局逻辑。</p>
<p>就像你看一张地图，你得先知道哪里是山，哪里是河，才能规划路线，对吧？</p>
<p><strong>步骤二：区块占位 &amp; 尺寸标注</strong></p>
<p>接下来，让AI用纯色半透明背景来做区块占位，这样你就能很清楚地看到每个区块的位置和大小。根据刚才分析的结果，设置好宽高尺寸，然后标记区块名称。</p>
<p>这一步就像盖房子先搭框架一样，先把结构搭起来。我一般会用不同的颜色来区分不同的区块，比如头部用红色，内容区用蓝色，底部用绿色，这样一眼就能看出来哪里是哪里。</p>
<p><strong>步骤三：嵌套区块 &amp; 组件拆分</strong></p>
<p>框架搭好了，接下来就是细化。继续让AI对区块内部的子区块进行占位和尺寸标注。这一步你会发现，原来复杂的页面，其实就是一个套一个的区块组合起来的。</p>
<p>就像俄罗斯套娃一样，大盒子里面有小盒子，小盒子里面还有更小的盒子。你一层层拆解，就会发现其实没那么复杂。</p>
<p><strong>步骤四：填充真实内容</strong></p>
<p>现在框架和细节都有了，就可以填充真实内容了。记住，要由小到大，从最小的组件开始，一步步填充设计稿的真实内容。这样AI更容易理解，生成的代码也更准确。</p>
<p>我一般会先从按钮、输入框这些小组件开始，然后再到卡片、列表这些中等组件，最后才是整个页面。这样一步步来，AI不会搞混，你也不会抓狂。</p>
<p><strong>步骤五：去除调试样式</strong></p>
<p>内容填充完了，那些占位的边框和调试用的半透明背景就可以去掉了。这时候你会发现，页面已经基本成型了。</p>
<p>这一步其实很简单，就是告诉AI：把那些调试用的样式都删掉，只保留最终需要的样式。就像装修房子，先把脚手架拆掉，看看最终效果。</p>
<p><strong>步骤六：微调 &amp; 验证</strong></p>
<p>最后一步，检查一下是否和设计稿一致。颜色、间距、字体大小，这些细节都要仔细对比。如果发现不对的地方，再让AI微调一下就可以了。</p>
<p>我一般会拿着设计稿，一个像素一个像素地对比。虽然有点累，但是这样出来的效果，真的和设计稿一模一样。设计师看了都夸我，说我是"像素级还原"。</p>
<hr/>
<h3 data-id="heading-2">结尾部分</h3>
<p>这个方法不只适用于设计稿还原。做任何复杂的AI任务，你都可以用这个思路：先分析、再搭框架、然后填充细节、最后微调。比如写长文章、做数据分析、甚至写代码，都可以用这个"分步骤、由大到小"的方法。</p>
<p>记住，AI是工具，不是魔法。你得知道怎么用它，它才能帮你提高效率。这个方法我已经在项目里验证过了，真的特别好用。你们可以试试，如果有什么问题，也可以在评论区告诉我。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 5.0 性能优化实战：从3秒到300ms的构建提速秘籍]]></title>    <link>https://juejin.cn/post/7591413526708502528</link>    <guid>https://juejin.cn/post/7591413526708502528</guid>    <pubDate>2026-01-05T04:16:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591413526708502528" data-draft-id="7591382440583053352" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 5.0 性能优化实战：从3秒到300ms的构建提速秘籍"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-05T04:16:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 5.0 性能优化实战：从3秒到300ms的构建提速秘籍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:16:54.000Z" title="Mon Jan 05 2026 04:16:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite 5.0 性能优化实战：从3秒到300ms的构建提速秘籍</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在前端工程化领域，构建工具的性能直接影响开发体验和生产效率。随着项目规模的扩大，传统的打包工具（如Webpack）在冷启动和热更新时往往显得力不从心，而Vite凭借其原生ESM（ECMAScript Modules）的设计理念和创新的构建策略，正在成为现代前端开发的标配。</p>
<p>Vite 5.0的发布进一步提升了性能，尤其是在构建速度和开发服务器启动时间方面。本文将深入探讨如何通过一系列优化手段，将一个原本需要3秒的构建过程压缩到300ms以内。我们将从Vite的核心原理出发，结合实战案例，揭示这一“提速秘籍”背后的技术细节。</p>
<hr/>
<h2 data-id="heading-2">Vite 5.0的核心优化点</h2>
<h3 data-id="heading-3">1. <strong>原生ESM的极致利用</strong></h3>
<p>Vite的核心优势在于其对浏览器原生ESM的支持。与传统的打包工具不同，Vite在开发模式下直接按需提供源码文件，避免了不必要的打包开销。Vite 5.0在此基础上进一步优化了模块解析算法：</p>
<ul>
<li><strong>更快的依赖预构建</strong>：通过智能缓存和并行处理，减少了<code>node_modules</code>依赖的重复构建时间。</li>
<li><strong>增量编译</strong>：仅对修改的文件重新编译，而非全量重建。</li>
</ul>
<h3 data-id="heading-4">2. <strong>Rust驱动的底层工具链</strong></h3>
<p>Vite 5.0引入了更多基于Rust的工具（如<code>esbuild</code>和<code>swc</code>），替代了部分JavaScript实现的逻辑：</p>
<ul>
<li><code>esbuild</code>用于依赖预构建和代码转换，速度比Babel快10-100倍。</li>
<li><code>swc</code>作为TypeScript编译器，显著减少了TS项目的编译时间。</li>
</ul>
<h3 data-id="heading-5">3. <strong>更智能的缓存策略</strong></h3>
<p>缓存是构建提速的关键。Vite 5.0改进了以下方面：</p>
<ul>
<li><strong>文件系统缓存</strong>：将预构建的依赖存储在<code>node_modules/.vite</code>目录中，避免重复工作。</li>
<li><strong>内存缓存</strong>：在开发服务器运行时保留模块图信息，减少重复解析的开销。</li>
</ul>
<hr/>
<h2 data-id="heading-6">实战优化：从3秒到300ms</h2>
<p>以下是一个实际项目的优化过程记录（基于React + TypeScript技术栈）。原始构建时间为3秒左右，通过以下步骤逐步降至300ms以内。</p>
<h3 data-id="heading-7">Step 1: <strong>分析瓶颈</strong></h3>
<p>使用<code>vite --profile</code>命令生成构建性能报告：</p>
<pre><code class="hljs language-bash" lang="bash">vite build --profile
</code></pre>
<p>报告显示主要耗时集中在：</p>
<ol>
<li>TypeScript类型检查（约40%时间）。</li>
<li><code>node_modules</code>依赖预构建（约30%时间）。</li>
<li>React组件的代码分割（约20%时间）。</li>
</ol>
<h3 data-id="heading-8">Step 2: <strong>关闭生产环境下的类型检查</strong></h3>
<p>在生产构建中，TypeScript类型检查通常是冗余的（CI阶段已覆盖）。通过在<code>vite.config.ts</code>中配置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">minify</span>: <span class="hljs-string">'terser'</span>,
    <span class="hljs-attr">terserOptions</span>: {
      <span class="hljs-attr">compress</span>: {
        <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span>,
      },
    },
    <span class="hljs-comment">// 关闭生产环境类型检查</span>
    <span class="hljs-attr">typescript</span>: {
      <span class="hljs-attr">skipLibCheck</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">noEmitOnError</span>: <span class="hljs-literal">false</span>,
    },
  },
});
</code></pre>
<p>这一改动节省了约40%的时间。</p>
<h3 data-id="heading-9">Step 3: <strong>优化依赖预构建</strong></h3>
<p>默认情况下，Vite会预构建所有依赖项。但对于某些稳定的库（如React、Lodash），可以手动排除：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">optimizeDeps</span>: {
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'react'</span>, <span class="hljs-string">'react-dom'</span>],
}
</code></pre>
<p>同时启用预构建设置缓存：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">optimizeDeps</span>: {
  <span class="hljs-attr">force</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 默认为false表示优先使用缓存</span>
}
</code></pre>
<h3 data-id="heading-10">Step 4: <strong>启用并发处理和多核压缩</strong></h3>
<p>通过配置多线程压缩工具（如Terser）进一步提升速度：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { viteStaticCopy } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-static-copy'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">viteStaticCopy</span>({
      <span class="hljs-attr">targets</span>: [
        { <span class="hljs-attr">src</span>: <span class="hljs-string">'public/**/*'</span>, <span class="hljs-attr">dest</span>: <span class="hljs-string">'assets'</span> },
      ],
    }),
   ],
   <span class="hljs-attr">build</span>: {
     <span class="hljs-attr">minify</span>: <span class="hljs-string">'terser'</span>,
     <span class="hljs-attr">terserOptions</span>: {
       <span class="hljs-attr">compress</span>: {
         <span class="hljs-attr">workers</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//启用多核压缩</span>
       },
     },
   },
});
</code></pre>
<h3 data-id="heading-11">Step 5:<strong>静态资源内联与CDN加速</strong></h3>
<p>对于第三方库(如React),可以通过CDN引入以跳过本地打包:</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/react@18/dist/react.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/react-dom@18/dist/react-dom.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>并在Vue配置中标记为外部依赖:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({ 
 <span class="hljs-attr">optimizeDeps</span>:{ 
   <span class="hljs-attr">exclude</span>:[‘react’,’react-dom’] 
 } 
}) 
</code></pre>
<hr/>
<p>##高级技巧与未来展望</p>
<p>除了上述基础优化外,Vitepress团队还推荐以下进阶手段:</p>
<p>1.<strong>持久化缓存插件</strong>:使用类似<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvite-pwa%2Fvitepress" target="_blank" title="https://github.com/vite-pwa/vitepress" ref="nofollow noopener noreferrer">vite-plugin-pwa</a>实现长期有效资源缓存。
2.<strong>WASM加速计算密集型任务</strong>:例如图像处理或加密运算。
3.<strong>实验性功能尝试</strong>:比如即将推出的"Lightning CSS"(基于Rust)替换传统PostCSS管道。</p>
<p>随着浏览器生态发展,Vites可能会进一步拥抱诸如Import Maps等新兴标准,彻底消除某些场景下对打包工具需求。</p>
<hr/>
<p>##总结</p>
<p>本文详细剖析了如何利用Vitess最新特性实现数量级性能提升—从最初冗长等待到现在近乎即时反馈—展示了现代前端工程化可能性边界扩展过程.</p>
<p>关键点回顾:</p>
<ul>
<li>充分利用原生EMS特性减少无效工作;</li>
<li>合理配置跳过非必要环节(如生产环境TS检查);</li>
<li>善用Rust编写高性能替代品;</li>
<li>结合CDN分流压力;</li>
</ul>
<p>最终效果不仅体现在冷启动数据上—更重要是开发者每天节省数小时重复劳动带来幸福感提升.Vites正重新定义我们对于"快速"二字认知上限</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ralph Wiggum 技巧：让 Claude Code 自主运行数小时]]></title>    <link>https://juejin.cn/post/7591375103521210408</link>    <guid>https://juejin.cn/post/7591375103521210408</guid>    <pubDate>2026-01-05T04:20:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591375103521210408" data-draft-id="7591382440583069736" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ralph Wiggum 技巧：让 Claude Code 自主运行数小时"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-05T04:20:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ralph Wiggum 技巧：让 Claude Code 自主运行数小时
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:20:39.000Z" title="Mon Jan 05 2026 04:20:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.atcyrus.com%2Fstories%2Fralph-wiggum-technique-claude-code-autonomous-loops" target="_blank" title="https://www.atcyrus.com/stories/ralph-wiggum-technique-claude-code-autonomous-loops" ref="nofollow noopener noreferrer">转载</a></p>
<p>你写一个 prompt。Claude 工作了一会儿。然后它停了。"我已经完成了实现，"它自豪地宣布。</p>
<p>你看了看结果。它只完成了 60%。</p>
<p>所以你重新 prompt。Claude 又工作了一会儿。又停了。"功能现在已经完成了。"</p>
<p>还是没完成。</p>
<p><strong>如果 Claude 就这样……一直继续呢？</strong> 如果它在自己的工作上进行迭代，直到任务真正完成——不是当它认为完成时，而是当你的测试真正通过时呢？</p>
<p>这正是 Ralph Wiggum 技巧所实现的。开发者们为此疯狂。</p>
<blockquote>
<p>Ralph Wiggum + Opus 4.5 真的非常非常好</p>
<p>— Matt Pocock (@mattpocockuk) 2026 年 1 月 1 日</p>
</blockquote>
<h2 data-id="heading-0">Ralph Wiggum 插件是什么？</h2>
<p>Ralph Wiggum 插件是一个官方的 Anthropic Claude Code 插件，用于创建自主开发循环。Claude 不会在单次尝试后停止，而是会让 Ralph 持续在同一任务上工作——一次又一次地迭代——直到它真正成功。</p>
<p>这个名字来自《辛普森一家》的角色 Ralph Wiggum，体现了一个简单的哲学：<strong>尽管有挫折，仍坚持迭代</strong>。不断尝试直到你做对为止。</p>
<p>这是核心命令：</p>
<pre><code class="hljs language-arduino" lang="arduino">/ralph-loop <span class="hljs-string">"Fix the token refresh logic in auth.ts. Output &lt;promise&gt;FIXED&lt;/promise&gt; when all tests pass."</span> --max-iterations <span class="hljs-number">10</span> --completion-promise <span class="hljs-string">"FIXED"</span>
</code></pre>
<p>这个想法是持续迭代，并希望能收敛到一个明确的目标。<code>&lt;promise&gt;</code> 标签模式给 Claude 一个明确的信号，告诉它何时输出完成标记。</p>
<p>当你运行这个命令时：</p>
<ol>
<li>Claude 尝试修复</li>
<li>当 Claude 认为它"完成"并试图退出时，一个 Stop hook 会拦截</li>
<li>hook 检查：Claude 是否输出了完成 promise（"FIXED"）？</li>
<li>如果没有，原始 prompt 会带着更新的上下文被重新注入</li>
<li>Claude 看到它自己之前的工作（修改过的文件、git 历史）</li>
<li>它继续迭代，直到 promise 出现在输出中</li>
</ol>
<p><strong>关键洞察：</strong> 每次迭代都不是从头开始。Claude 看到了它在上一轮构建的内容。它审查自己的代码，注意到什么坏了，然后修复它。这个循环创建了一个自我纠错的反馈系统。</p>
<h2 data-id="heading-1">它实际上是如何工作的</h2>
<p>技术机制令人惊讶地优雅。Ralph Wiggum 使用了 Claude Code 的 Stop hook 功能——一种拦截 Claude 试图结束会话的方式。</p>
<p>流程如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">You:</span> /ralph-<span class="hljs-keyword">loop</span> <span class="hljs-string">"Add auth to admin panel. Output &lt;promise&gt;DONE&lt;/promise&gt; when tests pass."</span> --max-iterations <span class="hljs-number">20</span> --completion-promise <span class="hljs-string">"DONE"</span>

[Iteration <span class="hljs-number">1</span>]
<span class="hljs-symbol">Claude:</span> *writes auth logic, tests, middleware*
<span class="hljs-symbol">Claude:</span> <span class="hljs-string">"Authentication implemented."</span>
<span class="hljs-keyword">Stop</span> hook: *Checks output <span class="hljs-keyword">for</span> <span class="hljs-string">"DONE"</span> - <span class="hljs-built_in">not</span> found*
<span class="hljs-keyword">Stop</span> hook: <span class="hljs-string">"Continue working."</span>

[Iteration <span class="hljs-number">2</span>]
<span class="hljs-symbol">Claude:</span> *sees failing tests, reviews own code*
<span class="hljs-symbol">Claude:</span> <span class="hljs-string">"Found issue with session handling. Fixing..."</span>
<span class="hljs-keyword">Stop</span> hook: *Checks output <span class="hljs-keyword">for</span> <span class="hljs-string">"DONE"</span> - <span class="hljs-built_in">not</span> found*
<span class="hljs-keyword">Stop</span> hook: <span class="hljs-string">"Keep going."</span>

[Iteration <span class="hljs-number">3</span>]
<span class="hljs-symbol">Claude:</span> *fixes edge <span class="hljs-keyword">case</span>, runs tests*
<span class="hljs-symbol">Claude:</span> <span class="hljs-string">"All tests passing. &lt;promise&gt;DONE&lt;/promise&gt;"</span>
<span class="hljs-keyword">Stop</span> hook: *Found <span class="hljs-string">"DONE"</span> <span class="hljs-keyword">in</span> output*
<span class="hljs-keyword">Stop</span> hook: <span class="hljs-string">"OK, you can exit now."</span>
</code></pre>
<p><code>--completion-promise</code> 参数定义了"完成"的实际含义。通过在你的 prompt 中将其嵌入 <code>&lt;promise&gt;</code> 标签内，你给 Claude 一个明确的信号，告诉它何时输出标记。hook 只是简单地检查该字符串是否出现在 Claude 的响应中。</p>
<h2 data-id="heading-2">Ralph Wiggum 擅长的场景</h2>
<p>这项技术在特定类型的工作中表现出色：</p>
<h3 data-id="heading-3">大型重构</h3>
<p>从一个框架迁移到另一个框架。更新数百个文件以使用新的 API。将类组件转换为 hooks。这些任务需要 Claude 多次迭代才能把所有事情都做对。</p>
<pre><code class="hljs language-arduino" lang="arduino">/ralph-loop <span class="hljs-string">"Convert all class components to functional components with hooks. Output &lt;promise&gt;MIGRATED&lt;/promise&gt; when npm run typecheck passes."</span> \
  --max-iterations <span class="hljs-number">30</span> \
  --completion-promise <span class="hljs-string">"MIGRATED"</span>
</code></pre>
<h3 data-id="heading-4">测试驱动开发</h3>
<p>先编写失败的测试，然后让 Ralph 迭代直到它们通过：</p>
<pre><code class="hljs language-arduino" lang="arduino">/ralph-loop <span class="hljs-string">"Implement the checkout flow to make all tests in checkout.test.ts pass. Output &lt;promise&gt;TESTS_PASS&lt;/promise&gt; when done."</span> \
  --max-iterations <span class="hljs-number">25</span> \
  --completion-promise <span class="hljs-string">"TESTS_PASS"</span>
</code></pre>
<h3 data-id="heading-5">批量操作</h3>
<p>文档生成、代码标准化、在整个代码库中添加 TypeScript 类型——这些受益于迭代的重复性工作。</p>
<h3 data-id="heading-6">有明确规格的全新功能</h3>
<p>当你有明确定义的功能和自动验证（测试、linter、构建）时，Ralph 可以增量构建它。</p>
<h2 data-id="heading-7">何时不要使用它</h2>
<p>Ralph Wiggum 并不是解决所有问题的魔法方案：</p>
<p><strong>模糊的需求</strong> —— 如果你无法定义客观的成功标准，Ralph 就无法知道何时停止。</p>
<p><strong>架构决策</strong> —— 在微服务和单体之间选择不是可以盲目迭代的事情。</p>
<p><strong>安全关键代码</strong> —— 认证、加密、支付处理——这些需要人工审查，而不是自主迭代。</p>
<p><strong>探索性工作</strong> —— "弄清楚应用程序为什么慢"不是一个好的 Ralph 任务。你需要人工判断来解释结果。</p>
<p><strong>需要人工判断的任务</strong> —— 设计决策、UX 选择、业务逻辑边缘案例——让人工保持在循环中。</p>
<h2 data-id="heading-8">社区的真实成果</h2>
<p>Ralph Wiggum 技巧产生了一些令人印象深刻的成果：</p>
<p><strong>Geoffrey Huntley 的编程语言</strong>：一个 3 个月的连续循环构建了 "Cursed"——一门完整的编程语言，带有 Z 世代的关键字。是的，真的。</p>
<p><strong>YC 黑客马拉松团队</strong>：一夜之间交付了 6+ 个仓库，API 成本约 297 美元。多个完整的项目在人类睡觉时自主运行。</p>
<p><strong>集成测试优化</strong>：一位开发者使用 Ralph 重构测试，将运行时间从 4 分钟减少到 2 秒。</p>
<p>共同的主线：具有自动验证的明确定义的任务运行了延长的时间。</p>
<h2 data-id="heading-9">成本考虑</h2>
<p>让我们现实地谈谈 token 使用。自主循环会快速消耗 token。</p>
<p>在一个中等规模的代码库上，一个典型的 50 次迭代循环可能会花费 50-100 美元以上的 API 使用费。<code>--max-iterations</code> 标志不仅仅是一个安全机制——它是成本控制。</p>
<p><strong>最佳实践：</strong></p>
<ul>
<li>对新任务从较低的迭代限制开始（10-20）</li>
<li>在你了解 token 消耗模式后扩大规模</li>
<li>使用特定的完成标准，以便尽早退出</li>
<li>监控成本与价值——一个节省 20 小时工作的 100 美元循环是值得的</li>
</ul>
<h2 data-id="heading-10">入门指南</h2>
<p>如果你正在使用 Claude Code，以下是尝试 Ralph Wiggum 的方法：</p>
<h3 data-id="heading-11">1. 安装插件</h3>
<p>Ralph Wiggum 是一个官方的 Anthropic 插件。从 Claude Code 中安装它：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin install ralph-wiggum@claude-plugins-official
</code></pre>
<p>你也可以随时使用 <code>/cancel-ralph</code> 取消活动的循环。</p>
<h3 data-id="heading-12">2. 从简单开始</h3>
<p>从一个小的、明确定义的任务开始：</p>
<pre><code class="hljs language-arduino" lang="arduino">/ralph-loop <span class="hljs-string">"Fix all ESLint errors in src/. Output &lt;promise&gt;LINT_CLEAN&lt;/promise&gt; when npm run lint passes."</span> \
  --max-iterations <span class="hljs-number">10</span> \
  --completion-promise <span class="hljs-string">"LINT_CLEAN"</span>
</code></pre>
<h3 data-id="heading-13">3. 定义明确的成功标准</h3>
<p>你的 <code>--completion-promise</code> 应该是：</p>
<ul>
<li>一个简单的、唯一的字符串（如 "DONE"、"FIXED"、"COMPLETE"）</li>
<li>使用 <code>&lt;promise&gt;YOUR_MARKER&lt;/promise&gt;</code> 语法嵌入到你的 prompt 中</li>
<li>Claude 只会在实际目标实现时才输出的东西</li>
</ul>
<h3 data-id="heading-14">4. 与版本控制一起使用</h3>
<p>总是在 git 跟踪的目录中运行 Ralph 循环。如果出现问题，你可以恢复。每次迭代都会添加到 git 历史，给你一个清晰的变更记录。</p>
<h2 data-id="heading-15">背后的哲学</h2>
<p>Ralph Wiggum 反转了典型的 AI 编码工作流。不再是：</p>
<ol>
<li>Prompt → Claude 工作 → 输出 → 人工审查 → 重复</li>
</ol>
<p>你得到的是：</p>
<ol>
<li>Prompt + 成功标准 → Claude 自主循环 → 人工审查最终结果</li>
</ol>
<p>这项技术将__失败视为学习数据__。每次失败的尝试都告诉 Claude 什么不起作用。在迭代过程中，解决方案会收敛向成功。</p>
<p>这种哲学——即持续迭代胜过完美的首次尝试——感觉违反直觉。我们被训练认为 AI 应该"立即做对"。但复杂编码任务的现实更加混乱。有时你需要多次尝试。有时你需要看到什么坏了才能修复它。</p>
<p>Ralph Wiggum 接受了这种现实。</p>
<h2 data-id="heading-16">这对开发工作流意味着什么</h2>
<p>Ralph Wiggum 技巧是我们与 AI 编码助手合作方式更广泛转变的一部分：</p>
<p><strong>从交互到自主</strong>：不再是看守每一步，而是定义目标并让 AI 向其迭代。</p>
<p><strong>从单次到迭代</strong>：接受复杂任务需要多次尝试，并将其构建到工作流中。</p>
<p><strong>从人类节奏到机器节奏</strong>：一个过夜的循环可以完成人类需要几天专注工作才能完成的事情。</p>
<p>对于大量使用 Claude Code 的团队，Ralph Wiggum 开启了一类新的任务——那些对人类来说太繁琐但对单个 prompt 来说又太复杂的任务。</p>
<h2 data-id="heading-17">关于 Opus 4.5 的说明</h2>
<p>有一点值得一提：随着 Opus 4.5 的出现，Ralph Wiggum 技巧对许多任务来说变得不那么必要了。正如 savage-bits 在 Reddit 上指出的那样：Opus 4.5 在遵循计划方面非常出色，而且压缩（上下文管理）已大大改进。</p>
<p>这些增强意味着 Claude 更擅长在更少的迭代中完成复杂任务——有时甚至可以一次性完成。模型改进的维护上下文和执行多步骤计划的能力，减少了对强制迭代循环的需求。</p>
<p>尽管如此，对于真正的大型重构、过夜的批量操作，以及你想要明确迭代控制的任务，Ralph Wiggum 仍然表现出色。它是你的工具箱中的一项强大技术，即使你发现自己随着新模型的推出而越来越少地使用它。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[哈珀·李的《**杀死一只知更鸟**》（*To Kill a Mockingbird*）是一部关于**人性、正义与道德成长**的小说]]></title>    <link>https://juejin.cn/post/7591420438850043940</link>    <guid>https://juejin.cn/post/7591420438850043940</guid>    <pubDate>2026-01-05T04:30:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591420438850043940" data-draft-id="7591575910257180699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="哈珀·李的《**杀死一只知更鸟**》（*To Kill a Mockingbird*）是一部关于**人性、正义与道德成长**的小说"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-05T04:30:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            哈珀·李的《**杀死一只知更鸟**》（*To Kill a Mockingbird*）是一部关于**人性、正义与道德成长**的小说
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:30:25.000Z" title="Mon Jan 05 2026 04:30:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">🕊️ 1. <strong>道德勇气与正义</strong></h3>
<p>小说的核心人物阿蒂克斯·芬奇（Atticus Finch）象征正义与理性。他在种族偏见严重的社会中，仍然选择为黑人汤姆·罗宾逊辩护，体现了<strong>在压力和舆论面前坚持真理</strong>的勇气。</p>
<blockquote>
<p>他教导孩子：“勇气不是拿着枪的人，而是在你知道自己可能会失败时，仍然坚持做正确的事。”</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">⚖️ 2. <strong>种族偏见与社会不公</strong></h3>
<p>通过汤姆·罗宾逊被错误定罪的故事，小说揭露了美国南方社会根深蒂固的<strong>种族歧视</strong>与<strong>法律不公</strong>。哈珀·李通过司法体系的失败，批判了社会制度的盲点——即使真相明摆在眼前，偏见仍然主宰人心。</p>
<hr/>
<h3 data-id="heading-2">🌱 3. <strong>成长与同理心</strong></h3>
<p>故事从小女孩斯库特（Scout）的视角展开。她的成长过程象征着<strong>从天真到觉醒</strong>的心灵转变。在父亲的影响下，她学会了用同理心去理解他人，特别是在阿蒂克斯教她——</p>
<blockquote>
<p>“你永远不会真正理解一个人，除非你设身处地，从他的角度想问题。”</p>
</blockquote>
<p>这句话贯穿全书，成为道德理解的核心。</p>
<hr/>
<h3 data-id="heading-3">🕊️ 4. <strong>知更鸟的象征意义</strong></h3>
<p>知更鸟象征<strong>纯洁与善良</strong>。小说标题中的“杀死一只知更鸟”是一个隐喻，意指<strong>伤害无辜者是一种罪恶</strong>。汤姆·罗宾逊和布·拉德利（Boo Radley）都像“知更鸟”一样无辜，却受到偏见的伤害。</p>
<hr/>
<h3 data-id="heading-4">🌍 5. <strong>人性的复杂与希望</strong></h3>
<p>虽然小说揭示了社会的丑陋一面，但它依然充满希望。通过斯库特的成长和阿蒂克斯的坚持，哈珀·李传递了信念：<strong>人性虽有偏见，但教育、理解与同情能带来改变。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[“开源”和“闭源“，AI 模型的发展方向]]></title>    <link>https://juejin.cn/post/7591420438850060324</link>    <guid>https://juejin.cn/post/7591420438850060324</guid>    <pubDate>2026-01-05T04:32:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591420438850060324" data-draft-id="7591410544928178218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="“开源”和“闭源“，AI 模型的发展方向"/> <meta itemprop="keywords" content="人工智能,前端,AIGC"/> <meta itemprop="datePublished" content="2026-01-05T04:32:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            “开源”和“闭源“，AI 模型的发展方向
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:32:29.000Z" title="Mon Jan 05 2026 04:32:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🤖 一、什么是“开源”和“闭源”AI？</h2>
<ul>
<li><strong>开源模型</strong>：其架构、参数或训练方式向公众开放，任何人都可以下载、微调或应用。例如：LLaMA（Meta）、Mistral、Falcon、Stable Diffusion。</li>
<li><strong>闭源模型</strong>：核心代码、参数和数据集不公开，由特定公司控制。例如：GPT 系列（OpenAI）、Claude（Anthropic）、Gemini（Google）。</li>
</ul>
<hr/>
<h2 data-id="heading-1">⚙️ 二、开源 AI 的优势与挑战</h2>
<h3 data-id="heading-2">✅ 优势：</h3>
<ol>
<li><strong>透明性与可验证性</strong>：任何人都可以审查模型结构与输出，助力安全性研究与学术创新。</li>
<li><strong>民主化与可定制</strong>：小型团队或个人也能构建强AI应用，降低技术门槛。</li>
<li><strong>加速生态繁荣</strong>：社区协作能快速迭代，类似 Linux 或 Python 的成功。</li>
</ol>
<h3 data-id="heading-3">⚠️ 挑战：</h3>
<ol>
<li><strong>安全风险</strong>：不良利用（如深度伪造、自动化网络攻击、虚假内容生成）难以监管。</li>
<li><strong>缺乏统一管理与责任归属</strong>：开放环境下的失控风险提升。</li>
<li><strong>资金与计算资源瓶颈</strong>：训练大型模型成本极高，社区项目难以持续。</li>
</ol>
<hr/>
<h2 data-id="heading-4">🧩 三、闭源 AI 的优势与挑战</h2>
<h3 data-id="heading-5">✅ 优势：</h3>
<ol>
<li><strong>质量控制</strong>：由专门团队负责优化、过滤有害输出、确保稳定。</li>
<li><strong>安全与商业可控性</strong>：更易遵守监管要求、保护知识产权与品牌声誉。</li>
<li><strong>持续创新能力</strong>：商业利润驱动研发投入，促成更强算力与更复杂模型。</li>
</ol>
<h3 data-id="heading-6">⚠️ 挑战：</h3>
<ol>
<li><strong>不透明与信任问题</strong>：用户无法验证模型是否存在偏见或隐私泄露。</li>
<li><strong>权力集中化</strong>：AI 能力可能掌握在少数巨头公司手中，导致技术垄断。</li>
<li><strong>创新受限</strong>：社区开发者难以复用与改进底层技术。</li>
</ol>
<hr/>
<h2 data-id="heading-7">🌍 四、未来趋势：走向“混合共存”格局</h2>
<p>现实中，<strong>AI 生态正在朝着“开源 + 闭源共进”的方向演化</strong>：</p>
<ol>
<li><strong>开源驱动底层创新</strong>：推动算法、架构、训练方法的突破。</li>
<li><strong>闭源推动商业落地</strong>：保障模型质量、合规与服务可持续发展。</li>
<li><strong>政府与社区监管介入</strong>：要求重大模型透明、负责任 AI 治理。</li>
<li><strong>API 生态逐渐融合</strong>：大型闭源模型可能支持“可控接口 + 本地开源扩展”，形成“混合 AI 堆栈”。</li>
</ol>
<hr/>
<h2 data-id="heading-8">🔮 五、未来属于谁？</h2>
<p><strong>未来不会属于单一阵营，而是属于兼顾开放性与安全性的平衡力量。</strong></p>
<ul>
<li>
<p>如果 <strong>开源阵营</strong> 继续发力，建立起 <strong>安全协议、数据治理标准与算力共享机制</strong>，它有望成为创新的温床；</p>
</li>
<li>
<p>而 <strong>闭源巨头</strong> 若能提升 <strong>透明度与可解释性</strong>，也可保持主导地位；</p>
</li>
<li>
<p>最可能的格局：</p>
<blockquote>
<p>“底层开源、上层闭源；模型基础开放、应用生态封闭”——就像今天的互联网堆栈。</p>
</blockquote>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis设计模式之装饰器、模版方法、策略模式]]></title>    <link>https://juejin.cn/post/7591508100664180787</link>    <guid>https://juejin.cn/post/7591508100664180787</guid>    <pubDate>2026-01-05T04:47:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591508100664180787" data-draft-id="7591441637052006450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis设计模式之装饰器、模版方法、策略模式"/> <meta itemprop="keywords" content="MyBatis"/> <meta itemprop="datePublished" content="2026-01-05T04:47:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis设计模式之装饰器、模版方法、策略模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T04:47:16.000Z" title="Mon Jan 05 2026 04:47:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MyBatis设计模式深度解析（二）</h2>
<h3 data-id="heading-1">一、MyBatis整体架构与设计模式续篇</h3>
<p>在上一篇文章中，我们深入讲解了MyBatis中的构建者模式、工厂模式和代理模式。本文将继续探讨MyBatis中另外三种重要的设计模式：装饰器模式、模板方法模式和策略模式。这些设计模式的应用，使得MyBatis在功能扩展、性能优化和架构灵活性方面表现出色。</p>
<h4 data-id="heading-2">1.1 MyBatis整体架构回顾</h4>
<p>MyBatis采用分层架构设计，从上到下包括：</p>
<ul>
<li><strong>应用层</strong>：用户应用程序</li>
<li><strong>接口层</strong>：SqlSession、Mapper接口</li>
<li><strong>核心处理层</strong>：SQL解析、执行、结果映射</li>
<li><strong>基础支撑层</strong>：缓存、事务、类型处理、日志等</li>
<li><strong>数据层</strong>：数据源、连接池、JDBC驱动</li>
</ul>
<p>在本文中，我们将重点探讨装饰器模式、模板方法模式和策略模式在这些层次中的应用。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4db29f98fb1640269893795b062e55a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768193236&amp;x-signature=CaWZ8kimn9%2B%2BcbVeEMEFT8%2FI6Bg%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3">1.2 本文涉及的设计模式</h4>
<ol>
<li><strong>装饰器模式（Decorator Pattern）</strong>：CachingExecutor、Cache装饰器链</li>
<li><strong>模板方法模式（Template Method Pattern）</strong>：BaseExecutor、BaseTypeHandler</li>
<li><strong>策略模式（Strategy Pattern）</strong>：RoutingStatementHandler、不同Executor策略</li>
</ol>
<h3 data-id="heading-4">二、装饰器模式（Decorator Pattern）</h3>
<p>装饰器模式是一种结构型设计模式，它允许你在不改变对象结构的情况下，动态地为对象添加新的行为。装饰器模式通过将对象包装在装饰器类中来实现功能的增强。</p>
<h4 data-id="heading-5">2.1 CachingExecutor</h4>
<p>CachingExecutor是MyBatis中最典型的装饰器模式应用。它为Executor添加了二级缓存功能。</p>
<h5 data-id="heading-6">2.1.1 类定义</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachingExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor delegate;  <span class="hljs-comment">// 被装饰的Executor</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">TransactionalCacheManager</span> <span class="hljs-variable">tcm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionalCacheManager</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CachingExecutor</span><span class="hljs-params">(Executor delegate)</span> {
        <span class="hljs-built_in">this</span>.delegate = delegate;
        <span class="hljs-comment">// 确保被装饰的Executor类型是SIMPLE、REUSE或BATCH</span>
        <span class="hljs-keyword">if</span> (delegate <span class="hljs-keyword">instanceof</span> CachingExecutor) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Cannot wrap a CachingExecutor"</span>);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 1. 获取绑定SQL</span>
        <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> ms.getBoundSql(parameterObject);
        <span class="hljs-comment">// 2. 创建缓存Key</span>
        <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> createCacheKey(ms, parameterObject, rowBounds, boundSql);
        <span class="hljs-comment">// 3. 执行查询（先查缓存，缓存没有则查数据库）</span>
        <span class="hljs-keyword">return</span> query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 4. 获取MappedStatement的缓存配置</span>
        <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> ms.getCache();

        <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 5. 刷新缓存（如果需要）</span>
            flushCacheIfRequired(ms);
            <span class="hljs-keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 6. 确保参数不为null时才使用缓存</span>
                ensureNoOutParams(ms, boundSql);
                <span class="hljs-comment">// 7. 从事务缓存管理器获取缓存</span>
                <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
                List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);
                <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// 8. 缓存未命中，委托给被装饰的Executor执行查询</span>
                    list = delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
                    <span class="hljs-comment">// 9. 将查询结果放入缓存</span>
                    tcm.putObject(cache, key, list); <span class="hljs-comment">// issue #578 and #116</span>
                }
                <span class="hljs-keyword">return</span> list;
            }
        }
        <span class="hljs-comment">// 10. 没有配置缓存，直接委托给被装饰的Executor</span>
        <span class="hljs-keyword">return</span> delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(MappedStatement ms, Object parameterObject)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 更新操作先刷新缓存</span>
        flushCacheIfRequired(ms);
        <span class="hljs-comment">// 委托给被装饰的Executor执行更新</span>
        <span class="hljs-keyword">return</span> delegate.update(ms, parameterObject);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flushCacheIfRequired</span><span class="hljs-params">(MappedStatement ms)</span> {
        <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> ms.getCache();
        <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span> &amp;&amp; ms.isFlushCacheRequired()) {
            tcm.clear(cache);
        }
    }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9645831369f34d21bbedc92d218ec65c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768193236&amp;x-signature=GG5%2BgMyTrlrYGevsynUyATmjSmo%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-7">2.1.2 装饰器模式的优势</h5>
<ol>
<li><strong>不修改原始类</strong>：通过包装而非继承来扩展功能</li>
<li><strong>动态组合</strong>：可以在运行时动态地添加或删除功能</li>
<li><strong>职责单一</strong>：每个装饰器只负责一个功能</li>
<li><strong>灵活扩展</strong>：可以多层嵌套，实现功能的灵活组合</li>
</ol>
<h4 data-id="heading-8">2.2 Cache装饰器链</h4>
<p>MyBatis的缓存系统也大量使用了装饰器模式。Cache接口有多个装饰器实现，形成了一个装饰器链。</p>
<h5 data-id="heading-9">2.2.1 Cache接口</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Cache</span> {
    String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span>;
    Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span>;
    Object <span class="hljs-title function_">removeObject</span><span class="hljs-params">(Object key)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span>;
    <span class="hljs-type">int</span> <span class="hljs-title function_">getSize</span><span class="hljs-params">()</span>;
    ReadWriteLock <span class="hljs-title function_">getReadWriteLock</span><span class="hljs-params">()</span>;
}
</code></pre>
<h5 data-id="heading-10">2.2.2 Cache装饰器实现</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. PerpetualCache - 基础缓存实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerpetualCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;
    <span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PerpetualCache</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        cache.put(key, value);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> {
        <span class="hljs-keyword">return</span> cache.get(key);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">removeObject</span><span class="hljs-params">(Object key)</span> {
        <span class="hljs-keyword">return</span> cache.remove(key);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        cache.clear();
    }
}

<span class="hljs-comment">// 2. LruCache - LRU淘汰策略装饰器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LruCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;
    <span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; keyMap;
    <span class="hljs-keyword">private</span> Object eldestKey;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LruCache</span><span class="hljs-params">(Cache delegate)</span> {
        <span class="hljs-built_in">this</span>.delegate = delegate;
        setSize(<span class="hljs-number">1024</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        delegate.putObject(key, value);
        cycleKeyList(key);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> {
        keyMap.get(key); <span class="hljs-comment">// 触发LRU</span>
        <span class="hljs-keyword">return</span> delegate.getObject(key);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cycleKeyList</span><span class="hljs-params">(Object key)</span> {
        keyMap.put(key, key);
        <span class="hljs-keyword">if</span> (eldestKey != <span class="hljs-literal">null</span>) {
            delegate.removeObject(eldestKey);
            eldestKey = <span class="hljs-literal">null</span>;
        }
    }
}

<span class="hljs-comment">// 3. FifoCache - FIFO淘汰策略装饰器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FifoCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;Object&gt; keyList;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FifoCache</span><span class="hljs-params">(Cache delegate)</span> {
        <span class="hljs-built_in">this</span>.delegate = delegate;
        <span class="hljs-built_in">this</span>.keyList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        <span class="hljs-built_in">this</span>.size = <span class="hljs-number">1024</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        cycleKeyList(key);
        delegate.putObject(key, value);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cycleKeyList</span><span class="hljs-params">(Object key)</span> {
        keyList.addLast(key);
        <span class="hljs-keyword">if</span> (keyList.size() &gt; size) {
            <span class="hljs-type">Object</span> <span class="hljs-variable">oldestKey</span> <span class="hljs-operator">=</span> keyList.removeFirst();
            delegate.removeObject(oldestKey);
        }
    }
}

<span class="hljs-comment">// 4. SoftCache/WeakCache - 软引用/弱引用装饰器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SoftCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Object, Object&gt; hardLinksToAvoidGarbageCollection;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        delegate.putObject(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftEntry</span>(value));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> delegate.getObject(key);
        <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> SoftEntry) {
            <span class="hljs-keyword">return</span> ((SoftEntry) value).get();
        }
        <span class="hljs-keyword">return</span> value;
    }
}

<span class="hljs-comment">// 5. BlockingCache - 阻塞装饰器（防止缓存击穿）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlockingCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Object, CountDownLatch&gt; locks;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        <span class="hljs-keyword">try</span> {
            delegate.putObject(key, value);
        } <span class="hljs-keyword">finally</span> {
            releaseLock(key);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> {
        acquireLock(key);
        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> delegate.getObject(key);
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            releaseLock(key);
        }
        <span class="hljs-keyword">return</span> value;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireLock</span><span class="hljs-params">(Object key)</span> {
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">existing</span> <span class="hljs-operator">=</span> locks.putIfAbsent(key, latch);
        <span class="hljs-keyword">if</span> (existing != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                existing.await();
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.interrupted();
            }
        }
    }
}

<span class="hljs-comment">// 6. LoggingCache - 日志装饰器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">requests</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        delegate.putObject(key, value);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> {
        requests++;
        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> delegate.getObject(key);
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            hits++;
        }
        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) {
            log.debug(<span class="hljs-string">"Cache Hit Ratio ["</span> + getId() + <span class="hljs-string">"]: "</span> + getHitRatio());
        }
        <span class="hljs-keyword">return</span> value;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getHitRatio</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) hits / (<span class="hljs-type">double</span>) requests;
    }
}

<span class="hljs-comment">// 7. ScheduledCache - 定时清理装饰器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduledCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> clearInterval;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> lastClear;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        clearWhenStale();
        delegate.putObject(key, value);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> {
        <span class="hljs-keyword">return</span> clearWhenStale() ? <span class="hljs-literal">null</span> : delegate.getObject(key);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">clearWhenStale</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (System.currentTimeMillis() - lastClear &gt; clearInterval) {
            clear();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}

<span class="hljs-comment">// 8. SerializedCache - 序列化装饰器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializedCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> &amp;&amp; !(value <span class="hljs-keyword">instanceof</span> Serializable)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">"Cacheed object is not serializable: "</span> + value);
        }
        delegate.putObject(key, serialize(value));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> delegate.getObject(key);
        <span class="hljs-keyword">return</span> object == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : deserialize((<span class="hljs-type">byte</span>[]) object);
    }
}

<span class="hljs-comment">// 9. SynchronizedCache - 同步装饰器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        delegate.putObject(key, value);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> {
        <span class="hljs-keyword">return</span> delegate.getObject(key);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        delegate.clear();
    }
}

<span class="hljs-comment">// 10. TransactionalCache - 事务缓存装饰器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionalCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> clearOnCommit;
    <span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; entriesToAddOnCommit;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        entriesToAddOnCommit.put(key, value);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> {
        <span class="hljs-keyword">if</span> (clearOnCommit) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> delegate.getObject(key);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (clearOnCommit) {
            delegate.clear();
        }
        <span class="hljs-keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : entriesToAddOnCommit.entrySet()) {
            delegate.putObject(entry.getKey(), entry.getValue());
        }
        reset();
    }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c689d5e41ee04fa68ab728e8a04a0771~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768193236&amp;x-signature=FxFwlCKU3%2F3hgO9noFTtP7ppbew%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-11">2.2.3 Cache装饰器链的构建</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheBuilder</span> {
    <span class="hljs-keyword">private</span> String id;
    <span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; implementation;
    <span class="hljs-keyword">private</span> List&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt;&gt; decorators;

    <span class="hljs-keyword">public</span> Cache <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
        setDefaultImplementations();
        <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> newBaseCacheInstance(implementation, id);
        setCacheProperties(cache);

        <span class="hljs-comment">// 应用装饰器</span>
        <span class="hljs-keyword">for</span> (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; decorator : decorators) {
            cache = newCacheDecoratorInstance(decorator, cache);
            setCacheProperties(cache);
        }
        <span class="hljs-keyword">return</span> cache;
    }
}
</code></pre>
<h4 data-id="heading-12">2.3 装饰器模式的应用场景</h4>
<p>在MyBatis中，装饰器模式主要应用于：</p>
<ol>
<li><strong>Executor增强</strong>：CachingExecutor为Executor添加二级缓存功能</li>
<li><strong>Cache功能扩展</strong>：通过各种Cache装饰器添加LRU、FIFO、日志等功能</li>
<li><strong>StatementHandler增强</strong>：通过RoutingStatementHandler路由到不同的实现</li>
</ol>
<h4 data-id="heading-13">2.4 装饰器模式 vs 继承</h4>
<p>装饰器模式相比继承的优势：</p>



































<table><thead><tr><th>对比项</th><th>装饰器模式</th><th>继承</th></tr></thead><tbody><tr><td>扩展方式</td><td>动态组合</td><td>静态继承</td></tr><tr><td>灵活性</td><td>高</td><td>低</td></tr><tr><td>代码复用</td><td>好</td><td>一般</td></tr><tr><td>类数量</td><td>可能增加</td><td>可能爆炸</td></tr><tr><td>复杂度</td><td>中等</td><td>简单</td></tr></tbody></table>
<h3 data-id="heading-14">三、模板方法模式（Template Method Pattern）</h3>
<p>模板方法模式是一种行为型设计模式，它在父类中定义了一个算法的框架，允许子类在不改变算法结构的情况下重写算法的特定步骤。</p>
<h4 data-id="heading-15">3.1 BaseExecutor</h4>
<p>BaseExecutor是MyBatis中模板方法模式的典型应用，它定义了SQL执行的基本流程，将具体的执行逻辑留给子类实现。</p>
<h5 data-id="heading-16">3.1.1 BaseExecutor核心代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> {

    <span class="hljs-keyword">protected</span> Transaction transaction;
    <span class="hljs-keyword">protected</span> Executor wrapper;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 1. 获取绑定SQL</span>
        <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> ms.getBoundSql(parameter);
        <span class="hljs-comment">// 2. 创建缓存Key</span>
        <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> createCacheKey(ms, parameter, rowBounds, boundSql);
        <span class="hljs-comment">// 3. 调用模板方法</span>
        <span class="hljs-keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);
    }

    <span class="hljs-comment">// 模板方法 - 定义算法骨架</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException {
        ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">"executing a query"</span>).object(ms.getId());

        <span class="hljs-keyword">if</span> (closed) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">"Executor was closed."</span>);
        }
        <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span> &amp;&amp; ms.isFlushCacheRequired()) {
            clearLocalCache();
        }

        List&lt;E&gt; list;
        <span class="hljs-keyword">try</span> {
            queryStack++;
            <span class="hljs-comment">// 4. 检查一级缓存</span>
            list = resultHandler == <span class="hljs-literal">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span>) {
                handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 5. 缓存未命中，调用抽象方法查询数据库</span>
                list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);
            }
        } <span class="hljs-keyword">finally</span> {
            queryStack--;
        }

        <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span>) {
            deferLoadIfNeeded();
        }
        <span class="hljs-keyword">return</span> list;
    }

    <span class="hljs-comment">// 从数据库查询 - 也是模板方法</span>
    <span class="hljs-keyword">private</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">queryFromDatabase</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException {
        List&lt;E&gt; list;
        localCache.putObject(key, EXECUTION_PLACEHOLDER);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 6. 调用抽象方法，由子类实现具体查询逻辑</span>
            list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);
        } <span class="hljs-keyword">finally</span> {
            localCache.removeObject(key);
        }
        localCache.putObject(key, list);
        <span class="hljs-keyword">return</span> list;
    }

    <span class="hljs-comment">// 抽象方法 - 由子类实现具体的查询逻辑</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter,
                                           RowBounds rowBounds, ResultHandler resultHandler,
                                           BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException;

    <span class="hljs-comment">// 抽象方法 - 由子类实现具体的更新逻辑</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException;

    <span class="hljs-comment">// 其他抽象方法...</span>
}
</code></pre>
<h5 data-id="heading-17">3.1.2 BaseExecutor的子类实现</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. SimpleExecutor - 简单执行器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 创建Statement</span>
            stmt = createStatement(ms, parameter, rowBounds);
            <span class="hljs-comment">// 2. 设置参数</span>
            setStatementParameters(ms, stmt, parameter, rowBounds, boundSql);
            <span class="hljs-comment">// 3. 执行查询</span>
            <span class="hljs-keyword">return</span> handler.query(stmt, resultHandler);
        } <span class="hljs-keyword">finally</span> {
            closeStatement(stmt);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();
            <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(<span class="hljs-built_in">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
            stmt = prepareStatement(handler, ms.getStatementLog());
            <span class="hljs-keyword">return</span> handler.update(stmt);
        } <span class="hljs-keyword">finally</span> {
            closeStatement(stmt);
        }
    }
}

<span class="hljs-comment">// 2. ReuseExecutor - 重用执行器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReuseExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Statement&gt; statementMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();
        <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(<span class="hljs-built_in">this</span>, ms, parameter, rowBounds, resultHandler, boundSql);
        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> prepareStatement(handler, ms.getStatementLog(), <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">return</span> handler.query(stmt, resultHandler);
    }

    <span class="hljs-keyword">private</span> Statement <span class="hljs-title function_">prepareStatement</span><span class="hljs-params">(StatementHandler handler, Log statementLog, <span class="hljs-type">boolean</span> isReusable)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> handler.getBoundSql();
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();
        Statement stmt;
        <span class="hljs-keyword">if</span> (isReusable) {
            <span class="hljs-comment">// 尝试重用Statement</span>
            stmt = statementMap.get(sql);
            <span class="hljs-keyword">if</span> (stmt == <span class="hljs-literal">null</span>) {
                stmt = handler.prepare(statementLog.getConnection(), transaction.getTimeout());
                statementMap.put(sql, stmt);
            }
        } <span class="hljs-keyword">else</span> {
            stmt = handler.prepare(statementLog.getConnection(), transaction.getTimeout());
        }
        handler.parameterize(stmt);
        <span class="hljs-keyword">return</span> stmt;
    }
}

<span class="hljs-comment">// 3. BatchExecutor - 批量执行器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Statement&gt; statementList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;BatchResult&gt; batchResultList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();
        <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(<span class="hljs-built_in">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> prepareStatement(handler, ms.getStatementLog());
        handler.parameterize(stmt);
        batchResultList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchResult</span>(ms.getStatement(), ms.getId(), parameter));
        handler.batch(stmt);
        <span class="hljs-keyword">return</span> BATCH_UPDATE_RETURN_VALUE;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span> {
        List&lt;BatchResult&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = statementList.size(); i &lt; n; i++) {
                <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> statementList.get(i);
                <span class="hljs-type">BatchResult</span> <span class="hljs-variable">batchResult</span> <span class="hljs-operator">=</span> batchResultList.get(i);
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">int</span>[] updateCounts = stmt.executeBatch();
                    batchResult.setUpdateCounts(updateCounts);
                    results.add(batchResult);
                } <span class="hljs-keyword">catch</span> (BatchUpdateException e) {
                    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
                    message.append(batchResult.getStatement()).append(<span class="hljs-string">" failed."</span>);
                    <span class="hljs-keyword">if</span> (updateCounts != <span class="hljs-literal">null</span> &amp;&amp; updateCounts.length &gt; <span class="hljs-number">0</span>) {
                        message.append(<span class="hljs-string">" Update counts: "</span>);
                        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; updateCounts.length; j++) {
                            message.append(updateCounts[j]).append(<span class="hljs-string">";"</span>);
                        }
                    }
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchExecutorException</span>(message.toString(), e, updateCounts, batchResult.getStatement());
                }
            }
            <span class="hljs-keyword">return</span> results;
        } <span class="hljs-keyword">finally</span> {
            clearLocalCache();
            statementList.clear();
            batchResultList.clear();
        }
    }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50be1d25c9ef48d2b156588514c8e8c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768193236&amp;x-signature=Ao1y3k3A06KXdWoHAx%2BHeVt%2Bt0U%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18">3.2 BaseTypeHandler</h4>
<p>BaseTypeHandler也是模板方法模式的应用，它定义了类型处理的基本流程。</p>
<h5 data-id="heading-19">3.2.1 BaseTypeHandler核心代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeReference</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TypeHandler</span>&lt;T&gt; {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 模板方法：设置非空参数</span>
        setParameter(ps, i, parameter, jdbcType);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 模板方法：通过列名获取结果</span>
        <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getNullableResult(rs, columnName);
        <span class="hljs-keyword">return</span> rs.wasNull() ? <span class="hljs-literal">null</span> : result;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 模板方法：通过列索引获取结果</span>
        <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getNullableResult(rs, columnIndex);
        <span class="hljs-keyword">return</span> rs.wasNull() ? <span class="hljs-literal">null</span> : result;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 模板方法：从存储过程获取结果</span>
        <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getNullableResult(cs, columnIndex);
        <span class="hljs-keyword">return</span> cs.wasNull() ? <span class="hljs-literal">null</span> : result;
    }

    <span class="hljs-comment">// 抽象方法：由子类实现具体的参数设置逻辑</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="hljs-keyword">throws</span> SQLException;

    <span class="hljs-comment">// 抽象方法：由子类实现具体的结果获取逻辑</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> <span class="hljs-keyword">throws</span> SQLException;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException;
}
</code></pre>
<h5 data-id="heading-20">3.2.2 具体的TypeHandler实现</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// StringTypeHandler</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringTypeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;String&gt; {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, String parameter, JdbcType jdbcType)</span> <span class="hljs-keyword">throws</span> SQLException {
        ps.setString(i, parameter);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> rs.getString(columnName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> rs.getString(columnIndex);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> cs.getString(columnIndex);
    }
}

<span class="hljs-comment">// IntegerTypeHandler</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntegerTypeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;Integer&gt; {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, Integer parameter, JdbcType jdbcType)</span> <span class="hljs-keyword">throws</span> SQLException {
        ps.setInt(i, parameter);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> rs.getInt(columnName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> rs.getInt(columnIndex);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> cs.getInt(columnIndex);
    }
}
</code></pre>
<h4 data-id="heading-21">3.3 模板方法模式的优势</h4>
<ol>
<li><strong>代码复用</strong>：将公共逻辑提取到父类，避免重复代码</li>
<li><strong>扩展性强</strong>：子类可以灵活实现特定步骤</li>
<li><strong>算法稳定</strong>：算法框架固定，保证一致性</li>
<li><strong>易于维护</strong>：修改算法只需修改父类</li>
</ol>
<h3 data-id="heading-22">四、策略模式（Strategy Pattern）</h3>
<p>策略模式是一种行为型设计模式，它定义了一系列算法，并将每个算法封装起来，使它们可以相互替换。策略模式让算法独立于使用它的客户端。</p>
<h4 data-id="heading-23">4.1 RoutingStatementHandler</h4>
<p>RoutingStatementHandler是MyBatis中策略模式的典型应用，它根据MappedStatement的配置，路由到不同的StatementHandler实现。</p>
<h5 data-id="heading-24">4.1.1 RoutingStatementHandler源码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutingStatementHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StatementHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StatementHandler delegate;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RoutingStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> {
        <span class="hljs-comment">// 根据Statement类型选择策略</span>
        <span class="hljs-keyword">switch</span> (ms.getStatementType()) {
            <span class="hljs-keyword">case</span> STATEMENT:
                delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> PREPARED:
                delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PreparedStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> CALLABLE:
                delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CallableStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">"Unknown statement type: "</span> + ms.getStatementType());
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Statement <span class="hljs-title function_">prepare</span><span class="hljs-params">(Connection connection, Integer transactionTimeout)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> delegate.prepare(connection, transactionTimeout);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException {
        delegate.parameterize(statement);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> delegate.query(statement, resultHandler);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> delegate.update(statement);
    }

    <span class="hljs-comment">// 其他方法都委托给delegate...</span>
}
</code></pre>
<h5 data-id="heading-25">4.1.2 三种StatementHandler策略</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. SimpleStatementHandler - 简单SQL策略</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleStatementHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseStatementHandler</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">if</span> (mappedStatement.getResultSetType() == ResultSetType.FORWARD_ONLY) {
            <span class="hljs-keyword">return</span> connection.createStatement();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> connection.createStatement(mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();
        <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> boundSql.getParameterObject();
        <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();
        <span class="hljs-type">int</span> rows;
        <span class="hljs-keyword">if</span> (keyGenerator <span class="hljs-keyword">instanceof</span> Jdbc3KeyGenerator) {
            statement.execute(sql, Statement.RETURN_GENERATED_KEYS);
            rows = statement.getUpdateCount();
            keyGenerator.processAfter(executor, mappedStatement, statement, parameterObject);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyGenerator <span class="hljs-keyword">instanceof</span> SelectKeyGenerator) {
            statement.execute(sql);
            rows = statement.getUpdateCount();
            keyGenerator.processAfter(executor, mappedStatement, statement, parameterObject);
        } <span class="hljs-keyword">else</span> {
            statement.execute(sql);
            rows = statement.getUpdateCount();
        }
        <span class="hljs-keyword">return</span> rows;
    }
}

<span class="hljs-comment">// 2. PreparedStatementHandler - 预编译SQL策略</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreparedStatementHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseStatementHandler</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();
        <span class="hljs-keyword">if</span> (mappedStatement.getResultSetType() == ResultSetType.FORWARD_ONLY) {
            <span class="hljs-keyword">return</span> connection.prepareStatement(sql);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> connection.prepareStatement(sql, mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException {
        parameterHandler.setParameters((PreparedStatement) statement);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> (PreparedStatement) statement;
        ps.execute();
        <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> ps.getUpdateCount();
        <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> boundSql.getParameterObject();
        <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();
        keyGenerator.processAfter(executor, mappedStatement, ps, parameterObject);
        <span class="hljs-keyword">return</span> rows;
    }
}

<span class="hljs-comment">// 3. CallableStatementHandler - 存储过程策略</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CallableStatementHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseStatementHandler</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();
        <span class="hljs-keyword">if</span> (mappedStatement.getResultSetType() == ResultSetType.FORWARD_ONLY) {
            <span class="hljs-keyword">return</span> connection.prepareCall(sql);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> connection.prepareCall(sql, mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException {
        registerOutputParameters((CallableStatement) statement);
        parameterHandler.setParameters((CallableStatement) statement);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">CallableStatement</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> (CallableStatement) statement;
        cs.execute();
        <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> cs.getUpdateCount();
        <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> boundSql.getParameterObject();
        <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();
        keyGenerator.processAfter(executor, mappedStatement, cs, parameterObject);
        <span class="hljs-keyword">return</span> rows;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span> {

    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">(Transaction transaction, ExecutorType executorType)</span> {
        executorType = executorType == <span class="hljs-literal">null</span> ? defaultExecutorType : executorType;
        Executor executor;
        <span class="hljs-comment">// 根据ExecutorType选择策略</span>
        <span class="hljs-keyword">if</span> (ExecutorType.BATCH == executorType) {
            executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchExecutor</span>(<span class="hljs-built_in">this</span>, transaction);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ExecutorType.REUSE == executorType) {
            executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReuseExecutor</span>(<span class="hljs-built_in">this</span>, transaction);
        } <span class="hljs-keyword">else</span> {
            executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleExecutor</span>(<span class="hljs-built_in">this</span>, transaction);
        }
        <span class="hljs-comment">// 如果启用缓存，装饰为CachingExecutor</span>
        <span class="hljs-keyword">if</span> (cacheEnabled) {
            executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachingExecutor</span>(executor);
        }
        <span class="hljs-keyword">return</span> (Executor) interceptorChain.pluginAll(executor);
    }
}
</code></pre>
<h5 data-id="heading-26">4.2.2 三种Executor策略对比</h5>





























<table><thead><tr><th>Executor类型</th><th>特点</th><th>适用场景</th><th>性能</th></tr></thead><tbody><tr><td>SimpleExecutor</td><td>每次执行创建新Statement</td><td>一般查询、单条操作</td><td>中等</td></tr><tr><td>ReuseExecutor</td><td>重用Statement</td><td>执行相同SQL多次</td><td>较好</td></tr><tr><td>BatchExecutor</td><td>批量执行SQL</td><td>批量插入、更新</td><td>最好</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5b10076079d420eba0a6311735bd43a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768193236&amp;x-signature=EJZd16zKML1l2kjZx2wJqrMQHqY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-27">4.3 策略模式的优势</h4>
<ol>
<li><strong>算法可替换</strong>：可以灵活切换不同的算法实现</li>
<li><strong>代码解耦</strong>：算法的实现与使用分离</li>
<li><strong>扩展方便</strong>：新增策略只需实现新类</li>
<li><strong>简化测试</strong>：可以独立测试每个策略</li>
</ol>
<h4 data-id="heading-28">4.4 策略模式 vs 模板方法模式</h4>






























<table><thead><tr><th>对比项</th><th>策略模式</th><th>模板方法模式</th></tr></thead><tbody><tr><td>算法结构</td><td>可变</td><td>固定</td></tr><tr><td>实现方式</td><td>组合</td><td>继承</td></tr><tr><td>灵活性</td><td>高</td><td>中等</td></tr><tr><td>复杂度</td><td>较高</td><td>较低</td></tr></tbody></table>
<h3 data-id="heading-29">五、设计模式的综合应用</h3>
<p>在MyBatis中，多种设计模式往往协同工作，共同完成复杂的功能。</p>
<h4 data-id="heading-30">5.1 Executor的创建过程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 模板方法模式：BaseExecutor定义执行流程</span>
<span class="hljs-comment">// 2. 策略模式：根据ExecutorType选择SimpleExecutor、ReuseExecutor或BatchExecutor</span>
<span class="hljs-comment">// 3. 装饰器模式：CachingExecutor为Executor添加缓存功能</span>
<span class="hljs-comment">// 4. 代理模式：Plugin为Executor添加拦截功能</span>

<span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> configuration.newExecutor(transaction, ExecutorType.SIMPLE);
</code></pre>
<h4 data-id="heading-31">5.2 Cache的构建过程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 装饰器模式：多层Cache装饰器嵌套</span>
<span class="hljs-comment">// 2. 模板方法模式：BaseExecutor定义查询流程（使用缓存）</span>

<span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheBuilder</span>(<span class="hljs-string">"myCache"</span>)
    .implementation(PerpetualCache.class)
    .addDecorator(LruCache.class)
    .addDecorator(FifoCache.class)
    .addDecorator(ScheduledCache.class)
    .build();
</code></pre>
<h4 data-id="heading-32">5.3 StatementHandler的选择过程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 策略模式：RoutingStatementHandler路由到不同的StatementHandler</span>
<span class="hljs-comment">// 2. 模板方法模式：BaseStatementHandler定义Statement处理流程</span>
<span class="hljs-comment">// 3. 代理模式：LoggerStatementHandler添加日志功能</span>

<span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(executor, ms, parameter, rowBounds, resultHandler, boundSql);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e34a672d2a8418bac9b12e9b9b1d0de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768193236&amp;x-signature=uMXAlSkzzJV5GZrZuBgrz8OkeaA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-33">六、最佳实践与建议</h3>
<h4 data-id="heading-34">6.1 装饰器模式应用场景</h4>
<p>当满足以下条件时，可以考虑使用装饰器模式：</p>
<ol>
<li>需要动态地、透明地给对象添加功能</li>
<li>不希望通过继承来扩展功能（避免类爆炸）</li>
<li>需要组合多个功能</li>
</ol>
<p><strong>应用示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 为服务添加缓存、日志、监控功能</span>
<span class="hljs-type">Service</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingService</span>(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MonitoringService</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachingService</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicService</span>()
        )
    )
);
</code></pre>
<h4 data-id="heading-35">6.2 模板方法模式应用场景</h4>
<p>当满足以下条件时，可以考虑使用模板方法模式：</p>
<ol>
<li>算法的整体结构固定，部分步骤可变</li>
<li>多个子类有共同的行为逻辑</li>
<li>需要控制子类的扩展</li>
</ol>
<p><strong>应用示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractDataService</span> {

    <span class="hljs-comment">// 模板方法：定义数据处理流程</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processData</span><span class="hljs-params">(String data)</span> {
        validate(data);      <span class="hljs-comment">// 验证</span>
        data = transform(data); <span class="hljs-comment">// 转换</span>
        save(data);          <span class="hljs-comment">// 保存</span>
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(String data)</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">transform</span><span class="hljs-params">(String data)</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(String data)</span>;
}
</code></pre>
<h4 data-id="heading-36">6.3 策略模式应用场景</h4>
<p>当满足以下条件时，可以考虑使用策略模式：</p>
<ol>
<li>有多种算法可以相互替换</li>
<li>算法的使用和实现分离</li>
<li>需要在运行时选择算法</li>
</ol>
<p><strong>应用示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 支付策略</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentStrategy</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(<span class="hljs-type">int</span> amount)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCardPayment</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentStrategy</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(<span class="hljs-type">int</span> amount)</span> {
        <span class="hljs-comment">// 信用卡支付逻辑</span>
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeChatPayPayment</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentStrategy</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(<span class="hljs-type">int</span> amount)</span> {
        <span class="hljs-comment">// 微信支付逻辑</span>
    }
}

<span class="hljs-comment">// 上下文</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentContext</span> {
    <span class="hljs-keyword">private</span> PaymentStrategy strategy;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPaymentStrategy</span><span class="hljs-params">(PaymentStrategy strategy)</span> {
        <span class="hljs-built_in">this</span>.strategy = strategy;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processPayment</span><span class="hljs-params">(<span class="hljs-type">int</span> amount)</span> {
        strategy.pay(amount);
    }
}
</code></pre>
<h4 data-id="heading-37">6.4 设计模式选择指南</h4>








































<table><thead><tr><th>场景</th><th>推荐模式</th><th>理由</th></tr></thead><tbody><tr><td>需要动态添加功能</td><td>装饰器模式</td><td>灵活组合，避免继承</td></tr><tr><td>算法结构固定部分可变</td><td>模板方法模式</td><td>代码复用，结构清晰</td></tr><tr><td>算法需要相互替换</td><td>策略模式</td><td>解耦算法和使用</td></tr><tr><td>创建复杂对象</td><td>构建者模式</td><td>分步构建，代码清晰</td></tr><tr><td>创建对象族</td><td>工厂模式</td><td>解耦创建和使用</td></tr><tr><td>控制对象访问</td><td>代理模式</td><td>增强功能，不修改原类</td></tr></tbody></table>
<h4 data-id="heading-38">6.5 避免过度设计</h4>
<p>虽然设计模式很有用，但也要避免过度设计：</p>
<ol>
<li><strong>简单问题简单解决</strong>：不要为了使用模式而使用模式</li>
<li><strong>按需设计</strong>：根据实际需求选择合适的模式</li>
<li><strong>保持简洁</strong>：简单的设计往往比复杂的设计更好</li>
<li><strong>重构时再引入</strong>：先实现功能，重构时再应用模式</li>
</ol>
<h3 data-id="heading-39">七、总结</h3>
<p>本文深入讲解了MyBatis中的装饰器模式、模板方法模式和策略模式，通过源码分析和示例代码，帮助读者理解这些设计模式在实际框架中的应用。</p>
<h4 data-id="heading-40">7.1 关键要点</h4>
<p><strong>装饰器模式：</strong></p>
<ul>
<li>CachingExecutor为Executor添加二级缓存功能</li>
<li>Cache装饰器链提供LRU、FIFO、日志等多种功能</li>
<li>动态组合，灵活扩展</li>
</ul>
<p><strong>模板方法模式：</strong></p>
<ul>
<li>BaseExecutor定义SQL执行的基本流程</li>
<li>BaseTypeHandler定义类型处理的基本流程</li>
<li>代码复用，算法稳定</li>
</ul>
<p><strong>策略模式：</strong></p>
<ul>
<li>RoutingStatementHandler根据配置路由到不同的StatementHandler</li>
<li>不同Executor策略适用于不同的执行场景</li>
<li>算法可替换，代码解耦</li>
</ul>
<h4 data-id="heading-41">7.2 设计模式的价值</h4>
<ol>
<li><strong>提高代码质量</strong>：使代码更易读、易维护、易扩展</li>
<li><strong>促进架构设计</strong>：提供成熟的设计思想和解决方案</li>
<li><strong>增强团队协作</strong>：统一的设计语言和思维方式</li>
<li><strong>提升个人能力</strong>：深入理解设计模式是成为高级工程师的必经之路</li>
</ol>
<p>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《产品经理说“Tool 分组要一条会渐变的彩虹轴，还要能 zoom！”——我 3 步把它拆成 1024 个像素》]]></title>    <link>https://juejin.cn/post/7591544356000169994</link>    <guid>https://juejin.cn/post/7591544356000169994</guid>    <pubDate>2026-01-05T03:03:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591544356000169994" data-draft-id="7591544356000104458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《产品经理说“Tool 分组要一条会渐变的彩虹轴，还要能 zoom！”——我 3 步把它拆成 1024 个像素》"/> <meta itemprop="keywords" content="ECharts,前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-05T03:03:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="啊花是条龙"/> <meta itemprop="url" content="https://juejin.cn/user/4409479418361243"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《产品经理说“Tool 分组要一条会渐变的彩虹轴，还要能 zoom！”——我 3 步把它拆成 1024 个像素》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4409479418361243/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    啊花是条龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T03:03:14.000Z" title="Mon Jan 05 2026 03:03:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>#ECharts #数据可视化 #前端干货 #需求拆解 #线性渐变</p>
<hr/>
<h3 data-id="heading-0">0. 开场 3 连问</h3>
<ol>
<li>为什么 Tool 分组要单独一条轴？<br/>
答：一条轴上混排了几十种 Tool，用户想一眼看出“哪一段属于哪把 Tool”。</li>
<li>为什么非要“渐变色”而不是直接写死颜色？<br/>
答：Tool 顺序、数量、颜色全由后端返回，写死就 GG。</li>
<li>为什么要在彩虹轴上叠加 dataZoom？<br/>
答：彩虹轴 = 导航条，拖动它≈拖动地图的“缩略图”，体验才丝滑。</li>
</ol>
<p>一句话总结：<br/>
<strong>把“Tool 名”→“颜色”→“渐变”→“可拖动”全自动化，让用户 0 配置就能彩虹导航。</strong></p>
<h3 data-id="heading-1">1. 先改数据结构，让“颜色”和“数据”同频共振</h3>
<p>老结构的问题：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">xAxis</span>: [<span class="hljs-string">'T1'</span>, <span class="hljs-string">'T2'</span>, <span class="hljs-string">'T3'</span> ...]        <span class="hljs-comment">// 只存名字</span>
<span class="hljs-attr">series</span>: [{<span class="hljs-attr">name</span>: <span class="hljs-string">'T1'</span>, <span class="hljs-attr">data</span>: [...]}, ...] <span class="hljs-comment">// 颜色靠索引去 externalColors 里硬匹配</span>
</code></pre>
<p>新结构（加 2 个字段即可）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">sitexAxis</span>: [<span class="hljs-string">'T1'</span>, <span class="hljs-string">'T1'</span>, <span class="hljs-string">'T2'</span>, <span class="hljs-string">'T3'</span>, <span class="hljs-string">'T3'</span>, <span class="hljs-string">'T3'</span>] <span class="hljs-comment">// 每个数据点对应的真实 Tool</span>
<span class="hljs-attr">colors</span>:   [<span class="hljs-string">'#FF6B6B'</span>,<span class="hljs-string">'#FF6B6B'</span>,<span class="hljs-string">'#4ECDC4'</span>,<span class="hljs-string">'#45B7D1'</span>,<span class="hljs-string">'#45B7D1'</span>,<span class="hljs-string">'#45B7D1'</span>] <span class="hljs-comment">// 一一对应</span>
</code></pre>
<p>生成逻辑 3 行代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> colors = [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(sitexAxis)].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">code</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> idx = filterSites.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-property">value</span> === code);
  <span class="hljs-keyword">return</span> idx &gt;= <span class="hljs-number">0</span> ? externalColors[idx] : <span class="hljs-string">'#ccc'</span>;
});
</code></pre>
<p><strong>好处</strong></p>
<ul>
<li>后端顺序随意变，前端不崩。</li>
<li>颜色数组直接丢给 <code>makeAxisColor</code> 做渐变，无需二次查找。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 彩虹轴 = 线性渐变 + 分段色标</h3>
<p>ECharts 的 <code>axisLine.lineStyle.color</code> 只认<strong>相对位置</strong>的色标，格式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> echarts.<span class="hljs-property">graphic</span>.<span class="hljs-title class_">LinearGradient</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, [
  {<span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,   <span class="hljs-attr">color</span>: <span class="hljs-string">'#FF6B6B'</span>},
  {<span class="hljs-attr">offset</span>: <span class="hljs-number">0.3</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#FF6B6B'</span>},
  {<span class="hljs-attr">offset</span>: <span class="hljs-number">0.3</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#4ECDC4'</span>},
  {<span class="hljs-attr">offset</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#4ECDC4'</span>},
  ...
])
</code></pre>
<p>算法一句话：<br/>
<strong>“相同 Tool 连续段” = 一个色块，头尾各插 2 个色标，offset = 索引 / 总长。</strong></p>
<p>代码 20 行不到：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">makeAxisColor</span>(<span class="hljs-params">data, externalColors</span>) {
  <span class="hljs-keyword">const</span> total = data.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">const</span> colorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">let</span> colorIdx = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> stops = [];
  <span class="hljs-keyword">let</span> startIdx = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">while</span> (startIdx &lt; total) {
    <span class="hljs-keyword">const</span> value = data[startIdx];
    <span class="hljs-keyword">if</span> (!colorMap.<span class="hljs-title function_">has</span>(value)) {
      colorMap.<span class="hljs-title function_">set</span>(value, externalColors[colorIdx++ % externalColors.<span class="hljs-property">length</span>]);
    }
    <span class="hljs-keyword">const</span> color = colorMap.<span class="hljs-title function_">get</span>(value);
    <span class="hljs-keyword">const</span> endIdx = data.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">v, i</span>) =&gt;</span> i &gt; startIdx &amp;&amp; v !== value);
    <span class="hljs-keyword">const</span> realEnd = endIdx === -<span class="hljs-number">1</span> ? total : endIdx;
    stops.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">offset</span>: startIdx / total, color });
    stops.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">offset</span>: realEnd / total, color });
    startIdx = realEnd;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> echarts.<span class="hljs-property">graphic</span>.<span class="hljs-title class_">LinearGradient</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, stops);
}
</code></pre>
<p><strong>自测技巧</strong><br/>
console.log(stops) 可以看到每段颜色起止，copy 到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcolorgradient.dev" target="_blank" title="https://colorgradient.dev" ref="nofollow noopener noreferrer">colorgradient.dev</a> 一眼验证对不对。</p>
<hr/>
<h3 data-id="heading-3">3. 叠加 dataZoom 的 2 个坑</h3>
<p>坑 1：彩虹轴是<strong>第三条 xAxis</strong>，<code>xAxisIndex</code> 必须对应。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">dataZoom</span>: [
  {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'slider'</span>,
    <span class="hljs-attr">xAxisIndex</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>],   <span class="hljs-comment">// 主轴 + 占位轴</span>
    ...
  },
  {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'inside'</span>,
    <span class="hljs-attr">xAxisIndex</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>],
    ...
  }
]
</code></pre>
<p>坑 2：彩虹轴本身不要响应拖动，把它当“导航条”而非“控制条”。<br/>
解决：</p>
<ul>
<li>彩虹轴 <code>axisLabel.interval = 0</code> 强制全显，</li>
<li>dataZoom 的 <code>xAxisIndex</code> <strong>不包含</strong>彩虹轴索引（这里是 2），</li>
<li>这样拖动时彩虹轴不会被裁剪，仅作视觉参考。</li>
</ul>
<hr/>
<h3 data-id="heading-4">4. 最终 10 行伪代码，把 3 步串成 pipeline</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 生成 sitexAxis &amp; colors</span>
<span class="hljs-keyword">const</span> sitexAxis = [];
<span class="hljs-keyword">const</span> colors = [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(sitexAxis)].<span class="hljs-title function_">map</span>(...);

<span class="hljs-comment">// 2. 生成渐变</span>
<span class="hljs-keyword">const</span> axisColor = <span class="hljs-title function_">makeAxisColor</span>(sitexAxis, colors);

<span class="hljs-comment">// 3. 配置第三条轴 + dataZoom</span>
<span class="hljs-keyword">const</span> chartOptions = {
  <span class="hljs-attr">xAxis</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'category'</span>, <span class="hljs-attr">data</span>: mainX },        <span class="hljs-comment">// 主轴</span>
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'category'</span>, <span class="hljs-attr">data</span>: mainX, <span class="hljs-attr">show</span>: <span class="hljs-literal">false</span> }, <span class="hljs-comment">// 占位</span>
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'category'</span>, <span class="hljs-attr">data</span>: sitexAxis, <span class="hljs-attr">position</span>: <span class="hljs-string">'bottom'</span>, <span class="hljs-attr">offset</span>: <span class="hljs-number">40</span>,
      <span class="hljs-attr">axisLine</span>: { <span class="hljs-attr">lineStyle</span>: { <span class="hljs-attr">color</span>: axisColor, <span class="hljs-attr">width</span>: <span class="hljs-number">16</span> } },
      <span class="hljs-attr">axisLabel</span>: { <span class="hljs-attr">interval</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>, <span class="hljs-attr">fontWeight</span>: <span class="hljs-number">600</span>,
        <span class="hljs-attr">formatter</span>: <span class="hljs-function">(<span class="hljs-params">v, i</span>) =&gt;</span> i === <span class="hljs-number">0</span> || sitexAxis[i] !== sitexAxis[i-<span class="hljs-number">1</span>] ? v : <span class="hljs-string">''</span> }
    }
  ],
  <span class="hljs-attr">dataZoom</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'slider'</span>, <span class="hljs-attr">xAxisIndex</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>], <span class="hljs-attr">bottom</span>: <span class="hljs-number">23</span>, <span class="hljs-attr">brushSelect</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'inside'</span>, <span class="hljs-attr">xAxisIndex</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>] }
  ]
};
</code></pre>
<hr/>
<h3 data-id="heading-5">5. 上线效果</h3>
<ul>
<li>20 把 Tool，彩虹导航条 1 秒生成。</li>
<li>拖动底部 zoom，彩虹段实时跟随，0 额外配置。</li>
<li>测试小姐姐说“像网易云的歌词渐变条，好酷”。</li>
</ul>
<hr/>
<h2 data-id="heading-6"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5be11fa2460f420db1073ac0697f93a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZWK6Iqx5piv5p2h6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768186994&amp;x-signature=wm%2BIimWqKR2pZ3dpoFLTMjYo5sY%3D" alt="image.png" loading="lazy"/></h2>
<h3 data-id="heading-7">6. 小结口诀</h3>
<p><strong>“数据先对齐，颜色再映射，渐变算断点，zoom 别绑错。”</strong><br/>
背下来，下次再遇到“彩虹轴 + 可拖动”需求，直接复制粘贴，提前下班去撸串。</p>
<p>（完）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员应该熟悉的概念(8)嵌入和语义检索]]></title>    <link>https://juejin.cn/post/7591375103520456744</link>    <guid>https://juejin.cn/post/7591375103520456744</guid>    <pubDate>2026-01-05T02:39:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591375103520456744" data-draft-id="7591382440582217768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员应该熟悉的概念(8)嵌入和语义检索"/> <meta itemprop="keywords" content="人工智能,算法"/> <meta itemprop="datePublished" content="2026-01-05T02:39:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘立军"/> <meta itemprop="url" content="https://juejin.cn/user/2830599308981642"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员应该熟悉的概念(8)嵌入和语义检索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2830599308981642/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘立军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T02:39:06.000Z" title="Mon Jan 05 2026 02:39:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>语义检索</strong>是指系统能够理解用户查询的深层含义（语义），而不仅仅是匹配字面关键词。它通过分析上下文、同义词、相关概念等，查找与查询意图最相关的信息，即使文档中没有完全相同的词语。</p>
<p><strong>与关键词检索的区别：</strong></p>
<ul>
<li><strong>关键词检索</strong>：基于字面匹配，查找包含用户输入的特定词语的文档。它不理解词语的含义，因此可能遗漏意思相关但用词不同的内容，或返回用词相同但意思不符的结果。</li>
<li><strong>语义检索</strong>：基于意义匹配，理解查询和文档的“意思”。它能找到表达方式不同但含义相近的内容，返回更符合用户真实意图的结果。</li>
</ul>
<p><strong>简单来说</strong>：关键词检索是“找词”，语义检索是“懂意”。<br/>
例如：如果用关键词检索“苹果”，那么可能找到我们吃的苹果以及苹果公司的相关信息；而语义检索会考虑检索内容的上下文，它能断定这个苹果是“苹果公司”，所以只会检索“苹果公司”的相关内容出来。</p>
<hr/>

<h2 data-id="heading-0">计算机是如何理解语义的</h2>
<p>计算机本身并不像人类一样真正“理解”语义，而是通过复杂的数学和统计模型来<strong>模拟</strong>对语言含义的理解。其核心方法是将文字转化为计算机可以处理的<strong>数值向量（Vector）</strong>，并让这些向量能够捕捉词语、句子或文档的语义信息。这个过程称作<strong>嵌入(Embedding)</strong>。</p>
<p>主要实现方式包括：</p>
<hr/>
<ol>
<li>
<p><strong>词嵌入 (Word Embedding)</strong>：</p>
<ul>
<li>
<p>将词语表示为高维空间中的向量。</p>
</li>
<li>
<p>核心思想是“<strong>分布假设</strong>”：上下文相似的词，其含义也相似。</p>
</li>
</ul>
<blockquote>
<p>例如，<code>word2vec</code>、<code>GloVe</code> 等模型训练后，<code>国王 - 男人 + 女人 ≈ 女王</code> 这样的向量运算成为可能，说明向量捕捉到了语义关系。</p>
</blockquote>
</li>
<li>
<p><strong>上下文化词嵌入 (Contextual Embedding)</strong>：</p>
<ul>
<li>
<p>早期词嵌入为每个词分配一个固定向量，无法处理一词多义。</p>
</li>
<li>
<p>现代模型（如 <code>BERT</code>、<code>RoBERTa</code>）使用深度神经网络（尤其是Transformer架构），根据词语在<strong>具体句子中的上下文</strong>来生成其向量表示。</p>
</li>
</ul>
<blockquote>
<p>例如，“苹果很好吃”和“苹果发布了新手机”中的“苹果”，会被编码成不同的向量，从而区分水果和公司。</p>
</blockquote>
</li>
<li>
<p><strong>句子/段落/文档编码</strong>：</p>
<ul>
<li>模型不仅能编码单个词，还能将整个句子、段落或文档编码成一个向量。</li>
<li>这个向量旨在代表其整体含义。语义相似的句子，其向量在向量空间中的距离会很近。</li>
</ul>
</li>
<li>
<p><strong>向量相似度计算</strong>：</p>
<ul>
<li>在语义检索中，用户的查询和数据库中的文档都被编码成向量。</li>
<li>计算机通过计算向量间的<strong>相似度</strong>（如余弦相似度）来判断语义的接近程度。</li>
<li>返回与查询向量最相似的文档向量所对应的文档。</li>
</ul>
</li>
</ol>
<p><strong>总结</strong>：计算机通过机器学习模型，将语言转化为高维向量，并让这些向量的<strong>空间关系</strong>反映语言的<strong>语义关系</strong>。它不是“理解”，而是通过海量数据训练出的模式识别能力，来预测和匹配语言的含义。</p>
<hr/>
<h2 data-id="heading-1">关于维度</h2>
<p>上面提到了<strong>高维</strong>一词，也就是<strong>高维度</strong>的意思，那么什么是<strong>维度</strong>呢？</p>
<p>在计算机（尤其是数据处理、机器学习和数学计算）中，<strong>维度</strong>（Dimension）指的是描述一个数据点所需<strong>独立特征或变量的数量</strong>。它定义了数据存在于一个多少维的“空间”中。</p>
<p>可以将维度想象成描述某件事物所需的“方面”或“属性”的个数。</p>
<hr/>
<h3 data-id="heading-2">核心概念</h3>
<ul>
<li><strong>一维</strong>：像一条直线，只需要一个数值来定位一个点（如：数轴上的位置）。</li>
<li><strong>二维</strong>：像一个平面，需要两个数值来定位一个点（如：地图上的经度和纬度）。</li>
<li><strong>三维</strong>：像我们生活的空间，需要三个数值来定位一个点（如：长、宽、高）。</li>
<li><strong>高维</strong>：超过三维的空间，在数学和计算机中很常见，用于表示包含多个特征的复杂数据。</li>
</ul>
<h3 data-id="heading-3">例子说明</h3>
<ol>
<li>
<p><strong>向量 (Vector)</strong>：</p>
<ul>
<li><code>[3]</code> 是一个<strong>一维</strong>向量，只包含一个数值。</li>
<li><code>[2, 5]</code> 是一个<strong>二维</strong>向量，可以表示平面上的一个点 (x=2, y=5)。</li>
<li><code>[1, 3, 8]</code> 是一个<strong>三维</strong>向量，可以表示空间中的一个点 (x=1, y=3, z=8)。</li>
<li><code>[身高, 体重, 年龄, 收入]</code> 是一个<strong>四维</strong>向量，用来描述一个人的四个不同特征。</li>
</ul>
</li>
<li>
<p><strong>图像数据</strong>：</p>
<ul>
<li>一张 28x28 像素的黑白图片，可以看作是一个 <strong>784 维</strong>的数据点（28 x 28 = 784 个像素值）。</li>
<li>一张 28x28 像素的彩色图片，通常有红、绿、蓝三个通道，因此是 <strong>2352 维</strong>（28 x 28 x 3 = 2352 个颜色值）。</li>
</ul>
</li>
<li>
<p><strong>机器学习中的特征</strong>：</p>
<ul>
<li>在预测房价的模型中，如果使用“面积”、“房间数”、“地段评分”三个特征来描述一套房子，那么每套房子的数据就是一个<strong>三维</strong>向量。</li>
<li>如果增加“房龄”、“是否学区”等更多特征，维度就会相应增加。一个包含100个不同特征的用户画像数据，就是一个<strong>百维</strong>向量。</li>
</ul>
</li>
<li>
<p><strong>张量 (Tensor)</strong>：</p>
<ul>
<li>在深度学习中，数据常以张量形式存在。一个二维数组（矩阵）是二维张量，一个三维数组（如一批彩色图片）是三维张量，以此类推。这里的“维数”也指张量的轴数。</li>
</ul>
</li>
</ol>
<p><strong>总结</strong>：维度是描述数据复杂性和特征数量的关键概念。维度越高，数据能包含的信息越丰富，但也可能带来“维度灾难”（计算复杂、数据稀疏等问题），需要特殊技术处理。</p>
<hr/>
<h2 data-id="heading-4">实现嵌入（Embedding，即：将文本转换成 向量/矢量）的方式</h2>
<p>我们可以把<strong>文本矢量/向量化</strong>（Text Vectorization）方法分为 <strong>三大类：基于统计的方法、基于预测的方法、以及基于上下文的大模型嵌入方法</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d72b47f080145fe81ab95d5ef54d261~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YiY56uL5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768185546&amp;x-signature=znu9ELi2U13HvlO9LuKlXXNDkNk%3D" alt="text-vectorization.png" loading="lazy"/></p>
<p>下面是详细解释：</p>
<hr/>
<h3 data-id="heading-5">一、基于统计的方法（传统方法）</h3>
<p>这些方法主要依靠<strong>词频统计</strong>和<strong>共现关系</strong>来表示文本，没有真正理解语义。</p>
<h4 data-id="heading-6">1. 独热编码（One-Hot Encoding）</h4>
<p><strong>原理：</strong></p>
<ul>
<li>给每个词分配一个唯一编号。</li>
<li>用一个全零的向量，只有该编号位置为1。</li>
</ul>
<p>例如：
词表 = {猫, 狗, 鱼}  ，  “狗” → <code>[0, 1, 0]</code></p>
<p><strong>特点：</strong></p>
<ul>
<li>简单直观，但向量维度高。</li>
<li>不同词之间没有语义关系（“猫”和“狗”的相似度=0）。</li>
</ul>
<hr/>
<h4 data-id="heading-7">2. 词袋模型(BoW，Bag of Words)</h4>
<p><strong>原理：</strong></p>
<ul>
<li>统计每个词在文本中出现的次数。</li>
<li>忽略词序和上下文，只保留频率。
例如：“我 爱 自然语言处理”
→ <code>[我:1, 爱:1, 自然:1, 语言:1, 处理:1]</code></li>
</ul>
<p><strong>特点：</strong></p>
<ul>
<li>易实现，但丢失语序信息。</li>
<li>不同长度文本可转化为同维度向量。</li>
</ul>
<hr/>
<h4 data-id="heading-8">3. TF-IDF（词频–逆文档频率）</h4>
<p><strong>原理：</strong></p>
<ul>
<li>
<p>在BoW基础上增加<strong>权重</strong>：</p>
<ul>
<li><strong>TF</strong>：词在当前文档的出现频率。</li>
<li><strong>IDF</strong>：词在整个语料中出现的稀有度。</li>
</ul>
</li>
</ul>
<p>公式：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>TF-IDF</mtext><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>d</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>TF</mtext><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>d</mi><mo stretchy="false">)</mo><mo>×</mo><mi>log</mi><mo>⁡</mo><mfrac><mi>N</mi><msub><mi>n</mi><mi>t</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\text{TF-IDF}(t, d) = \text{TF}(t, d) \times \log \frac{N}{n_t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">TF-IDF</span></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">TF</span></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.1963em;vertical-align:-0.836em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>其中 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span>) 是文档总数，(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">n_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 是包含词 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span>) 的文档数。</p>
<p><strong>特点：</strong></p>
<ul>
<li>能弱化“的、是”等高频无意义词。</li>
<li>表示仍是稀疏高维向量。</li>
</ul>
<hr/>
<h3 data-id="heading-9">二、基于预测的方法（词向量）</h3>
<p>从统计走向“<strong>语义表示</strong>”，用<strong>神经网络训练</strong>词与词的语义关系。</p>
<h4 data-id="heading-10">4. Word2Vec（Mikolov等人，2013）</h4>
<p><strong>原理：</strong></p>
<ul>
<li>
<p>通过预测任务学习词向量。</p>
</li>
<li>
<p>两种模型：</p>
<ul>
<li><strong>CBOW（连续词袋模型）</strong>：根据上下文预测目标词。</li>
<li><strong>Skip-gram</strong>：根据目标词预测上下文。</li>
</ul>
</li>
<li>
<p>相似语义的词，其向量在空间中接近。
（例如：<code>vector("国王") - vector("男人") + vector("女人") ≈ vector("王后")</code>）</p>
</li>
</ul>
<p><strong>特点：</strong></p>
<ul>
<li>低维（100~300维）、稠密、可捕捉语义关系。</li>
<li>不同上下文中同一个词向量相同（无上下文感知）。</li>
</ul>
<hr/>
<h4 data-id="heading-11">5. GloVe（Global Vectors for Word Representation）</h4>
<p><strong>原理：</strong></p>
<ul>
<li>综合<strong>全局共现统计</strong>和<strong>局部预测能力</strong>。</li>
<li>基于词共现矩阵的加权最小二乘优化。</li>
</ul>
<p><strong>特点：</strong></p>
<ul>
<li>与Word2Vec效果类似，但从统计角度出发。</li>
<li>同样为静态词向量。</li>
</ul>
<hr/>
<h3 data-id="heading-12">三、基于上下文的大模型嵌入方法（动态表示）</h3>
<p>这些方法利用<strong>深度语言模型（Transformer）</strong>，能根据上下文动态生成词或句子向量。</p>
<h4 data-id="heading-13">6. ELMo（Embeddings from Language Models,2018）</h4>
<p><strong>原理：</strong></p>
<ul>
<li>双向LSTM模型。</li>
<li>同一个词在不同上下文中会得到不同向量。</li>
<li>例如“bank”在“river bank”和“central bank”中向量不同。</li>
</ul>
<hr/>
<h4 data-id="heading-14">7. BERT（Bidirectional Encoder Representations from Transformers,2019）</h4>
<p><strong>原理：</strong></p>
<ul>
<li>
<p>基于Transformer的双向编码模型。</p>
</li>
<li>
<p>通过Masked Language Model（掩码预测）学习深层语义。</p>
</li>
<li>
<p>可输出：</p>
<ul>
<li>词级向量</li>
<li>句级向量</li>
</ul>
</li>
</ul>
<p><strong>特点：</strong></p>
<ul>
<li>语义理解强。</li>
<li>支持句子、段落、文档级向量化。</li>
<li>有衍生模型：RoBERTa、E5、SimCSE、ERNIE、MacBERT、<strong>BGE</strong>、Qwen-embedding等。</li>
</ul>
<hr/>
<h4 data-id="heading-15">8. Sentence Embedding（句向量模型）</h4>
<p><strong>原理：</strong></p>
<ul>
<li>在BERT基础上，通过对比学习优化句向量相似度。</li>
<li>相似句子 → 向量距离小。</li>
</ul>
<p><strong>代表模型：</strong></p>
<ul>
<li>Sentence-BERT（SBERT）</li>
<li>SimCSE</li>
<li>E5</li>
<li><strong>BGE</strong>、M3E、GTE等中文优化模型。</li>
</ul>
<p><strong>应用：</strong></p>
<ul>
<li>语义检索（Semantic Search）</li>
<li>问答匹配</li>
<li>RAG知识检索</li>
</ul>
<hr/>
<h3 data-id="heading-16">四、总结对比</h3>





















































<table><thead><tr><th>方法类别</th><th>代表模型</th><th>是否理解语义</th><th>向量维度</th><th>稀疏/稠密</th><th>是否上下文相关</th></tr></thead><tbody><tr><td>One-hot</td><td>-</td><td>否</td><td>高</td><td>稀疏</td><td>否</td></tr><tr><td>BoW / TF-IDF</td><td>sklearn</td><td>否</td><td>高</td><td>稀疏</td><td>否</td></tr><tr><td>Word2Vec / GloVe</td><td>gensim</td><td>是（静态）</td><td>100~300</td><td>稠密</td><td>否</td></tr><tr><td>ELMo</td><td>-</td><td>是</td><td>1024</td><td>稠密</td><td>是</td></tr><tr><td>BERT / RoBERTa / SimCSE / BGE</td><td>transformers</td><td>是</td><td>768~1024</td><td>稠密</td><td>是</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">小结</h3>
<ul>
<li><strong>传统统计法（BoW / TF-IDF）</strong>：只看词频，不懂语义。</li>
<li><strong>词向量（Word2Vec / GloVe）</strong>：理解语义，但忽略上下文。</li>
<li><strong>上下文嵌入（BERT / SimCSE / BGE）</strong>：深度语义理解、动态语境感知，是当前主流。</li>
</ul>
<p><strong>基于上下文的大模型嵌入方法</strong> 既能深度理解语义，还能动态感知关联上下文，最强大！</p>
<h2 data-id="heading-18">如何训练用于嵌入的模型</h2>
<p>显然，同一个词在不同的上下文中的含义可能不同，<strong>Transformer</strong>能够让同一个词在不同的上下文语境中得到不同向量。下面简单介绍一下基于<strong>Transformer</strong>的几种将文本转换为向量的几种模型：<strong>BERT / SimCSE / BGE</strong>的训练过程和基本原理。</p>
<hr/>
<h3 data-id="heading-19">一、核心目标</h3>
<p>这些模型的共同目标是：
<strong>把语义相似的文本映射到相近的向量空间中。</strong>
也就是说，经过矢量化后：</p>
<ul>
<li>“公司法规定的责任” 和 “公司法的责任条款” → 向量距离接近</li>
<li>“公司注册流程” 和 “股东权利义务” → 向量距离较远</li>
</ul>
<hr/>
<h3 data-id="heading-20">二、BERT 的训练过程（基础模型）</h3>
<p><strong>BERT</strong>（Bidirectional Encoder Representations from Transformers）是上下文嵌入的基础。</p>
<h4 data-id="heading-21">训练目标：</h4>
<h5 data-id="heading-22">1. <strong>Masked Language Modeling (MLM)</strong></h5>
<ul>
<li>
<p>随机遮盖句子中15%的词。</p>
</li>
<li>
<p>让模型预测被遮盖的词。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">输入: 我今天[MASK]很开心  </span>
<span class="hljs-section">输出: 吃 → 概率最高  </span>
</code></pre>
</li>
</ul>
<h5 data-id="heading-23">2. <strong>Next Sentence Prediction (NSP)</strong></h5>
<ul>
<li>
<p>给定两句话，让模型判断第二句是否是第一句的下文。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">句子A: 我去商店买水果  </span>
<span class="hljs-section">句子B: 然后我买了一个苹果   ✅</span>
<span class="hljs-section">句子B': 今天阳光很好         ❌</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-24">训练方式：</h4>
<ul>
<li>大规模无监督语料（Wikipedia、书籍等）</li>
<li>优化目标是最小化 MLM + NSP 的交叉熵损失</li>
</ul>
<h4 data-id="heading-25">结果：</h4>
<p>获得词或句子的“上下文感知”表示（Contextual Embedding）</p>
<blockquote>
<p>但原始BERT不直接适合句子相似度计算，因为句向量分布不稳定。</p>
</blockquote>
<hr/>
<h3 data-id="heading-26">三、SimCSE 的训练过程（句向量模型）</h3>
<p><strong>SimCSE</strong>（Simple Contrastive Sentence Embedding）是在BERT的基础上，用**对比学习（Contrastive Learning）**优化句子向量。</p>
<h4 data-id="heading-27">思想：</h4>
<ul>
<li>让语义相近的句子向量靠近，不同句子向量远离。</li>
</ul>
<h4 data-id="heading-28">训练方法：</h4>
<h5 data-id="heading-29">(1) 无监督 SimCSE</h5>
<ul>
<li>
<p>用 BERT 对同一句子做两次 dropout，得到两个不同表示。</p>
</li>
<li>
<p>视作「正样本对」，其他句子是「负样本」。</p>
<pre><code class="hljs language-arduino" lang="arduino">句子: <span class="hljs-string">"公司法的最新修订"</span>
dropout1 → 向量 v1  
dropout2 → 向量 v2  
</code></pre>
</li>
<li>
<p>目标：最大化 v1 与 v2 的相似度，最小化与其他句子的相似度。</p>
</li>
<li>
<p>损失函数：<strong>InfoNCE 对比损失</strong></p>
</li>
</ul>
<h5 data-id="heading-30">(2) 有监督 SimCSE</h5>
<ul>
<li>使用自然语言推理（NLI）数据集（如 entailment / contradiction）。</li>
<li>相似句（entailment）→ 正样本</li>
<li>不相似句（contradiction）→ 负样本</li>
</ul>
<hr/>
<h3 data-id="heading-31">四、BGE 的训练过程（现代中文向量模型）</h3>
<p><strong>BGE（BAAI General Embedding）</strong> 是面向中文和多语言优化的最新一代句向量模型，改进自 SimCSE 思路。</p>
<h4 data-id="heading-32">核心特征：</h4>
<ul>
<li>
<p>采用更大规模数据集（对话、问答、百科、网页）。</p>
</li>
<li>
<p>采用<strong>多任务学习</strong>：</p>
<ul>
<li>语义相似度任务</li>
<li>检索任务（query–document）</li>
<li>对比学习任务（positive/negative pairs）</li>
</ul>
</li>
<li>
<p>优化损失函数：</p>
<ul>
<li>InfoNCE + Margin Ranking Loss 混合</li>
</ul>
</li>
</ul>
<h4 data-id="heading-33">训练方式：</h4>
<ol>
<li>
<p>构建 (query, positive_doc, negative_doc) 三元组</p>
</li>
<li>
<p>通过 Transformer 编码每个文本为向量</p>
</li>
<li>
<p>优化目标：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Loss</mtext><mo>=</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mfrac><msup><mi>e</mi><mrow><mtext>sim</mtext><mo stretchy="false">(</mo><mi>q</mi><mo separator="true">,</mo><msup><mi>d</mi><mo>+</mo></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>τ</mi></mrow></msup><mrow><msup><mi>e</mi><mrow><mtext>sim</mtext><mo stretchy="false">(</mo><mi>q</mi><mo separator="true">,</mo><msup><mi>d</mi><mo>+</mo></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>τ</mi></mrow></msup><mo>+</mo><mo>∑</mo><msup><mi>e</mi><mrow><mtext>sim</mtext><mo stretchy="false">(</mo><mi>q</mi><mo separator="true">,</mo><msup><mi>d</mi><mo>−</mo></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>τ</mi></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{Loss} = -\log \frac{e^{\text{sim}(q, d^+) / \tau}}{e^{\text{sim}(q, d^+) / \tau} + \sum e^{\text{sim}(q, d^-) / \tau}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord text"><span class="mord">Loss</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.5874em;vertical-align:-0.954em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6334em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">sim</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7027em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mbin mtight">+</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">sim</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7027em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mbin mtight">−</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9564em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">sim</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8477em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mbin mtight">+</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.954em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>其中：</p>
<ul>
<li>( <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>sim</mtext></mrow><annotation encoding="application/x-tex">\text{sim}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em;"/><span class="mord text"><span class="mord">sim</span></span></span></span></span></span> )：向量余弦相似度</li>
<li>( <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span></span> )：温度参数</li>
</ul>
</li>
</ol>
<h4 data-id="heading-34">效果：</h4>
<ul>
<li>句子相似度更稳定。</li>
<li>支持跨域检索（法律、问答、文档匹配）。</li>
<li>常用于 RAG、知识问答、语义搜索。</li>
</ul>
<hr/>
<h3 data-id="heading-35">五、三者关系总结</h3>

































<table><thead><tr><th>模型</th><th>训练方式</th><th>语料类型</th><th>是否有监督</th><th>主要用途</th></tr></thead><tbody><tr><td><strong>BERT</strong></td><td>MLM + NSP</td><td>大规模文本</td><td>无监督</td><td>通用语言理解</td></tr><tr><td><strong>SimCSE</strong></td><td>对比学习 (dropout 或 NLI)</td><td>句对数据</td><td>无/有监督</td><td>句向量相似度</td></tr><tr><td><strong>BGE</strong></td><td>多任务对比学习</td><td>QA / 检索数据</td><td>有监督</td><td>中文检索 / RAG嵌入</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-36">总结</h2>
<p>通过<strong>训练</strong>好的模型，计算机可以把文本转换成高维向量，这些高维向量代表文本的<strong>语义</strong>，这个过程也称作<strong>嵌入</strong>（Embedding），语义检索让机器<strong>按意思找内容</strong>。</p>
<p>🪐感谢观看，祝好运🪐</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别 WHERE id=1！大数据工程师的 AI 觉醒：手把手带你拆解向量数据库 (RAG 核心)]]></title>    <link>https://juejin.cn/post/7591508100663672883</link>    <guid>https://juejin.cn/post/7591508100663672883</guid>    <pubDate>2026-01-05T02:58:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591508100663672883" data-draft-id="7591544356000071690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别 WHERE id=1！大数据工程师的 AI 觉醒：手把手带你拆解向量数据库 (RAG 核心)"/> <meta itemprop="keywords" content="大数据,数据库"/> <meta itemprop="datePublished" content="2026-01-05T02:58:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一直在追"/> <meta itemprop="url" content="https://juejin.cn/user/239028506736411"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别 WHERE id=1！大数据工程师的 AI 觉醒：手把手带你拆解向量数据库 (RAG 核心)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/239028506736411/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一直在追
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T02:58:23.000Z" title="Mon Jan 05 2026 02:58:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>💡 本文价值提示</strong>：
欢迎回到我们的 <strong>“大数据工程师转型 AI 架构师”</strong> 系列专题！
在搞定了 <strong>Python 高级工程化</strong> 和 <strong>大模型基础理论</strong> 之后，今天我们正式开启第三个重磅专题——<strong>RAG 架构与数据工程之向量数据库</strong>。</p>
<p>对于大数据老兵来说，数据库是我们的“后花园”。但 AI 时代的数据库（Vector DB）彻底颠覆了我们熟悉的 SQL 逻辑。本文将带你从<strong>底层思维</strong>上完成从“精确匹配”到“语义模糊匹配”的跨越，并用最轻量级的代码跑通你的第一个 RAG 闭环。这不仅是技术的升级，更是架构认知的重构。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">01 引言：当 SQL 遇到“灵魂拷问” 🤯</h2>
<p>作为一名在大数据领域摸爬滚打多年的工程师，你一定对这样的 SQL 语句烂熟于心：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> category <span class="hljs-operator">=</span> <span class="hljs-string">'electronics'</span> <span class="hljs-keyword">AND</span> price <span class="hljs-operator">&lt;</span> <span class="hljs-number">5000</span>;
</code></pre>
<p>这是一种<strong>精确匹配（Exact Match）</strong>。数据库像一个一丝不苟的图书管理员，你给它一个 ISBN 号，它给你一本书。如果 ISBN 错了一位，它就冷冰冰地告诉你：<code>0 rows returned</code>。</p>
<p>但在 AI 的世界里，用户的问题往往是模糊的、充满“灵魂”的。比如用户问：</p>
<blockquote>
<p><strong>“有没有那种适合打游戏、散热好，而且不太贵的手机？”</strong></p>
</blockquote>
<p>如果你试图用 SQL 的 <code>LIKE</code> 语句去匹配“散热好”、“不太贵”，那你大概率会疯掉。因为数据库里存的是“骁龙8 Gen 2”、“VC液冷”、“4999元”，根本没有“不太贵”这个字段。</p>
<p>这时候，<strong>向量数据库（Vector Database）</strong> 就登场了。它不再比较“字面是否一样”，而是比较“<strong>意思是否相近</strong>”。</p>
<p>今天，我们就来揭开这个 AI 时代“新基建”的神秘面纱，完成从大数据工程师到 AI 数据架构师的第一步蜕变。</p>
<hr/>
<h2 data-id="heading-1">02 核心思维转变：从 KV 到 Embedding 🧠</h2>
<p>要理解向量数据库，首先要理解它的原子单位——<strong>Embedding（嵌入）</strong>。</p>
<h3 data-id="heading-2">什么是 Embedding？</h3>
<p>想象一下，我们把世界上所有的词语都扔进一个巨大的、多维的坐标系里。</p>
<ul>
<li><strong>“苹果”</strong> 和 <strong>“香蕉”</strong> 都是水果，它们在坐标系里的距离应该很近。</li>
<li><strong>“苹果”</strong> 和 <strong>“iPhone”</strong> 虽然字一样，但在语义空间里，一个在“食物区”，一个在“电子产品区”，距离应该很远。</li>
</ul>
<p><strong>Embedding 就是把文本变成一串数字（向量），这串数字代表了它在这个高维空间里的坐标。</strong></p>
<blockquote>
<p>🧪 <strong>大数据视角映射</strong>：
以前做用户画像（User Profile）时，我们会给用户打标签：<code>[男, 25-30岁, 喜欢运动]</code>。这其实就是一种低维的、稀疏的向量。
而现在的 Embedding（如 OpenAI 的 <code>text-embedding-3-small</code>），是一个 <strong>1536 维</strong> 的稠密向量。它捕捉的特征比我们手动打的标签要丰富亿万倍。</p>
</blockquote>
<h3 data-id="heading-3">核心差异对比表</h3>






























<table><thead><tr><th align="left">特性</th><th align="left">传统数据库 (MySQL/HBase)</th><th align="left">向量数据库 (Milvus/Chroma)</th></tr></thead><tbody><tr><td align="left"><strong>查询逻辑</strong></td><td align="left">精确匹配 (<code>=</code>, <code>LIKE</code>)</td><td align="left">相似度匹配 (<code>Approximate Nearest Neighbor</code>)</td></tr><tr><td align="left"><strong>核心操作</strong></td><td align="left">CRUD</td><td align="left">Insert &amp; Search (TopK)</td></tr><tr><td align="left"><strong>数据形态</strong></td><td align="left">结构化 (Row/Column)</td><td align="left">非结构化 (Vector + Metadata)</td></tr><tr><td align="left"><strong>结果</strong></td><td align="left">确定性结果</td><td align="left">概率性结果 (Score)</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">03 距离度量：向量世界的“尺子” 📏</h2>
<p>既然数据变成了空间里的点，那怎么判断两个点“像不像”呢？我们需要一把尺子。在大数据聚类算法（如 K-Means）中，你可能已经见过它们：</p>
<h3 data-id="heading-5">1. 欧氏距离 (L2 - Euclidean Distance)</h3>
<ul>
<li><strong>原理</strong>：两点之间直线最短。</li>
<li><strong>直觉</strong>：空间距离越近，越相似。</li>
<li><strong>场景</strong>：对向量的<strong>大小</strong>和<strong>方向</strong>都敏感的场景。</li>
</ul>
<h3 data-id="heading-6">2. 余弦相似度 (Cosine Similarity) 🌟 <em>（最常用）</em></h3>
<ul>
<li><strong>原理</strong>：看两个向量的<strong>夹角</strong>。</li>
<li><strong>直觉</strong>：不管你跑得远不远（向量模长），只要我们方向一致，就是“同道中人”。</li>
<li><strong>场景</strong>：文本语义检索。因为文本长短不一可能导致模长不同，但核心语义（方向）是一致的。</li>
</ul>
<h3 data-id="heading-7">3. 内积 (IP - Inner Product)</h3>
<ul>
<li><strong>原理</strong>：向量对应位相乘再求和。</li>
<li><strong>场景</strong>：通常用于归一化（Normalized）后的向量，此时 IP 等价于 Cosine，但计算更快。</li>
</ul>
<hr/>
<h2 data-id="heading-8">04 极速上手：你的第一个 RAG 闭环 (MVP) 🛠️</h2>
<p>光说不练假把式。作为工程师，我们直接上代码。
我们将使用 <strong>Chroma</strong> —— 向量数据库界的 SQLite。它轻量、无需安装服务器，直接作为 Python 库运行，非常适合 MVP（最小可行性产品）验证。</p>
<h3 data-id="heading-9">场景设定</h3>
<p>我们要存入三句话，然后问一个问题，看它能不能找到最相关的那句。</p>
<h3 data-id="heading-10">1. 环境准备</h3>
<pre><code class="hljs language-bash" lang="bash">pip install chromadb
</code></pre>
<h3 data-id="heading-11">2. 代码实战 (Python)</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> chromadb

<span class="hljs-comment"># 1. 初始化一个本地的向量数据库客户端（内存模式，重启数据丢失，适合测试）</span>
client = chromadb.Client()

<span class="hljs-comment"># 2. 创建一个集合 (Collection)，类似于 SQL 中的 Table</span>
<span class="hljs-comment"># 这里我们使用默认的 Embedding 模型 (all-MiniLM-L6-v2)，它会自动下载</span>
collection = client.create_collection(name=<span class="hljs-string">"my_knowledge_base"</span>)

<span class="hljs-comment"># 3. 准备数据 (Documents) 和 元数据 (Metadata)</span>
documents = [
    <span class="hljs-string">"Hadoop 是一个分布式系统基础架构，主要解决海量数据的存储和分析计算问题。"</span>,
    <span class="hljs-string">"Spark 是一种基于内存的快速、通用、可扩展的大数据分析计算引擎。"</span>,
    <span class="hljs-string">"向量数据库是专门用于存储和查询高维向量数据的数据库，是 LLM 的记忆体。"</span>
]
metadatas = [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"bigdata"</span>}, {<span class="hljs-string">"type"</span>: <span class="hljs-string">"bigdata"</span>}, {<span class="hljs-string">"type"</span>: <span class="hljs-string">"ai"</span>}]
ids = [<span class="hljs-string">"doc1"</span>, <span class="hljs-string">"doc2"</span>, <span class="hljs-string">"doc3"</span>]

<span class="hljs-comment"># 4. 写入数据 (Upsert)</span>
<span class="hljs-comment"># Chroma 会自动调用内置模型，将 text 转为 vector，然后存储</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"🔄 正在将文本转化为向量并存入 Chroma..."</span>)
collection.add(
    documents=documents,
    metadatas=metadatas,
    ids=ids
)

<span class="hljs-comment"># 5. 语义查询 (Retrieve)</span>
query_text = <span class="hljs-string">"怎么让大模型拥有记忆？"</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"🔍 用户提问: <span class="hljs-subst">{query_text}</span>"</span>)

results = collection.query(
    query_texts=[query_text],
    n_results=<span class="hljs-number">1</span>  <span class="hljs-comment"># TopK = 1</span>
)

<span class="hljs-comment"># 6. 输出结果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n✅ 检索结果:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"匹配文档: <span class="hljs-subst">{results[<span class="hljs-string">'documents'</span>][<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"距离/相似度: <span class="hljs-subst">{results[<span class="hljs-string">'distances'</span>][<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]}</span>"</span>)
</code></pre>
<h3 data-id="heading-12">运行结果解析</h3>
<p><img src="http://openwrite.cn/uploads/20235/58098/ca0ba3d8-baee-4fca-a1e7-048e31ff05b8.png" alt="image.png" loading="lazy"/></p>
<p>当你运行这段代码，虽然你的问题里没有“向量数据库”这五个字，但系统会精准地返回 <code>doc3</code>。
这就是 <strong>语义匹配</strong> 的魅力！它听懂了“大模型记忆”和“向量数据库”之间的潜在联系。</p>
<hr/>
<h2 data-id="heading-13">05 架构师视角：RAG 的标准数据流水线 🏗️</h2>
<p>跑通了 Demo 只是第一步。作为未来的 AI 架构师，你需要关注的是整个数据流的流转。
一个标准的 <strong>RAG (Retrieval-Augmented Generation)</strong> 数据工程链路如下：</p>
<p><img src="http://openwrite.cn/uploads/20235/58098/ee60f6cc-bf01-49e5-acc0-4f12ec171387.png" alt="mermaid-diagram-2025-12-30-164218.png" loading="lazy"/></p>
<h3 data-id="heading-14">关键环节解析：</h3>
<ol>
<li><strong>Load (加载)</strong>：从 HDFS、S3 或本地读取非结构化数据。</li>
<li><strong>Split (切片)</strong>：这是最考验功力的地方。切太长，语义杂糅；切太短，语义破碎。通常使用 <code>RecursiveCharacterTextSplitter</code>。</li>
<li><strong>Embed (向量化)</strong>：调用 OpenAI 或 HuggingFace 的模型，将 Chunk 变成 Vector。这是最耗时且产生费用的环节。</li>
<li><strong>Store (存储)</strong>：将 Vector + Metadata + Original Text 存入向量库。</li>
<li><strong>Retrieve (检索)</strong>：计算 Query Vector 与 Library Vectors 的距离，返回 TopK。</li>
</ol>
<hr/>
<h2 data-id="heading-15">06 总结与预告 📝</h2>
<p>今天我们完成了从大数据工程师到 AI 工程师的第一次“脑机接口”升级。我们不再纠结于 <code>WHERE id=1</code>，而是开始思考数据在多维空间中的位置。</p>
<p><strong>核心知识点回顾：</strong></p>
<ul>
<li><strong>Embedding</strong> 是数据的灵魂坐标。</li>
<li><strong>Cosine Similarity</strong> 是寻找同类的指南针。</li>
<li><strong>Chroma</strong> 是我们手中的瑞士军刀。</li>
<li><strong>RAG Pipeline</strong> 是我们将非结构化数据转化为 AI 知识的标准工厂。</li>
</ul>
<p>为了让你更直观地复习，我为你准备了本篇的思维导图：</p>
<p><img src="http://openwrite.cn/uploads/20235/58098/04c8fca1-9541-4ac7-8b06-224f30a678b8.png" alt="mermaid-diagram-2025-12-30-164644.png" loading="lazy"/></p>
<h3 data-id="heading-16">📢 下期预告：核心战场——分布式向量数据库</h3>
<p>用 Chroma 跑 Demo 很爽，但如果数据量到了 <strong>10 亿级</strong> 怎么办？内存爆了怎么办？写入太慢怎么办？
这正是我们大数据工程师的主场！</p>
<p>下一期，我们将深入 <strong>Phase 2</strong>，硬核拆解 <strong>Milvus</strong> 的分布式架构。你会发现，它简直就是向量版的 Kafka + HDFS！我们将探讨 Proxy、DataCoord、QueryNode 等组件是如何协同工作的。</p>
<hr/>
<p><strong>💬 互动话题</strong>：
你在运行上面的 Python 代码时，有没有遇到 OpenAI API 连接的问题？或者你觉得“文本切片”应该按什么规则切才最合理？欢迎在评论区留言，我们一起探讨！</p>
<p><em>(别忘了关注，不错过下一篇硬核干货！)</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js fs 与 path 完全指南]]></title>    <link>https://juejin.cn/post/7591382440582578216</link>    <guid>https://juejin.cn/post/7591382440582578216</guid>    <pubDate>2026-01-05T03:06:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591382440582578216" data-draft-id="7591375103520620584" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js fs 与 path 完全指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-05T03:06:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dr_哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/2208293602984286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js fs 与 path 完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2208293602984286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dr_哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T03:06:52.000Z" title="Mon Jan 05 2026 03:06:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>从零到一掌握 Node.js 文件系统操作，小白也能看懂的实战教程</p>
<h2 data-id="heading-0">📌 核心原则</h2>
<p>在开始之前，请务必记住这四条黄金法则：</p>
<blockquote>
<p><strong>1. 异步优先</strong>：优先使用 <code>fs.promises</code>（不会阻塞程序运行）<br/>
<strong>2. 路径安全</strong>：使用 <code>path.*</code> 组合路径，避免字符串拼接<br/>
<strong>3. 原子写入</strong>：关键数据采用 "临时文件 + rename" 模式（下文会解释）<br/>
<strong>4. 安全校验</strong>：所有用户输入的路径必须做安全检查</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">💡 术语小课堂</h2>
<p>在正式开始前，先了解几个常见术语：</p>
<p><strong>🔹 什么是 API 签名（函数签名）？</strong></p>
<blockquote>
<p>就是函数的"使用说明书"，告诉你：</p>
<ul>
<li>函数叫什么名字</li>
<li>需要传什么参数</li>
<li>会返回什么结果</li>
</ul>
<p>例如：<code>readFile(path, options)</code> → <code>Promise&lt;string&gt;</code>
意思是：调用 <code>readFile</code> 函数，传入路径和选项，会返回一个 Promise，最终得到字符串内容</p>
</blockquote>
<p><strong>🔹 什么是原子写入？</strong></p>
<blockquote>
<p>简单理解：要么全部成功，要么全部失败，不会出现"写了一半"的情况。</p>
<p>举例：你正在保存一个重要配置文件，突然断电了</p>
<ul>
<li>❌ 普通写入：文件可能只写了一半，变成乱码</li>
<li>✅ 原子写入：要么保存成功，要么还是原来的文件，绝不会损坏</li>
</ul>
<p>实现方法：先写到临时文件，成功后再一次性替换原文件（rename 操作是原子性的）</p>
</blockquote>
<p><strong>🔹 什么是目录穿越攻击？</strong></p>
<blockquote>
<p>黑客通过特殊路径（如 <code>../../etc/passwd</code>）来访问不该访问的文件。</p>
<p>举例：你的网站允许用户下载 <code>/uploads</code> 目录下的文件</p>
<ul>
<li>用户正常请求：<code>/uploads/avatar.png</code> ✅</li>
<li>黑客恶意请求：<code>/uploads/../../etc/passwd</code> ❌ (试图访问系统密码文件)</li>
</ul>
<p>防御方法：检查最终路径是否真的在允许的目录内</p>
</blockquote>
<p><strong>🔹 异步 vs 同步？</strong></p>
<blockquote>
<ul>
<li><strong>异步</strong>：不等待任务完成，程序继续往下执行（推荐）</li>
<li><strong>同步</strong>：必须等待任务完成才能继续（会阻塞程序，不推荐）</li>
</ul>
<p>举例：读取一个 100MB 的文件</p>
<ul>
<li>异步：发起读取请求后，程序可以继续处理其他事情（如响应用户点击）</li>
<li>同步：程序卡住，等文件读完才能动（用户会觉得卡顿）</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-2">一、fs 模块 - 文件系统操作</h2>
<h3 data-id="heading-3">1.1 API 基础用法</h3>
<p>在动手实践前，先快速浏览一下 fs 模块提供了哪些工具：</p>
<h4 data-id="heading-4">📖 文件读写类</h4>
<p><strong><code>readFile(path, options)</code></strong> → 返回文件内容</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 读取文本文件</span>
<span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'config.json'</span>, <span class="hljs-string">'utf8'</span>);
</code></pre>
<ul>
<li>参数：文件路径 + 编码方式（如 <code>'utf8'</code>）</li>
<li>返回：文件内容（字符串或二进制数据）</li>
<li><strong>适用</strong>：小文件（&lt; 10MB）</li>
</ul>
<hr/>
<p><strong><code>writeFile(path, data, options)</code></strong> → 写入文件</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 写入文本文件</span>
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">'log.txt'</span>, <span class="hljs-string">'日志内容'</span>, <span class="hljs-string">'utf8'</span>);
</code></pre>
<ul>
<li>参数：文件路径 + 要写入的内容 + 编码方式</li>
<li>说明：文件不存在会自动创建，存在则覆盖</li>
<li><strong>适用</strong>：小文件</li>
</ul>
<hr/>
<p><strong><code>appendFile(path, data, options)</code></strong> → 追加内容到文件末尾</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 在文件末尾追加内容（不覆盖原内容）</span>
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">appendFile</span>(<span class="hljs-string">'log.txt'</span>, <span class="hljs-string">'新的一行日志\n'</span>, <span class="hljs-string">'utf8'</span>);
</code></pre>
<ul>
<li><strong>适用</strong>：日志记录</li>
</ul>
<hr/>
<h4 data-id="heading-5">📁 目录操作类</h4>
<p><strong><code>mkdir(path, options)</code></strong> → 创建目录</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 创建多级目录（父目录不存在也会自动创建）</span>
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(<span class="hljs-string">'data/cache/temp'</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
</code></pre>
<ul>
<li>重要参数：<code>recursive: true</code> 可创建多级目录</li>
<li>说明：目录已存在不会报错</li>
</ul>
<hr/>
<p><strong><code>readdir(path, options)</code></strong> → 读取目录内容</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 获取目录下的所有文件和子目录</span>
<span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readdir</span>(<span class="hljs-string">'data'</span>);  <span class="hljs-comment">// 返回文件名数组</span>

<span class="hljs-comment">// 获取详细信息（包括文件类型）</span>
<span class="hljs-keyword">const</span> entries = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readdir</span>(<span class="hljs-string">'data'</span>, { <span class="hljs-attr">withFileTypes</span>: <span class="hljs-literal">true</span> });
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(entry.<span class="hljs-property">name</span>, entry.<span class="hljs-title function_">isFile</span>() ? <span class="hljs-string">'文件'</span> : <span class="hljs-string">'目录'</span>);
}
</code></pre>
<hr/>
<h4 data-id="heading-6">🔍 信息查询类</h4>
<p><strong><code>stat(path)</code></strong> → 获取文件详细信息</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> info = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">stat</span>(<span class="hljs-string">'file.txt'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(info.<span class="hljs-property">size</span>);        <span class="hljs-comment">// 文件大小（字节）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(info.<span class="hljs-title function_">isFile</span>());    <span class="hljs-comment">// 是否为文件</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(info.<span class="hljs-property">mtime</span>);       <span class="hljs-comment">// 最后修改时间</span>
</code></pre>
<hr/>
<p><strong><code>access(path, mode)</code></strong> → 检查文件是否存在/可读写</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { constants } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-comment">// 检查文件是否可读写</span>
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">access</span>(<span class="hljs-string">'file.txt'</span>, constants.<span class="hljs-property">R_OK</span> | constants.<span class="hljs-property">W_OK</span>);
</code></pre>
<hr/>
<h4 data-id="heading-7">🛠️ 文件操作类</h4>
<p><strong><code>copyFile(src, dest)</code></strong> → 拷贝文件</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">copyFile</span>(<span class="hljs-string">'source.txt'</span>, <span class="hljs-string">'backup.txt'</span>);
</code></pre>
<hr/>
<p><strong><code>rename(oldPath, newPath)</code></strong> → 重命名或移动文件</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rename</span>(<span class="hljs-string">'old.txt'</span>, <span class="hljs-string">'new.txt'</span>);  <span class="hljs-comment">// 重命名</span>
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rename</span>(<span class="hljs-string">'temp/file.txt'</span>, <span class="hljs-string">'data/file.txt'</span>);  <span class="hljs-comment">// 移动</span>
</code></pre>
<hr/>
<p><strong><code>rm(path, options)</code></strong> → 删除文件或目录</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 删除文件（不存在也不报错）</span>
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rm</span>(<span class="hljs-string">'file.txt'</span>, { <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span> });

<span class="hljs-comment">// 删除整个目录（小心使用！）</span>
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rm</span>(<span class="hljs-string">'temp'</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span> });
</code></pre>
<ul>
<li><strong>⚠️ 危险操作</strong>：<code>recursive: true</code> 会删除整个目录树</li>
</ul>
<hr/>
<p><strong><code>unlink(path)</code></strong> → 删除文件</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">unlink</span>(<span class="hljs-string">'file.txt'</span>);  <span class="hljs-comment">// 只能删除文件，不能删除目录</span>
</code></pre>
<hr/>
<h4 data-id="heading-8">🌊 流式操作类（处理大文件）</h4>
<p><strong><code>createReadStream(path)</code></strong> → 创建读取流</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> stream = fs.<span class="hljs-title function_">createReadStream</span>(<span class="hljs-string">'video.mp4'</span>);
<span class="hljs-comment">// 逐块读取，不会一次性加载到内存</span>
</code></pre>
<hr/>
<p><strong><code>createWriteStream(path)</code></strong> → 创建写入流</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> stream = fs.<span class="hljs-title function_">createWriteStream</span>(<span class="hljs-string">'output.txt'</span>);
stream.<span class="hljs-title function_">write</span>(<span class="hljs-string">'内容'</span>);
</code></pre>
<hr/>
<p><strong><code>pipeline(...streams)</code></strong> → 连接多个流（最佳实践）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { pipeline } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:stream/promises'</span>;

<span class="hljs-comment">// 复制大文件</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">pipeline</span>(
  fs.<span class="hljs-title function_">createReadStream</span>(<span class="hljs-string">'large.dat'</span>),
  fs.<span class="hljs-title function_">createWriteStream</span>(<span class="hljs-string">'large.dat.backup'</span>)
);
</code></pre>
<hr/>
<h3 data-id="heading-9">1.2 异步 vs 同步方法</h3>
<p>Node.js 为每个文件操作都提供了<strong>两种版本</strong>：</p>
<h4 data-id="heading-10">🟢 异步方法（推荐）</h4>
<p>使用 <code>fs.promises</code> 或回调函数，不会阻塞程序：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { promises <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-comment">// ✅ 推荐：使用 Promise 风格（现代写法）</span>
<span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'file.txt'</span>, <span class="hljs-string">'utf8'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'读取完成'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这行代码会等上面读取完成后执行'</span>);

<span class="hljs-comment">// 在等待读取期间，程序可以处理其他任务（如响应用户操作）</span>
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>不阻塞程序，性能好</li>
<li>适合服务器环境（可同时处理多个请求）</li>
</ul>
<hr/>
<h4 data-id="heading-11">🔴 同步方法（谨慎使用）</h4>
<p>方法名以 <code>Sync</code> 结尾，会阻塞程序：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-comment">// ❌ 不推荐：同步方法（会卡住程序）</span>
<span class="hljs-keyword">const</span> content = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'file.txt'</span>, <span class="hljs-string">'utf8'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'读取完成'</span>);

<span class="hljs-comment">// 在读取文件期间，程序完全卡住，无法做其他事情</span>
</code></pre>
<p><strong>缺点</strong>：</p>
<ul>
<li>会阻塞事件循环，程序卡住</li>
<li>在服务器环境中会严重影响性能</li>
</ul>
<p><strong>何时可以用？</strong></p>
<ul>
<li>程序启动时读取配置文件（只执行一次）</li>
<li>命令行工具的简单脚本（单线程，无并发）</li>
</ul>
<p><strong>示例：程序启动时读取配置</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-comment">// 程序启动时，可以使用同步读取</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(
  fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'./config.json'</span>, <span class="hljs-string">'utf8'</span>)
);

<span class="hljs-comment">// 但在请求处理函数中，必须用异步</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/data'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fs.<span class="hljs-property">promises</span>.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'data.json'</span>, <span class="hljs-string">'utf8'</span>); <span class="hljs-comment">// ✅</span>
  res.<span class="hljs-title function_">send</span>(data);
});
</code></pre>
<hr/>
<h3 data-id="heading-12">1.3 实战场景详解</h3>
<p>掌握了基础 API 后，我们来看看在实际项目中如何应用。</p>
<h4 data-id="heading-13">场景 1：读取与写入配置文件</h4>
<p><strong>💡 场景描述</strong></p>
<ul>
<li>程序启动时读取 <code>config.json</code> 配置</li>
<li>用户修改设置后保存到配置文件</li>
<li>写日志到 <code>app.log</code> 文件</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { promises <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-comment">// 读取配置文件</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadConfig</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> text = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'config.json'</span>, <span class="hljs-string">'utf8'</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(text);
}

<span class="hljs-comment">// 保存配置</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">saveConfig</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-keyword">const</span> text = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(config, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>);  <span class="hljs-comment">// 格式化为易读的 JSON</span>
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">'config.json'</span>, text, <span class="hljs-string">'utf8'</span>);
}

<span class="hljs-comment">// 记录日志（追加方式）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">message</span>) {
  <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>();
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">appendFile</span>(<span class="hljs-string">'app.log'</span>, <span class="hljs-string">`[<span class="hljs-subst">${timestamp}</span>] <span class="hljs-subst">${message}</span>\n`</span>, <span class="hljs-string">'utf8'</span>);
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadConfig</span>();
config.<span class="hljs-property">theme</span> = <span class="hljs-string">'dark'</span>;
<span class="hljs-keyword">await</span> <span class="hljs-title function_">saveConfig</span>(config);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">log</span>(<span class="hljs-string">'配置已更新'</span>);
</code></pre>
<p><strong>⚠️ 注意事项</strong></p>
<ul>
<li>小文件（&lt; 10MB）用 <code>readFile/writeFile</code></li>
<li>大文件会导致内存溢出（OOM），必须用流式处理（见后文）</li>
<li>指定 <code>'utf8'</code> 编码会返回字符串，否则返回二进制 Buffer</li>
</ul>
<hr/>
<h4 data-id="heading-14">场景 2：遍历目录并分类文件</h4>
<p><strong>💡 场景描述</strong></p>
<ul>
<li>扫描 <code>uploads</code> 目录下的所有文件</li>
<li>根据类型（图片、文档、其他）分别统计</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { promises <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">classifyFiles</span>(<span class="hljs-params">dirPath</span>) {
  <span class="hljs-keyword">const</span> stats = {
    <span class="hljs-attr">images</span>: [],
    <span class="hljs-attr">documents</span>: [],
    <span class="hljs-attr">others</span>: []
  };
  
  <span class="hljs-comment">// withFileTypes: true 返回详细信息，性能更好</span>
  <span class="hljs-keyword">const</span> entries = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readdir</span>(dirPath, { <span class="hljs-attr">withFileTypes</span>: <span class="hljs-literal">true</span> });
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-title function_">isDirectory</span>()) {
      <span class="hljs-keyword">continue</span>;  <span class="hljs-comment">// 跳过子目录</span>
    }
    
    <span class="hljs-keyword">const</span> ext = path.<span class="hljs-title function_">extname</span>(entry.<span class="hljs-property">name</span>).<span class="hljs-title function_">toLowerCase</span>();
    <span class="hljs-keyword">const</span> fullPath = path.<span class="hljs-title function_">join</span>(dirPath, entry.<span class="hljs-property">name</span>);
    
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">'.jpg'</span>, <span class="hljs-string">'.png'</span>, <span class="hljs-string">'.gif'</span>].<span class="hljs-title function_">includes</span>(ext)) {
      stats.<span class="hljs-property">images</span>.<span class="hljs-title function_">push</span>(fullPath);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([<span class="hljs-string">'.pdf'</span>, <span class="hljs-string">'.docx'</span>, <span class="hljs-string">'.txt'</span>].<span class="hljs-title function_">includes</span>(ext)) {
      stats.<span class="hljs-property">documents</span>.<span class="hljs-title function_">push</span>(fullPath);
    } <span class="hljs-keyword">else</span> {
      stats.<span class="hljs-property">others</span>.<span class="hljs-title function_">push</span>(fullPath);
    }
  }
  
  <span class="hljs-keyword">return</span> stats;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">classifyFiles</span>(<span class="hljs-string">'uploads'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`找到 <span class="hljs-subst">${result.images.length}</span> 张图片`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`找到 <span class="hljs-subst">${result.documents.length}</span> 个文档`</span>);
</code></pre>
<p><strong>💡 小技巧</strong></p>
<ul>
<li><code>withFileTypes: true</code> 比先 <code>readdir</code> 再 <code>stat</code> 性能高很多</li>
<li><code>path.extname()</code> 可以获取文件扩展名</li>
</ul>
<hr/>
<h4 data-id="heading-15">场景 3：递归创建目录</h4>
<p><strong>💡 场景描述</strong></p>
<ul>
<li>脚手架工具初始化项目时创建目录结构</li>
<li>确保日志目录存在后再写入日志</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { promises <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-comment">// 创建多级目录</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureDir</span>(<span class="hljs-params">dirPath</span>) {
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(dirPath, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">ensureDir</span>(<span class="hljs-string">'project/src/components/Button'</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">ensureDir</span>(<span class="hljs-string">'logs/2024/01'</span>);

<span class="hljs-comment">// 现在可以放心写入文件了</span>
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">'logs/2024/01/app.log'</span>, <span class="hljs-string">'日志内容'</span>);
</code></pre>
<p><strong>⚠️ 重点</strong></p>
<ul>
<li><code>recursive: true</code> 会自动创建父目录</li>
<li>目录已存在不会报错</li>
</ul>
<hr/>
<h4 data-id="heading-16">场景 4：备份与日志轮转</h4>
<p><strong>💡 场景描述</strong></p>
<ul>
<li>每天零点将今天的日志文件重命名为 <code>app-2024-01-05.log</code></li>
<li>拷贝重要文件做备份</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { promises <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-comment">// 日志轮转：重命名今天的日志</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rotateLog</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> today = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>];  <span class="hljs-comment">// '2024-01-05'</span>
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rename</span>(<span class="hljs-string">'app.log'</span>, <span class="hljs-string">`app-<span class="hljs-subst">${today}</span>.log`</span>);
  <span class="hljs-comment">// 创建新的空日志文件</span>
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">'app.log'</span>, <span class="hljs-string">''</span>);
}

<span class="hljs-comment">// 备份文件</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">backupFile</span>(<span class="hljs-params">source</span>) {
  <span class="hljs-keyword">const</span> backup = <span class="hljs-string">`<span class="hljs-subst">${source}</span>.backup`</span>;
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">copyFile</span>(source, backup);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`已备份到: <span class="hljs-subst">${backup}</span>`</span>);
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">rotateLog</span>();
<span class="hljs-keyword">await</span> <span class="hljs-title function_">backupFile</span>(<span class="hljs-string">'config.json'</span>);
</code></pre>
<hr/>
<h4 data-id="heading-17">场景 5：安全的原子写入（防止文件损坏）</h4>
<p><strong>💡 场景描述</strong></p>
<ul>
<li>保存重要配置文件时，防止写到一半程序崩溃导致文件损坏</li>
</ul>
<p><strong>🔹 为什么需要原子写入？</strong></p>
<p>普通写入的问题：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 危险：如果写到一半程序崩溃，文件会损坏</span>
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">'config.json'</span>, largeContent);
<span class="hljs-comment">// 假设写到这里突然断电 → config.json 只写了一半，变成乱码！</span>
</code></pre>
<p>原子写入的解决方案：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { promises <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-comment">/**
 * 原子写入：先写临时文件，成功后再替换
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">atomicWrite</span>(<span class="hljs-params">filePath, content</span>) {
  <span class="hljs-comment">// 1. 确保目录存在</span>
  <span class="hljs-keyword">const</span> dir = path.<span class="hljs-title function_">dirname</span>(filePath);
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(dir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
  
  <span class="hljs-comment">// 2. 先写到临时文件（加时间戳避免冲突）</span>
  <span class="hljs-keyword">const</span> tmpFile = <span class="hljs-string">`<span class="hljs-subst">${filePath}</span>.tmp-<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(tmpFile, content);
  
  <span class="hljs-comment">// 3. 原子替换（rename 是原子操作）</span>
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rename</span>(tmpFile, filePath);
  <span class="hljs-comment">// 这一步要么成功，要么失败，不会出现"替换了一半"的情况</span>
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> config = { <span class="hljs-attr">version</span>: <span class="hljs-string">'2.0'</span>, <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span> };
<span class="hljs-keyword">await</span> <span class="hljs-title function_">atomicWrite</span>(<span class="hljs-string">'config.json'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(config, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
</code></pre>
<p><strong>✅ 原子写入的好处</strong></p>
<ul>
<li>写入过程中即使断电/崩溃，原文件不会损坏</li>
<li>要么看到旧版本，要么看到新版本，绝不会是"半截"内容</li>
</ul>
<p><strong>⚠️ 何时必须用</strong></p>
<ul>
<li>配置文件</li>
<li>数据库数据</li>
<li>用户保存的文档</li>
</ul>
<hr/>
<h4 data-id="heading-18">场景 6：流式处理大文件</h4>
<p><strong>💡 场景描述</strong></p>
<ul>
<li>复制 1GB 的视频文件</li>
<li>逐行读取 500MB 的日志文件并分析</li>
</ul>
<p><strong>🔹 为什么需要流式处理？</strong></p>
<p>普通方式的问题：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 危险：读取 1GB 文件会占用 1GB 内存，导致程序崩溃</span>
<span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'video.mp4'</span>);  <span class="hljs-comment">// OOM!</span>
<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">'video.mp4.backup'</span>, content);
</code></pre>
<p>流式处理的解决方案：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createReadStream, createWriteStream } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;
<span class="hljs-keyword">import</span> { pipeline } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:stream/promises'</span>;

<span class="hljs-comment">// ✅ 正确：逐块读写，内存占用极低（只有几 MB）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">copyLargeFile</span>(<span class="hljs-params">source, dest</span>) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">pipeline</span>(
    <span class="hljs-title function_">createReadStream</span>(source),
    <span class="hljs-title function_">createWriteStream</span>(dest)
  );
}

<span class="hljs-comment">// 带进度显示</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">copyWithProgress</span>(<span class="hljs-params">source, dest</span>) {
  <span class="hljs-keyword">let</span> processedBytes = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> readStream = <span class="hljs-title function_">createReadStream</span>(source);
  
  readStream.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
    processedBytes += chunk.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">const</span> mb = (processedBytes / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`已处理: <span class="hljs-subst">${mb}</span> MB`</span>);
  });
  
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">pipeline</span>(readStream, <span class="hljs-title function_">createWriteStream</span>(dest));
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ 复制完成'</span>);
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">copyLargeFile</span>(<span class="hljs-string">'video.mp4'</span>, <span class="hljs-string">'backup.mp4'</span>);
</code></pre>
<p><strong>⚠️ 关键规则</strong></p>
<ul>
<li>文件 &gt; 10MB 必须使用流</li>
<li>必须使用 <code>pipeline</code>（自动处理错误和背压）</li>
<li>禁止手写 <code>readStream.on('data')</code> + <code>writeStream.write()</code></li>
</ul>
<hr/>
<h4 data-id="heading-19">场景 7：批量处理文件（并发控制）</h4>
<p><strong>💡 场景描述</strong></p>
<ul>
<li>压缩 1000 张图片</li>
<li>复制 5 万个文件</li>
</ul>
<p><strong>🔹 为什么需要并发控制？</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 危险：同时打开 1000 个文件会导致资源耗尽</span>
<span class="hljs-keyword">const</span> files = [<span class="hljs-string">'img1.jpg'</span>, <span class="hljs-string">'img2.jpg'</span>, <span class="hljs-comment">/* ...1000 个 */</span>];
<span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(files.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> <span class="hljs-title function_">compressImage</span>(file)));  <span class="hljs-comment">// 崩溃！</span>
</code></pre>
<p>限制并发数的解决方案：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 并发池：限制同时运行的任务数
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">concurrentPool</span>(<span class="hljs-params">items, limit, worker</span>) {
  <span class="hljs-keyword">const</span> queue = [...items];
  <span class="hljs-keyword">let</span> running = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">runNext</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (index &gt;= items.<span class="hljs-property">length</span> &amp;&amp; running === <span class="hljs-number">0</span>) {
        <span class="hljs-title function_">resolve</span>();
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-keyword">while</span> (running &lt; limit &amp;&amp; index &lt; items.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> item = items[index++];
        running++;
        
        <span class="hljs-title function_">worker</span>(item).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
          running--;
          <span class="hljs-title function_">runNext</span>();
        });
      }
    }
    
    <span class="hljs-title function_">runNext</span>();
  });
}

<span class="hljs-comment">// 使用示例：限制并发为 10</span>
<span class="hljs-keyword">const</span> images = [<span class="hljs-string">'img1.jpg'</span>, <span class="hljs-string">'img2.jpg'</span>, <span class="hljs-comment">/* ...1000 个 */</span>];
<span class="hljs-keyword">await</span> <span class="hljs-title function_">concurrentPool</span>(images, <span class="hljs-number">10</span>, <span class="hljs-keyword">async</span> (file) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">compressImage</span>(file);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`已处理: <span class="hljs-subst">${file}</span>`</span>);
});
</code></pre>
<p><strong>💡 推荐并发数</strong></p>
<ul>
<li>CPU 密集任务（图片压缩）：CPU 核心数（如 4 或 8）</li>
<li>IO 密集任务（文件复制）：10-50</li>
</ul>
<hr/>
<h4 data-id="heading-20">场景 8：错误处理最佳实践</h4>
<p><strong>💡 场景描述</strong></p>
<ul>
<li>文件不存在时给出友好提示</li>
<li>权限不足时引导用户检查</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { promises <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">safeReadFile</span>(<span class="hljs-params">filePath</span>) {
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(filePath, <span class="hljs-string">'utf8'</span>);
} <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-comment">// 根据错误码提供友好提示</span>
    <span class="hljs-keyword">switch</span> (err.<span class="hljs-property">code</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'ENOENT'</span>:
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ 文件不存在: <span class="hljs-subst">${filePath}</span>`</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请检查文件路径是否正确'</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'EACCES'</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-string">'EPERM'</span>:
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ 权限不足: <span class="hljs-subst">${filePath}</span>`</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请检查文件权限或以管理员身份运行'</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'EISDIR'</span>:
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ 这是一个目录，不是文件: <span class="hljs-subst">${filePath}</span>`</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ 未知错误: <span class="hljs-subst">${err.message}</span>`</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">stack</span>);  <span class="hljs-comment">// 开发环境保留堆栈</span>
    }
    <span class="hljs-keyword">throw</span> err;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> <span class="hljs-title function_">safeReadFile</span>(<span class="hljs-string">'config.json'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(content);
} <span class="hljs-keyword">catch</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'读取失败，使用默认配置'</span>);
}
</code></pre>
<p><strong>常见错误码</strong></p>
<ul>
<li><code>ENOENT</code>：文件/目录不存在</li>
<li><code>EACCES</code> / <code>EPERM</code>：权限不足</li>
<li><code>EEXIST</code>：文件已存在</li>
<li><code>EISDIR</code>：路径是目录，不是文件</li>
<li><code>ENOTDIR</code>：路径是文件，不是目录</li>
</ul>
<hr/>
<h2 data-id="heading-21">二、path 模块 - 路径处理</h2>
<h3 data-id="heading-22">2.1 为什么需要 path 模块？</h3>
<p><strong>❌ 错误做法：字符串拼接</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> filePath = root + <span class="hljs-string">'/'</span> + folder + <span class="hljs-string">'/'</span> + filename;  <span class="hljs-comment">// 在 Windows 上会出错！</span>
</code></pre>
<p><strong>✅ 正确做法：使用 path 模块</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;
<span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(root, folder, filename);  <span class="hljs-comment">// 跨平台兼容</span>
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li>Windows 用 <code>\</code>（反斜杠）：<code>C:\Users\name\file.txt</code></li>
<li>macOS/Linux 用 <code>/</code>（正斜杠）：<code>/home/name/file.txt</code></li>
<li><code>path</code> 模块会自动处理这些差异</li>
</ul>
<hr/>
<h3 data-id="heading-23">2.2 核心 API 详解</h3>
<h4 data-id="heading-24"><code>path.join()</code> - 拼接路径</h4>
<p><strong>作用</strong>：将多个路径片段拼接成一个路径</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-keyword">const</span> projectRoot = <span class="hljs-string">'/Users/me/project'</span>;
<span class="hljs-keyword">const</span> logDir = path.<span class="hljs-title function_">join</span>(projectRoot, <span class="hljs-string">'logs'</span>);
<span class="hljs-comment">// 结果: '/Users/me/project/logs'</span>

<span class="hljs-keyword">const</span> logFile = path.<span class="hljs-title function_">join</span>(logDir, <span class="hljs-string">'2024'</span>, <span class="hljs-string">'app.log'</span>);
<span class="hljs-comment">// 结果: '/Users/me/project/logs/2024/app.log'</span>

<span class="hljs-comment">// 自动处理多余的斜杠</span>
path.<span class="hljs-title function_">join</span>(<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>);      <span class="hljs-comment">// 'a/b'</span>
path.<span class="hljs-title function_">join</span>(<span class="hljs-string">'a/'</span>, <span class="hljs-string">'/b'</span>);    <span class="hljs-comment">// 'a/b'（自动清理）</span>
path.<span class="hljs-title function_">join</span>(<span class="hljs-string">'a'</span>, <span class="hljs-string">'.'</span>, <span class="hljs-string">'b'</span>); <span class="hljs-comment">// 'a/b'（处理 .）</span>
</code></pre>
<hr/>
<h4 data-id="heading-25"><code>path.resolve()</code> - 解析为绝对路径</h4>
<p><strong>作用</strong>：将相对路径转为绝对路径</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-comment">// 假设当前目录是 /Users/me/project</span>

<span class="hljs-comment">// 相对路径 → 绝对路径</span>
<span class="hljs-keyword">const</span> abs = path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'logs'</span>, <span class="hljs-string">'app.log'</span>);
<span class="hljs-comment">// 结果: '/Users/me/project/logs/app.log'</span>

<span class="hljs-comment">// 如果遇到绝对路径，会从那里重新开始</span>
<span class="hljs-keyword">const</span> abs2 = path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'a'</span>, <span class="hljs-string">'/b'</span>, <span class="hljs-string">'c'</span>);
<span class="hljs-comment">// 结果: '/b/c'（从 /b 重新开始）</span>
</code></pre>
<p><strong>💡 推荐用法</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 项目中定位文件的最佳实践</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>;

<span class="hljs-comment">// ESM 模块中获取当前文件所在目录</span>
<span class="hljs-keyword">const</span> __dirname = path.<span class="hljs-title function_">dirname</span>(<span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>));

<span class="hljs-comment">// 定位项目根目录的配置文件</span>
<span class="hljs-keyword">const</span> configPath = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'../config/app.json'</span>);
</code></pre>
<hr/>
<h4 data-id="heading-26"><code>path.dirname()</code> / <code>path.basename()</code> / <code>path.extname()</code> - 拆分路径</h4>
<p><strong>作用</strong>：提取路径的各个部分</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-keyword">const</span> filePath = <span class="hljs-string">'/Users/me/project/src/app.js'</span>;

path.<span class="hljs-title function_">dirname</span>(filePath);   <span class="hljs-comment">// '/Users/me/project/src'（目录部分）</span>
path.<span class="hljs-title function_">basename</span>(filePath);  <span class="hljs-comment">// 'app.js'（文件名部分）</span>
path.<span class="hljs-title function_">extname</span>(filePath);   <span class="hljs-comment">// '.js'（扩展名部分）</span>

<span class="hljs-comment">// basename 可以去掉扩展名</span>
path.<span class="hljs-title function_">basename</span>(filePath, <span class="hljs-string">'.js'</span>);  <span class="hljs-comment">// 'app'</span>
</code></pre>
<p><strong>💡 实用案例：根据文件类型分类</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getFileType</span>(<span class="hljs-params">filename</span>) {
  <span class="hljs-keyword">const</span> ext = path.<span class="hljs-title function_">extname</span>(filename).<span class="hljs-title function_">toLowerCase</span>();
  
  <span class="hljs-keyword">if</span> ([<span class="hljs-string">'.jpg'</span>, <span class="hljs-string">'.png'</span>, <span class="hljs-string">'.gif'</span>].<span class="hljs-title function_">includes</span>(ext)) <span class="hljs-keyword">return</span> <span class="hljs-string">'图片'</span>;
  <span class="hljs-keyword">if</span> ([<span class="hljs-string">'.mp4'</span>, <span class="hljs-string">'.avi'</span>].<span class="hljs-title function_">includes</span>(ext)) <span class="hljs-keyword">return</span> <span class="hljs-string">'视频'</span>;
  <span class="hljs-keyword">if</span> ([<span class="hljs-string">'.pdf'</span>, <span class="hljs-string">'.docx'</span>].<span class="hljs-title function_">includes</span>(ext)) <span class="hljs-keyword">return</span> <span class="hljs-string">'文档'</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">'其他'</span>;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getFileType</span>(<span class="hljs-string">'avatar.png'</span>));  <span class="hljs-comment">// '图片'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getFileType</span>(<span class="hljs-string">'video.mp4'</span>));   <span class="hljs-comment">// '视频'</span>
</code></pre>
<hr/>
<h4 data-id="heading-27"><code>path.parse()</code> / <code>path.format()</code> - 结构化处理</h4>
<p><strong>作用</strong>：将路径拆解为对象，或从对象组装路径</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-comment">// 拆解路径</span>
<span class="hljs-keyword">const</span> parsed = path.<span class="hljs-title function_">parse</span>(<span class="hljs-string">'/Users/me/project/app.js'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(parsed);
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   root: '/',</span>
<span class="hljs-comment">//   dir: '/Users/me/project',</span>
<span class="hljs-comment">//   base: 'app.js',</span>
<span class="hljs-comment">//   name: 'app',</span>
<span class="hljs-comment">//   ext: '.js'</span>
<span class="hljs-comment">// }</span>

<span class="hljs-comment">// 修改后重新组装</span>
<span class="hljs-keyword">const</span> newPath = path.<span class="hljs-title function_">format</span>({
  ...parsed,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'server'</span>,  <span class="hljs-comment">// 改文件名</span>
  <span class="hljs-attr">ext</span>: <span class="hljs-string">'.ts'</span>       <span class="hljs-comment">// 改扩展名</span>
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newPath);  <span class="hljs-comment">// '/Users/me/project/server.ts'</span>
</code></pre>
<p><strong>💡 实用案例：批量重命名</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;
<span class="hljs-keyword">import</span> { promises <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;

<span class="hljs-comment">// 将所有 .jpg 改为 .png</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renameExtension</span>(<span class="hljs-params">dir, oldExt, newExt</span>) {
  <span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readdir</span>(dir);
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files) {
    <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">extname</span>(file) === oldExt) {
      <span class="hljs-keyword">const</span> parsed = path.<span class="hljs-title function_">parse</span>(file);
      <span class="hljs-keyword">const</span> newName = path.<span class="hljs-title function_">format</span>({ ...parsed, <span class="hljs-attr">ext</span>: newExt });
      
      <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rename</span>(
        path.<span class="hljs-title function_">join</span>(dir, file),
        path.<span class="hljs-title function_">join</span>(dir, newName)
      );
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${file}</span> → <span class="hljs-subst">${newName}</span>`</span>);
    }
  }
}

<span class="hljs-keyword">await</span> <span class="hljs-title function_">renameExtension</span>(<span class="hljs-string">'images'</span>, <span class="hljs-string">'.jpg'</span>, <span class="hljs-string">'.png'</span>);
</code></pre>
<hr/>
<h4 data-id="heading-28"><code>path.normalize()</code> - 清理路径</h4>
<p><strong>作用</strong>：清理路径中的多余部分</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

path.<span class="hljs-title function_">normalize</span>(<span class="hljs-string">'/a/b/c/../d'</span>);      <span class="hljs-comment">// '/a/b/d'（处理 ..）</span>
path.<span class="hljs-title function_">normalize</span>(<span class="hljs-string">'/a//b///c'</span>);        <span class="hljs-comment">// '/a/b/c'（去掉多余斜杠）</span>
path.<span class="hljs-title function_">normalize</span>(<span class="hljs-string">'./src/../dist'</span>);    <span class="hljs-comment">// 'dist'</span>
</code></pre>
<p><strong>⚠️ 注意</strong>：<code>normalize</code> 只是字符串处理，不做安全检查！</p>
<hr/>
<h4 data-id="heading-29"><code>path.relative()</code> - 计算相对路径</h4>
<p><strong>作用</strong>：计算从一个路径到另一个路径的相对路径</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-keyword">from</span> = <span class="hljs-string">'/Users/me/project/src'</span>;
<span class="hljs-keyword">const</span> to = <span class="hljs-string">'/Users/me/project/dist/index.js'</span>;

<span class="hljs-keyword">const</span> rel = path.<span class="hljs-title function_">relative</span>(<span class="hljs-keyword">from</span>, to);
<span class="hljs-comment">// 结果: '../dist/index.js'</span>
</code></pre>
<p><strong>💡 实用案例：生成 import 语句</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateImport</span>(<span class="hljs-params">fromFile, toFile</span>) {
  <span class="hljs-keyword">const</span> fromDir = path.<span class="hljs-title function_">dirname</span>(fromFile);
  <span class="hljs-keyword">const</span> rel = path.<span class="hljs-title function_">relative</span>(fromDir, toFile);
  <span class="hljs-keyword">return</span> <span class="hljs-string">`import something from './<span class="hljs-subst">${rel}</span>';`</span>;
}

<span class="hljs-keyword">const</span> statement = <span class="hljs-title function_">generateImport</span>(
  <span class="hljs-string">'/project/src/app.js'</span>,
  <span class="hljs-string">'/project/src/utils/helper.js'</span>
);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(statement);
<span class="hljs-comment">// import something from './utils/helper.js';</span>
</code></pre>
<hr/>
<h3 data-id="heading-30">2.3 安全拼接 - 防止目录穿越攻击</h3>
<p><strong>🔹 什么是目录穿越攻击？</strong>（复习）</p>
<p>黑客通过 <code>../../</code> 来访问不该访问的文件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 你的网站允许下载 /uploads 目录下的文件</span>
<span class="hljs-keyword">const</span> uploadDir = <span class="hljs-string">'/var/www/uploads'</span>;
<span class="hljs-keyword">const</span> userInput = <span class="hljs-string">'../../etc/passwd'</span>;  <span class="hljs-comment">// 黑客输入</span>

<span class="hljs-comment">// ❌ 危险：直接拼接会被攻击</span>
<span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(uploadDir, userInput);
<span class="hljs-comment">// 结果: '/var/etc/passwd'（逃出了 uploads 目录！）</span>

<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(filePath);  <span class="hljs-comment">// 黑客成功读取系统密码文件！</span>
</code></pre>
<p><strong>✅ 安全解决方案：检查最终路径</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-comment">/**
 * 安全拼接：确保最终路径不会逃出根目录
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">safeJoin</span>(<span class="hljs-params">rootDir, userInput</span>) {
  <span class="hljs-comment">// 1. 拼接路径</span>
  <span class="hljs-keyword">const</span> targetPath = path.<span class="hljs-title function_">resolve</span>(rootDir, userInput);
  
  <span class="hljs-comment">// 2. 规范化根目录（加上斜杠）</span>
  <span class="hljs-keyword">const</span> normalizedRoot = path.<span class="hljs-title function_">resolve</span>(rootDir) + path.<span class="hljs-property">sep</span>;
  
  <span class="hljs-comment">// 3. 检查目标路径是否以根目录开头</span>
  <span class="hljs-keyword">if</span> (!targetPath.<span class="hljs-title function_">startsWith</span>(normalizedRoot)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'⚠️ 检测到目录穿越攻击，拒绝访问！'</span>);
  }
  
  <span class="hljs-keyword">return</span> targetPath;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> uploadDir = <span class="hljs-string">'/var/www/uploads'</span>;

<span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// ✅ 正常访问</span>
  <span class="hljs-keyword">const</span> safe1 = <span class="hljs-title function_">safeJoin</span>(uploadDir, <span class="hljs-string">'avatar.png'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(safe1);  <span class="hljs-comment">// '/var/www/uploads/avatar.png'</span>
  
  <span class="hljs-comment">// ❌ 攻击被拦截</span>
  <span class="hljs-keyword">const</span> safe2 = <span class="hljs-title function_">safeJoin</span>(uploadDir, <span class="hljs-string">'../../etc/passwd'</span>);
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">message</span>);  <span class="hljs-comment">// '⚠️ 检测到目录穿越攻击'</span>
}
</code></pre>
<p><strong>⚠️ 重要规则</strong></p>
<ul>
<li><strong>所有用户输入的路径必须使用 <code>safeJoin</code> 检查</strong></li>
<li>包括：文件上传、下载、静态文件服务等</li>
<li>这是防止路径穿越的最核心方法</li>
</ul>
<hr/>
<h3 data-id="heading-31">2.4 URL 与路径互转（ESM 模块必备）</h3>
<p><strong>💡 问题背景</strong></p>
<p>在 <code>type: module</code> 的 ESM 项目中，<code>__dirname</code> 和 <code>__filename</code> 不可用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ ESM 模块中会报错</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(__dirname);  <span class="hljs-comment">// ReferenceError: __dirname is not defined</span>
</code></pre>
<p><strong>✅ 解决方案</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>;

<span class="hljs-comment">// 将当前模块的 URL 转为文件路径</span>
<span class="hljs-keyword">const</span> __filename = <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>);
<span class="hljs-keyword">const</span> __dirname = path.<span class="hljs-title function_">dirname</span>(__filename);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(__dirname);  <span class="hljs-comment">// '/Users/me/project/src'</span>

<span class="hljs-comment">// 现在可以定位项目文件了</span>
<span class="hljs-keyword">const</span> configPath = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'../config/app.json'</span>);
</code></pre>
<hr/>
<h2 data-id="heading-32">三、速查清单</h2>
<h3 data-id="heading-33">fs 模块常用 API</h3>











































































<table><thead><tr><th>功能</th><th>推荐 API</th><th>说明</th></tr></thead><tbody><tr><td>读小文件</td><td><code>readFile(path, 'utf8')</code></td><td>&lt; 10MB</td></tr><tr><td>写小文件</td><td><code>writeFile(path, data)</code></td><td>覆盖写</td></tr><tr><td>追加内容</td><td><code>appendFile(path, data)</code></td><td>日志场景</td></tr><tr><td>读大文件</td><td><code>createReadStream(path)</code> + <code>pipeline</code></td><td>&gt; 10MB</td></tr><tr><td>写大文件</td><td><code>createWriteStream(path)</code> + <code>pipeline</code></td><td>&gt; 10MB</td></tr><tr><td>创建目录</td><td><code>mkdir(path, { recursive: true })</code></td><td>多级目录</td></tr><tr><td>读取目录</td><td><code>readdir(path, { withFileTypes: true })</code></td><td>获取类型</td></tr><tr><td>复制文件</td><td><code>copyFile(src, dest)</code></td><td/></tr><tr><td>移动/重命名</td><td><code>rename(old, new)</code></td><td/></tr><tr><td>删除文件</td><td><code>rm(path, { force: true })</code></td><td/></tr><tr><td>删除目录</td><td><code>rm(path, { recursive: true })</code></td><td>危险操作</td></tr><tr><td>获取信息</td><td><code>stat(path)</code></td><td>大小、时间等</td></tr><tr><td>检查权限</td><td><code>access(path, constants.R_OK)</code></td><td/></tr></tbody></table>
<h3 data-id="heading-34">path 模块常用 API</h3>


















































<table><thead><tr><th>功能</th><th>推荐 API</th><th>示例</th></tr></thead><tbody><tr><td>拼接路径</td><td><code>path.join(a, b, c)</code></td><td><code>'a/b/c'</code></td></tr><tr><td>绝对路径</td><td><code>path.resolve(a, b)</code></td><td><code>/abs/path/a/b</code></td></tr><tr><td>提取目录</td><td><code>path.dirname(p)</code></td><td><code>'/a/b'</code></td></tr><tr><td>提取文件名</td><td><code>path.basename(p)</code></td><td><code>'file.txt'</code></td></tr><tr><td>提取扩展名</td><td><code>path.extname(p)</code></td><td><code>'.txt'</code></td></tr><tr><td>计算相对路径</td><td><code>path.relative(from, to)</code></td><td><code>'../other'</code></td></tr><tr><td>拆解路径</td><td><code>path.parse(p)</code></td><td>返回对象</td></tr><tr><td>组装路径</td><td><code>path.format(obj)</code></td><td>返回字符串</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-35">四、最佳实践总结</h2>
<h3 data-id="heading-36">✅ 推荐做法</h3>
<ol>
<li><strong>异步优先</strong>：使用 <code>fs.promises</code>，避免同步方法（除了程序启动时）</li>
<li><strong>路径安全</strong>：用 <code>path.join/resolve</code> 拼接，禁止字符串拼接</li>
<li><strong>原子写入</strong>：重要文件用"临时文件 + rename"模式</li>
<li><strong>流式处理</strong>：大文件（&gt; 10MB）必须用 Stream + <code>pipeline</code></li>
<li><strong>并发控制</strong>：批量操作限制并发数（10-50）</li>
<li><strong>安全检查</strong>：用户输入路径必须用 <code>safeJoin</code> 验证</li>
<li><strong>错误处理</strong>：根据 <code>err.code</code> 提供友好提示</li>
</ol>
<h3 data-id="heading-37">❌ 禁止做法</h3>
<ol>
<li>❌ 在服务器代码中使用同步方法（<code>readFileSync</code> 等）</li>
<li>❌ 字符串拼接路径：<code>root + '/' + file</code></li>
<li>❌ 用 <code>readFile</code> 读取大文件（内存溢出）</li>
<li>❌ 手写流处理逻辑（用 <code>pipeline</code>）</li>
<li>❌ 批量操作不限制并发（资源耗尽）</li>
<li>❌ 直接使用用户输入的路径（安全漏洞）</li>
<li>❌ 忽略错误码（用户体验差）</li>
</ol>
<hr/>
<h2 data-id="heading-38">五、学习路线建议</h2>
<p><strong>第一步：基础练习</strong>（1-2 天）</p>
<ul>
<li>读写配置文件（JSON）</li>
<li>遍历目录并统计文件数量</li>
<li>练习 <code>path.join</code> 和 <code>path.resolve</code></li>
</ul>
<p><strong>第二步：进阶实战</strong>（3-5 天）</p>
<ul>
<li>实现原子写入函数</li>
<li>用流复制大文件</li>
<li>实现批量图片处理（带并发控制）</li>
</ul>
<p><strong>第三步：安全加固</strong>（2-3 天）</p>
<ul>
<li>实现 <code>safeJoin</code> 函数</li>
<li>完善错误处理</li>
<li>学习文件权限控制</li>
</ul>
<p><strong>第四步：项目实践</strong></p>
<ul>
<li>在项目中创建 <code>utils/fs.js</code> 工具模块</li>
<li>封装常用函数：<code>safeJoin</code>、<code>atomicWrite</code>、<code>concurrentPool</code></li>
<li>统一项目的文件操作规范</li>
</ul>
<hr/>
<h2 data-id="heading-39">六、常见问题 FAQ</h2>
<p><strong>Q1：什么时候可以用同步方法？</strong></p>
<p>A：只有以下两种情况：</p>
<ul>
<li>程序启动时读取配置（只执行一次）</li>
<li>简单的命令行工具脚本</li>
</ul>
<p>其他情况（特别是服务器环境）必须用异步方法。</p>
<hr/>
<p><strong>Q2：如何判断应该用流还是 readFile？</strong></p>
<p>A：看文件大小：</p>
<ul>
<li>&lt; 10MB：用 <code>readFile/writeFile</code></li>
<li>&gt; 10MB：用 <code>createReadStream/createWriteStream</code></li>
<li>不确定大小：用流更安全</li>
</ul>
<hr/>
<p><strong>Q3：删除目录时 rm 和 unlink 有什么区别？</strong></p>
<p>A：</p>
<ul>
<li><code>unlink</code>：只能删除文件</li>
<li><code>rm</code>：可以删除文件和目录，支持 <code>recursive</code> 选项</li>
</ul>
<p>推荐统一使用 <code>rm</code>（加 <code>force: true</code> 避免报错）。</p>
<hr/>
<p><strong>Q4：path.join 和 path.resolve 有什么区别？</strong></p>
<p>A：</p>
<ul>
<li><code>path.join</code>：简单拼接，不保证返回绝对路径</li>
<li><code>path.resolve</code>：解析为绝对路径，基于当前工作目录</li>
</ul>
<p>项目内定位文件推荐用 <code>resolve</code>。</p>
<hr/>
<p><strong>Q5：如何在 ESM 模块中获取 __dirname？</strong></p>
<p>A：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>;

<span class="hljs-keyword">const</span> __filename = <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>);
<span class="hljs-keyword">const</span> __dirname = path.<span class="hljs-title function_">dirname</span>(__filename);
</code></pre>
<hr/>
<blockquote>
<p>🎉 恭喜！你已经掌握了 Node.js 文件系统操作的核心知识。</p>
<p>💡 建议：将本文中的 <code>safeJoin</code>、<code>atomicWrite</code>、<code>concurrentPool</code> 等函数保存到你的代码片段库，方便随时使用！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>