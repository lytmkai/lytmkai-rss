<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[开源工具新玩法：cpolar提升Penpot协作流畅度]]></title>    <link>https://juejin.cn/post/7587342120022278195</link>    <guid>https://juejin.cn/post/7587342120022278195</guid>    <pubDate>2025-12-25T05:42:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587342120022278195" data-draft-id="7587355990409166899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开源工具新玩法：cpolar提升Penpot协作流畅度"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-25T05:42:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金者阿豪"/> <meta itemprop="url" content="https://juejin.cn/user/4073055974333608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开源工具新玩法：cpolar提升Penpot协作流畅度
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4073055974333608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金者阿豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T05:42:25.000Z" title="Thu Dec 25 2025 05:42:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>@[toc]</p>
<h2 data-id="heading-0">前言</h2>
<p>你是否也曾因商业设计软件的高昂费用而放弃团队协作？或者，想和异地朋友一起做设计，却找不到免费好用的协作工具？其实，用 Penpot+cpolar，你不需要花一分钱，也能拥有功能强大的设计协作平台，让创意不受距离限制，团队协作像在同一个房间一样自然。</p>
<p>Penpot 是一款能让设计师 “自由创作” 的开源设计工具，它就像你的 “云端设计工作室”，支持 UI/UX 设计、原型制作和团队协作，功能完全不输收费软件，而且文件格式开放，不用担心格式锁定。但很多人不知道，配合 cpolar，你可以把这个 “工作室” 变成 “全球创意空间”，不管你和团队成员在哪里，都能实时共同编辑设计稿，即时反馈修改意见。自由设计师小王用这个方法后，合作范围大大扩展：“我现在能和国外的设计师一起工作，实时修改设计稿，沟通效率比以前用邮件来回发送文件高太多了！”</p>
<p>为什么这个组合能带来设计协作革命？打个比方，Penpot 就像一张 “无限大的数字画布”，所有设计师都能在上面画画。cpolar 相当于给这张画布配了 “全球投影功能”，让世界各地的人都能看到并添加自己的创意。整个过程不需要你懂任何代码，注册账号即可开始协作 —— 比使用普通设计软件还简单！</p>
<p>接下来，我们就来手把手教你如何用 Penpot 进行协同设计，如何通过 cpolar 实现远程访问。全程都是图形界面操作，没有难懂的技术术语，保证你一看就会，让设计协作从 “格式障碍” 变成 “创意碰撞”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71029630afa7482cb81df559209aa259~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=C9tEqOpMuAhkfPsjp13s%2BIRCgxw%3D" alt="6bbf7780b5e9a4ea4135874576ea2b1.png" loading="lazy"/></p>
<h2 data-id="heading-1">1. 安装Docker</h2>
<p>本教程操作环境为Linux Ubuntu系统，在开始之前，我们需要先安装Docker与docker-compose。</p>
<p>在终端中执行下方命令安装docker：</p>
<pre><code class="hljs language-arduino" lang="arduino">sudo curl -fsSL https:<span class="hljs-comment">//github.com/tech-shrimp/docker_installer/releases/download/latest/linux.sh| bash -s docker --mirror Aliyun</span>
</code></pre>
<p>如果上边命令中访问不了Github，可以使用Gitee的链接：</p>
<pre><code class="hljs language-arduino" lang="arduino">sudo curl -fsSL https:<span class="hljs-comment">//gitee.com/tech-shrimp/docker_installer/releases/download/latest/linux.sh| bash -s docker --mirror Aliyun</span>
</code></pre>
<p>然后启动Docker</p>
<pre><code class="hljs language-sql" lang="sql">sudo systemctl <span class="hljs-keyword">start</span> docker
</code></pre>
<h2 data-id="heading-2">2. Docker镜像源添加方法</h2>
<p>如因网络问题拉取不到镜像，</p>
<p>可尝试在终端执行 <code>sudo nano /etc/docker/daemon.json</code></p>
<p>输入：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
<span class="hljs-attr">"registry-mirrors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
<span class="hljs-string">"https://do.nark.eu.org"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://dc.j8.work"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://docker.m.daocloud.io"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://dockerproxy.com"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://docker.mirrors.ustc.edu.cn"</span><span class="hljs-punctuation">,</span>
<span class="hljs-string">"https://docker.nju.edu.cn"</span>
<span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>保存退出</p>
<p>然后执行：<code>sudo systemctl restart docker</code></p>
<h2 data-id="heading-3">3. 创建并启动Penpot容器</h2>
<p>成功拉取 Piwigo 镜像后，我们在Home目录下的docker路径新增该项目目录</p>
<pre><code class="hljs language-arduino" lang="arduino">mkdir penpot
</code></pre>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> penpot
</code></pre>
<p>然后在该项目中创建<strong>docker-compose.yml</strong></p>
<pre><code class="hljs">nano docker-compose.yml
</code></pre>
<p>输入下方代码并保存退出：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.8"</span>
<span class="hljs-string">​</span>
<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">penpot:</span>
<span class="hljs-string">​</span>
<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">penpot_postgres_v15:</span>
  <span class="hljs-attr">penpot_assets:</span>
  <span class="hljs-comment"># penpot_traefik:</span>
  <span class="hljs-comment"># penpot_minio:</span>
<span class="hljs-string">​</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-comment">## Traefik service declaration example. Consider using it if you are going to expose</span>
  <span class="hljs-comment">## penpot to the internet or different host than `localhost`.</span>
<span class="hljs-string">​</span>
  <span class="hljs-comment"># traefik:</span>
  <span class="hljs-comment">#   image: traefik:v2.9</span>
  <span class="hljs-comment">#   networks:</span>
  <span class="hljs-comment">#     - penpot</span>
  <span class="hljs-comment">#   command:</span>
  <span class="hljs-comment">#     - "--api.insecure=true"</span>
  <span class="hljs-comment">#     - "--entryPoints.web.address=:80"</span>
  <span class="hljs-comment">#     - "--providers.docker=true"</span>
  <span class="hljs-comment">#     - "--providers.docker.exposedbydefault=false"</span>
  <span class="hljs-comment">#     - "--entryPoints.websecure.address=:443"</span>
  <span class="hljs-comment">#     - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"</span>
  <span class="hljs-comment">#     - "--certificatesresolvers.letsencrypt.acme.email=&lt;EMAIL_ADDRESS&gt;"</span>
  <span class="hljs-comment">#     - "--certificatesresolvers.letsencrypt.acme.storage=/traefik/acme.json"</span>
  <span class="hljs-comment">#   volumes:</span>
  <span class="hljs-comment">#     - "penpot_traefik:/traefik"</span>
  <span class="hljs-comment">#     - "/var/run/docker.sock:/var/run/docker.sock"</span>
  <span class="hljs-comment">#   ports:</span>
  <span class="hljs-comment">#     - "80:80"</span>
  <span class="hljs-comment">#     - "443:443"</span>
<span class="hljs-string">​</span>
  <span class="hljs-attr">penpot-frontend:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">"penpotapp/frontend:latest"</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">9001</span><span class="hljs-string">:80</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot_assets:/opt/data/assets</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot-backend</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot-exporter</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"traefik.enable=true"</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## HTTP: example of labels for the case if you are going to expose penpot to the</span>
      <span class="hljs-comment">## internet using only HTTP (without HTTPS) with traefik</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment"># - "traefik.http.routers.penpot-http.entrypoints=web"</span>
      <span class="hljs-comment"># - "traefik.http.routers.penpot-http.rule=Host(`&lt;DOMAIN_NAME&gt;`)"</span>
      <span class="hljs-comment"># - "traefik.http.services.penpot-http.loadbalancer.server.port=80"</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## HTTPS: example of labels for the case if you are going to expose penpot to the</span>
      <span class="hljs-comment">## internet using with HTTPS using traefik</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment"># - "traefik.http.middlewares.http-redirect.redirectscheme.scheme=https"</span>
      <span class="hljs-comment"># - "traefik.http.middlewares.http-redirect.redirectscheme.permanent=true"</span>
      <span class="hljs-comment"># - "traefik.http.routers.penpot-http.entrypoints=web"</span>
      <span class="hljs-comment"># - "traefik.http.routers.penpot-http.rule=Host(`&lt;DOMAIN_NAME&gt;`)"</span>
      <span class="hljs-comment"># - "traefik.http.routers.penpot-http.middlewares=http-redirect"</span>
      <span class="hljs-comment"># - "traefik.http.routers.penpot-https.entrypoints=websecure"</span>
      <span class="hljs-comment"># - "traefik.http.routers.penpot-https.rule=Host(`&lt;DOMAIN_NAME&gt;`)"</span>
      <span class="hljs-comment"># - "traefik.http.services.penpot-https.loadbalancer.server.port=80"</span>
      <span class="hljs-comment"># - "traefik.http.routers.penpot-https.tls=true"</span>
      <span class="hljs-comment"># - "traefik.http.routers.penpot-https.tls.certresolver=letsencrypt"</span>
<span class="hljs-string">​</span>
    <span class="hljs-comment">## Configuration envronment variables for frontend the container. In this case this</span>
    <span class="hljs-comment">## container only needs the `PENPOT_FLAGS`. This environment variable is shared with</span>
    <span class="hljs-comment">## other services but not all flags are relevant to all services.</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-comment">## Relevant flags for frontend:</span>
      <span class="hljs-comment">## - demo-users</span>
      <span class="hljs-comment">## - login-with-github</span>
      <span class="hljs-comment">## - login-with-gitlab</span>
      <span class="hljs-comment">## - login-with-google</span>
      <span class="hljs-comment">## - login-with-ldap</span>
      <span class="hljs-comment">## - login-with-oidc</span>
      <span class="hljs-comment">## - login-with-password</span>
      <span class="hljs-comment">## - registration</span>
      <span class="hljs-comment">## - webhooks</span>
      <span class="hljs-comment">##</span>
      <span class="hljs-comment">## You can read more about all available flags on:</span>
      <span class="hljs-comment">## https://help.penpot.app/technical-guide/configuration/#advanced-configuration</span>
<span class="hljs-string">​</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_FLAGS=enable-registration</span> <span class="hljs-string">enable-login-with-password</span>
<span class="hljs-string">​</span>
  <span class="hljs-attr">penpot-backend:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">"penpotapp/backend:latest"</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot_assets:/opt/data/assets</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot-postgres</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot-redis</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot</span>
<span class="hljs-string">​</span>
    <span class="hljs-comment">## Configuration envronment variables for backend the</span>
    <span class="hljs-comment">## container.</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">environment:</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## Relevant flags for backend:</span>
      <span class="hljs-comment">## - demo-users</span>
      <span class="hljs-comment">## - email-verification</span>
      <span class="hljs-comment">## - log-emails</span>
      <span class="hljs-comment">## - log-invitation-tokens</span>
      <span class="hljs-comment">## - login-with-github</span>
      <span class="hljs-comment">## - login-with-gitlab</span>
      <span class="hljs-comment">## - login-with-google</span>
      <span class="hljs-comment">## - login-with-ldap</span>
      <span class="hljs-comment">## - login-with-oidc</span>
      <span class="hljs-comment">## - login-with-password</span>
      <span class="hljs-comment">## - registration</span>
      <span class="hljs-comment">## - secure-session-cookies</span>
      <span class="hljs-comment">## - smtp</span>
      <span class="hljs-comment">## - smtp-debug</span>
      <span class="hljs-comment">## - telemetry</span>
      <span class="hljs-comment">## - webhooks</span>
      <span class="hljs-comment">## - prepl-server</span>
      <span class="hljs-comment">##</span>
      <span class="hljs-comment">## You can read more about all available flags and other</span>
      <span class="hljs-comment">## environment variables for the backend here:</span>
      <span class="hljs-comment">## https://help.penpot.app/technical-guide/configuration/#advanced-configuration</span>
<span class="hljs-string">​</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_FLAGS=enable-registration</span> <span class="hljs-string">disable-secure-session-cookies</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## Penpot SECRET KEY. It serves as a master key from which other keys for subsystems</span>
      <span class="hljs-comment">## (eg http sessions, or invitations) are derived.</span>
      <span class="hljs-comment">##</span>
      <span class="hljs-comment">## If you leve it commented, all created sessions and invitations will</span>
      <span class="hljs-comment">## become invalid on container restart.</span>
      <span class="hljs-comment">##</span>
      <span class="hljs-comment">## If you going to uncomment this, we recommend use here a trully randomly generated</span>
      <span class="hljs-comment">## 512 bits base64 encoded string.  You can generate one with:</span>
      <span class="hljs-comment">##</span>
      <span class="hljs-comment">## python3 -c "import secrets; print(secrets.token_urlsafe(64))"</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment"># - PENPOT_SECRET_KEY=my-insecure-key</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## The PREPL host. Mainly used for external programatic access to penpot backend</span>
      <span class="hljs-comment">## (example: admin). By default it listen on `localhost` but if you are going to use</span>
      <span class="hljs-comment">## the `admin`, you will need to uncomment this and set the host to `0.0.0.0`.</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment"># - PENPOT_PREPL_HOST=0.0.0.0</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## Public URI. If you are going to expose this instance to the internet and use it</span>
      <span class="hljs-comment">## under different domain than 'localhost', you will need to adjust it to the final</span>
      <span class="hljs-comment">## domain.</span>
      <span class="hljs-comment">##</span>
      <span class="hljs-comment">## Consider using traefik and set the 'disable-secure-session-cookies' if you are</span>
      <span class="hljs-comment">## not going to serve penpot under HTTPS.</span>
<span class="hljs-string">​</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_PUBLIC_URI=http://localhost:9001</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## Database connection parameters. Don't touch them unless you are using custom</span>
      <span class="hljs-comment">## postgresql connection parameters.</span>
<span class="hljs-string">​</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_DATABASE_URI=postgresql://penpot-postgres/penpot</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_DATABASE_USERNAME=penpot</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_DATABASE_PASSWORD=penpot</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## Redis is used for the websockets notifications. Don't touch unless the redis</span>
      <span class="hljs-comment">## container has different parameters or different name.</span>
<span class="hljs-string">​</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_REDIS_URI=redis://penpot-redis/0</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## Default configuration for assets storage: using filesystem based with all files</span>
      <span class="hljs-comment">## stored in a docker volume.</span>
<span class="hljs-string">​</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_ASSETS_STORAGE_BACKEND=assets-fs</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_STORAGE_ASSETS_FS_DIRECTORY=/opt/data/assets</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## Also can be configured to to use a S3 compatible storage</span>
      <span class="hljs-comment">## service like MiniIO. Look below for minio service setup.</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment"># - AWS_ACCESS_KEY_ID=&lt;KEY_ID&gt;</span>
      <span class="hljs-comment"># - AWS_SECRET_ACCESS_KEY=&lt;ACCESS_KEY&gt;</span>
      <span class="hljs-comment"># - PENPOT_ASSETS_STORAGE_BACKEND=assets-s3</span>
      <span class="hljs-comment"># - PENPOT_STORAGE_ASSETS_S3_ENDPOINT=http://penpot-minio:9000</span>
      <span class="hljs-comment"># - PENPOT_STORAGE_ASSETS_S3_BUCKET=&lt;BUKET_NAME&gt;</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## Telemetry. When enabled, a periodical process will send anonymous data about this</span>
      <span class="hljs-comment">## instance. Telemetry data will enable us to learn on how the application is used,</span>
      <span class="hljs-comment">## based on real scenarios. If you want to help us, please leave it enabled. You can</span>
      <span class="hljs-comment">## audit what data we send with the code available on github</span>
<span class="hljs-string">​</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_TELEMETRY_ENABLED=true</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## Example SMTP/Email configuration. By default, emails are sent to the mailcatch</span>
      <span class="hljs-comment">## service, but for production usage is recommended to setup a real SMTP</span>
      <span class="hljs-comment">## provider. Emails are used to confirm user registrations &amp; invitations. Look below</span>
      <span class="hljs-comment">## how mailcatch service is configured.</span>
<span class="hljs-string">​</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_SMTP_DEFAULT_FROM=no-reply@example.com</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_SMTP_DEFAULT_REPLY_TO=no-reply@example.com</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_SMTP_HOST=penpot-mailcatch</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_SMTP_PORT=1025</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_SMTP_USERNAME=</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_SMTP_PASSWORD=</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_SMTP_TLS=false</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_SMTP_SSL=false</span>
<span class="hljs-string">​</span>
  <span class="hljs-attr">penpot-exporter:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">"penpotapp/exporter:latest"</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-comment"># Don't touch it; this uses internal docker network to</span>
      <span class="hljs-comment"># communicate with the frontend.</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_PUBLIC_URI=http://penpot-frontend</span>
<span class="hljs-string">​</span>
      <span class="hljs-comment">## Redis is used for the websockets notifications.</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PENPOT_REDIS_URI=redis://penpot-redis/0</span>
<span class="hljs-string">​</span>
  <span class="hljs-attr">penpot-postgres:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">"postgres:15"</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">stop_signal:</span> <span class="hljs-string">SIGINT</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot_postgres_v15:/var/lib/postgresql/data</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot</span>
<span class="hljs-string">​</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_INITDB_ARGS=--data-checksums</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_DB=penpot</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_USER=penpot</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_PASSWORD=penpot</span>
<span class="hljs-string">​</span>
  <span class="hljs-attr">penpot-redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot</span>
<span class="hljs-string">​</span>
  <span class="hljs-comment">## A mailcatch service, used as temporal SMTP server. You can access via HTTP to the</span>
  <span class="hljs-comment">## port 1080 for read all emails the penpot platform has sent. Should be only used as a</span>
  <span class="hljs-comment">## temporal solution meanwhile you don't have a real SMTP provider configured.</span>
<span class="hljs-string">​</span>
  <span class="hljs-attr">penpot-mailcatch:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">sj26/mailcatcher:latest</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">expose:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'1025'</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"1080:1080"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">penpot</span>
<span class="hljs-string">​</span>
  <span class="hljs-comment">## Example configuration of MiniIO (S3 compatible object storage service); If you don't</span>
  <span class="hljs-comment">## have preference, then just use filesystem, this is here just for the completeness.</span>
<span class="hljs-string">​</span>
  <span class="hljs-comment"># minio:</span>
  <span class="hljs-comment">#   image: "minio/minio:latest"</span>
  <span class="hljs-comment">#   command: minio server /mnt/data --console-address ":9001"</span>
  <span class="hljs-comment">#   restart: always</span>
  <span class="hljs-comment">#</span>
  <span class="hljs-comment">#   volumes:</span>
  <span class="hljs-comment">#     - "penpot_minio:/mnt/data"</span>
  <span class="hljs-comment">#</span>
  <span class="hljs-comment">#   environment:</span>
  <span class="hljs-comment">#     - MINIO_ROOT_USER=minioadmin</span>
  <span class="hljs-comment">#     - MINIO_ROOT_PASSWORD=minioadmin</span>
  <span class="hljs-comment">#</span>
  <span class="hljs-comment">#   ports:</span>
  <span class="hljs-comment">#     - 9000:9000</span>
  <span class="hljs-comment">#     - 9001:9001</span>
</code></pre>
<p>然后执行下方命令启动容器运行镜像：</p>
<pre><code class="hljs">sudo docker compose up -d
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f9015bfb1c54e94b7b7b854160cae93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=H5ftRPtsLor4dRrYUFunJpSQzzU%3D" alt="1456cf4ebfe7b8fc9e2da2a3fafa379.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6add5796c2a41388ead1173d89399ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=K60U52AnXNxAXapSmubtGSFi04E%3D" alt="f0d641d0b74a8cd670fafba5b91466d.png" loading="lazy"/></p>
<p>如需停止可以执行：</p>
<pre><code class="hljs">sudo docker-compose down
</code></pre>
<h2 data-id="heading-4">3. 本地使用Penpot进行创作</h2>
<p>接下来我们就可以通过任意浏览器进行访问测试，打开一个浏览器输入localhost:9001，可以看到进入到了Penpot的登录界面，注册一个用户名和密码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09d32341e0e54a8ea41acd0eebf9e0b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=A606tyFH2MQnat5SRjpIgqUBNaY%3D" alt="c64e3f393379fcca43711f377e6fbfd.png" loading="lazy"/></p>
<p>选择使用用途</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b6ddcfebdfd4c9cbde89b9476c600e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=ATx5KZR5BImxKHq5EyEdwQFw8dg%3D" alt="5e66b1c35d912ba519e478c9cd6a2ba.png" loading="lazy"/></p>
<p>然后进入到设计界面，可以自由创作了！</p>
<p>画板跟同类设计软件的画布功能差不多，并具有固定的边缘。你可以根据你的需要，选择一个特定的屏幕或打印用的尺寸。</p>
<ol start="0">
<li>创建画板：点击工具栏中 “移动” 箭头正下方的第一个方形图标。点击并拖动箭头来创建一个自定义尺寸的画板。你也可以在 “设计属性” 边栏选择包揽设备最常用分辨率和标准打印尺寸的预设模板。</li>
<li>选择和移动画板：点击画板的名称或没有图层的区域。当边框变成绿色时，代表着你选择成功了。一旦选择了，按住 “Shift” 键，然后点击并拖动画板来移动它。</li>
<li>设置画板为缩略图：选择一个画板并点击右键。在菜单上，选择 “设置为缩略图”。选定的画板将作为文件缩略图显示在仪表板的卡片上。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1aab8ae12a7427c9be3493cc1426fbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=MFbKTykEBXxFNi9AtJ0Nt%2BDddhE%3D" alt="9eda54e873c20803cffaefe016507b4.png" loading="lazy"/></p>
<p>目前我们在本机部署了 Penpot ，如果想团队协作多人使用，或者在异地其他设备使用的话就需要结合Cpolar内网穿透实现公网访问，免去了复杂得本地部署过程，只需要一个公网地址直接就可以进入到Penpot中。</p>
<p>接下来教大家如何安装Cpolar并且将 Penpot 实现公网访问。</p>
<h2 data-id="heading-5">4. 公网远程访问本地Penpot</h2>
<h3 data-id="heading-6">4.1 内网穿透工具安装</h3>
<p>下面是安装cpolar步骤：</p>
<blockquote>
<p>Cpolar官网地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2F" target="_blank" title="https://www.cpolar.com/" ref="nofollow noopener noreferrer">www.cpolar.com</a></p>
</blockquote>
<p>使用一键脚本安装命令</p>
<pre><code class="hljs language-arduino" lang="arduino">curl https:<span class="hljs-comment">//get.cpolar.sh | sudo sh</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdfd8c4fe30148548b236a698b052b8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=CsDsAxd9d1Gz1K%2FQUBqRHyk%2FdkU%3D" alt="image-20240801132238671" loading="lazy"/></p>
<p>安装完成后，执行下方命令查看cpolar服务状态：（如图所示即为正常启动）</p>
<pre><code class="hljs language-lua" lang="lua">sudo systemctl <span class="hljs-built_in">status</span> cpolar
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf674b4373d242279971cc068d0d0d3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=mh8LAWMueJWjqHtNq4DdwQd5Dbw%3D" alt="image.png" loading="lazy"/></p>
<p>Cpolar安装和成功启动服务后，在浏览器上输入ubuntu主机IP加9200端口即:【<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A9200%2F" target="_blank" title="http://localhost:9200/" ref="nofollow noopener noreferrer">http://localhost:9200</a>】访问Cpolar管理界面，使用Cpolar官网注册的账号登录,登录后即可看到cpolar web 配置界面,接下来在web 界面配置即可：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66e30f78344c405c868fb8ae13f01a05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=ndnSwujIvtfb4fbIX5Y3LXWZeMc%3D" alt="image-20240801133735424" loading="lazy"/></p>
<h3 data-id="heading-7">4.2 创建远程连接公网地址</h3>
<p>登录cpolar web UI管理界面后,点击左侧仪表盘的隧道管理——创建隧道：</p>
<ul>
<li>隧道名称：可自定义，本例使用了: Penpot 注意不要与已有的隧道名称重复</li>
<li>协议：http</li>
<li>本地地址：9001</li>
<li>域名类型：随机域名</li>
<li>地区：选择China Top</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43007a8b0bb44216be34cf45fb558e22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=JONLSDBCZ00zT6llvMI%2FiVJbCvs%3D" alt="bc5a79b121d5926248f10b382357fa4.png" loading="lazy"/></p>
<p>创建成功后,打开左侧在线隧道列表,可以看到刚刚通过创建隧道生成了两个公网地址，接下来就可以在其他电脑（异地）上，使用任意一个地址在浏览器中访问即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07b5d3c8737b44958131296b782ad423~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=Yv8XXmpEXDqVQO65WcKHwKRUY5A%3D" alt="fdbe39c89b79827b0b499bd2c923b36.png" loading="lazy"/></p>
<p>如下图所示，成功实现使用公网地址异地远程访问本地部署的Penpot设计创作平台！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03a0a4485b2941328855dc1447038c20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=wdtRSfio9PxLlwhju5A%2BxCNXE3s%3D" alt="1ea7631b693ec7e314fa1ddcd463af8.png" loading="lazy"/></p>
<p><strong>小结</strong></p>
<p>为了方便演示，我们在上边的操作过程中使用了cpolar生成的HTTP公网地址隧道，其公网地址是随机生成的。</p>
<p>这种随机地址的优势在于建立速度快，可以立即使用。然而，它的缺点是网址是随机生成，这个地址在24小时内会发生随机变化，更适合于临时使用。</p>
<p>如果有长期远程访问本地 Penpot设计创作平台或者其他本地部署的服务的需求，但又不想每天重新配置公网地址，还想地址好看又好记，那我推荐大家选择使用固定的二级子域名方式来远程访问。</p>
<h2 data-id="heading-8">5. 固定Penpot公网地址</h2>
<p>由于以上使用cpolar所创建的隧道使用的是随机公网地址，24小时内会随机变化，不利于长期远程访问。因此我们可以为其配置二级子域名，该地址为固定地址，不会随机变化【ps：cpolar.cn已备案】</p>
<blockquote>
<p>注意需要将cpolar套餐升级至基础套餐或以上，且每个套餐对应的带宽不一样。【cpolar.cn已备案】</p>
</blockquote>
<p>登录cpolar官网，点击左侧的预留，选择保留二级子域名，地区选择china vip top，然后设置一个二级子域名名称，填写备注信息，点击保留。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d07d759b65654404accd511eae6be22b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=5NJtCB%2BiDyXjUl0PLNf%2BeLDNk40%3D" alt="5980e39452113f042a10fbd5e5f6ee1.png" loading="lazy"/></p>
<p>保留成功后复制保留的二级子域名地址：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3ff1cecbca7482da04f02605b75764b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=VMr9iJPjI6OXQzZJzEKr0JhqIv0%3D" alt="f52abab3cd21228f4d4c99e548cf9df.png" loading="lazy"/></p>
<p>登录cpolar web UI管理界面，点击左侧仪表盘的隧道管理——隧道列表，找到所要配置的隧道，点击右侧的<code>编辑</code>。</p>
<p>修改隧道信息，将保留成功的二级子域名配置到隧道中</p>
<ul>
<li>域名类型：选择二级子域名</li>
<li>Sub Domain：填写保留成功的二级子域名</li>
<li>地区: China VIP</li>
</ul>
<p>点击<code>更新</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7d1c72b4855459da02911b392ff2242~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=9gXJeVrtpGIsEy4XhEkpdf%2FzEyA%3D" alt="4d52f1b1c68fa67c476d3c27db7b4a7.png" loading="lazy"/></p>
<p>更新完成后，打开在线隧道列表，此时可以看到随机的公网地址已经发生变化，地址名称也变成了保留和固定的二级子域名名称。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d989c81ab2342cbbd3493e03c204ea5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=W7451WKBYyawQYU1e1t8kOfQPF8%3D" alt="3b01868f42995a40725ed327b70ffcd.png" loading="lazy"/></p>
<p>最后，我们使用固定的公网地址访问 Penpot 界面可以看到访问成功，一个永久不会变化的远程访问方式即设置好了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63a3445c842646ce9af2a2a3cc781d2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246144&amp;x-signature=TuDhs2uRM6Fmr476pf%2Bosrm4Ymc%3D" alt="593a0b387964791fbf7c64ad4fafd89.png" loading="lazy"/></p>
<p>接下来就可以随时随地进行异地公网来使用Penpot创作平台了，把固定的公网地址分享给身边的人，方便团队协作，同时也大大提高了工作效率！自己用的话，无需云服务器，还可以实现异地其他设备登录！以上就是如何在本地安装Penpot的全部过程。</p>
<p>用 cpolar 让 Penpot 实现远程设计协作就是这么简单！三步轻松搞定：在电脑上安装 Penpot 并创建项目，邀请团队成员加入，运行 cpolar 生成远程访问链接。这个方法不仅免费开源，还能摆脱对商业软件的依赖，设计文件完全自己掌控。不管你是专业设计师还是设计爱好者，都能通过这个组合让创意自由流动，实现无边界协作。现在就试试吧，开启你的全球设计之旅！</p>
<p>本篇文章知识点来源<a href="#" title="#">cpolar官网</a></p>
<ol start="0">
<li>cpolar博客：配置二级子域名: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2Fblog%2Fconfigure-the-secondary-subdomain-name" target="_blank" title="https://www.cpolar.com/blog/configure-the-secondary-subdomain-name" ref="nofollow noopener noreferrer">www.cpolar.com/blog/config…</a></li>
<li>cpolar博客：配置自定义域名: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2Fblog%2Fconfigure-your-own-domain-name" target="_blank" title="https://www.cpolar.com/blog/configure-your-own-domain-name" ref="nofollow noopener noreferrer">www.cpolar.com/blog/config…</a></li>
<li>cpolar博客：配置固定TCP端口地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2Fblog%2Fconfigure-fixed-tcp-port-address" target="_blank" title="https://www.cpolar.com/blog/configure-fixed-tcp-port-address" ref="nofollow noopener noreferrer">www.cpolar.com/blog/config…</a></li>
<li>cpolar博客：配置固定FTP地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2Fblog%2Fconfigure-fixed-ftp-address" target="_blank" title="https://www.cpolar.com/blog/configure-fixed-ftp-address" ref="nofollow noopener noreferrer">www.cpolar.com/blog/config…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[27条作品涨粉77万？我用Coze破解了“藏经人”的流量密码]]></title>    <link>https://juejin.cn/post/7587398857537110079</link>    <guid>https://juejin.cn/post/7587398857537110079</guid>    <pubDate>2025-12-25T06:04:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587398857537110079" data-draft-id="7587313610696638491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="27条作品涨粉77万？我用Coze破解了“藏经人”的流量密码"/> <meta itemprop="keywords" content="Coze,AIGC,人工智能"/> <meta itemprop="datePublished" content="2025-12-25T06:04:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            27条作品涨粉77万？我用Coze破解了“藏经人”的流量密码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:04:00.000Z" title="Thu Dec 25 2025 06:04:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>大家好，我是小肥肠！最近藏经人风格的火柴人视频火得一塌糊涂，本期教程教你用 Coze + ComfyUI 搭建全自动视频工作流。输入主题，3分钟直出成品视频。想在这个高共鸣赛道分一杯羹的朋友，这篇干货千万别错过~</strong></p>
<h2 data-id="heading-0">1. 前言</h2>
<p>前两天刷视频的时候偶然刷到一个火柴人类型的视频，点赞互动不够数据不错，我进了他的主页发现真不得了。<strong>这位大佬仅仅发布了27个作品就斩获了77万粉丝！</strong></p>
<p>仔细分析发现，这类视频的核心逻辑其实就是：极简火柴人画面 + 高共鸣情感文案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59dd9f03397246408c15b7845cced2c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=6zVmPgFmJNryuyALxSrLwAxlBM4%3D" alt="" loading="lazy"/></p>
<p>既然逻辑清晰，实现起来就不难。我基于 <strong>Coze（扣子）花了半天时间实现</strong>了这套工作流，从文案生成到视频剪辑全自动化。先来看看最终跑出来的效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3f35b7b19444a88893838fb596fbcdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=hXU5KfbBfA65v3BJXIxKwIo%2BTU8%3D" alt="" loading="lazy"/></p>
<p>工作流操作方法很简单，只需要在开始节点输入必要参数，点击试【试运行】按钮。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/405d11824ccc4a23b13695810d50e8a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=1zYE2TgpjxIwCm22JaeFQYsVi1Q%3D" alt="" loading="lazy"/></p>
<p>等待几分钟后会获得剪映草稿地址，导入到剪映小助手创建草稿即可获得成品视频：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cd505b360824a7895674169d28d0407~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=h8%2BAIXayNey8vdk1sfa0U1ZAkQo%3D" alt="" loading="lazy"/></p>
<p>如果你也想做火柴人情感赛道视频，赶紧码住跟练，文末附送本文中的<strong>文生图和图生视频</strong>提示词哦~</p>
<h2 data-id="heading-1">2. 工作流实现</h2>
<p>复刻藏经人同款视频的完整工作流如下图，整体工作流并不复杂，接下来就带大家逐一拆解核心节点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239c91066807435c92dbb48797d6d28e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=B%2BY7I3fOpEwk2Tv8NiTV7qcl%2FJk%3D" alt="" loading="lazy"/></p>
<p><strong>开始节点：</strong> 下图中开始节点传入了四个参数，分别为type（可为豆包或banana对应两个生图模型），back_music(对应背景音乐)，input（对应视频主题），scm_api_key（对应配音插件所需要的key）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/950020bec74d4754927d8c2f3fa7d267~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=GJduTSt2e9SToqfaDcGkVV8enxc%3D" alt="" loading="lazy"/></p>
<p><strong>根据主题生成文案（</strong> <strong>大模型</strong> <strong>）：</strong> 开始节点后接大模型节点，这个节点的作用是基于开始节点输入的input主题生成视频文案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a423b4278c04b848b430221caec545b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=GzklDur7GQRNtFpQ%2FwH7QE8Jl0I%3D" alt="" loading="lazy"/></p>
<p>提示词编写思路：</p>
<pre><code class="hljs">根据用户输入的主题，围绕三段式结构来生成视频文案，三段式即开头抛出勾子，中间延续场景故事，末尾衍生人生哲理
</code></pre>
<p><strong>文案分段（</strong> <strong>大模型</strong> <strong>）：根据主题生成文案（大模型）</strong> 后还要接一个大模型节点，这个节点的作用是对前置节点产生的整段文案进行分段操作，最后输出文案列表。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd1d0fca09e9436ba3388f9bdf294847~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=ISMfNPNbzuXwQ%2BPW92EgflWvh6M%3D" alt="" loading="lazy"/></p>
<p><strong>提示词编写思路：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">接收一段纯文本故事作为输入，在内部先将其拆解为独立句子，然后按<span class="hljs-number">35</span>字视觉阈值重新打包，最终输出一个<span class="hljs-title class_">JSON</span>字符串列表。
</code></pre>
<p><strong>循环：文案分段（</strong> <strong>大模型</strong> <strong>）</strong> 节点后接循环节点，意为对产生的文案列表进行遍历处理，基于每个文案进行配音、文生图、图生视频操作，最后获得视频制作的基础素材，如音频列表、视频列表等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df9c3996605447ec93a280d8c70ee0ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=qQxbgWHmguH6SM4quka3zgT8HUY%3D" alt="" loading="lazy"/></p>
<p><strong>正文</strong> <strong>语音合成</strong> <strong>：</strong> 这个节点位于循环内部，它的作用是对每个文案进行配音操作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dc11d1e612142ef952fb4fd3f77c8cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=7V45RylyzVlZJxWiLsSKl1vVvYk%3D" alt="" loading="lazy"/></p>
<p><strong>get_audio_duration:正文</strong> <strong>语音合成</strong>节点后接<strong>get_audio_duration插件，</strong> 这个节点的作用是获取每段配音的时长以便后续将其有序放入到剪映草稿的轨道中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b71dcbbb913d45129cff0a34a11a8c6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=V73cSG8Q5TwO3DCtJW1HDQRuSAg%3D" alt="" loading="lazy"/></p>
<p><strong>生成配图/视频提示词（</strong> <strong>大模型</strong> <strong>）：</strong> 这个节点的作用是先基于<strong>根据主题生成文案（大模型）</strong> 节点提取文案的主题，围绕主题，紧扣循环传入的文案片段生成文生图和图生视频提示词。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df6e70b7b2504951b0abe76d9e8feae5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=WYepYwelVMB6S%2F4wT6DBEn4pbb8%3D" alt="" loading="lazy"/></p>
<p><strong>生图：生成配图/视频提示词（</strong> <strong>大模型</strong> <strong>）</strong> 节点后来到了生图步骤，本文的生图有两个方案，分别是基于香蕉模型（插件市场搜小肥肠即可找到）和coze内置的图像生成节点（基于Seedream4.0）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f415d733329f4933b441a82b2599fa79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=kfhLjcG8r9EXDxBfLsu4Scm0Iwk%3D" alt="" loading="lazy"/></p>
<p><strong>视频生成：</strong> 在本工作流中视频生成基于Running Hub，这是一个子工作流，里面的插件由我团队大佬研发。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8d921938f0947748b2c7e8516a82c33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=oRunmZabFxoGqTtf54mlFiCh6c8%3D" alt="" loading="lazy"/></p>
<p>Running Hub视频生成工作流如下，感兴趣的可以看看我的另外一篇文章：<a href="https://juejin.cn/post/7539938717806575662" target="_blank" title="https://juejin.cn/post/7539938717806575662">Coze+ComfyUI 实战：视频制作成本降10 倍，高质量成片这么做</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ba750a64c2040f8bd2790e44d061e58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=mrr6WgM2F1u7q1Hv068c6JXlF5g%3D" alt="" loading="lazy"/></p>
<p><strong>数据组装：</strong> 循环节点出来后需要接代码节点，对循环节点生成出来的视频素材进行组装，最后输出为适配剪映小助手插件的数据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee6822cb3e5f46f58d77ac71a1aaf0bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=D8PryFHUpgnUgIT%2FAgvJA3lcPkE%3D" alt="" loading="lazy"/></p>
<p><strong>添加素材到剪映：</strong> 素材组装完毕后基于剪映小助手插件依次添加到轨道即可，下图的节点进行了草稿创建，添加人声配音、添加背景音乐、添加视频片段、添加字幕、保存草稿的操作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26327e04636a47c28629c64594a4ed98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=vJVw8cJ0BY%2BI93MYSd1H%2FyAPqdQ%3D" alt="" loading="lazy"/></p>
<p><strong>结束：</strong> 结束节点接收的是save_draft节点输出的草稿地址，我们只需要将草稿地址导入到剪映小助手即可获取成品视频。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1713366b4bec4e27aaddb4f2d30c80e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=Zp0STJJLv4f4Vr7KtH4BeU8eD8Y%3D" alt="" loading="lazy"/></p>
<p>以上就是整个工作流的完整流程拆解，动手能力强的读者可以跟着教程实践一遍。<strong>上述工作流已经被收录到了小肥肠共学群中，如果想直接获取工作流原件，可以加入社群后我拉你进空间直接学习使用。</strong></p>
<h2 data-id="heading-2">3. 结语</h2>
<p>技术在进步，创作的门槛在不断降低。像“藏经人”这样依靠情感共鸣突围的账号，其核心壁垒从来不是剪辑技术，而是对人性的洞察。今天分享的这套Coze工作流，其本质是帮大家<strong>抹平技术与制作的时间差</strong>，让你能把更多精力聚焦在文案打磨和选题策划上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7b21861d8a543a792bfc2bd6d421a58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767247440&amp;x-signature=Lk0XbWzklcc5ljNoz%2BEOEkZhx8I%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[若依工作流集成camunda实现审批驳回功能]]></title>    <link>https://juejin.cn/post/7587335187073728538</link>    <guid>https://juejin.cn/post/7587335187073728538</guid>    <pubDate>2025-12-25T06:14:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587335187073728538" data-draft-id="7587355990409281587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="若依工作流集成camunda实现审批驳回功能"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-25T06:14:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码次位面"/> <meta itemprop="url" content="https://juejin.cn/user/1535333867720295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            若依工作流集成camunda实现审批驳回功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535333867720295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码次位面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:14:42.000Z" title="Thu Dec 25 2025 06:14:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>驳回是指审批人或司法机关对提交的申请或请求进行审查后，认为其不符合要求或无法成立，从而作出的<strong>不予同意、拒绝其通过</strong>的决定，该决定通常会导致流程回退或申请被否定。</p>
</blockquote>
<p>演示地址<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruoyiflow.com%2Fdocumentation%2Fworkflow%2Freject" target="_blank" title="https://www.ruoyiflow.com/documentation/workflow/reject" ref="nofollow noopener noreferrer">ruoyiflow驳回功能演示</a></p>
<pre><code class="hljs language-text" lang="text">测试账号信息:
账号: ry
密码: ry2025

账号: ruo
密码: ry123456

账号: yi
密码: ry123456
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/546c5448ebd54fb986c0d807d2ce399e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767248081&amp;x-signature=UfYlQ1NYT%2B%2F0d%2BXn8wSW3cFokj4%3D" alt="bo1.png" loading="lazy"/></p>
<blockquote>
<p>以小依的账号登陆， 在我发起的菜单，提交一个请假申请</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07fdec3559d34592b3797685a1d60820~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767248081&amp;x-signature=K28FJOme8zYj4PjVRNgYt3FYZlw%3D" alt="bo2.png" loading="lazy"/></p>
<blockquote>
<p>此时审批了已经流转到admin管理员</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bc9933ce12a42d19c92dbdbbb076dbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767248081&amp;x-signature=xFGJMMD%2FIQWC4KEZ5lZ26ILCscM%3D" alt="bo3.png" loading="lazy"/></p>
<blockquote>
<p>审批人， admin登陆，将请假申请驳回，并给出驳回意见。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1e2de47a6d24ccf80732db51ace8b22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767248081&amp;x-signature=CQaiiITZJO5cjfnZGPHWB2xXBcY%3D" alt="bo5.png" loading="lazy"/></p>
<blockquote>
<p>审批人， admin登陆，将请假申请驳回，并给出驳回意见。审批时间线可以看到变化了</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4017bff631f4ef0bf9d4dd3f3d70458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767248081&amp;x-signature=2A4efdLJdwDEgEQXUH9b7zgCXtc%3D" alt="bo6.png" loading="lazy"/></p>
<blockquote>
<p>小依这个时候，可以作为发起人，重新进行修改，提交。</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruoyiflow.com" target="_blank" title="https://www.ruoyiflow.com" ref="nofollow noopener noreferrer">若依工作流</a>聚焦中国式审批流</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI工具"翻车"现场：为什么你学了那么多，还是用不好AI？]]></title>    <link>https://juejin.cn/post/7587342664078311439</link>    <guid>https://juejin.cn/post/7587342664078311439</guid>    <pubDate>2025-12-25T06:23:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587342664078311439" data-draft-id="7587334152870805544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI工具&quot;翻车&quot;现场：为什么你学了那么多，还是用不好AI？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-25T06:23:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="居然JuRan"/> <meta itemprop="url" content="https://juejin.cn/user/2524134427858205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI工具"翻车"现场：为什么你学了那么多，还是用不好AI？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134427858205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    居然JuRan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:23:28.000Z" title="Thu Dec 25 2025 06:23:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">当AI让死人"复活"创业：一场真实的翻车现场</h2>
<p>今天，我用AI查了个资料，结果差点被气笑了。</p>
<p>我想了解一下Anthropic这家公司（就是做Claude那家），于是问了某个国内知名的AI产品："Anthropic是一家怎样的公司，创立过程是怎样的？"</p>
<p>AI开始了"深度思考"，思考过程看起来很专业，我满心期待地等着答案。</p>
<p>然后，它告诉我：<strong>Anthropic的联合创始人之一是克劳德·香农（Claude Shannon）——那位信息论之父、提出香农定律、参与早期计算机研发的传奇人物。</strong></p>
<p>等等，我记得香农好像早就去世了啊？难道他老人家"诈尸"了，从坟墓里爬出来，穿越到2021年创办了一家AI公司？</p>
<p>我赶紧去百度核实，果然，<strong>香农在2001年就已经去世了。</strong></p>
<p>好家伙，AI不仅让死人"复活"了，还让他跨界创业搞AI。这脑洞，编剧都不敢这么写。</p>
<h2 data-id="heading-1">一错错一片：AI的"连环翻车"</h2>
<p>我以为错误到此为止了，结果AI还在继续表演。</p>
<p>我追问它："克劳德·香农不是早就死了吗，为什么被说成联合创始人了？"</p>
<p>AI再次开始"深度思考"，然后纠正说香农确实死于2001年2月16日。</p>
<p>但问题是，**我查了百度百科和维基百科，香农其实死于2月24日。**AI不仅让大师"复活"创业，还让他"少活了七八天"。</p>
<p>更离谱的是，AI还虚构了一个叫"Claude Staple"的人物，说他是Anthropic的CTO。我翻遍了官网，问了ChatGPT，确认这个人<strong>根本不存在</strong>——纯属AI瞎编。</p>
<p>**幸好我碰巧做过20年IT，对香农有点了解，才对AI的回答产生了怀疑。**如果我不了解这块内容，直接把它的结果拿来用，后果不堪设想。</p>
<p>这件事让我深刻意识到一个问题：<strong>核实AI给我的资料，比我自己查百度还要费劲。时间上一点也没节省，反而更浪费。</strong></p>
<h2 data-id="heading-2">演示很美好，现实很骨感</h2>
<p>这不是个例。</p>
<p>你有没有发现，那些AI博主演示的"生产力神器"，到了我们手里就变成了"废铜烂铁"？</p>
<p>在视频里，AI博主只需要输入一句话，PPT、商业计划、工作汇报就"刷刷刷"全自动生成出来了——排版精美，内容详实，三天的活儿五分钟搞定，下班走人。</p>
<p><strong>看完之后，你恨不得马上学会AI，不然就要被同行卷死、被职场淘汰。</strong></p>
<p>然而，当你照着步骤一步步操作时，你会惊讶地发现：<strong>AI生成的内容看似华美，实则空洞，根本无法和自己的工作结合。</strong></p>
<p>为什么会这样？</p>
<h2 data-id="heading-3">真相一：AI博主太年轻，没怎么上过班</h2>
<p>最可能的原因之一，是<strong>这些博主大多很年轻，缺乏实际工作经验。</strong></p>
<p>他们真的相信，用AI生成的PPT拿来就能用，能糊弄领导、糊弄客户。</p>
<p>但现实是：<strong>任何一个在职场摸爬滚打过的人都知道，一份商业方案、一个工作汇报，绝不是"排版精美+内容详实"就能过关的。</strong></p>
<p>客户要的是针对性解决方案，老板要的是可执行的计划，同事要的是有价值的信息——这些，AI生成不了。</p>
<p><strong>AI能生成的，只是一个"看起来像那么回事"的壳子。</strong></p>
<h2 data-id="heading-4">真相二：人是1，AI是0</h2>
<p>更深层次的原因是：<strong>大部分人把AI的位置摆错了。</strong></p>
<p>很多人认为，AI是"1"，人是后面的"0"——有了AI，人就能成倍放大。</p>
<p>但现实恰恰相反：<strong>人才是"1"，AI只是后面的"0"。</strong></p>
<p>举个例子：两个人分别代表A、B公司，他们都用AI辅助工作。当他们在一起沟通需求时，是两个人在沟通，还是人背后的AI在沟通？</p>
<p><strong>答案很明显：是人在沟通。</strong></p>
<p>这时候：</p>
<ul>
<li>
<p>**如果你本身业务能力强、技能储备多，AI越能帮到你。**它能把你这个"1"变成"10"、"100"、"10000"，成倍放大你的效能。</p>
</li>
<li>
<p>**如果你刚上班、工作经验少，太依赖AI，就相当于在"1"前面摆放"0"。**摆再多的"0"，结果还是"1"。</p>
</li>
</ul>
<p>比如，有些朋友原来就不会制作PPT，不懂PPT排版布局原理，也不会写商业计划方案。</p>
<p><strong>给你生成再精美的PPT也没用。</strong></p>
<p>因为：</p>
<ol>
<li>
<p><strong>你不会写方案，也就不会改AI生成的方案</strong>——一个字都改不动。</p>
</li>
<li>
<p><strong>你不会做PPT，也就不会改AI生成的PPT</strong>——只能照搬。</p>
</li>
</ol>
<p><strong>没有核心能力做支撑，AI只是一个"看起来很厉害"的玩具。</strong></p>
<h2 data-id="heading-5">真相三:AI的答案可能全是错的</h2>
<p>回到我和AI的那场对话。</p>
<p><strong>如果我不了解香农这个知识点，直接把AI的结果拿来用，会怎样？</strong></p>
<ul>
<li>
<p>发到网上，顶多被懂的人笑话，删了隐藏了也就罢了。</p>
</li>
<li>
<p>但如果在工作中不假思索地引用到商业方案里，<strong>被甲方懂行的人发现了，不仅会让甲方觉得你们公司不专业，取消合作，甚至单子丢了，老板还要把你开掉——一毛钱赔偿都没有，因为你失职了。</strong></p>
</li>
</ul>
<p>这时候，你能像AI一样，轻飘飘地说一句"是AI给错了答案"，把锅甩给AI吗？</p>
<p><strong>抱歉，可能没有机会了。</strong></p>
<p>我昨天写了一篇关于Manus和通义千问合作的分析文章，评论区有位网友从别处截屏了一篇文章，想证明我讲错了——说和通义千问合作的Manus是一家"荷兰芯片巨头公司"。</p>
<p><strong>这事明明错得离谱，但他就信了，信誓旦旦地拿来和我对质。</strong></p>
<p>这说明什么？**这个信息正好是他的知识盲区，但他就相信了。**这是不是很可怕？</p>
<h2 data-id="heading-6">AI的底层逻辑：垃圾进，垃圾出</h2>
<p>所有AI产品的背后，都有一个相同的逻辑：<strong>从互联网爬取内容，喂给它什么，它就吐出来什么。</strong></p>
<p><strong>一旦源头信息错了，后面就全错了。</strong></p>
<p>这就像人一样，吃了不干净的东西，好汉也架不住三泡稀。</p>
<p><strong>所以，判别AI信息的真假、对错，应用到工作生活里效果怎么样，最后都取决于你——你这个人。</strong></p>
<h2 data-id="heading-7">没有稳定的内核，AI帮不了你</h2>
<p>在你还不够强大以前，AI帮不了你。</p>
<p><strong>没有一个稳定的内核，会用多少AI工具并不会给你带来巨大的竞争优势，反而可能误导你，对自己、对别人产生很多错误的判断。</strong></p>
<p>所以，我们更应该把时间花在：</p>
<ul>
<li>
<p><strong>理解自己</strong>——知道自己的优势和短板在哪里</p>
</li>
<li>
<p><strong>包容自己</strong>——接受自己的不足，但不放弃成长</p>
</li>
<li>
<p><strong>锻炼自己</strong>——持续提升专业能力和判断力</p>
</li>
<li>
<p><strong>提升自己</strong>——让自己变成一个更有价值的"1"</p>
</li>
<li>
<p><strong>等待自己</strong>——给自己时间，慢慢变强</p>
</li>
</ul>
<p><strong>而不是把命运拱手交给一台黑盒子机器。</strong></p>
<h2 data-id="heading-8">写在最后</h2>
<p>AI是工具，不是救命稻草。</p>
<p><strong>它能放大你的能力，但无法替代你的能力。</strong></p>
<p>如果你本身就很强，AI能让你如虎添翼；如果你本身就弱，AI只会让你更依赖，甚至被误导。</p>
<p><strong>所以，与其焦虑"不学AI就要被淘汰"，不如先问问自己：我的核心能力是什么？我能为别人创造什么价值？</strong></p>
<p>当你成为一个有价值的"1"时，AI才能成为你后面的那些"0"。</p>
<p>否则，再多的"0"也还是"1"。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试和算法：常见面试题实现与深度解析]]></title>    <link>https://juejin.cn/post/7587368168623030278</link>    <guid>https://juejin.cn/post/7587368168623030278</guid>    <pubDate>2025-12-25T06:24:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587368168623030278" data-draft-id="7587412021710045190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试和算法：常见面试题实现与深度解析"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-12-25T06:24:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Fronty"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试和算法：常见面试题实现与深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Fronty
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:24:03.000Z" title="Thu Dec 25 2025 06:24:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文将深入探讨前端面试中常见的算法和编程题，提供多种实现方案和性能优化策略，帮助大家全面掌握核心面试技能。</p>
<h4 data-id="heading-0">1. 函数柯里化(Currying)</h4>
<h5 data-id="heading-1">1.1 基础柯里化实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 基础柯里化函数
 * 将多参数函数转换为一系列单参数函数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">curry</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">curried</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// 如果参数数量足够, 直接执行原函数</span>
    <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> &gt;= fn.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    }
    <span class="hljs-comment">// 否则返回一个新函数, 继续收集参数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...nextArgs</span>) {
      <span class="hljs-keyword">return</span> curried.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args.<span class="hljs-title function_">concat</span>(nextArgs));
    };
  };
}
<span class="hljs-comment">// 示例：加法函数柯里化</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b, c</span>) {
  <span class="hljs-keyword">return</span> a + b + c;
}

<span class="hljs-keyword">const</span> curriedAdd = <span class="hljs-title function_">curry</span>(add);

<span class="hljs-comment">// 测试</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>)(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedAdd</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
</code></pre>
<h5 data-id="heading-2">1.2 高级柯里化实现(支持占位符)</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 高级柯里化函数, 支持占位符
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">advancedCurry</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">curried</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// 检查参数是否足够且没有占位符</span>
    <span class="hljs-keyword">const</span> complete =
      args.<span class="hljs-property">length</span> &gt;= fn.<span class="hljs-property">length</span> &amp;&amp;
      !args.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, fn.<span class="hljs-property">length</span>).<span class="hljs-title function_">includes</span>(advancedCurry.<span class="hljs-property">placeholder</span>);
    <span class="hljs-keyword">if</span> (complete) {
      <span class="hljs-keyword">return</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...nextArgs</span>) {
      <span class="hljs-comment">// 替换占位符</span>
      <span class="hljs-keyword">const</span> combinedArgs = args
        .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">arg</span>) =&gt;</span>
          arg === advancedCurry.<span class="hljs-property">placeholder</span> &amp;&amp; nextArgs.<span class="hljs-property">length</span>
            ? nextArgs.<span class="hljs-title function_">shift</span>()
            : arg
        )
        .<span class="hljs-title function_">concat</span>(nextArgs);

      <span class="hljs-keyword">return</span> curried.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, combinedArgs);
    };
  };
}

<span class="hljs-comment">// 定义占位符</span>
advancedCurry.<span class="hljs-property">placeholder</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"_"</span>);
<span class="hljs-comment">// 示例使用</span>
<span class="hljs-keyword">const</span> curriedMultiply = <span class="hljs-title function_">advancedCurry</span>(<span class="hljs-function">(<span class="hljs-params">a, b, c</span>) =&gt;</span> a * b * c);

<span class="hljs-keyword">const</span> _ = advancedCurry.<span class="hljs-property">placeholder</span>;

<span class="hljs-comment">// 测试</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedMultiply</span>(<span class="hljs-number">2</span>)(<span class="hljs-number">3</span>)(<span class="hljs-number">4</span>)); <span class="hljs-comment">// 24</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedMultiply</span>(_, <span class="hljs-number">3</span>)(<span class="hljs-number">2</span>)(<span class="hljs-number">4</span>)); <span class="hljs-comment">// 24</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">curriedMultiply</span>(<span class="hljs-number">2</span>, _, <span class="hljs-number">4</span>)(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 24</span>
</code></pre>
<h4 data-id="heading-3">2. 函数组合(Compose)</h4>
<h5 data-id="heading-4">2.1 基础函数组合</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">compose</span>(<span class="hljs-params">...fns</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) {
    <span class="hljs-keyword">return</span> fns.<span class="hljs-title function_">reduceRight</span>(<span class="hljs-function">(<span class="hljs-params">acc, fn</span>) =&gt;</span> <span class="hljs-title function_">fn</span>(acc), x);
  };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">pipe</span>(<span class="hljs-params">...fns</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">x</span>) {
    <span class="hljs-keyword">return</span> fns.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, fn</span>) =&gt;</span> <span class="hljs-title function_">fn</span>(acc), x);
  };
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">add1</span> = x =&gt; x + <span class="hljs-number">1</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">multiply2</span> = x =&gt; x * <span class="hljs-number">2</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">square</span> = x =&gt; x * x;

<span class="hljs-keyword">const</span> composed = <span class="hljs-title function_">compose</span>(square, multiply2, add1);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">composed</span>(<span class="hljs-number">2</span>)); <span class="hljs-comment">// 36</span>
</code></pre>
<h4 data-id="heading-5">3. 斐波那契数列优化</h4>
<h5 data-id="heading-6">3.1 多种实现对比</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 递归（性能差）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fibonacciRecursive</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> n;
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fibonacciRecursive</span>(n - <span class="hljs-number">1</span>) + <span class="hljs-title function_">fibonacciRecursive</span>(n - <span class="hljs-number">2</span>);
}

<span class="hljs-comment">// 2. 记忆化递归</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fibonacciMemo</span>(<span class="hljs-params">n, memo = {}</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> n;
  <span class="hljs-keyword">if</span> (memo[n]) <span class="hljs-keyword">return</span> memo[n];
  memo[n] = <span class="hljs-title function_">fibonacciMemo</span>(n - <span class="hljs-number">1</span>, memo) + <span class="hljs-title function_">fibonacciMemo</span>(n - <span class="hljs-number">2</span>, memo);
  <span class="hljs-keyword">return</span> memo[n];
}

<span class="hljs-comment">// 3. 动态规划</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fibonacciDP</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> n;
  <span class="hljs-keyword">const</span> dp = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">2</span>; i &lt;= n; i++) {
    dp[i] = dp[i - <span class="hljs-number">1</span>] + dp[i - <span class="hljs-number">2</span>];
  }
  <span class="hljs-keyword">return</span> dp[n];
}

<span class="hljs-comment">// 4. 空间优化</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fibonacciOptimized</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> n;
  <span class="hljs-keyword">let</span> prev = <span class="hljs-number">0</span>, curr = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">2</span>; i &lt;= n; i++) {
    <span class="hljs-keyword">const</span> next = prev + curr;
    prev = curr;
    curr = next;
  }
  <span class="hljs-keyword">return</span> curr;
}
</code></pre>
<h4 data-id="heading-7">4. 数组去重多种方法</h4>
<h5 data-id="heading-8">4.1 基础方法</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. Set</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueSet</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">return</span> [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(arr)];
}

<span class="hljs-comment">// 2. filter + indexOf</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueFilter</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> arr.<span class="hljs-title function_">indexOf</span>(item) === index);
}

<span class="hljs-comment">// 3. reduce</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueReduce</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, curr</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!acc.<span class="hljs-title function_">includes</span>(curr)) acc.<span class="hljs-title function_">push</span>(curr);
    <span class="hljs-keyword">return</span> acc;
  }, []);
}
</code></pre>
<h5 data-id="heading-9">4.2 复杂对象去重</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">uniqueComplex</span>(<span class="hljs-params">arr, keyFn</span>) {
  <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  <span class="hljs-keyword">const</span> result = [];
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-keyword">const</span> key = keyFn ? <span class="hljs-title function_">keyFn</span>(item) : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(item);
    <span class="hljs-keyword">if</span> (!seen.<span class="hljs-title function_">has</span>(key)) {
      seen.<span class="hljs-title function_">set</span>(key, <span class="hljs-literal">true</span>);
      result.<span class="hljs-title function_">push</span>(item);
    }
  }
  
  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span> }
];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">uniqueComplex</span>(users, <span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span>));
</code></pre>
<h4 data-id="heading-10">5. 深比较(DeepEqual)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deepEqual</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">if</span> (a === b) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  
  <span class="hljs-keyword">if</span> (a == <span class="hljs-literal">null</span> || b == <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> b !== <span class="hljs-string">'object'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(a) &amp;&amp; <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(b)) {
    <span class="hljs-keyword">if</span> (a.<span class="hljs-property">length</span> !== b.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; a.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">deepEqual</span>(a[i], b[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-keyword">const</span> keysA = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(a);
  <span class="hljs-keyword">const</span> keysB = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(b);
  
  <span class="hljs-keyword">if</span> (keysA.<span class="hljs-property">length</span> !== keysB.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">of</span> keysA) {
    <span class="hljs-keyword">if</span> (!keysB.<span class="hljs-title function_">includes</span>(key) || !<span class="hljs-title function_">deepEqual</span>(a[key], b[key])) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-11">6. 防抖与节流</h4>
<p><a href="https://juejin.cn/post/7579101504289554486" target="_blank" title="https://juejin.cn/post/7579101504289554486">防抖（Debounce）</a>
<a href="https://juejin.cn/post/7579123072825999379" target="_blank" title="https://juejin.cn/post/7579123072825999379">节流（Throttle）</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (timer) <span class="hljs-built_in">clearTimeout</span>(timer);
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), delay);
  };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">fn, interval</span>) {
  <span class="hljs-keyword">let</span> lastTime = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">if</span> (now - lastTime &gt;= interval) {
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      lastTime = now;
    }
  };
}
</code></pre>
<h4 data-id="heading-12">7. Promise实现</h4>
<p><a href="https://juejin.cn/post/7580208715275976746" target="_blank" title="https://juejin.cn/post/7580208715275976746">手写 Promise：深入理解 JavaScript 异步编程的核心</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">'pending'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">undefined</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">undefined</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = [];
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">'pending'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">'fulfilled'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>());
      }
    };
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">'pending'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">'rejected'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>());
      }
    };
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">executor</span>(resolve, reject);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title function_">reject</span>(error);
    }
  }
  
  <span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) {
    onFulfilled = <span class="hljs-keyword">typeof</span> onFulfilled === <span class="hljs-string">'function'</span> ? onFulfilled : <span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v;
    onRejected = <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">'function'</span> ? onRejected : <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> { <span class="hljs-keyword">throw</span> e };
    
    <span class="hljs-keyword">const</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFulfilled</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error);
          }
        });
      };
      
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRejected</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">reject</span>(error);
          }
        });
      };
      
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">'fulfilled'</span>) {
        <span class="hljs-title function_">handleFulfilled</span>();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">'rejected'</span>) {
        <span class="hljs-title function_">handleRejected</span>();
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">push</span>(handleFulfilled);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(handleRejected);
      }
    });
    
    <span class="hljs-keyword">return</span> promise2;
  }
  
  <span class="hljs-title function_">resolvePromise</span>(<span class="hljs-params">promise2, x, resolve, reject</span>) {
    <span class="hljs-keyword">if</span> (promise2 === x) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'循环引用'</span>));
    }
    
    <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;
    
    <span class="hljs-keyword">if</span> (x &amp;&amp; (<span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'function'</span>)) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> then = x.<span class="hljs-property">then</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> then === <span class="hljs-string">'function'</span>) {
          then.<span class="hljs-title function_">call</span>(
            x,
            <span class="hljs-function"><span class="hljs-params">y</span> =&gt;</span> {
              <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;
              called = <span class="hljs-literal">true</span>;
              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, y, resolve, reject);
            },
            <span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {
              <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;
              called = <span class="hljs-literal">true</span>;
              <span class="hljs-title function_">reject</span>(r);
            }
          );
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">resolve</span>(x);
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;
        called = <span class="hljs-literal">true</span>;
        <span class="hljs-title function_">reject</span>(error);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">resolve</span>(x);
    }
  }
  
  <span class="hljs-keyword">catch</span>(onRejected) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, onRejected);
  }
}
</code></pre>
<h4 data-id="heading-13">8. call、apply、bind实现</h4>
<p><a href="https://juejin.cn/post/7579066828179882020" target="_blank" title="https://juejin.cn/post/7579066828179882020">JavaScript 核心方法深度解析：手写 call、apply、bind 和 Object.create</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myCall</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">context = <span class="hljs-variable language_">window</span>, ...args</span>) {
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'fn'</span>);
  context[fnKey] = <span class="hljs-variable language_">this</span>;
  <span class="hljs-keyword">const</span> result = context[fnKey](...args);
  <span class="hljs-keyword">delete</span> context[fnKey];
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myApply</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">context = <span class="hljs-variable language_">window</span>, args = []</span>) {
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'fn'</span>);
  context[fnKey] = <span class="hljs-variable language_">this</span>;
  <span class="hljs-keyword">const</span> result = context[fnKey](...args);
  <span class="hljs-keyword">delete</span> context[fnKey];
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myBind</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">context = <span class="hljs-variable language_">window</span>, ...bindArgs</span>) {
  <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...callArgs</span>) {
    <span class="hljs-keyword">return</span> self.<span class="hljs-title function_">apply</span>(context, [...bindArgs, ...callArgs]);
  };
};
</code></pre>
<h4 data-id="heading-14">9. 事件总线（EventEmitter）</h4>
<p><a href="https://juejin.cn/post/7580389111921508415" target="_blank" title="https://juejin.cn/post/7580389111921508415">手写 EventEmitter：深入理解发布订阅模式</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EventEmitter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-title function_">on</span>(<span class="hljs-params">event, listener</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">has</span>(event)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">set</span>(event, []);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">get</span>(event).<span class="hljs-title function_">push</span>(listener);
  }
  
  <span class="hljs-title function_">off</span>(<span class="hljs-params">event, listener</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">has</span>(event)) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> listeners = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">get</span>(event);
    <span class="hljs-keyword">const</span> index = listeners.<span class="hljs-title function_">indexOf</span>(listener);
    <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) listeners.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
  }
  
  <span class="hljs-title function_">emit</span>(<span class="hljs-params">event, ...args</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">has</span>(event)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">get</span>(event).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> listener.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args));
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-title function_">once</span>(<span class="hljs-params">event, listener</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onceWrapper</span> = (<span class="hljs-params">...args</span>) =&gt; {
      listener.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(event, onceWrapper);
    };
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(event, onceWrapper);
  }
}
</code></pre>
<h4 data-id="heading-15">10. LRU缓存</h4>
<p><a href="https://juejin.cn/post/7582904081864507433" target="_blank" title="https://juejin.cn/post/7582904081864507433">JavaScript性能与优化：手写实现关键优化技术</a>
<a href="https://juejin.cn/post/7583727768543412260" target="_blank" title="https://juejin.cn/post/7583727768543412260">JavaScript 性能与优化：数据结构和算法</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LRUCache</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">capacity</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span> = capacity;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">has</span>(key)) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> value = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">get</span>(key);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(key);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">set</span>(key, value);
    <span class="hljs-keyword">return</span> value;
  }
  
  <span class="hljs-title function_">put</span>(<span class="hljs-params">key, value</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">has</span>(key)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(key);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">size</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">capacity</span>) {
      <span class="hljs-keyword">const</span> firstKey = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">delete</span>(firstKey);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">set</span>(key, value);
  }
}
</code></pre>
<h4 data-id="heading-16">11. 快速排序</h4>
<p><a href="https://juejin.cn/post/7581481178823770131" target="_blank" title="https://juejin.cn/post/7581481178823770131">JavaScript 数组原生方法手写实现</a>
<a href="https://juejin.cn/post/7583727768543412260" target="_blank" title="https://juejin.cn/post/7583727768543412260">JavaScript 性能与优化：数据结构和算法</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">quickSort</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">if</span> (arr.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> arr;
  
  <span class="hljs-keyword">const</span> pivotIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(arr.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>);
  <span class="hljs-keyword">const</span> pivot = arr[pivotIndex];
  <span class="hljs-keyword">const</span> left = [];
  <span class="hljs-keyword">const</span> right = [];
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">if</span> (i === pivotIndex) <span class="hljs-keyword">continue</span>;
    <span class="hljs-keyword">if</span> (arr[i] &lt; pivot) {
      left.<span class="hljs-title function_">push</span>(arr[i]);
    } <span class="hljs-keyword">else</span> {
      right.<span class="hljs-title function_">push</span>(arr[i]);
    }
  }
  
  <span class="hljs-keyword">return</span> [...<span class="hljs-title function_">quickSort</span>(left), pivot, ...<span class="hljs-title function_">quickSort</span>(right)];
}
</code></pre>
<h4 data-id="heading-17">12. 二分查找</h4>
<p><a href="https://juejin.cn/post/7583727768543412260" target="_blank" title="https://juejin.cn/post/7583727768543412260">JavaScript 性能与优化：数据结构和算法</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">binarySearch</span>(<span class="hljs-params">arr, target</span>) {
  <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>, right = arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
  
  <span class="hljs-keyword">while</span> (left &lt;= right) {
    <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left + right) / <span class="hljs-number">2</span>);
    <span class="hljs-keyword">if</span> (arr[mid] === target) <span class="hljs-keyword">return</span> mid;
    <span class="hljs-keyword">if</span> (arr[mid] &lt; target) {
      left = mid + <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
      right = mid - <span class="hljs-number">1</span>;
    }
  }
  
  <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}
</code></pre>
<h4 data-id="heading-18">总结</h4>
<p>本文涵盖了前端面试中常见的算法和编程题，包括函数柯里化、函数组合、斐波那契数列、数组去重、深比较、防抖节流、Promise实现等核心知识点。掌握这些内容有助于提升编程能力和面试表现。</p>
<p><strong>关键要点:</strong></p>
<ol>
<li><strong>函数柯里化:</strong> 理解函数式编程思想，掌握基础实现和高级功能</li>
<li><strong>函数组合:</strong> 学会构建可复用的函数管道，支持同步和异步操作</li>
<li><strong>算法优化:</strong> 掌握递归优化、动态规划、空间优化等技巧</li>
<li><strong>数据处理:</strong> 了解不同去重方法的适用场景和性能差异</li>
<li><strong>深度比较:</strong> 处理复杂对象的比较，包括循环引用和特殊类型</li>
<li><strong>异步控制:</strong> 实现防抖和节流，优化高频事件处理</li>
<li><strong>Promise实现:</strong> 深入理解异步编程模型</li>
<li><strong>原生方法实现:</strong> 掌握call、apply、bind的内部原理</li>
<li><strong>设计模式:</strong> 实现事件总线，理解发布-订阅模式</li>
</ol>
<p>这些知识点不仅是面试的常见考点，也是实际开发中的重要技能。建议大家不仅要理解代码实现，更要掌握背后的设计思想和适用场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[cursor 不让用 claude 模型？千万不要改 http1 ！这样设置才是正确操作！]]></title>    <link>https://juejin.cn/post/7587355990409429043</link>    <guid>https://juejin.cn/post/7587355990409429043</guid>    <pubDate>2025-12-25T06:20:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587355990409429043" data-draft-id="7587342120022425651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="cursor 不让用 claude 模型？千万不要改 http1 ！这样设置才是正确操作！"/> <meta itemprop="keywords" content="Cursor,Claude"/> <meta itemprop="datePublished" content="2025-12-25T06:20:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云一鹤"/> <meta itemprop="url" content="https://juejin.cn/user/729731452122382"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            cursor 不让用 claude 模型？千万不要改 http1 ！这样设置才是正确操作！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452122382/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云一鹤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:20:51.000Z" title="Thu Dec 25 2025 06:20:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">花钱还不给我用？</h2>
<p>这个锅 cursor 不背，实际是因为 claude 厂商的 xx 策略给咱限制了，导致在国内使用 claude 非常麻烦，但也不是没有办法，今天就来教大家如何在 cursor 使用 claude ！</p>
<p>我在 cursor 里选择 claude 模型，随便问一句话</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959a8a2e03094f4eb0d81d97bdc0aba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767248874&amp;x-signature=H5z3YHeSeS6YXIbtz3V87sAoJeg%3D" alt="1.png" loading="lazy"/></p>
<p>可以看到，它拒绝为我所在的地区提供服务，哪怕是我开了魔法也没用</p>
<h2 data-id="heading-1">修改 HTTP 协议 为 http1</h2>
<p>此时有两种解决方案，第一种许多人提及的修改 HTTP 协议 为 http1</p>
<p>操作步骤：点击右上角设置按钮 -&gt; 选择 Network -&gt; 选择 http/1.0 或者 http/1.1</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b935bb1bf574a578b63f1b4f52661f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767248874&amp;x-signature=b17pDyOEKjfoeQHUnq1mnl0yWw8%3D" alt="2.png" loading="lazy"/></p>
<p>我这里选择 http/1.0，更改后重启编辑器，然后再次发起提问</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78b82725d85c4dbc922de85d7d004817~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767248874&amp;x-signature=LWoGfffwdrAPKd4rq4eMinnwk%2FM%3D" alt="3.png" loading="lazy"/></p>
<p>可以看到，这一次它没有拒绝为我服务了</p>
<h2 data-id="heading-2">开启 TUN（虚拟网卡）模式</h2>
<p>上面这种方法用是可以用，不过有一个弊端，那就是一旦需求过于复杂，任务处理的时间过长时，就极容易断开链接，就像这样</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d0374a93e424a018d737e456828658b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767248874&amp;x-signature=96Di1Tx8JjhpdHrvQUPTiw86G5c%3D" alt="4.png" loading="lazy"/></p>
<p>token 消耗了，任务没有成功。钱也花了，事没办成。气煞我也！</p>
<p>那么问题来了，cursor 不开 http1.0 无法使用，开了又老是提示网络中断，咋搞啊到底？</p>
<p>现在就用到第二种方法，打开魔法工具的 <code>TUN（虚拟网卡）</code>模式</p>
<p>TUN（虚拟网卡）模式能接管系统所有流量（cursor 流量从魔法工具通过），所以能骗过 claude 服务商对于地区的检测</p>
<p>操作步骤：把 HTTP 协议还原成 http/2 -&gt; 然后开启魔法工具的 TUN（虚拟网卡）模式</p>
<p>因为一些众所周知的原因，不方便直接教人使用魔法工具，大家自行搜索关键词进行操作吧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis序列化与二次Json化]]></title>    <link>https://juejin.cn/post/7587428416127778854</link>    <guid>https://juejin.cn/post/7587428416127778854</guid>    <pubDate>2025-12-25T06:43:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587428416127778854" data-draft-id="7587325326046789641" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis序列化与二次Json化"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2025-12-25T06:43:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户696095092188"/> <meta itemprop="url" content="https://juejin.cn/user/2843813478142794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis序列化与二次Json化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2843813478142794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户696095092188
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:43:03.000Z" title="Thu Dec 25 2025 06:43:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><p><strong>注：以下代码示例以Google的Gson框架为例
其他框架如FastJson/Jackson可自行了解</strong></p>
<h2 data-id="heading-0">1. Redis 中的数据本质</h2>
<p>Redis 本身并不理解对象、JSON 或类型语义。
所谓“在 Redis 里存 JSON”，只是应用层的约定，不是 Redis 的能力。
它只做一件事：存储字节数组（byte[]）。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">key</span> -&gt; <span class="hljs-type">byte</span>[] value -&gt; <span class="hljs-type">byte</span>[]
</code></pre>
<p>在 Java 中，对象无法直接写入 Redis，必须经历：</p>
<pre><code class="hljs language-css" lang="css">Java <span class="hljs-selector-tag">Object</span> → 序列化（serialize） // toJson → byte<span class="hljs-selector-attr">[]</span> //getbytes() → Redis
</code></pre>
<p>读取时则是反向过程：</p>
<pre><code class="hljs language-css" lang="css">byte<span class="hljs-selector-attr">[]</span> → 反序列化（deserialize） → Java <span class="hljs-selector-tag">Object</span>
</code></pre>
<p>因此，序列化策略是 Java 客户端的职责，而不是 Redis 的职责。</p>
<p>问题几乎都出在：写入时用的序列化方式 ≠ 读取时用的反序列化方式。</p>
<hr/>
<h2 data-id="heading-1">2. 常见序列化方式对比</h2>
<h3 data-id="heading-2">序列化方式对比表</h3>








































<table><thead><tr><th/><th/><th/><th/><th/></tr></thead><tbody><tr><td>序列化方式</td><td>存储内容</td><td>可读性</td><td>兼容性</td><td>常见问题</td></tr><tr><td>JDK 原生序列化</td><td>二进制</td><td>差</td><td>极差（强依赖类结构）</td><td>类变更直接反序列化失败</td></tr><tr><td>JSON 序列化</td><td>JSON 字节</td><td>好</td><td>好</td><td>易出现二次 JSON 化</td></tr><tr><td>String 序列化</td><td>字符串字节</td><td>最好</td><td>取决于约定</td><td>需要自行维护类型</td></tr></tbody></table>
<p>JSON 序列化是最常见也是最容易踩坑的一种，原因不是 JSON 本身，而是职责混乱。</p>
<hr/>
<h3 data-id="heading-3">Jackson 的 Redis 序列化配置示例</h3>
<p>下面配置只是用于说明JSON 序列化在 Redis 中是如何接管 byte[] 的，后文代码示例仍然使用 Gson。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span> {
        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();
        template.setConnectionFactory(connectionFactory);

        <span class="hljs-comment">// Key 使用 String 序列化（保持可读性）</span>
        template.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        template.setHashKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());

        <span class="hljs-comment">// Value 使用 JSON 序列化（避免 JDK 序列化）</span>
        <span class="hljs-type">GenericJackson2JsonRedisSerializer</span> <span class="hljs-variable">jsonSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>();

        template.setValueSerializer(jsonSerializer);
        template.setHashValueSerializer(jsonSerializer);

        template.afterPropertiesSet();
        <span class="hljs-keyword">return</span> template;
    }
}
</code></pre>
<p>这个配置的关键点只有一句话：
RedisTemplate 已经负责“对象 ↔ JSON ↔ byte[]”的全部过程
如果你在写入前再手动 toJsonString，问题就埋下了。</p>
<hr/>
<h2 data-id="heading-4">3. 二次 JSON 化的典型成因</h2>
<h3 data-id="heading-5">什么是二次 JSON 化</h3>
<p>二次 JSON 化指的是：</p>
<p>对象 → JSON 字符串（第一次） → 再次 JSON 序列化（第二次） → Redis</p>
<p>最终 Redis 中存的不是对象的 JSON，而是JSON 字符串本身的 JSON 表示。</p>
<hr/>
<h3 data-id="heading-6">典型错误写法（Gson 示例）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>();
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">1L</span>, <span class="hljs-string">"Alice"</span>); <span class="hljs-comment">// 第一次 JSON 化（手动） </span>
<span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> gson.toJson(user); <span class="hljs-comment">// 第二次 JSON 化（Redis 序列化器） redisTemplate.opsForValue().set("user:1", json);</span>
</code></pre>
<p>如果 RedisTemplate 的 value 序列化器是 JSON（Jackson 或 Gson），
那么 json 会被当作一个普通 String 再序列化一次。</p>
<hr/>
<h3 data-id="heading-7">Redis 中的实际存储结果</h3>
<p>期望存的是：</p>
<pre><code class="hljs language-java" lang="java">{<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">"Alice"</span>} <span class="hljs-comment">//Object </span>
<span class="hljs-number">100</span> <span class="hljs-comment">//Integer </span>
<span class="hljs-literal">true</span> <span class="hljs-comment">//Boolean </span>
hello <span class="hljs-comment">//String   但是你在java中得String s = "hello"</span>
<span class="hljs-comment">//这里不要混淆 一般来讲，正常存储到redis的数据一般是不会带两侧的""的</span>
</code></pre>
<p>实际存的是：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-string">"{"</span>id<span class="hljs-string">":1,"</span>name<span class="hljs-string">":"</span>Alice<span class="hljs-string">"}"</span> <span class="hljs-comment">//String</span>
<span class="hljs-string">"100"</span> <span class="hljs-comment">//String </span>
<span class="hljs-string">"true"</span> <span class="hljs-comment">//String</span>
<span class="hljs-string">"hello"</span> <span class="hljs-comment">//String</span>
</code></pre>
<p>特征非常明显：</p>
<ul>
<li>最外层多了一层引号</li>
<li>内部充满转义字符</li>
<li>语义已经从「对象」变成了「字符串」</li>
</ul>
<hr/>
<h3 data-id="heading-8">另一种高频成因：模板混用</h3>
<pre><code class="hljs language-java" lang="java">
 StringRedisTemplate.opsForValue().set(key, gson.toJson(obj)); <span class="hljs-comment">// 写入</span>
 redisTemplate.opsForValue().get(key); <span class="hljs-comment">// 读取</span>
</code></pre>
<p>StringRedisTemplate 默认使用 String 序列化</p>
<p>RedisTemplate 期望 JSON 反序列化</p>
<p>写和读的“语言体系”完全不同</p>
<hr/>
<h2 data-id="heading-9">4.代码案例</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">test_toJson</span><span class="hljs-params">()</span> {
    <span class="hljs-type">RegionDo</span> <span class="hljs-variable">region</span> <span class="hljs-operator">=</span> buildRegion();
    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> gson.toJson(region);
    System.out.println(json);
    <span class="hljs-type">String</span> <span class="hljs-variable">json1</span> <span class="hljs-operator">=</span> gson.toJson(json);
    System.out.println(json1);
}
</code></pre>
<p>把对象直接set给redisTemplate，那么存的就是标准json格式，如果手动toJson后再丢给redisTemplate，那么存的就是后者</p>
<p>那么如何正常解析呢？</p>
<h4 data-id="heading-10">第一步：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">JsonElement</span> <span class="hljs-variable">jsonElement</span> <span class="hljs-operator">=</span> JsonParser.parseString(s);
</code></pre>
<p>JsonElement只有四个实现类，我们分开讲</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5162fa2d01d44098f932b9d08e556bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3Njk2MDk1MDkyMTg4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767249783&amp;x-signature=%2BlykMvV8YsDX7L5bHBcx5TY5ocQ%3D" alt="括号图 (1).png" loading="lazy"/></p>
<p>经过一次parseString，标准流程存储的数据都可以被成功反序列化</p>
<h4 data-id="heading-11">第二步：</h4>
<p>对于以上所说的所有被二次Json化的数据，全部属于<strong>JsonPrimitive中的String</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>{\<span class="hljs-string">"name\":\"Alice\",\"age\":25}"</span><span class="hljs-string">";  //二次Json的User对象
    String s2 = "</span><span class="hljs-string">"[{\"name\":\"Alice\",\"id\":25},{\"name\":\"Bob\",\"id\":30}]"</span><span class="hljs-string">"; //二次Json的List&lt;User&gt;
    String s3 = "</span><span class="hljs-string">"\100"</span><span class="hljs-string">";  //二次Json的Integer
    String s4 = "</span><span class="hljs-string">"true"</span><span class="hljs-string">";  //二次Json的Boolean
    System.out.println(JsonParser.parseString(s1).getClass());
    System.out.println(JsonParser.parseString(s2).getClass());
    System.out.println(JsonParser.parseString(s3).getClass());
    System.out.println(JsonParser.parseString(s4).getClass());
}
class com.google.gson.JsonPrimitive
class com.google.gson.JsonPrimitive
class com.google.gson.JsonPrimitive
class com.google.gson.JsonPrimitive
//另外强调下，这里之所以这么多\ 是为了转义，在java中手动new string模拟redis中的二次Json化的数据
</span></code></pre>
<p>那么这里就清晰了，我们可以</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-type">String</span> <span class="hljs-variable">asString</span> <span class="hljs-operator">=</span> jsonElement.getAsString();
<span class="hljs-keyword">return</span> gson.fromJson(asString,clazz);
</code></pre>
<h3 data-id="heading-12">小结</h3>
<p>二次 JSON 化从来不是“序列化器的 Bug”，而是：</p>
<p>应用层重复承担了本应由 RedisTemplate 负责的序列化职责</p>
<p>一旦对象被提前 toJson，后续所有 JSON 序列化器都会“再补一刀”。</p>
<h2 data-id="heading-13">Tips:</h2>
<h4 data-id="heading-14">1.string经过 serialize()方法只需要getBytes（），这不属于序列化，所以有的帖子会说string不需要序列化</h4>
<h4 data-id="heading-15">2.hash结构的数据如果getall，那么序列化或者反序列化都需要经过hash.size()次，也就是每个entry都要重复此步骤</h4>
<h4 data-id="heading-16">3.有时候我们使用Object接收返回的对象，实际上在底层的deserialize（）方法中有：return gson.fromJson(asString,clazz); 这里拿到的已经是User了，只是你用Object接收就得强转通过编译器检查，才能调用user自己的get方法</h4>
<pre><code class="hljs language-java" lang="java">RedisTemplate\&lt;String, Object&gt; redisTemplate; 
<span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">"user"</span>);<span class="hljs-comment">//obj.getClass()是User </span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (User) obj; <span class="hljs-comment">// ✅ 必须强转是因为编译器不知道，jvm内存层面其实是User </span>
user.getName();
</code></pre>
<ul>
<li>反序列化时已经 new 出了 User</li>
<li>但编译器只知道你拿到的是 Object</li>
<li>Java 是编译期静态类型语言</li>
</ul>
<p>👉 所以强转是给编译器看的，不是给 JVM 的</p>
<h4 data-id="heading-17">4.各 Ops 使用的序列化器组合</h4>






















































<table><thead><tr><th/><th/><th/><th/><th/></tr></thead><tbody><tr><td>Redis 操作类型</td><td>key 序列化</td><td>value 序列化</td><td>hash key 序列化</td><td>hash value 序列化</td></tr><tr><td>opsForValue()</td><td>keySerializer</td><td>valueSerializer</td><td>❌</td><td>❌</td></tr><tr><td>opsForHash()</td><td>keySerializer</td><td>❌</td><td>hashKeySerializer</td><td>hashValueSerializer</td></tr><tr><td>opsForList()</td><td>keySerializer</td><td>valueSerializer</td><td>❌</td><td>❌</td></tr><tr><td>opsForSet()</td><td>keySerializer</td><td>valueSerializer</td><td>❌</td><td>❌</td></tr><tr><td>opsForZSet()</td><td>keySerializer</td><td>valueSerializer</td><td>❌</td><td>❌</td></tr></tbody></table>
<p>核心总结：</p>
<ul>
<li>普通 key-value → key/value 序列化器</li>
<li>hash → hashKey/hashValue 序列化器</li>
<li>没有自己的序列化器，就回退去 valueSerializer 或 keySerializer</li>
</ul>
<p>Redis 是一个纯二进制存储系统。</p>
<p>凡是通过 RedisTemplate 以 Java 对象形式 存进去或读出来的东西，都必须经过序列化与反序列化。</p>
<ol>
<li>所有数据结构在 Redis 层 → 都是 byte[]</li>
<li>选择 opsForXXX 是为了匹配 Redis 不同结构，不是为了减少序列化</li>
<li>序列化器是针对（key/value/hashKey/hashValue）不同位置配置的</li>
<li>opsForXXX 选择序列化器的逻辑是结构驱动</li>
</ol>
<h4 data-id="heading-18">5.@class字段</h4>
<p>如果你redis中的 JSON 包含 @class 字段（由 GenericJackson2JsonRedisSerializer 生成）：</p>
<pre><code class="hljs language-less" lang="less">{ "<span class="hljs-variable">@class</span><span class="hljs-string">": "</span>com.example.User<span class="hljs-string">", "</span>id<span class="hljs-string">": 1, "</span>name<span class="hljs-string">": "</span>Alice" }
</code></pre>
<p>那么你可以：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">Object</span> obj = mapper.readValue(jsonWithClass, <span class="hljs-built_in">Object</span>.<span class="hljs-keyword">class</span>); <span class="hljs-comment">// ✅ 自动还原为 User！</span>
</code></pre>
<p>✅ 这是 Jackson 在 Redis / Spring 场景下的巨大优势：一个 RedisTemplate 能存/取任意类</p>
<p>但同时存在RCE漏洞。FastJson曾经因此出现重大bug，生产一般不开启此功能。</p>
<h4 data-id="heading-19">6.明确一点，new String最外侧的""只是标识作用，并不参与到字符串的内容中</h4>
<p>String s = "hello" // s.length()=5</p>
<p>String s = ""hello"" //真实内容是"hello"，可以理解为这就是被二次Json化的数据，s.length() = 7</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[硬核指南：Volta —— 重新定义 JavaScript 工具链管理]]></title>    <link>https://juejin.cn/post/7587313610697228315</link>    <guid>https://juejin.cn/post/7587313610697228315</guid>    <pubDate>2025-12-25T06:07:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587313610697228315" data-draft-id="7587322796826214440" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 硬核指南：Volta —— 重新定义 JavaScript 工具链管理"/> <meta itemprop="keywords" content="前端,命令行,敏捷开发"/> <meta itemprop="datePublished" content="2025-12-25T06:07:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="汤姆Tom"/> <meta itemprop="url" content="https://juejin.cn/user/4112607842680478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             硬核指南：Volta —— 重新定义 JavaScript 工具链管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4112607842680478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    汤姆Tom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:07:27.000Z" title="Thu Dec 25 2025 06:07:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端基建领域，Node.js 版本管理经历了三代演变：</p>
<ol>
<li><strong>石器时代</strong>：手动下载安装包，版本切换靠重装。</li>
<li><strong>铁器时代（NVM/N）</strong> ：基于 Shell 脚本的路径修改，虽然解决了多版本共存，但在跨 Shell、启动速度和项目自动化上存在硬伤。</li>
<li><strong>电气时代（Volta）</strong> ：基于 Rust 的二进制 Shim 机制，实现了<strong>毫秒级响应</strong>和<strong>零配置上下文切换</strong>。</li>
</ol>
<p>本文将带你从原理到实战，彻底掌握 Volta。</p>
<hr/>
<h2 data-id="heading-0">一、 核心原理：Volta 是如何工作的？</h2>
<p>很多开发者好奇，为什么 Volta 不需要像 NVM 那样运行 <code>nvm use</code>？</p>
<h3 data-id="heading-1">The Shim Mechanism (垫片机制)</h3>
<p>Volta 安装后，会把自己的 Shim 可执行文件（如 <code>node</code>, <code>npm</code>, <code>yarn</code>, <code>pnpm</code>）添加到系统的 <code>PATH</code> 环境变量最前端。</p>
<p>当你运行 <code>node</code> 时，实际发生的是：</p>
<ol>
<li>
<p><strong>拦截</strong>：Volta 的 Shim 拦截了这次调用。</p>
</li>
<li>
<p><strong>解析</strong>：Volta 迅速扫描当前目录树，寻找 <code>package.json</code> 中的 <code>volta</code> 字段。</p>
<ul>
<li><strong>有配置</strong>：使用配置文件锁定的版本。</li>
<li><strong>无配置</strong>：使用你通过 <code>volta install</code> 设置的默认全局版本。</li>
</ul>
</li>
<li>
<p><strong>路由</strong>：Volta 瞬间将命令转发给对应的真实二进制文件。</p>
</li>
</ol>
<p><strong>这一切都由 Rust 编写，开销极小（通常在几毫秒内），用户几乎无感。</strong></p>
<hr/>
<h2 data-id="heading-2">二、 安装与环境配置（进阶版）</h2>
<h3 data-id="heading-3">1. 标准安装</h3>
<ul>
<li><strong>Mac/Linux:</strong> <code>curl https://get.volta.sh | bash</code></li>
<li><strong>Windows:</strong> 使用安装包或 <code>winget install Volta.Volta</code></li>
</ul>
<h3 data-id="heading-4">2. 迁移指南（必须做的清理）</h3>
<p>为了防止冲突，安装 Volta 后，<strong>必须</strong>清理旧的管理器：</p>
<ul>
<li><strong>NVM 用户</strong>：注释掉 <code>.zshrc</code> / <code>.bashrc</code> 中关于 <code>NVM_DIR</code> 的加载脚本。</li>
<li><strong>Homebrew 用户</strong>：如果你之前用 brew 装过 node，建议 <code>brew uninstall node</code>，避免 PATH 优先级混淆。</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、 Volta 命令全解 (Command Reference)</h2>
<p>这是你要的详细命令手册，我们将命令分为 <strong>环境管理</strong>、<strong>项目管理</strong> 和 <strong>工具指令</strong> 三类。</p>
<h3 data-id="heading-6">1. 环境管理命令 (Global)</h3>
<p>这些命令影响你的全局默认环境（当你不在具体项目中时使用的版本）。</p>
<ul>
<li>
<p><strong><code>volta install [tool]</code></strong></p>
<ul>
<li>
<p><strong>作用</strong>：下载并安装工具，同时将其设为<strong>默认版本</strong>。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Bash</p>
<pre><code class="hljs language-perl" lang="perl">volta install node@18       <span class="hljs-comment"># 安装 Node 18 的最新 LTS 并设为默认</span>
volta install node@latest   <span class="hljs-comment"># 安装 Node 最新版</span>
volta install yarn@3        <span class="hljs-comment"># 安装 Yarn 3</span>
volta install cowsay        <span class="hljs-comment"># 安装全局二进制包 (cowsay)</span>
</code></pre>
</li>
<li>
<p><strong>细节</strong>：Volta 会把全局包安装在沙箱中，即使切换 Node 版本，这些全局工具依然可用（这是 NVM 做不到的）。</p>
</li>
</ul>
</li>
<li>
<p><strong><code>volta list</code></strong></p>
<ul>
<li>
<p><strong>作用</strong>：查看当前生效的工具版本（受当前目录上下文影响）。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Bash</p>
<pre><code class="hljs language-shell" lang="shell">volta list
<span class="hljs-meta prompt_"># </span><span class="bash">输出：</span>
<span class="hljs-meta prompt_"># </span><span class="bash">⚡️ Currently active tools:</span>
<span class="hljs-meta prompt_"># </span><span class="bash">   Node: v16.19.0 (current @ /projects/my-app/package.json)</span>
<span class="hljs-meta prompt_"># </span><span class="bash">   Yarn: v1.22.19 (default)</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>volta list all</code></strong></p>
<ul>
<li><strong>作用</strong>：查看本地缓存的所有已下载版本。</li>
<li><strong>场景</strong>：当你磁盘空间不足，想看看存了多少个 Node 版本时。</li>
</ul>
</li>
<li>
<p><strong><code>volta uninstall [tool]</code></strong></p>
<ul>
<li><strong>作用</strong>：卸载全局工具。</li>
<li><strong>注意</strong>：这主要用于卸载像 <code>typescript</code> 或 <code>create-react-app</code> 这样的全局包。如果你想删除特定的 Node 引擎缓存，通常不需要手动管理，Volta 会自动处理，或者你可以手动清理 <code>~/.volta/tools/image</code>。</li>
</ul>
</li>
<li>
<p><strong><code>volta fetch [tool]</code></strong></p>
<ul>
<li><strong>作用</strong>：仅下载版本到本地缓存，但不设置为默认，也不修改项目配置。</li>
<li><strong>场景</strong>：为离线环境做准备，预先下载 Node 20。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">2. 项目管理命令 (Project)</h3>
<p>这是 Volta 的灵魂，用于锁定项目依赖。</p>
<ul>
<li>
<p><strong><code>volta pin [tool]</code></strong></p>
<ul>
<li>
<p><strong>作用</strong>：将工具版本写入当前目录的 <code>package.json</code>。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Bash</p>
<pre><code class="hljs language-perl" lang="perl">cd <span class="hljs-keyword">my</span>-project
volta pin node@14.<span class="hljs-number">17</span>
volta pin yarn@1.<span class="hljs-number">22</span>
</code></pre>
</li>
<li>
<p><strong>结果</strong>：</p>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-attr">"volta"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"14.17.6"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"yarn"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.22.19"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>深层逻辑</strong>：一旦 Pin 住，任何进入该目录的人，运行 <code>node -v</code> 都会得到 <code>14.17.6</code>，无论他们全局默认是哪个版本。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">3. 高级工具命令 (Utility)</h3>
<ul>
<li>
<p><strong><code>volta run</code></strong></p>
<ul>
<li>
<p><strong>作用</strong>：使用特定版本的工具运行一次性命令（不修改配置）。</p>
</li>
<li>
<p><strong>场景</strong>：你需要用 Node 10 跑一个老脚本，但不想安装它为默认，也不想修改项目配置。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Bash</p>
<pre><code class="hljs language-arduino" lang="arduino">volta run --node <span class="hljs-number">12</span> index.js
volta run --npm <span class="hljs-number">6</span> npm install
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>volta which [tool]</code></strong></p>
<ul>
<li>
<p><strong>作用</strong>：显示当前工具实际调用的二进制文件路径。</p>
</li>
<li>
<p><strong>场景</strong>：Debug 专用。当你怀疑 Volta 没有生效，或者不知道自己在用哪里的 Node 时。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Bash</p>
<pre><code class="hljs language-shell" lang="shell">volta which node
<span class="hljs-meta prompt_"># </span><span class="bash">输出: /Users/username/.volta/tools/image/node/18.15.0/bin/node</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>volta setup</code></strong></p>
<ul>
<li><strong>作用</strong>：为当前用户/Shell 重新配置 Volta 环境变量。</li>
<li><strong>场景</strong>：主要用于 CI 环境或修复损坏的 Shell 配置文件。</li>
</ul>
</li>
<li>
<p><strong><code>volta completions</code></strong></p>
<ul>
<li><strong>作用</strong>：生成 Shell 自动补全脚本（支持 bash, zsh, fish, powershell）。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、 进阶实战场景</h2>
<h3 data-id="heading-10">1. Monorepo 支持 (Workspace)</h3>
<p>如果你使用 pnpm workspace 或 yarn workspace 管理 Monorepo：</p>
<ul>
<li>你只需要在<strong>根目录</strong>的 <code>package.json</code> 中运行 <code>volta pin</code>。</li>
<li>子包（packages/*）会自动继承根目录的 Volta 配置。</li>
<li>如果某个子包需要特殊的 Node 版本，你也可以在子包里单独 Pin（虽然不推荐这样做，但 Volta 支持）。</li>
</ul>
<h3 data-id="heading-11">2. CI/CD 集成 (GitHub Actions)</h3>
<p>在 CI 环境中使用 Volta 极度舒适，因为它保证了本地和 CI 环境的严格一致。</p>
<p><strong>示例 GitHub Actions Workflow:</strong></p>
<p>YAML</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">steps:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
  
  <span class="hljs-comment"># 安装 Volta</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">volta-cli/action@v4</span>
  
  <span class="hljs-comment"># 此时 Volta 会自动读取 package.json 中的设置</span>
  <span class="hljs-comment"># 自动安装对应的 Node 和 NPM/Yarn 版本</span>
  
  <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">test</span>
</code></pre>
<p>无需手动指定 <code>node-version: 16</code>，一切以代码库中的 <code>package.json</code> 为准。</p>
<h3 data-id="heading-12">3. 处理全局二进制 (Global Binaries)</h3>
<p>NVM 的痛点：切了 Node 版本，安装的全局包（如 nest-cli）就找不到了。</p>
<p>Volta 的解法：</p>
<p>Bash</p>
<pre><code class="hljs language-bash" lang="bash">volta install @nestjs/cli
</code></pre>
<p>无论你当前处于哪个 Node 版本的项目中，<code>nest</code> 命令都能用。Volta 会智能地用<strong>当前项目环境的 Node</strong> 去运行这个全局工具。</p>
<hr/>
<h2 data-id="heading-13">五、 常见问题排查 (Troubleshooting)</h2>






























<table><thead><tr><th><strong>问题现象</strong></th><th><strong>可能原因</strong></th><th><strong>解决方案</strong></th></tr></thead><tbody><tr><td><strong>安装后找不到 volta 命令</strong></td><td>环境变量没生效</td><td>运行 <code>source ~/.zshrc</code> 或重启终端。</td></tr><tr><td><strong>Node 版本没变</strong></td><td>旧的 PATH 优先级更高</td><td>检查 <code>$PATH</code>，确保 <code>~/.volta/bin</code> 在 <code>/usr/local/bin</code> 或 NVM 路径之前。</td></tr><tr><td><strong>npm install 报错权限问题</strong></td><td>Windows 常见问题</td><td>在 Windows 上开启“开发者模式”，或确保 Volta 目录无权限限制。</td></tr><tr><td><strong>Binary 无法执行</strong></td><td>缺少依赖</td><td>Linux 环境下偶尔需要安装 <code>build-essential</code>。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">总结</h2>
<p>Volta 不仅仅是一个版本切换器，它是一个<strong>确定性的环境管理器</strong>。</p>
<ul>
<li><strong>对于个人</strong>：它提供了极速、无感的开发体验。</li>
<li><strong>对于团队</strong>：<code>volta pin</code> 彻底终结了“由于 Node 版本不同导致的依赖报错”。</li>
</ul>
<p><strong>建议：</strong> 现在的项目开发中，直接在 <code>package.json</code> 中加入 <code>volta</code> 配置应成为一种<strong>行业最佳实践</strong>，就像配置 <code>.gitignore</code> 一样标准。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手搓实现简易版 Vue2 响应式系统]]></title>    <link>https://juejin.cn/post/7587398857537290303</link>    <guid>https://juejin.cn/post/7587398857537290303</guid>    <pubDate>2025-12-25T06:23:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587398857537290303" data-draft-id="7587412021710061574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手搓实现简易版 Vue2 响应式系统"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-25T06:23:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PlankBevelen"/> <meta itemprop="url" content="https://juejin.cn/user/1057085717486684"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手搓实现简易版 Vue2 响应式系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1057085717486684/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PlankBevelen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:23:23.000Z" title="Thu Dec 25 2025 06:23:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文引用自作者博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplankbevelen.cn" target="_blank" title="https://plankbevelen.cn" ref="nofollow noopener noreferrer">plankbevelen.cn</a></p>
</blockquote>
<p>以 vue2 为基础，实现一个简易版的响应式系统。
首先了解 vue2 的响应式系统是如何实现的。首先举例（以下为伪代码）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> val = <span class="hljs-number">1</span>;
val = <span class="hljs-number">2</span>;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ val }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span> =&gt; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span> =&gt; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<p>以上总的流程为：改变val值时，vue追踪到val的变化，然后通知所有依赖val的地方，最后更新视图。
vue官方说的是发布订阅模式，核心即：追踪变化，收集依赖，触发更新。</p>
<p>追踪变化 vue2 中是通过 Object.defineProperty 实现的。vue3 中是通过 Proxy 实现的，核心思路是不变的。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, val</span>) {
    object.<span class="hljs-title function_">defineProperty</span>(obj, key, {
        <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span> val;
        },
        <span class="hljs-title function_">set</span>(<span class="hljs-params">newVal</span>) {
            <span class="hljs-keyword">if</span> (newVal !== val) {
                val = newVal;
            }
        }
    })
}
</code></pre>
<p>这个借助Object.defineProperty，为对象的属性添加了getter和setter，当属性被访问或修改时，会触发getter和setter，达到数据变化追踪的效果。
而这个只能为对象的单个属性，而且只能添加一次，所以可以进行递归遍历，为对象的每个属性都加上getter和setter.</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 检测数据变化</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">value</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;
        <span class="hljs-keyword">if</span>(value &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span>) <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value) ? <span class="hljs-title function_">obserbeArray</span>(value) : <span class="hljs-title function_">walk</span>(value);
    }
    <span class="hljs-title function_">walk</span>(<span class="hljs-params">obj</span>) {
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
            <span class="hljs-title function_">defineReactive</span>(obj, key, obj[key]);
        }
    }
    <span class="hljs-title function_">obserbeArray</span>(<span class="hljs-params">obj</span>) {
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; obj.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-title function_">observe</span>(obj[i]);
        }
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-comment">// 如果不是对象</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> val !== <span class="hljs-string">'object'</span>) <span class="hljs-keyword">return</span> 
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(val); <span class="hljs-comment">// 继续</span>
}
</code></pre>
<p>Observer类用递归实现了一整个对象的所有属性的监听，如果数据有所变化的话，需要有一个类似于socket的东西去帮它传达更新消息，并执行其对应的业务逻辑。
vue 是使用了一个叫依赖的东西，当数据变化的时候，你所要通知的地方就是依赖。依赖收集的时期在getter时，等你在触发setter的时候就会去触发对应业务。到这儿整个流程大致会清晰一些，最后再做总结。所以中间先建立一个依赖收集器，只实现部分这儿用得到的功能：收集依赖、通知更新，就够了</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span> = [];
    }
    <span class="hljs-title function_">addSub</span>(<span class="hljs-params">sub</span>) {
        <span class="hljs-keyword">if</span>(sub &amp;&amp; sub.<span class="hljs-property">update</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">includes</span>(sub)) <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">push</span>(sub);
    }
    <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">foreach</span>(<span class="hljs-function">(<span class="hljs-params">sub</span>) =&gt;</span> sub.<span class="hljs-title function_">update</span>());
    }
}
<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>;
</code></pre>
<p>（补一下收集依赖的部分）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, val</span>) {
    object.<span class="hljs-title function_">defineProperty</span>(obj, key, {
        <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
            <span class="hljs-comment">// 收集依赖</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addSub</span>(<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>);
            <span class="hljs-keyword">return</span> val;
        },
        <span class="hljs-title function_">set</span>(<span class="hljs-params">newVal</span>) {
            <span class="hljs-keyword">if</span> (newVal !== val) {
                val = newVal;
                <span class="hljs-comment">// 通知更新</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notify</span>();
                <span class="hljs-comment">// 监听新值</span>
                <span class="hljs-title function_">observe</span>(newVal);
            }
        }
    })
}
</code></pre>
<p>最后是实现，依赖所要通知的单位，这个单位呢有很多种，比如用户实现的watch，template中的数据等，为了方便管理起来，vue中把这个叫做watcher进行集中管理</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> {
    <span class="hljs-comment">// vm是组件实例，expOrFn是监听对应的数据，cb是回调函数，也就是其对应的业务逻辑</span>
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm, expOrFn, cb</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> = cb;
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> expOrFn === <span class="hljs-string">'function'</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">expOrFn</span> = expOrFn; <span class="hljs-comment">// 直接执行</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">expOrFn</span> = <span class="hljs-title function_">parseExp</span>(exp);
        }
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>();
    }
    <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>;
        <span class="hljs-keyword">const</span> val = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">expOrFn</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>);
        <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">return</span> val;
    }
    <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">let</span> oldValue = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
        <span class="hljs-keyword">let</span> newValue = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>();
        <span class="hljs-keyword">if</span>(oldValue !== newValue) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = newValue;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>, newValue);
        }
    }
    <span class="hljs-title function_">parseExp</span>(<span class="hljs-params">exp</span>) {
        <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/[^\w.$]/</span>.<span class="hljs-title function_">test</span>(exp)) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'表达式格式错误'</span>);
        <span class="hljs-keyword">const</span> segments = exp.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>) {
            <span class="hljs-keyword">let</span> val = obj;
            segments.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">segment</span>) =&gt;</span> {
                val = val[segment];
            })
            <span class="hljs-keyword">return</span> val;
        }
    }
}
</code></pre>
<p>总的结果就是Observer类负责监听数据变化，Dep类负责收集依赖和通知更新，Watcher类负责订阅数据变化并执行回调函数。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP入门梳理]]></title>    <link>https://juejin.cn/post/7587421380228988978</link>    <guid>https://juejin.cn/post/7587421380228988978</guid>    <pubDate>2025-12-25T06:30:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587421380228988978" data-draft-id="7574639741149397043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MCP入门梳理"/> <meta itemprop="keywords" content="前端,MCP,TypeScript"/> <meta itemprop="datePublished" content="2025-12-25T06:30:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LoveDreaMing"/> <meta itemprop="url" content="https://juejin.cn/user/1535335657912839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MCP入门梳理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535335657912839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LoveDreaMing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:30:49.000Z" title="Thu Dec 25 2025 06:30:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai-sublime">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#23241f}.hljs-subst,.hljs-tag,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#f8f8f2}.hljs-emphasis,.hljs-strong{color:#a8a8a2}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ae81ff}.hljs-code,.hljs-section,.hljs-selector-class,.hljs-title{color:#a6e22e}.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}.hljs-attr,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#f92672}.hljs-attribute,.hljs-symbol{color:#66d9ef}.hljs-class .hljs-title,.hljs-params{color:#f8f8f2}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-string,.hljs-template-variable,.hljs-type,.hljs-variable{color:#e6db74}.hljs-comment,.hljs-deletion,.hljs-meta{color:#75715e}</style><h2 data-id="heading-0">前置知识-stdio(传输层)</h2>
<h3 data-id="heading-1">什么是stdio</h3>
<p><em>stdio</em> 是 "标准输入输出"（Standard Input/Output）的缩写，是计算机程序中用于进程间通信的基本机制。它通过三个主要的流（standard streams）来处理数据：</p>
<ul>
<li><strong>stdin</strong>：标准输入，用于接收外部数据输入。</li>
<li><strong>stdout</strong>：标准输出，用于输出数据给外部。</li>
<li><strong>stderr</strong>：标准错误输出，用于输出错误信息。</li>
</ul>
<p>可以把 <em>stdio</em> 想象成一个管道，程序的一部分通过管道将数据发送出去，另一部分通过管道接收数据。这种设计使得 <em>stdio</em> 成为最基本的通信形式，尤其在 <strong>命令行工具</strong> 或 <strong>脚本程序</strong> 中得到了广泛应用。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/394474929efa471eb6789d315d4bae47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTG92ZURyZWFNaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767249048&amp;x-signature=IeqZVdwMP4pgH12tT08GWtsCvgQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">为什么 MCP 会选 stdio 作为核心通信方式之一</h3>
<ul>
<li><strong>本地工具场景非常匹配</strong>：MCP 通常用于 <code>工具链与模型的协作</code>，这种场景下，<em>stdio</em> 提供了一种最原始、最直接的通信方式。MCP 主要通过本地工具或进程来执行任务，不需要外部的网络支持或服务暴露。通过 <em>stdio</em>，MCP 可以在不同的进程之间传递数据，保证了 <code>本地化、低延迟</code> 的需求。</li>
<li><strong>无需网络，启动成本极低</strong>：与传统的网络通信协议相比，<em>stdio</em> 的一个巨大优势在于，它不需要依赖网络连接。无论是 <code>端口配置</code> 还是 <code>网络访问权限</code>，都不再是使用 <em>stdio</em> 的障碍。在 MCP 中，任何一个本地进程都可以通过标准输入输出直接与另一个进程进行通信。</li>
<li><strong>天然的安全边界</strong>：在 MCP 的架构中，<em>stdio</em> 的通信只发生在本地进程间，不涉及网络层面的暴露。这意味着它天然具备了较高的安全性。每个进程的标准输入输出只能在该进程的上下文中访问，不会无意中暴露给外部网络或其他程序。</li>
<li><strong>非常容易跨语言</strong>：不同于某些专用协议，<em>stdio</em> 是操作系统层级的标准，它被绝大多数编程语言所支持。无论是用 Node.js、Python，还是 Go，所有这些语言都可以通过统一的方式进行输入输出。这为 MCP 提供了极大的灵活性，使得它可以轻松与多种工具和模型集成，跨语言的操作非常简单。</li>
</ul>
<h3 data-id="heading-3">stdio使用演示</h3>
<p><strong>client.js</strong>：通过 <em>stdio</em> 向子进程发送消息并接收响应</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> { spawn } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);
<span class="hljs-keyword">const</span> serverProcess = <span class="hljs-title function_">spawn</span>(<span class="hljs-string">'node'</span>, [<span class="hljs-string">'server.js'</span>]); <span class="hljs-comment">// 启动 server.js 子进程</span>
<span class="hljs-keyword">const</span> messages = [<span class="hljs-string">'你好吗？'</span>, <span class="hljs-string">'你吃饭了吗？'</span>, <span class="hljs-string">'天气真好！'</span>];
messages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">message, index</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> msg = message + <span class="hljs-string">'\n'</span>; <span class="hljs-comment">// 加上换行符可以让服务端更容易区分每一条输入</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'我：'</span> + msg);
    serverProcess.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">write</span>(msg);
  }, index * <span class="hljs-number">1000</span>); <span class="hljs-comment">// 每秒发送一条消息</span>
});
<span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
serverProcess.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'AI：'</span> + data.<span class="hljs-title function_">toString</span>());
  count++;
  <span class="hljs-keyword">if</span> (count === messages.<span class="hljs-property">length</span>) {
    serverProcess.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">end</span>();
  }
});
</code></pre>
<p><strong>server.js</strong>：从 <em>stdin</em> 读取输入并通过 <em>stdout</em> 返回结果</p>
<pre><code class="hljs language-js" lang="js">process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">setEncoding</span>(<span class="hljs-string">'utf-8'</span>); <span class="hljs-comment">// 设置utf-8 编码，输入的数据将被转换为字符串</span>
process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  data = data
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[?？]/g</span>, <span class="hljs-string">''</span>)
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/我/g</span>, <span class="hljs-string">'你'</span>)
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/你/g</span>, <span class="hljs-string">'我'</span>)
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/吗/g</span>, <span class="hljs-string">''</span>);
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">`<span class="hljs-subst">${data}</span>\n`</span>);
});
process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'end'</span>, <span class="hljs-function">() =&gt;</span> {
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 正常退出进程</span>
});
</code></pre>
<h2 data-id="heading-4">前置知识-JSON-RPC(协议层)</h2>
<h3 data-id="heading-5">什么是 JSON-RPC</h3>
<p><em>JSON-RPC</em> 是一种轻量级的远程过程调用（RPC）协议，基于 JSON 格式实现跨进程 / 跨网络的通信，核心目标是让不同系统能够通过简单的文本格式调用彼此的方法，无需依赖复杂的传输层协议。通俗的讲，JSON-RPC 做的事情只有一件：<code>把一次“函数调用”，用一段 JSON 表达出来</code>。</p>
<ul>
<li>
<p>它的核心特点：</p>
<ul>
<li><strong>无状态</strong>：每次请求独立，服务器不保存客户端上下文；</li>
<li><strong>语言无关</strong>：JSON 是通用格式，几乎所有编程语言都支持解析；</li>
<li><strong>简洁</strong>：协议规则极少，请求 / 响应格式固定且易理解。</li>
</ul>
</li>
<li>
<p>核心结构由「请求对象」和「响应对象」组成：</p>
<ul>
<li><strong>请求</strong>：包含要调用的方法名、参数、唯一标识（ID）；</li>
<li><strong>响应</strong>：包含调用结果（成功 / 失败）、对应请求的 ID（用于关联）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">MCP 为什么选择 JSON-RPC 2.0</h3>
<p>JSON-RPC 2.0 是 1.0 的官方标准化升级（1.0 无正式规范，仅为社区约定），主要解决了 1.0 的模糊性、扩展性问题。MCP 并没有重新设计一套通信协议，而是选择了 <em>JSON-RPC 2.0</em> 作为协议层，主要因为：</p>
<p>首先，JSON-RPC 2.0 是一个<strong>成熟且稳定的规范</strong>。它的结构固定、语义清晰，不需要在“如何定义消息格式”这件事上再花额外成本。</p>
<p>其次，JSON-RPC 的核心抽象与 MCP 的设计高度契合：</p>
<ul>
<li><code>method</code> 对应工具或能力的调用</li>
<li><code>params</code> 对应输入参数</li>
<li><code>result</code> 或 <code>error</code> 对应执行结果</li>
</ul>
<p>这种一一对应关系，使得 MCP 在表达工具调用时几乎不需要做额外包装。</p>
<p>最后，JSON-RPC 与传输层完全解耦。  在 MCP 中，JSON-RPC 消息既可以通过 <strong>stdio</strong> 传输，也可以通过 <strong>HTTP</strong> 传输，而协议本身不需要做任何修改。可以简单理解为：</p>
<blockquote>
<p>stdio 和 http 负责“怎么传”，<br/>
JSON-RPC 负责“传什么”。</p>
</blockquote>
<h3 data-id="heading-7">JSON-RPC 2.0的基本结构</h3>
<p>介绍几种常用的rpc调用，字段介绍及其他用法可参照<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jsonrpc.org%2Fspecification" target="_blank" title="https://www.jsonrpc.org/specification" ref="nofollow noopener noreferrer">英文文档</a>，也可以参照<a href="https://link.juejin.cn?target=http%3A%2F%2Fwiki.geekdream.com%2FSpecification%2Fjson-rpc_2.0.html" target="_blank" title="http://wiki.geekdream.com/Specification/json-rpc_2.0.html" ref="nofollow noopener noreferrer">中文文档</a></p>
<ul>
<li>参数是数组的rpc调用</li>
</ul>
<pre><code class="hljs language-json" lang="json">--&gt; <span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"subtract"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">42</span><span class="hljs-punctuation">,</span> <span class="hljs-number">23</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">}</span>
&lt;-- <span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>参数是键值对的rpc调用</li>
</ul>
<pre><code class="hljs language-json" lang="json">--&gt; <span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"subtract"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"subtrahend"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">23</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"minuend"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">42</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">}</span>
&lt;-- <span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">19</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>通知(没有 <code>id</code> 字段)</li>
</ul>
<pre><code class="hljs language-json" lang="json">--&gt; <span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"update"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span>

--&gt; <span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"foobar"</span><span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>失败响应的rpc调用</li>
</ul>
<pre><code class="hljs language-json" lang="json">--&gt; <span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"foobar"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">}</span>
&lt;-- <span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-32601</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Method not found"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-8">JSON-RPC 2.0的使用演示</h3>
<p><strong>server.js</strong>：是一个<code>基于 JSON-RPC 2.0 的本地服务端进程</code>，核心职责是：读取 <em>stdin</em> 结构化输入 → 根据 <em>method</em> 执行能力 → 返回 <em>stdout</em> 结构化结果</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-keyword">const</span> utils = {
  <span class="hljs-title function_">sum</span>(<span class="hljs-params">{ a, b }</span>) {
    <span class="hljs-keyword">return</span> a + b;
  },
  <span class="hljs-title function_">createFile</span>(<span class="hljs-params">{ filename, content }</span>) {
    <span class="hljs-keyword">try</span> {
      fs.<span class="hljs-title function_">writeFileSync</span>(filename, content);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
};

process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> req = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
  <span class="hljs-keyword">const</span> funcName = req.<span class="hljs-property">method</span>;
  <span class="hljs-keyword">const</span> params = req.<span class="hljs-property">params</span>;
  <span class="hljs-keyword">const</span> result = utils[funcName](params);
  <span class="hljs-keyword">const</span> res = {
    <span class="hljs-attr">jsonrpc</span>: <span class="hljs-string">'2.0'</span>,
    <span class="hljs-attr">id</span>: req.<span class="hljs-property">id</span>,
    result
  };
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(res) + <span class="hljs-string">'\n'</span>);
});
</code></pre>
<p><strong>jsonrpc.txt</strong>：提供两个模拟客户端发送的 JSON-RPC 请求消息，第一个是无副作用的，单纯的函数调用，第二个是有副作用的，触发系统能力的调用。</p>
<pre><code class="hljs language-txt" lang="txt">{"jsonrpc":"2.0","id":1,"method":"sum","params":{"a":1,"b":2}}

{"jsonrpc":"2.0","id":2,"method":"createFile","params":{"filename":"./test.txt","content":"Hello, World!"}}
</code></pre>
<h2 data-id="heading-9">基于 JSON-RPC 的 MCP 实现</h2>
<p><strong>server.js</strong>：是一个基于 JSON-RPC 2.0 实现的 MCP 服务端示例，通过 <code>initialize</code>、<code>tools/list</code> 和 <code>tools/call</code> 等方法对外声明能力并提供工具调用能力。utils里的MCP字段配置可以参考MCP官方的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-11-25%2Fschema" target="_blank" title="https://modelcontextprotocol.io/specification/2025-11-25/schema" ref="nofollow noopener noreferrer">Schema Reference</a></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-keyword">const</span> tools = {
  <span class="hljs-title function_">sum</span>(<span class="hljs-params">{ a, b }</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">content</span>: [
        {
          <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
          <span class="hljs-attr">text</span>: <span class="hljs-string">`两数求和结果是：<span class="hljs-subst">${a + b}</span>`</span>
        }
      ]
    };
  },
  <span class="hljs-title function_">createFile</span>(<span class="hljs-params">{ filename, content }</span>) {
    <span class="hljs-keyword">try</span> {
      fs.<span class="hljs-title function_">writeFileSync</span>(filename, content);
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">content</span>: [
          {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
            <span class="hljs-attr">text</span>: <span class="hljs-string">`文件创建成功！`</span>
          }
        ]
      };
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">content</span>: [
          {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
            <span class="hljs-attr">text</span>: err.<span class="hljs-property">message</span> || <span class="hljs-string">'文件创建失败！'</span>
          }
        ]
      };
    }
  }
};

<span class="hljs-keyword">const</span> utils = {
  <span class="hljs-title function_">initialize</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 服务器功能</span>
      <span class="hljs-attr">capabilities</span>: {
        <span class="hljs-comment">// 支持工具的服务器必须声明工具能力</span>
        <span class="hljs-attr">tools</span>: {
          <span class="hljs-attr">listChanged</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 该服务器是否支持工具列表变更的通知</span>
        }
      },
      <span class="hljs-attr">protocolVersion</span>: <span class="hljs-string">'2025-11-25'</span>, <span class="hljs-comment">// 协议版本</span>
      <span class="hljs-comment">// 服务器信息</span>
      <span class="hljs-attr">serverInfo</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'Demo Server'</span>, <span class="hljs-comment">// 名称</span>
        <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span> <span class="hljs-comment">// 版本</span>
      }
    };
  },
  <span class="hljs-string">'tools/list'</span>() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">tools</span>: [
        {
          <span class="hljs-attr">name</span>: <span class="hljs-string">'sum'</span>,
          <span class="hljs-attr">title</span>: <span class="hljs-string">'两数求和'</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">'得到两个数的和'</span>,
          <span class="hljs-attr">inputSchema</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
            <span class="hljs-attr">properties</span>: {
              <span class="hljs-attr">a</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span>,
                <span class="hljs-attr">description</span>: <span class="hljs-string">'第一个数'</span>
              },
              <span class="hljs-attr">b</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span>,
                <span class="hljs-attr">description</span>: <span class="hljs-string">'第二个数'</span>
              }
            },
            <span class="hljs-attr">required</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>]
          }
        },
        {
          <span class="hljs-attr">name</span>: <span class="hljs-string">'createFile'</span>,
          <span class="hljs-attr">title</span>: <span class="hljs-string">'创建文件'</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">'在指定目录下创建一个文件'</span>,
          <span class="hljs-attr">inputSchema</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
            <span class="hljs-attr">properties</span>: {
              <span class="hljs-attr">filename</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
                <span class="hljs-attr">description</span>: <span class="hljs-string">'文件名'</span>
              },
              <span class="hljs-attr">content</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
                <span class="hljs-attr">description</span>: <span class="hljs-string">'文件内容'</span>
              }
            },
            <span class="hljs-attr">required</span>: [<span class="hljs-string">'filename'</span>, <span class="hljs-string">'content'</span>]
          }
        }
      ]
    };
  }
};

process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> req = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
  <span class="hljs-keyword">let</span> result;
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">'tools/call'</span>) {
    result = tools[req.<span class="hljs-property">params</span>.<span class="hljs-property">name</span>](req.<span class="hljs-property">params</span>.<span class="hljs-property">arguments</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> <span class="hljs-keyword">in</span> utils) {
    result = utils[req.<span class="hljs-property">method</span>](req.<span class="hljs-property">params</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> res = {
    <span class="hljs-attr">jsonrpc</span>: <span class="hljs-string">'2.0'</span>,
    result,
    <span class="hljs-attr">id</span>: req.<span class="hljs-property">id</span>
  };
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(res) + <span class="hljs-string">'\n'</span>);
});
</code></pre>
<p><strong>jsonrpc.txt</strong>：展示了客户端通过 JSON-RPC 2.0 协议与 MCP 服务端交互的完整流程，包括初始化、查询工具列表以及调用具体工具的示例请求。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"Demo Client"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"2025-11-25"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"tools/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"sum"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"b"</span><span class="hljs-punctuation">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"createFile"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"filename"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"./test.txt"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"Hello World!"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-10">使用 TypeScript SDK 构建 MCP 应用</h2>
<h3 data-id="heading-11">StdioServerTransport</h3>
<p><strong>stdio.js</strong>：实现了一个基于 <code>StdioServerTransport</code> 的 MCP Server，通过标准输入输出与客户端通信，并对外注册了 <code>sum</code> 和 <code>createFile</code> 两个工具，分别用于数值计算和文件写入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">McpServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server/mcp.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StdioServerTransport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server/stdio.js'</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'demo-server'</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>
  });

  server.<span class="hljs-title function_">registerTool</span>(
    <span class="hljs-string">'sum'</span>,
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'两数求和'</span>,
      <span class="hljs-attr">description</span>: <span class="hljs-string">'将两个数字相加'</span>,
      <span class="hljs-attr">inputSchema</span>: { <span class="hljs-attr">a</span>: z.<span class="hljs-title function_">number</span>(), <span class="hljs-attr">b</span>: z.<span class="hljs-title function_">number</span>() },
      <span class="hljs-attr">outputSchema</span>: { <span class="hljs-attr">result</span>: z.<span class="hljs-title function_">number</span>() }
    },
    <span class="hljs-keyword">async</span> ({ a, b }) =&gt; {
      <span class="hljs-keyword">const</span> output = { <span class="hljs-attr">result</span>: a + b };
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">content</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(output) }],
        <span class="hljs-attr">structuredContent</span>: output
      };
    }
  );

  server.<span class="hljs-title function_">registerTool</span>(
    <span class="hljs-string">'createFile'</span>,
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'创建文件'</span>,
      <span class="hljs-attr">description</span>: <span class="hljs-string">'将内容添加到文件中'</span>,
      <span class="hljs-attr">inputSchema</span>: { <span class="hljs-attr">filename</span>: z.<span class="hljs-title function_">string</span>(), <span class="hljs-attr">content</span>: z.<span class="hljs-title function_">string</span>() }
    },
    <span class="hljs-keyword">async</span> ({ filename, content }) =&gt; {
      <span class="hljs-keyword">try</span> {
        fs.<span class="hljs-title function_">writeFileSync</span>(filename, content);
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">content</span>: [
            {
              <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
              <span class="hljs-attr">text</span>: <span class="hljs-string">'文件创建成功！'</span>
            }
          ]
        };
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">content</span>: [
            {
              <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
              <span class="hljs-attr">text</span>: err.<span class="hljs-property">message</span> || <span class="hljs-string">'文件创建失败！'</span>
            }
          ]
        };
      }
    }
  );

  <span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StdioServerTransport</span>();
  <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport);
}

<span class="hljs-title function_">main</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
</code></pre>
<h5 data-id="heading-12">使用rpc调用调试</h5>
<ul>
<li>在命令行窗口运行<code>node ./src/stdio.js</code>启动服务</li>
<li>如下<strong>jsonrpc.txt</strong>的内容，整行复制<em>jsonrpc</em>协议请求到命令行窗口，调试MCP工具函数</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"tools/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"sum"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"b"</span><span class="hljs-punctuation">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"createFile"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"filename"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"./test.txt"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"Hello World!"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-13">使用@modelcontextprotocol/inspector调试</h5>
<ul>
<li>在命令行窗口运行<code>npx @modelcontextprotocol/inspector</code>，浏览器会自动弹出调试窗口</li>
<li>在浏览器的调试窗口左侧填写对应的字段，<em>Arguments</em>里填写对应服务的文件相对地址或者绝对地址，然后点击<em>Connect</em>建立连接，会触发<em>initialize</em>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76f1e0d7e9284e41bbfc462cfbec1d75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTG92ZURyZWFNaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767249048&amp;x-signature=aXvdG5aptbeI9DdTmgINDU1PNqQ%3D" alt="image.png" loading="lazy"/></li>
<li>最后就可以在右侧的如下图两个红框内输入，调试MCP工具函数
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10b108245c7f4c78a57c4eb0df023755~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTG92ZURyZWFNaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767249048&amp;x-signature=a3WPvFJsuV%2Fj82Ru985ps3AF2hU%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h5 data-id="heading-14">使用LLM客户端调试(以Cursor举例，其他的配置差不多)</h5>
<ul>
<li>点击对话窗口的右上角的三个点，选择<em>Agent Settings</em>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d89111589f8e4bed8254c71ac1fbf223~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTG92ZURyZWFNaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767249048&amp;x-signature=p4sIzlRTCs%2Boal9Ea9RdIb1tgOk%3D" alt="image.png" loading="lazy"/></li>
<li>在Tools &amp; MCP一栏，点击<em>Add Custom MCP</em>，这时会打开mcp.json文件
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9a391d8a7564595884d58f74efaf1db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTG92ZURyZWFNaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767249048&amp;x-signature=UV3TxdbifJQipqPgYU%2FQuvU50so%3D" alt="image.png" loading="lazy"/></li>
<li>mcp.json文件内容如下，添加自己的mcp服务<em>my-mcp-server</em>，注意args里的服务文件地址需要填写绝对路径地址</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"my-mcp-server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"transport"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"stdio"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"xxx/xxx/src/stdio.js"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>返回对话窗口，输入@MCP xxx就能在对话框直接调用mcp工具函数，如果不@MCP有时也会触发mcp工具函数，只不过是大模型自己判断调用的
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/918fc205f2a64dc2990a2898b090c2d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTG92ZURyZWFNaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767249048&amp;x-signature=5uei34LnXTthQM2eSoFXqjCAAfg%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h3 data-id="heading-15">StreamableHTTPServerTransport</h3>
<p><strong>streamableHttp.js</strong>：实现了一个基于 <code>StreamableHTTPServerTransport</code> 的 MCP Server，通过 Express 提供 <code>/mcp</code> HTTP 接口，使 MCP 客户端可以以流式 HTTP 的方式调用 <code>sum</code> 和 <code>createFile</code> 两个工具。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">McpServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server/mcp.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StreamableHTTPServerTransport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server/streamableHttp.js'</span>;
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'demo-server'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>
});

server.<span class="hljs-title function_">registerTool</span>(
  <span class="hljs-string">'sum'</span>,
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'两数求和'</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">'将两个数字相加'</span>,
    <span class="hljs-attr">inputSchema</span>: { <span class="hljs-attr">a</span>: z.<span class="hljs-title function_">number</span>(), <span class="hljs-attr">b</span>: z.<span class="hljs-title function_">number</span>() },
    <span class="hljs-attr">outputSchema</span>: { <span class="hljs-attr">result</span>: z.<span class="hljs-title function_">number</span>() }
  },
  <span class="hljs-keyword">async</span> ({ a, b }) =&gt; {
    <span class="hljs-keyword">const</span> output = { <span class="hljs-attr">result</span>: a + b };
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">content</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(output) }],
      <span class="hljs-attr">structuredContent</span>: output
    };
  }
);

server.<span class="hljs-title function_">registerTool</span>(
  <span class="hljs-string">'createFile'</span>,
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'创建文件'</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">'将内容添加到文件中'</span>,
    <span class="hljs-attr">inputSchema</span>: { <span class="hljs-attr">filename</span>: z.<span class="hljs-title function_">string</span>(), <span class="hljs-attr">content</span>: z.<span class="hljs-title function_">string</span>() }
  },
  <span class="hljs-keyword">async</span> ({ filename, content }) =&gt; {
    <span class="hljs-keyword">try</span> {
      fs.<span class="hljs-title function_">writeFileSync</span>(filename, content);
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">content</span>: [
          {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
            <span class="hljs-attr">text</span>: <span class="hljs-string">'文件创建成功！'</span>
          }
        ]
      };
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">content</span>: [
          {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
            <span class="hljs-attr">text</span>: err.<span class="hljs-property">message</span> || <span class="hljs-string">'文件创建失败！'</span>
          }
        ]
      };
    }
  }
);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/mcp'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHTTPServerTransport</span>({
    <span class="hljs-attr">sessionIdGenerator</span>: <span class="hljs-literal">undefined</span>,
    <span class="hljs-attr">enableJsonResponse</span>: <span class="hljs-literal">true</span>
  });

  res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
    transport.<span class="hljs-title function_">close</span>();
  });

  <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport);
  <span class="hljs-keyword">await</span> transport.<span class="hljs-title function_">handleRequest</span>(req, res, req.<span class="hljs-property">body</span>);
});

<span class="hljs-keyword">const</span> port = <span class="hljs-built_in">parseInt</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-string">'3000'</span>);
app
  .<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Demo MCP Server running on http://localhost:<span class="hljs-subst">${port}</span>/mcp`</span>);
  })
  .<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Server error:'</span>, error);
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
  });
</code></pre>
<h5 data-id="heading-16">使用@modelcontextprotocol/inspector调试</h5>
<ul>
<li>需要先使用<code>node ./src/streamableHttp.js</code>命令启动服务</li>
<li>再开一个命令行窗口运行<code>npx @modelcontextprotocol/inspector</code>命令启动MCP检查器</li>
<li>打开的浏览器窗口里参数如下，点击<em>Connect</em>就可以在右侧调试工具函数了
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3902813266864658aa74c70db2e228fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTG92ZURyZWFNaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767249048&amp;x-signature=ibbbIbh3Xpa6P0P%2Bn4a0vzlF4Z8%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h5 data-id="heading-17">使用LLM客户端调试(以Cursor举例，其他的配置差不多)</h5>
<ul>
<li>需要先使用<code>node ./src/streamableHttp.js</code>命令启动服务</li>
<li>修改mcp.json文件里的配置如下，然后就可以在对话窗口调试了</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"my-mcp-server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"transport"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:3000/mcp"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Vue样式中使用JavaScript 变量（CSS 变量注入）]]></title>    <link>https://juejin.cn/post/7587392473851379758</link>    <guid>https://juejin.cn/post/7587392473851379758</guid>    <pubDate>2025-12-25T06:36:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587392473851379758" data-draft-id="7587313610696196123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Vue样式中使用JavaScript 变量（CSS 变量注入）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-25T06:36:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Drift_Dream"/> <meta itemprop="url" content="https://juejin.cn/user/3107677514241500"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Vue样式中使用JavaScript 变量（CSS 变量注入）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3107677514241500/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Drift_Dream
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:36:56.000Z" title="Thu Dec 25 2025 06:36:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">基本介绍</h2>
<p>在 Vue 3.2+ 版本中，我们可以直接在 <code>&lt;style&gt;</code>标签中使用响应式的 JavaScript 变量，这被称为 <strong>CSS 变量注入</strong>​ 或 <strong>v-bind in CSS</strong>。这个功能让我们能够：</p>
<ol>
<li>
<p><strong>动态修改样式</strong>：在脚本中定义的响应式变量可以直接在样式中引用</p>
</li>
<li>
<p><strong>减少样式类切换</strong>：不再需要为不同的状态定义多个 CSS 类</p>
</li>
<li>
<p><strong>实现主题切换</strong>：轻松实现动态主题色切换功能</p>
</li>
<li>
<p><strong>响应式设计</strong>：让 CSS 能够响应组件状态的变化</p>
</li>
</ol>
<p>简单说，就是<strong>让你在 CSS 中直接使用 Vue 的响应式数据</strong>，当数据变化时，样式会自动更新！</p>
<h2 data-id="heading-1">简单示例-黑色-亮色主题切换</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"base-case-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>动态主题切换示例<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggle()"</span>&gt;</span>切换主题<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> { useToggle } <span class="hljs-keyword">from</span> <span class="hljs-string">"@vueuse/core"</span>;

<span class="hljs-keyword">const</span> [isDarkMode, toggle] = <span class="hljs-title function_">useToggle</span>();

<span class="hljs-keyword">const</span> fontSize = ref&lt;string&gt;(<span class="hljs-string">"16px"</span>);
<span class="hljs-keyword">const</span> textColor = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> (isDarkMode.<span class="hljs-property">value</span> ? <span class="hljs-string">"#ffffff"</span> : <span class="hljs-string">"#333333"</span>));
<span class="hljs-keyword">const</span> backgroundColor = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span>
  isDarkMode.<span class="hljs-property">value</span> ? <span class="hljs-string">"#1a1a1a"</span> : <span class="hljs-string">"#f5f5f5"</span>
);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.base-case-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">v-bind</span>(fontSize);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">v-bind</span>(textColor);
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">v-bind</span>(backgroundColor);
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
}
&lt;/style
</span></code></pre>
<h2 data-id="heading-2">项目实战-动态主题切换系统</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"theme-container"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"customStyles"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>动态主题系统<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"theme-controls"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"color-picker"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>主色：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"color"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"theme.primary"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slider-control"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>字体大小：{{ theme.fontSize }}px<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"theme.fontSize"</span> <span class="hljs-attr">min</span>=<span class="hljs-string">"12"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"24"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slider-control"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>圆角：{{ theme.borderRadius }}px<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"range"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"theme.borderRadius"</span> <span class="hljs-attr">min</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"20"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-secondary"</span>&gt;</span>次要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>卡片标题<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个使用动态主题的卡片组件<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"alert"</span>&gt;</span>这是一个提示信息<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-comment">// 主题配置</span>
<span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">primary</span>: <span class="hljs-string">"#4a90e2"</span>,
  <span class="hljs-attr">secondary</span>: <span class="hljs-string">"#7b61ff"</span>,
  <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>,
  <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">8</span>,
  <span class="hljs-attr">spacing</span>: <span class="hljs-number">20</span>,
});

<span class="hljs-comment">// 计算其他衍生颜色</span>
<span class="hljs-keyword">const</span> themeColors = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">primaryLight</span>: <span class="hljs-title function_">lightenColor</span>(theme.<span class="hljs-property">primary</span>, <span class="hljs-number">30</span>),
    <span class="hljs-attr">primaryDark</span>: <span class="hljs-title function_">darkenColor</span>(theme.<span class="hljs-property">primary</span>, <span class="hljs-number">20</span>),
    <span class="hljs-attr">secondaryLight</span>: <span class="hljs-title function_">lightenColor</span>(theme.<span class="hljs-property">secondary</span>, <span class="hljs-number">30</span>),
  };
});

<span class="hljs-comment">// 工具函数：颜色变亮</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">lightenColor</span>(<span class="hljs-params">color, percent</span>) {
  <span class="hljs-comment">// 1. 移除#号，将十六进制转为十进制整数</span>
  <span class="hljs-keyword">const</span> num = <span class="hljs-built_in">parseInt</span>(color.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'#'</span>, <span class="hljs-string">''</span>), <span class="hljs-number">16</span>)  <span class="hljs-comment">// "#4a90e2" → 0x4a90e2 = 4890850</span>
  
  <span class="hljs-comment">// 2. 计算调整量</span>
  <span class="hljs-comment">// 255的百分比 → 每个颜色分量最大可增加的值</span>
  <span class="hljs-keyword">const</span> amt = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-number">2.55</span> * percent)  <span class="hljs-comment">// 例如percent=30 → 2.55 * 30=76.5 → 77</span>
  
  <span class="hljs-comment">// 3. 分解RGB分量</span>
  <span class="hljs-keyword">const</span> R = (num &gt;&gt; <span class="hljs-number">16</span>) + amt         <span class="hljs-comment">// 红色分量：右移16位</span>
  <span class="hljs-keyword">const</span> G = (num &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0x00FF</span>) + amt  <span class="hljs-comment">// 绿色分量：右移8位后与0x00FF进行与运算</span>
  <span class="hljs-keyword">const</span> B = (num &amp; <span class="hljs-number">0x0000FF</span>) + amt     <span class="hljs-comment">// 蓝色分量：与0x0000FF进行与运算</span>
  
  <span class="hljs-comment">// 4. 确保分量在0-255范围内</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">'#'</span> + (
    <span class="hljs-number">0x1000000</span> +  <span class="hljs-comment">// 保证结果始终是7位十六进制数</span>
    
    <span class="hljs-comment">// 三元运算符确保值在有效范围内</span>
    (R &lt; <span class="hljs-number">255</span> ? R &lt; <span class="hljs-number">1</span> ? <span class="hljs-number">0</span> : R : <span class="hljs-number">255</span>) * <span class="hljs-number">0x10000</span> +  <span class="hljs-comment">// 红色分量</span>
    (G &lt; <span class="hljs-number">255</span> ? G &lt; <span class="hljs-number">1</span> ? <span class="hljs-number">0</span> : G : <span class="hljs-number">255</span>) * <span class="hljs-number">0x100</span> +     <span class="hljs-comment">// 绿色分量</span>
    (B &lt; <span class="hljs-number">255</span> ? B &lt; <span class="hljs-number">1</span> ? <span class="hljs-number">0</span> : B : <span class="hljs-number">255</span>)               <span class="hljs-comment">// 蓝色分量</span>
    
  ).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>)  <span class="hljs-comment">// 转换为十六进制并去掉开头的1</span>
}

<span class="hljs-comment">// 工具函数：颜色变暗</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">darkenColor</span>(<span class="hljs-params">color, percent</span>) {
  <span class="hljs-comment">// 1. 十六进制转十进制</span>
  <span class="hljs-keyword">const</span> num = <span class="hljs-built_in">parseInt</span>(color.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'#'</span>, <span class="hljs-string">''</span>), <span class="hljs-number">16</span>)
  
  <span class="hljs-comment">// 2. 计算减少量</span>
  <span class="hljs-keyword">const</span> amt = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-number">2.55</span> * percent)  <span class="hljs-comment">// 百分比转换为实际减少值</span>
  
  <span class="hljs-comment">// 3. 减少每个分量</span>
  <span class="hljs-keyword">const</span> R = (num &gt;&gt; <span class="hljs-number">16</span>) - amt
  <span class="hljs-keyword">const</span> G = (num &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0x00FF</span>) - amt
  <span class="hljs-keyword">const</span> B = (num &amp; <span class="hljs-number">0x0000FF</span>) - amt
  
  <span class="hljs-comment">// 4. 确保值不小于0</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">'#'</span> + (
    <span class="hljs-number">0x1000000</span> +
    (R &gt; <span class="hljs-number">0</span> ? R : <span class="hljs-number">0</span>) * <span class="hljs-number">0x10000</span> +  <span class="hljs-comment">// 如果R&gt;0，使用R，否则为0</span>
    (G &gt; <span class="hljs-number">0</span> ? G : <span class="hljs-number">0</span>) * <span class="hljs-number">0x100</span> +
    (B &gt; <span class="hljs-number">0</span> ? B : <span class="hljs-number">0</span>)
  ).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.theme-container</span> {
  <span class="hljs-comment">/* 直接使用响应式变量 */</span>
  <span class="hljs-attr">--primary-color</span>: <span class="hljs-built_in">v-bind</span>(<span class="hljs-string">"theme.primary"</span>);
  <span class="hljs-attr">--secondary-color</span>: <span class="hljs-built_in">v-bind</span>(<span class="hljs-string">"theme.secondary"</span>);
  <span class="hljs-attr">--font-size</span>: <span class="hljs-built_in">v-bind</span>(<span class="hljs-string">'theme.fontSize + "px"'</span>);
  <span class="hljs-attr">--border-radius</span>: <span class="hljs-built_in">v-bind</span>(<span class="hljs-string">'theme.borderRadius + "px"'</span>);
  <span class="hljs-attr">--spacing</span>: <span class="hljs-built_in">v-bind</span>(<span class="hljs-string">'theme.spacing + "px"'</span>);

  <span class="hljs-comment">/* 使用计算属性 */</span>
  <span class="hljs-attr">--primary-light</span>: <span class="hljs-built_in">v-bind</span>(<span class="hljs-string">"themeColors.primaryLight"</span>);
  <span class="hljs-attr">--primary-dark</span>: <span class="hljs-built_in">v-bind</span>(<span class="hljs-string">"themeColors.primaryDark"</span>);
  <span class="hljs-attr">--secondary-light</span>: <span class="hljs-built_in">v-bind</span>(<span class="hljs-string">"themeColors.secondaryLight"</span>);

  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">var</span>(--spacing);
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">var</span>(--font-size);
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-selector-class">.header</span> {
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--spacing) * <span class="hljs-number">2</span>);
    <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-built_in">var</span>(--spacing);
    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">2px</span> solid <span class="hljs-built_in">var</span>(--primary-light);
    <span class="hljs-selector-class">.theme-controls</span> {
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fit, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">200px</span>, <span class="hljs-number">1</span>fr));
      <span class="hljs-attribute">gap</span>: <span class="hljs-built_in">var</span>(--spacing);
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-built_in">var</span>(--spacing);
    }
  }
}
<span class="hljs-selector-class">.content</span> {
  <span class="hljs-selector-class">.btn</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span> <span class="hljs-number">24px</span>;
    <span class="hljs-attribute">border</span>: none;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-built_in">var</span>(--border-radius);
    <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--font-size) * <span class="hljs-number">0.875</span>);
    <span class="hljs-attribute">cursor</span>: pointer;
    <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.2s</span> ease;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">8px</span>;
    &amp;<span class="hljs-selector-class">.btn-primary</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--primary-color);
      <span class="hljs-attribute">color</span>: white;
    }

    &amp;<span class="hljs-selector-class">.btn-primary</span><span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--primary-dark);
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>);
    }

    &amp;<span class="hljs-selector-class">.btn-secondary</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--secondary-color);
      <span class="hljs-attribute">color</span>: white;
    }

    &amp;<span class="hljs-selector-class">.btn-secondary</span><span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--secondary-light);
    }
  }

  <span class="hljs-selector-class">.card</span> {
    <span class="hljs-attribute">background</span>: white;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-built_in">var</span>(--border-radius);
    <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">var</span>(--spacing);
    <span class="hljs-attribute">margin</span>: <span class="hljs-built_in">var</span>(--spacing) <span class="hljs-number">0</span>;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">8px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
    <span class="hljs-attribute">border-left</span>: <span class="hljs-number">4px</span> solid <span class="hljs-built_in">var</span>(--primary-color);
  }

  <span class="hljs-selector-class">.alert</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--primary-light);
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--primary-color);
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-built_in">var</span>(--border-radius);
    <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--spacing) * <span class="hljs-number">0.75</span>);
    <span class="hljs-attribute">margin</span>: <span class="hljs-built_in">var</span>(--spacing) <span class="hljs-number">0</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--primary-dark);
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-3">注意事项和最佳实践</h2>
<h3 data-id="heading-4">性能考虑</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 避免频繁更新的变量用于样式绑定</span>
<span class="hljs-comment">// 不推荐：频繁变化的值</span>
<span class="hljs-keyword">const</span> scrollPosition = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)  <span class="hljs-comment">// 滚动时频繁变化</span>

<span class="hljs-comment">// 推荐：变化不频繁的值</span>
<span class="hljs-keyword">const</span> themeColor = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'#3498db'</span>)
<span class="hljs-keyword">const</span> fontSize = <span class="hljs-title function_">ref</span>(<span class="hljs-number">16</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">兼容性处理</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 提供回退方案 */</span>
<span class="hljs-selector-class">.element</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#3498db</span>; <span class="hljs-comment">/* 回退值 */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">v-bind</span>(themeColor);
  
  <span class="hljs-comment">/* 对于不支持 CSS 变量的浏览器 */</span>
  <span class="hljs-keyword">@supports</span> <span class="hljs-keyword">not</span> (<span class="hljs-attribute">color</span>: v-bind(themeColor)) {
    <span class="hljs-comment">/* 备用样式 */</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">结合 CSS 自定义属性</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 在 :root 或组件中定义 CSS 变量 */</span>
<span class="hljs-selector-class">.component</span> {
  <span class="hljs-attr">--primary-color</span>: <span class="hljs-built_in">v-bind</span>(primaryColor);
  <span class="hljs-attr">--secondary-color</span>: <span class="hljs-built_in">v-bind</span>(secondaryColor);
  
  <span class="hljs-comment">/* 在组件内重复使用 */</span>
  <span class="hljs-selector-class">.child</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--primary-color);
  }
  
  <span class="hljs-selector-class">.another-child</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--secondary-color);
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-7">总结</h2>
<p>Vue 样式中的 JavaScript 变量功能为前端开发带来了革命性的变化：</p>
<ul>
<li>
<p><strong>更灵活的样式控制</strong>：样式可以响应数据变化</p>
</li>
<li>
<p><strong>代码更简洁</strong>：减少样式类切换的逻辑</p>
</li>
<li>
<p><strong>主题系统更强大</strong>：轻松实现动态主题</p>
</li>
<li>
<p><strong>更好的开发体验</strong>：在 Vue 单文件组件中实现样式逻辑一体化</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[UniApp 请求封装实战：优雅实现 Token 无感刷新（附完整代码）]]></title>    <link>https://juejin.cn/post/7587412021710159878</link>    <guid>https://juejin.cn/post/7587412021710159878</guid>    <pubDate>2025-12-25T06:38:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587412021710159878" data-draft-id="7587357373728718884" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="UniApp 请求封装实战：优雅实现 Token 无感刷新（附完整代码）"/> <meta itemprop="keywords" content="uni-app"/> <meta itemprop="datePublished" content="2025-12-25T06:38:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MoMoDad"/> <meta itemprop="url" content="https://juejin.cn/user/2788017221151342"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            UniApp 请求封装实战：优雅实现 Token 无感刷新（附完整代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017221151342/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MoMoDad
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:38:34.000Z" title="Thu Dec 25 2025 06:38:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 UniApp 跨端开发中，基于 Token 的接口鉴权是最常见的身份验证方式。但 Token 有过期时间，传统处理方式是遇到 401 状态码直接跳转登录页，用户体验极差 —— 比如用户正在填写表单，突然提示登录过期，之前的操作全部白费。</p>
<p>本文将分享一套生产级的 UniApp request 请求封装方案，核心实现<strong>Token 过期后的无感刷新</strong>：无需用户手动操作，自动刷新 Token 并重试所有过期请求，仅当刷新 Token 失败时才引导用户重新登录。</p>
<h2 data-id="heading-0">核心思路</h2>
<p>无感刷新的关键是解决「多个请求同时触发 401」和「刷新 Token 期间的请求等待」问题，核心逻辑如下：</p>
<ol>
<li>拦截接口返回的 401 状态码（Token 过期）；</li>
<li>用<code>isRefreshing</code>标记位防止多个请求同时调用刷新 Token 接口；</li>
<li>将所有触发 401 的请求存入<code>requests</code>队列，等待 Token 刷新完成后统一重试；</li>
<li>调用刷新 Token 接口获取新 Token，更新本地存储；</li>
<li>用新 Token 重试队列中的所有请求，实现「无感」体验；</li>
<li>若刷新 Token 失败（如 RefreshToken 过期），则引导用户重新登录。</li>
</ol>
<h2 data-id="heading-1">完整代码实现</h2>
<p>以下是封装后的<code>request.js</code>完整代码，包含详细注释，可直接接入项目使用：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store'</span>
<span class="hljs-keyword">import</span> config <span class="hljs-keyword">from</span> <span class="hljs-string">'@/config'</span>
<span class="hljs-comment">// 封装Token的存储/获取/清除（建议单独抽离，方便替换存储方式）</span>
<span class="hljs-keyword">import</span> {
  getToken,
  setToken,
  clearToken,
  setRefreshToken,
  getRefreshToken,
  removeRefreshToken
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth'</span>
<span class="hljs-keyword">import</span> errorCode <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/errorCode'</span> <span class="hljs-comment">// 错误码映射表</span>
<span class="hljs-keyword">import</span> { toast, showConfirm, tansParams } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/common'</span> <span class="hljs-comment">// 通用工具函数</span>

<span class="hljs-comment">// 请求超时时间</span>
<span class="hljs-keyword">let</span> timeout = <span class="hljs-number">10000</span>
<span class="hljs-comment">// 接口基础地址（从配置文件读取）</span>
<span class="hljs-keyword">const</span> baseUrl = config.<span class="hljs-property">baseUrl</span>

<span class="hljs-comment">// 核心标记：是否正在刷新Token（避免重复刷新）</span>
<span class="hljs-keyword">let</span> isRefreshing = <span class="hljs-literal">false</span>
<span class="hljs-comment">// 核心队列：存储401失败的请求，刷新Token后重试</span>
<span class="hljs-keyword">let</span> requests = []

<span class="hljs-comment">/**
 * 封装后的请求核心函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">config</span> - 请求配置（url/method/data/header等）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">request</span> = config =&gt; {
  <span class="hljs-comment">// 是否需要携带Token（部分接口无需鉴权，可通过header.isToken=false关闭）</span>
  <span class="hljs-keyword">const</span> isToken = (config.<span class="hljs-property">headers</span> || {}).<span class="hljs-property">isToken</span> === <span class="hljs-literal">false</span>
  config.<span class="hljs-property">header</span> = config.<span class="hljs-property">header</span> || {}
  
  <span class="hljs-comment">// 携带Token（Bearer认证格式）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getToken</span>() &amp;&amp; !isToken) {
    config.<span class="hljs-property">header</span>[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer '</span> + <span class="hljs-title function_">getToken</span>()
  }

  <span class="hljs-comment">// GET请求参数拼接（将params转为url参数）</span>
  <span class="hljs-keyword">if</span> (config.<span class="hljs-property">params</span>) {
    <span class="hljs-keyword">let</span> url = config.<span class="hljs-property">url</span> + <span class="hljs-string">'?'</span> + <span class="hljs-title function_">tansParams</span>(config.<span class="hljs-property">params</span>)
    url = url.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)
    config.<span class="hljs-property">url</span> = url
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    uni.<span class="hljs-title function_">request</span>({
      <span class="hljs-attr">method</span>: config.<span class="hljs-property">method</span> || <span class="hljs-string">'GET'</span>,
      <span class="hljs-attr">timeout</span>: config.<span class="hljs-property">timeout</span> || timeout,
      <span class="hljs-attr">url</span>: baseUrl + config.<span class="hljs-property">url</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'/api'</span>, <span class="hljs-string">''</span>), <span class="hljs-comment">// 适配后端接口路径（按需调整）</span>
      <span class="hljs-attr">data</span>: config.<span class="hljs-property">data</span>,
      <span class="hljs-attr">header</span>: config.<span class="hljs-property">header</span>,
      <span class="hljs-attr">dataType</span>: <span class="hljs-string">'json'</span>
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
      <span class="hljs-keyword">let</span> [error, res] = response
      
      <span class="hljs-comment">// 网络层错误（如超时、断网）</span>
      <span class="hljs-keyword">if</span> (error) {
        <span class="hljs-title function_">toast</span>(<span class="hljs-string">'系统异常请联系管理员'</span>)
        <span class="hljs-title function_">reject</span>(<span class="hljs-string">'系统异常请联系管理员'</span>)
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-comment">// 业务层状态码处理</span>
      <span class="hljs-keyword">const</span> code = res.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> || <span class="hljs-number">200</span>
      <span class="hljs-keyword">const</span> msg = errorCode[code] || res.<span class="hljs-property">data</span>.<span class="hljs-property">msg</span> || errorCode[<span class="hljs-string">'default'</span>]

      <span class="hljs-comment">// 核心：拦截401 Token过期</span>
      <span class="hljs-keyword">if</span> (code === <span class="hljs-number">401</span>) {
        <span class="hljs-title function_">handle401Error</span>(config, resolve, reject)
      }
      <span class="hljs-comment">// 500服务器错误</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (code === <span class="hljs-number">500</span>) {
        <span class="hljs-title function_">toast</span>(msg)
        <span class="hljs-title function_">reject</span>(<span class="hljs-string">'500'</span>)
      }
      <span class="hljs-comment">// 其他业务错误</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (code !== <span class="hljs-number">200</span>) {
        <span class="hljs-title function_">toast</span>(msg)
        <span class="hljs-title function_">reject</span>(code)
      }
      <span class="hljs-comment">// 请求成功</span>
      <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">resolve</span>(res.<span class="hljs-property">data</span>)
      }
    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-comment">// 网络异常兜底处理</span>
      <span class="hljs-keyword">let</span> { message } = error
      <span class="hljs-keyword">if</span> (message === <span class="hljs-string">'Network Error'</span>) {
        message = <span class="hljs-string">'后端接口连接异常'</span>
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (message.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'timeout'</span>)) {
        message = <span class="hljs-string">'系统接口请求超时'</span>
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (message.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'Request failed with status code'</span>)) {
        message = <span class="hljs-string">'系统接口'</span> + message.<span class="hljs-title function_">substr</span>(message.<span class="hljs-property">length</span> - <span class="hljs-number">3</span>) + <span class="hljs-string">'异常'</span>
      }
      <span class="hljs-title function_">toast</span>(message)
      <span class="hljs-title function_">reject</span>(error)
    })
  })
}

<span class="hljs-comment">/**
 * 核心：401错误处理（无感刷新Token + 重试请求）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">config</span> - 原请求配置
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">resolve</span> - 原请求的resolve
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">reject</span> - 原请求的reject
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handle401Error</span>(<span class="hljs-params">config, resolve, reject</span>) {
  <span class="hljs-comment">// 封装重试逻辑：用新Token重新发起请求</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">retryRequest</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getToken</span>()) {
      config.<span class="hljs-property">header</span>[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer '</span> + <span class="hljs-title function_">getToken</span>()
    }
    <span class="hljs-title function_">request</span>(config).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-title function_">resolve</span>(res)).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title function_">reject</span>(err))
  }

  <span class="hljs-comment">// 若正在刷新Token，将当前请求加入队列等待</span>
  <span class="hljs-keyword">if</span> (isRefreshing) {
    requests.<span class="hljs-title function_">push</span>(retryRequest)
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-comment">// 标记为「正在刷新Token」，防止并发请求重复刷新</span>
  isRefreshing = <span class="hljs-literal">true</span>

  <span class="hljs-comment">// 调用刷新Token接口</span>
  <span class="hljs-title function_">refreshToken</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">newToken</span>) =&gt;</span> {
      <span class="hljs-comment">// 刷新成功：更新Token + 重试所有排队请求</span>
      <span class="hljs-title function_">setToken</span>(newToken) <span class="hljs-comment">// 存储新Token</span>
      requests.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>()) <span class="hljs-comment">// 批量重试队列中的请求</span>
      requests = [] <span class="hljs-comment">// 清空队列</span>
      <span class="hljs-title function_">retryRequest</span>() <span class="hljs-comment">// 重试当前请求</span>
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 刷新失败（如RefreshToken过期）：引导用户重新登录</span>
      <span class="hljs-title function_">showConfirm</span>(<span class="hljs-string">'登录状态已过期，您可以继续留在该页面，或者重新登录？'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (res.<span class="hljs-property">confirm</span>) {
          <span class="hljs-comment">// 优化：记录当前页面路径，登录后可跳转回来</span>
          <span class="hljs-keyword">const</span> currentPages = <span class="hljs-title function_">getCurrentPages</span>()
          <span class="hljs-keyword">const</span> currentPage = currentPages[currentPages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
          <span class="hljs-keyword">const</span> redirectUrl = currentPage ? currentPage.<span class="hljs-property">route</span> : <span class="hljs-string">'pages/index/index'</span>
          <span class="hljs-comment">// 跳转登录页（替换为你的实际登录页路径）</span>
          uni.<span class="hljs-title function_">reLaunch</span>({
            <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/login/login?redirect=<span class="hljs-subst">${redirectUrl}</span>`</span>
          })
        }
      })
      <span class="hljs-comment">// 拒绝所有排队请求</span>
      requests.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cb</span> =&gt;</span> <span class="hljs-title function_">cb</span>())
      requests = []
      <span class="hljs-title function_">reject</span>(<span class="hljs-string">'会话已过期，请重新登录'</span>)
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 无论刷新成功/失败，解除「正在刷新」标记</span>
      isRefreshing = <span class="hljs-literal">false</span>
    })
}

<span class="hljs-comment">/**
 * 调用后端刷新Token接口
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;string&gt;</span>} 新的Access Token
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">refreshToken</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    uni.<span class="hljs-title function_">request</span>({
      <span class="hljs-attr">url</span>: baseUrl + <span class="hljs-string">'/system/appUser/app/refreshToken'</span>, <span class="hljs-comment">// 替换为你的刷新Token接口</span>
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">header</span>: {
        <span class="hljs-comment">// 携带RefreshToken（后端需约定鉴权方式）</span>
        <span class="hljs-string">'refreshToken'</span>: <span class="hljs-title function_">getRefreshToken</span>()
      },
      <span class="hljs-attr">timeout</span>: timeout,
      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> { code, token } = res.<span class="hljs-property">data</span>
        <span class="hljs-comment">// 刷新成功（需后端返回新Token）</span>
        <span class="hljs-keyword">if</span> (code === <span class="hljs-number">200</span> &amp;&amp; token) {
          <span class="hljs-title function_">resolve</span>(token)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'刷新Token失败'</span>))
        }
      },
      <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-title function_">toast</span>(<span class="hljs-string">'刷新登录状态失败'</span>)
        <span class="hljs-title function_">reject</span>(err)
      }
    })
  })
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> request
</code></pre>
<h2 data-id="heading-2">关键模块解析</h2>
<h3 data-id="heading-3">1. 辅助层准备（必看）</h3>
<p>封装前需要先实现 3 个辅助文件，保证代码可运行：</p>
<ul>
<li>
<p><code>auth.js</code>：Token 的本地存储（基于<code>uni.setStorageSync</code>）</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 存储Token</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">setToken</span> = (<span class="hljs-params">token</span>) =&gt; uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'token'</span>, token)
<span class="hljs-comment">// 获取Token</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getToken</span> = (<span class="hljs-params"/>) =&gt; uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'token'</span>) || <span class="hljs-string">''</span>
<span class="hljs-comment">// 清除Token</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearToken</span> = (<span class="hljs-params"/>) =&gt; uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>)
<span class="hljs-comment">// RefreshToken同理（略）</span>
</code></pre>
</li>
<li>
<p><code>errorCode.js</code>：业务错误码映射（如 401=“登录过期”）</p>
</li>
<li>
<p><code>common.js</code>：通用工具函数（toast 提示、confirm 确认框、参数拼接）</p>
</li>
</ul>
<h3 data-id="heading-4">2. 核心状态控制</h3>
<ul>
<li><code>isRefreshing</code>：布尔值，标记是否正在刷新 Token，防止多个 401 请求同时调用刷新接口，造成资源浪费；</li>
<li><code>requests</code>：数组，存储所有因 401 失败的请求重试函数，刷新完成后批量执行。</li>
</ul>
<h3 data-id="heading-5">3. 401 处理逻辑（核心）</h3>
<p><code>handle401Error</code>函数是整个无感刷新的核心：</p>
<ol>
<li><strong>重试封装</strong>：<code>retryRequest</code>函数负责用新 Token 重新发起原请求；</li>
<li><strong>队列等待</strong>：若正在刷新 Token，将重试函数加入队列；</li>
<li><strong>刷新 Token</strong>：未刷新时标记状态，调用<code>refreshToken</code>接口；</li>
<li><strong>刷新成功</strong>：更新 Token、重试队列所有请求、重试当前请求；</li>
<li><strong>刷新失败</strong>：弹出确认框，引导用户登录（携带原页面路径，登录后可返回）；</li>
<li><strong>状态重置</strong>：无论成败，最终解除<code>isRefreshing</code>标记。</li>
</ol>
<h3 data-id="heading-6">4. 刷新 Token 接口</h3>
<p><code>refreshToken</code>函数调用后端的刷新接口，注意：</p>
<ul>
<li>后端需提供专门的刷新 Token 接口（如<code>/app/refreshToken</code>）；</li>
<li>请求头需携带<code>RefreshToken</code>（有效期长于 Access Token）；</li>
<li>成功后返回新的 Access Token，失败则触发登录逻辑。</li>
</ul>
<h2 data-id="heading-7">使用示例</h2>
<p>封装完成后，在 API 层直接调用即可，无需关心 Token 刷新逻辑：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// api/user.js</span>
<span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/request'</span>

<span class="hljs-comment">// 获取用户信息</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserInfo</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/system/user/info'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>
  })
}

<span class="hljs-comment">// 提交表单</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">submitForm</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/system/form/submit'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    data
  })
}
</code></pre>
<h2 data-id="heading-8">实战优化点</h2>
<h3 data-id="heading-9">1. 登录跳转优化</h3>
<p>代码中已实现「跳转登录页携带原页面路径」，登录成功后可解析<code>redirect</code>参数，跳转回用户之前操作的页面：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 登录页逻辑</span>
<span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">redirectUrl</span> = options.<span class="hljs-property">redirect</span> || <span class="hljs-string">'pages/index/index'</span>
},
<span class="hljs-comment">// 登录成功后</span>
uni.<span class="hljs-title function_">reLaunch</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">`/<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.redirectUrl}</span>`</span>
})
</code></pre>
<h3 data-id="heading-10">2. 边界场景处理</h3>
<ul>
<li>
<p><strong>多端兼容</strong>：<code>uni.request</code>和<code>getCurrentPages</code>是 UniApp 跨端 API，H5 / 小程序 / APP 均兼容；</p>
</li>
<li>
<p><strong>网络异常</strong>：对超时、断网等情况做了兜底提示，提升用户感知；</p>
</li>
<li>
<p><strong>无 Token 请求</strong>：部分接口（如登录、注册）无需鉴权，可通过<code>header.isToken=false</code>关闭 Token 携带：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 登录接口（无需Token）</span>
export <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">login</span> = (data) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">request</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/system/login'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    data,
    <span class="hljs-attr">header</span>: { <span class="hljs-attr">isToken</span>: <span class="hljs-literal">false</span> }
  })
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-11">3. 生产环境适配</h3>
<ul>
<li>可将<code>baseUrl</code>按环境区分（开发 / 测试 / 生产）；</li>
<li>增加请求 / 响应拦截器（如添加日志、加密参数）；</li>
<li>结合 Vuex 管理用户状态，刷新 Token 后同步更新 store。</li>
</ul>
<h2 data-id="heading-12">注意事项</h2>
<ol>
<li><strong>后端约定</strong>：必须和后端约定好 Token 规则（过期状态码 401、刷新接口地址、RefreshToken 传递方式）；</li>
<li><strong>RefreshToken 存储</strong>：建议<code>RefreshToken</code>单独存储，且有效期设置为 7 天 / 30 天（长于 Access Token 的 2 小时）；</li>
<li><strong>并发请求</strong>：该方案完美处理并发请求的 401 问题，比如页面初始化时多个接口同时返回 401，只会触发一次刷新；</li>
<li><strong>登出逻辑</strong>：若项目有 Vuex 的登出 action，可替换代码中直接跳转登录的逻辑，清空用户信息。</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start[开始请求] --&gt; CheckToken{是否需要Token?}
    
    CheckToken --&gt;|是| AddToken[添加Authorization头]
    CheckToken --&gt;|否| ProcessURL
    
    AddToken --&gt; ProcessURL[处理URL参数]
    
    ProcessURL --&gt; Request[发送uni.request请求]
    
    Request --&gt; Response{请求结果}
    
    Response --&gt;|网络异常| NetworkError[显示错误并拒绝]
    Response --&gt;|成功返回| CheckCode{检查响应码}
    
    NetworkError --&gt; End[结束]
    
    CheckCode --&gt;|200| Success[返回数据并解析]
    CheckCode --&gt;|500| ServerError[显示错误并拒绝]
    CheckCode --&gt;|401| Handle401[&amp;#34;&lt;b&gt;处理401错误&lt;br&gt;(核心逻辑)&lt;/b&gt;&amp;#34;]
    CheckCode --&gt;|其他非200| OtherError[显示错误并拒绝]
    
    Success --&gt; End
    ServerError --&gt; End
    OtherError --&gt; End
    
    Handle401 --&gt; CheckRefreshing{&amp;#34;&lt;b&gt;是否正在刷新Token?&lt;br&gt;(防重复机制)&lt;/b&gt;&amp;#34;}
    
    CheckRefreshing --&gt;|是| AddToQueue[&amp;#34;&lt;b&gt;加入请求队列等待&lt;/b&gt;&amp;#34;]
    CheckRefreshing --&gt;|否| SetRefreshing[&amp;#34;&lt;b&gt;设置刷新标记为true&lt;/b&gt;&amp;#34;]
    
    AddToQueue --&gt; Wait[等待刷新完成]
    Wait --&gt; End
    
    SetRefreshing --&gt; CallRefresh[&amp;#34;&lt;b&gt;调用refreshToken接口&lt;/b&gt;&lt;br&gt;/system/appUser/app/refreshToken&amp;#34;]
    
    CallRefresh --&gt; RefreshResult{&amp;#34;&lt;b&gt;刷新结果&lt;/b&gt;&lt;br&gt;(成功/失败)&amp;#34;}
    
    RefreshResult --&gt;|成功| UpdateToken[&amp;#34;&lt;b&gt;更新Token&lt;/b&gt;&lt;br&gt;清空RefreshToken&amp;#34;]
    RefreshResult --&gt;|失败| ShowConfirm[&amp;#34;&lt;b&gt;显示登录过期确认框&lt;/b&gt;&lt;br&gt;(用户选择是否重新登录)&amp;#34;]
    
    UpdateToken --&gt; RetryQueue[&amp;#34;&lt;b&gt;重试队列中所有请求&lt;/b&gt;&lt;br&gt;(requests.forEach)&amp;#34;]
    RetryQueue --&gt; RetryCurrent[&amp;#34;&lt;b&gt;重试当前请求&lt;/b&gt;&lt;br&gt;(核心重试逻辑)&amp;#34;]
    RetryCurrent --&gt; ClearQueue[清空请求队列]
    ClearQueue --&gt; ResetFlag[重置刷新标记为false]
    
    ResetFlag --&gt; End
    
    ShowConfirm --&gt; ConfirmResult{用户选择}
    
    ConfirmResult --&gt;|确认| Logout[&amp;#34;&lt;b&gt;跳转到登录页&lt;/b&gt;&lt;br&gt;(带redirect参数)&amp;#34;]
    ConfirmResult --&gt;|取消| Continue
    
    Logout --&gt; RejectQueue[&amp;#34;&lt;b&gt;拒绝队列中所有请求&lt;/b&gt;&amp;#34;]
    Continue --&gt; RejectQueue
    
    RejectQueue --&gt; RejectCurrent[&amp;#34;&lt;b&gt;拒绝当前请求&lt;/b&gt;&amp;#34;]
    RejectCurrent --&gt; ResetFlag2[重置刷新标记为false]
    
    ResetFlag2 --&gt; End
    
    %% 样式定义
    classDef highlightNode fill:#fff2cc,stroke:#d6b656,stroke-width:3px,font-weight:bold
    classDef processNode fill:#d5e8d4,stroke:#82b366,stroke-width:2px
    classDef decisionNode fill:#ffe6cc,stroke:#d79b00,stroke-width:2px
    classDef errorNode fill:#f8cecc,stroke:#b85450,stroke-width:2px
    classDef endNode fill:#e1d5e7,stroke:#9673a6,stroke-width:2px
    
    %% 应用样式
    class Handle401,CallRefresh,UpdateToken,RetryQueue,RetryCurrent,Logout highlightNode
    class CheckRefreshing,RefreshResult,ConfirmResult decisionNode
    class NetworkError,ServerError,OtherError,RejectQueue,RejectCurrent errorNode
    class Start,End,Wait,ClearQueue,ResetFlag,ResetFlag2 endNode
    class AddToQueue,SetRefreshing,ShowConfirm processNode
</code></pre>
<h2 data-id="heading-13">总结</h2>
<p>这套请求封装方案解决了 UniApp 中 Token 过期的核心痛点，实现了「无感刷新」的极致用户体验：</p>
<ul>
<li>无需用户手动操作，Token 过期自动刷新；</li>
<li>并发请求不重复刷新，资源更高效；</li>
<li>刷新失败后友好引导登录，兼顾体验与安全。</li>
</ul>
<p>该方案已在多个生产级 UniApp 项目中验证，适配小程序、H5、APP 等多端，可直接复制使用，也可根据业务需求扩展（如添加请求防抖、缓存等）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个功能强大的 React Native 拖拽排序组件库，支持单列和多列布局，提供流畅的拖拽体验和自动滚动功能]]></title>    <link>https://juejin.cn/post/7587518397949263926</link>    <guid>https://juejin.cn/post/7587518397949263926</guid>    <pubDate>2025-12-25T06:47:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587518397949263926" data-draft-id="7587412021710209030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个功能强大的 React Native 拖拽排序组件库，支持单列和多列布局，提供流畅的拖拽体验和自动滚动功能"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-25T06:47:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一天前"/> <meta itemprop="url" content="https://juejin.cn/user/1662097123187623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个功能强大的 React Native 拖拽排序组件库，支持单列和多列布局，提供流畅的拖拽体验和自动滚动功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1662097123187623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一天前
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:47:36.000Z" title="Thu Dec 25 2025 06:47:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3ea258d26ed42eaabc51cf0300afbcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5aSp5YmN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250164&amp;x-signature=L6Ii%2F9qk9DtvmJrVTVd7k9n9o7Y%3D" alt="1.gif" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOnedayago%2Freact-native-drag-sort%2Ftree%2F2.0.0" target="_blank" title="https://github.com/Onedayago/react-native-drag-sort/tree/2.0.0" ref="nofollow noopener noreferrer">源码地址</a></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># react-native-drag-sort</span>
一个功能强大的 React Native 拖拽排序组件库，支持单列和多列布局，提供流畅的拖拽体验和自动滚动功能。

<span class="hljs-comment">## 功能特性</span>

- ✅ **长按拖拽**：长按 500ms 后开始拖拽，提供视觉反馈（缩放效果）
- ✅ **单列/多列布局**：支持自定义列数，灵活布局
- ✅ **自动滚动**：拖拽到边缘时自动触发外层 ScrollView 滚动
- ✅ **流畅动画**：使用 Animated API 实现平滑的位置切换动画
- ✅ **ScrollView 联动**：支持与外层 ScrollView 无缝集成
- ✅ **自定义间距**：支持设置行间距和列间距
- ✅ **性能优化**：使用 memo 和 lodash 进行性能优化

<span class="hljs-comment">## 安装</span>

<span class="hljs-comment">### 前置依赖</span>

本组件依赖 `react-native-gesture-handler`，请先安装：

```bash
npm install react-native-gesture-handler
<span class="hljs-comment"># 或</span>
yarn add react-native-gesture-handler
```

<span class="hljs-comment">### iOS 安装</span>

```bash
cd ios &amp;&amp; pod install &amp;&amp; cd ..
```

<span class="hljs-comment">### 使用组件</span>

```bash
<span class="hljs-comment"># 将组件文件复制到你的项目中，或通过 npm link 等方式引入</span>
```

<span class="hljs-comment">## 使用方法</span>

<span class="hljs-comment">### 基础用法（单列）</span>

```javascript
import React from 'react'<span class="hljs-comment">;</span>
import { Dimensions, View, Text } from 'react-native'<span class="hljs-comment">;</span>
import DragSortView from './lib/DragSortView'<span class="hljs-comment">;</span>

const <span class="hljs-attr">windowWidth</span> = Dimensions.get(<span class="hljs-string">'window'</span>).width<span class="hljs-comment">;</span>

const <span class="hljs-attr">MyComponent</span> = () =&gt; {
  const <span class="hljs-section">[data, setData]</span> = React.useState(<span class="hljs-section">['1', '2', '3', '4', '5']</span>)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">renderItem</span> = (item, index) =&gt; {
    return (
      &lt;View <span class="hljs-attr">style</span>={{
        width: windowWidth,
        height: 50,
        backgroundColor: 'red',
        justifyContent: 'center',
        alignItems: 'center'
      }}&gt;
        &lt;Text&gt;{item}&lt;/Text&gt;
      &lt;/View&gt;
    )<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return (
    &lt;DragSortView
      <span class="hljs-attr">column</span>={<span class="hljs-number">1</span>}
      <span class="hljs-attr">childrenWidth</span>={windowWidth}
      <span class="hljs-attr">childrenHeight</span>={<span class="hljs-number">50</span>}
      <span class="hljs-attr">renderItem</span>={renderItem}
      <span class="hljs-attr">rowSpace</span>={<span class="hljs-number">10</span>}
      <span class="hljs-attr">dataSource</span>={data}
      <span class="hljs-attr">onDragEnd</span>={(from, to, newData) =&gt; {
        console.log('从位置', from, '移动到位置', to)<span class="hljs-comment">;</span>
        setData(newData)<span class="hljs-comment">;</span>
      }}
    /&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">### 多列布局</span>

```javascript
import React from 'react'<span class="hljs-comment">;</span>
import { Dimensions, View, Text } from 'react-native'<span class="hljs-comment">;</span>
import DragSortView from './lib/DragSortView'<span class="hljs-comment">;</span>

const <span class="hljs-attr">windowWidth</span> = Dimensions.get(<span class="hljs-string">'window'</span>).width<span class="hljs-comment">;</span>

const <span class="hljs-attr">MyComponent</span> = () =&gt; {
  const <span class="hljs-section">[data, setData]</span> = React.useState(<span class="hljs-section">['1', '2', '3', '4', '5', '6']</span>)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">renderItem</span> = (item, index) =&gt; {
    return (
      &lt;View <span class="hljs-attr">style</span>={{
        width: (windowWidth - 10) / 2,
        height: 50,
        backgroundColor: 'blue',
        justifyContent: 'center',
        alignItems: 'center'
      }}&gt;
        &lt;Text&gt;{item}&lt;/Text&gt;
      &lt;/View&gt;
    )<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return (
    &lt;DragSortView
      <span class="hljs-attr">column</span>={<span class="hljs-number">2</span>}
      <span class="hljs-attr">childrenWidth</span>={(windowWidth - <span class="hljs-number">10</span>) / <span class="hljs-number">2</span>}
      <span class="hljs-attr">childrenHeight</span>={<span class="hljs-number">50</span>}
      <span class="hljs-attr">renderItem</span>={renderItem}
      <span class="hljs-attr">rowSpace</span>={<span class="hljs-number">10</span>}
      <span class="hljs-attr">columnSpace</span>={<span class="hljs-number">10</span>}
      <span class="hljs-attr">dataSource</span>={data}
      <span class="hljs-attr">onDragEnd</span>={(from, to, newData) =&gt; {
        setData(newData)<span class="hljs-comment">;</span>
      }}
    /&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">### 与 ScrollView 集成</span>

在 ScrollView 中使用时，需要提供三个 ref 来支持自动滚动功能。你可以在同一个 ScrollView 中放置多个 DragSortView：

```javascript
import React, { useRef } from 'react'<span class="hljs-comment">;</span>
import { Dimensions, ScrollView, Text, View } from 'react-native'<span class="hljs-comment">;</span>
import DragSortView from './lib/DragSortView'<span class="hljs-comment">;</span>

const <span class="hljs-attr">windowWidth</span> = Dimensions.get(<span class="hljs-string">'window'</span>).width<span class="hljs-comment">;</span>

const <span class="hljs-attr">MyComponent</span> = () =&gt; {
  const <span class="hljs-attr">scrollViewRef</span> = useRef(null)<span class="hljs-comment">; // 最外层 scrollView</span>
  const <span class="hljs-attr">scrollYRef</span> = useRef(<span class="hljs-number">0</span>)<span class="hljs-comment">; // 已经滚动的距离</span>
  const <span class="hljs-attr">scrollViewHeightRef</span> = useRef(<span class="hljs-number">0</span>)<span class="hljs-comment">; // 页面展示视图大小</span>

  const <span class="hljs-attr">renderOneItem</span> = (item, index) =&gt; {
    return (
      &lt;View <span class="hljs-attr">style</span>={{
        width: windowWidth,
        height: 50,
        backgroundColor: 'red',
        justifyContent: 'center',
        alignItems: 'center'
      }}&gt;
        &lt;Text&gt;{item}&lt;/Text&gt;
      &lt;/View&gt;
    )<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">renderTwoItem</span> = (item, index) =&gt; {
    return (
      &lt;View <span class="hljs-attr">style</span>={{
        width: (windowWidth - 10) / 2,
        height: 50,
        backgroundColor: 'blue',
        justifyContent: 'center',
        alignItems: 'center'
      }}&gt;
        &lt;Text&gt;{item}&lt;/Text&gt;
      &lt;/View&gt;
    )<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return (
    &lt;View
      <span class="hljs-attr">onLayout</span>={(e) =&gt; {
        <span class="hljs-attr">scrollViewHeightRef.current</span> = e.nativeEvent.layout.height<span class="hljs-comment">;</span>
      }}
    &gt;
      &lt;ScrollView
        <span class="hljs-attr">bounces</span>={<span class="hljs-literal">false</span>}
        <span class="hljs-attr">scrollEventThrottle</span>={<span class="hljs-number">16</span>}
        <span class="hljs-attr">ref</span>={scrollViewRef}
        <span class="hljs-attr">onScroll</span>={(e) =&gt; {
          <span class="hljs-attr">scrollYRef.current</span> = e.nativeEvent.content<span class="hljs-literal">Off</span>set.y<span class="hljs-comment">;</span>
        }}
      &gt;
        {/* 单列拖拽列表 */}
        &lt;DragSortView
          <span class="hljs-attr">scrollYRef</span>={scrollYRef}
          <span class="hljs-attr">scrollViewRef</span>={scrollViewRef}
          <span class="hljs-attr">scrollViewHeightRef</span>={scrollViewHeightRef}
          <span class="hljs-attr">column</span>={<span class="hljs-number">1</span>}
          <span class="hljs-attr">childrenWidth</span>={windowWidth}
          <span class="hljs-attr">childrenHeight</span>={<span class="hljs-number">50</span>}
          <span class="hljs-attr">renderItem</span>={renderOneItem}
          <span class="hljs-attr">rowSpace</span>={<span class="hljs-number">10</span>}
          <span class="hljs-attr">dataSource</span>={[<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>, <span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>, <span class="hljs-string">'6'</span>, <span class="hljs-string">'7'</span>, <span class="hljs-string">'8'</span>, <span class="hljs-string">'9'</span>, <span class="hljs-string">'10'</span>]}
        /&gt;
        
        {/* 多列拖拽列表 */}
        &lt;DragSortView
          <span class="hljs-attr">scrollYRef</span>={scrollYRef}
          <span class="hljs-attr">scrollViewRef</span>={scrollViewRef}
          <span class="hljs-attr">scrollViewHeightRef</span>={scrollViewHeightRef}
          <span class="hljs-attr">column</span>={<span class="hljs-number">2</span>}
          <span class="hljs-attr">childrenWidth</span>={(windowWidth - <span class="hljs-number">10</span>) / <span class="hljs-number">2</span>}
          <span class="hljs-attr">childrenHeight</span>={<span class="hljs-number">50</span>}
          <span class="hljs-attr">renderItem</span>={renderTwoItem}
          <span class="hljs-attr">rowSpace</span>={<span class="hljs-number">10</span>}
          <span class="hljs-attr">columnSpace</span>={<span class="hljs-number">10</span>}
          <span class="hljs-attr">dataSource</span>={[<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>, <span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>, <span class="hljs-string">'6'</span>, <span class="hljs-string">'7'</span>, <span class="hljs-string">'8'</span>, <span class="hljs-string">'9'</span>, <span class="hljs-string">'10'</span>]}
        /&gt;
      &lt;/ScrollView&gt;
    &lt;/View&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## API 文档</span>

<span class="hljs-comment">### DragSortView Props</span>

| 属性名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `dataSource` | `Array` | ✅ | - | 数据源数组 |
| `renderItem` | `Function(item, index)` | ✅ | - | 渲染每个列表项的函数 |
| `childrenWidth` | `Number` | ✅ | - | 子元素宽度 |
| `childrenHeight` | `Number` | ✅ | - | 子元素高度 |
| `column` | `Number` | ❌ | `1` | 列数 |
| `rowSpace` | `Number` | ❌ | `0` | 行间距 |
| `columnSpace` | `Number` | ❌ | `0` | 列间距 |
| `keyStr` | `String` | ❌ | - | 作为列表 key 的关键字（用于优化渲染） |
| `onDragStart` | `Function()` | ❌ | - | 拖拽开始回调 |
| `onDragEnd` | `Function(from, to, newData)` | ❌ | - | 拖拽结束回调，参数：原始索引、新索引、新数据数组 |
| `parentYRef` | `Ref&lt;Number&gt;` | ❌ | - | 如果当前拖拽视图在一个容器中，则需要这个容器在 scrollView 的 y 位置 |
| `scrollYRef` | `Ref&lt;Number&gt;` | ❌ | - | 外层 ScrollView 滚动距离的 ref |
| `scrollViewRef` | `Ref&lt;ScrollView&gt;` | ❌ | - | 外层 ScrollView 的 ref |
| `scrollViewHeightRef` | `Ref&lt;Number&gt;` | ❌ | - | 外层 ScrollView 视图高度的 ref |
| `triggerTop` | `Number` | ❌ | `200` | 距离页面顶部多少距离触发自动向上滚动 |
| `triggerBottom` | `Number` | ❌ | `屏幕高度 - 200` | 距离页面顶部多少距离触发自动向下滚动 |

<span class="hljs-comment">### onDragEnd 回调参数</span>

- `from` (Number): 拖拽元素的原始索引位置
- `to` (Number): 拖拽元素的新索引位置
- `newData` (Array): 重新排序后的新数据数组

<span class="hljs-comment">## 注意事项</span>

1. **手势库依赖**：确保已正确安装和配置 `react-native-gesture-handler`，并在应用入口处导入：
   ```javascript
   import 'react-native-gesture-handler'<span class="hljs-comment">;</span>
   ```

2. **ScrollView 集成**：如果需要在 ScrollView 中使用，必须提供 `scrollYRef`、`scrollViewRef` 和 `scrollViewHeightRef` 三个 ref，否则自动滚动功能将无法正常工作。

3. **性能优化**：组件内部使用 `memo` 进行优化，但建议为 `dataSource` 中的每个对象提供唯一的 `keyStr` 属性以进一步提升性能。

4. **平台差异**：
   - iOS 和 Android 的滚动速度和距离有细微差异（iOS: 10ms/2px, Android: 20ms/5px）
   - 可通过修改 `DragSortView.js` 中的 `TIME` 和 `DISTANCE` 常量进行调整

5. **长按时间**：默认长按 500ms 后开始拖拽，可通过修改 `DragItemContainer.js` 中的 `minDuration` 和 `activateAfterLongPress` 进行调整。

<span class="hljs-comment">## 示例项目</span>

项目包含两个测试文件，展示了不同的使用场景：

- `TestDragSort.js`：基础单列拖拽示例
- `TestMoreDragSort.js`：ScrollView 集成和多列布局示例
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个基于 canvas 的 pdf 图片分页切割方法]]></title>    <link>https://juejin.cn/post/7587582213059838006</link>    <guid>https://juejin.cn/post/7587582213059838006</guid>    <pubDate>2025-12-25T06:44:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587582213059838006" data-draft-id="7587368168623013894" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个基于 canvas 的 pdf 图片分页切割方法"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-25T06:44:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小林攻城狮"/> <meta itemprop="url" content="https://juejin.cn/user/4162081646979545"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个基于 canvas 的 pdf 图片分页切割方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4162081646979545/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小林攻城狮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:44:49.000Z" title="Thu Dec 25 2025 06:44:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>主要应用场景是导出 pdf 的时候图片过长的情况下没法在一页内完整导出，此时需要对图片进行分页切割，这里实现的就是一个基于 canvas 的图片分页切割方法</p>
<h2 data-id="heading-0">代码实现</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 获取 base64 图片的尺寸。
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">base64</span> - 图片的Base64编码字符串。
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Object</span>} 包含图片宽度和高度的对象，格式为{width: number, height: number}。
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getPngDimensions</span>(<span class="hljs-params">base64: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// 从base64字符串中提取一部分数据并解码</span>
    <span class="hljs-keyword">const</span> header = <span class="hljs-title function_">atob</span>(base64.<span class="hljs-title function_">slice</span>(<span class="hljs-number">22</span>, <span class="hljs-number">70</span>)).<span class="hljs-title function_">slice</span>(<span class="hljs-number">16</span>, <span class="hljs-number">24</span>);
    <span class="hljs-comment">// 将解码后的字符串转换为Uint8Array</span>
    <span class="hljs-keyword">const</span> uint8 = <span class="hljs-title class_">Uint8Array</span>.<span class="hljs-title function_">from</span>(header, <span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>));
    <span class="hljs-comment">// 使用DataView来处理Uint8Array的数据</span>
    <span class="hljs-keyword">const</span> dataView = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(uint8.<span class="hljs-property">buffer</span>);

    <span class="hljs-keyword">return</span> {
        <span class="hljs-comment">// 从DataView中获取图片宽度</span>
        <span class="hljs-attr">width</span>: dataView.<span class="hljs-title function_">getInt32</span>(<span class="hljs-number">0</span>),
        <span class="hljs-comment">// 从DataView中获取图片高度</span>
        <span class="hljs-attr">height</span>: dataView.<span class="hljs-title function_">getInt32</span>(<span class="hljs-number">4</span>),
    };
}


<span class="hljs-comment">/**
 * 根据给定的页面尺寸和边距，对PDF中的图片进行分割。
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">imageContent</span> - 图片Base64编码字符串。
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">pageSize</span> - 页面尺寸对象，格式为{width: number, height: number}，单位是毫米。
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">pageMargins</span> - 页面边距数组，包含两个值，表示水平（左右）和垂直（上下）方向的间距，单位是毫米。
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;Object[]&gt;</span>} 返回分割后的图片对象，包含每一页分割后的图片大小
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">splitPdfImage</span>(<span class="hljs-params">
    imageContent: <span class="hljs-built_in">string</span>, 
    pageSize: { width: <span class="hljs-built_in">number</span>; height: <span class="hljs-built_in">number</span> }, 
    pageMargins: <span class="hljs-built_in">number</span>[]
   </span>) {
    <span class="hljs-comment">// 获取图片的宽度和高度</span>
    <span class="hljs-keyword">const</span> { width, height } = <span class="hljs-title function_">getPngDimensions</span>(imageContent);
    <span class="hljs-comment">// 创建一个div元素，用于模拟页面</span>
    <span class="hljs-keyword">const</span> pageDom = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    <span class="hljs-comment">// 设置div元素的宽度，考虑页面边距</span>
    pageDom.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = pageSize.<span class="hljs-property">width</span> - pageMargins[<span class="hljs-number">0</span>] * <span class="hljs-number">4</span> +<span class="hljs-string">'mm'</span>;
    <span class="hljs-comment">// 设置div元素的高度，考虑页面边距</span>
    pageDom.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = (pageSize.<span class="hljs-property">height</span> - pageMargins[<span class="hljs-number">1</span>] * <span class="hljs-number">2.5</span>) +<span class="hljs-string">'mm'</span>;
    <span class="hljs-comment">// 设置div元素的定位为绝对定位</span>
    pageDom.<span class="hljs-property">style</span>.<span class="hljs-property">position</span> = <span class="hljs-string">'absolute'</span>;
    <span class="hljs-comment">// 设置div元素的顶部位置为0</span>
    pageDom.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">'0'</span>;
    <span class="hljs-comment">// 将div元素添加到文档主体中</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">append</span>(pageDom);
    <span class="hljs-keyword">const</span> scale = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> num = <span class="hljs-number">38</span>;
    <span class="hljs-comment">// 计算页面高度，基于div元素的高度和一些缩放因子</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PAGE_HEIGHT</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(pageDom.<span class="hljs-property">clientHeight</span> / num) * num * scale;
    <span class="hljs-comment">// 计算页面宽度，基于div元素的宽度和缩放因子</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PAGE_WIDTH</span> = pageDom.<span class="hljs-property">clientWidth</span> * scale;
    <span class="hljs-comment">// 计算图片在当前页面宽度下的打印高度</span>
    <span class="hljs-keyword">const</span> printHeight = (height * <span class="hljs-variable constant_">PAGE_WIDTH</span>) / width;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">content</span>: <span class="hljs-built_in">any</span>[] = [];
        <span class="hljs-comment">// 如果图片的打印高度大于页面高度，则需要分割图片</span>
        <span class="hljs-keyword">if</span> (printHeight &gt; <span class="hljs-variable constant_">PAGE_HEIGHT</span>) {
            <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
            <span class="hljs-comment">// 当图片加载完成时执行以下操作</span>
            img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
                <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)!;
                <span class="hljs-keyword">const</span> printHeight = (img.<span class="hljs-property">height</span> * <span class="hljs-variable constant_">PAGE_WIDTH</span>) / img.<span class="hljs-property">width</span>;

                canvas.<span class="hljs-property">width</span> = <span class="hljs-variable constant_">PAGE_WIDTH</span>;

                <span class="hljs-comment">// 循环分割图片</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> pages = <span class="hljs-number">0</span>; printHeight &gt; pages * <span class="hljs-variable constant_">PAGE_HEIGHT</span>; pages++) {
                    <span class="hljs-comment">// 设置当前canvas的高度，避免最后一张图片超出实际高度</span>
                    canvas.<span class="hljs-property">height</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable constant_">PAGE_HEIGHT</span>, printHeight - pages * <span class="hljs-variable constant_">PAGE_HEIGHT</span>);
                    <span class="hljs-comment">// 在canvas上绘制图片的相应部分</span>
                    ctx.<span class="hljs-title function_">drawImage</span>(img, <span class="hljs-number">0</span>, -pages * <span class="hljs-variable constant_">PAGE_HEIGHT</span>, canvas.<span class="hljs-property">width</span>, printHeight);
                    <span class="hljs-comment">// 将分割后的图片内容添加到content数组中</span>
                    content.<span class="hljs-title function_">push</span>({
                      <span class="hljs-attr">image</span>: canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">'image/png'</span>),
                      <span class="hljs-attr">width</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(width, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-variable constant_">PAGE_WIDTH</span> / scale)),
                      <span class="hljs-attr">height</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(canvas.<span class="hljs-property">height</span> / scale),
                    });
                }
                <span class="hljs-comment">// 清理canvas</span>
                ctx!.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>)
                canvas.<span class="hljs-property">width</span> = <span class="hljs-number">1</span>
                canvas.<span class="hljs-property">height</span> = <span class="hljs-number">1</span>
                canvas.<span class="hljs-title function_">remove</span>()
                img.<span class="hljs-property">src</span> = <span class="hljs-string">''</span>;
                img.<span class="hljs-title function_">remove</span>();
                <span class="hljs-title function_">resolve</span>(content);
            };
            img.<span class="hljs-property">src</span> = imageContent;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果图片高度不超过页面高度，直接返回原图片内容</span>
            <span class="hljs-title function_">resolve</span>([{ <span class="hljs-attr">image</span>: imageContent, width, height }]);
        }
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
        <span class="hljs-comment">// 移除之前创建的模拟页面的div元素</span>
        pageDom.<span class="hljs-title function_">remove</span>();
        <span class="hljs-keyword">return</span> res;
    });
}
</code></pre>
<h2 data-id="heading-1">使用示例</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">splitPdfImage</span>(imageContent, pdfPage.<span class="hljs-property">pageSize</span>, pdfPage.<span class="hljs-property">pageMargins</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'---split image---'</span>, res)
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🤖 2025 年的人类还需要 “Prompt 工程师” 吗？]]></title>    <link>https://juejin.cn/post/7587355990409691187</link>    <guid>https://juejin.cn/post/7587355990409691187</guid>    <pubDate>2025-12-25T06:54:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587355990409691187" data-draft-id="7587355990409674803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🤖 2025 年的人类还需要 “Prompt 工程师” 吗？"/> <meta itemprop="keywords" content="人工智能,AIGC,LLM"/> <meta itemprop="datePublished" content="2025-12-25T06:54:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🤖 2025 年的人类还需要 “Prompt 工程师” 吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:54:27.000Z" title="Thu Dec 25 2025 06:54:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌌 一、引子：从“打字工”到“AI 驯兽师”</h2>
<p>2022 年，一个新职业横空出世——<strong>Prompt 工程师</strong>。<br/>
他们靠着一行行看似神秘的咒语，将 ChatGPT、Stable Diffusion、Claude 调教得像现代版的炼金术士。</p>
<p>他们不是码农，却能让 AI 写代码；他们不会画画，却能让 AI 出海报。<br/>
一时间，社交网站上充斥着这种神奇的句式：</p>
<blockquote>
<p>“构图：黑暗森林 + 月光 + 哥特风少女 + 梦幻光效 + 瑞典电音氛围 🎵”</p>
</blockquote>
<p>于是，AI就乖乖画出一张堪比宫崎骏画风的奇幻插图。<br/>
看似魔法，其实是——<strong>语义工程</strong>（Semantic Engineering）。</p>
<hr/>
<h2 data-id="heading-1">🧠 二、底层原理：Prompt 其实是怎样“生效”的？</h2>
<p>要理解 Prompt 工程师的地位，就必须先知道 AI 为什么听得懂人话。<br/>
以大型语言模型（LLM）为例，比如 GPT 系列，底层是一个<strong>概率语言模型</strong>。</p>
<p>它不是“懂你”，而是<strong>预测你说的下一个词的概率最大值</strong>。</p>
<p>我们可以这么理解👇：</p>
<p>🔹 你输入一句话：</p>
<blockquote>
<p>“给我写一首关于量子计算的诗。”</p>
</blockquote>
<p>🔹 模型在内部悄悄进行这样的“思考”：</p>
<blockquote>
<p>“接下来哪个词最可能接在‘量子计算’后面出现？”</p>
</blockquote>
<p>如果它发现 “像梦一样的粒子” 出现概率高——那就会输出它。<br/>
再接着算下一个词……无限循环。</p>
<p>这就像一个超高速算命大师在预测词语命运。</p>
<p>所以，Prompt 其实是我们对它的“语言引导算法”——<br/>
在软件工程里，它更像是一种<strong>输入调控层（Input Conditioning Layer）</strong> 。</p>
<hr/>
<h2 data-id="heading-2">🧩 三、AI 真的还需要我们“调教”吗？</h2>
<h3 data-id="heading-3">🧑‍💻 人类的引导依然重要（至少现在）</h3>
<p>虽然 2025 年的 AI 看起来无所不能，但它依然依赖人类输入。<br/>
Prompt 工程师的价值在于——<br/>
他们不是在写命令，而是在<strong>与模型对话时建立上下文显著性（Contextual Salience）</strong> 。</p>
<p>对 AI 来说，Prompt 好比是“神经导航系统”，告诉模型该往哪个方向收敛。</p>
<p>比如在 JS 里，如果我们想构建一个“小型 Prompt 校正器”，可以这样玩：</p>
<pre><code class="hljs language-ini" lang="ini">function promptOptimizer(prompt) {
  const <span class="hljs-attr">trimmed</span> = prompt.trim()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">structure</span> = `请以分析、创造、总结的顺序回答以下内容：<span class="hljs-variable">${trimmed}</span>`<span class="hljs-comment">;</span>
  return structure<span class="hljs-comment">;</span>
}

console.log(promptOptimizer("解释量子纠缠的本质"))<span class="hljs-comment">;</span>
</code></pre>
<p>👉 输出：</p>
<blockquote>
<p>请以分析、创造、总结的顺序回答以下内容：解释量子纠缠的本质</p>
</blockquote>
<p>这就是小范围的 <strong>Prompt 规范化（Prompt Normalization）</strong> 。</p>
<hr/>
<h3 data-id="heading-4">⚙️ 但 AI 已经学会理解“含糊的人类语言”</h3>
<p>多模态模型（比如 GPT-5、Gemini 2、Claude 3.5）已经能<br/>
自动识别语义结构、推测上下文意图并自我补全 Prompt。</p>
<p>换句话说，人类说：</p>
<blockquote>
<p>“帮我搞点能骗老板相信我加班的报告。”</p>
</blockquote>
<p>AI 就会自动想到：</p>
<blockquote>
<p>“好，那我就生成一份 PPT 模板、加上统计图表、再附带几句‘深度优化’的神秘术语。” 😏</p>
</blockquote>
<p>这说明——<strong>Prompt 工程的门槛在显著下降</strong>。<br/>
未来，你不需要懂 Prompt，你只要懂<strong>表达</strong>。</p>
<hr/>
<h2 data-id="heading-5">🧬 四、从“Prompt 工程师”到“语义设计师”</h2>
<p>2025 年，我们正在见证从 <strong>Prompt 1.0 → Semantic Design 2.0</strong> 的转变。</p>
<ul>
<li>Prompt 工程师：教 AI 如何理解输入</li>
<li>语义设计师：教 AI 如何理解<strong>人类的意图</strong></li>
</ul>
<p>区别在于——后者不再专注写“指令”，<br/>
而是<strong>设计沟通结构</strong>、<strong>优化多轮交互逻辑</strong>、<strong>塑造人机对话体验</strong>。</p>
<p>如果要用一段 JS 来比喻这种演化，可以是这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统Prompt写法</span>
<span class="hljs-keyword">let</span> prompt = <span class="hljs-string">"解释人工智能的历史"</span>;

<span class="hljs-comment">// 新时代语义设计思维</span>
<span class="hljs-keyword">let</span> intent = {
  <span class="hljs-attr">goal</span>: <span class="hljs-string">"教育型讲解"</span>,
  <span class="hljs-attr">tone</span>: <span class="hljs-string">"幽默"</span>,
  <span class="hljs-attr">depth</span>: <span class="hljs-string">"深入浅出"</span>,
  <span class="hljs-attr">context</span>: <span class="hljs-string">"大学课堂"</span>
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">semanticPrompt</span>(<span class="hljs-params">intent</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`请以<span class="hljs-subst">${intent.tone}</span>方式，为<span class="hljs-subst">${intent.context}</span>做一个<span class="hljs-subst">${intent.goal}</span>的内容，要求<span class="hljs-subst">${intent.depth}</span>。`</span>;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">semanticPrompt</span>(intent));
</code></pre>
<blockquote>
<p>输出：请以幽默方式，为大学课堂做一个教育型讲解的内容，要求深入浅出。</p>
</blockquote>
<p>是不是很像我们现在对 AI 说话的方式？<br/>
——这就是“Prompt 消亡后的进化形态”。🔥</p>
<hr/>
<h2 data-id="heading-6">💭 五、哲学视角：当语言本身成为编程语言</h2>
<p>人类从机器语言 → 汇编 → C → Python → Prompt，自然语言的地位越来越高。<br/>
<strong>Prompt 工程师的诞生，只是编程史的一次短暂过渡。</strong></p>
<p>因为未来的程序语言，将是<strong>语义驱动（Intent-Driven Programming）</strong> 。</p>
<p>有一天，你可能对计算机说——</p>
<blockquote>
<p>“帮我部署一个能自动抓取新闻的微服务，代码简洁点。”</p>
</blockquote>
<p>然后系统自动生成：</p>
<ul>
<li>Node.js 服务端代码</li>
<li>定时抓取模块</li>
<li>情感分析模型</li>
<li>部署脚本</li>
</ul>
<p>而你，只是贡献了一个“意图”。</p>
<p>到那时，<strong>自然语言就成了终极编程语言</strong>。</p>
<hr/>
<h2 data-id="heading-7">✨ 六、结语：Prompt 的消亡，正是理解的开始</h2>
<p>Let’s face it ——<br/>
2025 年的 AI 已经能读懂我们的语气、情绪、甚至暗示。<br/>
Prompt 工程师不再是“键盘巫师”，而是<strong>人类与机器之间的语言桥梁</strong>。</p>
<p>未来，写 Prompt 不再是一种职业，<br/>
而是一种<strong>思维方式、沟通艺术、语义哲学</strong>。</p>
<p>正如诗人约瑟夫·布洛德斯基说的：</p>
<blockquote>
<p>“语言不是我们使用的工具，而是我们存在的方式。”</p>
</blockquote>
<p>当我们教 AI 理解语言，其实是在教它理解——<strong>我们是谁</strong>。</p>
<hr/>
<p>🧩 <strong>总结</strong></p>





























<table><thead><tr><th>阶段</th><th>特征</th><th>专业能力需求</th><th>关键问题</th></tr></thead><tbody><tr><td>Prompt 1.0</td><td>指令编写</td><td>多轮测试与调优</td><td>AI如何听懂？</td></tr><tr><td>Prompt 2.0</td><td>语义建模</td><td>意图推理 + 语境设计</td><td>AI如何理解人？</td></tr><tr><td>Prompt 3.0</td><td>自适应智能</td><td>自我构造Prompt</td><td>还需要人类吗？</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[转型成为AI研发工程师之路]]></title>    <link>https://juejin.cn/post/7587582213059903542</link>    <guid>https://juejin.cn/post/7587582213059903542</guid>    <pubDate>2025-12-25T06:54:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587582213059903542" data-draft-id="7587368168622948358" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="转型成为AI研发工程师之路"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2025-12-25T06:54:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="这是你的玩具车吗"/> <meta itemprop="url" content="https://juejin.cn/user/3737995264659230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            转型成为AI研发工程师之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995264659230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    这是你的玩具车吗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:54:49.000Z" title="Thu Dec 25 2025 06:54:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>代码是现实世界中最清晰、最明确、最高质量的大模型训练数据，且代码编程天生具有较高的容忍度和巨大的商业价值。因此，各个大模型公司在这个领域的发力远远领先于其他文档撰写、医疗诊断、自动驾驶领域。</p>
<p>毫不夸张的说，<strong>代码编程是大模型目前唯一一个已经被人类广泛接受、且接近甚至局部超过人类平均水平的领域</strong>。程序员，尤其是“前端程序员”，成为了第一个被大模型冲击的岗位。这是一种不幸，更是一种幸运。</p>
<h2 data-id="heading-0">为什么第一个被冲击是一种“幸运”？</h2>
<p>被技术浪潮拍在沙滩上，通常被视为一种职业危机。但是毛选中说了：“此处吃亏，彼处胜利，东方不亮西方亮”。如果换个角度来看待这次冲击，会发现其中隐藏着巨大的先发红利：</p>
<p><strong>最早拿到AI时代的入场券</strong></p>
<p>大模型懂代码，意味着程序员是目前世界上唯一<strong>能用“自然语言”和“编程语言”双语</strong>与 AI进行深度交流的人群。固然有Vibe Coding，但是如果不懂编程的原理，想实现一个真正有一点逻辑的应用的难度，不用我多说，试过的都知道。当其他行业还在摸索如何用AI画图、写文案时，程序员已经可以直接利用agent重构自己的应用。这种对工具的理解深度，就是转型的第一层护城河。</p>
<p><strong>被迫的强制进化</strong></p>
<p>AI在侵蚀工作岗位，程序员没有办法，只能接受并寻找出路。在一个AI并不完美而非全面碾压的时代先学会如何与它共生，积攒与其合作的经验；在后AI时代就相对别人获得经验优势。就好像第一个被迫成为汽车司机的马车夫，驾驶经验总是比新手高超一些。</p>
<p>更不用说前端工程师还有天然优势：用户Sense与串联能力。前端从来不仅仅是写界面的，前端是所有技术岗位中最有用户Sense、最习惯串联上下游、最擅长了解新事物的岗位。当工作中的代码实现逐渐被AI辅助甚至替代后，剩下的部分——即产品能力的定义、用户价值的实现、复杂系统的串联——变得前所未有的重要。而这，恰恰是前端工程师最擅长的领域。</p>
<p>尽管在并发处理、稳定性、甚至LLM的底层上前端会遇到挑战，但是前端遇到的挑战还少吗？而且任何一个人都没有必要自己扛下所有，软件工程本就是体系作战，总还有其他partner的。</p>
<h2 data-id="heading-1">AI应用研发工程师主要干什么？</h2>
<p>很多人误以为AI应用研发就是“写Prompt”或者“编排workflow”，这是一个巨大的误区。真实的AI应用研发是一个复杂的系统工程，主要包含以下职责：</p>
<p><strong>系统编排与分工设计</strong></p>
<p>这是最核心的能力。面对一个应用或者功能点，需要设计一套机制，决定哪些部分分给AI（模糊处理、创意生成），哪些部分分给传统后端（精确计算、逻辑校验）。这不仅仅是调用接口，而是像设计电路一样，让确定性的代码逻辑与概率性的AI模型相互配合，发挥出1+1&gt;2的效果。</p>
<p><strong>RAG与上下文管理</strong></p>
<p>通用模型不会知道公司内部的私有数据。需要构建高效的向量检索系统，清洗脏数据，设计切片策略，把最准确的信息“喂”给模型。这本质上是数据工程与搜索技术的结合。</p>
<p><strong>大模型交互设计</strong></p>
<p>新的生产力带来了新的交互方式。端侧不再仅是实现界面，而是设计“人与智能的对话”。流式输出带来的体验优化只是最基本的，用户意图的预判、当AI处理耗时较长时的中间态管理都是新的挑战。</p>
<p><strong>评估与迭代</strong></p>
<p>毫无疑问，必须建立一套评估体系。用数据回答：新版本的Prompt是不是真的比旧版本好？RAG检索的准确率是多少？没有量化，就没有工程。甚至，Prompt也不能是人力炼丹，得让提示词优化来接管。复杂的人工Prompt就是天然的屎山代码，不管是换个人还是换个应用的大模型都难以维护。</p>
<p><strong>驯服非确定性</strong></p>
<p>更不用说大模型还有非确定性。传统软件是确定的，但AI是概率性的、会幻觉的，甚至有时候是“抽风”的。如何在AI本身只有90%可靠性的情况下，通过重试机制、输出校验、兜底逻辑等工程手段，构建出一个在生产环境下99.99%健壮的系统，也是是AI工程师面临的挑战。</p>
<h2 data-id="heading-2">如何成为AI应用研发工程师</h2>
<p><strong>先动起来：Action &gt; Planning</strong></p>
<p>很多人的转型死在了“准备不足”的焦虑上。别总想着要先学完深度学习原理再动手。不上路都是问题，上了路再考虑怎么解的问题。接了一个3天后deadline的活，自然而然就有思路了；没有3天后deadline的活，就自己创造一个。</p>
<p>AI时代，你永远拥有“大模型”这个私人金牌导师。以前卡住要查半天文档，求爷爷告奶奶，现在AI大概率能给你解决。做一个简单的Demo，串联起Python、LangChain、LangSmith，这其中的试错成本极低。动起来，比想清楚更重要。</p>
<p><strong>敏捷补齐：只学最新的</strong></p>
<p>AI领域工具策略的变动日新月异，我3个月前写的Cursor使用指南现在看起来像个憨憨。在AI应用层，紧跟潮流更重要。永远只学最新的，永远接受最新的，永远只看官方文档。现在的AI知识半衰期很短，快速学习、快速遗忘、快速更新是新常态。</p>
<p><strong>保持敬畏：从Demo到上线交付的鸿沟</strong></p>
<p>我听了一句话觉得很有道理：<strong>不要向我阐述你的项目有多少用户价值，有多少个用户愿意掏30块/月来购买才是这个项目的用户价值</strong>。完成一个酷炫的Demo很容易，但完成一个真正让用户愿意掏钱的项目非常困难。</p>
<p>不要看不起写Prompt，写一个真的能在生产环境用，cover住用户99.9%意图的workflow，都能吐一口血。更不用说延迟问题、Token成本问题、并发问题、记忆问题、以及长尾Case的幻觉问题，才是真正的考验。</p>
<h2 data-id="heading-3">优秀AI应用研发工程师的壁垒在哪里？</h2>
<p>当所有人都会写Prompt、都在Vibe Coding，AI应用研发工程师的价值沉淀在哪里？<strong>真正的壁垒在于构建一条能快速上线部署、精准符合业务、可评测、可迭代的AI链路。</strong></p>
<p><strong>精准的业务与场景匹配</strong></p>
<p>AI是大脑，行业知识是肌肉。<strong>知道在哪里不该用AI以及知道在哪里注入AI能产生最大效能</strong>。懂业务领域的痛点，比单纯懂模型参数更稀缺。</p>
<p><strong>可评测的数据闭环</strong></p>
<p>能否建立一套自动化的Evals系统？当Prompt调整后，你能否在一分钟内知道它在1000个历史测试用例上的表现是变好了还是变差了？没有评测就没有迭代，没有迭代就没有护城河。</p>
<p><strong>工程化的生产环境部署</strong></p>
<p>与目前的工程化链路做结合：在复杂Case下控制Token成本，在高并发时保证响应速度，在模型抽风时有完美的降级方案。将“概率性模型”封装成“稳定性服务”的工程能力，也是核心壁垒。</p>
<h2 data-id="heading-4">总结</h2>
<p>最后的最后，想确认前端死了没，只需要看招聘市场的热度就行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2db7853782174ff6ac158e03d361fb93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-Z5piv5L2g55qE546p5YW36L2m5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250489&amp;x-signature=lApVNPSMSw9E7DTVqxJlztg0Eaw%3D" alt="1.png" loading="lazy"/></p>
<p>当Gemini 3轻松的实现了我都写不出的UI的时候，<strong>前端这艘大船在我的眼里已经撞上了冰山，沉没只是时间问题</strong>。<strong>公司和就业市场都不相信眼泪，只相信个体能提供的实际价值</strong>。</p>
<p><strong>我也不关心前端是否死了，我只关心我自己是否还有竞争力。走在别人的前面，走在就业市场的风口，就是个体在这个时代最大的护城河</strong>。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[意图驱动编程（Intent-Driven Programming）]]></title>    <link>https://juejin.cn/post/7587392473851445294</link>    <guid>https://juejin.cn/post/7587392473851445294</guid>    <pubDate>2025-12-25T06:56:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587392473851445294" data-draft-id="7587355990409707571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="意图驱动编程（Intent-Driven Programming）"/> <meta itemprop="keywords" content="人工智能,LLM,AIGC"/> <meta itemprop="datePublished" content="2025-12-25T06:56:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            意图驱动编程（Intent-Driven Programming）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:56:50.000Z" title="Thu Dec 25 2025 06:56:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧭 一、什么是“意图驱动编程”？</h2>
<p>👨‍💻 <strong>一句话概念：</strong></p>
<blockquote>
<p>程序员不再告诉计算机“怎么做”，而是描述“要达成什么”，<br/>
系统通过语义理解与模型推理，自动生成“如何实现”的过程。</p>
</blockquote>
<p>也就是说，从命令式（Imperative）转向目的导向（Intent-Oriented）。</p>
<p>传统编程像这样：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">items</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]<span class="hljs-comment">;</span>
let <span class="hljs-attr">sum</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; items.length; i++) {</span>
  sum += items<span class="hljs-section">[i]</span><span class="hljs-comment">;</span>
}
console.log(sum)<span class="hljs-comment">;</span>
</code></pre>
<p>意图驱动的思路则是：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 人类写的句子</span>
<span class="hljs-built_in">sumNumbers</span>(items)
</code></pre>
<p>系统自动推理出：</p>
<blockquote>
<p>“他想要的是将这个数组中所有数字加和”<br/>
于是自动生成并执行对应的实现逻辑。</p>
</blockquote>
<p>甚至未来的形式可能更自然：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 自然语言接口</span>
<span class="hljs-string">"计算这组数字的总和，并在控制台输出结果"</span>
</code></pre>
<hr/>
<h2 data-id="heading-1">🧩 二、核心机制：从“命令→目标→实现”的三层结构</h2>
<p>我们把它的底层想象成三层语义映射模型：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[ 人类输入 ]</span>
     ↓
🎯 意图层（Intent Layer） —— “想做什么”
     ↓
🧠 语义推理层（Semantic Reasoning Layer） —— “怎么实现”
     ↓
⚙️ 执行层（Execution Layer） —— “执行什么代码”
</code></pre>
<p>这就像人类大脑处理自然语言时的三个阶段：</p>
<ol>
<li><strong>识别意图</strong>（你想做什么）</li>
<li><strong>推理动作</strong>（怎么达成）</li>
<li><strong>发出指令</strong>（去做）</li>
</ol>
<p>在计算机系统中，这分别对应：</p>





























<table><thead><tr><th>层级</th><th>对应技术</th><th>核心任务</th><th>示例</th></tr></thead><tbody><tr><td>意图层</td><td>自然语言解析 / Prompt理解</td><td>将语言转为抽象语义树</td><td>“生成一份用户报告”</td></tr><tr><td>语义推理层</td><td>语义图谱 / 大语言模型 / 逻辑规划</td><td>确定调用哪些函数、API 或 Agent</td><td>“用数据库查询 -&gt; 格式化 -&gt; 输出PDF”</td></tr><tr><td>执行层</td><td>编程语言运行时 / 自动生成代码</td><td>实际执行可验证的程序</td><td>“运行SQL + 渲染模板”</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">🧠 三、与“符号AI”和“连接主义AI”的融合点</h2>
<p>从计算机科学的角度，意图驱动编程是<strong>符号派与连接派结合的产物</strong>：</p>

























<table><thead><tr><th>领域</th><th>意图的角色</th><th>技术基础</th></tr></thead><tbody><tr><td>符号推理（Symbolic AI）</td><td>把“意图”形式化成逻辑表达式</td><td>逻辑规划、知识图谱、规则系统</td></tr><tr><td>神经网络（Neural AI）</td><td>从语义中抽出意图分布概率</td><td>Transformer、语义嵌入</td></tr><tr><td>大模型融合层</td><td>在语义与结构间建立中间层语言</td><td>LLM + DSL（领域特定语言）</td></tr></tbody></table>
<p>换句话说，大模型捕捉“意图”，<br/>
知识系统验证“合理性”，<br/>
编程语言生成“执行逻辑”。</p>
<hr/>
<h2 data-id="heading-3">🧮 四、从“编译器”到“语义编译器”的演化逻辑</h2>
<blockquote>
<p><strong>传统编译器</strong>：把语法翻译成机器指令。<br/>
<strong>语义编译器</strong>：把意图翻译成问题求解路径。</p>
</blockquote>
<p>这种编译器已经在雏形阶段，比如：</p>
<h4 data-id="heading-4">🌱 类比流程：</h4>
<pre><code class="hljs language-rust" lang="rust">输入：<span class="hljs-string">"生成一个能每天抓取新闻并发邮件的服务。"</span>

↓ 编译过程 ↓

<span class="hljs-number">1</span>️⃣ 抽取意图：
   <span class="hljs-punctuation">-&gt;</span> {目标: 信息自动化, 动作: 抓取, 输出: 邮件, 周期: 每天}

<span class="hljs-number">2</span>️⃣ 推理组件：
   <span class="hljs-punctuation">-&gt;</span> {Agent: WebCrawler, Parser: NLPContentExtractor, Scheduler: Timer}

<span class="hljs-number">3</span>️⃣ 代码合成：
   <span class="hljs-punctuation">-&gt;</span> Node.js 模块 + cron job + 邮件API集成

<span class="hljs-number">4</span>️⃣ 执行：
   <span class="hljs-punctuation">-&gt;</span> 自动部署 &amp; 监控
</code></pre>
<p>这就是 <strong>“语义到可执行”的映射过程</strong>。<br/>
系统在内部生成中间表示（Semantic IR），<br/>
然后自动调用模板代码或小模型完成构建。</p>
<hr/>
<h2 data-id="heading-5">⚙️ 五、意图的“结构化抽象”：程序不再是函数，而是语义节点</h2>
<p>未来程序可能不再由函数和类组成，而是由**语义节点（Semantic Nodes）**组成：</p>
<pre><code class="hljs language-css" lang="css">{
  intent: <span class="hljs-string">"生成日报"</span>,
  data_source: <span class="hljs-string">"公司数据库"</span>,
  filters: [<span class="hljs-string">"销售额"</span>, <span class="hljs-string">"地区"</span>],
  output: <span class="hljs-string">"PDF"</span>,
  schedule: <span class="hljs-string">"每日 7:00"</span>
}
</code></pre>
<p>然后由系统将其转译为：</p>
<ul>
<li>数据库查询语句</li>
<li>PDF 模板引擎调用</li>
<li>定时任务脚本</li>
<li>发送逻辑执行器</li>
</ul>
<p>即编程抽象从 <strong>“控制流（Control Flow）” → “目标语义网（Goal Graph）”</strong> 。</p>
<hr/>
<h2 data-id="heading-6">🌉 六、意图驱动编程的基础支撑：</h2>
<h3 data-id="heading-7">（1）语义理解模型（Semantic Understanding）</h3>
<p>让机器能稳定识别目标，而非句式。<br/>
比如“写报告”、“生成日报”在语义上是等价任务。</p>
<h3 data-id="heading-8">（2）意图映射标准化（Intent Mapping Schema）</h3>
<p>类似 API 的“协议层”，定义意图标准。<br/>
未来可能会有类似这种文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"intent"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"send_email"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"recipient"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"message"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"optional"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"attachment"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"priority"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-9">（3）自我规划与验证（Autonomous Planning &amp; Verification）</h3>
<p>系统会自动推理满足意图的任务链，并检查是否合理（类似 Model Checking）。</p>
<hr/>
<h2 data-id="heading-10">🔍 七、JS 示例：从人类语言生成任务执行流</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> ai = {
  <span class="hljs-attr">interpret</span>: <span class="hljs-function">(<span class="hljs-params">sentence</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (sentence.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"报告"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">"generateReport"</span>;
    <span class="hljs-keyword">if</span> (sentence.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"邮件"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">"sendEmail"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">"unknown"</span>;
  },
  <span class="hljs-attr">execute</span>: <span class="hljs-function">(<span class="hljs-params">intent</span>) =&gt;</span> {
    <span class="hljs-keyword">switch</span> (intent) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"generateReport"</span>:
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📊 正在生成日报..."</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">"sendEmail"</span>:
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📧 正在发送邮件..."</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🤔 不确定你的意图"</span>);
    }
  }
};

<span class="hljs-keyword">const</span> input = <span class="hljs-string">"帮我生成一份日报"</span>;
<span class="hljs-keyword">const</span> intent = ai.<span class="hljs-title function_">interpret</span>(input);
ai.<span class="hljs-title function_">execute</span>(intent);
</code></pre>
<p>🧩 <strong>输出：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">📊 正在生成日报...
</code></pre>
<p>这只是一个概念性 mini 模型，<br/>
但真正的意图驱动系统会有多层语义模型、执行引擎、验证逻辑。</p>
<hr/>
<h2 data-id="heading-11">🔮 八、哲学视角：从编写代码到表达思维</h2>
<p>意图驱动编程的终极目标，不是让AI写代码，<br/>
而是<strong>让思维本身成为编程语言</strong>。</p>
<p>未来的程序员可能这样“写程序”：</p>
<blockquote>
<p>我想构建一个能阅读新闻、总结趋势并每天早上给我发报告的智能体。<br/>
请确保：</p>
<ul>
<li>语气专业但亲切</li>
<li>提供关键指标的趋势图</li>
<li>不要啰嗦</li>
</ul>
</blockquote>
<p>AI 理解后直接构建整个系统。<br/>
到那时，编程会变得更像文学创作——<br/>
逻辑 = 诗意，算法 = 思想的骨架。</p>
<hr/>
<h2 data-id="heading-12">⚡ 九、总结表格</h2>





























<table><thead><tr><th>层级</th><th>目标</th><th>技术形态</th><th>对人类意义</th></tr></thead><tbody><tr><td>编程语言</td><td>让人类教计算机</td><td>语法与命令</td><td>技术性沟通</td></tr><tr><td>意图编程</td><td>让计算机理解人类</td><td>语义建模与推理</td><td>思维层沟通</td></tr><tr><td>自演化系统</td><td>让AI构建AI</td><td>自我反思模型</td><td>合作式智能共创</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-13">✨ 十、结语：编程的未来，是“表达意图的艺术”</h2>
<p>在过往 70 年的计算机史中，<br/>
人类一直在努力缩小“思考”和“执行”之间的鸿沟。</p>
<p>从机器码到 Python，从 Prompt 到 Intent，<br/>
我们不再去写程序，而是在<strong>表达思想的结构</strong>。</p>
<p>也许未来的调试，不是修 Bug，<br/>
而是纠正误解——</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[除了 DeepSeek-OCR，还有谁在“把字当图看”？]]></title>    <link>https://juejin.cn/post/7587343333329698850</link>    <guid>https://juejin.cn/post/7587343333329698850</guid>    <pubDate>2025-12-25T06:55:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587343333329698850" data-draft-id="7587334152870969384" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="除了 DeepSeek-OCR，还有谁在“把字当图看”？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-25T06:55:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智见AGI"/> <meta itemprop="url" content="https://juejin.cn/user/4145611877132986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            除了 DeepSeek-OCR，还有谁在“把字当图看”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4145611877132986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智见AGI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:55:48.000Z" title="Thu Dec 25 2025 06:55:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57c6e3f25e174324be7788c2e94fb7e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=l%2BopZr78pLvBE2fdJ%2Fjmqnyd3%2Bg%3D" alt="a1bf8ef4b3016b288f307ed673a30f4a_640_wx_fmt=png&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1#imgIndex=0.webp" loading="lazy"/></p>
<p>别再狂塞 token 了。长文档/长对话真贵的原因，是输入方式太臃肿。本文用 3 分钟带你看完 <strong>OCR-free / 像素化语言 / token 压缩</strong>，并给出一套最小评测清单。</p>
<p><strong>为什么要看“字当图看”的替代路线</strong></p>
<p>长文档与长对话的成本越来越高，根因不是“模型不够强”，而是输入方式太昂贵：文本注意力几乎按 N² 增长。与其无止境地塞 token，不如换一条思路——<strong>让输入更密、更稳、更统一</strong>：把页面当图看（OCR-free）、把语言也回到像素（像素化语言），或直接在视觉/文本两侧做<strong>token 压缩</strong>。这三条路线不是“谁替代谁”，而是<strong>互补</strong>：复杂混排靠 OCR-free 保结构，跨语种靠像素化语言更鲁棒，长上下文直接用压缩减重，三者还能<strong>打组合拳</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a2338c3f43b4ee4a65f73fe9288a36a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=H0CdQbbaOYasQbGfjraV0vmiuUc%3D" alt="图片" loading="lazy"/></p>
<p>DeepSeek OCR</p>
<p>如果你这两天被 DeepSeek-OCR 刷屏，核心记忆大概有两句：第一，<strong>把长文本渲成图片</strong>；第二，<strong>用更少的视觉 token 表示海量信息</strong>，于是长上下文的算力账突然“省钱”了。很多读者会问：这条思路是不是独一家？其实不止。本文用一篇就够的方式，梳理三条“类同路线”：一条是和 DeepSeek-OCR最像的 <strong>OCR-free / 端到端文档理解</strong>（整页当图像直接读懂）；一条是更“哲学”的 <strong>像素化语言建模</strong>（把文字也变像素再学）；最后一条是工程味很浓的 <strong>token 压缩/合并</strong>（少给点 token 也能懂）。看完你大概就能做两件事：<strong>给自己的生产链路选型</strong>，以及<strong>搭一套最小可复现实验</strong>，用真实 PDF、表格、公式和多轮对话，测出“谁更省、谁更稳”。</p>
<p><strong>路线一：OCR-free / 端到端读文档（最像 DeepSeek-OCR 的“把整页当图看”）</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a04618211eb9419786fb9a0bfe5661e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=49cS%2BBRWsjh35JW34WPFhijsbYY%3D" alt="图片" loading="lazy"/></p>
<p>The pipeline of Donut</p>
<p>Donut 开了头：整页图像输入、直接生成结构化结果，不依赖传统 OCR 引擎，<strong>排版/层级</strong>天然保留，适合表单、票据、报表。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b75a34386d7543279e7be135a5a6a8f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=kBDp%2FeLkaTJ8Yt348yturQ4V2%2BQ%3D" alt="图片" loading="lazy"/></p>
<p>Examples of visually-situated language understanding tasks, including diagram QA (AI2D), app captioning (Screen2Words), and document QA (DocVQA).</p>
<p>Google 的 Pix2Struct 把网页、UI、图表都当“视觉化语言”，先学“截图→简化结构”的共性，再去做问答与描述；</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2466fb8dd3a14bdcbe829ce5085e1c29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=9Qez7vNW09OeAsP%2Fji3zWQFHuRo%3D" alt="图片" loading="lazy"/></p>
<p>UReader</p>
<p>UReader 往通用多模态方向走，一套模型兼容文档/网页/场景文字。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82462d687e8f44e784b191e1b09a03d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=hNatkV%2FYcJxnkG6UakM7DIYXMns%3D" alt="图片" loading="lazy"/></p>
<p>GOT-OCR</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89643c3b1f2b41ed9a5da961337a943a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=K3OWGseU8TJ92738JurowEMaxEY%3D" alt="图片" loading="lazy"/></p>
<p>MinerU framework processing workflow</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e35291ebe18b4ee9b5725126d701139f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=9h784%2BqErkU6CfVSg5Vb0TOVN0c%3D" alt="图片" loading="lazy"/></p>
<p>PaddleOCR-VL</p>
<p>而 Haoran Wei 牵头的 GOT-OCR 2.0、以及开源系统 MinerU（最新到 2.5）和百度的 PaddleOCR-VL，则把复杂版式、表格/公式重建、跨语种等拉满，用在真实业务的可用性更强。这些工作的<strong>共同点</strong>是：<strong>整页进、结构出</strong>，最大化保留二维版式与图表语义，少走“先 OCR 再拼”的中间损耗；与 DeepSeek-OCR 的<strong>差别</strong>是：它们多把“图→文/结构”的链路做到极致，而 DeepSeek-OCR 额外把“<strong>文本先视觉化→以视觉 token 进上下文</strong>”这件事做成了<strong>长上下文压缩</strong>与<strong>记忆管理</strong>的新范式。(GitHub)</p>
<p>工程实战里，GOT-OCR、MinerU、PaddleOCR-VL把<strong>表格/公式重建与多语</strong>做得更踏实，适合“读懂+重建+再编辑”的生产链路。<strong>什么时候用？当你的 PDF/网页图文混排复杂、表格/图表多时</strong>，OCR-free 的结构保持会比“先 OCR 再拼”稳定得多。</p>
<p><strong>路线二：像素化语言建模（“语言也该回到像素”）</strong></p>
<p>如果你认同“语言只是更低维的视觉投影”，那这条线会很对胃口。PIXEL 的直觉很简单：<strong>把文字渲成图片再学</strong>，用像素掩码重建来获得语言表征，这样跨文字体系更鲁棒，也绕开分词器的词表束缚；</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e81386d0e0043779bf63d2919a110ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=%2B25RRmcfDVn45A%2F778nIo9tHDJk%3D" alt="图片" loading="lazy"/></p>
<p>CLIPPO 走得更远，图片与“渲成图的文字”统一<strong>用同一个视觉编码器</strong>，做纯像素的跨模态对齐。<strong>什么时候用？当你需要多语/异体字/对抗字符</strong>稳定性时，这条路往往更“抗噪”，也让“语言/视觉”的输入侧更一致。思想上它们与 DeepSeek-OCR <strong>高度类同：用像素/视觉表征统一语言与图像</strong>，让输入侧更一致、也更抗“分词越狱/编码割裂”。(arXiv)</p>
<p><strong>路线三：token 压缩/合并（介质不同，但目标一致：更少 token，近似效果）</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31d9cda99c6e4c6488304f6892402490~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=O8i8%2Fbcz6R0OtyEQA3hCBvkKvi4%3D" alt="图片" loading="lazy"/></p>
<p>ToMe</p>
<p>在视觉侧，ToMe（Token Merging）通过<strong>合并相似视觉 token</strong>，训练免改即可把 ViT/扩散的吞吐拉到 2×，精度只掉零点几个点；专为多模态 LLM 设计的 TokenPacker 则是“<strong>粗到细的视觉投影器</strong>”，常见能把视觉 token 压到 75–89% 还保持细节与推理力；</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ddce22aec914ce8a3d31fac0a5beb51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250547&amp;x-signature=wbWhuj0bdmZZZKCJRolK5%2FAlytE%3D" alt="图片" loading="lazy"/></p>
<p>Framework of the proposed approach LLMLingua.</p>
<p>在文本侧，LLMLingua / LongLLMLingua 用<strong>提示压缩</strong>把 10×–20× 的 token 砍掉还维持性能，且长上下文里更能抗位置偏置。这条线和 DeepSeek-OCR 的关系很清楚：<strong>大家都在减少解码器要吃的 token</strong>，只不过一个从“视觉端”做（合并/投影），一个从“文本端”做（剪裁/蒸馏），而 DeepSeek-OCR 则把“<strong>文本先视觉化再压缩</strong>”纳入统一记忆管理。(arXiv)</p>
<p><strong>结论：最现实的是“文-视双轨＋自适应路由”</strong></p>
<p>复杂混排 → 走 OCR-free；跨语种/抗扰动 → 走像素化语言；一般长上下文 → 走 token 压缩；<strong>高价值任务</strong>可在视觉侧配合压缩，既保结构、又控成本。工程上，把三条路线做成一个<strong>路由器</strong>：检测到“表格/图表/定位”线索就走视觉路由，需要代码/严谨推理就回文本主路，必要时局部回读原文或高分图片，“既便宜又不糊”。</p>
<p>参考</p>
<p>General OCR Theory: Towards OCR-2.0 via a Unified End-to-end Model</p>
<p>UReader: Universal OCR-free Visually-situated Language Understanding with Multimodal Large Language Model</p>
<p>Pix2Struct: Screenshot Parsing as Pretraining for Visual Language Understanding</p>
<p>PaddleOCR-VL: Boosting Multilingual Document Parsing via a 0.9B Ultra-Compact Vision-Language Model</p>
<p>MinerU: An Open-Source Solution for Precise Document Content Extraction</p>
<p>DeepSeek-OCR: Contexts Optical Compression</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年OpenTiny年度人气贡献者评选正式开始]]></title>    <link>https://juejin.cn/post/7587327550873468928</link>    <guid>https://juejin.cn/post/7587327550873468928</guid>    <pubDate>2025-12-25T06:56:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587327550873468928" data-draft-id="7587334152870871080" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年OpenTiny年度人气贡献者评选正式开始"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-25T06:56:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenTiny社区"/> <meta itemprop="url" content="https://juejin.cn/user/3808325101432983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年OpenTiny年度人气贡献者评选正式开始
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808325101432983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenTiny社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T06:56:01.000Z" title="Thu Dec 25 2025 06:56:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>携手共创，致敬不凡！</p>
<p>2025年，OpenTiny持续在前端开源领域扎根，每一位开发者都是推动项目共同前行的宝贵力量。从bug修复，到技术探讨；从参与开源活动，到输出技术文章；从使用项目，到参与共建，每一步跨越，都凝聚了开发者的智慧与汗水。
致敬所有在OpenTiny社区里默默付出、积极贡献、引领创新的杰出个人，我们正式启动“OpenTiny年度贡献者评选”活动！快为你喜爱的人气贡献者投票吧~</p>
<h2 data-id="heading-1">人气贡献者评选</h2>
<p><strong>名单公布：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bb14e9925de48adbc40495a5161168d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250561&amp;x-signature=%2BRBp2EDU0bnr5tq%2BzmptHk3aJEk%3D" alt="新1.PNG" loading="lazy"/></p>
<p><strong>年度贡献者投票评选时间：</strong></p>
<p>2025年12月25日-2025年12月31日</p>
<p><strong>投票规则：</strong></p>
<p>每人每天可回答3次，每次最多可投2票，最终投票结果选取前5名</p>
<p><strong>投票入口：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwj.qq.com%2Fs2%2F25333949%2F4w7w" target="_blank" title="https://wj.qq.com/s2/25333949/4w7w" ref="nofollow noopener noreferrer">wj.qq.com/s2/25333949…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f26c570b1c841799f07f38e8816e142~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767250561&amp;x-signature=ZpwG7IA96gy1EXxbV4FbRLmQDLU%3D" alt="去水印.png" loading="lazy"/></p>
<h2 data-id="heading-2">关于OpenTiny</h2>
<p>欢迎加入 OpenTiny 开源社区。添加微信小助手：opentiny-official 一起参与交流前端技术～<br/>
OpenTiny 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design" target="_blank" title="https://opentiny.design" ref="nofollow noopener noreferrer">opentiny.design</a><br/>
OpenTiny 代码仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny" target="_blank" title="https://github.com/opentiny" ref="nofollow noopener noreferrer">github.com/opentiny</a><br/>
TinyVue 源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-vue" target="_blank" title="https://github.com/opentiny/tiny-vue" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a><br/>
TinyEngine 源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine" target="_blank" title="https://github.com/opentiny/tiny-engine" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a><br/>
欢迎进入代码仓库 Star🌟TinyEngine、TinyVue、TinyNG、TinyCLI~  如果你也想要共建，可以进入代码仓库，找到 good first issue标签，一起参与开源贡献~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[计算机网络-从CGI 到 Unix Domain Socket：理解 Web 服务背后的进程通信演进]]></title>    <link>https://juejin.cn/post/7587392473851494446</link>    <guid>https://juejin.cn/post/7587392473851494446</guid>    <pubDate>2025-12-25T07:01:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587392473851494446" data-draft-id="7587421380229169202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="计算机网络-从CGI 到 Unix Domain Socket：理解 Web 服务背后的进程通信演进"/> <meta itemprop="keywords" content="网络协议"/> <meta itemprop="datePublished" content="2025-12-25T07:01:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            计算机网络-从CGI 到 Unix Domain Socket：理解 Web 服务背后的进程通信演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T07:01:59.000Z" title="Thu Dec 25 2025 07:01:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从 CGI 到 Unix Domain Socket：理解 Web 服务背后的进程通信演进</h2>
<blockquote>
<p>摘要：<strong>为什么你的模型每次都要重新加载？为什么 Nginx 要和后端“说话”？底层到底用了什么通信方式？本文从最古老的 CGI 出发，一路深入到内核级 IPC 机制，试图清晰理顺搞懂现代 Web 服务的通信本质。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-1">引言：一个朴素的问题</h3>
<p>你写了一个命令行工具 <code>my-model-cli</code>，它能处理用户输入并返回结果。但每次调用都要花 5 秒加载大模型——这显然无法用于 Web 服务。</p>
<p>你尝试用 Flask 包装它：</p>
<pre><code class="hljs language-python" lang="python">result = subprocess.run([<span class="hljs-string">"my-model-cli"</span>, <span class="hljs-built_in">input</span>])
</code></pre>
<p>却发现<strong>每次请求都重新启动进程</strong>，性能极差。</p>
<p>于是你问：</p>
<blockquote>
<p>“有没有办法让这个 CLI 工具常驻内存，只加载一次，反复使用？”</p>
</blockquote>
<p>这个问题，其实早在 Web 诞生之初就被提出过。而它的答案，藏在一段被遗忘的历史中——<strong>CGI</strong>。</p>
<hr/>
<h3 data-id="heading-2">一、CGI：Web 与程序交互的原始契约</h3>
<h4 data-id="heading-3">1.1 CGI 是什么？</h4>
<p>CGI（Common Gateway Interface）是 1990 年代 Web 服务器与外部程序通信的标准协议。其核心思想极其简单：</p>
<blockquote>
<p><strong>当收到 HTTP 请求时，Web 服务器直接执行一个可执行文件（<code>.cgi</code> 脚本），并将它的标准输出作为 HTTP 响应返回给浏览器。</strong></p>
</blockquote>
<h4 data-id="heading-4">1.2 一个最简 CGI 脚本</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># hello.cgi</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Content-Type: text/plain"</span>)
<span class="hljs-built_in">print</span>()  <span class="hljs-comment"># 空行分隔头与体</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello from CGI!"</span>)
</code></pre>
<p>部署后，访问 <code>http://example.com/cgi-bin/hello.cgi</code>，浏览器就会显示 <code>Hello from CGI!</code>。print的内容会被web服务器所捕获，这个cgi脚本本质上跟后来的JSP等没有什么区别，只有效率的区别（进程重复创建）。</p>
<h4 data-id="heading-5">1.3 CGI 的致命缺陷</h4>
<ul>
<li><strong>每请求 fork 一次</strong>：每次访问都启动新进程；</li>
<li><strong>无法复用状态</strong>：模型、数据库连接等必须重复初始化；</li>
<li><strong>性能低下</strong>：进程创建开销在高并发下成为瓶颈。</li>
</ul>
<blockquote>
<p>💡 这正是你遇到的 CLI 工具问题的<strong>放大版</strong>：CGI 本质上就是“用脚本调用 CLI”的通用化。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">二、现代方案：常驻进程 + 反向代理</h3>
<p>为解决 CGI 的问题，现代架构采用 <strong>“常驻服务 + 反向代理”</strong> 模式：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[Browser]</span> → <span class="hljs-selector-attr">[Nginx]</span> → <span class="hljs-selector-attr">[Your App (Flask/Gunicorn/Tomcat)]</span>
</code></pre>
<ul>
<li><strong>Nginx</strong>：处理静态文件、SSL、负载均衡；</li>
<li><strong>App</strong>：常驻内存，复用昂贵资源（如模型）；</li>
<li><strong>两者通过 socket 通信</strong>。</li>
</ul>
<p>但问题来了：<strong>它们到底用什么 socket？</strong></p>
<hr/>
<h3 data-id="heading-7">三、Nginx 与后端如何通信？TCP vs UDS</h3>
<h4 data-id="heading-8">3.1 默认方式：HTTP over TCP</h4>
<p>典型 Nginx 配置：</p>
<pre><code class="hljs language-nginx" lang="nginx">location / {
    proxy_pass http://127.0.0.1:8000;
}
</code></pre>
<ul>
<li>Nginx 作为 HTTP 客户端，通过 <strong>TCP 连接 <code>127.0.0.1:8000</code></strong>；</li>
<li>即使在同一台机器，数据仍经过 <strong>完整 TCP/IP 协议栈</strong>（校验和、缓冲区管理等）；</li>
<li><strong>优点</strong>：通用、跨语言、跨容器；</li>
<li><strong>缺点</strong>：有不必要的协议开销。</li>
</ul>
<h4 data-id="heading-9">3.2 更优选择：Unix Domain Socket (UDS)</h4>
<pre><code class="hljs language-nginx" lang="nginx">location / {
    proxy_passed http://unix:/tmp/app.sock;
}
</code></pre>
<ul>
<li>通信地址是一个<strong>文件路径</strong>（如 <code>/tmp/app.sock</code>）；</li>
<li><strong>不走网络协议栈</strong>，内核直接在进程间传递数据；</li>
<li><strong>性能提升 20%~50%</strong>（尤其小包高并发场景）；</li>
<li><strong>权限可控</strong>：通过 <code>chmod</code> 限制访问。</li>
</ul>
<blockquote>
<p>✅ 在 Python（Gunicorn/uWSGI）、Go、Node.js 等生态中，<strong>UDS 是生产环境推荐方案</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">四、UDS 与 TCP 的代码对比</h3>
<h4 data-id="heading-11">4.1 C 语言实现：仅一行之差</h4>
<h5 data-id="heading-12">TCP 服务端（IPv4）</h5>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);  <span class="hljs-comment">// ← 关键：AF_INET</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span> =</span> {<span class="hljs-number">0</span>};
addr.sin_family = AF_INET;
addr.sin_port = htons(<span class="hljs-number">8000</span>);
addr.sin_addr.s_addr = htonl(INADDR_LOOPBACK);
bind(sock, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;addr, <span class="hljs-keyword">sizeof</span>(addr));
</code></pre>
<h5 data-id="heading-13">UDS 服务端</h5>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> sock = socket(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>);  <span class="hljs-comment">// ← 关键：AF_UNIX</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_un</span> <span class="hljs-title">addr</span> =</span> {<span class="hljs-number">0</span>};
addr.sun_family = AF_UNIX;
<span class="hljs-built_in">strcpy</span>(addr.sun_path, <span class="hljs-string">"/tmp/app.sock"</span>);
bind(sock, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;addr, <span class="hljs-keyword">sizeof</span>(addr));
unlink(<span class="hljs-string">"/tmp/app.sock"</span>); <span class="hljs-comment">// 启动前清理</span>
</code></pre>
<blockquote>
<p>🔑 <strong>唯一区别：<code>AF_INET</code> vs <code>AF_UNIX</code></strong>。<br/>
后续 API（<code>listen</code>, <code>accept</code>, <code>recv</code>）完全一致——这正是 BSD Socket 的设计之美。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">五、UDS 底层原理：绕过网络栈的内核魔法</h3>
<p>之前写过一篇文章，讲解了IPC的种类和方便的记忆方法：<a href="https://juejin.cn/post/7569160551482818569" target="_blank" title="https://juejin.cn/post/7569160551482818569">进程间通信（IPC）分类讲解进程间通信（IPC）- 掘金</a>，感兴趣的可以回看一下。</p>
<p>UDS也是属于套接字，不过是本地套接字，而非跨主机的套接字，之所以非要弄个本地套接字，是为了跟跨主机的编程接口一致！</p>
<p>UDS 并非“文件”，而是<strong>内核中的 IPC 通道</strong>：</p>
<ol>
<li><strong>地址即路径</strong>：<code>/tmp/app.sock</code> 是 VFS 中的一个 <code>socket inode</code>（类型 <code>s</code>）；</li>
<li><strong>数据直通</strong>：<code>send()</code> → 内核缓冲区 → <code>recv()</code>，无 TCP/IP 封装；</li>
<li><strong>权限继承文件系统</strong>：<code>chmod 660 /tmp/app.sock</code> 可限制访问者；</li>
<li><strong>无端口占用</strong>：避免 <code>Address already in use</code> 问题。</li>
</ol>
<blockquote>
<p>📌 实测：在本地回环（loopback）场景，UDS 比 <code>127.0.0.1</code> TCP 快 30% 以上。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">六、为什么 Tomcat 仍用 TCP？</h3>
<p>你可能会问：既然 UDS 更好，为何 Java 的 Tomcat 不用？</p>
<ul>
<li><strong>Java 标准库的 <code>ServerSocket</code> 仅支持 TCP/UDP</strong>；</li>
<li>UDS 需要 JNI 或第三方库（如 <code>junixsocket</code>），增加复杂度；</li>
<li>在云原生时代，<strong>容器间通信通常走网络</strong>，UDS 优势减弱；</li>
<li><strong>TCP 足够用</strong>：本机 loopback 性能损失可接受。</li>
</ul>
<blockquote>
<p>✅ 所以：<strong>Python/Go/Rust 常用 UDS，Java 生态多用 TCP</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-16">七、回到最初的问题：如何让 CLI 工具常驻？</h3>
<p>现在你有了完整答案：</p>

























<table><thead><tr><th>方案</th><th>说明</th></tr></thead><tbody><tr><td><strong>❌ 直接用 subprocess</strong></td><td>每次 fork，无法复用状态</td></tr><tr><td><strong>✅ 改造成常驻服务</strong></td><td>用 <code>while True</code> 循环读 stdin 或监听 UDS</td></tr><tr><td><strong>✅ 用 Gunicorn + UDS</strong></td><td>将逻辑封装为 WSGI app，由 Gunicorn 管理进程</td></tr><tr><td><strong>✅ 缓存中间结果</strong></td><td>对确定性输入缓存输出，减少实际调用</td></tr></tbody></table>
<p>例如，将 CLI 改为 UDS 服务：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> socket
sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
sock.bind(<span class="hljs-string">"/tmp/model.sock"</span>)
sock.listen(<span class="hljs-number">1</span>)
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    conn, _ = sock.accept()
    input_data = conn.recv(<span class="hljs-number">1024</span>).decode()
    result = process_once_loaded_model(input_data)  <span class="hljs-comment"># 模型只加载一次！</span>
    conn.send(result.encode())
    conn.close()
</code></pre>
<p>Nginx 只需配置 <code>proxy_pass http://unix:/tmp/model.sock;</code> 即可。</p>
<hr/>
<h3 data-id="heading-17">结语：理解抽象之下的真实世界</h3>
<p>从 CGI 的 <code>print()</code> 到 UDS 的 <code>AF_UNIX</code>，我们走过了一条从<strong>应用层</strong>到<strong>内核层</strong>的认知之路。</p>
<ul>
<li><strong>CGI</strong> 教会我们：进程模型决定性能上限；</li>
<li><strong>反向代理</strong> 告诉我们：解耦是扩展性的关键；</li>
<li><strong>UDS vs TCP</strong> 揭示了：<strong>最优方案取决于通信范围与性能需求</strong>。</li>
</ul>
<p>下次当你部署一个模型服务时，你会知道：</p>
<blockquote>
<p>“我不只是在写代码，我是在设计进程间的对话方式。”</p>
</blockquote>
<p>而这，正是系统工程的魅力所在。</p>
<hr/>
<p><strong>延伸阅读</strong>：</p>
<ul>
<li>《UNIX Network Programming》 by W. Richard Stevens</li>
<li>Linux 内核源码：<code>net/unix/af_unix.c</code></li>
<li>Nginx 官方文档：<a href="https://link.juejin.cn?target=http%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html" target="_blank" title="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" ref="nofollow noopener noreferrer">ngx_http_proxy_module</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在数据库迁移中，如何让 AI 真正“可用、可信、可落地”?]]></title>    <link>https://juejin.cn/post/7587342120022212659</link>    <guid>https://juejin.cn/post/7587342120022212659</guid>    <pubDate>2025-12-25T05:14:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587342120022212659" data-draft-id="7587336857538707465" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在数据库迁移中，如何让 AI 真正“可用、可信、可落地”?"/> <meta itemprop="keywords" content="数据库,SQL,LLM"/> <meta itemprop="datePublished" content="2025-12-25T05:14:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱可生开源社区"/> <meta itemprop="url" content="https://juejin.cn/user/1480387593251847"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在数据库迁移中，如何让 AI 真正“可用、可信、可落地”?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1480387593251847/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱可生开源社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T05:14:06.000Z" title="Thu Dec 25 2025 05:14:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24265f1dec9141dfad04ee4cdcb68485~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767245931&amp;x-signature=%2F0HpE5Jt9F2KsQ7YkkgP51zAwIA%3D" alt="生成特定风格图片 (1).png" loading="lazy"/></p>
<p><strong>在数据库迁移领域，AI 正在被寄予厚望。</strong></p>
<p>但一个现实问题也越来越清晰：如果只“<strong>相信模型</strong>”，迁移风险并不会减少，甚至可能被放大。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsqlshift.cn%2Fapp%2Ftask_detail%3Ftask_id%3D578cb98b-a121-41a6-930a-4cc271ef0749%26task_name%3DDemo%26detail_type%3Dshare_detail%26code%3D83103ce2-9167-439c-a03c-532c911fb516" title="https://sqlshift.cn/app/task_detail?task_id=578cb98b-a121-41a6-930a-4cc271ef0749&amp;task_name=Demo&amp;detail_type=share_detail&amp;code=83103ce2-9167-439c-a03c-532c911fb516" target="_blank" ref="nofollow noopener noreferrer">SQLShift</a> 正是在这样的背景下诞生，并持续演进。</p>
<h2 data-id="heading-0">一、数据库迁移难点</h2>
<p>在企业进行 IT 架构升级、云化改造或国产化替代时，数据库迁移几乎是绕不开的核心任务。</p>
<p>从实践来看，迁移难点主要集中在两个层面：</p>
<p>1️⃣ <strong>表对象层面</strong></p>
<p>字段类型映射、长度调整、默认值修正，这类问题已经被大量工具（如 OMA、OMS、DTS 等）较好解决。</p>
<p>2️⃣ <strong>非表对象层面</strong></p>
<p>存储过程、函数、触发器、包、视图等非表对象中，封装的是 <strong>真实业务逻辑</strong>，也是迁移中最容易出问题的地方。</p>
<p>即便在“<strong>看似兼容</strong>”的迁移路径中，问题依然大量存在。例如：</p>
<ul>
<li>在 Oracle → OceanBase（Oracle 模式）迁移中
<ul>
<li><code>SYSDATE()</code> 在 Oracle 可用，在 OceanBase 中却报错</li>
<li>动态 SQL 的 <code>USING</code> 子句在目标端行为更严格</li>
</ul>
</li>
<li>全角符号、隐式类型转换、宽松语法在目标端直接失效</li>
<li>国产数据库宣称“完全兼容”，但关键行为差异并未在文档中说明</li>
</ul>
<p>这些“隐性方言差异”，往往需要 DBA <strong>逐行阅读、反复调试、人工改写</strong>，成本极高、风险极大。</p>
<h2 data-id="heading-1">二、为什么“直接用大模型做迁移”并不可靠？</h2>
<p>在 <strong>SQLShift</strong> 的早期调研与实践中，我们并没有盲目乐观地“直接上 AI”。相反，我们系统性地验证了一个问题：</p>
<blockquote>
<p>大模型是否真的具备可靠的数据库语法与版本感知能力？</p>
</blockquote>
<h3 data-id="heading-2">🔍 实际评测结论（来自多模型测试）</h3>
<p>在对多款主流大模型（包括 GPT、Claude、Gemini、DeepSeek、Qwen、Kimi 等）进行对比评测后，我们得到了一致结论：</p>
<p><strong>即使是排行榜前列的大模型，在数据库版本与细节问题上，仍然普遍存在幻觉。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9228b0db11ca4895a6a794e9f3792760~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767245931&amp;x-signature=ZS7SaFM04ZzWv5zmVBm6isoEcQI%3D" alt="" loading="lazy"/></p>
<p>关键结论包括：</p>
<ul>
<li>单靠模型“自身知识”回答数据库兼容问题，可靠性不足</li>
<li><strong>结合联网搜索会有明显提升，但仍无法保证一致正确</strong></li>
</ul>
<h3 data-id="heading-3">📌 典型测试问题示例</h3>
<ul>
<li>OceanBase（MySQL 模式）从哪个版本开始支持临时表？</li>
<li>GaussDB v2.0_3.x 集中式版本是否支持 <code>ON COMMIT DROP</code>？</li>
<li>GaussDB v2.0_3.x 集中式版本是否内置 UUID 生成函数？</li>
</ul>
<p>这些问题在 DBA 看来是 <strong>确定且可查证的事实</strong>，但大模型却频繁出现：</p>
<ul>
<li>版本号错误</li>
<li>功能“凭空存在”</li>
<li>行为描述与官方文档不一致</li>
</ul>
<p>这意味着：</p>
<blockquote>
<p>如果直接让大模型“自由生成”迁移 SQL，风险是不可控的。</p>
</blockquote>
<h2 data-id="heading-4">三、SQLShift 的核心思路</h2>
<p>正是基于上述认知，<strong>SQLShift</strong> 从一开始就明确了一条技术路线：</p>
<p><strong>AI 是能力放大器，但不能是唯一判断源。</strong></p>
<h3 data-id="heading-5">SQLShift 的定位</h3>
<p><strong>SQLShift 是一款专注于数据库非表对象的智能方言转换工具</strong>，但它的“智能”并非单一模型能力，而是一个 <strong>工程化的 AI 迁移体系</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4642ddebdf3f4adaa7d577c0a8ddfd9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767245931&amp;x-signature=jEAyjOYXD2hz%2Fid6R2f8liVp5MI%3D" alt="" loading="lazy"/></p>
<p>👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsqlshift.cn%2Fapp%2Ftask_detail%3Ftask_id%3D578cb98b-a121-41a6-930a-4cc271ef0749%26task_name%3DDemo%26detail_type%3Dshare_detail%26code%3D83103ce2-9167-439c-a03c-532c911fb516" target="_blank" title="https://sqlshift.cn/app/task_detail?task_id=578cb98b-a121-41a6-930a-4cc271ef0749&amp;task_name=Demo&amp;detail_type=share_detail&amp;code=83103ce2-9167-439c-a03c-532c911fb516" ref="nofollow noopener noreferrer">即刻体验</a></p>
<h2 data-id="heading-6">四、SQLShift 如何让 AI 在迁移场景中“可控”</h2>
<h3 data-id="heading-7">1️⃣ 领域知识微调，而非通用问答</h3>
<p><strong>SQLShift</strong> 并不依赖模型的“通识记忆”，而是：</p>
<ul>
<li>使用 数据库官方文档、语法规范、最佳实践</li>
<li>引入 真实迁移项目中的存储过程、函数 Case</li>
<li>通过 DBA 人工校验 构建高质量训练与验证集</li>
</ul>
<p>目标只有一个：</p>
<blockquote>
<p>让模型学习“数据库真实世界”，而不是互联网印象。</p>
</blockquote>
<h3 data-id="heading-8">2️⃣ 多重校验机制，而非一次性生成</h3>
<p>在 SQLShift 中，AI 生成并不是终点，而是起点：</p>
<ul>
<li><strong>语法校验</strong>：通过目标数据库解析器验证是否可执行</li>
<li><strong>语义校验（探索中）</strong>：用第二模型审查高风险逻辑</li>
<li><strong>历史 Case 对照</strong>：对比已知兼容 / 不兼容模式</li>
</ul>
<p>避免“看起来对，实际上错”的隐性风险。</p>
<h3 data-id="heading-9">3️⃣ 人机协同，而不是“黑盒 AI”</h3>
<p>对于复杂度极高或模型置信度不足的代码：</p>
<ul>
<li><strong>SQLShift</strong> 会显式标注风险点</li>
<li>给出转换依据与修改建议</li>
<li>DBA 可快速确认并让 <strong>SQLShift</strong> 自动调整</li>
</ul>
<p>用户的每一次反馈，都会反向进入模型与规则的优化闭环。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1659b7410aa4bfd9564556c229af68c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5Y-v55Sf5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767245931&amp;x-signature=rTBm3nkANQXmVYJ5MF79c8gpmRo%3D" alt="" loading="lazy"/></p>
<p>👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsqlshift.cn%2Fapp%2Ftask_detail%3Ftask_id%3D578cb98b-a121-41a6-930a-4cc271ef0749%26task_name%3DDemo%26detail_type%3Dshare_detail%26code%3D83103ce2-9167-439c-a03c-532c911fb516" target="_blank" title="https://sqlshift.cn/app/task_detail?task_id=578cb98b-a121-41a6-930a-4cc271ef0749&amp;task_name=Demo&amp;detail_type=share_detail&amp;code=83103ce2-9167-439c-a03c-532c911fb516" ref="nofollow noopener noreferrer">即刻体验</a></p>
<h3 data-id="heading-10">4️⃣ 模块化与分治，解决超大对象问题</h3>
<p>面对动辄上千行的存储过程：</p>
<ul>
<li><strong>SQLShift</strong> 尝试先由模型 拆解逻辑模块</li>
<li>再对每个子模块分别转换</li>
<li>最终在目标端重新组合</li>
</ul>
<p>这既解决了上下文长度限制，也显著提升了准确率。</p>
<h2 data-id="heading-11">五、SQLShift 的价值：不是替代 DBA，而是降低迁移的不确定性</h2>
<p>在数据库迁移这件事上，不确定性本身就是最大的成本。</p>
<p><strong>SQLShift</strong> 的核心价值在于：</p>
<ul>
<li>将大量隐性方言差异显性化</li>
<li>将“靠经验猜”的迁移过程，变成“有依据、有校验”的工程流程</li>
<li>大幅减少 DBA 在非表对象迁移中的重复劳动与踩坑成本</li>
</ul>
<p>无论是初级 DBA，还是经验丰富的专家，都可以在 SQLShift 的辅助下：</p>
<blockquote>
<p>把时间用在判断与决策上，而不是消耗在无穷的试错中。</p>
</blockquote>
<h2 data-id="heading-12">结语</h2>
<p>AI 正在改变数据库迁移，但<strong>真正可用的 AI，一定是被工程体系约束和验证过的 AI</strong>。</p>
<p><strong>SQLShift</strong> 选择了一条更慢、但更稳的路：</p>
<p>不追求“看起来很聪明”，而追求 <strong>在真实数据库上能跑、能用、能交付</strong>。
这，才是 AI 在数据库迁移场景中真正的价值所在。</p>
<h2 data-id="heading-13">🎁 限时活动说明</h2>
<p>为降低大家体验智能迁移能力的门槛，<strong>SQLShift</strong> 当前开放活动期内免费使用，所有用户均可在线体验 AI 驱动的非表对象语法转换能力。</p>
<p>📅 <strong>活动截止时间</strong>：2025 年 12 月 30 日</p>
<p>如果你正面临数据库迁移，尤其是存储过程这种非表对象迁移难题，欢迎在活动期内免费参与体验，与 <strong>SQLShift</strong> 一起验证 AI 在真实迁移场景中的价值。</p>
<p>👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsqlshift.cn%2Fapp%2Ftask_detail%3Ftask_id%3D578cb98b-a121-41a6-930a-4cc271ef0749%26task_name%3DDemo%26detail_type%3Dshare_detail%26code%3D83103ce2-9167-439c-a03c-532c911fb516" target="_blank" title="https://sqlshift.cn/app/task_detail?task_id=578cb98b-a121-41a6-930a-4cc271ef0749&amp;task_name=Demo&amp;detail_type=share_detail&amp;code=83103ce2-9167-439c-a03c-532c911fb516" ref="nofollow noopener noreferrer">即刻体验</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用URLPattern API构建自己的路由器 🛣️]]></title>    <link>https://juejin.cn/post/7587263750250299443</link>    <guid>https://juejin.cn/post/7587263750250299443</guid>    <pubDate>2025-12-25T03:40:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587263750250299443" data-draft-id="7587313610696671259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用URLPattern API构建自己的路由器 🛣️"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-25T03:40:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yanni4Night"/> <meta itemprop="url" content="https://juejin.cn/user/4089838983724520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用URLPattern API构建自己的路由器 🛣️
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4089838983724520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yanni4Night
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T03:40:09.000Z" title="Thu Dec 25 2025 03:40:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjschof.dev%2Fposts%2F2025%2F11%2Fbuild-your-own-router%2F" target="_blank" title="https://jschof.dev/posts/2025/11/build-your-own-router/" ref="nofollow noopener noreferrer">jschof.dev/posts/2025/…</a></p>
</blockquote>
<p>URLPattern 现在已经在所有浏览器中可用了！所以我想深入研究一下，看看如何使用原生 JavaScript 和浏览器 API 制作一个简单的 SPA 路由器。我们应该能够创建一个组件，它接受路由器配置，并根据浏览器 URL 渲染相应的组件。</p>
<h2 data-id="heading-0">URLPattern() 是做什么的？📎</h2>
<p>对于路由器来说，条件渲染组件并不是困难的部分。困难的是准确测试浏览器 URL，以确定应该渲染哪个组件。而且不仅如此，我们还需要能够捕获路由的动态部分（比如像 <code>/posts/{post_id}</code> 这样的路径）。</p>
<p>不多说，让我们来看一些示例，展示如何测试路由 URL 是否匹配某个模式！然后你可以使用这个机制来创建一个具有易于配置路径的路由器。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> catUrlPattern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>({ <span class="hljs-attr">pathname</span>: <span class="hljs-string">"/cat"</span> });
catUrlPattern.<span class="hljs-title function_">test</span>(<span class="hljs-string">"http://www.jschof.dev/cat"</span>); <span class="hljs-comment">// True!</span>
catUrlPattern.<span class="hljs-title function_">test</span>(<span class="hljs-string">"http://www.jschof.dev/dog"</span>); <span class="hljs-comment">// False!</span>
catUrlPattern.<span class="hljs-title function_">test</span>({ <span class="hljs-attr">pathname</span>: <span class="hljs-string">"/cat"</span> }); <span class="hljs-comment">// True!</span>
catUrlPattern.<span class="hljs-title function_">test</span>(<span class="hljs-string">"http://www.jschof.dev/cat/"</span>); <span class="hljs-comment">// False!</span>
catUrlPattern.<span class="hljs-title function_">test</span>(<span class="hljs-string">"http://www.jschof.dev/cat/other-things?yes"</span>); <span class="hljs-comment">// False!</span>
</code></pre>
<p>你可能会对上面的第四个例子感到惊讶。<code>/cat</code> 和 <code>/cat/</code> 是有区别的。所以为了处理这种情况，你可以在一个用大括号括起来的组中使模式可选地包含一个结尾斜杠，并使用 <code>?:</code> 标记它为可选：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> catUrlPattern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>({ <span class="hljs-attr">pathname</span>: <span class="hljs-string">"/cat{/}?"</span> });
catUrlPattern.<span class="hljs-title function_">test</span>(<span class="hljs-string">"http://www.jschof.dev/cat"</span>); <span class="hljs-comment">// True!</span>
catUrlPattern.<span class="hljs-title function_">test</span>({ <span class="hljs-attr">pathname</span>: <span class="hljs-string">"/cat/"</span> }); <span class="hljs-comment">// True!</span>
catUrlPattern.<span class="hljs-title function_">test</span>(<span class="hljs-string">"http://www.jschof.dev/cat/"</span>); <span class="hljs-comment">// True!</span>
catUrlPattern.<span class="hljs-title function_">test</span>(<span class="hljs-string">"http://www.jschof.dev/cat/other-things?yes"</span>); <span class="hljs-comment">// False!</span>
</code></pre>
<p>又一个惊喜！你可能期望可以接受 <code>/cat/</code> 后面的更多内容。要做到这一点，需要包含一个通配符星号：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> catUrlPattern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>({ <span class="hljs-attr">pathname</span>: <span class="hljs-string">"/cat{/}?*"</span> });
catUrlPattern.<span class="hljs-title function_">test</span>(<span class="hljs-string">"http://www.jschof.dev/cat"</span>); <span class="hljs-comment">// True!</span>
catUrlPattern.<span class="hljs-title function_">test</span>({ <span class="hljs-attr">pathname</span>: <span class="hljs-string">"/cat/"</span> }); <span class="hljs-comment">// True!</span>
catUrlPattern.<span class="hljs-title function_">test</span>(<span class="hljs-string">"http://www.jschof.dev/cat/"</span>); <span class="hljs-comment">// True!</span>
catUrlPattern.<span class="hljs-title function_">test</span>(<span class="hljs-string">"http://www.jschof.dev/cat/other-things?yes"</span>); <span class="hljs-comment">// True!</span>
</code></pre>
<h2 data-id="heading-1">我们从哪里开始？📎</h2>
<p>我将使用一个配置对象数组，将 URL 路由与特定的 Web 组件关联起来。这与你使用 vue-router 创建路由器的方式非常相似。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> routerConfig = [
  { <span class="hljs-attr">pathName</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>(<span class="hljs-string">"/home{/}?"</span>), <span class="hljs-attr">component</span>: <span class="hljs-string">"my-home"</span> },
  { <span class="hljs-attr">pathName</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>(<span class="hljs-string">"/posts{/}?"</span>), <span class="hljs-attr">component</span>: <span class="hljs-string">"my-posts"</span> },
  { <span class="hljs-attr">pathName</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>(<span class="hljs-string">"/about{/}?"</span>), <span class="hljs-attr">component</span>: <span class="hljs-string">"my-about"</span> },
];
</code></pre>
<p>配置对象的顺序很重要。我们会逐个测试每个模式，如果找到匹配项，就渲染那个 Web 组件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> config <span class="hljs-keyword">of</span> routerConfig) {
  <span class="hljs-keyword">if</span> (config.<span class="hljs-property">pathName</span>.<span class="hljs-title function_">test</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>)) {
    <span class="hljs-comment">// 渲染 config.component！</span>
    <span class="hljs-keyword">return</span>;
  }
}
<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 处理 404！</span>
</code></pre>
<p>如何进行渲染呢？这将是我们放置所有这些逻辑的 Web 组件的工作。该组件会查看当前窗口 URL，将其与我们用 URLPattern 设置的所有路由器配置进行测试，然后创建并渲染适当的 Web 组件作为子元素。</p>
<p>有些框架称这个路由器为"出口"组件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> routerConfig = [
  { <span class="hljs-attr">pathName</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>(<span class="hljs-string">"/home{/}?"</span>), <span class="hljs-attr">component</span>: <span class="hljs-string">"my-home"</span> },
  { <span class="hljs-attr">pathName</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>(<span class="hljs-string">"/posts{/}?"</span>), <span class="hljs-attr">component</span>: <span class="hljs-string">"my-posts"</span> },
  { <span class="hljs-attr">pathName</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>(<span class="hljs-string">"/about{/}?"</span>), <span class="hljs-attr">component</span>: <span class="hljs-string">"my-about"</span> },
];
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRouter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HTMLElement</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-keyword">const</span> matchedComponent = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRouteMatch</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderComponent</span>(matchedComponent);
  }
  <span class="hljs-title function_">getRouteMatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> config <span class="hljs-keyword">of</span> routerConfig) {
      <span class="hljs-keyword">if</span> (config.<span class="hljs-property">pathName</span>.<span class="hljs-title function_">test</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>)) {
        <span class="hljs-keyword">return</span> config.<span class="hljs-property">component</span>;
      }
    }
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 处理 404！</span>
  }
  <span class="hljs-title function_">renderComponent</span>(<span class="hljs-params">component</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">const</span> viewElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(component);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendChild</span>(viewElement);
  }
}
customElements.<span class="hljs-title function_">define</span>(<span class="hljs-string">"my-router"</span>, <span class="hljs-title class_">MyRouter</span>);
</code></pre>
<p>当然，你还需要注册 <code>my-home</code>、<code>my-posts</code> 和 <code>my-about</code> 这些 Web 组件。</p>
<p>这样我们就有了一个路由器，它会在页面加载时渲染适当的 Web 组件。不过我们还有很多工作要做。如果有人点击链接怎么办？如果有人使用浏览器导航前进或后退怎么办？我们需要处理这些情况，幸运的是这并不太困难。</p>
<h2 data-id="heading-2">处理 SPA 导航和链接点击 📎</h2>
<p>有一点需要意识到的是，如果你导航到 <code>http://www.myblog.com/some/path</code>，服务器通常会尝试在后端解析 <code>/some/path</code>。它实际上可能会寻找 "some" 和 "path" 文件夹。但在 SPA 中，我们没有文件夹——我们只有一个处理虚拟路径的 index HTML 文件。所有这些都在客户端用 JS 完成！无论我们要到哪个路径，服务器实际上只需要提供 index 页面。然后客户端会接管，使用我们的新 URLPattern 并处理渲染适当的组件。</p>
<p>对于配置 Vite 来说，这非常简单。你可以使用一个名为 <code>spa</code> 的配置。只需更新你的 vite 配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">appType</span>: <span class="hljs-string">"spa"</span>,
});
</code></pre>
<p>这对于你的 Vite 本地服务器来说效果很好。但不幸的是，这将取决于你部署的位置以及你使用的其他框架/开发服务器。对于像 netlify 这样的地方，你需要在你的 netlify 配置中设置重定向规则。你可能需要查阅 Stack Overflow、Google 或你选择的 LLM 来了解如何针对你的特定情况执行此操作。</p>
<p>但一旦你设置好服务器配置和重定向，我们就可以开始处理点击事件了！</p>
<p>我们基本上想拦截任何链接点击，并阻止浏览器正常导航。这意味着我们要对所有点击事件调用 <code>preventDefault()</code>，并提取链接的目标来与我们的 URL 模式进行测试。这让我们知道应该渲染哪个组件，然后我们手动将 URL 设置为锚标签指向的内容。看起来我们正在更改页面，但实际上我们是在模拟页面过渡。</p>
<p>我们需要在路由器组件连接到 DOM 时设置一个点击处理器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRouter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HTMLElement</span> {
  <span class="hljs-comment">//...</span>
  <span class="hljs-title function_">connectedCallback</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClicks</span>);
  }
  handleClicks = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">target</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLAnchorElement</span>) {
      <span class="hljs-comment">// 不要像通常那样处理这个链接！</span>
      event.<span class="hljs-title function_">preventDefault</span>();
      <span class="hljs-comment">// 手动设置 URL</span>
      <span class="hljs-keyword">const</span> toUrl = event.<span class="hljs-property">target</span>.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">"href"</span>);
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">""</span>, toUrl);
      <span class="hljs-comment">// 现在 URL 已经设置好了，执行通常的匹配和渲染！</span>
      <span class="hljs-keyword">const</span> matchedComponent = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRouteMatch</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderComponent</span>(matchedComponent);
    }
  };
  <span class="hljs-title function_">disconnectedCallback</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClicks</span>);
  }
}
</code></pre>
<p>当然，确保你在 <code>disconnectedCallback</code> 中清理这些处理器！</p>
<p>当用户点击链接时，他们会看到 URL 改变，页面过渡，甚至浏览器导航历史中会有一个新条目。现在，我们需要确保浏览器不会实际前进或后退，而是在点击前进/后退按钮时钩子到我们的路由器。</p>
<blockquote>
<p>注意：在上面的例子中，我们拦截了所有锚标签上的点击，无论点击是在我们的路由器组件内部还是外部。你可能只想处理这个路由器组件内部的点击，这样你就不会承担整个页面上链接的责任。</p>
</blockquote>
<blockquote>
<p>另外，请注意，我们甚至还没有触及如何处理外部链接。这需要特别注意，但这超出了这篇博客文章的范围。</p>
</blockquote>
<h2 data-id="heading-3">最后一个细节：浏览器导航 📎</h2>
<p>当浏览器前进或后退时（无论是通过编程方式 <code>window.back()</code>/<code>forward()</code> 还是用户点击前进/后退按钮），都会触发一个 <code>popstate</code> 事件。</p>
<p>这个事件的好处是，当我们使用 <code>window.pushState</code> 时，浏览器已经在历史栈中前后移动到了我们推送的条目。换句话说，我们只需要监听这种后退/前进导航何时发生，并渲染我们的组件。在按下后退/前进按钮后，URL 已经更新了。</p>
<p>这是我们最小可行路由器的最后一部分：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRouter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HTMLElement</span> {
  <span class="hljs-comment">//...</span>
  <span class="hljs-title function_">connectedCallback</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClicks</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"popstate"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlePopState</span>);
  }
  handlePopState = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> matchedComponent = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRouteMatch</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderComponent</span>(matchedComponent);
  };
  <span class="hljs-title function_">disconnectedCallback</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClicks</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"popstate"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handlePopState</span>);
  }
}
</code></pre>
<h2 data-id="heading-4">一个工作示例 📎</h2>
<p>如果你有兴趣看到它的工作原理，这里有一个在 StackBlitz 上构建的示例。</p>
<p>还有更多工作要做！以下是我建议研究的事情：</p>
<ul>
<li>创建动态段，如 <code>/posts/:id</code>。这里有一些关于处理动态参数的文档</li>
<li>使用 <code>search</code> 处理查询参数</li>
<li>处理嵌套或子路由器</li>
</ul>
<h2 data-id="heading-5">需要记住的事情... 📎</h2>
<p>我们正在处理相当底层的东西。像这样创建自己的路由器渲染器可能会让你暴露在 XSS 攻击中，如果你留下了让人们破坏你的路由器配置的方法。例如，如果你让人们直接在路由器组件上设置配置数组，有人可能会在控制台中注册他们自己的 Web 组件，并导航到他们的组件来渲染它。实际上，你将允许其他方在你的路由器中运行他们的代码！</p>
<p>这就是为什么，至少在我们讨论的例子中，路由器配置是在我们的路由器组件中的一个私有变量中定义的。如果我们公开这个属性，有人可以注册他们自己的 Web 组件并让我们的路由器渲染它。</p>
<p>我们如何解决这个问题？我想说，永远不要纯粹基于 URL 的查询参数或动态段进行渲染。始终将实际渲染的 Web 组件保存在静态列表中——可能是路由器上的私有变量中的列表。</p>
<p>另一件事——我们应该用 Web 组件构建路由器吗？嗯...也许不应该？Lit 似乎认为这会有帮助和有用。但你自己实现的路由器需要处理很多框架路由器已经解决的问题。Web 组件还增加了另一个你需要注意的安全级别。</p>
<p>我认为这值得研究和学习。而且了解不断推出的原生 API 也很好，这些 API 让我们在依赖平台时的生活更轻松。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析：fetch 与 Promise 结合实战及面试重点]]></title>    <link>https://juejin.cn/post/7587313610696851483</link>    <guid>https://juejin.cn/post/7587313610696851483</guid>    <pubDate>2025-12-25T04:16:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587313610696851483" data-draft-id="7587342120022114355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析：fetch 与 Promise 结合实战及面试重点"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-25T04:16:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端无涯"/> <meta itemprop="url" content="https://juejin.cn/user/3967483738859639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析：fetch 与 Promise 结合实战及面试重点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3967483738859639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端无涯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T04:16:18.000Z" title="Thu Dec 25 2025 04:16:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>在前端异步编程领域，Promise 是解决回调地狱的核心方案，而 fetch 作为现代浏览器原生支持的网络请求 API，其设计本身就深度依赖 Promise。掌握二者的结合使用，不仅是日常开发的基础，更是前端面试的高频考点。本文将从核心概念联动、实战场景应用、面试重点拆解三个维度，帮你彻底搞懂 fetch 与 Promise 的协同逻辑。</p>
<h2 data-id="heading-0">一、核心概念：为什么 fetch 天然适配 Promise？</h2>
<p>在讲解结合用法前，我们先明确两个核心概念的关联：</p>
<h3 data-id="heading-1">1.1 Promise 的核心价值</h3>
<p>Promise 是一种用于处理异步操作的对象，它将异步操作的结果（成功/失败）封装为可预测的状态流转，避免了多层嵌套的回调地狱。其核心特性包括：</p>
<ul>
<li>三种状态：<code>pending</code>（进行中）、<code>fulfilled</code>（成功）、<code>rejected</code>（失败），状态一旦改变不可逆；</li>
<li>链式调用：通过 <code>then()</code> 接收成功结果，<code>catch()</code> 捕获错误，支持链式串联多个异步操作；</li>
<li>异步穿透：允许在链式调用中跳过部分 <code>then()</code>，直接由后续 <code>catch()</code> 捕获错误。</li>
</ul>
<h3 data-id="heading-2">1.2 fetch 的设计本质</h3>
<p>fetch 是浏览器提供的用于替代 XMLHttpRequest 的网络请求 API，其核心设计理念就是“基于 Promise 封装异步请求”。与 XHR 不同，fetch 调用后会直接返回一个 Promise 对象：</p>
<ul>
<li>当请求发出后，Promise 处于 <code>pending</code> 状态；</li>
<li>当服务器返回响应（无论 HTTP 状态码是否为 2xx），Promise 会变为 <code>fulfilled</code>，并将响应对象（Response）传递给 <code>then()</code>；</li>
<li>只有当网络故障（如断网、跨域未授权等）导致请求无法发出时，Promise 才会变为 <code>rejected</code>，错误会被 <code>catch()</code> 捕获。</li>
</ul>
<p>注意：fetch 的 Promise 不会因 HTTP 错误状态码（如 404、500）而 reject，这是面试高频易错点！</p>
<h2 data-id="heading-3">二、实战场景：fetch 与 Promise 结合用法全解析</h2>
<p>基于二者的天然适配性，实际开发中我们通过 Promise 的链式调用，就能优雅地处理 fetch 的请求、响应解析、错误捕获全流程。以下是高频实战场景：</p>
<h3 data-id="heading-4">2.1 基础场景：GET 请求与响应解析</h3>
<p>fetch 默认发起 GET 请求，需通过 Response 对象的方法（如 <code>json()</code>、<code>text()</code>）解析响应体，而这些方法本身也返回 Promise，因此需要嵌套一层 <code>then()</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基础 GET 请求</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/data'</span>)
  <span class="hljs-comment">// 第一次 then：接收响应对象，解析为 JSON（返回 Promise）</span>
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-comment">// 手动处理 HTTP 错误状态码</span>
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP 错误：<span class="hljs-subst">${response.status}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>(); <span class="hljs-comment">// 解析 JSON 格式响应体，返回 Promise</span>
  })
  <span class="hljs-comment">// 第二次 then：接收解析后的业务数据</span>
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求成功：'</span>, data);
  })
  <span class="hljs-comment">// catch：捕获所有错误（网络错误 + 手动抛出的 HTTP 错误）</span>
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, error);
  });
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>核心逻辑：外层 Promise 处理请求发起与响应接收，内层 Promise 处理响应体解析，通过链式调用串联，代码清晰无嵌套。</p>
<h3 data-id="heading-5">2.2 进阶场景：POST 请求与请求配置</h3>
<p>发起 POST 请求时，需通过 fetch 的第二个参数配置请求方法、请求头、请求体等，结合 Promise 处理复杂异步逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义请求数据</span>
<span class="hljs-keyword">const</span> postData = { <span class="hljs-attr">username</span>: <span class="hljs-string">'test'</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">'123456'</span> };

<span class="hljs-comment">// POST 请求</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/login'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>, <span class="hljs-comment">// 请求方法</span>
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>, <span class="hljs-comment">// 声明请求体格式为 JSON</span>
  },
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(postData), <span class="hljs-comment">// 序列化请求体（必须为字符串）</span>
})
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {<span class="hljs-comment">//这里是处理fetch返回的promise对象</span>
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`状态码：<span class="hljs-subst">${response.status}</span>`</span>);
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {<span class="hljs-comment">//response.json也是一个promise对象</span>
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'登录成功：'</span>, result.<span class="hljs-property">data</span>.<span class="hljs-property">token</span>);
      <span class="hljs-comment">// 可继续发起后续请求（如获取用户信息），形成 Promise 链式串联</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/userInfo'</span>, {
        <span class="hljs-attr">headers</span>: { <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${result.data.token}</span>`</span> }
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(result.<span class="hljs-property">msg</span>);
    }
  })
    <span class="hljs-comment">// 这里是获取用户对象fetch 返回的promise</span>
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">userRes</span> =&gt;</span> userRes.<span class="hljs-title function_">json</span>())
    <span class="hljs-comment">// 处理获取用户信息接口返回的数据</span>
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">userData</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户信息：'</span>, userData))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'流程失败：'</span>, error));
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>关键亮点：在一个 Promise 链中串联多个异步请求（登录 → 获取用户信息），前一个请求的结果作为后一个请求的参数，实现异步流程的线性化。</p>
<h3 data-id="heading-6">2.3 高级场景：Promise 工具函数结合 fetch</h3>
<p>利用 Promise 的工具函数（如 <code>Promise.all()</code>、<code>Promise.race()</code>），可实现 fetch 的批量请求或超时控制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. Promise.all()：并行发起多个请求，全部成功才返回结果</span>
<span class="hljs-keyword">const</span> request1 = <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/data1'</span>);
<span class="hljs-keyword">const</span> request2 = <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/data2'</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([request1, request2])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">responses</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(responses.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())))
  .<span class="hljs-title function_">then</span>([data1, data2] =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'批量请求成功：'</span>, data1, data2);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'任意一个请求失败：'</span>, error));

<span class="hljs-comment">// 2. Promise.race()：超时控制（请求超时时中断并抛出错误）</span>
<span class="hljs-keyword">const</span> timeoutPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求超时（3秒）'</span>)), <span class="hljs-number">3000</span>);
});

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/slowData'</span>), timeoutPromise])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求成功：'</span>, data))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, error));
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-7">2.4 优化场景：Promise 工具函数结合async,await</h3>
<p>利用async,await将请求更加优雅,统一处理error</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">search</span> = <span class="hljs-keyword">async</span>(<span class="hljs-params"/>) =&gt;{
    <span class="hljs-keyword">try</span>{
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/test'</span>)
        <span class="hljs-keyword">const</span> data = res.<span class="hljs-title function_">json</span>()
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data,<span class="hljs-string">'返回接口数据'</span>)
    }<span class="hljs-keyword">catch</span>(err){
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求出错'</span>,err)
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-8">三、面试重点：高频问题与核心答案</h2>
<p>fetch 与 Promise 的结合是前端面试的核心考点，以下是高频问题及精准回答思路：</p>
<h3 data-id="heading-9">3.1 问题 1：fetch 的返回值是什么？它的 Promise 什么时候会 reject？</h3>
<ul>
<li>fetch 的返回值是一个 <strong>Promise 对象</strong>；</li>
<li>该 Promise 仅在「网络故障」时才会 reject（如断网、跨域未配置 CORS、域名无法解析等）；</li>
<li>即使服务器返回 404、500 等 HTTP 错误状态码，Promise 仍会 resolve，此时需要通过 Response 对象的 <code>ok</code> 属性（true 表示 2xx 状态码）手动判断请求是否成功，并抛出错误。</li>
</ul>
<h3 data-id="heading-10">3.2 问题 2：如何用 Promise 处理 fetch 的错误（包括网络错误和 HTTP 错误）？</h3>
<p>核心答案：通过「手动判断 HTTP 状态码 + catch 捕获」的组合实现全量错误处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-comment">// 第一步：判断 HTTP 状态码，非 2xx 则抛出错误</span>
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP 错误：<span class="hljs-subst">${res.status}</span>`</span>);
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'成功'</span>, data))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-comment">// 捕获两类错误：网络错误 + 手动抛出的 HTTP 错误</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'失败'</span>, err);
  });
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-11">3.3 问题 3：fetch 相比 XMLHttpRequest，结合 Promise 有哪些优势？</h3>
<ol>
<li>代码更简洁：Promise 链式调用替代 XHR 的多层回调，避免回调地狱；</li>
<li>状态更可控：Promise 的状态不可逆特性，让异步流程更可预测；</li>
<li>原生适配：fetch 天生返回 Promise，无需手动封装，而 XHR 需要手动用 Promise 包裹才能实现链式调用；</li>
<li>功能更强大：支持 Promise 工具函数（如 Promise.all()）实现批量请求，轻松处理复杂异步场景。</li>
</ol>
<h3 data-id="heading-12">3.4 问题 4：如何用 Promise.race() 给 fetch 设置超时时间？</h3>
<p>创建一个超时 Promise（指定时间后 reject），与 fetch 的 Promise 进行 race 竞争，谁先改变状态就以谁的结果为准：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchWithTimeout</span>(<span class="hljs-params">url, timeout = <span class="hljs-number">3000</span></span>) {
  <span class="hljs-comment">// 超时 Promise</span>
  <span class="hljs-keyword">const</span> timeoutTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`超时 <span class="hljs-subst">${timeout}</span>ms`</span>)), timeout);
  });
  <span class="hljs-comment">// 竞争：fetch 成功/失败 或 超时</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">fetch</span>(url), timeoutTask]);
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_">fetchWithTimeout</span>(<span class="hljs-string">'/api/slowData'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'成功'</span>, data))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'失败'</span>, err));
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-13">3.5 问题 5：fetch 中如何实现请求中断？结合 Promise 怎么处理？</h3>
<p>fetch 本身不支持中断，但可通过 <strong>AbortController</strong> 与 Promise 结合实现：</p>
<pre><code class="hljs language-ini" lang="ini">// 1. 创建 AbortController 实例
const <span class="hljs-attr">controller</span> = new AbortController()<span class="hljs-comment">;</span>
// 2. 获取信号对象
const <span class="hljs-attr">signal</span> = controller.signal<span class="hljs-comment">;</span>

// 3. 发起 fetch 请求，将 signal 传入配置
fetch('/api/data', { signal })
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; console.log(<span class="hljs-string">'成功'</span>, data))
  .catch(<span class="hljs-attr">err</span> =&gt; {
    // 4. 中断时会触发 AbortError
    if (<span class="hljs-attr">err.name</span> === <span class="hljs-string">'AbortError'</span>) {
      console.log('请求已中断')<span class="hljs-comment">;</span>
      return<span class="hljs-comment">;</span>
    }
    console.error('其他错误', err)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

// 5. 主动中断请求（如用户点击取消按钮）
controller.abort()<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>原理：AbortController 的 signal 对象与 fetch 关联，调用 <code>abort()</code> 时，signal 会触发 abort 事件，fetch 会立即 reject 并抛出 AbortError。</p>
<h2 data-id="heading-14">四、总结</h2>
<p>fetch 与 Promise 的结合，核心是利用 Promise 的状态管理和链式调用特性，解决 fetch 异步请求的流程控制问题。日常开发中，需重点掌握响应解析、错误处理（尤其是 HTTP 错误）、批量请求、超时控制等场景；面试中，要牢记 fetch 的 Promise 状态规则、错误处理逻辑、与 XHR 的差异及请求中断方案等核心考点。</p>
<p>掌握二者的协同逻辑，不仅能提升异步代码的可读性和可维护性，更能在面试中快速精准地应对高频问题。建议结合实际场景多写多练，加深对 Promise 异步流转和 fetch 核心特性的理解。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter 确实不需要 hooks]]></title>    <link>https://juejin.cn/post/7587325326046412809</link>    <guid>https://juejin.cn/post/7587325326046412809</guid>    <pubDate>2025-12-25T04:37:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587325326046412809" data-draft-id="7587355990408970291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter 确实不需要 hooks"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-25T04:37:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="未来猫咪花"/> <meta itemprop="url" content="https://juejin.cn/user/1081575169340526"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter 确实不需要 hooks
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575169340526/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    未来猫咪花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T04:37:40.000Z" title="Thu Dec 25 2025 04:37:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前写过一篇文章:<a href="https://juejin.cn/post/7568527869187899435" target="_blank" title="https://juejin.cn/post/7568527869187899435">juejin.cn/post/756852…</a></p>
<p>最近有人在评论区指责我不懂 hooks、不懂 signals、不懂前端潮流。那篇文章中,我对 hooks 还保留了一些余地,认为某些场景下可能确实有其必要性。但直到我深入研究了 <code>flutter_hooks</code> 这个库的起源,我的想法发生了改变。</p>
<p>事情的起因是,该库作者在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F51752" target="_blank" title="https://github.com/flutter/flutter/issues/51752" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a> 中提出状态复用困难的问题,希望借鉴 React 的 hooks 模式来解决。但 Flutter 官方维护者并不认同 hooks 与状态复用之间存在必然联系,因此不打算提供官方支持。</p>
<p>尽管如此,作者在这几年里始终坚持自己的观点,创建了 <code>flutter_hooks</code> 库,将 React 的那套 API 完整地移植到了 Flutter 中。</p>
<p>我个人也反对将 hooks 引入 Flutter。如果问题是状态复用困难,难道 hooks 就是唯一的解决方案吗?显然不是。</p>
<p>我们完全可以借鉴 Android 的 <code>LifecycleObserver</code> 模式,将逻辑抽离出来实现最大化复用,达到与 hooks 相同甚至更好的效果。本质上,hooks 也是对生命周期的一种封装,只是它在封装生命周期之外还附加了许多额外功能。但这些额外功能与状态复用的核心问题关系不大,我认为这更像是为了使用 hooks 而强行引入 hooks。</p>
<p>具体实现代码 :<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flwj1994%2Fstate_lifecycle_observer" target="_blank" title="https://github.com/lwj1994/state_lifecycle_observer" ref="nofollow noopener noreferrer">github.com/lwj1994/sta…</a></p>
<h3 data-id="heading-0">使用文档</h3>
<h2 data-id="heading-1">Flutter State Observer</h2>
<p>使用 Observer 模式解决状态复用问题的 Flutter 包。</p>
<h3 data-id="heading-2">特性</h3>
<ul>
<li><strong>LifecycleObserver</strong>: 用于创建可复用状态观察者的基类。</li>
<li><strong>LifecycleObserverMixin</strong>: 用于在 <code>State</code> 中管理观察者生命周期的 mixin。</li>
<li><strong>常用观察者</strong>:
<ul>
<li><code>AnimControllerObserver</code>: 可复用的 <code>AnimationController</code> 逻辑。</li>
<li><code>ScrollControllerObserver</code>: 管理 <code>ScrollController</code>。</li>
<li><code>TabControllerObserver</code>: 管理 <code>TabController</code>。</li>
<li><code>TextEditingControllerObserver</code>: 管理 <code>TextEditingController</code>。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">用法</h3>
<h4 data-id="heading-4">自定义观察者</h4>
<p>你可以通过继承 <code>LifecycleObserver</code> 轻松创建自己的观察者。</p>
<p>示例：一个 <code>UserDataObserver</code>，它能够：</p>
<ol>
<li>在 <code>onInit</code> 中初始化数据获取。</li>
<li>在 <code>onUpdate</code> 中当 <code>userId</code> 变化时重新获取数据。</li>
<li>在 <code>onBuild</code> 中记录调试信息。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:state_lifecycle_observer/state_lifecycle_observer.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Data</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> info;
  Data(<span class="hljs-keyword">this</span>.id, <span class="hljs-keyword">this</span>.info);
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDataObserver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LifecycleObserver</span>&lt;<span class="hljs-title">ValueNotifier</span>&lt;<span class="hljs-title">Data</span>?&gt;&gt; </span>{
  <span class="hljs-comment">// 获取 Widget 最新参数的机制</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> <span class="hljs-built_in">Function</span>() getUserId;
  
  <span class="hljs-comment">// 用于追踪变化的内部状态</span>
  <span class="hljs-keyword">late</span> <span class="hljs-built_in">String</span> _currentUserId;

  UserDataObserver(
    <span class="hljs-keyword">super</span>.state, {
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.getUserId,
  });

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onInit() {
    target = ValueNotifier(<span class="hljs-keyword">null</span>);
    _currentUserId = getUserId();
    _fetchData(_currentUserId);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onUpdate() {
    <span class="hljs-comment">// 检查依赖 (userId) 是否发生变化</span>
    <span class="hljs-keyword">final</span> newUserId = getUserId();
    <span class="hljs-keyword">if</span> (newUserId != _currentUserId) {
      debugPrint(<span class="hljs-string">'UserId changed from <span class="hljs-subst">$_currentUserId</span> to <span class="hljs-subst">$newUserId</span>'</span>);
      _currentUserId = newUserId;
      _fetchData(_currentUserId);
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onBuild(BuildContext context) {
    debugPrint(<span class="hljs-string">'Building with user: <span class="hljs-subst">$_currentUserId</span>'</span>);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onDispose() {
    target.dispose();
  }

  <span class="hljs-keyword">void</span> _fetchData(<span class="hljs-built_in">String</span> id) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 模拟网络请求</span>
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">500</span>));
    <span class="hljs-keyword">if</span> (_currentUserId == id) { <span class="hljs-comment">// 避免竞态条件</span>
      target.value = Data(id, <span class="hljs-string">'Info for <span class="hljs-subst">$id</span>'</span>);
    }
  }
}
</code></pre>
<h3 data-id="heading-5">与 flutter_hooks 的比较</h3>








































<table><thead><tr><th align="left">特性</th><th align="left">state_lifecycle_observer</th><th align="left">flutter_hooks</th></tr></thead><tbody><tr><td align="left"><strong>范式</strong></td><td align="left">OOP (类)</td><td align="left">函数式 (Hooks)</td></tr><tr><td align="left"><strong>基类</strong></td><td align="left">标准 <code>StatefulWidget</code></td><td align="left"><code>HookWidget</code></td></tr><tr><td align="left"><strong>生命周期</strong></td><td align="left">显式 (<code>onInit</code>, <code>onDispose</code>)</td><td align="left">隐式 (<code>useEffect</code>)</td></tr><tr><td align="left"><strong>学习曲线</strong></td><td align="left">低 (标准 Flutter)</td><td align="left">中 (Hooks 规则)</td></tr><tr><td align="left"><strong>黑魔法</strong></td><td align="left">低 (Mixin + List)</td><td align="left">高 (Element 逻辑)</td></tr><tr><td align="left"><strong>条件逻辑</strong></td><td align="left">随处支持</td><td align="left">不允许在 <code>build</code> 中使用</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C Programming Language | Manipulating arrays in functions]]></title>    <link>https://juejin.cn/post/7587335187073253402</link>    <guid>https://juejin.cn/post/7587335187073253402</guid>    <pubDate>2025-12-25T03:38:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587335187073253402" data-draft-id="7587336857537904649" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C Programming Language | Manipulating arrays in functions"/> <meta itemprop="keywords" content="C语言"/> <meta itemprop="datePublished" content="2025-12-25T03:38:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="落贯一"/> <meta itemprop="url" content="https://juejin.cn/user/2306144643848090"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C Programming Language | Manipulating arrays in functions
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2306144643848090/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    落贯一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T03:38:01.000Z" title="Thu Dec 25 2025 03:38:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-comment">/*
1.编写一个函数，打印传入的数组中的所有元素。
	 
*/</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">printArr</span><span class="hljs-params">(<span class="hljs-type">int</span> arr[],<span class="hljs-type">int</span> len)</span>{
		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;len;i++){
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>,arr[i]);
		}
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
	<span class="hljs-comment">//int 类型的数组</span>
	<span class="hljs-type">int</span> arr1[<span class="hljs-number">5</span>]={<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>};
	<span class="hljs-type">int</span> arr2[<span class="hljs-number">3</span>]={<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>};

	printArr(arr1,<span class="hljs-number">5</span>); 
	printArr(arr2,<span class="hljs-number">3</span>); 
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
} 
<span class="hljs-comment">//函数中操作数组 </span>
<span class="hljs-comment">//printf("在函数中传入数组");</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2b970a7b90f4accbc901a6fa1bd419a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JC96LSv5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767238681&amp;x-signature=1CN0BKbDj842g%2BU1Jz1nP5NaIfU%3D" alt="image.png" loading="lazy"/></p>
<p>改变原地址</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">funArr</span><span class="hljs-params">(<span class="hljs-type">int</span> arr[])</span>{
    arr[<span class="hljs-number">0</span>]=<span class="hljs-number">100</span>;
    arr[<span class="hljs-number">1</span>]=<span class="hljs-number">200</span>;
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    <span class="hljs-comment">// int 类型的数组</span>
    <span class="hljs-type">int</span> arr[]={<span class="hljs-number">1</span>,<span class="hljs-number">2</span>};
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %d\n"</span>, arr[<span class="hljs-number">0</span>], arr[<span class="hljs-number">1</span>]);
    funArr(arr);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %d\n"</span>, arr[<span class="hljs-number">0</span>], arr[<span class="hljs-number">1</span>]);
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbf14222ce09480597097bfd32219de4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JC96LSv5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767238681&amp;x-signature=TITkx14JoYW6Wz0%2ByBYKA%2FNLdhU%3D" alt="image.png" loading="lazy"/></p>
<p>局部变量不改变</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">f</span><span class="hljs-params">(<span class="hljs-type">int</span> m)</span>{
    m += <span class="hljs-number">10</span>;
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    <span class="hljs-type">int</span> m = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"m=%d\n"</span>, m); <span class="hljs-comment">// 1</span>
    f(m);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"m=%d"</span>, m); <span class="hljs-comment">// 1</span>
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc04b1c68a414b499b2e0cada785c9ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JC96LSv5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767238681&amp;x-signature=yLvXaQBxw7%2BtJAcXeTsBnSVui0I%3D" alt="image.png" loading="lazy"/></p>
<p>任务1： 定义一个函数，它的参数是int数组，它的返回值是数组中的所有元素的和。
int getArrSum(int arr[], int len){</p>
<p>}</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">getArrSum</span><span class="hljs-params">(<span class="hljs-type">int</span> arr[], <span class="hljs-type">int</span> len)</span>{
    <span class="hljs-type">int</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt;len; i++){
        sum += arr[i];
    }
    <span class="hljs-keyword">return</span> sum;
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    <span class="hljs-type">int</span> arr[<span class="hljs-number">3</span>] = {<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>};
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>, getArrSum(arr, <span class="hljs-number">3</span>));
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3135a5e6a414f89bd41b842bbe91c87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JC96LSv5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767238681&amp;x-signature=0Km0rqk%2FoWQwD0Q4ypL5Ta8JKB4%3D" alt="image.png" loading="lazy"/>
任务2： 定义一个函数，它的参数是int数组，它的返回值是数组中的所有元素的最大值。
int getArrMax(int arr[], int len){
}</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">//任务2：获取数组中的最大值</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-type">int</span> <span class="hljs-title function_">getArrMax</span><span class="hljs-params">(<span class="hljs-type">int</span> arr[], <span class="hljs-type">int</span> len)</span> {
    <span class="hljs-comment">// 处理数组长度为0的异常情况</span>
    <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"数组长度无效！\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 或根据需求返回其他标识值</span>
    }
    <span class="hljs-comment">// 假设第一个元素为最大值</span>
    <span class="hljs-type">int</span> max = arr[<span class="hljs-number">0</span>];
    <span class="hljs-comment">// 遍历数组，从第二个元素开始比较</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; len; i++) {
        <span class="hljs-keyword">if</span> (arr[i] &gt; max) {
            max = arr[i]; <span class="hljs-comment">// 更新最大值</span>
        }
    }
    <span class="hljs-keyword">return</span> max;
}

<span class="hljs-comment">// 测试函数</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 测试用例1：普通数组</span>
    <span class="hljs-type">int</span> arr1[<span class="hljs-number">5</span>] = {<span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">9</span>, <span class="hljs-number">5</span>};
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"数组1的最大值：%d\n"</span>, getArrMax(arr1, <span class="hljs-number">5</span>)); <span class="hljs-comment">// 输出9</span>

    <span class="hljs-comment">// 测试用例2：包含负数的数组</span>
    <span class="hljs-type">int</span> arr2[<span class="hljs-number">4</span>] = {<span class="hljs-number">-5</span>, <span class="hljs-number">-2</span>, <span class="hljs-number">-8</span>, <span class="hljs-number">-1</span>};
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"数组2的最大值：%d\n"</span>, getArrMax(arr2, <span class="hljs-number">4</span>)); <span class="hljs-comment">// 输出-1</span>

    <span class="hljs-comment">// 测试用例3：单元素数组</span>
    <span class="hljs-type">int</span> arr3[<span class="hljs-number">1</span>] = {<span class="hljs-number">10</span>};
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"数组3的最大值：%d\n"</span>, getArrMax(arr3, <span class="hljs-number">1</span>)); <span class="hljs-comment">// 输出10</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77f49bdfd3374a3a8e738a0994ac95ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JC96LSv5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767238681&amp;x-signature=jFTVgBjYa4kQgD%2F5ILiYr%2BSMEYw%3D" alt="image.png" loading="lazy"/>
任务3： 定义一个函数，它的参数是int数组，和要查找的值。如果在这个数组中，能找到，则返回第一个找到的值的下标；
如果找不到，则返回-1
int findArrValue(int arr[], int len, int val) {
}</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-comment">// 任务3：查找数组中目标值的第一个下标，未找到返回-1</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">findArrValue</span><span class="hljs-params">(<span class="hljs-type">int</span> arr[], <span class="hljs-type">int</span> len, <span class="hljs-type">int</span> val)</span> {
    <span class="hljs-comment">// 处理数组长度无效的情况</span>
    <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"数组长度无效！\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    <span class="hljs-comment">// 遍历数组，逐个匹配目标值</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
        <span class="hljs-keyword">if</span> (arr[i] == val) {
            <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 找到目标值，返回当前下标</span>
        }
    }
    <span class="hljs-comment">// 遍历结束未找到，返回-1</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
}

<span class="hljs-comment">// 测试函数</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 测试用例1：目标值存在且出现多次</span>
    <span class="hljs-type">int</span> arr1[<span class="hljs-number">6</span>] = {<span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>};
    <span class="hljs-type">int</span> index1 = findArrValue(arr1, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>);
    <span class="hljs-keyword">if</span> (index1 != <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"目标值7的第一个下标：%d\n"</span>, index1); <span class="hljs-comment">// 输出1</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"未找到目标值7\n"</span>);
    }

    <span class="hljs-comment">// 测试用例2：目标值不存在</span>
    <span class="hljs-type">int</span> index2 = findArrValue(arr1, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">if</span> (index2 != <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"目标值10的第一个下标：%d\n"</span>, index2);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"未找到目标值10\n"</span>); <span class="hljs-comment">// 输出该语句</span>
    }

    <span class="hljs-comment">// 测试用例3：单元素数组且匹配</span>
    <span class="hljs-type">int</span> arr2[<span class="hljs-number">1</span>] = {<span class="hljs-number">5</span>};
    <span class="hljs-type">int</span> index3 = findArrValue(arr2, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>);
    <span class="hljs-keyword">if</span> (index3 != <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"目标值5的第一个下标：%d\n"</span>, index3); <span class="hljs-comment">// 输出0</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"未找到目标值5\n"</span>);
    }

    <span class="hljs-comment">// 测试用例4：空数组（长度为0）</span>
    <span class="hljs-type">int</span> arr3[<span class="hljs-number">0</span>];
    <span class="hljs-type">int</span> index4 = findArrValue(arr3, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">if</span> (index4 != <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"目标值2的第一个下标：%d\n"</span>, index4);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"未找到目标值2（数组为空）\n"</span>); <span class="hljs-comment">// 输出该语句</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c2a42cf50cf4647a5faedbc0695fd98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JC96LSv5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767238681&amp;x-signature=I%2B%2B12ideag%2BMqvyIF3sEGQQ4mU8%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code 效率翻倍指南:你可能错过的10个隐藏更新]]></title>    <link>https://juejin.cn/post/7587368168622669830</link>    <guid>https://juejin.cn/post/7587368168622669830</guid>    <pubDate>2025-12-25T04:34:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587368168622669830" data-draft-id="7587398857536749631" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code 效率翻倍指南:你可能错过的10个隐藏更新"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-25T04:34:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="和平hepingfly"/> <meta itemprop="url" content="https://juejin.cn/user/4100516930912747"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code 效率翻倍指南:你可能错过的10个隐藏更新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100516930912747/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    和平hepingfly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T04:34:31.000Z" title="Thu Dec 25 2025 04:34:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在用 Claude Code 写代码的时候，遇到了一些问题。比如：</p>
<p>1️⃣ 跟 Claude Code 聊天聊到一半，电脑重启之后，之前聊天的上下文都没有了。又得重新跟一个没有记忆的 Claude 从头开始聊。</p>
<p>2️⃣ Claude 用着用着幻觉严重，开始胡言乱语，不知道是不是上下文 token 用超了</p>
<p>3️⃣ 让 Claude 改一个代码，结果改错了，想要撤回，得花费一番功夫。</p>
<p>4️⃣ Claude 多开窗口之后，分不清哪个对话是哪个</p>
<p>好在最近 Claude Code 更新了一系列的功能，如果你也经常遇到类似的问题，看完这篇文章再去使用 Claude Code 或许能够提高成倍的效率。</p>
<h3 data-id="heading-0">1、退出对话之后，上下文都没有了咋整？用<code>--resume</code></h3>
<p>当你花了很长的时间跟 Claude 聊需求，好不容易聊顺了，建立了完整的上下文，准备开始写代码了。</p>
<p>这时候一不小心把窗口给关了，这时候，所有对话历史全部消失，难道又要从头开始吗？</p>
<p><strong>解决方案：</strong></p>
<p>命令:<code>claude --resume</code>  或者在 Claude 交互窗口，输入<code> /resume</code></p>
<p>这样会把所有的历史文化都给你显示出来，需要用哪个直接选择对应的会话，之前的上下文就会全都回来了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bcc59628cd94ff89b04f86f39d2f639~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=yGe4loV6n9kLUgu8G%2Fzlzm%2BsqSQ%3D" alt="img" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f243d431bae64fc8ad3a62ee4b0a1333~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=dG1ADvYuak6AdJXaIhE%2BLRc8fCc%3D" alt="img" loading="lazy"/></p>
<h3 data-id="heading-1">2、Claude 用着用着感觉幻觉严重，回答的牛头不对马嘴。用<code> /context</code></h3>
<p>在你指挥 Claude 写代码，写了一段时间之后，你发现他开始瞎改代码，出现明显的幻觉。</p>
<p>这时候你就要看一下你的上下文窗口是不是被塞满了。</p>
<p><strong>解决方案：</strong></p>
<p>在 Claude 交互窗口，输入<code>/context</code></p>
<p>这个命令可以用可视化的方式显示上下文占用情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50565d732fbe453d8ae9e2c777040399~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=NM%2B%2FSEKTiKzfHT85ko5XREYdGgk%3D" alt="img" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f5a6d4d09034e8584ff1e5c5c95563b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=Qq98yKb9S041QU%2B8gm9pBQNgXYg%3D" alt="img" loading="lazy"/></p>
<p>如果是历史消息占用的token过多就可以使用 <code>/clear</code> 去清理。</p>
<p>如果是系统提示词太大，就要去看一下是不是Claude 规则写太多了。</p>
<p>如果是MCP工具占用的 token 太多了，就需要先卸载一部分不常用的MCP工具。</p>
<h3 data-id="heading-2">3、不知道 token 用了多少? 用<code> /stats</code></h3>
<p>当你在疯狂用 Claude Code 开发的时候，想要看一下用了多少token 的时候。</p>
<p><strong>解决方案：</strong></p>
<p>在 Claude 交互窗口，输入<code>/stats</code></p>
<p>这条命令可以让你看到所有的使用数据，包括 token、连续天数、活跃时段、使用的模型</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c63be2f7a98f4278930b1555f822b9e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=sxuxwp%2Bv4C4PwR%2FTd%2BVsrd4Xn14%3D" alt="img" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8956bd6c87bf49179ae1c7a332a0033b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=UjxUJ3tThkVKbrnAswxST1K9%2BMI%3D" alt="img" loading="lazy"/></p>
<p>看到这里可以在评论区晒一下你的模型和 token 的使用数据，哈哈哈😄</p>
<h3 data-id="heading-3">4、Claude 同时开多个窗口来回切？用 <code>/rename</code></h3>
<p>如果你同时开多个 Claude 窗口，时间长了可能就分不清哪个对哪个了。下次再<code> /resume</code>  看到一堆系统默认的命名也完全不知道哪个是哪个。</p>
<p><strong>解决方案：</strong></p>
<p>在 Claude 交互窗口，输入<code>/rename 会话名字 </code></p>
<p>这个命令会给你当前的会话起一个有意义的名字，让你下次一眼就能找到这个会话。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6253b9dc1ffd45bbb41580b91353ada6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=t9llZd%2BeArILgb94I%2BIZdzabUmk%3D" alt="img" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55b8926c5a1147ea853e7c08258caacd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=kZSEsU2P1PPnTZRckY8L6rtKueI%3D" alt="img" loading="lazy"/></p>
<p><strong>命名规则：</strong></p>
<p>可以根据你自己的喜好。 或者使用， <strong>项目名-功能模块</strong></p>
<p>例如：</p>
<ul>
<li>学生管理系统-查询学生</li>
<li>学生管理系统-删除学生</li>
</ul>
<p><strong>配合使用：</strong></p>
<ol>
<li>新项目开始时，先 <code>/rename</code> 命名</li>
<li>每天 resume 时，一眼找到对应会话</li>
<li>多开几个终端，同时推进不同功能</li>
</ol>
<h3 data-id="heading-4">5、代码改坏了，想撤回更改？ 双击 ESC 键</h3>
<p>当你指挥 Claude 修改某一个功能的时候，Claude 一不小心把这个功能给改坏了，怎么办呢？</p>
<p>这时候你肯定想撤回修改。</p>
<p><strong>解决方案：</strong></p>
<p>双击 <code>ESC</code> 键</p>
<p>这个操作会显示历史节点，你可以选择回到哪一步。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/130b41efda35487ea3f2738b65e71765~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=4vtSSn4IRGg4l3uXN0bIjSPUKI0%3D" alt="img" loading="lazy"/></p>
<p>假如我对这一次的操作不满意，我想回到上一步。那这时候我就可以双击 ESC键。</p>
<p>它就会显示你之前操作的历史节点，你可以选择回到哪一个节点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aaf821f1d51d4dd6805b74d2a60c7271~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=9FdSnMoefXMpxhx%2BORig0LJVNAI%3D" alt="img" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d2535ca53104c4fa89239e712749383~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=9OxC07poi0UvnUZZtZcy3ZQ9Q48%3D" alt="img" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77e124ef013e4849a4d03777dc030006~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=MhGJ1mCtQNbHk1cCvnBdKwRxGw0%3D" alt="img" loading="lazy"/></p>
<p>有了这个功能之后，有任何想法，你就可以直接让 Claude 上手去改。改错了没关系，直接双击ESC，选恢复代码和对话，立刻回到之前的状态，零成本试错</p>
<h3 data-id="heading-5">6、针对复杂任务，加 UltraThink ，质量立马飞升</h3>
<p>比如你让 Claude 设计一个复杂的日历组件，但是第一版出来的结果很普通，不够精致。你想要的是那种能直接放进产品的质量。</p>
<p><strong>解决方案：</strong></p>
<p>在提示词里加一个词：UltraThink</p>
<p>这样 Claude 会花更多时间思考，给出更好的方案（它甚至会变成彩虹色）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b46ca289449347da9725da8068e87c73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=F1KEMj4WFhM97mzC6RIZwVa80hI%3D" alt="img" loading="lazy"/></p>
<p><strong>什么时候用：</strong></p>
<ul>
<li>复杂的架构设计</li>
<li>需要精致的 UI 组件</li>
<li>困难的 Bug 调试</li>
</ul>
<p><strong>什么时候不用：</strong></p>
<ul>
<li>简单的增删改查</li>
<li>改个文案/颜色</li>
<li>日常小调整</li>
</ul>
<p>因为 UltraThink 会消耗更多 token 和时间</p>
<h3 data-id="heading-6">7、无条件信任 Claude ，开启 YOLO 模式</h3>
<p>当你给 Claude 一个长期任务，比如：重构整个认证系统,加上单元测试。</p>
<p>然后你会发现你需要不停地点，接受 → 接受 → 接受 ，需要一直守着点确认。</p>
<p><strong>解决方案：</strong></p>
<p>命令:<code>claude --dangerously-skip-permissions</code></p>
<p>这样 Claude 就不会再问你要权限，直接执行</p>
<p><strong>这个功能适合：</strong></p>
<ul>
<li>对 Claude Code 非常熟悉的人</li>
<li>给的是清晰、明确的任务</li>
<li>有完整的 Git 版本控制</li>
</ul>
<p><strong>这个功能不适合：</strong></p>
<ul>
<li>刚开始用 Claude Code 的新手</li>
<li>在生产环境直接操作</li>
<li>任务描述模糊不清</li>
</ul>
<p>当你开启 YOLO 模式的时候，你会发现他能够帮你节省50%的时间。</p>
<h3 data-id="heading-7">8、一键安装神器，<code>/plugins </code>插件商店</h3>
<p>假如你想用 Claude 操作 GitHub、Figma、Notion ，但不知道怎么配置 MCP 服务器。网上教程又长又复杂。</p>
<p><strong>解决方案：</strong></p>
<p>命令:<code>/plugins</code></p>
<p>它可以一键帮你安装各种 skill 和 MCP。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfd55d64543c4fb2b5c375c69970e5d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=GVdBRVBTtLBSuFJHJErLxw8xzOc%3D" alt="img" loading="lazy"/></p>
<h3 data-id="heading-8">9、提示词写一半，想起来要先修个 bug ？用<code>Ctrl+S</code>暂存起来</h3>
<p>当你写了很长一大串的提示词，写到一半，突然想起还有个 Bug 要先修。</p>
<p>然后你就一直按住 Backspace ，把刚才辛苦写的提示词全部都删了，先修这个 bug，修完之后又重新写刚才的提示词。</p>
<p><strong>解决方案：</strong></p>
<p>快捷键:<code>Ctrl+S</code></p>
<p>它可以暂存你当前的提示词，等你处理完其他事情后自动恢复。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12898fa5da0d41df9ed3c1ebfb0abd0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=jKtsb%2FuIAb5vgjp0svjFDSAnZ6o%3D" alt="img" loading="lazy"/></p>
<p>假如现在我输了一大段的提示词，但是突然发现我需要先修一个bug。</p>
<p>按照以往，我只能先把这段提示词给删了。但是现在你可以使用快捷键 <code>Ctrl+S</code>，把这段提示词给暂存。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7605d07286e045a0b51f9bef087950e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=%2BSkCv%2Bmv%2FyUHZkjea9lc6sAYXdk%3D" alt="img" loading="lazy"/></p>
<p>此时这个窗口你就可以用来先去修bug。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5397897eff22408f8ea59704e462eb26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=B15kz4kzlvwkyZv7eYzgkXRgVIQ%3D" alt="img" loading="lazy"/></p>
<p>当我回车提交这个命令之后，上面暂存的提示词会自动回到对话窗口。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf5ede8bb54a460d84f75983d3acfb26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=NfIotzHyqamARU5KowM5c%2Ftf8rU%3D" alt="img" loading="lazy"/></p>
<p><strong>什么时候用：</strong></p>
<ul>
<li>写长提示词时突然想起其他事</li>
<li>需要先查看某个文件再继续</li>
<li>临时被打断但不想丢失思路</li>
</ul>
<h3 data-id="heading-9">10、想导出完整聊天记录？用<code> /export</code></h3>
<p>当你和 Claude 聊了一轮又一轮，积累了非常多有价值的上下文，想要把这个上下文保存下来，方便下次使用。</p>
<p><strong>解决方案：</strong></p>
<p>命令: <code>/export 文件名</code></p>
<p>这个命令会帮你把整个对话以 Markdown 格式转储，包括每一个提示、每一条回复以及每一次工具调用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37759addc7694d0da09a37904a04af1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=v2jauD236eHeVk1HOzxvWRZUA1Q%3D" alt="img" loading="lazy"/></p>
<p>然后在你的项目目录下就可以看到这份聊天记录</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/895d4c58979b4c8e9ede17acdf243a8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767242071&amp;x-signature=hGeIGvGHosbjGrGj1Ik967%2FYUA4%3D" alt="img" loading="lazy"/></p>
<p>以上这些命令，大家都用过几个？哪个命令你平常用的最多？可以聊一聊</p>
<p>最后，觉得有收获的话，可以点个关注，会持续分享干货内容🫶</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型原理剖析——矩阵吸收优化：LLM推理加速的核心原理与实践]]></title>    <link>https://juejin.cn/post/7587343333329256482</link>    <guid>https://juejin.cn/post/7587343333329256482</guid>    <pubDate>2025-12-25T05:41:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587343333329256482" data-draft-id="7587342664078016527" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型原理剖析——矩阵吸收优化：LLM推理加速的核心原理与实践"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-25T05:41:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾醒"/> <meta itemprop="url" content="https://juejin.cn/user/708512558088669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型原理剖析——矩阵吸收优化：LLM推理加速的核心原理与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/708512558088669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T05:41:10.000Z" title="Thu Dec 25 2025 05:41:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>矩阵吸收优化是针对Transformer架构大语言模型（LLM）的<strong>无精度损失推理加速技术</strong>，核心通过利用矩阵乘法结合律和模型参数的固定性，将冗余的在线矩阵乘法提前离线预计算，从而减少推理时的计算量、降低延迟。该技术尤其适用于自注意力机制的计算瓶颈优化，在不改变模型输出结果的前提下，可实现约1.7倍的推理速度提升，是LLM本地化部署、高并发API服务等场景的关键优化手段之一。</p>
<h2 data-id="heading-1">先明确核心背景：Transformer自注意力的标准计算流程</h2>
<p>要理解矩阵吸收优化的价值，需先回顾Transformer自注意力机制的核心计算步骤。假设模型输入序列经过词嵌入+位置编码后得到特征矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></span>（维度：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>×</mo><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">L×d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">L</span></span></span></span></span> 为序列长度，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>为模型隐藏层维度），自注意力的标准计算逻辑如下：</p>
<h3 data-id="heading-2">1. 核心符号定义</h3>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>q</mi></msub><mo separator="true">,</mo><msub><mi>C</mi><mi>k</mi></msub><mo separator="true">,</mo><msub><mi>C</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">C_q, C_k, C_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：输入特征 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></span>分别对应查询（Query）、键（Key）、值（Value）的输入特征（实际中通常是同一 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></span> 经过不同线性层投影，此处分开表示更清晰）；</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_q^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2244em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_k^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>v</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_v^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0883em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span>：查询、键、值的<strong>上投影矩阵</strong>（模型预训练好的固定参数，维度：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_{model}×d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 为注意力头的维度，满足 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mi mathvariant="normal">/</mi><mi>n</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_k = d_{model} / num_{heads}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>)；</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：注意力头维度，用于缩放注意力分数（避免数值过大）。</li>
</ul>
<h3 data-id="heading-3">2. 标准自注意力计算步骤（3次矩阵乘法）</h3>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mn>1.</mn><mtext>投影计算： </mtext><mi>Q</mi><mo>=</mo><msub><mi>C</mi><mi>q</mi></msub><mo>⋅</mo><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup><mo separator="true">,</mo><mtext> </mtext><mi>K</mi><mo>=</mo><msub><mi>C</mi><mi>k</mi></msub><mo>⋅</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup><mo separator="true">,</mo><mtext> </mtext><mi>V</mi><mo>=</mo><msub><mi>C</mi><mi>v</mi></msub><mo>⋅</mo><msubsup><mi>W</mi><mi>v</mi><mi>U</mi></msubsup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mn>2.</mn><mtext>注意力分数计算： </mtext><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><mo>⋅</mo><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mn>3.</mn><mtext>输出计算： </mtext><mi>O</mi><mi>u</mi><mi>t</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo>=</mo><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>⋅</mo><mi>V</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
&amp;1. \text{投影计算：} \ Q = C_q \cdot W_q^U, \ K = C_k \cdot W_k^U, \ V = C_v \cdot W_v^U \\
&amp;2. \text{注意力分数计算：} \ Attention = softmax\left( \frac{Q \cdot K^T}{\sqrt{d_k}} \right) \\
&amp;3. \text{输出计算：} \ Output = Attention \cdot V
\end{align*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.8428em;vertical-align:-2.6714em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.1714em;"><span style="top:-5.7984em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"/></span><span style="top:-3.597em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"/></span><span style="top:-1.5069em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.6714em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.1714em;"><span style="top:-5.7984em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mord">1.</span><span class="mord text"><span class="mord cjk_fallback">投影计算：</span></span><span class="mspace"> </span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span><span style="top:-3.597em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mord">2.</span><span class="mord text"><span class="mord cjk_fallback">注意力分数计算：</span></span><span class="mspace"> </span><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span><span style="top:-1.5069em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mord">3.</span><span class="mord text"><span class="mord cjk_fallback">输出计算：</span></span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal">u</span><span class="mord mathnormal">tp</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.6714em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p><strong>关键瓶颈</strong>：步骤1中需同时计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> 的投影（2次独立的矩阵乘法），步骤2中还需计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo separator="true">⋅</mo><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">Q·K^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span>，当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">L</span></span></span></span></span>（序列长度）或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（隐藏层维度）较大时（如LLM中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>=</mo><mn>2048</mn><mi mathvariant="normal">/</mi><mn>4096</mn></mrow><annotation encoding="application/x-tex">d_{model}=2048/4096</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">2048/4096</span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>2048</mn></mrow><annotation encoding="application/x-tex">L=2048</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2048</span></span></span></span></span>），这三步的矩阵乘法会占据推理时的主要计算开销和内存访问成本。</p>
<h2 data-id="heading-4">矩阵吸收优化的核心逻辑：预乘投影矩阵，省去在线计算</h2>
<p>矩阵吸收优化的核心灵感来自两个关键点：</p>
<ol>
<li><strong>矩阵乘法结合律</strong>：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">⋅</mo><mi>B</mi><mo stretchy="false">)</mo><mo separator="true">⋅</mo><mi>C</mi><mo>=</mo><mi>A</mi><mo separator="true">⋅</mo><mo stretchy="false">(</mo><mi>B</mi><mo separator="true">⋅</mo><mi>C</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(A·B)·C = A·(B·C)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span></span>，允许调整计算顺序；</li>
<li><strong>投影矩阵固定性</strong>：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_q^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2244em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_k^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span> 是模型预训练好的参数，推理时完全不变，可<strong>离线预计算</strong>其组合结果，无需在线实时计算。</li>
</ol>
<h3 data-id="heading-5">1. 优化核心：预计算合并投影矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></h3>
<p>将查询投影矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_q^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2244em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span></span></span></span></span> 与键投影矩阵的转置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">(W_k^U)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 提前离线相乘，得到合并后的投影矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub><mo>=</mo><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup><mo>⋅</mo><mo stretchy="false">(</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">W_{qk} = W_q^U \cdot (W_k^U)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2744em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span></div>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 维度：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>×</mo><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_{model}×d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（因 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_q^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2244em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span></span></span></span></span>是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_{model}×d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">(W_k^U)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>×</mo><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_k×d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，乘积后为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>×</mo><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_{model}×d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）；</li>
<li>预计算时机：模型加载前、部署打包时（仅需计算一次，后续推理直接复用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>）。</li>
</ul>
<h3 data-id="heading-6">2. 优化后的自注意力计算步骤（2次矩阵乘法）</h3>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mn>1.</mn><mtext>简化投影计算： </mtext><msup><mi>Q</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><msub><mi>C</mi><mi>q</mi></msub><mo>⋅</mo><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub><mo separator="true">,</mo><mtext> </mtext><mi>V</mi><mo>=</mo><msub><mi>C</mi><mi>v</mi></msub><mo>⋅</mo><msubsup><mi>W</mi><mi>v</mi><mi>U</mi></msubsup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mn>2.</mn><mtext>注意力分数计算： </mtext><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mrow><mo fence="true">(</mo><mfrac><mrow><msup><mi>Q</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>⋅</mo><msubsup><mi>C</mi><mi>k</mi><mi>T</mi></msubsup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mn>3.</mn><mtext>输出计算： </mtext><mi>O</mi><mi>u</mi><mi>t</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo>=</mo><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>⋅</mo><mi>V</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
&amp;1. \text{简化投影计算：} \ Q' = C_q \cdot W_{qk}, \ V = C_v \cdot W_v^U \\
&amp;2. \text{注意力分数计算：} \ Attention = softmax\left( \frac{Q' \cdot C_k^T}{\sqrt{d_k}} \right) \\
&amp;3. \text{输出计算：} \ Output = Attention \cdot V
\end{align*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.8197em;vertical-align:-2.6598em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.1598em;"><span style="top:-5.7868em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"/></span><span style="top:-3.6085em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"/></span><span style="top:-1.5185em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.6598em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.1598em;"><span style="top:-5.7868em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mord">1.</span><span class="mord text"><span class="mord cjk_fallback">简化投影计算：</span></span><span class="mspace"> </span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span><span style="top:-3.6085em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mord">2.</span><span class="mord text"><span class="mord cjk_fallback">注意力分数计算：</span></span><span class="mspace"> </span><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span><span style="top:-1.5185em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mord">3.</span><span class="mord text"><span class="mord cjk_fallback">输出计算：</span></span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal">u</span><span class="mord mathnormal">tp</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.6598em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<h3 data-id="heading-7">3. 优化前后对比：减少1次关键矩阵乘法</h3>





























<table><thead><tr><th>阶段</th><th>标准计算</th><th>矩阵吸收优化</th><th>核心差异</th></tr></thead><tbody><tr><td>投影阶段</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>=</mo><msub><mi>C</mi><mi>q</mi></msub><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">Q = C_q·W_q^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2244em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span></span></span></span></span>（1次）+ <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><msub><mi>C</mi><mi>k</mi></msub><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">K = C_k·W_k^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span>（1次）</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><msub><mi>C</mi><mi>q</mi></msub><mo separator="true">⋅</mo><msub><mi>W</mi><mi>q</mi></msub><mi>k</mi></mrow><annotation encoding="application/x-tex">Q' = C_q·W_qk</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>（1次）</td><td>省去 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><msub><mi>C</mi><mi>k</mi></msub><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">K = C_k·W_k^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span> 的在线计算</td></tr><tr><td>注意力分数阶段</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo separator="true">⋅</mo><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">Q·K^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span>（1次）</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo separator="true">⋅</mo><msubsup><mi>C</mi><mi>k</mi><mi>T</mi></msubsup></mrow><annotation encoding="application/x-tex">Q'·C_k^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span>（1次）</td><td>用预计算的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub><mi>k</mi></mrow><annotation encoding="application/x-tex">W_qk</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>替代 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup><mo separator="true">⋅</mo><mo stretchy="false">(</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">W_q^U·(W_k^U)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2244em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span></td></tr><tr><td>总在线矩阵乘法次数</td><td>3次</td><td>2次</td><td>减少1次高开销的投影矩阵乘法</td></tr></tbody></table>
<p><strong>关键结论</strong>：优化后省去的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><msub><mi>C</mi><mi>k</mi></msub><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">K = C_k·W_k^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span> 是高开销计算——<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">C_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 维度为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>×</mo><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">L×d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_k^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span> 为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>m</mi></msub><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_model×d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，该乘法的时间复杂度为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>L</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>m</mi></msub><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(L·d_model·d_k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">L</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，占标准自注意力计算总耗时的30%~40%（尤其当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 较大时），这是实现1.7倍加速的核心原因。</p>
<h2 data-id="heading-8">加速比背后的计算复杂度分析</h2>
<p>要理解为何能实现约1.7倍加速，需从<strong>时间复杂度</strong>和<strong>实际硬件执行效率</strong>两方面分析：</p>
<h3 data-id="heading-9">1. 时间复杂度量化对比</h3>
<p>假设：序列长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>2048</mn></mrow><annotation encoding="application/x-tex">L=2048</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2048</span></span></span></span></span>，隐藏层维度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>=</mo><mn>2048</mn></mrow><annotation encoding="application/x-tex">d_{model}=2048</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2048</span></span></span></span></span>，注意力头维度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><mn>64</mn></mrow><annotation encoding="application/x-tex">d_k=64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">64</span></span></span></span></span>（对应32个注意力头），忽略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">softmax</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span></span></span></span></span> 和小常数项，仅计算矩阵乘法的浮点运算次数（FLOPs）：</p>
<ul>
<li>标准计算：每个头的 <code>Q/K</code> 投影FLOPs为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">L·d_k·d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord mathnormal">L</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（因每个头的输入特征维度是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mi mathvariant="normal">/</mi><mi>n</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>s</mi></mrow></msub><mo>=</mo><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_{model}/num_{heads} = d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>），<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">num_{heads}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 个头的总FLOPs为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>s</mi></mrow></msub><mo>×</mo><mo stretchy="false">(</mo><mi>L</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub><mo>+</mo><mi>L</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mn>2</mn><mo>×</mo><mi>n</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>s</mi></mrow></msub><mo>×</mo><mi>L</mi><mo>×</mo><msubsup><mi>d</mi><mi>k</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">num_{heads} × (L·d_k·d_k + L·d_k·d_k) = 2×num_{heads}×L×d_k²</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">L</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0972em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4169em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span>；</li>
<li>矩阵吸收优化：每个头的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k×d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（按头拆分后），<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><msub><mi>C</mi><mi>q</mi></msub><mo separator="true">⋅</mo><msub><mi>W</mi><mi>q</mi></msub><mi>k</mi></mrow><annotation encoding="application/x-tex">Q'=C_q·W_qk</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 的FLOPs为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>s</mi></mrow></msub><mo>×</mo><mi>L</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">num_{heads} × L·d_k·d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord mathnormal">L</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，省去了 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>s</mi></mrow></msub><mo>×</mo><mi>L</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub><mo separator="true">⋅</mo><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">num_{heads} × L·d_k·d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord mathnormal">L</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的K投影FLOPs。</li>
</ul>
<p>当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>h</mi><mi>e</mi><mi>a</mi><mi>d</mi><mi>s</mi></mrow></msub><mo>=</mo><mn>32</mn></mrow><annotation encoding="application/x-tex">num_{heads}=32</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">32</span></span></span></span></span>，L=2048，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><mn>64</mn></mrow><annotation encoding="application/x-tex">d_k=64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">64</span></span></span></span></span> 时：</p>
<ul>
<li>标准计算投影FLOPs：<code>2×32×2048×64² ≈ 5.3e9</code>；</li>
<li>优化后投影FLOPs：<code>32×2048×64² ≈ 2.65e9</code>；</li>
<li>仅投影阶段就节省了50%的FLOPs，再加上注意力分数计算的内存访问优化（无需存储 <code>K</code> 矩阵，减少内存带宽占用），综合下来实现1.7倍左右的端到端加速（实际加速比受硬件类型、序列长度、模型维度影响，通常在1.5~2倍之间）。</li>
</ul>
<h3 data-id="heading-10">2. 硬件执行效率提升</h3>
<p>除了减少FLOPs，矩阵吸收优化还能提升<strong>内存访问效率</strong>：</p>
<ul>
<li>标准计算需存储 <code>Q</code>、<code>K</code>、<code>V</code> 三个矩阵，优化后仅需存储 <code>Q'</code> 和 <code>V</code>，减少了 <code>K</code> 矩阵的内存占用（尤其是长序列场景，<code>K</code> 矩阵的存储开销显著）；</li>
<li>内存访问延迟是LLM推理的重要瓶颈（尤其是GPU显存带宽、CPU内存带宽受限场景），减少内存占用可降低缓存命中失败率，进一步提升实际执行速度。</li>
</ul>
<h2 data-id="heading-11">矩阵吸收优化的关键特性与适用场景</h2>
<h3 data-id="heading-12">1. 核心优势</h3>
<ul>
<li><strong>无精度损失</strong>：仅调整矩阵乘法顺序，数值计算完全等价于标准自注意力，不影响模型输出质量（无需重新训练或微调）；</li>
<li><strong>实现成本极低</strong>：无需修改模型结构，仅需在推理前预计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>，并调整推理时的计算逻辑（替换 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo separator="true">⋅</mo><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">Q·K^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo separator="true">⋅</mo><msubsup><mi>C</mi><mi>k</mi><mi>T</mi></msubsup></mrow><annotation encoding="application/x-tex">Q'·C_k^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span>）；</li>
<li><strong>兼容性强</strong>：可与量化（INT8/INT4）、稀疏化、FlashAttention、TensorRT等其他推理加速技术叠加使用（例如：预计算的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 可直接进行INT8量化，进一步降低计算开销）；</li>
<li><strong>普适性高</strong>：适用于所有基于Transformer自注意力的LLM（如GPT系列、Llama系列、ChatGLM系列等），无论是解码器架构（Decoder-only）还是编码器-解码器架构（Encoder-Decoder）。</li>
</ul>
<h3 data-id="heading-13">2. 适用场景</h3>
<ul>
<li><strong>长序列推理</strong>：序列长度 L越大，K 矩阵的投影和存储开销越显著，优化效果越明显（如文档摘要、代码生成等长文本场景）；</li>
<li><strong>高并发部署</strong>：API服务、本地化部署等对延迟敏感的场景，可通过减少计算量提升并发处理能力（相同硬件资源下支持更多请求）；</li>
<li><strong>资源受限设备</strong>：CPU部署、边缘设备（如 Jetson 系列）等算力/内存有限的场景，可在不牺牲精度的前提下降低硬件门槛。</li>
</ul>
<h3 data-id="heading-14">3. 局限性</h3>
<ul>
<li>仅适用于<strong>推理阶段</strong>：训练阶段 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_q^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2244em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_k^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span> 是动态更新的，无法预计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>，因此不适用；</li>
<li>对短序列加速效果有限：当 L 极小时（如 L&lt;128），K 矩阵的投影开销占比低，加速比可能降至1.2倍以下。</li>
</ul>
<h2 data-id="heading-15">工程实现步骤（以PyTorch为例）</h2>
<p>矩阵吸收优化的工程实现非常简洁，核心分为“预计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>”和“修改推理逻辑”两步：</p>
<h3 data-id="heading-16">1. 步骤1：预计算合并投影矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></h3>
<p>加载预训练模型后，提取 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_q^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2244em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_k^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span>，离线计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 并替换原投影矩阵（以Llama系列模型为例）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LlamaAttentionWithAbsorption</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, original_attention</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.original_attention = original_attention
        self.d_model = original_attention.hidden_size
        self.num_heads = original_attention.num_attention_heads
        self.d_k = self.d_model // self.num_heads
        
        <span class="hljs-comment"># 提取原始投影矩阵（Llama的attention权重通常在self.q_proj、self.k_proj、self.v_proj）</span>
        self.W_q_U = original_attention.q_proj.weight  <span class="hljs-comment"># 维度：d_model × d_model（实际是num_heads×d_k × d_model，需按头拆分）</span>
        self.W_k_U = original_attention.k_proj.weight  <span class="hljs-comment"># 维度：d_model × d_model</span>
        self.W_v_U = original_attention.v_proj.weight  <span class="hljs-comment"># 维度：d_model × d_model</span>
        
        <span class="hljs-comment"># 按注意力头拆分投影矩阵（num_heads × d_k × d_model）</span>
        self.W_q_U_per_head = self.W_q_U.view(self.num_heads, self.d_k, self.d_model)
        self.W_k_U_per_head = self.W_k_U.view(self.num_heads, self.d_k, self.d_model)
        
        <span class="hljs-comment"># 预计算每个头的 W_qk = W_q_U · (W_k_U)^T（维度：num_heads × d_k × d_k）</span>
        self.W_qk_per_head = torch.matmul(
            self.W_q_U_per_head,  <span class="hljs-comment"># (num_heads, d_k, d_model)</span>
            self.W_k_U_per_head.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment"># (num_heads, d_model, d_k)</span>
        )
        
        <span class="hljs-comment"># 合并为一个矩阵（方便批量计算：num_heads×d_k × d_k）</span>
        self.W_qk = self.W_qk_per_head.view(self.num_heads * self.d_k, self.d_k)
        
        <span class="hljs-comment"># 保留V的投影矩阵</span>
        self.W_v = self.W_v_U.view(self.num_heads, self.d_k, self.d_model)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, hidden_states</span>):
        L, B, d_model = hidden_states.shape  <span class="hljs-comment"># 输入维度：(序列长度L, 批次大小B, 隐藏层维度d_model)</span>
        num_heads, d_k = self.num_heads, self.d_k
        
        <span class="hljs-comment"># 1. 计算Q' = C_q · W_qk（替代原Q = C_q·W_q_U 和 K = C_k·W_k_U）</span>
        <span class="hljs-comment"># 输入reshape：(L, B, d_model) → (B, L, d_model)</span>
        hidden_states = hidden_states.transpose(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># Q'计算：(B, L, d_model) × (num_heads×d_k, d_k) → (B, L, num_heads×d_k)</span>
        q_prime = torch.matmul(hidden_states, self.W_qk.t())  <span class="hljs-comment"># W_qk是(num_heads×d_k, d_k)，转置后是(d_k, num_heads×d_k)？修正：</span>
        q_prime = torch.matmul(hidden_states, self.W_qk.permute(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>))  <span class="hljs-comment"># 正确维度匹配：(B,L,d_model) × (d_model, num_heads×d_k) → (B,L,num_heads×d_k)</span>
        
        <span class="hljs-comment"># 按头拆分Q'：(B, L, num_heads, d_k) → (B, num_heads, L, d_k)</span>
        q_prime = q_prime.view(B, L, num_heads, d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        
        <span class="hljs-comment"># 2. 计算C_k^T（输入特征的转置）：(B, d_model, L)</span>
        C_k_T = hidden_states.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        
        <span class="hljs-comment"># 3. 注意力分数计算：Q' · C_k^T → (B, num_heads, L, L)</span>
        attention_scores = torch.matmul(q_prime, C_k_T)  <span class="hljs-comment"># (B, num_heads, L, d_k) × (B, d_model, L) → 不对，需按头处理C_k：</span>
        <span class="hljs-comment"># 修正：C_k按头拆分并转置：(B, d_model, L) → (B, num_heads, d_k, L)</span>
        C_k_per_head_T = hidden_states.view(B, L, num_heads, d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).transpose(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)  <span class="hljs-comment"># (B, num_heads, d_k, L)</span>
        attention_scores = torch.matmul(q_prime, C_k_per_head_T)  <span class="hljs-comment"># (B, num_heads, L, d_k) × (B, num_heads, d_k, L) → (B, num_heads, L, L)</span>
        
        <span class="hljs-comment"># 缩放注意力分数</span>
        attention_scores = attention_scores / math.sqrt(d_k)
        
        <span class="hljs-comment"># 4. softmax计算注意力权重</span>
        attention_weights = F.softmax(attention_scores, dim=-<span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># 5. 计算V = C_v · W_v_U</span>
        v = torch.matmul(hidden_states, self.W_v.permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>).reshape(d_model, num_heads*d_k).t())  <span class="hljs-comment"># (B, L, num_heads×d_k)</span>
        v = v.view(B, L, num_heads, d_k).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment"># (B, num_heads, L, d_k)</span>
        
        <span class="hljs-comment"># 6. 输出计算：Attention · V → (B, num_heads, L, d_k)</span>
        output = torch.matmul(attention_weights, v)
        
        <span class="hljs-comment"># 合并注意力头：(B, num_heads, L, d_k) → (B, L, num_heads×d_k) → (B, L, d_model)</span>
        output = output.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous().view(B, L, d_model)
        
        <span class="hljs-comment"># 还原为原始输出维度：(L, B, d_model)</span>
        <span class="hljs-keyword">return</span> output.transpose(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
</code></pre>
<h3 data-id="heading-17">2. 步骤2：替换模型的注意力层并部署</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 加载原始Llama模型</span>
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> LlamaForCausalLM, LlamaTokenizer
model_name = <span class="hljs-string">"meta-llama/Llama-2-7b-hf"</span>
tokenizer = LlamaTokenizer.from_pretrained(model_name)
original_model = LlamaForCausalLM.from_pretrained(model_name)

<span class="hljs-comment"># 替换所有注意力层为优化后的版本</span>
<span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> original_model.model.layers:
    layer.self_attn = LlamaAttentionWithAbsorption(layer.self_attn)

<span class="hljs-comment"># 推理测试</span>
inputs = tokenizer(<span class="hljs-string">"Hello, matrix absorption optimization!"</span>, return_tensors=<span class="hljs-string">"pt"</span>)
outputs = original_model.generate(**inputs, max_new_tokens=<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>))
</code></pre>
<h3 data-id="heading-18">3. 关键优化点</h3>
<ul>
<li><strong>按头拆分计算</strong>：LLM的注意力头是并行设计的，按头拆分 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 可避免维度不匹配，同时利用硬件的并行计算能力；</li>
<li><strong>预计算缓存</strong>：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 可提前保存为文件（如 <code>.bin</code>），模型加载时直接读取，无需每次加载都重新计算；</li>
<li><strong>量化兼容</strong>：若需量化模型，可在预计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>q</mi><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{qk}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 后对其进行INT8量化（如使用 <code>torch.quantize_per_tensor</code>），进一步降低计算和内存开销。</li>
</ul>
<h2 data-id="heading-19">总结</h2>
<p>矩阵吸收优化是LLM推理加速的“轻量级利器”——通过<strong>离线预计算合并投影矩阵</strong>，在不损失精度、不修改模型结构的前提下，减少1次高开销的在线矩阵乘法，同时降低内存访问压力，最终实现约1.7倍的推理速度提升。该技术实现简单、兼容性强，尤其适合长序列、高并发、资源受限的LLM本地化部署场景，是开发者在优化LLM推理性能时的优先选择之一。</p>
<p>若需进一步提升性能，可将其与FlashAttention（优化注意力分数的内存访问）、模型量化（INT8/INT4）、TensorRT推理引擎等技术结合，形成“组合优化方案”，可实现3~5倍的综合加速比，满足更严苛的延迟和吞吐量需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[记录CI/CD自动化上传AppGallery遇到的坑]]></title>    <link>https://juejin.cn/post/7587398857536651327</link>    <guid>https://juejin.cn/post/7587398857536651327</guid>    <pubDate>2025-12-25T04:07:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587398857536651327" data-draft-id="7587349016222220329" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="记录CI/CD自动化上传AppGallery遇到的坑"/> <meta itemprop="keywords" content="前端,Android,API"/> <meta itemprop="datePublished" content="2025-12-25T04:07:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="helloCat"/> <meta itemprop="url" content="https://juejin.cn/user/1908407918148728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            记录CI/CD自动化上传AppGallery遇到的坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1908407918148728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    helloCat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T04:07:03.000Z" title="Thu Dec 25 2025 04:07:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文主要声讨的是华为 AppGallery 开发者文档。要值得称赞的是，他们还是写了为了这个功能编写了文档。如果你在写CI/CD的时候遇到这个问题，并通过该文章解决了，麻烦点个赞。</p>
<p>一般来说，你需要按照以下几步走。</p>
<h2 data-id="heading-0">第一步，获取华为应用市场 Access Token</h2>
<p>首先，一开始，先看<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fapp%2Fagc-help-connect-api-obtain-server-auth-0000002271134661%23section1679462873111" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/app/agc-help-connect-api-obtain-server-auth-0000002271134661#section1679462873111" ref="nofollow noopener noreferrer">文档</a>。获取服务端授权，然后把拿到的<code>client_id</code> 和 <code>client_secret</code> 进行如下请求。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> result = axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'https://connect-api.cloud.huawei.com/api/oauth2/v1/token'</span>, {
  <span class="hljs-attr">grant_type</span>: <span class="hljs-string">'client_credentials'</span>,
  <span class="hljs-attr">client_id</span>: clientId, <span class="hljs-comment">// 替换为你的 client_id</span>
  <span class="hljs-attr">client_secret</span>: clientSecret, <span class="hljs-comment">// 替换为你的 client_secret</span>
});

<span class="hljs-comment">// 拿到的 Token</span>
<span class="hljs-keyword">const</span> accessToken = result.<span class="hljs-property">access_token</span>;
</code></pre>
<h2 data-id="heading-1">第二步，申请上传权限</h2>
<p>接着，直接看代码就行，到这一步还没有坑。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> contentLength = fs.<span class="hljs-title function_">statSync</span>(apkFilePath).<span class="hljs-property">size</span>;
  
<span class="hljs-keyword">const</span> uploadApplyResult = axios.<span class="hljs-title function_">get</span>(
  <span class="hljs-string">"https://connect-api.cloud.huawei.com/api/publish/v2/upload-url/for-obs"</span>, 
  {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-attr">client_id</span>: clientId,
      <span class="hljs-comment">// 第一步拿到的 token</span>
      <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${accessToken}</span>`</span>,
      <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
    },
    
    <span class="hljs-attr">params</span>: {
      <span class="hljs-comment">// 根据华为 API 要求构造请求体</span>

      <span class="hljs-comment">// 1 代表 APK, 2 代表 AAB（Android App Bundle）</span>
      <span class="hljs-attr">type</span>: <span class="hljs-number">1</span>,
      <span class="hljs-comment">// 你在华为平台的应用 ID</span>
      <span class="hljs-attr">appId</span>: appId,
      <span class="hljs-comment">// 'apk' or 'aab'</span>
      <span class="hljs-attr">suffix</span>: <span class="hljs-string">'apk'</span>,

      <span class="hljs-comment">// 上传的 APK 文件名</span>
      <span class="hljs-attr">fileName</span>: fileName,
      
      <span class="hljs-comment">// 上传的 APK 文件大小</span>
      <span class="hljs-attr">contentLength</span>: contentLength,

      <span class="hljs-comment">// 大陆地区可以忽略，海外地区必填</span>
      <span class="hljs-attr">chineseMainlandFlag</span>: <span class="hljs-number">0</span>,
    },
  }
)
</code></pre>
<h2 data-id="heading-2">第三部，开始上传 APK 文件</h2>
<p>我们要求是只需要上传到平台就行，所以不用搞分片上传。这一步就是坑的开始，如果你按照文档来，百分百会给你报一串错误 XML，如下：</p>
<pre><code class="hljs language-txt" lang="txt">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;Error&gt;
  &lt;Code&gt;SignatureDoesNotMatch&lt;/Code&gt;
  &lt;Message&gt;The request signature we calculated does not match the signature you provided. Check your
    key and signing method.&lt;/Message&gt;
  &lt;RequestId&gt;0000019AED024D5C94169C0FA01D180A&lt;/RequestId&gt;
  &lt;HostId&gt;Z9v+cC1sRnaWw6x0vi8pxxYA0YVnKxbYHUPAFpnxkX8sLV44u5b02Z+ailn2wCnR&lt;/HostId&gt;
  &lt;AWSAccessKeyId&gt;NT1DSSQ7R3FSAEMCBELN&lt;/AWSAccessKeyId&gt;
  &lt;SignatureProvided&gt;fbd22dc7ed5bf90a420fcd6bd78b3fae93e68f2668758c53cbb13c7555913422&lt;/SignatureProvided&gt;
  &lt;StringToSign&gt;AWS4-HMAC-SHA256
    20251205T053539Z
    20251205/ap-southeast-3/s3/aws4_request
    0b4bc19ab88df2d905cfbba6f3f24fd722da7cb7434fc9d2288776eaed7cd15f&lt;/StringToSign&gt;
  &lt;StringToSignBytes&gt;41 57 53 34 2d 48 4d 41 43 2d 53 48 41 32 35 36 0a 32 30 32 35 31 32 30 35 54
    30 35 33 35 33 39 5a 0a 32 30 32 35 31 32 30 35 2f 61 70 2d 73 6f 75 74 68 65 61 73 74 2d 33 2f
    73 33 2f 61 77 73 34 5f 72 65 71 75 65 73 74 0a 30 62 34 62 63 31 39 61 62 38 38 64 66 32 64 39
    30 35 63 66 62 62 61 36 66 33 66 32 34 66 64 37 32 32 64 61 37 63 62 37 34 33 34 66 63 39 64 32
    32 38 38 37 37 36 65 61 65 64 37 63 64 31 35 66&lt;/StringToSignBytes&gt;
  &lt;CanonicalRequest&gt;PUT
    /SG/2025120505/1764912939540-2257a16f-c80f-4fe3-bdde-f3150531d3c4.apk
    content-type:application/octet-stream
    host:nsp-appgallery-agcfs-dra.obs.ap-southeast-3.myhuaweicloud.com
    x-amz-content-sha256:UNSIGNED-PAYLOAD
    x-amz-date:20251205T053539Z
    ontent-length;content-type;host;x-amz-content-sha256;x-amz-date
    UNSIGNED-PAYLOAD
    &lt;/CanonicalRequest&gt;
  &lt;StringToSignBytes&gt;50 55 54 0a 2f 53 47 2f 32 30 32 35 31 32 30 35 30 35 2f 31 37 36 34 39 31 32
    39 33 39 35 34 30 2d 32 32 35 37 61 31 36 66 2d 63 38 30 66 2d 34 66 65 33 2d 62 64 64 65 2d 66
    33 31 35 30 35 33 31 64 33 63 34 2e 61 70 6b 0a 0a 63 6f 6e 74 65 6e 74 2d 74 79 70 65 3a 61 70
    70 6c 69 63 61 74 69 6f 6e 2f 6f 63 74 65 74 2d 73 74 72 65 61 6d 0a 68 6f 73 74 3a 6e 73 70 2d
    61 70 70 67 61 6c 6c 65 72 79 2d 61 67 63 66 73 2d 64 72 61 2e 6f 62 73 2e 61 70 2d 73 6f 75 74
    68 65 61 73 74 2d 33 2e 6d 79 68 75 61 77 65 69 63 6c 6f 75 64 2e 63 6f 6d 0a 78 2d 61 6d 7a 2d
    63 6f 6e 74 65 6e 74 2d 73 68 61 32 35 36 3a 55 4e 53 49 47 4e 45 44 2d 50 41 59 4c 4f 41 44 0a
    78 2d 61 6d 7a 2d 64 61 74 65 3a 32 30 32 35 31 32 30 35 54 30 35 33 35 33 39 5a 0a 0a 63 6f 6e
    74 65 6e 74 2d 6c 65 6e 67 74 68 3b 63 6f 6e 74 65 6e 74 2d 74 79 70 65 3b 68 6f 73 74 3b 78 2d
    61 6d 7a 2d 63 6f 6e 74 65 6e 74 2d 73 68 61 32 35 36 3b 78 2d 61 6d 7a 2d 64 61 74 65 0a 55 4e
    53 49 47 4e 45 44 2d 50 41 59 4c 4f 41 44&lt;/StringToSignBytes&gt;
&lt;/Error&gt;
</code></pre>
<p>其实问题的症结就在于，文档没告诉你，你需要把<code>Content-Length</code>放入头部，他的头部签名字段<code>x-amz-content-sha256</code>中需要<code>Content-Length</code>来进行签名。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 第二步拿到的上传结果</span>
<span class="hljs-keyword">const</span> result = uploadApplyResult;

<span class="hljs-comment">// 文件流</span>
<span class="hljs-keyword">const</span> fileStream = fs.<span class="hljs-title function_">createReadStream</span>(apkFilePath);

<span class="hljs-comment">// 现在不会报错了...</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">put</span>(result.<span class="hljs-property">urlInfo</span>.<span class="hljs-property">url</span>, fileStream, {
  <span class="hljs-attr">headers</span>: {
    ...result.<span class="hljs-property">urlInfo</span>.<span class="hljs-property">headers</span>,
    <span class="hljs-string">'Content-Length'</span>: contentLength
  }
});

</code></pre>
<h2 data-id="heading-3">第四步，更新应用文件信息</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 第二步拿到的结果</span>
<span class="hljs-keyword">const</span> objectId = uploadApplyResult.<span class="hljs-property">urlInfo</span>.<span class="hljs-property">objectId</span>;

<span class="hljs-keyword">const</span> fileName = <span class="hljs-string">'my.apk'</span>

<span class="hljs-keyword">const</span> fileInfoResult = <span class="hljs-keyword">await</span> httpClient.<span class="hljs-title function_">put</span>(
  <span class="hljs-string">`https://connect-api.cloud.huawei.com/api/publish/v2/app-file-info?appId=<span class="hljs-subst">${appId}</span>`</span>,
  {
    <span class="hljs-comment">// apk: 5, aab: 6</span>
    <span class="hljs-string">'fileType'</span>: <span class="hljs-number">5</span>,
    <span class="hljs-string">'files'</span>: [{
      <span class="hljs-string">'fileName'</span>: fileName,
      <span class="hljs-string">'fileDestUrl'</span>: result.<span class="hljs-property">urlInfo</span>.<span class="hljs-property">objectId</span>
    }]
  },
);
</code></pre>
<h2 data-id="heading-4">最后</h2>
<p>我看到截止目前 2025-12-25 为止，AppGallery 已经从 v2 升级到了 v3。所以，搞 API 没啥前途。你看到上面所谓的 <code>SignatureDoesNotMatch</code> 后，能第一时间想到看是不是少了或者多了参数，这种解决问题的直觉才是我认为最重要的。</p>
<p>ps: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fen%2Fdoc%2FAppGallery-connect-References%2Fagcapi-app-file-info-0000001111685202" target="_blank" title="https://developer.huawei.com/consumer/en/doc/AppGallery-connect-References/agcapi-app-file-info-0000001111685202" ref="nofollow noopener noreferrer">英文版文档</a>还没改，用的还是 v2 的 API。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Reasoning + Acting: ReAct范式与ReAct Agent]]></title>    <link>https://juejin.cn/post/7587355990409150515</link>    <guid>https://juejin.cn/post/7587355990409150515</guid>    <pubDate>2025-12-25T05:42:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587355990409150515" data-draft-id="7587335187073384474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Reasoning + Acting: ReAct范式与ReAct Agent"/> <meta itemprop="keywords" content="LLM,人工智能,后端"/> <meta itemprop="datePublished" content="2025-12-25T05:42:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Reasoning + Acting: ReAct范式与ReAct Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T05:42:00.000Z" title="Thu Dec 25 2025 05:42:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在人工智能领域，大型语言模型（LLM）的出现带来了前所未有的可能性。然而，LLM 并非万能，它们会“幻觉”，它们无法实时获取信息。为了弥补这些不足，<strong>ReAct 范式</strong> 应运而生，它赋予了 LLM 像人类一样“思考”（Reasoning）和“行动”（Acting）的能力，从而构建出更强大、更可靠的 <strong>ReAct Agent</strong>。</p>
<h2 data-id="heading-1">传统 LLM 的局限性：为什么需要 ReAct</h2>
<p>想象一下，你问一个普通的 LLM：“请帮我规划一下从上海到北京的火车票，并告诉我天气情况。”</p>
<ul>
<li><strong>票务信息</strong>：LLM 可能会给出一些看似合理但实际上是虚构的票务信息，因为它无法访问实时票务系统。</li>
<li><strong>天气信息</strong>：LLM 只能根据其训练数据回答历史天气，而无法提供实时天气。</li>
</ul>
<p><strong>核心问题：</strong> 传统的 LLM 缺乏与外部世界交互的能力，它们无法调用工具，也无法根据真实世界的反馈进行调整。</p>
<h2 data-id="heading-2">ReAct 范式登场：思考、行动、观察、迭代的循环</h2>
<h3 data-id="heading-3">ReAct是谁提出来的？</h3>
<p>在人工智能领域，<strong>ReAct</strong>（Reasoning and Acting）框架是由 <strong>普林斯顿大学</strong>（Princeton University）和 <strong>谷歌研究院</strong>（Google Research，特别是 Brain 团队）的科研人员共同提出的。 </p>
<p>该框架首次出现在 2022 年发表的论文 <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2210.03629" target="_blank" title="https://arxiv.org/abs/2210.03629" ref="nofollow noopener noreferrer">《ReAct: Synergizing Reasoning and Acting in Language Models》</a> 中。其主要贡献者包括： </p>
<ul>
<li><strong>姚顺雨 (Shunyu Yao)</strong> ：论文第一作者，来自普林斯顿大学。</li>
<li><strong>Jeffrey Zhao, Dian Yu, Nan Du, Izhak Shafran, Yuan Cao</strong>：来自谷歌研究院。</li>
<li><strong>Karthik Narasimhan</strong>：来自普林斯顿大学。</li>
</ul>
<p>姚顺雨（Shunyu Yao）目前被公认为 AI Agent（人工智能体）领域的<strong>全球顶尖青年学者和领军人物之一</strong>。</p>
<p>小八卦：2025 年 12 月，腾讯官方确认姚顺雨已正式加盟，出任首席 AI 科学家（Chief AI Scientist），直属于 CEO/总裁办，并领导新成立的 <strong>AI Infra 部门</strong>和<strong>大模型部门</strong>。</p>
<h3 data-id="heading-4">什么是 ReAct 范式</h3>
<p>它的核心逻辑是一个四元组的循环：</p>
<p>Thought (思考) → Action (行动) → Observation (观察) → <strong>迭代</strong></p>
<p><strong>核心组件分解：</strong></p>
<ul>
<li><strong>Thought (推理)</strong> ：模型对当前任务进行分析，计划下一步要做什么（例如：“我需要查询当前的股价”）。</li>
<li><strong>Action (行动)</strong> ：模型决定调用哪个外部工具（Tool/Function Calling），并给出参数（例如：调用 <code>get_stock_price(symbol="AAPL")</code>）。</li>
<li><strong>Observation (观察)</strong> ：模型接收外部工具返回的真实结果（例如：“Apple 股价为 190 美元”）。</li>
<li><strong>迭代</strong>：基于观察结果继续思考和行动，直到完成任务。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5562d1c3fa0d4055bb750e13b088c82a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246120&amp;x-signature=GUH5d8P5HqAzGsnuUxtaqiPK6mw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">ReAct Agent：具有“手脚”的智能体</h2>
<h3 data-id="heading-6">定义</h3>
<p><strong>ReAct Agent</strong> 就是基于 ReAct 范式构建的智能体。你可以把它想象成一个拥有大脑（LLM）和“手脚”（外部工具）的机器人。它不再仅仅是回答问题，而是能够：</p>
<ul>
<li><strong>理解并规划</strong>：解析用户意图。</li>
<li><strong>调用工具</strong>：执行特定的外部操作。</li>
<li><strong>处理反馈</strong>：根据工具返回的真实世界信息调整策略。</li>
<li><strong>迭代优化</strong>：通过多轮思考-行动-观察，逐步接近最终答案</li>
</ul>
<h3 data-id="heading-7">案例</h3>
<p>这样说太干了，来点案例？😈</p>
<p><strong>用户：</strong> “计算一下 2023 年 8 月 15 日，上海浦东新区有多少人会去迪士尼乐园，然后告诉我当天是否会下雨？”</p>
<ol>
<li><strong>Thought:</strong> “用户想知道迪士尼客流量和天气。我需要一个获取客流量的工具和一个天气查询工具。客流量可能需要结合历史数据和节假日因素，天气是实时的。”</li>
<li><strong>Action:</strong> “调用 <code>get_disney_attendance_estimate(date='2023-08-15', location='上海浦东新区')</code> 工具。”</li>
<li><strong>Observation:</strong> “迪士尼乐园在 8 月 15 日（非周末）预计客流量为 30,000 人。”</li>
<li><strong>Thought:</strong> “我已经获取了客流量。现在需要获取天气信息。”</li>
<li><strong>Action:</strong> “调用 <code>get_current_weather(location='上海浦东新区', date='2023-08-15')</code> 工具。”</li>
<li><strong>Observation:</strong> “2023 年 8 月 15 日，上海浦东新区预计小雨。”</li>
<li><strong>Thought:</strong> “我已经获取了所有需要的信息，可以回答用户了。”</li>
<li><strong>Action:</strong> “回答用户：‘根据预测，2023 年 8 月 15 日上海浦东迪士尼乐园预计客流量为 30,000 人，当天预计会有小雨。’”</li>
</ol>
<h2 data-id="heading-8">深入后端开发：ReAct Agent 的实现框架</h2>
<p>对于后端开发者来说，手动实现 ReAct 范式需要大量的提示词工程和状态管理。幸运的是，目前主流的 AI 框架都提供了对 ReAct 的开箱即用支持：</p>
<ul>
<li>Spring AI/Spring AI Alibaba</li>
<li>Langchain4j</li>
</ul>
<h3 data-id="heading-9">Spring AI Alibaba (声明式/配置式)</h3>
<p>它更倾向于通过 Spring 的 Bean 注入和 <code>ChatClient</code> 来实现，其深度绑定 Spring 生态。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// 典型的 Spring 风格：通过 ChatClient 绑定工具</span>
<span class="hljs-type">var</span> <span class="hljs-variable">chatClient</span> <span class="hljs-operator">=</span> chatClientBuilder
    .defaultFunctions(<span class="hljs-string">"currentWeatherTool"</span>) <span class="hljs-comment">// 注册为 Spring Bean 的工具</span>
    .build();

<span class="hljs-comment">// 执行时，Spring AI 内部会封装 ReAct 的循环逻辑</span>
<span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatClient.prompt(<span class="hljs-string">"上海今天天气怎么样？"</span>).call().content();
</code></pre>
<h3 data-id="heading-10">LangChain4j (命令式/编排式)</h3>
<p>它更像是一个工具箱，让你显式地构建“大脑”和“手脚”。如果你需要复杂的底层agent编排，那它更加适合你。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-type">Assistant</span> <span class="hljs-variable">assistant</span> <span class="hljs-operator">=</span> AiServices.builder(Assistant.class)
    .chatLanguageModel(model)
    .tools(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WeatherTool</span>()) <span class="hljs-comment">// 手动绑定工具类</span>
    .chatMemory(MessageWindowChatMemory.withMaxMessages(<span class="hljs-number">10</span>))
    .build();

<span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> assistant.chat(<span class="hljs-string">"上海今天天气怎么样？"</span>);
</code></pre>
<h3 data-id="heading-11">对比总结</h3>






























<table><thead><tr><th><strong>维度</strong></th><th><strong>LangChain4j</strong></th><th><strong>Spring AI Alibaba</strong></th></tr></thead><tbody><tr><td><strong>生态</strong></td><td>独立于框架，Quarkus/Spring 均可</td><td>深度绑定 Spring Boot / Cloud</td></tr><tr><td><strong>灵活性</strong></td><td>极高，适合从底层定制 Agent 行为</td><td>较好，遵循“约定大于配置”</td></tr><tr><td><strong>上手难度</strong></td><td>需要学习复杂的链/服务概念</td><td>只要会用 Spring，上手非常快</td></tr><tr><td><strong>推荐场景</strong></td><td>复杂的、非 Spring 环境的多 Agent 协作</td><td>现有的 Java 微服务系统增加 AI 能力</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebc4fcdaf9474592a5a96a0e98ebaa59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767246120&amp;x-signature=gvJyqd5uxKoXm6bSle%2Brf0aXwqk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-12">总结</h2>
<p>ReAct范式很好地指导了agent如何思考并调用工具解决用户提出的问题，虽然耗费的token会多很多，但是幻觉问题得到大大缓解。这是agent开发的新的指导范式和里程碑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python函数深度解析：从基础到高级装饰器]]></title>    <link>https://juejin.cn/post/7587398857536864319</link>    <guid>https://juejin.cn/post/7587398857536864319</guid>    <pubDate>2025-12-25T05:16:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587398857536864319" data-draft-id="7587349016222924841" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python函数深度解析：从基础到高级装饰器"/> <meta itemprop="keywords" content="Python,PyCharm"/> <meta itemprop="datePublished" content="2025-12-25T05:16:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python函数深度解析：从基础到高级装饰器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T05:16:25.000Z" title="Thu Dec 25 2025 05:16:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>在Python编程中，函数就像乐高积木——你可以创建小块的功能模块，然后将它们组合成复杂的结构。今天，让我们深入探索Python函数的方方面面，从最基础的函数定义到高级的装饰器模式。</p>
<h2 data-id="heading-0">引入：为什么函数如此重要？</h2>
<p>想象一下，你正在编写一个数据分析程序：</p>
<ul>
<li>需要多次计算数据的平均值</li>
<li>需要格式化输出结果</li>
<li>需要验证输入数据的有效性</li>
</ul>
<p>如果没有函数，你会重复写相同的代码。而使用函数，就像拥有一个魔法工具箱，每个工具都有特定的用途，可以反复使用，让代码更简洁、更易维护。</p>
<h2 data-id="heading-1">一、函数基础：构建代码模块</h2>
<h3 data-id="heading-2">1.1 函数的定义与调用</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 函数基础：定义、调用、返回值</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== Python函数基础 ===\n"</span>)

<span class="hljs-comment"># 1. 最简单的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>():
    <span class="hljs-string">"""一个简单的问候函数"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"你好！"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"欢迎学习Python函数"</span>)

<span class="hljs-comment"># 调用函数</span>
greet()

<span class="hljs-comment"># 2. 带参数的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">personalized_greet</span>(<span class="hljs-params">name</span>):
    <span class="hljs-string">"""向特定的人问好"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"你好，<span class="hljs-subst">{name}</span>！"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>，今天过得怎么样？"</span>)

<span class="hljs-comment"># 调用带参数的函数</span>
personalized_greet(<span class="hljs-string">"小明"</span>)
personalized_greet(<span class="hljs-string">"小红"</span>)

<span class="hljs-comment"># 3. 带返回值的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_numbers</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-string">"""返回两个数的和"""</span>
    result = a + b
    <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># 使用返回值</span>
sum_result = add_numbers(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 + 3 = <span class="hljs-subst">{sum_result}</span>"</span>)

<span class="hljs-comment"># 返回值可以直接使用</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"10 + 20 = <span class="hljs-subst">{add_numbers(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)}</span>"</span>)

<span class="hljs-comment"># 4. 多个返回值</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_student_info</span>():
    <span class="hljs-string">"""返回学生的姓名、年龄和成绩"""</span>
    name = <span class="hljs-string">"张三"</span>
    age = <span class="hljs-number">18</span>
    scores = [<span class="hljs-number">85</span>, <span class="hljs-number">92</span>, <span class="hljs-number">78</span>]
    <span class="hljs-keyword">return</span> name, age, scores  <span class="hljs-comment"># 实际上返回一个元组</span>

<span class="hljs-comment"># 接收多个返回值</span>
student_name, student_age, student_scores = get_student_info()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"学生信息：<span class="hljs-subst">{student_name}</span>，<span class="hljs-subst">{student_age}</span>岁，成绩：<span class="hljs-subst">{student_scores}</span>"</span>)

<span class="hljs-comment"># 5. 查看函数信息</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n函数文档：<span class="hljs-subst">{add_numbers.__doc__}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数名：<span class="hljs-subst">{add_numbers.__name__}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"模块：<span class="hljs-subst">{add_numbers.__module__}</span>"</span>)
</code></pre>
<h3 data-id="heading-3">1.2 参数传递的四种方式</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 参数传递的四种方式 ===\n"</span>)

<span class="hljs-comment"># 1. 位置参数（最基本的参数传递）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">describe_pet</span>(<span class="hljs-params">animal_type, pet_name</span>):
    <span class="hljs-string">"""显示宠物的信息"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"我有一只<span class="hljs-subst">{animal_type}</span>，它叫<span class="hljs-subst">{pet_name}</span>。"</span>)

describe_pet(<span class="hljs-string">"狗"</span>, <span class="hljs-string">"旺财"</span>)  <span class="hljs-comment"># 参数按位置传递</span>
describe_pet(<span class="hljs-string">"猫"</span>, <span class="hljs-string">"咪咪"</span>)

<span class="hljs-comment"># 2. 关键字参数（指定参数名）</span>
describe_pet(animal_type=<span class="hljs-string">"仓鼠"</span>, pet_name=<span class="hljs-string">"吱吱"</span>)  <span class="hljs-comment"># 明确指定参数名</span>
describe_pet(pet_name=<span class="hljs-string">"花花"</span>, animal_type=<span class="hljs-string">"鸟"</span>)    <span class="hljs-comment"># 顺序可以改变</span>

<span class="hljs-comment"># 3. 默认参数（参数有默认值）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">make_coffee</span>(<span class="hljs-params">size=<span class="hljs-string">"中杯"</span>, coffee_type=<span class="hljs-string">"拿铁"</span>, sugar=<span class="hljs-literal">True</span></span>):
    <span class="hljs-string">"""制作咖啡"""</span>
    sugar_text = <span class="hljs-string">"加糖"</span> <span class="hljs-keyword">if</span> sugar <span class="hljs-keyword">else</span> <span class="hljs-string">"不加糖"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"制作一杯<span class="hljs-subst">{size}</span><span class="hljs-subst">{coffee_type}</span>，<span class="hljs-subst">{sugar_text}</span>"</span>)

make_coffee()                          <span class="hljs-comment"># 使用所有默认值</span>
make_coffee(<span class="hljs-string">"大杯"</span>)                     <span class="hljs-comment"># 只指定第一个参数</span>
make_coffee(coffee_type=<span class="hljs-string">"美式"</span>, sugar=<span class="hljs-literal">False</span>)  <span class="hljs-comment"># 指定部分参数</span>

<span class="hljs-comment"># 4. 可变参数（参数数量可变）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_average</span>(<span class="hljs-params">*scores</span>):
    <span class="hljs-string">"""计算平均分，可以接受任意数量的分数"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(scores) == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    total = <span class="hljs-built_in">sum</span>(scores)
    <span class="hljs-keyword">return</span> total / <span class="hljs-built_in">len</span>(scores)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均分1：<span class="hljs-subst">{calculate_average(<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>):<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均分2：<span class="hljs-subst">{calculate_average(<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>, <span class="hljs-number">76</span>):<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均分3：<span class="hljs-subst">{calculate_average(<span class="hljs-number">100</span>, <span class="hljs-number">95</span>):<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-comment"># 5. 关键字可变参数（**kwargs）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">build_profile</span>(<span class="hljs-params">first, last, **user_info</span>):
    <span class="hljs-string">"""创建一个包含用户所有信息的字典"""</span>
    profile = {}
    profile[<span class="hljs-string">'first_name'</span>] = first
    profile[<span class="hljs-string">'last_name'</span>] = last
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> user_info.items():
        profile[key] = value
    <span class="hljs-keyword">return</span> profile

user_profile = build_profile(<span class="hljs-string">'张'</span>, <span class="hljs-string">'三'</span>, age=<span class="hljs-number">25</span>, city=<span class="hljs-string">'北京'</span>, job=<span class="hljs-string">'工程师'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n用户档案：<span class="hljs-subst">{user_profile}</span>"</span>)

<span class="hljs-comment"># 6. 参数组合使用（完整的函数签名）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">complex_function</span>(<span class="hljs-params">a, b, *args, c=<span class="hljs-number">10</span>, d=<span class="hljs-number">20</span>, **kwargs</span>):
    <span class="hljs-string">"""演示所有参数类型的组合"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"a=<span class="hljs-subst">{a}</span>, b=<span class="hljs-subst">{b}</span>, args=<span class="hljs-subst">{args}</span>, c=<span class="hljs-subst">{c}</span>, d=<span class="hljs-subst">{d}</span>, kwargs=<span class="hljs-subst">{kwargs}</span>"</span>)

<span class="hljs-comment"># 调用示例</span>
complex_function(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, c=<span class="hljs-number">30</span>, e=<span class="hljs-number">100</span>, f=<span class="hljs-number">200</span>)
</code></pre>
<h2 data-id="heading-4">二、函数进阶：作用域与闭包</h2>
<h3 data-id="heading-5">2.1 变量作用域</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 变量作用域：理解Python的命名空间 ===\n"</span>)

<span class="hljs-comment"># 全局变量（在整个文件中都有效）</span>
global_var = <span class="hljs-string">"我是全局变量"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">scope_demo</span>():
    <span class="hljs-string">"""演示变量作用域"""</span>
    <span class="hljs-comment"># 局部变量（只在函数内部有效）</span>
    local_var = <span class="hljs-string">"我是局部变量"</span>
    
    <span class="hljs-comment"># 可以在函数内部访问全局变量</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数内访问全局变量：<span class="hljs-subst">{global_var}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数内访问局部变量：<span class="hljs-subst">{local_var}</span>"</span>)
    
    <span class="hljs-comment"># 修改全局变量需要使用global关键字</span>
    <span class="hljs-keyword">global</span> global_var
    global_var = <span class="hljs-string">"全局变量已被修改"</span>
    
    <span class="hljs-comment"># 嵌套作用域</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner_function</span>():
        <span class="hljs-comment"># 内层函数可以访问外层函数的变量</span>
        inner_var = <span class="hljs-string">"我是内层局部变量"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n内层函数："</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  访问外层局部变量：<span class="hljs-subst">{local_var}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  访问全局变量：<span class="hljs-subst">{global_var}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  访问内层局部变量：<span class="hljs-subst">{inner_var}</span>"</span>)
        
        <span class="hljs-comment"># 使用nonlocal修改外层函数的变量</span>
        <span class="hljs-keyword">nonlocal</span> local_var
        local_var = <span class="hljs-string">"外层局部变量已被内层函数修改"</span>
    
    inner_function()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n外层函数修改后：local_var = <span class="hljs-subst">{local_var}</span>"</span>)

<span class="hljs-comment"># 函数调用</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数调用前全局变量：<span class="hljs-subst">{global_var}</span>"</span>)
scope_demo()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数调用后全局变量：<span class="hljs-subst">{global_var}</span>"</span>)

<span class="hljs-comment"># 尝试访问局部变量（会报错）</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(local_var)
<span class="hljs-keyword">except</span> NameError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n错误：<span class="hljs-subst">{e}</span> - 不能从外部访问局部变量"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 作用域查找规则：LEGB ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"1. Local（局部作用域） - 函数内部"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"2. Enclosing（嵌套作用域） - 外层函数"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"3. Global（全局作用域） - 模块级别"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"4. Built-in（内置作用域） - Python内置函数和变量"</span>)
</code></pre>
<h3 data-id="heading-6">2.2 闭包：函数中的函数</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 闭包：函数返回函数 ==="</span>)

<span class="hljs-comment"># 闭包：函数内部定义了另一个函数，并且内部函数引用了外部函数的变量</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">outer_function</span>(<span class="hljs-params">message</span>):
    <span class="hljs-string">"""外部函数"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inner_function</span>():
        <span class="hljs-string">"""内部函数（闭包）"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"消息：<span class="hljs-subst">{message}</span>"</span>)
    <span class="hljs-keyword">return</span> inner_function  <span class="hljs-comment"># 返回内部函数，而不是调用它</span>

<span class="hljs-comment"># 创建闭包</span>
closure = outer_function(<span class="hljs-string">"你好，闭包！"</span>)
closure()  <span class="hljs-comment"># 调用闭包函数</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 闭包的实际应用：计数器 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_counter</span>():
    <span class="hljs-string">"""创建一个计数器闭包"""</span>
    count = <span class="hljs-number">0</span>  <span class="hljs-comment"># 这个变量会被闭包"记住"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">counter</span>():
        <span class="hljs-keyword">nonlocal</span> count  <span class="hljs-comment"># 声明使用外层函数的变量</span>
        count += <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> count
    
    <span class="hljs-keyword">return</span> counter

<span class="hljs-comment"># 创建两个独立的计数器</span>
counter1 = create_counter()
counter2 = create_counter()

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"计数器1：<span class="hljs-subst">{counter1()}</span>"</span>)  <span class="hljs-comment"># 1</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"计数器1：<span class="hljs-subst">{counter1()}</span>"</span>)  <span class="hljs-comment"># 2</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"计数器2：<span class="hljs-subst">{counter2()}</span>"</span>)  <span class="hljs-comment"># 1</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"计数器1：<span class="hljs-subst">{counter1()}</span>"</span>)  <span class="hljs-comment"># 3</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"计数器2：<span class="hljs-subst">{counter2()}</span>"</span>)  <span class="hljs-comment"># 2</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 闭包应用：函数工厂 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">power_factory</span>(<span class="hljs-params">exponent</span>):
    <span class="hljs-string">"""创建计算幂的函数工厂"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">power</span>(<span class="hljs-params">base</span>):
        <span class="hljs-keyword">return</span> base ** exponent
    <span class="hljs-keyword">return</span> power

<span class="hljs-comment"># 创建不同的幂函数</span>
square = power_factory(<span class="hljs-number">2</span>)  <span class="hljs-comment"># 平方函数</span>
cube = power_factory(<span class="hljs-number">3</span>)    <span class="hljs-comment"># 立方函数</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"3的平方：<span class="hljs-subst">{square(<span class="hljs-number">3</span>)}</span>"</span>)  <span class="hljs-comment"># 9</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"3的立方：<span class="hljs-subst">{cube(<span class="hljs-number">3</span>)}</span>"</span>)    <span class="hljs-comment"># 27</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5的平方：<span class="hljs-subst">{square(<span class="hljs-number">5</span>)}</span>"</span>)  <span class="hljs-comment"># 25</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 闭包应用：配置函数 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">make_multiplier</span>(<span class="hljs-params">factor</span>):
    <span class="hljs-string">"""创建乘以特定因子的函数"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">multiplier</span>(<span class="hljs-params">x</span>):
        <span class="hljs-keyword">return</span> x * factor
    <span class="hljs-keyword">return</span> multiplier

<span class="hljs-comment"># 创建不同的乘法器</span>
double = make_multiplier(<span class="hljs-number">2</span>)
triple = make_multiplier(<span class="hljs-number">3</span>)
ten_times = make_multiplier(<span class="hljs-number">10</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"2倍：<span class="hljs-subst">{double(<span class="hljs-number">5</span>)}</span>"</span>)      <span class="hljs-comment"># 10</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"3倍：<span class="hljs-subst">{triple(<span class="hljs-number">5</span>)}</span>"</span>)      <span class="hljs-comment"># 15</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"10倍：<span class="hljs-subst">{ten_times(<span class="hljs-number">5</span>)}</span>"</span>)   <span class="hljs-comment"># 50</span>
</code></pre>
<h2 data-id="heading-7">三、装饰器：函数的"化妆师"</h2>
<h3 data-id="heading-8">3.1 装饰器基础</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 装饰器基础：增强函数功能 ==="</span>)

<span class="hljs-comment"># 装饰器本质上是一个函数，它接受一个函数作为参数，返回一个新的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_decorator</span>(<span class="hljs-params">func</span>):
    <span class="hljs-string">"""一个简单的装饰器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"装饰器：函数执行前"</span>)
        result = func()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"装饰器：函数执行后"</span>)
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@simple_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>():
    <span class="hljs-string">"""被装饰的函数"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"你好，世界！"</span>)

<span class="hljs-comment"># 调用被装饰的函数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"调用被装饰的函数："</span>)
say_hello()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 手动应用装饰器 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>():
    <span class="hljs-string">"""普通函数"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"你好！"</span>)

<span class="hljs-comment"># 不适用@语法，手动装饰</span>
decorated_greet = simple_decorator(greet)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"手动装饰的函数："</span>)
decorated_greet()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 带参数的函数装饰 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">logger_decorator</span>(<span class="hljs-params">func</span>):
    <span class="hljs-string">"""记录函数调用的装饰器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"调用函数：<span class="hljs-subst">{func.__name__}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"参数：args=<span class="hljs-subst">{args}</span>, kwargs=<span class="hljs-subst">{kwargs}</span>"</span>)
        result = func(*args, **kwargs)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"返回值：<span class="hljs-subst">{result}</span>"</span>)
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@logger_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-string">"""两个数相加"""</span>
    <span class="hljs-keyword">return</span> a + b

<span class="hljs-meta">@logger_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet_person</span>(<span class="hljs-params">name, title=<span class="hljs-string">"先生"</span></span>):
    <span class="hljs-string">"""问候某人"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"你好，<span class="hljs-subst">{name}</span><span class="hljs-subst">{title}</span>！"</span>

<span class="hljs-comment"># 测试带参数的装饰器</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"测试加法函数："</span>)
result = add(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终结果：<span class="hljs-subst">{result}</span>\n"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"测试问候函数："</span>)
greeting = greet_person(<span class="hljs-string">"小明"</span>, title=<span class="hljs-string">"同学"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终问候：<span class="hljs-subst">{greeting}</span>"</span>)
</code></pre>
<h3 data-id="heading-9">3.2 实用的装饰器示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 实用装饰器示例 ==="</span>)

<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> functools

<span class="hljs-comment"># 1. 计时装饰器</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">timer_decorator</span>(<span class="hljs-params">func</span>):
    <span class="hljs-string">"""计算函数执行时间的装饰器"""</span>
<span class="hljs-meta">    @functools.wraps(<span class="hljs-params">func</span>)  </span><span class="hljs-comment"># 保留原函数的元数据</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        start_time = time.time()
        result = func(*args, **kwargs)
        end_time = time.time()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{func.__name__}</span> 执行时间：<span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.4</span>f}</span>秒"</span>)
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@timer_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">slow_function</span>(<span class="hljs-params">seconds</span>):
    <span class="hljs-string">"""模拟耗时操作"""</span>
    time.sleep(seconds)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"等待了<span class="hljs-subst">{seconds}</span>秒"</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"计时装饰器测试："</span>)
<span class="hljs-built_in">print</span>(slow_function(<span class="hljs-number">1</span>))

<span class="hljs-comment"># 2. 缓存装饰器（记忆化）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">cache_decorator</span>(<span class="hljs-params">func</span>):
    <span class="hljs-string">"""缓存函数结果的装饰器"""</span>
    cache = {}
    
<span class="hljs-meta">    @functools.wraps(<span class="hljs-params">func</span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args</span>):
        <span class="hljs-keyword">if</span> args <span class="hljs-keyword">in</span> cache:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"缓存命中：<span class="hljs-subst">{args}</span> -&gt; <span class="hljs-subst">{cache[args]}</span>"</span>)
            <span class="hljs-keyword">return</span> cache[args]
        result = func(*args)
        cache[args] = result
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"缓存未命中，计算结果：<span class="hljs-subst">{args}</span> -&gt; <span class="hljs-subst">{result}</span>"</span>)
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@cache_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci</span>(<span class="hljs-params">n</span>):
    <span class="hljs-string">"""计算斐波那契数列（递归实现）"""</span>
    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> n
    <span class="hljs-keyword">return</span> fibonacci(n-<span class="hljs-number">1</span>) + fibonacci(n-<span class="hljs-number">2</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n缓存装饰器测试（斐波那契数列）："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"fibonacci(5) = <span class="hljs-subst">{fibonacci(<span class="hljs-number">5</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"fibonacci(5) = <span class="hljs-subst">{fibonacci(<span class="hljs-number">5</span>)}</span>"</span>)  <span class="hljs-comment"># 第二次调用应该从缓存获取</span>

<span class="hljs-comment"># 3. 重试装饰器</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">retry_decorator</span>(<span class="hljs-params">max_attempts=<span class="hljs-number">3</span>, delay=<span class="hljs-number">1</span></span>):
    <span class="hljs-string">"""重试装饰器，失败时自动重试"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func</span>):
<span class="hljs-meta">        @functools.wraps(<span class="hljs-params">func</span>)</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
            last_exception = <span class="hljs-literal">None</span>
            <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_attempts):
                <span class="hljs-keyword">try</span>:
                    <span class="hljs-keyword">return</span> func(*args, **kwargs)
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    last_exception = e
                    <span class="hljs-keyword">if</span> attempt &lt; max_attempts - <span class="hljs-number">1</span>:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{attempt+<span class="hljs-number">1</span>}</span>次尝试失败：<span class="hljs-subst">{e}</span>，<span class="hljs-subst">{delay}</span>秒后重试..."</span>)
                        time.sleep(delay)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"所有<span class="hljs-subst">{max_attempts}</span>次尝试都失败了"</span>)
            <span class="hljs-keyword">raise</span> last_exception
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator

<span class="hljs-meta">@retry_decorator(<span class="hljs-params">max_attempts=<span class="hljs-number">3</span>, delay=<span class="hljs-number">1</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">unreliable_function</span>():
    <span class="hljs-string">"""有时会失败的函数"""</span>
    <span class="hljs-keyword">import</span> random
    <span class="hljs-keyword">if</span> random.random() &lt; <span class="hljs-number">0.7</span>:  <span class="hljs-comment"># 70%的几率失败</span>
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"随机失败"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"成功！"</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n重试装饰器测试："</span>)
<span class="hljs-keyword">try</span>:
    result = unreliable_function()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果：<span class="hljs-subst">{result}</span>"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终失败：<span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-10">3.3 带参数的装饰器</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 带参数的装饰器 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">repeat_decorator</span>(<span class="hljs-params">num_times</span>):
    <span class="hljs-string">"""重复执行函数的装饰器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func</span>):
<span class="hljs-meta">        @functools.wraps(<span class="hljs-params">func</span>)</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
            results = []
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_times):
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>次执行："</span>)
                result = func(*args, **kwargs)
                results.append(result)
            <span class="hljs-keyword">return</span> results
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator

<span class="hljs-meta">@repeat_decorator(<span class="hljs-params">num_times=<span class="hljs-number">3</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>):
    <span class="hljs-string">"""问候函数"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"你好，<span class="hljs-subst">{name}</span>！"</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"带参数的装饰器测试："</span>)
results = greet(<span class="hljs-string">"小明"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"所有结果：<span class="hljs-subst">{results}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 多个装饰器 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator1</span>(<span class="hljs-params">func</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"装饰器1：之前"</span>)
        func()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"装饰器1：之后"</span>)
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator2</span>(<span class="hljs-params">func</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"装饰器2：之前"</span>)
        func()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"装饰器2：之后"</span>)
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@decorator1</span>
<span class="hljs-meta">@decorator2</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hi</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"你好！"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"多个装饰器测试："</span>)
say_hi()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n注意：装饰器的应用顺序是从下往上（从里到外）"</span>)
</code></pre>
<h2 data-id="heading-11">四、Lambda函数与高阶函数</h2>
<h3 data-id="heading-12">4.1 Lambda表达式</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== Lambda表达式：匿名函数 ==="</span>)

<span class="hljs-comment"># Lambda表达式用于创建简单的匿名函数</span>
<span class="hljs-comment"># 语法：lambda 参数: 表达式</span>

<span class="hljs-comment"># 1. 基本用法</span>
square = <span class="hljs-keyword">lambda</span> x: x ** <span class="hljs-number">2</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平方函数：square(5) = <span class="hljs-subst">{square(<span class="hljs-number">5</span>)}</span>"</span>)

add = <span class="hljs-keyword">lambda</span> a, b: a + b
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"加法函数：add(3, 4) = <span class="hljs-subst">{add(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)}</span>"</span>)

<span class="hljs-comment"># 2. 立即调用</span>
result = (<span class="hljs-keyword">lambda</span> x, y: x * y)(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"立即调用：(lambda x, y: x * y)(3, 4) = <span class="hljs-subst">{result}</span>"</span>)

<span class="hljs-comment"># 3. 在列表推导式中使用</span>
numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
squares = [(<span class="hljs-keyword">lambda</span> x: x ** <span class="hljs-number">2</span>)(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> numbers]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"列表推导式中的Lambda：<span class="hljs-subst">{squares}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== Lambda的典型应用场景 ==="</span>)

<span class="hljs-comment"># 1. 排序</span>
students = [
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"小明"</span>, <span class="hljs-string">"score"</span>: <span class="hljs-number">85</span>},
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"小红"</span>, <span class="hljs-string">"score"</span>: <span class="hljs-number">92</span>},
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"小刚"</span>, <span class="hljs-string">"score"</span>: <span class="hljs-number">78</span>}
]

<span class="hljs-comment"># 按分数排序</span>
students_sorted = <span class="hljs-built_in">sorted</span>(students, key=<span class="hljs-keyword">lambda</span> s: s[<span class="hljs-string">"score"</span>], reverse=<span class="hljs-literal">True</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"按分数排序："</span>)
<span class="hljs-keyword">for</span> student <span class="hljs-keyword">in</span> students_sorted:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{student[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{student[<span class="hljs-string">'score'</span>]}</span>分"</span>)

<span class="hljs-comment"># 2. 过滤</span>
numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>]
even_numbers = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>, numbers))
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n偶数：<span class="hljs-subst">{even_numbers}</span>"</span>)

<span class="hljs-comment"># 3. 映射</span>
squared_numbers = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x ** <span class="hljs-number">2</span>, numbers))
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平方数：<span class="hljs-subst">{squared_numbers}</span>"</span>)

<span class="hljs-comment"># 4. 在GUI编程中（如按钮回调）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\nLambda作为回调函数的示例："</span>)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">button_click</span>(<span class="hljs-params">button_name</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">lambda</span>: <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{button_name}</span> 被点击了"</span>)

ok_button = button_click(<span class="hljs-string">"确定"</span>)
cancel_button = button_click(<span class="hljs-string">"取消"</span>)

<span class="hljs-comment"># 模拟点击</span>
ok_button()
cancel_button()
</code></pre>
<h3 data-id="heading-13">4.2 高阶函数</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 高阶函数：函数作为参数或返回值 ==="</span>)

<span class="hljs-comment"># 1. 函数作为参数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_operation</span>(<span class="hljs-params">numbers, operation</span>):
    <span class="hljs-string">"""对列表中的每个数应用操作"""</span>
    <span class="hljs-keyword">return</span> [operation(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> numbers]

numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">square</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> x ** <span class="hljs-number">2</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">double</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> x * <span class="hljs-number">2</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"应用平方操作：<span class="hljs-subst">{apply_operation(numbers, square)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"应用加倍操作：<span class="hljs-subst">{apply_operation(numbers, double)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"应用Lambda操作：<span class="hljs-subst">{apply_operation(numbers, <span class="hljs-keyword">lambda</span> x: x + <span class="hljs-number">10</span>)}</span>"</span>)

<span class="hljs-comment"># 2. 函数作为返回值</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">make_adder</span>(<span class="hljs-params">n</span>):
    <span class="hljs-string">"""创建加法函数"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">adder</span>(<span class="hljs-params">x</span>):
        <span class="hljs-keyword">return</span> x + n
    <span class="hljs-keyword">return</span> adder

add5 = make_adder(<span class="hljs-number">5</span>)
add10 = make_adder(<span class="hljs-number">10</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"add5(3) = <span class="hljs-subst">{add5(<span class="hljs-number">3</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"add10(3) = <span class="hljs-subst">{add10(<span class="hljs-number">3</span>)}</span>"</span>)

<span class="hljs-comment"># 3. 函数组合</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">compose</span>(<span class="hljs-params">f, g</span>):
    <span class="hljs-string">"""组合两个函数：f(g(x))"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">lambda</span> x: f(g(x))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_one</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> x + <span class="hljs-number">1</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply_by_two</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> x * <span class="hljs-number">2</span>

<span class="hljs-comment"># 创建组合函数：先加1，再乘以2</span>
add_then_multiply = compose(multiply_by_two, add_one)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"add_then_multiply(3) = <span class="hljs-subst">{add_then_multiply(<span class="hljs-number">3</span>)}</span>"</span>)  <span class="hljs-comment"># (3+1)*2 = 8</span>

<span class="hljs-comment"># 4. 部分函数</span>
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial

<span class="hljs-keyword">def</span> <span class="hljs-title function_">power</span>(<span class="hljs-params">base, exponent</span>):
    <span class="hljs-string">"""计算幂"""</span>
    <span class="hljs-keyword">return</span> base ** exponent

<span class="hljs-comment"># 创建平方函数（固定exponent为2）</span>
square = partial(power, exponent=<span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"square(5) = <span class="hljs-subst">{square(<span class="hljs-number">5</span>)}</span>"</span>)

<span class="hljs-comment"># 创建立方函数（固定exponent为3）</span>
cube = partial(power, exponent=<span class="hljs-number">3</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"cube(3) = <span class="hljs-subst">{cube(<span class="hljs-number">3</span>)}</span>"</span>)
</code></pre>
<h2 data-id="heading-14">五、生成器函数：惰性计算的艺术</h2>
<h3 data-id="heading-15">5.1 yield关键字与生成器</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 生成器函数：使用yield ==="</span>)

<span class="hljs-comment"># 生成器函数使用yield返回一个值，并暂停执行，下次从暂停处继续</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_generator</span>():
    <span class="hljs-string">"""一个简单的生成器"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始"</span>)
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"继续"</span>)
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"结束"</span>)
    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"创建生成器："</span>)
gen = simple_generator()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"第一次调用next："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))

<span class="hljs-built_in">print</span>(<span class="hljs-string">"第二次调用next："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))

<span class="hljs-built_in">print</span>(<span class="hljs-string">"第三次调用next："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))

<span class="hljs-comment"># 再次调用会抛出StopIteration异常</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))
<span class="hljs-keyword">except</span> StopIteration:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成器已结束"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 使用for循环遍历生成器 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">countdown</span>(<span class="hljs-params">n</span>):
    <span class="hljs-string">"""倒数生成器"""</span>
    <span class="hljs-keyword">while</span> n &gt; <span class="hljs-number">0</span>:
        <span class="hljs-keyword">yield</span> n
        n -= <span class="hljs-number">1</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"倒数："</span>)
<span class="hljs-keyword">for</span> number <span class="hljs-keyword">in</span> countdown(<span class="hljs-number">5</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"倒计时：<span class="hljs-subst">{number}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 生成器表达式 ==="</span>)

<span class="hljs-comment"># 生成器表达式类似于列表推导式，但使用圆括号</span>
numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]

<span class="hljs-comment"># 列表推导式：立即计算所有值</span>
squares_list = [x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> numbers]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"列表推导式：<span class="hljs-subst">{squares_list}</span>，类型：<span class="hljs-subst">{<span class="hljs-built_in">type</span>(squares_list)}</span>"</span>)

<span class="hljs-comment"># 生成器表达式：惰性计算</span>
squares_gen = (x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> numbers)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成器表达式：<span class="hljs-subst">{squares_gen}</span>，类型：<span class="hljs-subst">{<span class="hljs-built_in">type</span>(squares_gen)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"转换为列表：<span class="hljs-subst">{<span class="hljs-built_in">list</span>(squares_gen)}</span>"</span>)
</code></pre>
<h3 data-id="heading-16">5.2 生成器的实际应用</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 生成器的实际应用 ==="</span>)

<span class="hljs-comment"># 1. 读取大文件</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_large_file</span>(<span class="hljs-params">file_path</span>):
    <span class="hljs-string">"""逐行读取大文件"""</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> file:
        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> file:
            <span class="hljs-keyword">yield</span> line.strip()

<span class="hljs-comment"># 模拟大文件</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'large_file.txt'</span>, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000</span>):
        f.write(<span class="hljs-string">f"这是第<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>行数据\n"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"读取大文件（不占用太多内存）："</span>)
line_count = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> read_large_file(<span class="hljs-string">'large_file.txt'</span>):
    <span class="hljs-keyword">if</span> line_count &lt; <span class="hljs-number">5</span>:  <span class="hljs-comment"># 只显示前5行</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{line}</span>"</span>)
    line_count += <span class="hljs-number">1</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"总行数：<span class="hljs-subst">{line_count}</span>"</span>)

<span class="hljs-comment"># 2. 无限序列</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci_sequence</span>():
    <span class="hljs-string">"""生成斐波那契数列（无限）"""</span>
    a, b = <span class="hljs-number">0</span>, <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">yield</span> a
        a, b = b, a + b

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n斐波那契数列（前10个）："</span>)
fib_gen = fibonacci_sequence()
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  F<span class="hljs-subst">{i}</span> = <span class="hljs-subst">{<span class="hljs-built_in">next</span>(fib_gen)}</span>"</span>)

<span class="hljs-comment"># 3. 管道处理</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">number_generator</span>(<span class="hljs-params">n</span>):
    <span class="hljs-string">"""生成数字"""</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        <span class="hljs-keyword">yield</span> i

<span class="hljs-keyword">def</span> <span class="hljs-title function_">square_numbers</span>(<span class="hljs-params">numbers</span>):
    <span class="hljs-string">"""平方数字"""</span>
    <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> numbers:
        <span class="hljs-keyword">yield</span> num ** <span class="hljs-number">2</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_even</span>(<span class="hljs-params">numbers</span>):
    <span class="hljs-string">"""过滤偶数"""</span>
    <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> numbers:
        <span class="hljs-keyword">if</span> num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">yield</span> num

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n管道处理：生成 → 平方 → 过滤"</span>)
pipeline = filter_even(square_numbers(number_generator(<span class="hljs-number">10</span>)))
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果：<span class="hljs-subst">{<span class="hljs-built_in">list</span>(pipeline)}</span>"</span>)

<span class="hljs-comment"># 4. 协程（双向通信）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">coroutine_example</span>():
    <span class="hljs-string">"""一个简单的协程"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"协程启动"</span>)
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        value = <span class="hljs-keyword">yield</span>  <span class="hljs-comment"># 接收值</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到值：<span class="hljs-subst">{value}</span>"</span>)
        <span class="hljs-keyword">yield</span> value * <span class="hljs-number">2</span>  <span class="hljs-comment"># 返回值</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n协程示例："</span>)
coro = coroutine_example()
<span class="hljs-built_in">next</span>(coro)  <span class="hljs-comment"># 启动协程，执行到第一个yield</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"发送10，收到：<span class="hljs-subst">{coro.send(<span class="hljs-number">10</span>)}</span>"</span>)
<span class="hljs-built_in">next</span>(coro)  <span class="hljs-comment"># 继续到下一个yield</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"发送20，收到：<span class="hljs-subst">{coro.send(<span class="hljs-number">20</span>)}</span>"</span>)
</code></pre>
<h2 data-id="heading-17">六、面向对象中的函数：方法与特殊方法</h2>
<h3 data-id="heading-18">6.1 类方法与实例方法</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 类中的函数：方法 ==="</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span>:
    <span class="hljs-string">"""计算器类"""</span>
    
    <span class="hljs-comment"># 类属性</span>
    operation_count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name=<span class="hljs-string">"计算器"</span></span>):
        <span class="hljs-string">"""构造方法"""</span>
        self.name = name
        self.history = []
    
    <span class="hljs-comment"># 实例方法：操作实例数据</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, a, b</span>):
        <span class="hljs-string">"""加法"""</span>
        Calculator.operation_count += <span class="hljs-number">1</span>
        result = a + b
        self.history.append(<span class="hljs-string">f"<span class="hljs-subst">{a}</span> + <span class="hljs-subst">{b}</span> = <span class="hljs-subst">{result}</span>"</span>)
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">self, a, b</span>):
        <span class="hljs-string">"""乘法"""</span>
        Calculator.operation_count += <span class="hljs-number">1</span>
        result = a * b
        self.history.append(<span class="hljs-string">f"<span class="hljs-subst">{a}</span> × <span class="hljs-subst">{b}</span> = <span class="hljs-subst">{result}</span>"</span>)
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-comment"># 实例方法：访问实例数据</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">show_history</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""显示历史记录"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.history:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span> 还没有操作记录"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span> 的操作记录："</span>)
            <span class="hljs-keyword">for</span> operation <span class="hljs-keyword">in</span> self.history:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{operation}</span>"</span>)
    
    <span class="hljs-comment"># 类方法：操作类数据</span>
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_operation_count</span>(<span class="hljs-params">cls</span>):
        <span class="hljs-string">"""获取总操作次数"""</span>
        <span class="hljs-keyword">return</span> cls.operation_count
    
    <span class="hljs-comment"># 静态方法：不访问类或实例数据</span>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">help</span>():
        <span class="hljs-string">"""显示帮助信息"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"这是一个计算器类，支持加法和乘法运算"</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"创建计算器实例："</span>)
calc1 = Calculator(<span class="hljs-string">"我的计算器"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n使用实例方法："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 + 3 = <span class="hljs-subst">{calc1.add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 × 3 = <span class="hljs-subst">{calc1.multiply(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
calc1.show_history()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n使用类方法："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"总操作次数：<span class="hljs-subst">{Calculator.get_operation_count()}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n使用静态方法："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"帮助信息：<span class="hljs-subst">{Calculator.<span class="hljs-built_in">help</span>()}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n创建第二个计算器："</span>)
calc2 = Calculator(<span class="hljs-string">"第二个计算器"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"10 + 20 = <span class="hljs-subst">{calc2.add(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"总操作次数（类级别）：<span class="hljs-subst">{Calculator.get_operation_count()}</span>"</span>)
</code></pre>
<h3 data-id="heading-19">6.2 特殊方法（魔术方法）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 特殊方法（魔术方法） ==="</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Vector</span>:
    <span class="hljs-string">"""向量类，演示特殊方法"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, x, y</span>):
        self.x = x
        self.y = y
    
    <span class="hljs-comment"># 字符串表示</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""str() 时调用"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Vector(<span class="hljs-subst">{self.x}</span>, <span class="hljs-subst">{self.y}</span>)"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""repr() 时调用"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Vector(<span class="hljs-subst">{self.x}</span>, <span class="hljs-subst">{self.y}</span>)"</span>
    
    <span class="hljs-comment"># 算术运算</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__add__</span>(<span class="hljs-params">self, other</span>):
        <span class="hljs-string">"""+ 运算"""</span>
        <span class="hljs-keyword">return</span> Vector(self.x + other.x, self.y + other.y)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__sub__</span>(<span class="hljs-params">self, other</span>):
        <span class="hljs-string">"""- 运算"""</span>
        <span class="hljs-keyword">return</span> Vector(self.x - other.x, self.y - other.y)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__mul__</span>(<span class="hljs-params">self, scalar</span>):
        <span class="hljs-string">"""* 运算（向量乘以标量）"""</span>
        <span class="hljs-keyword">return</span> Vector(self.x * scalar, self.y * scalar)
    
    <span class="hljs-comment"># 比较运算</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, other</span>):
        <span class="hljs-string">"""== 运算"""</span>
        <span class="hljs-keyword">return</span> self.x == other.x <span class="hljs-keyword">and</span> self.y == other.y
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__lt__</span>(<span class="hljs-params">self, other</span>):
        <span class="hljs-string">"""&lt; 运算（比较长度）"""</span>
        <span class="hljs-keyword">return</span> (self.x**<span class="hljs-number">2</span> + self.y**<span class="hljs-number">2</span>) &lt; (other.x**<span class="hljs-number">2</span> + other.y**<span class="hljs-number">2</span>)
    
    <span class="hljs-comment"># 长度和布尔值</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""len() 时调用（返回维度）"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__bool__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""bool() 时调用"""</span>
        <span class="hljs-keyword">return</span> self.x != <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> self.y != <span class="hljs-number">0</span>
    
    <span class="hljs-comment"># 调用对象</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, scale=<span class="hljs-number">1</span></span>):
        <span class="hljs-string">"""对象被调用时"""</span>
        <span class="hljs-keyword">return</span> Vector(self.x * scale, self.y * scale)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"创建向量："</span>)
v1 = Vector(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)
v2 = Vector(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"v1 = <span class="hljs-subst">{v1}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"v2 = <span class="hljs-subst">{v2}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nv1 + v2 = <span class="hljs-subst">{v1 + v2}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"v1 - v2 = <span class="hljs-subst">{v1 - v2}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"v1 * 2 = <span class="hljs-subst">{v1 * <span class="hljs-number">2</span>}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nv1 == v2: <span class="hljs-subst">{v1 == v2}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"v1 &lt; v2: <span class="hljs-subst">{v1 &lt; v2}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nlen(v1): <span class="hljs-subst">{<span class="hljs-built_in">len</span>(v1)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"bool(v1): <span class="hljs-subst">{<span class="hljs-built_in">bool</span>(v1)}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nv1(2): <span class="hljs-subst">{v1(<span class="hljs-number">2</span>)}</span>"</span>)  <span class="hljs-comment"># 调用对象</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 属性访问特殊方法 ==="</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-string">"""演示属性访问特殊方法"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self._age = age  <span class="hljs-comment"># 私有属性</span>
    
    <span class="hljs-comment"># 属性访问</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattr__</span>(<span class="hljs-params">self, name</span>):
        <span class="hljs-string">"""访问不存在的属性时调用"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"__getattr__: 尝试访问不存在的属性 '<span class="hljs-subst">{name}</span>'"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__setattr__</span>(<span class="hljs-params">self, name, value</span>):
        <span class="hljs-string">"""设置属性时调用"""</span>
        <span class="hljs-keyword">if</span> name == <span class="hljs-string">'_age'</span> <span class="hljs-keyword">and</span> value &lt; <span class="hljs-number">0</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"年龄不能为负数！"</span>)
            <span class="hljs-keyword">return</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"__setattr__: 设置属性 <span class="hljs-subst">{name}</span> = <span class="hljs-subst">{value}</span>"</span>)
        <span class="hljs-built_in">super</span>().__setattr__(name, value)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__delattr__</span>(<span class="hljs-params">self, name</span>):
        <span class="hljs-string">"""删除属性时调用"""</span>
        <span class="hljs-keyword">if</span> name == <span class="hljs-string">'name'</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"不能删除姓名属性！"</span>)
            <span class="hljs-keyword">return</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"__delattr__: 删除属性 <span class="hljs-subst">{name}</span>"</span>)
        <span class="hljs-built_in">super</span>().__delattr__(name)

person = Person(<span class="hljs-string">"小明"</span>, <span class="hljs-number">25</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"姓名：<span class="hljs-subst">{person.name}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"年龄：<span class="hljs-subst">{person._age}</span>"</span>)

person.salary = <span class="hljs-number">5000</span>  <span class="hljs-comment"># 设置新属性</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"薪水：<span class="hljs-subst">{person.salary}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"不存在的属性：<span class="hljs-subst">{person.address}</span>"</span>)  <span class="hljs-comment"># 访问不存在的属性</span>

<span class="hljs-keyword">del</span> person.salary  <span class="hljs-comment"># 删除属性</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"删除后：<span class="hljs-subst">{person.salary}</span>"</span>)
</code></pre>
<h2 data-id="heading-20">七、实战应用：函数式数据处理管道</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 实战：函数式数据处理管道 ==="</span>)

<span class="hljs-comment"># 创建示例数据</span>
students = [
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-string">"age"</span>: <span class="hljs-number">18</span>, <span class="hljs-string">"scores"</span>: {<span class="hljs-string">"math"</span>: <span class="hljs-number">85</span>, <span class="hljs-string">"english"</span>: <span class="hljs-number">92</span>, <span class="hljs-string">"chinese"</span>: <span class="hljs-number">78</span>}},
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"李四"</span>, <span class="hljs-string">"age"</span>: <span class="hljs-number">17</span>, <span class="hljs-string">"scores"</span>: {<span class="hljs-string">"math"</span>: <span class="hljs-number">92</span>, <span class="hljs-string">"english"</span>: <span class="hljs-number">88</span>, <span class="hljs-string">"chinese"</span>: <span class="hljs-number">95</span>}},
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"王五"</span>, <span class="hljs-string">"age"</span>: <span class="hljs-number">19</span>, <span class="hljs-string">"scores"</span>: {<span class="hljs-string">"math"</span>: <span class="hljs-number">76</span>, <span class="hljs-string">"english"</span>: <span class="hljs-number">85</span>, <span class="hljs-string">"chinese"</span>: <span class="hljs-number">90</span>}},
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"赵六"</span>, <span class="hljs-string">"age"</span>: <span class="hljs-number">18</span>, <span class="hljs-string">"scores"</span>: {<span class="hljs-string">"math"</span>: <span class="hljs-number">88</span>, <span class="hljs-string">"english"</span>: <span class="hljs-number">92</span>, <span class="hljs-string">"chinese"</span>: <span class="hljs-number">86</span>}},
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"钱七"</span>, <span class="hljs-string">"age"</span>: <span class="hljs-number">17</span>, <span class="hljs-string">"scores"</span>: {<span class="hljs-string">"math"</span>: <span class="hljs-number">95</span>, <span class="hljs-string">"english"</span>: <span class="hljs-number">79</span>, <span class="hljs-string">"chinese"</span>: <span class="hljs-number">88</span>}},
]

<span class="hljs-comment"># 1. 纯函数：不修改外部状态，相同输入总是得到相同输出</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_average</span>(<span class="hljs-params">student</span>):
    <span class="hljs-string">"""计算学生的平均分"""</span>
    scores = student[<span class="hljs-string">"scores"</span>].values()
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(scores) / <span class="hljs-built_in">len</span>(scores)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_average</span>(<span class="hljs-params">student</span>):
    <span class="hljs-string">"""添加平均分到学生信息（返回新字典）"""</span>
    student_copy = student.copy()
    student_copy[<span class="hljs-string">"average"</span>] = calculate_average(student)
    <span class="hljs-keyword">return</span> student_copy

<span class="hljs-comment"># 2. 高阶函数：处理数据管道</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_students</span>(<span class="hljs-params">students, *processors</span>):
    <span class="hljs-string">"""处理学生数据管道"""</span>
    result = students
    <span class="hljs-keyword">for</span> processor <span class="hljs-keyword">in</span> processors:
        result = processor(result)
    <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># 3. 数据处理函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_average_to_all</span>(<span class="hljs-params">students</span>):
    <span class="hljs-string">"""为所有学生添加平均分"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(add_average, students))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_by_age</span>(<span class="hljs-params">students, min_age=<span class="hljs-number">18</span></span>):
    <span class="hljs-string">"""过滤年龄"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> s: s[<span class="hljs-string">"age"</span>] &gt;= min_age, students))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sort_by_average</span>(<span class="hljs-params">students, reverse=<span class="hljs-literal">True</span></span>):
    <span class="hljs-string">"""按平均分排序"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sorted</span>(students, key=<span class="hljs-keyword">lambda</span> s: s.get(<span class="hljs-string">"average"</span>, <span class="hljs-number">0</span>), reverse=reverse)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_top_n</span>(<span class="hljs-params">students, n=<span class="hljs-number">3</span></span>):
    <span class="hljs-string">"""获取前N名学生"""</span>
    <span class="hljs-keyword">return</span> students[:n]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">format_output</span>(<span class="hljs-params">students</span>):
    <span class="hljs-string">"""格式化输出"""</span>
    <span class="hljs-keyword">return</span> [<span class="hljs-string">f"<span class="hljs-subst">{s[<span class="hljs-string">'name'</span>]}</span>（<span class="hljs-subst">{s[<span class="hljs-string">'age'</span>]}</span>岁）: 平均分<span class="hljs-subst">{s[<span class="hljs-string">'average'</span>]:<span class="hljs-number">.1</span>f}</span>"</span> <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> students]

<span class="hljs-comment"># 4. 组合函数</span>
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial

<span class="hljs-comment"># 创建部分函数</span>
filter_adults = partial(filter_by_age, min_age=<span class="hljs-number">18</span>)
get_top_3 = partial(get_top_n, n=<span class="hljs-number">3</span>)

<span class="hljs-comment"># 5. 构建数据处理管道</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"数据处理管道：添加平均分 → 过滤成年人 → 按平均分排序 → 取前三名"</span>)

result = process_students(
    students,
    add_average_to_all,
    filter_adults,
    <span class="hljs-keyword">lambda</span> s: sort_by_average(s, reverse=<span class="hljs-literal">True</span>),
    get_top_3,
    format_output
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n结果："</span>)
<span class="hljs-keyword">for</span> i, student <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(result, <span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{i}</span>. <span class="hljs-subst">{student}</span>"</span>)

<span class="hljs-comment"># 6. 使用装饰器记录处理步骤</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_step</span>(<span class="hljs-params">step_name</span>):
    <span class="hljs-string">"""记录处理步骤的装饰器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func</span>):
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">students</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"步骤：<span class="hljs-subst">{step_name}</span> (处理<span class="hljs-subst">{<span class="hljs-built_in">len</span>(students)}</span>名学生)"</span>)
            result = func(students)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  结果：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(result)}</span>名学生"</span>)
            <span class="hljs-keyword">return</span> result
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 带日志的数据处理管道 ==="</span>)

<span class="hljs-meta">@log_step(<span class="hljs-params"><span class="hljs-string">"添加平均分"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_average_with_log</span>(<span class="hljs-params">students</span>):
    <span class="hljs-keyword">return</span> add_average_to_all(students)

<span class="hljs-meta">@log_step(<span class="hljs-params"><span class="hljs-string">"过滤成年人"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_adults_with_log</span>(<span class="hljs-params">students</span>):
    <span class="hljs-keyword">return</span> filter_adults(students)

<span class="hljs-meta">@log_step(<span class="hljs-params"><span class="hljs-string">"按平均分排序"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sort_by_average_with_log</span>(<span class="hljs-params">students</span>):
    <span class="hljs-keyword">return</span> sort_by_average(students, reverse=<span class="hljs-literal">True</span>)

<span class="hljs-meta">@log_step(<span class="hljs-params"><span class="hljs-string">"取前三名"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_top_3_with_log</span>(<span class="hljs-params">students</span>):
    <span class="hljs-keyword">return</span> get_top_3(students)

final_result = process_students(
    students,
    add_average_with_log,
    filter_adults_with_log,
    sort_by_average_with_log,
    get_top_3_with_log,
    format_output
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n最终结果："</span>)
<span class="hljs-keyword">for</span> i, student <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(final_result, <span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{i}</span>. <span class="hljs-subst">{student}</span>"</span>)
</code></pre>
<h2 data-id="heading-21">八、总结：Python函数的核心要点</h2>
<h3 data-id="heading-22">🎯 核心要点总结：</h3>
<ol>
<li>
<p><strong>函数定义</strong>：使用<code>def</code>关键字，可以带参数和返回值</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">function_name</span>(<span class="hljs-params">parameters</span>):
    <span class="hljs-string">"""文档字符串"""</span>
    <span class="hljs-comment"># 函数体</span>
    <span class="hljs-keyword">return</span> value
</code></pre>
</li>
<li>
<p><strong>四种参数类型</strong>：</p>
<ul>
<li><strong>位置参数</strong>：按顺序传递</li>
<li><strong>关键字参数</strong>：指定参数名</li>
<li><strong>默认参数</strong>：参数有默认值</li>
<li><strong>可变参数</strong>：<code>*args</code>和<code>**kwargs</code></li>
</ul>
</li>
<li>
<p><strong>装饰器</strong>：增强函数功能的强大工具</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">function</span>():
    <span class="hljs-keyword">pass</span>
</code></pre>
</li>
<li>
<p><strong>Lambda表达式</strong>：匿名函数，简洁高效</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">lambda</span> x: x**<span class="hljs-number">2</span>
</code></pre>
</li>
<li>
<p><strong>生成器</strong>：使用<code>yield</code>，节省内存</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">generator</span>():
    <span class="hljs-keyword">yield</span> value
</code></pre>
</li>
<li>
<p><strong>闭包</strong>：函数中的函数，可以"记住"外部变量</p>
</li>
</ol>
<h3 data-id="heading-23">💡 最佳实践：</h3>
<ol>
<li>
<p><strong>一个函数只做一件事</strong>：保持函数简洁，功能单一</p>
</li>
<li>
<p><strong>使用有意义的函数名</strong>：函数名应该描述函数的功能</p>
</li>
<li>
<p><strong>编写文档字符串</strong>：解释函数的作用、参数和返回值</p>
</li>
<li>
<p><strong>使用类型提示</strong>（Python 3.5+）：提高代码可读性</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-keyword">return</span> a + b
</code></pre>
</li>
<li>
<p><strong>避免副作用</strong>：纯函数更容易测试和维护</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python模块与包：构建可维护的代码结构]]></title>    <link>https://juejin.cn/post/7587368168622817286</link>    <guid>https://juejin.cn/post/7587368168622817286</guid>    <pubDate>2025-12-25T05:31:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587368168622817286" data-draft-id="7587349016222973993" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python模块与包：构建可维护的代码结构"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-25T05:31:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python模块与包：构建可维护的代码结构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T05:31:20.000Z" title="Thu Dec 25 2025 05:31:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>在Python编程中，模块和包就像乐高积木的盒子——它们帮助你把相关的代码组织在一起，让大型项目变得井然有序。今天，我们来学习如何将Python代码组织成模块和包，构建可维护的代码结构！</p>
<h2 data-id="heading-0">引入：为什么需要模块和包？</h2>
<p>想象一下，你正在开发一个电商网站：</p>
<ul>
<li>需要处理用户认证</li>
<li>需要管理商品</li>
<li>需要处理订单</li>
<li>需要与数据库交互</li>
</ul>
<p>如果不使用模块和包，你可能会有一个巨大的文件，里面包含所有功能，这样的代码：</p>
<ol>
<li>难以阅读和维护</li>
<li>难以多人协作开发</li>
<li>难以重用特定功能</li>
</ol>
<p>使用模块和包，你可以：</p>
<ul>
<li>将用户认证代码放在 <code>auth.py</code> 模块中</li>
<li>将商品管理代码放在 <code>products.py</code> 模块中</li>
<li>将订单处理代码放在 <code>orders.py</code> 模块中</li>
<li>将所有相关模块组织在 <code>ecommerce</code> 包中</li>
</ul>
<p>这就是模块化和代码组织的魅力！</p>
<h2 data-id="heading-1">一、模块基础：创建和使用模块</h2>
<h3 data-id="heading-2">1.1 什么是模块？</h3>
<p><strong>模块</strong>就是一个包含Python代码的 <code>.py</code> 文件。模块可以包含：</p>
<ul>
<li>函数</li>
<li>类</li>
<li>变量</li>
<li>可执行代码</li>
</ul>
<h3 data-id="heading-3">1.2 创建第一个模块</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建一个名为 calculator.py 的模块</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 创建和使用模块 ===\n"</span>)

<span class="hljs-comment"># calculator.py 的内容如下：</span>
<span class="hljs-string">"""
calculator.py - 一个简单的计算器模块

这个模块包含基本的数学运算函数。
"""</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-string">"""返回两个数的和"""</span>
    <span class="hljs-keyword">return</span> a + b

<span class="hljs-keyword">def</span> <span class="hljs-title function_">subtract</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-string">"""返回两个数的差"""</span>
    <span class="hljs-keyword">return</span> a - b

<span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-string">"""返回两个数的积"""</span>
    <span class="hljs-keyword">return</span> a * b

<span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-string">"""
    返回两个数的商
    如果除数为0，返回None
    """</span>
    <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">return</span> a / b

<span class="hljs-comment"># 模块级别的变量</span>
PI = <span class="hljs-number">3.141592653589793</span>
VERSION = <span class="hljs-string">"1.0.0"</span>

<span class="hljs-comment"># 模块级别的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_version</span>():
    <span class="hljs-string">"""返回模块版本"""</span>
    <span class="hljs-keyword">return</span> VERSION

<span class="hljs-comment"># 模块测试代码（通常放在最后）</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 只有当直接运行这个模块时才执行</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试计算器模块："</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 + 3 = <span class="hljs-subst">{add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 - 3 = <span class="hljs-subst">{subtract(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 * 3 = <span class="hljs-subst">{multiply(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 / 3 = <span class="hljs-subst">{divide(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>):<span class="hljs-number">.2</span>f}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 / 0 = <span class="hljs-subst">{divide(<span class="hljs-number">5</span>, <span class="hljs-number">0</span>)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PI = <span class="hljs-subst">{PI}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"版本：<span class="hljs-subst">{get_version()}</span>"</span>)
</code></pre>
<h3 data-id="heading-4">1.3 使用模块</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># main.py - 使用计算器模块</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 使用模块 ===\n"</span>)

<span class="hljs-comment"># 方法1：导入整个模块</span>
<span class="hljs-keyword">import</span> calculator

<span class="hljs-built_in">print</span>(<span class="hljs-string">"方法1：导入整个模块"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 + 3 = <span class="hljs-subst">{calculator.add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"PI = <span class="hljs-subst">{calculator.PI}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"版本：<span class="hljs-subst">{calculator.get_version()}</span>\n"</span>)

<span class="hljs-comment"># 方法2：导入特定函数/变量</span>
<span class="hljs-keyword">from</span> calculator <span class="hljs-keyword">import</span> add, subtract, PI

<span class="hljs-built_in">print</span>(<span class="hljs-string">"方法2：导入特定函数/变量"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 + 3 = <span class="hljs-subst">{add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 - 3 = <span class="hljs-subst">{subtract(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"PI = <span class="hljs-subst">{PI}</span>\n"</span>)

<span class="hljs-comment"># 方法3：导入所有内容（不推荐）</span>
<span class="hljs-keyword">from</span> calculator <span class="hljs-keyword">import</span> *

<span class="hljs-built_in">print</span>(<span class="hljs-string">"方法3：导入所有内容"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 * 3 = <span class="hljs-subst">{multiply(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 / 3 = <span class="hljs-subst">{divide(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>):<span class="hljs-number">.2</span>f}</span>\n"</span>)

<span class="hljs-comment"># 方法4：给模块起别名</span>
<span class="hljs-keyword">import</span> calculator <span class="hljs-keyword">as</span> calc

<span class="hljs-built_in">print</span>(<span class="hljs-string">"方法4：给模块起别名"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"calc.add(5, 3) = <span class="hljs-subst">{calc.add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"calc.VERSION = <span class="hljs-subst">{calc.VERSION}</span>\n"</span>)

<span class="hljs-comment"># 方法5：给函数起别名</span>
<span class="hljs-keyword">from</span> calculator <span class="hljs-keyword">import</span> add <span class="hljs-keyword">as</span> addition

<span class="hljs-built_in">print</span>(<span class="hljs-string">"方法5：给函数起别名"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"addition(5, 3) = <span class="hljs-subst">{addition(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 查看模块信息 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"模块名：<span class="hljs-subst">{calculator.__name__}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件位置：<span class="hljs-subst">{calculator.__file__}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"文档字符串：<span class="hljs-subst">{calculator.__doc__}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"模块中的所有名称：<span class="hljs-subst">{<span class="hljs-built_in">dir</span>(calculator)[:<span class="hljs-number">10</span>]}</span>..."</span>)  <span class="hljs-comment"># 只显示前10个</span>
</code></pre>
<h3 data-id="heading-5">1.4 模块搜索路径</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== Python模块搜索路径 ==="</span>)

<span class="hljs-keyword">import</span> sys

<span class="hljs-built_in">print</span>(<span class="hljs-string">"Python搜索模块的路径："</span>)
<span class="hljs-keyword">for</span> i, path <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sys.path, <span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i:<span class="hljs-number">2</span>}</span>. <span class="hljs-subst">{path}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 自定义模块搜索路径 ==="</span>)

<span class="hljs-comment"># 添加自定义路径到模块搜索路径</span>
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 创建自定义模块目录</span>
custom_dir = <span class="hljs-string">"my_modules"</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(custom_dir):
    os.makedirs(custom_dir)

<span class="hljs-comment"># 创建一个简单的模块</span>
module_content = <span class="hljs-string">'''
def hello():
    return "来自自定义模块的问候！"

def add(a, b):
    return a + b
'''</span>

<span class="hljs-comment"># 将模块保存到自定义目录</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(os.path.join(custom_dir, <span class="hljs-string">"mymodule.py"</span>), <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(module_content)

<span class="hljs-comment"># 添加自定义目录到搜索路径</span>
sys.path.append(os.path.abspath(custom_dir))

<span class="hljs-comment"># 现在可以导入自定义模块</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">import</span> mymodule
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功导入自定义模块：<span class="hljs-subst">{mymodule.hello()}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"mymodule.add(5, 3) = <span class="hljs-subst">{mymodule.add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
<span class="hljs-keyword">except</span> ImportError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"导入失败：<span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 动态导入模块 ==="</span>)

<span class="hljs-comment"># 有时我们需要在运行时决定导入哪个模块</span>
module_name = <span class="hljs-string">"calculator"</span>  <span class="hljs-comment"># 可以是变量</span>

<span class="hljs-comment"># 方法1：使用__import__</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"方法1：使用 __import__"</span>)
<span class="hljs-keyword">try</span>:
    calc_module = <span class="hljs-built_in">__import__</span>(module_name)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"导入成功：<span class="hljs-subst">{calc_module.add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
<span class="hljs-keyword">except</span> ImportError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"无法导入模块：<span class="hljs-subst">{module_name}</span>"</span>)

<span class="hljs-comment"># 方法2：使用importlib（推荐）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n方法2：使用 importlib"</span>)
<span class="hljs-keyword">import</span> importlib

<span class="hljs-keyword">try</span>:
    calc_module = importlib.import_module(module_name)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"导入成功：<span class="hljs-subst">{calc_module.subtract(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)}</span>"</span>)
<span class="hljs-keyword">except</span> ImportError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"无法导入模块：<span class="hljs-subst">{module_name}</span>"</span>)
</code></pre>
<h2 data-id="heading-6">二、包：组织模块的容器</h2>
<h3 data-id="heading-7">2.1 什么是包？</h3>
<p><strong>包</strong>是一个包含多个模块的目录。包必须包含一个特殊的文件：<code>__init__.py</code>（Python 3.3+ 中可以是空文件，但推荐包含内容）。</p>
<h3 data-id="heading-8">2.2 创建包的结构</h3>
<pre><code class="hljs language-python" lang="python">ecommerce/                    <span class="hljs-comment"># 包目录</span>
├── __init__.py              <span class="hljs-comment"># 包初始化文件</span>
├── products.py              <span class="hljs-comment"># 商品模块</span>
├── orders.py                <span class="hljs-comment"># 订单模块</span>
├── auth.py                  <span class="hljs-comment"># 认证模块</span>
├── database/                <span class="hljs-comment"># 子包</span>
│   ├── __init__.py
│   ├── connection.py
│   └── models.py
└── utils/                   <span class="hljs-comment"># 另一个子包</span>
    ├── __init__.py
    ├── validators.py
    └── helpers.py
</code></pre>
<h3 data-id="heading-9">2.3 创建包和子包</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建ecommerce包及其模块</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 创建和使用包 ==="</span>)

<span class="hljs-comment"># 首先创建目录结构</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> shutil

<span class="hljs-comment"># 清理旧的测试目录</span>
<span class="hljs-keyword">if</span> os.path.exists(<span class="hljs-string">"ecommerce"</span>):
    shutil.rmtree(<span class="hljs-string">"ecommerce"</span>)

<span class="hljs-comment"># 创建目录结构</span>
os.makedirs(<span class="hljs-string">"ecommerce/database"</span>)
os.makedirs(<span class="hljs-string">"ecommerce/utils"</span>)

<span class="hljs-comment"># 创建 __init__.py 文件</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"创建包和子包..."</span>)

<span class="hljs-comment"># ecommerce/__init__.py</span>
init_content = <span class="hljs-string">'''
"""
ecommerce包 - 电子商务系统

这个包包含电子商务网站的核心功能。
"""

__version__ = "1.0.0"
__author__ = "Python开发者"

# 导入包级别的功能
from .products import Product
from .orders import Order
from .auth import authenticate

# 包级别的变量
SITE_NAME = "我的电商网站"

def get_version():
    """返回包版本"""
    return __version__
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"ecommerce/__init__.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(init_content)

<span class="hljs-comment"># ecommerce/products.py</span>
products_content = <span class="hljs-string">'''
class Product:
    """商品类"""
    
    def __init__(self, name, price, category):
        self.name = name
        self.price = price
        self.category = category
    
    def display_info(self):
        """显示商品信息"""
        return f"{self.name} - ¥{self.price:.2f} ({self.category})"
    
    def apply_discount(self, discount_percent):
        """应用折扣"""
        discounted_price = self.price * (1 - discount_percent / 100)
        return discounted_price

def create_product(name, price, category):
    """创建商品"""
    return Product(name, price, category)

def calculate_total(products):
    """计算商品总价"""
    return sum(product.price for product in products)
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"ecommerce/products.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(products_content)

<span class="hljs-comment"># ecommerce/orders.py</span>
orders_content = <span class="hljs-string">'''
class Order:
    """订单类"""
    
    def __init__(self, order_id, customer, products):
        self.order_id = order_id
        self.customer = customer
        self.products = products
        self.status = "pending"
    
    def calculate_total(self):
        """计算订单总额"""
        return sum(product.price for product in self.products)
    
    def update_status(self, new_status):
        """更新订单状态"""
        valid_statuses = ["pending", "processing", "shipped", "delivered", "cancelled"]
        if new_status in valid_statuses:
            self.status = new_status
            return True
        return False
    
    def display_order(self):
        """显示订单信息"""
        total = self.calculate_total()
        return f"订单 #{self.order_id} - 客户: {self.customer}, 总额: ¥{total:.2f}, 状态: {self.status}"
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"ecommerce/orders.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(orders_content)

<span class="hljs-comment"># ecommerce/auth.py</span>
auth_content = <span class="hljs-string">'''
def authenticate(username, password):
    """用户认证"""
    # 这里应该是数据库查询，这里用硬编码演示
    users = {
        "admin": "admin123",
        "user1": "password1",
        "user2": "password2"
    }
    
    if username in users and users[username] == password:
        return True, f"欢迎回来，{username}！"
    else:
        return False, "用户名或密码错误"

def register(username, password, email):
    """用户注册"""
    # 这里应该有数据库操作，这里只是演示
    return True, f"用户 {username} 注册成功！"

def logout(username):
    """用户退出"""
    return f"用户 {username} 已退出登录"
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"ecommerce/auth.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(auth_content)

<span class="hljs-comment"># ecommerce/database/__init__.py</span>
db_init_content = <span class="hljs-string">'''
"""
数据库子包
"""
from .connection import DatabaseConnection
from .models import User, ProductModel

__all__ = ['DatabaseConnection', 'User', 'ProductModel']
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"ecommerce/database/__init__.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(db_init_content)

<span class="hljs-comment"># ecommerce/database/connection.py</span>
connection_content = <span class="hljs-string">'''
class DatabaseConnection:
    """数据库连接类"""
    
    def __init__(self, host, port, database):
        self.host = host
        self.port = port
        self.database = database
        self.connected = False
    
    def connect(self):
        """连接数据库"""
        self.connected = True
        return f"已连接到 {self.host}:{self.port}/{self.database}"
    
    def disconnect(self):
        """断开数据库连接"""
        self.connected = False
        return "数据库连接已断开"
    
    def execute_query(self, query):
        """执行查询"""
        if self.connected:
            return f"执行查询: {query}"
        else:
            return "错误：数据库未连接"
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"ecommerce/database/connection.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(connection_content)

<span class="hljs-comment"># ecommerce/database/models.py</span>
models_content = <span class="hljs-string">'''
class User:
    """用户模型"""
    
    def __init__(self, user_id, username, email):
        self.user_id = user_id
        self.username = username
        self.email = email
    
    def to_dict(self):
        """转换为字典"""
        return {
            'user_id': self.user_id,
            'username': self.username,
            'email': self.email
        }

class ProductModel:
    """商品模型"""
    
    def __init__(self, product_id, name, price, stock):
        self.product_id = product_id
        self.name = name
        self.price = price
        self.stock = stock
    
    def is_available(self):
        """检查是否有库存"""
        return self.stock &gt; 0
    
    def update_stock(self, quantity):
        """更新库存"""
        if self.stock + quantity &gt;= 0:
            self.stock += quantity
            return True
        return False
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"ecommerce/database/models.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(models_content)

<span class="hljs-comment"># ecommerce/utils/__init__.py</span>
utils_init_content = <span class="hljs-string">'''
"""
工具函数子包
"""
from .validators import validate_email, validate_phone
from .helpers import format_price, generate_id

__all__ = ['validate_email', 'validate_phone', 'format_price', 'generate_id']
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"ecommerce/utils/__init__.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(utils_init_content)

<span class="hljs-comment"># ecommerce/utils/validators.py</span>
validators_content = <span class="hljs-string">'''
import re

def validate_email(email):
    """验证邮箱格式"""
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+.[a-zA-Z]{2,}$'
    return bool(re.match(pattern, email))

def validate_phone(phone):
    """验证手机号格式（中国）"""
    pattern = r'^1[3-9]\d{9}$'
    return bool(re.match(pattern, phone))

def validate_password(password):
    """验证密码强度"""
    if len(password) &lt; 8:
        return False, "密码至少8位"
    if not any(c.isupper() for c in password):
        return False, "密码必须包含大写字母"
    if not any(c.islower() for c in password):
        return False, "密码必须包含小写字母"
    if not any(c.isdigit() for c in password):
        return False, "密码必须包含数字"
    return True, "密码强度足够"
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"ecommerce/utils/validators.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(validators_content)

<span class="hljs-comment"># ecommerce/utils/helpers.py</span>
helpers_content = <span class="hljs-string">'''
import random
import string
from datetime import datetime

def format_price(price):
    """格式化价格"""
    return f"¥{price:,.2f}"

def generate_id(prefix="", length=8):
    """生成随机ID"""
    chars = string.ascii_uppercase + string.digits
    random_part = ''.join(random.choices(chars, k=length))
    return f"{prefix}{random_part}"

def get_current_timestamp():
    """获取当前时间戳"""
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def truncate_text(text, max_length=50):
    """截断文本"""
    if len(text) &lt;= max_length:
        return text
    return text[:max_length] + "..."
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"ecommerce/utils/helpers.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(helpers_content)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"包结构创建完成！\n"</span>)

<span class="hljs-comment"># 现在让我们使用这个包</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 使用包 ==="</span>)

<span class="hljs-comment"># 方法1：导入整个包</span>
<span class="hljs-keyword">import</span> ecommerce

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"包版本：<span class="hljs-subst">{ecommerce.get_version()}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"网站名称：<span class="hljs-subst">{ecommerce.SITE_NAME}</span>\n"</span>)

<span class="hljs-comment"># 方法2：从包中导入特定模块</span>
<span class="hljs-keyword">from</span> ecommerce <span class="hljs-keyword">import</span> products

<span class="hljs-comment"># 使用products模块</span>
product1 = products.create_product(<span class="hljs-string">"Python编程书"</span>, <span class="hljs-number">89.90</span>, <span class="hljs-string">"图书"</span>)
product2 = products.create_product(<span class="hljs-string">"无线鼠标"</span>, <span class="hljs-number">129.00</span>, <span class="hljs-string">"电子产品"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"商品1：<span class="hljs-subst">{product1.display_info()}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"商品2：<span class="hljs-subst">{product2.display_info()}</span>"</span>)

<span class="hljs-comment"># 方法3：从包中导入特定类/函数</span>
<span class="hljs-keyword">from</span> ecommerce.orders <span class="hljs-keyword">import</span> Order

order = Order(<span class="hljs-string">"ORD001"</span>, <span class="hljs-string">"张三"</span>, [product1, product2])
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n订单：<span class="hljs-subst">{order.display_order()}</span>"</span>)

<span class="hljs-comment"># 方法4：使用子包</span>
<span class="hljs-keyword">from</span> ecommerce.database <span class="hljs-keyword">import</span> DatabaseConnection
<span class="hljs-keyword">from</span> ecommerce.utils <span class="hljs-keyword">import</span> validate_email, format_price

db_conn = DatabaseConnection(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">5432</span>, <span class="hljs-string">"ecommerce_db"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n数据库连接：<span class="hljs-subst">{db_conn.connect()}</span>"</span>)

email = <span class="hljs-string">"test@example.com"</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n邮箱验证：<span class="hljs-subst">{email}</span> -&gt; <span class="hljs-subst">{validate_email(email)}</span>"</span>)

price = <span class="hljs-number">1234.56</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"价格格式化：<span class="hljs-subst">{price}</span> -&gt; <span class="hljs-subst">{format_price(price)}</span>"</span>)

<span class="hljs-comment"># 方法5：相对导入（在包内部使用）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 包内部的相对导入 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"在包内部的模块中，可以使用相对导入来引用其他模块"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"例如，在 orders.py 中导入 products："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  from . import products  # 导入同级模块"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  from .products import Product  # 从同级模块导入"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  from ..utils import helpers  # 从上级目录导入"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  from .database import models  # 从子包导入"</span>)
</code></pre>
<h3 data-id="heading-10">2.4 <code>__all__</code> 变量</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== __all__ 变量 ==="</span>)

<span class="hljs-comment"># __all__ 变量定义了当使用 from module import * 时导入的内容</span>
<span class="hljs-comment"># 创建示例模块</span>
module_content = <span class="hljs-string">'''
__all__ = ['public_func', 'PublicClass']

def public_func():
    return "这是一个公共函数"

def _private_func():
    return "这是一个私有函数"

class PublicClass:
    def __init__(self):
        self.name = "公共类"

class _PrivateClass:
    def __init__(self):
        self.name = "私有类"

public_var = "公共变量"
_private_var = "私有变量"
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"example_module.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(module_content)

<span class="hljs-comment"># 测试 __all__</span>
<span class="hljs-keyword">from</span> example_module <span class="hljs-keyword">import</span> *

<span class="hljs-built_in">print</span>(<span class="hljs-string">"使用 from example_module import * 后："</span>)
<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"public_func: <span class="hljs-subst">{public_func()}</span>"</span>)
<span class="hljs-keyword">except</span> NameError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误：<span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-keyword">try</span>:
    pc = PublicClass()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PublicClass: <span class="hljs-subst">{pc.name}</span>"</span>)
<span class="hljs-keyword">except</span> NameError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误：<span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"_private_func: <span class="hljs-subst">{_private_func()}</span>"</span>)
<span class="hljs-keyword">except</span> NameError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"_private_func 未导入"</span>)

<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"public_var: <span class="hljs-subst">{public_var}</span>"</span>)
<span class="hljs-keyword">except</span> NameError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"public_var 未导入"</span>)

<span class="hljs-comment"># 清理</span>
<span class="hljs-keyword">import</span> os
os.remove(<span class="hljs-string">"example_module.py"</span>)
</code></pre>
<h2 data-id="heading-11">三、Python标准库模块</h2>
<h3 data-id="heading-12">3.1 常用内置模块</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== Python常用内置模块 ==="</span>)

<span class="hljs-comment"># 1. os - 操作系统接口</span>
<span class="hljs-keyword">import</span> os

<span class="hljs-built_in">print</span>(<span class="hljs-string">"1. os模块 - 操作系统接口"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"当前工作目录: <span class="hljs-subst">{os.getcwd()}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"目录列表: <span class="hljs-subst">{os.listdir(<span class="hljs-string">'.'</span>)[:<span class="hljs-number">5</span>]}</span>..."</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"路径存在: <span class="hljs-subst">{os.path.exists(<span class="hljs-string">'ecommerce'</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"路径是文件: <span class="hljs-subst">{os.path.isfile(<span class="hljs-string">'ecommerce/products.py'</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"路径是目录: <span class="hljs-subst">{os.path.isdir(<span class="hljs-string">'ecommerce'</span>)}</span>\n"</span>)

<span class="hljs-comment"># 2. sys - 系统相关参数和函数</span>
<span class="hljs-keyword">import</span> sys

<span class="hljs-built_in">print</span>(<span class="hljs-string">"2. sys模块 - 系统相关"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Python版本: <span class="hljs-subst">{sys.version_info.major}</span>.<span class="hljs-subst">{sys.version_info.minor}</span>.<span class="hljs-subst">{sys.version_info.micro}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平台: <span class="hljs-subst">{sys.platform}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"默认编码: <span class="hljs-subst">{sys.getdefaultencoding()}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"命令行参数: <span class="hljs-subst">{sys.argv}</span>\n"</span>)

<span class="hljs-comment"># 3. datetime - 日期和时间处理</span>
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, date, time, timedelta

<span class="hljs-built_in">print</span>(<span class="hljs-string">"3. datetime模块 - 日期时间处理"</span>)
now = datetime.now()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"当前时间: <span class="hljs-subst">{now}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"格式化: <span class="hljs-subst">{now.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"日期部分: <span class="hljs-subst">{now.date()}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"时间部分: <span class="hljs-subst">{now.time()}</span>"</span>)

<span class="hljs-comment"># 时间运算</span>
tomorrow = now + timedelta(days=<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"明天: <span class="hljs-subst">{tomorrow.strftime(<span class="hljs-string">'%Y-%m-%d'</span>)}</span>"</span>)

<span class="hljs-comment"># 4. json - JSON数据处理</span>
<span class="hljs-keyword">import</span> json

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n4. json模块 - JSON数据处理"</span>)

<span class="hljs-comment"># Python对象转JSON字符串</span>
data = {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"张三"</span>,
    <span class="hljs-string">"age"</span>: <span class="hljs-number">25</span>,
    <span class="hljs-string">"city"</span>: <span class="hljs-string">"北京"</span>,
    <span class="hljs-string">"skills"</span>: [<span class="hljs-string">"Python"</span>, <span class="hljs-string">"JavaScript"</span>, <span class="hljs-string">"SQL"</span>]
}

json_str = json.dumps(data, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"JSON字符串:\n<span class="hljs-subst">{json_str}</span>"</span>)

<span class="hljs-comment"># JSON字符串转Python对象</span>
parsed_data = json.loads(json_str)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析后姓名: <span class="hljs-subst">{parsed_data[<span class="hljs-string">'name'</span>]}</span>\n"</span>)

<span class="hljs-comment"># 5. random - 生成随机数</span>
<span class="hljs-keyword">import</span> random

<span class="hljs-built_in">print</span>(<span class="hljs-string">"5. random模块 - 随机数生成"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"随机整数(1-100): <span class="hljs-subst">{random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"随机浮点数: <span class="hljs-subst">{random.random()}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"随机选择: <span class="hljs-subst">{random.choice([<span class="hljs-string">'苹果'</span>, <span class="hljs-string">'香蕉'</span>, <span class="hljs-string">'橙子'</span>])}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"随机样本: <span class="hljs-subst">{random.sample(<span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>), <span class="hljs-number">5</span>)}</span>\n"</span>)

<span class="hljs-comment"># 6. re - 正则表达式</span>
<span class="hljs-keyword">import</span> re

<span class="hljs-built_in">print</span>(<span class="hljs-string">"6. re模块 - 正则表达式"</span>)
text = <span class="hljs-string">"我的邮箱是 zhangsan@example.com，电话是 138-1234-5678"</span>
email_pattern = <span class="hljs-string">r'[\w.-]+@[\w.-]+.\w+'</span>
phone_pattern = <span class="hljs-string">r'\d{3}-\d{4}-\d{4}'</span>

emails = re.findall(email_pattern, text)
phones = re.findall(phone_pattern, text)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"文本: <span class="hljs-subst">{text}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"找到邮箱: <span class="hljs-subst">{emails}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"找到电话: <span class="hljs-subst">{phones}</span>\n"</span>)

<span class="hljs-comment"># 7. collections - 容器数据类型</span>
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter, defaultdict, namedtuple

<span class="hljs-built_in">print</span>(<span class="hljs-string">"7. collections模块 - 高级容器"</span>)
<span class="hljs-comment"># Counter - 计数器</span>
words = [<span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"apple"</span>, <span class="hljs-string">"orange"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"apple"</span>]
word_count = Counter(words)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"单词计数: <span class="hljs-subst">{word_count}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"最常见的2个: <span class="hljs-subst">{word_count.most_common(<span class="hljs-number">2</span>)}</span>"</span>)

<span class="hljs-comment"># defaultdict - 带默认值的字典</span>
fruit_dict = defaultdict(<span class="hljs-built_in">list</span>)
fruit_dict[<span class="hljs-string">'red'</span>].append(<span class="hljs-string">'apple'</span>)
fruit_dict[<span class="hljs-string">'yellow'</span>].append(<span class="hljs-string">'banana'</span>)
fruit_dict[<span class="hljs-string">'red'</span>].append(<span class="hljs-string">'cherry'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"默认字典: <span class="hljs-subst">{<span class="hljs-built_in">dict</span>(fruit_dict)}</span>"</span>)

<span class="hljs-comment"># namedtuple - 命名元组</span>
Point = namedtuple(<span class="hljs-string">'Point'</span>, [<span class="hljs-string">'x'</span>, <span class="hljs-string">'y'</span>])
p = Point(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"命名元组: <span class="hljs-subst">{p}</span>, x=<span class="hljs-subst">{p.x}</span>, y=<span class="hljs-subst">{p.y}</span>\n"</span>)

<span class="hljs-comment"># 8. itertools - 迭代器工具</span>
<span class="hljs-keyword">import</span> itertools

<span class="hljs-built_in">print</span>(<span class="hljs-string">"8. itertools模块 - 迭代器工具"</span>)
<span class="hljs-comment"># 无限迭代器</span>
counter = itertools.count(start=<span class="hljs-number">10</span>, step=<span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"无限计数前5个: <span class="hljs-subst">{[<span class="hljs-built_in">next</span>(counter) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]}</span>"</span>)

<span class="hljs-comment"># 排列组合</span>
letters = [<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"排列(2个): <span class="hljs-subst">{<span class="hljs-built_in">list</span>(itertools.permutations(letters, <span class="hljs-number">2</span>))}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"组合(2个): <span class="hljs-subst">{<span class="hljs-built_in">list</span>(itertools.combinations(letters, <span class="hljs-number">2</span>))}</span>"</span>)
</code></pre>
<h3 data-id="heading-13">3.2 第三方模块管理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 第三方模块管理 ==="</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"Python有丰富的第三方库，可以使用pip管理："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n常用pip命令："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  安装包: pip install package_name"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  安装特定版本: pip install package_name==1.0.0"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  升级包: pip install --upgrade package_name"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  卸载包: pip uninstall package_name"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  查看已安装包: pip list"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  导出依赖: pip freeze &gt; requirements.txt"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  从文件安装: pip install -r requirements.txt"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n常用第三方库示例："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  1. requests - HTTP请求库"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  2. numpy - 科学计算"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  3. pandas - 数据分析"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  4. matplotlib - 数据可视化"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  5. flask/django - Web框架"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  6. beautifulsoup4 - HTML解析"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  7. pillow - 图像处理"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  8. openpyxl - Excel操作"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 虚拟环境 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"虚拟环境可以隔离不同项目的依赖："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n创建虚拟环境："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  python -m venv myenv"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n激活虚拟环境："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  Windows: myenv\Scripts\activate"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  Mac/Linux: source myenv/bin/activate"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n退出虚拟环境："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"  deactivate"</span>)

<span class="hljs-comment"># 演示requests库的使用（如果已安装）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 使用第三方库：requests ==="</span>)
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">import</span> requests
    
    <span class="hljs-comment"># 发送GET请求</span>
    response = requests.get(<span class="hljs-string">"https://api.github.com"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"GitHub API状态码: <span class="hljs-subst">{response.status_code}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"响应头: <span class="hljs-subst">{<span class="hljs-built_in">dict</span>(response.headers)[:<span class="hljs-number">3</span>]}</span>..."</span>)
    
    <span class="hljs-comment"># 发送带参数的GET请求</span>
    params = {<span class="hljs-string">"q"</span>: <span class="hljs-string">"python"</span>, <span class="hljs-string">"sort"</span>: <span class="hljs-string">"stars"</span>}
    response = requests.get(<span class="hljs-string">"https://api.github.com/search/repositories"</span>, params=params)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"搜索Python仓库，结果数: <span class="hljs-subst">{response.json()[<span class="hljs-string">'total_count'</span>]}</span>"</span>)
    
<span class="hljs-keyword">except</span> ImportError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"requests库未安装，运行 pip install requests 安装"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h2 data-id="heading-14">四、模块高级特性</h2>
<h3 data-id="heading-15">4.1 模块缓存和重新加载</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 模块缓存和重新加载 ==="</span>)

<span class="hljs-keyword">import</span> importlib

<span class="hljs-comment"># 创建测试模块</span>
test_module_content = <span class="hljs-string">'''
message = "原始消息"
def get_message():
    return message
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"test_module.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(test_module_content)

<span class="hljs-comment"># 第一次导入</span>
<span class="hljs-keyword">import</span> test_module
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"第一次导入: <span class="hljs-subst">{test_module.get_message()}</span>"</span>)

<span class="hljs-comment"># 修改模块文件</span>
test_module_content_updated = <span class="hljs-string">'''
message = "更新后的消息"
def get_message():
    return f"更新: {message}"
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"test_module.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(test_module_content_updated)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"修改后直接调用: <span class="hljs-subst">{test_module.get_message()}</span> (仍然是旧版本)"</span>)

<span class="hljs-comment"># 重新加载模块</span>
importlib.reload(test_module)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"重新加载后: <span class="hljs-subst">{test_module.get_message()}</span>"</span>)

<span class="hljs-comment"># 清理</span>
<span class="hljs-keyword">import</span> os
os.remove(<span class="hljs-string">"test_module.py"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 模块缓存位置 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"导入的模块缓存在 sys.modules 中:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"test_module 在缓存中: <span class="hljs-subst">{<span class="hljs-string">'test_module'</span> <span class="hljs-keyword">in</span> sys.modules}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"缓存大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(sys.modules)}</span> 个模块"</span>)

<span class="hljs-comment"># 查看模块缓存</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n前10个缓存的模块:"</span>)
<span class="hljs-keyword">for</span> i, name <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">list</span>(sys.modules.keys())[:<span class="hljs-number">10</span>], <span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{i:<span class="hljs-number">2</span>}</span>. <span class="hljs-subst">{name}</span>"</span>)
</code></pre>
<h3 data-id="heading-16">4.2 动态模块创建</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 动态创建模块 ==="</span>)

<span class="hljs-keyword">import</span> types

<span class="hljs-comment"># 创建一个模块对象</span>
dynamic_module = types.ModuleType(<span class="hljs-string">"dynamic_module"</span>)

<span class="hljs-comment"># 添加内容到模块</span>
dynamic_module.value = <span class="hljs-number">42</span>
dynamic_module.hello = <span class="hljs-keyword">lambda</span>: <span class="hljs-string">"Hello from dynamic module!"</span>

<span class="hljs-comment"># 添加到sys.modules以便可以导入</span>
sys.modules[<span class="hljs-string">"dynamic_module"</span>] = dynamic_module

<span class="hljs-comment"># 现在可以像普通模块一样导入</span>
<span class="hljs-keyword">import</span> dynamic_module <span class="hljs-keyword">as</span> dm
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"动态模块值: <span class="hljs-subst">{dm.value}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"动态模块函数: <span class="hljs-subst">{dm.hello()}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 从字符串创建模块 ==="</span>)

<span class="hljs-comment"># 从字符串创建模块</span>
module_code = <span class="hljs-string">"""
def greet(name):
    return f"Hello, {name}!"

def calculate(a, b):
    return a + b, a - b, a * b, a / b

CONSTANT = "这是一个常量"
"""</span>

<span class="hljs-comment"># 编译并执行模块代码</span>
compiled_code = <span class="hljs-built_in">compile</span>(module_code, <span class="hljs-string">"&lt;string&gt;"</span>, <span class="hljs-string">"exec"</span>)
string_module = types.ModuleType(<span class="hljs-string">"string_module"</span>)
<span class="hljs-built_in">exec</span>(compiled_code, string_module.__dict__)

<span class="hljs-comment"># 使用模块</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"常量: <span class="hljs-subst">{string_module.CONSTANT}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"问候: <span class="hljs-subst">{string_module.greet(<span class="hljs-string">'Python'</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"计算: <span class="hljs-subst">{string_module.calculate(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>)}</span>"</span>)
</code></pre>
<h3 data-id="heading-17">4.3 模块单例模式</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 模块单例模式 ==="</span>)

<span class="hljs-comment"># 在Python中，模块天然就是单例的</span>
<span class="hljs-comment"># 当模块第一次被导入时，它被初始化并缓存</span>
<span class="hljs-comment"># 后续导入都使用同一个实例</span>

<span class="hljs-comment"># singleton.py 内容</span>
singleton_content = <span class="hljs-string">'''
class DatabaseConnection:
    """数据库连接单例"""
    
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance.connection_count = 0
        return cls._instance
    
    def connect(self):
        self.connection_count += 1
        return f"连接 #{self.connection_count}"
    
    def get_connection_count(self):
        return self.connection_count

# 创建单例实例
db = DatabaseConnection()
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"singleton.py"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> f:
    f.write(singleton_content)

<span class="hljs-comment"># 在不同地方导入</span>
<span class="hljs-keyword">import</span> singleton <span class="hljs-keyword">as</span> s1
<span class="hljs-keyword">import</span> singleton <span class="hljs-keyword">as</span> s2  <span class="hljs-comment"># 实际上是同一个模块</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"s1.db is s2.db: <span class="hljs-subst">{s1.db <span class="hljs-keyword">is</span> s2.db}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"s1.db.connect(): <span class="hljs-subst">{s1.db.connect()}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"s2.db.connect(): <span class="hljs-subst">{s2.db.connect()}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"连接次数: <span class="hljs-subst">{s1.db.get_connection_count()}</span>"</span>)

<span class="hljs-comment"># 清理</span>
<span class="hljs-keyword">import</span> os
os.remove(<span class="hljs-string">"singleton.py"</span>)
</code></pre>
<h2 data-id="heading-18">五、实战项目：构建小型Web框架</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 实战：构建小型Web框架 ==="</span>)

<span class="hljs-comment"># 创建一个小型Web框架的结构</span>
web_framework_structure = {
    <span class="hljs-string">"web_framework/__init__.py"</span>: <span class="hljs-string">'''
"""
小型Web框架
"""
from .app import Application
from .request import Request
from .response import Response
from .router import Router

__version__ = "0.1.0"
__all__ = ['Application', 'Request', 'Response', 'Router']
'''</span>,
    
    <span class="hljs-string">"web_framework/app.py"</span>: <span class="hljs-string">'''
"""
应用程序类
"""
from .router import Router
from .request import Request
from .response import Response

class Application:
    """Web应用"""
    
    def __init__(self):
        self.router = Router()
        self.middleware = []
    
    def route(self, path, methods=None):
        """路由装饰器"""
        if methods is None:
            methods = ['GET']
        
        def decorator(handler):
            for method in methods:
                self.router.add_route(method, path, handler)
            return handler
        
        return decorator
    
    def use(self, middleware):
        """添加中间件"""
        self.middleware.append(middleware)
    
    def handle_request(self, environ):
        """处理请求"""
        # 创建请求对象
        request = Request(environ)
        
        # 执行中间件
        for middleware in self.middleware:
            middleware(request)
        
        # 路由匹配
        handler, params = self.router.match(request.method, request.path)
        
        if handler:
            # 执行处理器
            response = handler(request, **params)
            if isinstance(response, str):
                response = Response(body=response)
            return response
        else:
            # 404 未找到
            return Response(status=404, body="404 Not Found")
    
    def __call__(self, environ, start_response):
        """WSGI接口"""
        response = self.handle_request(environ)
        start_response(response.status, response.headers)
        return [response.body.encode('utf-8')]
'''</span>,
    
    <span class="hljs-string">"web_framework/request.py"</span>: <span class="hljs-string">'''
"""
请求类
"""
class Request:
    """HTTP请求"""
    
    def __init__(self, environ):
        self.environ = environ
        self.method = environ.get('REQUEST_METHOD', 'GET')
        self.path = environ.get('PATH_INFO', '/')
        self.query_string = environ.get('QUERY_STRING', '')
        self.headers = {}
        
        # 解析头部
        for key, value in environ.items():
            if key.startswith('HTTP_'):
                header_name = key[5:].replace('_', '-').title()
                self.headers[header_name] = value
    
    def get_header(self, name):
        """获取头部"""
        return self.headers.get(name)
    
    @property
    def query_params(self):
        """查询参数"""
        from urllib.parse import parse_qs
        return parse_qs(self.query_string)
'''</span>,
    
    <span class="hljs-string">"web_framework/response.py"</span>: <span class="hljs-string">'''
"""
响应类
"""
class Response:
    """HTTP响应"""
    
    def __init__(self, status=200, body="", content_type="text/html; charset=utf-8"):
        self.status = f"{status} OK" if status == 200 else f"{status}"
        self.body = body
        self.headers = [
            ('Content-Type', content_type),
            ('Content-Length', str(len(body.encode('utf-8'))))
        ]
    
    def set_header(self, name, value):
        """设置头部"""
        self.headers.append((name, value))
    
    def json(self, data):
        """返回JSON响应"""
        import json
        self.body = json.dumps(data)
        self.headers = [
            ('Content-Type', 'application/json'),
            ('Content-Length', str(len(self.body.encode('utf-8'))))
        ]
        return self
'''</span>,
    
    <span class="hljs-string">"web_framework/router.py"</span>: <span class="hljs-string">'''
"""
路由器类
"""
import re

class Route:
    """路由"""
    
    def __init__(self, pattern, handler):
        self.pattern = pattern
        self.handler = handler
        self.regex = self._compile_pattern(pattern)
    
    def _compile_pattern(self, pattern):
        """编译路由模式为正则表达式"""
        # 将 :param 转换为 (?P&lt;param&gt;[^/]+)
        regex_pattern = re.sub(r':(\w+)', r'(?P&lt;\1&gt;[^/]+)', pattern)
        return re.compile(f'^{regex_pattern}$')
    
    def match(self, path):
        """匹配路径"""
        match = self.regex.match(path)
        if match:
            return True, match.groupdict()
        return False, {}

class Router:
    """路由器"""
    
    def __init__(self):
        self.routes = {}  # method -&gt; list of routes
    
    def add_route(self, method, pattern, handler):
        """添加路由"""
        if method not in self.routes:
            self.routes[method] = []
        
        route = Route(pattern, handler)
        self.routes[method].append(route)
    
    def match(self, method, path):
        """匹配路由"""
        if method not in self.routes:
            return None, {}
        
        for route in self.routes[method]:
            matched, params = route.match(path)
            if matched:
                return route.handler, params
        
        return None, {}
'''</span>
}

<span class="hljs-comment"># 创建框架文件</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"创建Web框架结构..."</span>)
os.makedirs(<span class="hljs-string">"web_framework"</span>, exist_ok=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">for</span> file_path, content <span class="hljs-keyword">in</span> web_framework_structure.items():
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(content)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"框架创建完成！"</span>)

<span class="hljs-comment"># 使用框架创建应用</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 使用框架创建应用 ==="</span>)

app_content = <span class="hljs-string">'''
from web_framework import Application
from web_framework.response import Response

app = Application()

# 中间件
def logging_middleware(request):
    print(f"[{request.method}] {request.path}")

app.use(logging_middleware)

# 路由
@app.route('/')
def home(request):
    return """
    &lt;html&gt;
    &lt;head&gt;&lt;title&gt;Home&lt;/title&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;欢迎来到我的网站！&lt;/h1&gt;
        &lt;p&gt;这是一个使用自定义Web框架构建的网站。&lt;/p&gt;
        &lt;ul&gt;
            &lt;li&gt;&lt;a href="/about"&gt;关于&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href="/hello/World"&gt;问候&lt;/a&gt;&lt;/li&gt;
            &lt;li&gt;&lt;a href="/api/info"&gt;API信息&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
    &lt;/body&gt;
    &lt;/html&gt;
    """

@app.route('/about')
def about(request):
    return """
    &lt;html&gt;
    &lt;head&gt;&lt;title&gt;About&lt;/title&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;关于我们&lt;/h1&gt;
        &lt;p&gt;这是一个演示Web框架的小型网站。&lt;/p&gt;
        &lt;a href="/"&gt;返回首页&lt;/a&gt;
    &lt;/body&gt;
    &lt;/html&gt;
    """

@app.route('/hello/:name')
def hello(request, name):
    return f"""
    &lt;html&gt;
    &lt;head&gt;&lt;title&gt;Hello {name}&lt;/title&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Hello, {name}!&lt;/h1&gt;
        &lt;p&gt;欢迎来到我们的网站。&lt;/p&gt;
        &lt;a href="/"&gt;返回首页&lt;/a&gt;
    &lt;/body&gt;
    &lt;/html&gt;
    """

@app.route('/api/info')
def api_info(request):
    response = Response()
    return response.json({
        'framework': 'Web Framework',
        'version': '0.1.0',
        'endpoints': ['/', '/about', '/hello/:name', '/api/info']
    })

if __name__ == '__main__':
    # 启动开发服务器
    from wsgiref.simple_server import make_server
    
    print("启动服务器：http://localhost:8000")
    server = make_server('localhost', 8000, app)
    server.serve_forever()
'''</span>

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"myapp.py"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
    f.write(app_content)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"应用创建完成：myapp.py"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"运行 python myapp.py 启动服务器"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"访问 http://localhost:8000 查看网站"</span>)

<span class="hljs-comment"># 清理临时文件（在实际环境中保留）</span>
<span class="hljs-keyword">import</span> shutil
shutil.rmtree(<span class="hljs-string">"web_framework"</span>, ignore_errors=<span class="hljs-literal">True</span>)
shutil.rmtree(<span class="hljs-string">"ecommerce"</span>, ignore_errors=<span class="hljs-literal">True</span>)
os.remove(<span class="hljs-string">"myapp.py"</span>)
</code></pre>
<h2 data-id="heading-19">六、总结：模块与包的核心要点</h2>
<h3 data-id="heading-20">🎯 核心要点总结：</h3>
<ol>
<li>
<p><strong>模块是 <code>.py</code> 文件</strong>：包含Python代码，可以导入和使用</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> module
<span class="hljs-keyword">from</span> module <span class="hljs-keyword">import</span> function
</code></pre>
</li>
<li>
<p><strong>包是包含 <code>__init__.py</code> 的目录</strong>：组织相关模块</p>
<pre><code class="hljs language-python" lang="python">mypackage/
├── __init__.py
├── module1.py
└── module2.py
</code></pre>
</li>
<li>
<p><strong>导入方式</strong>：</p>
<ul>
<li>绝对导入：<code>from package import module</code></li>
<li>相对导入：<code>from . import module</code>（在包内部使用）</li>
</ul>
</li>
<li>
<p><strong>Python路径</strong>：<code>sys.path</code> 定义了模块搜索路径</p>
</li>
</ol>
<h3 data-id="heading-21">💡 最佳实践：</h3>
<ol>
<li><strong>保持模块小巧</strong>：一个模块应该专注于一个功能</li>
<li><strong>使用有意义的名称</strong>：模块名应该描述其功能</li>
<li><strong>编写文档字符串</strong>：解释模块的用途</li>
<li><strong>使用 <code>__all__</code></strong> ：控制 <code>from module import *</code> 的行为</li>
<li><strong>组织包结构</strong>：相关功能放在同一个包中</li>
</ol>
<h3 data-id="heading-22">🚀 高级特性：</h3>
<ul>
<li><strong>动态导入</strong>：<code>importlib.import_module()</code></li>
<li><strong>模块重载</strong>：<code>importlib.reload()</code></li>
<li><strong>模块缓存</strong>：<code>sys.modules</code></li>
<li><strong>单例模式</strong>：模块天然就是单例</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型原理剖析——多头并行 + 潜变量协同：原理、应用与部署优化]]></title>    <link>https://juejin.cn/post/7587334152870477864</link>    <guid>https://juejin.cn/post/7587334152870477864</guid>    <pubDate>2025-12-25T05:42:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587334152870477864" data-draft-id="7587322796825985064" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型原理剖析——多头并行 + 潜变量协同：原理、应用与部署优化"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-25T05:42:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾醒"/> <meta itemprop="url" content="https://juejin.cn/user/708512558088669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型原理剖析——多头并行 + 潜变量协同：原理、应用与部署优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/708512558088669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T05:42:20.000Z" title="Thu Dec 25 2025 05:42:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>“多头并行+潜变量协同”是深度学习注意力机制的核心进阶架构，通过“多维度并行挖掘”与“隐性特征协同融合”，突破单一注意力头的表达瓶颈，高效捕捉数据中的复杂关联（如语义、时序、特征依赖）。其设计理念完美适配大语言模型（LLM）、语音识别（ASR）等复杂AI任务，尤其在本地化部署场景中，能兼顾模型表达能力与硬件并行效率，是当前高性能AI系统的核心技术之一。</p>
<h3 data-id="heading-1">一、核心概念与底层逻辑</h3>
<h4 data-id="heading-2">1. 整体定义</h4>
<p>该架构由<strong>多头并行</strong>（Multi-Head Parallelism）和<strong>潜变量协同</strong>（Latent Variable Collaboration）两个核心模块组成：</p>
<ul>
<li>多头并行：将输入特征拆分到多个独立子空间，通过并行计算挖掘差异化关联；</li>
<li>潜变量协同：融合多个子空间的隐性特征（潜变量），形成无瓶颈的全局表达。
本质是“并行探索+集中整合”，既解决了单一视角的信息局限，又避免了并行结果的碎片化。</li>
</ul>
<h4 data-id="heading-3">2. 模块1：多头并行——多维度并行探索</h4>
<h5 data-id="heading-4">（1）核心原理</h5>
<p>将原始输入特征通过<strong>差异化线性投影</strong>，拆分到h个相互独立的“子特征空间”，每个空间对应一个“注意力头”（Attention Head）。每个头独立计算注意力权重，专注挖掘该子空间内的特定关联模式（如有的头关注局部特征，有的关注长距离依赖）。</p>
<h5 data-id="heading-5">（2）数学简化表达</h5>
<p>假设输入特征维度为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，多头数为h，每个头的维度为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mi mathvariant="normal">/</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">d_k = d_{model}/h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal">h</span></span></span></span></span>（保证总维度不变）：</p>
<ol>
<li>投影拆分：原始查询（Q）、键（K）、值（V）通过不同线性矩阵投影，得到h组独立的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub><mtext>、</mtext><msub><mi>K</mi><mi>i</mi></msub><mtext>、</mtext><msub><mi>V</mi><mi>i</mi></msub><mtext>（</mtext><mi>i</mi><mo>=</mo><mn>1</mn><mo>∼</mo><mi>h</mi><mtext>）</mtext></mrow><annotation encoding="application/x-tex">Q_i、K_i、V_i（i=1\sim h）</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord cjk_fallback">（</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">h</span><span class="mord cjk_fallback">）</span></span></span></span></span>；</li>
<li>并行计算：每个头独立执行注意力公式：<br/>
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><msub><mi>Q</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>K</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>V</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi>S</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><msub><mi>Q</mi><mi>i</mi></msub><msubsup><mi>K</mi><mi>i</mi><mi>T</mi></msubsup><mi mathvariant="normal">/</mi><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt><mo stretchy="false">)</mo><mo separator="true">⋅</mo><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Attention(Q_i, K_i, V_i) = Softmax(Q_iK_i^T/\sqrt{d_k})·V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1159em;vertical-align:-0.2587em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mord">/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span><span class="mclose">)</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>；</li>
<li>结果暂存：每个头的输出包含该子空间的“潜变量”（如特征重要性权重、关联强度）。</li>
</ol>
<h5 data-id="heading-6">（3）关键优势：差异化与并行效率</h5>
<ul>
<li>差异化：不同投影矩阵让每个头学习到独特的关联模式（如LLM中，头1关注语法结构，头2关注语义搭配，头3关注指代关系），避免信息冗余；</li>
<li>并行性：多头计算完全独立，天然适配GPU/CPU的并行架构（如多核心拆分计算），显著提升推理速度。</li>
</ul>
<h4 data-id="heading-7">3. 模块2：潜变量协同——隐性特征集中整合</h4>
<h5 data-id="heading-8">（1）潜变量的定义</h5>
<p>“潜变量”指每个注意力头在计算中学习到的<strong>隐性关联信息</strong>（未直接显式输入），例如：</p>
<ul>
<li>LLM中：语义关联强度、长距离依赖权重、语法结构优先级；</li>
<li>ASR中：频谱特征关联、音素时序依赖、噪声抑制掩码。</li>
</ul>
<h5 data-id="heading-9">（2）协同机制：解决“并行碎片化”问题</h5>
<p>单一多头并行会产生h个独立的特征输出，潜变量协同通过以下方式整合：</p>





























<table><thead><tr><th>协同方式</th><th>原理</th><th>适用场景</th><th>计算复杂度</th></tr></thead><tbody><tr><td>拼接融合（Concat）</td><td>直接拼接h个头的输出，通过线性层压缩维度</td><td>LLM、复杂文本生成</td><td>中-高</td></tr><tr><td>加权求和（Weighted Sum）</td><td>给每个头分配可学习权重，动态调整重要性</td><td>ASR、噪声环境下的特征提取</td><td>低-中</td></tr><tr><td>交叉注意力协同</td><td>以一个头的潜变量为查询，其他头为键/值</td><td>多模态任务（语音-文本联动）</td><td>高</td></tr></tbody></table>
<h5 data-id="heading-10">（3）与“单一潜注意力”的核心区别</h5>






























<table><thead><tr><th>对比维度</th><th>单一潜注意力</th><th>多头并行+潜变量协同</th></tr></thead><tbody><tr><td>特征空间</td><td>单维度空间，易“维度拥挤”</td><td>多子空间并行，无表达瓶颈</td></tr><tr><td>关联挖掘能力</td><td>仅能捕捉单一粒度关联</td><td>多粒度、多维度关联同时捕捉</td></tr><tr><td>泛化能力</td><td>易过拟合，适配性差</td><td>适配多样化数据分布</td></tr><tr><td>并行效率</td><td>无并行性，推理速度慢</td><td>天然并行，适配硬件加速</td></tr></tbody></table>
<h3 data-id="heading-11">二、核心优势：为何成为LLM/ASR的首选架构</h3>
<h4 data-id="heading-12">1. 突破表达瓶颈，捕捉复杂关联</h4>
<ul>
<li>LLM场景：同时捕捉短距离语法搭配（如“深度学习框架”）和长距离语义连贯（如对话中前文“模型部署”与后文呼应），生成文本的逻辑性提升30%以上；</li>
<li>ASR场景：同时捕捉频谱局部关联（音素识别）和时序长距离关联（语句流畅性），复杂噪声环境下识别准确率提升10%-20%。</li>
</ul>
<h4 data-id="heading-13">2. 适配硬件并行，提升部署效率</h4>
<ul>
<li>GPU部署：多头计算可通过Tensor Parallelism拆分到多卡核心（如h=32的LLM拆分为4张GPU，每张处理8个头），显存占用降低50%，推理速度提升2-3倍；</li>
<li>CPU/边缘设备部署：通过多线程并行处理不同头，8核CPU处理h=8的多头时，延迟降低50%。</li>
</ul>
<h4 data-id="heading-14">3. 泛化能力强，适配多任务场景</h4>
<ul>
<li>可通过调整多头数（h）和协同方式适配不同任务：
<ul>
<li>轻量任务（文本分类、简单ASR）：h=8+加权求和，平衡速度与效果；</li>
<li>复杂任务（对话生成、多模态联动）：h=16/32+交叉注意力，提升关联捕捉能力。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-15">4. 成本效益平衡，适配本地化部署</h4>
<ul>
<li>小模型（LLaMA 7B、轻量ASR）：h=8-16，单卡RTX 3090/4090即可部署，显存占用仅8-12GB；</li>
<li>大模型（LLaMA 70B）：h=32-64，通过多卡并行（4张A100），兼顾效果与部署可行性。</li>
</ul>
<h3 data-id="heading-16">三、实际应用场景：聚焦LLM与ASR</h3>
<h4 data-id="heading-17">1. 场景1：LLM的自注意力机制（核心应用）</h4>
<h5 data-id="heading-18">（1）实现逻辑（以Transformer为例）</h5>
<ol>
<li>输入处理：文本Embedding（维度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>=</mo><mn>512</mn><mi mathvariant="normal">/</mi><mn>1024</mn></mrow><annotation encoding="application/x-tex">d_{model}=512/1024</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">512/1024</span></span></span></span></span>）通过Q、K、V线性投影；</li>
<li>多头拆分：split为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mn>12</mn><mi mathvariant="normal">/</mi><mn>16</mn><mi mathvariant="normal">/</mi><mn>32</mn></mrow><annotation encoding="application/x-tex">h=12/16/32</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">12/16/32</span></span></span></span></span>个头（如<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>=</mo><mn>1024</mn></mrow><annotation encoding="application/x-tex">d_{model}=1024</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1024</span></span></span></span></span>，h=16，每个头维度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><mn>64</mn></mrow><annotation encoding="application/x-tex">d_k=64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">64</span></span></span></span></span>）；</li>
<li>并行计算：每个头独立计算自注意力，挖掘不同语义潜变量；</li>
<li>潜变量协同：拼接所有头的输出，通过线性层得到全局注意力特征，输入Feed-Forward网络。</li>
</ol>
<h5 data-id="heading-19">（2）部署优化技巧</h5>
<ul>
<li>显存优化：将多头拆分到多卡（Tensor Parallelism），LLaMA 7B h=32拆分为2张GPU，每张处理16个头，显存占用从14GB降至8GB；</li>
<li>速度优化：利用CUDA Tensor Core加速矩阵乘法（QK^T、V·权重），开启TensorRT优化，推理速度提升2倍。</li>
</ul>
<h4 data-id="heading-20">2. 场景2：ASR的语音特征提取（关键改进）</h4>
<h5 data-id="heading-21">（1）多头分工设计</h5>
<ul>
<li>头1-4：专注频谱局部关联（梅尔频谱的频率依赖，用于音素识别）；</li>
<li>头5-8：专注时序长距离关联（音素先后顺序，用于语句连贯性）；</li>
<li>头9-12：专注噪声抑制（挖掘“语音信号”与“噪声”的潜变量差异）。</li>
</ul>
<h5 data-id="heading-22">（2）潜变量协同策略</h5>
<p>采用<strong>动态加权求和</strong>：模型根据输入语音的噪声强度、长度，自动调整不同头的权重（如噪声环境下，噪声抑制头权重从0.1提升至0.3）。</p>
<h5 data-id="heading-23">（3）部署效果</h5>
<ul>
<li>实时ASR：延迟从200ms降至100ms以内（CPU 8核并行）；</li>
<li>长语音转写（10分钟会议录音）：WER（字错误率）从18%降至12%。</li>
</ul>
<h4 data-id="heading-24">3. 场景3：多模态工具（语音-文本-脱敏联动）</h4>
<h5 data-id="heading-25">（1）架构设计</h5>
<ul>
<li>多头分工：部分头负责ASR语音转写，部分头负责文本敏感信息识别（挖掘“敏感词-上下文”潜变量）；</li>
<li>协同方式：交叉注意力（ASR头输出作为K/V，脱敏头输出作为Q），让脱敏任务利用语音时序信息，避免误判（如“张三”不会被误判为普通名词）。</li>
</ul>
<h5 data-id="heading-26">（2）实用价值</h5>
<p>构建本地化“语音转写+数据脱敏”一体化工具，适用于企业会议录音、客户通话等隐私场景，脱敏准确率达95%以上。</p>
<h3 data-id="heading-27">四、本地化部署优化指南</h3>
<h4 data-id="heading-28">1. 多头数（h）的选择：平衡效果与硬件成本</h4>

































<table><thead><tr><th>模型规模</th><th>推荐多头数h</th><th>适配硬件</th><th>显存占用（FP16）</th><th>推理速度（单条请求）</th></tr></thead><tbody><tr><td>轻量模型（LLaMA 7B、轻量ASR）</td><td>8-16</td><td>单卡RTX 3090/4090、CPU 16核</td><td>8-12GB</td><td>LLM：50-100ms，ASR：50ms</td></tr><tr><td>中规模模型（LLaMA 13B、通用ASR）</td><td>16-24</td><td>单卡A10、双卡RTX 4090</td><td>12-20GB</td><td>LLM：100-200ms，ASR：80ms</td></tr><tr><td>大规模模型（LLaMA 70B、高精度ASR）</td><td>32-64</td><td>4-8卡A100</td><td>40-80GB</td><td>LLM：200-500ms，ASR：150ms</td></tr></tbody></table>
<blockquote>
<p>注意：多头数并非越多越好，超过h=64后，模型复杂度激增，泛化能力下降，且硬件成本翻倍。</p>
</blockquote>
<h4 data-id="heading-29">2. 潜变量协同方式的硬件适配</h4>
<ul>
<li>计算资源有限（CPU/边缘设备）：选择“加权求和”或“平均池化”，计算量比拼接融合低30%，适合树莓派、NVIDIA Jetson等设备；</li>
<li>高性能硬件（GPU多卡）：选择“拼接融合”或“交叉注意力”，最大化模型表达能力，适合企业级本地化部署；</li>
<li>边缘设备功耗优化：采用“稀疏多头”策略（禁用20%次要头），功耗降低15%，效果仅下降2%。</li>
</ul>
<h4 data-id="heading-30">3. 并行计算优化技巧</h4>
<h5 data-id="heading-31">（1）GPU部署</h5>
<ul>
<li>开启Tensor Parallelism：拆分多头计算到多卡，如h=32拆分为4张GPU，每张处理8个头；</li>
<li>混合精度训练/推理（FP16/FP8）：显存占用降低50%，推理速度提升1.5倍，效果损失可忽略；</li>
<li>利用CUDA核函数：自定义多头注意力的矩阵乘法核，进一步提升并行效率。</li>
</ul>
<h5 data-id="heading-32">（2）CPU部署</h5>
<ul>
<li>多线程并行：通过OpenMP将每个头的计算分配到不同CPU核心，避免串行等待；</li>
<li>特征维度优化：降低<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（如从1024降至768），同时保持h=16，平衡速度与效果。</li>
</ul>
<h4 data-id="heading-33">4. 性能评估指标（本地化部署关键）</h4>

























<table><thead><tr><th>维度</th><th>核心指标</th><th>优化目标</th></tr></thead><tbody><tr><td>模型效果</td><td>LLM：Perplexity、BLEU；ASR：WER/CER</td><td>LLM Perplexity&lt;30；ASR WER&lt;15%</td></tr><tr><td>部署性能</td><td>推理延迟、吞吐量、显存/内存占用</td><td>延迟&lt;300ms；吞吐量&gt;10 QPS</td></tr><tr><td>成本效益</td><td>每千条请求硬件成本（GPU小时费、电费）</td><td>控制在1-5元/千条</td></tr></tbody></table>
<h3 data-id="heading-34">五、前沿扩展与未来趋势</h3>
<h4 data-id="heading-35">1. 动态多头机制</h4>
<p>模型根据输入数据复杂度动态激活多头数（如简单文本激活4个头，复杂文本激活16个头），推理速度提升30%，同时保持效果。</p>
<h4 data-id="heading-36">2. 潜变量蒸馏</h4>
<p>将大模型（h=32）的潜变量知识蒸馏到小模型（h=8），让小模型在边缘设备部署时，效果接近大模型（如ASR WER仅上升3%）。</p>
<h4 data-id="heading-37">3. 跨任务潜变量共享</h4>
<p>在一体化工具（如“LLM生成+ASR转写+脱敏”）中，共享语义关联类潜变量，减少模型参数30%，提升部署效率。</p>
<h3 data-id="heading-38">总结</h3>
<p>“多头并行+潜变量协同”是平衡AI模型“表达能力”与“部署效率”的核心架构，其本质是通过“多维度并行探索”突破单一视角局限，再通过“隐性特征协同”形成全局表达。在LLM、ASR等本地化部署场景中，通过合理选择多头数、协同方式和并行策略，可在普通硬件（如单卡RTX 4090）上实现高性能推理，同时控制成本。</p>
<p>对于开发者而言，该架构的关键价值在于“灵活性”——可根据任务复杂度、硬件配置动态调整参数，完美适配从边缘设备到企业级服务器的全场景部署需求，是构建实用化、本地化AI工具的核心技术支撑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[逃出结构化思维：从向量，向量数据库到RAG]]></title>    <link>https://juejin.cn/post/7587074669818134554</link>    <guid>https://juejin.cn/post/7587074669818134554</guid>    <pubDate>2025-12-24T13:51:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587074669818134554" data-draft-id="7587245616754507827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="逃出结构化思维：从向量，向量数据库到RAG"/> <meta itemprop="keywords" content="后端,架构,LLM"/> <meta itemprop="datePublished" content="2025-12-24T13:51:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            逃出结构化思维：从向量，向量数据库到RAG
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T13:51:09.000Z" title="Wed Dec 24 2025 13:51:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>作为一个 <strong>Java/Go 后端开发者</strong>，你肯定非常熟悉传统的<strong>关系型数据库</strong>（MySQL、PostgreSQL）和<strong>键值对数据库</strong>（Redis）。它们的核心逻辑通常是<strong>精确匹配</strong>（<code>WHERE id = 1</code> 或 <code>key = "session_123"</code>）。</p>
<p>但在这个 AI 爆发的时代，我们处理的数据类型变了：文本、图像、音频、视频。这些非结构化数据无法通过简单的“精确匹配”来查询。详细来说，<strong>如何让数据库理解“含义”？</strong> 比如用户搜“怎么退货？”，数据库得能把文档里写着“售后流程”的那一行找出来。传统的 SQL <code>LIKE</code> 或全文检索（Elasticsearch）在这里往往力不从心，因为它们匹配的是<strong>字面</strong>，而不是<strong>意思</strong></p>
<p>这时候，向量（Vector）<strong>和</strong>向量数据库（Vector Database）<strong>就登场了。简单来说，它们是为了解决</strong>“语义搜索”<strong>和</strong>“模糊匹配”而生的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c25d1a22c33f4e18a55ff86bd3cd5522~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767189069&amp;x-signature=mFka%2BJ%2FMoJUhXBm6sQL4BjF5JXc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">什么是向量 -- 数据的坐标</h2>
<p>在数学上，向量是有大小和方向的量。但在 AI 工程中，<strong>向量（Embedding）</strong> 是<strong>非结构化数据（文本、图片、音频）在多维空间中的数值映射</strong></p>
<p>因此，定义是：数据（如一句话、一张图）经过深度学习模型（Embedding Model）计算后，转化成的一串<strong>浮点数数组</strong></p>
<p>例如：</p>
<ul>
<li>
<p><strong>输入：</strong> "苹果"</p>
</li>
<li>
<p><strong>输出 (假设 3 维)：</strong> <code>[0.8, 0.1, 0.1]</code></p>
</li>
<li>
<p><strong>输入：</strong> "梨子"</p>
</li>
<li>
<p><strong>输出：</strong> <code>[0.7, 0.2, 0.1]</code></p>
</li>
<li>
<p><strong>输入：</strong> "卡车"</p>
</li>
<li>
<p><strong>输出：</strong> <code>[-0.9, 0.5, 0.3]</code></p>
</li>
</ul>
<h3 data-id="heading-2"><strong>核心逻辑：空间距离代表语义相似度</strong></h3>
<p>简单来说呢，就是在这个多维空间里，<strong>含义相近的词，坐标距离就近</strong></p>
<ul>
<li>如果两个数据在语义上很像（比如“猫”和“小猫”），它们转换成的向量在数学空间里的<strong>距离</strong>就会非常近。</li>
<li>如果语义无关（比如“猫”和“汽车”），距离就会很远</li>
</ul>
<h3 data-id="heading-3"><strong>后端视角</strong></h3>
<p>对于后端来说，所谓的“语义搜索”，本质上就是<strong>计算两个数组（向量）之间的数学距离</strong>。常用的算法是 <strong>余弦相似度 (Cosine Similarity)</strong> ：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>similarity</mtext><mo>=</mo><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>A</mi><mo>⋅</mo><mi>B</mi></mrow><mrow><mi mathvariant="normal">∥</mi><mi>A</mi><mi mathvariant="normal">∥</mi><mi mathvariant="normal">∥</mi><mi>B</mi><mi mathvariant="normal">∥</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{similarity} = \cos(\theta) = \frac{A \cdot B}{\|A\| \|B\|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">similarity</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3923em;vertical-align:-0.52em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∥</span><span class="mord mathnormal mtight">A</span><span class="mord mtight">∥∥</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mord mtight">∥</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mbin mtight">⋅</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p>结果越接近 1，表示越相似。</p>
<h2 data-id="heading-4">向量数据库 (Vector DB) -- “坐标”的引擎</h2>
<p>如果只有几千条数据，你把向量存在内存里，写个 <code>for</code> 循环算距离也行。但如果有 1 亿条数据，每次查询都要算 1 亿次余弦相似度，CPU 直接爆炸。</p>
<p>这就需要 <strong>向量数据库</strong></p>
<h3 data-id="heading-5">与关系型数据库的区别</h3>
<p>它和 MySQL 的本质区别</p>
<ul>
<li><strong>MySQL (B+ Tree):</strong> 寻找<strong>精确匹配</strong>。利用树结构快速定位到 <code>ID=100</code> 的叶子节点。</li>
<li><strong>Vector DB (ANN):</strong> 寻找<strong>近似最近邻</strong></li>
</ul>






























<table><thead><tr><th><strong>特性</strong></th><th><strong>传统数据库 (MySQL/PostgreSQL)</strong></th><th><strong>向量数据库 (Milvus/Weaviate/Pinecone)</strong></th></tr></thead><tbody><tr><td><strong>查询逻辑</strong></td><td>精确匹配 (Exact Match)</td><td>近似最近邻搜索 (ANN - Approximate Nearest Neighbor)</td></tr><tr><td><strong>查询语句</strong></td><td><code>SELECT * FROM table WHERE type='fruit'</code></td><td><code>Search(vector=[0.1, 0.2...], top_k=5)</code></td></tr><tr><td><strong>核心算法</strong></td><td>B+ Tree, Hash Index</td><td>HNSW (图索引), IVF (倒排索引), Quantization (量化)</td></tr><tr><td><strong>结果</strong></td><td>确定的行数据</td><td>最相似的数据列表 + 相似度得分</td></tr></tbody></table>
<h3 data-id="heading-6">躲在背后的皇帝？HNSW 索引</h3>
<p>虽然这个小标题有点哗众取宠，但是我恰好是想借其来表达<strong>HNSW 索引的重要性</strong>。</p>
<p>向量库不会真的去算 1 亿次距离。它通常使用 <strong>HNSW</strong> 这种图索引算法。</p>
<p>你可以把它想象成“跳表”+“社交网络”：</p>
<ol>
<li><strong>分层导航：</strong> 顶层只有少数几个“枢纽节点”，底层包含所有数据。</li>
<li><strong>快速收敛：</strong> 查询时，先在顶层找到大概区域，然后像跳伞一样落入下一层，逐步缩小范围，最终找到离目标最近的一簇数据</li>
</ol>
<h3 data-id="heading-7">向量数据库工作一般流程？</h3>
<p>来讲讲一般向量数据库是怎么工作的：</p>
<ul>
<li>
<p><strong>Embedding（嵌入）：</strong> 你的后端服务调用 AI 模型（如 OpenAI），把用户的 Query 变成向量。</p>
</li>
<li>
<p><strong>Indexing（索引）：</strong> 向量数据库使用算法（如 HNSW）构建索引，把向量在空间中按区域划分。</p>
</li>
<li>
<p><strong>Search（搜索）：</strong> 数据库快速定位到目标向量附近的区域，找出最近的邻居，而不是全表扫描。</p>
</li>
</ul>
<h3 data-id="heading-8">向量数据库有哪些推荐？</h3>
<h4 data-id="heading-9">1. 纯向量数据库 (专门产品)</h4>
<ul>
<li><strong>Milvus:</strong> <strong>强烈推荐关注。</strong> 它是云原生架构，核心部分是用 <strong>Go</strong> 写的（对 Go 开发者很亲切），性能极强，国内社区活跃。它有完善的 Java 和 Go SDK。</li>
<li><strong>Weaviate:</strong> 也是用 <strong>Go</strong> 写的开源向量数据库，支持 GraphQL，不仅存向量，还能存对象。</li>
</ul>
<h4 data-id="heading-10">2. 传统数据库的扩展 (插件)</h4>
<ul>
<li><strong>Elasticsearch (kNN):</strong> 如果你的架构里已经有 ES，可以直接用它的向量搜索功能。</li>
<li><strong>PostgreSQL (pgvector):</strong> 非常火的插件。如果你的数据量不是特别巨大（比如千万级以下），直接用 PG 存向量是最省架构成本的</li>
</ul>
<h2 data-id="heading-11">向量数据库这么火的原因🧐 -- RAG与LLM</h2>
<p>作为后端，你可能听说过 <strong>RAG (Retrieval-Augmented Generation，检索增强生成)</strong> 。这是向量数据库最核心的应用场景。</p>
<p><strong>大模型 (LLM) 的痛点：</strong></p>
<ul>
<li>它不知道你公司的私有数据（比如内部文档、代码库）：例如它不知道你公司上周发布的《V3.0 接口文档》，也不知道今天的新闻(不调用任何tool的情况下)</li>
<li>它的知识有截止日期，导致了幻觉：一本正经地胡说八道（这个大家应该深有体会🤓）</li>
</ul>
<p><strong>向量数据库的解法：</strong></p>
<ol>
<li>把你公司的文档切片，变成向量，存入向量数据库（这是“长期记忆”）。</li>
<li>当用户提问时，先把问题变成向量。</li>
<li>去向量数据库里搜出最相关的几段文档。</li>
<li>把“用户问题 + 搜到的文档”一起扔给 LLM。</li>
<li>LLM 基于这些文档回答问题。</li>
</ol>
<p>这让 LLM 看起来像是读过你公司的维基百科一样</p>
<h3 data-id="heading-12">RAG的标准架构流程？</h3>
<h4 data-id="heading-13">阶段一：数据入库</h4>
<p>这是一个离线或异步任务。</p>
<ol>
<li><strong>加载 (Load):</strong> 读取 PDF/Word/Markdown 文档。</li>
<li><strong>切片 (Chunking):</strong> <strong>这是最关键的一步。</strong> 你不能把整本书存成一个向量。你需要把文本按语义（或固定字符数，如 500 字）切成小块。</li>
<li><strong>嵌入 (Embedding):</strong> 调用 OpenAI API 或本地模型，把每个 Chunk 变成向量 <code>[]float32</code>。</li>
<li><strong>存储 (Upsert):</strong> 将 <code>(Vector, Chunk_Text, Metadata)</code> 存入向量数据库（如 Milvus）</li>
</ol>
<h4 data-id="heading-14">阶段二：在线检索与生成</h4>
<p>这是用户发起请求时的同步流程。</p>
<ol>
<li><strong>问题嵌入:</strong> 用户问：“V3 接口怎么鉴权？” -&gt; 调用模型转成向量 <code>Query_Vector</code>。</li>
<li><strong>向量检索:</strong> 拿 <code>Query_Vector</code> 去向量库搜 Top 3 最相似的 Chunks。</li>
<li><strong>Prompt 组装:</strong></li>
</ol>
<pre><code class="hljs language-Plaintext" lang="Plaintext">你是一个技术支持助手。请根据以下已知信息回答用户问题。

已知信息：
1. ... (检索到的 Chunk 1)
2. ... (检索到的 Chunk 2)

用户问题：V3 接口怎么鉴权？
</code></pre>
<p>4.<strong>LLM 生成:</strong> 将组装好的 Prompt 发给 GPT，得到最终答案</p>
<h3 data-id="heading-15">潜在踩坑点😵</h3>
<p>在 Demo 阶段，上面的流程跑得很顺。但在生产环境，你会遇到以下问题，这也是后端工程师的价值所在：</p>
<h4 data-id="heading-16">1. 切片策略 (Chunking Strategy)</h4>
<ul>
<li><strong>问题：</strong> 如果切片太小，上下文丢失；如果切片太大，噪音太多且不仅占 Token。</li>
<li><strong>解法：</strong> 使用 <code>RecursiveCharacterTextSplitter</code>，并设置 <strong>Overlap (重叠)</strong> 。比如每块 500 字，块与块之间重叠 50 字，保证句子没被切断。</li>
</ul>
<h4 data-id="heading-17">2. 混合检索 (Hybrid Search)</h4>
<ul>
<li><strong>问题：</strong> 用户搜具体的“错误码 10045”。向量搜索可能找出一堆“错误”、“异常”相关的文档，但偏偏漏了包含“10045”这个数字的文档（因为向量关注的是语义，对精确数字有时不敏感）。</li>
<li><strong>解法：</strong> <strong>向量检索 (语义) + 关键词检索 (BM25)</strong> 同时进行，然后使用 <strong>RRF (Reciprocal Rank Fusion)</strong> 算法对结果进行加权重新排序。</li>
</ul>
<h4 data-id="heading-18">3. 元数据过滤 (Metadata Filtering)</h4>
<ul>
<li><strong>问题：</strong> 你存了全公司的文档。但“财务部”的文档不能被“研发部”的人搜到。</li>
<li><strong>解法：</strong> 在存向量时，写入 Metadata：<code>{"dept": "finance"}</code>。在查询向量库时，带上 <code>filter: "dept == 'finance'"</code>。<strong>先过滤，再做向量近似搜索</strong>。</li>
</ul>
<h2 data-id="heading-19">总结❤️</h2>
<p>从<strong>向量</strong>到<strong>向量数据库</strong>，再到<strong>RAG</strong>，本质上是我们逃出了结构化思维，对数据处理方式的一次升维：</p>
<ol>
<li><strong>向量</strong>是数据的<strong>语义压缩</strong>。</li>
<li><strong>向量数据库</strong>是语义数据的<strong>高性能索引</strong>。</li>
<li><strong>RAG</strong> 是连接<strong>静态数据</strong>与<strong>动态智能</strong>的桥梁。</li>
</ol>
<p>对于 Java/Go 开发者来说，现在的机会在于：不要只盯着 LLM 的 API 调用，而是去建设<strong>高质量的数据管道 (Data Pipeline)</strong> 。因为在 RAG 架构中，<strong>检索的质量（数据切得好不好、搜得准不准）直接决定了最终回答的质量</strong>。</p>
<p>如果你觉得我写的好，就点赞收藏关注，这是我更新的最大动力！！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[虚拟内存与寻址方式解析(面试版)]]></title>    <link>https://juejin.cn/post/7585395972294197257</link>    <guid>https://juejin.cn/post/7585395972294197257</guid>    <pubDate>2025-12-19T12:15:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585395972294197257" data-draft-id="7585121055036686386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="虚拟内存与寻址方式解析(面试版)"/> <meta itemprop="keywords" content="后端,操作系统,面试"/> <meta itemprop="datePublished" content="2025-12-19T12:15:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            虚拟内存与寻址方式解析(面试版)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-19T12:15:06.000Z" title="Fri Dec 19 2025 12:15:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>虚拟内存和物理内存的区别？它们之间是怎么对应的？段式、页式、段页式分别是怎么寻址的？这是一个非常经典的操作系统底层问题，对于后端开发（Java/Go）来说，理解它是进行性能调优（如排查 OOM、理解 GC 行为、数据库缓存机制）的基石。同时这也是大厂面试的常考题，下面让我们一起探讨。</p>
</blockquote>
<h2 data-id="heading-1">虚拟内存与物理内存</h2>
<ul>
<li>物理内存：物理内存是指计算机中实际存在的硬件内存，由内存条等硬件组成</li>
<li>虚拟内存：由操作系统提供，为每个进程创建一个<strong>独立的、连续的地址空间</strong>，空间大小可以远远大于物理内存。每个进程都认为自己拥有独立、连续的内存空间。且每个进程的虚拟空间都是<strong>独立隔离</strong>的</li>
</ul>
<p><strong>使用虚拟内存的好处？</strong></p>
<ul>
<li>提供<strong>内存隔离</strong>：每个进程以为自己独占整个内存空间，互不干扰，这解决了多进程之间地址冲突的问题；</li>
<li>支持<strong>比物理内存更大的地址空间</strong>（例如32位系统支持4GB虚拟地址空间，即使物理内存只有2GB），因为程序运行符合局部性原理，CPU 访问内存会有很明显的重复访问的倾向性，对于那些没有被经常使用到的内存，我们可以把它换出到物理内存之外，比如硬盘上的 swap 区域；</li>
<li>实现<strong>按需加载</strong>（Demand Paging）和<strong>内存保护</strong>；</li>
<li>简化程序开发，程序员无需关心物理内存布局。</li>
</ul>
<p>简单来说，<strong>物理内存是硬件真相，虚拟内存是操作系统编织的“谎言”（抽象层）。</strong></p>



































<table><thead><tr><th><strong>特性</strong></th><th><strong>物理内存 (Physical Memory)</strong></th><th><strong>虚拟内存 (Virtual Memory)</strong></th></tr></thead><tbody><tr><td><strong>本质</strong></td><td>真实的硬件设备（RAM 内存条）。</td><td>操作系统提供的逻辑抽象层。</td></tr><tr><td><strong>大小</strong></td><td>受限于硬件容量（如 16GB, 32GB）。</td><td>受限于 CPU 字长（32位系统4GB，64位系统理论极大）。</td></tr><tr><td><strong>地址空间</strong></td><td>全局唯一，所有程序共享这块硬件。</td><td><strong>进程隔离</strong>。每个进程都认为自己拥有独立、连续的内存空间。</td></tr><tr><td><strong>可见性</strong></td><td>操作系统内核和硬件直接访问。</td><td>应用程序（Java/Go 进程）直接看到的内存。</td></tr><tr><td><strong>主要作用</strong></td><td>存储实际的数据和指令。</td><td>隔离进程、简化内存管理、实现内存超售（Swap/Pagefile）。</td></tr></tbody></table>
<p><strong>后端视角：</strong> 当你在 Java 中 <code>new Object()</code> 或在 Go 中 <code>make([]int)</code> 时，分配的地址（如 <code>0x4f00123</code>）全都是<strong>虚拟地址</strong>。你永远无法直接触碰物理内存地址</p>
<h2 data-id="heading-2">虚拟内存与物理内存之间是如何对应的？</h2>
<p>虚拟内存和物理内存之间的桥梁是 <strong>MMU（Memory Management Unit，内存管理单元）</strong> 。这是一个集成在 CPU 中的硬件单元。</p>
<ul>
<li><strong>映射表：</strong> 操作系统在内存中维护着映射表（页表或段表），记录了“虚拟地址 X 对应 物理地址 Y”。</li>
<li><strong>转换过程：</strong> 当 CPU 执行指令要访问某个虚拟地址时，MMU 会自动查询映射表，将其转换为物理地址，然后发给内存条读取数据。</li>
<li><strong>缺页中断 (Page Fault)：</strong> 如果 MMU 发现数据不在物理内存中（可能在磁盘 Swap 分区里），会触发中断异常，操作系统会把数据从磁盘加载到物理内存，更新映射表，然后重试</li>
</ul>
<h2 data-id="heading-3">三种寻址方式详解</h2>
<p>不同的操作系统采用不同的方式来管理这种映射，主要分为段式、页式和段页式。</p>
<h3 data-id="heading-4">段式储存(Segmentation) —— 按逻辑分块</h3>
<p><strong>核心思想</strong>：按照程序的逻辑结构划分。比如把程序分为“代码段”、“数据段”、“栈段”。<strong>每一段的大小是不固定的</strong>。</p>
<ul>
<li>
<p><strong>虚拟地址结构</strong>：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mtext>段号</mtext><mo stretchy="false">(</mo><mi>S</mi><mi>e</mi><mi>g</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mtext> </mtext><mi>S</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mtext>段内偏移量</mtext><mo stretchy="false">(</mo><mi>O</mi><mi>f</mi><mi>f</mi><mi>s</mi><mi>e</mi><mi>t</mi><mo stretchy="false">)</mo><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;段号 (Segment\ Selector), 段内偏移量 (Offset)&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">段号</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord cjk_fallback">段内偏移量</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.10764em;">ff</span><span class="mord mathnormal">se</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span></span></span></span></span></p>
</li>
<li>
<p><strong>寻址过程</strong>：</p>
<ol>
<li>
<p>根据<strong>段号</strong>去查<strong>段表 (Segment Table)</strong> 。</p>
</li>
<li>
<p>段表中记录了该段的<strong>基址 (Base Address)</strong> 和 <strong>段长 (Limit)</strong> 。</p>
</li>
<li>
<p><strong>越界检查</strong>：检查 <code>偏移量</code> 是否超过了 <code>段长</code>，超过则报错（Segfault）。</p>
</li>
<li>
<p><strong>计算物理地址</strong>：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>物理地址</mtext><mo>=</mo><mtext>段基址</mtext><mo>+</mo><mtext>偏移量</mtext></mrow><annotation encoding="application/x-tex">物理地址 = 段基址 + 偏移量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">物理地址</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">段基址</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">偏移量</span></span></span></span></span></p>
</li>
</ol>
</li>
<li>
<p><strong>优缺点</strong>：</p>
<ul>
<li><em>优点</em>：符合程序员思维，方便代码共享和保护。</li>
<li><em>缺点</em>：<strong>外部碎片</strong>。因为段的大小不一，内存中会留下许多塞不进新段的小空隙。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">页式存储 (Paging) —— 按固定大小分块</h3>
<p><strong>核心思想</strong>：将物理内存和虚拟内存都切成<strong>固定大小</strong>的块（通常是 4KB）。物理内存块叫<strong>页框 (Page Frame)</strong> ，虚拟内存块叫<strong>页 (Page)</strong> 。</p>
<ul>
<li>
<p><strong>虚拟地址结构</strong>：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mtext>页号</mtext><mo stretchy="false">(</mo><mi>V</mi><mi>P</mi><mi>N</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mtext>页内偏移量</mtext><mo stretchy="false">(</mo><mi>O</mi><mi>f</mi><mi>f</mi><mi>s</mi><mi>e</mi><mi>t</mi><mo stretchy="false">)</mo><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;页号 (VPN), 页内偏移量 (Offset)&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">页号</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.10903em;">PN</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord cjk_fallback">页内偏移量</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.10764em;">ff</span><span class="mord mathnormal">se</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span></span></span></span></span></p>
</li>
<li>
<p><strong>寻址过程</strong>：</p>
<ol>
<li>
<p>根据<strong>页号</strong>去查<strong>页表 (Page Table)</strong> 。</p>
</li>
<li>
<p>页表中记录了该页对应的<strong>物理页框号 (PPN)</strong> 。</p>
</li>
<li>
<p><strong>计算物理地址</strong>：直接拼接。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>物理地址</mtext><mo>=</mo><mtext>物理页框号</mtext><mo>×</mo><mtext>页大小</mtext><mo>+</mo><mtext>偏移量</mtext></mrow><annotation encoding="application/x-tex">物理地址 = 物理页框号 \times 页大小 + 偏移量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">物理地址</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">物理页框号</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">页大小</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">偏移量</span></span></span></span></span></p>
</li>
</ol>
<ul>
<li><em>注：实际硬件中通常是直接拼接二进制位。</em></li>
</ul>
</li>
<li>
<p><strong>优缺点</strong>：</p>
<ul>
<li><em>优点</em>：解决了外部碎片问题，内存利用率高。</li>
<li><em>缺点</em>：<strong>内部碎片</strong>（最后一页没填满）；页表可能很大（需要多级页表）；频繁访问内存（需要 TLB 加速）。</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>现代主流 OS（Linux, Windows）主要基于页式管理</strong>（尽管 x86 硬件保留了分段机制，但 Linux 主要将其旁路掉，只用分页）。</p>
</blockquote>
<h3 data-id="heading-6">段页式存储 (Segmented Paging) —— 集大成者</h3>
<p><strong>核心思想</strong>：先将程序按逻辑<strong>分段</strong>，再把每个段<strong>分页</strong>。这是为了结合两者的优点。</p>
<ul>
<li>
<p><strong>虚拟地址结构</strong>：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mtext>段号</mtext><mo separator="true">,</mo><mtext>段内页号</mtext><mo separator="true">,</mo><mtext>页内偏移量</mtext><mo>&gt;</mo></mrow><annotation encoding="application/x-tex">&lt;段号, 段内页号, 页内偏移量&gt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord cjk_fallback">段号</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord cjk_fallback">段内页号</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord cjk_fallback">页内偏移量</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span></span></span></span></span></p>
</li>
<li>
<p><strong>寻址过程</strong>（需要三次内存访问，比较慢，必须依赖硬件缓存）：</p>
<ol>
<li>
<p>根据<strong>段号</strong>查<strong>段表</strong>，得到该段的<strong>页表起始地址</strong>。</p>
</li>
<li>
<p>根据<strong>段内页号</strong>查<strong>页表</strong>，得到<strong>物理页框号</strong>。</p>
</li>
<li>
<p><strong>计算物理地址</strong>：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>物理地址</mtext><mo>=</mo><mtext>物理页框号</mtext><mo>+</mo><mtext>页内偏移量</mtext></mrow><annotation encoding="application/x-tex">物理地址 = 物理页框号 + 页内偏移量</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">物理地址</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">物理页框号</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">页内偏移量</span></span></span></span></span></p>
</li>
</ol>
</li>
</ul>
<h2 data-id="heading-7">总结</h2>
<p>这张图表展示了三种寻址方式的对比</p>

































<table><thead><tr><th><strong>方式</strong></th><th><strong>单位大小</strong></th><th><strong>碎片类型</strong></th><th><strong>寻址复杂度</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td><strong>段式</strong></td><td>不定（按逻辑）</td><td>外部碎片</td><td>中</td><td>早期系统，便于共享保护</td></tr><tr><td><strong>页式</strong></td><td>固定（如 4KB）</td><td>内部碎片</td><td>低（硬件易实现）</td><td><strong>现代主流 OS（Linux）</strong></td></tr><tr><td><strong>段页式</strong></td><td>固定</td><td>内部碎片</td><td>高（多次查表）</td><td>复杂系统架构</td></tr></tbody></table>
<p>在日常后端开发，哪里有内存管理与寻址的知识运用呢？</p>
<ul>
<li>
<p><strong>GC 与 内存整理</strong>：Java 的 GC 算法（如 G1, ZGC）在处理堆内存时，实际上是在整理<strong>虚拟内存</strong>。底层的操作系统会通过页表映射，尽可能让物理内存的使用变得紧凑，但如果 Java 堆过大导致频繁 Swap，性能会急剧下降。</p>
</li>
<li>
<p><strong>Copy-On-Write (COW)</strong> ：Linux <code>fork()</code> 子进程（如 Redis RDB 快照）时，子进程和父进程共享物理内存，只有在写操作时，OS 才会利用页表机制复制一份物理页。理解页式存储能帮你理解为什么 Redis 快照时内存占用不会瞬间翻倍。</p>
</li>
<li>
<p><strong>mmap</strong>：在 Go 或 Java 中使用 <code>MappedByteBuffer</code> (Zero Copy)，本质上是修改页表，将文件直接映射到用户态的虚拟内存地址，绕过内核缓冲区拷贝。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[电视版智家App兼容触摸和遥控器交互方式]]></title>    <link>https://juejin.cn/post/7587322796826198056</link>    <guid>https://juejin.cn/post/7587322796826198056</guid>    <pubDate>2025-12-25T06:02:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587322796826198056" data-draft-id="7585091990347677732" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="电视版智家App兼容触摸和遥控器交互方式"/> <meta itemprop="keywords" content="APP"/> <meta itemprop="datePublished" content="2025-12-25T06:02:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="海尔智慧家技术平台"/> <meta itemprop="url" content="https://juejin.cn/user/3848721122725016"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            电视版智家App兼容触摸和遥控器交互方式
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/7156434854350389283/posts" data-v-d326b38e=""><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a4176c1a2e0b4e1b986f105126840cc9~tplv-k3u1fbpfcp-watermark.image?" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/7156434854350389283/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="三翼鸟数字化技术团队" class="title" data-v-d326b38e="">三翼鸟数字化技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-12-25T06:02:27.000Z" title="Thu Dec 25 2025 06:02:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-12-25
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读8分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              @海尔优家智能科技（北京）有限公司
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"> 1. 背景</h2>
<p>电视版智家App一直运行在海尔电视上，使用遥控器进行交互，后来添加了一个指向型遥控器，也是通过焦点进行交互的，一直运行正常。</p>
<p>现在增加了一款新的电视，此电视竟然可触摸，太厉害了，超级好用。但是我们的App跑上去后竟然水土不服，交互出现了问题，问题有很多，有UI适配的，有交互的，有横竖屏的，今天先研究一下交互模式，饭要一口一口吃。</p>
<h2 data-id="heading-1">2. 焦点与触摸模式</h2>
<h3 data-id="heading-2">2.1 什么是焦点？它有什么作用？</h3>
<p>在非触屏的手机或者电视上，我们通常需要用键盘、鼠标、遥控器与界面进行交互，当交互的时候必须先使目标控件获得焦点（比如高亮起来），这样用户才会注意到是什么控件接受输入。</p>
<p>而如果是在触屏时代，用户可以直接用手指点击控件，这个时候就没必要将目标高亮了（即获取焦点）。</p>
<p>总结，焦点主要用于非触屏手机上的，是与用户交互有关的产物，跟交互方式紧密相关（当然它还有其它用途，这个后续再说，现在先聚焦在这里）。</p>
<h3 data-id="heading-3">2.2 触摸模式</h3>
<h4 data-id="heading-4">2.2.1 触摸模式是什么？</h4>
<p>现在的手机大多是触摸屏，使用起来很方便，它与传统的键盘、鼠标、遥控器的交互方式不太一样的一点是，它不需要焦点辅助交互，更加方便人们使用手机，所以它是一种新的交互模式，我们称之为“触摸模式”（Touch Mode）。</p>
<p>在Android上，有一个方法（<strong>View#isInTouchMode()</strong> ）用来指示当前是否是处于触摸模式，它是用户和手机进行交互时view层次结构的一个状态。代表了最近一次的交互是否是通过触摸屏发生的，因为在Android设备上还存在别的交互方式，比如键盘、鼠标等等。</p>
<h4 data-id="heading-5">2.2.2 进入/退出触摸模式，如何判断当前是什么模式</h4>
<p>Android系统会自动维护当前的状态，即是否是触摸模式。对于支持触摸功能的设备，当用户触摸屏幕时，设备会立即进入触摸模式。无论何时，只要用户点击方向键或滚动轨迹球或点击遥控器，设备就会退出触摸模式并找到一个视图使其获得焦点。</p>
<p>整个系统（所有窗口和 Activity）都将保持同一个触摸模式的状态。可通过调用<strong>View#isInTouchMode()</strong> 来检查设备目前是否处于触摸模式，用于您自己的逻辑处理时使用。</p>
<h3 data-id="heading-6">2.3 触摸模式与焦点</h3>
<p>前面说了，触摸模式是与传统的遥控器、键盘不一样的一种交互方式，它是不需要焦点的，任何已聚焦的控件当进入触摸模式时都变为未聚焦状态。而当使用鼠标和键盘时，就会立即离开触摸模式，控件就会变成聚焦的状态。</p>
<p>那么是不是触摸模式下就没有焦点的概念了呢？</p>
<p>非也，上边只是说不需要焦点进行辅助交互，但还是有其它场景是需要焦点的，比如文本输入框。这就引出了两个概念，搞清了它俩，也就弄清了焦点和触模模式了，它们是<strong>setFocusableInTouchMode 和 setFocusable 。</strong></p>
<h4 data-id="heading-7">2.3.1 setFocusableInTouchMode 和 setFocusable 方法</h4>
<ul>
<li><strong>setFocusable</strong>：设置控件是否能获取焦点。可以通过isFocusable()获取其状态。</li>
<li><strong>setFocusableInTouchMode</strong>：在触摸模式下，设置控件是否允许聚焦。可以通过isFocusableInTouchMode() 获取其状态。</li>
</ul>
<h4 data-id="heading-8">2.3.2 setFocusableInTouchMode 和 setFocusable 的使用场景</h4>
<ol>
<li>在使用键盘、鼠标、轨迹球、遥控器的情况下，只有setFocusable为true的控件，才可以获取焦点（选中时高亮）。</li>
<li>在触摸模式下，setFocusable为true，并无法保证控件可以获取焦点，它只能保证在非触摸模式下，该控件可以允许获取焦点。如果想在在触摸模式中，改变控件是否允许聚焦，需要使用setFocusableInTouchMode。</li>
<li>从上面我们也可以看出，不管是否在触摸模式下，控件获取焦点的前提是isFocusable()为true。而在触摸模式下，只有isFocusable()和isFocusableInTouchMode()都为ture的情况下，控件才允许聚焦。</li>
</ol>
<h4 data-id="heading-9">2.3.3 调用 setFocusableInTouchMode 和 setFocusable 对相互的影响</h4>
<ol>
<li>setFocusableInTouchMode为true，会使isFocusable也变为true，而setFocusableInTouchMode为false并不影响isFocusable。</li>
<li>setFocusable为false，会使isFocusableInTouchMode变为false，而setFocusable为true并不影响isFocusableInTouchMode</li>
</ol>
<h4 data-id="heading-10">2.3.4 各种常用控件的默认初始状态</h4>







































































































<table><thead><tr><th/><th/><th/><th/><th/></tr></thead><tbody><tr><td>控件</td><td>Focusable</td><td>FocusableInTouchMode</td><td>Clickable</td><td>LongClickable</td></tr><tr><td>View</td><td>FALSE</td><td>FALSE</td><td>FALSE</td><td>FALSE</td></tr><tr><td>TextView</td><td>FALSE</td><td>FALSE</td><td>FALSE</td><td>FALSE</td></tr><tr><td>EditText</td><td>TRUE</td><td>TRUE</td><td>TRUE</td><td>TRUE</td></tr><tr><td>Button</td><td>TRUE</td><td>FALSE</td><td>TRUE</td><td>FALSE</td></tr><tr><td>ImageButton</td><td>TRUE</td><td>FALSE</td><td>TRUE</td><td>FALSE</td></tr><tr><td>ImageView</td><td>FALSE</td><td>FALSE</td><td>FALSE</td><td>FALSE</td></tr><tr><td>CheckBox</td><td>TRUE</td><td>FALSE</td><td>TRUE</td><td>FALSE</td></tr><tr><td>RadioButton</td><td>TRUE</td><td>FALSE</td><td>TRUE</td><td>FALSE</td></tr><tr><td>ProgressBar</td><td>FALSE</td><td>FALSE</td><td>FALSE</td><td>FALSE</td></tr><tr><td>LinearLayout</td><td>FALSE</td><td>FALSE</td><td>FALSE</td><td>FALSE</td></tr><tr><td>RelativeLayout</td><td>FALSE</td><td>FALSE</td><td>FALSE</td><td>FALSE</td></tr><tr><td>其他Layout都几乎一样</td><td>FALSE</td><td>FALSE</td><td>FALSE</td><td>FALSE</td></tr></tbody></table>
<p>从上面我们可以看出，大部分的控件FocusableInTouchMode属性都为false。只有类似EditText这种控件才为true，因为EditText需要提供在没用户点击的条件下，弹出一个软键盘进行输入的功能。</p>
<h2 data-id="heading-11">3. 智家App适配触摸屏要点</h2>
<p>由于电视之前只有遥控器，所以它的交互方式一直是依赖焦点的，新电视支持触摸，这块肯定是需要适配的，经过上面的研究，发现现在的问题主要是使用focusableInTouchMode属性不当导致的，需要检查一下所有页面中的控件，此属性的使用情况，是否正确。</p>
<p>以下总结了在电视上适配触摸屏的要点及可能会出现的问题：</p>
<ol>
<li>
<p>触摸模式的进入和退出系统已做好了，不用开发者操心；</p>
</li>
<li>
<p>开发者只需要管理好控件的focusableInTouchMode属性即可，一般情况(不需要输入时)下将它设置为false即可，可在xml中进行设置也可以通过 setFocusableInTouchMode() 在代码中设置；</p>
</li>
<li>
<p>当需要根据当前的模式进行自定义逻辑适配时，可使用方法：<strong>View#isInTouchMode()</strong> ；</p>
</li>
<li>
<p>可能会出现的问题需要注意：</p>
<ol>
<li>普通的控件或自定义控件，滥用了setFocusableInTouchMode，会出现点击一下获取焦点，再点一下才是点击的情况。对于这种情况，将它的setFocusableInTouchMode设置为false即可；</li>
<li>以后开发时，要小心onTouchEvent()方法，因为它只会在触摸屏上才有，在非触摸屏上永远不会触发它，如果使用了此方法，到时候逻辑可能就不正常了；</li>
</ol>
</li>
</ol>
<h2 data-id="heading-12">4. 统一适配View</h2>
<p>在实际使用过程中，我们需要将常用的一些适配放到基类中进行统一适配，可方便我们的开发及维护，这里我们统一做了几处适配。</p>
<h3 data-id="heading-13">4.1 封装方法判断是否是移动屏</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">tvProductTypeIsPad</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> getTvProductType() == TvProductType.PAD
}
</code></pre>
<h3 data-id="heading-14">4.2 HoverViewExtension</h3>
<p>通用扩展类，用于在鼠标/指向型遥控器移动到View时，智能修改focuseableInTouchMode，以适配移动屏和普通电视，关键代码如下所示</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span>  View.<span class="hljs-title">addHoverListener</span><span class="hljs-params">(autoChangeItemFocusableInTouchMode: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>)</span></span> {
    <span class="hljs-keyword">this</span>.setOnGenericMotionListener { v, event -&gt;
        <span class="hljs-keyword">when</span>(event?.action) {
            MotionEvent.ACTION_HOVER_ENTER -&gt; {
                <span class="hljs-keyword">if</span> (autoChangeItemFocusableInTouchMode) {
                    v.isFocusableInTouchMode = <span class="hljs-literal">true</span>
                }
            }
            MotionEvent.ACTION_HOVER_EXIT -&gt; {
                <span class="hljs-keyword">if</span> (autoChangeItemFocusableInTouchMode) {
                    v.isFocusableInTouchMode = <span class="hljs-literal">false</span>
                }
            }
        }
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@setOnGenericMotionListener</span> <span class="hljs-literal">true</span>
    }
}
</code></pre>
<h3 data-id="heading-15">4.3 UiUtils</h3>
<p>创建Utils方法，实现点击时的动效，点击缩小View，松开手指恢复原大小，如下</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">commonCardTouchScale</span><span class="hljs-params">(
    view: <span class="hljs-type">View</span>?,
    scaleX: <span class="hljs-type">Float</span> = SCALE_RATIO_SMART,
    scaleY: <span class="hljs-type">Float</span> = SCALE_RATIO_SMART,
    duration: <span class="hljs-type">Long</span> = SCALE_DURATION_SMART,
    effectZ: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">false</span>
)</span></span> {
    view?.setOnTouchListener { v, event -&gt;
        <span class="hljs-keyword">when</span> (event.action) {
            MotionEvent.ACTION_DOWN -&gt; {
                <span class="hljs-keyword">if</span> (effectZ) view.elevation += <span class="hljs-number">1</span>
                scaleView(v,
                    getSmartScaleRatio(scaleX, v),
                    getSmartScaleRatio(scaleY, v),
                    getSmartScaleDuration(duration, event.action)
                )
            }
            MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -&gt; {
                <span class="hljs-keyword">if</span> (effectZ) view.elevation -= <span class="hljs-number">1</span>
                scaleView(v, SCALE_DEFAULT, SCALE_DEFAULT,
                    getSmartScaleDuration(duration, event.action)
                )
            }
        }
        <span class="hljs-literal">false</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">scaleView</span><span class="hljs-params">(
    view: <span class="hljs-type">View</span>,
    scaleX: <span class="hljs-type">Float</span>,
    scaleY: <span class="hljs-type">Float</span>,
    duration: <span class="hljs-type">Long</span> = SCALE_DURATION
)</span></span> {
    view.animate().scaleX(scaleX).scaleY(scaleY).setDuration(duration)
        .setInterpolator(AccelerateDecelerateInterpolator())
        .start()
}
</code></pre>
<p>如上，实现了一些通用的方法，然后在每个页面的合适位置中进行适配，即可完成整个工程的适配。当然适配工作是一项细致的事情，需要细心修改，并反复打磨，最后呈现出一个完美的作品。</p>
<h2 data-id="heading-16">5. 总结</h2>
<p>本篇文章梳理总结了焦点、触摸模式的定义，维护是否是触摸模式的方式、focusable和focusableInTouchMode属性的区别，最后梳理出智家App适配触摸屏的要点，清晰了概念，根据要点，走查一遍App功能，大体上就算适配完了，后续再根据需要进行一些UI或其它逻辑的完善即可。</p>
<h2 data-id="heading-17">6. 参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fmcryeasy%2Farticle%2Fdetails%2F53708493" title="https://blog.csdn.net/mcryeasy/article/details/53708493" target="_blank" ref="nofollow noopener noreferrer">Android 触摸模式（Touch Mode）</a></p>
<h2 data-id="heading-18">7. 团队介绍</h2>
<p>「三翼鸟数字化技术平台-应用软件框架开发」主要负责设计工具的研发，包括营销设计工具、家电VR设计和展示、水电暖通前置设计能力，研发并沉淀素材库，构建家居家装素材库，集成户型库、全品类产品库、设计方案库、生产工艺模型，打造基于户型和风格的AI设计能力，快速生成算量和报价；同时研发了门店设计师中心和项目中心，包括设计师管理能力和项目经理管理能力。实现了场景全生命周期管理，同时为水，空气，厨房等产业提供商机管理工具，从而实现了以场景贯穿的B端C端全流程系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式]]></title>    <link>https://juejin.cn/post/7587336857538527241</link>    <guid>https://juejin.cn/post/7587336857538527241</guid>    <pubDate>2025-12-25T04:05:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587336857538527241" data-draft-id="7587336857538478089" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2025-12-25T04:05:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="伍华聪"/> <meta itemprop="url" content="https://juejin.cn/user/122769398839592"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/122769398839592/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    伍华聪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T04:05:48.000Z" title="Thu Dec 25 2025 04:05:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Python+FastAPI的后端项目中，我们往往很多时候需要对数据进行相关的处理，本篇随笔介绍在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式。</p>
<p>使用 FastAPI, SQLAlchemy, Pydantic构建后端项目的时候，其中数据库访问采用SQLAlchemy 的异步方式处理。一般我们在操作数据库操作的时候，采用基类继承的方式减少重复代码，提高代码复用性。不过我们在分析SQLAlchemy的时候，我们可以简单的方式来剖析几种常见的数据库操作方式，来介绍SQLAlchemy的具体使用。</p>
<h3 data-id="heading-0">1、SQLAlchemy介绍</h3>
<p><strong>SQLAlchemy</strong> 是一个功能强大且灵活的 Python SQL 工具包和对象关系映射（ORM）库。它被广泛用于在 Python 项目中处理关系型数据库的场景，既提供了高级的 ORM 功能，又保留了对底层 SQL 语句的强大控制力。<code>SQLAlchemy</code> 允许开发者通过 Python 代码与数据库进行交互，而无需直接编写 SQL 语句，同时也支持直接使用原生 SQL 进行复杂查询。下面是<strong>SQLAlchemy</strong>和我们常规数据库对象的对应关系说明。</p>
<p>Engine  　　连接对象         驱动引擎</p>
<p>Session 　　连接池           事务  由此开始查询</p>
<p>Model   　　表                   类定义</p>
<p>Column  　  列  </p>
<p>Query   　　若干行         可以链式添加多个条件</p>
<p>在使用SQLAlchemy时，通常会将其与数据库对象对应起来。</p>
<p><strong>SQLAlchemy</strong>: 使用 <code>Table</code> 对象或 <code>Declarative Base</code> 中的类来表示。</p>
<p><strong>对应关系</strong>: 数据库中的每一个表对应于SQLAlchemy中的一个类，该类继承自 <code>declarative_base()</code>。</p>
<pre><code class="hljs language-ini" lang="ini">from sqlalchemy import Column, Integer, String, create_engine
from sqlalchemy.ext.declarative import declarative_base

<span class="hljs-attr">Base</span> = declarative_base()

class User(Base):
    <span class="hljs-attr">__tablename__</span> = <span class="hljs-string">'users'</span>  <span class="hljs-comment"># 数据库表名</span>
    <span class="hljs-attr">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>)
    <span class="hljs-attr">name</span> = Column(String)
    <span class="hljs-attr">email</span> = Column(String)
</code></pre>
<p><strong>数据库列 (Database Column)：</strong> 使用 <code>Column</code> 对象来表示。每个数据库表中的列在SQLAlchemy中表示为 <code>Column</code> 对象，并作为类的属性定义。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>)
<span class="hljs-attr">name</span> = Column(String(<span class="hljs-number">50</span>))
</code></pre>
<p><strong>数据库行 (Database Row)：</strong> 每个数据库表的一个实例（对象）代表数据库表中的一行。在SQLAlchemy中，通过实例化模型类来表示数据库表中的一行。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">new_user</span> = User(id=<span class="hljs-number">1</span>, name=<span class="hljs-string">'John Doe'</span>, email=<span class="hljs-string">'john@example.com'</span>)
</code></pre>
<p><strong>主键 (Primary Key)</strong> ：使用 <code>primary_key=True</code> 参数定义主键。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>)
</code></pre>
<p><strong>外键 (Foreign Key):</strong> 使用 <code>ForeignKey</code> 对象来表示。</p>
<pre><code class="hljs language-ini" lang="ini">from sqlalchemy import ForeignKey
from sqlalchemy.orm import relationship

class Address(Base):
    <span class="hljs-attr">__tablename__</span> = <span class="hljs-string">'addresses'</span>
    <span class="hljs-attr">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>)
    <span class="hljs-attr">user_id</span> = Column(Integer, ForeignKey(<span class="hljs-string">'users.id'</span>))
    <span class="hljs-attr">user</span> = relationship(<span class="hljs-string">'User'</span>)
</code></pre>
<p><strong>关系 (Relationships):</strong> 使用 <code>relationship</code> 对象来表示。数据库中表与表之间的关系在SQLAlchemy中通过 <code>relationship</code> 来定义。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">addresses</span> = relationship(<span class="hljs-string">"Address"</span>, back_populates=<span class="hljs-string">"user"</span>)
</code></pre>
<h3 data-id="heading-1">2、常规的单表处理</h3>
<p>下面我们通过异步处理的方式，介绍如何在单表中操作相关的数据库数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, db: AsyncSession, <span class="hljs-built_in">id</span>: <span class="hljs-type">Any</span></span>) -&gt; <span class="hljs-type">Any</span>:
    <span class="hljs-string">"""根据主键获取一个对象"""</span>

    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">id</span>, <span class="hljs-built_in">str</span>):
        query = select(self.model).<span class="hljs-built_in">filter</span>(func.lower(self.model.<span class="hljs-built_in">id</span>) == <span class="hljs-built_in">id</span>.lower())
    <span class="hljs-keyword">else</span>:
        query = select(self.model).<span class="hljs-built_in">filter</span>(self.model.<span class="hljs-built_in">id</span> == <span class="hljs-built_in">id</span>)

    result = <span class="hljs-keyword">await</span> db.execute(query)
    item = result.scalars().first()

    <span class="hljs-keyword">return</span> item
</code></pre>
<p>如果我们需要强制对外键的类型进行匹配（如对于Postgresql的严格要求，数据比较的类型必须一致），那么我们需要在基类或者CRUD类初始化的时候，获得对应的主键类型。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseCrud</span>(<span class="hljs-type">Generic</span>[ModelType, PrimaryKeyType, PageDtoType, DtoType]):
    <span class="hljs-string">"""
    基础CRUD操作类，传入参数说明：
    * `ModelType`: SQLAlchemy 模型类
    * `PrimaryKeyType`: 限定主键的类型
    * `PageDtoType`: 分页查询输入类
    * `DtoType`: 数据传输对象类，如新增、更新的单个对象DTO
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model: <span class="hljs-type">Type</span>[ModelType]</span>):
        <span class="hljs-string">"""
        数据库访问操作的基类对象(CRUD).
        * `model`: A SQLAlchemy model class
        """</span>
        
        self.model = model  <span class="hljs-comment"># 模型类型</span>

        <span class="hljs-comment"># 运行期获取主键字段类型</span>
        pk_column = inspect(model).primary_key[<span class="hljs-number">0</span>]
        self._pk_type = pk_column.<span class="hljs-built_in">type</span>.python_type  <span class="hljs-comment"># int / str</span>
</code></pre>
<p>因此对于单表的Get方法，我们修改下，让他匹配主键的类型进行比较，这样过对于严格类型判断的Postgresql也正常匹配了。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, db: AsyncSession, <span class="hljs-built_in">id</span>: PrimaryKeyType</span>) -&gt; <span class="hljs-type">Optional</span>[ModelType]:
        <span class="hljs-string">"""根据主键获取一个对象"""</span>
        
        <span class="hljs-comment">#对id的主键进行类型转换，self._pk_type在构造函数的初始化中获取</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-built_in">id</span> = self._pk_type(<span class="hljs-built_in">id</span>)
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Invalid primary key type: <span class="hljs-subst">{<span class="hljs-built_in">id</span>}</span>"</span>)
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">id</span>, <span class="hljs-built_in">str</span>):
            query = select(self.model).<span class="hljs-built_in">filter</span>(func.lower(self.model.<span class="hljs-built_in">id</span>) == <span class="hljs-built_in">id</span>.lower())
        <span class="hljs-keyword">else</span>:
            query = select(self.model).<span class="hljs-built_in">filter</span>(self.model.<span class="hljs-built_in">id</span> == <span class="hljs-built_in">id</span>)

        result = <span class="hljs-keyword">await</span> db.execute(query)
        item = result.scalars().first()

        <span class="hljs-keyword">return</span> item
</code></pre>
<p>对于删除的数据，我们也可以类似的处理对比进行了。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> Session, Query
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncSession
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> delete <span class="hljs-keyword">as</span> sa_delete, update <span class="hljs-keyword">as</span> sa_update

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_byid</span>(<span class="hljs-params">self, db: AsyncSession, <span class="hljs-built_in">id</span>: PrimaryKeyType</span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""根据主键删除一个对象
    
    :param id: 主键值
    """</span>
    
    <span class="hljs-comment">#对id的主键进行类型转换，self._pk_type在构造函数的初始化中获取</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">id</span> = self._pk_type(<span class="hljs-built_in">id</span>)
    <span class="hljs-keyword">except</span> Exception:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"Invalid primary key type: <span class="hljs-subst">{<span class="hljs-built_in">id</span>}</span>"</span>)
    
    del_query: sa_delete
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">id</span>, <span class="hljs-built_in">str</span>):
        del_query = sa_delete(self.model).where(
            func.lower(self.model.<span class="hljs-built_in">id</span>) == <span class="hljs-built_in">id</span>.lower()
        )
    <span class="hljs-keyword">else</span>:
        del_query = sa_delete(self.model).where(self.model.<span class="hljs-built_in">id</span> == <span class="hljs-built_in">id</span>)

    result = <span class="hljs-keyword">await</span> db.execute(del_query)

    <span class="hljs-keyword">await</span> db.commit()
    <span class="hljs-keyword">return</span> result.rowcount &gt; <span class="hljs-number">0</span>
</code></pre>
<p>对于提供多条件的查询或者过滤，我们可以使用<strong>where</strong>函数或者<strong>filter</strong>函数，在 SQLAlchemy 中，<code>select(...).where(...)</code> 和 <code>select(...).filter(...)</code> 都用于构造查询条件，如下所示等效。</p>
<pre><code class="hljs language-python" lang="python">query = select(self.model).where(self.model.<span class="hljs-built_in">id</span> == <span class="hljs-built_in">id</span>)

query = select(self.model).<span class="hljs-built_in">filter</span>(self.model.<span class="hljs-built_in">id</span> == <span class="hljs-built_in">id</span>)
</code></pre>
<p>我们可以通过sqlAlchemy的and_和or_函数来进行组合多个条件。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">from</span> sqlalchemy import ( <span class="hljs-keyword">Table</span>,<span class="hljs-keyword">Column</span>,and_,or_,<span class="hljs-keyword">asc</span>,<span class="hljs-keyword">desc</span>,<span class="hljs-keyword">select</span>,func,<span class="hljs-keyword">distinct</span>,text, <span class="hljs-type">Integer</span>)

....
    <span class="hljs-keyword">match</span> expression:
        <span class="hljs-keyword">case</span> "and":
            query <span class="hljs-operator">=</span> await db.execute(
                <span class="hljs-keyword">select</span>(self.model)
                .<span class="hljs-keyword">filter</span>(and_(  <span class="hljs-operator">*</span> where_list)) 
                .order_by(<span class="hljs-operator">*</span>order_by_list)
            )
        <span class="hljs-keyword">case</span> "or":
            query <span class="hljs-operator">=</span> await db.execute(
                <span class="hljs-keyword">select</span>(self.model).<span class="hljs-keyword">filter</span>(or_(  <span class="hljs-operator">*</span>where_list)) .order_by(<span class="hljs-operator">*</span>order_by_list)
            )
</code></pre>
<p>Python的SqlAlchemy提供 InstrumentedAttribute 对象来操作多个条件，如我们对于一些多条件的处理，可以利用它来传递多个参数。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all_by_attributes</span>(<span class="hljs-params">
        self, db: AsyncSession, *attributes: InstrumentedAttribute, sorting: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>
    </span>) -&gt; <span class="hljs-type">List</span>[ModelType] | <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""根据列名称和值获取相关的对象列表

        :param sorting: 格式：name asc 或 name asc,age desc
        :param attributes: SQLAlchemy InstrumentedAttribute objects，可以输入多个条件
        例子：User.id != 1 或者 User.username == "JohnDoe"
        """</span>

        order_by_list = parse_sort_string(sorting, self.model)
        query = select(self.model).<span class="hljs-built_in">filter</span>(and_(*attributes)).order_by(*order_by_list)
        
        result = <span class="hljs-keyword">await</span> db.execute(query)
        <span class="hljs-keyword">return</span> result.scalars().<span class="hljs-built_in">all</span>()
</code></pre>
<p>例如，对于 模型 Material 对象，我们对它进行多个条件的查询处理，如下所示，红色部分为 *attributes: InstrumentedAttribute 参数。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">items</span> = await super().get_all_by_attributes(
    db,
 <span class="hljs-attr">Material.id</span> == vercol.id,
    <span class="hljs-attr">Material.vercol</span> == vercol.vercol,
    <span class="hljs-attr">Material.ischecked</span> == <span class="hljs-number">0</span>,
    <span class="hljs-attr">Material.status</span> == <span class="hljs-number">0</span>, 
)
</code></pre>
<p>同样我们可以利用它来获取数量，或者判断多条件的记录是否存在。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/757682ba154a422caaa6813152a5e890~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyN5Y2O6IGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767240347&amp;x-signature=TJaMmqNVSsmbwb%2FVQgrgL%2B05Ezk%3D" alt="image" loading="lazy"/></p>
<p> 在数据插入或者更新的操作中，我们可以接受对象类型或者字典类型的参数对象，因此方法如下所示。</p>
<pre><code class="hljs language-python" lang="python">   <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, db: AsyncSession, obj_in: DtoType | <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""更新对象
        
        :param obj_in: 对象输入数据,可以是 DTO 对象或字典
        """</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(obj_in, <span class="hljs-built_in">dict</span>):
                obj_id = obj_in.get(<span class="hljs-string">"id"</span>)
                <span class="hljs-keyword">if</span> obj_id <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"id is required for update"</span>)
                update_data = obj_in
            <span class="hljs-keyword">else</span>:
                obj_id = obj_in.<span class="hljs-built_in">id</span>
                <span class="hljs-comment"># update_data = vars(obj_in)  </span>
                update_data = obj_in.model_dump(exclude_unset=<span class="hljs-literal">True</span>)

            query = select(self.model).<span class="hljs-built_in">filter</span>(self.model.<span class="hljs-built_in">id</span> == obj_id)
            result = <span class="hljs-keyword">await</span> db.execute(query)
            db_obj = result.scalars().first()

            <span class="hljs-keyword">if</span> db_obj:
                <span class="hljs-comment"># 更新对象字段</span>
                <span class="hljs-keyword">for</span> field, value <span class="hljs-keyword">in</span> update_data.items():
                    <span class="hljs-comment"># 跳过以 "_" 开头的私有属性</span>
                    <span class="hljs-keyword">if</span> field.startswith(<span class="hljs-string">"_"</span>):
                        <span class="hljs-keyword">continue</span>
                    <span class="hljs-built_in">setattr</span>(db_obj, field, value)

                <span class="hljs-comment"># 处理更新前的回调处理</span>
 self.on_before_update(update_data, db_obj) <span class="hljs-comment"># 提交事务</span>
                <span class="hljs-keyword">await</span> db.commit()
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">except</span> SQLAlchemyError <span class="hljs-keyword">as</span> e:
            self.logger.error(<span class="hljs-string">f"update 操作出现错误: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">await</span> db.rollback()  <span class="hljs-comment"># 确保在出错时回滚事务</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p>我们在插入或者更新数据的时候，一般会默认更新一些字段，如创建人，创建日期、编辑人，编辑日期等信息，我们可以把它单独作为一个可以给子类重写的函数，基类做一些默认的处理。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_before_update</span>(<span class="hljs-params">self, update_data: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>], db_obj: ModelType</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""更新对象前的回调函数，子类可以重写此方法

        可通过 setattr(db_obj, field, value) 设置字段值
        """</span>
        
        <span class="hljs-built_in">setattr</span>(db_obj, <span class="hljs-string">"edittime"</span>, datetime.now())
        user :CurrentUserIns  = get_current_user()
        <span class="hljs-keyword">if</span> user:
            <span class="hljs-built_in">setattr</span>(db_obj, <span class="hljs-string">"editor"</span>, user.fullname)
            <span class="hljs-built_in">setattr</span>(db_obj, <span class="hljs-string">"editor_id"</span>, user.<span class="hljs-built_in">id</span>)

            <span class="hljs-built_in">setattr</span>(db_obj, <span class="hljs-string">"company_id"</span>, user.company_id)
            <span class="hljs-built_in">setattr</span>(db_obj, <span class="hljs-string">"companyname"</span>, user.companyname)
</code></pre>
<p>有时候，如果我们需要获取某个字段非重复的列表，用来做为动态下拉列表的数据，那么我们可以通过下面函数封装下。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_field_list</span>(<span class="hljs-params">self, db: AsyncSession, field_name: <span class="hljs-built_in">str</span></span>) -&gt; Iterable[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""获取指定字段值的唯一列表

        :param field_name: 字段名称
        """</span>

        field = <span class="hljs-built_in">getattr</span>(self.model, field_name)
        query = select(distinct(field))
        result = <span class="hljs-keyword">await</span> db.execute(query)
        <span class="hljs-keyword">return</span> result.scalars().<span class="hljs-built_in">all</span>()
</code></pre>
<h3 data-id="heading-2">3、多表联合的处理操作 </h3>
<p>多表操作，也是我们经常碰到的处理方式，如对于字典类型和字典项目，他们是两个表，需要联合起来获取数据，那么就需要多表的联合操作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcde1deeeecb42ee9bf077f276e466df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyN5Y2O6IGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767240347&amp;x-signature=gqBb0Bk5oM2cfSPVZPjahlYledk%3D" alt="image" loading="lazy"/></p>
<p> 如下是字典CRUD类中，联合字典类型获取数据的记录处理。</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_dict_by_typename</span>(<span class="hljs-params">self, db: AsyncSession, dicttype_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">"""根据字典类型名称获取所有该类型的字典列表集合"""</span>
        result = <span class="hljs-keyword">await</span> db.execute(
            select(self.model)
             .join(DictType, DictType.<span class="hljs-built_in">id</span> == self.model.dicttype_id)   <span class="hljs-comment"># 关联字典类型表</span>
            .<span class="hljs-built_in">filter</span>(DictType.name == dicttype_name) <span class="hljs-comment"># 过滤字典类型名称</span>
            .order_by(DictData.seq)  <span class="hljs-comment"># 排序</span>
        )
        items = result.scalars().<span class="hljs-built_in">all</span>()

        <span class="hljs-built_in">dict</span> = {}
        <span class="hljs-keyword">for</span> info <span class="hljs-keyword">in</span> items:
            <span class="hljs-keyword">if</span> info.name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">dict</span>:
                <span class="hljs-built_in">dict</span>[info.name] = info.value

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">dict</span>
</code></pre>
<p>如果我们需要对某个表的递归获取树列表，可以如下处理</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tree</span>(<span class="hljs-params">self, db: AsyncSession, pid: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">list</span>[DictType]:
        <span class="hljs-string">"""获取字典类型一级列表及其下面的内容"""</span>

        <span class="hljs-comment"># 使用三元运算符将 pid 设为 "-1"（如果 pid 是 null 或空白）或保持原值</span>
        pid = <span class="hljs-string">"-1"</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pid <span class="hljs-keyword">or</span> pid.strip() == <span class="hljs-string">""</span> <span class="hljs-keyword">else</span> pid
        result = <span class="hljs-keyword">await</span> db.execute(
            select(self.model)
            .<span class="hljs-built_in">filter</span>(self.model.pid == pid)
            .options(selectinload(DictType.children))
        )
        nodes = result.scalars().<span class="hljs-built_in">all</span>()
        <span class="hljs-keyword">return</span> nodes
</code></pre>
<p>我们来假设用户和文章的示例表结构（ORM 模型，如下所示。</p>
<pre><code class="hljs language-ini" lang="ini">class User(Base):
    <span class="hljs-attr">__tablename__</span> = <span class="hljs-string">"users"</span>
    <span class="hljs-attr">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>)
    <span class="hljs-attr">name</span> = Column(String)
    <span class="hljs-attr">email</span> = Column(String)
    <span class="hljs-attr">articles</span> = relationship(<span class="hljs-string">"Article"</span>, back_populates=<span class="hljs-string">"author"</span>)


class Article(Base):
    <span class="hljs-attr">__tablename__</span> = <span class="hljs-string">"articles"</span>
    <span class="hljs-attr">id</span> = Column(Integer, primary_key=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>)
    <span class="hljs-attr">title</span> = Column(String)
    <span class="hljs-attr">content</span> = Column(Text)
    <span class="hljs-attr">user_id</span> = Column(Integer, ForeignKey(<span class="hljs-string">"users.id"</span>))
    <span class="hljs-attr">author</span> = relationship(<span class="hljs-string">"User"</span>, back_populates=<span class="hljs-string">"articles"</span>)
</code></pre>
<p>我们可以通过下面函数处理获得相关的记录集合。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_articles</span>(<span class="hljs-params">db: AsyncSession</span>):
    stmt = (
        select(User, Article)
        .join(Article, Article.user_id == User.<span class="hljs-built_in">id</span>)
    )
    result = <span class="hljs-keyword">await</span> db.execute(stmt)
    <span class="hljs-keyword">return</span> result.<span class="hljs-built_in">all</span>()   <span class="hljs-comment"># [ (User(), Article()), . ..]</span>
</code></pre>
<p>如果需要可以使用outer_join函数处理</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_users_with_articles</span>(<span class="hljs-params">db: AsyncSession</span>):
    stmt = (
        select(User, Article)
        .outerjoin(Article, Article.user_id == User.<span class="hljs-built_in">id</span>)
    )
    result = <span class="hljs-keyword">await</span> db.execute(stmt)
    <span class="hljs-keyword">return</span> result.<span class="hljs-built_in">all</span>()  <span class="hljs-comment"># 用户即便没有文章也会出现</span>
</code></pre>
<p>如果我们需要获取有文章的所有用户，如下所示。</p>
<pre><code class="hljs language-scss" lang="scss">async def <span class="hljs-built_in">get_users_with_articles</span>(db: AsyncSession):
    stmt = <span class="hljs-built_in">select</span>(User).<span class="hljs-built_in">options</span>(<span class="hljs-built_in">selectinload</span>(User.articles))  # 自动 load 关联
    result = await db.<span class="hljs-built_in">execute</span>(stmt)
    return result.<span class="hljs-built_in">scalars</span>().<span class="hljs-built_in">all</span>()
</code></pre>
<p><code>selectinload</code> 会执行两次 SQL，但效率高，不会产生笛卡尔积，非常适合集合查询。</p>
<p>多表链式 Join的处理，可以获得两个表的不同信息进行组合。</p>
<pre><code class="hljs language-css" lang="css">async def get_articles_with_author(db: AsyncSession):
    stmt = (
        <span class="hljs-built_in">select</span>(Article.title, User.name.<span class="hljs-built_in">label</span>(<span class="hljs-string">"author"</span>))
        .<span class="hljs-built_in">join</span>(User, Article.user_id == User.id)
    )
    rows = await db.<span class="hljs-built_in">execute</span>(stmt)
    return rows.<span class="hljs-built_in">mappings</span>().<span class="hljs-built_in">all</span>()   # 以 dict 形式返回 [{'title':..., <span class="hljs-string">'author'</span>:...}]
</code></pre>
<p>带筛选条件与分页的处理实现，如下所示</p>
<pre><code class="hljs language-scss" lang="scss">async def <span class="hljs-built_in">search_articles</span>(db: AsyncSession, keyword: str, page: int = <span class="hljs-number">1</span>, size: int = <span class="hljs-number">10</span>):
    stmt = (
        <span class="hljs-built_in">select</span>(Article, User.name.<span class="hljs-built_in">label</span>(<span class="hljs-string">"author"</span>))
        .<span class="hljs-built_in">join</span>(User)
        .<span class="hljs-built_in">filter</span>(Article.title.<span class="hljs-built_in">contains</span>(keyword))
        .<span class="hljs-built_in">offset</span>((page - <span class="hljs-number">1</span>) * size)
        .<span class="hljs-built_in">limit</span>(size)
    )
    result = await db.<span class="hljs-built_in">execute</span>(stmt)
    return result.<span class="hljs-built_in">mappings</span>().<span class="hljs-built_in">all</span>()
</code></pre>
<p> 
对于权限管理系统来说，一般有用户、角色，以及用户角色的中间表，我们来看看这个在SQLAlchemy最佳实践是如何的操作。</p>
<pre><code class="hljs language-ini" lang="ini">from sqlalchemy import Table, Column, Integer, ForeignKey
from sqlalchemy.orm import relationship, Mapped, mapped_column
from database import Base

<span class="hljs-comment"># --- 中间表写法 ---</span>
<span class="hljs-attr">role_user</span> = Table(
    "role_user",
    Base.metadata,
    Column("user_id", ForeignKey("users.id"), <span class="hljs-attr">primary_key</span>=<span class="hljs-literal">True</span>),
    Column("role_id", ForeignKey("roles.id"), <span class="hljs-attr">primary_key</span>=<span class="hljs-literal">True</span>)
)

class User(Base):
    <span class="hljs-attr">__tablename__</span> = <span class="hljs-string">"users"</span>
    id: Mapped<span class="hljs-section">[int]</span> = mapped_column(<span class="hljs-attr">primary_key</span>=<span class="hljs-literal">True</span>)
    username: Mapped<span class="hljs-section">[str]</span> = mapped_column()

    roles: Mapped<span class="hljs-section">[list["Role"]]</span> = relationship(
        <span class="hljs-attr">secondary</span>=role_user,
        <span class="hljs-attr">back_populates</span>=<span class="hljs-string">"users"</span>,
        <span class="hljs-attr">lazy</span>=<span class="hljs-string">"selectin"</span>
    )

class Role(Base):
    <span class="hljs-attr">__tablename__</span> = <span class="hljs-string">"roles"</span>
    id: Mapped<span class="hljs-section">[int]</span> = mapped_column(<span class="hljs-attr">primary_key</span>=<span class="hljs-literal">True</span>)
    name: Mapped<span class="hljs-section">[str]</span> = mapped_column()

    users: Mapped<span class="hljs-section">[list[User]]</span> = relationship(
        <span class="hljs-attr">secondary</span>=role_user,
        <span class="hljs-attr">back_populates</span>=<span class="hljs-string">"roles"</span>,
        <span class="hljs-attr">lazy</span>=<span class="hljs-string">"selectin"</span>
    )
</code></pre>
<p>在 SQLAlchemy 声明多对多关系时，<code>secondary</code> 参数既可以填 <strong>字符串形式的表名</strong>，也可以填 <strong>已经定义好的中间表对象（Table 对象）。</strong></p>
<p><strong>① econdary="role_user" —— 使用字符串表名</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">roles</span> = relationship(<span class="hljs-string">"Role"</span>, secondary=<span class="hljs-string">"role_user"</span>, back_populates=<span class="hljs-string">"users"</span>)
</code></pre>
<p><strong>② secondary=role_user —— 传入中间表对象（推荐方式）</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">role_user</span> = Table(
    "role_user",
    Base.metadata,
    Column("user_id", ForeignKey("users.id"), <span class="hljs-attr">primary_key</span>=<span class="hljs-literal">True</span>),
    Column("role_id", ForeignKey("roles.id"), <span class="hljs-attr">primary_key</span>=<span class="hljs-literal">True</span>)
)

<span class="hljs-attr">roles</span> = relationship(<span class="hljs-string">"Role"</span>, secondary=role_user, back_populates=<span class="hljs-string">"users"</span>)
</code></pre>
<p>对于如果获取对应角色的用户记录，我们可以通过下面方式获取（通过连接中间表的方式）</p>
<pre><code class="hljs language-ini" lang="ini">async def get_users_by_role(db: AsyncSession, role_id: int) -&gt; list<span class="hljs-section">[User]</span>:
    <span class="hljs-attr">stmt</span> = (
        select(User)
        .join(role_user, <span class="hljs-attr">role_user.c.user_id</span> == User.id)
        .where(<span class="hljs-attr">role_user.c.role_id</span> == role_id)
    )
    <span class="hljs-attr">result</span> = await db.execute(stmt)
    return result.scalars().all()
</code></pre>
<p>也可以下面的方式进行处理（使用 relationship any()），效果是一样的。</p>
<pre><code class="hljs language-python" lang="python">select(User).<span class="hljs-built_in">filter</span>(User.roles.<span class="hljs-built_in">any</span>(<span class="hljs-built_in">id</span>=role_id))
</code></pre>
<p>如果需要写入用户、角色的关联关系，我们可以使用下面方法来通过中间表进行判断并写入记录。</p>
<pre><code class="hljs language-ini" lang="ini">from sqlalchemy import select, insert

async def add_users_to_role(db: AsyncSession, role_id: int, user_ids: list<span class="hljs-section">[int]</span>):
    <span class="hljs-comment"># 1️⃣ 查询已有关联 user_id</span>
    <span class="hljs-attr">stmt</span> = select(role_user.c.user_id).where(role_user.c.role_id == role_id)
    <span class="hljs-attr">res</span> = await db.execute(stmt)
    <span class="hljs-attr">existing_user_ids</span> = {row[<span class="hljs-number">0</span>] for row in res.fetchall()}

    <span class="hljs-comment"># 2️⃣ 过滤出新的 user_id</span>
    <span class="hljs-attr">new_user_ids</span> = [uid for uid in user_ids if uid not in existing_user_ids]
    if not new_user_ids:
        return 0  <span class="hljs-comment"># 没有新增</span>

    <span class="hljs-comment"># 3️⃣ 批量插入</span>
    <span class="hljs-attr">values</span> = [{<span class="hljs-string">"user_id"</span>: uid, <span class="hljs-string">"role_id"</span>: role_id} for uid in new_user_ids]
    <span class="hljs-attr">stmt</span> = insert(role_user).values(values)
    await db.execute(stmt)
    await db.commit()

    return len(new_user_ids)
</code></pre>
<p>如果只是单个记录的插入，可以利用下面的方式处理。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, insert

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_user_to_role</span>(<span class="hljs-params">db: AsyncSession, role_id: <span class="hljs-built_in">int</span>, user_id: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-comment"># 1️⃣ 检查是否已存在关联</span>
    stmt = select(role_user).where(
        role_user.c.role_id == role_id,
        role_user.c.user_id == user_id
    )
    res = <span class="hljs-keyword">await</span> db.execute(stmt)
    exists = res.first()

    <span class="hljs-keyword">if</span> exists:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>  <span class="hljs-comment"># 已存在，不再插入</span>

    <span class="hljs-comment"># 2️⃣ 插入记录</span>
    stmt = insert(role_user).values(user_id=user_id, role_id=role_id)
    <span class="hljs-keyword">await</span> db.execute(stmt)
    <span class="hljs-keyword">await</span> db.commit()

    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
</code></pre>
<p>以上就是对于在Python+FastAPI的后端项目中使用SqlAlchemy操作数据的几种常见方式，包括单表处理，多表关联、中间表的数据维护和定义等内容，是我们在操作常规数据的时候，经常碰到的几种方式。</p>
<p>希望上文对你有所启发和帮助，感谢阅读。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python性能翻倍的5个隐藏技巧：让你的代码跑得比同事快50%]]></title>    <link>https://juejin.cn/post/7587322796825870376</link>    <guid>https://juejin.cn/post/7587322796825870376</guid>    <pubDate>2025-12-25T04:16:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587322796825870376" data-draft-id="7587327550872895488" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python性能翻倍的5个隐藏技巧：让你的代码跑得比同事快50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-25T04:16:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python性能翻倍的5个隐藏技巧：让你的代码跑得比同事快50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T04:16:48.000Z" title="Thu Dec 25 2025 04:16:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python性能翻倍的5个隐藏技巧：让你的代码跑得比同事快50%</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>Python因其简洁易读的语法和强大的生态系统而广受欢迎，但在性能方面却常常被人诟病。然而，Python的性能问题并非无解——通过一些鲜为人知的优化技巧，你可以显著提升代码的执行效率。本文将深入探讨5个经过验证的隐藏技巧，帮助你轻松实现性能翻倍，甚至在某些场景下比同事的代码快50%以上。这些技巧涵盖了从数据结构选择到底层优化的多个层面，适合中高级开发者进一步提升代码效率。</p>
<hr/>
<h3 data-id="heading-2">1. 使用内置函数和库替代手动实现</h3>
<h4 data-id="heading-3">为什么有效？</h4>
<p>Python的内置函数（如<code>map()</code>、<code>filter()</code>、<code>sum()</code>）和标准库（如<code>collections</code>、<code>itertools</code>）是用C实现的，执行速度远高于纯Python代码。许多开发者习惯手动实现这些功能，却忽略了内置函数的性能优势。</p>
<h4 data-id="heading-4">示例对比</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 手动求和</span>
total = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> large_list:
    total += num

<span class="hljs-comment"># 使用sum()内置函数</span>
total = <span class="hljs-built_in">sum</span>(large_list)
</code></pre>
<p>后者不仅更简洁，而且在处理大规模数据时速度可能快2-3倍。类似的优化还包括：</p>
<ul>
<li>用<code>collections.defaultdict</code>替代字典的手动初始化</li>
<li>用<code>itertools.chain</code>合并多个迭代器而非嵌套循环</li>
</ul>
<h4 data-id="heading-5">实测数据</h4>
<p>在1000万次加法测试中，<code>sum()</code>比手动循环快约60%。</p>
<hr/>
<h3 data-id="heading-6">2. 利用局部变量加速访问</h3>
<h4 data-id="heading-7">原理分析</h4>
<p>Python的变量查找遵循LEGB规则（Local → Enclosing → Global → Built-in），局部变量的访问速度最快。将频繁使用的全局变量或类属性赋值给局部变量，可以减少查找时间。</p>
<h4 data-id="heading-8">优化示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 未优化版本</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">data</span>):
    result = []
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:
        result.append(math.sqrt(item) * config.factor)  <span class="hljs-comment"># config.factor是全局变量</span>

<span class="hljs-comment"># 优化后版本</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">data</span>):
    factor = config.factor  <span class="hljs-comment"># 局部化全局变量</span>
    sqrt_func = math.sqrt   <span class="hljs-comment"># 避免多次属性查找</span>
    result = []
    append = result.append  <span class="hljs-comment"># 方法也转为局部变量</span>
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:
        append(sqrt_func(item) * factor)
</code></pre>
<p>这种优化在循环次数超过10万次时可能带来20%-30%的性能提升。</p>
<hr/>
<h3 data-id="heading-9">3. <strong><strong>slots</strong></strong>魔法：减少内存占用与加速属性访问</h3>
<h4 data-id="heading-10"><strong>slots</strong>的作用</h4>
<p>默认情况下，Python类的实例使用字典（<code>__dict__</code>）存储属性，这带来了灵活性但也增加了内存和访问开销。通过定义<code>__slots__</code>，可以固定类的属性列表，节省内存并提升访问速度。</p>
<h4 data-id="heading-11"><strong>示例代码</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RegularUser</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, uid</span>):
        self.name = name
        self.uid = uid

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SlotUser</span>:
    __slots__ = [<span class="hljs-string">'name'</span>, <span class="hljs-string">'uid'</span>]
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, uid</span>):
        self.name = name
        self.uid = uid
</code></pre>
<h4 data-id="heading-12"><strong>性能对比</strong></h4>
<ul>
<li><strong>内存占用</strong>：在100万个实例的测试中，使用<code>__slots__</code>可减少40%-50%的内存。</li>
<li><strong>访问速度</strong>：属性读取速度快约20%。</li>
</ul>
<p>注意：仅适用于属性固定的类，且会牺牲动态添加属性的能力。</p>
<hr/>
<h3 data-id="heading-13">4. NumPy/Pandas向量化操作替代循环</h3>
<h4 data-id="heading-14"><strong>向量化的力量</strong></h4>
<p>对于数值计算任务（如矩阵运算、统计聚合），NumPy和Pandas的底层C/Fortran实现比Python循环高效几个数量级。关键在于避免逐元素操作，转而使用内置的向量化函数。</p>
<h4 data-id="heading-15"><strong>典型案例</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 低效的逐元素平方</span>
squares = [x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> big_list]

<span class="hljs-comment"># NumPy向量化版本</span>
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
arr = np.array(big_list)
squares = arr ** <span class="hljs-number">2</span>  <span class="hljs-comment"># Speedup: ~100x for large arrays</span>
</code></pre>
<h4 data-id="heading-16"><strong>进阶技巧</strong></h4>
<ul>
<li>Pandas的<code>.apply()</code>仍然较慢，优先使用<code>.map()</code>或<code>.transform()</code></li>
<li>NumPy的广播机制（Broadcasting）可避免显式循环</li>
</ul>
<hr/>
<h3 data-id="heading-17">5. JIT编译：用Numba突破解释器限制</h3>
<h4 data-id="heading-18"><strong>Numba简介</strong></h4>
<p>Numba是一个JIT（Just-In-Time）编译器，能将Python函数编译为机器码。特别适合数值计算密集型任务（如科学计算、算法核心逻辑）。无需重写代码——只需添加一个装饰器即可获得C级别的速度。</p>
<h4 data-id="heading-19"><strong>使用方法</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> numba <span class="hljs-keyword">import</span> njit

<span class="hljs-meta">@njit(<span class="hljs-params">fastmath=<span class="hljs-literal">True</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">monte_carlo_pi</span>(<span class="hljs-params">n_samples</span>): 
    acc = <span class="hljs-number">0</span> 
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_samples): 
        x, y = np.random.random(), np.random.random() 
        <span class="hljs-keyword">if</span> (x**<span class="hljs-number">2</span> + y**<span class="hljs-number">2</span>) &lt; <span class="hljs-number">1.0</span>: 
            acc +=<span class="hljs-number">1</span> 
    return4 * acc / n_samples 

<span class="hljs-comment"># First run includes compilation time </span>
pi_estimate=monte_carlo_pi(<span class="hljs-number">1000000</span>)<span class="hljs-comment"># Subsequent calls are极速执行!</span>
</code></pre>
<h4 data-id="heading-20"><strong>性能收益</strong></h4>
<p>在蒙特卡洛模拟等场景下,Numba可提速100倍以上(对比纯Python实现)。</p>
<hr/>
<p>###总结</p>
<p>这五个技巧覆盖了从语言特性(<code>slots</code>,局部变量)到工具链(Numba,NumPy)的多维度优化手段:</p>
<p>1.<strong>优先使用内置函数/库</strong>
2.<strong>局部化频繁访问的变量</strong>
3.<strong>对固定属性类启用slots</strong>
4.<strong>数值计算务必向量化</strong>
5.<strong>关键路径考虑JIT编译</strong></p>
<p>需要强调的是:优化前务必先用cProfile定位瓶颈!盲目应用这些技术可能导致代码可读性下降却收效甚微。</p>
<p>当你将这些方法组合使用时,完全可能在保持Python开发效率的同时,让关键代码段的性能匹敌C/Java实现—这才是真正的"全栈Python"高手之道!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[ChannelMask节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7587336857538658313</link>    <guid>https://juejin.cn/post/7587336857538658313</guid>    <pubDate>2025-12-25T04:38:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587336857538658313" data-draft-id="7587325326046429193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[ChannelMask节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2025-12-25T04:38:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[ChannelMask节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T04:38:50.000Z" title="Thu Dec 25 2025 04:38:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<h2 data-id="heading-0">节点功能概述</h2>
<p>ChannelMask节点是Unity通用渲染管线（URP）中Shader Graph的重要组成部分，专门用于实现通道级的颜色操作。该节点通过动态通道选择机制，能够对输入向量进行选择性屏蔽，其核心优势在于非破坏性编辑——仅调整指定通道，而不会影响其他数据。这一特性在材质编辑、特效合成以及性能优化等场景中具有关键作用。</p>
<p>在URP渲染管线中，ChannelMask节点与SRP Batcher深度兼容，通过批量处理通道操作有效减少Draw Call。节点具备动态维度适配能力，可自动处理Vector2/Vector3/Vector4等不同类型的输入。例如，当连接纹理采样节点时，系统会根据RGBA通道自动生成相应选项，从而显著降低Shader开发的复杂度，使开发者能够更专注于视觉效果的实现。</p>
<h2 data-id="heading-1">端口配置详解</h2>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/ChannelMaskNodeThumb.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">输入端口（In）</h3>
<ul>
<li><strong>类型</strong>：动态矢量（Dynamic Vector）</li>
<li><strong>绑定</strong>：无</li>
<li><strong>特性</strong>：
<ul>
<li>支持自动类型推导，可连接任意输出矢量型节点</li>
<li>输入维度决定可选通道范围（例如，Vector3输入仅显示R、G、B选项）</li>
<li>在URP管线中，该端口与StandardLit材质中的基础色通道完全兼容</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">输出端口（Out）</h3>
<ul>
<li><strong>类型</strong>：动态矢量</li>
<li><strong>绑定</strong>：无</li>
<li><strong>特性</strong>：
<ul>
<li>输出维度与输入保持一致，确保数据流完整性</li>
<li>支持多节点串联输出，便于构建复杂通道处理流水线</li>
<li>在URP渲染过程中，输出结果可直接应用于Albedo、Metallic等材质通道</li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">控件参数分析</h2>
<h3 data-id="heading-5">Channels控件</h3>
<ul>
<li><strong>类型</strong>：动态掩码下拉选单</li>
<li><strong>行为逻辑</strong>：
<ul>
<li>当输入为Vector4时，显示R、G、B、A四个选项</li>
<li>支持多选操作（例如同时屏蔽R和G通道）</li>
<li>选项命名与URP材质通道规范保持一致</li>
</ul>
</li>
<li><strong>特殊场景</strong>：
<ul>
<li>连接法线贴图时，自动转换为X、Y、Z通道选项</li>
<li>处理HDR颜色时，通道值会依据URP线性空间规则重新计算</li>
</ul>
</li>
</ul>
<h2 data-id="heading-6">数学原理与代码实现</h2>
<h3 data-id="heading-7">HLSL核心逻辑</h3>
<p><code>// 示例：屏蔽红色通道的Vector4处理 void Unity_ChannelMask_Red_float4(float4 In, out float4 Out) {     Out = float4(0, In.g, In.b, In.a); }</code></p>
<h3 data-id="heading-8">URP适配特性</h3>
<ol>
<li><strong>线性空间处理</strong>：在URP的线性颜色空间下，通道屏蔽操作自动应用Gamma校正</li>
<li><strong>HDR支持</strong>：处理HDR颜色时，屏蔽操作会保留高动态范围数据</li>
<li><strong>批处理优化</strong>：在SRP Batcher中，相同通道掩码的节点会被合并为单个Draw Call</li>
</ol>
<h2 data-id="heading-9">实际应用场景</h2>
<h3 data-id="heading-10">材质编辑</h3>
<ul>
<li><strong>金属度控制</strong>：通过屏蔽红色通道分离金属反射信息</li>
<li><strong>法线贴图处理</strong>：屏蔽Alpha通道以实现法线压缩</li>
<li><strong>次表面散射</strong>：单独处理绿色通道以模拟皮肤透光效果</li>
</ul>
<h3 data-id="heading-11">特效制作</h3>
<ul>
<li><strong>发光效果</strong>：屏蔽所有通道仅保留亮度通道</li>
<li><strong>颜色渐变</strong>：动态切换通道实现实时颜色过渡</li>
<li><strong>故障特效</strong>：随机屏蔽通道以模拟数字失真效果</li>
</ul>
<h3 data-id="heading-12">性能优化</h3>
<ul>
<li><strong>通道压缩</strong>：屏蔽无用通道以减少纹理采样量</li>
<li><strong>LOD适配</strong>：根据距离动态调整通道精度</li>
<li><strong>移动端优化</strong>：在低端设备上屏蔽非必要通道</li>
</ul>
<h2 data-id="heading-13">性能优化策略</h2>
<h3 data-id="heading-14">URP专属优化</h3>
<ol>
<li><strong>SRP Batcher兼容</strong>：确保通道掩码操作在相同材质实例中进行</li>
<li><strong>动态分辨率适配</strong>：根据屏幕分辨率调整通道精度</li>
<li><strong>GPU Instancing支持</strong>：对使用相同通道掩码的物体进行批处理</li>
</ol>
<h3 data-id="heading-15">通用优化技巧</h3>
<ul>
<li>避免在片段着色器中频繁修改通道掩码</li>
<li>使用通道预计算节点减少实时计算量</li>
<li>利用URP的Shader Variants系统创建不同通道配置的变体</li>
</ul>
<h2 data-id="heading-16">常见问题解决方案</h2>
<h3 data-id="heading-17">URP特有问题</h3>
<ol>
<li><strong>通道不显示</strong>：检查是否启用了URP的线性颜色空间</li>
<li><strong>性能下降</strong>：确认在移动端是否启用了不必要的通道</li>
<li><strong>渲染异常</strong>：验证通道掩码是否与URP材质属性冲突</li>
</ol>
<h3 data-id="heading-18">通用解决方案</h3>
<ul>
<li>使用URP的Shader Graph预览功能实时验证通道效果</li>
<li>通过Frame Debugger分析通道操作对渲染管线的影响</li>
<li>在URP的Quality设置中启用通道操作优化选项</li>
</ul>
<h2 data-id="heading-19">高级应用技巧</h2>
<h3 data-id="heading-20">URP管线集成</h3>
<ol>
<li><strong>与Volume系统结合</strong>：通过通道掩码实现动态材质修改</li>
<li><strong>与Lit Shader配合</strong>：控制URP标准材质的不同通道</li>
<li><strong>与Post Processing集成</strong>：在后期处理中应用通道操作</li>
</ol>
<h3 data-id="heading-21">动态通道控制</h3>
<ul>
<li>通过URP的MaterialPropertyBlock实现运行时通道修改</li>
<li>结合URP的Render Feature创建自定义通道处理流程</li>
<li>利用URP的Shader Variants系统创建多通道配置</li>
</ul>
<h2 data-id="heading-22">与其他节点的配合使用</h2>
<h3 data-id="heading-23">URP核心节点</h3>
<ol>
<li><strong>Sample Texture 2D</strong>：在纹理采样后应用通道掩码</li>
<li><strong>URP Lit Shader</strong>：控制标准材质的通道输出</li>
<li><strong>URP Render Features</strong>：在渲染管线中插入通道处理</li>
</ol>
<h3 data-id="heading-24">通用节点组合</h3>
<ul>
<li>与Math节点配合实现通道值计算</li>
<li>与Condition节点结合创建动态通道切换</li>
<li>与Texture Sample节点连接实现基于纹理的通道控制</li>
</ul>
<h2 data-id="heading-25">最佳实践指南</h2>
<h3 data-id="heading-26">URP开发规范</h3>
<ol>
<li>在URP项目中优先使用通道掩码而非颜色混合</li>
<li>为移动端创建简化通道配置的变体</li>
<li>利用URP的Shader Variants系统管理多通道配置</li>
</ol>
<h3 data-id="heading-27">通用实践建议</h3>
<ul>
<li>为复杂通道操作创建注释节点</li>
<li>使用URP的Shader Graph预览功能验证效果</li>
<li>定期检查通道操作对性能的影响</li>
</ul>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 全局样式污染问题复盘]]></title>    <link>https://juejin.cn/post/7587284708947771407</link>    <guid>https://juejin.cn/post/7587284708947771407</guid>    <pubDate>2025-12-25T02:22:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587284708947771407" data-draft-id="7587261253912969231" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 全局样式污染问题复盘"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-12-25T02:22:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大象的鼻子那么长"/> <meta itemprop="url" content="https://juejin.cn/user/2277843821926871"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 全局样式污染问题复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843821926871/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大象的鼻子那么长
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.4 融会贯通
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.4 融会贯通" title="VIP.4 融会贯通" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T02:22:34.000Z" title="Thu Dec 25 2025 02:22:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、问题现象</h2>
<h3 data-id="heading-1">1.1 问题描述</h3>
<p>VGM 编辑弹窗（使用 <code>CmcDialog</code> 组件）出现异常的内边距，导致弹窗内容布局错乱，表单元素间距过大。</p>
<h3 data-id="heading-2">1.2 问题截图</h3>
<p>弹窗内容区域出现了不应有的 <code>padding: 52px 50px</code> 样式，导致：</p>
<ul>
<li>表单内容被压缩</li>
<li>布局与设计稿不符</li>
<li>视觉效果异常</li>
</ul>
<h3 data-id="heading-3">1.3 影响范围</h3>
<p>所有使用 <code>el-dialog</code> 或基于 <code>el-dialog</code> 封装的组件（如 <code>CmcDialog</code>）都受到影响。</p>
<hr/>
<h2 data-id="heading-4">二、问题定位</h2>
<h3 data-id="heading-5">2.1 排查过程</h3>
<ol>
<li><strong>检查组件自身样式</strong> - <code>CmcDialog</code> 组件样式正常</li>
<li><strong>检查父组件样式</strong> - 使用 <code>CmcDialog</code> 的页面无异常样式</li>
<li><strong>使用 DevTools 检查</strong> - 发现 <code>.el-dialog</code> 被注入了全局样式</li>
<li><strong>全局搜索污染源</strong> - 搜索 <code>padding: 52px 50px</code> 定位到问题文件</li>
</ol>
<h3 data-id="heading-6">2.2 问题根源</h3>
<p>在 <code>src/views/search_service/ship-schedules/components/Subscribe.vue</code> 中发现以下代码：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style scoped lang="scss"&gt;
.subscriber-dialog {
  :global(.el-dialog) {
    padding: 52px 50px;
  }
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-7">2.3 为什么会造成全局污染？</h3>
<p>这里涉及到 Vue Scoped CSS 和 <code>:global()</code> 的工作原理：</p>
<h4 data-id="heading-8">Vue Scoped CSS 原理</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 编译前 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.subscriber-dialog</span> {
    <span class="hljs-attribute">color</span>: red;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 编译后 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.subscriber-dialog</span><span class="hljs-selector-attr">[data-v-xxxxx]</span> {
    <span class="hljs-attribute">color</span>: red;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</code></pre>
<p>Vue 会为 scoped 样式添加唯一的 <code>data-v-xxxxx</code> 属性选择器，确保样式只作用于当前组件。</p>
<h4 data-id="heading-9">:global() 的作用</h4>
<p><code>:global()</code> 是 CSS Modules 和 Vue 的一个特性，用于<strong>跳过 scoped 限制</strong>，生成全局样式：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 编译前</span>
<span class="hljs-selector-class">.subscriber-dialog</span> {
  :<span class="hljs-built_in">global</span>(.el-dialog) {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">52px</span> <span class="hljs-number">50px</span>;
  }
}

<span class="hljs-comment">// 编译后（注意：.el-dialog 没有 data-v 属性！）</span>
<span class="hljs-selector-class">.subscriber-dialog</span><span class="hljs-selector-attr">[data-v-xxxxx]</span> <span class="hljs-selector-class">.el-dialog</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">52px</span> <span class="hljs-number">50px</span>;
}

</code></pre>
<h4 data-id="heading-10">关键问题：el-dialog 的 DOM 结构</h4>
<p>Element Plus 的 <code>el-dialog</code> 默认会通过 <code>append-to-body</code> 将 DOM 挂载到 <code>&lt;body&gt;</code> 下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 页面内容 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subscriber-dialog"</span> <span class="hljs-attr">data-v-xxxxx</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 触发按钮 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- Dialog 被 teleport 到 body 下 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-overlay subscriber-dialog"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- modal-class 应用在这里 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-dialog"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 实际的 dialog --&gt;</span>
      ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

</code></pre>
<p>由于 <code>modal-class="subscriber-dialog"</code> 应用到了 <code>el-overlay</code> 上，而 <code>.el-dialog</code> 是其子元素，所以选择器 <code>.subscriber-dialog .el-dialog</code> 能够匹配到！</p>
<p><strong>但问题在于</strong>：<code>:global(.el-dialog)</code> 生成的样式<strong>没有足够的特异性限制</strong>，当其他页面的 dialog 也被挂载到 body 时，如果 CSS 加载顺序导致这个样式后加载，就会覆盖其他 dialog 的样式。</p>
<hr/>
<h2 data-id="heading-11">三、深度原理剖析</h2>
<h3 data-id="heading-12">3.1 CSS 特异性（Specificity）</h3>
<p>CSS 特异性决定了当多个规则应用于同一元素时，哪个规则优先：</p>

























<table><thead><tr><th>选择器类型</th><th>特异性值</th></tr></thead><tbody><tr><td>内联样式</td><td>1000</td></tr><tr><td>ID 选择器</td><td>100</td></tr><tr><td>类/属性/伪类</td><td>10</td></tr><tr><td>元素/伪元素</td><td>1</td></tr></tbody></table>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 特异性：20（两个类选择器）</span>
<span class="hljs-selector-class">.subscriber-dialog</span> <span class="hljs-selector-class">.el-dialog</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">52px</span> <span class="hljs-number">50px</span>;
}

<span class="hljs-comment">// 特异性：20（两个类选择器）</span>
<span class="hljs-selector-class">.cmc-dialog</span><span class="hljs-selector-class">.el-dialog</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
}

</code></pre>
<p>当特异性相同时，<strong>后加载的样式会覆盖先加载的样式</strong>。</p>
<h3 data-id="heading-13">3.2 样式加载顺序问题</h3>
<p>在 SPA 应用中，组件样式是按需加载的：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 用户访问首页 → 加载首页组件样式
<span class="hljs-bullet">2.</span> 用户访问船期页面 → 加载 Subscribe.vue 样式（包含全局污染）
<span class="hljs-bullet">3.</span> 用户访问 VGM 页面 → CmcDialog 样式被污染样式覆盖
</code></pre>
<h3 data-id="heading-14">3.3 Teleport/Portal 的影响</h3>
<p>Element Plus Dialog 使用 Vue 3 的 Teleport 特性：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;Teleport to="body"&gt;
  &lt;div class="el-overlay"&gt;
    &lt;div class="el-dialog"&gt;...&lt;/div&gt;
  &lt;/div&gt;
&lt;/Teleport&gt;
</code></pre>
<p>这导致：</p>
<ol>
<li>Dialog DOM 脱离了组件的 DOM 树</li>
<li>Scoped 样式的 <code>data-v-xxxxx</code> 属性无法正确应用</li>
<li>必须使用 <code>:global()</code> 或 <code>:deep()</code> 才能样式化 dialog</li>
</ol>
<hr/>
<h2 data-id="heading-15">四、修复方案</h2>
<h3 data-id="heading-16">4.1 修复污染源（治本）</h3>
<p><strong>修改前（错误写法）：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;el-dialog modal-class="subscriber-dialog"&gt;
  ...
&lt;/el-dialog&gt;

&lt;style scoped lang="scss"&gt;
.subscriber-dialog {
  :global(.el-dialog) {
    padding: 52px 50px;
  }
}
&lt;/style&gt;
</code></pre>
<p><strong>修改后（正确写法）：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;el-dialog class="subscriber-dialog-box" modal-class="subscriber-dialog"&gt;
  ...
&lt;/el-dialog&gt;

&lt;style scoped lang="scss"&gt;
// 使用 class 属性直接应用到 el-dialog 上
// 组合选择器确保只影响特定的 dialog
:global(.subscriber-dialog-box) {
  padding: 52px 50px;

  .el-dialog__header {
    display: none;
  }
}
&lt;/style&gt;
</code></pre>
<p><strong>关键改动：</strong></p>
<ol>
<li>使用 <code>class</code> 而非仅依赖 <code>modal-class</code></li>
<li>使用<strong>组合选择器</strong> <code>.subscriber-dialog-box</code> 确保唯一性</li>
<li>样式只作用于带有该特定类名的 dialog</li>
</ol>
<h3 data-id="heading-17">4.2 加固组件库（治标 + 防御）</h3>
<p>在 <code>CmcDialog</code> 组件中添加高优先级样式重置：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.cmc-dialog</span> {
  &amp;<span class="hljs-selector-class">.el-dialog</span> {
    <span class="hljs-comment">// 使用 !important 确保不被外部样式覆盖</span>
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">padding-right</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
  }

  <span class="hljs-selector-class">.el-dialog__header</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
  }

  <span class="hljs-selector-class">.el-dialog__body</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
  }

  <span class="hljs-selector-class">.el-dialog__footer</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
  }
}

</code></pre>
<hr/>
<h2 data-id="heading-18">五、同类问题预防指南</h2>
<h3 data-id="heading-19">5.1 ❌ 错误写法示例</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 错误1：直接使用 :global 修改 Element Plus 组件</span>
:<span class="hljs-built_in">global</span>(.el-dialog) { ... }
:<span class="hljs-built_in">global</span>(.el-table) { ... }
:<span class="hljs-built_in">global</span>(.el-form) { ... }

<span class="hljs-comment">// 错误2：在 scoped 样式中使用过于宽泛的选择器</span>
<span class="hljs-selector-class">.my-page</span> {
  :<span class="hljs-built_in">global</span>(.el-button) {
    <span class="hljs-attribute">background</span>: red;
  }
}

<span class="hljs-comment">// 错误3：在全局样式文件中直接修改组件样式</span>
<span class="hljs-comment">// src/assets/styles/index.scss</span>
<span class="hljs-selector-class">.el-dialog</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">52px</span> <span class="hljs-number">50px</span>;
}
</code></pre>
<h3 data-id="heading-20">5.2 ✅ 正确写法示例</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 正确1：使用组合选择器，确保唯一性</span>
:<span class="hljs-built_in">global</span>(.my-specific-dialog.el-dialog) {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">52px</span> <span class="hljs-number">50px</span>;
}

<span class="hljs-comment">// 正确2：使用 BEM 命名 + 组合选择器</span>
:<span class="hljs-built_in">global</span>(.page-name__dialog.el-dialog) {
  <span class="hljs-comment">// 样式</span>
}

<span class="hljs-comment">// 正确3：在组件上使用 class 属性</span>
&lt;el-dialog class="my-unique-dialog"&gt;

<span class="hljs-comment">// 正确4：使用 CSS 变量进行定制</span>
<span class="hljs-selector-class">.my-dialog</span> {
  <span class="hljs-attr">--el-dialog-padding-primary</span>: <span class="hljs-number">52px</span> <span class="hljs-number">50px</span>;
}

</code></pre>
<h3 data-id="heading-21">5.3 代码审查检查清单</h3>
<p>在 Code Review 时，检查以下内容：</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了 <code>:global(.el-xxx)</code> 直接修改 Element Plus 组件？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 全局样式文件中是否有直接修改组件库样式的代码？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 使用 <code>:global()</code> 时是否添加了足够特异性的父选择器？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Dialog/Drawer 等 Teleport 组件是否使用了 <code>class</code> 属性？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 样式是否可能影响其他页面的同类组件？</li>
</ul>
<h3 data-id="heading-22">5.4 ESLint/Stylelint 规则建议</h3>
<p>可以配置 Stylelint 规则来检测潜在的全局污染：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// stylelint.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">rules</span>: {
    <span class="hljs-comment">// 禁止直接使用 Element Plus 类名作为选择器</span>
    <span class="hljs-string">'selector-disallowed-list'</span>: [
      <span class="hljs-string">'/^\\.el-(?!.*\\.)/'</span>, <span class="hljs-comment">// 匹配单独的 .el-xxx 选择器</span>
      {
        <span class="hljs-attr">message</span>: <span class="hljs-string">'请使用组合选择器避免全局污染，如 .my-class.el-dialog'</span>
      }
    ]
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-23">六、总结</h2>
<h3 data-id="heading-24">6.1 问题本质</h3>
<p>这是一个典型的 <strong>CSS 作用域泄漏</strong> 问题，由以下因素共同导致：</p>
<ol>
<li><strong>Teleport 机制</strong> - Dialog DOM 脱离组件树</li>
<li><strong>:global() 滥用</strong> - 跳过 scoped 限制</li>
<li><strong>选择器特异性不足</strong> - 没有使用组合选择器</li>
<li><strong>样式加载顺序</strong> - 后加载的样式覆盖先加载的</li>
</ol>
<h3 data-id="heading-25">6.2 核心教训</h3>
<ol>
<li><strong>永远不要直接 <code>:global(.el-xxx)</code></strong> - 必须添加特定的父选择器或组合选择器</li>
<li><strong>组件库封装要有防御性</strong> - 使用 <code>!important</code> 重置关键样式</li>
<li><strong>使用 <code>class</code> 而非仅 <code>modal-class</code></strong> - 确保样式能正确应用</li>
<li><strong>命名要有唯一性</strong> - 使用 BEM 或页面前缀避免冲突</li>
</ol>
<h3 data-id="heading-26">6.3 推荐的 Dialog 样式定制模式</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-dialog
    class="feature-name__dialog"
    modal-class="feature-name__overlay"
  &gt;
    ...
  &lt;/el-dialog&gt;
&lt;/template&gt;

&lt;style scoped lang="scss"&gt;
// 使用组合选择器，确保只影响当前组件的 dialog
:global(.feature-name__dialog.el-dialog) {
  // 自定义样式
}
&lt;/style&gt;
</code></pre>
<hr/>
<h2 data-id="heading-27">七、相关资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fapi%2Fsfc-css-features.html%23scoped-css" target="_blank" title="https://vuejs.org/api/sfc-css-features.html#scoped-css" ref="nofollow noopener noreferrer">Vue Scoped CSS 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FCSS%2FSpecificity" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/CSS/Specificity" ref="nofollow noopener noreferrer">CSS Specificity MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2Fzh-CN%2Fcomponent%2Fdialog.html" target="_blank" title="https://element-plus.org/zh-CN/component/dialog.html" ref="nofollow noopener noreferrer">Element Plus Dialog 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fbuilt-ins%2Fteleport.html" target="_blank" title="https://vuejs.org/guide/built-ins/teleport.html" ref="nofollow noopener noreferrer">Vue Teleport 文档</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 调用 Coze 工作流：从上传宠物照到生成冰球明星的完整技术解析]]></title>    <link>https://juejin.cn/post/7587263750250086451</link>    <guid>https://juejin.cn/post/7587263750250086451</guid>    <pubDate>2025-12-25T03:00:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587263750250086451" data-draft-id="7587238733503545387" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 调用 Coze 工作流：从上传宠物照到生成冰球明星的完整技术解析"/> <meta itemprop="keywords" content="前端,Vue.js,Coze"/> <meta itemprop="datePublished" content="2025-12-25T03:00:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 调用 Coze 工作流：从上传宠物照到生成冰球明星的完整技术解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T03:00:11.000Z" title="Thu Dec 25 2025 03:00:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"> 引言</h2>
<blockquote>
<p><strong>“你家的猫，也能打冰球？”</strong><br/>
不是玩笑——这是一次前端与 AI 工作流的完美邂逅。</p>
</blockquote>
<p>在当今 AI 应用爆发的时代，开发者不再满足于调用单一模型 API，而是通过 <strong>工作流（Workflow）</strong> 编排多个能力节点，实现复杂业务逻辑。而前端作为用户交互的第一线，如何优雅地集成这些 AI 能力，成为现代 Web 开发的重要课题。</p>
<p>本文将带你深入剖析一个真实项目：<strong>使用 Vue3 前端调用 Coze 平台的工作流 API，上传一张宠物照片，生成穿着定制队服、手持冰球杆的运动员形象图</strong>。我们将逐行解读 <code>App.vue</code> 源码，解释每一个 API 调用、每一段逻辑设计，并结合完整的 Coze 工作流图解，还原整个数据流转过程。文章内容严格引用原始代码（一字不变），确保技术细节 100% 准确。</p>
<hr/>
<h2 data-id="heading-1">一、项目背景与目标</h2>
<blockquote>
<p>AI 应用之冰球前端应用 vue3：冰球协会，上传宠物照片，生成运动员的形象照片。</p>
</blockquote>
<p>这个应用的核心功能非常明确：</p>
<ul>
<li>用户上传一张宠物（或人物）照片；</li>
<li>选择冰球队服编号、颜色、场上位置、持杆手、艺术风格等参数；</li>
<li>点击“生成”，系统调用 AI 工作流；</li>
<li>返回一张合成后的“冰球运动员”图像。</li>
</ul>
<p>而这一切的实现，完全依赖于 <strong>Coze 平台提供的工作流 API</strong>。前端负责收集输入、上传文件、发起请求、展示结果——典型的“轻前端 + 重 AI 后端”架构。</p>
<hr/>
<h2 data-id="heading-2">二、App.vue 整体结构概览</h2>
<p><code>App.vue</code> 是一个标准的 Vue3 单文件组件（SFC），采用 <code>&lt;script setup&gt;</code> 语法糖，结合 Composition API 实现响应式逻辑。整体分为三部分：</p>
<ol>
<li><strong><code>&lt;template&gt;</code></strong> ：用户界面（UI）</li>
<li><strong><code>&lt;script setup&gt;</code></strong> ：业务逻辑（JS）</li>
<li><strong><code>&lt;style scoped&gt;</code></strong> ：样式（CSS）</li>
</ol>
<p>我们先从模板入手，理解用户看到什么、能做什么。</p>
<hr/>
<h2 data-id="heading-3">三、模板（Template）详解：用户交互层</h2>
<h3 data-id="heading-4">3.1 文件上传与预览</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"file-input"</span>&gt;
  &lt;input 
    <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> 
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"uploadImage"</span> 
    <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span> 
    @<span class="hljs-attr">change</span>=<span class="hljs-string">"updateImageData"</span> required /&gt;
&lt;/div&gt;
&lt;img :<span class="hljs-attr">src</span>=<span class="hljs-string">"imgPreview"</span> alt=<span class="hljs-string">""</span> v-if=<span class="hljs-string">"imgPreview"</span>/&gt;
</code></pre>
<ul>
<li><code>&lt;input type="file"&gt;</code>：原生文件选择器，限制只接受图片（<code>accept="image/*"</code>）。</li>
<li><code>ref="uploadImage"</code>：通过 <code>ref</code> 获取该 DOM 元素，便于 JS 中读取文件。</li>
<li><code>@change="updateImageData"</code>：当用户选择文件后，立即触发 <code>updateImageData</code> 方法，生成本地预览。</li>
<li><code>imgPreview</code> 是一个响应式变量，用于显示 Data URL 格式的预览图，无需上传即可看到效果。</li>
</ul>
<blockquote>
<p>✅ <strong>用户体验亮点</strong>：即使图片很大、上传很慢，用户也能立刻确认自己选对了图。</p>
</blockquote>
<h3 data-id="heading-5">3.2 表单参数设置</h3>
<p>接下来是两组设置项，全部使用 <code>v-model</code> 双向绑定：</p>
<h4 data-id="heading-6">第一组：队服信息</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"settings"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"selection"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>队服编号:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"uniform_number"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"selection"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>队服颜色:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"uniform_color"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"红"</span>&gt;</span>红<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"蓝"</span>&gt;</span>蓝<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"绿"</span>&gt;</span>绿<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"白"</span>&gt;</span>白<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"黑"</span>&gt;</span>黑<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li><code>uniform_number</code>：默认值为 <code>10</code>（见 script 部分），支持任意数字。</li>
<li><code>uniform_color</code>：限定五种颜色，值为中文字符串（如 <code>"红"</code>）。</li>
</ul>
<h4 data-id="heading-7">第二组：角色与风格</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"settings"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"selection"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>位置：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"position"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"0"</span>&gt;</span>守门员<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>&gt;</span>前锋<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"2"</span>&gt;</span>后卫<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"selection"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>持杆：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"shooting_hand"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"0"</span>&gt;</span>左手<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>&gt;</span>右手<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"selection"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>风格：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"style"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"写实"</span>&gt;</span>写实<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"乐高"</span>&gt;</span>乐高<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"国漫"</span>&gt;</span>国漫<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"日漫"</span>&gt;</span>日漫<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"油画"</span>&gt;</span>油画<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"涂鸦"</span>&gt;</span>涂鸦<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"素描"</span>&gt;</span>素描<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li><code>position</code> 和 <code>shooting_hand</code> 的值虽然是数字字符串（<code>"0"</code>/<code>"1"</code>/<code>"2"</code>），但前端显示为中文，兼顾可读性与后端兼容性。</li>
<li><code>style</code> 提供 7 种艺术风格，极大增强趣味性和分享欲。</li>
</ul>
<h3 data-id="heading-8">3.3 生成按钮与输出区域</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"generate"</span>&gt;
  &lt;button @<span class="hljs-attr">click</span>=<span class="hljs-string">"generate"</span>&gt;生成&lt;/button&gt;
&lt;/div&gt;
</code></pre>
<p>点击后触发 <code>generate()</code> 函数，启动整个 AI 生成流程。</p>
<p>输出区域：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"output"</span>&gt;
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"generated"</span>&gt;
    &lt;img :<span class="hljs-attr">src</span>=<span class="hljs-string">"imgUrl"</span> alt=<span class="hljs-string">""</span> v-if=<span class="hljs-string">"imgUrl"</span>/&gt;
    &lt;div <span class="hljs-attr">v-if</span>=<span class="hljs-string">"status"</span>&gt;{{ status }}&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<ul>
<li><code>imgUrl</code>：存储 Coze 返回的生成图 URL。</li>
<li><code>status</code>：动态显示当前状态（如“上传中…”、“生成失败”等），避免用户焦虑。</li>
</ul>
<blockquote>
<p>💡 <strong>设计哲学</strong>：状态反馈是良好 UX 的核心。没有反馈的“生成”按钮，等于黑盒。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">四、脚本逻辑（Script Setup）深度解析</h2>
<p>现在进入最核心的部分——JavaScript 逻辑。</p>
<h3 data-id="heading-10">4.1 环境配置与常量定义</h3>
<pre><code class="hljs language-ini" lang="ini">import { ref, onMounted } from 'vue'

const <span class="hljs-attr">patToken</span> = import.meta.env.VITE_PAT_TOKEN<span class="hljs-comment">;</span>
const <span class="hljs-attr">uploadUrl</span> = <span class="hljs-string">'https://api.coze.cn/v1/files/upload'</span><span class="hljs-comment">;</span>
const <span class="hljs-attr">workflowUrl</span> = <span class="hljs-string">'https://api.coze.cn/v1/workflow/run'</span><span class="hljs-comment">;</span>
const <span class="hljs-attr">workflow_id</span> = <span class="hljs-string">'7584046136391630898'</span><span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>
<p><code>import.meta.env.VITE_PAT_TOKEN</code>：Vite 提供的环境变量注入机制。<code>.env</code> 文件中应包含：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">VITE_PAT_TOKEN</span>=cztei_lvNwngHgch9rxNlx4KiXuky3UjfW9iqCZRe17KDXjh22RLL8sPLsb8Vl10R3IHJsW
</code></pre>
</li>
<li>
<p><code>uploadUrl</code>：Coze 官方文件上传接口（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.coze.com%2Freference%2Fupload_file" title="https://docs.coze.com/reference/upload_file" target="_blank" ref="nofollow noopener noreferrer">文档</a>）。</p>
</li>
<li>
<p><code>workflowUrl</code>：触发工作流的入口（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.coze.com%2Freference%2Frun_workflow" title="https://docs.coze.com/reference/run_workflow" target="_blank" ref="nofollow noopener noreferrer">文档</a>）。</p>
</li>
<li>
<p><code>workflow_id</code>：在 Coze 控制台创建的工作流唯一 ID，内部已配置好图像生成逻辑（如调用文生图模型、叠加队服等）。</p>
</li>
</ul>
<blockquote>
<p>⚠️ <strong>安全警告</strong>：将 PAT Token 放在前端仅适用于演示或内部工具。生产环境应通过后端代理 API，避免 Token 泄露。</p>
</blockquote>
<h3 data-id="heading-11">4.2 响应式状态声明</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">uniform_number</span> = ref(<span class="hljs-number">10</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniform_color</span> = ref(<span class="hljs-string">'红'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">position</span> = ref(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">shooting_hand</span> = ref(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">style</span> = ref(<span class="hljs-string">'写实'</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">status</span> = ref(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">imageUrl</span> = ref(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>所有表单字段均为 <code>ref</code> 响应式对象，确保视图自动更新。</li>
<li><code>status</code> 初始为空，后续将显示：“图片上传中...” → “图片上传成功, 正在生成...” → 成功清空 或 错误信息。</li>
<li><code>imageUrl</code> 初始为空，生成成功后赋值为图片 URL。</li>
</ul>
<h3 data-id="heading-12">4.3 核心函数 1：图片预览（updateImageData）</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">uploadImage</span> = ref(null)<span class="hljs-comment">;</span>
const <span class="hljs-attr">imgPreview</span> = ref(<span class="hljs-string">''</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">updateImageData</span> = () =&gt; {
  const <span class="hljs-attr">input</span> = uploadImage.value<span class="hljs-comment">;</span>
  if (!input.files || <span class="hljs-attr">input.files.length</span> === <span class="hljs-number">0</span>) {
    return<span class="hljs-comment">;</span>
  }
  const <span class="hljs-attr">file</span> = input.files[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
  const <span class="hljs-attr">reader</span> = new FileReader()<span class="hljs-comment">;</span>
  reader.readAsDataURL(file)<span class="hljs-comment">;</span>
  <span class="hljs-attr">reader.onload</span> = (e) =&gt; {
    <span class="hljs-attr">imgPreview.value</span> = e.target.result<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}
</code></pre>
<ul>
<li><code>uploadImage</code> 是对 <code>&lt;input&gt;</code> 元素的引用。</li>
<li>使用 <code>FileReader</code> 的 <code>readAsDataURL</code> 方法，将文件转为 Base64 编码的 Data URL。</li>
<li><code>onload</code> 回调中，将结果赋给 <code>imgPreview</code>，触发 <code>&lt;img&gt;</code> 标签渲染。</li>
</ul>
<blockquote>
<p>✅ <strong>优势</strong>：纯前端实现，零网络请求，秒级响应。</p>
</blockquote>
<h3 data-id="heading-13">4.4 核心函数 2：文件上传（uploadFile）</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">uploadFile</span> = async () =&gt; {
  const <span class="hljs-attr">formData</span> = new FormData()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">input</span> = uploadImage.value<span class="hljs-comment">;</span>
  if (!input.files || input.files.length &lt;= 0) return<span class="hljs-comment">;</span>
  formData.append('file', input.files<span class="hljs-section">[0]</span>)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">res</span> = await fetch(uploadUrl, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${patToken}`
    },
    body: formData
  })<span class="hljs-comment">;</span>

  const <span class="hljs-attr">ret</span> = await res.json()<span class="hljs-comment">;</span>
  console.log(ret)<span class="hljs-comment">;</span>
  if (ret.code !== 0) {
    <span class="hljs-attr">status.value</span> = ret.msg<span class="hljs-comment">;</span>
    return<span class="hljs-comment">;</span>
  }
  return ret.data.id<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-14">逐行解析：</h4>
<ol>
<li>
<p><strong>构造 FormData</strong>：</p>
<ul>
<li><code>new FormData()</code> 是浏览器原生 API，用于构建 multipart/form-data 请求体，专为文件上传设计。</li>
<li><code>formData.append('file', file)</code>：Coze 要求字段名为 <code>file</code>。</li>
</ul>
</li>
<li>
<p><strong>发送 POST 请求</strong>：</p>
<ul>
<li>
<p>URL：<code>https://api.coze.cn/v1/files/upload</code></p>
</li>
<li>
<p>Headers：</p>
<ul>
<li><code>Authorization: Bearer &lt;token&gt;</code>：Coze 使用 Bearer Token 认证。</li>
</ul>
</li>
<li>
<p>Body：<code>formData</code> 自动设置正确 Content-Type（含 boundary）。</p>
</li>
</ul>
</li>
<li>
<p><strong>处理响应</strong>：</p>
<ul>
<li>
<p>成功时返回：</p>
<pre><code class="hljs language-css" lang="css">{ "<span class="hljs-selector-tag">code</span>": <span class="hljs-number">0</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"success"</span>, <span class="hljs-string">"data"</span>: { "id": <span class="hljs-string">"file_xxx"</span>, ... } }
</code></pre>
</li>
<li>
<p>失败时 <code>code !== 0</code>，<code>msg</code> 包含错误原因（如 Token 无效、文件过大等）。</p>
</li>
<li>
<p>函数返回 <code>file_id</code>（如 <code>"file_abc123"</code>），供下一步使用。</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>关键点</strong>：Coze 的文件上传是独立步骤，必须先上传获取 <code>file_id</code>，才能在工作流中引用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">五、核心函数 3：调用工作流（generate）</h2>
<p>这是整个应用的“大脑”。我们结合 Coze 工作流图，深入分析其逻辑与数据流。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">generate</span> = async () =&gt; {
  <span class="hljs-attr">status.value</span> = <span class="hljs-string">"图片上传中..."</span><span class="hljs-comment">;</span>
  const <span class="hljs-attr">file_id</span> = await uploadFile()<span class="hljs-comment">;</span>
  if (!file_id) return<span class="hljs-comment">;</span>

  <span class="hljs-attr">status.value</span> = <span class="hljs-string">"图片上传成功, 正在生成..."</span><span class="hljs-comment">;</span>

  const <span class="hljs-attr">parameters</span> = {
    picture: JSON.stringify({ file_id }),
    style: style.value,
    uniform_color: uniform_color.value,
    uniform_number: uniform_number.value,
    position: position.value,
    shooting_hand: shooting_hand.value,
  }<span class="hljs-comment">;</span>

  try {
    const <span class="hljs-attr">res</span> = await fetch(workflowUrl, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${patToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ workflow_id, parameters })
    })<span class="hljs-comment">;</span>

    const <span class="hljs-attr">ret</span> = await res.json()<span class="hljs-comment">;</span>
    console.log("Workflow API response:", ret)<span class="hljs-comment">;</span>
    if (ret.code !== 0) {
      <span class="hljs-attr">status.value</span> = ret.msg<span class="hljs-comment">;</span>
      return<span class="hljs-comment">;</span>
    }

    // 检查返回数据结构
    console.log("Return data:", ret.data)<span class="hljs-comment">;</span>
    console.log("Return data type:", typeof ret.data)<span class="hljs-comment">;</span>

    // 尝试解析数据
    let data<span class="hljs-comment">;</span>
    if (typeof <span class="hljs-attr">ret.data</span> === <span class="hljs-string">'string'</span>) {
      try {
        <span class="hljs-attr">data</span> = JSON.parse(ret.data)<span class="hljs-comment">;</span>
        console.log("Parsed data:", data)<span class="hljs-comment">;</span>
      } catch (e) {
        console.error("JSON parse error:", e)<span class="hljs-comment">;</span>
        <span class="hljs-attr">status.value</span> = <span class="hljs-string">"数据解析错误"</span><span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
      }
    } else {
      <span class="hljs-attr">data</span> = ret.data<span class="hljs-comment">;</span>
    }

    // 检查data.data是否存在
    if (data &amp;&amp; data.data) {
      console.log("Generated image URL:", data.data)<span class="hljs-comment">;</span>
      <span class="hljs-attr">status.value</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">imageUrl.value</span> = data.data<span class="hljs-comment">;</span>
    } else {
      console.error("Invalid data structure, missing 'data' field:", data)<span class="hljs-comment">;</span>
      <span class="hljs-attr">status.value</span> = <span class="hljs-string">"返回数据结构错误"</span><span class="hljs-comment">;</span>
    }
  } catch (error) {
    console.error("Generate error:", error)<span class="hljs-comment">;</span>
    <span class="hljs-attr">status.value</span> = <span class="hljs-string">"生成失败，请检查网络连接"</span><span class="hljs-comment">;</span>
  }
}
</code></pre>
<h3 data-id="heading-16">逻辑拆解（结合 Coze 工作流图）</h3>
<h4 data-id="heading-17">Coze 工作流结构（图解说明）</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df867d224be54ad6abb69d515547f3d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767236411&amp;x-signature=w82B316O2BMsmkUpKIegCC%2BsVOY%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<blockquote>
<p><strong>图注</strong>：</p>
<ol>
<li><strong>开始节点</strong>：接收 <code>picture</code>, <code>style</code>, <code>uniform_number</code>, <code>position</code>, <code>shooting_hand</code>, <code>uniform_color</code> 等参数。</li>
<li><strong>分支一</strong>：<code>imgUnderstand_1</code>（图像理解）→ 分析上传图片内容（如动物种类、姿态）。</li>
<li><strong>分支二</strong>：<code>代码</code> 节点 → 根据 <code>position</code>, <code>shooting_hand</code>, <code>style</code> 等生成描述文本（如“一只狗，右手持杆，身穿红色10号队服，站在冰球场上”）。</li>
<li><strong>大模型节点</strong>：将图像理解结果与描述文本合并，生成最终提示词（prompt）。</li>
<li><strong>图像生成节点</strong>：调用文生图模型（如豆包·1.5·Pro·32k），生成新图像。</li>
<li><strong>结束节点</strong>：输出生成图的 URL。</li>
</ol>
</blockquote>
<hr/>
<h4 data-id="heading-18">前端代码的对应关系</h4>








































<table><thead><tr><th>前端参数</th><th>Coze 输入字段</th><th>用途</th></tr></thead><tbody><tr><td><code>picture</code></td><td><code>picture</code></td><td>图片文件 ID，传入 <code>imgUnderstand_1</code> 和 <code>图像生成</code> 节点</td></tr><tr><td><code>style</code></td><td><code>style</code></td><td>传递给 <code>代码</code> 节点，决定艺术风格</td></tr><tr><td><code>uniform_number</code></td><td><code>uniform_number</code></td><td>用于生成描述</td></tr><tr><td><code>position</code></td><td><code>position</code></td><td>决定角色动作（如守门员蹲姿）</td></tr><tr><td><code>shooting_hand</code></td><td><code>shooting_hand</code></td><td>决定持杆手</td></tr><tr><td><code>uniform_color</code></td><td><code>uniform_color</code></td><td>用于生成队服颜色</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>关键点</strong>：前端只需提供原始参数，Coze 工作流内部完成所有逻辑编排。</p>
</blockquote>
<hr/>
<h3 data-id="heading-19">数据流全过程</h3>
<ol>
<li>
<p><strong>前端上传文件</strong> → 得到 <code>file_id</code></p>
</li>
<li>
<p><strong>前端组装参数</strong> → 发送至 <code>/workflow/run</code></p>
</li>
<li>
<p><strong>Coze 工作流执行</strong>：</p>
<ul>
<li><code>imgUnderstand_1</code>：分析图片内容 → 输出 <code>text</code>, <code>url</code>, <code>content</code></li>
<li><code>代码</code> 节点：根据参数生成描述 → 如 <code>"一只猫，身穿蓝色10号队服，右手持杆，站在冰球场上，风格为乐高"</code></li>
<li><code>大模型</code> 节点：合并图像理解结果与描述 → 生成最终 prompt</li>
<li><code>图像生成</code> 节点：调用模型生成图像 → 返回 <code>data</code> 字段（URL）</li>
</ul>
</li>
<li>
<p><strong>前端接收响应</strong>：</p>
<ul>
<li>若 <code>ret.data</code> 是字符串 → 尝试 <code>JSON.parse</code></li>
<li>若是对象 → 直接取 <code>data.data</code></li>
<li>最终赋值给 <code>imageUrl</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>✅ <strong>为什么需要双重解析？</strong><br/>
因为 Coze 的“图像生成”节点可能直接返回 URL 字符串，也可能返回 <code>{ data: "url" }</code> 结构。前端必须兼容两种情况。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">六、样式（Style）简析</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: row;
  <span class="hljs-attribute">align-items</span>: start;
  <span class="hljs-attribute">justify-content</span>: start;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">font-size</span>: .<span class="hljs-number">85rem</span>;
}
<span class="hljs-selector-class">.generated</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">border</span>: solid <span class="hljs-number">1px</span> black;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
}
<span class="hljs-selector-class">.output</span> <span class="hljs-selector-tag">img</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<ul>
<li>使用 Flex 布局，左右分栏（输入区固定宽度，输出区自适应）。</li>
<li><code>.generated</code> 容器固定 400x400，图片居中显示，无论原始比例如何都不变形。</li>
<li><code>scoped</code> 确保样式仅作用于当前组件，避免污染全局。</li>
</ul>
<hr/>
<h2 data-id="heading-21">七、项目运行</h2>
<p>在项目终端运行命令 ：npm run dev</p>
<p>运行界面如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c0b4ffcc9074875ac79d19c6dd039b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767236411&amp;x-signature=0TGAd4aYtt0gXusNweelNBbN%2BUM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>选择图片及风格等内容后，点击开始生成，运行结果如图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae9a4d82c5964599b8b4c648a2a02684~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUFB6Zi_Z2lhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767236411&amp;x-signature=kyiJS9z4Mjupkb9D9Ov3fs%2BNkj8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-22">总结：为什么这个项目值得学习？</h2>
<ol>
<li>
<p><strong>真实场景</strong>：不是 Hello World，而是完整产品逻辑。</p>
</li>
<li>
<p><strong>技术全面</strong>：</p>
<ul>
<li>Vue3 Composition API</li>
<li>文件上传与预览</li>
<li>Fetch API 与错误处理</li>
<li>环境变量管理</li>
<li>响应式状态驱动 UI</li>
</ul>
</li>
<li>
<p><strong>AI 集成范式</strong>：展示了如何将复杂 AI 能力封装为简单 API，前端只需“填参数 + 拿结果”。</p>
</li>
<li>
<p><strong>用户体验优先</strong>：状态提示、本地预览、错误反馈一应俱全。</p>
</li>
</ol>
<p><strong>安全与部署建议</strong>：</p>
<ul>
<li>
<p><strong>后端代理所有 Coze API 调用</strong>：</p>
<ul>
<li>前端 → 自己的后端（/api/generate）</li>
<li>后端 → Coze（携带安全存储的 Token）</li>
</ul>
</li>
<li>
<p><strong>限制工作流权限</strong>：Coze 的 PAT Token 应仅授予必要权限。</p>
</li>
<li>
<p><strong>添加速率限制</strong>：防止滥用。</p>
</li>
</ul>
<blockquote>
<p>最终，技术的意义在于创造快乐。<br/>
当你上传一张狗子的照片，看到它穿上红色10号球衣、右手持杆、以“乐高”风格站在冰场上——<br/>
你会笑，会分享，会说：“AI 真酷！”</p>
</blockquote>
<p>而这，正是我们写代码的初心。</p>
<p>完整项目源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FgiaoZou%2Flesson_zp%2Ftree%2Fmaster%2Fai%2Fapp%2Ficeball" title="https://gitee.com/giaoZou/lesson_zp/tree/master/ai/app/iceball" target="_blank" ref="nofollow noopener noreferrer">lesson_zp/ai/app/iceball: AI + 全栈学习仓库 - Gitee.com</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux pinctrl 子系统]]></title>    <link>https://juejin.cn/post/7587299670641737734</link>    <guid>https://juejin.cn/post/7587299670641737734</guid>    <pubDate>2025-12-24T16:53:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587299670641737734" data-draft-id="7587299443643924543" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux pinctrl 子系统"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-12-24T16:53:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lolo_fi"/> <meta itemprop="url" content="https://juejin.cn/user/414934077803401"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux pinctrl 子系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/414934077803401/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lolo_fi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T16:53:24.000Z" title="Wed Dec 24 2025 16:53:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Linux pinctrl 子系统</h2>
<h3 data-id="heading-1">一、Pinctrl的使用</h3>
<p>大多数 SOC 的 pin 都是支持复用的，例如某个SOC的GPIO3_D4 既可以作为普通的 GPIO 使用，也可以作为 PWM1_M0 引脚、GPU_AVS 引脚、UART0_RX 引脚。此外我们还需要配置 pin 的电气特性，比如上/下拉、驱动能力等等。传统的配置 pin 的方式就是直接操作相应的寄存器，但是这种配置方式比较繁琐、而且容易出问题(比如 pin 功能冲突)。pinctrl 子系统就是为了解决这个问题而引入的，pinctrl 子系统主要工作内容如下：</p>
<ul>
<li>获取设备树中 pin 信息。</li>
<li>根据获取到的 pin 信息来设置 pin 的复用功能</li>
<li>根据获取到的 pin 信息来设置 pin 的电气特性，如驱动能力。</li>
</ul>
<p>对于我们使用者来讲，只需要在设备树里面设置好某个 pin 的相关属性即可，其他的初始化工作均由 pinctrl 子系统来完成，pinctrl 子系统源码目录为 drivers/pinctrl。</p>
<h4 data-id="heading-2">1.PIN 配置信息详解</h4>
<p>要使用 pinctrl 子系统，我们需要在设备树里面设置 PIN 的配置信息，毕竟 pinctrl 子系统要根据你提供的信息来配置 PIN 功能，一般会在设备树里面创建一个节点来描述 PIN 的配置信息。</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-comment">//imx6ull.dtsi</span>
iomuxc: iomuxc@<span class="hljs-number">020e0000</span> {
				compatible = <span class="hljs-string">"fsl,imx6ul-iomuxc"</span>;
				reg = &lt;<span class="hljs-number">0x020e0000</span> <span class="hljs-number">0x4000</span>&gt;;
			};
<span class="hljs-comment">//imx6ull-14x14-evk.dts</span>
&amp;iomuxc {
	pinctrl-names = <span class="hljs-string">"default"</span>;
	pinctrl<span class="hljs-number">-0</span> = &lt;&amp;pinctrl_hog_1&gt;; <span class="hljs-comment">//hog pin是系统默认的状态，在 pinctrl 初始化阶段立即生效</span>
	pinctrl_hog_1: hoggrp<span class="hljs-number">-1</span> {
		fsl,pins = &lt;
			MX6UL_PAD_UART1_RTS_B__GPIO1_IO19	<span class="hljs-number">0x17059</span> <span class="hljs-comment">/* SD1 CD */</span>
			MX6UL_PAD_GPIO1_IO05__USDHC1_VSELECT	<span class="hljs-number">0x17059</span> <span class="hljs-comment">/* SD1 VSELECT */</span>
			MX6UL_PAD_GPIO1_IO09__GPIO1_IO09        <span class="hljs-number">0x17059</span> <span class="hljs-comment">/* SD1 RESET */</span>
		&gt;;
	};

	pinctrl_csi1: csi1grp {
		fsl,pins = &lt;
			MX6UL_PAD_CSI_MCLK__CSI_MCLK		<span class="hljs-number">0x1b088</span>
			MX6UL_PAD_CSI_PIXCLK__CSI_PIXCLK	<span class="hljs-number">0x1b088</span>
			...
		&gt;;
	};
    ...
}
</code></pre>
<ul>
<li><code>iomuxc</code> 是 IOMUX 控制器，负责 pin 的复用和 pad 控制</li>
<li><code>compatible</code> 决定使用哪个 pinctrl 驱动（<code>drivers/pinctrl/freescale/</code>）</li>
<li><code>reg</code> 指向 IOMUXC 寄存器基地址</li>
</ul>
<p>所有 pin 的复用和电气配置，最终都会通过该控制器完成。</p>
<p>这里要说明一下，PAD、Pin、GPIO是三个东西：</p>
<ul>
<li>
<p>PAD  				SoC 内部  			负责复用、电气特性、信号缓冲</p>
</li>
<li>
<p>Pin / Ball  		芯片封装  				焊球 / 引脚编号</p>
</li>
<li>
<p>GPIO  				逻辑功能  			数字输入输出控制器</p>
</li>
</ul>
<p><strong>PAD 是 pinctrl / IOMUX 直接操作的对象，多个内部信号共享同一个 PAD，通过复用选择其一。</strong></p>
<p>通常在 <code>&amp;iomuxc</code> 节点下定义多个 pinctrl 子节点，每个子节点描述一组功能相关的 pin，例如上面的<code>pinctrl_hog_1</code>、<code>pinctrl_csi1</code>。</p>
<pre><code class="hljs language-c" lang="c">pinctrl_xxx: xxxgrp {
	fsl,pins = &lt;
		PAD_MUX_CONFIG  PAD_CTRL_CONFIG
		...
	&gt;;
};

</code></pre>
<p><code>pinctrl_xxx</code>：label，用于被其他设备节点引用</p>
<p><code>xxxgrp</code>：节点名，无实际功能意义，仅用于区分</p>
<p><code>fsl,pins</code>：平台私有属性，描述具体 pin 配置</p>
<p><strong>fsl,pins 属性格式说明</strong></p>
<p>该属性由 若干组 <code>&lt;PAD MUX + PAD CTRL&gt;</code> 组成，每一组代表一个 pin 的配置。举例：</p>
<pre><code class="hljs language-C" lang="C">fsl,pins = &lt;
	MX6UL_PAD_UART1_RTS_B__GPIO1_IO19   <span class="hljs-number">0x17059</span>
&gt;;

</code></pre>
<p><strong>PAD MUX</strong>：宏<code>MX6UL_PAD_UART1_RTS_B__GPIO1_IO19</code>包含三部分信息，<code>MX6UL_PAD_UART1_RTS_B</code>表示物理 PAD 名称，<code>__</code>表示分隔符，<code>GPIO1_IO19</code>表示复用后的功能，表示将 <code>UART1_RTS_B</code> 这个 PAD 复用为 <code>GPIO1_IO19</code> 功能。这些宏定义位于<code>arch/arm/boot/dts/imx6ull-pinfunc.h</code>。</p>
<p><strong>PAD CTRL</strong>：<code>0x17059</code>用于配置 pin 的电气特性，对应 <code>IOMUXC_PAD</code> 控制寄存器。常见控制项包括：上拉 / 下拉、驱动能力、速率、施密特触发、推挽开漏。</p>
<h4 data-id="heading-3">2.设备节点中引用 pinctrl</h4>
<p>pinctrl 配置并不会自动生效，必须被设备节点引用。</p>
<p><strong>基本引用方式</strong></p>
<pre><code class="hljs language-c" lang="c">uart1: serial@<span class="hljs-number">02020000</span> {
	compatible = <span class="hljs-string">"fsl,imx6ul-uart"</span>;
	reg = &lt;<span class="hljs-number">0x02020000</span> <span class="hljs-number">0x4000</span>&gt;;
	interrupts = &lt;GIC_SPI <span class="hljs-number">26</span> IRQ_TYPE_LEVEL_HIGH&gt;;

	pinctrl-names = <span class="hljs-string">"default"</span>;
	pinctrl<span class="hljs-number">-0</span> = &lt;&amp;pinctrl_uart1&gt;; <span class="hljs-comment">//引用pinctrl_uart1</span>

	status = <span class="hljs-string">"okay"</span>;
};
<span class="hljs-comment">//对应的pinctrl定义</span>
pinctrl_uart1: uart1grp {
	fsl,pins = &lt;
		MX6UL_PAD_UART1_TX_DATA__UART1_DCE_TX  <span class="hljs-number">0x1b0b1</span>
		MX6UL_PAD_UART1_RX_DATA__UART1_DCE_RX  <span class="hljs-number">0x1b0b1</span>
	&gt;;
};
</code></pre>
<p><strong>多状态 pinctrl</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">pinctrl-names</span> = <span class="hljs-string">"default"</span>, <span class="hljs-string">"sleep"</span><span class="hljs-comment">;</span>
<span class="hljs-attr">pinctrl-0</span> = &lt;&amp;pinctrl_uart1_default&gt;<span class="hljs-comment">;</span>
<span class="hljs-attr">pinctrl-1</span> = &lt;&amp;pinctrl_uart1_sleep&gt;<span class="hljs-comment">;</span>
</code></pre>
<p>这里有两个状态：</p>
<p><code>default</code>：工作状态</p>
<p><code>sleep</code>：低功耗状态（关闭上下拉、降低驱动）</p>
<p>是否切换由驱动调用：<code>pinctrl_select_state();</code></p>
<h3 data-id="heading-4">二、内部原理</h3>
<p><strong>核心思路</strong> （方便回忆）
pinctrl 是 Linux 内核中负责管理引脚复用与引脚配置的子系统。<br/>
它通过Pin Controller 驱动和 设备驱动两层模型，实现了从设备树引脚定义到硬件寄存器配置的完整映射。</p>
<p>简单流程版：</p>
<ul>
<li>pinctrl 子系统的工作流程从 Pin Controller 驱动开始。首先，内核通过设备树中的 <strong>compatible</strong> 属性匹配到对应的 pinctrl 驱动，当匹配成功后，会调用该驱动的 <strong>probe</strong> 函数。在 probe 阶段，驱动会根据 SoC 的特性填充一个 <strong>pinctrl_desc</strong> 结构体，其中包含引脚描述信息（pins/npins）、操作函数（pctlops、pmxops、confops）等内容，并通过 <strong>devm_pinctrl_register()</strong> 将该 pin controller 注册到内核中，完成引脚控制器的初始化与功能注册。</li>
<li>当具体使用pinctrl的设备驱动在 probe 阶段加载时，内核会根据设备树中定义的引脚配置调用 <strong>pinctrl_bind_pins()</strong> 函数，为该设备建立引脚控制上下文。该函数首先为设备创建一个 <strong>dev_pin_info</strong> 结构体，用于保存设备的引脚控制信息。其中，函数会调用 <strong>devm_pinctrl_get()</strong> 创建一个新的 <strong>pinctrl</strong> 结构体，并将其赋值给 <code>dev_pin_info</code> 的 <code>p</code> 成员。</li>
<li>随后，内核通过 <strong>pinctrl_dt_to_map()</strong> 从设备树中读取该设备的引脚配置，并调用 pinctrl 驱动提供的 <strong>imx_dt_node_to_map()</strong> 等函数来解析 <code>pinctrl-0</code>、<code>pinctrl-1</code> 等节点。解析过程会生成一系列 <strong>pinctrl_map</strong> 结构体，每个 map 对应一组引脚功能或配置。这些 map 会被进一步转换为 <strong>pinctrl_setting</strong>，并挂入对应状态的 <strong>pinctrl_state.settings</strong> 链表中，同时所有 map 信息也会保存在 <code>pinctrl</code> 的 <code>dt_maps</code> 链表中。</li>
<li>在此基础上，内核根据不同的 pinctrl 节点（如 default、sleep 等）创建多个 <strong>pinctrl_state</strong>，每个状态对应设备树中定义的一个引脚状态。这些状态被添加到 <code>pinctrl</code> 的 <code>states</code> 链表中，而 <code>dev_pin_info</code> 结构中的 <code>default_state</code>、<code>sleep_state</code> 等指针则会被设置为指向这些状态结构。</li>
<li>当设备运行过程中需要切换引脚配置（例如进入睡眠或恢复默认状态）时，驱动可调用 <strong>pinctrl_select_state()</strong> 函数来切换到对应的状态。该函数会遍历当前状态下的所有 <strong>pinctrl_setting</strong>，并根据每个 setting 的类型（复用或配置）调用 pin controller 驱动提供的操作接口（ops），最终通过底层寄存器配置完成硬件引脚功能与电气属性的切换。</li>
</ul>
<p>这一整套机制实现了从设备树定义到硬件引脚配置的完整自动化映射流程。</p>
<hr/>
<h4 data-id="heading-5">1.Provider 端</h4>
<p><strong>Pin Controller 驱动注册流程</strong></p>
<h5 data-id="heading-6">(1)设备树匹配</h5>
<p>在设备树中定义一个 pin controller 节点：</p>
<pre><code class="hljs language-ini" lang="ini">iomuxc: iomuxc@020e0000 {
    <span class="hljs-attr">compatible</span> = <span class="hljs-string">"fsl,imx6ul-iomuxc"</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">reg</span> = &lt;<span class="hljs-number">0</span>x020e0000 <span class="hljs-number">0</span>x4000&gt;<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p>对应驱动中的匹配表：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">of_device_id</span> imx6ul_pinctrl_of_match[] = {
    { .compatible = <span class="hljs-string">"fsl,imx6ul-iomuxc"</span>, .data = &amp;imx6ul_pinctrl_info },
    { <span class="hljs-comment">/* sentinel */</span> }
};
</code></pre>
<p>当 compatible 匹配成功后，调用：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">imx6ul_pinctrl_probe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *pdev)</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">imx_pinctrl_probe</span>(pdev, pinctrl_info);
}
</code></pre>
<hr/>
<h5 data-id="heading-7">(2)probe 阶段</h5>
<p><strong>构造并注册 pinctrl_desc</strong></p>
<p>核心函数 <code>imx_pinctrl_probe()</code>：</p>
<pre><code class="hljs language-ini" lang="ini">int imx_pinctrl_probe(struct platform_device *pdev,
                      struct imx_pinctrl_soc_info *info)
{
    struct pinctrl_desc *desc<span class="hljs-comment">;</span>

    desc-&gt;<span class="hljs-attr">name</span> = dev_name(&amp;pdev-&gt;dev)<span class="hljs-comment">;</span>
    desc-&gt;<span class="hljs-attr">pins</span> = info-&gt;pins<span class="hljs-comment">;           // 引脚数组</span>
    desc-&gt;<span class="hljs-attr">npins</span> = info-&gt;npins<span class="hljs-comment">;         // 引脚数量</span>
    desc-&gt;<span class="hljs-attr">pctlops</span> = &amp;imx_pctrl_ops<span class="hljs-comment">;    // 分组操作</span>
    desc-&gt;<span class="hljs-attr">pmxops</span> = &amp;imx_pmx_ops<span class="hljs-comment">;       // 复用操作</span>
    desc-&gt;<span class="hljs-attr">confops</span> = &amp;imx_pinconf_ops<span class="hljs-comment">;  // 引脚配置操作</span>
    desc-&gt;<span class="hljs-attr">owner</span> = THIS_MODULE<span class="hljs-comment">;</span>

    // 注册 pin controller
    ipctl-&gt;<span class="hljs-attr">pctl</span> = devm_pinctrl_register(&amp;pdev-&gt;dev, desc, ipctl)<span class="hljs-comment">;</span>
}
</code></pre>
<p><code>devm_pinctrl_register()</code> 会在内核中注册一个 <code>pinctrl_dev</code> 实例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">pinctrl_dev</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pinctrl_desc</span> *desc;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">device</span> *dev;
    <span class="hljs-type">void</span> *driver_data;
};
</code></pre>
<hr/>
<h5 data-id="heading-8">(3)三大操作函数</h5>
<p>pinctrl 框架通过以下三类 ops 完成抽象：</p>

























<table><thead><tr><th>操作集</th><th>功能</th><th>示例函数</th></tr></thead><tbody><tr><td><strong>pinctrl_ops</strong></td><td>引脚组管理与设备树解析</td><td><code>dt_node_to_map()</code></td></tr><tr><td><strong>pinmux_ops</strong></td><td>控制引脚复用</td><td><code>set_mux()</code></td></tr><tr><td><strong>pinconf_ops</strong></td><td>控制引脚电气属性</td><td><code>pin_config_set()</code></td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-ini" lang="ini">static const struct pinctrl_ops <span class="hljs-attr">imx_pctrl_ops</span> = {
    .<span class="hljs-attr">get_groups_count</span> = imx_get_groups_count,
    .<span class="hljs-attr">get_group_name</span> = imx_get_group_name,
    .<span class="hljs-attr">dt_node_to_map</span> = imx_dt_node_to_map, // 关键：设备树转 pinctrl_map
}<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-9">2.Consumer 端</h3>
<p><strong>设备驱动的引脚绑定与状态创建</strong></p>
<h5 data-id="heading-10">(1)设备树中定义引脚配置</h5>
<pre><code class="hljs language-ini" lang="ini">&amp;iomuxc {
    imx6ul-evk {
        pinctrl_i2c1: i2c1grp {
            fsl,<span class="hljs-attr">pins</span> = &lt;
                MX6UL_PAD_UART1_TX_DATA__I2C1_SCL 0x4001b8b0
                MX6UL_PAD_UART1_RX_DATA__I2C1_SDA 0x4001b8b0
            &gt;<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

i2c1: i2c@021a0000 {
    <span class="hljs-attr">compatible</span> = <span class="hljs-string">"fsl,imx6ul-i2c"</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">pinctrl-names</span> = <span class="hljs-string">"default"</span>, <span class="hljs-string">"sleep"</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">pinctrl-0</span> = &lt;&amp;pinctrl_i2c1&gt;<span class="hljs-comment">;</span>
    <span class="hljs-attr">pinctrl-1</span> = &lt;&amp;pinctrl_i2c1_sleep&gt;<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><code>pinctrl-names</code> 与 <code>pinctrl-0</code>, <code>pinctrl-1</code> 等属性定义了设备的多种引脚状态。</p>
<hr/>
<h5 data-id="heading-11">(2)pinctrl_bind_pins()</h5>
<p><strong>设备 probe 时的引脚绑定入口：<code>pinctrl_bind_pins()</code></strong></p>
<p>当设备驱动被加载时，<code>really_probe()</code> 调用：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">pinctrl_bind_pins</span>(dev);
</code></pre>
<p>该函数负责为设备创建引脚控制信息，是 Consumer 端的核心入口。</p>
<hr/>
<h5 data-id="heading-12">(3)<code>pinctrl_bind_pins</code></h5>
<p><strong><code>pinctrl_bind_pins</code> 内部关键步骤</strong></p>
<p><strong>step1.创建 <code>dev_pin_info</code> 结构</strong></p>
<pre><code class="hljs language-ini" lang="ini">dev-&gt;<span class="hljs-attr">pins</span> = devm_kzalloc(dev, sizeof(*(dev-&gt;pins)), GFP_KERNEL)<span class="hljs-comment">;</span>
</code></pre>
<p><code>struct dev_pin_info</code> 用于描述设备与 pinctrl 子系统的绑定关系：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dev_pin_info</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pinctrl</span> *p;                    <span class="hljs-comment">// 指向该设备的 pinctrl 句柄</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pinctrl_state</span> *default_state;  <span class="hljs-comment">// 默认状态</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pinctrl_state</span> *init_state;     <span class="hljs-comment">// 初始化状态</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pinctrl_state</span> *sleep_state;    <span class="hljs-comment">// 睡眠状态</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pinctrl_state</span> *idle_state;     <span class="hljs-comment">// 空闲状态</span>
};
</code></pre>
<p><code>dev_pin_info</code> 是设备和 pinctrl 框架之间的“桥梁”：</p>
<ul>
<li><code>p</code>：指向设备对应的 <code>struct pinctrl</code></li>
<li>其他成员指向不同命名状态的 <code>pinctrl_state</code></li>
</ul>
<hr/>
<p><strong>step2.创建 <code>pinctrl</code> 结构</strong></p>
<pre><code class="hljs language-ini" lang="ini">dev-&gt;pins-&gt;<span class="hljs-attr">p</span> = devm_pinctrl_get(dev)<span class="hljs-comment">;</span>
</code></pre>
<p><code>devm_pinctrl_get()</code> 内部执行：</p>
<ol>
<li>创建 <code>struct pinctrl</code>；</li>
<li>调用 <code>pinctrl_dt_to_map()</code> 解析设备树；</li>
<li>将解析结果保存到 <code>pinctrl-&gt;dt_maps</code>；</li>
<li>为每个状态创建 <code>pinctrl_state</code> 并加入 <code>pinctrl-&gt;states</code> 链表。</li>
</ol>
<hr/>
<p><strong>step3.设备树解析 → <code>pinctrl_map</code> 构建</strong></p>
<p><code>pinctrl_dt_to_map()</code> 通过 pinctrl 驱动提供的 <code>dt_node_to_map()</code> 来解析：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">imx_dt_node_to_map</span>(np_config, &amp;map, &amp;num_maps);
</code></pre>
<p>每个节点（如 <code>pinctrl-0</code>）会生成若干个 <code>pinctrl_map</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">pinctrl_map</span> {
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dev_name;
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;
    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">pinctrl_map_type</span> type;
    <span class="hljs-keyword">union</span> {
        <span class="hljs-keyword">struct</span> { <span class="hljs-type">const</span> <span class="hljs-type">char</span> *group; <span class="hljs-type">const</span> <span class="hljs-type">char</span> *function; } mux;
        <span class="hljs-keyword">struct</span> { <span class="hljs-type">const</span> <span class="hljs-type">char</span> *group_or_pin; <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *configs; <span class="hljs-type">unsigned</span> num_configs; } configs;
    } data;
};
</code></pre>
<p>这些 <code>pinctrl_map</code> 描述了设备、组、功能与配置之间的对应关系，并被挂入：</p>
<pre><code class="hljs language-rust" lang="rust">pinctrl<span class="hljs-punctuation">-&gt;</span>dt_maps
</code></pre>
<hr/>
<p><strong>step4.<code>pinctrl_map</code> → <code>pinctrl_setting</code> → <code>pinctrl_state</code></strong></p>
<p>每个 <code>pinctrl_map</code> 会被转换为 <code>pinctrl_setting</code>，挂入对应的 <code>pinctrl_state.settings</code> 链表。</p>
<p>结构关系如下：</p>
<pre><code class="hljs language-scss" lang="scss">dev_pin_info
   └── pinctrl
        ├── states (链表)
        │     ├── <span class="hljs-built_in">pinctrl_state</span>("default")
        │     │       └── settings → <span class="hljs-built_in">pinctrl_setting</span>(多个)
        │     └── <span class="hljs-built_in">pinctrl_state</span>("sleep")
        └── dt_maps (映射链表)
</code></pre>
<p>此时，<code>dev_pin_info</code> 中的：</p>
<pre><code class="hljs language-arduino" lang="arduino">default_state → 指向 states 中名为 “<span class="hljs-keyword">default</span>” 的状态
sleep_state   → 指向 states 中名为 “sleep” 的状态
</code></pre>
<hr/>
<h3 data-id="heading-13">3.状态切换</h3>
<p>当驱动需要切换引脚状态时（如进入休眠），会调用：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">pinctrl_select_state</span>(pinctrl, sleep_state);
</code></pre>
<p>执行过程：</p>
<ol>
<li>遍历该状态下所有的 <code>pinctrl_setting</code></li>
<li>判断 setting 类型并调用相应 ops：</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">switch</span> (setting-&gt;<span class="hljs-keyword">type</span>) {
<span class="hljs-keyword">case</span> PIN_MAP_TYPE_MUX_GROUP:
    pinmux_enable_setting(setting);
    <span class="hljs-comment">// 实际调用 -&gt; ops-&gt;set_mux()</span>
    <span class="hljs-keyword">break</span>;

<span class="hljs-keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP:
<span class="hljs-keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN:
    pinconf_apply_setting(setting);
    <span class="hljs-comment">// 实际调用 -&gt; ops-&gt;pin_config_group_set()</span>
    <span class="hljs-keyword">break</span>;
}
</code></pre>
<p>最终由 pin controller 驱动的底层函数（<code>imx_pmx_ops</code>、<code>imx_pinconf_ops</code>）将配置写入寄存器，完成硬件层设置。</p>
<hr/>
<h3 data-id="heading-14">4.调试</h3>
<p>在 <code>/sys/kernel/debug/pinctrl/&lt;controller&gt;/</code> 下可以查看 pinctrl 的内部状态：</p>

































<table><thead><tr><th>文件名</th><th>含义</th></tr></thead><tbody><tr><td><code>pins</code></td><td>已注册引脚信息</td></tr><tr><td><code>pingroups</code></td><td>引脚组信息</td></tr><tr><td><code>pinmux-pins</code></td><td>每个引脚的复用状态</td></tr><tr><td><code>pinmux-functions</code></td><td>功能与组的对应</td></tr><tr><td><code>pinconf-pins</code></td><td>引脚配置参数</td></tr><tr><td><code>pinconf-config</code></td><td>可动态修改配置</td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /sys/kernel/debug/pinctrl/20e0000.iomuxc/pingroups
<span class="hljs-built_in">cat</span> /sys/kernel/debug/pinctrl/20e0000.iomuxc/pinmux-functions
</code></pre>
<hr/>
<h3 data-id="heading-15">5.执行链总结</h3>





















































<table><thead><tr><th>阶段</th><th>主体</th><th>操作</th><th>核心结构 / 函数</th></tr></thead><tbody><tr><td><strong>1. 匹配驱动</strong></td><td>内核 → pinctrl 驱动</td><td>匹配 compatible</td><td><code>of_match_table</code></td></tr><tr><td><strong>2. 控制器注册</strong></td><td>pinctrl 驱动</td><td>注册 pin controller</td><td><code>devm_pinctrl_register</code></td></tr><tr><td><strong>3. 设备树解析</strong></td><td>内核框架</td><td>解析 pinctrl-0 节点</td><td><code>pinctrl_dt_to_map</code> / <code>dt_node_to_map</code></td></tr><tr><td><strong>4. 状态建立</strong></td><td>内核框架</td><td>创建 map → setting → state</td><td><code>pinctrl_add_setting</code></td></tr><tr><td><strong>5. 设备绑定</strong></td><td>内核框架</td><td>创建 <code>dev_pin_info</code> 与 <code>pinctrl</code></td><td><code>pinctrl_bind_pins</code></td></tr><tr><td><strong>6. 状态切换</strong></td><td>设备驱动</td><td>应用状态</td><td><code>pinctrl_select_state</code></td></tr><tr><td><strong>7. 硬件配置</strong></td><td>pinctrl 驱动</td><td>调用 ops 写寄存器</td><td><code>set_mux</code> / <code>pin_config_set</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-16">6.总结</h3>
<p>pinctrl 驱动：描述并注册硬件引脚能力；</p>
<p>pinctrl 核心：提供统一的数据结构与调用机制；</p>
<p>设备驱动：声明状态，动态切换引脚配置；</p>
<p>dev_pin_info：连接设备与 pinctrl 框架的中枢，管理状态切换。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android暗黑模式适配全攻略：从入门到精通，告别"阴间配色"]]></title>    <link>https://juejin.cn/post/7587264707285106698</link>    <guid>https://juejin.cn/post/7587264707285106698</guid>    <pubDate>2025-12-25T01:49:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587264707285106698" data-draft-id="7587264707285041162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android暗黑模式适配全攻略：从入门到精通，告别&quot;阴间配色&quot;"/> <meta itemprop="keywords" content="面试,Android,性能优化"/> <meta itemprop="datePublished" content="2025-12-25T01:49:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="顾林海"/> <meta itemprop="url" content="https://juejin.cn/user/2365804752153911"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android暗黑模式适配全攻略：从入门到精通，告别"阴间配色"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2365804752153911/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    顾林海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T01:49:19.000Z" title="Thu Dec 25 2025 01:49:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>如今打开手机，不少人都会下意识切换到暗黑模式——毕竟在深夜刷手机时，惨白的屏幕堪比"电子强光手电"，晃得人眼睛发酸。作为Android开发者，给应用做好暗黑模式适配早已不是"加分项"，而是关乎用户体验的"必做题"。</p>
<p>但适配暗黑模式可不是简单地把背景改成黑色、文字改成白色就完事了。不少新手踩坑后做出的暗黑模式，要么文字和背景对比度不够看得费劲，要么控件颜色混乱像"调色盘打翻"，要么切换时闪屏卡顿让用户抓狂。今天这篇全攻略，就从基础原理到进阶技巧，把Android暗黑模式适配讲得明明白白，还附上可直接复用的代码，让你少走99%的弯路。</p>
<h2 data-id="heading-1">一、先搞懂：暗黑模式适配的核心逻辑</h2>
<p>在动手写代码前，我们得先明白Android系统是怎么管理暗黑模式的。简单来说，核心逻辑就是 <strong>"资源匹配"</strong> ——系统会根据当前的主题模式（浅色/暗黑），自动加载对应的资源文件。</p>
<p>Android 10（API 29）是个关键节点，从这个版本开始，系统正式支持全局暗黑模式。而通过AndroidX的AppCompat库，我们可以把适配范围向下兼容到API 14，基本覆盖市面上绝大多数设备。</p>
<p>这里有个重要概念：<strong>DayNight主题</strong>。这是Android提供的"日夜切换"基础主题，我们的应用主题只要继承它，就能自动响应系统的主题切换指令。后续的所有适配工作，都是围绕这个主题展开的资源定制。</p>
<p>另外，暗黑模式的开启方式有三种（用户可自行切换）：</p>
<ul>
<li>系统设置：设置 &gt; 显示 &gt; 主题，手动切换浅色/暗黑；</li>
<li>快捷设置：下拉通知栏，点击"暗黑模式"快捷开关；</li>
<li>省电模式：部分设备（如Pixel）开启省电模式后，会自动切换到暗黑模式。</li>
</ul>
<p>我们的适配目标，就是让应用在这三种场景下，都能流畅、美观地切换主题，且所有UI元素都符合暗黑模式的视觉规范。</p>
<h2 data-id="heading-2">二、基础操作：3步搞定暗黑模式适配入门</h2>
<p>入门级的暗黑模式适配，核心就3个步骤：继承DayNight主题、创建暗黑模式资源目录、使用主题属性而非硬编码颜色。跟着做，就能快速实现基础的明暗切换效果。</p>
<h3 data-id="heading-3">步骤1：让应用主题继承DayNight主题</h3>
<p>首先找到应用的主题配置文件（通常在res/values/styles.xml），把主题的parent设置为DayNight相关主题。这里推荐使用Material Components库的主题，兼容性更好，还能直接复用Material Design的配色规范。</p>
<p>先确保在build.gradle中引入了Material Components依赖（如果还没引入的话）：</p>
<pre><code class="hljs language-groovy" lang="groovy">// Module级别的build.gradle
 dependencies {
     implementation 'com.google.android.material:material:1.12.0'
 }
 
</code></pre>
<p>然后修改styles.xml中的主题配置：</p>
<pre><code class="hljs language-xml" lang="xml">// res/values/styles.xml

     <span class="hljs-comment">&lt;!-- 基础主题：继承Material的DayNight主题 --&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"AppTheme"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"Theme.MaterialComponents.DayNight.NoActionBar"</span>&amp;<span class="hljs-attr">gt</span>;
         &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">主题属性配置</span>：<span class="hljs-attr">不要硬编码颜色</span>！ <span class="hljs-attr">--</span>&gt;</span><span class="xml">
         <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"colorPrimary"</span>&gt;</span>?attr/colorPrimary<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"colorPrimaryDark"</span>&gt;</span>?attr/colorPrimaryDark<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"colorAccent"</span>&gt;</span>?attr/colorAccent<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowBackground"</span>&gt;</span>?android:attr/colorBackground<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
     </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

 
</code></pre>
<p>这里要重点提醒：<strong>绝对不要在主题中硬编码颜色</strong>（比如直接写#FFFFFF、#000000）。上面的?attr/xxx是主题属性引用，系统会根据当前模式自动匹配对应的颜色值，这是适配的核心前提。</p>
<h3 data-id="heading-4">步骤2：创建暗黑模式专属资源目录</h3>
<p>Android通过"资源限定符"来区分不同模式的资源。对于暗黑模式，我们需要创建带有**-night**后缀的资源目录，把暗黑模式下的资源放在里面。</p>
<p>常见的需要适配的资源包括：颜色（colors.xml）、图片（drawable）、布局（layout，一般不需要，除非布局结构有差异）、字符串（strings.xml，极少数场景需要）。</p>
<p>创建目录的规则很简单：在res目录下，复制原有的资源目录，添加-night后缀。比如：</p>
<ul>
<li>浅色模式颜色：res/values/colors.xml</li>
<li>暗黑模式颜色：res/values-night/colors.xml</li>
<li>浅色模式图片：res/drawable/icon_home.xml</li>
<li>暗黑模式图片：res/drawable-night/icon_home.xml</li>
</ul>
<p>注意：两个目录下的资源文件名必须完全一致，系统才能正确匹配。比如在values/colors.xml中定义了color_bg_main，在values-night/colors.xml中也必须定义同名的color_bg_main，只是颜色值不同。</p>
<h3 data-id="heading-5">步骤3：在布局中使用主题属性或资源引用</h3>
<p>创建好资源后，在布局文件中引用这些资源，而不是直接写死颜色。这样系统切换模式时，会自动加载对应目录下的资源。</p>
<pre><code class="hljs language-xml" lang="xml">// 正确示例：引用资源或主题属性
 <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
     <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
     <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
     <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/color_bg_main"</span>  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">引用颜色资源</span> <span class="hljs-attr">--</span>&gt;</span>
     android:orientation="vertical"&gt;
 
     <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
         <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
         <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
         <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@string/app_name"</span>
         <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"?attr/textColorPrimary"</span>  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">引用主题属性</span> <span class="hljs-attr">--</span>&gt;</span>
         android:textSize="20sp"/&gt;
 
 <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
 
</code></pre>
<p>对应的颜色资源文件示例：</p>
<pre><code class="hljs language-xml" lang="xml">// res/values/colors.xml（浅色模式）
 <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"color_bg_main"</span>&amp;<span class="hljs-attr">gt</span>;#<span class="hljs-attr">FFFFFF</span>&amp;<span class="hljs-attr">lt</span>;/<span class="hljs-attr">color</span>&amp;<span class="hljs-attr">gt</span>;  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">白色背景</span> <span class="hljs-attr">--</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"color_text_main"</span>&amp;<span class="hljs-attr">gt</span>;#<span class="hljs-attr">333333</span>&amp;<span class="hljs-attr">lt</span>;/<span class="hljs-attr">color</span>&amp;<span class="hljs-attr">gt</span>;  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">深灰色文字</span> <span class="hljs-attr">--</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
 
 // res/values-night/colors.xml（暗黑模式）
 <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"color_bg_main"</span>&gt;</span>#121212<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 深黑色背景 --&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"color_text_main"</span>&gt;</span>#E0E0E0<span class="hljs-symbol">&amp;lt;</span>/color<span class="hljs-symbol">&amp;gt;</span>  <span class="hljs-comment">&lt;!-- 浅灰色文字 --&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
</code></pre>
<p>到这里，基础的暗黑模式适配就完成了。运行应用后切换系统主题，你会发现界面会自动跟着切换明暗颜色。是不是很简单？但这只是入门，真正的难点在后面的细节优化。</p>
<h2 data-id="heading-6">三、进阶优化：从"能用"到"好用"的关键细节</h2>
<p>不少开发者做到上面三步就觉得完事了，但用户用起来还是吐槽不断。问题就出在细节上。下面这些进阶技巧，能让你的暗黑模式体验飙升一个档次。</p>
<h3 data-id="heading-7">1. 颜色适配：遵循"对比度优先"原则</h3>
<p>暗黑模式不是"黑色背景+白色文字"的简单组合，关键是要保证文字和背景的<strong>对比度足够高</strong>，否则用户会看得很费劲。根据WCAG（Web内容无障碍指南），正文文字与背景的对比度至少要达到4.5:1，标题文字至少要达到3:1。</p>
<p>这里推荐几个实用的颜色搭配方案（亲测不会踩坑）：</p>
<ul>
<li>背景色：#121212（深黑）、#1E1E1E（浅黑），避免用纯黑#000000，会让文字显得过于刺眼；</li>
<li>正文文字：#E0E0E0（浅灰）、#FFFFFF（白色），对比度足够且不刺眼；</li>
<li>辅助文字：#9E9E9E（中灰），用于提示性文字，对比度适中；</li>
<li>强调色：保持和浅色模式一致的强调色（如蓝色#2196F3），既能突出重点，又能保证视觉一致性。</li>
</ul>
<p>另外，Material Design 3提供了一套完整的暗黑模式配色系统，推荐直接复用：通过?attr/colorSurface（表面色）、?attr/colorOnSurface（表面文字色）等属性，能快速实现符合规范的配色。示例如下：</p>
<pre><code class="hljs language-xml" lang="xml">// 在主题中自定义Material 3配色
 <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"AppTheme"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"Theme.MaterialComponents.DayNight.NoActionBar"</span>&gt;</span><span class="xml">
     <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"colorSurface"</span>&gt;</span>@color/surface<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"colorOnSurface"</span>&gt;</span>@color/on_surface<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"colorPrimary"</span>&gt;</span>@color/primary<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"colorOnPrimary"</span>&gt;</span>@color/on_primary<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
 </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
 
 // res/values/colors.xml
 <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"surface"</span>&gt;</span>#FFFFFF<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"on_surface"</span>&gt;</span>#121212<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"primary"</span>&gt;</span>#2196F3<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"on_primary"</span>&gt;</span>#FFFFFF<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
 
 // res/values-night/colors.xml
 <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"surface"</span>&gt;</span>#121212<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"on_surface"</span>&gt;</span>#E0E0E0<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
 <span class="hljs-symbol">&amp;lt;</span>color name="primary"<span class="hljs-symbol">&amp;gt;</span>#64B5F6<span class="hljs-symbol">&amp;lt;</span>/color<span class="hljs-symbol">&amp;gt;</span>  <span class="hljs-comment">&lt;!-- 暗黑模式下可稍微调亮强调色 --&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"on_primary"</span>&gt;</span>#000000<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
 
</code></pre>
<h3 data-id="heading-8">2. 图片与图标适配：避免"白图标变黑底"的尴尬</h3>
<p>很多应用在浅色模式下用的是黑色图标，切换到暗黑模式后，图标就和黑色背景"融为一体"，用户根本看不见。这时候就需要为暗黑模式准备专属的图标资源。</p>
<p>推荐两种适配方案，根据场景选择：</p>
<h4 data-id="heading-9">方案1：使用矢量图（SVG）+ tint着色</h4>
<p>这是最推荐的方案，矢量图体积小、不失真，还能通过tint属性动态着色。我们只需要准备一份矢量图，然后在布局中通过?attr/colorControlNormal属性给图标着色，系统会自动根据主题切换颜色。</p>
<pre><code class="hljs language-xml" lang="xml">// 布局中的ImageView配置
 <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span>
     <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"24dp"</span>
     <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"24dp"</span>
     <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/ic_home"</span>  &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">矢量图资源</span> <span class="hljs-attr">--</span>&gt;</span>
     android:tint="?attr/colorControlNormal"/<span class="hljs-symbol">&amp;gt;</span>  <span class="hljs-comment">&lt;!-- 主题色着色 --&gt;</span>
 
</code></pre>
<p>这样一来，浅色模式下图标是黑色，暗黑模式下是白色，无需准备两份图标资源，省心又高效。</p>
<h4 data-id="heading-10">方案2：创建drawable-night目录存放专属图标</h4>
<p>如果是位图（PNG/JPG），就需要创建res/drawable-night目录，把暗黑模式下的图标放进去。注意图标文件名要和drawable目录下的一致，系统会自动匹配。</p>
<p>比如：</p>
<ul>
<li>浅色模式图标：res/drawable/ic_setting.png（黑色）</li>
<li>暗黑模式图标：res/drawable-night/ic_setting.png（白色）</li>
</ul>
<p>提示：尽量使用矢量图，减少APK体积，也避免多套位图资源的维护成本。</p>
<h3 data-id="heading-11">3. 应用内主题切换：给用户自主选择的权利</h3>
<p>除了跟随系统主题，很多应用还会提供"浅色/暗黑/跟随系统"的自主切换选项（比如微信、知乎）。这需要我们在应用内实现主题切换逻辑，还得把用户的选择持久化存储（比如SharedPreferences），下次启动时恢复用户的设置。</p>
<p>实现步骤如下：</p>
<h4 data-id="heading-12">第一步：定义主题切换选项对应的模式</h4>
<p>AppCompat提供了四种夜间模式，对应我们的切换选项：</p>
<ul>
<li>MODE_NIGHT_NO：强制浅色模式；</li>
<li>MODE_NIGHT_YES：强制深色模式；</li>
<li>MODE_NIGHT_FOLLOW_SYSTEM：跟随系统（默认）；</li>
<li>MODE_NIGHT_AUTO_BATTERY：低电量时自动开启暗黑模式。</li>
</ul>
<h4 data-id="heading-13">第二步：实现切换逻辑与持久化存储</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 主题工具类：处理切换和持久化</span>
 <span class="hljs-keyword">object</span> ThemeUtils {
     <span class="hljs-comment">// 存储用户选择的主题模式，key为"night_mode"</span>
     <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> KEY_NIGHT_MODE = <span class="hljs-string">"night_mode"</span>
     <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> sharedPreferences <span class="hljs-keyword">by</span> lazy {
         AppContext.context.getSharedPreferences(<span class="hljs-string">"app_settings"</span>, Context.MODE_PRIVATE)
     }
 
     <span class="hljs-comment">// 初始化主题：启动应用时调用</span>
     <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initTheme</span><span class="hljs-params">()</span></span> {
         <span class="hljs-keyword">val</span> mode = sharedPreferences.getInt(KEY_NIGHT_MODE, AppCompatDelegate.MODE_NIGHT_FOLLOW_SYSTEM)
         AppCompatDelegate.setDefaultNightMode(mode)
     }
 
     <span class="hljs-comment">// 切换主题</span>
     <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchTheme</span><span class="hljs-params">(mode: <span class="hljs-type">Int</span>)</span></span> {
         <span class="hljs-comment">// 保存主题模式到SP</span>
         sharedPreferences.edit().putInt(KEY_NIGHT_MODE, mode).apply()
         <span class="hljs-comment">// 设置主题模式</span>
         AppCompatDelegate.setDefaultNightMode(mode)
         <span class="hljs-comment">// 重启Activity以应用主题（可选，根据需求调整）</span>
         AppContext.context.startActivity(
             Intent(AppContext.context, MainActivity::<span class="hljs-keyword">class</span>.java).apply {
                 addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP or Intent.FLAG_ACTIVITY_NEW_TASK)
             }
         )
     }
 }
 
</code></pre>
<h4 data-id="heading-14">第三步：在Activity中调用切换方法</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例：设置页面的切换按钮点击事件</span>
 btnLight.setOnClickListener {
     ThemeUtils.switchTheme(AppCompatDelegate.MODE_NIGHT_NO)
 }
 
 btnDark.setOnClickListener {
     ThemeUtils.switchTheme(AppCompatDelegate.MODE_NIGHT_YES)
 }
 
 btnFollowSystem.setOnClickListener {
     ThemeUtils.switchTheme(AppCompatDelegate.MODE_NIGHT_FOLLOW_SYSTEM)
 }
 
</code></pre>
<p>注意：从AppCompat v1.1.0开始，setDefaultNightMode()会自动重建已启动的Activity，所以有时候不需要手动重启。但如果有特殊需求（比如保存页面状态），可以手动处理重启逻辑，并通过onSaveInstanceState()保存数据。</p>
<h2 data-id="heading-15">四、特殊场景适配：这些坑千万别踩</h2>
<p>除了常规的界面适配，还有几个特殊场景容易被忽略，一旦踩坑就会严重影响用户体验。下面逐个讲解解决方案。</p>
<h3 data-id="heading-16">1. 启动页（Splash）适配：避免"白屏闪一下"</h3>
<p>很多应用的启动页是通过WindowBackground设置的图片或颜色。如果启动页的颜色是硬编码的白色，那么在暗黑模式下启动应用时，会先闪一下白色的启动页，再切换到暗黑模式的界面，非常突兀。</p>
<p>解决方案：启动页的背景不要硬编码，使用主题属性?android:attr/colorBackground。</p>
<pre><code class="hljs language-xml" lang="xml">// 启动页的主题（在styles.xml中定义）
 <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"SplashTheme"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"Theme.MaterialComponents.DayNight.NoActionBar"</span>&gt;</span><span class="xml">
     <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowBackground"</span>&gt;</span>?android:attr/colorBackground<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 使用主题背景色 --&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android:windowFullscreen"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
 </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
 
 // 在AndroidManifest.xml中给启动Activity设置主题
 <span class="hljs-tag">&lt;<span class="hljs-name">activity</span>
     <span class="hljs-attr">android:name</span>=<span class="hljs-string">".SplashActivity"</span>
     <span class="hljs-attr">android:theme</span>=<span class="hljs-string">"@style/SplashTheme"</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.action.MAIN"</span>/&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.category.LAUNCHER"</span>/&gt;</span>
     <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span>
 
</code></pre>
<p>如果启动页用的是图片，就需要创建drawable-night目录，放置暗黑模式下的启动页图片，确保启动页和应用主题保持一致。</p>
<h3 data-id="heading-17">2. WebView适配：让网页也能跟着变暗</h3>
<p>如果应用中有WebView加载网页，默认情况下网页不会跟随系统主题变暗，会出现"应用是暗黑模式，网页是浅色模式"的割裂感。解决方案有两种：</p>
<h4 data-id="heading-18">方案1：使用WebView的forceDark功能（Android 10+）</h4>
<p>Android 10及以上版本，WebView支持forceDark功能，能自动把浅色网页转换成暗黑模式。只需在代码中开启即可：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {
     webView.settings.forceDark = WebSettings.FORCE_DARK_ON
     <span class="hljs-comment">// 可选：设置暗黑模式的对比度</span>
     webView.settings.forceDarkStrategy = WebSettings.DARK_STRATEGY_WEB_THEME_DARKEN
 }
 
</code></pre>
<h4 data-id="heading-19">方案2：自定义暗黑模式CSS</h4>
<p>如果需要兼容更低版本，或者想让网页暗黑模式更美观，可以在网页中添加暗黑模式的CSS，然后通过Android代码判断当前主题，注入对应的CSS样式。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 判断当前是否为暗黑模式</span>
 <span class="hljs-keyword">val</span> isDarkMode = resources.configuration.uiMode and Configuration.UI_MODE_NIGHT_MASK == Configuration.UI_MODE_NIGHT_YES
 
 <span class="hljs-comment">// 加载网页时注入CSS</span>
 webView.webViewClient = <span class="hljs-keyword">object</span> : WebViewClient() {
     <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageFinished</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>?, url: <span class="hljs-type">String</span>?)</span></span> {
         <span class="hljs-keyword">super</span>.onPageFinished(view, url)
         <span class="hljs-keyword">val</span> css = <span class="hljs-keyword">if</span> (isDarkMode) {
             <span class="hljs-comment">// 暗黑模式CSS：设置背景色和文字色</span>
             <span class="hljs-string">"javascript:(function() { "</span> +
                     <span class="hljs-string">"document.body.style.backgroundColor = '#121212'; "</span> +
                     <span class="hljs-string">"document.body.style.color = '#E0E0E0'; "</span> +
                     <span class="hljs-string">"})()"</span>
         } <span class="hljs-keyword">else</span> {
             <span class="hljs-comment">// 浅色模式CSS</span>
             <span class="hljs-string">"javascript:(function() { "</span> +
                     <span class="hljs-string">"document.body.style.backgroundColor = '#FFFFFF'; "</span> +
                     <span class="hljs-string">"document.body.style.color = '#333333'; "</span> +
                     <span class="hljs-string">"})()"</span>
         }
         webView.evaluateJavascript(css, <span class="hljs-literal">null</span>)
     }
 }
 
</code></pre>
<h3 data-id="heading-20">3. 通知与Widget适配：别让通知成为"视觉异类"</h3>
<p>通知和桌面Widget是在应用外部显示的，也需要适配暗黑模式，否则在暗黑模式下会出现"白色通知框+黑色文字"的刺眼组合。</p>
<p>解决方案：</p>
<ul>
<li>通知：尽量使用系统提供的通知模板（如MessagingStyle、BigTextStyle），系统会自动适配暗黑模式。避免自定义通知布局，如果必须自定义，要使用主题属性设置颜色，不要硬编码。</li>
<li>Widget：在Widget的布局中使用主题属性（如?attr/textColorPrimary、?attr/colorBackground），确保文字和背景颜色能跟随主题切换。</li>
</ul>
<pre><code class="hljs language-xml" lang="xml">// Widget布局示例（使用主题属性）
 <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
     <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
     <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
     <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
     <span class="hljs-attr">android:background</span>=<span class="hljs-string">"?attr/colorBackground"</span>
     <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span>
 
     <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
         <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/widget_title"</span>
         <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
         <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
         <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"?attr/textColorPrimary"</span>
         <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"16sp"</span>/&gt;</span>
 
 <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
 
</code></pre>
<h2 data-id="heading-21">五、常见问题排查：解决适配中的"疑难杂症"</h2>
<p>适配过程中难免会遇到各种问题，下面列举几个最常见的坑，以及对应的解决方案。</p>
<h3 data-id="heading-22">1. 切换主题时闪黑/闪白</h3>
<p>问题原因：切换主题时系统会重建Activity，重建过程中会短暂显示Window的背景色，如果背景色和当前主题不匹配，就会出现闪屏。</p>
<p>解决方案：</p>
<ul>
<li>确保所有Activity的主题都继承自DayNight主题，且WindowBackground使用主题属性；</li>
<li>在AndroidManifest.xml中给Activity添加android:configChanges="uiMode"，避免系统自动重建，然后在Activity中重写onConfigurationChanged()方法，手动更新UI；</li>
</ul>
<h3 data-id="heading-23">2. 部分视图没有跟随主题切换</h3>
<p>问题原因：大概率是在代码中硬编码了颜色，或者没有使用主题属性/资源引用。</p>
<p>解决方案：</p>
<ul>
<li>全局搜索代码中的硬编码颜色（如#FFFFFF、#000000），全部替换为主题属性或资源引用；</li>
<li>检查是否所有资源都在values-night目录下有对应的暗黑模式版本；</li>
<li>如果是动态创建的视图，确保在创建时使用主题属性获取颜色：</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 正确示例：从主题中获取颜色</span>
 <span class="hljs-keyword">val</span> textColor = ThemeUtils.getColor(context, android.R.attr.textColorPrimary)
 textView.setTextColor(textColor)
 
 <span class="hljs-comment">// 工具类方法</span>
 <span class="hljs-keyword">object</span> ThemeUtils {
     <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getColor</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, attr: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
         <span class="hljs-keyword">val</span> typedValue = TypedValue()
         context.theme.resolveAttribute(attr, typedValue, <span class="hljs-literal">true</span>)
         <span class="hljs-keyword">return</span> typedValue.<span class="hljs-keyword">data</span>
     }
 }
 
</code></pre>
<h3 data-id="heading-24">3. Force Dark功能不生效</h3>
<p>问题原因：Force Dark是Android 10提供的"一键暗黑"功能，适用于没有适配DayNight主题的应用，但有几个前提条件：</p>
<ul>
<li>应用主题必须是浅色主题（如Theme.Material.Light）；</li>
<li>必须在主题中设置android:forceDarkAllowed="true"；</li>
<li>如果应用已经继承了DayNight主题，Force Dark会自动失效（因为DayNight已经实现了暗黑模式）。</li>
</ul>
<p>解决方案：如果需要使用Force Dark，确保主题是浅色且开启了forceDarkAllowed；如果已经适配了DayNight主题，就不需要再使用Force Dark了。</p>
<h2 data-id="heading-25">六、进阶优化：让暗黑模式更极致的小技巧</h2>
<p>如果想让你的暗黑模式体验更上一层楼，可以试试下面这些小技巧：</p>
<h3 data-id="heading-26">1. 动态调整图片亮度</h3>
<p>对于一些没有适配暗黑模式的图片（比如用户头像、网络图片），可以在暗黑模式下适当降低图片亮度，避免图片过亮刺眼。可以通过ColorMatrix调整图片的亮度：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">adjustImageBrightness</span><span class="hljs-params">(imageView: <span class="hljs-type">ImageView</span>, isDarkMode: <span class="hljs-type">Boolean</span>)</span></span> {
     <span class="hljs-keyword">if</span> (isDarkMode) {
         <span class="hljs-keyword">val</span> matrix = ColorMatrix()
         matrix.setSaturation(<span class="hljs-number">0.8f</span>)  <span class="hljs-comment">// 降低饱和度</span>
         matrix.setScale(<span class="hljs-number">0.9f</span>, <span class="hljs-number">0.9f</span>, <span class="hljs-number">0.9f</span>, <span class="hljs-number">1f</span>)  <span class="hljs-comment">// 降低亮度</span>
         imageView.colorFilter = ColorMatrixColorFilter(matrix)
     } <span class="hljs-keyword">else</span> {
         imageView.colorFilter = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 恢复正常</span>
     }
 }
 
</code></pre>
<h3 data-id="heading-27">2. 适配深色模式下的状态栏</h3>
<p>在暗黑模式下，状态栏的颜色也应该跟着调整，避免出现"白色状态栏+黑色文字"的割裂感。可以通过代码动态设置状态栏颜色和文字颜色：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setStatusBarTheme</span><span class="hljs-params">(activity: <span class="hljs-type">Activity</span>, isDarkMode: <span class="hljs-type">Boolean</span>)</span></span> {
     <span class="hljs-keyword">val</span> window = activity.window
     <span class="hljs-comment">// 设置状态栏背景色</span>
     window.statusBarColor = ThemeUtils.getColor(activity, android.R.attr.colorBackground)
     <span class="hljs-comment">// 设置状态栏文字颜色（true：黑色文字；false：白色文字）</span>
     ViewCompat.getWindowInsetsController(window.decorView)?.apply {
         isAppearanceLightStatusBars = !isDarkMode
     }
 }
 
</code></pre>
<h3 data-id="heading-28">3. 测试工具推荐</h3>
<p>适配完成后，一定要做好测试。推荐两个实用的测试工具：</p>
<ul>
<li>Android Studio的Layout Inspector：可以实时查看视图的颜色、资源引用，快速定位硬编码问题；</li>
<li>Accessibility Scanner（无障碍扫描器）：可以检测文字对比度是否达标，帮助优化无障碍体验。</li>
</ul>
<h2 data-id="heading-29">七、总结：暗黑模式适配的核心要点</h2>
<p>其实暗黑模式适配的核心就三件事：<strong>不硬编码颜色、用对主题属性、做好资源匹配</strong>。从基础的继承DayNight主题，到进阶的应用内切换和特殊场景适配，只要一步步跟着做，就能做出体验优秀的暗黑模式。</p>
<p>最后再强调几个关键点：</p>
<ul>
<li>优先使用Material Design的主题属性，减少自定义颜色的成本；</li>
<li>所有资源都要做好"浅色/暗黑"双版本准备，尤其是颜色和图标；</li>
<li>切换主题时要处理好Activity重建和状态保存，避免闪屏和数据丢失；</li>
<li>一定要测试特殊场景（启动页、WebView、通知、Widget），避免出现"视觉异类"。</li>
</ul>
<p>做好暗黑模式适配，不仅能提升用户体验，还能体现开发者的细节把控能力。希望这篇全攻略能帮你顺利搞定适配工作，让你的应用在深夜也能给用户带来舒适的使用体验～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 新并发框架之 async/await]]></title>    <link>https://juejin.cn/post/7587349016221810729</link>    <guid>https://juejin.cn/post/7587349016221810729</guid>    <pubDate>2025-12-25T02:26:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587349016221810729" data-draft-id="7587368168621834246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 新并发框架之 async/await"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-12-25T02:26:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皇上o_O"/> <meta itemprop="url" content="https://juejin.cn/user/4177799913409303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 新并发框架之 async/await
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4177799913409303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皇上o_O
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T02:26:46.000Z" title="Thu Dec 25 2025 02:26:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 为什么需要 async/await</h2>
<p>在移动开发里，“并发/异步”几乎无处不在：网络请求、图片下载、文件读写、数据库操作……它们都有一个共同特点：</p>
<ul>
<li><strong>耗时</strong>（如果你在主线程里死等，会卡 UI）</li>
<li><strong>结果稍后才回来</strong>（你必须用某种方式“拿到结果”）</li>
</ul>
<p>传统的并发模型大多是“回调式”的：用 <code>completion</code>、delegate、通知等在未来某个时间点把结果交还给你。
这套方案能跑，但会带来两个典型挑战（你参考资料里也点出来了）：</p>
<ol>
<li><strong>代码维护性差</strong>：异步回调让代码阅读“跳来跳去”，不线性</li>
<li><strong>容易出现数据竞争（Data Races）</strong>：共享可变状态在并发下很容易出 Bug，而且难复现、难排查</li>
</ol>
<p>Swift 从 <strong>5.5</strong> 开始引入新并发框架，<code>async/await</code> 先解决第一个核心痛点：<strong>让异步代码看起来像同步代码一样顺畅</strong>，并且把错误处理变得更自然。</p>
<hr/>
<h2 data-id="heading-1">2. 先复习 4 个基础概念</h2>
<h3 data-id="heading-2">2.1 同步 vs 异步（描述“函数怎么返回”）</h3>
<ul>
<li><strong>同步（Synchronous）</strong>：函数执行完才返回
例子：<code>let x = add(1, 2)</code>，拿到结果才能往下走</li>
<li><strong>异步（Asynchronous）</strong>：函数把任务“丢出去”，<strong>结果以后再给你</strong>
所以你必须用 <code>completion</code> / delegate / async/await 等方式拿结果</li>
</ul>
<h3 data-id="heading-3">2.2 串行 vs 并行/并发（描述“一组任务怎么跑”）</h3>
<ul>
<li><strong>串行（Serial）</strong>：一次只执行一个任务，完成一个再下一个</li>
<li><strong>并发/并行（Concurrent/Parallel）</strong>：同一段时间内可能执行多个任务
（本文不严格区分并发与并行；你只要知道：会“同时处理多个任务”就行）</li>
</ul>
<hr/>
<h2 data-id="heading-4">3. 回调式异步的典型痛点：回调地狱 + 错误处理难看</h2>
<p>用“头像加载”来说明：
步骤：拿 URL → 下载数据（加密）→ 解密 → 解码成图片</p>
<h3 data-id="heading-5">3.1 回调地狱（Callback Hell）</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AvatarLoader</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadAvatar</span>(<span class="hljs-params">token</span>: <span class="hljs-type">String</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">UIImage</span>) -&gt; <span class="hljs-type">Void</span>) {
        fetchAvatarURL(token: token) { url <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span>.fetchAvatar(url: url) { data <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">self</span>.decryptAvatar(data: data) { data <span class="hljs-keyword">in</span>
                    <span class="hljs-keyword">self</span>.decodeImage(data: data) { image <span class="hljs-keyword">in</span>
                        completion(image)
                    }
                }
            }
        }
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchAvatarURL</span>(<span class="hljs-params">token</span>: <span class="hljs-type">String</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Void</span>) { <span class="hljs-comment">/* ... */</span> }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchAvatar</span>(<span class="hljs-params">url</span>: <span class="hljs-type">String</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Data</span>) -&gt; <span class="hljs-type">Void</span>) { <span class="hljs-comment">/* ... */</span> }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">decryptAvatar</span>(<span class="hljs-params">data</span>: <span class="hljs-type">Data</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Data</span>) -&gt; <span class="hljs-type">Void</span>) { <span class="hljs-comment">/* ... */</span> }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">decodeImage</span>(<span class="hljs-params">data</span>: <span class="hljs-type">Data</span>, <span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">UIImage</span>) -&gt; <span class="hljs-type">Void</span>) { <span class="hljs-comment">/* ... */</span> }
}
</code></pre>
<p>阅读体验像在“走迷宫”：你要不停地进回调、出回调，脑子要同时记住很多上下文。</p>
<h3 data-id="heading-6">3.2 错误处理会让代码更糟</h3>
<p>异步回调常见的写法是 <code>completion(value, error)</code> 或者 <code>Result</code>。
但在多层嵌套里，错误传递会越来越啰嗦，漏掉某个分支的 <code>completion</code> 也很常见。</p>
<hr/>
<h2 data-id="heading-7">4. async/await 的核心：把“异步代码”写成“线性代码”</h2>
<h3 data-id="heading-8">4.1 先看效果：一眼就能读懂</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AvatarLoader</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadAvatar</span>(<span class="hljs-params">token</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">UIImage</span> {
        <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> fetchAvatarURL(token: token)
        <span class="hljs-keyword">let</span> encryptedData <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> fetchAvatar(url: url)
        <span class="hljs-keyword">let</span> decryptedData <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> decryptAvatar(data: encryptedData)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> decodeImage(data: decryptedData)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchAvatarURL</span>(<span class="hljs-params">token</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">String</span> { <span class="hljs-comment">/* ... */</span> }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchAvatar</span>(<span class="hljs-params">url</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">Data</span> { <span class="hljs-comment">/* ... */</span> }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">decryptAvatar</span>(<span class="hljs-params">data</span>: <span class="hljs-type">Data</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">Data</span> { <span class="hljs-comment">/* ... */</span> }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">decodeImage</span>(<span class="hljs-params">data</span>: <span class="hljs-type">Data</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">UIImage</span> { <span class="hljs-comment">/* ... */</span> }
}
</code></pre>
<p>你会发现：</p>
<ul>
<li>代码像同步一样从上到下执行（“直线式”）</li>
<li>错误处理回到了熟悉的 <code>throws + try + do/catch</code></li>
<li>逻辑清晰、可维护性大幅提升</li>
</ul>
<hr/>
<h2 data-id="heading-9">5. 语法规则：你只需要掌握这 3 条</h2>
<h3 data-id="heading-10">5.1 <code>async</code>：声明“这个函数可能会挂起”</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetch</span>() <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Int</span> { <span class="hljs-number">42</span> }
</code></pre>
<p>含义：它是“异步函数”，执行过程中<strong>可能暂停</strong>（挂起），等待某些事情完成（比如网络返回、IO 完成）。</p>
<h3 data-id="heading-11">5.2 <code>await</code>：调用 async 函数时必须写</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> fetch()
</code></pre>
<p><code>await</code> 表示：这里是一个<strong>潜在挂起点</strong>（potential suspension point）。
意思是：运行到这里，可能会“先停一下”，等结果准备好再继续往下走。</p>
<h3 data-id="heading-12">5.3 <code>await</code> 只能出现在“异步上下文”里</h3>
<p>异步上下文主要有两类：</p>
<ol>
<li><strong>async 函数体内部</strong></li>
<li><strong>Task 闭包内部</strong></li>
</ol>
<hr/>
<h2 data-id="heading-13">6. 一个关键认知：挂起的是“函数”，不是“线程”</h2>
<p>这是很多新手最容易误解的地方：</p>
<ul>
<li><code>await</code> <strong>不是</strong>“把当前线程卡住等待”</li>
<li>它是“把当前函数挂起”，让出执行权</li>
<li>等条件满足后，再恢复执行（恢复时<strong>可能换了线程</strong>）</li>
</ul>
<p>你可以把它想象成：</p>
<blockquote>
<p>你在排队取号（await），你人可以先离开去做别的（线程去执行别的任务），等叫到你号了你再回来继续办理（函数恢复执行）。</p>
</blockquote>
<p><strong>结论</strong>：在 async/await 的世界里，别强依赖“我现在一定在某个线程上”。</p>
<hr/>
<h2 data-id="heading-14">7. 为什么“锁 + await”容易出事：一个经典坑</h2>
<p>一个很典型的示例：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> lock <span class="hljs-operator">=</span> <span class="hljs-type">NSLock</span>()

<span class="hljs-keyword">func</span> <span class="hljs-title function_">test</span>() <span class="hljs-keyword">async</span> {
    lock.lock()
    <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(nanoseconds: <span class="hljs-number">1_000_000_000</span>)
    lock.unlock()
}

<span class="hljs-keyword">for</span> <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span><span class="hljs-number">10</span> {
    <span class="hljs-type">Task</span> { <span class="hljs-keyword">await</span> test() }
}
</code></pre>
<p>问题在哪里？</p>
<ul>
<li>在 <code>lock.lock()</code> 后遇到了 <code>await</code></li>
<li>函数可能挂起并发生线程切换</li>
<li>其他任务也想拿锁，但锁可能被“拿着不放”</li>
<li>结果就是：很容易出现<strong>死锁/饥饿</strong>等难排查问题</li>
</ul>
<p><strong>经验法则：</strong></p>
<blockquote>
<p>不要在持有锁的期间跨过 <code>await</code>。
如果你需要保护共享可变状态，优先考虑 <code>actor</code>或让状态只在单一执行上下文里修改。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">8. 真正能上手的代码：用 URLSession 写一个 async 网络请求</h2>
<p>iOS 15+（Swift 5.5+）开始，<code>URLSession</code> 已经提供了 async API，例如：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: url)
</code></pre>
<p>我们做一个“获取用户信息”的示例（包含错误处理）：</p>
<h3 data-id="heading-16">8.1 定义模型与错误</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Foundation

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span>: <span class="hljs-title class_">Decodable</span> {
    <span class="hljs-keyword">let</span> id: <span class="hljs-type">Int</span>
    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>
}

<span class="hljs-keyword">enum</span> <span class="hljs-title class_">NetworkError</span>: <span class="hljs-title class_">Error</span> {
    <span class="hljs-keyword">case</span> invalidURL
    <span class="hljs-keyword">case</span> invalidResponse
    <span class="hljs-keyword">case</span> httpStatus(<span class="hljs-type">Int</span>)
}
</code></pre>
<h3 data-id="heading-17">8.2 写一个 async 网络层</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">id</span>: <span class="hljs-type">Int</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">User</span> {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://example.com/users/<span class="hljs-subst">\(id)</span>"</span>) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-type">NetworkError</span>.invalidURL
        }

        <span class="hljs-keyword">let</span> (data, response) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: url)

        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> http <span class="hljs-operator">=</span> response <span class="hljs-keyword">as?</span> <span class="hljs-type">HTTPURLResponse</span> <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-type">NetworkError</span>.invalidResponse
        }
        <span class="hljs-keyword">guard</span> (<span class="hljs-number">200</span><span class="hljs-operator">...</span><span class="hljs-number">299</span>).contains(http.statusCode) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-type">NetworkError</span>.httpStatus(http.statusCode)
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode(<span class="hljs-type">User</span>.<span class="hljs-keyword">self</span>, from: data)
    }
}
</code></pre>
<p>这一段代码的阅读体验就是“同步式”的：构建 URL → await 拿数据 → 校验 → decode。</p>
<hr/>
<h2 data-id="heading-18">9. 在 UIViewController 里怎么调用 async 并更新 UI？</h2>
<p>这是 iOS 开发里最常见的落地问题：</p>
<blockquote>
<p>async 方法不能直接在普通函数里 <code>await</code>，那我怎么从按钮点击里发请求？</p>
</blockquote>
<p>答案：用 <code>Task { }</code> 把它放进异步上下文里。</p>
<h3 data-id="heading-19">9.1 示例：点击按钮加载用户并刷新 label</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit

<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewController</span>: <span class="hljs-title class_">UIViewController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> api <span class="hljs-operator">=</span> <span class="hljs-type">APIClient</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> label <span class="hljs-operator">=</span> <span class="hljs-type">UILabel</span>()

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        view.backgroundColor <span class="hljs-operator">=</span> .white

        label.numberOfLines <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
        label.frame <span class="hljs-operator">=</span> <span class="hljs-type">CGRect</span>(x: <span class="hljs-number">20</span>, y: <span class="hljs-number">100</span>, width: <span class="hljs-number">320</span>, height: <span class="hljs-number">200</span>)
        view.addSubview(label)

        loadUser()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadUser</span>() {
        <span class="hljs-comment">// 进入异步上下文</span>
        <span class="hljs-type">Task</span> { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }

            <span class="hljs-keyword">do</span> {
                <span class="hljs-keyword">let</span> user <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> api.fetchUser(id: <span class="hljs-number">1</span>)

                <span class="hljs-comment">// 更新 UI：回到主线程（MainActor）</span>
                <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
                    <span class="hljs-keyword">self</span>.label.text <span class="hljs-operator">=</span> <span class="hljs-string">"用户：<span class="hljs-subst">\(user.name)</span><span class="hljs-subst">\n</span>ID：<span class="hljs-subst">\(user.id)</span>"</span>
                }

            } <span class="hljs-keyword">catch</span> {
                <span class="hljs-keyword">await</span> <span class="hljs-type">MainActor</span>.run {
                    <span class="hljs-keyword">self</span>.label.text <span class="hljs-operator">=</span> <span class="hljs-string">"加载失败：<span class="hljs-subst">\(error)</span>"</span>
                }
            }
        }
    }
}
</code></pre>
<p>你只要记住一句话就够了：</p>
<ul>
<li><strong>耗时工作</strong>放在 <code>Task</code> 里 <code>await</code></li>
<li><strong>UI 更新</strong>放在 <code>MainActor</code>（主线程语义）里做</li>
</ul>
<hr/>
<h2 data-id="heading-20">10. 从旧代码迁移：把 completion 回调包装成 async</h2>
<p>很多项目里已经有大量回调式 API，你不可能一夜之间全改掉。Swift 提供了“续体（Continuation）”做桥接。</p>
<h3 data-id="heading-21">10.1 假设你有旧接口</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LegacyService</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchText</span>(<span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Error</span>&gt;) -&gt; <span class="hljs-type">Void</span>) {
        <span class="hljs-type">DispatchQueue</span>.global().asyncAfter(deadline: .now() <span class="hljs-operator">+</span> <span class="hljs-number">1</span>) {
            completion(.success(<span class="hljs-string">"hello async/await"</span>))
        }
    }
}
</code></pre>
<h3 data-id="heading-22">10.2 用 withCheckedThrowingContinuation 包装</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">LegacyService</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchText</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">String</span> {
        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withCheckedThrowingContinuation { continuation <span class="hljs-keyword">in</span>
            fetchText { result <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">switch</span> result {
                <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> text):
                    continuation.resume(returning: text)
                <span class="hljs-keyword">case</span> .failure(<span class="hljs-keyword">let</span> error):
                    continuation.resume(throwing: error)
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-23">10.3 使用方式</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Task</span> {
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">let</span> text <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">LegacyService</span>().fetchText()
        <span class="hljs-built_in">print</span>(text)
    } <span class="hljs-keyword">catch</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"error:"</span>, error)
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-24">11. 入门阶段的最佳实践清单</h2>
<ol>
<li><strong>不要在持锁期间跨 <code>await</code></strong>（容易死锁/逻辑卡住）</li>
<li><strong>UI 更新统一回到 <code>MainActor</code></strong>（避免主线程问题）</li>
<li><strong>能用 <code>throws</code> 就别用 Optional+error 乱传</strong>：错误路径更清晰</li>
<li><strong>从入口处就结构化</strong>：<code>async</code> 函数调用 <code>async</code> 函数，别层层回调</li>
<li><strong>迁移旧代码用 Continuation</strong>：逐步改，不要一次性重构到崩</li>
</ol>
<hr/>
<h2 data-id="heading-25">12. 小结</h2>
<p>到这里，你已经具备了 async/await 的“可用级理解”：</p>
<ul>
<li><code>async</code>：这个函数可能挂起</li>
<li><code>await</code>：潜在挂起点，只能在异步上下文使用</li>
<li>async/await 让异步代码“线性可读”，错误处理回到 <code>throws</code></li>
<li>挂起的是函数，不是线程；<code>await</code> 前后可能换线程</li>
<li>iOS 里用 <code>Task {}</code> 进入异步上下文，用 <code>MainActor</code> 更新 UI</li>
<li>旧回调接口可以用 <code>withCheckedThrowingContinuation</code> 平滑迁移</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nextcloud Docker 容器化部署指南]]></title>    <link>https://juejin.cn/post/7587299670642704390</link>    <guid>https://juejin.cn/post/7587299670642704390</guid>    <pubDate>2025-12-25T02:06:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587299670642704390" data-draft-id="7587329107303415871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nextcloud Docker 容器化部署指南"/> <meta itemprop="keywords" content="Docker,数据可视化,数据分析"/> <meta itemprop="datePublished" content="2025-12-25T02:06:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老赵"/> <meta itemprop="url" content="https://juejin.cn/user/3208848015890347"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nextcloud Docker 容器化部署指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3208848015890347/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老赵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T02:06:29.000Z" title="Thu Dec 25 2025 02:06:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">概述</h3>
<p>Nextcloud 是一款开源的容器化应用，为用户提供安全的数据存储与管理解决方案，支持文件访问与共享、日历、联系人、邮件等多种功能，可从任何设备访问，完全由用户自主掌控。该Docker镜像由Nextcloud社区开发维护，旨在提供轻量级、可扩展的部署方式。</p>
<p>本文档将详细介绍如何通过Docker容器化方式部署 Nextcloud ，包括环境准备、镜像拉取、容器配置、功能测试及生产环境优化建议，帮助用户快速搭建稳定可靠的NEXTCLOUD服务。</p>
<h3 data-id="heading-1">环境准备</h3>
<h4 data-id="heading-2">Docker环境安装</h4>
<p>部署 Nextcloud 容器前，需先确保服务器已安装Docker环境。推荐使用以下一键安装脚本，适用于主流Linux发行版：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">bash</span> &lt;(wget -qO- <span class="hljs-attribute">https</span>:<span class="hljs-comment">//xuanyuan.cloud/docker.sh)</span>
</code></pre>
<p>脚本执行过程中需根据提示完成必要配置，安装完成后可通过<code>docker --version</code>命令验证Docker是否正常安装。</p>
<h3 data-id="heading-3">镜像准备</h3>
<h4 data-id="heading-4">拉取 Nextcloud 镜像</h4>
<p>使用以下命令通过轩辕镜像访问支持地址拉取最新版本的 Nextcloud 镜像：</p>
<pre><code class="hljs language-arduino" lang="arduino">docker pull xxx.xuanyuan.run/library/nextcloud:latest
</code></pre>
<p>如需查看所有可用版本标签，可访问 Nextcloud 镜像标签列表 <code>https://xuanyuan.cloud/r/library/nextcloud/tags</code>。</p>
<h3 data-id="heading-5">容器部署</h3>
<h4 data-id="heading-6">基础部署（适用于测试环境）</h4>
<p>以下命令将创建一个基础的 Nextcloud 容器，使用默认配置和SQLite数据库，适合快速测试：</p>
<pre><code class="hljs language-arduino" lang="arduino">docker run -d \  --name nextcloud \  -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> \  -v nextcloud_data:/var/www/html \  xxx.xuanyuan.run/library/nextcloud:latest
</code></pre>
<p><strong>参数说明</strong>：</p>
<ul>
<li>• <code>-d</code>：后台运行容器</li>
<li>• <code>--name nextcloud</code>：指定容器名称为nextcloud</li>
<li>• <code>-p 80:80</code>：将容器80端口映射到主机80端口（端口配置请参考 NEXTCLOUD镜像文档（轩辕） <code>https://xuanyuan.cloud/r/library/nextcloud</code>）</li>
<li>• <code>-v nextcloud_data:/var/www/html</code>：创建命名卷<code>nextcloud_data</code>挂载到容器内<code>/var/www/html</code>目录，用于持久化存储数据</li>
</ul>
<h4 data-id="heading-7">自定义配置部署（适用于开发环境）</h4>
<p>如需自定义管理员账户、数据库配置等，可通过环境变量实现自动配置：</p>
<pre><code class="hljs language-javascript" lang="javascript">docker run -d \  --name nextcloud \  -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> \  -v <span class="hljs-attr">nextcloud_data</span>:<span class="hljs-regexp">/var/</span>www/html \  -v <span class="hljs-attr">nextcloud_config</span>:<span class="hljs-regexp">/var/</span>www/html/config \  -v <span class="hljs-attr">nextcloud_apps</span>:<span class="hljs-regexp">/var/</span>www/html/custom_apps \  -e <span class="hljs-variable constant_">NEXTCLOUD_ADMIN_USER</span>=admin \  -e <span class="hljs-variable constant_">NEXTCLOUD_ADMIN_PASSWORD</span>=your_secure_password \  -e <span class="hljs-variable constant_">NEXTCLOUD_TRUSTED_DOMAINS</span>=<span class="hljs-string">"localhost 192.168.1.100"</span> \  xxx.<span class="hljs-property">xuanyuan</span>.<span class="hljs-property">run</span>/library/<span class="hljs-attr">nextcloud</span>:latest
</code></pre>
<p><strong>新增参数说明</strong>：</p>
<ul>
<li>• 额外挂载<code>nextcloud_config</code>和<code>nextcloud_apps</code>卷，分别用于持久化配置文件和自定义应用</li>
<li>• <code>NEXTCLOUD_ADMIN_USER</code>：设置管理员用户名</li>
<li>• <code>NEXTCLOUD_ADMIN_PASSWORD</code>：设置管理员密码（请替换为安全密码）</li>
<li>• <code>NEXTCLOUD_TRUSTED_DOMAINS</code>：设置可访问NEXTCLOUD的可信域名，多个域名用空格分隔</li>
</ul>
<h4 data-id="heading-8">外部数据库部署（推荐配置）</h4>
<p>NEXTCLOUD默认使用SQLite数据库，适合测试环境。生产环境建议使用MySQL/MariaDB或PostgreSQL数据库以提升性能和可靠性。以下是使用MariaDB的示例：</p>
<ol>
<li>
<p>1. <strong>启动MariaDB容器</strong>：</p>
<p>docker run -d \  --name nextcloud_db \  -v nextcloud_db:/var/lib/mysql \  -e MYSQL_ROOT_PASSWORD=root_password \  -e MYSQL_DATABASE=nextcloud \  -e MYSQL_USER=nextcloud_user \  -e MYSQL_PASSWORD=db_user_password \  mariadb:10.6</p>
</li>
<li>
<p>2. <strong>启动NEXTCLOUD容器并连接数据库</strong>：</p>
<p>docker run -d \  --name nextcloud \  --link nextcloud_db:db \  -p 80:80 \  -v nextcloud_data:/var/www/html \  -e MYSQL_HOST=db \  -e MYSQL_DATABASE=nextcloud \  -e MYSQL_USER=nextcloud_user \  -e MYSQL_PASSWORD=db_user_password \  -e NEXTCLOUD_ADMIN_USER=admin \  -e NEXTCLOUD_ADMIN_PASSWORD=your_secure_password \  xxx.xuanyuan.run/library/nextcloud:latest</p>
</li>
</ol>
<p><strong>说明</strong>：<code>--link nextcloud_db:db</code>参数将MariaDB容器链接到NEXTCLOUD容器，使NEXTCLOUD可通过<code>db</code>主机名访问数据库。</p>
<h3 data-id="heading-9">功能测试</h3>
<h4 data-id="heading-10">服务访问测试</h4>
<p>容器启动后，可通过以下方式验证服务是否正常运行：</p>
<ol>
<li>
<p>1. <strong>浏览器访问</strong>：在浏览器中输入<code>http://服务器IP</code>，首次访问将显示NEXTCLOUD设置页面（如未通过环境变量预设管理员账户）或直接进入登录界面。</p>
</li>
<li>
<p>2. <strong>命令行访问</strong>：使用<code>curl</code>命令测试端口连通性：</p>
<p>curl -I <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost" target="_blank" title="http://localhost" ref="nofollow noopener noreferrer">http://localhost</a></p>
</li>
</ol>
<p>若返回<code>HTTP/1.1 200 OK</code>或<code>HTTP/1.1 302 Found</code>，表示服务基本正常。</p>
<h4 data-id="heading-11">容器状态检查</h4>
<p>通过以下命令查看容器运行状态：</p>
<pre><code class="hljs language-python" lang="python">docker ps --<span class="hljs-built_in">filter</span> <span class="hljs-string">"name=nextcloud"</span>
</code></pre>
<p>正常情况下，容器状态应为<code>Up</code>。</p>
<h4 data-id="heading-12">日志查看</h4>
<p>查看容器日志以排查潜在问题：</p>
<pre><code class="hljs">docker logs nextcloud
</code></pre>
<p>首次启动时，日志将显示初始化过程，包括数据库连接、文件权限配置等信息。若出现错误，可根据日志提示进行排查。</p>
<h4 data-id="heading-13">基础功能测试</h4>
<ol>
<li>1. <strong>登录测试</strong>：使用预设的管理员账户登录系统，验证认证功能。</li>
<li>2. <strong>文件上传测试</strong>：上传一个小型测试文件，验证存储功能是否正常。</li>
<li>3. <strong>应用访问测试</strong>：访问内置应用（如“文件”、“相册”），确认应用加载正常。</li>
</ol>
<h3 data-id="heading-14">生产环境建议</h3>
<h4 data-id="heading-15">数据持久化优化</h4>
<p>生产环境中，建议对NEXTCLOUD的数据目录进行精细化挂载，确保数据安全和升级兼容性：</p>
<pre><code class="hljs language-javascript" lang="javascript">docker run -d \  --name nextcloud \  -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> \  -v <span class="hljs-attr">nextcloud_html</span>:<span class="hljs-regexp">/var/</span>www/html \  -v <span class="hljs-attr">nextcloud_data</span>:<span class="hljs-regexp">/var/</span>www/html/data \  -v <span class="hljs-attr">nextcloud_config</span>:<span class="hljs-regexp">/var/</span>www/html/config \  -v <span class="hljs-attr">nextcloud_apps</span>:<span class="hljs-regexp">/var/</span>www/html/custom_apps \  -v <span class="hljs-attr">nextcloud_themes</span>:<span class="hljs-regexp">/var/</span>www/html/themes \  xxx.<span class="hljs-property">xuanyuan</span>.<span class="hljs-property">run</span>/library/<span class="hljs-attr">nextcloud</span>:latest
</code></pre>
<p><strong>挂载说明</strong>：</p>
<ul>
<li>• <code>/var/www/html/data</code>：用户上传文件存储目录</li>
<li>• <code>/var/www/html/config</code>：配置文件目录</li>
<li>• <code>/var/www/html/custom_apps</code>：自定义应用目录</li>
<li>• <code>/var/www/html/themes</code>：主题文件目录</li>
</ul>
<h4 data-id="heading-16">安全加固</h4>
<ol>
<li>
<p>1. <strong>启用HTTPS</strong>：生产环境必须配置HTTPS，可通过反向代理（如Nginx、Traefik）实现。示例Nginx配置可参考 NEXTCLOUD官方文档 <code>https://docs.nextcloud.com/server/latest/admin_manual/installation/nginx.html</code>。</p>
</li>
<li>
<p>2. <strong>限制容器权限</strong>：使用非root用户运行容器，减少安全风险：</p>
<p>docker run -d \  --name nextcloud \  --user 33:33 \  # www-data用户ID和组ID  -p 80:80 \  -v nextcloud_data:/var/www/html \  xxx.xuanyuan.run/library/nextcloud:latest</p>
</li>
<li>
<p>3. <strong>设置防火墙</strong>：只开放必要端口（如80/443），限制访问来源。</p>
</li>
</ol>
<h4 data-id="heading-17">性能优化</h4>
<ol>
<li>
<p>1. <strong>使用Redis缓存</strong>：配置Redis用于文件锁定和缓存，提升并发性能：</p>
<h2 data-id="heading-18">启动Redis容器docker run -d --name nextcloud_redis redis:alpine# 启动NEXTCLOUD并配置Redisdocker run -d \  --name nextcloud \  --link nextcloud_db:db \  --link nextcloud_redis:redis \  -p 80:80 \  -e REDIS_HOST=redis \  -e REDIS_HOST_PASSWORD=your_redis_password \  -v nextcloud_data:/var/www/html \  xxx.xuanyuan.run/library/nextcloud:latest</h2>
</li>
<li>
<p>2. <strong>调整PHP参数</strong>：根据服务器配置调整PHP内存限制和上传限制：</p>
<p>docker run -d \  --name nextcloud \  -e PHP_MEMORY_LIMIT=1G \  # 调整PHP内存限制为1GB  -e PHP_UPLOAD_LIMIT=10G \  # 调整上传限制为10GB  -v nextcloud_data:/var/www/html \  xxx.xuanyuan.run/library/nextcloud:latest</p>
</li>
<li>
<p>3. <strong>数据库优化</strong>：对MariaDB/MySQL进行性能调优，如调整连接数、缓存大小等，具体配置可参考数据库官方文档。</p>
</li>
</ol>
<h4 data-id="heading-19">备份策略</h4>
<p>定期备份NEXTCLOUD数据和数据库，建议使用以下策略：</p>
<ol>
<li>
<p>1. <strong>数据卷备份</strong>：使用<code>docker volume inspect</code>找到卷的实际路径，然后通过<code>rsync</code>或<code>tar</code>进行备份。</p>
</li>
<li>
<p>2. <strong>数据库备份</strong>：对MariaDB容器执行数据库导出：</p>
<p>docker exec nextcloud_db mysqldump -u root -p'root_password' nextcloud &gt; nextcloud_db_backup_$(date +%Y%m%d).sql</p>
</li>
<li>
<p>3. <strong>自动化备份</strong>：使用crontab设置定时任务，自动执行备份脚本，并将备份文件存储到外部存储或云存储服务。</p>
</li>
</ol>
<h3 data-id="heading-20">故障排查</h3>
<h4 data-id="heading-21">常见问题及解决方法</h4>
<ol>
<li>1. <strong>服务无法访问</strong></li>
</ol>
<ul>
<li>• 检查容器状态：<code>docker ps --filter "name=nextcloud"</code>，若未运行，使用<code>docker start nextcloud</code>启动</li>
<li>• 检查端口映射：<code>netstat -tulpn | grep 80</code>，确认端口未被占用</li>
<li>• 检查防火墙规则：确保服务器防火墙允许80/443端口访问</li>
</ul>
<ol start="3">
<li>2. <strong>数据库连接失败</strong></li>
</ol>
<ul>
<li>• 查看容器日志：<code>docker logs nextcloud</code>，检查数据库连接错误信息</li>
<li>• 验证数据库容器状态：<code>docker ps --filter "name=nextcloud_db"</code></li>
<li>• 检查数据库环境变量：确认<code>MYSQL_HOST</code>、<code>MYSQL_USER</code>、<code>MYSQL_PASSWORD</code>等参数正确</li>
</ul>
<ol start="5">
<li>3. <strong>文件上传失败</strong></li>
</ol>
<ul>
<li>• 检查目录权限：容器内<code>/var/www/html/data</code>目录权限应为www-data用户（ID 33）所有</li>
<li>• 检查PHP上传限制：通过环境变量<code>PHP_UPLOAD_LIMIT</code>调整上传大小限制</li>
<li>• 检查磁盘空间：使用<code>df -h</code>确认主机磁盘空间充足</li>
</ul>
<ol start="7">
<li>4. <strong>升级后功能异常</strong></li>
</ol>
<ul>
<li>
<p>• 查看升级日志：<code>docker logs nextcloud</code>，检查升级过程中的错误</p>
</li>
<li>
<p>• 禁用第三方应用：通过<code>occ</code>命令禁用可能不兼容的自定义应用：</p>
<pre><code class="hljs language-sql" lang="sql">docker <span class="hljs-keyword">exec</span> <span class="hljs-comment">--user www-data nextcloud php occ app:disable problematic_app</span>
</code></pre>
</li>
<li>
<p>• 恢复备份：若升级失败，可使用之前的备份恢复数据和配置</p>
</li>
</ul>
<h4 data-id="heading-22">日志排查工具</h4>
<ol>
<li>
<p>1. <strong>容器日志</strong>：<code>docker logs -f nextcloud</code>（<code>-f</code>参数可实时查看日志）</p>
</li>
<li>
<p>2. <strong>应用日志</strong>：Nextcloud 应用日志位于<code>/var/www/html/data/nextcloud.log</code>，可通过以下命令查看：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> nextcloud <span class="hljs-built_in">cat</span> /var/www/html/data/nextcloud.log
</code></pre>
</li>
<li>
<p>3. <strong>数据库日志</strong>：查看MariaDB容器日志以排查数据库问题：</p>
<pre><code class="hljs">docker logs nextcloud_db
</code></pre>
</li>
</ol>
<h3 data-id="heading-23">参考资源</h3>
<ol>
<li>1. Nextcloud 镜像文档（轩辕） <code>https://xuanyuan.cloud/r/library/nextcloud</code> - 轩辕镜像提供的NEXTCLOUD镜像详细说明</li>
<li>2. Nextcloud 镜像标签列表 <code>https://xuanyuan.cloud/r/library/nextcloud/tags</code> - 所有可用镜像版本标签</li>
<li>3. Nextcloud官方文档 <code>https://docs.nextcloud.com</code> - Nextcloud项目官方文档，包含详细的配置和管理指南</li>
<li>4. Docker官方文档 <code>https://docs.docker.com</code> - Docker容器技术官方文档，包含容器管理、网络、存储等基础内容</li>
<li>5. MariaDB官方文档 <code>https://mariadb.com/kb/en</code> - MariaDB数据库官方文档，包含性能优化、备份恢复等内容</li>
</ol>
<h3 data-id="heading-24">总结</h3>
<p>本文详细介绍了 Nextcloud 的Docker容器化部署方案，从环境准备、镜像拉取、基础部署到生产环境优化，提供了一套完整的部署流程。通过容器化部署，用户可快速搭建 Nextcloud 服务，并根据实际需求进行灵活配置。</p>
<p><strong>关键要点</strong>：</p>
<ul>
<li>• 使用轩辕镜像访问支持可提升 Nextcloud 镜像下载访问表现，简化部署流程</li>
<li>• 测试环境可使用基础部署命令快速启动，生产环境需配置外部数据库和HTTPS</li>
<li>• 数据持久化需通过Docker卷实现，建议精细化挂载关键目录以确保数据安全</li>
<li>• 定期备份数据和数据库是生产环境稳定运行的重要保障</li>
<li>• 遇到问题时，可通过容器日志、应用日志和数据库日志进行排查</li>
</ul>
<p><strong>后续建议</strong>：</p>
<ul>
<li>• 深入学习 Nextcloud 的高级特性，如外部存储集成、LDAP认证、联邦共享等，扩展服务功能</li>
<li>• 根据业务需求调整性能参数，如PHP内存限制、数据库连接数、缓存策略等，优化系统性能</li>
<li>• 关注 Nextcloud 镜像标签列表 <code>https://xuanyuan.cloud/r/library/nextcloud/tags</code>，及时更新镜像版本以获取安全补丁和新功能</li>
<li>• 建立完善的监控体系，对 Nextcloud 服务的运行状态、资源使用率进行实时监控，确保服务稳定运行</li>
</ul>
<p>通过本文档的指导，用户可在各种环境中高效部署和管理 Nextcloud 服务，充分利用其数据管理和协作功能，满足个人或企业的需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微前端从入门到精通：Vue开发者的大型应用架构演进指南]]></title>    <link>https://juejin.cn/post/7587412021709225990</link>    <guid>https://juejin.cn/post/7587412021709225990</guid>    <pubDate>2025-12-25T03:26:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587412021709225990" data-draft-id="7587349016222302249" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微前端从入门到精通：Vue开发者的大型应用架构演进指南"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2025-12-25T03:26:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_chiu"/> <meta itemprop="url" content="https://juejin.cn/user/1644525124592974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微前端从入门到精通：Vue开发者的大型应用架构演进指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1644525124592974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_chiu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T03:26:07.000Z" title="Thu Dec 25 2025 03:26:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开篇：当Vue应用从“小别墅”变成“摩天大楼”</h2>
<p>作为Vue开发者，你是否经历过这样的技术焦虑？</p>
<ul>
<li>项目代码量突破10万行，<code>npm run build</code> 时间超过5分钟</li>
<li>15个团队在同一个代码库中并行开发，每天产生数十个合并冲突</li>
<li>每次功能上线都需要全量回归测试，发布窗口越来越小</li>
<li>想用Vue 3的Composition API重构老代码，却无从下手</li>
</ul>
<p>这正是微前端架构要解决的核心问题。本文将为你呈现一套完整的Vue微前端实战指南，从基础概念到生产级架构设计，助你掌握大型Vue应用的拆分艺术。</p>
<h2 data-id="heading-1">第一章：重新认识微前端——不只是代码拆分</h2>
<h3 data-id="heading-2">1.1 微前端的本质：技术架构与组织架构的融合</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 微前端解决的不仅是技术问题</span>
<span class="hljs-keyword">const</span> microFrontendBenefits = {
  <span class="hljs-attr">technical</span>: [
    <span class="hljs-string">'独立开发、部署'</span>,
    <span class="hljs-string">'技术栈异构（Vue 2/3、React并行）'</span>,
    <span class="hljs-string">'渐进式升级'</span>,
    <span class="hljs-string">'增量更新'</span>
  ],
  <span class="hljs-attr">organizational</span>: [
    <span class="hljs-string">'团队自治'</span>,
    <span class="hljs-string">'并行开发流'</span>,
    <span class="hljs-string">'按业务领域划分职责'</span>,
    <span class="hljs-string">'降低协作成本'</span>
  ]
};
</code></pre>
<h3 data-id="heading-3">1.2 Vue开发者的微前端思维转变</h3>
<p><strong>传统思维：</strong></p>
<pre><code class="hljs">单仓库 → 集中路由 → 全局状态 → 统一构建 → 全量部署
</code></pre>
<p><strong>微前端思维：</strong></p>
<pre><code class="hljs">多仓库 → 路由聚合 → 状态隔离 → 独立构建 → 增量部署
</code></pre>
<h2 data-id="heading-4">第二章：Vue微前端核心技术选型深度解析</h2>
<h3 data-id="heading-5">2.1 主流方案横向对比</h3>








































<table><thead><tr><th>方案</th><th>核心原理</th><th>Vue支持度</th><th>生产就绪度</th><th>学习成本</th></tr></thead><tbody><tr><td><strong>qiankun</strong></td><td>运行时加载 + JS沙箱</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>中</td></tr><tr><td><strong>Module Federation</strong></td><td>编译时依赖共享</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>高</td></tr><tr><td><strong>Single-SPA</strong></td><td>生命周期调度</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>中</td></tr><tr><td><strong>无界</strong></td><td>iframe沙箱</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>低</td></tr></tbody></table>
<h3 data-id="heading-6">2.2 我们的选择：qiankun + Vue 3生态体系</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 技术栈全景图</span>
<span class="hljs-keyword">const</span> techStack = {
  <span class="hljs-attr">baseFramework</span>: <span class="hljs-string">'Vue 3 + TypeScript + Vite'</span>,
  <span class="hljs-attr">microFramework</span>: {
    <span class="hljs-attr">host</span>: <span class="hljs-string">'Vue 3 + qiankun'</span>,
    <span class="hljs-attr">microApps</span>: [
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'auth-center'</span>, <span class="hljs-attr">stack</span>: <span class="hljs-string">'Vue 3 + Pinia'</span> },
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'dashboard'</span>, <span class="hljs-attr">stack</span>: <span class="hljs-string">'Vue 3 + Composition API'</span> },
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'legacy-module'</span>, <span class="hljs-attr">stack</span>: <span class="hljs-string">'Vue 2 + Vuex'</span> },
      { <span class="hljs-attr">name</span>: <span class="hljs-string">'experimental'</span>, <span class="hljs-attr">stack</span>: <span class="hljs-string">'React 18'</span> } <span class="hljs-comment">// 技术栈自由！</span>
    ]
  },
  <span class="hljs-attr">stateManagement</span>: <span class="hljs-string">'Pinia (主应用) + 自定义通信协议'</span>,
  <span class="hljs-attr">buildSystem</span>: <span class="hljs-string">'Vite (微应用) + Webpack (主应用)'</span>
};
</code></pre>
<h2 data-id="heading-7">第三章：实战演练——从零构建生产级Vue微前端架构</h2>
<h3 data-id="heading-8">3.1 主应用：微前端的“航空母舰”</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// main-app/src/micro/registry.ts - 微应用注册中心</span>
<span class="hljs-keyword">import</span> { registerMicroApps, start, initGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'qiankun'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">MicroApp</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/micro'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">microApps</span>: <span class="hljs-title class_">MicroApp</span>[] = [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vue3-auth'</span>,
    <span class="hljs-attr">entry</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_AUTH_APP_URL</span>,
    <span class="hljs-attr">container</span>: <span class="hljs-string">'#micro-container'</span>,
    <span class="hljs-attr">activeRule</span>: <span class="hljs-string">'/auth'</span>,
    <span class="hljs-attr">props</span>: {
      <span class="hljs-attr">routerBase</span>: <span class="hljs-string">'/auth'</span>,
      <span class="hljs-attr">sharedStore</span>: <span class="hljs-title function_">initGlobalState</span>({ <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span> }),
      <span class="hljs-attr">onAuthSuccess</span>: <span class="hljs-function">(<span class="hljs-params">token: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'token'</span>, token);
      }
    }
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vue2-legacy'</span>,
    <span class="hljs-attr">entry</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_LEGACY_APP_URL</span>,
    <span class="hljs-attr">container</span>: <span class="hljs-string">'#micro-container'</span>,
    <span class="hljs-attr">activeRule</span>: <span class="hljs-string">'/legacy'</span>,
    <span class="hljs-attr">props</span>: {
      <span class="hljs-comment">// Vue 2兼容性适配器</span>
      <span class="hljs-attr">vue2Adapter</span>: <span class="hljs-literal">true</span>
    }
  }
];

<span class="hljs-comment">// 智能预加载策略</span>
<span class="hljs-keyword">const</span> prefetchApps = microApps
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> app.<span class="hljs-property">priority</span> === <span class="hljs-string">'high'</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> app.<span class="hljs-property">name</span>);

<span class="hljs-title function_">registerMicroApps</span>(microApps, {
  <span class="hljs-attr">beforeLoad</span>: [<span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`加载 <span class="hljs-subst">${app.name}</span>`</span>)],
  <span class="hljs-attr">beforeMount</span>: [<span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`挂载 <span class="hljs-subst">${app.name}</span>`</span>)],
  <span class="hljs-attr">afterUnmount</span>: [<span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`卸载 <span class="hljs-subst">${app.name}</span>`</span>)]
});

<span class="hljs-title function_">start</span>({
  <span class="hljs-attr">prefetch</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">sandbox</span>: {
    <span class="hljs-attr">experimentalStyleIsolation</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// CSS隔离</span>
  },
  <span class="hljs-attr">singular</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 允许同时运行多个微应用</span>
});
</code></pre>
<h3 data-id="heading-9">3.2 Vue 3微应用：现代化配置</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// micro-auth/src/entry.ts - 微应用入口文件</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>;
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> createApp&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">props: <span class="hljs-built_in">any</span> = {}</span>) {
  <span class="hljs-keyword">const</span> { container, routerBase } = props;
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>);
  
  <span class="hljs-comment">// 独立运行时与嵌入运行时路由差异化</span>
  <span class="hljs-keyword">const</span> baseRouter = routerBase || <span class="hljs-string">'/'</span>;
  
  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">router</span>(baseRouter));
  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createPinia</span>());
  
  <span class="hljs-comment">// 挂载到指定容器或默认#app</span>
  <span class="hljs-keyword">const</span> target = container 
    ? container.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#auth-app'</span>) 
    : <span class="hljs-string">'#auth-app'</span>;
  
  instance = app.<span class="hljs-title function_">mount</span>(target);
  <span class="hljs-keyword">return</span> instance;
}

<span class="hljs-comment">// 独立运行</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">__POWERED_BY_QIANKUN__</span>) {
  <span class="hljs-title function_">render</span>();
}

<span class="hljs-comment">// qiankun生命周期协议</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Auth] 微应用启动'</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params">props: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Auth] 接收主应用参数'</span>, props);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">render</span>(props);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unmount</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (instance &amp;&amp; instance.<span class="hljs-property">$destroy</span>) {
    instance.$destroy();
  }
  instance = <span class="hljs-literal">null</span>;
}
</code></pre>
<h3 data-id="heading-10">3.3 Vue 2微应用：兼容性适配方案</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// micro-legacy/src/public-path.js</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">__POWERED_BY_QIANKUN__</span>) {
  <span class="hljs-comment">// 动态设置webpack publicPath</span>
  __webpack_public_path__ = <span class="hljs-variable language_">window</span>.<span class="hljs-property">__INJECTED_PUBLIC_PATH_BY_QIANKUN__</span>;
}

<span class="hljs-comment">// micro-legacy/src/main.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;

<span class="hljs-keyword">let</span> vueInstance = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">{ container, routerBase } = {}</span>) {
  <span class="hljs-keyword">const</span> target = container 
    ? container.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#legacy-app'</span>) 
    : <span class="hljs-string">'#legacy-app'</span>;
  
  vueInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
    store,
    <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">App</span>)
  }).$mount(target);
  
  <span class="hljs-keyword">return</span> vueInstance;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Legacy] Vue 2应用启动'</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Legacy] 挂载'</span>, props);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">render</span>(props);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unmount</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (vueInstance) {
    vueInstance.$destroy();
    vueInstance.<span class="hljs-property">$el</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
  }
  vueInstance = <span class="hljs-literal">null</span>;
}
</code></pre>
<h2 data-id="heading-11">第四章：高级特性实现——突破微前端核心难题</h2>
<h3 data-id="heading-12">4.1 跨应用状态管理：不只是Pinia/Vuex</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// shared/src/stores/global-store.ts - 跨应用状态总线</span>
<span class="hljs-keyword">import</span> { reactive, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { initGlobalState, <span class="hljs-title class_">MicroAppStateActions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'qiankun'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalStore</span> {
  <span class="hljs-keyword">private</span> state = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span>,
    <span class="hljs-attr">permissions</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[],
    <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span> <span class="hljs-keyword">as</span> <span class="hljs-string">'light'</span> | <span class="hljs-string">'dark'</span>
  });
  
  <span class="hljs-keyword">private</span> <span class="hljs-attr">actions</span>: <span class="hljs-title class_">MicroAppStateActions</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span> = <span class="hljs-title function_">initGlobalState</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);
    
    <span class="hljs-comment">// 监听状态变化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span>.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">newState, prevState</span>) =&gt;</span> {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>, newState);
    });
  }
  
  <span class="hljs-comment">// 更新状态并同步到所有微应用</span>
  <span class="hljs-title function_">setUser</span>(<span class="hljs-params">user: User</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">user</span> = user;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span>?.<span class="hljs-title function_">setGlobalState</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);
  }
  
  <span class="hljs-comment">// 仅本地更新，不广播</span>
  <span class="hljs-title function_">setThemeLocal</span>(<span class="hljs-params">theme: <span class="hljs-string">'light'</span> | <span class="hljs-string">'dark'</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">theme</span> = theme;
  }
  
  <span class="hljs-title function_">getState</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> globalStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalStore</span>();

<span class="hljs-comment">// 在Vue组件中使用</span>
<span class="hljs-keyword">import</span> { globalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@shared/store'</span>;
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { user, theme } = <span class="hljs-title function_">storeToRefs</span>(globalStore.<span class="hljs-title function_">getState</span>());
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateUser</span> = (<span class="hljs-params"/>) =&gt; {
      globalStore.<span class="hljs-title function_">setUser</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span> });
    };
    
    <span class="hljs-keyword">return</span> { user, theme, updateUser };
  }
};
</code></pre>
<h3 data-id="heading-13">4.2 CSS隔离的终极方案</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 方案一：CSS Modules + 命名空间（推荐）</span>
<span class="hljs-selector-class">.auth-app</span> {
  <span class="hljs-comment">// 所有样式都在命名空间下</span>
  :global {
    <span class="hljs-selector-class">.button</span> {
      <span class="hljs-comment">// 覆盖全局样式</span>
    }
  }
}

<span class="hljs-comment">// 方案二：动态样式表加载/卸载</span>
class ScopedCSSManager {
  private styleCache = new Map&lt;string, HTMLStyleElement&gt;();
  
  <span class="hljs-built_in">load</span>(appName: string, css: string) {
    const style = document<span class="hljs-selector-class">.createElement</span>('style');
    style<span class="hljs-selector-class">.setAttribute</span>('data-app', appName);
    style<span class="hljs-selector-class">.textContent</span> = this<span class="hljs-selector-class">.scopeCSS</span>(css, appName);
    document<span class="hljs-selector-class">.head</span><span class="hljs-selector-class">.appendChild</span>(style);
    this<span class="hljs-selector-class">.styleCache</span><span class="hljs-selector-class">.set</span>(appName, style);
  }
  
  <span class="hljs-built_in">unload</span>(appName: string) {
    const style = this<span class="hljs-selector-class">.styleCache</span><span class="hljs-selector-class">.get</span>(appName);
    if (style &amp;&amp; document.head.contains(style)) {
      document<span class="hljs-selector-class">.head</span><span class="hljs-selector-class">.removeChild</span>(style);
    }
    this<span class="hljs-selector-class">.styleCache</span><span class="hljs-selector-class">.delete</span>(appName);
  }
  
  private <span class="hljs-built_in">scopeCSS</span>(css: string, appName: string): string {
    <span class="hljs-comment">// 将选择器转换为 [data-app="auth"] .button 形式</span>
    return css<span class="hljs-selector-class">.replace</span>(/([^{]+)\{/g, `<span class="hljs-selector-attr">[data-app=<span class="hljs-string">"${appName}"</span>]</span> $<span class="hljs-number">1</span>{`);
  }
}
</code></pre>
<h3 data-id="heading-14">4.3 智能路由与导航守卫</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// main-app/src/router/micro-router.ts</span>
<span class="hljs-keyword">import</span> { createRouter, createWebHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;

<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/layouts/MainLayout.vue'</span>),
    <span class="hljs-attr">children</span>: [
      <span class="hljs-comment">// 主应用路由</span>
      { <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HomePage</span> },
      <span class="hljs-comment">// 微前端路由 - 动态匹配</span>
      { 
        <span class="hljs-attr">path</span>: <span class="hljs-string">'/auth/:pathMatch(.*)*'</span>,
        <span class="hljs-attr">component</span>: <span class="hljs-title class_">MicroContainer</span>,
        <span class="hljs-attr">meta</span>: { <span class="hljs-attr">microApp</span>: <span class="hljs-string">'vue3-auth'</span> }
      },
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">'/legacy/:pathMatch(.*)*'</span>,
        <span class="hljs-attr">component</span>: <span class="hljs-title class_">MicroContainer</span>,
        <span class="hljs-attr">meta</span>: { <span class="hljs-attr">microApp</span>: <span class="hljs-string">'vue2-legacy'</span> }
      }
    ]
  }
];

<span class="hljs-comment">// 导航守卫 - 微应用权限控制</span>
router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> microApp = to.<span class="hljs-property">meta</span>.<span class="hljs-property">microApp</span>;
  
  <span class="hljs-keyword">if</span> (microApp) {
    <span class="hljs-comment">// 检查微应用是否就绪</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isMicroAppLoaded</span>(microApp)) {
      <span class="hljs-title function_">loadMicroApp</span>(microApp).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">next</span>();
      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">next</span>(<span class="hljs-string">'/error/micro-app-unavailable'</span>);
      });
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 检查微应用访问权限</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">hasPermissionForMicroApp</span>(microApp)) {
      <span class="hljs-title function_">next</span>(<span class="hljs-string">'/forbidden'</span>);
      <span class="hljs-keyword">return</span>;
    }
  }
  
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<h2 data-id="heading-15">第五章：性能优化实战手册</h2>
<h3 data-id="heading-16">5.1 微应用懒加载与预加载策略</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// main-app/src/utils/preload-strategy.ts</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MicroAppPreloader</span> {
  <span class="hljs-keyword">private</span> loadedApps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;();
  <span class="hljs-keyword">private</span> <span class="hljs-attr">prefetchQueue</span>: <span class="hljs-built_in">string</span>[] = [];
  
  <span class="hljs-comment">// 基于用户行为预测的预加载</span>
  <span class="hljs-title function_">setupUserBehaviorPrediction</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 监听路由变化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title function_">afterEach</span>(<span class="hljs-function"><span class="hljs-params">to</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> nextApps = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">predictNextApps</span>(to);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">prefetch</span>(nextApps);
    });
    
    <span class="hljs-comment">// 2. 监听鼠标悬停</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseover'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> link = e.<span class="hljs-property">target</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>;
      <span class="hljs-keyword">if</span> (link.<span class="hljs-property">dataset</span>.<span class="hljs-property">microApp</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">prefetch</span>([link.<span class="hljs-property">dataset</span>.<span class="hljs-property">microApp</span>]);
      }
    }, { <span class="hljs-attr">capture</span>: <span class="hljs-literal">true</span> });
  }
  
  <span class="hljs-comment">// 智能预加载算法</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">prefetch</span>(<span class="hljs-params">appNames: <span class="hljs-built_in">string</span>[]</span>) {
    <span class="hljs-keyword">const</span> toLoad = appNames.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> 
      !<span class="hljs-variable language_">this</span>.<span class="hljs-property">loadedApps</span>.<span class="hljs-title function_">has</span>(name) &amp;&amp; 
      !<span class="hljs-variable language_">this</span>.<span class="hljs-property">prefetchQueue</span>.<span class="hljs-title function_">includes</span>(name)
    );
    
    <span class="hljs-comment">// 空闲时加载</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'requestIdleCallback'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
      <span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> app <span class="hljs-keyword">of</span> toLoad) {
          <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadAppResources</span>(app);
        }
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 降级方案：延迟加载</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        toLoad.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadAppResources</span>(app));
      }, <span class="hljs-number">1000</span>);
    }
  }
  
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">predictNextApps</span>(currentRoute): <span class="hljs-built_in">string</span>[] {
    <span class="hljs-comment">// 基于路由配置的简单预测</span>
    <span class="hljs-keyword">const</span> routeMap = {
      <span class="hljs-string">'/dashboard'</span>: [<span class="hljs-string">'vue3-auth'</span>, <span class="hljs-string">'vue3-analytics'</span>],
      <span class="hljs-string">'/user/profile'</span>: [<span class="hljs-string">'vue3-auth'</span>],
      <span class="hljs-comment">// ...更多路由映射</span>
    };
    
    <span class="hljs-keyword">return</span> routeMap[currentRoute.<span class="hljs-property">path</span>] || [];
  }
}
</code></pre>
<h3 data-id="heading-17">5.2 构建优化：Vite + qiankun的最佳实践</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// micro-app/vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">'es2015'</span>,
    <span class="hljs-attr">lib</span>: {
      <span class="hljs-attr">entry</span>: <span class="hljs-string">'src/entry.ts'</span>,
      <span class="hljs-attr">formats</span>: [<span class="hljs-string">'umd'</span>],
      <span class="hljs-attr">name</span>: <span class="hljs-string">'vue3AuthApp'</span>
    },
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">external</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>, <span class="hljs-string">'pinia'</span>],
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">globals</span>: {
          <span class="hljs-attr">vue</span>: <span class="hljs-string">'Vue'</span>,
          <span class="hljs-string">'vue-router'</span>: <span class="hljs-string">'VueRouter'</span>,
          <span class="hljs-attr">pinia</span>: <span class="hljs-string">'Pinia'</span>
        },
        <span class="hljs-comment">// 确保qiankun能正确加载</span>
        <span class="hljs-attr">entryFileNames</span>: <span class="hljs-string">'[name].js'</span>,
        <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'[name].[hash].js'</span>
      }
    }
  },
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">3001</span>,
    <span class="hljs-attr">cors</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>
    }
  }
});
</code></pre>
<h2 data-id="heading-18">第六章：生产环境部署与DevOps流水线</h2>
<h3 data-id="heading-19">6.1 微前端CI/CD架构</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/deploy-micro-apps.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">Micro</span> <span class="hljs-string">Frontends</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'micro-apps/**'</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'main-app/**'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy-micro-apps:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-attr">app:</span> [<span class="hljs-string">auth</span>, <span class="hljs-string">dashboard</span>, <span class="hljs-string">legacy</span>]
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node.js</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-string">'18'</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          cd micro-apps/${{ matrix.app }}
          npm ci
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">Micro</span> <span class="hljs-string">App</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          cd micro-apps/${{ matrix.app }}
          npm run build
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">CDN</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">aws-actions/configure-aws-credentials@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">aws-access-key-id:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.AWS_ACCESS_KEY</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">aws-secret-access-key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.AWS_SECRET_KEY</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">aws-region:</span> <span class="hljs-string">us-east-1</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          aws s3 sync ./dist s3://my-cdn/micro-apps/${{ matrix.app }}/${{ github.sha }}/
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Update</span> <span class="hljs-string">Version</span> <span class="hljs-string">Registry</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 更新微应用版本清单
          curl -X POST https://api.myapp.com/versions \
            -H "Authorization: Bearer ${{ secrets.DEPLOY_TOKEN }}" \
            -d '{"app":"${{ matrix.app }}","version":"${{ github.sha }}"}'
</span></code></pre>
<h3 data-id="heading-20">6.2 版本管理与灰度发布</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// version-manager.ts - 微应用版本控制</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VersionManager</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">versionManifest</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {};
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">versionManifest</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchManifest</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupVersionPolling</span>();
  }
  
  <span class="hljs-comment">// 获取指定应用的最佳版本</span>
  <span class="hljs-title function_">getAppVersion</span>(<span class="hljs-attr">appName</span>: <span class="hljs-built_in">string</span>, userId?: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">const</span> defaultVersion = <span class="hljs-variable language_">this</span>.<span class="hljs-property">versionManifest</span>[appName];
    
    <span class="hljs-comment">// 灰度发布逻辑</span>
    <span class="hljs-keyword">if</span> (userId &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isInGrayScale</span>(userId, appName)) {
      <span class="hljs-keyword">const</span> grayVersion = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getGrayVersion</span>(appName);
      <span class="hljs-keyword">return</span> grayVersion || defaultVersion;
    }
    
    <span class="hljs-keyword">return</span> defaultVersion;
  }
  
  <span class="hljs-comment">// 自动降级机制</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadWithFallback</span>(<span class="hljs-params">appName: <span class="hljs-built_in">string</span>, version: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadVersion</span>(appName, version);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`版本 <span class="hljs-subst">${version}</span> 加载失败，尝试回退`</span>);
      
      <span class="hljs-comment">// 尝试上一个稳定版本</span>
      <span class="hljs-keyword">const</span> stableVersion = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getStableVersion</span>(appName);
      <span class="hljs-keyword">if</span> (stableVersion !== version) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadVersion</span>(appName, stableVersion);
      }
      
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`微应用 <span class="hljs-subst">${appName}</span> 加载失败`</span>);
    }
  }
}
</code></pre>
<h2 data-id="heading-21">第七章：从Monolith到微前端——真实迁移案例</h2>
<h3 data-id="heading-22">迁移前后的量化对比</h3>
<p><strong>某电商平台Vue项目迁移数据：</strong></p>









































<table><thead><tr><th>指标</th><th>迁移前（单体）</th><th>迁移后（微前端）</th><th>改进</th></tr></thead><tbody><tr><td>构建时间</td><td>8分30秒</td><td>平均1分20秒</td><td>⬇️ 84%</td></tr><tr><td>首屏加载</td><td>3.2秒</td><td>1.8秒</td><td>⬇️ 44%</td></tr><tr><td>发布频率</td><td>每周1次</td><td>每日多次</td><td>⬆️ 500%+</td></tr><tr><td>团队独立部署率</td><td>0%</td><td>85%</td><td>⬆️ 85%</td></tr><tr><td>生产事故影响范围</td><td>全局</td><td>单个微应用</td><td>⬇️ 90%</td></tr></tbody></table>
<h3 data-id="heading-23">渐进式迁移策略示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 迁移路线图</span>
<span class="hljs-keyword">const</span> migrationRoadmap = [
  {
    <span class="hljs-attr">phase</span>: <span class="hljs-string">'准备阶段'</span>,
    <span class="hljs-attr">tasks</span>: [
      <span class="hljs-string">'搭建微前端基座'</span>,
      <span class="hljs-string">'配置构建流水线'</span>,
      <span class="hljs-string">'制定通信协议'</span>,
      <span class="hljs-string">'培训开发团队'</span>
    ],
    <span class="hljs-attr">duration</span>: <span class="hljs-string">'2周'</span>
  },
  {
    <span class="hljs-attr">phase</span>: <span class="hljs-string">'第一期迁移'</span>,
    <span class="hljs-attr">tasks</span>: [
      <span class="hljs-string">'抽离用户中心（低风险）'</span>,
      <span class="hljs-string">'独立部署认证模块'</span>,
      <span class="hljs-string">'验证技术方案可行性'</span>
    ],
    <span class="hljs-attr">duration</span>: <span class="hljs-string">'3周'</span>
  },
  {
    <span class="hljs-attr">phase</span>: <span class="hljs-string">'核心业务迁移'</span>,
    <span class="hljs-attr">tasks</span>: [
      <span class="hljs-string">'拆解商品详情页'</span>,
      <span class="hljs-string">'迁移订单流程'</span>,
      <span class="hljs-string">'实现购物车微应用'</span>
    ],
    <span class="hljs-attr">duration</span>: <span class="hljs-string">'6周'</span>
  },
  {
    <span class="hljs-attr">phase</span>: <span class="hljs-string">'收尾与优化'</span>,
    <span class="hljs-attr">tasks</span>: [
      <span class="hljs-string">'迁移剩余模块'</span>,
      <span class="hljs-string">'性能调优'</span>,
      <span class="hljs-string">'监控体系完善'</span>,
      <span class="hljs-string">'文档整理'</span>
    ],
    <span class="hljs-attr">duration</span>: <span class="hljs-string">'3周'</span>
  }
];
</code></pre>
<h2 data-id="heading-24">第八章：避坑指南与最佳实践</h2>
<h3 data-id="heading-25">8.1 常见问题与解决方案</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 🐛 问题1：微应用样式污染</span>
<span class="hljs-strong">**症状**</span>：微应用的CSS影响了其他应用
<span class="hljs-strong">**解决方案**</span>：
<span class="hljs-bullet">1.</span> 启用qiankun的experimentalStyleIsolation
<span class="hljs-bullet">2.</span> 使用CSS Modules + 命名空间前缀
<span class="hljs-bullet">3.</span> 动态样式表加载/卸载

<span class="hljs-section">## 🐛 问题2：全局变量冲突</span>
<span class="hljs-strong">**症状**</span>：多个Vue实例或Vuex store冲突
<span class="hljs-strong">**解决方案**</span>：
<span class="hljs-bullet">1.</span> 使用沙箱模式运行微应用
<span class="hljs-bullet">2.</span> 避免修改window全局对象
<span class="hljs-bullet">3.</span> 通过props传递共享依赖

<span class="hljs-section">## 🐛 问题3：路由跳转异常</span>
<span class="hljs-strong">**症状**</span>：微应用内跳转导致主应用路由混乱
<span class="hljs-strong">**解决方案**</span>：
<span class="hljs-bullet">1.</span> 统一使用主应用路由控制
<span class="hljs-bullet">2.</span> 微应用使用相对路径
<span class="hljs-bullet">3.</span> 实现路由事件代理机制

<span class="hljs-section">## 🐛 问题4：通信复杂度高</span>
<span class="hljs-strong">**症状**</span>：微应用间通信代码混乱
<span class="hljs-strong">**解决方案**</span>：
<span class="hljs-bullet">1.</span> 定义清晰的事件通信协议
<span class="hljs-bullet">2.</span> 使用状态管理库（Pinia）作为中心化store
<span class="hljs-bullet">3.</span> 限制直接通信，通过主应用中转
</code></pre>
<h3 data-id="heading-26">8.2 Vue微前端黄金法则</h3>
<ol>
<li><strong>单一职责原则</strong>：每个微应用只负责一个业务领域</li>
<li><strong>技术栈自由但有限制</strong>：允许异构，但要制定标准</li>
<li><strong>独立可部署</strong>：每个微应用都能独立运行和测试</li>
<li><strong>向后兼容</strong>：确保API和通信协议向后兼容</li>
<li><strong>监控全覆盖</strong>：每个微应用都需要独立的监控和日志</li>
</ol>
<h2 data-id="heading-27">结语：微前端不是银弹，而是架构演进的必经之路</h2>
<p>微前端并不是要取代Vue的单页面应用架构，而是为其提供一种可扩展的解决方案。当你的Vue应用从“小别墅”成长为“摩天大楼”时，微前端提供了必要的结构支撑。</p>
<p>记住，技术选型的核心不是追求最新最酷，而是找到最适合团队和业务场景的平衡点。微前端带来的不仅是技术上的解耦，更是组织架构和开发流程的优化。</p>
<p><strong>Vue 3 + qiankun的微前端方案，已经证明是生产可行的。现在，是时候将你的大型Vue应用带入微前端时代了。</strong></p>
<hr/>
<p><strong>资源推荐</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fqiankun.umijs.org%2F" target="_blank" title="https://qiankun.umijs.org/" ref="nofollow noopener noreferrer">qiankun官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvue-microfrontends" target="_blank" title="https://github.com/vue-microfrontends" ref="nofollow noopener noreferrer">Vue 3微前端实战代码库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodule-federation.io%2F" target="_blank" title="https://module-federation.io/" ref="nofollow noopener noreferrer">Module Federation with Vue</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmicro-frontends.org%2F" target="_blank" title="https://micro-frontends.org/" ref="nofollow noopener noreferrer">微前端设计模式</a></li>
</ul>
<p><em>本文首发于掘金技术社区，转载请注明出处。如果你在Vue微前端实践中遇到问题，欢迎在评论区交流讨论。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误]]></title>    <link>https://juejin.cn/post/7586901995429871625</link>    <guid>https://juejin.cn/post/7586901995429871625</guid>    <pubDate>2025-12-24T00:57:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586901995429871625" data-draft-id="7586703355646492699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误"/> <meta itemprop="keywords" content="MySQL,后端,SQL"/> <meta itemprop="datePublished" content="2025-12-24T00:57:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青石路"/> <meta itemprop="url" content="https://juejin.cn/user/1999357021005580"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1999357021005580/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青石路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T00:57:04.000Z" title="Wed Dec 24 2025 00:57:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开心一刻</h2>
<p>一天，老婆笑容满面的冲到我面前<br/>
老婆：你娶我到底是图我啥<br/>
我：便宜<br/>
老婆笑容瞬间消失，气呼呼的道：你会不会说话？<br/>
并且强调：我爸当年那是可怜你，没跟你多要<br/>
我：不是，你爸不是这么说的<br/>
老婆：那怎么说的<br/>
我开始学着老丈人的口吻：不许退，给你便宜点<br/></p>
<div align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/145c7b4e26194e5e81243a259cb88af9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142624&amp;x-signature=XbcCvm3PTHFLzDz7MaVUbMmh9IY%3D" alt="开心一刻" loading="lazy"/></div>
<h2 data-id="heading-1">INSERT ON DUPLICATE KEY UPDATE</h2>
<p>关于 <code>INSERT ... ON DUPLICATE KEY UPDATE</code>，相信大家都有所了解，是 <code>MySQL</code> 针对</p>
<blockquote>
<p>不存在则插入，存在则更新</p>
</blockquote>
<p>的一种方言实现；<code>存不存在</code> 该如何判定呢，基于表的 <code>唯一索引</code> 或 <code>主键</code></p>
<p>举个例子，如果列 <code>a</code> 被声明为 <code>唯一</code> 且表中已经存在 <code>a=1</code> 的记录，则以下两条语句具有类似的效果</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t1 (a,b,c) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
  <span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> c<span class="hljs-operator">=</span>c<span class="hljs-operator">+</span><span class="hljs-number">1</span>;

<span class="hljs-keyword">UPDATE</span> t1 <span class="hljs-keyword">SET</span> c<span class="hljs-operator">=</span>c<span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> a<span class="hljs-operator">=</span><span class="hljs-number">1</span>;
</code></pre>
<p>假设我们有表</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tbl_insert_on_update` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `uk_column1` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `uk_column2` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `remark` text,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `name` (`name`)
) ENGINE<span class="hljs-operator">=</span>InnoDB
</code></pre>
<p>一开始表中没有数据，那么</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'狂风一样的男子'</span>;
</code></pre>
<p>的作用，相信大家都知道，与</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>);
</code></pre>
<p>作用一样，会往表中插入一条新的记录；如果再执行一次</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'狂风一样的男子'</span>;
</code></pre>
<p>呢，会是怎么样的结果？相信大家都知道</p>
<div align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a67391724fdd49c49a4b8c777679d035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142624&amp;x-signature=und9tkxAabtRGe70a0t6Ow2CfWo%3D" alt="insert_on_update_再执行一次" loading="lazy"/></div>
<p>与</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UPDATE</span> tbl_insert_on_update <span class="hljs-keyword">SET</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'狂风一样的男子'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p>的效果一样。我们接着做个简单调整，拿掉 <code>name</code></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>或者拿掉 <code>id</code></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>会是怎么样的一个结果，你们可以大胆猜一下。这两个 SQL 的执行结果是一样的</p>
<div align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcc56051e4c24b888d7ccb70fed7bba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142624&amp;x-signature=W%2BDJ5QTi1N%2BUfCrqrtRoX2vn0ik%3D" alt="男三浩" loading="lazy"/></div>
<p>此时你们是不是有疑问呢</p>
<blockquote>
<p>为什么拿掉 <code>name</code> 和拿掉 <code>id</code> 的 INSERT ... ON DUPLICATE KEY UPDATE 的执行结果会是一样的？</p>
</blockquote>
<p>这个问题先放一放，我们先录入女一号的数据</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'婉儿'</span>, <span class="hljs-string">'20050101001X'</span>, <span class="hljs-string">'女一号'</span>, <span class="hljs-string">'花一样的女子'</span>);
</code></pre>
<p>假设我们要修改女一号的信息，包括 <code>姓名</code>，是不是可以这么实现</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'婉儿'</span>, <span class="hljs-string">'20050101001X'</span>, <span class="hljs-string">'女一号'</span>, <span class="hljs-string">'花一样的女子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span>, name<span class="hljs-operator">=</span><span class="hljs-string">'张三'</span>, uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101002X'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'女二号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'牵牛花一样的女子'</span>;
</code></pre>
<p>有什么问题吗，执行下就知道了嘛</p>
<div align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80d7289949da4d01b4e54029844f72f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2S55-z6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767142624&amp;x-signature=%2BaD5b68%2Fb3%2FAFjXpF2yQROcxhfU%3D" alt="唯一索引冲突" width="90%" loading="lazy"/></div>
<p>执行报错了，提示</p>
<blockquote>
<p>1062 - Duplicate entry '张三' for key 'tbl_insert_on_update.name'</p>
</blockquote>
<p>这个错误信息我们是不是很熟悉？不就是唯一索引冲突吗？那么问题又来了</p>
<blockquote>
<p>用了MySQL的INSERT ON DUPLICATE KEY UPDATE，为什么还会唯一索引冲突？</p>
</blockquote>
<h2 data-id="heading-2">如何判断是否存在</h2>
<p>我们写 <code>INSERT ... ON DUPLICATE KEY UPDATE</code> 语句时，并未指定用哪个 <code>主键</code> 或者 <code>唯一索引</code> 来判定记录是否存在</p>
<blockquote>
<p>Oracle、SQL Server、PostgreSQL 的 <code>MERGE</code> 有类似作用</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">MERGE</span> <span class="hljs-keyword">INTO</span> TBL_INSERT_ON_UPDATE t
<span class="hljs-keyword">USING</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> ID, <span class="hljs-string">'张三'</span> <span class="hljs-keyword">AS</span> NAME, <span class="hljs-string">'20050101001'</span> <span class="hljs-keyword">AS</span> UK_COLUMN1, <span class="hljs-string">'男一号'</span> <span class="hljs-keyword">AS</span> UK_COLUMN2, <span class="hljs-string">'风一样的男子'</span> <span class="hljs-keyword">AS</span> REMARK <span class="hljs-keyword">FROM</span> dual
) s
<span class="hljs-keyword">ON</span> (t.NAME <span class="hljs-operator">=</span> s.NAME)  <span class="hljs-comment">-- 基于 NAME 字段匹配</span>
<span class="hljs-keyword">WHEN</span> MATCHED <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">SET</span>
        t.ID <span class="hljs-operator">=</span> s.ID,
        t.UK_COLUMN1 <span class="hljs-operator">=</span> s.UK_COLUMN1,
        t.UK_COLUMN2 <span class="hljs-operator">=</span> s.UK_COLUMN2,
        t.REMARK <span class="hljs-operator">=</span> s.REMARK
<span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">NOT</span> MATCHED <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">INSERT</span> (ID, NAME, UK_COLUMN1, UK_COLUMN2, REMARK)
    <span class="hljs-keyword">VALUES</span> (s.ID, s.NAME, s.UK_COLUMN1, s.UK_COLUMN2, s.REMARK);
</code></pre>
<p>其中的 <code>ON</code>  明确指定匹配字段（根据哪些字段判断记录是否存在），一般是指定 <code>主键</code>字段或 <code>唯一索引</code>字段</p>
</blockquote>
<p>那 MySQL 是如何判定记录是否存在的呢？我们可以翻阅下官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Finsert-on-duplicate.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/insert-on-duplicate.html" ref="nofollow noopener noreferrer">INSERT ... ON DUPLICATE KEY UPDATE Statement</a>。一开头有如下一段描述</p>
<blockquote>
<p>If you specify an <code>ON DUPLICATE KEY UPDATE</code> clause and a row to be inserted would cause a duplicate value in a <code>UNIQUE</code> index or <code>PRIMARY KEY</code>, an <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Fupdate.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/update.html" ref="nofollow noopener noreferrer"><code>UPDATE</code></a> of the old row occurs</p>
<p>当我们使用 <code>ON DUPLICATE KEY UPDATE</code>  子句时，插入的行导致 <code>唯一</code> 索引或者 <code>主键</code> 重复时，会更新旧的行</p>
</blockquote>
<p>通过这段话，我们只知道 MySQL 是根据唯一索引或主键来判定行是否存在，并不知道</p>
<ol>
<li>先根据主键判定，不冲突之后再根据唯一索引判定？</li>
<li>有多个唯一索引时，这些唯一索引的判定优先级是怎样的？</li>
</ol>
<p>官方文档里面并未明确说明这些问题，只是在结尾进行了如下说明</p>
<blockquote>
<p>An <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Finsert-on-duplicate.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/insert-on-duplicate.html" ref="nofollow noopener noreferrer"><code>INSERT ... ON DUPLICATE KEY UPDATE</code></a> statement against a table having more than one unique or primary key is also marked as unsafe. (Bug #11765650, Bug #58637)</p>
<p>当表中有多个唯一索引或者主键时，INSERT ... ON DUPLICATE KEY UPDATE 语句不安全</p>
</blockquote>
<p>不安全代表执行结果不固定，会出现我们预期之外的结果</p>
<h2 data-id="heading-3">工作原理</h2>
<p>如果让你们来实现 <code>不存在则插入，存在则更新</code>，你们会怎么实现？</p>
<p>逐个查询主键以及所有唯一索引，判断该行数据是否存在，一旦存在则根据重复的主键或者唯一索引进行 <code>UPDATE</code>，都不存在则进行 <code>INSERT</code>；这不仅是你们最容易想到的实现方式，也是我最容易想到的方式。</p>
<p>但 MySQL 并未采用这种方式，而是采用了另外一种更高效的方式，先尝试插入，存储引擎会向<strong>所有相关的唯一索引（包括主键）</strong> 中插入对应的索引条目，如果都插入成功，说明数据行不存在，那么 <code>INSERT</code> 数据行；一旦存储引擎尝试插入某个唯一索引时，发现该数据行已经存在，会立即停止插入动作，并向MySQL服务层抛出 <code>重复键</code> 错误，服务层收到重复键错误后，并不会让整个语句失败（因为使用了 ON DUPLICATE KEY UPDATE 子句），而是转换执行模式，会先回滚之前的插入，然后根据重复的那个唯一索引找到数据行对应的 <code>旧行</code> 数据，最后 <code>UPDATE</code> 数据行；总结下来分三步</p>
<ol>
<li>
<p>尝试插入</p>
<p>所有唯一索引（包括主键）都插入成功，则插入数据行，相当于完成普通的 <code>INSERT</code></p>
<p>一旦某个唯一索引插入失败，则立即停止插入，存储引擎会向上层抛出一个 <code>重复键</code> 错误</p>
</li>
<li>
<p>模式转换</p>
<p>MySQL服务器收到重复键后，发现执行语句中有 <code>ON DUPLICATE KEY UPDATE</code> 子句，不会直接让整个语句失败，而是先回滚之前的那部分唯一索引的插入，然后根据插入失败的唯一索引找到已经存在的 <code>旧行</code></p>
</li>
<li>
<p>执行更新</p>
<p>根据插入失败的唯一索引，对旧行执行更新操作，相当于完成普通的 <code>UPDATE</code></p>
</li>
</ol>
<p>整个 <code>尝试-失败-转换-更新</code> 过程时一个原子操作，那么完全成功，要么完全失败；相比于 <code>先查询后判断</code> 的传统实现，这种实现方式效率更高。</p>
<h2 data-id="heading-4">问题答疑</h2>
<p>前面涉及到两个问题，现在我们来解惑下</p>
<ol>
<li>
<p>为什么拿掉 <code>name</code> 和拿掉 <code>id</code> 的 INSERT ... ON DUPLICATE KEY UPDATE 的执行结果会是一样的？</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 拿掉name</span>
<span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;

<span class="hljs-comment">-- 拿掉id</span>
<span class="hljs-keyword">INSERT</span> tbl_insert_on_update(name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>这个问题是不是很简单，我们一起来分析下</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(id, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>INSERT 的字段中没有 <code>name</code>，但有 <code>id</code>，可想而知判断数据行是否存在，用到的是 <code>主键</code>，因为 <code>id=1</code> 的记录已经存在，所以根据 id 去更新其他字段值；那么执行结果与如下 SQL 一致</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UPDATE</span> tbl_insert_on_update <span class="hljs-keyword">SET</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p>同理</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> tbl_insert_on_update(name, uk_column1, uk_column2, remark)
<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'20050101001'</span>, <span class="hljs-string">'男一号'</span>, <span class="hljs-string">'风一样的男子'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span>;
</code></pre>
<p>INSERT 的字段中没有 <code>id</code>，但有 <code>name</code>，可想而知判断数据行是否存在，用到的是 <code>唯一索引</code>，因为 <code>name=张三</code> 的记录已经存在，所以根据 name 去更新其他字段值；那么执行结果与如下 SQL 一致</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UPDATE</span> tbl_insert_on_update <span class="hljs-keyword">SET</span> uk_column1<span class="hljs-operator">=</span><span class="hljs-string">'20050101003'</span>, uk_column2<span class="hljs-operator">=</span><span class="hljs-string">'男三号'</span>, remark<span class="hljs-operator">=</span><span class="hljs-string">'暴风一样的男子'</span> <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'张三'</span>;
</code></pre>
<p><code>id = 1</code> 与 <code>name = '张三'</code> 指向的本来就是同一行数据，更新的列与列值都一致，那么执行结果自然就一样了</p>
</li>
<li>
<p>存在多个唯一索引（包含主键）时，判断数据行是否存在，这些唯一索引的优先级顺序是怎样的？</p>
<p>MySQL 官方文档并未明确说明这个优先级顺序，但在 MySQL 的实现中肯定有这个优先级顺序的实现算法，可能跟版本、存储引擎有关</p>
<p>基于 <code>8.0.31</code> 版本，简单测试出以下优先级</p>
<blockquote>
<p>主键 &gt; 唯一索引</p>
<p>唯一索引之间按创建顺序，先创建的优先级高</p>
</blockquote>
<p>官方文档已经明确说明：当表中有多个唯一索引或者主键时，INSERT ... ON DUPLICATE KEY UPDATE 语句不安全，所以如上的测试结果并不具备确定性，不能作为使用准则</p>
</li>
<li>
<p>用了MySQL的INSERT ON DUPLICATE KEY UPDATE，怎么还报唯一索引冲突错误</p>
<p>MySQL是基于尝试插入的第一个冲突的唯一索引来执行更新的，更新的字段完全有可能触发其他唯一索引（包括主键）冲突</p>
<p>这个问题根本不成立！</p>
</li>
</ol>
<h2 data-id="heading-5">总结</h2>
<ol>
<li>
<p>不管是 MySQL，还是 Oracle、SQL Server、PostgreSQL，针对 <code>不存在则插入，存在则更新</code> 判断数据是否存在的逻辑都是一样的，只是 MySQL 不需要显示指定 <code>判存</code> 的唯一索引（包括主键），由 MySQL 引擎内部自动实现</p>
</li>
<li>
<p>关于判断数据行是否存在，多个唯一索引的优先级，看似能测出 MySQL 中的优先级，但并不具备确定性，不能作为使用准则</p>
<p>类似不确定的排序问题还有：<a href="https://juejin.cn/post/7290017749715632168" target="_blank" title="https://juejin.cn/post/7290017749715632168">我试图扯掉这条 SQL 的底裤</a></p>
</li>
<li>
<p>INSERT ... ON DUPLICATE KEY UPDATE 使用过程中有一些需要注意的点，需要结合自己的业务来分析是否可以忽略这些点</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fyouzhibing%2Fp%2F15248758.html" target="_blank" title="https://www.cnblogs.com/youzhibing/p/15248758.html" ref="nofollow noopener noreferrer">记录不存在则插入，存在则更新 → MySQL 的实现方式有哪些？</a></p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给前端明星开源项目Biome提 PR，被 Snapshot 测试坑了一把]]></title>    <link>https://juejin.cn/post/7586983243925782566</link>    <guid>https://juejin.cn/post/7586983243925782566</guid>    <pubDate>2025-12-24T05:27:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586983243925782566" data-draft-id="7586983243925766182" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给前端明星开源项目Biome提 PR，被 Snapshot 测试坑了一把"/> <meta itemprop="keywords" content="前端,后端,测试"/> <meta itemprop="datePublished" content="2025-12-24T05:27:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给前端明星开源项目Biome提 PR，被 Snapshot 测试坑了一把
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:27:55.000Z" title="Wed Dec 24 2025 05:27:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Snapshot 测试：从一次 CI 失败说起</h2>
<p>最近给 Biome 提了个 PR，改了几个文件，本地测试跑过了，push 上去，CI 挂了。</p>
<p>报错信息是这样的：</p>
<pre><code class="hljs language-arduino" lang="arduino">---- specs::nursery::no_undeclared_env_vars::invalid_js stdout ----
thread <span class="hljs-string">'specs::nursery::no_undeclared_env_vars::invalid_js'</span> panicked at
crates/biome_js_analyze/tests/spec_tests.rs:<span class="hljs-number">19</span>:<span class="hljs-number">5</span>:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot file: crates/biome_js_analyze/tests/specs/nursery/noUndeclaredEnvVars/invalid.js.snap
Snapshot: invalid_js
Source: crates/biome_js_analyze/tests/spec_tests.rs:<span class="hljs-number">19</span>

-old snapshot
+<span class="hljs-keyword">new</span> results
────────────────────────────────────────────────────────────────────────────────
</code></pre>
<p>一脸懵。我改的是 <code>--stdin-file-path</code> 的逻辑，跟 <code>noUndeclaredEnvVars</code> 这个 lint 规则有什么关系？</p>
<p>后来搞明白了：我的分支落后于 main，rebase 之后把上游的改动合进来了。上游给这个规则加了一行提示信息，但快照文件还是旧的，所以测试失败。</p>
<p>这就是 snapshot 测试。</p>
<h3 data-id="heading-1">什么是 snapshot 测试</h3>
<p>Snapshot，直译就是"快照"。生活中的快照是某个时刻的照片，代码里的 snapshot 是某个时刻程序输出的"照片"。</p>
<p>传统测试是这样写的：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 你得手动写出期望的输出</span>
<span class="hljs-built_in">assert_eq!</span>(<span class="hljs-title function_ invoke__">format</span>(<span class="hljs-string">"let x=1"</span>), <span class="hljs-string">"let x = 1;\n"</span>);
</code></pre>
<p>Snapshot 测试换了个思路：<strong>你不用写期望值，让程序自己记录。</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">第一次跑测试：
  输入 → 程序 → 输出 → 自动保存成 .snap 文件（这就是<span class="hljs-string">"快照"</span>）

后续跑测试：
  输入 → 程序 → 输出 → 跟 .snap 文件比对
                         │
                         ├── 一样 → 通过
                         └── 不一样 → 失败，显示 diff
</code></pre>
<p>第一次运行时，测试框架会问你："这个输出对吗？"你确认后，它就把输出存成 <code>.snap</code> 文件。之后每次运行，都拿新输出跟这个文件比。</p>
<p><strong>为什么叫"快照"？</strong></p>
<p>因为它记录的是某个时间点的状态。就像你给代码的输出拍了张照片，以后每次都拿新输出跟照片对比，看有没有变化。</p>
<p><strong>Snapshot 文件存什么？</strong></p>
<p>就是纯文本，记录程序的输出。比如格式化工具的 snapshot 存的是格式化后的代码，CLI 工具的 snapshot 存的是命令行输出，React 组件的 snapshot 存的是渲染出来的 DOM 结构。</p>
<p>我遇到的情况就是：上游改了规则的输出（多了一行 "This rule belongs to the nursery group"），但 <code>.snap</code> 文件还是旧的，新输出跟旧快照不一样，所以测试失败。</p>
<h3 data-id="heading-2">怎么修</h3>
<p>Biome 用的是 Rust 生态的 <code>insta</code> 库做 snapshot 测试。修起来很简单：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先本地跑一遍测试，确认是 snapshot 的问题</span>
cargo <span class="hljs-built_in">test</span>

<span class="hljs-comment"># 接受新的 snapshot</span>
cargo insta accept

<span class="hljs-comment"># 或者用交互模式，逐个确认</span>
cargo insta review
</code></pre>
<p>跑完 <code>cargo insta accept</code>，它会自动更新 <code>.snap</code> 文件。commit 进去，push，CI 就过了。</p>
<h3 data-id="heading-3">快照文件长什么样</h3>
<p>看一眼 Biome 里的快照文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">source:</span> <span class="hljs-string">crates/biome_cli/tests/snap_test.rs</span>
<span class="hljs-attr">expression:</span> <span class="hljs-string">content</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment">## `biome.json`</span>

<span class="hljs-string">```json</span>
{ <span class="hljs-attr">"files":</span> { <span class="hljs-attr">"includes":</span> [<span class="hljs-string">"apps/**"</span>] } }
</code></pre>
<h2 data-id="heading-4">Emitted Messages</h2>
<pre><code class="hljs language-block" lang="block">function f() {
	return {};
}
</code></pre>
<pre><code class="hljs language-csharp" lang="csharp">
就是把测试的输入（配置文件）和输出（格式化结果）都记下来。下次跑测试，输出变了就能发现。

<span class="hljs-meta">## 为什么 Biome 要用 snapshot 测试</span>

先想一个问题：Biome 是做什么的？

代码格式化和 lint。输入一段代码，输出格式化后的代码，或者输出一堆 lint 警告。

这类工具有个特点：**输出又长又复杂，而且经常变。**

比如格式化 `<span class="hljs-function">function <span class="hljs-title">f</span>()</span>{<span class="hljs-keyword">return</span>{}}` 这段代码，输出是：

```<span class="hljs-function">javascript
function <span class="hljs-title">f</span>()</span> {
	<span class="hljs-keyword">return</span> {};
}
</code></pre>
<p>如果用传统测试，你得这样写：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-built_in">assert_eq!</span>(
    <span class="hljs-title function_ invoke__">format_code</span>(<span class="hljs-string">"function f(){return{}}"</span>),
    <span class="hljs-string">"function f() {\n\treturn {};\n}\n"</span>
);
</code></pre>
<p>问题来了：</p>
<ol>
<li><strong>输出太长</strong>：这还是最简单的例子，真实场景可能是几十上百行代码</li>
<li><strong>转义字符地狱</strong>：<code>\n</code>、<code>\t</code> 一多，根本没法读</li>
<li><strong>改动频繁</strong>：格式化规则经常调整，比如"函数前要不要空行"，一改就得手动更新几百个测试</li>
</ol>
<p>Biome 有几千个测试用例，如果每个都手写期望值，维护成本太高了。</p>
<p>Snapshot 测试解决了这个问题：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 不用写期望值，框架自动存</span>
assert_snapshot!(<span class="hljs-title function_ invoke__">format_code</span>(<span class="hljs-string">"function f(){return{}}"</span>));
</code></pre>
<p>输出自动存到 <code>.snap</code> 文件里，下次运行自动比对。改了格式化规则？跑一遍 <code>cargo insta accept</code>，几千个快照一起更新。</p>
<h3 data-id="heading-5">哪些项目在用</h3>
<p>不只是 Biome，很多知名项目都重度依赖 snapshot 测试：</p>













































<table><thead><tr><th>项目</th><th>类型</th><th>为什么用 snapshot</th></tr></thead><tbody><tr><td><strong>Prettier</strong></td><td>代码格式化</td><td>输出是格式化后的代码，手写太累</td></tr><tr><td><strong>Babel</strong></td><td>JS 编译器</td><td>输出是转换后的代码</td></tr><tr><td><strong>TypeScript</strong></td><td>类型检查</td><td>错误信息、类型推断结果</td></tr><tr><td><strong>Rome/Biome</strong></td><td>格式化+Lint</td><td>格式化结果、诊断信息</td></tr><tr><td><strong>Jest</strong></td><td>测试框架</td><td>React 组件渲染结果</td></tr><tr><td><strong>Rust Analyzer</strong></td><td>IDE 支持</td><td>代码补全、悬停提示</td></tr><tr><td><strong>SWC</strong></td><td>JS/TS 编译器</td><td>AST、转换结果</td></tr></tbody></table>
<p>这些项目有个共同点：<strong>输出是结构化的文本，而且量大</strong>。</p>
<p>用 snapshot 测试的好处：</p>
<ol>
<li><strong>防止回归</strong>：改了一行代码，所有相关输出的变化都能看到</li>
<li><strong>代码审查友好</strong>：PR 里能直接看到输出变化的 diff</li>
<li><strong>文档作用</strong>：快照文件本身就是"这个输入应该产生什么输出"的文档</li>
<li><strong>维护成本低</strong>：输出变了，一条命令更新，不用手动改几百个测试</li>
</ol>
<h3 data-id="heading-6">一个真实的例子</h3>
<p>我这次改的 PR 加了一个测试用例，测试 stdin 输入能不能正常格式化。</p>
<p>测试代码很简单：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[test]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">format_stdin_formats_virtual_path_outside_includes</span>() {
    <span class="hljs-comment">// 准备输入</span>
    console.in_buffer.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">"function f() {return{}}"</span>.<span class="hljs-title function_ invoke__">to_string</span>());

    <span class="hljs-comment">// 运行格式化</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = <span class="hljs-title function_ invoke__">run_cli</span>(
        Args::<span class="hljs-title function_ invoke__">from</span>([<span class="hljs-string">"format"</span>, <span class="hljs-string">"--stdin-file-path"</span>, <span class="hljs-string">"mock.js"</span>]),
    );

    <span class="hljs-comment">// 快照测试</span>
    assert_cli_snapshot!(...);
}
</code></pre>
<p>生成的快照文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">source:</span> <span class="hljs-string">crates/biome_cli/tests/snap_test.rs</span>
<span class="hljs-attr">expression:</span> <span class="hljs-string">content</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment">## `biome.json`</span>

{ <span class="hljs-attr">"files":</span> { <span class="hljs-attr">"includes":</span> [<span class="hljs-string">"apps/**"</span>] } }

<span class="hljs-comment"># Emitted Messages</span>

<span class="hljs-string">function</span> <span class="hljs-string">f()</span> {
	<span class="hljs-string">return</span> {}<span class="hljs-string">;</span>
}
</code></pre>
<p>以后如果有人改了格式化逻辑，导致输出变了，测试就会失败，提醒你检查这个变化是不是预期的。</p>
<h3 data-id="heading-7">什么时候用</h3>
<p>适合的场景：</p>

























<table><thead><tr><th>场景</th><th>例子</th></tr></thead><tbody><tr><td>CLI 工具</td><td>帮助信息、错误消息、格式化输出</td></tr><tr><td>编译器/格式化器</td><td>代码转换结果、AST 输出</td></tr><tr><td>UI 组件</td><td>React/Vue 组件的渲染结果</td></tr><tr><td>序列化</td><td>JSON、YAML 的输出</td></tr></tbody></table>
<p>不太适合的场景：</p>
<ul>
<li>简单断言（<code>1 + 1 == 2</code>）</li>
<li>随机/时间相关的输出</li>
<li>业务逻辑验证（snapshot 只能告诉你"变了"，不能告诉你"对不对"）</li>
</ul>
<h3 data-id="heading-8">容易踩的坑</h3>
<p><strong>1. 无脑 accept</strong></p>
<p>测试挂了，看都不看直接 <code>cargo insta accept</code>。这样 snapshot 测试就失去意义了——万一是真的 bug 呢？</p>
<p>我这次的情况比较明确，是 rebase 带进来的改动，所以直接 accept 没问题。但平时还是要看一眼 diff。</p>
<p><strong>2. 忘了提交快照文件</strong></p>
<p>本地跑测试没问题，CI 挂了。因为 <code>.snap</code> 文件没 commit。</p>
<p><strong>3. 快照太大</strong></p>
<p>有些项目喜欢把整个页面的渲染结果存成快照，几千行。每次 review 都是折磨，最后大家都无脑 accept 了。</p>
<p>建议拆小一点，每个快照保持在几十行内。</p>
<h3 data-id="heading-9">JavaScript 生态</h3>
<p>JS 这边常用的是 Jest 的 snapshot 功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">test</span>(<span class="hljs-string">'Button 渲染正确'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> tree = renderer.<span class="hljs-title function_">create</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"点击"</span> /&gt;</span></span>).<span class="hljs-title function_">toJSON</span>();
  <span class="hljs-title function_">expect</span>(tree).<span class="hljs-title function_">toMatchSnapshot</span>();
});
</code></pre>
<p>更新快照：</p>
<pre><code class="hljs language-bash" lang="bash">jest --updateSnapshot
<span class="hljs-comment"># 或者</span>
jest -u
</code></pre>
<p>原理一样，就是 API 不同。</p>
<h3 data-id="heading-10">小结</h3>
<p>Snapshot 测试本质上是把"写期望值"这件事自动化了。对于输出复杂的场景（CLI、格式化器、UI 组件），能省不少事。</p>
<p>但记住：更新快照前要看一眼 diff，确认变化是你想要的。不然就跟我一样，rebase 完无脑 push，CI 一样会挂。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型LLM入门篇：小白入门一文快速了解大模型（附教程）]]></title>    <link>https://juejin.cn/post/7586957587077103666</link>    <guid>https://juejin.cn/post/7586957587077103666</guid>    <pubDate>2025-12-24T06:03:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586957587077103666" data-draft-id="7586957587077038130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型LLM入门篇：小白入门一文快速了解大模型（附教程）"/> <meta itemprop="keywords" content="LLM,Agent,LangChain"/> <meta itemprop="datePublished" content="2025-12-24T06:03:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型LLM入门篇：小白入门一文快速了解大模型（附教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:03:21.000Z" title="Wed Dec 24 2025 06:03:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>大模型席卷全球，彷佛得模型者得天下。对于IT行业来说，以后可能没有各种软件了，只有各种各样的智体（Agent）调用各种各样的API。在这种大势下，笔者也阅读了很多大模型相关的资料，和很多新手一样，开始脑子里都是一团乱麻，随着相关文章越读越多，再进行内容梳理，终于理清了一条清晰的脉络。</p>
<p>笔者希望通过三篇文章总结（入门篇、原理篇和应用篇）将思路写下来，以便跟我一样的新手读者快速了解大模型的方方面面。在这里，笔者先强调一下，本系列文章的深度有限，只是个人对大模型知识脉络的梳理，同时也会借鉴一下同行的博客内容充实本文，文末将会注明参考来源。</p>
<p>在开始阅读文章之前，有几个问题读者可以先思考一下：</p>
<ul>
<li>什么是大模型？</li>
<li>大模型最终要解决的问题是什么？</li>
</ul>
<h4 data-id="heading-0"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FDEVELOPERAA%2Farticle%2Fdetails%2F146979848%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522b89c918c549e0aaad7cb340126a05c42%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fblog.%252522%25257D%26request_id%3Db89c918c549e0aaad7cb340126a05c42%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase%26utm_term%3D%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258B%25E5%25AD%25A6%25E4%25B9%25A0%25E8%25B7%25AF%25E7%25BA%25BF%26spm%3D1018.2226.3001.4450" target="_blank" title="https://blog.csdn.net/DEVELOPERAA/article/details/146979848?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522b89c918c549e0aaad7cb340126a05c42%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=b89c918c549e0aaad7cb340126a05c42&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase&amp;utm_term=%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF&amp;spm=1018.2226.3001.4450" ref="nofollow noopener noreferrer"/>大模型LLM与人工智能AI</h4>
<p>提到大模型（全名，大语言模型，LLM，Large Language Model），绕不开人工智能（AI，Artificial Intelligence）这个概念。</p>
<p>目前业界对于AI的定义有很多，但有一个令我印象深刻的说法：<strong>让机器像人一样阅读、写作和交流</strong>。通过最近几年AGI的高速发展，AI不仅仅能写作了，还能进行各种各样的创作了。所以，笔者认为这个说明可以进一步完善：<strong>人工智能就是要让机器像人一样阅读、创作和交流</strong>。</p>
<ul>
<li>阅读：机器能够像人一样接收各种各样的输入，并能够理解这些输入；</li>
<li>创作：机器能够像人一样进行创作输出，不仅仅只是写作，还包括：绘画、视频创作等等；</li>
<li>交流：在上述理解输入和创作输出的基础上，就自然而然可以实现机器像人一样交流，并且在创作输出能力上，可能比自然人更加优势。</li>
</ul>
<p>要实现上述描述的人工智能，首先就需要让机器理解人类的输入，人类的输入方式比较多，语言和文字首当其冲。要让机器理解语言和文字，就需要进行语言建模，语言建模的输出就是语言模型LM（Language Model）。</p>
<p>机器通过分析学习大量人类语言和文字，最终获得一个语言模型。通过该模型，机器好像<strong>听懂</strong>了用户输入一样，对用户的输入进行对应的输出。而用户通过得到的机器输出，也感觉机器<strong>理解</strong>了自己的意思。<strong>但实际这里的听懂和理解都是机器的运算。</strong></p>
<p>那么，这么厉害的模型是怎么来的呢？</p>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FDEVELOPERAA%2Farticle%2Fdetails%2F146979848%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522b89c918c549e0aaad7cb340126a05c42%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fblog.%252522%25257D%26request_id%3Db89c918c549e0aaad7cb340126a05c42%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase%26utm_term%3D%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258B%25E5%25AD%25A6%25E4%25B9%25A0%25E8%25B7%25AF%25E7%25BA%25BF%26spm%3D1018.2226.3001.4450" target="_blank" title="https://blog.csdn.net/DEVELOPERAA/article/details/146979848?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522b89c918c549e0aaad7cb340126a05c42%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=b89c918c549e0aaad7cb340126a05c42&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase&amp;utm_term=%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF&amp;spm=1018.2226.3001.4450" ref="nofollow noopener noreferrer"/>大模型LLM的发展与定义</h4>
<p>和很多有故事的人的名字一样，大模型一开始并不叫大模型。</p>
<p>大模型的发展经历了4个阶段：</p>
<ul>
<li>统计语言模型 SLM，Statistical Language Model，统计语言模型，基于统计学习方法开发，其基本思想是基于马尔可夫假设建立词预测模型。这种模型常见于我们的全文检索和推荐系统中，通过统计词频等信息来做统计预测，这种模型通常受到维数灾难的困扰。</li>
<li>神经语言模型 NLM，Neutral Language Model，通过神经网络，如循环神经网络（RNN），来描述单词序列的概率。该模型引入了词的分布式表示这一概念，并在聚合上下文特征（即分布式词向量）的条件下构建词预测函数。word2vec提出了构建简化的浅层神经网络来学习分布式单词表示的方法，这些表示在各种NLP任务中被证明非常有效。</li>
<li>预训练语言模型 PLM，Pre-training Language Model，基于自注意力机制的高度并行化Transformer架构，在大规模无标签语料库上使用专门设计的预训练任务。该模型确立了“预训练和微调”学习范式。在这个范式下，通常需要对PLM进行微调以适配不同的下游任务。</li>
<li>大语言模型 LLM，Large Language Model。研究人员发现，扩展PLM（扩展模型大小或数据大小）通常会提高下游任务的模型性能，许多研究通过训练越来越大的PLM来探索性能极限。随后发现，当模型参数达到某一极限之后，模型在解决一系列复杂任务中展示了惊人的能力，这种能力被称为【<strong>涌现能力</strong>】。 关于涌现能力，业界目前还有很多问题待研究解决。比如：模型参数具体达到多少涌现能力会出现？大模型为什么会突然出现涌现能力等。</li>
</ul>
<p>通过大模型的发展阶段描述，本节最后总结一下大模型LLM的定义。 <strong>大模型是一种采用Transformer架构，模型参数达到百亿或千亿级的预训练模型。</strong></p>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FDEVELOPERAA%2Farticle%2Fdetails%2F146979848%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522b89c918c549e0aaad7cb340126a05c42%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fblog.%252522%25257D%26request_id%3Db89c918c549e0aaad7cb340126a05c42%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase%26utm_term%3D%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258B%25E5%25AD%25A6%25E4%25B9%25A0%25E8%25B7%25AF%25E7%25BA%25BF%26spm%3D1018.2226.3001.4450" target="_blank" title="https://blog.csdn.net/DEVELOPERAA/article/details/146979848?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522b89c918c549e0aaad7cb340126a05c42%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=b89c918c549e0aaad7cb340126a05c42&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase&amp;utm_term=%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF&amp;spm=1018.2226.3001.4450" ref="nofollow noopener noreferrer"/>大模型LLM的分类</h4>
<p>目前业界涌现了非常多的大模型，也看了网上一些关于对大模型分类归纳的文章，都非常不错，本节主要是对网上的分类信息进行总结。</p>
<p>本节将从以下三个方面来对大模型进行分类：</p>
<h5 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FDEVELOPERAA%2Farticle%2Fdetails%2F146979848%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522b89c918c549e0aaad7cb340126a05c42%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fblog.%252522%25257D%26request_id%3Db89c918c549e0aaad7cb340126a05c42%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase%26utm_term%3D%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258B%25E5%25AD%25A6%25E4%25B9%25A0%25E8%25B7%25AF%25E7%25BA%25BF%26spm%3D1018.2226.3001.4450" target="_blank" title="https://blog.csdn.net/DEVELOPERAA/article/details/146979848?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522b89c918c549e0aaad7cb340126a05c42%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=b89c918c549e0aaad7cb340126a05c42&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase&amp;utm_term=%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF&amp;spm=1018.2226.3001.4450" ref="nofollow noopener noreferrer"/>根据算法原理分类</h5>
<p>大模型的架构基本都是Transformer，而Transformer详细的结构在google发布的论文《Attention Is All You Need》中进行了描述，Transformer结构中有两个非常重要的部件：Encoder和Decoder，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af58ee3a7a574c46b61eecce34429b8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161000&amp;x-signature=onWZHqmLkTo6OqMMs5oE5e8xBS8%3D" alt="transformer架构.webp" loading="lazy"/></p>
<p>根据对Transformer结构的裁剪，可以将目前的大模型分为三类：</p>
<ul>
<li>Encoder-Only：裁剪了Decoder部件，代表模型BERT，到了2020年之后，这类技术基本已经不再发展。</li>
<li>Encoder-Decoder：没有裁剪任何部件，代表模型T5。</li>
<li>Decoder-Only：裁剪了Encoder部件，代表模型GPT，目前主导LLM领域的发展。</li>
</ul>
<p>下面是一张结合了大模型出现时间以及所属架构分类的图片，分别详细阐述了各个分类有哪些代表模型，以及模型出现的时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baa636f5d459496cae65718a99af5797~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161000&amp;x-signature=yfsxTDv6Iw7Np4cWN1g5DpyyjDo%3D" alt="llm-evolutionary-tree.png" loading="lazy"/></p>
<h5 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FDEVELOPERAA%2Farticle%2Fdetails%2F146979848%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522b89c918c549e0aaad7cb340126a05c42%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fblog.%252522%25257D%26request_id%3Db89c918c549e0aaad7cb340126a05c42%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase%26utm_term%3D%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258B%25E5%25AD%25A6%25E4%25B9%25A0%25E8%25B7%25AF%25E7%25BA%25BF%26spm%3D1018.2226.3001.4450" target="_blank" title="https://blog.csdn.net/DEVELOPERAA/article/details/146979848?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522b89c918c549e0aaad7cb340126a05c42%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=b89c918c549e0aaad7cb340126a05c42&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase&amp;utm_term=%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF&amp;spm=1018.2226.3001.4450" ref="nofollow noopener noreferrer"/>根据输入内容分类</h5>
<p>根据输入内容不同，可以分为以下三类：</p>
<ul>
<li>语言大模型</li>
</ul>
<p>指在自然语言处理（Natural Language Processing，NLP）领域中的一类大模型，通常用于处理文本数据和理解自然语言。 这类大模型的主要特点是它们在大规模语料库上进行了训练，以学习自然语言的各种语法、语义和语境规则。 例如：GPT 系列（OpenAI）、Bard（Google）、文心一言（百度）。</p>
<ul>
<li>视觉大模型</li>
</ul>
<p>指在计算机视觉（Computer Vision，CV）领域中使用的大模型，通常用于图像处理和分析。 这类模型通过在大规模图像数据上进行训练，可以实现各种视觉任务，如图像分类、目标检测、图像分割、姿态估计、人脸识别等。 例如：VIT 系列（Google）、文心UFO、华为盘古 CV、INTERN（商汤）。</p>
<ul>
<li>多模态大模型</li>
</ul>
<p>指能够处理多种不同类型数据的大模型，例如文本、图像、音频等多模态数据。 这类模型结合了 NLP 和 CV 的能力，以实现对多模态信息的综合理解和分析，从而能够更全面地理解和处理复杂的数据。 例如：DingoDB 多模向量数据库（九章云极 DataCanvas）、DALL-E(OpenAI)、悟空画画（华为）、midjourney。</p>
<h5 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FDEVELOPERAA%2Farticle%2Fdetails%2F146979848%3Fops_request_misc%3D%25257B%252522request%25255Fid%252522%25253A%252522b89c918c549e0aaad7cb340126a05c42%252522%25252C%252522scm%252522%25253A%25252220140713.130102334.pc%25255Fblog.%252522%25257D%26request_id%3Db89c918c549e0aaad7cb340126a05c42%26biz_id%3D0%26utm_medium%3Ddistribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase%26utm_term%3D%25E5%25A4%25A7%25E6%25A8%25A1%25E5%259E%258B%25E5%25AD%25A6%25E4%25B9%25A0%25E8%25B7%25AF%25E7%25BA%25BF%26spm%3D1018.2226.3001.4450" target="_blank" title="https://blog.csdn.net/DEVELOPERAA/article/details/146979848?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522b89c918c549e0aaad7cb340126a05c42%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=b89c918c549e0aaad7cb340126a05c42&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-28-146979848-null-null.nonecase&amp;utm_term=%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF&amp;spm=1018.2226.3001.4450" ref="nofollow noopener noreferrer"/>根据应用领域分类</h5>
<p>按照应用领域，大模型主要可以分为 L0、L1、L2 三个层级：</p>
<ul>
<li>通用大模型 L0： 是指可以在多个领域和任务上通用的大模型。 它们利用大算力、使用海量的开放数据与具有巨量参数的深度学习算法，在大规模无标注数据上进行训练，以寻找特征并发现规律，进而形成可“举一反三”的强大泛化能力，可在不进行微调或少量微调的情况下完成多场景任务，相当于 AI 完成了“通识教育”。</li>
<li>行业大模型 L1： 是指那些针对特定行业或领域的大模型。 它们通常使用行业相关的数据进行预训练或微调，以提高在该领域的性能和准确度，相当于 AI 成为“行业专家”。</li>
<li>垂直大模型 L2： 是指那些针对特定任务或场景的大模型。 它们通常使用任务相关的数据进行预训练或微调，以提高在该任务上的性能和效果。</li>
</ul>
<h2 data-id="heading-6">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE 2025 年度报告🥳：隐藏人格大揭秘！晒报告赢定制年终奖]]></title>    <link>https://juejin.cn/post/7587349016222367785</link>    <guid>https://juejin.cn/post/7587349016222367785</guid>    <pubDate>2025-12-25T03:31:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587349016222367785" data-draft-id="7587062584164810790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE 2025 年度报告🥳：隐藏人格大揭秘！晒报告赢定制年终奖"/> <meta itemprop="keywords" content="Trae,AI编程,VibeCoding"/> <meta itemprop="datePublished" content="2025-12-25T03:31:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE 2025 年度报告🥳：隐藏人格大揭秘！晒报告赢定制年终奖
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194374926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T03:31:02.000Z" title="Thu Dec 25 2025 03:31:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cc3df41b00e4a0e8fef7414eb0d2af8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767238262&amp;x-signature=qdeddRoXvXh%2FD0Ec2pxjZ8v%2FE6E%3D" alt="20251225-111403.png" loading="lazy"/></p>
<p><strong>年末收官，TRAE 年度报告正式上线啦</strong></p>
<p>这一年里，每一次和 AI 协作 Coding、每一段被优化的代码、每一个攻克的需求，都在 TRAE 留下了你的专属印记。通过这份报告，还能解锁你的隐藏编码人格～</p>
<p>COME ON ！晒出报告分享真实感受，来冲一波 TRAE 周边年终大礼！</p>
<p>用一条沸点，来给这一年的 Coding 时光完美收尾吧～</p>
<h3 data-id="heading-0">活动时间</h3>
<p>12月25日12:00-12月30日23:59</p>
<h3 data-id="heading-1">活动方式</h3>
<ul>
<li><strong>生成报告</strong>：点击链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.trae.cn%2Fevents%2Fannual-2025" target="_blank" title="https://www.trae.cn/events/annual-2025" ref="nofollow noopener noreferrer">www.trae.cn/events/annu…</a> 或扫描二维码，生成并保存你的 2025 年度报告。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da9dc97b2362442684f7a26ddecc7dd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767238262&amp;x-signature=80piVKiEsvvVoExfvD9fSpkkgOk%3D" alt="img_v3_02ta_eecdce34-bda4-4470-a0fe-86a5fbae943g.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>发布沸点</strong>：在掘金社区内发布沸点，<strong>分享2025最具成就感的「数据面板」或「角色形象」</strong>，文案内容包括但不限于：体验感想、玩法攻略、反馈建议……</p>
</li>
<li>
<p><strong>添加话题</strong>：带上 <strong>#<a href="https://juejin.cn/pin/topic/7587524867952476206" target="_blank" title="https://juejin.cn/pin/topic/7587524867952476206">TRAELAND</a></strong> 话题标签。</p>
</li>
</ul>
<h3 data-id="heading-2">活动激励</h3>
<p>活动期间，综合统计所有符合要求的参赛沸点，按「点赞数 + 评论数」总和排名，前 100 名掘友可获得专属 TRAE 定制周边年终大礼～</p>
<p>💡 100 个获奖名额全覆盖，只要跻身前 100，即可将定制福利收入囊中！</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/325702089b7640c99f88fc5d580a2fc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767238262&amp;x-signature=sFxKgaNzADS92g2wZDcfOJnVAhs%3D" alt="img_v3_02ta_9413d7eb-e69d-4fd2-b7db-0d74589504dg.jpg" loading="lazy"/></p>
<h3 data-id="heading-3">注意事项</h3>
<ul>
<li>
<p><strong>话题正确</strong>：参赛沸点必须添加 #<a href="https://juejin.cn/pin/topic/7587524867952476206" target="_blank" title="https://juejin.cn/pin/topic/7587524867952476206">TRAELAND</a> 话题标签，错加、漏加均视为无效参与；</p>
</li>
<li>
<p><strong>内容真实</strong>：分享的年度报告截图、数据信息需真实有效，严禁伪造、盗用他人内容，一经发现取消资格；</p>
</li>
<li>
<p><strong>形式合规</strong>：发布内容需清晰展示「角色形象」或「数据面板」之一，无遮挡、无模糊，确保审核人员可清晰辨识；</p>
</li>
<li>
<p><strong>公开可见</strong>：参赛沸点需设置为「公开」状态，私密或仅好友可见的内容无法参与审核与排名；</p>
</li>
<li>
<p><strong>合规创作</strong>：内容需积极向上，不得包含违规、低俗、攻击性言论，否则取消参与资格。</p>
</li>
<li>
<p>本次活动面向TRAE中国版用户。</p>
</li>
</ul>
<h3 data-id="heading-4">活动Q&amp;A</h3>
<p><strong>Q1: 有效沸点判定标准是什么？</strong></p>
<p>A1: 需同时满足以下条件：</p>
<p>① 内容积极向上，围绕 TRAELAND 年度报告展开真实分享，可含体验感想、玩法攻略、反馈建议等；</p>
<p>② 正确添加 <strong>#<a href="https://juejin.cn/pin/topic/7587524867952476206" target="_blank" title="https://juejin.cn/pin/topic/7587524867952476206">TRAELAND</a></strong> 话题标签；</p>
<p>③ 沸点设置为公开可见状态；</p>
<p>④ 清晰展示你的 TRAE LAND 角色形象或数据面板截图；内容真实，无伪造、盗用行为。</p>
<p><strong>Q2: 排名如何计算与截止时间？</strong></p>
<p>A2: 参赛沸点排名按「点赞数 + 评论数」总和核算，同一用户发布多条参赛内容，仅取数据最优一条参与排名；无意义水评论不计入有效评论数。；</p>
<p>数据统计截止时间为 2025 年 12 月 30 日 23:59，逾期新增的点赞、评论不再计入。获奖名单将于活动结束后 7 个工作日内，在掘金沸点圈子公布，敬请关注。</p>
<p><strong>Q3: 同一用户可以发布多条沸点参赛吗？</strong></p>
<p>A3: 可以，但同一用户仅能以数据最优的一条沸点参与排名，不可重复获奖。建议大家精心打磨一条内容，提升获奖概率哦～</p>
<p><strong>Q4: 是否必须发布截图？</strong></p>
<p>A4: 是的，请分享 TRAE LAND 年度报告中的“角色形象”或“数据面板”截图之一，并确保内容清晰可见。</p>
<p><strong>Q5: 违规或抄袭如何处理？</strong></p>
<p>A5: 一经核实存在刷量、抄袭、盗用等违规行为，将取消参与资格。</p>
<p><strong>Q6: 奖品如何发放？</strong></p>
<p>A6: 获奖名单公布后，官方将通过掘金社区「私信」功能联系获奖用户，核实身份信息与收货地址。请获奖用户在收到私信后 3 个工作日内回复确认，逾期未回复视为自动放弃福利。实物奖品将在信息确认后 10 个工作日内安排寄送。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>