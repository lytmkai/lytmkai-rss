<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Hooks 使用注意事项及来龙去脉]]></title>    <link>https://juejin.cn/post/7599679977344483369</link>    <guid>https://juejin.cn/post/7599679977344483369</guid>    <pubDate>2026-01-27T10:07:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599679977344483369" data-draft-id="7598490039489855523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hooks 使用注意事项及来龙去脉"/> <meta itemprop="keywords" content="前端,React.js,前端工程化"/> <meta itemprop="datePublished" content="2026-01-27T10:07:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sophie旭"/> <meta itemprop="url" content="https://juejin.cn/user/2559318799692952"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hooks 使用注意事项及来龙去脉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2559318799692952/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sophie旭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:07:52.000Z" title="Tue Jan 27 2026 10:07:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>前几篇文章已经聊了Hooks 的意义以及如何实现的，那么现在我们来看下 我们平时 使用 hook的一些注意事项，也就是我们说的 “心智负担”，但是当我们理解它背后的实现原理后，也许 这种负担会大大减轻吧</p>
<h2 data-id="heading-1">为什么Hooks必须在函数组件顶层调用，不能写在条件语句中？</h2>
<h3 data-id="heading-2">前置知识</h3>
<p>我们知道 hook链表绑在了fiber上了，<strong><code>那么下次 更新时，首先要找到对应的旧fiber对吗？那怎么找呢？？</code></strong></p>
<h4 data-id="heading-3">正确的「新旧 Fiber 树构建 + alternate 绑定」流程</h4>
<p>以「首次渲染后，点击 setCount 触发更新」为例，完整步骤：</p>
<h5 data-id="heading-4">步骤 1：首次渲染后，先建立“旧树（Current）”</h5>
<ul>
<li>首次渲染时，React 从根节点开始，为每个组件（根→App→Button 等）创建全新的 fiber 节点，构建出「Current Fiber 树」（旧树）；</li>
<li>此时每个 fiber 节点的 <code>alternate</code> 为 null（无新树）；</li>
<li>根 Fiber 的 <code>current</code> 指向这棵旧树。</li>
</ul>
<h5 data-id="heading-5">步骤 2：触发更新后，创建新树（WorkInProgress）的“骨架”</h5>
<p>React 不会复制旧树，而是：</p>
<ol>
<li>从根 Fiber 开始，<strong><code>遍历旧树（Current）的节点</code></strong>（按 <code>child</code>/<code>sibling</code> 层级）；</li>
<li>对每个旧 fiber 节点，执行「调和（Reconciliation）」：
<ul>
<li>如果组件类型未变(且key也没变)（比如还是 <code>&lt;App /&gt;</code>）：<strong><code>确认结构没变化，创建新的 workInProgress fiber 节点</code></strong>,<strong><code>（只复用旧节点的“结构信息”，比如层级、类型，不复制状态）；</code></strong></li>
<li>如果组件类型变了（比如 <code>&lt;App /&gt;</code> 变成 <code>&lt;Other /&gt;</code>）：丢弃旧节点，创建全新的新节点；</li>
<li>如果组件被卸载：不创建新节点；</li>
</ul>
</li>
<li><strong>关键</strong>：为新创建的 workInProgress fiber 绑定 <code>alternate</code> 指针 → <strong><code>workInProgress.alternate = 旧 fiber</code></strong>（同时旧 fiber.alternate = workInProgress，双向绑定）。</li>
</ol>
<p>举例说明：</p>
<p>假设旧 fiber（Current）是这样的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旧 fiber（Current）- App 组件</span>
<span class="hljs-keyword">const</span> oldFiber = {
  <span class="hljs-comment">// 结构信息（静态）</span>
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">App</span>, <span class="hljs-comment">// 组件类型是 App 函数</span>
  <span class="hljs-attr">key</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">return</span>: rootFiber, <span class="hljs-comment">// 父节点是根 fiber</span>
  <span class="hljs-attr">child</span>: buttonFiber, <span class="hljs-comment">// 子节点是 Button 组件的 fiber</span>
  <span class="hljs-attr">sibling</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 无兄弟节点</span>
  
  <span class="hljs-comment">// 状态信息（动态）</span>
  <span class="hljs-attr">memoizedState</span>: { <span class="hljs-attr">memoizedState</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">queue</span>: <span class="hljs-literal">null</span> }, <span class="hljs-comment">// Hook 链表（count=0）</span>
  <span class="hljs-attr">updateQueue</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 副作用队列</span>
  <span class="hljs-attr">props</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"旧名称"</span> } <span class="hljs-comment">// 父组件传的旧 props</span>
};
</code></pre>
<p>当创建新 fiber（workInProgress）时，React 做的是：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 新 fiber（workInProgress）- App 组件</span>
<span class="hljs-keyword">const</span> newFiber = {
  <span class="hljs-comment">// 1. 复用旧 fiber 的「结构信息」（直接抄，不用重新判断）</span>
  <span class="hljs-attr">type</span>: oldFiber.<span class="hljs-property">type</span>, <span class="hljs-comment">// 复用 type: App</span>
  <span class="hljs-attr">key</span>: oldFiber.<span class="hljs-property">key</span>, <span class="hljs-comment">// 复用 key: null</span>
  <span class="hljs-attr">return</span>: oldFiber.<span class="hljs-property">return</span>, <span class="hljs-comment">// 复用父节点：rootFiber</span>
  <span class="hljs-attr">child</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 先留空，后续调和子节点时再复用旧 child 的结构</span>
  <span class="hljs-attr">sibling</span>: oldFiber.<span class="hljs-property">sibling</span>, <span class="hljs-comment">// 复用兄弟节点：null</span>
  
  <span class="hljs-comment">// 2. 「状态信息」完全清空/重新计算（不复用旧值）</span>
  <span class="hljs-attr">memoizedState</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 清空 Hook 链表（后续通过 renderWithHooks 重新构建）</span>
  <span class="hljs-attr">updateQueue</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 清空副作用队列（后续重新收集）</span>
  <span class="hljs-attr">props</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"新名称"</span> } <span class="hljs-comment">// 用本次父组件传的新 props（不复用旧 props）</span>
};

<span class="hljs-comment">// 3. 绑定 alternate 指针（新→旧）</span>
newFiber.<span class="hljs-property">alternate</span> = oldFiber;
oldFiber.<span class="hljs-property">alternate</span> = newFiber;
</code></pre>
<p>👉 核心看差异：</p>
<ul>
<li>结构信息（<code>type</code>/<code>return</code>/<code>key</code>）：直接从旧 fiber 拿，不用重新判断“这个组件是不是 App？它的父节点是谁？”——省掉了重复的层级/类型判断成本；</li>
<li>状态信息（<code>memoizedState</code>/<code>updateQueue</code>）：完全清空，后续执行 <code>renderWithHooks</code> 时，再从旧 fiber 的 <code>memoizedState</code> 读取 Hook 状态、计算新状态，最后填充到新 fiber 中。</li>
</ul>
<h5 data-id="heading-6">步骤 3：遍历新树骨架，执行渲染函数填充内容</h5>
<p>React 遍历刚创建的「WorkInProgress 新树骨架」，对每个函数组件节点：</p>
<ol>
<li>调用 <code>updateFunctionComponent</code> → 进而调用 <code>renderWithHooks</code>；</li>
<li>执行组件的渲染函数（比如 <code>App()</code>），触发 Hook 调用；</li>
<li><strong><code>通过 workInProgress.alternate 找到旧 fiber，读取旧 Hook 状态，计算新状态；</code></strong></li>
<li>把新状态填充到 workInProgress fiber 的 <code>memoizedState</code>（Hook 链表）中，完成新树的“内容填充”。</li>
</ol>
<h5 data-id="heading-7">步骤 4：提交新树，替换旧树</h5>
<p>渲染完成后，React 把「WorkInProgress 新树」提交到 DOM，然后：</p>
<ul>
<li>根 Fiber 的 <code>current</code> 指向这棵新树（它变成了下一次更新的“旧树”）；</li>
<li>原来的旧树被标记为可回收，等待 GC。</li>
</ul>
<h4 data-id="heading-8">总结：</h4>
<ul>
<li>React 找旧 fiber 的最终“快捷方式”是 <code>workInProgress.alternate</code>；</li>
<li>双树的核心价值是“增量更新”——不用每次重新创建完整 fiber 树，只需基于旧树更新变化的部分；</li>
<li>alternate 指针是双树关联的“物理纽带”，保证了旧状态能被精准找到。</li>
</ul>
<h3 data-id="heading-9">旧fiber找到了，那么hook呢？新hook和旧hook的关系是？？</h3>
<p><strong><code>首先旧hook链表从哪里来？其实我们可以理解为旧fiber的hook</code></strong></p>
<h4 data-id="heading-10">第一步：先看错误代码（Hook 放条件里）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>); <span class="hljs-comment">// Hook1</span>
  
  <span class="hljs-keyword">if</span> (name) { <span class="hljs-comment">// 条件：name有值时才执行Hook2</span>
    <span class="hljs-keyword">const</span> [phone, setPhone] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>); <span class="hljs-comment">// Hook2</span>
  }
  
  <span class="hljs-keyword">const</span> [submit, setSubmit] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// Hook3</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{/* 渲染 */}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<h4 data-id="heading-11">第二步：首次渲染（name 为空，条件不满足）</h4>
<ul>
<li>执行顺序：Hook1（name）→ Hook3（submit）；</li>
<li>旧 Hook 链表（current fiber）：<code>Hook1（name）→ Hook3（submit）</code>（共2个节点）；</li>
<li>指针记录：遍历到第2个节点（Hook3）结束。</li>
</ul>
<h4 data-id="heading-12">第三步：更新渲染（输入name，条件满足）</h4>
<p>此时用户输入了 name，<code>if (name)</code> 为 true，Hook 执行顺序变了：</p>
<ul>
<li>执行顺序：Hook1（name）→ Hook2（phone）→ Hook3（submit）；</li>
<li>React 开始遍历旧链表（只有2个节点）：
<ol>
<li>本次第1个 Hook（name）→ 匹配旧链表第1个节点（name）→ 正常；</li>
<li>本次第2个 Hook（phone）→ 匹配旧链表第2个节点（submit）→ <strong>错位！</strong> phone 会读取到 submit 的旧状态（false）；</li>
<li>本次第3个 Hook（submit）→ 旧链表已无节点（只有2个）→ React 直接报错（Hook 数量不匹配）。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-13">第四步：关键补充（<strong><code>不只是“遍历拿”，还有“指针移动”</code></strong>）</h4>
<p>你说的“依次遍历之前的旧hook链表拿到一个，返回一个”，可以再补全一点：
React 不是“一次性遍历旧链表”，而是 <strong><code>每调用一个新 Hook，就把旧链表的指针往后移一位 -- 重点，好好理解！！！！</code></strong>：</p>
<ul>
<li>调用第1个新 Hook → 取旧链表第1个节点，指针移到第2个；</li>
<li>调用第2个新 Hook → 取旧链表第2个节点，指针移到第3个；</li>
<li>……</li>
</ul>
<p>条件语句会让“新 Hook 的数量/顺序”和“旧链表的节点数量/顺序”对不上，指针一错位，状态就张冠李戴；数量对不上的话，React 直接抛出警告（Hook 调用数量不一致）。</p>
<p>大致步骤如下：</p>
<p>整个过程和 <code>next</code> 复制无关，完全由「本次 Hook 调用次数」驱动，步骤如下（结合源码简化版）：</p>
<h5 data-id="heading-14">步骤 1：初始化 <code>currentHook</code> 指向旧链表头</h5>
<p>更新渲染时，先把 <code>currentHook</code> 指向旧 fiber 的 Hook 链表头（这是唯一和旧链表 <code>next</code> 相关的一步，但只是“读取头节点”，不是复制）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化：currentHook 指向旧链表头（靠旧链表的 next，但只取头节点）</span>
<span class="hljs-keyword">let</span> currentHook = current !== <span class="hljs-literal">null</span> ? current.<span class="hljs-property">memoizedState</span> : <span class="hljs-literal">null</span>;
<span class="hljs-comment">// 新 Hook 链表头初始为空（不复制任何 next）</span>
<span class="hljs-keyword">let</span> workInProgressHook = <span class="hljs-literal">null</span>;
</code></pre>
<h5 data-id="heading-15">步骤 2：每调用一个 Hook，手动移动 <code>currentHook</code> 找下一个旧 Hook</h5>
<p>每次执行 <code>updateState</code>（比如 useState），React 会：</p>
<ol>
<li>用<strong>当前的 <code>currentHook</code></strong> 创建新 Hook（复制 memoizedState/queue）；</li>
<li>手动执行 <code>currentHook = currentHook.next</code>——这就是“找到下一个旧 Hook”的核心操作；</li>
<li><strong><code>新 Hook 的 next 设为 null，后续按本次顺序手动拼接（而非复制旧 next）。因为旧next指向的是就hook，我们说过每次都会重新创建新hook，所以应该新 Hook 的next永远指向下一个新创建的 Hook</code></strong></li>
</ol>
<h5 data-id="heading-16">完整代码演示（顺序一致的场景）：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 旧链表：Hook1（name）→ Hook2（phone）→ Hook3（submit）（旧 next 正常）</span>
<span class="hljs-keyword">let</span> currentHook = oldHook1; <span class="hljs-comment">// 初始化指向旧链表头</span>

<span class="hljs-comment">// 第1次调用 useState（Hook1）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateState</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 用当前 currentHook（oldHook1）创建新 Hook1（复制 memoizedState/queue）</span>
  <span class="hljs-keyword">const</span> newHook1 = <span class="hljs-title function_">createWorkInProgressHook</span>(currentHook);
  newHook1.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 不复制 oldHook1.next（oldHook1.next 是 oldHook2）</span>
  
  <span class="hljs-comment">// 手动移动 currentHook → 找到下一个旧 Hook（oldHook2）</span>
  currentHook = currentHook.<span class="hljs-property">next</span>; 
  
  workInProgressHook = newHook1; <span class="hljs-comment">// 新链表头指向 newHook1</span>
}

<span class="hljs-comment">// 第2次调用 useState（Hook2）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateState</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 用当前 currentHook（oldHook2）创建新 Hook2</span>
  <span class="hljs-keyword">const</span> newHook2 = <span class="hljs-title function_">createWorkInProgressHook</span>(currentHook);
  newHook2.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 不复制 oldHook2.next（oldHook2.next 是 oldHook3）</span>
  
  <span class="hljs-comment">// 手动移动 currentHook → 找到下一个旧 Hook（oldHook3）</span>
  currentHook = currentHook.<span class="hljs-property">next</span>; 
  
  <span class="hljs-comment">// 手动拼接新链表的 next（本次顺序）</span>
  workInProgressHook.<span class="hljs-property">next</span> = newHook2;
  workInProgressHook = newHook2;
}

<span class="hljs-comment">// 第3次调用 useState（Hook3）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateState</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 用当前 currentHook（oldHook3）创建新 Hook3</span>
  <span class="hljs-keyword">const</span> newHook3 = <span class="hljs-title function_">createWorkInProgressHook</span>(currentHook);
  newHook3.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>;
  
  <span class="hljs-comment">// 手动移动 currentHook → 旧链表结束（null）</span>
  currentHook = currentHook.<span class="hljs-property">next</span>; 
  
  <span class="hljs-comment">// 手动拼接新链表的 next</span>
  workInProgressHook.<span class="hljs-property">next</span> = newHook3;
  workInProgressHook = newHook3;
}
</code></pre>
<h5 data-id="heading-17">关键：找下一个旧 Hook 靠的是 <code>currentHook = currentHook.next</code>，而非新 Hook 的 <code>next</code></h5>
<ul>
<li>旧链表的 <code>next</code> 只被 <code>currentHook</code> 用来“移动指针”，但新 Hook 完全不复制这个 <code>next</code>；</li>
<li>新 Hook 的 <code>next</code> 是<strong>按本次调用顺序手动拼接</strong>的，和旧 Hook 的 <code>next</code> 无关；</li>
<li>哪怕旧链表的 <code>next</code> 异常（比如指向 null/僵尸节点），<code>currentHook</code> 移动时能立刻发现，及时报错，而复制旧 <code>next</code> 会把异常带入新链表。</li>
</ul>
<h4 data-id="heading-18">通俗比喻：像“按顺序领快递”</h4>
<p>把旧 Hook 链表比作“快递柜的格子”（按顺序编号1、2、3…），每次渲染领快递：</p>
<ul>
<li>正常情况：每次都按1→2→3的顺序领，格子里的快递（状态）永远对应你的 Hook；</li>
<li>条件语句：第一次领1→3（跳过2），第二次领1→2→3——此时领2号格子时，里面是原本3号的快递（submit的状态），领3号时格子空了，直接报错。</li>
</ul>
<h4 data-id="heading-19">总结</h4>
<p>Hook 不能放条件语句里的核心原因：</p>
<ol>
<li>React 更新时，会<strong>按本次 Hook 调用顺序，逐个匹配旧 Hook 链表的节点</strong>（指针逐次后移）；</li>
<li>条件语句会导致本次 Hook 的调用顺序/数量，和旧链表的节点顺序/数量不一致；</li>
<li>最终要么状态错位（张冠李戴），要么直接报错（数量不匹配），完全破坏 Hook 状态和组件的绑定关系。</li>
</ol>
<h2 data-id="heading-20">关于useEffect</h2>
<h3 data-id="heading-21">useEffect副作用函数啥时候执行？</h3>
<h4 data-id="heading-22">一、先搞懂核心概念：React 工作的三大步骤</h4>
<p>文章里提到的 React 工作流程是理解所有问题的基础，先把这个核心框架记住：</p>
<ol>
<li>
<p><strong>调度器</strong>：决定「什么时候更新」（比如用户点击、数据请求完成触发更新）</p>
<p>调度器就是 React 的「时间管家」，它判断 “什么时候该干活”。比如你点击按钮想改页面内容，调度器会说 “现在可以开始更新了”；再比如请求接口拿到数据后，调度器会说 “数据到了，该更新页面了”。</p>
</li>
<li>
<p><strong>协调器</strong>：决定「更新什么内容」（生成 Fiber 树，给需要操作的 Fiber 打标记，构建 effectList）</p>
<p>协调器是 React 的「规划师」，它不管 “什么时候干”，只管 “干什么”。</p>
</li>
<li>
<p><strong>渲染器</strong>：执行「实际的更新操作」（遍历 effectList，执行 DOM 插入/更新、useEffect 回调等）</p>
<p>渲染器是 React 的「打工人」，它照着协调器列的 effectList 清单干活 —— 遍历链表，看到「Placement」标记就插 DOM，看到「Passive」标记就执行 useEffect 回调。</p>
</li>
</ol>
<p>其中，<strong>Fiber</strong> 可以简单理解为「带标记的虚拟 DOM 节点」，</p>
<pre><code class="hljs language-php" lang="php">可以理解为「带备注的虚拟DOM树」，每个组件对应一个 <span class="hljs-built_in">Fiber</span> 节点；
打标记：比如某个组件需要新增 DOM，就给它的 <span class="hljs-built_in">Fiber</span> 打「Placement（插入）」标记；某个组件有 useEffect 要执行，就打「Passive」标记；
</code></pre>
<p><strong>effectList</strong> 是「需要执行副作用（比如 DOM 操作、useEffect）的 Fiber 链表」。</p>
<pre><code class="hljs language-php" lang="php"> effectList：把所有“有标记要干活”的 <span class="hljs-built_in">Fiber</span> 节点串成一个链表
（比如“Child要执行useEffect → Parent要执行useEffect → App要执行useEffect”），方便后续挨个处理。
</code></pre>
<h4 data-id="heading-23">二、第一个问题：useEffect 的执行顺序（child -&gt; parent -&gt; app）</h4>
<h5 data-id="heading-24">核心逻辑：effectList 的构建在「归阶段」</h5>
<p>React 协调器处理组件树时，分「递」和「归」两个阶段：</p>
<ul>
<li><strong>递阶段</strong>：从根组件（App）向下遍历到叶子组件（Child），相当于「从上到下找要更新的组件」；</li>
<li><strong>归阶段</strong>：从叶子组件（Child）向上回到根组件（App），相当于「从下到上给找到的组件打标记、构建 effectList」。</li>
</ul>
<p>而 useEffect 对应的 Fiber 会被打上 <code>Passive</code> 标记，这个标记的添加、effectList 的构建都发生在「归阶段」。</p>
<p>所以 effectList 的顺序是：Child → Parent → App，渲染器遍历 effectList 执行 useEffect 回调时，自然也是这个顺序，控制台就会先打印 <code>child</code>，再 <code>parent</code>，最后 <code>app</code>。</p>
<h5 data-id="heading-25">举个通俗例子</h5>
<p>你可以把组件树想象成「爷爷（App）→ 爸爸（Parent）→ 儿子（Child）」：</p>
<ul>
<li>递阶段：爷爷先喊爸爸，爸爸再喊儿子，确认大家是否需要更新；</li>
<li>归阶段：儿子先报告「我要执行 useEffect」，然后爸爸报告，最后爷爷报告；</li>
<li>执行时：按「儿子→爸爸→爷爷」的顺序执行 useEffect 回调。</li>
</ul>
<h4 data-id="heading-26">三、第二个问题：useEffect([]) 和 componentDidMount 调用时机不同</h4>
<h5 data-id="heading-27">表面相似，底层逻辑不同</h5>
<ul>
<li><strong>相似点</strong>：两者都只在「组件挂载（mount）」时执行一次（useEffect 因为 deps 为空，不会触发更新）；</li>
<li><strong>核心不同</strong>：执行时机的「同步/异步」差异：
<ol>
<li><code>componentDidMount</code>：属于类组件的生命周期钩子，在「DOM 渲染完成后同步执行」（渲染完立刻执行，阻塞后续代码）；</li>
<li><code>useEffect([])</code>：属于 Passive Effect，React 会在「DOM 渲染完成后，把所有 Passive Effect 的回调放到异步队列里执行」（不阻塞主线程，浏览器先绘制页面，再执行回调）。</li>
</ol>
</li>
</ul>
<h5 data-id="heading-28">更贴近 componentDidMount 的是 useLayoutEffect</h5>
<p><code>useLayoutEffect</code> 的回调会在「DOM 渲染完成后同步执行」，和 componentDidMount 时机几乎一致；而 useEffect 是异步执行，这也是为什么有时用 useEffect 操作 DOM 会看到「一闪而过」的视觉问题（页面先渲染，再执行回调修改 DOM），而 useLayoutEffect 不会。</p>
<h4 data-id="heading-29">四、useEffect 完整执行流程（结合文章）</h4>
<ol>
<li>组件触发更新 → 协调器执行 FunctionComponent，遇到 useEffect 检查 deps 是否变化；</li>
<li>如果 deps 变化 → 给当前组件的 Fiber 打上 <code>Passive</code> 标记；</li>
<li>协调器在「归阶段」构建 effectList（顺序：叶子→根）；</li>
<li>渲染器遍历 effectList：
<ul>
<li>先执行所有 useEffect 的「销毁函数」（即回调的返回值）；</li>
<li>再执行所有 useEffect 的「回调函数」（create）；</li>
</ul>
</li>
<li>整个过程在页面渲染后<strong>异步</strong>完成。</li>
</ol>
<h4 data-id="heading-30">总结</h4>
<ol>
<li><strong>useEffect 执行顺序</strong>：由 effectList 决定，而 effectList 构建于「归阶段」，所以是「子组件 → 父组件 → 根组件」；</li>
<li><strong>useEffect 执行时机</strong>：DOM 渲染后异步执行，和类组件的 componentDidMount（同步执行）时机不同，useLayoutEffect 才是同步执行，更贴近 componentDidMount；</li>
<li><strong>核心思路</strong>：理解 useEffect 不要依赖「生命周期类比」，要从 React「调度→协调→渲染」的底层流程出发，核心是 effectList 的构建和遍历逻辑。</li>
</ol>
<h4 data-id="heading-31">依赖数组传空数组 <code>[]</code> 和完全不写依赖 的区别</h4>


























<table><thead><tr><th>写法</th><th>deps 变化判断逻辑</th><th>Passive 标记时机</th><th>执行次数</th><th>底层本质</th></tr></thead><tbody><tr><td><code>useEffect(() =&gt; {}, [])</code></td><td>仅首次挂载时，因“无旧 deps”视为 deps 变化；后续更新时，新旧 deps 都是空数组，判定为“无变化”</td><td>仅<strong>首次挂载</strong>的调和阶段，给 Fiber 打 Passive 标记</td><td>只执行 1 次（组件挂载时）</td><td>对应“仅 mount 执行”，和 <code>componentDidMount</code> 逻辑对齐</td></tr><tr><td><code>useEffect(() =&gt; {})</code></td><td>完全不判断 deps 变化，React 视为“每次更新都有变化”</td><td><strong>每次组件更新</strong>的调和阶段，都给 Fiber 打 Passive 标记</td><td>组件每次渲染/更新都执行（包括首次挂载）</td><td>对应“mount + 每次 update 执行”，和 <code>componentDidUpdate</code> 无依赖版对齐</td></tr></tbody></table>
<h4 data-id="heading-32">结合底层流程，拆解差异根源</h4>
<p>我们还是以 <code>App → Parent → Child</code> 组件为例，结合调和阶段的递/归流程，看两种写法的执行逻辑：</p>
<h5 data-id="heading-33">1. 写法1：<code>useEffect(() =&gt; {}, [])</code>（空数组依赖）</h5>
<ul>
<li><strong>递阶段</strong>：
<ul>
<li>首次挂载：执行组件时，检查 deps（无旧 deps）→ 判定“变化”，记录 <code>needPassiveEffect = true</code>；</li>
<li>后续更新（比如 Parent 组件 setState）：执行组件时，对比新旧 deps（都是 <code>[]</code>）→ 判定“无变化”，记录 <code>needPassiveEffect = false</code>；</li>
</ul>
</li>
<li><strong>归阶段</strong>：
<ul>
<li>首次挂载：因 <code>needPassiveEffect = true</code> → 打 Passive 标记，加入 effectList → commit 阶段执行回调；</li>
<li>后续更新：因 <code>needPassiveEffect = false</code> → 不打 Passive 标记，不会加入 effectList → 回调不执行；</li>
</ul>
</li>
<li><strong>最终表现</strong>：仅组件首次挂载时执行 1 次，后续无论父/子组件怎么更新，都不再执行。</li>
</ul>
<h5 data-id="heading-34">2. 写法2：<code>useEffect(() =&gt; {})</code>（无依赖数组）</h5>
<ul>
<li><strong>递阶段</strong>：
React 对“不写 deps”的处理逻辑是——<strong>跳过 deps 对比，直接判定为“变化”</strong>，无论首次挂载还是后续更新，都记录 <code>needPassiveEffect = true</code>；</li>
<li><strong>归阶段</strong>：
每次组件更新的调和阶段，都会给 Fiber 打 Passive 标记，加入 effectList；</li>
<li><strong>最终表现</strong>：
<ul>
<li>首次挂载执行 1 次；</li>
<li>只要组件自身/父组件触发更新（比如 Parent 改 state 导致 Child 重渲染），该 useEffect 就会重新执行；</li>
<li>极端情况：如果父组件频繁 setState，这个 useEffect 会被频繁触发，甚至导致性能问题。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-35">实战例子：直观看到差异</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 写法1：空数组依赖</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'空数组依赖：Child 执行'</span>);
  }, []);

  <span class="hljs-comment">// 写法2：无依赖数组</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'无依赖：Child 执行'</span>);
  });

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Child<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;点我更新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h5 data-id="heading-36">执行结果：</h5>
<ul>
<li>首次挂载：
<pre><code class="hljs">空数组依赖：Child 执行
无依赖：Child 执行
</code></pre>
</li>
<li>点击按钮（Parent 触发更新，Child 重渲染）：
<pre><code class="hljs language-arduino" lang="arduino">无依赖：Child 执行 <span class="hljs-comment">// 空数组依赖的回调不再执行，无依赖的每次都执行</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-37">补充：容易踩的坑</h4>
<ol>
<li><strong>误以为“不写依赖”=“依赖所有变量”</strong>：
很多新手觉得“不写 deps”是“监听所有变量变化”，但底层逻辑是——React 不做任何 deps 对比，直接判定“每次都变化”，哪怕组件内没有任何变量变化，只要组件重渲染，就会执行；</li>
<li><strong>空数组依赖≠“完全不依赖”</strong>：
空数组只是“不依赖组件内的任何 state/props”，但如果依赖的是“外部全局变量”（比如 window 的属性），全局变量变化时，回调也不会重新执行（因为 deps 还是空数组）；</li>
<li><strong>性能风险</strong>：
不写依赖的 useEffect 若包含耗时操作（比如接口请求、DOM 频繁修改），会导致组件每次更新都触发耗时操作，严重时卡顿，<strong>实战中绝对要避免不写依赖的写法</strong>。</li>
</ol>
<h4 data-id="heading-38">总结</h4>
<ol>
<li><strong>空数组 <code>[]</code></strong>：仅首次挂载打 Passive 标记，回调只执行 1 次，对应“仅 mount 执行”；</li>
<li><strong>不写依赖</strong>：每次更新都打 Passive 标记，回调每次渲染都执行，对应“mount + 每次 update 执行”；</li>
<li>底层核心差异：React 对“空数组”做严格的 deps 对比，对“不写依赖”直接跳过对比、判定为每次都变化。</li>
</ol>
<h4 data-id="heading-39">实战建议</h4>
<ul>
<li>除非明确需要“每次更新都执行”（几乎没有这种场景），否则<strong>绝对不要省略依赖数组</strong>；</li>
<li>若想“仅挂载执行”，用 <code>[]</code>；</li>
<li>若想“依赖某个变量变化才执行”，把变量放进依赖数组（比如 <code>[count]</code>），React 会精准对比该变量，仅变化时打 Passive 标记。</li>
</ul>
<h2 data-id="heading-40">useState 和 useRef</h2>
<h3 data-id="heading-41">一、完整闭包陷阱题目</h3>
<h4 data-id="heading-42">1. 题目代码（可直接运行）</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 闭包陷阱示例组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CountDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 初始count为0</span>
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 点击按钮触发：延迟1秒更新count</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 传值更新：基于当前闭包的count计算</span>
      <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
    }, <span class="hljs-number">1000</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前count：{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>点击更新count（延迟1秒）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CountDemo</span>;
</code></pre>
<h4 data-id="heading-43">2. 操作与问题</h4>
<p><strong>操作</strong>：快速点击按钮 3 次（1秒内完成）。
<strong>问题</strong>：1秒后页面上的 <code>count</code> 最终显示多少？
<strong>答案</strong>：<code>1</code>（而非预期的 <code>3</code>）。</p>
<h3 data-id="heading-44">二、现象原因分析（闭包陷阱核心）</h3>
<p>结合你之前理解的「闭包快照」逻辑，拆解核心原因：</p>
<ol>
<li><strong>每次点击触发的是「同一版本的 handleClick」</strong>：
快速点击3次时，所有点击都发生在「1秒延迟期内」，组件还没重新渲染，<code>&lt;button&gt;</code> 的 <code>onClick</code> 始终绑定「初始渲染的 handleClick（版本1）」。</li>
<li><strong>版本1 handleClick 的闭包捕获的是初始 count=0</strong>：
3次点击都会预约「1秒后执行 <code>setCount(0 + 1)</code>」，最终 React 处理这3个更新时，都是将 count 设为 <code>1</code>，因此最终只显示 <code>1</code>。</li>
<li><strong>核心本质</strong>：传值更新（<code>setCount(count + 1)</code>）依赖「闭包内的旧快照值」，而非 React 内部的最新状态。</li>
</ol>
<h3 data-id="heading-45">三、改造方案：延迟1秒拿到最新count（两种常用方案）</h3>
<h4 data-id="heading-46">方案1：函数式更新（React 官方推荐，最优解）</h4>
<h5 data-id="heading-47">改造思路</h5>
<p>将 <code>setCount</code> 的「传值更新」改为「函数式更新」，让 React 自动传入「最新的 prevCount」，脱离闭包对旧值的依赖。</p>
<h5 data-id="heading-48">改造后代码</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">CountDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 函数式更新：参数prevCount是React维护的最新状态</span>
      <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
    }, <span class="hljs-number">1000</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前count：{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>点击更新count（延迟1秒）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CountDemo</span>;
</code></pre>
<h5 data-id="heading-49">原理与效果</h5>
<ul>
<li><strong>原理</strong>：函数式更新的参数 <code>prevCount</code> 是 React 在「处理更新时」传入的「最新状态值」，而非闭包内的旧快照；</li>
<li><strong>效果</strong>：快速点击3次后，1秒内 React 会依次执行：
第1次：<code>prevCount=0 → 0+1=1</code>；
第2次：<code>prevCount=1 → 1+1=2</code>；
第3次：<code>prevCount=2 → 2+1=3</code>；
最终 count 显示 <code>3</code>，符合预期。</li>
</ul>
<h4 data-id="heading-50">方案2：useRef 保存最新值（适合需主动获取最新状态的场景）</h4>
<h5 data-id="heading-51">改造思路</h5>
<p>利用 <code>useRef</code> 的 <code>current</code> 属性是「引用类型」的特性（闭包中能拿到最新值，不会被快照锁定），同步 <code>count</code> 到 <code>ref</code>，延迟操作时从 <code>ref</code> 取最新值。</p>
<h5 data-id="heading-52">改造后代码</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">CountDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-comment">// 用ref保存最新count（ref.current是引用类型，闭包能拿到最新值）</span>
  <span class="hljs-keyword">const</span> countRef = <span class="hljs-title function_">useRef</span>(count);

  <span class="hljs-comment">// 关键：每次渲染同步ref和最新count</span>
  countRef.<span class="hljs-property">current</span> = count;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 从ref中获取最新count值</span>
      <span class="hljs-title function_">setCount</span>(countRef.<span class="hljs-property">current</span> + <span class="hljs-number">1</span>);
    }, <span class="hljs-number">1000</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前count：{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>点击更新count（延迟1秒）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CountDemo</span>;
</code></pre>
<h5 data-id="heading-53">原理与效果</h5>
<ul>
<li><strong>原理</strong>：<code>useRef</code> 的 <code>current</code> 属性存储在堆内存中，引用地址不变，每次组件渲染都会同步最新的 <code>count</code> 到 <code>countRef.current</code>；延迟回调执行时，能直接读取到「最新的 count 值」；</li>
<li><strong>效果</strong>：同样实现点击3次后 count 显示 <code>3</code>，适合需要「在闭包中主动获取最新状态」的场景（比如除了更新，还需打印/使用最新count）。</li>
</ul>
<h3 data-id="heading-54">四、方案对比与适用场景</h3>























<table><thead><tr><th>方案</th><th>核心逻辑</th><th>适用场景</th><th>优点</th></tr></thead><tbody><tr><td>函数式更新</td><td>依赖React传入的最新prevState</td><td>仅需「基于最新状态更新」（绝大多数场景）</td><td>简洁、React官方推荐</td></tr><tr><td>useRef</td><td>手动同步最新状态到ref</td><td>需要「主动读取最新状态」（如打印、传参等）</td><td>灵活，可主动控制状态</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-55">总结</h4>
<ol>
<li><strong>闭包陷阱本质</strong>：快速点击时，延迟更新依赖「闭包内的旧count快照」，多次更新都是基于同一个旧值，最终只生效一次；</li>
<li><strong>核心改造逻辑</strong>：脱离闭包对旧值的依赖——要么用函数式更新让React传最新值，要么用useRef保存最新值；</li>
<li><strong>最佳实践</strong>：优先使用「函数式更新」（<code>setXxx(prev =&gt; prev + 1)</code>），这是React为解决闭包陷阱设计的最优方案，适配90%以上的延迟更新场景。</li>
</ol>
<h3 data-id="heading-56">useState 和 useRef的区别</h3>
<h4 data-id="heading-57">一、核心区别（从底层逻辑到使用表现）</h4>
<p>为了让你一目了然，先通过对比表总结核心差异，再逐一拆解：</p>








































<table><thead><tr><th>维度</th><th>useState</th><th>useRef</th></tr></thead><tbody><tr><td><strong>核心定位</strong></td><td>管理<strong>渲染相关</strong>的状态</td><td>存储<strong>非渲染相关</strong>的持久化数据</td></tr><tr><td><strong>数据修改影响</strong></td><td>调用setter函数会触发组件<strong>重新渲染</strong></td><td>直接修改<code>.current</code><strong>不触发任何渲染</strong></td></tr><tr><td><strong>数据访问方式</strong></td><td>直接访问状态变量（如<code>count</code>）</td><td>必须通过<code>.current</code>属性（如<code>ref.current</code>）</td></tr><tr><td><strong>数据更新特性</strong></td><td>状态更新是“不可变”的（新值替换旧值）</td><td>数据修改是“可变”的（直接修改引用值）</td></tr><tr><td><strong>依赖监听</strong></td><td>状态变化会触发依赖该状态的<code>useEffect</code>/<code>useCallback</code>等</td><td>修改<code>.current</code>不会触发依赖监听（需手动配合<code>useState</code>/<code>useEffect</code>）</td></tr><tr><td><strong>初始值特性</strong></td><td>初始值仅在组件首次挂载时生效（后续渲染忽略）</td><td>初始值仅用于初始化<code>.current</code>，后续可自由修改</td></tr></tbody></table>
<h4 data-id="heading-58">二、关键差异拆解（结合代码示例）</h4>
<h5 data-id="heading-59">1. 数据修改是否触发渲染（最核心区别）</h5>
<ul>
<li>
<p><strong>useState</strong>：状态更新必然触发组件重渲染，这是它的核心设计目的——让页面跟随状态变化更新。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">StateDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'StateDemo 渲染了'</span>); <span class="hljs-comment">// 每次点击都会打印（重渲染）</span>
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;
      计数：{count}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
</li>
<li>
<p><strong>useRef</strong>：修改<code>.current</code>完全不触发渲染，数据仅在内存中更新，页面无感知。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">RefDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> countRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'RefDemo 渲染了'</span>); <span class="hljs-comment">// 仅首次挂载打印一次</span>
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
      countRef.current += 1; // 修改不触发渲染
      console.log('内存中的值：', countRef.current); // 控制台能看到值变化，但页面不变
    }}&gt;
      计数：{countRef.current} {/* 始终显示0，因为没渲染 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
</li>
</ul>
<h5 data-id="heading-60">2. 数据更新的“可变/不可变”特性</h5>
<ul>
<li>
<p><strong>useState</strong>：状态是“不可变”的，必须通过<code>setter</code>函数更新（不能直接修改原始值），React会用新值替换旧值。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 错误用法：直接修改state不会触发渲染</span>
<span class="hljs-keyword">const</span> [obj, setObj] = <span class="hljs-title function_">useState</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> });
obj.<span class="hljs-property">name</span> = <span class="hljs-string">'李四'</span>; <span class="hljs-comment">// 无效，页面不更新</span>
<span class="hljs-comment">// 正确用法：通过setter传递新对象</span>
<span class="hljs-title function_">setObj</span>({ ...obj, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span> }); <span class="hljs-comment">// 触发渲染</span>
</code></pre>
</li>
<li>
<p><strong>useRef</strong>：<code>.current</code>是“可变”的，可以直接修改（类似操作普通JS对象），无需特殊方法。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> objRef = <span class="hljs-title function_">useRef</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> });
objRef.<span class="hljs-property">current</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'李四'</span>; <span class="hljs-comment">// 直接修改生效，无需要setter</span>
</code></pre>
</li>
</ul>
<h5 data-id="heading-61">3. 依赖监听的差异</h5>
<p><code>useEffect</code>、<code>useCallback</code>等Hook会监听<code>useState</code>的状态变化，但不会监听<code>useRef.current</code>的变化：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">EffectDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> countRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 监听count：count变化时执行</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'count变了：'</span>, count);
  }, [count]);

  <span class="hljs-comment">// 监听countRef.current：永远不会执行（因为ref不是依赖项）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'countRef变了：'</span>, countRef.<span class="hljs-property">current</span>);
  }, [countRef.<span class="hljs-property">current</span>]); <span class="hljs-comment">// 无效！</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;修改state<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> countRef.current += 1}&gt;修改ref<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-62">三、适用场景（帮你快速选对Hook）</h4>
<h5 data-id="heading-63">用useState的场景（渲染相关）</h5>
<ul>
<li>页面需要展示的数据（如按钮文案、列表数据、表单输入值）；</li>
<li>需要触发UI更新的状态（如弹窗显隐、加载中状态、切换主题）；</li>
<li>依赖状态变化执行副作用的场景（如根据筛选条件请求数据）。</li>
</ul>
<h5 data-id="heading-64">用useRef的场景（非渲染相关）</h5>
<ul>
<li>存储DOM元素引用（如获取输入框焦点、操作DOM尺寸）；</li>
<li>存储跨生命周期的临时数据（如定时器ID、请求取消令牌）；</li>
<li>保存上一次的状态/属性值（如对比当前值和上一次值）；</li>
<li>存储无需页面展示的内存数据（如计算中间结果、缓存数据）。</li>
</ul>
<h4 data-id="heading-65">四、特殊场景：useRef + useState 结合使用</h4>
<p>如果需要“数据持久化且修改时触发渲染”，可以结合两者：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useRef, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CombineDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> countRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 持久化存储</span>
  <span class="hljs-keyword">const</span> [, forceRender] = <span class="hljs-title function_">useState</span>({}); <span class="hljs-comment">// 用于强制渲染</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
    countRef.<span class="hljs-property">current</span> += <span class="hljs-number">1</span>; <span class="hljs-comment">// 修改ref（不触发渲染）</span>
    <span class="hljs-title function_">forceRender</span>({}); <span class="hljs-comment">// 手动触发渲染（通过更新空对象）</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{increment}</span>&gt;</span>
      计数：{countRef.current} {/* 能正常更新 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-66">总结</h4>
<ol>
<li><strong>核心差异</strong>：<code>useState</code>管理渲染状态（更新触发重渲染），<code>useRef</code>存储持久化数据（更新不触发渲染）；</li>
<li><strong>使用原则</strong>：数据需要展示在页面上→用<code>useState</code>；数据仅在内存中使用→用<code>useRef</code>；</li>
<li><strong>更新特性</strong>：<code>useState</code>是不可变更新（需setter），<code>useRef</code>是可变更新（直接改<code>.current</code>）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uv-优点（1）]]></title>    <link>https://juejin.cn/post/7599708108621660211</link>    <guid>https://juejin.cn/post/7599708108621660211</guid>    <pubDate>2026-01-27T09:55:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599708108621660211" data-draft-id="7598287024077717544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uv-优点（1）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-27T09:55:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="花花无缺"/> <meta itemprop="url" content="https://juejin.cn/user/2021343967862435"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uv-优点（1）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2021343967862435/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    花花无缺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:55:49.000Z" title="Tue Jan 27 2026 09:55:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>uv是一个用 Rust 编写的、速度极快的 Python 包和项目管理器</p>
<h3 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2F%23_1" target="_blank" title="https://uv.oaix.tech/#_1" ref="nofollow noopener noreferrer">亮点</a></h3>
<ul>
<li>🚀 一个工具即可取代 <code>pip</code>、<code>pip-tools</code>、<code>pipx</code>、<code>poetry</code>、<code>pyenv</code>、<code>twine</code>、<code>virtualenv</code> 等。</li>
<li>⚡️ 比 <code>pip</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2Freference%2Fbenchmarks%2F" target="_blank" title="https://uv.oaix.tech/reference/benchmarks/" ref="nofollow noopener noreferrer">快 10-100 倍</a>。</li>
<li>🗂️ 提供<a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2F%23_3" target="_blank" title="https://uv.oaix.tech/#_3" ref="nofollow noopener noreferrer">全面的项目管理</a>，并带有<a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2Fconcepts%2Fprojects%2Flayout%2F%23_3" target="_blank" title="https://uv.oaix.tech/concepts/projects/layout/#_3" ref="nofollow noopener noreferrer">通用锁文件</a>。</li>
<li>❇️ <a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2F%23_4" target="_blank" title="https://uv.oaix.tech/#_4" ref="nofollow noopener noreferrer">运行脚本</a>，支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2Fguides%2Fscripts%2F%23_4" target="_blank" title="https://uv.oaix.tech/guides/scripts/#_4" ref="nofollow noopener noreferrer">内联依赖元数据</a>。</li>
<li>🐍 <a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2F%23python" target="_blank" title="https://uv.oaix.tech/#python" ref="nofollow noopener noreferrer">安装和管理</a> Python 版本。</li>
<li>🛠️ <a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2F%23_5" target="_blank" title="https://uv.oaix.tech/#_5" ref="nofollow noopener noreferrer">运行和安装</a> 作为 Python 包发布的工具。</li>
<li>🔩 包含一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2F%23pip" target="_blank" title="https://uv.oaix.tech/#pip" ref="nofollow noopener noreferrer">pip 兼容接口</a>，以熟悉的 CLI 提供性能提升。</li>
<li>🏢 支持 Cargo 风格的<a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2Fconcepts%2Fprojects%2Fworkspaces%2F" target="_blank" title="https://uv.oaix.tech/concepts/projects/workspaces/" ref="nofollow noopener noreferrer">工作区</a>，适用于可扩展项目。</li>
<li>💾 磁盘空间高效，具有用于依赖项去重的<a href="https://link.juejin.cn?target=https%3A%2F%2Fuv.oaix.tech%2Fconcepts%2Fcache%2F" target="_blank" title="https://uv.oaix.tech/concepts/cache/" ref="nofollow noopener noreferrer">全局缓存</a>。</li>
<li>⏬ 无需 Rust 或 Python，即可通过 <code>curl</code> 或 <code>pip</code> 安装。</li>
<li>🖥️ 支持 macOS、Linux 和 Windows。</li>
</ul>
<p>安装方式：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">macOS 和 Linux</span>]
curl -LsSf https:<span class="hljs-comment">//astral.sh/uv/install.sh | sh</span>

[<span class="hljs-meta">windows</span>]
powershell -ExecutionPolicy ByPass -c <span class="hljs-string">"irm https://astral.sh/uv/install.ps1 | iex"</span>
</code></pre>
<h2 data-id="heading-1">🛠️ 典型应用场景</h2>
<ol>
<li><strong>日常开发</strong>：用 <code>uv pip install</code> 极速安装依赖，替代 <code>pip install</code>。</li>
<li><strong>环境隔离</strong>：用 <code>uv venv</code> 一键创建虚拟环境，替代 <code>virtualenv</code>。</li>
</ol>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 创建虚拟环境</span>
uv venv  <span class="hljs-comment">#在 `.venv` 创建一个虚拟环境</span>
uv venv <span class="hljs-keyword">my</span>-name  <span class="hljs-comment">#在 `my-name` 创建一个虚拟环境</span>
uv venv --python <span class="hljs-number">3.11</span>  <span class="hljs-comment">#使用 Python 3.11 创建一个虚拟环境</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#激活虚拟环境</span>
[macOS 和 Linux]
<span class="hljs-built_in">source</span> .venv/bin/activate
[windows]
.venv\Scripts\activate

deactivate  <span class="hljs-comment"># 退出虚拟环境</span>
uv venv --seed  <span class="hljs-comment"># 强制安装基础包（如pip, setuptools, wheel）</span>
</code></pre>
<ol start="4">
<li><strong>版本管理</strong>：用 <code>uv python install</code> 安装和管理多版本 Python，替代 <code>pyenv</code>。</li>
<li><strong>依赖锁定</strong>：自动生成 <code>uv.lock</code>，确保团队依赖一致。
例如，在 Python 项目中，通常会用 <code>requirements.txt</code>（或 <code>pyproject.toml</code>）记录依赖，比如你写了：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">requests &gt;= 2.20.0  <span class="hljs-comment">#版本只要大于等于 2.20.0 就行</span>
</code></pre>
<p>这种 “依赖版本不固定，会导致<strong>依赖不可重现</strong>，项目在不同环境、不同时间运行结果不一致” 的问题：</p>
<blockquote>
<ul>
<li><strong>你本地的版本和别人不一样</strong>：你今天安装可能拿到 2.28.0，你的同事明天安装可能拿到 2.31.0（期间官方发布了新版本）。</li>
<li><strong>新版本可能有兼容问题</strong>：<code>requests</code> 2.31.0 可能修改了某个接口，导致你的项目在同事电脑上运行报错，而你本地却一切正常（“我的代码明明能跑，为什么你这不行？” 的经典场景）。</li>
<li><strong>跨环境不一致</strong>：你开发环境正常，部署到服务器上时，安装了更高版本的依赖，导致线上服务故障。</li>
</ul>
</blockquote>
<ul>
<li><code>uv.lock</code>:是 uv 生成的<strong>纯文本格式锁定文件</strong>，会记录下你当前环境中，所有依赖（包括主依赖、间接依赖）的「精确版本号」、下载来源、哈希值等信息，形成一份 “依赖快照”，可以把 “模糊依赖” 变成 “精确依赖”；<strong>它确保 “所有人安装的依赖完全一致”</strong> ：当其他人拿到你的项目后，只要有这份 <code>uv.lock</code>，用 uv 安装依赖时，uv 会<strong>严格按照锁定文件中的精确版本、哈希值来安装</strong>，不会去下载任何新版本，哪怕官方已经发布了更高版本的 <code>requests</code>；<strong>验证依赖完整性</strong>：锁定文件中的哈希值，可以验证下载的依赖包是否被篡改，避免安装恶意或损坏的包；用 uv 安装依赖后，uv 会自动生成 / 更新 <code>uv.lock</code>，里面不会有 <code>&gt;=</code>、<code>&lt;=</code> 这种模糊符号，全是精确版本，比如：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">    requests = { version = <span class="hljs-string">"2.28.2"</span>, <span class="hljs-built_in">source</span> = <span class="hljs-string">"pypi"</span>, <span class="hljs-built_in">hash</span> = <span class="hljs-string">"sha256:..."</span> }
    urllib3 = { version = <span class="hljs-string">"1.26.14"</span>, <span class="hljs-built_in">source</span> = <span class="hljs-string">"pypi"</span>, <span class="hljs-built_in">hash</span> = <span class="hljs-string">"sha256:..."</span> }
    （`urllib3` 是 `requests` 的间接依赖，没手动写，但它也会被精确记录）
</code></pre>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fuv" target="_blank" title="https://github.com/astral-sh/uv" ref="nofollow noopener noreferrer">github.com/astral-sh/u…</a><br/>
文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv%2F%3Fspm%3D5176.28103460.0.0.272f6308QrzTQc" target="_blank" title="https://docs.astral.sh/uv/?spm=5176.28103460.0.0.272f6308QrzTQc" ref="nofollow noopener noreferrer">docs.astral.sh/uv/</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[搭建基于react webview的vscode插件]]></title>    <link>https://juejin.cn/post/7599924965949603878</link>    <guid>https://juejin.cn/post/7599924965949603878</guid>    <pubDate>2026-01-27T10:11:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599924965949603878" data-draft-id="7599708108621512755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="搭建基于react webview的vscode插件"/> <meta itemprop="keywords" content="Visual Studio Code"/> <meta itemprop="datePublished" content="2026-01-27T10:11:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若愚79"/> <meta itemprop="url" content="https://juejin.cn/user/2649162517852320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            搭建基于react webview的vscode插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2649162517852320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若愚79
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:11:59.000Z" title="Tue Jan 27 2026 10:11:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">搭建基于react webview的vscode插件</h2>
<h3 data-id="heading-1">准备工作</h3>
<p>确保你本机安装了最新的vscode以及git和Node.js，如果没有，遵照下边官方链接下载安装。</p>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2FDownload" target="_blank" title="https://code.visualstudio.com/Download" ref="nofollow noopener noreferrer">vscode下载</a></h4>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Finstall%2Fwindows" target="_blank" title="https://git-scm.com/install/windows" ref="nofollow noopener noreferrer">git下载</a></h4>
<h4 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen%2Fdownload" target="_blank" title="https://nodejs.org/en/download" ref="nofollow noopener noreferrer">Node.js下载</a></h4>
<p>安装完成后可以在控制台看到类似如下信息。</p>
<pre><code class="hljs language-lua" lang="lua">PS C:\Users\xuruo&gt;code <span class="hljs-comment">--version</span>
<span class="hljs-number">1.108</span><span class="hljs-number">.0</span>
<span class="hljs-number">94e8</span>ae2b28cb5cc932b86e1070569c4463565c37
x64

PS C:\Users\xuruo&gt;git <span class="hljs-comment">--version</span>
git version <span class="hljs-number">2.42</span><span class="hljs-number">.0</span>.windows<span class="hljs-number">.2</span>

PS C:\Users\xuruo&gt;node <span class="hljs-comment">--version</span>
v22<span class="hljs-number">.12</span><span class="hljs-number">.0</span>

PS C:\Users\xuruo&gt;npm <span class="hljs-comment">--version</span>
<span class="hljs-number">10.9</span><span class="hljs-number">.0</span>
</code></pre>
<h3 data-id="heading-5">创建你的第一个vscode插件</h3>
<p>从cline的代码中可以看到他是从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fvscode-webview-ui-toolkit-samples%2Ftree%2Fmain%2Fframeworks%2Fhello-world-react-vite" target="_blank" title="https://github.com/microsoft/vscode-webview-ui-toolkit-samples/tree/main/frameworks/hello-world-react-vite" ref="nofollow noopener noreferrer">hello-world-ract-vite</a>作为基础开始构建的。
让我们从克隆minicline项目代码开始创建我们的第一个vscode插件项目。
minicline的第一个代码commit就是从拷贝hello-world-ract-vite代码开始的。</p>
<pre><code class="hljs language-bash" lang="bash">PS D:\git&gt; git <span class="hljs-built_in">clone</span> https://github.com/xuruoyu1979/minicline.git

PS D:\git&gt; git <span class="hljs-built_in">cd</span> miniclone

PS D:\git&gt; git checkout f1b5631dc1196a2b082165e603840870248ca5fc

PS D:\git\miniclone&gt; git npm run install:all
</code></pre>
<p>如果一切正常，会看到类似如下的输出。</p>
<pre><code class="hljs language-less" lang="less">&gt; <span class="hljs-selector-tag">hello-world-react-vite</span>@<span class="hljs-number">0.0</span><span class="hljs-selector-class">.1</span> <span class="hljs-selector-tag">install</span>:<span class="hljs-keyword">all</span>
&gt; <span class="hljs-selector-tag">npm</span> <span class="hljs-selector-tag">install</span> <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-tag">&amp;</span> <span class="hljs-selector-tag">cd</span> <span class="hljs-selector-tag">webview-ui</span> <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-tag">&amp;</span> <span class="hljs-selector-tag">npm</span> <span class="hljs-selector-tag">install</span>


<span class="hljs-selector-tag">added</span> <span class="hljs-number">182</span> <span class="hljs-selector-tag">packages</span>, <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">audited</span> <span class="hljs-number">183</span> <span class="hljs-selector-tag">packages</span> <span class="hljs-selector-tag">in</span> <span class="hljs-number">5s</span>
...
<span class="hljs-selector-tag">To</span> <span class="hljs-selector-tag">address</span> <span class="hljs-keyword">all</span> <span class="hljs-selector-tag">issues</span> (including breaking changes), <span class="hljs-selector-tag">run</span>:
  <span class="hljs-selector-tag">npm</span> <span class="hljs-selector-tag">audit</span> <span class="hljs-selector-tag">fix</span> <span class="hljs-selector-tag">--force</span>

<span class="hljs-selector-tag">Run</span> `<span class="hljs-selector-tag">npm</span> <span class="hljs-selector-tag">audit</span>` <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">details</span>.
</code></pre>
<h3 data-id="heading-6">编译webview</h3>
<pre><code class="hljs language-bash" lang="bash">PS D:\git\minicline&gt; npm run build:webview

&gt; hello-world-react-vite@0.0.1 build:webview
&gt; <span class="hljs-built_in">cd</span> webview-ui &amp;&amp; npm run build


&gt; hello-world@0.0.1 build
&gt; tsc &amp;&amp; vite build

vite v2.9.13 building <span class="hljs-keyword">for</span> production...
transforming (1) index.htmlBrowserslist: caniuse-lite is outdated. Please run:
  npx browserslist@latest --update-db
  Why you should <span class="hljs-keyword">do</span> it regularly: https://github.com/browserslist/browserslist<span class="hljs-comment">#browsers-data-updating</span>
...
✓ 319 modules transformed.
build/index.html         0.37 KiB
build/assets/index.css   0.10 KiB / gzip: 0.10 KiB
build/assets/index.js    308.26 KiB / gzip: 85.31 KiB
</code></pre>
<h3 data-id="heading-7">运行你的第一个插件</h3>
<p>克隆下来的minicline项目下已经自带了 <strong>.vscode/launch.json</strong> ，里边有运行vscode extension的配置，从vscode左侧 <strong>RUN and DEBUG</strong> 视图点击 <strong>Run Extension</strong> ，会启动一个新的vscode实例，里边已经加载了我们的minicline插件，用组合键 <strong>CTRL+SHIFT+P</strong> 打开命令窗口，在里边输入 <strong>Hello World</strong>, 找到 <strong>Hello World (React + Vite): Show</strong>命令，点击会打开新的webview显示在编辑器区域，如下图所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbaadd1b83124707b2ca4490576333cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5oSaNzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770113519&amp;x-signature=JtHcgYMN6Qauw2XSeAlNEbJrJ9k%3D" alt="chapter-1-1.png" loading="lazy"/>
点击 <strong>Howdy!</strong> 按钮，右下方会显示消息 <strong>Hey there partner! 🤠</strong></p>
<h3 data-id="heading-8">总结</h3>
<p>本章我们运行了第一个webview插件，webview相对于普通的vscode插件和普通的react webapp的区别在于，它是运行在独立的sandbox里边的，所以不同于运行在web browser和vscode extension host，它不能访问外部资源。所以需要访问外部数据需要通过和vscode extension host中运行的插件代码交互，比如本章中我们点击 <strong>Howdy!</strong> 按钮后vscode显示对应消息就是通过webview往vscode extension host发送消息实现的。</p>
<p>具体代码参考如下。</p>
<p><strong>webview-ui/src/App.tsx</strong></p>
<pre><code class="hljs language-php" lang="php">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleHowdyClick</span>(<span class="hljs-params"/>) </span>{
    vscode.<span class="hljs-title function_ invoke__">postMessage</span>({
      <span class="hljs-attr">command</span>: <span class="hljs-string">"hello"</span>,
      <span class="hljs-attr">text</span>: <span class="hljs-string">"Hey there partner! 🤠"</span>,
    });
  }
</code></pre>
<p><strong>src/panels/HelloWorldPanel.ts</strong></p>
<pre><code class="hljs language-typescript" lang="typescript">  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_setWebviewMessageListener</span>(<span class="hljs-params">webview: Webview</span>) {
    webview.<span class="hljs-title function_">onDidReceiveMessage</span>(
      <span class="hljs-function">(<span class="hljs-params">message: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> command = message.<span class="hljs-property">command</span>;
        <span class="hljs-keyword">const</span> text = message.<span class="hljs-property">text</span>;

        <span class="hljs-keyword">switch</span> (command) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">"hello"</span>:
            <span class="hljs-comment">// Code that should run in response to the hello message command</span>
            <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">showInformationMessage</span>(text);
            <span class="hljs-keyword">return</span>;
          <span class="hljs-comment">// Add more switch case statements here as more webview message commands</span>
          <span class="hljs-comment">// are created within the webview context (i.e. inside media/main.js)</span>
        }
      },
      <span class="hljs-literal">undefined</span>,
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_disposables</span>
    );
  }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS-如何在 Chrome 中实现小于 12px 的字体？]]></title>    <link>https://juejin.cn/post/7599798118461489161</link>    <guid>https://juejin.cn/post/7599798118461489161</guid>    <pubDate>2026-01-27T10:12:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599798118461489161" data-draft-id="7599708108621725747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS-如何在 Chrome 中实现小于 12px 的字体？"/> <meta itemprop="keywords" content="前端,面试,CSS"/> <meta itemprop="datePublished" content="2026-01-27T10:12:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS-如何在 Chrome 中实现小于 12px 的字体？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:12:12.000Z" title="Tue Jan 27 2026 10:12:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在前端开发中，设计师有时会给出 10px 甚至更小的字体设计。然而，Chrome 等 Chromium 核浏览器为了保证中文的可读性，默认限制了最小字号为 <strong>12px</strong>。本文将带你梳理解决这一限制的几种方案及其优缺点。</p>
<h2 data-id="heading-1">一、 为什么有这个限制？</h2>
<p><strong>背景：</strong> Chrome 中文版浏览器默认设定最小字号为 <code>12px</code>。这是因为在早期的显示器上，复杂的汉字如果小于 12px，笔画会由于像素点不足而挤在一起，导致难以辨认。虽然现在的视网膜屏幕（Retina）已经不存在这个问题，但这一规范被保留了下来。</p>
<hr/>
<h2 data-id="heading-2">二、 核心解决方案</h2>
<h3 data-id="heading-3">1. 推荐方案：Transform 缩放</h3>
<p>这是目前兼容性最好、也是最主流的方案。通过 <code>transform: scale()</code> 对元素进行整体缩放。</p>
<ul>
<li>
<p><strong>实现思路</strong>：</p>
<p>先设置字体为 <code>12px</code>，然后使用缩放属性将其缩小。</p>
</li>
<li>
<p><strong>核心代码</strong>：</p>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-selector-class">.small-font</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">display</span>: inline-block; <span class="hljs-comment">/* 注意：transform 仅对块级或行内块元素生效 */</span>
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.8333</span>); <span class="hljs-comment">/* 10px = 12px x 0.8333 */</span>
  <span class="hljs-attribute">transform-origin</span>: left center; <span class="hljs-comment">/* 关键：设置缩放中心，否则文字会向中心靠拢 */</span>
}
</code></pre>
</li>
<li>
<p><strong>优点</strong>：兼容性极佳，视觉效果平滑。</p>
</li>
<li>
<p><strong>缺点</strong>：缩放会占据原有的 12px 空间，可能导致边距看起来变大，需要手动调整偏移。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">2. SVG 矢量缩放方案</h3>
<p>如果你需要极其精准的字体渲染，可以利用 SVG 的 <code>text</code> 标签。</p>
<ul>
<li>
<p><strong>实现思路</strong>：</p>
<p>SVG 内部的文字不受浏览器最小字号限制。</p>
</li>
<li>
<p><strong>核心代码</strong>：</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"20"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"15"</span> <span class="hljs-attr">font-size</span>=<span class="hljs-string">"10"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"#000"</span>&gt;</span>我是10px文字<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>优点</strong>：渲染清晰，完全不受浏览器限制。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、 已失效或不推荐的方案（避坑指南）</h2>
<h3 data-id="heading-6">1. -webkit-text-size-adjust (已废除)</h3>
<ul>
<li><strong>现状</strong>：Chrome 27 以后已经废除。</li>
</ul>
<h3 data-id="heading-7">2. Zoom 方案</h3>
<ul>
<li><strong>现状</strong>：<code>zoom</code> 本质上是非标准的属性。</li>
<li><strong>副作用</strong>：<strong>Firefox 完全不支持</strong>。且 <code>zoom</code> 会引起复杂的重绘和重排，性能弱于 <code>transform</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-8">四、 总结与最佳实践</h2>























<table><thead><tr><th><strong>方案</strong></th><th><strong>推荐指数</strong></th><th><strong>优点</strong></th><th><strong>缺点</strong></th></tr></thead><tbody><tr><td><strong>Transform Scale</strong></td><td>⭐⭐⭐⭐⭐</td><td>兼容性高，性能好</td><td>需要处理 <code>transform-origin</code> 和空间占位</td></tr><tr><td><strong>SVG 渲染</strong></td><td>⭐⭐⭐</td><td>绝对精准</td><td>编写略显繁琐，不适合大段文字</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[资源池化设计指南]]></title>    <link>https://juejin.cn/post/7599860946836815935</link>    <guid>https://juejin.cn/post/7599860946836815935</guid>    <pubDate>2026-01-27T09:57:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599860946836815935" data-draft-id="7599634796583976966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="资源池化设计指南"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-27T09:57:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="温宇飞"/> <meta itemprop="url" content="https://juejin.cn/user/4300945219403368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            资源池化设计指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4300945219403368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    温宇飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:57:14.000Z" title="Tue Jan 27 2026 09:57:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>资源池化(Resource Pooling)是一种通过复用资源来优化系统性能的技术。频繁创建和销毁资源（如数据库连接、线程、对象实例）会带来显著的性能开销，池化通过维护可复用的资源集合来解决这一问题。本文介绍资源池化的核心概念、方案设计要素、内存分配策略，以及如何评价一个池化方案的优劣。</p>
<h2 data-id="heading-0">资源池化基础</h2>
<p>资源池化是一种资源管理模式，通过维护可复用的资源集合来避免频繁的创建和销毁开销。</p>
<h3 data-id="heading-1">什么是资源池化</h3>
<p>资源池化维护一个资源集合（池），当需要使用资源时从池中获取，使用完毕后归还到池中而不是销毁。核心思想是<strong>复用资源</strong>，避免重复的创建和销毁成本。</p>
<p>资源在池中的生命周期包括：</p>
<ul>
<li><strong>创建</strong>：池初始化时或按需创建</li>
<li><strong>获取</strong>：从池中取出使用</li>
<li><strong>归还</strong>：使用完毕放回池中</li>
<li><strong>销毁</strong>：池关闭或资源淘汰时</li>
</ul>
<h3 data-id="heading-2">为什么需要资源池化</h3>
<p>资源池化主要解决以下问题：</p>
<p><strong>1. 降低创建销毁开销</strong></p>
<p>创建和销毁资源通常涉及复杂的初始化过程：</p>
<ul>
<li>数据库连接：TCP 握手、身份验证、会话初始化</li>
<li>线程：内核态资源分配、栈空间分配</li>
<li>对象实例：内存分配、构造函数执行</li>
</ul>
<p>通过复用资源，避免频繁创建销毁带来的 CPU 和内存压力。对于某些资源（如 TCP 连接），池化还能保持连接活跃状态，避免重新握手等重复初始化开销。</p>
<p><strong>2. 控制资源使用</strong></p>
<p>通过设置资源上限防止资源耗尽：</p>
<ul>
<li>限制数据库并发连接数，避免数据库过载</li>
<li>限制线程数量，避免线程爆炸</li>
<li>限制内存对象数量，避免内存溢出</li>
</ul>
<p><strong>3. 支持热启动</strong></p>
<p>池可以在系统启动时创建资源，避免首次请求的冷启动延迟。例如数据库连接池在系统启动时建立连接，首次请求无需等待连接建立。</p>
<h3 data-id="heading-3">应用场景</h3>
<p>资源池化特别适用于以下场景：</p>






























<table><thead><tr><th>场景</th><th>典型应用</th><th>优化效果</th></tr></thead><tbody><tr><td><strong>数据库连接池</strong></td><td>MySQL、PostgreSQL 连接</td><td>避免 TCP 握手和身份验证，提升 10-100 倍性能</td></tr><tr><td><strong>线程池</strong></td><td>Web 服务器、任务调度</td><td>避免线程创建销毁开销，降低上下文切换</td></tr><tr><td><strong>对象池</strong></td><td>游戏引擎中的实体对象、粒子系统</td><td>减少 GC 压力，避免内存分配开销</td></tr><tr><td><strong>网络连接池</strong></td><td>HTTP 连接池、gRPC 连接池</td><td>复用 TCP 连接，减少握手延迟</td></tr></tbody></table>
<h2 data-id="heading-4">池化方案核心要素</h2>
<p>一个完整的池化方案需要明确资源的创建时机、池大小、获取归还策略和淘汰策略。</p>
<h3 data-id="heading-5">资源创建时机</h3>
<p>资源创建时机决定何时创建资源：</p>
<p><strong>预创建(Eager)</strong></p>
<p>池初始化时立即创建资源。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pool</span> {
    <span class="hljs-built_in">Pool</span>(<span class="hljs-type">size_t</span> initial_size) {
        <span class="hljs-comment">// 初始化时创建所有资源</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; initial_size; ++i) {
            resources_.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">CreateResource</span>());
        }
    }
};
</code></pre>
<p>优点：首次获取无延迟
缺点：启动时间长，可能浪费资源</p>
<p><strong>懒加载(Lazy)</strong></p>
<p>首次请求时才创建资源。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Resource* <span class="hljs-title">Pool::Acquire</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (free_list_.<span class="hljs-built_in">empty</span>()) {
        <span class="hljs-comment">// 按需创建</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">CreateResource</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">GetFromFreeList</span>();
}
</code></pre>
<p>优点：启动快，按需分配
缺点：首次请求有延迟</p>
<p><strong>混合模式</strong></p>
<p>初始化时创建部分资源，后续按需创建。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pool</span> {
    <span class="hljs-built_in">Pool</span>(<span class="hljs-type">size_t</span> min_size, <span class="hljs-type">size_t</span> max_size) {
        <span class="hljs-comment">// 创建最小数量</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; min_size; ++i) {
            resources_.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">CreateResource</span>());
        }
        max_size_ = max_size;
    }
};
</code></pre>
<h3 data-id="heading-6">池大小管理</h3>
<p>根据池大小的管理方式，可分为三种类型：</p>
<p><strong>静态池(Static Pool)</strong></p>
<p>初始化时创建固定数量的资源，运行期间不增减。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticPool</span> {
    std::array&lt;Resource, POOL_SIZE&gt; resources_;  <span class="hljs-comment">// 固定大小</span>
    std::vector&lt;<span class="hljs-type">size_t</span>&gt; free_indices_;
};
</code></pre>
<p>优点：实现简单，性能稳定
缺点：无法适应负载变化</p>
<p><strong>动态池(Dynamic Pool)</strong></p>
<p>根据实际需求动态创建和销毁资源。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicPool</span> {
    <span class="hljs-type">size_t</span> min_size_;   <span class="hljs-comment">// 最小池大小</span>
    <span class="hljs-type">size_t</span> core_size_;  <span class="hljs-comment">// 核心池大小</span>
    <span class="hljs-type">size_t</span> max_size_;   <span class="hljs-comment">// 最大池大小</span>

    <span class="hljs-function">Resource* <span class="hljs-title">Acquire</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (free_list_.<span class="hljs-built_in">empty</span>() &amp;&amp; total_size_ &lt; max_size_) {
            <span class="hljs-comment">// 动态扩容</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">CreateResource</span>();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">GetFromFreeList</span>();
    }
};
</code></pre>
<p>优点：灵活适应负载变化
缺点：维护复杂，性能波动</p>
<p><strong>分层池(Tiered Pool)</strong></p>
<p>将资源分为多个层级，每层有不同的优先级和管理策略。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TieredPool</span> {
    std::queue&lt;Resource*&gt; hot_pool_;   <span class="hljs-comment">// 热池：高优先级</span>
    std::queue&lt;Resource*&gt; cold_pool_;  <span class="hljs-comment">// 冷池：低优先级</span>

    <span class="hljs-function">Resource* <span class="hljs-title">Acquire</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (!hot_pool_.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-keyword">return</span> hot_pool_.<span class="hljs-built_in">front</span>();
        }
        <span class="hljs-keyword">return</span> cold_pool_.<span class="hljs-built_in">front</span>();
    }
};
</code></pre>
<p>优点：提高高频资源访问效率
缺点：实现复杂度高</p>
<h3 data-id="heading-7">获取策略</h3>
<p>当请求资源时的处理策略：</p>
<p><strong>阻塞等待(Blocking)</strong></p>
<p>如果池为空，阻塞等待直到有资源可用。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Resource* <span class="hljs-title">Pool::Acquire</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
    <span class="hljs-comment">// 阻塞等待</span>
    cv_.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>]{ <span class="hljs-keyword">return</span> !free_list_.<span class="hljs-built_in">empty</span>(); });
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">GetFromFreeList</span>();
}
</code></pre>
<p>适用场景：资源必须获取，可以接受等待</p>
<p><strong>超时等待(Timeout)</strong></p>
<p>等待指定时间后超时返回。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Resource* <span class="hljs-title">Pool::Acquire</span><span class="hljs-params">(std::chrono::milliseconds timeout)</span> </span>{
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
    <span class="hljs-keyword">if</span> (cv_.<span class="hljs-built_in">wait_for</span>(lock, timeout, [<span class="hljs-keyword">this</span>]{ <span class="hljs-keyword">return</span> !free_list_.<span class="hljs-built_in">empty</span>(); })) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">GetFromFreeList</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;  <span class="hljs-comment">// 超时返回 null</span>
}
</code></pre>
<p>适用场景：需要控制等待时间，避免无限阻塞</p>
<p><strong>快速失败(Fail Fast)</strong></p>
<p>如果池为空，立即返回错误。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Resource* <span class="hljs-title">Pool::Acquire</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
    <span class="hljs-keyword">if</span> (free_list_.<span class="hljs-built_in">empty</span>()) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;  <span class="hljs-comment">// 立即返回</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">GetFromFreeList</span>();
}
</code></pre>
<p>适用场景：高性能要求，不能接受等待</p>
<p><strong>动态扩容(Dynamic Expansion)</strong></p>
<p>池为空时创建新资源（不超过最大值）。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Resource* <span class="hljs-title">Pool::Acquire</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
    <span class="hljs-keyword">if</span> (free_list_.<span class="hljs-built_in">empty</span>() &amp;&amp; total_size_ &lt; max_size_) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">CreateResource</span>();  <span class="hljs-comment">// 动态创建</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">GetFromFreeList</span>();
}
</code></pre>
<p>适用场景：负载波动大，需要弹性扩容</p>
<h3 data-id="heading-8">归还策略</h3>
<p>资源使用完毕后的处理策略：</p>
<p><strong>状态重置</strong></p>
<p>清理资源状态，恢复到初始状态。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Pool::Release</span><span class="hljs-params">(Resource* resource)</span> </span>{
    resource-&gt;<span class="hljs-built_in">Reset</span>();  <span class="hljs-comment">// 重置状态</span>
    free_list_.<span class="hljs-built_in">push_back</span>(resource);
}
</code></pre>
<p><strong>健康检查</strong></p>
<p>验证资源是否仍然有效。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Pool::Release</span><span class="hljs-params">(Resource* resource)</span> </span>{
    <span class="hljs-keyword">if</span> (resource-&gt;<span class="hljs-built_in">IsHealthy</span>()) {
        free_list_.<span class="hljs-built_in">push_back</span>(resource);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">delete</span> resource;  <span class="hljs-comment">// 销毁损坏的资源</span>
        total_size_--;
    }
}
</code></pre>
<p><strong>超时清理</strong></p>
<p>如果资源被占用超过一定时间，强制回收。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Pool::CheckTimeout</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> now = std::chrono::steady_clock::<span class="hljs-built_in">now</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; [resource, acquire_time] : in_use_resources_) {
        <span class="hljs-keyword">if</span> (now - acquire_time &gt; timeout_) {
            <span class="hljs-built_in">ForceRelease</span>(resource);  <span class="hljs-comment">// 强制回收</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-9">淘汰策略</h3>
<p>移除池中资源的策略：</p>
<p><strong>空闲超时淘汰(Idle Timeout)</strong></p>
<p>资源空闲超过一定时间后移除。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Pool::EvictIdleResources</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> now = std::chrono::steady_clock::<span class="hljs-built_in">now</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = free_list_.<span class="hljs-built_in">begin</span>(); it != free_list_.<span class="hljs-built_in">end</span>();) {
        <span class="hljs-keyword">if</span> (now - it-&gt;last_use_time &gt; idle_timeout_) {
            <span class="hljs-keyword">delete</span> *it;
            it = free_list_.<span class="hljs-built_in">erase</span>(it);
        } <span class="hljs-keyword">else</span> {
            ++it;
        }
    }
}
</code></pre>
<p><strong>定期健康检查(Health Check)</strong></p>
<p>定期检查资源有效性，移除损坏资源。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Pool::HealthCheck</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = free_list_.<span class="hljs-built_in">begin</span>(); it != free_list_.<span class="hljs-built_in">end</span>();) {
        <span class="hljs-keyword">if</span> (!(*it)-&gt;<span class="hljs-built_in">IsHealthy</span>()) {
            <span class="hljs-keyword">delete</span> *it;
            it = free_list_.<span class="hljs-built_in">erase</span>(it);
        } <span class="hljs-keyword">else</span> {
            ++it;
        }
    }
}
</code></pre>
<p><strong>最少使用淘汰(LRU)</strong></p>
<p>当池满时，淘汰最久未使用的资源。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Pool::EvictLRU</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (total_size_ &gt; max_size_) {
        <span class="hljs-comment">// 按最后使用时间排序，淘汰最久未使用的</span>
        std::<span class="hljs-built_in">sort</span>(free_list_.<span class="hljs-built_in">begin</span>(), free_list_.<span class="hljs-built_in">end</span>(),
            [](Resource* a, Resource* b) {
                <span class="hljs-keyword">return</span> a-&gt;last_use_time &lt; b-&gt;last_use_time;
            });
        <span class="hljs-keyword">delete</span> free_list_.<span class="hljs-built_in">front</span>();
        free_list_.<span class="hljs-built_in">erase</span>(free_list_.<span class="hljs-built_in">begin</span>());
    }
}
</code></pre>
<p><strong>固定大小淘汰</strong></p>
<p>当资源数超过核心大小时，淘汰多余资源。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Pool::ShrinkToCore</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">while</span> (free_list_.<span class="hljs-built_in">size</span>() &gt; core_size_) {
        <span class="hljs-keyword">delete</span> free_list_.<span class="hljs-built_in">back</span>();
        free_list_.<span class="hljs-built_in">pop_back</span>();
    }
}
</code></pre>
<h2 data-id="heading-10">池化方案的内存设计</h2>
<p>从内存分配的角度，池化方案可分为栈式池化（池内连续存储）和堆式池化（堆上分散存储）。</p>
<h3 data-id="heading-11">栈式池化 vs 堆式池化</h3>








































<table><thead><tr><th>对比维度</th><th>栈式池化</th><th>堆式池化</th></tr></thead><tbody><tr><td><strong>内存位置</strong></td><td>池内连续内存（如 <code>std::deque&lt;T&gt;</code>）</td><td>堆上分散存储（每个资源独立分配）</td></tr><tr><td><strong>资源管理</strong></td><td>池维护所有资源（使用中 + 空闲）</td><td>池只维护空闲资源，使用中的资源在外部</td></tr><tr><td><strong>内存分配优化</strong></td><td>完全避免 malloc/free</td><td>仍需 malloc/free，但复用对象避免构造/析构</td></tr><tr><td><strong>CPU Cache</strong></td><td>内存连续，Cache 命中率高</td><td>内存分散，Cache 命中率低</td></tr><tr><td><strong>内存碎片</strong></td><td>无内存碎片</td><td>可能产生内存碎片</td></tr><tr><td><strong>外部访问方式</strong></td><td>返回索引或裸指针</td><td>返回裸指针或智能指针</td></tr></tbody></table>
<h3 data-id="heading-12">栈式池化的实现</h3>
<p>栈式池化将所有资源存储在池内的连续内存中。常用的实现方式有三种：</p>
<p><strong>方案 1：空闲索引 vector</strong></p>
<p>维护一个 vector 存储空闲资源的索引。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StackPool</span> {
    std::deque&lt;T&gt; objects_;          <span class="hljs-comment">// 所有资源（地址稳定）</span>
    std::vector&lt;<span class="hljs-type">size_t</span>&gt; free_list_;  <span class="hljs-comment">// 空闲资源索引</span>

<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 返回索引，外部通过索引访问资源</span>
    <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">Acquire</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (!free_list_.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-type">size_t</span> idx = free_list_.<span class="hljs-built_in">back</span>();
            free_list_.<span class="hljs-built_in">pop_back</span>();
            objects_[idx].<span class="hljs-built_in">Reset</span>();  <span class="hljs-comment">// 重置状态</span>
            <span class="hljs-keyword">return</span> idx;
        }
        <span class="hljs-comment">// 扩容</span>
        objects_.<span class="hljs-built_in">emplace_back</span>();
        <span class="hljs-keyword">return</span> objects_.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>;
    }

    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Release</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span> </span>{
        free_list_.<span class="hljs-built_in">push_back</span>(idx);
    }

    <span class="hljs-function">T&amp; <span class="hljs-title">Get</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span> </span>{ <span class="hljs-keyword">return</span> objects_[idx]; }
};
</code></pre>
<p>优点：实现简单，索引访问快速
缺点：需要额外的 vector 存储索引</p>
<p><strong>方案 2：内嵌式 freelist</strong></p>
<p>将空闲链表嵌入到资源内部，节省额外存储。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Slot</span> {
    <span class="hljs-built_in">alignas</span>(T) std::array&lt;std::byte, <span class="hljs-keyword">sizeof</span>(T)&gt; storage;
    <span class="hljs-type">size_t</span> next;  <span class="hljs-comment">// 使用中=自身索引, 空闲=下一个空闲索引</span>
};

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StackPool</span> {
    std::deque&lt;Slot&gt; slots_;
    <span class="hljs-type">size_t</span> free_head_ = INVALID;

<span class="hljs-keyword">public</span>:
    <span class="hljs-function">T* <span class="hljs-title">Acquire</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (free_head_ != INVALID) {
            <span class="hljs-type">size_t</span> idx = free_head_;
            free_head_ = slots_[idx].next;
            T* obj = std::<span class="hljs-built_in">launder</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;T*&gt;(&amp;slots_[idx].storage));
            obj-&gt;<span class="hljs-built_in">Reset</span>();
            <span class="hljs-keyword">return</span> obj;
        }
        <span class="hljs-comment">// 扩容并返回新对象</span>
        slots_.<span class="hljs-built_in">emplace_back</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> (&amp;slots_.<span class="hljs-built_in">back</span>().storage) <span class="hljs-built_in">T</span>();
    }

    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Release</span><span class="hljs-params">(T* obj)</span> </span>{
        <span class="hljs-type">size_t</span> idx = <span class="hljs-built_in">GetIndex</span>(obj);
        slots_[idx].next = free_head_;
        free_head_ = idx;
    }
};
</code></pre>
<p>优点：节省额外存储空间
缺点：需要使用 placement new，实现复杂</p>
<p><strong>方案 3：bitmap 标记</strong></p>
<p>使用位图标记资源是否空闲。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StackPool</span> {
    std::deque&lt;T&gt; objects_;
    std::vector&lt;<span class="hljs-type">bool</span>&gt; in_use_;  <span class="hljs-comment">// true=使用中, false=空闲</span>

<span class="hljs-keyword">public</span>:
    <span class="hljs-function">T* <span class="hljs-title">Acquire</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 查找第一个空闲资源</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; objects_.<span class="hljs-built_in">size</span>(); ++i) {
            <span class="hljs-keyword">if</span> (!in_use_[i]) {
                in_use_[i] = <span class="hljs-literal">true</span>;
                objects_[i].<span class="hljs-built_in">Reset</span>();
                <span class="hljs-keyword">return</span> &amp;objects_[i];
            }
        }
        <span class="hljs-comment">// 扩容</span>
        objects_.<span class="hljs-built_in">emplace_back</span>();
        in_use_.<span class="hljs-built_in">push_back</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-keyword">return</span> &amp;objects_.<span class="hljs-built_in">back</span>();
    }

    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Release</span><span class="hljs-params">(T* obj)</span> </span>{
        <span class="hljs-type">size_t</span> idx = <span class="hljs-built_in">GetIndex</span>(obj);
        in_use_[idx] = <span class="hljs-literal">false</span>;
    }
};
</code></pre>
<p>优点：状态清晰，易于调试
缺点：获取资源需要遍历，O(n) 复杂度</p>
<h3 data-id="heading-13">堆式池化的实现</h3>
<p>堆式池化将资源分配在堆上，池只维护空闲资源的指针。</p>
<p><strong>实现方式：返回智能指针（自动归还）</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HeapPool</span> {
    std::queue&lt;std::unique_ptr&lt;T&gt;&gt; free_resources_;
    std::mutex mutex_;

<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">using</span> Deleter = std::function&lt;<span class="hljs-built_in">void</span>(T*)&gt;;
    <span class="hljs-keyword">using</span> PoolPtr = std::unique_ptr&lt;T, Deleter&gt;;

    <span class="hljs-comment">// 返回智能指针，析构时自动归还</span>
    <span class="hljs-function">PoolPtr <span class="hljs-title">Acquire</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;
        T* ptr = <span class="hljs-literal">nullptr</span>;
        <span class="hljs-keyword">if</span> (!free_resources_.<span class="hljs-built_in">empty</span>()) {
            ptr = free_resources_.<span class="hljs-built_in">front</span>().<span class="hljs-built_in">release</span>();
            free_resources_.<span class="hljs-built_in">pop</span>();
        } <span class="hljs-keyword">else</span> {
            ptr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">T</span>();  <span class="hljs-comment">// 堆上分配</span>
        }

        <span class="hljs-comment">// 自定义 deleter，归还到池而不是 delete</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">PoolPtr</span>(ptr, [<span class="hljs-keyword">this</span>](T* p) {
            std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(mutex_);
            free_resources_.<span class="hljs-built_in">push</span>(std::<span class="hljs-built_in">unique_ptr</span>&lt;T&gt;(p));
        });
    }
};
</code></pre>
<p>优点：使用方便，自动归还，支持 RAII
缺点：仍需 malloc/free，内存分散</p>
<h3 data-id="heading-14">选择建议</h3>








































<table><thead><tr><th>判断维度</th><th>栈式池化</th><th>堆式池化</th></tr></thead><tbody><tr><td><strong>对象大小</strong></td><td>小对象（&lt; 1KB）</td><td>大对象（&gt; 1KB）</td></tr><tr><td><strong>对象类型</strong></td><td>值类型、非多态、POD</td><td>多态对象、继承体系</td></tr><tr><td><strong>地址稳定性</strong></td><td>不需要稳定地址</td><td>需要稳定地址（地址作为 key 或被引用）</td></tr><tr><td><strong>所有权管理</strong></td><td>资源所有权归池</td><td>资源所有权在使用方</td></tr><tr><td><strong>性能要求</strong></td><td>高性能要求（连续内存，Cache 友好）</td><td>性能要求一般</td></tr><tr><td><strong>实现复杂度</strong></td><td>复杂（需要管理索引/空闲列表）</td><td>简单（直接管理指针）</td></tr></tbody></table>
<h2 data-id="heading-15">池化方案的评价标准</h2>
<p>评价池化方案需要从性能、可靠性、资源利用率、淘汰率等多个维度综合考量。</p>
<h3 data-id="heading-16">性能指标</h3>
<p><strong>响应时间(Response Time)</strong></p>
<p>获取资源的平均耗时和 P99 耗时。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 测量响应时间</span>
<span class="hljs-keyword">auto</span> start = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();
<span class="hljs-keyword">auto</span> resource = pool.<span class="hljs-built_in">Acquire</span>();
<span class="hljs-keyword">auto</span> end = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();
<span class="hljs-keyword">auto</span> latency = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::microseconds&gt;(end - start);
</code></pre>
<p><strong>吞吐量(Throughput)</strong></p>
<p>单位时间内完成的资源获取/归还次数。</p>
<ul>
<li>静态池：吞吐量稳定，受池大小限制</li>
<li>动态池：吞吐量波动，受动态分配影响</li>
<li>分层池：热池吞吐量高，冷池吞吐量低</li>
</ul>
<p><strong>延迟抖动(Latency Jitter)</strong></p>
<p>响应时间的波动程度，影响系统稳定性。</p>
<ul>
<li>静态池延迟稳定</li>
<li>动态池可能因扩容/淘汰产生延迟峰值</li>
</ul>
<h3 data-id="heading-17">可靠性指标</h3>
<p><strong>容错能力(Fault Tolerance)</strong></p>
<p>资源损坏或连接断开时的处理能力。</p>
<ul>
<li><strong>健康检查</strong>：获取时验证资源有效性</li>
<li><strong>自动重建</strong>：损坏资源自动替换为新资源</li>
<li><strong>降级策略</strong>：池耗尽时的备选方案</li>
</ul>
<p><strong>并发安全(Concurrency Safety)</strong></p>
<p>多线程环境下的正确性。</p>
<ul>
<li>使用 mutex/lock 保证线程安全</li>
<li>避免死锁和竞态条件</li>
<li>使用 lock-free 数据结构提升性能</li>
</ul>
<p><strong>资源泄漏防护(Leak Protection)</strong></p>
<p>防止资源未归还导致的泄漏。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// RAII 包装防止泄漏</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PoolGuard</span> {
    Pool&amp; pool_;
    Resource* resource_;
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">PoolGuard</span>(Pool&amp; pool) : <span class="hljs-built_in">pool_</span>(pool), <span class="hljs-built_in">resource_</span>(pool.<span class="hljs-built_in">Acquire</span>()) {}
    ~<span class="hljs-built_in">PoolGuard</span>() { <span class="hljs-keyword">if</span> (resource_) pool_.<span class="hljs-built_in">Release</span>(resource_); }
    <span class="hljs-function">Resource* <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> resource_; }
};
</code></pre>
<ul>
<li>使用 RAII 包装资源</li>
<li>超时自动回收机制</li>
<li>监控未归还资源的数量和持有时间</li>
</ul>
<h3 data-id="heading-18">资源利用率指标</h3>
<p><strong>池利用率(Pool Utilization) 与 空闲率(Idle Rate)</strong></p>
<p>两个互补的指标，用于评估池的资源使用情况。</p>
<p>计算公式：</p>
<ul>
<li><code>池利用率 = 使用中的资源数 / 总资源数</code></li>
<li><code>空闲率 = 空闲资源数 / 总资源数</code></li>
</ul>























<table><thead><tr><th>指标</th><th>关注问题</th><th>过低的影响</th><th>过高的影响</th></tr></thead><tbody><tr><td><strong>池利用率</strong></td><td>资源是否被充分使用</td><td>资源浪费，池大小设置过大</td><td>资源紧张，可能需要扩容</td></tr><tr><td><strong>空闲率</strong></td><td>是否有足够的空闲资源应对新请求</td><td>资源紧张，获取可能等待</td><td>资源闲置，可以淘汰部分资源</td></tr></tbody></table>
<p><strong>命中率(Hit Rate)</strong></p>
<p>从池中成功获取资源的比例（不需要创建新资源）。</p>
<p>计算公式：<code>命中率 = 从池中获取次数 / 总获取次数</code></p>
<ul>
<li>静态池命中率稳定</li>
<li>动态池命中率受负载影响</li>
</ul>
<p><strong>淘汰频率(Eviction Frequency)</strong></p>
<p>单位时间内淘汰的资源数量。反映资源的复用效率。</p>
<ul>
<li><strong>淘汰频率低</strong>：资源被长期复用，池化效果好</li>
<li><strong>淘汰频率高</strong>：资源频繁创建销毁，池化效果差</li>
</ul>
<p>需要结合空闲率评估：淘汰频率低且空闲率低为理想状态，说明资源被充分使用。</p>
<p><strong>内存占用(Memory Footprint)</strong></p>
<p>池占用的总内存大小。</p>
<ul>
<li>栈式池化：内存占用 = 池大小 × 资源大小</li>
<li>堆式池化：内存占用 = 空闲资源数 × 资源大小</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂RPC、gRPC与Protobuf：分布式通信的核心技术栈]]></title>    <link>https://juejin.cn/post/7599496293161828393</link>    <guid>https://juejin.cn/post/7599496293161828393</guid>    <pubDate>2026-01-26T04:00:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599496293161828393" data-draft-id="7598899986856820742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂RPC、gRPC与Protobuf：分布式通信的核心技术栈"/> <meta itemprop="keywords" content="后端,gRPC,protobuf"/> <meta itemprop="datePublished" content="2026-01-26T04:00:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="stark张宇"/> <meta itemprop="url" content="https://juejin.cn/user/1983974643871069"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂RPC、gRPC与Protobuf：分布式通信的核心技术栈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1983974643871069/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    stark张宇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T04:00:50.000Z" title="Mon Jan 26 2026 04:00:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在分布式系统中，不同服务间的高效通信是核心需求之一。RPC、gRPC与Protobuf作为一套协同工作的技术组合，广泛应用于微服务、跨语言通信等场景。本文将逐一拆解三者的核心概念、工作原理，并重点分析RPC与HTTP的差异，帮助大家理清技术选型逻辑。</p>
<h3 data-id="heading-0">一、RPC：远程过程调用的核心范式</h3>
<h4 data-id="heading-1"><strong>什么是RPC</strong></h4>
<p>RPC 是一种编程思想，是一种跨进程通信协议，把在不同服务之间的通信变得高效和简单，全称是远程过程调用（Remote Procedure Call ），其核心思想是“像调用本地方法一样调用远程服务的方法”，调用另一个远程项目（服务提供者）的接口，而不需要了解数据的传输处理过程和底层网络的通信细节，让程序员专注于业务逻辑，快速开发分布式、微服务系统。</p>
<h4 data-id="heading-2"><strong>RPC的核心原理与流程</strong></h4>
<p>一次完整的RPC调用流程包含以下步骤，涉及客户端（调用方）和服务端（提供方）的协同工作：</p>
<ol start="0">
<li><strong>客户端调用本地代理（Stub）</strong> ：客户端将远程方法调用参数传递给本地Stub（类似“代理类”），Stub负责后续的通信封装。</li>
<li><strong>参数序列化</strong>：Stub将调用参数（如对象、基本类型）转换为可在网络中传输的二进制数据（序列化），避免因数据格式不兼容导致的通信问题。</li>
<li><strong>网络传输</strong>：通过底层网络协议（如TCP、UDP）将序列化后的二进制数据发送到服务端。</li>
<li><strong>服务端Stub反序列化</strong>：服务端Stub接收数据后，将二进制数据还原为原始参数（反序列化）。</li>
<li><strong>调用服务端本地方法</strong>：服务端Stub调用对应的本地业务方法，执行核心逻辑并获取返回结果。</li>
<li><strong>结果序列化与回传</strong>：服务端Stub将方法返回结果序列化，通过网络传输回客户端。</li>
<li><strong>客户端处理结果</strong>：客户端Stub反序列化返回数据，将结果传递给客户端业务代码，完成一次远程调用。</li>
</ol>
<p><strong>有了Http为啥还有RPC？</strong> Http的本质是基于请求-响应模式的应用层网络通信协议，而Rpc是远程调用本地化的一种思想，主流的RPC大多采用基于Tcp的二进制格式，传送的数据更紧凑，传送的效率也更高效。一般来说，常用于浏览器与服务器、跨服务接口调用（如RESTful API）。而Rpc更适合服务间的内部通信，RPC与HTTP虽都可用于跨服务通信，但设计目标、特性差异显著。</p>
<p>还有一点补充的是RPC并非与HTTP对立，部分RPC框架（如gRPC）底层基于HTTP/2实现，本质是“用HTTP/2作为传输载体的RPC协议”，兼顾了RPC的易用性和HTTP/2的高效特性。</p>
<h4 data-id="heading-3"><strong>远程调用过程面临的问题?</strong></h4>
<p><strong>1.Call ID映射。</strong></p>
<p>我们怎么告诉远程机器我们要调用的函数ID呢?再本地调用中，函数体是直接通过指针来指定的，我们调用function，编译器就自动帮我们调用它相应的函数指针。</p>
<p>但是在远程调用中，函数指针是不行的，因为两个进程的地址空间是完全不一样的。所以，再RPC中，所有的函数都必须有自己的一个ID。这个ID在所有的进程中都是唯一确定的。客户端在做远程调用时，必须附上这个ID。然后还需要再客户端和服务端分别维护一个{函数 &lt;--&gt; Call ID}的对应表。两者的表不一定需要完全相同，但相同函数对应的Call ID必须相同。</p>
<p>当客户端需要进行远程调用时，它就查一下这个表，找出相应的Call ID,然后把它传给服务端，服务端也通过查表，来确定客户端需要调用的函数，然后执行相应的函数的代码。</p>
<p><strong>2.序列化和反序列化</strong></p>
<p>客户端怎么把参数值传给远程函数呢?在本地调用中，我们只需要把参数压到栈里，然后让函数自己去栈里读就行。但是在远程过程调用时，客户端跟服务端是不同的进程，不能通过内存来传递参数。甚至有时候客户端和服务端使用的不是同一种编程语言，这时候就需要客户端和服务端把参数先转成一个字节流，传给服务端后再把字节流转成自己能读懂的格式，这个过程叫做序列化和反序列化。</p>
<p><strong>3.网络传输</strong></p>
<p>远程调用往往用在网络上，客户端和服务端是通过网络连接的。所有的数据都需要通过网络传输，因此就需要一个网络传输层。网络传输层需要把Call ID和序列化后的参数字节流传给服务端，然后在把序列化后的调用结果返回客户端，只要能完成这两者的，都可以作为传输层使用。</p>
<p>因此，它所使用的协议其实是不限的，能完成传输就行。尽管大部分Rpc框架都使用Tcp协议，但其实Udp也可以，gRPC干脆使用了Http2。</p>
<h3 data-id="heading-4">二、Protobuf：高效的序列化协议</h3>
<p>Protobuf（Protocol Buffers）是Google开源的一种<strong>语言无关、平台无关、可扩展</strong>的二进制序列化协议，用于将结构化数据序列化为紧凑的二进制格式，适用于数据存储、通信协议等场景。它是gRPC的默认序列化协议，也是目前高性能RPC通信的首选序列化方案之一。</p>
<h4 data-id="heading-5">Protobuf的核心特性</h4>
<ul>
<li><strong>高效紧凑</strong>：采用二进制编码，序列化后的数据体积远小于JSON/XML，解析速度更快（比JSON快3-5倍甚至更高），减少网络传输开销和解析耗时。</li>
<li><strong>跨语言/跨平台</strong>：支持Java、Go、Python、C++等多种语言，可在不同平台（Windows、Linux、Mac）间无缝传输数据，适配跨语言RPC场景。</li>
<li><strong>可扩展性强</strong>：支持字段的新增和废弃，且向后兼容（旧版本程序可解析新版本数据，新版本程序可兼容旧版本数据），无需担心接口升级导致的兼容性问题。</li>
<li><strong>强类型约束</strong>：通过IDL定义数据结构，编译后生成对应语言的代码，强制数据类型校验，避免因类型不匹配导致的异常，提升代码健壮性。</li>
</ul>
<h4 data-id="heading-6"><strong>我们为什么需要 protoc和protoc-gen-go？</strong></h4>
<p><code>proto</code> 文件本质上是<strong>纯文本的协议定义</strong>，比如定义了消息结构、字段类型、服务接口等，它只是一份 “设计图纸”—— 计算机无法直接识别和使用这份图纸，必须把它转换成对应编程语言（比如 Go）的可执行代码，才能在程序中实现序列化、反序列化、网络通信等功能。</p>
<p>而 protoc 和 protoc-gen-go 就是完成 “图纸转代码” 这个核心任务的工具，二者分工协作，缺一不可。</p>
<p>protoc 要执行的就是把Protobuf文件生成对应语言的源码 ，而protoc-gen-go 是生成Go语言的源码</p>
<p>由于你的 <code>protoc</code> 版本是 3.15.5，直接安装最新版插件会出现版本不兼容问题，因此需要指定适配的版本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 protoc-gen-go（适配 3.15.5 的版本）</span>
go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.27.1

<span class="hljs-comment"># 安装 protoc-gen-go-grpc（适配 3.15.5 的版本）</span>
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.1.0

<span class="hljs-comment"># 查看 protoc-gen-go 版本</span>
protoc-gen-go --version
<span class="hljs-comment"># 查看 protoc-gen-go-grpc 版本</span>
protoc-gen-go-grpc --version
</code></pre>
<p><code>protoc</code>的基础命令格式，参数解释：</p>
<ul>
<li><code>-I .</code>：指定 proto 文件的搜索目录（当前目录）。</li>
<li><code>--go_out=.</code>：指定基础 Protobuf 代码生成到当前目录。</li>
<li><code>--go_opt=paths=source_relative</code>：按 proto 文件的相对路径生成 Go 文件（避免生成多层嵌套目录，新手友好）。</li>
<li><code>--go-grpc_out=.</code>：指定 gRPC 代码生成到当前目录。</li>
<li><code>--go-grpc_opt=paths=source_relative</code>：同上，保证 gRPC 代码和 proto 文件路径对应。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第一步：生成基础的 Protobuf Go 代码</span>
protoc -I . helloworld.proto --go_out=. --go_opt=paths=source_relative

<span class="hljs-comment"># 第二步：生成 gRPC 相关的 Go 代码</span>
protoc -I . helloworld.proto --go-grpc_out=. --go-grpc_opt=paths=source_relative
</code></pre>
<h4 data-id="heading-7">Protobuf 文件的编写</h4>
<p>protobuf 标量类型是最基础的数据类型，以下是 proto3 核心标量类型与 Go/Python/PHP 的精准映射（重点标注易踩坑的差异）：</p>





















































































































<table><thead><tr><th>Protobuf 类型</th><th>Go 类型</th><th>Python 类型</th><th>PHP 类型</th><th>备注说明</th></tr></thead><tbody><tr><td>double</td><td>float64</td><td>float</td><td>float</td><td>64 位浮点数</td></tr><tr><td>float</td><td>float32</td><td>float</td><td>float</td><td>32 位浮点数</td></tr><tr><td>int32</td><td>int32</td><td>int</td><td>int</td><td>有符号 32 位整型，可变长编码</td></tr><tr><td>int64</td><td>int64</td><td>int</td><td>string</td><td>PHP 64 位整型易溢出，映射为字符串避免问题</td></tr><tr><td>uint32</td><td>uint32</td><td>int</td><td>int</td><td>无符号 32 位整型，可变长编码</td></tr><tr><td>uint64</td><td>uint64</td><td>int</td><td>string</td><td>同上，PHP 映射为字符串</td></tr><tr><td>sint32</td><td>int32</td><td>int</td><td>int</td><td>有符号可变长编码（负数更高效）</td></tr><tr><td>sint64</td><td>int64</td><td>int</td><td>string</td><td>有符号可变长编码（负数更高效）</td></tr><tr><td>fixed32</td><td>uint32</td><td>int</td><td>int</td><td>固定 4 字节编码，大数更高效</td></tr><tr><td>fixed64</td><td>uint64</td><td>int</td><td>string</td><td>固定 8 字节编码</td></tr><tr><td>sfixed32</td><td>int32</td><td>int</td><td>int</td><td>有符号固定 4 字节编码</td></tr><tr><td>sfixed64</td><td>int64</td><td>int</td><td>string</td><td>有符号固定 8 字节编码</td></tr><tr><td>bool</td><td>bool</td><td>bool</td><td>bool</td><td>布尔值</td></tr><tr><td>string</td><td>string</td><td>str</td><td>string</td><td>UTF-8 编码，长度 ≤ 2^32-1</td></tr><tr><td>bytes</td><td>[]byte</td><td>bytes</td><td>string</td><td>PHP 无原生 bytes 类型，用 string 存二进制</td></tr></tbody></table>
<p><strong>1.proto 简单示例</strong></p>
<pre><code class="hljs language-bash" lang="bash">syntax = <span class="hljs-string">"proto3"</span>; // 必须放在第一行，声明使用proto3语法

// 展示基本类型和默认值的message
message BasicTypeDemo {
  int32 age = 1;          // 默认值：0
  string name = 2;        // 默认值：空字符串
  bool is_student = 3;    // 默认值：<span class="hljs-literal">false</span>
  double score = 4;       // 默认值：0.0
  bytes avatar = 5;       // 默认值：空字节数组
}
</code></pre>
<p><strong>2.option go_package 的作用:</strong> <code>option go_package</code> 是 Go 语言专属的编译选项，核心作用是<strong>指定生成的 Go 代码的包路径和包名</strong>，解决 Go 模块模式下的代码导入冲突问题。</p>
<p>语法格式：<code>option go_package = "模块路径/子目录;包名";</code></p>
<ul>
<li>分号前：生成的 Go 文件存放的<strong>模块相对路径</strong>（如 <code>github.com/yourname/proto-demo/pb</code>）；</li>
<li>分号后：生成的 Go 代码的<strong>包名</strong>（省略则用目录名）。</li>
</ul>
<p>编译时：<code>protoc</code> 会根据该选项自动将生成的<code>.go</code>文件放到指定路径，并设置正确的包名。</p>
<pre><code class="hljs language-bash" lang="bash">syntax = <span class="hljs-string">"proto3"</span>;

// 假设你的Go模块名是 github.com/yourname/proto-demo
// 生成的Go代码会放到 ./pb 目录下，包名是 pb
option go_package = <span class="hljs-string">"github.com/yourname/proto-demo/pb;pb"</span>;

message User {
  string username = 1;
}
</code></pre>
<p><strong>3. proto 文件的 import 导入</strong></p>
<p><code>import</code> 用于复用其他 proto 文件中定义的 message、枚举等结构，是 Protobuf 实现代码复用的核心方式：</p>
<ul>
<li>普通导入：<code>import "路径/文件名.proto";</code>，仅当前文件可使用导入的结构；</li>
<li>公共导入：<code>import public "路径/文件名.proto";</code>，当前文件和导入当前文件的其他文件都能使用；</li>
<li>导入路径：支持相对路径（如 <code>./common.proto</code>）或绝对路径（需配合<code>protoc</code>的<code>-I</code>参数指定根目录）。</li>
</ul>
<p><strong>被导入文件：common.proto</strong></p>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";
option go_package = "github.com/yourname/proto-demo/pb;pb";

// 供其他文件复用的枚举
enum Gender {
  GENDER_UNSPECIFIED = 0;
  GENDER_MALE = 1;
  GENDER_FEMALE = 2;
}
</code></pre>
<p><strong>主文件：import_demo.proto</strong></p>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";
option go_package = "github.com/yourname/proto-demo/pb;pb";

// 导入common.proto，复用Gender枚举
import "./common.proto";

message User {
  string name = 1;
  Gender gender = 2; // 使用导入的枚举
}
</code></pre>
<p><strong>4.message 对象和 message 对象的嵌套</strong></p>
<p><code>message</code> 是 Protobuf 定义结构化数据的核心单元（类似 Go 的<code>struct</code>），支持两种嵌套方式：</p>
<ul>
<li><strong>内部嵌套</strong>：在一个 message 内定义子 message，仅能通过外部 message 的作用域访问（如 <code>Outer.Inner</code>）；</li>
<li><strong>外部嵌套</strong>：在一个 message 中直接引用其他已定义的 message 作为字段类型（同文件 / 导入的均可）；</li>
<li><code>repeated</code> 关键字：表示字段是数组 / 切片类型（默认空数组）。</li>
</ul>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";
option go_package = "github.com/yourname/proto-demo/pb;pb";

// 外部message（供嵌套引用）
message Phone {
  string number = 1;
  string type = 2; // 如"mobile"、"home"
}

// 主message，包含内部嵌套和外部引用
message UserProfile {
  string username = 1;

  // 内部嵌套message（仅UserProfile可用）
  message ExtraInfo {
    string hobby = 1;
    string signature = 2;
  }

  repeated Phone phones = 2; // 外部嵌套：引用Phone，repeated表示数组
  ExtraInfo extra_info = 3;  // 内部嵌套：使用ExtraInfo
}
</code></pre>
<p><strong>5.枚举类型</strong></p>
<p><code>enum</code> 用于定义命名常量，proto3 有严格规范：</p>
<ol>
<li>第一个枚举值必须为 0（作为默认值），通常命名为<code>XXX_UNSPECIFIED</code>；</li>
<li>可通过<code>option allow_alias = true;</code>开启别名（多个常量映射同一数值）；</li>
<li>枚举可定义在 message 内部（局部可用）或外部（全局可用）；</li>
<li>枚举字段的默认值是第一个值（值为 0 的常量）。</li>
</ol>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";
option go_package = "github.com/yourname/proto-demo/pb;pb";

// 开启别名功能
option allow_alias = true;

// 外部枚举（全局可用）
enum OrderStatus {
  ORDER_STATUS_UNSPECIFIED = 0; // 默认值
  ORDER_STATUS_PENDING = 1;
  ORDER_STATUS_PAID = 2;
  ORDER_STATUS_CONFIRMED = 2;   // 别名：PAID和CONFIRMED都对应2
}

// 内部枚举（仅Order内可用）
message Order {
  enum PaymentMethod {
    PAYMENT_METHOD_UNSPECIFIED = 0;
    PAYMENT_METHOD_ALIPAY = 1;
    PAYMENT_METHOD_WECHAT = 2;
  }

  PaymentMethod payment_method = 1; // 内部枚举
  OrderStatus status = 2;           // 外部枚举
}
</code></pre>
<h3 data-id="heading-8">三、gRPC：基于HTTP/2和Protobuf的RPC框架</h3>
<p>gRPC是Google开源的高性能跨语言RPC框架，基于HTTP/2协议传输，默认使用Protobuf作为序列化协议，完美结合了HTTP/2的高效传输能力和Protobuf的紧凑序列化优势，同时支持多种调用模式和跨语言部署。</p>
<h4 data-id="heading-9">gRPC 流模式</h4>
<p>GRPC 基于 HTTP/2 实现了四种通信模式，其中<strong>流模式</strong>是区别于传统 “一次请求一次响应” 的核心特性，分为三类：</p>
<p><strong>服务器流 RPC</strong>：客户端发送 1 个请求 → 服务器流式返回多个响应（如实时日志推送、数据分页返回）。</p>
<p><strong>客户端流 RPC</strong>：客户端流式发送多个请求 → 服务器返回 1 个响应（如批量数据上传后返回汇总结果）。</p>
<p><strong>双向流 RPC</strong>：客户端和服务器双向流式通信，双方可独立发送 / 接收数据（如即时聊天、实时音视频指令交互）。</p>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";

option go_package = "./pb;pb"; // 生成的Go代码路径

// 流模式演示服务
service StreamService {
  // 1. 服务器流RPC：客户端发请求，服务端返回流
  rpc ServerStream(StreamRequest) returns (stream StreamResponse);
  
  // 2. 客户端流RPC：客户端发流，服务端返回单个响应
  rpc ClientStream(stream StreamRequest) returns (StreamResponse);
  
  // 3. 双向流RPC：双向流式通信
  rpc BidirectionalStream(stream StreamRequest) returns (stream StreamResponse);
}

// 请求结构
message StreamRequest {
  string message = 1;
  int32 id = 2;
}

// 响应结构
message StreamResponse {
  string reply = 1;
  int32 code = 2;
}
</code></pre>
<p>服务端实现（server.go）</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"context"</span>
  <span class="hljs-string">"fmt"</span>
  <span class="hljs-string">"log"</span>
  <span class="hljs-string">"net"</span>
  <span class="hljs-string">"time"</span>

  <span class="hljs-string">"google.golang.org/grpc"</span>
  pb <span class="hljs-string">"your-project-path/pb"</span> <span class="hljs-comment">// 替换为实际pb包路径</span>
)

<span class="hljs-comment">// 实现StreamService服务</span>
<span class="hljs-keyword">type</span> streamServer <span class="hljs-keyword">struct</span> {
  pb.UnimplementedStreamServiceServer
}

<span class="hljs-comment">// 1. 服务器流RPC实现</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> ServerStream(req *pb.StreamRequest, stream pb.StreamService_ServerStreamServer) <span class="hljs-type">error</span> {
  log.Printf(<span class="hljs-string">"收到客户端请求：%s (id:%d)"</span>, req.Message, req.Id)
  <span class="hljs-comment">// 模拟流式返回3个响应</span>
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ {
    reply := fmt.Sprintf(<span class="hljs-string">"服务器流响应 %d: %s"</span>, i, req.Message)
    <span class="hljs-keyword">if</span> err := stream.Send(&amp;pb.StreamResponse{Reply: reply, Code: <span class="hljs-type">int32</span>(i)}); err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">return</span> err
    }
    time.Sleep(<span class="hljs-number">1</span> * time.Second) <span class="hljs-comment">// 模拟延迟</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 2. 客户端流RPC实现</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> ClientStream(stream pb.StreamService_ClientStreamServer) <span class="hljs-type">error</span> {
  <span class="hljs-keyword">var</span> total <span class="hljs-type">int32</span> = <span class="hljs-number">0</span>
  <span class="hljs-keyword">var</span> messages []<span class="hljs-type">string</span>
  <span class="hljs-comment">// 循环接收客户端流式请求</span>
  <span class="hljs-keyword">for</span> {
    req, err := stream.Recv()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
      <span class="hljs-comment">// 客户端流结束（EOF）</span>
      <span class="hljs-keyword">if</span> err.Error() == <span class="hljs-string">"EOF"</span> {
        reply := fmt.Sprintf(<span class="hljs-string">"客户端共发送%d条消息：%v"</span>, total, messages)
        <span class="hljs-keyword">return</span> stream.SendAndClose(&amp;pb.StreamResponse{Reply: reply, Code: total})
      }
      <span class="hljs-keyword">return</span> err
    }
    total++
    messages = <span class="hljs-built_in">append</span>(messages, req.Message)
    log.Printf(<span class="hljs-string">"收到客户端流请求 %d: %s"</span>, req.Id, req.Message)
  }
}

<span class="hljs-comment">// 3. 双向流RPC实现</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> BidirectionalStream(stream pb.StreamService_BidirectionalStreamServer) <span class="hljs-type">error</span> {
  <span class="hljs-comment">// 协程接收客户端消息</span>
  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">for</span> {
      req, err := stream.Recv()
      <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Printf(<span class="hljs-string">"双向流接收结束: %v"</span>, err)
        <span class="hljs-keyword">return</span>
      }
      log.Printf(<span class="hljs-string">"收到双向流请求：%s (id:%d)"</span>, req.Message, req.Id)
    }
  }()

  <span class="hljs-comment">// 主线程发送流式响应</span>
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ {
    reply := fmt.Sprintf(<span class="hljs-string">"双向流服务器响应 %d"</span>, i)
    <span class="hljs-keyword">if</span> err := stream.Send(&amp;pb.StreamResponse{Reply: reply, Code: <span class="hljs-type">int32</span>(i)}); err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">return</span> err
    }
    time.Sleep(<span class="hljs-number">1</span> * time.Second)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
  <span class="hljs-comment">// 监听端口</span>
  lis, err := net.Listen(<span class="hljs-string">"tcp"</span>, <span class="hljs-string">":50051"</span>)
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"监听失败: %v"</span>, err)
  }
  <span class="hljs-comment">// 创建GRPC服务器</span>
  s := grpc.NewServer()
  pb.RegisterStreamServiceServer(s, &amp;streamServer{})
  log.Println(<span class="hljs-string">"GRPC服务器启动，端口50051"</span>)
  <span class="hljs-keyword">if</span> err := s.Serve(lis); err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"服务启动失败: %v"</span>, err)
  }
}
</code></pre>
<p>客户端实现（client.go）</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"context"</span>
  <span class="hljs-string">"fmt"</span>
  <span class="hljs-string">"log"</span>
  <span class="hljs-string">"time"</span>

  <span class="hljs-string">"google.golang.org/grpc"</span>
  <span class="hljs-string">"google.golang.org/grpc/credentials/insecure"</span>
  pb <span class="hljs-string">"your-project-path/pb"</span> <span class="hljs-comment">// 替换为实际pb包路径</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
  <span class="hljs-comment">// 连接GRPC服务器</span>
  conn, err := grpc.Dial(<span class="hljs-string">":50051"</span>, grpc.WithTransportCredentials(insecure.NewCredentials()))
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"连接失败: %v"</span>, err)
  }
  <span class="hljs-keyword">defer</span> conn.Close()
  client := pb.NewStreamServiceClient(conn)

  <span class="hljs-comment">// 1. 调用服务器流RPC</span>
  fmt.Println(<span class="hljs-string">"=== 测试服务器流RPC ==="</span>)
  serverStream, err := client.ServerStream(context.Background(), &amp;pb.StreamRequest{Message: <span class="hljs-string">"hello server stream"</span>, Id: <span class="hljs-number">1</span>})
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"调用服务器流失败: %v"</span>, err)
  }
  <span class="hljs-keyword">for</span> {
    resp, err := serverStream.Recv()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">if</span> err.Error() == <span class="hljs-string">"EOF"</span> {
        <span class="hljs-keyword">break</span>
      }
      log.Fatalf(<span class="hljs-string">"接收服务器流响应失败: %v"</span>, err)
    }
    fmt.Printf(<span class="hljs-string">"收到服务器流响应：%s (code:%d)\n"</span>, resp.Reply, resp.Code)
  }

  <span class="hljs-comment">// 2. 调用客户端流RPC</span>
  fmt.Println(<span class="hljs-string">"\n=== 测试客户端流RPC ==="</span>)
  clientStream, err := client.ClientStream(context.Background())
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"调用客户端流失败: %v"</span>, err)
  }
  <span class="hljs-comment">// 发送3个流式请求</span>
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ {
    req := &amp;pb.StreamRequest{Message: fmt.Sprintf(<span class="hljs-string">"client stream msg %d"</span>, i), Id: <span class="hljs-type">int32</span>(i)}
    <span class="hljs-keyword">if</span> err := clientStream.Send(req); err != <span class="hljs-literal">nil</span> {
      log.Fatalf(<span class="hljs-string">"发送客户端流请求失败: %v"</span>, err)
    }
    time.Sleep(<span class="hljs-number">500</span> * time.Millisecond)
  }
  <span class="hljs-comment">// 关闭客户端流，接收响应</span>
  resp, err := clientStream.CloseAndRecv()
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"接收客户端流响应失败: %v"</span>, err)
  }
  fmt.Printf(<span class="hljs-string">"客户端流最终响应：%s (code:%d)\n"</span>, resp.Reply, resp.Code)

  <span class="hljs-comment">// 3. 调用双向流RPC</span>
  fmt.Println(<span class="hljs-string">"\n=== 测试双向流RPC ==="</span>)
  biStream, err := client.BidirectionalStream(context.Background())
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"调用双向流失败: %v"</span>, err)
  }
  <span class="hljs-comment">// 协程发送客户端消息</span>
  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ {
      req := &amp;pb.StreamRequest{Message: fmt.Sprintf(<span class="hljs-string">"bi stream msg %d"</span>, i), Id: <span class="hljs-type">int32</span>(i)}
      <span class="hljs-keyword">if</span> err := biStream.Send(req); err != <span class="hljs-literal">nil</span> {
        log.Printf(<span class="hljs-string">"发送双向流请求失败: %v"</span>, err)
        <span class="hljs-keyword">return</span>
      }
      time.Sleep(<span class="hljs-number">800</span> * time.Millisecond)
    }
    <span class="hljs-comment">// 关闭客户端发送流</span>
    <span class="hljs-keyword">if</span> err := biStream.CloseSend(); err != <span class="hljs-literal">nil</span> {
      log.Printf(<span class="hljs-string">"关闭双向流发送失败: %v"</span>, err)
    }
  }()

  <span class="hljs-comment">// 接收服务器流式响应</span>
  <span class="hljs-keyword">for</span> {
    resp, err := biStream.Recv()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">if</span> err.Error() == <span class="hljs-string">"EOF"</span> {
        <span class="hljs-keyword">break</span>
      }
      log.Fatalf(<span class="hljs-string">"接收双向流响应失败: %v"</span>, err)
    }
    fmt.Printf(<span class="hljs-string">"收到双向流响应：%s (code:%d)\n"</span>, resp.Reply, resp.Code)
  }
}
</code></pre>
<h4 data-id="heading-10">GRPC Metadata 机制</h4>
<p>Metadata 是 GRPC 的<strong>元数据传递机制</strong>，类比 HTTP 的 Header，用于在客户端和服务端之间传递非业务的附加信息（如认证 Token、请求 ID、超时时间、版本号等）：</p>
<ul>
<li>
<p>结构：键值对（key-value），key 推荐小写，以<code>grpc-</code>开头的 key 为 GRPC 保留字段。</p>
</li>
<li>
<p>类型：支持字符串（<code>metadata.Pairs</code>）和二进制值（需转字符串传递）。</p>
</li>
<li>
<p>传递方向：</p>
<ul>
<li>客户端 → 服务端：通过上下文（Context）注入 Metadata。</li>
<li>服务端 → 客户端：分为<code>Header Metadata</code>（响应头）和<code>Trailing Metadata</code>（响应尾），可主动返回。</li>
</ul>
</li>
</ul>
<p><strong>服务端添加 Metadata 处理（server.go）</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 新增导入</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"google.golang.org/grpc/metadata"</span>

<span class="hljs-comment">// 重写ServerStream方法，添加Metadata解析和返回</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> ServerStream(req *pb.StreamRequest, stream pb.StreamService_ServerStreamServer) <span class="hljs-type">error</span> {
  <span class="hljs-comment">// 1. 提取客户端传递的Metadata</span>
  md, ok := metadata.FromIncomingContext(stream.Context())
  <span class="hljs-keyword">if</span> !ok {
    log.Println(<span class="hljs-string">"未获取到客户端Metadata"</span>)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> tokens := md.Get(<span class="hljs-string">"token"</span>); <span class="hljs-built_in">len</span>(tokens) &gt; <span class="hljs-number">0</span> {
      log.Printf(<span class="hljs-string">"客户端Token: %s"</span>, tokens[<span class="hljs-number">0</span>])
    }
    <span class="hljs-keyword">if</span> reqIDs := md.Get(<span class="hljs-string">"request-id"</span>); <span class="hljs-built_in">len</span>(reqIDs) &gt; <span class="hljs-number">0</span> {
      log.Printf(<span class="hljs-string">"请求ID: %s"</span>, reqIDs[<span class="hljs-number">0</span>])
    }
  }

  <span class="hljs-comment">// 2. 向客户端返回Header Metadata</span>
  headerMd := metadata.Pairs(
    <span class="hljs-string">"server-version"</span>, <span class="hljs-string">"v1.0.0"</span>,
    <span class="hljs-string">"timestamp"</span>, fmt.Sprintf(<span class="hljs-string">"%d"</span>, time.Now().Unix()),
  )
  <span class="hljs-keyword">if</span> err := stream.SendHeader(headerMd); err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> err
  }

  <span class="hljs-comment">// 3. 向客户端返回Trailing Metadata</span>
  trailingMd := metadata.Pairs(
    <span class="hljs-string">"request-status"</span>, <span class="hljs-string">"success"</span>,
    <span class="hljs-string">"response-count"</span>, <span class="hljs-string">"3"</span>,
  )
  stream.SetTrailer(trailingMd)

  <span class="hljs-comment">// 原有流式响应逻辑（略）</span>
  log.Printf(<span class="hljs-string">"收到客户端请求：%s (id:%d)"</span>, req.Message, req.Id)
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ {
    reply := fmt.Sprintf(<span class="hljs-string">"服务器流响应 %d: %s"</span>, i, req.Message)
    <span class="hljs-keyword">if</span> err := stream.Send(&amp;pb.StreamResponse{Reply: reply, Code: <span class="hljs-type">int32</span>(i)}); err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">return</span> err
    }
    time.Sleep(<span class="hljs-number">1</span> * time.Second)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<p>客户端添加 Metadata 发送和接收（client.go）</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 新增导入</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"google.golang.org/grpc/metadata"</span>

<span class="hljs-comment">// 修改服务器流RPC调用逻辑</span>
fmt.Println(<span class="hljs-string">"=== 测试服务器流RPC（带Metadata） ==="</span>)
<span class="hljs-comment">// 1. 创建Metadata</span>
md := metadata.Pairs(
  <span class="hljs-string">"token"</span>, <span class="hljs-string">"user_123456_token"</span>,
  <span class="hljs-string">"request-id"</span>, <span class="hljs-string">"req_987654"</span>,
)
<span class="hljs-comment">// 2. 注入到上下文</span>
ctx := metadata.NewOutgoingContext(context.Background(), md)
<span class="hljs-comment">// 3. 调用RPC</span>
serverStream, err := client.ServerStream(ctx, &amp;pb.StreamRequest{Message: <span class="hljs-string">"hello server stream"</span>, Id: <span class="hljs-number">1</span>})
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
  log.Fatalf(<span class="hljs-string">"调用服务器流失败: %v"</span>, err)
}

<span class="hljs-comment">// 4. 接收服务端Header Metadata</span>
headerMd, err := serverStream.Header()
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
  log.Fatalf(<span class="hljs-string">"获取Header Metadata失败: %v"</span>, err)
}
fmt.Printf(<span class="hljs-string">"服务端Header: server-version=%s, timestamp=%s\n"</span>, 
  headerMd.Get(<span class="hljs-string">"server-version"</span>)[<span class="hljs-number">0</span>], headerMd.Get(<span class="hljs-string">"timestamp"</span>)[<span class="hljs-number">0</span>])

<span class="hljs-comment">// 5. 接收流式响应（原有逻辑，略）</span>
<span class="hljs-keyword">for</span> {
  resp, err := serverStream.Recv()
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">if</span> err.Error() == <span class="hljs-string">"EOF"</span> {
      <span class="hljs-keyword">break</span>
    }
    log.Fatalf(<span class="hljs-string">"接收响应失败: %v"</span>, err)
  }
  fmt.Printf(<span class="hljs-string">"收到响应：%s (code:%d)\n"</span>, resp.Reply, resp.Code)
}

<span class="hljs-comment">// 6. 接收服务端Trailing Metadata</span>
trailingMd := serverStream.Trailer()
fmt.Printf(<span class="hljs-string">"服务端Trailer: request-status=%s, response-count=%s\n"</span>, 
  trailingMd.Get(<span class="hljs-string">"request-status"</span>)[<span class="hljs-number">0</span>], trailingMd.Get(<span class="hljs-string">"response-count"</span>)[<span class="hljs-number">0</span>])
</code></pre>
<h4 data-id="heading-11">GRPC 验证器</h4>
<p>GRPC 验证器用于<strong>请求参数的前置校验</strong>，避免非法请求进入业务逻辑，核心依赖<code>protoc-gen-validate</code>插件：</p>
<ul>
<li>原理：在 Proto 文件中通过注解定义字段验证规则（如非空、长度、数值范围、正则匹配），生成对应的验证代码，服务端调用<code>Validate()</code>方法即可校验。</li>
<li>优势：校验逻辑与业务解耦，规则集中在 Proto 中，跨语言通用。</li>
<li>常用规则：<code>required</code>（非空）、<code>min_len/max_len</code>（字符串长度）、<code>gt/lt</code>（数值范围）、<code>pattern</code>（正则）等。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">go install github.com/bufbuild/protoc-gen-validate@latest
</code></pre>
<p>proto文件</p>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";

option go_package = "./pb;pb";

// 导入验证器注解
import "validate/validate.proto";

message StreamRequest {
  // 验证规则：非空，长度1-20
  string message = 1 [(validate.rules).string = {min_len: 1, max_len: 20}];
  // 验证规则：大于0，小于100
  int32 id = 2 [(validate.rules).int32 = {gt: 0, lt: 100}];
}

// 服务定义不变
service StreamService {
  rpc ServerStream(StreamRequest) returns (stream StreamResponse);
  // ... 其他方法
}

message StreamResponse {
  string reply = 1;
  int32 code = 2;
}
</code></pre>
<p>服务端添加验证逻辑</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 新增导入</span>
<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"google.golang.org/grpc/codes"</span>
  <span class="hljs-string">"google.golang.org/grpc/status"</span>
)

<span class="hljs-comment">// 修改ServerStream方法，添加参数验证</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> ServerStream(req *pb.StreamRequest, stream pb.StreamService_ServerStreamServer) <span class="hljs-type">error</span> {
  <span class="hljs-comment">// 1. 参数验证（核心）</span>
  <span class="hljs-keyword">if</span> err := req.Validate(); err != <span class="hljs-literal">nil</span> {
    log.Printf(<span class="hljs-string">"参数验证失败: %v"</span>, err)
    <span class="hljs-comment">// 返回INVALID_ARGUMENT状态码</span>
    <span class="hljs-keyword">return</span> status.Error(codes.InvalidArgument, fmt.Sprintf(<span class="hljs-string">"参数非法: %v"</span>, err))
  }
​
  <span class="hljs-comment">// 原有Metadata解析、响应逻辑（略）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h4 data-id="heading-12">GRPC 状态码错误机制</h4>
<p>GRPC 定义了<strong>标准化状态码（StatusCode）</strong> ，用于统一表示请求处理结果，替代 HTTP 状态码，核心特点：</p>
<ul>
<li>核心状态码：共 16 种标准码，常用的有<code>OK(0)</code>（成功）、<code>INVALID_ARGUMENT(3)</code>（参数非法）、<code>UNAUTHENTICATED(16)</code>（认证失败）、<code>FAILED_PRECONDITION(9)</code>（业务规则失败）等。</li>
<li>错误结构：包含<strong>状态码</strong>、<strong>错误消息</strong>、<strong>详细信息</strong>（可通过<code>WithDetails</code>附加）。</li>
<li>使用方式：服务端通过<code>status.Error()</code>返回错误；客户端通过<code>status.FromError()</code>解析状态码和消息。</li>
</ul>
<p>服务端返回不同状态码错误</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> ServerStream(req *pb.StreamRequest, stream pb.StreamService_ServerStreamServer) <span class="hljs-type">error</span> {
  <span class="hljs-comment">// 1. 参数验证失败 → INVALID_ARGUMENT(3)</span>
  <span class="hljs-keyword">if</span> err := req.Validate(); err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> status.Error(codes.InvalidArgument, fmt.Sprintf(<span class="hljs-string">"参数非法: %v"</span>, err))
  }

  <span class="hljs-comment">// 2. 认证失败 → UNAUTHENTICATED(16)</span>
  md, _ := metadata.FromIncomingContext(stream.Context())
  <span class="hljs-keyword">if</span> tokens := md.Get(<span class="hljs-string">"token"</span>); <span class="hljs-built_in">len</span>(tokens) == <span class="hljs-number">0</span> || tokens[<span class="hljs-number">0</span>] != <span class="hljs-string">"user_123456_token"</span> {
    <span class="hljs-keyword">return</span> status.Error(codes.Unauthenticated, <span class="hljs-string">"token无效或缺失"</span>)
  }

  <span class="hljs-comment">// 3. 业务规则失败 → FAILED_PRECONDITION(9)（带详细信息）</span>
  <span class="hljs-keyword">if</span> req.Id == <span class="hljs-number">5</span> {
    st := status.New(codes.FailedPrecondition, <span class="hljs-string">"业务规则校验失败"</span>)
    <span class="hljs-comment">// 附加详细信息</span>
    st, err := st.WithDetails(&amp;pb.StreamResponse{Reply: <span class="hljs-string">"id不能为5"</span>, Code: <span class="hljs-number">5</span>})
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">return</span> st.Err()
    }
    <span class="hljs-keyword">return</span> st.Err()
  }

  <span class="hljs-comment">// 原有逻辑（略）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<p>客户端解析错误详情</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 调用RPC（id=5）</span>
serverStream, err := client.ServerStream(ctx, &amp;pb.StreamRequest{Message: <span class="hljs-string">"test"</span>, Id: <span class="hljs-number">5</span>})
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
  st, ok := status.FromError(err)
  <span class="hljs-keyword">if</span> !ok {
    log.Fatalf(<span class="hljs-string">"非GRPC错误: %v"</span>, err)
  }

  <span class="hljs-comment">// 解析基础信息</span>
  fmt.Printf(<span class="hljs-string">"状态码: %s (数字:%d)\n"</span>, st.Code().String(), st.Code())
  fmt.Printf(<span class="hljs-string">"错误消息: %s\n"</span>, st.Message())

  <span class="hljs-comment">// 解析详细信息</span>
  <span class="hljs-keyword">for</span> _, detail := <span class="hljs-keyword">range</span> st.Details() {
    <span class="hljs-keyword">if</span> resp, ok := detail.(*pb.StreamResponse); ok {
      fmt.Printf(<span class="hljs-string">"详细信息: %s (code:%d)\n"</span>, resp.Reply, resp.Code)
    }
  }
  <span class="hljs-comment">// 输出：</span>
  <span class="hljs-comment">// 状态码: FailedPrecondition (数字:9)</span>
  <span class="hljs-comment">// 错误消息: 业务规则校验失败</span>
  <span class="hljs-comment">// 详细信息: id不能为5 (code:5)</span>
  <span class="hljs-keyword">return</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里开源 Assistant Agent，助力企业快速构建答疑、诊断智能助手]]></title>    <link>https://juejin.cn/post/7599155566297546795</link>    <guid>https://juejin.cn/post/7599155566297546795</guid>    <pubDate>2026-01-26T08:11:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599155566297546795" data-draft-id="7599053532168224809" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里开源 Assistant Agent，助力企业快速构建答疑、诊断智能助手"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-26T08:11:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里开源 Assistant Agent，助力企业快速构建答疑、诊断智能助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T08:11:40.000Z" title="Mon Jan 26 2026 08:11:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：残风、栀七</p>
<blockquote>
<p>更多接入与使用方式，可查看文末微信与钉钉群，与官方维护团队取得联系。</p>
</blockquote>
<h2 data-id="heading-0">📖 简介</h2>
<p><strong>Assistant Agent</strong> 是一个基于 Spring AI Alibaba 构建的企业级智能助手框架，采用代码即行动（Code-as-Action）范式，通过生成和执行代码来编排工具、完成任务。它是一个<strong>能理解、能行动、能学习</strong>的智能助手解决方案，可帮助企业快速构建<strong>智能答疑客服、系统诊断、运维助手、业务助理、AIOps</strong> 等智能体。</p>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-ai-alibaba%2FAssistantAgent" target="_blank" title="https://github.com/spring-ai-alibaba/AssistantAgent" ref="nofollow noopener noreferrer">github.com/spring-ai-a…</a></p>
<h3 data-id="heading-1">技术特性</h3>
<ul>
<li>🚀<strong>代码即行动（Code-as-Action）</strong> ：Agent 通过生成并执行代码来完成任务，而非仅仅调用预定义工具，可以在代码中灵活编排、组合多个工具，实现复杂流程</li>
<li>🔒<strong>安全沙箱</strong>：AI 生成的代码在 GraalVM 多语言沙箱中安全运行，具备资源隔离能力</li>
<li>📊<strong>多维评估</strong>：通过评估图（Graph）进行多层次意图识别，精准指导 Agent 行为</li>
<li>🔄<strong>Prompt 动态组装</strong>：根据场景及前置评估结果动态注入上下文（经验、知识等）到 Prompt 中，灵活处理不同任务</li>
<li>🧠<strong>经验学习</strong>：自动积累成功经验，持续提升后续任务的表现</li>
<li>⚡<strong>快速响应</strong>：熟悉场景下，跳过 LLM 推理过程，基于经验快速响应</li>
</ul>
<h3 data-id="heading-2">Assistant Agent 能帮你做什么？</h3>
<p>Assistant Agent 是一个功能完整的智能助手，具备以下核心能力：</p>
<ul>
<li>🔍<strong>智能问答</strong>：支持多数据源统一检索架构（通过 SPI 可扩展知识库、Web 等数据源），提供准确、可溯源的答案</li>
<li>🛠️<strong>工具调用</strong>：支持 MCP、HTTP API（OpenAPI）等协议，灵活接入海量工具，可组合调用实现复杂业务流程</li>
<li>⏰<strong>主动服务</strong>：支持定时任务、延迟执行、事件回调，让助手主动为你服务</li>
<li>📬<strong>多渠道触达</strong>：内置 IDE 回复，允许通过 SPI 可扩展钉钉、飞书、企微、Webhook 等渠道</li>
</ul>
<h3 data-id="heading-3">为什么选择 Assistant Agent？</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93b35aafeb2a458d9a4f51f96444a288~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019900&amp;x-signature=zJxsODkmc7vlZmL44hmA%2BkJJvpc%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-4">适用场景</h3>
<ul>
<li>智能客服：接入企业知识库，智能解答用户咨询</li>
<li>运维助手：对接监控、工单系统，自动处理告警、查询状态、执行操作</li>
<li>业务助理：连接 CRM、ERP 等业务系统，辅助员工完成日常工作</li>
</ul>
<p><em>💡 以上仅为典型场景示例。通过配置知识库和接入工具，Assistant Agent 可适配更多业务场景，欢迎探索。</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb3b8a2d8c88444596f3c07db11324ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019900&amp;x-signature=cKu36Jtll4869Mmhl3ilQnAqLKM%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b14110afa9954efebfebe21ff21ef201~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019900&amp;x-signature=ts%2Fau7gEhbwGK2RORrtp2ZfARAM%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-5">整体工作原理</h3>
<p>以下是 Assistant Agent 处理一个完整请求的端到端流程示例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/914532a64ea149ad97eb23ab06240fe5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019900&amp;x-signature=62Reh8IFhDk%2BtekaqxxcUNu7Od4%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6">项目结构</h3>
<pre><code class="hljs language-csharp" lang="csharp">assistant-agent/
├── assistant-agent-common          <span class="hljs-meta"># 通用工具、枚举、常量</span>
├── assistant-agent-core            <span class="hljs-meta"># 核心引擎：GraalVM 执行器、工具注册表</span>
├── assistant-agent-extensions      <span class="hljs-meta"># 扩展模块：</span>
│   ├── <span class="hljs-built_in">dynamic</span>/               <span class="hljs-meta">#   - 动态工具（MCP、HTTP API）</span>
│   ├── experience/            <span class="hljs-meta">#   - 经验管理与快速意图配置</span>
│   ├── learning/              <span class="hljs-meta">#   - 学习提取与存储</span>
│   ├── search/                <span class="hljs-meta">#   - 统一搜索能力</span>
│   ├── reply/                 <span class="hljs-meta">#   - 多渠道回复</span>
│   ├── trigger/               <span class="hljs-meta">#   - 触发器机制</span>
│   └── evaluation/            <span class="hljs-meta">#   - 评估集成</span>
├── assistant-agent-prompt-builder  <span class="hljs-meta"># Prompt 动态组装</span>
├── assistant-agent-evaluation      <span class="hljs-meta"># 评估引擎</span>
├── assistant-agent-autoconfigure   <span class="hljs-meta"># Spring Boot 自动配置</span>
└── assistant-agent-start           <span class="hljs-meta"># 启动模块</span>
</code></pre>
<h2 data-id="heading-7">🚀 快速启动</h2>
<h3 data-id="heading-8">前置要求</h3>
<ul>
<li>Java 17+</li>
<li>Maven 3.8+</li>
<li>DashScope API Key</li>
</ul>
<h3 data-id="heading-9">1. 克隆并构建</h3>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/spring-ai-alibaba/AssistantAgent.git
<span class="hljs-built_in">cd</span> assistant-agent
mvn clean install -DskipTests
</code></pre>
<h3 data-id="heading-10">2. 配置 API Key</h3>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">DASHSCOPE_API_KEY</span>=your-api-key-here
</code></pre>
<h3 data-id="heading-11">3. 最小配置</h3>
<p>项目已内置默认配置，只需确保 API Key 正确即可。如需自定义，可编辑 <code>assistant-agent-start/src/main/resources/application.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">dashscope:</span>
      <span class="hljs-string">api-key:</span> <span class="hljs-string">${DASHSCOPE_API_KEY}</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">qwen-max</span>
</code></pre>
<h3 data-id="heading-12">4. 启动应用</h3>
<pre><code class="hljs language-arduino" lang="arduino">cd assistant-agent-start
mvn spring-boot:run
</code></pre>
<p>所有扩展模块默认开启并采用合理的配置，无需额外配置即可快速启动。</p>
<h3 data-id="heading-13">5. 配置知识库（接入业务知识）</h3>
<p>💡 框架默认提供 Mock 知识库实现用于演示测试。<strong>生产环境需要接入真实知识源</strong>（如向量数据库、Elasticsearch、企业知识库 API 等），以便 Agent 能够检索并回答业务相关问题。</p>
<h4 data-id="heading-14">方式一：快速体验（使用内置 Mock 实现）</h4>
<p>默认配置已启用知识库搜索，可直接体验：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">alibaba:</span>
      <span class="hljs-attr">codeact:</span>
        <span class="hljs-attr">extension:</span>
          <span class="hljs-attr">search:</span>
            <span class="hljs-string">enabled:</span> <span class="hljs-literal">true</span>
            <span class="hljs-string">knowledge-search-enabled:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 默认开启</span>
</code></pre>
<h4 data-id="heading-15">方式二：接入真实知识库（推荐）</h4>
<p>实现 SearchProvider 接口，接入你的业务知识源：</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">knowledge</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">assistant</span>.<span class="hljs-property">agent</span>.<span class="hljs-property">extension</span>.<span class="hljs-property">search</span>.<span class="hljs-property">spi</span>.<span class="hljs-property">SearchProvider</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">assistant</span>.<span class="hljs-property">agent</span>.<span class="hljs-property">extension</span>.<span class="hljs-property">search</span>.<span class="hljs-property">model</span>.*;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.*;
<span class="hljs-meta">@Component</span>  <span class="hljs-comment">// 添加此注解，Provider 会自动注册</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyKnowledgeSearchProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SearchProvider</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">supports</span>(<span class="hljs-params">SearchSourceType <span class="hljs-keyword">type</span></span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">SearchSourceType</span>.<span class="hljs-property">KNOWLEDGE</span> == <span class="hljs-keyword">type</span>;
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">SearchResultItem</span>&gt; <span class="hljs-title function_">search</span>(<span class="hljs-params">SearchRequest request</span>) {
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">SearchResultItem</span>&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-comment">// 1. 从你的知识源查询（向量数据库、ES、API 等）</span>
        <span class="hljs-comment">// 示例：List&lt;Doc&gt; docs = vectorStore.similaritySearch(request.getQuery());</span>
        <span class="hljs-comment">// 2. 转换为 SearchResultItem</span>
        <span class="hljs-comment">// for (Doc doc : docs) {</span>
        <span class="hljs-comment">//     SearchResultItem item = new SearchResultItem();</span>
        <span class="hljs-comment">//     item.setId(doc.getId());</span>
        <span class="hljs-comment">//     item.setSourceType(SearchSourceType.KNOWLEDGE);</span>
        <span class="hljs-comment">//     item.setTitle(doc.getTitle());</span>
        <span class="hljs-comment">//     item.setSnippet(doc.getSummary());</span>
        <span class="hljs-comment">//     item.setContent(doc.getContent());</span>
        <span class="hljs-comment">//     item.setScore(doc.getScore());</span>
        <span class="hljs-comment">//     results.add(item);</span>
        <span class="hljs-comment">// }</span>
        <span class="hljs-keyword">return</span> results;
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"MyKnowledgeSearchProvider"</span>;
    }
}
</code></pre>
<h4 data-id="heading-16">常见知识源接入示例</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91b352cfa74e4b9682caed5d1d50557c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019900&amp;x-signature=CFLlQPZTBNcmzcGoMVwXFtKGtck%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-17">🧩 核心模块介绍</h2>
<h3 data-id="heading-18">评估模块（Evaluation）</h3>
<p><strong>作用</strong>：多维度意图识别框架，通过评估图（Graph）对信息进行多层次特质识别。</p>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────────────────────────────┐
│                    评估图 (Evaluation Graph) 示例                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  用户输入: <span class="hljs-string">"查询今日订单"</span>                                           │
│          │                                                       │
│          ▼                                                       │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │ Layer <span class="hljs-number">1</span> （并行执行）                                      │     │
│  │   ┌────────────┐         ┌────────────┐                 │     │
│  │   │ 是否模糊?   │         │ 输入改写     │                 │     │
│  │   │ 清晰/模糊   │         │（增强）      │                 │     │
│  │   └─────┬──────┘         └─────┬──────┘                 │     │
│  └─────────┼──────────────────────┼────────────────────────┘     │
│            │                      │                              │
│            └──────────┬───────────┘                              │
│                       ▼                                          │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │ Layer <span class="hljs-number">2</span> (基于改写内容，并行执行)                            │     │
│  │   ┌──────────┐   ┌──────────┐   ┌──────────┐            │     │
│  │   │ 检索经验  │   │ 匹配工具  │   │ 搜索知识  │             │     │
│  │   │ 有/无    │   │ 有/无     │   │ 有/无    │             │     │
│  │   └──────────┘   └──────────┘   └──────────┘            │     │
│  └─────────────────────────────────────────────────────────┘     │
│                       │                                          │
│                       ▼                                          │
│            ┌────────────────────┐                                │
│            │ 整合不同维度评估结果  │                                │
│            │ → 传递给后续模块     │                                │
│            └────────────────────┘                                │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>核心能力</strong>：</p>
<ul>
<li><strong>双评估引擎：</strong>
<ul>
<li><strong>LLM 评估：</strong> 通过大模型进行复杂语义判断，用户可完全自定义评估 Prompt（<code>customPrompt</code>），也可使用默认 Prompt 组装（支持 <code>description、workingMechanism、fewShots</code> 等配置）</li>
<li><strong>Rule-based 评估：</strong> 通过 Java 函数实现规则逻辑，用户自定义 <code>Function&lt;CriterionExecutionContext, CriterionResult&gt;</code> 执行任意规则判断，适合阈值检测、格式校验、精确匹配等场景</li>
</ul>
</li>
<li><strong>依赖关系自定义：</strong> 评估项可通过 <code>dependsOn</code> 声明前置依赖，系统自动构建评估图按拓扑执行，无依赖项并行、有依赖项顺序执行，后续评估项可访问前置评估项的结果</li>
<li><strong>评估结果：</strong> 支持 <code>BOOLEAN</code>、<code>ENUM</code>、<code>SCORE</code>、<code>JSON</code>、<code>TEXT</code> 等类型，传递给 Prompt Builder 驱动动态组装</li>
</ul>
<h3 data-id="heading-19">Prompt Builder 模块</h3>
<p><strong>作用</strong>：根据评估结果和运行时上下文，动态组装发送给模型的 Prompt。示例：</p>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────────────────┐
│                   Prompt Builder - 条件化动态生成                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  评估结果输入:                                                            │
│  ┌────────────────────────────────────────────────────────┐             │
│  │ 模糊: 是  │ 经验: 有  │ 工具: 有  │ 知识: 无               │             │
│  └────────────────────────────────────────────────────────┘             │
│                    │                                                    │
│                    ▼                                                    │
│  ┌────────────────────────────────────────────────────────────────┐     │
│  │              自定义 PromptBuilder 条件匹配                       │     │
│  │                                                                │     │
│  │   模糊=是 ──────▶ 注入 <span class="hljs-section">[澄清引导 Prompt]</span>                          │     │
│  │   模糊=否 ──────▶ 注入 <span class="hljs-section">[直接执行 Prompt]</span>                          │     │
│  │                                                                │     │
│  │   经验=有 ──────▶ 注入 <span class="hljs-section">[历史经验参考]</span>                              │     │
│  │   工具=有 ──────▶ 注入 <span class="hljs-section">[工具使用说明]</span>                              │     │
│  │   知识=有 ──────▶ 注入 <span class="hljs-section">[相关知识片段]</span>                              │     │
│  │                                                                │     │
│  │   组合示例1: 模糊+无工具+无知识 ──▶ <span class="hljs-section">[追问用户 Prompt]</span>               │     │
│  │   组合示例2: 清晰+有工具+有经验 ──▶ <span class="hljs-section">[快速执行 Prompt]</span>               │     │
│  └────────────────────────────────────────────────────────────────┘     │
│                    │                                                    │
│                    ▼                                                    │
│  ┌────────────────────────────────────────────────────────────────┐     │
│  │ 最终动态 Prompt:                                                │     │
│  │ <span class="hljs-section">[系统提示]</span> + <span class="hljs-section">[澄清引导]</span> + <span class="hljs-section">[历史经验]</span> + <span class="hljs-section">[工具说明]</span> + <span class="hljs-section">[用户问题]</span>        │     │
│  └────────────────────────────────────────────────────────────────┘     │
│                    │                                                    │
│                    ▼                                                    │
│              ┌──────────┐                                               │
│              │   模型    │                                               │
│              └──────────┘                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>核心能力</strong>：</p>
<ul>
<li>多个 PromptBuilder 按优先级顺序执行</li>
<li>每个 Builder 根据评估结果决定是否贡献、贡献什么内容</li>
<li>支持自定义 Builder，根据业务需求定制 Prompt 逻辑</li>
<li>非侵入式，在模型调用层拦截</li>
</ul>
<p><strong>对比传统方案</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0c0a1037d5c4c9983ad90dafb68f045~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019900&amp;x-signature=8%2BH9Rn5vEtvLSwNrK2r7VHPeyhM%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-20">学习模块（Learning）</h3>
<p><strong>作用</strong>：从 Agent 执行历史中自动提取并保存有价值的经验。</p>
<pre><code class="hljs">┌─────────────────────────────────────────────────────────────────────────┐
│                         学习模块工作流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        Agent 执行过程                               │ │
│  │                                                                    │ │
│  │  输入 ──▶ 推理 ──▶ 代码生成 ──▶ 执行 ──▶ 输出                          │ │
│  │   │        │          │         │        │                         │ │
│  │   └────────┴──────────┴─────────┴────────┘                         │ │
│  │                        │                                           │ │
│  └────────────────────────┼───────────────────────────────────────────┘ │
│                           ▼                                             │
│              ┌────────────────────────┐                                 │
│              │      学习上下文捕获      │                                 │
│              │  - 用户输入             │                                 │
│              │  - 中间推理步骤          │                                │
│              │  - 生成的代码           │                                 │
│              │  - 执行结果             │                                │
│              └───────────┬────────────┘                                │
│                          │                                             │
│                          ▼                                             │
│   ┌──────────────────────────────────────────────────────────────┐     │
│   │                    学习提取器分析                              │     │
│   │  ┌────────────┐  ┌────────────┐  ┌────────────┐              │     │
│   │  │ 经验提取器  │  │ 模式提取器   │  │ 错误提取器   │              │     │
│   │  │ 成功模式    │  │ 通用模式    │  │ 失败教训     │              │     │
│   │  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘              │     │
│   └────────┼───────────────┼───────────────┼─────────────────────┘     │
│            │               │               │                           │
│            └───────────────┼───────────────┘                           │
│                            ▼                                           │
│                   ┌────────────────┐                                   │
│                   │   持久化存储    │ ──▶ 供后续任务参考使用                │
│                   └────────────────┘                                   │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>核心能力</strong>：</p>
<ul>
<li><strong>After-Agent 学习：</strong> 每次 Agent 运行完成后提取经验</li>
<li><strong>After-Model 学习：</strong> 每次模型调用后提取经验</li>
<li><strong>Tool Interceptor：</strong> 从工具调用中提取经验</li>
<li><strong>离线学习：</strong> 批量分析历史数据提取模式</li>
<li><strong>学习过程：</strong> 捕获执行上下文 → 提取器分析识别 → 生成经验记录 → 持久化存储供后续复用</li>
</ul>
<h3 data-id="heading-21">经验模块（Experience）</h3>
<p><strong>作用</strong>：积累和复用历史成功执行经验。</p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────────────────┐
│                         经验模块工作示意                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【场景<span class="hljs-number">1</span>: 经验积累】                                                       │
│                                                                         │
│   用户: <span class="hljs-string">"查询订单状态"</span>  ──▶  Agent 成功执行  ──▶     ┌────────────────┐     │
│                                                  │ 保存经验:       │     │
│                                                  │ - React决策经验 │     │
│                                                  │ - Code经验     │     │
│                                                  │ - 常识经验      │     │
│                                                  └────────────────┘     │
│                                                           │             │
│                                                           ▼             │
│                                                  ┌────────────────┐     │
│                                                  │   经验库        │     │
│                                                  └────────────────┘     │
│                                                                         │
│  【场景<span class="hljs-number">2</span>: 经验复用】                                       ｜              │
│                                                          │              │
│   用户: <span class="hljs-string">"查询我的订单状态"</span>  ◀────  匹配相似经验  ◀────────────┘              │
│            │                                                            │
│            ▼                                                            │
│   ┌─────────────────────────────────────────────────┐                   │
│   │ Agent 参考历史经验，更快决策+生成正确代码             │                   │
│   └─────────────────────────────────────────────────┘                   │
│                                                                         │
│  【场景<span class="hljs-number">3</span>: 快速意图响应】                                                   │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ 经验库                                                           │   │
│   │   ┌─────────────────────┐       ┌────────────────────────────┐  │   │
│   │   │ 经验<span class="hljs-built_in">A</span> (普通)         │       │ 经验<span class="hljs-built_in">B</span> (✓ 已配置快速意图)      │  │   │
│   │   │ 无快速意图配置        │       │   条件: 前缀匹配<span class="hljs-string">"查看*销量"</span>   │  │   │
│   │   │ → 注入prompt供llm参考│       │   动作: 调用销量查询API       │  │   │
│   │   └─────────────────────┘       └───────────┬────────────────┘  │   │
│   └─────────────────────────────────────────────┼───────────────────┘   │
│                                                 │ 条件命中               │
│                                                 ▼                       │
│   用户: <span class="hljs-string">"查看今日销量"</span>  ──▶  匹配经验B快速意图  ──▶  跳过LLM，直接执行          │
│                                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>核心能力</strong>：</p>
<ul>
<li><strong>多类型经验：</strong> 代码生成经验、ReAct 决策经验、常识经验，为类似任务提供历史参考</li>
<li><strong>灵活复用：</strong> 经验可注入 Prompt 或用于快速意图匹配</li>
<li><strong>生命周期管理：</strong> 支持经验的创建、更新、删除</li>
<li><strong>快速意图响应：</strong>
<ul>
<li>经验需显式配置 <code>fastIntentConfig</code> 才能启用</li>
<li>匹配已配置条件时，跳过 LLM 完整推理，直接执行预记录的工具调用或代码</li>
<li>支持多条件匹配：消息前缀、正则、元数据、状态等</li>
</ul>
</li>
</ul>
<h3 data-id="heading-22">触发器模块（Trigger）</h3>
<p><strong>作用</strong>：创建和管理定时任务或事件触发的 Agent 执行。</p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────────────────┐
│                         触发器模块能力示意                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【定时触发】                                                             │
│                                                                         │
│   用户: <span class="hljs-string">"每天早上9点给我发送销售日报"</span>                                        │
│            │                                                            │
│            ▼                                                            │
│   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐   │
│   │  Agent 创建      │     │   调度器         │     │  自动执行        │   │
│   │  Cron 触发器     │────▶│  <span class="hljs-number">0</span> <span class="hljs-number">9</span> * * *      │────▶│  生成日报        │   │
│   │  (自我调度)      │     │                 │     │  发送通知        │    │
│   └─────────────────┘     └─────────────────┘     └─────────────────┘   │
│                                                                         │
│  【延迟触发】                                                             │
│                                                                         │
│   用户: <span class="hljs-string">"30分钟后提醒我开会"</span>                                               │
│            │                                                            │
│            ▼                                                            │
│   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐   │
│   │  Agent 创建      │     │   <span class="hljs-number">30</span>分钟后      │     │  发送提醒         │   │
│   │  一次性触发器     │────▶│   触发          │────▶│  <span class="hljs-string">"该开会了"</span>       │   │
│   └─────────────────┘     └─────────────────┘     └─────────────────┘   │
│                                                                         │
│  【回调触发】                                                             │
│                                                                         │
│   用户: <span class="hljs-string">"满足xx条件时帮我xx"</span>                                               │
│                                                                         │
│   外部系统: 发送事件到 Webhook                                             │
│            │                                                            │
│            ▼                                                            │
│   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐   │
│   │  接收回调        │     │   触发 Agent     │     │  处理事件        │   │
│   │  Webhook 事件   │────▶│   执行任务        │────▶│  返回响应        │   │
│   └─────────────────┘     └─────────────────┘     └─────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>核心能力</strong>：</p>
<ul>
<li><code>TIME_CRON</code> 触发器：支持 Cron 表达式定时触发任务</li>
<li><code>TIME_ONCE</code> 触发器：支持一次性延迟触发</li>
<li><code>CALLBACK</code> 触发器：支持回调事件触发</li>
<li><code>Agent</code> 可通过工具自主创建触发器，实现“自我调度”</li>
</ul>
<h3 data-id="heading-23">回复渠道模块（Reply Channel）</h3>
<p><strong>作用</strong>：提供灵活的消息回复能力，支持多种输出渠道。</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────────────┐
│                       回复渠道模块能力示意                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Agent 需要向用户回复消息                                                 │
│            │                                                            │
│            ▼                                                            │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    回复渠道路由                                   │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│            │                                                            │
│            ├──────────────┬──────────────┬──────────────┐               │
│            ▼              ▼              ▼              ▼               │
│   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐        │
│   │  DEFAULT   │  │  IDE_CARD  │  │ IM_NOTIFY  │  │  WEBHOOK   │        │
│   │  文本回复   │  │  卡片展示   │   │  消息推送   │  │  JSON推送   │        │
│   └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘        │
│         │               │               │               │               │
│         ▼               ▼               ▼               ▼               │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐          │
│   │ 控制台    │    │   IDE    │    │   IM     │    │ 第三方    │          │
│   │ 终端回复  │    │ 富文本卡片 │     │ (可扩展) │    │  系统     │          │
│   └──────────┘    └──────────┘    └──────────┘    └──────────┘          │
│                                                                         │
│  【使用示例】                                                             │
│                                                                         │
│   用户: <span class="hljs-string">"分析完成后发送结果"</span>                                                │
│            │                                                            │
│            ▼                                                            │
│   Agent: <span class="hljs-built_in">send_message</span>(text=<span class="hljs-string">"分析结果..."</span>)                                │
│            │                                                            │
│            ▼                                                            │
│   用户收到消息: <span class="hljs-string">"📊 分析结果: ..."</span>                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>核心能力</strong>：</p>
<ul>
<li><strong>多渠道路由：</strong> Agent 可根据场景选择不同渠道回复</li>
<li><strong>配置驱动：</strong> 动态生成回复工具，无需编码</li>
<li><strong>同步异步支持：</strong> 支持同步和异步回复模式</li>
<li><strong>统一接口：</strong> 屏蔽底层实现差异</li>
<li><strong>内置示例渠道：</strong> <code>IDE_TEXT</code>（演示用）</li>
<li><strong>可扩展渠道（通过实现 <code>ReplyChannelDefinition</code> SPI）：</strong> 如 <code>IDE_CARD</code>、<code>IM_NOTIFICATION</code>（钉钉/飞书/企微）、<code>WEBHOOK_JSON</code> 等，需用户自行实现</li>
</ul>
<h3 data-id="heading-24">工具扩展模块（Dynamic Tools）</h3>
<p><strong>作用</strong>：提供高度可扩展的工具体系，让 Agent 能够调用各类外部工具完成任务。</p>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────────────────┐
│                        工具扩展架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Agent 需要执行操作                                                      │
│            │                                                            │
│            ▼                                                            │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │                   CodeactTool 工具体系                            │  │
│   └─────────────────────────────────────────────────────────────────┘   │
│            │                                                            │
│            ├─────────────┬─────────────┬─────────────┬──────────────┐   │
│            ▼             ▼             ▼             ▼              ▼   │
│   ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌───────┐ │
│   │   MCP      │ │   HTTP     │ │  <span class="hljs-keyword">Search</span>    │ │  <span class="hljs-keyword">Trigger</span>   │ │ 自定义 │ │
│   │   Tools    │ │   API      │ │  Tools     │ │  Tools     │ │ Tools │ │
│   │            │ │   Tools    │ │            │ │            │ │       │ │
│   └─────┬──────┘ └─────┬──────┘ └─────┬──────┘ └─────┬──────┘ └───┬───┘ │
│         │              │              │              │            │     │
│         ▼              ▼              ▼              ▼            ▼     │
│   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐  ┌──────┐   │
│   │ 任意 MCP │   │ REST API │   │ 知识检索   │   │ 定时任务  │  │ ...  │   │
│   │ Server   │   │ OpenAPI  │   │ 项目搜索  │   │ 事件回调  │  │      │    │
│   └──────────┘   └──────────┘   └──────────┘   └──────────┘  └──────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>核心能力</strong>：</p>
<ul>
<li><strong>MCP 工具支持：</strong> 一键接入任意 MCP Server，复用 MCP 工具生态</li>
<li><strong>HTTP API 支持：</strong> 通过 OpenAPI 规范接入 REST API，调用企业现有接口</li>
<li><strong>内置工具类型：</strong> 搜索（Search）、回复（Reply）、触发器（Trigger）、学习（Learning）等</li>
<li><strong>自定义工具 SPI：</strong> 实现 <code>CodeactTool</code> 接口，轻松扩展新工具</li>
</ul>
<h3 data-id="heading-25">知识检索模块（Knowledge Search）</h3>
<p><strong>作用</strong>：多数据源统一检索引擎，为 Agent 的问答和决策提供知识支撑。</p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────────────────┐
│                       多数据源检索架构                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  用户问题: <span class="hljs-string">"如何配置数据库连接池？"</span>                                          │
│            │                                                            │
│            ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                      统一检索接口                                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│            │                                                            │
│            ├────────────────┬────────────────┬────────────────┐         │
│            ▼                ▼                ▼                ▼         │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────┐     │
│   │    知识库     │  │    项目       │  │     Web      │  │  自定义  │    │
│   │   Provider   │  │   Provider   │  │   Provider   │  │Provider │    │
│   │   (主要)      │  │   (可选)     │  │   (可选)      │  │  (<span class="hljs-built_in">SPI</span>)  │    │
│   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └───┬─────┘    │
│          │                 │                 │              │          │
│          ▼                 ▼                 ▼              ▼          │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────┐      │
│   │ FAQ / 文档    │  │ 源代码       │  │ 网络文章       │  │  ...   │      │
│   │ 历史问答      │  │ 配置文件      │  │ 技术论坛       │  │        │      │
│   │ 团队笔记      │  │ 日志         │  │               │  │        │      │
│   └──────────────┘  └─────────────┘  └───────────────┘  └────────┘      │
│          │                 │                 │              │          │
│          └─────────────────┴─────────────────┴──────────────┘          │
│                            │                                           │
│                            ▼                                           │
│               ┌────────────────────────┐                               │
│               │ 聚合排序                │                               │
│               │ → 注入 Prompt          │                                │
│               └────────────────────────┘                               │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>核心能力</strong>：</p>
<ul>
<li><strong>统一检索接口：</strong> <code>SearchProvider</code> SPI，支持可插拔数据源</li>
<li><strong>演示 Provider：</strong> 内置知识库、项目、Web 的 Mock 实现（仅供演示和测试）</li>
<li><strong>自定义扩展：</strong> 通过实现 <code>SearchProvider</code> 接口，接入任意数据源（数据库、向量库、API）</li>
<li><strong>结果聚合：</strong> 支持可配置的排序策略</li>
<li><strong>业务价值：</strong> 接入企业知识库提供准确答案、支持答案溯源、降低人工客服压力</li>
</ul>
<p><strong>配置示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">alibaba:</span>
      <span class="hljs-attr">codeact:</span>
        <span class="hljs-attr">extension:</span>
          <span class="hljs-attr">search:</span>
            <span class="hljs-string">enabled:</span> <span class="hljs-literal">true</span>
            <span class="hljs-string">knowledge-search-enabled:</span> <span class="hljs-literal">true</span>   <span class="hljs-comment"># 知识库（默认 Mock 实现）</span>
            <span class="hljs-string">project-search-enabled:</span> <span class="hljs-literal">false</span>    <span class="hljs-comment"># 项目代码（默认 Mock 实现）</span>
            <span class="hljs-string">web-search-enabled:</span> <span class="hljs-literal">false</span>        <span class="hljs-comment"># Web 搜索（默认 Mock 实现）</span>
            <span class="hljs-string">default-top-k:</span> <span class="hljs-number">5</span>
            <span class="hljs-string">search-timeout-ms:</span> <span class="hljs-number">5000</span>
</code></pre>
<p><em>💡 以上搜索功能默认提供 Mock 实现供演示测试。生产环境需实现 <code>SearchProvider</code> SPI 接入实际数据源。</em></p>
<p><strong>🙏 致谢：</strong></p>
<ul>
<li>
<p>Spring AI</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai" target="_blank" title="https://github.com/spring-projects/spring-ai" ref="nofollow noopener noreferrer">github.com/spring-proj…</a></p>
</li>
<li>
<p>Spring AI Alibaba</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fspring-ai-alibaba" target="_blank" title="https://github.com/alibaba/spring-ai-alibaba" ref="nofollow noopener noreferrer">github.com/alibaba/spr…</a></p>
</li>
<li>
<p>GraalVM</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.graalvm.org%2F" target="_blank" title="https://www.graalvm.org/" ref="nofollow noopener noreferrer">www.graalvm.org/</a></p>
</li>
</ul>
<p><strong>联系方式：</strong></p>
<ul>
<li>搜索加入钉钉群：130240015687</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[熔断限流从入门到实战：打造高可用微服务架构]]></title>    <link>https://juejin.cn/post/7599094262592274442</link>    <guid>https://juejin.cn/post/7599094262592274442</guid>    <pubDate>2026-01-26T01:11:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599094262592274442" data-draft-id="7598737609494249491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="熔断限流从入门到实战：打造高可用微服务架构"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-26T01:11:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            熔断限流从入门到实战：打造高可用微服务架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T01:11:31.000Z" title="Mon Jan 26 2026 01:11:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">熔断限流从入门到实战：打造高可用微服务架构</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63c1c5be139f4de8a607f3cf81b5802f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769994691&amp;x-signature=GZGCKLl8tb14Qk9udkXrPQhUOgk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">一、为什么需要熔断限流？</h3>
<p>在分布式系统中，服务间的依赖关系日益复杂。当一个服务出现故障或响应过慢时，如果不及时隔离，会引发"雪崩效应"，导致整个系统瘫痪。</p>
<p><strong>真实案例</strong>：某电商系统在大促期间，推荐服务因为数据库慢查询导致响应超时，调用方持续重试，最终使整个订单系统崩溃，造成数百万元损失。</p>
<p>熔断限流正是解决这类问题的核心手段：</p>
<ul>
<li><strong>熔断（Circuit Breaker）</strong>：当检测到下游服务故障率达到阈值时，自动切断调用，快速失败，保护系统稳定性</li>
<li><strong>限流（Rate Limiting）</strong>：控制请求速率，防止系统过载</li>
</ul>
<h3 data-id="heading-2">二、自定义实现熔断器</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3149ab7547484bbda3d0e035a85d4101~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769994691&amp;x-signature=3nQfxjP6J5C7hPopTA9aCNC7bQg%3D" alt="" loading="lazy"/></p>
<p>让我们从零开始，手动实现一个简单的熔断器，深入理解其核心原理。</p>
<h4 data-id="heading-3">2.1 熔断器状态机</h4>
<p>熔断器有三种状态：</p>
<ol>
<li><strong>关闭（CLOSED）</strong>：正常状态，请求正常通过</li>
<li><strong>开启（OPEN）</strong>：熔断状态，直接返回失败，不调用下游服务</li>
<li><strong>半开（HALF_OPEN）</strong>：尝试恢复状态，允许少量请求通过探测服务是否恢复</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b85e4a1e2dd483b8918e05c2babb64b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769994691&amp;x-signature=rMCT5DfM8eVT%2B2dq8hlnDoGotu8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">2.2 核心代码实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.circuitbreaker;

<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicReference;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;

<span class="hljs-comment">/**
 * 自定义熔断器实现
 *
 * <span class="hljs-doctag">@author</span> 架构师
 * <span class="hljs-doctag">@version</span> 1.0.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CircuitBreaker</span> {

    <span class="hljs-comment">// 熔断器状态枚举</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">State</span> {
        CLOSED,    <span class="hljs-comment">// 关闭状态 - 正常</span>
        OPEN,      <span class="hljs-comment">// 开启状态 - 熔断</span>
        HALF_OPEN  <span class="hljs-comment">// 半开状态 - 尝试恢复</span>
    }

    <span class="hljs-comment">// 配置参数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> failureThreshold;      <span class="hljs-comment">// 失败阈值</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timeoutMillis;        <span class="hljs-comment">// 超时时间（毫秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> halfOpenWaitMillis;   <span class="hljs-comment">// 半开状态等待时间</span>

    <span class="hljs-comment">// 状态变量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicReference&lt;State&gt; state = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(State.CLOSED);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">failureCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">lastFailureTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">nextAttemptTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CircuitBreaker</span><span class="hljs-params">(<span class="hljs-type">int</span> failureThreshold, <span class="hljs-type">long</span> timeoutMillis, <span class="hljs-type">long</span> halfOpenWaitMillis)</span> {
        <span class="hljs-built_in">this</span>.failureThreshold = failureThreshold;
        <span class="hljs-built_in">this</span>.timeoutMillis = timeoutMillis;
        <span class="hljs-built_in">this</span>.halfOpenWaitMillis = halfOpenWaitMillis;
    }

    <span class="hljs-comment">/**
     * 执行请求，带熔断保护
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">execute</span><span class="hljs-params">(Supplier&lt;T&gt; supplier, Supplier&lt;T&gt; fallback)</span> {
        <span class="hljs-comment">// 检查是否可以执行请求</span>
        <span class="hljs-keyword">if</span> (!allowRequest()) {
            <span class="hljs-keyword">return</span> fallback.get();
        }

        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> supplier.get();
            <span class="hljs-comment">// 记录成功</span>
            onSuccess();
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 记录失败</span>
            onFailure(startTime);
            <span class="hljs-keyword">return</span> fallback.get();
        }
    }

    <span class="hljs-comment">/**
     * 判断是否允许请求通过
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">allowRequest</span><span class="hljs-params">()</span> {
        <span class="hljs-type">State</span> <span class="hljs-variable">currentState</span> <span class="hljs-operator">=</span> state.get();

        <span class="hljs-keyword">switch</span> (currentState) {
            <span class="hljs-keyword">case</span> CLOSED:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

            <span class="hljs-keyword">case</span> OPEN:
                <span class="hljs-comment">// 检查是否可以尝试半开</span>
                <span class="hljs-keyword">if</span> (System.currentTimeMillis() &gt;= nextAttemptTime.get()) {
                    <span class="hljs-keyword">if</span> (state.compareAndSet(State.OPEN, State.HALF_OPEN)) {
                        System.out.println(<span class="hljs-string">"熔断器进入半开状态，尝试恢复..."</span>);
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">case</span> HALF_OPEN:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-comment">/**
     * 处理成功调用
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">()</span> {
        failureCount.set(<span class="hljs-number">0</span>);

        <span class="hljs-keyword">if</span> (state.get() == State.HALF_OPEN) {
            <span class="hljs-keyword">if</span> (state.compareAndSet(State.HALF_OPEN, State.CLOSED)) {
                System.out.println(<span class="hljs-string">"服务已恢复，熔断器关闭"</span>);
            }
        }
    }

    <span class="hljs-comment">/**
     * 处理失败调用
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(<span class="hljs-type">long</span> startTime)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">currentFailures</span> <span class="hljs-operator">=</span> failureCount.incrementAndGet();
        lastFailureTime.set(System.currentTimeMillis());

        <span class="hljs-comment">// 超时也算失败</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
        <span class="hljs-keyword">if</span> (duration &gt; timeoutMillis) {
            System.out.println(<span class="hljs-string">"请求超时: "</span> + duration + <span class="hljs-string">"ms"</span>);
        }

        <span class="hljs-comment">// 检查是否需要熔断</span>
        <span class="hljs-keyword">if</span> (currentFailures &gt;= failureThreshold) {
            <span class="hljs-keyword">if</span> (state.compareAndSet(State.CLOSED, State.OPEN) ||
                state.compareAndSet(State.HALF_OPEN, State.OPEN)) {

                <span class="hljs-type">long</span> <span class="hljs-variable">waitTime</span> <span class="hljs-operator">=</span> halfOpenWaitMillis;
                nextAttemptTime.set(System.currentTimeMillis() + waitTime);

                System.out.println(<span class="hljs-string">"失败次数达到阈值 "</span> + failureThreshold + <span class="hljs-string">"，熔断器开启，等待 "</span> +
                                 waitTime + <span class="hljs-string">"ms 后尝试恢复"</span>);
            }
        }
    }

    <span class="hljs-keyword">public</span> State <span class="hljs-title function_">getState</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> state.get();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getFailureCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> failureCount.get();
    }

    <span class="hljs-meta">@FunctionalInterface</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Supplier</span>&lt;T&gt; {
        T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;
    }
}
</code></pre>
<h4 data-id="heading-5">2.3 使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.circuitbreaker;

<span class="hljs-comment">/**
 * 熔断器使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CircuitBreakerExample</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建熔断器：3次失败后熔断，超时2秒，半开等待5秒</span>
        <span class="hljs-type">CircuitBreaker</span> <span class="hljs-variable">breaker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CircuitBreaker</span>(<span class="hljs-number">3</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">5000</span>);

        <span class="hljs-comment">// 模拟远程服务调用</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> breaker.execute(
                () -&gt; {
                    <span class="hljs-comment">// 模拟远程调用</span>
                    <span class="hljs-keyword">if</span> (Math.random() &lt; <span class="hljs-number">0.4</span>) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"服务异常"</span>);
                    }
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"调用成功"</span>;
                },
                () -&gt; {
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"降级处理"</span>;
                }
            );

            System.out.println(<span class="hljs-string">"第"</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">"次调用: "</span> + result +
                             <span class="hljs-string">", 熔断器状态: "</span> + breaker.getState() +
                             <span class="hljs-string">", 失败次数: "</span> + breaker.getFailureCount());

            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">500</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-6">三、自定义限流器</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93a8f8beaea647cd8f5ba7c5b40e145b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769994691&amp;x-signature=Jspj18AsYluORilW%2FAYqlbHm1%2Bk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.1 滑动窗口算法</h4>
<p>滑动窗口算法可以更精确地控制请求速率。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11d718587c7b43ceb4d91f18c71e59d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769994691&amp;x-signature=ZmDLLdPm0A4jP7UD6QisedOiFMM%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.ratelimiter;

<span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;

<span class="hljs-comment">/**
 * 滑动窗口限流器
 *
 * <span class="hljs-doctag">@author</span> 架构师
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SlidingWindowRateLimiter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> maxRequests;        <span class="hljs-comment">// 窗口内最大请求数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> windowSizeMillis;   <span class="hljs-comment">// 窗口大小（毫秒）</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentLinkedQueue&lt;Long&gt; requestTimestamps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedQueue</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">currentCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SlidingWindowRateLimiter</span><span class="hljs-params">(<span class="hljs-type">int</span> maxRequests, <span class="hljs-type">long</span> windowSizeMillis)</span> {
        <span class="hljs-built_in">this</span>.maxRequests = maxRequests;
        <span class="hljs-built_in">this</span>.windowSizeMillis = windowSizeMillis;
    }

    <span class="hljs-comment">/**
     * 尝试获取请求许可
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">long</span> <span class="hljs-variable">windowStart</span> <span class="hljs-operator">=</span> currentTime - windowSizeMillis;

        <span class="hljs-comment">// 清理窗口外的旧记录</span>
        <span class="hljs-keyword">while</span> (!requestTimestamps.isEmpty() &amp;&amp; requestTimestamps.peek() &lt; windowStart) {
            requestTimestamps.poll();
            currentCount.decrementAndGet();
        }

        <span class="hljs-comment">// 检查是否允许新请求</span>
        <span class="hljs-keyword">if</span> (currentCount.get() &lt; maxRequests) {
            requestTimestamps.offer(currentTime);
            currentCount.incrementAndGet();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCurrentCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> currentCount.get();
    }
}
</code></pre>
<h4 data-id="heading-8">3.2 令牌桶算法</h4>
<p>令牌桶算法可以应对突发流量。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.ratelimiter;

<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;

<span class="hljs-comment">/**
 * 令牌桶限流器
 *
 * <span class="hljs-doctag">@author</span> 架构师
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenBucketRateLimiter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> capacity;           <span class="hljs-comment">// 桶容量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> refillRate;         <span class="hljs-comment">// 令牌填充速率（每秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicLong tokens;        <span class="hljs-comment">// 当前令牌数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicLong lastRefillTime; <span class="hljs-comment">// 上次填充时间</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TokenBucketRateLimiter</span><span class="hljs-params">(<span class="hljs-type">long</span> capacity, <span class="hljs-type">long</span> refillRate)</span> {
        <span class="hljs-built_in">this</span>.capacity = capacity;
        <span class="hljs-built_in">this</span>.refillRate = refillRate;
        <span class="hljs-built_in">this</span>.tokens = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(capacity);
        <span class="hljs-built_in">this</span>.lastRefillTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(System.currentTimeMillis());
    }

    <span class="hljs-comment">/**
     * 尝试消费令牌
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>)</span> {
        refillTokens();

        <span class="hljs-type">long</span> <span class="hljs-variable">currentTokens</span> <span class="hljs-operator">=</span> tokens.get();
        <span class="hljs-keyword">if</span> (currentTokens &gt;= <span class="hljs-keyword">permits</span>) {
            tokens.addAndGet(-<span class="hljs-keyword">permits</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">/**
     * 填充令牌
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refillTokens</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">long</span> <span class="hljs-variable">lastRefill</span> <span class="hljs-operator">=</span> lastRefillTime.get();
        <span class="hljs-type">long</span> <span class="hljs-variable">elapsedMillis</span> <span class="hljs-operator">=</span> now - lastRefill;

        <span class="hljs-keyword">if</span> (elapsedMillis &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-type">long</span> <span class="hljs-variable">tokensToAdd</span> <span class="hljs-operator">=</span> (elapsedMillis * refillRate) / <span class="hljs-number">1000</span>;

            <span class="hljs-keyword">if</span> (tokensToAdd &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-type">long</span> <span class="hljs-variable">newTokens</span> <span class="hljs-operator">=</span> Math.min(capacity, tokens.get() + tokensToAdd);
                tokens.set(newTokens);
                lastRefillTime.set(now);
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getAvailableTokens</span><span class="hljs-params">()</span> {
        refillTokens();
        <span class="hljs-keyword">return</span> tokens.get();
    }
}
</code></pre>
<h3 data-id="heading-9">四、生产级解决方案：Resilience4j</h3>
<p>自定义实现适合学习原理，但在生产环境中，我们推荐使用成熟的开源框架。Resilience4j是Java领域最流行的容错库。</p>
<h4 data-id="heading-10">4.1 Resilience4j核心模块</h4>
<p>Resilience4j提供多个模块，各司其职：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c5d4f26ed7140aaabebc1b17845e41d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769994691&amp;x-signature=i8mYmTectgyeLApmb2VG0zUXcbY%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>Circuit Breaker</strong>：熔断器</li>
<li><strong>Rate Limiter</strong>：限流器</li>
<li><strong>Retry</strong>：重试机制</li>
<li><strong>Timeout</strong>：超时控制</li>
<li><strong>Bulkhead</strong>：舱壁隔离（限制并发数）</li>
<li><strong>Cache</strong>：结果缓存</li>
</ul>
<h4 data-id="heading-11">4.2 快速集成</h4>
<p><strong>Maven依赖</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.resilience4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>resilience4j-spring-boot2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.resilience4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>resilience4j-circuitbreaker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.resilience4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>resilience4j-ratelimiter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.resilience4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>resilience4j-retry<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.resilience4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>resilience4j-bulkhead<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>配置文件</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">resilience4j:</span>
  <span class="hljs-attr">circuitbreaker:</span>
    <span class="hljs-attr">configs:</span>
      <span class="hljs-attr">default:</span>
        <span class="hljs-attr">failure-rate-threshold:</span> <span class="hljs-number">50</span>              <span class="hljs-comment"># 失败率阈值50%</span>
        <span class="hljs-attr">wait-duration-in-open-state:</span> <span class="hljs-string">10s</span>       <span class="hljs-comment"># 熔断开启等待时间</span>
        <span class="hljs-attr">sliding-window-size:</span> <span class="hljs-number">10</span>                <span class="hljs-comment"># 滑动窗口大小</span>
        <span class="hljs-attr">minimum-number-of-calls:</span> <span class="hljs-number">5</span>             <span class="hljs-comment"># 最小调用次数</span>
        <span class="hljs-attr">permitted-number-of-calls-in-half-open-state:</span> <span class="hljs-number">3</span>  <span class="hljs-comment"># 半开状态允许调用次数</span>

    <span class="hljs-attr">instances:</span>
      <span class="hljs-attr">remoteService:</span>
        <span class="hljs-attr">base-config:</span> <span class="hljs-string">default</span>

  <span class="hljs-attr">ratelimiter:</span>
    <span class="hljs-attr">configs:</span>
      <span class="hljs-attr">default:</span>
        <span class="hljs-attr">limit-refresh-period:</span> <span class="hljs-string">1s</span>               <span class="hljs-comment"># 限流周期</span>
        <span class="hljs-attr">limit-for-period:</span> <span class="hljs-number">100</span>                  <span class="hljs-comment"># 每周期允许请求数</span>
        <span class="hljs-attr">register-health-indicator:</span> <span class="hljs-literal">true</span>

    <span class="hljs-attr">instances:</span>
      <span class="hljs-attr">remoteService:</span>
        <span class="hljs-attr">base-config:</span> <span class="hljs-string">default</span>

  <span class="hljs-attr">retry:</span>
    <span class="hljs-attr">configs:</span>
      <span class="hljs-attr">default:</span>
        <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span>                        <span class="hljs-comment"># 最大重试次数</span>
        <span class="hljs-attr">wait-duration:</span> <span class="hljs-string">500ms</span>                   <span class="hljs-comment"># 重试等待时间</span>
        <span class="hljs-attr">retry-exceptions:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">java.lang.RuntimeException</span>

  <span class="hljs-attr">bulkhead:</span>
    <span class="hljs-attr">configs:</span>
      <span class="hljs-attr">default:</span>
        <span class="hljs-attr">max-concurrent-calls:</span> <span class="hljs-number">50</span>               <span class="hljs-comment"># 最大并发调用数</span>
        <span class="hljs-attr">max-wait-duration:</span> <span class="hljs-string">0s</span>                  <span class="hljs-comment"># 最大等待时间</span>
</code></pre>
<h4 data-id="heading-12">4.3 代码实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.resilience;

<span class="hljs-keyword">import</span> io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker;
<span class="hljs-keyword">import</span> io.github.resilience4j.ratelimiter.annotation.RateLimiter;
<span class="hljs-keyword">import</span> io.github.resilience4j.retry.annotation.Retry;
<span class="hljs-keyword">import</span> io.github.resilience4j.bulkhead.annotation.Bulkhead;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.Random;

<span class="hljs-comment">/**
 * 远程服务代理类 - 使用Resilience4j增强
 *
 * <span class="hljs-doctag">@author</span> 架构师
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteServiceProxy</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();

    <span class="hljs-comment">/**
     * 调用远程服务 - 组合使用多种容错机制
     */</span>
    <span class="hljs-meta">@CircuitBreaker(name = "remoteService", fallbackMethod = "fallback")</span>
    <span class="hljs-meta">@RateLimiter(name = "remoteService")</span>
    <span class="hljs-meta">@Retry(name = "remoteService")</span>
    <span class="hljs-meta">@Bulkhead(name = "remoteService", type = Bulkhead.Type.THREADPOOL)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">callRemoteService</span><span class="hljs-params">(String request)</span> {
        <span class="hljs-comment">// 模拟远程服务调用</span>
        simulateRemoteCall();
        <span class="hljs-keyword">return</span> <span class="hljs-string">"服务响应: "</span> + request;
    }

    <span class="hljs-comment">/**
     * 降级方法
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">fallback</span><span class="hljs-params">(String request, Exception exception)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"[降级] 服务暂时不可用，请稍后再试"</span>;
    }

    <span class="hljs-comment">/**
     * 模拟远程调用（可能失败）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">simulateRemoteCall</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 30%概率失败</span>
        <span class="hljs-keyword">if</span> (random.nextInt(<span class="hljs-number">10</span>) &lt; <span class="hljs-number">3</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"服务调用失败"</span>);
        }

        <span class="hljs-comment">// 模拟网络延迟</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">50</span> + random.nextInt(<span class="hljs-number">100</span>));
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre>
<h4 data-id="heading-13">4.4 控制器层</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.controller;

<span class="hljs-keyword">import</span> com.example.resilience.RemoteServiceProxy;
<span class="hljs-keyword">import</span> io.github.resilience4j.circuitbreaker.CircuitBreakerRegistry;
<span class="hljs-keyword">import</span> io.github.resilience4j.circuitbreaker.CircuitBreaker;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-comment">/**
 * API控制器
 *
 * <span class="hljs-doctag">@author</span> 架构师
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RemoteServiceProxy remoteService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CircuitBreakerRegistry circuitBreakerRegistry;

    <span class="hljs-meta">@GetMapping("/call/{request}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">callService</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String request)</span> {
        <span class="hljs-keyword">return</span> remoteService.callRemoteService(request);
    }

    <span class="hljs-meta">@GetMapping("/circuit-breaker/state")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getCircuitBreakerState</span><span class="hljs-params">()</span> {
        <span class="hljs-type">CircuitBreaker</span> <span class="hljs-variable">circuitBreaker</span> <span class="hljs-operator">=</span> circuitBreakerRegistry
            .circuitBreaker(<span class="hljs-string">"remoteService"</span>);

        <span class="hljs-keyword">return</span> java.util.Collections.singletonMap(<span class="hljs-string">"state"</span>,
            circuitBreaker.getState().name());
    }
}
</code></pre>
<h3 data-id="heading-14">五、生产环境实战</h3>
<h4 data-id="heading-15">5.1 系统架构</h4>
<p>在高并发系统中，我们采用多层防护策略：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/023c6bc207d540fe86c8b6058e6aae26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769994691&amp;x-signature=7y17rOPZIbaOyZf8lU9rqF82Ik4%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>网关层限流</strong>：基于IP、API路径的全局限流</li>
<li><strong>应用层熔断</strong>：针对每个下游服务的熔断保护</li>
<li><strong>数据库层连接池</strong>：限制数据库并发连接数</li>
</ol>
<h4 data-id="heading-16">5.2 典型应用场景</h4>
<p><strong>场景1：第三方API调用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> {

    <span class="hljs-meta">@CircuitBreaker(
        name = "paymentGateway",
        fallbackMethod = "localPaymentQueue"
    )</span>
    <span class="hljs-meta">@RateLimiter(name = "paymentGateway")</span>
    <span class="hljs-keyword">public</span> PaymentResult <span class="hljs-title function_">processPayment</span><span class="hljs-params">(PaymentRequest request)</span> {
        <span class="hljs-comment">// 调用第三方支付网关</span>
        <span class="hljs-keyword">return</span> paymentGatewayClient.charge(request);
    }

    <span class="hljs-keyword">private</span> PaymentResult <span class="hljs-title function_">localPaymentQueue</span><span class="hljs-params">(PaymentRequest request, Exception ex)</span> {
        <span class="hljs-comment">// 降级：写入本地队列，稍后重试</span>
        paymentQueueService.enqueue(request);
        <span class="hljs-keyword">return</span> PaymentResult.pending();
    }
}
</code></pre>
<p><strong>场景2：数据库查询保护</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Bulkhead(name = "databaseQuery", maxConcurrentCalls = 10)</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUsersByIds</span><span class="hljs-params">(List&lt;Long&gt; ids)</span> {
        <span class="hljs-comment">// 限制数据库并发查询数</span>
        <span class="hljs-keyword">return</span> userRepository.findAllById(ids);
    }
}
</code></pre>
<p><strong>场景3：缓存穿透保护</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {

    <span class="hljs-meta">@CircuitBreaker(name = "productSearch", fallbackMethod = "searchFromCache")</span>
    <span class="hljs-meta">@Cacheable(value = "products", key = "#keyword")</span>
    <span class="hljs-keyword">public</span> List&lt;Product&gt; <span class="hljs-title function_">searchProducts</span><span class="hljs-params">(String keyword)</span> {
        <span class="hljs-keyword">return</span> productRepository.search(keyword);
    }

    <span class="hljs-keyword">private</span> List&lt;Product&gt; <span class="hljs-title function_">searchFromCache</span><span class="hljs-params">(String keyword, Exception ex)</span> {
        <span class="hljs-comment">// 从缓存或ES中搜索</span>
        <span class="hljs-keyword">return</span> productCacheService.search(keyword);
    }
}
</code></pre>
<h4 data-id="heading-17">5.3 分布式限流</h4>
<p>在微服务架构中，需要实现分布式限流：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedRateLimiter</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;

    <span class="hljs-comment">/**
     * 基于Redis的分布式限流
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">int</span> limit, <span class="hljs-type">int</span> windowSeconds)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"rate:limit:"</span> + key;

        <span class="hljs-comment">// Lua脚本保证原子性</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span>
            <span class="hljs-string">"local current = redis.call('get', KEYS[1]) "</span> +
            <span class="hljs-string">"if current == false then "</span> +
            <span class="hljs-string">"    redis.call('set', KEYS[1], 1) "</span> +
            <span class="hljs-string">"    redis.call('expire', KEYS[1], ARGV[1]) "</span> +
            <span class="hljs-string">"    return 1 "</span> +
            <span class="hljs-string">"elseif tonumber(current) &lt; tonumber(ARGV[2]) then "</span> +
            <span class="hljs-string">"    return redis.call('incr', KEYS[1]) "</span> +
            <span class="hljs-string">"else "</span> +
            <span class="hljs-string">"    return 0 "</span> +
            <span class="hljs-string">"end"</span>;

        DefaultRedisScript&lt;Long&gt; script = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(luaScript, Long.class);
        <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.execute(script,
            Collections.singletonList(redisKey),
            String.valueOf(windowSeconds),
            String.valueOf(limit));

        <span class="hljs-keyword">return</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
    }
}
</code></pre>
<h3 data-id="heading-18">六、最佳实践</h3>
<h4 data-id="heading-19">6.1 配置原则</h4>
<ol>
<li><strong>失败率阈值</strong>：建议设置为50%，避免过于敏感</li>
<li><strong>熔断等待时间</strong>：根据服务恢复时间设置，一般10-30秒</li>
<li><strong>半开状态请求数</strong>：建议3-5个，避免过多请求冲击</li>
</ol>
<h4 data-id="heading-20">6.2 常见陷阱</h4>
<p><strong>错误做法1</strong>：所有服务使用统一配置</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐：一刀切</span>
<span class="hljs-meta">@CircuitBreaker(name = "default")</span>  <span class="hljs-comment">// 所有服务用同一配置</span>
</code></pre>
<p>✅ <strong>正确做法</strong>：针对不同服务特点配置</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐：个性化配置</span>
<span class="hljs-meta">@CircuitBreaker(name = "criticalService")</span>  <span class="hljs-comment">// 核心服务</span>
<span class="hljs-meta">@CircuitBreaker(name = "normalService")</span>   <span class="hljs-comment">// 普通服务</span>
</code></pre>
<p><strong>错误做法2</strong>：降级逻辑抛异常</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐：降级中抛异常</span>
<span class="hljs-keyword">private</span> String <span class="hljs-title function_">fallback</span><span class="hljs-params">(String req, Exception ex)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"降级失败"</span>); 
}
</code></pre>
<p>✅ <strong>正确做法</strong>：降级返回安全值</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐：返回默认值或缓存值</span>
<span class="hljs-keyword">private</span> String <span class="hljs-title function_">fallback</span><span class="hljs-params">(String req, Exception ex)</span> {
    <span class="hljs-keyword">return</span> getCachedValue(req); 
}
</code></pre>
<h3 data-id="heading-21">七、总结</h3>
<p>熔断限流是保障微服务高可用的核心手段。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FileCodeBox：轻量级文件快递柜，让文件分享像取快递一样简单]]></title>    <link>https://juejin.cn/post/7598710324167868431</link>    <guid>https://juejin.cn/post/7598710324167868431</guid>    <pubDate>2026-01-26T01:02:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598710324167868431" data-draft-id="7538085027172237327" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FileCodeBox：轻量级文件快递柜，让文件分享像取快递一样简单"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T01:02:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YL_jia"/> <meta itemprop="url" content="https://juejin.cn/user/1467226241383211"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FileCodeBox：轻量级文件快递柜，让文件分享像取快递一样简单
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1467226241383211/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YL_jia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T01:02:32.000Z" title="Mon Jan 26 2026 01:02:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">FileCodeBox：轻量级文件快递柜，让文件分享像取快递一样简单</h2>
<blockquote>
<p><strong>“在隐私焦虑的时代，FileCodeBox用匿名口令架起了安全与便捷的桥梁”</strong>——一位从传统网盘迁移的DevOps工程师如此评价</p>
</blockquote>
<p>当我们还在为微信文件过期、网盘限速、FTP配置复杂而烦恼时，一款基于<strong>FastAPI+Vue3</strong>开发的轻量级工具——FileCodeBox正以“文件快递柜”的理念重塑文件共享体验。它允许用户通过匿名口令分享文件，接收方凭取件码获取内容，<strong>无需注册、无需登录、即开即用</strong>。本文将深入解析这一5.8k Star开源项目的技术架构与实战应用。</p>
<hr/>
<h3 data-id="heading-1">一、核心价值：为什么FileCodeBox成为开发者的新宠？</h3>
<h4 data-id="heading-2">1. 极简架构背后的工程哲学</h4>
<p>FileCodeBox采用<strong>前后端分离架构</strong>：</p>
<ul>
<li><strong>后端</strong>：FastAPI + SQLite3（高性能异步框架，单文件数据库）</li>
<li><strong>前端</strong>：Vue3 + ElementUI（响应式界面，暗黑模式支持）</li>
<li><strong>资源占用</strong>：Docker镜像仅85MB，内存消耗&lt;100MB</li>
</ul>
<p>这种设计使得它在树莓派等边缘设备上也能流畅运行，彻底告别传统网盘的资源黑洞。</p>
<h4 data-id="heading-3">2. 六大杀手级特性</h4>
<ul>
<li><strong>无感上传体验</strong><br/>
支持拖拽文件、粘贴文本、Ctrl+V粘贴截图，上传过程如同聊天发图般自然</li>
<li><strong>军工级安全防护</strong>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[暴力破解] --&gt;|错误超5次| B(IP冻结10分钟)
  C[恶意上传] --&gt;|IP限流60次/分钟| D(请求拒绝)
</code></pre>
</li>
<li><strong>精准有效期控制</strong><br/>
可按次数（如允许提取5次）或时间（如24小时后过期）设置自毁规则</li>
<li><strong>多云存储支持</strong><br/>
通过插件化存储引擎，无缝切换本地存储与阿里云OSS/S3协议</li>
<li><strong>终端友好</strong><br/>
<code>wget https://your-domain/?code=提取码</code> 直接下载</li>
<li><strong>零成本管理</strong><br/>
管理员通过统一面板查看所有文件，一键清理敏感内容</li>
</ul>
<hr/>
<h3 data-id="heading-4">二、安装部署：5分钟构建企业级文件共享中心</h3>
<h4 data-id="heading-5">1. 单机Docker部署（推荐方案）</h4>
<p><strong>适用场景</strong>：个人/小团队快速搭建</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建持久化目录</span>
<span class="hljs-built_in">mkdir</span> -p /opt/FileCodeBox &amp;&amp; <span class="hljs-built_in">cd</span> /opt/FileCodeBox

<span class="hljs-comment"># 一键启动容器</span>
docker run -d --restart=always \
  -p 12345:12345 \
  -v $(<span class="hljs-built_in">pwd</span>):/app/data \  <span class="hljs-comment"># 持久化配置及文件</span>
  --name filecodebox \
  lanol/filecodebox:beta
</code></pre>
<p>访问 <code>http://服务器IP:12345</code> 进入前台，<code>http://服务器IP:12345/#/admin</code> 进入管理后台（初始密码：<code>FileCodeBox2023</code>）</p>
<h4 data-id="heading-6">2. 企业高可用方案</h4>
<p><strong>架构拓扑</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    Nginx --&gt; FileCodeBox1
    Nginx --&gt; FileCodeBox2
    FileCodeBox1 --&gt; OSS[阿里云OSS]
    FileCodeBox2 --&gt; OSS
</code></pre>
<p><strong>关键配置</strong>（docker-compose.yml）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">filecodebox:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">lanol/filecodebox:beta</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">STORAGE_ENGINE:</span> <span class="hljs-string">oss</span>  <span class="hljs-comment"># 启用OSS存储</span>
      <span class="hljs-attr">KeyId:</span> <span class="hljs-string">AK***************</span>  <span class="hljs-comment"># OSS访问密钥</span>
      <span class="hljs-attr">KeySecret:</span> <span class="hljs-string">SK******************</span>
      <span class="hljs-attr">OSS_ENDPOINT:</span> <span class="hljs-string">oss-cn-hangzhou.aliyuncs.com</span>
      <span class="hljs-attr">BUCKET_NAME:</span> <span class="hljs-string">your-bucket</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./config:/app/data</span>  <span class="hljs-comment"># 保留配置文件</span>
</code></pre>
<h4 data-id="heading-7">3. 安全加固实践</h4>
<p><strong>场景</strong>：企业合规要求审计日志<br/>
<strong>方案</strong>：启用数据库追踪</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 修改挂载目录中的.env</span>
AUDIT_LOG_ENABLED=True
AUDIT_LOG_PATH=/app/data/audit.log
</code></pre>
<p><strong>效果</strong>：所有文件操作（上传/下载/删除）记录IP、时间、操作类型，满足等保2.0要求</p>
<hr/>
<h3 data-id="heading-8">三、企业实战案例：从临时分享到生产级应用</h3>
<h4 data-id="heading-9">案例1：金融公司合规文件传输</h4>
<p><strong>挑战</strong>：某支付机构需向监管机构报送交易数据，但禁止使用微信/邮箱发送敏感文件。</p>
<p><strong>FileCodeBox解决方案</strong>：</p>
<ol>
<li><strong>安全策略配置</strong>：
<pre><code class="hljs language-env" lang="env"># .env 安全强化配置
FILE_SIZE_LIMIT=50  # 文件上限50MB
UPLOAD_COUNT=3      # 每个IP每天限传3次
ERROR_COUNT=3       # 密码错误3次冻结IP
</code></pre>
</li>
<li><strong>操作流程</strong>：
<ul>
<li>业务员上传加密压缩包，设置<strong>1次提取权限+2小时有效期</strong></li>
<li>系统生成取件码，通过安全信道发送至监管方</li>
<li>监管方下载后文件自动销毁
<strong>成效</strong>：数据泄露风险降低90%，审计通过率100%</li>
</ul>
</li>
</ol>
<h4 data-id="heading-10">案例2：制造业分布式固件分发</h4>
<p><strong>挑战</strong>：某汽车零件厂需向全球8个工厂下发设备固件，FTP服务器跨国传输慢。</p>
<p><strong>技术方案</strong>：</p>
<ol>
<li>中心节点部署FileCodeBox + 阿里云OSS加速</li>
<li>各工厂通过内网缓存节点同步：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 工厂节点定期同步脚本</span>
wget -O firmware.bin <span class="hljs-string">"https://center.com/?code=FX29K"</span>
<span class="hljs-built_in">md5sum</span> firmware.bin | grep -q <span class="hljs-string">"a1b2c3d4"</span> &amp;&amp; flash_firmware
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-11">四、高阶技巧：解锁90%用户未知的用法</h3>
<h4 data-id="heading-12">1. CLI自动化运维</h4>
<p>通过API实现无人值守操作：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python自动上传巡检报告</span>
<span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">"http://filecodebox.domain/upload"</span>
files = {<span class="hljs-string">'file'</span>: <span class="hljs-built_in">open</span>(<span class="hljs-string">'daily_check.log'</span>, <span class="hljs-string">'rb'</span>)}
data = {<span class="hljs-string">'expire_type'</span>: <span class="hljs-string">'time'</span>, <span class="hljs-string">'expire_value'</span>: <span class="hljs-number">24</span>}  <span class="hljs-comment"># 24小时过期</span>
headers = {<span class="hljs-string">'X-Management-Key'</span>: <span class="hljs-string">'企业密钥'</span>}  <span class="hljs-comment"># 后台配置密钥</span>

r = requests.post(url, files=files, data=data, headers=headers)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"取件码：<span class="hljs-subst">{r.json()[<span class="hljs-string">'code'</span>]}</span>"</span>)
</code></pre>
<h4 data-id="heading-13">2. 跨系统集成方案</h4>
<p><strong>场景</strong>：与钉钉机器人联动<br/>
<strong>步骤</strong>：</p>
<ol>
<li>配置钉钉机器人Webhook</li>
<li>文件上传后触发通知：
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 钉钉消息模板</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"msgtype"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"markdown"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"markdown"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"新文件待取"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"文件：${filename}\n有效期：${expire}\n取件码：`${code}`"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-14">3. 存储优化实战</h4>
<p><strong>问题</strong>：本地磁盘空间不足<br/>
<strong>解决方案</strong>：挂载NFS或启用OSS</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.yml 片段</span>
<span class="hljs-attr">volumes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">/nfs/filecodebox:/app/data</span>  <span class="hljs-comment"># NFS挂载</span>
<span class="hljs-attr">environment:</span>
  <span class="hljs-attr">STORAGE_ENGINE:</span> <span class="hljs-string">oss</span>  <span class="hljs-comment"># 或使用S3协议</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">五、与传统工具的对比</h3>















































<table><thead><tr><th><strong>能力维度</strong></th><th><strong>FileCodeBox</strong></th><th><strong>WeTransfer</strong></th><th><strong>自建FTP</strong></th></tr></thead><tbody><tr><td>部署复杂度</td><td>⭐（Docker一键启动）</td><td>⭐⭐⭐⭐（需公有云）</td><td>⭐⭐⭐（配置复杂）</td></tr><tr><td>隐私保护</td><td>✅ 匿名分享+无用户数据</td><td>❌ 需手机号/邮箱</td><td>⚠️ 依赖账号体系</td></tr><tr><td>传输加密</td><td>TLS 1.3端到端加密</td><td>✅</td><td>❌ 明文传输</td></tr><tr><td>成本</td><td>0（开源）</td><td>付费版$12/月起</td><td>服务器费用</td></tr><tr><td>定制开发</td><td>✅ 完整API+开源代码</td><td>❌</td><td>⚠️ 有限</td></tr><tr><td>企业级扩展</td><td>✅ OSS/S3/高可用</td><td>✅</td><td>❌</td></tr></tbody></table>
<blockquote>
<p><strong>结论</strong>：FileCodeBox在<strong>隐私安全</strong>和<strong>可控性</strong>上完胜，尤其适合对数据主权要求高的场景</p>
</blockquote>
<hr/>
<h3 data-id="heading-16">六、未来演进：2025年路线图解析</h3>
<p>根据核心开发者访谈，FileCodeBox将聚焦三大方向：</p>
<ol>
<li><strong>区块链存证</strong>：文件哈希上链，实现不可篡改的传输审计</li>
<li><strong>边缘计算支持</strong>：集成Web3.storage，实现IPFS分布式存储</li>
<li><strong>AI安全增强</strong>：
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  上传文件 --&gt; AI扫描
  AI扫描 --&gt;|敏感内容| 自动加密
  AI扫描 --&gt;|恶意软件| 拦截删除
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-17">结语：工具的本质是回归用户价值</h3>
<p>FileCodeBox的成功不在于技术颠覆，而在于<strong>精准抓住了“临时文件分享”这一高频痛点</strong>。当开发者不再为10MB的小文件搭建FTP，当业务人员能安全传递客户数据，效率提升便水到渠成。</p>
<blockquote>
<p><strong>实践箴言</strong>：</p>
<ol>
<li><strong>轻量起步</strong>：从团队内部临时分享切入，逐步替代微信文件传输</li>
<li><strong>安全左移</strong>：初始部署即配置IP限流与错误封锁</li>
<li><strong>文化适配</strong>：通过取件码机制培养用户“用完即焚”的安全意识</li>
</ol>
</blockquote>
<p>正如某科技公司CTO所言：<em>“自从用了FileCodeBox，公司钉钉群里的‘文件已过期’投诉减少了87%”</em>。</p>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvastsa%2FFileCodeBox" target="_blank" title="https://github.com/vastsa/FileCodeBox" ref="nofollow noopener noreferrer">github.com/vastsa/File…</a><br/>
<strong>中文文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffilecodebox.cn%2Fdocs" target="_blank" title="https://filecodebox.cn/docs" ref="nofollow noopener noreferrer">filecodebox.cn/docs</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂 Skills｜从概念到实操的完整指南]]></title>    <link>https://juejin.cn/post/7599528186586595338</link>    <guid>https://juejin.cn/post/7599528186586595338</guid>    <pubDate>2026-01-26T10:27:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599528186586595338" data-draft-id="7599485473707245606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂 Skills｜从概念到实操的完整指南"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-26T10:27:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂 Skills｜从概念到实操的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:27:18.000Z" title="Mon Jan 26 2026 10:27:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/498562aa9ed8432ba9e87cda7d4a062e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=8yAuhMePtapSu%2FGOazhGCXYsOOU%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：咸鱼，TRAE 开发者用户</p>
</blockquote>
<blockquote>
<p>Agent 正在经历从“聊天机器人”到“得力干将”的进化，而 <strong>Skills</strong> 正是这场进化的关键催化剂。</p>
<p>你是否曾被 Agent 的“不听话”、“执行乱”和“工具荒”搞得焦头烂额？</p>
<p>本文将带你一文弄懂 <strong>Skills</strong> ——这个让 Agent 变得可靠、可控、可复用的“高级技能包”。</p>
<p>我们将从 Skills 是什么、如何工作，一路聊到怎样写好一个 Skills，并为你推荐实用的社区资源，带领大家在 TRAE 中实际使用 Skills 落地一个场景。</p>
<p>无论你是开发者还是普通用户，都能在这里找到让你的 Agent “开窍”的秘诀。</p>
</blockquote>
<p><strong>你是否也经历过或者正在经历这样的“ Agent 调教”崩溃时刻？</strong></p>
<ul>
<li>
<p><strong>规则失效：</strong> 在 Agent.md 里写下千言万语，Agent 却视若无睹，完全“已读不回”。</p>
</li>
<li>
<p><strong>执行失控：</strong> 精心打磨了无数 Prompt，Agent 执行起来依旧像无头苍蝇，混乱无序。</p>
</li>
<li>
<p><strong>工具迷失：</strong> 明明集成了强大的 MCP 工具库，Agent 却两手一摊说“没工具”，让人摸不着头脑。</p>
</li>
</ul>
<p>如果这些场景让你感同身受，别急着放弃。<strong>终结这场混乱的答案，可能就是 Skills。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e689cd9039c147278c306e13ec24004b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=rQmSbPXhzErYNi1J59HU%2BG28NpE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>什么是 Skills</strong></h2>
<p>“Skills” 这个概念最早由 Anthropic 公司提出，作为其大模型 Claude 的一种能力扩展机制。简单来说，它允许用户为 Claude 添加自定义的功能和工具。随着这套做法越来越成熟，并被社区广泛接受，Skills 如今已成为大多数 Agent 开发工具和 IDE 都支持的一种标准扩展规范。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30a3492ffbfb4f8c86543ba47e2714c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=ZAMUCjEIT1Qsuj9AL5ySwVGdSDg%3D" alt="" loading="lazy"/></p>
<p>一个 Skills 通常以一个文件夹的形式存在，里面主要装着三样东西：<strong>一份说明书（SKILL.md）、一堆操作脚本（Script）、以及一些参考资料（Reference）。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfdff3d6d6954816a0947ee5d3625652~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=sfdkPQw4lDQu9Z0no9AlRw67wPE%3D" alt="640 (1).png" loading="lazy"/></p>
<p>你可以把一个 Skill 想象成一个打包好的“技能包”。它把完成某个特定任务所需的<strong>领域知识、操作流程、要用到的工</strong> <strong>具、以及最佳实践</strong>全都封装在了一起。当 AI 面对相应请求时，就能像一位经验丰富的专家那样，有条不紊地自主执行。</p>
<p><strong>一句话总结：</strong> 要是把 Agent 比作一个有很大潜力的大脑，那 <strong>Skills 就像是给这个大脑的一套套能反复用的“高级武功秘籍”。</strong> 有了它，Agent 能从一个“什么都略知一二”的通才，变成在特定领域“什么都擅长”的专家。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2a8152998b547a08a8a54e8b8459b38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=YXPCIbBAv5x0stu2X3HnINwDbqk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>Skill 原理介绍</strong></h2>
<p>📚 官方解释：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Foverview" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p>
<h4 data-id="heading-2"><strong>Skill 的架构原理：渐进式加载</strong></h4>
<p>Skill 的设计很巧妙，它运行在一个沙盒环境里，这个环境允许大模型访问文件系统和执行 <em><strong>bash</strong></em> 命令（可以理解为一种电脑操作指令）。在这个环境里，一个个 Skill 就像一个个文件夹。Agent 就像一个熟悉电脑操作的人，通过命令行来读取文件、执行脚本，然后利用结果去完成你交代的任务。这种“按需取用”的架构，让 Skill 成为一个既强大又高效的“工具箱”。</p>
<p>为了平衡效果和效率，Skill 设计了一套聪明的三层分级加载机制：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fde448de57f540409d9264c41d82cb2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=ovVLGJjnunTuBQBwoHOtruHUCEc%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f254ff2a09d2490fbfcb8147c257b216~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=mBe29p0fLEw%2BVAU6tX%2B6aHe694M%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3"><strong>Level 1：元数据（始终加载）</strong></h4>
<p>元数据就像是 Skill 的“名片”，里面有名称（<em><strong>name</strong></em>）和描述（<em><strong>description</strong></em>），是用 YAML 格式来定义的。Claude 在启动的时候，会把所有已经安装的 Skill 的元数据都加载进来，这样它就能知道每个 Skill 有什么用、什么时候该用。因为元数据很轻量，所以你可以安装很多 Skill，不用担心把上下文占满。</p>
<h4 data-id="heading-4"><strong>Level 2：说明文档（触发时加载）</strong></h4>
<p><em><strong>SKILL.md</strong></em> 文件的正文就是说明文档，里面有工作流程、最佳实践和操作指南。只有用户的请求和 Skills 元数据里的描述相符时，Claude 才会用 <em><strong>bash</strong></em> 指令读取这份文档，把内容加载到上下文里。这种“触发式加载”能保证只有相关的详细指令才会消耗 Token。</p>
<h4 data-id="heading-5"><strong>Level 3：资源与代码（按需加载）</strong></h4>
<p>Skills 还能打包一些更深入的资源，比如更详细的说明文档（<em><strong>FORMS.md</strong></em>）、可执行脚本（ <em><strong>.py</strong></em>）或者参考资料（像 API 文档、数据库结构等）。Claude 只有在需要的时候，才会通过 <em><strong>bash</strong></em> 去读取或执行这些文件，而且脚本代码本身不会进入上下文。这样一来，Skills 就能捆绑大量信息，几乎不会增加额外的上下文成本。</p>
<h3 data-id="heading-6"><strong>Skills 的调用逻辑：从理解意图到稳定执行</strong></h3>
<p>那么，Agent 是如何智能地选择并执行一个 Skill 的呢？整个过程就像一位经验丰富的助理在处理工作：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56d095ed53234caca572363ae4de6a9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=%2FAivTlcRt5aFuEPnrm2Mv2vPQT0%3D" alt="" loading="lazy"/></p>
<ol>
<li>
<p><strong>意图匹配（找到对的人）：</strong> Agent 首先聆听你的需求，然后快速扫一眼自己手头所有 Skill 的“名片夹”（元数据），寻找最匹配的那一张。</p>
</li>
<li>
<p><strong>读取手册（看懂怎么干）：</strong> 找到合适的 Skills 后，Agent 会像模像样地翻开它的“操作手册”（<em><strong>SKILL.md</strong></em>），仔细研究详细的执行步骤和注意事项。</p>
</li>
<li>
<p><strong>按需执行（动手开干）：</strong> 根据手册的指引，Agent 开始工作。如果需要，它会随时从“工具箱”里拿出脚本或工具来完成具体操作。</p>
</li>
<li>
<p><strong>反馈结果（事毕复命）：</strong> 任务完成后，Agent 向你汇报最终结果，或者在遇到困难时，及时向你请教。</p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be94cd4da1f84612aab5a51c9ad0891f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=kfzTOJ2f%2FrSvosdXCKwQ1jG775o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7"><strong>Skills  vs.  其他概念的区别</strong></h2>
<p>为了更清晰地理解 Skills 的独特价值，我们不妨把它和另外两个容易混淆的概念——<strong>快捷指令（Command）</strong> 和<strong>原子工具（MCP）</strong> ——放在一起做个对比。用一个厨房的例子就很好懂了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46415a2bb9a74a72b49cd886e62cbb8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=H6Rn5XSrDc5azaMkgyh32pCPQ3A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b51047922b214010b0b7d886fa290af8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=iizVN7MLxbJ5Loaksvy%2BDDA07yw%3D" alt="" loading="lazy"/></p>
<p>我们也列举了几个大家容易混淆的其他功能，一起来对比看看。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ae20becf7a54b9c8dd9d689096c4ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=umQTI6W%2FXB%2BHCsNqSPZHqhqcr1g%3D" alt="" loading="lazy"/></p>
<p>📚 官方博客解释：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fskills-explained" target="_blank" title="https://claude.com/blog/skills-explained" ref="nofollow noopener noreferrer">claude.com/blog/skills…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0526612b042f4c788613b5eac6bc5155~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=Q6da1excp3hmiXA8pHZF9Zkkrno%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8"><strong>什么是好的 Skills：从“能用”到“好用”</strong></h2>
<p><strong>Good Skills vs Bad Skills</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/260567fa689b4cd0be8befc0ddfdfcb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=G1LvLKremMuB9DqfpkHT%2FwMoPmM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>如何写好 Skills</strong></h3>
<ol>
<li>
<p><strong>原子性（Atomicity）：</strong> 坚持单一职责，让每个 Skill 都像一块积木，小而美，专注于解决一个具体问题，便于日后的复用和组合。</p>
</li>
<li>
<p><strong>给例子（Few-Shot Prompting）：</strong> <strong>这是最关键的一点</strong>，与其费尽口舌解释，不如直接给出几个清晰的输入输出示例。榜样的力量是无穷的，模型能通过具体例子，秒懂你想要的格式、风格和行为。</p>
</li>
<li>
<p><strong>立规矩（Structured Instructions）：</strong></p>
<p><strong>1) 定角色：</strong> 给它一个明确的专家人设，比如“你现在是一个资深的市场分析师”。</p>
<p><strong>2) 拆步骤：</strong> 把任务流程拆解成一步步的具体指令，引导它“思考”。</p>
<p><strong>3) 画红线：</strong> 明确告诉它“不能做什么”，防止它天马行空地“幻觉”</p>
</li>
<li>
<p><strong>造接口（Interface Design）：</strong> 像设计软件 API 一样，明确定义 Skill 的输入参数和输出格式（比如固定输出 JSON 或 Markdown）。这让你的 Skill 可以被其他程序稳定调用和集成。</p>
</li>
</ol>

<ol start="5">
<li><strong>勤复盘（Iterative Refinement）：</strong> 把 Skills 当作一个产品来迭代。在实际使用中留心那些不尽如人意的“Bad Case”，然后把它们变成新的规则或反例，补充到你的 Skills 定义里，让它持续进化，越来越聪明、越来越靠谱。</li>
</ol>
<p>📚 一些官方最佳实践指南 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fzh-CN%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/zh-CN/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/zh-CN/…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90124ad767404c5da449c53d544012aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=urA0pky4RXmFjJIVB1Ho8wnJb%2Fo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10"><strong>社区热门 Skills 推荐</strong></h2>
<p>刚开始接触 Skills，不知从何下手？不妨从社区沉淀的这些热门 Skills 开始，寻找灵感，或直接在你的工作流中复用它们。</p>
<h3 data-id="heading-11"><strong>Claude 官方提供的 Skills</strong></h3>
<p>📚 官方 Skills 仓库  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p>学习 Claude 官方的 Skills 仓库可以帮助我们最快的了解 Skills 的最佳实践，便于我们沉淀出自己的 Skills。</p>
<blockquote>
<p><strong>如何快速使用官方 Skills？</strong></p>
<p>大多数官方 Skills 都能直接下载，或者通过 Git 克隆到本地。在 TRAE 等工具里，一般只需把这些 Skills 的文件夹放到指定的 <em><strong>Skills</strong></em> 目录，接着重启或刷新 Agent，它就会自动识别并加载这些新能力。具体操作可参考工具的使用文档。</p>
<p>更多细节可参考下面这部分内容：<strong>如何在 TRAE 里快速用起来</strong></p>
</blockquote>
<p><strong>Claude 官方提供的 Skills 列表</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d3df5f253864939bfefa0c7ef8b5852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=jbuN31Rn4gWzYgvofxBB0YIqWr0%3D" alt="show_679493203_1769422730184.png" loading="lazy"/></p>
<h3 data-id="heading-12"><strong>社区其他最佳实践</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e34611085a1c475bb4b2f26285f21bca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=EdlPHC3DgsQUx3M2B%2BbVa%2FhNCa8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/530b1a02e08f45e18af7f7b78cf14941~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=a1gu3tF9yc%2FZSIU6omjYanf8yO8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13"><strong>如何在 TRAE 里快速使用</strong></h2>
<p>理论说再多，不如亲手一试。我们先讲一下如何在 TRAE SOLO 中创建并应用一个 Skill 并以基于飞书文档的 Spec Coding 为例讲解一下如何利用 Skills 快速解决一个实际问题。</p>
<h3 data-id="heading-14"><strong>Skill 创建</strong></h3>
<p><strong>方式一：设置中直接创建</strong></p>
<p>TRAE 支持在设置页面可以快速创建一个 Skill</p>
<p>按下快捷键 Cmd +/ Ctrl + 通过快捷键打开设置面板。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6894be68150545ddafcf6a2aed27535f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=TYNNesb3q6i7yffMCBgn9CyPTM0%3D" alt="" loading="lazy"/></p>
<p>在设置面板左侧找到「规则技能」选项</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec94a84497d24c56b026679c6bd190b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=5itKsgX1rjNRS2%2FJde7bVO9O4T8%3D" alt="" loading="lazy"/></p>
<p>找到技能板块，点击右侧的「创建」按钮。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39b8d09b9a29433ca09059bae34c9f18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=r0T71CKdS%2FIy3Ky3cX%2FGqrGANQw%3D" alt="" loading="lazy"/></p>
<p>你会看到一个简洁的创建界面，包含三要素：<strong>Skill 名称、Skill 描述、Skill 主体</strong>。我们以创建一个“按规范提交 git commit”的 Skill 为例，填入相应内容后点击「确认」即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b45f17d81c4b4c1083bd0c3a209a6927~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=epgAmv7m272oFkGSweS3o4hjhmU%3D" alt="" loading="lazy"/></p>
<p>填入我们需要的内容「确认」即可</p>
<p><strong>方式二：直接解析 SKILL.md</strong></p>
<p>在当前项目目录下，新增目录.<em><strong>trae/Skills/xxx</strong></em> 导入你需要文件夹，和 TRAE 进行对话，即可使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b54f715d553d4c68b517da01516f94e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=Ezz0ssjg2toioy99GRMnaRy5tx0%3D" alt="" loading="lazy"/></p>
<p>可以在「设置 - 规则技能」中看到已经成功导入</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbc7108b9e804a7680d0ceea27012dfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=nugFbLMyBtdfy%2B4J1ycjChfUYdE%3D" alt="" loading="lazy"/></p>
<p><strong>方式三：在对话中创建</strong></p>
<p>目前 TRAE 中内置了 Skills-creator Skills ，你可以在对话中直接和 TRAE 要求创建需要的 Skills</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b10a41b1e3b4ac1841e9c908c4a4c37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=bmyFQIg0HGR5ulMwl9TZbLOtAJc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15"><strong>Skill 使用</strong></h3>
<p>在 TRAE 里使用技能很容易，你加载好需要的技能后，只需在对话框中用日常语言说明你的需求就行。</p>
<ul>
<li>
<p>例如，输入“帮我设计一个有科技感的登录页面”，系统就会自动调用“frontend-design”技能。</p>
</li>
<li>
<p>例如，输入“帮我提取这个 PDF 里的所有表格”，系统会自动调用“document-Skills/pdf”技能。</p>
</li>
<li>
<p>例如，输入“帮我把这片技术文档转为飞书文档”，系统会自动调用“using-feishu-doc”技能。</p>
</li>
</ul>
<p>系统会自动分析你的需求，加载技能文档，还会一步步指导你完成任务！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5175bab9f2b4529b0f54eac980ae4e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=PfyED%2BwpHDPFoCnxTOJO7oe1RAE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16"><strong>实践场景举例</strong></h3>
<p>还记得引言里提到的那些问题吗？比如说，项目规则文件（<em><strong>project_rules</strong></em>）有字符数量的限制；又或者，就算你在根规则文件里明确写好了“在什么情况下读取哪个文件”，Agent 在执行任务时也不会按照要求来做。</p>
<p>这些问题的根本原因是，<strong>规则（Rules）对于 Agent 而言是固定不变的</strong>，它会在任务开始时就把所有规则一次性加载到上下文中，这样既占用空间，又不够灵活。而 <strong>技能（Skill）采用的是“逐步加载”的动态方式</strong>，刚好可以解决这个问题。所以，我们可以把之前那些复杂的规则场景，重新拆分成一个个独立的技能。</p>
<p><strong>接下来，我们通过一个基于飞书文档的“Spec Coding”简单流程，来实际操作一下如何用技能解决问题。</strong></p>
<h4 data-id="heading-17"><strong>什么是 Spec Coding？</strong></h4>
<p>Spec Coding 提倡“先思考后行动”，也就是通过详细定义可以执行的需求规范（Specification）来推动 AI 开发。它的流程包含“需求分析、技术设计、任务拆解”的文档编写过程，最后让 AI 根据规范来完成编码。这种一步步的工作流程能保证每一步都有依据，实现从需求到代码的准确转化。</p>
<p><strong>让我来分析一下这个场景</strong></p>
<p>上面提到将开发过程划分为四个关键阶段，所以要完成 “需求分析、技术设计、任务拆解” 的飞书文档撰写，还有最终的代码实现。为此，我们需要不同的技能来满足不同场景下的文档编写需求，并且要教会 Agent 如何使用飞书工具进行创作协同。</p>
<p><strong>下面我们就一起完成上面提到的 Skills 的设计实现。</strong></p>
<h4 data-id="heading-18"><strong>多角色专家 Skills</strong></h4>
<p>通过实现多角色 Skills 通过创建多个交付物过程文档，约束后续的编码，为编码提供足够且明确的上下文，每个Skill 专注完成一件事</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3af5b203e7e446cbb42409995896ef7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=x2DJMDCBO%2FKvmlfA8f5nD4EIO%2BM%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>下面让我们进一步详细设计</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbbbe68dfda9491798c69f32a084deb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=whcmN6%2B0R4rMiB19SW6pl38vBOc%3D" alt="" loading="lazy"/></p>
<p>按照上述的表格我们就可以大致明确我们需要的 Skills 该如何实现了。</p>
<ul>
<li>本次只作为一个例子大家可以参考上面创建 Skill 的教程自己完成一下这个多角色 Skills 的创建和调试，当然正如上面所述好的 Skill 需要在实践中逐渐优化并通过场景调用不断进行优化的</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/046c201b33704525a24d8d32fdca1e9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=tx2MC2Em5jcPSBfbk%2BaJO0SNNZc%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9a0bcd187364746b74ee2f272c8d73a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=2tTeQMuH9IxdOP3XQlLvdlVWWLo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-19"><strong>飞书文档使用 Skill</strong></h4>
<p>飞书文档的格式是 markdown 的超集，<strong>我们 Skill 的目的则是教会 Agent 飞书文档的语法</strong>，便于 Agent 写出符合格式的 md 文件。并通过约束 Agent 行为，<strong>充分利用飞书文档的评论的读写完成多人协作审阅的过程</strong>，用户通过在飞书文档评论完成相关建议的提出，Agent 重新阅读文档和评论，根据建议进一步优化文档，<strong>实现文档协作工作流。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/330f2aeb47764d91b04fb728d4464f08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=VejIhkIHalFsBne1uvVTRCaw5UM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-20"><strong>Spec Coding Skill</strong></h4>
<p>上面我们实现了多个角色 Skills 和一个功能 Skill，但实际使用时，还需要有一个能统筹全局的技能，来实现分工协作。把上述多个技能组合起来，告诉智能体（agent）整体的规格编码（spec coding）流程，完成工具技能和角色技能的组合与调度。</p>
<p>如此我们就能快速搭建一个规格编码工作流程，完成基础开发。当然也可以参考上面的逻辑，用技能来重新复刻社区里的规格编码实践（如 SpecKit、OpenSpec 等）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5701078e580497895f98d1efd77d5d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=vq%2BTCQxE%2F6DhdQKDYt7WFoPGPUw%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7925bbc8e2d14f1b80591c4e60cc2176~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=oGg%2BqMgLQuYpKDdZUviIUAze4Pc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-21"><strong>总结</strong></h4>
<p>上述场景提到了两种不同风格的 Skill（角色型，工具型），利用 <strong>Skill 的动态加载机制</strong>（取代固定规则的一次性加载方式），完成了复杂场景下的任务分解；通过 <strong>不同角色技能的分工协作</strong>（避免 Agent 什么都做导致执行混乱）；尝试借助<strong>飞书文档形成协作闭环</strong>（打通人机交互的最后一步），有效解决了 Agent “不听话、执行乱、工具少” 的问题，让 AI 从 “对话助手” 真正转变为 “可信赖的实干家”，实现从需求提出到代码产出的高效、精准、协作式交付。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/580d8eed249c4a98ae1233f298611cff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=s2iEalF5pfkW%2Fe6eCvci1rjS7tE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-22"><strong>Q &amp; A | 一些常见问题</strong></h2>
<h3 data-id="heading-23"><strong>为什么我写的 Skills 不生效，或者效果不符合预期？</strong></h3>
<p><strong>那十有八九是你的“名片”（</strong> <em><strong>Description</strong></em> <strong>）没写好。</strong></p>
<p>记住，Agent 是通过读取 Skills 的 <em><strong>Description</strong></em> 来判断“什么时候该用哪个 Skill”的。要是你的描述写得含糊不清、太专业或者太简单，Agent 就很难明白你的意思，自然在需要的时候就不会调用这个 Skill。所以，<strong>用大白话写的清晰、准确的</strong> <em><strong>Description</strong></em> <strong>，对 Skill 能否起作用至关重要。</strong></p>
<h3 data-id="heading-24"><strong>使用 Skills 的效果，会受到我选择的大语言模型（LLM）的影响吗？</strong></h3>
<p><strong>会有影响，不过影响的方面不一样。</strong></p>
<ul>
<li>
<p><strong>一个更强大的模型，主要影响“挑选”和“安排”技能的能力。</strong> 它能更准确地明白你的真实想法，然后从一堆技能里挑出最适合的一个或几个来解决问题。它的优势体现在制定策略方面。</p>
</li>
<li>
<p><strong>而技能本身，决定了具体任务执行的“最低水平”和“稳定性”。</strong> 一旦某个技能被选中，它里面设定好的流程和代码是固定的，会稳定地运行。所以，技能编写得好不好，直接决定了具体任务能不能出色完成。。</p>
</li>
</ul>
<h3 data-id="heading-25"><strong>Skills 是不是万能的？有什么它不擅长做的事情吗？</strong></h3>
<p><strong>当然不是万能的。</strong> Skills 的主要优势是<strong>处理那些流程明确、边界清晰的任务。</strong> 在下面这些情况中，它可能就不是最好的选择了：</p>
<ul>
<li>
<p><strong>需要高度创造力的任务：</strong> 像写一首饱含情感的诗，或者设计一个全新的品牌标志。这类工作更需要大模型本身的“灵感”。</p>
</li>
<li>
<p><strong>需要实时、动态做决策的复杂策略游戏：</strong> 比如在变化极快的金融市场中做交易决策。</p>
</li>
<li>
<p><strong>单纯的知识问答或开放式闲聊：</strong> 如果你只是想问“文艺复兴三杰是谁？”，直接问大模型就可以，不用动用 Skills 这个“大杀器”。</p>
</li>
</ul>
<h3 data-id="heading-26"><strong>我发现一个社区的 Skills 很好用，但我可以修改它以适应我的特殊需求吗？</strong></h3>
<p><strong>当然可以，我们强烈建议你这么做！</strong></p>
<p>大多数共享的 Skill 都支持用户“Fork”（也就是“复制一份”）并进行二次开发。你可以把通用的 Skill 当作模板，在自己的工作空间里复制一份，然后修改里面的逻辑或参数，以适应你自己的业务需求。这对整个生态的共建和知识复用很重要。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c2dfe38cb3454f81679a9548f08458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=cJCENj%2BpTeNPQE468eNnku7SJfc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-27"><strong>结语｜让 Agent 成为你真正的“行动派”</strong></h2>
<p>Skill 的出现，为 AI 从“对话式助手”转变为“可信赖的执行者”搭建了关键的技术桥梁。它用结构化的方法把领域知识、操作流程和工具调用逻辑封装起来，解决了 Agent 规则失效、执行失控的混乱问题，让 AI 的能力输出变得可以控制、值得信赖且高效。</p>
<p>Skill 的核心价值在于：</p>
<ul>
<li>
<p><strong>精准实际痛点：</strong> 通过巧妙的三级加载机制（元数据→说明文档→资源）平衡上下文效率与功能深度，在功能深度和上下文效率之间找到了一个绝佳的平衡点，既避免了宝贵 Token 的浪费，又确保了任务执行的精准性，实现了 Agent 上下文的动态加载能力。</p>
</li>
<li>
<p><strong>生态赋能，降低门槛：</strong> 无论是官方还是社区，都提供了丰富的资源（如 Claude 官方仓库、SkillsMP 市场等），让普通用户也能轻松站在巨人的肩膀上，快速复用各种成熟的能力。</p>
</li>
</ul>
<p>虽然 Skill 不是万能的，但它在“确定性流程任务”上的优势无可替代。未来，随着 AI 模型能力的提升与 Skill 生态的进一步完善，我们有望看到更多跨领域、可组合的 Skill 出现——<strong>让 AI 从“样样懂一点”的通才，真正进化为“事事做得好”的专家协作伙伴。</strong></p>
<p><strong>不妨从今天开始，尝试创建你的第一个 Skill：将你最擅长的领域经验封装成可复用的能力，让 AI 成为你延伸专业价值的放大器。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型系列之-RAG技术深度解析：从基础架构到实战应用]]></title>    <link>https://juejin.cn/post/7598699872553074724</link>    <guid>https://juejin.cn/post/7598699872553074724</guid>    <pubDate>2026-01-25T16:08:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598699872553074724" data-draft-id="7598537739517263914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型系列之-RAG技术深度解析：从基础架构到实战应用"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-25T16:08:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="正儿八经蛙"/> <meta itemprop="url" content="https://juejin.cn/user/4101648892575020"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型系列之-RAG技术深度解析：从基础架构到实战应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4101648892575020/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    正儿八经蛙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T16:08:35.000Z" title="Sun Jan 25 2026 16:08:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>一开始接触大模型问答的时候，发现直接问它一些最新的、或者公司内部的知识，它就开始胡说八道了，要么说“我的知识截止到...”，要么就一本正经地编答案，干！！</p>
<p>后来发现有个叫<strong>RAG（检索增强生成）</strong> 的技术能解决这个问题，说白了就是“<strong>不会就查，查完再答</strong>”。我用下来之后发现，这玩意儿是真香，但坑也是真多。今天就把我折腾RAG的实战经验，从核心架构到优化技巧，一次性给你讲明白。</p>
<h3 data-id="heading-1">核心架构：拆开看看里面都有啥</h3>
<p>一个完整的RAG系统，其实就像个聪明的图书管理员。你问问题，它先去资料库（向量数据库）里翻找最相关的几本书（文档片段），然后把这几页内容和你问题一起，交给大模型去组织答案。</p>
<p>整个流程拆开看，主要就这几块：</p>
<h4 data-id="heading-2">1. 文档处理流水线（Ingestion Pipeline）</h4>
<p>这是最基础也最容易出问题的地方。你的PDF、Word、网页，都得先变成大模型能“吃”的格式。</p>
<pre><code class="hljs language-arduino" lang="arduino"># 一个简单的文档处理示例，用LangChainfrom langchain.document_loaders <span class="hljs-keyword">import</span> PyPDFLoaderfrom langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter# 加载文档loader = <span class="hljs-built_in">PyPDFLoader</span>(<span class="hljs-string">"公司手册.pdf"</span>)documents = loader.<span class="hljs-built_in">load</span>()# 切分文档 - 这里就有讲究了！text_splitter = <span class="hljs-built_in">RecursiveCharacterTextSplitter</span>(    chunk_size=<span class="hljs-number">500</span>,      # 每个片段<span class="hljs-number">500</span>字符    chunk_overlap=<span class="hljs-number">50</span>,    # 重叠<span class="hljs-number">50</span>字符，避免信息被切断    separators=[<span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">"。"</span>, <span class="hljs-string">"，"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">""</span>]  # 按这些符号优先切分)chunks = text_splitter.<span class="hljs-built_in">split_documents</span>(documents)
</code></pre>
<blockquote>
<p><strong>附赠小技巧</strong>：<code>chunk_size</code>别瞎设！太大会导致检索不精准，太小又会让模型看不到完整上下文。我试下来，500-1000字符对于中文文档比较合适。</p>
</blockquote>
<h4 data-id="heading-3">2. 向量化与检索（Embedding &amp; Retrieval）</h4>
<p>这是RAG的“检索”部分核心。简单说就是把文字变成一串数字（向量），然后计算相似度。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> langchain.<span class="hljs-property">embeddings</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">HuggingFaceEmbeddingsfrom</span> langchain.<span class="hljs-property">vectorstores</span> <span class="hljs-keyword">import</span> <span class="hljs-title class_">Chroma</span># 使用开源的embedding模型embeddings = <span class="hljs-title class_">HuggingFaceEmbeddings</span>(    model_name=<span class="hljs-string">"BAAI/bge-small-zh-v1.5"</span>,  # 中文小模型，效果不错    model_kwargs={<span class="hljs-string">'device'</span>: <span class="hljs-string">'cpu'</span>},       # 没<span class="hljs-variable constant_">GPU</span>也能跑    encode_kwargs={<span class="hljs-string">'normalize_embeddings'</span>: <span class="hljs-title class_">True</span>}  # 归一化，提高检索精度)# 创建向量数据库vectorstore = <span class="hljs-title class_">Chroma</span>.<span class="hljs-title function_">from_documents</span>(    documents=chunks,    embedding=embeddings,    persist_directory=<span class="hljs-string">"./chroma_db"</span># 保存到本地，下次不用重新生成)
</code></pre>
<p>也不卖关子，这里有几个关键选择：</p>
<ul>
<li><strong>Embedding模型</strong>：中文千万别用OpenAI的text-embedding-ada-002（虽然它英文很强），对中文支持不好。推荐用<code>BAAI/bge</code>系列或者<code>m3e</code>系列。</li>
<li><strong>向量数据库</strong>：小项目用Chroma（轻量，本地运行），生产环境可以考虑Qdrant、Weaviate或者Pinecone（云服务）。</li>
</ul>
<h4 data-id="heading-4">3. 增强生成（Augmented Generation）</h4>
<p>这是最后一步，把检索到的文档和问题一起喂给大模型。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">from</span> langchain.chains import RetrievalQAfrom langchain.llms import ChatGLM# 初始化本地大模型llm <span class="hljs-operator">=</span> ChatGLM(    endpoint<span class="hljs-operator">=</span>"http://localhost:8000",  # 本地部署的ChatGLM API    max_tokens<span class="hljs-operator">=</span><span class="hljs-number">1024</span>,    temperature<span class="hljs-operator">=</span><span class="hljs-number">0.1</span># 温度调低，让答案更确定)# 创建RAG链qa_chain <span class="hljs-operator">=</span> RetrievalQA.from_chain_type(    llm<span class="hljs-operator">=</span>llm,    chain_type<span class="hljs-operator">=</span>"stuff",  # 最简单的方式：把所有检索到的文档拼起来一起问    retriever<span class="hljs-operator">=</span>vectorstore.as_retriever(        search_kwargs<span class="hljs-operator">=</span>{"k": <span class="hljs-number">3</span>}  # 检索前<span class="hljs-number">3</span>个最相关的片段    ),    return_source_documents<span class="hljs-operator">=</span><span class="hljs-literal">True</span># 返回源文档，方便调试)# 提问！<span class="hljs-keyword">result</span> <span class="hljs-operator">=</span> qa_chain("我们公司的年假政策是怎样的？")print(<span class="hljs-keyword">result</span>["result"])print("参考来源：", <span class="hljs-keyword">result</span>["source_documents"])
</code></pre>
<h3 data-id="heading-5">优化策略：从“能用”到“好用”</h3>
<p>如果你按上面的步骤搭起来，会发现基本功能是有了，但效果可能不太理想。下面是我踩过坑后总结的优化技巧：</p>
<h4 data-id="heading-6">1. 检索优化：让找东西更准</h4>
<ul>
<li><strong>问题重写</strong>：用户问“咋请假？”，但文档里写的是“年假申请流程”。需要在检索前把问题改写成“年假申请流程”。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">用大模型先重写问题rewrite_prompt = <span class="hljs-string">""</span><span class="hljs-string">"请将以下用户问题重写为更适合文档检索的查询语句。用户问题：{question}重写后的查询："</span><span class="hljs-string">""</span><span class="hljs-comment"># 先调用一次LLM重写问题，再用重写后的问题去检索</span></span>
</code></pre>
<ul>
<li><strong>混合检索</strong>：光用向量检索（语义搜索）不够，再加个关键词检索（稀疏搜索）。比如“2024年Q2财报”，其中“2024”、“Q2”这些关键词很重要。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">from</span> langchain<span class="hljs-selector-class">.retrievers</span> import BM25Retriever, EnsembleRetriever# 创建两个检索器vector_retriever = vectorstore<span class="hljs-selector-class">.as_retriever</span>(search_kwargs={"k": <span class="hljs-number">3</span>})bm25_retriever = BM25Retriever<span class="hljs-selector-class">.from_documents</span>(chunks)# 组合起来ensemble_retriever = EnsembleRetriever(    retrievers=<span class="hljs-selector-attr">[bm25_retriever, vector_retriever]</span>,    weights=<span class="hljs-selector-attr">[0.4, 0.6]</span>  # 调整权重，我试下来<span class="hljs-number">0.4</span>/<span class="hljs-number">0.6</span>效果不错)
</code></pre>
<h4 data-id="heading-7">2. 提示词优化：让模型答得更好</h4>
<p>直接扔文档给模型，它可能抓不住重点。得在提示词里“教”它怎么用这些文档。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">改进后的提示词模板RAG_PROMPT_TEMPLATE = <span class="hljs-string">""</span><span class="hljs-string">"你是一个专业的问答助手，请根据以下提供的参考文档来回答问题。如果文档中没有相关信息，请直接说“根据提供的资料，我无法回答这个问题”，不要编造答案。参考文档：{context}用户问题：{question}请按照以下格式回答：1. 首先给出直接答案2. 然后说明这个答案的依据（引用文档中的具体内容）3. 如果有相关流程或注意事项，一并列出回答："</span><span class="hljs-string">""</span></span>
</code></pre>
<blockquote>
<p><strong>附赠小技巧</strong>：在提示词里加上“如果不知道就说不知道”，能减少80%的胡编乱造！贴不贴心吧？</p>
</blockquote>
<h4 data-id="heading-8">3. 评估与迭代：怎么知道效果好不好</h4>
<p>搭完RAG不能就完事了，得有个评估方法。</p>
<pre><code class="hljs language-css" lang="css"># 简单的评估脚本test_questions = <span class="hljs-selector-attr">[    <span class="hljs-string">"年假有多少天？"</span>,    <span class="hljs-string">"请假需要谁审批？"</span>,    <span class="hljs-string">"病假需要什么证明？"</span>]</span>for question in test_questions:    result = <span class="hljs-built_in">qa_chain</span>(question)    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"问题：{question}"</span>)    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"答案：{result['result'][:200]}..."</span>)  # 只打印前<span class="hljs-number">200</span>字符    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"检索到的文档数：{len(result['source_documents'])}"</span>)    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)        # 手动评估：<span class="hljs-number">1</span>. 答案是否正确 <span class="hljs-number">2</span>. 是否引用了相关文档    # 生产环境可以用GPT-<span class="hljs-number">4</span>来自动评估，但那个要花钱...
</code></pre>
<h3 data-id="heading-9">部署实战：让RAG跑起来</h3>
<p>理论说完了，来点实际的。假设我们要部署一个公司知识库问答系统。</p>
<h4 data-id="heading-10">项目结构：</h4>
<pre><code class="hljs language-bash" lang="bash">company-rag/├── docs/                    <span class="hljs-comment"># 原始文档│   ├── 员工手册.pdf│   ├── 财务制度.docx│   └── 产品介绍.md├── ingest.py               # 文档处理脚本├── query.py               # 查询接口├── chroma_db/             # 向量数据库（自动生成）└── requirements.txt       # 依赖包</span>
</code></pre>
<h4 data-id="heading-11">requirements.txt：</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">langchain</span>==<span class="hljs-number">0.1</span>.<span class="hljs-number">0</span>chromadb==<span class="hljs-number">0.4</span>.<span class="hljs-number">22</span>sentence-transformers==<span class="hljs-number">2.2</span>.<span class="hljs-number">2</span>pypdf==<span class="hljs-number">3.17</span>.<span class="hljs-number">0</span>python-docx==<span class="hljs-number">1.1</span>.<span class="hljs-number">0</span>fastapi==<span class="hljs-number">0.104</span>.<span class="hljs-number">1</span>uvicorn==<span class="hljs-number">0.24</span>.<span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-12">ingest.py（文档处理）：</h4>
<pre><code class="hljs language-css" lang="css">import osfrom pathlib import Path# ... 上面的文档处理代码if __name__ == "__main__":    # 处理docs目录下所有文档    docs_dir = <span class="hljs-built_in">Path</span>(<span class="hljs-string">"./docs"</span>)    all_chunks = []        for file_path in docs_dir.<span class="hljs-built_in">glob</span>(<span class="hljs-string">"**/*"</span>):        if file_path.suffix == <span class="hljs-string">".pdf"</span>:            loader = <span class="hljs-built_in">PyPDFLoader</span>(<span class="hljs-built_in">str</span>(file_path))        elif file_path.suffix == <span class="hljs-string">".docx"</span>:            from langchain.document_loaders import Docx2txtLoader            loader = <span class="hljs-built_in">Docx2txtLoader</span>(<span class="hljs-built_in">str</span>(file_path))        elif file_path.suffix == <span class="hljs-string">".md"</span>:            from langchain.document_loaders import TextLoader            loader = <span class="hljs-built_in">TextLoader</span>(<span class="hljs-built_in">str</span>(file_path))        else:            continue                    documents = loader.<span class="hljs-built_in">load</span>()        chunks = text_splitter.<span class="hljs-built_in">split_documents</span>(documents)        all_chunks.<span class="hljs-built_in">extend</span>(chunks)        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"已处理：{file_path.name}，得到{len(chunks)}个片段"</span>)        # 创建向量数据库    vectorstore = Chroma.<span class="hljs-built_in">from_documents</span>(        documents=all_chunks,        embedding=embeddings,        persist_directory=<span class="hljs-string">"./chroma_db"</span>    )    <span class="hljs-built_in">print</span>(<span class="hljs-string">"向量数据库构建完成！"</span>)
</code></pre>
<h4 data-id="heading-13">query.py（Web接口）：</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">from fastapi <span class="hljs-keyword">import</span> FastAPIfrom pydantic <span class="hljs-keyword">import</span> BaseModelapp = FastAPI()<span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryRequest</span>(BaseModel):    question: str# 启动时加载QA链（实际生产要加缓存）qa_chain = None# 这里初始化你的QA链<span class="hljs-meta">@app</span>.post(<span class="hljs-string">"/query"</span>)asyncdef query(request: QueryRequest):    result = qa_chain(request.question)    <span class="hljs-keyword">return</span> {        <span class="hljs-string">"answer"</span>: result[<span class="hljs-string">"result"</span>],        <span class="hljs-string">"sources"</span>: [doc.metadata.<span class="hljs-keyword">get</span>(<span class="hljs-string">"source"</span>, <span class="hljs-string">""</span>) <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> result[<span class="hljs-string">"source_documents"</span>]]    }<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:    <span class="hljs-keyword">import</span> uvicorn    uvicorn.run(app, host=<span class="hljs-string">"0.0.0.0"</span>, port=<span class="hljs-number">8000</span>)
</code></pre>
<p>运行起来：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">先处理文档python ingest.py<span class="hljs-comment"># 启动服务python query.py# 访问 http://localhost:8000/docs 就能看到API文档了</span></span>
</code></pre>
<h3 data-id="heading-14">后记</h3>
<p>RAG这东西，说起来简单，就是“检索+生成”，但真想做好，每个环节都有讲究。文档怎么切、用什么embedding模型、怎么设计提示词、怎么评估效果...都是坑。</p>
<p>我用下来之后发现，最大的经验就是：<strong>别想一次性完美</strong>。先搭个最简单的版本跑起来，然后找一些真实问题去测试，看哪里出问题了就优化哪里。可能是检索不准，那就优化检索；可能是生成不好，那就优化提示词。</p>
<p>另外，RAG虽然解决了大模型的“知识更新”和“幻觉”问题，但它也不是万能的。对于需要复杂推理、数学计算或者创造性写作的任务，还是直接问大模型可能更好。</p>
<p>最后，祝各位的RAG系统都能精准检索、聪明回答！有什么问题欢迎留言讨论～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从对话到协作，Skills 如何改变我们与 AI 共事的方式]]></title>    <link>https://juejin.cn/post/7598947628468224046</link>    <guid>https://juejin.cn/post/7598947628468224046</guid>    <pubDate>2026-01-25T17:35:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598947628468224046" data-draft-id="7598921649888886811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从对话到协作，Skills 如何改变我们与 AI 共事的方式"/> <meta itemprop="keywords" content="Claude,AI编程"/> <meta itemprop="datePublished" content="2026-01-25T17:35:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="knqiufan"/> <meta itemprop="url" content="https://juejin.cn/user/4265760848347998"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从对话到协作，Skills 如何改变我们与 AI 共事的方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4265760848347998/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    knqiufan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T17:35:45.000Z" title="Sun Jan 25 2026 17:35:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>2025年10月，Anthropic发布了Claude Skills。两个月后，Agent Skills作为开放标准推出。这个看似简单的技术革新，正在悄然改变我们与AI协作的方式。Skills让这些知识和经验可以被封装、被复用、被传承。</p>
<h2 data-id="heading-1">一、什么是Skills？</h2>
<h3 data-id="heading-2">1.1 一个直观的理解</h3>
<p>想象你要把一项工作交给新同事。如果不能用口口相传的方式，只能通过文档一次性交接清楚，你会准备什么？</p>
<p>你大概会准备一个<code>交接大礼包</code>，里面包含：</p>
<ul>
<li>这件事大致怎么做（执行SOP和背景知识）</li>
<li>用什么工具、怎么操作（工具说明）</li>
<li>要用到的模板、素材、历史案例</li>
<li>可能遇到的问题和解决方案</li>
</ul>
<p>Skills 的架构几乎就是这个<code>交接大礼包</code>的数字版本。一个典型的 Skill 结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">skill-name/
├── SKILL.md          <span class="hljs-comment"># 核心指令文档（必需）</span>
├── scripts/          <span class="hljs-comment"># 可执行的代码脚本（可选）</span>
├── references/       <span class="hljs-comment"># 参考文档和规范（可选）</span>
└── assets/          <span class="hljs-comment"># 模板、素材等资源（可选）</span>
</code></pre>
<h3 data-id="heading-3">1.2 SKILL.md 是核心</h3>
<p>可以看到其他文件都是可选的，只有<code>SKILL.md</code>是必需的。因为<code>SKILL.md</code>是整个 Skill 的"大脑"和"说明书"。它告诉Agent三件最重要的事：</p>
<p><strong>第一，什么时候用这个Skill</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">word-to-markdown</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">将Word文档转换为Markdown格式，支持智能格式识别、图片处理和批量转换</span>
<span class="hljs-meta">---
</span></code></pre>
<p>开头的这段元数据，只有几十个 token，<strong>Agent 启动时就会加载它</strong>。当用户输入例如"把这个文档转成markdown"时，Agent就是通过匹配 description 来判断应该调用<code>word-to-markdown</code>这个Skill。</p>
<p><strong>第二，具体怎么做</strong></p>
<p><code>SKILL.md</code> 的主体部分会详细说明：</p>
<ul>
<li>任务的分步骤执行流程</li>
<li>每个步骤的注意事项</li>
<li>什么时候需要调用scripts里的脚本</li>
<li>什么时候需要查阅references里的文档</li>
<li>常见问题和解决方案</li>
</ul>
<p><strong>第三，做到什么标准</strong></p>
<p>好的<code>SKILL.md</code>可能还会包含：</p>
<ul>
<li>输出格式规范</li>
<li>质量检查标准</li>
<li>边界情况的说明</li>
<li>最佳实践建议</li>
<li>...</li>
</ul>
<p>所以最简单的Skill可能只有一个<code>SKILL.md</code>文件，用自然语言把一件事说清楚就够了。复杂的Skill则会在<code>SKILL.md</code>的指引下，协调scripts、references、assets中的各种资源，完成多步骤的复杂任务。</p>
<p>这就是<code>SKILL.md</code>的核心地位：它是Skill的指挥官，其他文件都是它调度的资源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/518905c5e85c49deb379685bd647d204~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga25xaXVmYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769968020&amp;x-signature=VDGaF6OmjAHpQ4tgCu%2B%2BDJL4sOE%3D" alt="Gemini_Generated_Image_yb1hfayb1hfayb1h.png" loading="lazy"/></p>
<h3 data-id="heading-4">1.3 渐进式披露：让AI既博学又专注</h3>
<p>那这里会有个问题。既然 Agent 在启动的时候就会加载 Skills，如果给 Agent 装了上百个 Skills 会不会把它"撑爆"？如果每次运行都要加载所有 Skills 会不会太慢？</p>
<p>答案是不会。Skills 有个很妙的设计叫：渐进式披露（Progressive Disclosure）。</p>
<p>这个概念大白话讲，就像我们人类学习知识一样：不可能同时把所有细节都记在脑子里，而是<strong>先记住"有什么知识"，需要时再深入学习具体内容</strong>。</p>
<p>Skills采用了三层信息加载机制：</p>
<p><strong>第一层：元数据层（始终加载）</strong></p>
<p>只加载SKILL.md开头的name和description，大约50-100个token。这部分就像是Skill的"名片"，Agent启动时就会加载所有Skills的名片。</p>
<p>这样做的好处是：即使你有100个Skills，也只需要几千个token来维持"认知"。Agent就像有个索引，知道"我会哪些技能"，但不需要记住每个技能的所有细节。</p>
<p><strong>第二层：指令层（触发时加载）</strong></p>
<p>当Agent判断某个Skill与当前任务相关时，才会读取完整的SKILL.md内容，大约500-5000个token。</p>
<p>这就像你遇到具体问题时，才打开相关的操作手册详细阅读。不需要的Skills，它们的详细指令就不会占用宝贵的上下文窗口。</p>
<p><strong>第三层：资源层（按需动态加载）</strong></p>
<p>scripts、references、assets这些文件，只有在SKILL.md明确指示时才会被读取。而且它们的大小没有限制，因为不会一次性全部加载到上下文中。</p>
<p>比如Agent在处理文档转换时，读到SKILL.md中说"对于复杂表格，参考references/table-handling.md"，才会去读取那个参考文档。如果这个任务不涉及表格，那个文档就永远不会被加载。</p>
<p>这种设计的美妙之处在于：你可以给Agent装备海量的知识库，但每次运行时只会用到当前真正需要的那部分。就像图书馆，藏书万册，但你每次只会借阅几本。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e8692f845c04747b80f7fd55d2b9507~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga25xaXVmYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769968020&amp;x-signature=EBzImtsF0JWV5PeA98SEy4h5H7s%3D" alt="Gemini_Generated_Image_cg5j2ucg5j2ucg5j.png" loading="lazy"/></p>
<h3 data-id="heading-5">1.4 Skills与MCP：各司其职的好搭档</h3>
<p>Skills和MCP（Model Context Protocol）经常被混淆，甚至被当成竞争对手。但它们其实是互补关系，解决的是完全不同的问题。</p>

































































<table><thead><tr><th>维度</th><th>MCP</th><th>Skills</th></tr></thead><tbody><tr><td><strong>核心痛点</strong></td><td>上下文膨胀严重</td><td>渐进式披露，按需加载</td></tr><tr><td><strong>上下文占用</strong></td><td>一次性加载所有工具定义，可能占用数千到数万tokens</td><td>初始仅30-50 tokens，按需加载详细内容</td></tr><tr><td><strong>加载方式</strong></td><td>全量预加载（所有工具schema一次性加载到上下文）</td><td>三层渐进加载（元数据→指令→资源）</td></tr><tr><td><strong>扩展性</strong></td><td>工具越多上下文占用越大，受限于窗口大小</td><td>可装备数百个Skills而不影响性能</td></tr><tr><td><strong>本质</strong></td><td>开放标准协议</td><td>知识封装格式</td></tr><tr><td><strong>解决的问题</strong></td><td>连接性：让Agent能访问外部工具和数据</td><td>专业性：让Agent知道如何使用这些能力</td></tr><tr><td><strong>提供的内容</strong></td><td>WHAT（有什么能力可用）</td><td>HOW（如何使用这些能力）</td></tr><tr><td><strong>典型内容</strong></td><td>API接口、数据库连接、文件系统</td><td>工作流程、最佳实践、领域知识</td></tr><tr><td><strong>形象比喻</strong></td><td>Agent的"手脚"（工具箱）</td><td>Agent的"大脑记忆"（经验库）</td></tr><tr><td><strong>使用方式</strong></td><td>Agent调用MCP提供的工具</td><td>Agent加载Skill中的知识</td></tr><tr><td><strong>开发门槛</strong></td><td>需要编程，定义接口</td><td>只需写文档，描述方法</td></tr></tbody></table>
<p><strong>为什么上下文占用差异这么大？</strong></p>
<p>MCP的设计哲学是"连接优先"。为了让Agent知道有哪些工具可用，MCP需要在启动时就把所有工具的定义（包括参数、schema、使用说明）全部加载到上下文中。这导致了一个问题，在 MCP 工具很多的情况下，会消耗大量的 tokens。比如一个包含22个工具的MCP服务器，仅工具定义就需要约15,000 tokens，在较小的上下文窗口中，MCP工具定义可能占用35%以上的空间，还没开始工作就已经"撑"了。</p>
<p>而Skills采用完全不同的思路。通过渐进式披露，每个Skill初始只暴露30-50个tokens的元数据（name和description），只有当Agent判断需要某个Skill时，才会加载完整的SKILL.md（约500-5000 tokens），scripts和references则更是按需读取。</p>
<p>这意味着即使是给Agent装备100个Skills，上下文占用也只有约5,000 tokens的元数据，远小于一个中等规模的MCP服务器。更重要的是这些元数据始终"值得"，因为它们让Agent知道"我能做什么"，而不是浪费在冗长的工具定义上。</p>
<p><strong>用一句话总结：MCP让Agent能够"做到"更多事，Skills让Agent能够"做好"这些事，而且更高效。</strong></p>
<p>举个实际的例子：让Agent写一份竞品分析报告。</p>
<ul>
<li>MCP的作用：连接到Google Drive获取数据、访问GitHub读取竞品代码、调用Slack获取内部讨论</li>
<li>Skills的作用：指导Agent如何进行SWOT分析、报告结构应该是什么样的、数据可视化用什么配色方案</li>
</ul>
<p>两者配合，能既"有办法"又"有方法"，同时保持上下文的高效利用。</p>
<p>这也是为什么2025年后越来越多人开始重视Skills —— 不是因为MCP不好，而是因为上下文效率太重要了。</p>
<h2 data-id="heading-6">二、如何使用Skills？</h2>
<h3 data-id="heading-7">2.1 Claude Code：本地运行的AI助理</h3>
<p>默认在本地已经安装好了 Claude Code，直接从如何使用Skills开始。</p>
<h4 data-id="heading-8">安装Skills</h4>
<p>有三种方式可以给Claude Code安装Skills：</p>
<p><strong>方式一：自然语言安装</strong></p>
<p>这种方式是最简单的，找到对应 skill 的 github 地址，直接在Claude Code中输入例如：</p>
<pre><code class="hljs language-ruby" lang="ruby">帮我安装skill，项目地址是：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/anthropics</span><span class="hljs-regexp">/skills/tree</span><span class="hljs-regexp">/main/skills</span><span class="hljs-regexp">/pptx
</span></code></pre>
<p>Claude Code会自动下载、解压、配置好一切。新手推荐。</p>
<p><strong>方式二：手动安装</strong></p>
<p>Claude Code 专门有一个文件夹来管理所有的Skill文件，可以手动安装：</p>
<ol>
<li>从GitHub或其他来源下载Skill文件包（通常是.zip或直接clone项目）</li>
<li>解压后放到Skills目录</li>
</ol>
<p>不同操作系统的路径不一样：</p>
<p><strong>Windows系统：</strong></p>
<ul>
<li>项目级：<code>你的项目路径\.claude\skills\</code>，例如：<code>E:\my-project\.claude\skills\</code></li>
<li>全局级：<code>C:\Users\你的用户名\.claude\skills\</code></li>
</ul>
<p><strong>Linux/macOS系统：</strong></p>
<ul>
<li>项目级：<code>./.claude/skills/</code></li>
<li>全局级：<code>~/.claude/skills/</code></li>
</ul>
<p>项目级只对当前项目有效，全局级则所有项目都能使用。建议把通用的Skills放在全局级，项目相关的Skills放在项目级。Claude Code 2.1 版本更新了 skills 热加载功能，修改或新创建的 skill 能及时生效。即以前修改 <code>~/.claude/skills</code> 下的工具文件必须重启会话才能生效，若要调试还蛮痛苦的痛苦的。2.1 版本之后修改了即可生效，允许开发者像编写脚本一样，动态“编程”自己的 AI 助手。</p>
<p><strong>方式三：插件市场（官方推荐）</strong></p>
<p>Claude Code支持插件市场功能，可以像应用商店一样浏览和安装Skills。在Claude Code中输入：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin marketplace add anthropics/skills
</code></pre>
<p>这会注册Anthropic官方的Skills市场，让你可以访问官方维护的所有Skills。使用如下命令：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin
</code></pre>
<p>这会打开一个交互式菜单，这时候可以：</p>
<ul>
<li>浏览所有可用的Skills</li>
<li>查看Skill的描述和功能</li>
<li>直接选择安装</li>
</ul>
<p>选择想要安装的 Skill 的名称，输入一下命令安装：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin install &lt;skill-name&gt;
</code></pre>
<p>例如：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin install pptx
/plugin install brand-guidelines
</code></pre>
<p>如果是 Claude Code 2.1 以及之后的版本，安装完输入 <code>/</code> 查看所有可用的 slash 命令，已安装的 Skills 应该会出现在自动补全列表中</p>
<p>除了官方市场，还有第三方市场可以添加：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fclaudecodeplugins.io%2F" target="_blank" title="https://claudecodeplugins.io/" ref="nofollow noopener noreferrer">Claude Code Skills Hub</a> - 包含550+个Skills</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fskillsmp.com%2F" target="_blank" title="https://skillsmp.com/" ref="nofollow noopener noreferrer">SkillsMP Marketplace</a> - 社区驱动的Skills市场</li>
</ul>
<h4 data-id="heading-9">使用Skills</h4>
<p>安装好Skills后，可以直接显示调用</p>
<pre><code class="hljs language-bash" lang="bash">使用 /pptx 这个skill创建一个关于AI的演示文稿
</code></pre>
<p>也可以说明需求，Agent会自动选择合适的Skill：</p>
<pre><code class="hljs">帮我把这份报告做成PPT格式
</code></pre>
<p>因为 SKILL.md 中的 description 不仅用于分类，还会被Agent用来理解"什么情况下应该用这个Skill"。当需求描述与某个Skill的描述高度相关时，Agent就会自动调用它。</p>
<h3 data-id="heading-10">2.2 Coze：云端协作的AI平台</h3>
<p>Coze 是字节跳出的AI Agent平台，也支持Skills功能。前段时间刚出，浅浅提一下。主要是云端 vs 本地的区别。</p>


















































<table><thead><tr><th>维度</th><th>Claude Code</th><th>Coze</th></tr></thead><tbody><tr><td><strong>运行环境</strong></td><td>本地电脑</td><td>云端服务器</td></tr><tr><td><strong>安装复杂度</strong></td><td>需要安装软件</td><td>打开网页即用</td></tr><tr><td><strong>文件访问</strong></td><td>可访问所有本地文件</td><td>只能访问上传的文件</td></tr><tr><td><strong>隐私性</strong></td><td>数据不离开本地</td><td>数据在云端处理</td></tr><tr><td><strong>分享便利性</strong></td><td>需要打包分发</td><td>分享链接即可</td></tr><tr><td><strong>定时任务</strong></td><td>电脑必须开机</td><td>云端自动运行</td></tr><tr><td><strong>商业化</strong></td><td>难以直接变现</td><td>可上架技能商店收费</td></tr><tr><td><strong>典型场景</strong></td><td>本地文件处理、隐私敏感任务</td><td>团队协作、公开分享、自动化任务</td></tr></tbody></table>
<p><strong>在Coze中使用Skills：</strong></p>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.coze.cn%2F" target="_blank" title="https://space.coze.cn/" ref="nofollow noopener noreferrer">space.coze.cn/</a></li>
<li>左侧栏选择"扣子编程"</li>
<li>可以直接上传skill文件（.skill或.zip结尾文件），或者在对话框中描述你的Skill需求</li>
<li>Coze会自动生成Skill文件</li>
<li>在右侧预览区测试Skill效果</li>
<li>点击"部署"发布Skill</li>
<li>可以选择上架到技能商店，让其他人使用（甚至可以设置付费）</li>
</ol>
<p>Coze 适合那些需要分享给他人的Skills，或者需要定时运行的任务（比如每天早上自动生成资讯日报）。如果你的Skills主要是个人的生产力工具，需要操作本地文件，Claude Code可能更合适。</p>
<h2 data-id="heading-11">三、实战案例：创建一个Word转Markdown的Skill</h2>
<p>浅浅的通过一个实际的例子看看创建一个skill是什么过程。</p>
<h3 data-id="heading-12">3.1 从一个真实的需求开始</h3>
<p>假设你需要把Word文档转换成Markdown格式，但是作为一个非开发者不懂什么 pandoc 工具也觉得使用这些工具很麻烦，无法满足更细节的要求。你希望有一个真正"懂你"的转换工具，它知道：</p>
<ul>
<li>你喜欢什么样的标题层级</li>
<li>表格应该怎么处理才好看</li>
<li>图片要放在哪个目录</li>
<li>批量转换时如何保持一致性</li>
</ul>
<p>这时候就可以选择创建一个专属的Skill。</p>
<h3 data-id="heading-13">3.2 用skill-creator自动生成</h3>
<p>首先，安装一个特殊的 Skill叫 skill-creator。它是专门用来创建其他Skill的Skill，有点像"工具制造厂"。</p>
<p><strong>从GitHub安装：</strong></p>
<pre><code class="hljs language-ruby" lang="ruby">帮我安装skill-creator，地址：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/anthropics</span><span class="hljs-regexp">/skills/tree</span><span class="hljs-regexp">/main/skills</span><span class="hljs-regexp">/skill-creator
</span></code></pre>
<p><strong>或从插件市场安装：</strong></p>
<pre><code class="hljs language-bash" lang="bash">/plugin install skill-creator
</code></pre>
<p>安装完成后，告诉它你想要什么：</p>
<pre><code class="hljs language-markdown" lang="markdown">创建一个skill，能够将Word文档（.docx）转换为Markdown格式
要求：
<span class="hljs-bullet">1.</span> 智能识别文档结构（标题、段落、列表、表格）
<span class="hljs-bullet">2.</span> 正确处理图片（提取到本地images目录）
<span class="hljs-bullet">3.</span> 保留超链接和文本格式（加粗、斜体）
<span class="hljs-bullet">4.</span> 支持批量转换整个文件夹
<span class="hljs-bullet">5.</span> 输出符合CommonMark标准的Markdown
</code></pre>
<p>skill-creator会自动生成一个完整的Skill包，包含例如以下结构：</p>
<pre><code class="hljs language-bash" lang="bash">word-to-markdown/
├── SKILL.md                      <span class="hljs-comment"># 核心指令文档</span>
├── scripts/
│   └── convert.py                <span class="hljs-comment"># Word转Markdown的Python脚本</span>
└── references/
    └── commonmark-spec.md        <span class="hljs-comment"># CommonMark格式规范参考</span>
</code></pre>
<h3 data-id="heading-14">3.3 生成的Skill是什么样的</h3>
<p><strong>SKILL.md的内容概要：</strong></p>
<p>开头是元数据部分：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">word-to-markdown</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">将Word文档转换为格式良好的Markdown文件，支持智能格式识别、图片处理和批量转换</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># Word转Markdown Skill</span>

<span class="hljs-comment">## 何时使用</span>
<span class="hljs-string">当用户需要将.docx文件转换为.md格式时</span>
</code></pre>
<p>然后是详细的执行流程：</p>
<ul>
<li>文档分析：如何识别标题、列表、表格</li>
<li>格式转换：不同Word样式对应的Markdown语法</li>
<li>图片处理：如何提取和引用图片</li>
<li>质量检查：转换后如何验证结果</li>
</ul>
<p>还有使用示例和注意事项，确保Agent知道在各种情况下应该如何处理。</p>
<p><strong>scripts/convert.py 的作用：</strong></p>
<p>这是一个Python脚本，使用python-docx库读取Word文档，按照SKILL.md中的规范进行转换。它处理那些靠自然语言描述不够精确的细节——比如表格的Markdown语法、图片的命名规则等。</p>
<p><strong>references/commonmark-spec.md的作用：</strong></p>
<p>这是一个参考文档，详细说明了CommonMark标准的语法规范。当Agent遇到复杂的格式问题时，可以查阅这个文档来确保输出符合标准。</p>
<p>所以具体流程就是，当 Agent 在执行转换任务时，会：</p>
<ol>
<li>读取SKILL.md了解整体流程</li>
<li>调用convert.py执行实际的转换工作</li>
<li>如果遇到特殊格式，查阅commonmark-spec.md</li>
<li>根据转换结果生成最终的Markdown文件</li>
</ol>
<h3 data-id="heading-15">3.4 使用和迭代</h3>
<p>Skill创建完成后就可以直接使用了：</p>
<pre><code class="hljs">将report.docx转换为markdown
</code></pre>
<p>或者批量转换：</p>
<pre><code class="hljs">将docs文件夹下所有Word文档转换为Markdown
</code></pre>
<p>Agent会自动识别这个需求应该调用word-to-markdown Skill，然后按照SKILL.md中的指引完成转换。</p>
<p>如果第一次转换的结果不理想怎么办？你可以继续和Agent对话：</p>
<pre><code class="hljs">表格转换有问题，列对齐不对
</code></pre>
<p>Agent会基于你的反馈，调整convert.py脚本中的表格处理逻辑，或者更新SKILL.md中的转换规范。经过几轮迭代，这个Skill就会越来越符合你的需求。</p>
<p>当这个 Skill 优化完稳定后，可以把它分享给任何一个有 word 转 markdown 需求的人，他们不需要了解任何技术细节，就能用上你总结出来的"最佳实践"。或者，更进一步，可以再基于这个Skill再创建新的Skills：比如一个专门处理学术论文格式的Skill，它继承word-to-markdown的能力，再增加参考文献的特殊处理逻辑。</p>
<p>这就是Skills的可组合性：每个Skill都是独立的，但可以相互嵌套、相互引用，构建出越来越强大的能力体系。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eacf582058674e2496891384717d269e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga25xaXVmYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769968020&amp;x-signature=vUJuiTAVOR1ezRnWNrvE%2BS3Q2%2Fk%3D" alt="Gemini_Generated_Image_w9d7a8w9d7a8w9d7.png" loading="lazy"/></p>
<h2 data-id="heading-16">四、Skill的设计哲学</h2>
<h3 data-id="heading-17">知识的可移植性</h3>
<p>Skills把知识显式化为文件。这意味着：</p>
<ul>
<li>可以用Git进行版本控制</li>
<li>可以通过GitHub或文件共享</li>
<li>可以在不同平台间迁移</li>
<li>可以持续迭代优化</li>
</ul>
<p>这听起来很技术化，但换个角度想：这意味着你的经验不再是你个人的私有财产，而变成了可以传承、可以复用、可以不断完善的团队资产。就像一本不断更新的"操作手册"，每个使用者都可以贡献自己的改进。</p>
<h3 data-id="heading-18">渐进式复杂度</h3>
<p>很多技术框架的问题是"门槛太高"。你想做一个简单的功能，却要先理解一大堆概念、配置一堆环境、学习一堆语法。还没开始做，热情就已经被磨灭了。</p>
<p>而 Skills 的理念是"极简起步，按需扩展"。</p>
<p>最简单的Skill只有一个SKILL.md文件，用自然语言把一件事说清楚就够了。不需要学编程，不需要理解复杂的概念，就像给新同事写工作邮件一样简单。</p>
<p>当发现自然语言不够用时，可以继续添加一个Python脚本来自动化某个步骤。当脚本变复杂时，可以拆分成多个子脚本。当文档太长时，可以把某些部分抽离成独立的参考文档。即使是非开发人员也可以做到这点，因为这些脚本可以不用自己编写，AI 会帮忙搞定。</p>
<p>这种渐进式的复杂度，让Skill的创建者能够"边做边学"，而不是一开始就被庞大的架构吓退。更重要的是，它让Skills能够"有机生长"——从一个小萌芽，逐步发展成一个功能完善的系统。</p>
<h3 data-id="heading-19">人机协作的新范式</h3>
<p>Skills很有意思的一个地方是，是它重新定义了人机协作的方式。</p>
<p>原先的 AI 应用要么把一切都预设好（Workflow、规则引擎），要么完全依赖AI的"智能"（ChatGPT 那样的通用对话）。前者太死板，后者太不可控。</p>
<p>Skills走的是一条中间路：人类提供知识和方法，AI提供推理和执行。</p>
<p>这种协作方式充分发挥了各自的优势：人类擅长积累经验、总结方法、设定规范，AI擅长执行细节、处理变数、快速迭代。结果就是一个既专业又灵活的AI应用。</p>
<h3 data-id="heading-20">从预设到响应式</h3>
<p>再深入一点，这其实是从"预设所有可能"到"响应实际情况"的范式转变。</p>
<p>传统的编程思维是：我需要预想所有可能的情况，为每种情况编写处理逻辑。但现实总是超出预期，于是就不断地打补丁、加特例，代码越来越复杂，维护越来越困难。Skills 赋能的 Agent 采用响应式设计：你告诉它目标和原则，它根据实际情况动态调整策略。</p>
<p>举个例子。一个文档转换的Skill，你不需要预设所有可能的Word格式。你只需要告诉它"标题应该转换为#开头"、"表格要保持对齐"这些基本原则。遇到特殊的格式时，Agent会基于它的理解进行推理，给出最可能的处理方式。如果不确定，它甚至会问你："这个格式不太常见，我这样处理可以吗？"</p>
<p>这种从"预设"到"响应"的转变，让AI应用具备了真正的适应性。它不再是僵化的工具，而更像是一个能够学习和成长的合作伙伴。</p>
<h3 data-id="heading-21">知识的模块化与组合性</h3>
<p>Skills 的本质是知识的模块化。这听起来很技术，但其实和乐高积木的原理一样。</p>
<p>每个Skill都是一个独立的知识模块，它：</p>
<ul>
<li>可以单独使用</li>
<li>可以和其他Skills组合</li>
<li>可以被嵌套在更大的Skill中</li>
<li>可以作为其他Skill的基础</li>
</ul>
<p>这种组合性意味着N个Skills可以应对远超N种场景：</p>
<ul>
<li>brand-guidelines + pptx = 符合品牌规范的PPT生成器</li>
<li>web-scraping + data-analysis + pptx = 自动竞品分析报告</li>
<li>brand-guidelines + web-scraping + data-analysis + pptx = 符合品牌规范的自动竞品分析报告</li>
</ul>
<p>你会发现最后这个复杂的系统其实是由简单的Skills组合而成的。不需要从零开始开发一个"竞品分析系统"，只需要把已有的"积木"搭在一起就行。</p>
<p>更重要的是这些Skills可以被无限复用。brand-guidelines 可以被用于网站设计、邮件模板、营销材料等各种场景。每创建了一个新的Skill，不仅解决的是当前的问题，还为未来的问题提供了一个可用的组件。</p>
<p>模块化，组件化，这可玩性就很高了。</p>
<h2 data-id="heading-22">五、Skills 到底有多强？</h2>
<p>最简单的Skill只需要一个SKILL.md文件，用自然语言把一件事说清楚。这意味着那些最懂业务的人——产品经理、分析师、律师、医生、教师等等，可以直接创建AI应用，而不需要把需求"翻译"给开发工程师。而开发工程师可以从重复性的"翻译工作"中解放出来，专注于更有挑战性的技术问题。领域专家的经验和知识，可以直接转化为生产力。</p>
<p>这意义就很重大。</p>
<p>Skills 的智能上限是很高，因为 Skills 依托的是通用 Agent 的推理能力，而不是预设的规则。当遇到超出预期的情况时，使用 Skills 的 Agent 会基于对任务的理解进行推理，可能会调用其他Skills，可能即兴编写一段脚本，可能向你询问确认。这种适应性和学习能力，让它的应用场景远超传统AI应用。</p>
<p>Skills 也很灵活，只需要修改文档，甚至直接告诉Agent"下次这样做"，下次任务就会应用新的方法。这种快速迭代的能力，让Skills特别适合那些还在探索阶段的场景。快速尝试不同的方法，找到最优解后再固化下来，极大地降低了验证想法的成本。</p>
<p>当AI应用开发的门槛降低，竞争不再是谁能开发，而是谁有更好的方法论、更深的领域知识、更优的工作流程。这对有经验的人来说是好消息。核心竞争力变成对业务的理解、解决问题的方法、积累的经验。这些是AI短期内无法替代的。</p>
<h2 data-id="heading-23">六、写在最后</h2>
<p>Skills的出现确实改变了我们与AI协作的方式。过去每次和AI对话都要从零开始，反复解释同样的规则。现在，这些知识和经验可以被封装、被复用、被传承。这种转变不仅是效率的提升，更是对知识积累方式的重新思考。那些老员工脑子里的"经验之谈"，那些团队多年摸索出的"最佳实践"，不再随着人员流动而消失，而是变成了可以传承的显性资产。</p>
<p>一个人的能力总是有限的，但当无数人的经验和知识通过Skills组合在一起时，就能产生远超个体之和的集体智慧。就像乐高积木，每个Skill都是独立的模块，但可以自由组合，应对各种复杂场景。</p>
<p>Skills让AI从"工具"变成了"合作伙伴"。人类提供智慧和方向，AI提供执行和适应。这种协作方式充分发挥了各自的优势：我们擅长积累经验、判断价值、设定目标，AI擅长执行细节、处理变数、快速迭代。</p>
<p>Skills生态才刚刚起步，但趋势已经明确：那些能够将自己的经验和知识转化为Skills的人，将在AI时代获得巨大优势。这不再是谁会写代码的问题，而是谁有更好的方法论、更深的领域知识、更优的工作流程。</p>
<hr/>
<p><strong>参考资料：</strong></p>
<ol>
<li>Anthropic官方博客 - <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fbuilding-agents-with-skills-equipping-agents-for-specialized-work" target="_blank" title="https://claude.com/blog/building-agents-with-skills-equipping-agents-for-specialized-work" ref="nofollow noopener noreferrer">Building Agents with Skills</a></li>
<li>Anthropic官方博客 - <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fequipping-agents-for-the-real-world-with-agent-skills" target="_blank" title="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills" ref="nofollow noopener noreferrer">Equipping agents for the real world with Agent Skills</a></li>
<li>Agent Skills官方标准 - <a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2F" target="_blank" title="https://agentskills.io/" ref="nofollow noopener noreferrer">agentskills.io/</a></li>
<li>Claude Code官方文档 - <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Fskills" target="_blank" title="https://code.claude.com/docs/en/skills" ref="nofollow noopener noreferrer">code.claude.com/docs/en/ski…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fintuitionlabs.ai%2Farticles%2Fclaude-skills-vs-mcp" target="_blank" title="https://intuitionlabs.ai/articles/claude-skills-vs-mcp" ref="nofollow noopener noreferrer">Claude Skills vs. MCP: A Technical Comparison</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.volcengine.com%2Farticles%2F7592876110652981274" target="_blank" title="https://developer.volcengine.com/articles/7592876110652981274" ref="nofollow noopener noreferrer">别搞混了！MCP和Agent Skill到底有什么区别？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1992907559875654043" target="_blank" title="https://zhuanlan.zhihu.com/p/1992907559875654043" ref="nofollow noopener noreferrer">2026年AI应用技术栈：深度剖析Agent Skill"渐进式披露"架构</a></li>
<li>Pandoc文档转换工具 - <a href="https://link.juejin.cn?target=https%3A%2F%2Fpandoc.org%2F" target="_blank" title="https://pandoc.org/" ref="nofollow noopener noreferrer">pandoc.org/</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[快速上手Rsync]]></title>    <link>https://juejin.cn/post/7599852636529901603</link>    <guid>https://juejin.cn/post/7599852636529901603</guid>    <pubDate>2026-01-27T10:25:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599852636529901603" data-draft-id="7599828354515664936" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="快速上手Rsync"/> <meta itemprop="keywords" content="运维,自动化运维"/> <meta itemprop="datePublished" content="2026-01-27T10:25:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lihouyi"/> <meta itemprop="url" content="https://juejin.cn/user/4365493763322599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            快速上手Rsync
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4365493763322599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lihouyi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:25:30.000Z" title="Tue Jan 27 2026 10:25:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">快速上手Rsync</h2>
<p>在分布式系统与灾备场景中，文件同步是基石</p>
<p>传统的 <code>cp</code> 或 <code>scp</code> 是“傻瓜式”的——它们不懂变通。面对海量小文件或弱网环境的大文件，它们总是进行<strong>全量复制</strong>。这不仅打满带宽，还浪费了宝贵的 IO</p>
<p>你需要的是 <strong>Rsync (Remote Sync)</strong> —— 系统管理员手中的“瑞士军刀”。它的杀手锏在于：<strong>只传改动过的部分</strong></p>
<h3 data-id="heading-1">核心机制：为什么 Rsync 这么快？</h3>
<p>Rsync 的高性能不是玄学，而是一套严密的数学逻辑。它不同于简单的对比 <code>mtime</code>（修改时间）或 <code>size</code>（大小），而是深入到了<strong>块（Block）级别</strong></p>
<ol>
<li><strong>FileList 交换</strong>：客户端首先向服务端发送文件列表（包含文件名、大小、mtime 等元数据）</li>
<li><strong>Generator 识别</strong>：接收端根据元数据快速筛选出“可能变化”的文件</li>
<li><strong>Rolling Checksum &amp; MD5</strong>：对于变化的文件，Rsync 将其分块（Block），计算滚动校验和与 MD5 摘要。通过比对两端的校验值，精准定位到发生变动的“数据块”</li>
<li><strong>增量传输</strong>：仅传输差异数据块，而非整个文件</li>
</ol>
<blockquote>
<p>默认情况下，如果源文件与目标文件的 <code>size</code> 和 <code>mtime</code> 一致，Rsync 会直接跳过校验。如果你怀疑文件被篡改但时间戳被伪造了，请加上 <code>--checksum</code> 参数，但这会消耗更多 CPU</p>
</blockquote>
<h3 data-id="heading-2">命令行模式：严格的操作规范</h3>
<p>虽然 Rsync 支持本地模式（功能类似 <code>cp</code>），但在生产环境中，我们更关注远程传输</p>
<h4 data-id="heading-3">斜杠的艺术</h4>
<p>在使用 Rsync 时，最容易引发“事故”的细节在于源路径末尾的 <code>/</code>。这是一个必须形成肌肉记忆的规范：</p>
<ul>
<li><code>src</code>：同步目录本身 + 目录下的内容。会在目标目录下创建一个名为 <code>src</code> 的子目录</li>
<li><code>src/</code> ：<strong>仅</strong>同步目录下的内容。不会创建 <code>src</code> 子目录</li>
</ul>
<blockquote>
<p><strong>生产建议</strong>：为了保持语义清晰，如果你只想同步文件夹内部，<strong>请始终加上 <code>/</code></strong></p>
</blockquote>
<h4 data-id="heading-4">常用参数的最佳实践</h4>
<p>在脚本化任务中，建议使用以下标准参数组合：</p>
<pre><code class="hljs language-bash" lang="bash">rsync -avzP --delete --bwlimit=1000 /source/ user@host:/dest/
</code></pre>

















































<table><thead><tr><th align="left"><strong>参数</strong></th><th align="left"><strong>说明</strong></th></tr></thead><tbody><tr><td align="left"><code>-a</code></td><td align="left">归档模式，-rlptgoD的组合，涵盖各个方面<br/>-r递归<br/>-l复制软链接<br/>-p权限不变<br/>-m修改时间不变<br/>-o所有者不变<br/>-g用户组不变<br/>-D --devices --specials 设备与特殊文件</td></tr><tr><td align="left"><code>-r</code></td><td align="left">递归同步子目录</td></tr><tr><td align="left"><code>-v</code></td><td align="left">显示过程</td></tr><tr><td align="left"><code>-z</code></td><td align="left">传输数据时进行压缩（公网）</td></tr><tr><td align="left"><code>-h</code></td><td align="left">人类可读的格式输出</td></tr><tr><td align="left">--bwlimit</td><td align="left">=500kb，限速，注意不要与<code>-z</code>一起使用</td></tr><tr><td align="left">--delete</td><td align="left">删除目标端多余文件（<strong>保持严格同步</strong>）</td></tr><tr><td align="left">--exclude='*.log'</td><td align="left">排除所有<code>.log</code>文件</td></tr><tr><td align="left">--progress（<code>-P</code>）</td><td align="left">显示传输进度</td></tr><tr><td align="left">--password-file=xxx</td><td align="left">指定客户端免密登陆文件</td></tr></tbody></table>
<h3 data-id="heading-5">守护进程模式：生产级部署方案</h3>
<p>相比于 SSH 隧道模式，Rsync Daemon 模式（默认端口 873）更适合自动化、定时的集中式备份任务，因为它支持细粒度的配置文件控制和免密认证</p>
<h4 data-id="heading-6">架构流程图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 客户端 (Source)
    participant Daemon as 服务端 (Rsync Daemon)
    participant Auth as 认证模块
    participant FS as 文件系统

    Note over Client, Daemon: 握手阶段
    Client-&gt;&gt;Daemon: 发起连接 (User@Host::Module)
    Daemon-&gt;&gt;Client: 挑战 (Challenge): 询问密码
    
    Note over Client: 读取 /etc/rsync.pass
    Client--&gt;&gt;Daemon: 发送密码 hash
    
    Note over Daemon: 比对 /etc/rsyncd.secrets
    Daemon-&gt;&gt;Auth: 验证 User/Pass
    
    alt 验证通过
        Auth--&gt;&gt;Daemon: OK
        Note over Daemon: 权限降级 (Drop Root)
        Daemon-&gt;&gt;FS: 切换 UID/GID (rsync:rsync)
        FS--&gt;&gt;Daemon: 读写数据
        Daemon--&gt;&gt;Client: 传输数据流
    else 验证失败
        Auth--&gt;&gt;Daemon: Fail
        Daemon--&gt;&gt;Client: Connection Refused
    end
</code></pre>
<h4 data-id="heading-7">服务端标准化配置</h4>
<ul>
<li>安装<code>rsync</code></li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载客户端，红帽7包含守护进程</span>
yum install -y rsync

<span class="hljs-comment"># 红帽8+ 服务端直接安装如下命令（rsync+守护进程）</span>
yum install rsync-daemon -y
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查软件包内容</span>
rpm -ql rsync
rpm -ql rsync-daemon

<span class="hljs-comment"># 配置文件（服务端配置文件、守护进程模式）</span>
/etc/rsyncd.conf
/usr/bin/rsync
<span class="hljs-comment"># systemctl对应配置文件</span>
/usr/lib/systemd/system/rsyncd.service
</code></pre>
<p>以下配置体现了权限分离（Privilege Separation）和安全基线要求：（<code>/etc/rsyncd.conf</code>）</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># --- 全局配置 (Global Settings) ---</span>
<span class="hljs-comment"># 虚拟用户，降低安全风险，避免使用 root 运行</span>
uid = rsync
gid = rsync

<span class="hljs-comment"># 安全机制：chroot 监狱，锁定进程访问范围</span>
use <span class="hljs-built_in">chroot</span> = <span class="hljs-built_in">yes</span>
<span class="hljs-comment"># 允许非 root 用户保存文件原有属性 (如 owner/group)</span>
fake super = <span class="hljs-built_in">yes</span>

<span class="hljs-comment"># 性能与连接控制</span>
max connections = 2000
<span class="hljs-built_in">timeout</span> = 600
lock file = /var/run/rsync.lock
pid file = /var/run/rsyncd.pid
<span class="hljs-built_in">log</span> file = /var/log/rsyncd.log

<span class="hljs-comment"># 容错配置</span>
<span class="hljs-comment"># 同步时忽略非致命错误，避免传输中断</span>
ignore errors
<span class="hljs-built_in">read</span> only = <span class="hljs-literal">false</span>
<span class="hljs-comment"># 关闭rsync服务端列表功能</span>
list = <span class="hljs-literal">false</span>

<span class="hljs-comment"># 网络访问控制 (ACL)</span>
<span class="hljs-comment"># 只允许哪些IP/网段访问白名单</span>
hosts allow = 10.0.0.0/24
<span class="hljs-comment"># 拒绝哪些IP/网段访问白名单</span>
hosts deny = *

<span class="hljs-comment"># --- 模块定义 (Module Definitions) ---</span>
[backup]
	path = /data/backup
	comment = Standard Backup Directory
	<span class="hljs-comment"># 认证配置</span>
	auth <span class="hljs-built_in">users</span> = rsync_bak_user
	secrets file = /etc/rsyncd.secrets
</code></pre>
<blockquote>
<p><strong>关键点解析</strong>：</p>
<ul>
<li><code>fake super = yes</code>：这是非 root 运行 Rsync 但仍需保留文件原有属性（如root:root）的关键。它通过扩展属性（xattr）来记录原始权限，非常适合备份系统文件</li>
<li><code>secrets file</code>：权限必须严格设置为 <code>600</code>，否则 Rsync 为了安全会拒绝启动</li>
</ul>
</blockquote>
<h4 data-id="heading-8">部署清单</h4>
<p>在部署时，服务端请遵循以下标准化步骤：</p>
<ul>
<li>创建虚拟用户<code>rsync</code></li>
</ul>
<pre><code class="hljs language-bash" lang="bash">useradd -s /sbin/nologin -M rsync
</code></pre>
<ul>
<li>权限控制</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建密码文件</span>
vim /etc/rsyncd.secrets
<span class="hljs-comment"># 内容如下：rsync_bak_user:password123</span>

<span class="hljs-comment"># secrets file 必须设置权限为 600，否则rsync会拒绝启动</span>
<span class="hljs-built_in">chmod</span> 600 /etc/rsyncd.secrets 

<span class="hljs-comment"># 确保/data/backup 目录属主为 rsync</span>
<span class="hljs-built_in">chown</span> -R rsync:rsync /data/backup
</code></pre>
<ul>
<li>服务管理</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">systemctl start rsyncd
systemctl <span class="hljs-built_in">enable</span> rsyncd
</code></pre>
<h4 data-id="heading-9">客户端操作</h4>
<p>客户端无需启动服务，仅需配置密码文件（注意：仅需密码，不需要用户名）以实现免密传输：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"password123"</span> &gt; /etc/rsync.pass
<span class="hljs-built_in">chmod</span> 600 /etc/rsync.pass
</code></pre>
<pre><code class="hljs language-bash" lang="bash">rsync -avz --password-file=/etc/rsync.pass /local/data/ rsync_bak_user@10.0.0.20::backup
</code></pre>
<h3 data-id="heading-10">数据完整性与可靠性保障</h3>
<p>Rsync 传输完毕不代表万事大吉。在核心数据迁移（如数据库冷备、金融数据）场景下，必须引入应用层校验</p>
<h4 data-id="heading-11">MD5 校验闭环</h4>
<p><code>md5sum</code>用于计算和校验文件报文摘要的工具程序（Linux自带），MD5算法常被用来验证网路文件传输的完整性</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">md5sum</span> (选项) (参数)
</code></pre>





























<table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td><code>-b</code></td><td>二进制模式读取文件</td></tr><tr><td><code>-t</code>、<code>--text</code></td><td>把输入的文件作为文本文件看待</td></tr><tr><td><code>-c</code></td><td>从指定文件中读取MD5校验和，并进行校验</td></tr><tr><td><code>--status</code></td><td>验证成功时不输出任何信息</td></tr><tr><td><code>-w</code></td><td>当校验不正确时给出警告信息</td></tr></tbody></table>
<p>在执行关键数据迁移后，建议增加校验步骤：</p>
<ul>
<li>源端生成指纹</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">md5sum</span> file.tar.gz &gt; file.md5
</code></pre>
<ul>
<li>
<p>同步数据文件与指纹文件</p>
</li>
<li>
<p>目标端校验</p>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">md5sum</span> -c file.md5

<span class="hljs-comment"># 文件没有变化输出</span>
forsort: OK
<span class="hljs-comment"># 文件发生变化输出</span>
forsort: FAILED
<span class="hljs-built_in">md5sum</span>: WARNING: 1 of 1 computed checksum did NOT match
</code></pre>
<p>如果输出 <code>OK</code>，则证明传输链路可靠；若出现 <code>FAILED</code>，则必须告警介入</p>
<h4 data-id="heading-12">自动化与实时同步</h4>
<p>对于定时备份，结合 <code>crontab</code> 即可满足大部分需求。若业务对 RPO（恢复点目标）要求极高，需要毫秒级同步，则应升级架构，引入 <code>inotify</code> 或 <code>sersync</code>。这些工具能监听文件系统事件，一旦文件发生变动立即触发 Rsync 推送，从而解决单点存储的风险</p>
<blockquote>
<p><strong>结语</strong>：Rsync 不仅仅是一个命令，它是构建稳健运维体系的基础组件。从理解 <code>/</code> 的细微差别，到配置 Daemon 的权限隔离，再到引入 MD5 校验闭环，每一个细节都体现了对数据安全的敬畏。掌握 Rsync 的生产级用法，是每一位运维工程师的必修课</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 移动端性能王者组合：懒加载 + 无限滚动，实战级深度解析]]></title>    <link>https://juejin.cn/post/7599708108621824051</link>    <guid>https://juejin.cn/post/7599708108621824051</guid>    <pubDate>2026-01-27T10:21:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599708108621824051" data-draft-id="7599924965949620262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 移动端性能王者组合：懒加载 + 无限滚动，实战级深度解析"/> <meta itemprop="keywords" content="React.js,TypeScript,性能优化"/> <meta itemprop="datePublished" content="2026-01-27T10:21:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="栀秋666"/> <meta itemprop="url" content="https://juejin.cn/user/2566698322650307"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 移动端性能王者组合：懒加载 + 无限滚动，实战级深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2566698322650307/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    栀秋666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:21:55.000Z" title="Tue Jan 27 2026 10:21:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p><strong>首屏卡顿？流量浪费？内存飙升？列表滚动像幻灯片？</strong><br/>
别再让一次性加载毁掉你的用户体验了！</p>
</blockquote>
<p>在移动端信息流场景中（如新闻资讯、社交动态、电商商品页），数据量大、图片密集是常态。但若处理不当，<strong>首屏加载慢、内存占用高、滚动卡顿</strong>等问题会直接劝退用户。</p>
<p>而真正的高性能体验，不是“堆硬件”，而是“精调度”。本文将带你深入 React 生态下两大核心优化技术——<strong>图片懒加载 + 无限滚动</strong>，从原理到实战，逐层拆解，手把手教你打造丝滑流畅的信息流页面。</p>
<blockquote>
<p>💡 全文基于真实项目重构经验，所有代码可直接复用，Zustand + Intersection Observer + react-lazy-load 技术栈全链路打通，助你轻松冲上性能巅峰！</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">🌟 为什么你需要关注这两个技术？</h2>






























<table><thead><tr><th>问题</th><th>后果</th><th>懒加载 &amp; 无限滚动的作用</th></tr></thead><tbody><tr><td>首屏加载上百张图</td><td>白屏时间长、CLS 高</td><td>图片按需加载，首屏秒开</td></tr><tr><td>一次性拉取几千条数据</td><td>内存爆炸、React 渲染卡顿</td><td>分页加载，只渲染可视区域附近内容</td></tr><tr><td>用户滚动到底才发现分页按钮</td><td>交互割裂、体验差</td><td>自动触发加载，沉浸式浏览</td></tr><tr><td>浏览器主线程被 <code>onscroll</code> 占满</td><td>滚动卡顿、响应延迟</td><td>使用原生异步 API，不阻塞主线程</td></tr></tbody></table>
<p>👉 <strong>一句话总结：懒加载管「资源」，无限滚动管「数据」，两者结合才是移动端高性能信息流的黄金搭档。</strong></p>
<hr/>
<h2 data-id="heading-2">🛠️ 一、技术选型：轻量高效才是王道</h2>
<p>我们坚持三个原则：<strong>轻量、高效、可复用</strong>。因此选择了以下技术组合：</p>





























<table><thead><tr><th>技术</th><th>选择理由</th></tr></thead><tbody><tr><td><strong>Zustand</strong></td><td>替代 Redux/Context，体积仅 1KB，无 Provider 嵌套，状态更新精准，避免无效重渲染</td></tr><tr><td><strong>react-lazy-load</strong></td><td>封装了 Intersection Observer 的图片懒加载组件，使用简单且兼容性好</td></tr><tr><td><strong>Intersection Observer API</strong></td><td>浏览器原生命令，运行在主线程之外，监听元素可见性无性能损耗</td></tr><tr><td><strong>自定义 InfiniteScroll 组件</strong></td><td>解耦业务逻辑，支持任意列表复用，防重复请求、防内存泄漏</td></tr><tr><td><strong>Lucide React 图标库</strong></td><td>轻量、可 Tree Shaking、图标丰富，适合移动端</td></tr></tbody></table>
<blockquote>
<p>✅ 所有依赖总包体积 &lt; 5KB，真正实现“小身材大能量”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">🖼️ 二、图片懒加载：让首屏快如闪电</h2>
<h3 data-id="heading-4">❌ 传统方式的三大痛点</h3>
<ol>
<li>所有 <code>&lt;img src="real-url"&gt;</code> 一上来就发起请求 → 首屏网络拥堵</li>
<li>图片加载前后容器高度变化 → 页面布局偏移（CLS 指标爆表）</li>
<li>用户根本没看到的图片也被加载 → 浪费流量 &amp; 用户耐心</li>
</ol>
<h3 data-id="heading-5">✅ 正确姿势：按需加载 + 占位控制 + 提前预判</h3>
<h4 data-id="heading-6">核心实现：<code>react-lazy-load</code> + <code>loading="lazy"</code> 双保险</h4>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">LazyLoad</span> className=<span class="hljs-string">"w-full h-full"</span> offset={<span class="hljs-number">100</span>}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
    <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span> // <span class="hljs-attr">原生降级方案</span>
    <span class="hljs-attr">src</span>=<span class="hljs-string">{post.thumbnail}</span>
    <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-full object-cover"</span>
  /&gt;</span></span>
&lt;/<span class="hljs-title class_">LazyLoad</span>&gt;
</code></pre>
<h4 data-id="heading-7">关键点解析：</h4>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><code>offset={100}</code></td><td>提前 100px 开始加载，用户滑到时图已显示，实现“无感知加载”</td></tr><tr><td><code>loading="lazy"</code></td><td>浏览器原生懒加载属性，作为不支持 Intersection Observer 时的兜底方案</td></tr><tr><td><code>object-cover</code> + 固定尺寸</td><td>容器 <code>w-24 h-24</code> 不随图片加载改变，防止布局偏移</td></tr><tr><td>条件渲染 <code>{post.thumbnail &amp;&amp; ...}</code></td><td>空值不生成 DOM，减少渲染负担</td></tr></tbody></table>
<h3 data-id="heading-8">🚀 进阶优化技巧（提升体验细节）</h3>





















<table><thead><tr><th>技巧</th><th>效果</th></tr></thead><tbody><tr><td><strong>LQIP（低质量占位图）</strong></td><td>先展示模糊小图，让用户感知内容正在加载</td></tr><tr><td><strong>WebP/AVIF 图片格式</strong></td><td>同等画质下体积减少 50%，CDN 可自动转换</td></tr><tr><td><strong>取消监听机制</strong></td><td>图片加载完成后自动卸载 observer，释放资源</td></tr></tbody></table>
<blockquote>
<p>⚠️ 注意：手动实现时务必在 <code>onload</code> 中调用 <code>observer.unobserve()</code>，否则会造成内存泄漏！</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">🔁 三、无限滚动：打造沉浸式内容消费体验</h2>
<h3 data-id="heading-10">🤔 为什么要用无限滚动？</h3>
<p>相比传统“点击加载更多”或“翻页”：</p>
<ul>
<li>✅ 减少操作步骤，提升浏览效率</li>
<li>✅ 更符合移动端“一直往下刷”的直觉</li>
<li>✅ 数据加载更平滑，体验更沉浸</li>
</ul>
<p>但如果不加以控制，很容易引发：</p>
<ul>
<li>❌ 请求风暴（反复触发加载）</li>
<li>❌ 内存泄漏（Observer 未清理）</li>
<li>❌ 列表重复渲染</li>
</ul>
<h3 data-id="heading-11">✅ 正确实现思路：哨兵元素 + 状态锁 + 资源回收</h3>
<h4 data-id="heading-12">实现核心：<code>InfiniteScroll</code> 通用组件封装</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">InfiniteScrollProps</span> {
  <span class="hljs-attr">hasMore</span>: <span class="hljs-built_in">boolean</span>;
  isLoading?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">onLoadMore</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">InfiniteScroll</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">InfiniteScrollProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  hasMore,
  isLoading = <span class="hljs-literal">false</span>,
  onLoadMore,
  children,
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> sentinelRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!hasMore || isLoading) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(
      <span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (entries[<span class="hljs-number">0</span>].<span class="hljs-property">isIntersecting</span>) {
          <span class="hljs-title function_">onLoadMore</span>();
        }
      },
      { <span class="hljs-attr">threshold</span>: <span class="hljs-number">0</span> }
    );

    <span class="hljs-keyword">if</span> (sentinelRef.<span class="hljs-property">current</span>) {
      observer.<span class="hljs-title function_">observe</span>(sentinelRef.<span class="hljs-property">current</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (sentinelRef.<span class="hljs-property">current</span>) {
        observer.<span class="hljs-title function_">unobserve</span>(sentinelRef.<span class="hljs-property">current</span>);
      }
      observer.<span class="hljs-title function_">disconnect</span>(); <span class="hljs-comment">// 必须断开连接！</span>
    };
  }, [onLoadMore, hasMore, isLoading]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {children}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{sentinelRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-4"</span> /&gt;</span> {/* 哨兵 */}
      {isLoading &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center py-4"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      {!hasMore &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center py-4"</span>&gt;</span>没有更多了<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">InfiniteScroll</span>;
</code></pre>
<h4 data-id="heading-13">🔍 核心设计亮点</h4>

























<table><thead><tr><th>设计</th><th>作用</th></tr></thead><tbody><tr><td><code>sentinelRef</code> 哨兵元素</td><td>触发加载的“开关”，不可见但能被监听</td></tr><tr><td><code>threshold: 0</code></td><td>元素刚进入视口即触发，响应及时</td></tr><tr><td><code>hasMore与isLoading</code> 判断</td><td>防止重复请求和无效加载</td></tr><tr><td><code>useEffect</code> 返回清理函数</td><td>防止内存泄漏，组件销毁后释放资源</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">🧠 四、状态管理：用 Zustand 实现精准控制</h2>
<p>为了统一管理分页状态，我们使用 Zustand 创建全局状态：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// store/useHomeStore.ts</span>
<span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;
<span class="hljs-keyword">import</span> { fetchPosts } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/posts'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HomeState</span> {
  <span class="hljs-attr">posts</span>: <span class="hljs-title class_">Post</span>[];
  <span class="hljs-attr">page</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">loading</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">hasMore</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">loadMore</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useHomeStore = create&lt;<span class="hljs-title class_">HomeState</span>&gt;(<span class="hljs-function">(<span class="hljs-params">set, get</span>) =&gt;</span> ({
  <span class="hljs-attr">posts</span>: [],
  <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">hasMore</span>: <span class="hljs-literal">true</span>,

  <span class="hljs-attr">loadMore</span>: <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">get</span>().<span class="hljs-property">loading</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 加载锁，防重复请求</span>

    <span class="hljs-title function_">set</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span> });

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { items } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchPosts</span>(<span class="hljs-title function_">get</span>().<span class="hljs-property">page</span>);

      <span class="hljs-keyword">if</span> (items.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-title function_">set</span>({ <span class="hljs-attr">hasMore</span>: <span class="hljs-literal">false</span> });
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-title function_">set</span>({
        <span class="hljs-attr">posts</span>: [...<span class="hljs-title function_">get</span>().<span class="hljs-property">posts</span>, ...items],
        <span class="hljs-attr">page</span>: <span class="hljs-title function_">get</span>().<span class="hljs-property">page</span> + <span class="hljs-number">1</span>,
        <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,
      });
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载失败'</span>, err);
      <span class="hljs-title function_">set</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> }); <span class="hljs-comment">// 失败也要释放锁</span>
    }
  },
}));
</code></pre>
<blockquote>
<p>✅ <strong>加载锁机制</strong> 是防止请求风暴的关键！任何情况下都要确保 <code>loading</code> 最终会被重置。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">🧩 五、页面整合：Home 组件完整示例</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { banners, posts, hasMore, loading, loadMore } = <span class="hljs-title function_">useHomeStore</span>();

  <span class="hljs-comment">// 首次加载第一页</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">loadMore</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"首页"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"p-4 space-y-4"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">SlideShow</span> <span class="hljs-attr">slides</span>=<span class="hljs-string">{banners}</span> /&gt;</span>
        
        {/* 文章列表 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"container mx-auto py-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-2xl font-bold mb-6"</span>&gt;</span>文章列表<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

          <span class="hljs-tag">&lt;<span class="hljs-name">InfiniteScroll</span>
            <span class="hljs-attr">hasMore</span>=<span class="hljs-string">{hasMore}</span>
            <span class="hljs-attr">isLoading</span>=<span class="hljs-string">{loading}</span>
            <span class="hljs-attr">onLoadMore</span>=<span class="hljs-string">{loadMore}</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
              {posts.map((post) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">PostItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{post.id}</span> <span class="hljs-attr">post</span>=<span class="hljs-string">{post}</span> /&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">InfiniteScroll</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p>📌 <strong>关键整合逻辑：</strong></p>
<ul>
<li><code>useEffect</code> 初始化加载第一页</li>
<li><code>key={post.id}</code> 保证 React 列表 diff 高效</li>
<li><code>InfiniteScroll</code> 接收状态，自动控制加载提示和结束标识</li>
</ul>
<h3 data-id="heading-16">实现效果：</h3>
<p>1.当滑动到文章列表最下端时：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18bc7031a66f4f709521c2e8f72a0d58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCA56eLNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114115&amp;x-signature=Iy3ijvsm%2Bw7gtci7RIXYYRUSNc4%3D" alt="image.png" loading="lazy"/>
2.当继续往下滑时：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cf6ee41b3bc4d84ba4d1f34a0687df4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCA56eLNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114115&amp;x-signature=8W7BJX4TdKfMZXwVqUhKvA73rtE%3D" alt="image.png" loading="lazy"/>
页面会自动刷新，此时文章列表加长
当一直往下滑，滑倒文章全部显现时：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f59c072e2024b549dd616c407ad4bfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCA56eLNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114115&amp;x-signature=juuu19jIbc4VO3qghTI875pyQ%2BA%3D" alt="image.png" loading="lazy"/>
此时已经到底部，显示没有更多了</p>
<hr/>
<h2 data-id="heading-17">⚠️ 六、常见坑点 &amp; 解决方案（避雷必看）</h2>



































<table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>重复请求 / 请求风暴</strong></td><td>未判断 <code>loading</code> 或 <code>threshold</code> 设置不合理</td><td>添加加载锁，合理设置阈值（建议 <code>0</code> 或 <code>1</code>）</td></tr><tr><td><strong>内存泄漏</strong></td><td>组件卸载后仍监听哨兵元素</td><td>在 <code>useEffect</code> 返回中调用 <code>unobserve</code> 和 <code>disconnect</code></td></tr><tr><td><strong>布局偏移（CLS 高）</strong></td><td>图片容器无固定尺寸</td><td>设置宽高 + <code>object-cover</code> + 占位图</td></tr><tr><td><strong>懒加载失效</strong></td><td>直接写了 <code>src</code> 或未包裹组件</td><td>确保由懒加载组件控制 <code>src</code> 加载时机</td></tr><tr><td><strong>移动端兼容性差</strong></td><td>旧浏览器不支持 Intersection Observer</td><td>使用 <code>loading="lazy"</code> 降级 + polyfill（可选）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-18">🏆 七、性能优化总结：六大核心要点</h2>

































<table><thead><tr><th>优化方向</th><th>具体措施</th></tr></thead><tbody><tr><td><strong>资源调度</strong></td><td>图片懒加载 + 数据分页加载</td></tr><tr><td><strong>监听性能</strong></td><td>使用 Intersection Observer 替代 <code>onscroll</code></td></tr><tr><td><strong>内存安全</strong></td><td>组件卸载时清理 Observer</td></tr><tr><td><strong>用户体验</strong></td><td>提前加载（offset）、占位图、无闪烁过渡</td></tr><tr><td><strong>状态精准</strong></td><td>Zustand 管理 loading、page、hasMore</td></tr><tr><td><strong>可维护性</strong></td><td>封装通用组件，业务层只关心数据和 UI</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-19">✅ 八、结语：这才是现代 React 移动端该有的样子</h2>
<p>通过本文的实践，你应该已经掌握：</p>
<p>✅ 如何用 <code>react-lazy-load</code> 实现高性能图片懒加载<br/>
✅ 如何封装一个防重复、防泄漏的 <code>InfiniteScroll</code> 组件<br/>
✅ 如何用 Zustand 实现优雅的状态管理<br/>
✅ 如何规避移动端常见的性能陷阱</p>
<p>这些方案已在多个生产项目中验证，无论是资讯类 App、社交 Feed 流还是电商商品页，均可直接复用。</p>
<hr/>
<h2 data-id="heading-20">📣 最后呼吁：别再写“一次性加载”的代码了！</h2>
<p>如果你还在这样做：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">fetchAllData</span>(); <span class="hljs-comment">// 拉取几千条</span>
}, []);
</code></pre>
<p>那你真的该停下来思考一下：<strong>你在为谁牺牲性能？</strong></p>
<p>从今天起，拥抱“按需加载”的理念，用懒加载 + 无限滚动，给用户一个更快、更稳、更省流量的移动体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[cross-env@10.1.0源码阅读]]></title>    <link>https://juejin.cn/post/7599843186202591274</link>    <guid>https://juejin.cn/post/7599843186202591274</guid>    <pubDate>2026-01-27T10:26:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599843186202591274" data-draft-id="7598737609493708819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" cross-env@10.1.0源码阅读"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-27T10:26:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="米丘"/> <meta itemprop="url" content="https://juejin.cn/user/1611227736052074"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             cross-env@10.1.0源码阅读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1611227736052074/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    米丘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:26:17.000Z" title="Tue Jan 27 2026 10:26:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>发布日期： 2025 年 9 月 30 日</em></p>
<p><code>cross-env</code> 是一个 Node.js 工具，用于解决不同操作系统间环境变量设置方式不一致的问题，支持 Windows、Linux 和 macOS平台。</p>
<h2 data-id="heading-0">package.json</h2>
<p><code>cross-env-10.1.0/package.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.0.0-semantically-released"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Run scripts that set and use environment variables across platforms"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"cross-env"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/bin/cross-env.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cross-env-shell"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/bin/cross-env-shell.js"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=20"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zshy"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zshy --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint ."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint:fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint . --fix"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --write ."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"format:check"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --check ."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typecheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc --noEmit"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test:ui"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest --ui"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test:run"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test:coverage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vitest run --coverage"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test:e2e"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node e2e/test-cross-env.js &amp;&amp; node e2e/test-cross-env-shell.js &amp;&amp; node e2e/test-default-values.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"validate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build &amp;&amp; npm run typecheck &amp;&amp; npm run lint &amp;&amp; npm run format:check &amp;&amp; npm run test:run"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"dist"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"cross-environment"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"environment variable"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"windows"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"cross-platform"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Kent C. Dodds &lt;me@kentcdodds.com&gt; (https://kentcdodds.com)"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@epic-web/invariant"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cross-spawn"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^7.0.6"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@epic-web/config"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.21.1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/cross-spawn"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^6.0.6"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^24.1.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@vitest/coverage-v8"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.2.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@vitest/ui"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.2.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"eslint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.32.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prettier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.6.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.8.3"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"vitest"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.2.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"zshy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.3.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"repository"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/kentcdodds/cross-env.git"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bugs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/kentcdodds/cross-env/issues"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://github.com/kentcdodds/cross-env#readme"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"zshy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"cjs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./src/index.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"./bin/cross-env"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./src/bin/cross-env.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"./bin/cross-env-shell"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./src/bin/cross-env-shell.ts"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"prettier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@epic-web/config/prettier"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./bin/cross-env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/bin/cross-env.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/bin/cross-env.js"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"./bin/cross-env-shell"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/bin/cross-env-shell.d.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/bin/cross-env-shell.js"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<h2 data-id="heading-1">cross-env</h2>
<p><code>cross-env-10.1.0/src/bin/cross-env.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-keyword">import</span> { crossEnv } <span class="hljs-keyword">from</span> <span class="hljs-string">'../index.js'</span>

<span class="hljs-comment">// process.argv.slice(2) 用于获取命令行参数（排除掉 node 和脚本路径本身）</span>
<span class="hljs-title function_">crossEnv</span>(process.<span class="hljs-property">argv</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>))

</code></pre>
<h2 data-id="heading-2">cross-env-shell</h2>
<p><code>cross-env-10.1.0/src/bin/cross-env-shell.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-keyword">import</span> { crossEnv } <span class="hljs-keyword">from</span> <span class="hljs-string">'../index.js'</span>

<span class="hljs-title function_">crossEnv</span>(process.<span class="hljs-property">argv</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>), { <span class="hljs-attr">shell</span>: <span class="hljs-literal">true</span> })

</code></pre>
<h2 data-id="heading-3">crossEnv</h2>
<p><code>cross-env-10.1.0/src/index.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { spawn } <span class="hljs-keyword">from</span> <span class="hljs-string">'cross-spawn'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">crossEnv</span>(<span class="hljs-params">
  args: <span class="hljs-built_in">string</span>[],
  options: CrossEnvOptions = {},
</span>): <span class="hljs-title class_">ProcessResult</span> | <span class="hljs-literal">null</span> {

  <span class="hljs-comment">// 1、解析命令行参数</span>
  <span class="hljs-comment">// envSetters：需要设置的环境变量键值对（如 { NODE_ENV: 'production' }）</span>
  <span class="hljs-comment">// command：要执行的命令（如 node 或 webpack）</span>
  <span class="hljs-comment">// commandArgs：命令的参数（如 ['server.js']）</span>
  <span class="hljs-keyword">const</span> [envSetters, command, commandArgs] = <span class="hljs-title function_">parseCommand</span>(args)

  <span class="hljs-comment">// 2、构建环境变量对象</span>
  <span class="hljs-comment">// 基于当前进程的环境变量（process.env）</span>
  <span class="hljs-comment">// 合并 envSetters 中的自定义环境变量（会经过格式处理）</span>
  <span class="hljs-comment">// 保证跨平台兼容性（如保留 Windows 的 APPDATA 变量）</span>
  <span class="hljs-keyword">const</span> env = <span class="hljs-title function_">getEnvVars</span>(envSetters)

  <span class="hljs-comment">// 3、执行命令（当命令存在时）</span>
  <span class="hljs-keyword">if</span> (command) {
    <span class="hljs-comment">// 配置子进程启动选项</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">spawnOptions</span>: <span class="hljs-title class_">SpawnOptions</span> = {
      <span class="hljs-attr">stdio</span>: <span class="hljs-string">'inherit'</span>,   <span class="hljs-comment">// 子进程共享父进程的输入输出流（控制台）</span>
      <span class="hljs-attr">shell</span>: options.<span class="hljs-property">shell</span>,  <span class="hljs-comment">// 是否通过 shell 执行命令（可选）</span>
      env,  <span class="hljs-comment">// 使用上面构建的环境变量对象</span>
    }

    <span class="hljs-comment">// 启动子进程执行命令</span>
    <span class="hljs-comment">// 使用 cross-spawn 的 spawn 函数（跨平台版本的 child_process.spawn）启动子进程</span>
    <span class="hljs-keyword">const</span> proc = <span class="hljs-title function_">spawn</span>(
      <span class="hljs-comment">// run `path.normalize` for command(on windows)</span>
      <span class="hljs-comment">// 处理命令名称（如 Windows 路径规范化）</span>
      <span class="hljs-title function_">commandConvert</span>(command, env, <span class="hljs-literal">true</span>),
      <span class="hljs-comment">// by default normalize is `false`, so not run for cmd args</span>
       <span class="hljs-comment">// 处理命令参数</span>
      commandArgs.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">arg</span>) =&gt;</span> <span class="hljs-title function_">commandConvert</span>(arg, env)),
      spawnOptions,
    )

    <span class="hljs-comment">// 4、信号处理（进程间通信）</span>
    <span class="hljs-comment">// 当父进程收到终止信号时，将信号传递给子进程</span>
    <span class="hljs-comment">// 确保父进程收到终止信号（如用户按 Ctrl+C）时，子进程能同步终止，避免僵尸进程</span>
    process.<span class="hljs-title function_">on</span>(<span class="hljs-string">'SIGTERM'</span>, <span class="hljs-function">() =&gt;</span> proc.<span class="hljs-title function_">kill</span>(<span class="hljs-string">'SIGTERM'</span>))
    process.<span class="hljs-title function_">on</span>(<span class="hljs-string">'SIGINT'</span>, <span class="hljs-function">() =&gt;</span> proc.<span class="hljs-title function_">kill</span>(<span class="hljs-string">'SIGINT'</span>))
    process.<span class="hljs-title function_">on</span>(<span class="hljs-string">'SIGBREAK'</span>, <span class="hljs-function">() =&gt;</span> proc.<span class="hljs-title function_">kill</span>(<span class="hljs-string">'SIGBREAK'</span>))
    process.<span class="hljs-title function_">on</span>(<span class="hljs-string">'SIGHUP'</span>, <span class="hljs-function">() =&gt;</span> proc.<span class="hljs-title function_">kill</span>(<span class="hljs-string">'SIGHUP'</span>))

    <span class="hljs-comment">// 5、处理子进程退出</span>
    proc.<span class="hljs-title function_">on</span>(<span class="hljs-string">'exit'</span>, <span class="hljs-function">(<span class="hljs-params">code: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>, signal?: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> crossEnvExitCode = code
      <span class="hljs-comment">// 如果退出码为 null（通常是被信号终止），设置默认退出码</span>
      <span class="hljs-comment">// 处理信号终止的情况（如 SIGINT 通常是用户主动中断，返回 0 表示正常退出）</span>
      <span class="hljs-keyword">if</span> (crossEnvExitCode === <span class="hljs-literal">null</span>) {
        crossEnvExitCode = signal === <span class="hljs-string">'SIGINT'</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>
      }
      <span class="hljs-comment">// 父进程使用子进程的退出码退出</span>
      process.<span class="hljs-title function_">exit</span>(crossEnvExitCode)
    })

    <span class="hljs-keyword">return</span> proc
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"test-crossenv"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cross-env NODE_ENV=test node test-crossenv.js"</span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>执行 <code>npm run test-crossenv</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bac6b5b7d9044796b6f237482f645e01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Gz5LiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114378&amp;x-signature=1p0pXYbyMhg20iKs15GstPIoHOA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">parseCommand</h3>
<p><code>cross-env-10.1.0/src/index.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">parseCommand</span>(<span class="hljs-params">
  args: <span class="hljs-built_in">string</span>[],
</span>): [<span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;, <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>, <span class="hljs-built_in">string</span>[]] {

  <span class="hljs-comment">// 存储环境变量</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">envSetters</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {}
  <span class="hljs-comment">// 存储命令名称</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">command</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
  <span class="hljs-comment">// 存储命令参数</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">commandArgs</span>: <span class="hljs-built_in">string</span>[] = []

  <span class="hljs-comment">// 遍历处理参数</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; args.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> arg = args[i]
    <span class="hljs-keyword">if</span> (!arg) <span class="hljs-keyword">continue</span> <span class="hljs-comment">// 跳过空参数</span>
    <span class="hljs-keyword">const</span> match = envSetterRegex.<span class="hljs-title function_">exec</span>(arg)

    <span class="hljs-comment">// 解析环境变量</span>
    <span class="hljs-keyword">if</span> (match &amp;&amp; match[<span class="hljs-number">1</span>]) {
      <span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> match[<span class="hljs-number">3</span>] !== <span class="hljs-string">'undefined'</span>) {
        value = match[<span class="hljs-number">3</span>]
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> match[<span class="hljs-number">4</span>] === <span class="hljs-string">'undefined'</span>) {
        value = match[<span class="hljs-number">5</span>] || <span class="hljs-string">''</span>
      } <span class="hljs-keyword">else</span> {
        value = match[<span class="hljs-number">4</span>]
      }

      envSetters[match[<span class="hljs-number">1</span>]] = value

      <span class="hljs-comment">// 解析命令和命令参数</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// No more env setters, the rest of the line must be the command and args</span>
      <span class="hljs-keyword">const</span> cStart = args
        .<span class="hljs-title function_">slice</span>(i)
        .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">a</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> re = <span class="hljs-regexp">/\\\\|(\\)?'|([\\])(?=[$"\\])/g</span>
          <span class="hljs-comment">// Eliminate all matches except for "\'" =&gt; "'"</span>
          <span class="hljs-keyword">return</span> a.<span class="hljs-title function_">replace</span>(re, <span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (m === <span class="hljs-string">'\\\\'</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'\\'</span>
            <span class="hljs-keyword">if</span> (m === <span class="hljs-string">"\\'"</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"'"</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
          })
        })
      <span class="hljs-keyword">const</span> parsedCommand = cStart[<span class="hljs-number">0</span>]
      <span class="hljs-title function_">invariant</span>(parsedCommand, <span class="hljs-string">'Command is required'</span>) <span class="hljs-comment">// 确保命令存在</span>
      command = parsedCommand
      commandArgs = cStart.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>) <span class="hljs-comment">// 过滤空参数</span>
      <span class="hljs-comment">// 退出循环，后续参数已处理</span>
      <span class="hljs-keyword">break</span>
    }
  }

  <span class="hljs-keyword">return</span> [envSetters, command, commandArgs]
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> envSetterRegex = <span class="hljs-regexp">/(\w+)=('(.*)'|"(.*)"|(.*))/</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> re = <span class="hljs-regexp">/\\\\|(\\)?'|([\\])(?=[$"\\])/g</span>
</code></pre>
<h3 data-id="heading-5">getEnvVars</h3>
<p><code>cross-env-10.1.0/src/index.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getEnvVars</span>(<span class="hljs-params">
  envSetters: Record&lt;string, string&gt;
</span>): <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">ProcessEnv</span> {
  
  <span class="hljs-comment">// 初始化环境变量对象</span>
  <span class="hljs-keyword">const</span> envVars = { ...process.<span class="hljs-property">env</span> }

  <span class="hljs-comment">// 特殊处理 Windows 系统的 APPDATA 变量</span>
  <span class="hljs-comment">// APPDATA 是 Windows 系统中存储应用程序数据的目录路径环境变量</span>
  <span class="hljs-comment">// 通常路径为 C:\Users\&lt;用户名&gt;\AppData\Roaming）</span>
  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">APPDATA</span>) {
    envVars.<span class="hljs-property">APPDATA</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">APPDATA</span>
  }

  <span class="hljs-comment">// 合并并处理自定义环境变量</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(envSetters).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">varName</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> value = envSetters[varName]
    <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">undefined</span>) {
      envVars[varName] = <span class="hljs-title function_">varValueConvert</span>(value, varName)
    }
  })
  <span class="hljs-keyword">return</span> envVars
}
</code></pre>
<h4 data-id="heading-6">varValueConvert</h4>
<p><code>cross-env-10.1.0/src/variable.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">varValueConvert</span>(<span class="hljs-params">
	originalValue: string,
	originalName: string,
</span>): string {
	<span class="hljs-keyword">return</span> <span class="hljs-title function_">resolveEnvVars</span>(<span class="hljs-title function_">replaceListDelimiters</span>(originalValue, originalName))
}
</code></pre>
<h4 data-id="heading-7">replaceListDelimiters</h4>
<p><code>cross-env-10.1.0/src/variable.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">replaceListDelimiters</span>(<span class="hljs-params">varValue: string, varName = <span class="hljs-string">''</span></span>): string {

  <span class="hljs-comment">// 1、确定目标分隔符</span>
  <span class="hljs-comment">// Windows 系统的路径列表分隔符是 ;（例如 PATH=C:\a;C:\b）</span>
  <span class="hljs-comment">// 类 Unix 系统（Linux、macOS 等）的路径列表分隔符是 :（例如 PATH=/usr/bin:/bin）</span>
  <span class="hljs-keyword">const</span> targetSeparator = <span class="hljs-title function_">isWindows</span>() ? <span class="hljs-string">';'</span> : <span class="hljs-string">':'</span>

  <span class="hljs-comment">// pathLikeEnvVarWhitelist 是一个白名单集合（包含 PATH、NODE_PATH 环境变量名）</span>
  <span class="hljs-keyword">if</span> (!pathLikeEnvVarWhitelist.<span class="hljs-title function_">has</span>(varName)) {
    <span class="hljs-keyword">return</span> varValue
  }

  <span class="hljs-comment">// 匹配一个或多个反斜杠（\\*）后面紧跟一个冒号（:）</span>
  <span class="hljs-comment">// (\\*): 捕获组，匹配0个或多个反斜杠</span>
  <span class="hljs-comment">// 在JavaScript字符串中需要用两个反斜杠表示一个实际的反斜杠</span>
  <span class="hljs-keyword">return</span> varValue.<span class="hljs-title function_">replace</span>(
    <span class="hljs-regexp">/(\\*):/g</span>, 
    <span class="hljs-comment">// 替换回调</span>
    <span class="hljs-comment">// match: 完整的匹配结果（反斜杠序列加冒号）</span>
    <span class="hljs-comment">// backslashes: 捕获组中匹配的反斜杠部分</span>
    <span class="hljs-function">(<span class="hljs-params">match, backslashes</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (backslashes.<span class="hljs-property">length</span> % <span class="hljs-number">2</span>) {
        <span class="hljs-comment">// 反斜杠数量为奇数：表示分隔符被转义，移除一个反斜杠</span>
        <span class="hljs-keyword">return</span> match.<span class="hljs-title function_">substring</span>(<span class="hljs-number">1</span>)
      }
      <span class="hljs-comment">// 反斜杠数量为偶数：表示是普通分隔符，替换为目标分隔符</span>
      <span class="hljs-keyword">return</span> backslashes + targetSeparator
    })
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> pathLikeEnvVarWhitelist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-string">'PATH'</span>, <span class="hljs-string">'NODE_PATH'</span>])
</code></pre>
<h4 data-id="heading-8">resolveEnvVars</h4>
<p><code>cross-env-10.1.0/src/variable.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveEnvVars</span>(<span class="hljs-params">varValue: string</span>): string {

  <span class="hljs-keyword">const</span> envUnixRegex = <span class="hljs-regexp">/(\\*)(\$(\w+)|\${(\w+)})/g</span>

  <span class="hljs-keyword">return</span> varValue.<span class="hljs-title function_">replace</span>(
    envUnixRegex,
    <span class="hljs-comment">// 替换回调函数</span>
    <span class="hljs-comment">// escapeChars：环境变量引用前的所有反斜杠（捕获组 1）</span>
    <span class="hljs-comment">// varNameWithDollarSign：完整的环境变量引用（如 $VAR 或 ${VAR}）</span>
    <span class="hljs-comment">// varName：$VAR 格式中的变量名（捕获组 3）</span>
    <span class="hljs-comment">// altVarName：${VAR} 格式中的变量名（捕获组 4）</span>
    <span class="hljs-function">(<span class="hljs-params">_, escapeChars, varNameWithDollarSign, varName, altVarName</span>) =&gt;</span> {
      <span class="hljs-comment">// 奇数个反斜杠</span>
      <span class="hljs-comment">// 当反斜杠数量为奇数时，表示这个环境变量引用被转义了，应该保留原始格式（不替换为实际值）</span>
      <span class="hljs-keyword">if</span> (escapeChars.<span class="hljs-property">length</span> % <span class="hljs-number">2</span> === <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> varNameWithDollarSign
      }
      <span class="hljs-comment">// 偶数个反斜杠</span>
      <span class="hljs-comment">// 反斜杠数量为偶数时，表示是正常的环境变量引用</span>
      <span class="hljs-comment">// 保留一半的反斜杠（因为偶数个反斜杠是成对的转义）</span>
      <span class="hljs-comment">// 拼接上环境变量的实际值（从 process.env 获取，不存在则用空字符串）</span>
      <span class="hljs-keyword">return</span> (
        escapeChars.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, escapeChars.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>) +
        (process.<span class="hljs-property">env</span>[varName || altVarName] || <span class="hljs-string">''</span>)
      )
    },
  )
}
</code></pre>
<h3 data-id="heading-9">commandConvert</h3>
<p><code>cross-env-10.1.0/src/command.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commandConvert</span>(<span class="hljs-params">
  command: string,
  env: NodeJS.ProcessEnv,
  normalize = <span class="hljs-literal">false</span>,
</span>): string {
  <span class="hljs-comment">// 1、非 Windows 系统直接返回</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isWindows</span>()) {
    <span class="hljs-keyword">return</span> command
  }

  <span class="hljs-comment">// 2、定义正则</span>
  <span class="hljs-comment">// 匹配简单变量引用: $var 或 ${var}</span>
  <span class="hljs-keyword">const</span> simpleEnvRegex = <span class="hljs-regexp">/\$(\w+)|\${(\w+)}/g</span>
  <span class="hljs-comment">// 匹配带默认值的 Bash 参数扩展: ${var:-default}</span>
  <span class="hljs-keyword">const</span> defaultValueRegex = <span class="hljs-regexp">/\$\{(\w+):-([^}]+)\}/g</span>

  <span class="hljs-keyword">let</span> convertedCmd = command

  <span class="hljs-comment">// First, handle bash parameter expansion with default values</span>
  <span class="hljs-comment">// 3、处理带默认值的变量引用</span>
  convertedCmd = convertedCmd.<span class="hljs-title function_">replace</span>(
    defaultValueRegex,
    <span class="hljs-comment">// 替换回调函数</span>
    <span class="hljs-comment">// match：整个匹配的字符串（如 ${PORT:-3000}）</span>
    <span class="hljs-comment">// varName：正则捕获组 1 的值，即环境变量名（如 PORT）</span>
    <span class="hljs-comment">// defaultValue：正则捕获组 2 的值，即默认值（如 3000）</span>
    <span class="hljs-function">(<span class="hljs-params">match, varName, defaultValue</span>) =&gt;</span> {
      <span class="hljs-comment">// 优先用环境变量值，否则用默认值</span>
      <span class="hljs-keyword">const</span> value = env[varName] || defaultValue
      <span class="hljs-keyword">return</span> value
    },
  )

  <span class="hljs-comment">// 4、处理简单变量引用</span>
  convertedCmd = convertedCmd.<span class="hljs-title function_">replace</span>(
    simpleEnvRegex, 
    <span class="hljs-comment">// 替换回调函数</span>
    <span class="hljs-comment">// match：整个匹配的字符串（如 $PATH 或 ${HOME}）</span>
    <span class="hljs-comment">// $1：正则第一个捕获组的值，对应 $VAR 格式中的变量名（如 PATH）</span>
    <span class="hljs-comment">// $2：正则第二个捕获组的值，对应 ${VAR} 格式中的变量名（如 HOME）</span>
    <span class="hljs-function">(<span class="hljs-params">match, $1, $2</span>) =&gt;</span> {
      <span class="hljs-comment">// 从捕获组获取变量名（$1 对应 $VAR，$2 对应 ${VAR}）</span>
      <span class="hljs-keyword">const</span> varName = $1 || $2
      <span class="hljs-comment">// 如果环境变量存在，返回 Windows 风格的 %VAR%，否则返回空字符串</span>
      <span class="hljs-keyword">return</span> env[varName] ? <span class="hljs-string">`%<span class="hljs-subst">${varName}</span>%`</span> : <span class="hljs-string">''</span>
    })

  <span class="hljs-comment">// 5、路径规范化（可选）</span>
  <span class="hljs-keyword">return</span> normalize === <span class="hljs-literal">true</span> ? path.<span class="hljs-title function_">normalize</span>(convertedCmd) : convertedCmd
}
</code></pre>
<h4 data-id="heading-10">isWindows</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isWindows</span>(<span class="hljs-params"/>): boolean {
  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// 条件1：检测原生 Windows 系统</span>
    process.<span class="hljs-property">platform</span> === <span class="hljs-string">'win32'</span> ||
    <span class="hljs-comment">// 条件2：检测 Windows 兼容环境（msys/cygwin）</span>
    <span class="hljs-regexp">/^(msys|cygwin)$/</span>.<span class="hljs-title function_">test</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">OSTYPE</span> || <span class="hljs-string">''</span>)
  )
}
</code></pre>
<p><code>process.platform</code>：是 Node.js 内置的进程属性，用于返回当前操作系统的平台标识，不同系统对应固定值：</p>
<ol>
<li>Windows 系统（包括 Windows 10/11、Windows Server 等）返回 <code>'win32'</code>（注意：即使是 64 位 Windows，也返回 <code>'win32'</code>，这是历史兼容设计）；</li>
<li>macOS 系统返回 <code>'darwin'</code>；</li>
<li>Linux 系统返回 <code>'linux'</code>；</li>
</ol>
<p><code>process.env.OSTYPE</code>：是环境变量中存储的 “操作系统类型” 标识，常见于 Unix-like 环境或 Windows 兼容层（如 msys、cygwin）：</p>
<ol>
<li><code>msys</code>/<code>cygwin</code>：是 Windows 系统上的两款类 Unix 兼容层工具（可模拟 Linux/macOS 的命令行环境，如 Git Bash 基于 msys），它们会将 <code>OSTYPE</code> 设为 <code>'msys'</code> 或 <code>'cygwin'</code>；</li>
<li>原生 Linux/macOS 中，<code>OSTYPE</code> 通常为 <code>'linux-gnu'</code> 或 <code>'darwin'</code>，不会匹配此正则。</li>
</ol>
<h2 data-id="heading-11">cross-env 适用场景</h2>
<ol>
<li>简单命令执行，不需要 shell 特性。</li>
<li>需要高性能执行的场景（不经过 shell 可以略微提高性能）。</li>
<li>安全敏感场景（避免 shell 注入风险）。</li>
</ol>
<h2 data-id="heading-12">cross-env-shell 适用场景</h2>
<ol>
<li>需要使用 shell 特性（如管道 |、重定向 &gt;、命令组合 &amp;&amp; 等）。</li>
<li>需要执行复杂的 shell 脚本。</li>
<li>需要变量替换、通配符等 shell 功能。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1 分钟 CSS 小技巧让你的 UI 看起来贵 10 倍]]></title>    <link>https://juejin.cn/post/7599634796584108038</link>    <guid>https://juejin.cn/post/7599634796584108038</guid>    <pubDate>2026-01-27T10:28:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599634796584108038" data-draft-id="7599591405313327145" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1 分钟 CSS 小技巧让你的 UI 看起来贵 10 倍"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-27T10:28:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1 分钟 CSS 小技巧让你的 UI 看起来贵 10 倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:28:00.000Z" title="Tue Jan 27 2026 10:28:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>为什么同样是按钮，有的看起来高档大气，有的却显得廉价劣质？</p>
<p>秘诀就在于<strong>层次感</strong>。</p>
<p>就像 3D 电影比 2D 电影更有沉浸感一样，有深度的界面比扁平的界面更能抓住用户的注意力。</p>
<p>扁平的化界面就像一张平铺的纸，而有层次的界面就像立体的雕塑，自然显得更高级。</p>
<h2 data-id="heading-0">核心秘诀</h2>
<p>苹果的产品为什么看起来那么高级？</p>
<p>其实原理很简单——就像化妆一样，<strong>层次感来自多重叠加</strong>。</p>
<p>回忆一下女朋友化妆的步骤：</p>
<ol>
<li><strong>第一层</strong>：浅色打底（提亮）</li>
<li><strong>第二层</strong>：深色阴影（立体感）</li>
</ol>
<p>界面设计也是同理：</p>
<ul>
<li><strong>第一层阴影</strong>：让元素“浮起来”</li>
<li><strong>第二层阴影</strong>：让元素“站得住”</li>
</ul>
<p>就这么简单！但效果却能让你惊叹。</p>
<p>现在让我们看些实际的例子。</p>
<h2 data-id="heading-1">应用场景</h2>
<h3 data-id="heading-2">1. 鼠标悬停</h3>
<p>CSS 代码很简单：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--shade);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.5</span>), <span class="hljs-comment">/* top glow */</span> <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.12</span>); <span class="hljs-comment">/* bottom drop */</span>
}
</code></pre>
<p>鼠标悬停时：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.5</span>), <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.16</span>);
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>);
}
</code></pre>
<p>使用效果如下：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71f0dc7c7d084fcfab3bee5670fc5b98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114499&amp;x-signature=3UWkVkWP1EHy%2BSVW0iF%2Fuiwo5xw%3D" alt="" loading="lazy"/></p>
<p>这种轻微的悬停提升效果能让用户界面感觉响应迅速且高端，而无需使用动画库。</p>
<h3 data-id="heading-3">激活标签</h3>
<p>当前激活的标签页看起来应该比其他标签页位置更高。</p>
<p>代码如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.tab</span><span class="hljs-selector-class">.active</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--shade);
  <span class="hljs-attribute">box-shadow</span>: inset <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.4</span>), <span class="hljs-number">0</span> <span class="hljs-number">3px</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.12</span>);
}
</code></pre>
<p>使用效果如下：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/596a81f6e1c3400eac1ee0c7d2633ac1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114499&amp;x-signature=M8f2vgyZ7ULW6JpsziDAfWgVhEw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">结论</h2>
<p>我以前认为，优秀的 UI 需要复杂的渐变、自定义图标或大规模的重新设计。</p>
<p>事实证明，优秀设计很大程度上来自于细微的、有意设计的深度细节。</p>
<p>颜色图层 + 柔和阴影 = 廉价 UI → 高级 UI</p>
<p>现在就去试试吧！花 1 分钟，你就能让界面看起来贵 10 倍。</p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong>，每天分享前端知识、AI 干货。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[langChain——Demo演示]]></title>    <link>https://juejin.cn/post/7599835610406076462</link>    <guid>https://juejin.cn/post/7599835610406076462</guid>    <pubDate>2026-01-27T10:19:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599835610406076462" data-draft-id="7594351060615233555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="langChain——Demo演示"/> <meta itemprop="keywords" content="LangChain,LLM,Python"/> <meta itemprop="datePublished" content="2026-01-27T10:19:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="寻找光_sxy"/> <meta itemprop="url" content="https://juejin.cn/user/1495754537711661"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            langChain——Demo演示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1495754537711661/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    寻找光_sxy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:19:23.000Z" title="Tue Jan 27 2026 10:19:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>上上文章介绍了<code>LangChain</code>的概念与其模块组成——<a href="https://juejin.cn/post/7594358540048810019" target="_blank" title="https://juejin.cn/post/7594358540048810019">一文助你了解Langchain</a>，本篇文章基于上上篇文章的基本概念，来实际开发一下，基于<code>LacngChain</code>搭建一个<code>Agent</code></p>
<h2 data-id="heading-1">项目</h2>
<h3 data-id="heading-2">项目介绍</h3>
<p>本项目包含3大模块：</p>
<ul>
<li><strong><code>Agent</code> 和工具调用</strong>：演示如何创建能够使用工具的智能 <code>Agent</code></li>
<li><strong>文档处理和向量存储</strong>：展示如何加载、处理文档并构建向量数据库</li>
<li><strong>检索增强生成（<code>RAG</code>）</strong>：实现基于文档的智能问答系统</li>
</ul>
<h3 data-id="heading-3">项目结构</h3>
<pre><code class="hljs language-py" lang="py">LangChainDemo2/
├── main.py                    <span class="hljs-comment"># Agent 演示主程序</span>
├── document_vector_demo.py    <span class="hljs-comment"># 文档处理和 RAG 演示</span>
├── requirements.txt           <span class="hljs-comment"># 项目依赖</span>
├── .env                       <span class="hljs-comment"># 环境变量配置（需自行创建）</span>
├── documents/                 <span class="hljs-comment"># 文档存储目录</span>
│   ├── langchain_intro.txt
│   └── python_basics.txt
├── tools/                     <span class="hljs-comment"># 工具模块</span>
│   ├── __init__.py
│   ├── math_tools.py          <span class="hljs-comment"># 数学工具</span>
│   └── time_tools.py          <span class="hljs-comment"># 时间工具</span>
└── chroma_db_langchain/       <span class="hljs-comment"># 向量数据库存储目录（自动生成）</span>
</code></pre>
<h3 data-id="heading-4">环境要求</h3>
<ul>
<li><code>Python 3.8</code> 或更高版本</li>
<li><code>pip</code> 包管理器</li>
</ul>
<h2 data-id="heading-5">搭建步骤</h2>
<h4 data-id="heading-6">1. 创建项目目录</h4>
<p>首先，创建项目目录并进入：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> LangChainDemo2
<span class="hljs-built_in">cd</span> LangChainDemo2
</code></pre>
<h4 data-id="heading-7">2. 创建虚拟环境（推荐）</h4>
<p>使用虚拟环境可以隔离项目依赖，避免与其他项目冲突：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建虚拟环境</span>
python -m venv venv

<span class="hljs-comment"># 激活虚拟环境</span>
<span class="hljs-comment"># macOS/Linux:</span>
<span class="hljs-built_in">source</span> venv/bin/activate
<span class="hljs-comment"># Windows:</span>
<span class="hljs-comment"># venv\Scripts\activate</span>
</code></pre>
<h4 data-id="heading-8">3. 安装项目依赖</h4>
<p>项目依赖已定义在 <code>requirements.txt</code> 文件中，包含以下主要包：</p>
<ul>
<li><code>langchain</code>：LangChain 核心框架</li>
<li><code>langchain-community</code>：社区贡献的组件</li>
<li><code>langchain-openai</code>：OpenAI 兼容的模型接口</li>
<li><code>langchain-core</code>：LangChain 核心功能</li>
<li><code>python-dotenv</code>：环境变量管理</li>
<li><code>chromadb</code>：向量数据库</li>
<li><code>dashscope</code>：阿里云 DashScope API（用于嵌入模型）</li>
</ul>
<p>安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pip install -r requirements.txt
</code></pre>
<h4 data-id="heading-9">4. 配置环境变量</h4>
<p>在项目根目录创建 <code>.env</code> 文件，配置 API 密钥：</p>
<pre><code class="hljs language-env" lang="env"># 阿里云 DashScope API Key
DASHSCOPE_API_KEY=your_api_key_here
</code></pre>
<p><strong>获取 API Key 的方法：</strong></p>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdashscope.console.aliyun.com%2F" target="_blank" title="https://dashscope.console.aliyun.com/" ref="nofollow noopener noreferrer">阿里云 DashScope 控制台</a></li>
<li>注册/登录账号</li>
<li>创建 API Key</li>
<li>将 API Key 复制到 <code>.env</code> 文件中</li>
</ol>
<h4 data-id="heading-10">5. 创建项目目录结构</h4>
<p>创建必要的目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建文档目录</span>
<span class="hljs-built_in">mkdir</span> documents

<span class="hljs-comment"># 创建工具目录</span>
<span class="hljs-built_in">mkdir</span> tools
</code></pre>
<h4 data-id="heading-11">6. 创建工具模块</h4>
<h5 data-id="heading-12">6.1 创建 <code>tools/__init__.py</code></h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># tools/__init__.py</span>
<span class="hljs-comment"># 工具模块初始化文件</span>
</code></pre>
<h5 data-id="heading-13">6.2 创建 <code>tools/math_tools.py</code></h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
数学工具模块
用于执行数学运算
"""</span>

<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool


<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""
    计算两个整数的和。
    Agent 会在需要进行加法运算时自动调用此工具。

    Args:
        a: 第一个整数
        b: 第二个整数

    Returns:
        两个整数的和
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 处理字符串类型的输入（Agent 可能传递字符串格式的数字）</span>
        a = <span class="hljs-built_in">int</span>(a) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(a, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> a
        b = <span class="hljs-built_in">int</span>(b) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(b, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> b
        <span class="hljs-keyword">return</span> a + b
    <span class="hljs-keyword">except</span> (ValueError, TypeError) <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"计算时发生错误: 无法将输入转换为整数 - <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"计算时发生错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
</code></pre>
<h5 data-id="heading-14">6.3 创建 <code>tools/time_tools.py</code></h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
时间工具模块
用于获取当前日期和时间
"""</span>

<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool


<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_current_time</span>() -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    获取当前时间。
    Agent 会在需要获取当前时间时自动调用此工具。

    Returns:
        当前时间（格式为 HH:MM:SS）
    """</span>
    <span class="hljs-keyword">return</span> datetime.now().strftime(<span class="hljs-string">"%H:%M:%S"</span>)
</code></pre>
<h4 data-id="heading-15">7. 创建主程序文件</h4>
<h5 data-id="heading-16">7.1 创建 <code>main.py</code>（Agent 演示）</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_react_agent, AgentExecutor
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate

<span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory
<span class="hljs-keyword">from</span> tools.math_tools <span class="hljs-keyword">import</span> add
<span class="hljs-keyword">from</span> tools.time_tools <span class="hljs-keyword">import</span> get_current_time

<span class="hljs-comment"># 加载环境变量</span>
load_dotenv()


<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_llm</span>():  <span class="hljs-comment"># 创建 LLM 模型实例</span>
    api_key = os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)  <span class="hljs-comment"># 从环境变量中获取 API 密钥</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api_key:  <span class="hljs-comment"># 如果 API 密钥未设置，则抛出错误</span>
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"DASHSCOPE_API_KEY 环境变量未设置"</span>)

    llm = ChatOpenAI(
        model=<span class="hljs-string">"qwen-plus"</span>,
        api_key=api_key,
        base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,  <span class="hljs-comment"># 阿里云 DashScope API 的兼容模式 URL</span>
        temperature=<span class="hljs-number">0.7</span>,  <span class="hljs-comment"># 用于控制生成文本的随机性</span>
    )
    <span class="hljs-keyword">return</span> llm


<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_tools</span>():  <span class="hljs-comment"># 创建工具列表</span>
    tools = [add, get_current_time]
    <span class="hljs-keyword">return</span> tools


<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_memory</span>():  <span class="hljs-comment"># 创建记忆模块</span>
    memory = ConversationBufferMemory(
        memory_key=<span class="hljs-string">"chat_history"</span>,  <span class="hljs-comment"># 在 prompt 中使用的变量名</span>
        return_messages=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 返回字符串格式，适合字符串模板</span>
    )
    <span class="hljs-keyword">return</span> memory


<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_agent_executor</span>(<span class="hljs-params">llm, tools, memory</span>):  <span class="hljs-comment"># 创建Agent执行器</span>
    prompt_template = <span class="hljs-string">"""你是一个友好的 AI 助手。你可以使用工具来回答问题。
    你可以使用的工具：
    {tools}

    使用以下格式：
    Question: 需要回答的问题
    Thought: 你应该思考要做什么
    Action: 要采取的行动，应该是 [{tool_names}] 中的一个
    Action Input: 行动的输入
    Observation: 行动的结果
    ... (这个 Thought/Action/Action Input/Observation 可以重复 N 次)
    Thought: 我现在知道最终答案了
    Final Answer: 对原始问题的最终答案

    {chat_history}

    Question: {input}
    Thought: {agent_scratchpad}"""</span>
    prompt = PromptTemplate.from_template(prompt_template)  <span class="hljs-comment"># 创建提示模板</span>

    agent = create_react_agent(llm=llm, tools=tools, prompt=prompt)  <span class="hljs-comment"># 创建Agent</span>

    agent_executor = AgentExecutor(
        agent=agent,  <span class="hljs-comment"># Agent实例</span>
        tools=tools,  <span class="hljs-comment"># 工具列表</span>
        memory=memory,  <span class="hljs-comment"># 记忆模块</span>
        verbose=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 是否打印详细信息</span>
        handle_parsing_errors=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 处理解析错误</span>
        max_iterations=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 最大迭代次数</span>
    )
    <span class="hljs-keyword">return</span> agent_executor


<span class="hljs-comment"># 创建主函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">try</span>:
        llm = create_llm()  <span class="hljs-comment"># 创建 LLM 模型实例</span>
        tools = create_tools()  <span class="hljs-comment"># 创建工具列表</span>
        memory = create_memory()  <span class="hljs-comment"># 创建记忆模块</span>
        agent_executor = create_agent_executor(llm, tools, memory)  <span class="hljs-comment"># 创建Agent执行器</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:  <span class="hljs-comment"># 循环输入问题</span>
            prompt = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入问题："</span>)
            <span class="hljs-keyword">if</span> prompt.lower() <span class="hljs-keyword">in</span> [<span class="hljs-string">"exit"</span>, <span class="hljs-string">"quit"</span>, <span class="hljs-string">"退出"</span>]:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n再见！"</span>)
                <span class="hljs-keyword">break</span>

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> prompt.strip():
                <span class="hljs-keyword">continue</span>
            response = agent_executor.invoke({<span class="hljs-string">"input"</span>: prompt})  <span class="hljs-comment"># 执行Agent</span>
            <span class="hljs-built_in">print</span>(response[<span class="hljs-string">"output"</span>])  <span class="hljs-comment"># 打印响应</span>
    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:  <span class="hljs-comment"># 如果创建 LLM 模型实例失败，则抛出错误</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"创建 LLM 模型实例失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span>


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h5 data-id="heading-17">7.2 创建 <code>document_vector_demo.py</code>（文档处理和 RAG 演示）</h5>
<p>该文件包含文档处理、向量存储和 RAG 的完整实现，代码较长，请参考项目中的 <code>document_vector_demo.py</code> 文件。</p>
<h4 data-id="heading-18">8. 创建示例文档（可选）</h4>
<p>项目会自动创建示例文档，但您也可以手动创建：</p>
<h5 data-id="heading-19"><code>documents/langchain_intro.txt</code></h5>
<pre><code class="hljs language-markdown" lang="markdown">LangChain 简介

LangChain 是一个用于构建 LLM 应用的框架。

核心概念：
<span class="hljs-bullet">1.</span> Chains（链）：将多个组件连接起来
<span class="hljs-bullet">2.</span> Agents（代理）：能够自主决策和执行任务
<span class="hljs-bullet">3.</span> Memory（记忆）：维护对话历史
<span class="hljs-bullet">4.</span> Tools（工具）：扩展 LLM 的能力
<span class="hljs-bullet">5.</span> Document Processing（文档处理）：加载和预处理文档
<span class="hljs-bullet">6.</span> Vector Stores（向量存储）：存储和检索文档向量

主要功能：
<span class="hljs-bullet">-</span> 文档加载和预处理
<span class="hljs-bullet">-</span> 向量数据库集成
<span class="hljs-bullet">-</span> 检索增强生成（RAG）
<span class="hljs-bullet">-</span> 工具调用和 Agent 构建

使用场景：
<span class="hljs-bullet">-</span> 构建智能问答系统
<span class="hljs-bullet">-</span> 文档检索和分析
<span class="hljs-bullet">-</span> 自动化任务处理
<span class="hljs-bullet">-</span> 知识库构建
</code></pre>
<h5 data-id="heading-20"><code>documents/python_basics.txt</code></h5>
<pre><code class="hljs language-markdown" lang="markdown">Python 基础语法

Python 是一种高级编程语言，具有简洁明了的语法。

变量和数据类型：
<span class="hljs-bullet">-</span> 整数：x = 10
<span class="hljs-bullet">-</span> 浮点数：y = 3.14
<span class="hljs-bullet">-</span> 字符串：name = "Python"
<span class="hljs-bullet">-</span> 列表：numbers = [1, 2, 3]

控制流：
<span class="hljs-bullet">-</span> if/else 语句用于条件判断
<span class="hljs-bullet">-</span> for 循环用于遍历序列
<span class="hljs-bullet">-</span> while 循环用于重复执行

函数定义：
def greet(name):
<span class="hljs-code">    return f"Hello, {name}!"
</span>
Python 的特点：
<span class="hljs-bullet">-</span> 语法简洁，易于学习
<span class="hljs-bullet">-</span> 丰富的标准库和第三方库
<span class="hljs-bullet">-</span> 跨平台支持
<span class="hljs-bullet">-</span> 广泛用于 Web 开发、数据科学、人工智能等领域
</code></pre>
<h3 data-id="heading-21">运行项目</h3>
<h4 data-id="heading-22">运行 Agent 演示</h4>
<pre><code class="hljs language-bash" lang="bash">python main.py
</code></pre>
<p>运行后，您可以与 Agent 进行交互，例如：</p>
<ul>
<li>"计算 123 加 456"</li>
<li>"现在几点了？"</li>
<li>"先计算 10 加 20，然后告诉我现在的时间"</li>
</ul>
<h4 data-id="heading-23">运行文档处理和 RAG 演示</h4>
<pre><code class="hljs language-bash" lang="bash">python document_vector_demo.py
</code></pre>
<p>该程序会：</p>
<ol>
<li>自动创建示例文档</li>
<li>加载并分割文档</li>
<li>创建向量数据库</li>
<li>演示相似度搜索</li>
<li>演示 RAG 问答</li>
</ol>
<h3 data-id="heading-24">核心功能说明</h3>
<h4 data-id="heading-25">1. Agent 和工具调用</h4>
<ul>
<li><strong>LLM 模型</strong>：使用阿里云 DashScope 的 qwen-plus 模型</li>
<li><strong>工具系统</strong>：通过 <code>@tool</code> 装饰器定义工具，Agent 可以自动调用</li>
<li><strong>记忆模块</strong>：使用 <code>ConversationBufferMemory</code> 维护对话历史</li>
<li><strong>ReAct Agent</strong>：使用 ReAct 模式，让 Agent 能够思考、行动和观察</li>
</ul>
<h4 data-id="heading-26">2. 文档处理</h4>
<ul>
<li><strong>文档加载</strong>：使用 <code>TextLoader</code> 加载文本文件</li>
<li><strong>文本分割</strong>：使用 <code>RecursiveCharacterTextSplitter</code> 将长文档分割成小块</li>
<li><strong>参数配置</strong>：
<ul>
<li><code>chunk_size=200</code>：每个片段的最大字符数</li>
<li><code>chunk_overlap=50</code>：片段之间的重叠字符数</li>
</ul>
</li>
</ul>
<h4 data-id="heading-27">3. 向量存储</h4>
<ul>
<li><strong>向量数据库</strong>：使用 ChromaDB 存储文档向量</li>
<li><strong>嵌入模型</strong>：使用阿里云 DashScope 的 text-embedding-v2 模型</li>
<li><strong>持久化存储</strong>：向量数据库会保存到 <code>chroma_db_langchain/</code> 目录</li>
</ul>
<h4 data-id="heading-28">4. RAG（检索增强生成）</h4>
<ul>
<li><strong>检索器</strong>：从向量数据库中检索相关文档片段</li>
<li><strong>上下文构建</strong>：将检索到的文档片段组合成上下文</li>
<li><strong>提示模板</strong>：自定义提示词，指导 LLM 基于上下文回答问题</li>
</ul>
<h3 data-id="heading-29">常见问题</h3>
<h4 data-id="heading-30">1. API Key 配置错误</h4>
<p><strong>问题</strong>：提示 "DASHSCOPE_API_KEY 环境变量未设置"</p>
<p><strong>解决</strong>：</p>
<ul>
<li>检查 <code>.env</code> 文件是否存在</li>
<li>确认 API Key 配置正确</li>
<li>确保 <code>.env</code> 文件在项目根目录</li>
</ul>
<h4 data-id="heading-31">2. 依赖安装失败</h4>
<p><strong>问题</strong>：<code>pip install</code> 失败</p>
<p><strong>解决</strong>：</p>
<ul>
<li>确保 Python 版本 &gt;= 3.8</li>
<li>尝试升级 pip：<code>pip install --upgrade pip</code></li>
<li>使用国内镜像源：<code>pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple</code></li>
</ul>
<h4 data-id="heading-32">3. 向量数据库创建失败</h4>
<p><strong>问题</strong>：ChromaDB 初始化错误</p>
<p><strong>解决</strong>：</p>
<ul>
<li>确保有写入权限</li>
<li>删除旧的 <code>chroma_db_langchain/</code> 目录后重新运行</li>
</ul>
<h3 data-id="heading-33">扩展建议</h3>
<ol>
<li><strong>添加更多工具</strong>：在 <code>tools/</code> 目录下创建新的工具模块</li>
<li><strong>支持更多文档格式</strong>：添加 PDF、Word 等文档加载器</li>
<li><strong>优化 RAG 提示词</strong>：根据实际需求调整提示模板</li>
<li><strong>添加 Web 界面</strong>：使用 Streamlit 或 Gradio 创建交互界面</li>
<li><strong>集成更多向量数据库</strong>：尝试 FAISS、Pinecone 等</li>
</ol>
<h3 data-id="heading-34">总结</h3>
<p>通过本项目的搭建，您可以学习到：</p>
<ul>
<li>✅ LangChain 框架的基本使用</li>
<li>✅ Agent 和工具系统的构建</li>
<li>✅ 文档处理和向量存储的实现</li>
<li>✅ RAG 系统的搭建</li>
<li>✅ 与 LLM API 的集成</li>
</ul>
<p>希望这个项目能帮助您更好地理解和应用 LangChain 框架！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[将webview展示到vscode的视图容器中]]></title>    <link>https://juejin.cn/post/7599798118461505545</link>    <guid>https://juejin.cn/post/7599798118461505545</guid>    <pubDate>2026-01-27T10:14:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599798118461505545" data-draft-id="7599630795805425710" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="将webview展示到vscode的视图容器中"/> <meta itemprop="keywords" content="Visual Studio Code"/> <meta itemprop="datePublished" content="2026-01-27T10:14:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若愚79"/> <meta itemprop="url" content="https://juejin.cn/user/2649162517852320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            将webview展示到vscode的视图容器中
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2649162517852320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若愚79
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:14:05.000Z" title="Tue Jan 27 2026 10:14:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">将webview展示到vscode的视图容器中</h2>
<p>大家已经注意到上边的webview是显示在编辑器区域的，而cline的对话界面是作为一个视图显示在单独的视图容器里边的，下边我们将进行改造，将我们的react webview显示在单独的视图容器中。</p>
<p>下边我们将参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fvscode-webview-ui-toolkit-samples%2Ftree%2Fmain%2Fdefault%2Fweather-webview" target="_blank" title="https://github.com/microsoft/vscode-webview-ui-toolkit-samples/tree/main/default/weather-webview" ref="nofollow noopener noreferrer">Weather Webview Sample Extension</a>, 将webview显示在视图中。</p>
<h3 data-id="heading-1">定义视图容器和视图</h3>
<p>在 <strong>package.json</strong> 文件中的 <strong>contributes</strong> 中定义 <strong>viewsContainers</strong> 和 <strong>views</strong> , 文件内容看起来如下</p>
<pre><code class="hljs language-erlang" lang="erlang">  ...
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"./out/extension.js"</span>,
  <span class="hljs-string">"contributes"</span>: {
    <span class="hljs-string">"viewsContainers"</span>: {
      <span class="hljs-string">"activitybar"</span>: [
        {
          <span class="hljs-string">"id"</span>: <span class="hljs-string">"minicline-ActivityBar"</span>,
          <span class="hljs-string">"title"</span>: <span class="hljs-string">"MiniCline"</span>,
          <span class="hljs-string">"icon"</span>: <span class="hljs-string">"assets/icons/icon.svg"</span>
        }
      ]
    },
    <span class="hljs-string">"views"</span>: {
      <span class="hljs-string">"minicline-ActivityBar"</span>: [
        {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"webview"</span>,
          <span class="hljs-string">"id"</span>: <span class="hljs-string">"minicline.SidebarProvider"</span>,
          <span class="hljs-string">"name"</span>: <span class="hljs-string">"MiniCline"</span>
        }
      ]
    },
    <span class="hljs-string">"commands"</span>: [
      {
        <span class="hljs-string">"command"</span>: <span class="hljs-string">"hello-world.showHelloWorld"</span>,
        <span class="hljs-string">"title"</span>: <span class="hljs-string">"Hello World (React + Vite): Show"</span>
      }
    ]
  },
  ...
</code></pre>
<p>从cline项目中拷贝 <strong>icon.svg</strong> 到 <strong>assets/icons/</strong> 目录下，再次启动插件，侧边栏将出现新的minicline的视图容器，点击图标将显示minicline视图，当然，现在我们还没有实现新的webview，所以显示不了任何内容，如下图所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/777471b6f5de4a83825ec5562fdf4871~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5oSaNzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770113649&amp;x-signature=pA%2FNRaT8ropYLiXIScVzVD%2BxoUc%3D" alt="chapter-2-1.png" loading="lazy"/></p>
<h3 data-id="heading-2">实现WebviewViewProvider</h3>
<p>因为现在我们的webview实现为视图容器里边的视图，所以我们需要实现WebviewViewProvider，并且在插件启动时注册该WebviewViewProvider。
我们将 <strong>weather-webview</strong> 项目中的 <strong>src/providers/WeatherViewProvider.ts</strong> 拷贝到我们 <strong>minicline</strong> 对应目录下，并且在修改插件入口函数调用它。</p>
<p><strong>src/extension.ts</strong></p>
<pre><code class="hljs language-ini" lang="ini">  const <span class="hljs-attr">provider</span> = new WeatherViewProvider(context.extensionUri)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">weatherViewDisposable</span> = window.registerWebviewViewProvider(
    WeatherViewProvider.viewType,
    provider
  )<span class="hljs-comment">;</span>

  context.subscriptions.push(weatherViewDisposable)<span class="hljs-comment">;</span>
</code></pre>
<p>然后我们把原先<strong>src/panels/HelloWorldPanel.ts</strong>中对应的函数    <strong>_getWebviewContent</strong> 和 <strong>_setWebviewMessageListener</strong> 的内容替换 <strong>src/providers/WeatherViewProvider.ts</strong> 对应函数内容。这样我们的视图就会显示我们react编译的webview内容了。现在启动插件，应该看到如下图所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4e17dc1378e48f7bae50f1e50235b0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5oSaNzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770113649&amp;x-signature=ZHiXC%2FBCPRW3In7cpjRjhJvnpJQ%3D" alt="chapter-2-2.png" loading="lazy"/></p>
<p>下边我们把 <strong>weather-webview</strong> 里一些有用的组件添加到我们的react webview中，比如vscode-text-field，vscode-dropdown等。后边我们的chat box会用到。</p>
<p>将原 <strong>src/providers/WeatherViewProvider.ts</strong> 中函数 <strong>_getWebviewContent</strong> 的如下内容拷贝到 <strong>webview-ui/src/App.tsx</strong> 中，需要注意的是，在 <strong>@vscode/webview-ui-toolkit/react</strong> 中对应的react组件名字不是 <strong>vscode-button</strong> 而是 <strong>VSCodeButton</strong>，其他组件名字也需要对应改动，具体可以到 <strong>@vscode/webview-ui-toolkit/react</strong>中查看。然后在react中class需要替换成className。</p>
<p><strong>src/providers/WeatherViewProvider.ts</strong></p>
<pre><code class="hljs language-ini" lang="ini">&lt;h1&gt;Weather Checker&lt;/h1&gt;
&lt;section <span class="hljs-attr">id</span>=<span class="hljs-string">"search-container"</span>&gt;
  &lt;vscode-text-field
    <span class="hljs-attr">id</span>=<span class="hljs-string">"location"</span>
    <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"Location"</span>
    <span class="hljs-attr">value</span>=<span class="hljs-string">"Seattle, WA"</span>&gt;
  &lt;/vscode-text-field&gt;
  &lt;vscode-dropdown <span class="hljs-attr">id</span>=<span class="hljs-string">"unit"</span>&gt;
    &lt;vscode-option <span class="hljs-attr">value</span>=<span class="hljs-string">"F"</span>&gt;Fahrenheit&lt;/vscode-option&gt;
    &lt;vscode-option <span class="hljs-attr">value</span>=<span class="hljs-string">"C"</span>&gt;Celsius&lt;/vscode-option&gt;
  &lt;/vscode-dropdown&gt;
&lt;/section&gt;
&lt;vscode-button <span class="hljs-attr">id</span>=<span class="hljs-string">"check-weather-button"</span>&gt;Check&lt;/vscode-button&gt;
&lt;h2&gt;Current Weather&lt;/h2&gt;
&lt;section <span class="hljs-attr">id</span>=<span class="hljs-string">"results-container"</span>&gt;
  &lt;vscode-progress-ring <span class="hljs-attr">id</span>=<span class="hljs-string">"loading"</span> class=<span class="hljs-string">"hidden"</span>&gt;&lt;/vscode-progress-ring&gt;
  &lt;p <span class="hljs-attr">id</span>=<span class="hljs-string">"icon"</span>&gt;&lt;/p&gt;
  &lt;p <span class="hljs-attr">id</span>=<span class="hljs-string">"summary"</span>&gt;&lt;/p&gt;
&lt;/section&gt;
</code></pre>
<p><strong>webview-ui/src/App.tsx</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  ...
  <span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Weather Checker<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"search-container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">VSCodeTextField</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"location"</span>
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"Location"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">"Seattle, WA"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeTextField</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">VSCodeDropdown</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"unit"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">VSCodeOption</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"F"</span>&gt;</span>Fahrenheit<span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeOption</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">VSCodeOption</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"C"</span>&gt;</span>Celsius<span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeOption</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeDropdown</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">VSCodeButton</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"check-weather-button"</span>&gt;</span>Check<span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeButton</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Current Weather<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"results-container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">VSCodeProgressRing</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"loading"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"hidden"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeProgressRing</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"icon"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"summary"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>
  ); 
}
</code></pre>
<p>拷贝对应的 <strong>weather-webview/src/webview/styles.css</strong> 的内容到 <strong>webview-ui/src/App.css</strong> 中。</p>
<p>别忘了在启动插件前重新运行 <strong>npm run build:webview</strong> 编译我们的react webview。</p>
<p>启动插件，现在视图看起来如下所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1ed6ae337474b1196fb220e596c544b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5oSaNzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770113649&amp;x-signature=2KntSgSx3cCWqs%2B%2FM0ijEvckWww%3D" alt="chapter-2-3.png" loading="lazy"/></p>
<p>接下来我们需要把 <strong>weather-webview/src/webview/main.ts</strong> 中的代码迁移到react webview中。</p>
<p>关键代码如下</p>
<p>在webview端，当点击 <strong>Check</strong> 按钮时会向vscode extension host发送当前位置信息，请求天气情况信息。并且使用react的useEffect函数在App启动时注册监听器，监听vscode extension host端发送的天气消息。</p>
<p><strong>webview-ui/src/App.tsx</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  ...
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {

    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"message"</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> command = event.<span class="hljs-property">data</span>.<span class="hljs-property">command</span>;
      <span class="hljs-keyword">switch</span> (command) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"weather"</span>:
          <span class="hljs-keyword">const</span> weatherData = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">payload</span>);
          <span class="hljs-title function_">displayWeatherData</span>(weatherData);
          <span class="hljs-keyword">break</span>;
          ...
      }
    });
  }, []);
  ...
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkWeather</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> location = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"location"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">TextField</span>;
    <span class="hljs-keyword">const</span> unit = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"unit"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Dropdown</span>;
    vscode.<span class="hljs-title function_">postMessage</span>({
      <span class="hljs-attr">command</span>: <span class="hljs-string">"weather"</span>,
      <span class="hljs-attr">location</span>: location.<span class="hljs-property">value</span>,
      <span class="hljs-attr">unit</span>: unit.<span class="hljs-property">value</span>,
    });
    <span class="hljs-title function_">displayLoadingState</span>();
  }
  ...
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Weather Checker<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      ...
      <span class="hljs-tag">&lt;<span class="hljs-name">VSCodeButton</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"check-weather-button"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{checkWeather}</span>&gt;</span>Check<span class="hljs-tag">&lt;/<span class="hljs-name">VSCodeButton</span>&gt;</span>
      ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>
  );
}
</code></pre>
<p>在vscode extension host端，修改<strong>WeatherViewProvider</strong>监听的消息类型，当消息类型为天气情况时，调用weather库获取实际天气信息发送给webview端。</p>
<p><strong>src/providers/WeatherViewProvider.ts</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">_setWebviewMessageListener</span>(<span class="hljs-params">webviewView: WebviewView</span>) {
  webviewView.<span class="hljs-property">webview</span>.<span class="hljs-title function_">onDidReceiveMessage</span>(
    <span class="hljs-function">(<span class="hljs-params">message: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
      ...
      <span class="hljs-keyword">switch</span> (command) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"weather"</span>:
          weather.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">search</span>: location, <span class="hljs-attr">degreeType</span>: unit }, <span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">any</span>, result: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
            ...
            <span class="hljs-keyword">const</span> weatherForecast = result[<span class="hljs-number">0</span>];
            <span class="hljs-comment">// Pass the weather forecast object to the webview</span>
            webviewView.<span class="hljs-property">webview</span>.<span class="hljs-title function_">postMessage</span>({
              <span class="hljs-attr">command</span>: <span class="hljs-string">"weather"</span>,
              <span class="hljs-attr">payload</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(weatherForecast),
            });
          });
          <span class="hljs-keyword">break</span>;
      }
    },
    ...
  );
}
</code></pre>
<p>现在我们启动插件项目，点击 <strong>Check</strong> 按钮后会更新天气情况，如下图所示，别忘了启动前运行 <strong>npm run build:webview</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/579ff183dbbc4afc841de5a97bf5b022~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5oSaNzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770113649&amp;x-signature=7G9whU%2BPFi6OvX%2FkNC8xNw6X4sE%3D" alt="chapter-2-4.png" loading="lazy"/></p>
<h3 data-id="heading-3">总结</h3>
<p>本章我们新建了视图容器，并且将webview移到了视图容器中的一个视图中。我们添加了新的vscode webview-ui-toolkit的一些react组件。并且实现了webview和vscode extension host之间的双向消息发送和监听。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手带你做一个 Claude Code plugin 插件（新手必看 ）]]></title>    <link>https://juejin.cn/post/7599630795805655086</link>    <guid>https://juejin.cn/post/7599630795805655086</guid>    <pubDate>2026-01-27T10:29:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599630795805655086" data-draft-id="7599798118461571081" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手带你做一个 Claude Code plugin 插件（新手必看 ）"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-27T10:29:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="和平hepingfly"/> <meta itemprop="url" content="https://juejin.cn/user/4100516930912747"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手带你做一个 Claude Code plugin 插件（新手必看 ）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100516930912747/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    和平hepingfly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:29:22.000Z" title="Tue Jan 27 2026 10:29:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用过 claude code 的人应该都知道，claude code 除了是一个非常强大的 Agent 之外，它还有好几个组件来扩展自身的能力，比如</p>
<ul>
<li>Skills（技能）</li>
<li>subagents(子代理)</li>
<li>Hooks（钩子）</li>
<li>MCP 服务器</li>
<li>Commands（命令）</li>
</ul>
<p>这些扩展能力单个拎出来都很强大，而 Claude Code Plugin 又可以把上面的东西组合起来使用，更加全方位的去扩展 Claude Code 的功能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8124fafe32584b0f9880e23a67652435~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114561&amp;x-signature=Smdp97wXwNVxbsLxpQCoCS6oeFU%3D" alt="img" loading="lazy"/></p>
<h2 data-id="heading-0">1、开发插件实操演示</h2>
<h3 data-id="heading-1">1.1 创建插件目录</h3>
<p>每个插件都有一个自己独立的目录，在这个目录里面可以去放插件配置文件、相应的技能、代理或钩子</p>
<p>BASH</p>
<pre><code class="hljs language-arduino" lang="arduino">mkdir hepingfly-plugin
</code></pre>
<h3 data-id="heading-2">1.2 创建插件配置文件</h3>
<p>配置文件要放在<code> .claude-plugin</code> 这个文件夹下面，所以我们先来创建这个文件夹（要在刚才的插件目录里面去创建）</p>
<p>可以使用下面的命令，也可以自己手动新建文件夹。</p>
<p>BASH</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> hepingfly-plugin/.claude-plugin
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c48117e31ed4a60b3db227a5a848284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114561&amp;x-signature=8DKC1j2iHg77ftvSNYJ3g1ZKJ6s%3D" alt="img" loading="lazy"/></p>
<p>新建<code> plugin.json</code> 配置文件， <code>hepingfly-plugin/.claude-plugin/plugin.json</code></p>
<p>这个配置文件用于定义插件的基本信息，包括名称、描述和版本号。</p>
<p>claude code 会利用这些元数据，在插件管理器中展示您的插件。</p>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hepingfly-plugin"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"会打印 hello hepingfly"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hepingfly"</span>
<span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>

























<table><thead><tr><th>字段</th><th>用途</th></tr></thead><tbody><tr><td>name</td><td>唯一标识符和斜杠命令命名空间。斜杠命令以此为前缀（例如 /hepingfly-plugin:hello）。</td></tr><tr><td>description</td><td>在浏览或安装插件时在插件管理器中显示。</td></tr><tr><td>version</td><td>使用语义版本控制跟踪发布。</td></tr><tr><td>author</td><td>作者名字（可选）。有助于归属。</td></tr></tbody></table>
<h3 data-id="heading-3">1.3 开发插件功能</h3>
<p>上面几步我们把插件基本的配置做好了，下面我们就要开发这个插件具体的功能了。你可以使用 skill、subagent、command、hooks 都可以。</p>
<p><strong>我们以 command 能力来演示：</strong></p>
<p>在你的插件文件夹中创建 <code>commands</code> 目录：</p>
<p>BASH</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> hepingfly-plugin/commands
</code></pre>
<p>然后我们创建一个 hello.md ，功能非常简单，我们让它打印一句「hepingfly 你好，2026 一路发发发」</p>
<p><code>hepingfly-plugin/commands/hello.md</code>：</p>
<p>PLAIN</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">打印</span> <span class="hljs-string">hello</span> <span class="hljs-string">hepingfly</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">说，hepingfly</span> <span class="hljs-string">你好，2026</span> <span class="hljs-string">一路发发发</span>
</code></pre>
<p><strong>测试插件是否能正常执行？</strong></p>
<p>使用下面这条命令去指定 Claude Code 加载插件的位置。</p>
<p>Claude Code 的插件系统需要知道去哪里加载插件。</p>
<p>默认情况下，Claude Code 只会在特定的默认目录中查找插件。</p>
<p>而我们的插件放在项目目录 hepingfly-plugin 中，Claude Code 启动时并不知道这个位置，所以需要显示指定一下</p>
<p>PLAIN</p>
<pre><code class="hljs language-bash" lang="bash">claude --plugin-dir ./hepingfly-plugin
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2e1feb857394eccab9c66537db38412~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114561&amp;x-signature=ziwGyyU6Jb5obadvSY%2BUmpZMHcE%3D" alt="img" loading="lazy"/></p>
<p>Claude Code 启动后，就能够加载出来我们的插件了。敲个斜杠就能联想出我们插件的名字。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3ea7ecc30c34261bd59e863177e7d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114561&amp;x-signature=D1cN04H7bsNsYWDFhNH5kbxtGco%3D" alt="img" loading="lazy"/></p>
<p><strong>执行结果：</strong></p>
<p>跟我们预期的一致，说明我们这个插件就开发成功了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca6ec9d1eea047b2b17b1c9a60a74d99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZKM5bmzaGVwaW5nZmx5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770114561&amp;x-signature=5aPIxsO1ErVzbzDYVxRFgKbBHhI%3D" alt="img" loading="lazy"/></p>
<p>到这里，就完成了第一个入门 Claude 插件，后面你可以继续接 skills / subagent / MCP。</p>
<p>等下一篇再继续分享，有任何问题欢迎在评论区交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[与本地ollama模型对话]]></title>    <link>https://juejin.cn/post/7599630795805605934</link>    <guid>https://juejin.cn/post/7599630795805605934</guid>    <pubDate>2026-01-27T10:18:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599630795805605934" data-draft-id="7599835610405830702" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="与本地ollama模型对话"/> <meta itemprop="keywords" content="Visual Studio Code"/> <meta itemprop="datePublished" content="2026-01-27T10:18:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若愚79"/> <meta itemprop="url" content="https://juejin.cn/user/2649162517852320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            与本地ollama模型对话
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2649162517852320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若愚79
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:18:33.000Z" title="Tue Jan 27 2026 10:18:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">与本地ollama模型对话</h2>
<p>本章我们将完善对话界面，将webview端选中的模型和输入的对话消息发送至extension host端。然后在extension host端调用ollama API与模型进行对话，获取模型返回消息，解析后写入文件。</p>
<h3 data-id="heading-1">定义新的proto</h3>
<p>首先我们将定义一个message.proto，用来描述要发送到extension host端的消息，该模型也用来在webview上显示发送和接收到的消息。</p>
<p><strong>proto/minicline/message.proto</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">syntax</span> = <span class="hljs-string">"proto3"</span><span class="hljs-comment">;</span>

package minicline<span class="hljs-comment">;</span>

message Message {
    string <span class="hljs-attr">content</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    MessageOwn <span class="hljs-attr">owner</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
}

enum MessageOwn {
    <span class="hljs-attr">SYSTEM</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">ASSISTANT</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">USER</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>然后我们定义一个task.proto，其中的newTask调用用来将我们收集到的模型名字和对话消息发送给extension host端。</p>
<p><strong>proto/minicline/task.proto</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">syntax</span> = <span class="hljs-string">"proto3"</span><span class="hljs-comment">;</span>

package minicline<span class="hljs-comment">;</span>

import "minicline/common.proto"<span class="hljs-comment">;</span>

service TaskService {
  rpc newTask(NewTaskRequest) returns (String)<span class="hljs-comment">;</span>
}

message NewTaskRequest {
  string <span class="hljs-attr">model</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  string <span class="hljs-attr">text</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>同样，我们需要导出newTask函数来作为TaskService.newTask的处理函数。这里我们先简单的打印收到model和text信息，然后返回一个虚假的taskID.</p>
<p><strong>src/core/controller/task/newTask.ts</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NewTaskRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/shared/proto/minicline/task"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">".."</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">String</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@shared/proto/minicline/common"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">newTask</span>(<span class="hljs-params">controller: Controller, request: NewTaskRequest</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">String</span>&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(request);
    <span class="hljs-keyword">const</span> taskId = <span class="hljs-string">"fakeTaskId"</span>;
	<span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>.<span class="hljs-title function_">create</span>({ <span class="hljs-attr">value</span>: taskId || <span class="hljs-string">""</span> });
}
</code></pre>
<p>运行<strong>npm run proto</strong>编译。</p>
<h3 data-id="heading-2">更新webview界面</h3>
<p>让我们在webview的中间区域添加消息列表，用来显示我们发送的消息和AI助手返回的消息。</p>
<p><strong>webview-ui/src/App.tsx</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
...
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [selectedModel, setSelectedModel] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-attr">initMessages</span>: <span class="hljs-title class_">Message</span>[] = [<span class="hljs-title class_">Message</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">content</span>: <span class="hljs-string">"你好，我是你的AI编程助手MiniCline"</span>,
    <span class="hljs-attr">owner</span>:<span class="hljs-title class_">MessageOwn</span>.<span class="hljs-property">ASSISTANT</span>
  })];

  <span class="hljs-keyword">const</span> [messages, setMessages] = <span class="hljs-title function_">useState</span>(initMessages);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"top"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ModelBar</span> <span class="hljs-attr">selectedModel</span>=<span class="hljs-string">{selectedModel}</span> <span class="hljs-attr">selectModel</span>=<span class="hljs-string">{setSelectedModel}/</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"center"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Messages</span> <span class="hljs-attr">messages</span>=<span class="hljs-string">{messages}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bottom"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Chatbox</span> 
        <span class="hljs-attr">selectedModel</span>=<span class="hljs-string">{selectedModel}</span>
        <span class="hljs-attr">messages</span>=<span class="hljs-string">{messages}</span>
        <span class="hljs-attr">setMessages</span>=<span class="hljs-string">{setMessages}/</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
...
</code></pre>
<p>我们在主程序初始化选中的模型和消息列表的状态，然后传递给其他组件共享状态。</p>
<p><strong>webview-ui/src/components/message/message.tsx</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">...
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Messages</span>(<span class="hljs-params">{ messages }: { messages: Message[] }</span>) {

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            {messages?.map((message: Message) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{message.owner</span> === <span class="hljs-string">MessageOwn.USER</span> ? "<span class="hljs-attr">message_user</span>" <span class="hljs-attr">:</span> "<span class="hljs-attr">message</span>"}&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"texts"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message.content}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/&gt;</span></span>
    );
}
...
</code></pre>
<p><strong>webview-ui/src/components/models/models.tsx</strong></p>
<pre><code class="hljs language-ini" lang="ini">...
function ModelBar({ selectedModel, selectModel }: { selectedModel: string, selectModel: Function }) {
    ...
    const <span class="hljs-attr">handleListModelsMessage</span> = useCallback(
        async () =&gt; {
            const result: <span class="hljs-attr">StringArray</span> = await OllamaServiceClient.listModels(EmptyRequest.create())<span class="hljs-comment">;</span>
            ...
            selectModel(result.values<span class="hljs-section">[0]</span>)<span class="hljs-comment">;</span>
        }, <span class="hljs-section">[models]</span>
    )<span class="hljs-comment">;</span>
    return (
        ...
                &lt;VSCodeDropdown <span class="hljs-attr">id</span>=<span class="hljs-string">"models"</span> className=<span class="hljs-string">"modellist"</span> <span class="hljs-literal">on</span>Change={(e: any) =&gt; selectModel(e.target._value)}&gt;
        ...
    )<span class="hljs-comment">;</span>
}
...
</code></pre>
<p><strong>webview-ui/src/components/chat/chat.tsx</strong></p>
<pre><code class="hljs language-ini" lang="ini">...
function Chatbox({ selectedModel, messages, setMessages }: { selectedModel: string, messages: Message<span class="hljs-section">[]</span>, setMessages: Function }) {
    const <span class="hljs-section">[taskId, setTaskId]</span> = useState("")<span class="hljs-comment">;</span>
    const <span class="hljs-section">[content, setContent]</span> = useState("")<span class="hljs-comment">;</span>

    const <span class="hljs-attr">handleNewTaskMessage</span> = useCallback(
        async (model: string, text: string) =&gt; {
            const taskId: <span class="hljs-attr">String</span> = await TaskServiceClient.newTask(NewTaskRequest.create({
                model: model,
                text: text
            }))<span class="hljs-comment">;</span>
            setTaskId(taskId.value)<span class="hljs-comment">;</span>
            setMessages(<span class="hljs-section">[...messages, Message.create({
                content: text,
                owner: MessageOwn.USER
            })]</span>)<span class="hljs-comment">;</span>
            setContent("")<span class="hljs-comment">;</span>
        }, <span class="hljs-section">[taskId, messages]</span>
    )<span class="hljs-comment">;</span>

    const <span class="hljs-attr">onSend</span> = () =&gt; {
        handleNewTaskMessage(selectedModel, content)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    return (
        &lt;&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"chat-box"</span>&gt;
                &lt;div&gt;
                    &lt;VSCodeTextArea <span class="hljs-attr">className</span>=<span class="hljs-string">"chatinput"</span>
                        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"say hello"</span>
                        <span class="hljs-attr">value</span>={content}
                        <span class="hljs-attr">onChange</span>={(e: any) =&gt; setContent(e.target._value)}&gt;
                    &lt;/VSCodeTextArea&gt;
                &lt;/div&gt;
                &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"button-container"</span>&gt;
                    &lt;div&gt;
                        &lt;span <span class="hljs-attr">className</span>=<span class="hljs-string">"codicon codicon-send"</span> <span class="hljs-literal">on</span>Click={<span class="hljs-literal">on</span>Send}&gt;&lt;/span&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/&gt;
    )<span class="hljs-comment">;</span>
}
...
</code></pre>
<p>在chatbox中我们将输入的文本和当前选中的模型发送给extension host，记录返回的taskID，然后将消息添加到消息列表中并且清空输入框。</p>
<p>运行<strong>npm run build:webview</strong>重新编译react应用，启动插件项目，确保本地ollama已经启动，输入一些消息点击发送图标，如果一切正常如下图所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/951592374ef14c97a2180a18388e2d3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5oSaNzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770113912&amp;x-signature=gSKNsb5dfm1r9jcHHUQh0h6onJg%3D" alt="chapter-6-1.png" loading="lazy"/></p>
<h3 data-id="heading-3">添加新的第三方库用于与Ollama对话</h3>
<p><strong>package.json</strong></p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"devDependencies"</span>: {
    ...
    <span class="hljs-string">"@types/clone-deep"</span>: <span class="hljs-string">"^4.0.4"</span>,
    ...
  },
  <span class="hljs-string">"dependencies"</span>: {
    ...
    <span class="hljs-string">"@anthropic-ai/sdk"</span>: <span class="hljs-string">"^0.37.0"</span>,
    <span class="hljs-string">"ollama"</span>: <span class="hljs-string">"^0.5.13"</span>,
    <span class="hljs-string">"clone-deep"</span>: <span class="hljs-string">"^4.0.1"</span>,
    ...
  }
}
</code></pre>
<p>我们引入了@anthropic-ai包里边定义好的数据结构，同时引入ollama库用于与本地服务对话。clone-deep用来深度拷贝流式处理过程中的数据。运行<strong>npm run install:all</strong>安装依赖.</p>
<h3 data-id="heading-4">与本地Ollama对话</h3>
<p>我们首先在controller类中添加一个initTask方法，在newTask接收到webview的模型和对话内容后调用该方法开始一个新的任务。开始新任务的代码如下。</p>
<p><strong>src/core/controller/task/index.ts</strong></p>
<pre><code class="hljs language-typescript" lang="typescript">...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {
    ...
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">...</span>) {
        ...
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">api</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OllamaHandler</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>);
    };

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">startTask</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">processedUserContent</span>: <span class="hljs-title class_">Anthropic</span>.<span class="hljs-property">TextBlockParam</span>[] = [
            {
                <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-attr">text</span>: <span class="hljs-string">`&lt;task&gt;\n<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.task}</span>\n&lt;/task&gt;`</span>,
            }
        ];
        processedUserContent.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>,
            <span class="hljs-attr">text</span>: <span class="hljs-title class_">FocusChainPrompts</span>.<span class="hljs-property">recommended</span>,
        });

        <span class="hljs-keyword">const</span> stream = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attemptApiRequest</span>(processedUserContent);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
                <span class="hljs-keyword">switch</span> (chunk.<span class="hljs-property">type</span>) {
                    ...
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"text"</span>: {
                        assistantMessage += chunk.<span class="hljs-property">text</span>;
                        <span class="hljs-variable language_">this</span>.<span class="hljs-property">assistantMessageContent</span> = <span class="hljs-title function_">parseAssistantMessageV2</span>(assistantMessage);
                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">presentAssistantMessage</span>();
                        <span class="hljs-keyword">break</span>;
                    }
                }
            }
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);
        }
        ...
    }

    <span class="hljs-keyword">async</span> *<span class="hljs-title function_">attemptApiRequest</span>(<span class="hljs-attr">processedUserContent</span>: <span class="hljs-title class_">Anthropic</span>.<span class="hljs-property">TextBlockParam</span>[]): <span class="hljs-title class_">ApiStream</span> {
        <span class="hljs-keyword">const</span> systemPrompt = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getSystemPrompt</span>();

        <span class="hljs-keyword">const</span> <span class="hljs-attr">userMessages</span>: <span class="hljs-title class_">Anthropic</span>.<span class="hljs-property">MessageParam</span>[] = [{
            <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-attr">content</span>: processedUserContent
        }];

        <span class="hljs-comment">// Response API requires native tool calls to be enabled</span>
        <span class="hljs-keyword">const</span> stream = <span class="hljs-variable language_">this</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">createMessage</span>(systemPrompt, userMessages);
        <span class="hljs-keyword">const</span> iterator = stream[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">asyncIterator</span>]();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> firstChunk = <span class="hljs-keyword">await</span> iterator.<span class="hljs-title function_">next</span>();
            <span class="hljs-keyword">yield</span> firstChunk.<span class="hljs-property">value</span>;
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);
        }
        <span class="hljs-keyword">yield</span>* iterator;
    }

    <span class="hljs-keyword">async</span> <span class="hljs-title function_">presentAssistantMessage</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> block = <span class="hljs-title function_">cloneDeep</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">assistantMessageContent</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentStreamingContentIndex</span>]);
        <span class="hljs-keyword">if</span> (block) {
            <span class="hljs-keyword">switch</span> (block.<span class="hljs-property">type</span>) {
                ...
                <span class="hljs-keyword">case</span> <span class="hljs-string">"tool_use"</span>:
                    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeTool</span>(block);
                    <span class="hljs-keyword">break</span>;
            }
            ...
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeTool</span>(<span class="hljs-attr">block</span>: <span class="hljs-title class_">ToolUse</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
        <span class="hljs-keyword">if</span> (block.<span class="hljs-property">params</span>.<span class="hljs-property">path</span> &amp;&amp; block.<span class="hljs-property">params</span>.<span class="hljs-property">content</span>) {
            <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cwd</span>, block.<span class="hljs-property">params</span>.<span class="hljs-property">path</span>);
            <span class="hljs-comment">// 将内容写入文件</span>
            <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(filePath, block.<span class="hljs-property">params</span>.<span class="hljs-property">content</span>, <span class="hljs-string">'utf-8'</span>);
        }
    }
}

</code></pre>
<p>我们在startTask调用attemptApiRequest与本地Ollama对话,使用准备好的系统提示词和用户提示词规范模型返回输出。然后循环读取对话输出流的内容，使用parseAssistantMessageV2解析特定内容。当匹配到write_to_file标签时调用本地工具写入文件。写到这里我们可以知道类似cline之类的本地agent是十分依赖于模型的输出内容的。当模型正确按照我们的系统提示词输出内容时，返回差不多如下。</p>
<pre><code class="hljs language-scss" lang="scss">&lt;write_to_file&gt;
&lt;path&gt;hello<span class="hljs-selector-class">.c</span>&lt;/path&gt;
&lt;<span class="hljs-attribute">content</span>&gt;<span class="hljs-selector-id">#include</span> &amp;lt;stdio<span class="hljs-selector-class">.h</span>&amp;gt;

int <span class="hljs-selector-tag">main</span>() {
    <span class="hljs-built_in">printf</span>("Hello, World!\\n");
    return <span class="hljs-number">0</span>;
}
&lt;/<span class="hljs-attribute">content</span>&gt;
&lt;task_progress&gt;
- <span class="hljs-selector-attr">[x]</span> 创建C语言Hello World程序文件
- <span class="hljs-selector-attr">[x]</span> 编写包含标准输入输出库的代码
- <span class="hljs-selector-attr">[x]</span> 实现<span class="hljs-selector-tag">main</span>函数
- <span class="hljs-selector-attr">[x]</span> 添加打印"Hello, World!"语句
- <span class="hljs-selector-attr">[x]</span> 返回<span class="hljs-number">0</span>表示程序成功结束
&lt;/task_progress&gt;
&lt;/write_to_file&gt;
</code></pre>
<p>这时候我们会解析&lt;write_to_file&gt;中的内容，从path获取文件名，从content获取文件内容，然后写入workspace下的该文件。</p>
<h3 data-id="heading-5">使用cline的示例测试</h3>
<p>根据cline官网的例子<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.cline.bot%2Fgetting-started%2Fyour-first-project" target="_blank" title="https://docs.cline.bot/getting-started/your-first-project" ref="nofollow noopener noreferrer">Build Your First Project</a>，我们在vscode中打开一个本地目录，比如c:/git/testvibe, 在我webview中选择qwen3-coder:latest,在对话框输入如下内容，点击发送按钮。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Create</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">simple</span> <span class="hljs-selector-tag">website</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">single</span> <span class="hljs-selector-tag">HTML</span> <span class="hljs-selector-tag">file</span>. <span class="hljs-selector-tag">It</span> <span class="hljs-selector-tag">should</span> <span class="hljs-selector-tag">have</span>:
<span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">welcome</span> <span class="hljs-selector-tag">message</span> <span class="hljs-selector-tag">saying</span> "<span class="hljs-selector-tag">Hello</span> <span class="hljs-selector-tag">from</span> <span class="hljs-selector-tag">Cline</span>!"
<span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">colorful</span> <span class="hljs-selector-tag">gradient</span> <span class="hljs-selector-tag">background</span>
<span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">button</span> <span class="hljs-selector-tag">that</span> <span class="hljs-selector-tag">cycles</span> <span class="hljs-selector-tag">through</span> <span class="hljs-selector-tag">different</span> <span class="hljs-selector-tag">color</span> <span class="hljs-selector-tag">themes</span> <span class="hljs-keyword">when</span> clicked
- Modern, clean design
- All CSS <span class="hljs-keyword">and</span> JavaScript should be included in the same HTML file
</code></pre>
<p>如果一切运行正常（在我本机差不多运行了2分多种），会在workspace目录下生成index.html,预览效果如下，点击按钮可以切换主题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b37b7cb586914f199601eb0c0cca3a15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5oSaNzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770113912&amp;x-signature=6ByJhvzPKd76bA%2BX%2FE0Wh0TtpC4%3D" alt="chapter-6-2.png" loading="lazy"/></p>
<h3 data-id="heading-6">总结</h3>
<p>系列入门教程到此告一段落。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript的数据类型 —— Undefined类型]]></title>    <link>https://juejin.cn/post/7599852579067281423</link>    <guid>https://juejin.cn/post/7599852579067281423</guid>    <pubDate>2026-01-27T09:24:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599852579067281423" data-draft-id="7599852579067084815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript的数据类型 —— Undefined类型"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-27T09:24:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="橘朵"/> <meta itemprop="url" content="https://juejin.cn/user/1099989273025416"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript的数据类型 —— Undefined类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099989273025416/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    橘朵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:24:39.000Z" title="Tue Jan 27 2026 09:24:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 中，<code>Undefined</code>类型是一个特殊且基础的数据类型，它表示一个变量最原始的自然状态——"未定义"。</p>
<p>Undefined类型只有一个值，就是 <code>undefined</code>。</p>
<p>当使用<code>var</code>或<code>let</code>声明了变量但没有初始化时，就相当于给变量赋予了<code>undefined</code>值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> message;  
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message == <span class="hljs-literal">undefined</span>); <span class="hljs-comment">// true </span>
<span class="hljs-comment">//等于</span>
<span class="hljs-keyword">let</span> message = <span class="hljs-literal">undefined</span> ; <span class="hljs-comment">//默认情况下，任何未经初始化的变量都会取得undefined值，因此，不必显式的初始化为undefined。</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message == <span class="hljs-literal">undefined</span>); <span class="hljs-comment">// true </span>
</code></pre>
<p>可以通过 typeof操作符来确认一个变量是否为 Undefined类型。无论是声明还是未声明，<code>typeof</code>返回的都是字符串"<code>undefined</code>"。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 变量被声明了，但未初始化，值为 undefined </span>
<span class="hljs-keyword">let</span> message; 

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message); <span class="hljs-comment">// "undefined"  </span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age); <span class="hljs-comment">// 没有声明变量,报错</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> message); <span class="hljs-comment">// "undefined" </span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> age); <span class="hljs-comment">// "undefined"</span>

<span class="hljs-comment">//访问对象不存在的属性</span>
<span class="hljs-keyword">let</span> obj = {};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">name</span>); <span class="hljs-comment">// undefined</span>

<span class="hljs-comment">//函数没有返回值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {} 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">foo</span>()); <span class="hljs-comment">// undefined</span>

<span class="hljs-comment">//函数参数未传递</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params">param</span>) { 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(param); 
} 
<span class="hljs-title function_">bar</span>(); <span class="hljs-comment">// undefined</span>

<span class="hljs-comment">//使用 void 操作符</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">void</span>(<span class="hljs-number">0</span>)); <span class="hljs-comment">// undefined</span>
</code></pre>
<p>使用严格相等进行检查：使用 <code>===</code>来严格判断一个值是否为 <code>undefined</code>，避免使用 <code>==</code>（因为 <code>undefined == null</code>为 <code>true</code>）。</p>
<pre><code class="hljs language-ini" lang="ini">if (<span class="hljs-attr">myVar</span> === undefined) { /* 处理 undefined */ }
</code></pre>
<p>安全地访问对象属性（可选链操作符 ?.）：当访问一个可能不存在的深层嵌套属性时，可选链操作符可以避免抛出错误。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">city</span> = user?.address?.city<span class="hljs-comment">; // 如果 address 不存在，则 city 为 undefined，而非报错。</span>
</code></pre>
<p>提供默认值（空值合并运算符 ??）：当变量为 <code>undefined</code>或 <code>null</code>时，空值合并运算符可以提供一个默认值。它与 <code>||</code>不同，不会过滤掉其他假值（如 <code>0</code>, <code>""</code>）。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">displayName</span> = username ?? <span class="hljs-string">"匿名用户"</span><span class="hljs-comment">; // 仅在 username 是 null 或 undefined 时使用默认值。</span>
</code></pre>
<p>安全的类型检查：如果要检查一个可能未声明的变量（直接使用会报引用错误），使用 <code>typeof</code>是最安全的方式。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> someUndeclaredVar === <span class="hljs-string">'undefined'</span>) {
  <span class="hljs-comment">// 不会报错，即使 someUndeclaredVar 从未被声明。</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“使用AI服务”到“拥有AI助手”：Clawdbot，你的个人AI基础设施]]></title>    <link>https://juejin.cn/post/7599630795804622894</link>    <guid>https://juejin.cn/post/7599630795804622894</guid>    <pubDate>2026-01-27T07:41:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599630795804622894" data-draft-id="7599850148055072777" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“使用AI服务”到“拥有AI助手”：Clawdbot，你的个人AI基础设施"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-27T07:41:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大厂技术总监下海"/> <meta itemprop="url" content="https://juejin.cn/user/4091714106833577"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“使用AI服务”到“拥有AI助手”：Clawdbot，你的个人AI基础设施
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4091714106833577/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大厂技术总监下海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:41:04.000Z" title="Tue Jan 27 2026 07:41:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Clawdbot 深度技术解析：构建去中心化的个人 AI 网关</h2>
<h3 data-id="heading-1">1. 整体介绍</h3>
<h4 data-id="heading-2">1.1 项目概览与定位</h4>
<p>Clawdbot 是一个开源项目，其核心是一个<strong>本地优先、自托管的 AI 助手网关系统</strong>。项目代码库位于 <code>clawdbot/clawdbot</code>，通过分析 <code>package.json</code> 和源码结构可知，这是一个使用 TypeScript 构建的 Node.js 应用程序，采用现代 JavaScript 工具链（pnpm、TypeScript、Vitest）。项目设计理念鲜明：将 AI 助手的能力从云端中心化服务中剥离，下沉到用户个人可控的设备上运行，实现数据主权、隐私保护和低延迟响应。</p>
<h4 data-id="heading-3">1.2 核心功能与解决方案</h4>
<p><strong>核心价值主张</strong>：解决用户对云端 AI 服务的三大顾虑——数据隐私、服务依赖性与交互割裂。</p>
<p><strong>面临的问题与目标人群</strong>：</p>
<ul>
<li><strong>问题</strong>：
<ol>
<li><strong>隐私泄露风险</strong>：敏感对话数据上传至第三方服务器。</li>
<li><strong>服务不可控</strong>：受限于服务商的策略、定价与可用性。</li>
<li><strong>交互碎片化</strong>：AI 助手能力分散在各个独立的 App 或网页中，无法统一管理。</li>
</ol>
</li>
<li><strong>目标人群</strong>：注重隐私的技术爱好者、开发者、希望将 AI 深度集成到个性化工作流中的进阶用户。</li>
</ul>
<p><strong>传统的解决方式与 Clawdbot 的创新</strong>：</p>
<ul>
<li><strong>传统方式</strong>：用户依赖 ChatGPT、Claude 等服务的 Web 界面或官方 API，数据流经服务商，且交互环境受限。</li>
<li><strong>Clawdbot 方式</strong>：
<ul>
<li><strong>本地网关</strong>：核心逻辑 (<code>Gateway</code>) 在用户设备（PC、服务器、Raspberry Pi）上运行，构成“控制平面”。所有消息路由、工具调用、会话管理首先发生在本地。</li>
<li><strong>协议适配器</strong>：为 WhatsApp (<code>@whiskeysockets/baileys</code>)、Telegram (<code>grammy</code>)、Slack (<code>@slack/bolt</code>)、Discord 等平台编写适配层，将不同协议统一为内部事件。</li>
<li><strong>统一智能体接口</strong>：无论来自哪个平台的消息，最终都路由到统一的 AI 智能体 (<code>Agent</code>) 处理，智能体可以调用本地工具、访问网络或使用配置的云模型（如 OpenAI, Anthropic）。</li>
<li><strong>优点</strong>：
<ol>
<li><strong>数据可控</strong>：对话上下文、个人配置、访问令牌等存储于本地。</li>
<li><strong>服务稳定</strong>：网关服务不受服务商界面变动影响，可配置多个模型后备。</li>
<li><strong>体验统一</strong>：一个 AI 助手分身可同时服务多个通讯平台。</li>
</ol>
</li>
</ul>
</li>
</ul>
<p><strong>商业价值预估逻辑</strong>：</p>
<ul>
<li><strong>代码与工程成本</strong>：项目结构复杂，涉及多协议适配、事件驱动架构、插件系统、移动端集成等。若从零开发，一个成熟团队需要至少 12-18 人月的密集投入。估算开发成本约为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>300</mn><mo separator="true">,</mo><mn>000</mn><mo>−</mo></mrow><annotation encoding="application/x-tex">300,000 - </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">300</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">000</span><span class="mord">−</span></span></span></span></span>500,000。</li>
<li><strong>覆盖问题空间效益</strong>：它解决的是一个<strong>集成与自动化</strong>问题，而非创造新的 AI 能力。其价值在于将已有的 AI 模型能力（OpenAI/Anthropic）与用户已有的通讯工具（WhatsApp/Slack）无缝连接，创造了“1+1&gt;2”的效用。对于个体用户，价值在于隐私和定制化；对于企业，可作为内部知识助手的安全部署方案原型。市场规模属于“开发者工具”与“效率工具”的交集，潜在用户量在数百万级别。</li>
</ul>
<h3 data-id="heading-4">2. 详细功能拆解</h3>
<h4 data-id="heading-5">2.1 核心功能模块</h4>
<p>从 <code>package.json</code> 的 <code>files</code> 字段和源码目录可清晰划分模块：</p>
<ol>
<li><strong>网关核心 (<code>src/gateway/</code>)</strong>：消息路由、连接管理、状态维护的枢纽。</li>
<li><strong>渠道适配层 (<code>src/whatsapp/</code>, <code>src/telegram/</code>等)</strong>：将各平台 SDK 封装成统一的 <code>Channel</code> 接口。</li>
<li><strong>智能体引擎 (<code>src/agents/</code>)</strong>：AI 交互的核心，处理提示词、调用模型、管理会话上下文和工具执行。</li>
<li><strong>工具系统 (<code>src/tools/</code>)</strong>：提供 AI 可调用的函数，如浏览器、Canvas、Cron 等，是扩展能力的基石。</li>
<li><strong>会话与状态管理 (<code>src/sessions/</code>)</strong>：管理用户对话的持久化状态，支持多智能体路由。</li>
<li><strong>插件 SDK (<code>dist/plugin-sdk/</code>)</strong>：定义标准接口，允许第三方扩展认证提供商、工具或渠道。</li>
<li><strong>配置与向导 (<code>src/config/</code>, <code>src/wizard/</code>)</strong>：提供 <code>clawdbot onboard</code> 等 CLI 向导，简化复杂的配置过程。</li>
<li><strong>配套应用 (<code>apps/macos/</code>, <code>apps/ios/</code>)</strong>：提供系统托盘应用和移动端节点，扩展交互场景。</li>
</ol>
<h4 data-id="heading-6">2.2 产品-技术联动视角</h4>
<ul>
<li><strong>“多智能体”功能</strong>：技术上通过 <code>src/sessions/session-store.ts</code> 中的 <code>SessionEntry</code> 和路由逻辑实现。每个会话 (<code>sessionKey</code>) 可以绑定到不同的 <code>agentId</code>，从而关联不同的工作空间 (<code>workspaceDir</code>) 和模型配置，实现角色隔离。</li>
<li><strong>“配对”安全策略</strong>：在 <code>src/sessions/</code> 中实现配对码生成与验证逻辑，只有经本地确认的会话才能被智能体处理。这解决了自托管机器人可能被任意用户滥用的安全问题。</li>
<li><strong>“模型后备”机制</strong>：由 <code>src/agents/model-fallback.js</code> 和 <code>agentCommand</code> 函数中的 <code>runWithModelFallback</code> 逻辑实现。当主模型认证失败或不可用时，自动切换到备选模型，提升了系统鲁棒性。</li>
</ul>
<h3 data-id="heading-7">3. 技术难点挖掘</h3>
<ol>
<li><strong>异构协议的统一抽象</strong>：不同 IM 协议（XMPP、MTProto、自定义）在连接、认证、消息格式上差异巨大。难点在于设计一个足够通用的内部 <code>Message</code> 和 <code>Channel</code> 接口，并稳定处理各 SDK 的回调与事件流。</li>
<li><strong>长上下文会话状态管理</strong>：AI 对话需要维护可能长达数万 token 的上下文。难点在于高效地存储、检索、截断和在不同会话间隔离这些状态，同时支持随模型切换而调整上下文窗口大小（参考 <code>src/sessions/session-store.ts</code> 中的 <code>contextTokens</code> 处理）。</li>
<li><strong>工具调用的安全沙盒</strong>：允许 AI 执行代码（如 Python 脚本）、访问文件系统或网络是强大但危险的功能。难点在于实现安全的执行隔离、资源限制和权限控制。项目通过明确的工具定义和参数校验（如 <code>src/tools/tool.ts</code> 中的 <code>ZalouserToolSchema</code>）来部分缓解。</li>
<li><strong>分布式节点协调</strong>：在 macOS、iOS 多设备间同步状态、转发语音或画布数据，涉及网络发现、低延迟通信和冲突解决，是一个分布式系统问题。</li>
<li><strong>OAuth 等复杂认证流程的本地化处理</strong>：例如 Gemini CLI 的 OAuth 流程 (<code>src/gateway/oauth.js</code>)，需要在本地服务器处理回调，并在无浏览器环境的 CLI 中引导用户授权。</li>
</ol>
<h3 data-id="heading-8">4. 详细设计图</h3>
<h4 data-id="heading-9">4.1 系统架构图 (C4 Model - Container Diagram)</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/753eb183a6f84cb2961edfb8d3993465~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5Y6C5oqA5pyv5oC755uR5LiL5rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770104463&amp;x-signature=Y6tGC2d%2BtxhUJNfn4rix3FGdf3o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-10">4.2 核心消息处理序列图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C as Channel (e.g., WhatsApp)
    participant G as Gateway Core
    participant R as Router
    participant S as Session Manager
    participant A as Agent Engine
    participant T as Tool
    participant M as AI Model (Cloud)

    C-&gt;&gt;G: 收到新消息 (原始协议格式)
    G-&gt;&gt;G: 解码，标准化为内部 Message 事件
    G-&gt;&gt;R: 路由消息 (基于 to/sessionKey/agentId)
    R-&gt;&gt;S: 获取或创建 SessionEntry
    S-&gt;&gt;A: 交付消息及完整会话上下文
    A-&gt;&gt;A: 构建提示词， 决定是否思考/调用工具
    alt 需要调用工具
        A-&gt;&gt;T: executeTool(toolCallId, params)
        T-&gt;&gt;T: 执行（如查询、API调用）
        T--&gt;&gt;A: 返回工具执行结果
    end
    A-&gt;&gt;M: 调用模型 API (携带最终提示)
    M--&gt;&gt;A: 返回模型响应
    A-&gt;&gt;S: 更新会话历史与用量
    S-&gt;&gt;G: 提交回复消息
    G-&gt;&gt;C: 编码为协议格式并发送
</code></pre>
<h4 data-id="heading-11">4.3 核心类关系图 (简化的领域模型)</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcd437152a854879b6f9fbabd8a83d73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5Y6C5oqA5pyv5oC755uR5LiL5rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770104463&amp;x-signature=eVn%2BCIRtQAw5PBVrZ5gkUFtd4ko%3D" alt="deepseek_mermaid_20260127_b3e5ca.png" loading="lazy"/></p>
<h3 data-id="heading-12">5. 核心函数解析</h3>
<h4 data-id="heading-13">5.1 智能体命令入口：<code>agentCommand</code></h4>
<p>这是整个系统最核心的流程控制函数，位于 <code>src/agents/agent.ts</code>。它协调了从接收消息到交付响应的完整生命周期。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 代码基于 src/agents/agent.ts 简化与注释</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">agentCommand</span>(<span class="hljs-params">
  opts: AgentCommandOpts, <span class="hljs-comment">// 包含消息、接收者、会话ID、模型参数等</span>
  runtime: RuntimeEnv = defaultRuntime,
  deps: CliDeps = createDefaultDeps(),
</span>) {
  <span class="hljs-comment">// 1. 输入验证与基础准备</span>
  <span class="hljs-keyword">const</span> body = (opts.<span class="hljs-property">message</span> ?? <span class="hljs-string">""</span>).<span class="hljs-title function_">trim</span>();
  <span class="hljs-keyword">if</span> (!body) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Message (--message) is required"</span>);
  <span class="hljs-comment">// ... 验证 to, sessionId, agentId 至少有一个</span>

  <span class="hljs-keyword">const</span> cfg = <span class="hljs-title function_">loadConfig</span>(); <span class="hljs-comment">// 加载用户配置</span>
  <span class="hljs-keyword">const</span> sessionResolution = <span class="hljs-title function_">resolveSession</span>({ cfg, ...opts }); <span class="hljs-comment">// 关键：解析出当前会话</span>

  <span class="hljs-keyword">const</span> {
    sessionId,
    sessionKey,
    sessionEntry,
    sessionStore,
    storePath,
    isNewSession,
  } = sessionResolution;

  <span class="hljs-keyword">const</span> runId = opts.<span class="hljs-property">runId</span>?.<span class="hljs-title function_">trim</span>() || sessionId; <span class="hljs-comment">// 用于跟踪本次运行的唯一ID</span>

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 2. 检查发送策略（如DM配对是否通过）</span>
    <span class="hljs-keyword">if</span> (opts.<span class="hljs-property">deliver</span> === <span class="hljs-literal">true</span>) {
      <span class="hljs-keyword">const</span> sendPolicy = <span class="hljs-title function_">resolveSendPolicy</span>({ cfg, <span class="hljs-attr">entry</span>: sessionEntry, sessionKey, ... });
      <span class="hljs-keyword">if</span> (sendPolicy === <span class="hljs-string">"deny"</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"send blocked by session policy"</span>);
    }

    <span class="hljs-comment">// 3. 确定思考层级和详细级别（用户输入 &gt; 会话存储 &gt; 全局默认）</span>
    <span class="hljs-keyword">let</span> resolvedThinkLevel = <span class="hljs-comment">/* 计算逻辑 */</span>;
    <span class="hljs-keyword">const</span> resolvedVerboseLevel = <span class="hljs-comment">/* 计算逻辑 */</span>;

    <span class="hljs-comment">// 4. 注册运行时上下文，用于事件发射和日志关联</span>
    <span class="hljs-keyword">if</span> (sessionKey) {
      <span class="hljs-title function_">registerAgentRunContext</span>(runId, { sessionKey, <span class="hljs-attr">verboseLevel</span>: resolvedVerboseLevel });
    }

    <span class="hljs-comment">// 5. 构建或获取技能快照（用于给AI提供上下文）</span>
    <span class="hljs-keyword">const</span> skillsSnapshot = isNewSession || !sessionEntry?.<span class="hljs-property">skillsSnapshot</span>
      ? <span class="hljs-title function_">buildWorkspaceSkillSnapshot</span>(workspaceDir, ...)
      : sessionEntry?.<span class="hljs-property">skillsSnapshot</span>;

    <span class="hljs-comment">// 6. 模型选择与后备逻辑</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">provider</span>: defaultProvider, <span class="hljs-attr">model</span>: defaultModel } = <span class="hljs-title function_">resolveConfiguredModelRef</span>({ cfg });
    <span class="hljs-keyword">let</span> provider = defaultProvider;
    <span class="hljs-keyword">let</span> model = defaultModel;
    <span class="hljs-comment">// 处理会话级别的模型覆盖 (sessionEntry.modelOverride)</span>
    <span class="hljs-comment">// 处理模型允许列表 (cfg.agents.defaults.models)</span>
    <span class="hljs-comment">// 加载模型目录以验证可用性</span>

    <span class="hljs-comment">// 7. 核心执行：运行嵌入式PI智能体或CLI智能体</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">runWithModelFallback</span>({
      cfg,
      provider,
      model,
      <span class="hljs-attr">run</span>: <span class="hljs-keyword">async</span> (providerOverride, modelOverride) =&gt; {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isCliProvider</span>(providerOverride, cfg)) {
          <span class="hljs-comment">// 模式：调用本地命令行AI工具（如`llm`命令）</span>
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">runCliAgent</span>({ sessionId, <span class="hljs-attr">prompt</span>: body, <span class="hljs-attr">provider</span>: providerOverride, ... });
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 模式：调用云API或本地模型库（主要路径）</span>
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">runEmbeddedPiAgent</span>({
            sessionId,
            sessionKey,
            <span class="hljs-attr">prompt</span>: body,
            <span class="hljs-attr">provider</span>: providerOverride,
            <span class="hljs-attr">model</span>: modelOverride,
            <span class="hljs-attr">thinkLevel</span>: resolvedThinkLevel, <span class="hljs-comment">// 控制AI的“思考”深度</span>
            skillsSnapshot, <span class="hljs-comment">// 注入可用技能信息</span>
            <span class="hljs-attr">streamParams</span>: opts.<span class="hljs-property">streamParams</span>, <span class="hljs-comment">// 支持流式响应</span>
            <span class="hljs-attr">onAgentEvent</span>: <span class="hljs-function">(<span class="hljs-params">evt</span>) =&gt;</span> { <span class="hljs-comment">/* 发射生命周期事件 */</span> },
          });
        }
      },
    });

    <span class="hljs-comment">// 8. 更新会话存储（记录使用的模型、token消耗等）</span>
    <span class="hljs-keyword">if</span> (sessionStore &amp;&amp; sessionKey) {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateSessionStoreAfterAgentRun</span>({
        cfg,
        sessionId,
        sessionKey,
        storePath,
        sessionStore,
        <span class="hljs-attr">defaultProvider</span>: provider,
        <span class="hljs-attr">defaultModel</span>: model,
        result, <span class="hljs-comment">// 包含用量元数据</span>
      });
    }

    <span class="hljs-comment">// 9. 交付结果（根据opts.deliver决定是打印到CLI还是发送回消息渠道）</span>
    <span class="hljs-keyword">const</span> payloads = result.<span class="hljs-property">payloads</span> ?? [];
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">deliverAgentCommandResult</span>({ cfg, deps, runtime, opts, sessionEntry, result, payloads });

  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 10. 清理运行时上下文</span>
    <span class="hljs-title function_">clearAgentRunContext</span>(runId);
  }
}
</code></pre>
<p><strong>关键设计解析</strong>：</p>
<ul>
<li><strong>依赖注入</strong>：函数接收 <code>runtime</code> 和 <code>deps</code> 参数，便于测试和环境隔离。</li>
<li><strong>统一的会话抽象</strong>：<code>resolveSession</code> 函数将 <code>to</code> (E.164号码)、<code>sessionId</code>、<code>sessionKey</code>、<code>agentId</code> 等多种标识符统一解析为内部的 <code>sessionKey</code> 和 <code>SessionEntry</code>，这是实现多平台路由的基础。</li>
<li><strong>模型后备机制</strong>：<code>runWithModelFallback</code> 封装了重试逻辑，是系统可靠性的关键。</li>
<li><strong>事件驱动架构</strong>：通过 <code>onAgentEvent</code> 回调发射细粒度事件（思考开始、工具调用、流式输出块），使得外部（如UI、日志）可以实时观察智能体运行状态。</li>
<li><strong>资源生命周期管理</strong>：使用 <code>try...finally</code> 确保 <code>runContext</code> 被清理，避免内存泄漏。</li>
</ul>
<h4 data-id="heading-14">5.2 工具执行示例：<code>executeZalouserTool</code></h4>
<p>展示了如何将外部命令行工具（<code>zca</code>，一个 Zalo 客户端）安全地封装成 AI 可调用的函数。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 代码基于 src/tools/tool.ts 简化</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeZalouserTool</span>(<span class="hljs-params">_toolCallId: <span class="hljs-built_in">string</span>, params: ToolParams</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ToolResult</span>&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">switch</span> (params.<span class="hljs-property">action</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"send"</span>: {
        <span class="hljs-comment">// 1. 参数校验</span>
        <span class="hljs-keyword">if</span> (!params.<span class="hljs-property">threadId</span> || !params.<span class="hljs-property">message</span>) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"threadId and message required for send action"</span>);
        }
        <span class="hljs-comment">// 2. 构造安全的命令行参数</span>
        <span class="hljs-keyword">const</span> args = [<span class="hljs-string">"msg"</span>, <span class="hljs-string">"send"</span>, params.<span class="hljs-property">threadId</span>, params.<span class="hljs-property">message</span>];
        <span class="hljs-keyword">if</span> (params.<span class="hljs-property">isGroup</span>) args.<span class="hljs-title function_">push</span>(<span class="hljs-string">"-g"</span>);
        <span class="hljs-comment">// 3. 调用外部二进制，不直接拼接字符串，避免注入</span>
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">runZca</span>(args, { <span class="hljs-attr">profile</span>: params.<span class="hljs-property">profile</span> });
        <span class="hljs-comment">// 4. 处理结果，统一格式返回</span>
        <span class="hljs-keyword">if</span> (!result.<span class="hljs-property">ok</span>) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(result.<span class="hljs-property">stderr</span> || <span class="hljs-string">"Failed to send message"</span>);
        }
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">content</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>, <span class="hljs-attr">text</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">output</span>: result.<span class="hljs-property">stdout</span> }, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) }],
          <span class="hljs-attr">details</span>: { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">output</span>: result.<span class="hljs-property">stdout</span> }
        };
      }
      <span class="hljs-comment">// ... 处理其他 action (image, link, friends...)</span>
    }
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-comment">// 5. 统一的错误处理，将异常转化为AI可理解的格式</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">content</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>, <span class="hljs-attr">text</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">error</span>: err.<span class="hljs-property">message</span> }, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) }],
      <span class="hljs-attr">details</span>: { <span class="hljs-attr">error</span>: err.<span class="hljs-property">message</span> }
    };
  }
}
</code></pre>
<h3 data-id="heading-15">6. 同类技术对比与总结</h3>
<p><strong>与云端助手（ChatGPT/Claude）对比</strong>：</p>
<ul>
<li><strong>优势</strong>：数据本地化、多平台统一入口、可深度定制和扩展、运行成本可控（仅支付模型API费用）。</li>
<li><strong>劣势</strong>：用户需自行维护服务器、配置复杂度高、初始设置有技术门槛。</li>
</ul>
<p><strong>与单一平台机器人框架（如Botpress、GrammY）对比</strong>：</p>
<ul>
<li><strong>优势</strong>：真正的<strong>跨平台</strong>统一架构，一个智能体实例服务所有渠道；<strong>本地优先</strong>的设计哲学更注重隐私和控制权。</li>
<li><strong>劣势</strong>：项目更年轻，社区和插件生态可能不如成熟框架丰富。</li>
</ul>
<p><strong>技术选型与架构评价</strong>：
Clawdbot 选择 TypeScript/Node.js 生态，利用了其强大的异步I/O处理能力和丰富的 npm 包（各类 IM SDK），适合事件驱动、高I/O的网关类应用。其架构清晰，模块化程度高，通过 Plugin SDK 预留了良好的扩展性。然而，将复杂状态管理于文件系统和内存中，在向多实例、高可用性部署演进时可能面临挑战。</p>
<p><strong>结论</strong>：
Clawdbot 代表了一种重要的技术方向：将大型AI模型的“智能”与个人计算设备的“控制”相结合。它不是一个面向普通用户的“产品”，而是一个面向开发者和技术爱好者的“强大平台”。其代码体现了对复杂性问题（多协议、状态管理、扩展性）的深刻思考与工程化解法，为构建隐私友好、用户可控的下一代个人AI基础设施提供了极具价值的参考实现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[错的"优化目标"：从扫地机器人到毁掉一切的算法]]></title>    <link>https://juejin.cn/post/7599847938537406473</link>    <guid>https://juejin.cn/post/7599847938537406473</guid>    <pubDate>2026-01-27T08:02:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599847938537406473" data-draft-id="7599630795804786734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="错的&quot;优化目标&quot;：从扫地机器人到毁掉一切的算法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T08:02:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深度涌现"/> <meta itemprop="url" content="https://juejin.cn/user/2524932621734990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            错的"优化目标"：从扫地机器人到毁掉一切的算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524932621734990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深度涌现
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T08:02:01.000Z" title="Tue Jan 27 2026 08:02:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>清扫整个 Albert Heijn 超市的地面。听起来很简单。而且原本也应该很简单。</p>
<p>但我是一名计算机科学专业的学生，我遇到了一个问题：我总是忍不住去优化一些（可能）不需要优化的东西。</p>
<p>所以，我没有只是做好我的工作，比如扫地，而是做了任何一个“理智的”人都会做的事：我把超市的平面图转换成了网格图，构建了一个可视化编辑器，并使用模拟退火算法编写了一个 C++ 路径优化器。</p>
<p>但在我们深入探讨这件事是如何彻底出错，以及这件事如何让我意识到这会让每个人都痛苦之前，我需要你回答一个问题：</p>
<p>如果你要替我工作一天，并且需要打扫整个 Albert Heijn 超市的楼层，你会选择 A 路线还是 B 路线？
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/bdc47e6c-cc83-4a27-87bd-102e3d3c0516_1150x1500_c35cf38c.png" alt="img" loading="lazy"/>
路径 A（上）和路径 B（下）。</p>
<p>说真的，看看它们。哪个看起来更适合清扫超市地面？</p>
<p>如果你选择了A选项：恭喜你，你的思维方式像算法一样，很可能就是个机器人。</p>
<p>但从技术上讲，你的说法没错。路径 A 的距离更短。然而，它完全没用。</p>
<p>看看那些弯道。你不妨想象一下，如果你走路时也这样弯，你会看起来像个疯子，就像一台抽搐的扫地机器人。</p>
<p>路径 A 是你优化了错误的东西而导致的结果。</p>
<p>剧透一下，这正是这个故事的重点。不过我们稍后再谈，先让我解释一下事情的来龙去脉：</p>
<h2 data-id="heading-0">第一步：将现实转化为过于简单的模型</h2>
<p>首先，我把 Albert Heijn 的平面图转换成了网格。每个方格要么是空的（应该打扫），要么是障碍物（墙壁、收银台、有人扔在地上的酸奶包装）。</p>
<p>我在<a href="https://link.juejin.cn?target=https%3A%2F%2Fprocessing.org%2F" target="_blank" title="https://processing.org/" ref="nofollow noopener noreferrer">Processing</a>中构建了一个可视化编辑器，这样我就可以轻松地绘制商店地图并导出生成的图表。</p>
<p>因此，将平面图转换为网格结构非常容易。
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/20260127133430350_e273c43d.png" alt="img" loading="lazy"/>
Albert Heijn 超市的网格平面图。</p>
<p>实际地面的瓷砖铺设有助于将该区域细分为易于管理的小块区域。
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/d0ea4a82-edf2-4aa8-9a45-348731666114_1150x750_f9f84176.png" alt="img" loading="lazy"/>
采用瓷砖结构的细分式平面图。</p>
<p>然后，通过将每个图块解释为一个节点，然后将它们连接到相邻的图块，就可以很容易地将其转换为网络结构（也称为图）。
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/846289b8-6269-46d5-a7ee-ea375325651e_1150x750_1ad8642d.png" alt="img" loading="lazy"/>
将每个图块解释为图中的一个节点。
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/085819a8-9e57-4bad-902b-75823cb7ca34_1150x750_5b065217.png" alt="img" loading="lazy"/>
生成的瓦片网络。</p>
<p>如你所见，我允许水平和垂直移动，以及对角线移动（只要你不穿墙）。
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/716121fe-3f08-4c7e-894d-082f673ca1f0_1150x750_e6014d03.png" alt="img" loading="lazy"/>
Albert Heijn 的最终图表。</p>
<p>接下来唯一要做的就是找到一条贯穿这个网络的路径，同时确保访问所有节点（图块）。这样就能解决我的扫描问题。</p>
<p><em>（这个问题也称为<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FTravelling_salesman_problem" target="_blank" title="https://en.wikipedia.org/wiki/Travelling_salesman_problem" ref="nofollow noopener noreferrer">旅行商问题</a>，详情请参阅相关文章，了解它为何如此难以“解决”。）</em></p>
<h2 data-id="heading-1">第二步：编写优化器</h2>
<p>由于在如此规模的图中，计算上不可能找到最优路径，我们只能求助于启发式算法。启发式算法本质上是在短时间内找到一个<strong>非常好的</strong>解，而不是试图找到<strong>完美的</strong>解（这几乎是不可能的）。</p>
<p>所以我用 C++ 实现了路径优化器。</p>
<p>底层启发式算法：<strong>模拟退火</strong>。</p>
<p>如果你还不熟悉，模拟退火本质上就是尝试一系列微小的变化（也称为局部移动）。</p>
<p>一开始，你接受每一个小小的改变（即使它让路径变得更糟），但随着算法的进行，你会逐渐变得更加挑剔，最终只允许那些严格意义上改善路径的改变。</p>
<p>这个想法源于金属冷却的过程。首先，金属在高温下运行（尝试不同的运动方式）进行充分的探索，然后逐渐冷却，最终稳定在低能量状态（接近最佳状态）。
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/c80c76a3-0921-4b5e-89cf-dc254b81a0e9_1150x750_fc6adf39.gif" alt="img" loading="lazy"/>
模拟退火算法通过多次迭代逐步改进路径。</p>
<p>看看这个动图。看到了吗？它一开始很混乱，然后逐渐变得稳定下来。这就是模拟退火算法的工作原理。</p>
<p>对于局部移动，我使用了 2-opt 移动。具体来说，就是移除路径中的两条边，然后用不同的方式重新连接它们。如果这种微小的改动使路径变得更好，就保留它。否则，要么保留它（如果温度仍然很高），要么舍弃它。
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/0d414694-060b-4126-82c6-093acf5c0ebc_1956x876_f8c0b43b.png" alt="img" loading="lazy"/>
2-opt 移动可视化。</p>
<p>那就这么做十亿次。或者，让你的电脑这么做十亿次。</p>
<h2 data-id="heading-2">第三步：搞砸</h2>
<p>运行一段时间后，我得到了第一条“优化”路径。以下是优化结果：
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/fcb8b22f-3afc-406a-adff-455aa0dd32ee_1150x750_921cb651.gif" alt="img" loading="lazy"/>
第一条“优化”路径。</p>
<p>瞧瞧这路！弯道比克里斯托弗·诺兰的电影还多。谁会傻到真的这么扫地啊？扫完估计都想吐。</p>
<p>从技术上讲，它覆盖了整个地面。从技术上讲，它（几乎）是最小的清扫路径。从技术上讲，它是完美的。</p>
<p>它有一些优点，但实际上，它完全没用。</p>
<p>算法完全按照我的要求执行了。</p>
<p>我问错问题了。</p>
<h2 data-id="heading-3">第四步：根据实际情况进行优化</h2>
<p>我很快意识到我优化的方向错了。距离并非一切。</p>
<p>转弯很重要。动量很重要。看起来不像个故障的机器人也很重要。</p>
<p>所以我给成本函数增加了一个“转弯惩罚”，并要求它最小化这个惩罚。基本上就是告诉算法：“转弯90度会扣分。转弯180度？你疯了吧。”</p>
<p>这样一来，路线就更加顺畅了，即使距离略微延长了一些。
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/2809e59e-bfab-4ced-8f23-a8625bce71e4_1150x750_f58bf32e.gif" alt="img" loading="lazy"/>
更平坦、更适合步行的道路。</p>
<p>你看，这其实……挺好走的。你把这条路交给一个真正的人，他也不会立刻放弃。</p>
<p>我们不再追求距离上的最优解，而是追求与现实的契合度。</p>
<h2 data-id="heading-4">第五步：打破它</h2>
<p>接下来才是精彩的部分。</p>
<p>您可以调整急转弯的惩罚。这相当于一个滑块，可以在“纯粹的效率”和“实际用途”之间切换。
<img src="https://pic-1251484506.cos.ap-guangzhou.myqcloud.com/imgs/a3392aaf-223d-475c-9acb-a947eedefaa0_2300x2250_6c44f82c.png" alt="img" loading="lazy"/>
从低角度罚分（1）到高角度罚分（6）。</p>
<p>你可以清楚地看到其中的权衡。增加惩罚，路径会更平滑，但会稍长一些。减少惩罚，效率会提高，但会造成混乱。</p>
<p>选择哪条路完全取决于你自己。这取决于很多因素，比如你转身是否方便，总距离是否是首要考虑因素，以及你能忍受多大的眩晕。</p>
<h2 data-id="heading-5">第六步：意识到生活其实并没有那么美好</h2>
<p>但这不仅仅是扫地那么简单。</p>
<p>这关乎一切。</p>
<p>社交媒体算法以提升用户参与度为目标，而且它们在这方面做得非常出色。问题出在哪里呢？</p>
<p>参与度≠幸福。参与度≠真相。参与度=点击量、屏幕使用时长、愤怒情绪和负面反应。</p>
<p>后果？愤怒、错误信息、负面新闻刷屏、焦虑。</p>
<p>算法运行完美，完全按照设计预期执行。问题出在成本函数上。（Instagram 可能不这么认为。）</p>
<p>推荐算法会优化观看时长和点击率。你奶奶正在YouTube上连续看6个小时的阴谋论视频。</p>
<p>算法彻底毁了她。她感觉糟透了。</p>
<p>这并不令人意外。</p>
<p>即使是像 ChatGPT 这样的大型语言模型，它们的优化方向也错了。它们优化的是听起来自信，听起来好像知道答案。</p>
<p>不是因为他正确，也不是因为他诚实。</p>
<p>他们接受的训练是完成既定模式，而不是说“我不知道”。所以他们只能靠猜测。而且毫无羞耻心，语法也完美无瑕。</p>
<p>这一点甚至适用于科技以外的领域。</p>
<p>想想企业。它们大多以盈利为目标。地球、环境、道德或伦理呢？这些都没有纳入成本函数，因此也不会被优化。</p>
<p>我在实际工作中是否使用了这条优化路径？</p>
<p>不，显然不是。我只是像正常人一样扫了地而已。</p>
<p>但构建这个项目教会了我一个我一直在思考的道理：如果你解决的是错误的问题，那么技术上的正确性就毫无意义。</p>
<p>你可以写出完美的代码，你可以构建完美无瑕的系统，你可以把成本函数优化到极致，但最终结果仍然可能很糟糕。</p>
<p>重要的不是优化算法本身，而是首先要弄清楚你究竟应该优化什么。</p>
<p>大多数时候，我们甚至都不会问这个问题。我们只是优化那些容易衡量的指标，然后祈祷结果会好起来。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftiespetersen.substack.com%2Fp%2Fi-got-paid-minimum-wage-to-solve" target="_blank" title="https://tiespetersen.substack.com/p/i-got-paid-minimum-wage-to-solve" ref="nofollow noopener noreferrer">tiespetersen.substack.com/p/i-got-pai…</a></p>
<p>笔者公众号「深度涌现」</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript事件循环与异步执行全解析]]></title>    <link>https://juejin.cn/post/7599860946836652095</link>    <guid>https://juejin.cn/post/7599860946836652095</guid>    <pubDate>2026-01-27T09:26:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599860946836652095" data-draft-id="7599843186202378282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript事件循环与异步执行全解析"/> <meta itemprop="keywords" content="JavaScript,面试,前端"/> <meta itemprop="datePublished" content="2026-01-27T09:26:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雪中何以赠君别"/> <meta itemprop="url" content="https://juejin.cn/user/3186831013974270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript事件循环与异步执行全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3186831013974270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雪中何以赠君别
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:26:33.000Z" title="Tue Jan 27 2026 09:26:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><hr/>
<h2 data-id="heading-0">📝 代码示例一：Promise与setTimeout混合</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"set!"</span>);
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-title function_">resolve</span>();
  }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
      <span class="hljs-title function_">resolve</span>();
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"then4"</span>);
    });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"then2"</span>);
  });
});

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"pr1"</span>);
  <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"then1"</span>);
});

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"set2"</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);

<span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"microtask"</span>);
});

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"then3"</span>);
});
</code></pre>
<p><strong>🎯 输出顺序：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">pr1
<span class="hljs-number">2</span>
then1
microtask
then3
set!
then2
then4
set2
</code></pre>
<h2 data-id="heading-1">📝 代码示例二：async/await与Promise混合</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async1</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"async1 start"</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">async2</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"async1 end"</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">async2</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"async2"</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"script start"</span>);

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"setTimeout"</span>);
}, <span class="hljs-number">0</span>);

<span class="hljs-title function_">async1</span>();

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">resolve</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"promise1"</span>);
  <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"promise2"</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"script end"</span>);
</code></pre>
<p><strong>🎯 输出顺序：</strong></p>
<pre><code class="hljs language-sql" lang="sql">script <span class="hljs-keyword">start</span>
async1 <span class="hljs-keyword">start</span>
async2
promise1
script <span class="hljs-keyword">end</span>
async1 <span class="hljs-keyword">end</span>
promise2
setTimeout
</code></pre>
<h2 data-id="heading-2">🔍 事件循环核心概念</h2>
<h3 data-id="heading-3">任务队列分类</h3>
<h4 data-id="heading-4">宏任务 (Macrotask)</h4>
<ul>
<li><code>setTimeout</code> / <code>setInterval</code></li>
<li>I/O 操作</li>
<li>UI 渲染</li>
<li><code>setImmediate</code> (Node.js)</li>
<li>脚本整体代码</li>
</ul>
<h4 data-id="heading-5">微任务 (Microtask)</h4>
<ul>
<li><code>Promise.then</code> / <code>.catch</code> / <code>.finally</code></li>
<li><code>queueMicrotask</code></li>
<li><code>MutationObserver</code></li>
<li><code>async/await</code> 后的代码</li>
</ul>
<h3 data-id="heading-6">⚡ 执行规则（黄金法则）</h3>
<ol>
<li><strong>同步代码立即执行</strong>：所有非异步代码立即执行</li>
<li><strong>微任务优先</strong>：当前宏任务结束后，立即执行所有微任务</li>
<li><strong>微任务队列必须完全清空</strong>：包括执行过程中新加入的微任务</li>
<li><strong>按序执行宏任务</strong>：微任务清空后才执行下一个宏任务</li>
</ol>
<h2 data-id="heading-7">🚀 详细执行机制解析</h2>
<h3 data-id="heading-8">第一阶段：同步代码执行（立即执行）</h3>
<p>在示例一中：</p>
<ol>
<li><code>setTimeout1</code> 回调加入宏任务队列</li>
<li><code>Promise</code> 构造函数同步执行，输出 <code>pr1</code>，<code>then1</code> 加入微任务队列</li>
<li><code>setTimeout2</code> 回调加入宏任务队列</li>
<li><code>console.log(2)</code> 输出 <code>2</code></li>
<li><code>queueMicrotask</code> 回调加入微任务队列</li>
<li>第二个 <code>Promise</code> 的 <code>then3</code> 加入微任务队列</li>
</ol>
<p>在示例二中：</p>
<ol>
<li><code>console.log("script start")</code> 输出</li>
<li><code>setTimeout</code> 加入宏任务队列</li>
<li>执行 <code>async1()</code>：
<ul>
<li>输出 <code>async1 start</code></li>
<li>执行 <code>async2()</code>，输出 <code>async2</code></li>
<li><code>await</code> 后的代码转为微任务</li>
</ul>
</li>
<li><code>new Promise</code> 构造函数同步执行，输出 <code>promise1</code></li>
<li><code>console.log("script end")</code> 输出</li>
</ol>
<h3 data-id="heading-9">第二阶段：微任务执行（同步代码完成后）</h3>
<p><strong>关键特性</strong>：微任务执行期间产生的新微任务会加入当前队列并继续执行</p>
<p>示例一微任务顺序：</p>
<ol>
<li><code>then1</code> → 输出 <code>then1</code></li>
<li><code>microtask</code> → 输出 <code>microtask</code></li>
<li><code>then3</code> → 输出 <code>then3</code></li>
</ol>
<p>示例二微任务顺序：</p>
<ol>
<li><code>async1 end</code> → 输出 <code>async1 end</code></li>
<li><code>promise2</code> → 输出 <code>promise2</code></li>
</ol>
<h3 data-id="heading-10">第三阶段：宏任务执行（微任务清空后）</h3>
<p>按加入队列的顺序执行宏任务：</p>
<p>示例一：</p>
<ol>
<li>第一个 <code>setTimeout</code> 回调：
<ul>
<li>输出 <code>set!</code></li>
<li>执行 <code>Promise.then</code>，输出 <code>then2</code></li>
<li>内部 <code>Promise.then</code> 加入微任务队列</li>
<li>清空新产生的微任务，输出 <code>then4</code></li>
</ul>
</li>
<li>第二个 <code>setTimeout</code> 回调：输出 <code>set2</code></li>
</ol>
<p>示例二：</p>
<ol>
<li><code>setTimeout</code> 回调：输出 <code>setTimeout</code></li>
</ol>
<h2 data-id="heading-11">💡 关键技术点详解</h2>
<h3 data-id="heading-12">1. Promise执行机制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"构造函数内 - 同步执行"</span>);  <span class="hljs-comment">// 同步代码</span>
  <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"then回调 - 微任务"</span>);      <span class="hljs-comment">// 微任务</span>
});
</code></pre>
<h3 data-id="heading-13">2. async/await本质</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// async/await 写法</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"A"</span>);          <span class="hljs-comment">// 同步执行</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">someFunction</span>();      <span class="hljs-comment">// 同步执行someFunction，后面的代码转为微任务</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"B"</span>);          <span class="hljs-comment">// 微任务</span>
}

<span class="hljs-comment">// 等价 Promise 写法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"A"</span>);          <span class="hljs-comment">// 同步执行</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">someFunction</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"B"</span>);        <span class="hljs-comment">// 微任务</span>
  });
}
</code></pre>
<h3 data-id="heading-14">3. 微任务嵌套执行</h3>
<p>微任务执行期间产生的新的微任务，会在当前事件循环中被执行，不会延迟到下一轮：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"微任务1"</span>);
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"嵌套微任务"</span>);  <span class="hljs-comment">// 会在当前微任务循环中执行</span>
  });
});
</code></pre>
<h2 data-id="heading-15">🎓 记忆口诀</h2>
<pre><code class="hljs language-csharp" lang="csharp">同步先行微随后，
宏任务在最后头。
<span class="hljs-keyword">await</span>前是同步走，
<span class="hljs-keyword">await</span>后微任务留。
微任务清空才宏任务，
新微任务，继续跟。
</code></pre>
<h2 data-id="heading-16">📊 事件循环流程图</h2>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────┐
│     同步代码执行栈        │ ← 立即执行
└─────────────────────────┘
           ↓
┌─────────────────────────┐
│       微任务队列          │ ← 完全清空（包括嵌套）
│   • <span class="hljs-title class_">Promise</span>.<span class="hljs-property">then</span>        │
│   • <span class="hljs-keyword">await</span>后的代码        │
│   • queueMicrotask      │
└─────────────────────────┘
           ↓
┌─────────────────────────┐
│       宏任务队列          │ ← 按序执行
│   • <span class="hljs-built_in">setTimeout</span>/<span class="hljs-built_in">setInterval</span>│
│   • I/O回调              │
│   • <span class="hljs-variable constant_">UI</span>渲染              │
└─────────────────────────┘
           ↓
        循环执行
</code></pre>
<h2 data-id="heading-17">🏆 面试要点总结</h2>
<ol>
<li><strong>同步代码永远最先执行</strong></li>
<li><strong>微任务在同步代码之后、宏任务之前执行</strong></li>
<li><strong>async函数中，await前的代码同步执行</strong></li>
<li><strong>await后的代码作为微任务执行</strong></li>
<li><strong>Promise构造函数是同步的，只有.then()才是微任务</strong></li>
<li><strong>微任务队列必须完全清空后才执行宏任务</strong></li>
<li><strong>微任务执行期间产生的新微任务会立即加入当前队列</strong></li>
<li><strong>多个微任务按入队顺序执行</strong></li>
<li><strong>宏任务按事件循环顺序执行</strong></li>
</ol>
<h2 data-id="heading-18">📚 扩展知识</h2>
<h3 data-id="heading-19">复杂场景分析</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">nestedAsync</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"A"</span>);              <span class="hljs-comment">// 同步</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"B"</span>);              <span class="hljs-comment">// 微任务1</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"C"</span>);              <span class="hljs-comment">// 微任务2（在微任务1中产生）</span>
}
<span class="hljs-comment">// 输出: A → B → C（每个await后都是新的微任务）</span>
</code></pre>
<h3 data-id="heading-20">浏览器与Node.js差异</h3>
<ul>
<li>Node.js中有<code>process.nextTick</code>，优先级高于Promise微任务</li>
<li>Node.js的<code>setImmediate</code>和<code>setTimeout</code>执行时机有所不同</li>
</ul>
<h3 data-id="heading-21">性能考虑</h3>
<ul>
<li>避免在微任务中执行耗时操作，会阻塞UI渲染</li>
<li>合理拆分任务，避免长时间占用事件循环</li>
</ul>
<p>掌握这些核心概念，你就能准确预测任何JavaScript异步代码的执行顺序，这是前端面试中的高频考点，也是编写可靠异步代码的基础！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[社区共创｜TRAE 一周年许愿地图开发细节全揭秘]]></title>    <link>https://juejin.cn/post/7599634796583829510</link>    <guid>https://juejin.cn/post/7599634796583829510</guid>    <pubDate>2026-01-27T09:26:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599634796583829510" data-draft-id="7599579865609388074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="社区共创｜TRAE 一周年许愿地图开发细节全揭秘"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-27T09:26:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            社区共创｜TRAE 一周年许愿地图开发细节全揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:26:04.000Z" title="Tue Jan 27 2026 09:26:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69dae43525764e128cc72604d2c4e5cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=Xprrsu13vvRX65%2F7qnA84nCll8o%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>作者：茉卷，TRAE 开发者用户</p>
</blockquote>
<p><strong>一群社区伙伴</strong>，如何从零到一，为 TRAE 开发一个线上周年庆项目？当你要同时扮演产品经理、设计师和开发者的角色，如何保证项目不失控？</p>
<p>本文记录了社区伙伴们使用 TRAE ，将“周年庆活动”这个想法，一步步变为高质量交付的线上产品的全过程。你将看到一个可复制的实践路径：从需求分析、技术选型，到文档生成、编码实现，再到社区协作与迭代。</p>
<p>这不仅是一份个人项目交付指南，也是一次关于“社区共创”的生动诠释。</p>
<blockquote>
<p>点击链接即可进入网页：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftraebirth.kingzeus.space%2F" target="_blank" title="https://traebirth.kingzeus.space/" ref="nofollow noopener noreferrer">traebirth.kingzeus.space/</a></p>
</blockquote>
<h2 data-id="heading-0"><strong>一切始于一个社区想法</strong></h2>
<p>一切始于 TRAE 周年庆前夕的一次社区征集。当“设计一个活动页面”的想法最终要落地为“周年庆正式项目”时，挑战随之而来。</p>
<p>为把这份“来自社区的生日礼物”按期交付，我和几位社区伙伴一起共创。我在项目中同时承担项目经理、UI 设计、前端开发、联调测试等角色，并用 TRAE 贯穿全过程：从文档生成、任务拆解，到基线代码生成、多人协作、缺陷定位与修复。</p>
<p><strong>全程开发使用的是 TRAE国际版 IDE 和 SOLO 模式，主力模型为 GPT-5.2 和 Gemini-3-Pro，从想法到最终网页上线，用时一周，成品如下图：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbc75bd3d8454dbca12db4973a422842~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=qjmHuR5SywhokvDz%2B%2Fk8gdGyvYU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0743fab371cf40aab53234aaab17d801~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=%2FQHFzLgApoZriZagzHqIanL21k0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>第一步：从想法，到清晰需求</strong></h2>
<p>周年庆的目标是“做一个能让用户参与、愿意分享的小项目”。</p>
<p>我首先将这个笼统的目标拆解为三个需要具体解决的问题：</p>
<ul>
<li>
<p><strong>参与路径问题：</strong> 周年节点需要一个统一入口，让用户“看见就能参与”，路径越短越好。</p>
</li>
<li>
<p><strong>氛围与仪式感问题：</strong> 只有列表会很平淡，地图能天然制造“点亮世界”的仪式感与参与反馈（每一条心愿都对应一个地点被点亮，越多人参与越直观）。</p>
</li>
<li>
<p><strong>互动与传播问题：</strong> 用户希望自己的内容被看见、被回应；活动需要自然传播抓手，例如点赞和分享链接。</p>
</li>
</ul>
<p>为了系统性地梳理需求，我习惯于在项目开始时强制自己回答“灵魂 4 问”，并把这一步交给 TRAE 做第一轮头脑风暴，然后由我进行裁剪与定稿：</p>
<blockquote>
<ol>
<li>系统要解决什么问题？</li>
<li>包含哪些核心功能？</li>
<li>输入输出是什么？</li>
<li>依赖哪些组件与数据？</li>
</ol>
</blockquote>
<p>我向 TRAE 的自定义智能体“创意引导师”下达指令，让它围绕这四个问题进行分析。下图是 TRAE 生成的部分初步构想：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0420617cc3b94b3e91184d2f272ca35f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=iOEeLrImdu3KGZBm7jj7bJ2tZmA%3D" alt="截屏2026-01-27 16.41.11.png" loading="lazy"/></p>
<p>经过多轮讨论和我的裁剪，最终得出以下结论：</p>
<h3 data-id="heading-2"><strong>价值主张</strong></h3>
<ul>
<li>
<p>把分散的“周年祝福”聚合成一个可视化的共同记忆（地图点亮 + 热力聚合）。</p>
</li>
<li>
<p>让用户在短路径内完成参与，并获得即时反馈（提交成功动效、实时弹幕、点赞增长）。</p>
</li>
<li>
<p>让内容具备可传播性（分享链接可打开特定心愿）。</p>
</li>
</ul>
<h3 data-id="heading-3"><strong>业务边界</strong></h3>
<ul>
<li>
<p>心愿提交依赖浏览器定位：用户授权后提交，经纬度写入数据库，省份由坐标推断。</p>
</li>
<li>
<p>心愿提交需要向用户申请位置信息，用户同意后才能提交愿望</p>
</li>
<li>
<p>点赞有防重复：前端本地去重 + 后端/数据库指纹去重，重复点赞返回错误。</p>
</li>
<li>
<p>点亮计数按 IP 限制：同一 IP 只能“点亮”一次。</p>
</li>
</ul>
<h3 data-id="heading-4"><strong>附灵魂 4 问</strong></h3>
<h4 data-id="heading-5"><strong>1. 系统要解决什么问题？</strong></h4>
<ul>
<li>
<p><strong>参与路径问题：</strong> 需要一个统一入口，让用户“快速参与”。</p>
</li>
<li>
<p><strong>可视化与氛围问题：</strong> 需要UI组件（地图 + 点亮 + 弹幕）来放大参与感。</p>
</li>
<li>
<p><strong>互动与传播问题：</strong> 用户希望自己的内容被看见、被反馈；活动需要自然传播抓手（点赞、分享链接）。</p>
</li>
<li>
<p><strong>治理与可控问题：</strong> 匿名参与不可避免带来内容风险，因此必须具备审核与快速处置能力。</p>
</li>
</ul>
<h4 data-id="heading-6"><strong>2. 包含哪些核心功能？</strong></h4>
<p><strong>用户侧</strong></p>
<p><strong>沉浸式开场：</strong> 现有一个动画，之后进入主界面</p>
<p><strong>地图交互与展示：</strong></p>
<ul>
<li>MapLibre 地图（暗色风格）呈现；</li>
<li>心愿点位渲染、聚合与热力图层；</li>
<li>点击点位打开心愿详情</li>
</ul>
<p><strong>提交心愿：</strong></p>
<ul>
<li>用户可以输入内容与署名，选择本地头像；</li>
<li>提交前要求同意“定位使用说明”并开启定位权限；</li>
<li>由定位获得经纬度，并写入数据库</li>
</ul>
<p><strong>实时氛围：</strong></p>
<ul>
<li>弹幕展示最新心愿</li>
</ul>
<p><strong>点赞互动：</strong></p>
<ul>
<li>后端数据库 按照IP设置点赞</li>
</ul>
<p><strong>分享：</strong></p>
<ul>
<li>为单条心愿生成 可传播链接；</li>
<li>分享页打开后可直接点赞</li>
</ul>
<p><strong>心愿榜：</strong> 按地区聚合，展示总点赞/心愿数排行</p>
<h4 data-id="heading-7"><strong>3. 输入输出是什么？</strong></h4>
<p><strong>核心输入（用户侧）</strong></p>
<ul>
<li>
<p><strong>内容输入：</strong> 心愿内容 <code>content</code>、署名 <code>author</code>、头像引用 <code>avatar_url</code>。</p>
</li>
<li>
<p><strong>定位输入：</strong> 浏览器  返回 <code>latitude</code> / <code>longitude</code>。</p>
</li>
<li>
<p><strong>互动输入：</strong> 点赞（wishId）、分享（wishId）。</p>
</li>
<li>
<p><strong>隐私/授权输入：</strong> 是否同意定位说明 + 是否授予定位权限。</p>
</li>
</ul>
<p><strong>核心输出（用户侧）</strong></p>
<ul>
<li>
<p><strong>地图层：</strong> 点位、聚合、热力层；可从列表/弹窗聚焦到某个点位。</p>
</li>
<li>
<p><strong>心愿卡片/详情：</strong> 作者、头像、内容、点赞数、时间等。</p>
</li>
<li>
<p><strong>实时氛围：</strong> 弹幕。</p>
</li>
<li>
<p><strong>分享链接：</strong> 可打开指定心愿。</p>
</li>
<li>
<p><strong>点亮编号：</strong> 提交成功后返回全站点亮计数。</p>
</li>
</ul>
<p><strong>API 输入输出（面向系统）</strong></p>
<p>主要接口：</p>
<ul>
<li>
<p><em><strong>POST /wishes</strong></em>：提交心愿（含经纬度、province_id 等）</p>
</li>
<li>
<p>**<em>GET /wishes?limit=...</em> **：拉取已审核心愿</p>
</li>
<li>
<p><em><strong>POST /wishes/{id}/like</strong></em>：点赞（返回最新 likes）</p>
</li>
<li>
<p><em><strong>GET /leaderboard</strong></em>：省份榜</p>
</li>
<li>
<p><em><strong>GET /counter</strong></em>、<em><strong>POST /counter/increment</strong></em>、<em><strong>GET /counter/check-ip</strong></em>：点亮计数 + IP 限制</p>
</li>
<li>
<p><em><strong>POST /shares</strong></em>、**<em>GET /shares/{token}</em> **：分享 token 生成与解析</p>
</li>
<li>
<p>**<em>GET /sse/wishes：</em> **SSE 实时推送</p>
</li>
</ul>
<p><strong>数据库输入输出（核心数据模型）</strong></p>
<p>主表为 <em><strong>public.users</strong></em>（语义上承载“心愿”记录）：</p>
<ul>
<li>
<p><em><strong>id（uuid）</strong></em></p>
</li>
<li>
<p><em><strong>content</strong></em></p>
</li>
<li>
<p><em><strong>author</strong></em></p>
</li>
<li>
<p><em><strong>avatar_url</strong></em></p>
</li>
<li>
<p><em><strong>province_id</strong></em></p>
</li>
<li>
<p><em><strong>location</strong></em></p>
</li>
<li>
<p><em><strong>likes</strong></em></p>
</li>
<li>
<p><em><strong>status</strong></em></p>
</li>
<li>
<p><em><strong>created_at</strong></em></p>
</li>
</ul>
<h4 data-id="heading-8"><strong>4. 依赖哪些组件与数据？</strong></h4>
<p>我在选型时关注的是“快速落地 + 生态成熟 + 可控成本”。</p>
<p><strong>地图：MapLibre GL JS</strong></p>
<ul>
<li>原因：API 成熟、渲染能力强、社区资源多；对“点位 + 聚合 + 交互”非常贴合。</li>
</ul>
<p><strong>前端框架：React + TypeScript</strong></p>
<ul>
<li>原因：页面型项目交付速度快；路由与 API Routes 方便快速搭建接口层。</li>
</ul>
<p><strong>数据库：Supabase</strong></p>
<ul>
<li>原因：TRAE SOLO 可以直接连接，开发非常方便。</li>
</ul>
<p><strong>部署：Vercel</strong></p>
<ul>
<li>原因：TRAE SOLO 一键部署，方便快速展示成果。</li>
</ul>
<blockquote>
<p><strong>实践总结：用 TRAE 加速需求探索</strong></p>
<p>将行业通用的分析框架（如“灵魂四问”）作为 Prompt 的一部分，让 TRAE 扮演“需求分析师”的角色，可以快速产出结构化的思考框架，帮助你理清思路，为后续的设计与开发奠定坚实基础。</p>
<ul>
<li><strong>TRAE 使用细节：</strong> TRAE 国际版 IDE模式，自定义智能体 +GPT-5.2 模型</li>
<li>附头脑风暴自定义智能体分享链接，大家可导入使用：我用 TRAE 做了一个有意思的Agent 「创意引导师」。 点击 <a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.ai%2Fa%2F835bc7%3Fregion%3Dsg" target="_blank" title="https://s.trae.ai/a/835bc7?region=sg" ref="nofollow noopener noreferrer">s.trae.ai/a/835bc7?re…</a> 立即复刻，一起来玩吧！</li>
</ul>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f244d09738d41d1b25259409643c4fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=1YQRLfUkdgWDV8wjMbmuCb8Y%2FNk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>第二步：从需求，到可执行的技术方案</strong></h2>
<p>有了清晰的需求，下一步是将其转化为结构化的技术文档。在过去，这通常需要耗费大量时间编写 PRD 和技术设计文档。但借助 TRAE ，这个过程可以被极大地加速。</p>
<p>我为 TRAE 准备了三个核心的 Prompt，分别用于生成<strong>需求文档（PRD）</strong> 、技术文档和任务列表。这些 Prompt 不仅仅是简单的指令，更是一套标准化的“模板”，规定了文档的结构、编写规范和技术栈要求等。</p>
<p><strong>生成项目需求提示词</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">请为 [项目名称] 生成一份完整的需求文档，遵循以下规范：

<span class="hljs-strong">**文档结构要求：**</span>
<span class="hljs-bullet">1.</span> Introduction - 项目概述和背景
<span class="hljs-bullet">2.</span> Glossary - 定义所有关键术语和系统名称
<span class="hljs-bullet">3.</span> Requirements - 详细的需求列表

<span class="hljs-strong">**需求编写规范：**</span>
<span class="hljs-bullet">-</span> 每个需求必须包含 User Story（用户故事）
<span class="hljs-bullet">-</span> 每个需求必须包含 Acceptance Criteria（验收标准）
<span class="hljs-bullet">-</span> 所有验收标准必须使用 EARS 模式之一：
<span class="hljs-bullet">  *</span> Ubiquitous: THE <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">system</span>&gt;</span></span> SHALL <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">response</span>&gt;</span></span>
<span class="hljs-bullet">  *</span> Event-driven: WHEN <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">trigger</span>&gt;</span></span>, THE <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">system</span>&gt;</span></span> SHALL <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">response</span>&gt;</span></span>
<span class="hljs-bullet">  *</span> State-driven: WHILE <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">condition</span>&gt;</span></span>, THE <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">system</span>&gt;</span></span> SHALL <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">response</span>&gt;</span></span>
<span class="hljs-bullet">  *</span> Unwanted event: IF <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">condition</span>&gt;</span></span>, THEN THE <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">system</span>&gt;</span></span> SHALL <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">response</span>&gt;</span></span>
<span class="hljs-bullet">  *</span> Optional feature: WHERE <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">option</span>&gt;</span></span>, THE <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">system</span>&gt;</span></span> SHALL <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">response</span>&gt;</span></span>
<span class="hljs-bullet">  *</span> Complex: [WHERE] [WHILE] [WHEN/IF] THE <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">system</span>&gt;</span></span> SHALL <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">response</span>&gt;</span></span>

<span class="hljs-strong">**质量标准：**</span>
<span class="hljs-bullet">-</span> 使用主动语态，明确说明谁做什么
<span class="hljs-bullet">-</span> 避免模糊术语（如"快速"、"合理"、"用户友好"）
<span class="hljs-bullet">-</span> 不使用代词，使用 Glossary 中定义的具体术语
<span class="hljs-bullet">-</span> 每个标准必须可测试和可验证
<span class="hljs-bullet">-</span> 使用正面陈述（说明系统应该做什么，而非不应该做什么）
<span class="hljs-bullet">-</span> 避免逃避条款（如"在可能的情况下"、"如果可行"）

<span class="hljs-strong">**项目背景：**</span>
[在此描述你的项目想法、目标用户、核心功能等]

请生成符合上述规范的需求文档。
</code></pre>
<p><strong>生写项目技术文档提示词</strong></p>
<p><strong>上下滑动查看完整内容</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">请基于以下需求文档为 [项目名称] 生成一份完整的技术设计文档：

<span class="hljs-strong">**需求文档路径：**</span> [需求文档的路径或内容]

<span class="hljs-strong">**文档结构要求：**</span>
<span class="hljs-bullet">1.</span> Overview - 系统概述、核心功能、技术栈选择
<span class="hljs-bullet">2.</span> Architecture - 系统架构图（使用 Mermaid）、请求流程图
<span class="hljs-bullet">3.</span> Components and Interfaces - 各组件的职责、接口定义、实现要点
<span class="hljs-bullet">4.</span> Data Models - 数据库 Schema、Pydantic/数据模型定义
<span class="hljs-bullet">5.</span> Correctness Properties - 可测试的正确性属性
<span class="hljs-bullet">6.</span> Error Handling - 错误处理策略、错误码定义、日志策略
<span class="hljs-bullet">7.</span> Testing Strategy - 单元测试和属性测试策略

<span class="hljs-strong">**技术栈要求：**</span>
<span class="hljs-bullet">-</span> 编程语言：[指定语言，如 Python/TypeScript/Java]
<span class="hljs-bullet">-</span> Web 框架：[如 FastAPI/Express/Spring Boot]
<span class="hljs-bullet">-</span> 数据库：[如 PostgreSQL/MongoDB/MySQL]
<span class="hljs-bullet">-</span> 缓存/队列：[如 Redis/RabbitMQ]
<span class="hljs-bullet">-</span> 其他技术：[根据需求指定]

<span class="hljs-strong">**Correctness Properties 要求：**</span>
<span class="hljs-bullet">-</span> 在编写 Correctness Properties 之前，必须先完成 prework 分析
<span class="hljs-bullet">-</span> 每个属性必须以 "For any" 或 "For all" 开头（通用量化）
<span class="hljs-bullet">-</span> 每个属性必须标注验证的需求编号： <span class="hljs-strong">**Validates: Requirements X.Y**</span>
<span class="hljs-bullet">-</span> 属性应覆盖所有可测试的验收标准
<span class="hljs-bullet">-</span> 消除冗余属性，确保每个属性提供独特的验证价值

<span class="hljs-strong">**测试策略要求：**</span>
<span class="hljs-bullet">-</span> 明确单元测试和属性测试的互补关系
<span class="hljs-bullet">-</span> 指定属性测试库（如 Hypothesis/fast-check/QuickCheck）
<span class="hljs-bullet">-</span> 每个属性测试至少运行 100 次迭代
<span class="hljs-bullet">-</span> 每个测试必须标注对应的设计属性编号

请生成符合上述规范的技术设计文档。
</code></pre>
<p><strong>生成项目任务列表提示词</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">请基于以下需求文档和设计文档为 [项目名称] 生成一份完整的实现任务列表：

<span class="hljs-strong">**需求文档路径：**</span> [需求文档的路径]
<span class="hljs-strong">**设计文档路径：**</span> [设计文档的路径]

<span class="hljs-strong">**实现语言：**</span> [Python/TypeScript/Java 等]

<span class="hljs-strong">**任务列表要求：**</span>
<span class="hljs-bullet">1.</span> 将设计转换为离散的编码步骤
<span class="hljs-bullet">2.</span> 每个任务必须是可由代码生成 LLM 执行的具体编码任务
<span class="hljs-bullet">3.</span> 任务必须增量构建，每个任务基于前一个任务
<span class="hljs-bullet">4.</span> 最多两层层级（主任务和子任务）
<span class="hljs-bullet">5.</span> 使用复选框格式：<span class="hljs-code">`- [ ] 任务描述`</span>
<span class="hljs-bullet">6.</span> 子任务使用小数编号：<span class="hljs-code">`- [ ] 1.1 子任务描述`</span>

<span class="hljs-strong">**任务内容要求：**</span>
<span class="hljs-bullet">-</span> 每个任务必须引用具体的需求编号： <span class="hljs-emphasis">_需求: X.Y, X.Z_</span>
<span class="hljs-bullet">-</span> 包含属性测试子任务，标注属性编号和验证的需求
<span class="hljs-bullet">-</span> 测试相关子任务标记为可选（后缀 <span class="hljs-code">`*`</span>）：<span class="hljs-code">`- [ ]* 1.2 编写单元测试`</span>
<span class="hljs-bullet">-</span> 在合理的断点添加检查点任务

<span class="hljs-strong">**禁止的任务类型：**</span>
<span class="hljs-bullet">-</span> 用户验收测试或用户反馈收集
<span class="hljs-bullet">-</span> 部署到生产或预发布环境
<span class="hljs-bullet">-</span> 性能指标收集或分析
<span class="hljs-bullet">-</span> 运行应用进行端到端测试（应使用自动化测试）
<span class="hljs-bullet">-</span> 用户培训或文档创建
<span class="hljs-bullet">-</span> 业务流程或组织变更

<span class="hljs-strong">**任务示例格式：**</span>
<span class="hljs-code">```markdown
- [ ] 1. 实现核心功能
  - [ ] 1.1 实现组件 A
    - 编写核心逻辑实现
    - _需求: X.Y, X.Z_
  - [ ]* 1.2 编写属性测试
    - **Property N: [属性标题]**
    - **Validates: Requirements X.Y**
  - [ ] 1.3 实现组件 B
    - 编写支持逻辑
    - _需求: X.Z_

- [ ] 2. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户。
请生成符合上述规范的实现任务列表。
</span></code></pre>
<h3 data-id="heading-10"><strong>2.1  生成项目文档</strong></h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/019a5df69a8647048992ba57c3f094fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=ynOYAALbgSkAuXH9YgqeXDeYl1Q%3D" alt="" loading="lazy"/></p>
<p>参考上面的提示词，可以给出  1周年项目文档、 1周年项目技术文档、1周年项目任务列表。</p>
<p>我们需要仔细检查这些文档，然后进行优化和裁剪。</p>
<h4 data-id="heading-11"><strong>1周年项目需求文档举例</strong></h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/384138f9d3f247e7bd2039a17c36ca9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=X%2BN%2B0swF%2Bwitr8b%2Fe4oFb78z4Ug%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a37f713875d143078ba22c2017a45efa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=9A2o2S2cDs9sf0g%2B%2Fj1WIQ2M%2Buw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12"><strong>1周年项目技术文档举例</strong></h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95f05f78763e41fa922a8de1f372e347~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=6uFUGWmWzUI%2FB0ZZh0KZxcdTFfY%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/836a0dd9fe224326a06958d1931d4dcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=UxjFlzICiuIfWyplIrLTzbuAmis%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-13"><strong>1周年项目任务列表举例</strong></h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f4fd1d138ff44eda0a4c7dfc704e557~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=11ylNbxPtuCymZ8sgcG1ElMGNHI%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6252084ccf0482683c66814a880afbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=7v2CrfqARdzsk4F7%2FANCtZwixHE%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>实践总结：通过 TRAE 将繁琐的文档工作半自动化：</strong></p>
<ul>
<li><strong>保证规范性：</strong> 通过 Prompt 预设模板，确保每份文档都遵循统一的、业界认可的最佳实践</li>
<li><strong>提升效率：</strong> AI 可以快速完成文档的框架搭建和细节填充，将我从重复的写作中解放出来，专注于关键决策的思考和评审</li>
<li><strong>确保一致性：</strong> 从需求、设计到最终的任务拆解，所有文档都基于同一份输入，保证了信息在传递过程中不失真、不遗漏</li>
<li><strong>TRAE 使用细节：</strong> TRAE 国际版 IDE模式+GPT-5.2 模型</li>
</ul>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b203237a8d54018811c4b73631d9ac3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=dbZdTnhWnhD9jKJ5%2FCrKQqYtZro%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14"><strong>第三步：用 TRAE 编码、协作与迭代（社区共创实践）</strong></h2>
<p>文档就位后，开发工作正式开始。这个过程同样深度融合了社区共创与 TRAE 辅助。</p>
<h3 data-id="heading-15"><strong>3.1 基线代码生成：用 TRAE 搭出第一个可用版本</strong></h3>
<p>为了快速验证核心方案，我需要先创建一个能够展示主页功能的地图页面。我向 TRAE 提供了此前生成的全部文档，并给出了具体指令：</p>
<pre><code class="hljs language-markdown" lang="markdown">TRAE 马上迎来 1 周年，我们想在这个节点做一个比较有参与感的小项目：TRAE 一周年许愿地图。
设想是做一个前端页面，用户可以选择自己的省份（中国地图）留下愿望，也可以点开查看其他人的留言，并进行点赞互动。

你是资深前端工程师（TypeScript + React/Next.js）。请严格引用并对齐以下三份文档中的要求，生成一个“带地图的最小展示页面（MVP）”，用于演示地图浏览与点选查看心愿信息。输出必须是可直接落地的代码（文件结构 + 每个文件完整内容），不要输出解释性文字，不要添加任何注释。

引用来源（必须在实现中体现）
1) 任务列表：1周年项目任务列表.md
<span class="hljs-bullet"> -</span> 对齐任务：12.1/12.2/12.3/12.4（地图容器、聚合阈值切换、点选信息展示、移动端适配）

2) 需求文档：1周年项目需求文档.md
<span class="hljs-bullet"> -</span> R-02 地图浏览与交互：地图可交互；zoom 阈值以下显示聚合 markers；阈值以上显示单点；点选展示关联心愿信息
<span class="hljs-bullet"> -</span> R-23 性能要求：低 zoom 使用聚合/聚类（本 MVP 用阈值切换模拟即可）
<span class="hljs-bullet"> -</span> R-24 兼容性与可访问性：移动端布局；键盘可达（至少关闭详情面板可用键盘操作）
3) 技术文档：1周年项目技术文档.md
<span class="hljs-bullet"> -</span> 地图使用 MapLibre GL JS
<span class="hljs-bullet"> -</span> 与“/api/map/points?bbox=&amp;zoom=”接口契约保持一致

MVP 范围（最小可展示）
<span class="hljs-bullet">-</span> 单个页面：MapPage（Next.js 页面或 React 路由页均可，但默认按 Next.js 实现）
<span class="hljs-bullet">-</span> 地图能加载并可缩放/拖拽
<span class="hljs-bullet">-</span> 可访问性：
<span class="hljs-bullet">-</span> 详情面板有“关闭”按钮，支持 Enter/Space 触发；按 Escape 关闭
<span class="hljs-bullet">-</span> 移动端：
<span class="hljs-bullet">-</span> 页面高度自适应；详情面板在窄屏改为底部抽屉（或全屏 modal）


输出要求
1) 先输出文件结构清单（相对路径）
2) 再逐个文件输出完整代码（包含 package.json、next.config.<span class="hljs-emphasis">*、pages 或 app 路由文件、地图页组件、最小数据层、样式文件）
3) 代码必须可运行：给出 npm scripts：dev/build/start
4) 不要写任何“如何运行”的说明文字（只通过 package.json scripts 体现即可）
</span></code></pre>
<p><strong>简单迭代之后，第一个地图版本形成了</strong>，但我注意到提示词中缺少对页面风格的约束和创意，于是我使用 Gemini 3 Pro 200K, 补充了新的指令，让 TRAE 参考 国际版官方风格，同时上传了一张 TRAE 官网截图作为参考，让它基于现有代码修改。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85495ddee53f4a5fbb41d92ada2939dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=OXi95AmyXt%2FZxtvl4CGKCcRz1aM%3D" alt="" loading="lazy"/></p>
<p>经过多轮迭代优化，一个功能完整、风格统一的地图页面便完成了。</p>
<p>前端直接与 Supase 数据库直连，用户可以添加消息到数据库，地图上可以显示用户的留言。</p>
<p>使用 SOLO 中的  Supabae （数据库） 和  Vercel 部署</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6888575d3664e6bae9b8135dfd26f69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=kyGxnyzvvZs1SZ6T3H2cUGSDgWs%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>实践总结：</strong></p>
<p>让 TRAE 生成代码时，务必提供完整的上下文，包括需求文档、技术设计和任务列表。信息越完备，生成的基线代码质量越高，越接近最终目标。</p>
</blockquote>
<h3 data-id="heading-16"><strong>3.2 社区共创：从“使用者”到“共创者”</strong></h3>
<h4 data-id="heading-17"><strong>3.2.1 社区需求收集、任务分配</strong></h4>
<p>基线版本得到了 TRAE 官方同学的认可。于是，我们以此为基础，开始聚集社区里感兴趣的小伙伴进行功能扩展。大家通过线上讨论提出了很多优化方案，我负责收集、确认需求，并分配给参与项目的同学。</p>
<p>期间，通过私聊、多人线上讨论等方式，将需求落地。（部分需求举例）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/226a220e4e284d6687840f403caa9551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=HAqHjKAenFo9tS1174mIVEwD1d0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18"><strong>3.2.2  社区开源项目多人协作模式</strong></h4>
<p>大家通过 Fork 在各自仓库里独立开发，完成后向主仓库发起 PR。我在 PR 中做简单的代码审查，并要求通过基础检查后再合并。这样既能让多人并行开发，也能保证主干分支始终保持可用、稳定的版本。</p>
<blockquote>
<p><strong>所有人 Fork 主仓库独立开发：</strong> 避免互相阻塞，减少冲突。</p>
<p><strong>通过 PR 合并回主干：</strong> 每个 PR 都必须能跑通基础检查，主干始终保持可用。</p>
</blockquote>
<p>在这个过程中，大家也使用 TRAE 来辅助提交代码，自动生成规范的 Commit Message。</p>
<p><strong>通过 TRAE 提交代码</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/068638e53a5c46969f132c861bb8b91f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=cPNvLpo544pG8dBljPimExW1SLc%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3394118135fa49908bf7905219abc4bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=3OCiPYYj9Vmyhj1CjKpHWw8B2wY%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea17bc97b32b4cffb4835d2cf0d60a64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=DDhh0h4A6u2D0nUZwfn6Sckn2Yk%3D" alt="" loading="lazy"/></p>
<p><strong>通过PR合并代码到主干</strong></p>
<p>社区伙伴们各自开发，然后通过PR合并到开发主干。（部分PR举例）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cba2df74bbbb499d8717f1988b2a3139~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=FfuZJsBkhDKmLPIv8AG45qZynxk%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>实践总结：</strong></p>
<p>在社区协作中，标准化的流程（如 Fork &amp; PR）和工具（如 TRAE 辅助代码提交）是保持高效和高质量的关键。它能让每个人的贡献都清晰、可追溯。</p>
</blockquote>
<h3 data-id="heading-19"><strong>3.3 增量开发与迭代：让文档和代码形成闭环</strong></h3>
<p>在增加新功能时，我们依然遵循“文档先行”的原则，并利用 TRAE 让文档与代码保持同步。例如，当需要增加新需求时，我们会：</p>
<ol>
<li>
<p>让 TRAE 阅读现有代码和新需求，生成一份实现方案文档。</p>
</li>
<li>
<p>团队评审并确定最优方案。</p>
</li>
<li>
<p>让 TRAE 根据最终方案生成代码。</p>
</li>
<li>
<p>代码实现后，再由 TRAE 提交，完成闭环。</p>
</li>
</ol>
<p>我们可以让TRAE先根据需求，阅读代码，然后生成一个实现文档</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b4b3c1597c64aeea003bd7567a1d03b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=KbwkCfepw9f5yi0ZLBx7%2Fdo9x0k%3D" alt="" loading="lazy"/></p>
<p>TRAE 生成的任务文档</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b40404e3430644f9a9015827787cabc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=Vc10HjjV2cWWnsLYlWs%2FYaoSW18%3D" alt="" loading="lazy"/></p>
<p>仔细阅读上面的文档，然后选择一个最优的方案让TRAE实现</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55c39c527daa436e84ca38b608e7a86d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=yxX9A0lOFdM6yN2HIkyfpFnnUFY%3D" alt="" loading="lazy"/></p>
<p>需求实现之后，让 TRAE提交代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d68fd0a792045529c31f9f9ee445f41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=r1gEr%2BoQRam6rWHpYSqYBqCZnwI%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3324e4dd23c440b9b417ce07eacd41a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=K%2BcX%2F1DPIVnCTJRYOBwsOqvHgjc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-20"><strong>3.4 用 TRAE 解决BUG</strong></h3>
<p>项目中，会遇到各种问题，推荐的解决步骤：</p>
<ol>
<li>
<p>让 TRAE 先分析问题，给出一个问题分析文档和推荐的修改方案。</p>
</li>
<li>
<p>我们review 问题的 Root Cause 和 修改建议。</p>
</li>
<li>
<p>确认方案后，让 TRAE 基于分析文档修改代码。</p>
</li>
</ol>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2c482b5a4484a51a72d013fe5fdff84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=Rr4OzuJlzWHiQ8GZf4S1S1htZLA%3D" alt="" loading="lazy"/>图：TRAE 生成的问题分析文档节选</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee7375bb17154c52b2b381cf6e2bdf85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110764&amp;x-signature=eJvU4SigPAIBXRKAGq0rmCxvUkM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-21"><strong>写在最后</strong></h2>
<p>从一个模糊的想法，到最终上线的一份完整作品：这次经历不仅是技术上的实践，更是一次身份的转变——从产品的使用者，到价值的共创者。</p>
<p>在需要频繁切换视角、同时推进多项工作的情况下，<strong>TRAE 更像一个稳定可靠的搭档</strong>：帮我理清需求、输出文档、快速推进实现，也在反复调试和修改中节省了大量时间，让整个共创过程始终保持在可控的节奏里。</p>
<p>这次实践也证明了，在开放的社区中，每一位成员都有机会发起、组织并交付一个有价值的项目。如果你也有好的想法，不妨现在就开始，<strong>借助 TRAE 将创意快速变为现实。</strong></p>
<p>期待在社区里，看到更多伙伴发起和完成属于自己的共创项目。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Skills 实战】AI 编程的下半场：别让 AI 写的代码只活在 localhost 里]]></title>    <link>https://juejin.cn/post/7599630795805016110</link>    <guid>https://juejin.cn/post/7599630795805016110</guid>    <pubDate>2026-01-27T08:45:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599630795805016110" data-draft-id="7599850148055662601" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Skills 实战】AI 编程的下半场：别让 AI 写的代码只活在 localhost 里"/> <meta itemprop="keywords" content="Agent,Claude,AIGC"/> <meta itemprop="datePublished" content="2026-01-27T08:45:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="binggg"/> <meta itemprop="url" content="https://juejin.cn/user/1609340751972270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Skills 实战】AI 编程的下半场：别让 AI 写的代码只活在 localhost 里
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1609340751972270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    binggg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T08:45:55.000Z" title="Tue Jan 27 2026 08:45:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d823bb5661e41c08da23e1e7174a837~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=2y4n1f88GO6Zp3aRNlvZh5stVes%3D" alt="企业微信20260127-164344@2x.png" loading="lazy"/></p>
<h2 data-id="heading-0">AI 编程的下半场：别让 AI 写的代码只活在 localhost 里</h2>
<blockquote>
<p>如何把 8 年云端经验装进你的 AI 开发工具，让AI从"实习生"变成"持证上岗的专家"。分享如何用 Agent Skill 解决 AI Coding 领域的痛点问题，也分享如何解决 AI 不调用 Skill 等实践技巧</p>
</blockquote>
<p><strong>【推荐语】</strong></p>
<p>最近我们在折腾 Agent Skills，想把云开发（CloudBase）这些年攒下的经验打包给 AI。实战下来发现，最折磨人的不是 AI 不会写代码，而是它写的代码**“只能活在本地”<strong>，以及它</strong>“总是不听规矩”**。</p>
<p>这篇文章主要分享两点实操复盘，希望能帮大家少走点弯路：</p>
<ol>
<li><strong>让 AI 生成的代码能直接上线</strong>：大家可能都遇到过，AI 写的代码 Demo 感十足，但一上线就全是安全隐患。我们尝试给 AI 注入底座感知，让它学会用底座原生认证代替脆弱的传参，用安全规则代替接口“裸奔”，解决代码“死在本地”的尴尬。</li>
<li><strong>解决“AI 有 Skill 却不爱用”的毛病</strong>：最让人头疼的是，明明配好了 Skills，AI 却视而不见，非要凭直觉盲干。我们会分享如何通过“总纲+插件”的结构，配合简单的工程拦截，把 AI 的技能激活率从 20% 硬拉到 84%。</li>
</ol>
<p>希望能给同样在研究 Skills 和 AI 开发的朋友一点参考，让 AI 交付的代码不再只是“看着挺美”，而是真正稳健。</p>
<hr/>
<h3 data-id="heading-1">现状：Vibe Coding 的 "本地舒适区"</h3>
<p>最近，开发者都在享受 <strong>Vibe Coding</strong> 的快感。在用户本地的 <code>localhost</code> 一顿操作，UI 漂亮得像成品，但魔法往往在“上线”瞬间戛然而止。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/853f8904b7b3487382597a1990a36e96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=q8%2BRiwkok98n08T3sC6hzPhtvnc%3D" alt="" loading="lazy"/></p>
<p>AI 的代码逻辑还不错，但它无法感知真实的后端底座，导致生成的“局部最优解”难以落地，无法简单的生成生产级可用的应用。</p>
<p><strong>世界上最遥远的距离，是从 <code>localhost</code> 到真实访问的距离。</strong> AI 填补了代码量的空白，却填补不了工程底座的断层。</p>
<p>有什么办法可以解决这个问题吗？这里就需要提到 Skills。</p>
<h3 data-id="heading-2">什么是 Skills</h3>
<p>Skills 最早是 Anthropic 在 2025 年 10 月给 Claude Code 加的一个功能，它是一套包含指令、脚本和资源的能力包。<strong>把专业知识、步骤、代码打包成“技能包”</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1ac18a4908c4ece94e592f7e8804dcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=J7stDAtx12bESSt7d7OM83vUDrk%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>Agent Skills 是一种轻量级、开放式的格式，用于通过专业知识和工作流扩展 AI Agent 的能力。</strong></p>
</blockquote>
<p>从本质上讲，一个 Skill 就是一个包含 <code>SKILL.md</code> 文件的文件夹。该文件包含元数据（至少包括 <code>name</code> 和 <code>description</code>）以及告诉 Agent 如何执行特定任务的指令。Skills 还可以捆绑脚本、模板和参考材料。</p>
<pre><code class="hljs language-directory" lang="directory">my-skill/
├── SKILL.md          # 核心：指令 + 元数据
├── scripts/          # 可选：可执行代码
├── references/       # 可选：参考文档
└── assets/           # 可选：模板、资源

</code></pre>
<p>如果把 AI 比作高材生，Skills 就是他的 <strong>“岗位操作手册”。它不改变 AI 的智商，但它通过注入程序性知识</strong>（Procedural Knowledge），让 AI 知道在你的特定环境下，“正确且高效”的操作标准是什么。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a2a07285bb744a39610e4963f0485f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=bLxfK7Oxc2V%2BTSrNls0dKmSfwcg%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2F" title="https://agentskills.io/" target="_blank" ref="nofollow noopener noreferrer">Agent Skill </a>在 2025 年 12 月正式成为开放规范，目前已有包括 Claude、Cursor、VS Code、GitHub Copilot、OpenCode等主流AI开发工具宣布兼容支持。</p>
<h4 data-id="heading-3">Skills 的工作原理：渐进式加载（Progressive Disclosure）</h4>
<p>Skills 通过<strong>渐进式加载</strong>来高效管理上下文（Context），确保 Agent 在拥有强大能力的同时不会因信息过载而变得迟钝：</p>
<ol>
<li><strong>Discovery（发现）</strong>：启动时，Agent 仅加载每个 Skill 的<strong>名称和描述</strong>。这足以让它在处理请求时，判断哪些 Skill 可能与当前任务相关，而不会耗尽上下文窗口。</li>
<li><strong>Activation（激活）</strong>：当任务与某个 Skill 的描述匹配时，Agent 才会按需将该 Skill 的完整 <code>SKILL.md</code> 指令读入当前上下文。</li>
<li><strong>Execution（执行）</strong>：Agent 遵循指令执行任务，并根据需要动态加载引用文件或运行捆绑的脚本代码。</li>
</ol>
<p>这种方法让 Agent 保持极高的响应速度，同时能够像“随身携带百科全书”一样，在需要时立即获取深度专业知识。</p>
<p><strong>行业大佬们已经在行动：</strong></p>
<p><strong>Vercel</strong> 发布了<a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2Fblog%2Fintroducing-react-best-practices" title="https://vercel.com/blog/introducing-react-best-practices" target="_blank" ref="nofollow noopener noreferrer"> <code>react-best-practices</code></a>，解决 AI 乱写 React 导致的性能问题，将 React 专家十余年经验你浓缩为最佳实践。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a29b31a4b66f42b6b3115039d1122888~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=tuQpQYy7%2F8uVAD3gCmTwEh3MNXE%3D" alt="" loading="lazy"/></p>
<p><strong>Remotion</strong> 推出<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FRemotion%2Fstatus%2F2013626968386765291" title="https://x.com/Remotion/status/2013626968386765291" target="_blank" ref="nofollow noopener noreferrer">视频制作 Skill</a>，让 AI 学会用代码"剪辑"视频</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/228ec50192de475ebe7b34fa9c2b4f46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=KBRzu70A38Ld6l6lex%2BPC5VZD7s%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fskills.sh%2F" title="https://skills.sh/" target="_blank" ref="nofollow noopener noreferrer">Vercel 推出了 skills 命令</a>来快速安装 Skills 到各个工具中，这是当前热门的 skills 列表。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db3d6862e16f4aa1bda5dee2695ed3ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=uAD3FMjHDCLkFzWmvQ9uD7HKSBU%3D" alt="" loading="lazy"/></p>
<p>这些 Skills 解决的核心问题是：<strong>让 AI 拥有特定领域的"工程直觉"。</strong></p>
<p>那么，当你的应用需要落地到云端时，谁来给 AI 注入"后端直觉"？</p>
<hr/>
<h3 data-id="heading-4">CloudBase Skills：把 8 年云端经验打包给 AI</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb7d1e78f1704d4d9137a45b4f174336~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=OJ5nD6Neu8gF%2ByDY2c7yRyucbIs%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftcb.cloud.tencent.com%2F" title="https://tcb.cloud.tencent.com/" target="_blank" ref="nofollow noopener noreferrer">云开发 CloudBase</a> 作为自 2018 年起就推出 Serverless 服务的团队，也推出<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencentCloudBase%2FSkills" title="https://github.com/TencentCloudBase/Skills" target="_blank" ref="nofollow noopener noreferrer">CloudBase Skills</a>。</p>
<p><strong>Skills 是软件层面的“岗位手册”，而 CloudBase 则是承载代码落地的“全栈底座”。</strong></p>
<p>许多 AI 生成的代码之所以“死在本地”，是因为 AI 往往只负责写逻辑，却不知道如何对接复杂的生产环境。CloudBase 为 AI 提供了一套高度抽象的基础设施，让 AI 写出的逻辑能无缝运行在公网：</p>
<ul>
<li><strong>全栈托管与部署能力</strong>：支持前端静态网页与后端逻辑的快速部署，让项目从 <code>localhost</code> 真正变成可访问的在线 URL。</li>
<li><strong>多端原生身份认证</strong>：打通了 Web、小程序等多种身份源。AI 无需手写复杂的登录逻辑，通过 Skills 直接调用底座的认证能力，实现秒级接入。</li>
<li><strong>数据库底座</strong>：同时提供文档型（NoSQL）与 SQL 型数据库能力。更重要的是，底座原生集成了面向 C 端的权限控制机制，确保 AI 生成的每一行查询都运行在物理隔离的安全沙箱中，从根源规避越权风险。</li>
</ul>
<p>它将 CloudBase 支撑<strong>日均 10 亿次 API 调用</strong>、服务<strong>超过 330 万开发者</strong>的真实经验，翻译成了 AI 听得懂的指令。</p>
<p>举一些 CloudBase Skills 如何为 AI 注入生产级标准的场景：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/779765422f7540bc8d5d9eadbc9795e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=RzsaARUvHU%2FSvJocxFfKrizVBkg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">场景一：身份认证——拒绝“相信前端输入”</h3>
<h4 data-id="heading-6">错误做法</h4>
<p>习惯于让前端通过 <code>userId</code> 传参给后端。</p>
<ul>
<li><strong>风险</strong>：这是典型的“防君子不防小人”。攻击者只需拦截请求并修改参数，即可实现<strong>横向越权</strong>，访问任何人的私密数据。</li>
</ul>
<h4 data-id="heading-7">正确做法</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1922ca87eaf941d0b3e187f6cd2c50bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=sxJ%2B3Km0mOaBqkcx5BceLwL3PsU%3D" alt="" loading="lazy"/></p>
<p>加载 <code>auth-wechat</code> Skill 后，AI 会被强制要求放弃前端传参，转而利用云底座的<strong>原生链路</strong>。</p>
<ul>
<li><strong>Before (脆弱逻辑)</strong>:</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实习生 AI：相信用户传来的 ID</span>
<span class="hljs-keyword">const</span> { openid } = event.<span class="hljs-property">params</span>; 
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">'users'</span>).<span class="hljs-title function_">doc</span>(openid).<span class="hljs-title function_">get</span>();

</code></pre>
<ul>
<li><strong>After (生产级标准)</strong>:</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 专家 AI：利用底座原生上下文，不可伪造</span>
<span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">OPENID</span> } = cloud.<span class="hljs-title function_">getWXContext</span>(); 
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">'users'</span>).<span class="hljs-title function_">doc</span>(<span class="hljs-variable constant_">OPENID</span>).<span class="hljs-title function_">get</span>();

</code></pre>
<blockquote>
<p><strong>工程准则</strong>：安全性应由底座的<strong>原生互信</strong>保证，而非依赖前端输入的自觉。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">场景二：数据安全——从“接口裸奔”到“行权限”</h3>
<h4 data-id="heading-9">错误做法</h4>
<p>倾向于直接暴露数据库接口。如果你的 API 逻辑稍有疏忽，数据库对攻击者几乎是“裸奔”状态。</p>
<h4 data-id="heading-10">正确做法</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89f2a551bb0b46ed9d35aaee0157d65a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=VczPHljIah5FRPAguryqJCM%2Beyo%3D" alt="" loading="lazy"/></p>
<p>Skill 会引导 AI 将权限校验 <strong>下沉到数据库入口</strong>，直接驱动底座的 <strong>安全规则（Security Rules）</strong>。</p>
<ul>
<li><strong>实现改变</strong>：不再单纯写查询逻辑，而是为集合定义 <code>auth.uid == doc._openid</code> 规则。</li>
<li><strong>价值</strong>：<strong>防御性编程的闭环。</strong> 即使业务逻辑代码出现 Bug，底座依然能从物理层面拦截任何非本人数据的越权修改。</li>
</ul>
<hr/>
<h3 data-id="heading-11">场景三：AI 集成——消灭 Hardcoded，三行代码闭环</h3>
<p>接入大模型是当前最热的需求，但 AI 往往给出的是“Demo 级”的代码，完全忽略了生产环境的安全与高可用要求。</p>
<h4 data-id="heading-12">错误做法</h4>
<p>将 API Key 硬编码在前端，写出一坨混乱的逻辑来处理流式输出（Streaming），既不安全也不稳定。</p>
<h4 data-id="heading-13">正确做法</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00a0d8fb2ff748bca652b150a38dd4c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=hNTZLry1SKwA5irTwTWVvj46f1Y%3D" alt="" loading="lazy"/></p>
<p>Skill 注入了生产级 AI 接入规范，将复杂的封装逻辑简化为底层 SDK 的原生调用。</p>
<ul>
<li><strong>安全加固</strong>：Key 自动托管在云端环境变量，前端实现 <strong>“零泄露”</strong>。</li>
<li><strong>几行代码调用 AI 大模型</strong> ，自动处理流式响应。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// CloudBase Skills 实现的生产级 AI 调用</span>
<span class="hljs-keyword">const</span> model = wx.<span class="hljs-property">cloud</span>.<span class="hljs-property">extend</span>.<span class="hljs-property">AI</span>.<span class="hljs-title function_">createModel</span>(<span class="hljs-string">"hunyuan-exp"</span>);

<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">streamText</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">model</span>: <span class="hljs-string">"hunyuan-turbos-latest"</span>,
    <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"介绍一下李白"</span> }],
  }
});

<span class="hljs-comment">// 使用 textStream 获取增量文本</span>
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> text <span class="hljs-keyword">of</span> res.<span class="hljs-property">textStream</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"文本片段:"</span>, text);
}

</code></pre>
<h3 data-id="heading-14">核心价值</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c2acfb57a904ebfb574ef6483a9b252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=Qv48qwXlaGtB0cGjmdNM%2FjEti9k%3D" alt="" loading="lazy"/></p>
<p><strong>“AI 提供了逻辑的上限，而 CloudBase Skills 守住了工程的下限。”</strong></p>
<hr/>
<h3 data-id="heading-15">安装 CloudBase Skills</h3>
<p>在你的终端输入以下命令，为你的 AI 助手注入“生产级直觉”：</p>
<pre><code class="hljs language-bash" lang="bash">npx skills add tencentcloudbase/skills
</code></pre>
<p>即可安装我们提供的多个 Skills 到你的开发工具中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6e2adedcbf141db956be0b7186e8bea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=u0gd0LQVLIELAEtFYvaT0U3n5jk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-16">CloudBase Skills 完整列表</h4>
<p>我们将 Skills 按照实际开发中的职能进行了归类，确保 AI 在不同环境下调用正确的 SDK 和工具。</p>
<p>这种分类不仅是为了方便开发者查阅，更是为了在 Discovery（发现阶段）降低 AI 的认知负荷，实现精准的按需挂载。</p>
<h5 data-id="heading-17">核心理念：环境即边界（Environment as Boundary）</h5>
<p>在展开列表前，我们需要阐述这套架构的底层设计：总纲路由，三端隔离。</p>
<ul>
<li><strong>物理隔离</strong>：Web、小程序、Node.js 的同名方法逻辑各异。我们将它们拆分为独立插件，从物理层面杜绝 AI 在小程序里写出 Web SDK 语法的语义污染。</li>
<li><strong>总纲引导</strong>：cloudbase-guidelines 是所有任务的默认入口。它像一个语义路由器，先判定项目环境，再指引 AI 激活对应的子 Skill。</li>
</ul>
<h4 data-id="heading-18">完整技能矩阵</h4>
















































































<table><thead><tr><th>分类</th><th>核心 Skills</th><th>核心职能与实战要点</th></tr></thead><tbody><tr><td><strong>必读总纲</strong></td><td>cloudbase-guidelines</td><td>全局入口。判定 Web/小程序/后端环境，负责架构导航与全局防错规矩。</td></tr><tr><td><strong>AI 扩展</strong></td><td>ai-model-nodejs</td><td>服务端专用。支持文本、流式及图像生成。唯一支持 Node SDK 3.16.0+ 图像能力的 Skill。</td></tr><tr><td/><td>ai-model-web / -wechat</td><td>前端专用。分别适配浏览器与小程序环境。注意小程序端 API 不同，且不支持图像生成。</td></tr><tr><td><strong>身份鉴权</strong></td><td>auth-nodejs / -web / -wechat</td><td>三端隔离。解决 Web 端的登录、小程序原生身份以及服务端的自定义 Ticket 逻辑。</td></tr><tr><td/><td>auth-tool</td><td>MCP 专用。通过 callCloudApi 直接配置短信、匿名、第三方登录等后台开关。</td></tr><tr><td><strong>数据库</strong></td><td>no-sql-web-sdk / -wx-mp-sdk</td><td>文档数据库。适配 Web 与小程序 SDK 的查询、创建、更新、删除及地理位置查询。</td></tr><tr><td/><td>relational-database-tool</td><td>关系型数据库。AI 专用 SQL 执行工具，内置生产数据保护机制，严禁裸写 SQL。</td></tr><tr><td/><td>relational-database-web</td><td>SQL-on-Web。前端通过 SDK 访问关系型数据库的标准初始化与查询模式。</td></tr><tr><td><strong>计算与存储</strong></td><td>cloud-functions</td><td>Serverless 核心。涵盖运行时选择、部署、日志、异步调用与 HTTP 访问配置。</td></tr><tr><td/><td>cloudrun-development</td><td>容器化模式。针对长连接、多语言或 AI Agent 需要的容器云环境开发规范。</td></tr><tr><td/><td>cloud-storage-web</td><td>文件管理。Web 环境下的上传、下载、临时链接生成及文件管理最佳实践。</td></tr><tr><td><strong>研发流与 UI</strong></td><td>spec-workflow</td><td>工程标准化。从需求分析到技术设计的标准 SOP，提升复杂项目的确定性。</td></tr><tr><td/><td>ui-design</td><td>审美基准。提供生产级的组件设计建议与 UI 规范，确保前端界面具备专业视觉品质。</td></tr><tr><td/><td>web / miniprogram</td><td>平台规则。针对 Web 静态托管或小程序开发（含企业微信、wx.cloud 模式）的专项规则。</td></tr></tbody></table>
<h3 data-id="heading-19">MCP vs Skills</h3>
<p>在构建 AI 原生开发生态的道路上，我们始终坚持“先打通，再优化”的逻辑。</p>
<h4 data-id="heading-20">CloudBase MCP：早已就绪的“工程双手”</h4>
<p>事实上，云开发 CloudBase 在 2025 年上半年的时候就推出了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencentCloudBase%2FCloudBase-MCP" title="https://github.com/TencentCloudBase/CloudBase-MCP" target="_blank" ref="nofollow noopener noreferrer">CloudBase MCP</a>。作为 Anthropic 推出的行业标准协议，MCP 解决的是“连接”问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1479cd10e2a40179aa28d0e30942773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=2QFKcj4Itp550nUiN3D6meYcF6g%3D" alt="" loading="lazy"/></p>
<p>通过 MCP，我们让 AI 助手真正拥有了操作腾讯云底座的<strong>结构化权限</strong>。它不再只是在对话框里写代码，而是能直接查询云端状态、创建资源、拉取日志。目前，CloudBase MCP 已经支持了包括 Cursor、Claude Desktop、VS Code 在内的多种主流工具，帮助大量开发者实现了 AI 与云端的物理连接，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.cloudbase.net%2Fai%2Fcloudbase-ai-toolkit%2F" title="https://docs.cloudbase.net/ai/cloudbase-ai-toolkit/" target="_blank" ref="nofollow noopener noreferrer">查看具体使用指引</a>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/033989932fb84891841ba5b33d8d7c2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=k0%2Bfiggvdz1G2qHMdUymdpBlMfg%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-21">CloudBase Skills：后发制人的“岗位手册”</h4>
<p>既然有了 MCP 这双强有力的“手”，为什么我们还要推出 Skills？</p>
<p><strong>如果说 MCP 是让 AI “有权限”干活，那么 Skills 就是让 AI “懂规矩”干活。</strong></p>
<p>在我们的规划中，Skills 是更上层的能力封装：</p>
<ul>
<li><strong>不仅仅是脚本</strong>：虽然 Skills 规范支持包含脚本（Scripts），但我们现阶段更侧重于**“程序性知识（Procedural Knowledge）”的注入**。</li>
<li><strong>更安全、更通用的专家直觉</strong>：正如前文提到的，AI 有了 MCP 虽然能执行脚本，但在云端生产环境，盲目执行脚本不仅不安全，也不符合工程规范。Skills 则是把我们 8 年的云端填坑经验（如行权限隔离、原生上下文认证）变成 AI 的<strong>直觉</strong>。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21dae09e367943b1bfde600d9d38e65b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=tM%2BS1bgIVDBg%2FjIyE9jHqVZQh6w%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-22">为什么它们是黄金组合？</h4>
<p>你可以单独使用其中之一，但组合使用才是 AI 编程的“终极形态”：</p>
<p><strong>“MCP 提供了标准化的安全连接，而 Skills 提供了生产级的工程直觉。”</strong></p>
<p>两者搭配，让 AI 从一个 <strong>“力气大但鲁莽的实习生”</strong> ，真正进化为一个**“懂规矩、有权限”** 的资深云开发专家。</p>
<h3 data-id="heading-23">实战案例</h3>
<p>CodeBuddy IDE 中已经内置了 CloudBase MCP 和 Skills，在连接 CloudBase 之后会自动下载 Skills 到你项目中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/085a8c2399ed4502bacecbcad43ee99b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=emVgrCMHvOL0VpZhYStG48zvg6s%3D" alt="" loading="lazy"/></p>
<p>这里有一篇教程教你用免费云开发资源与混元Token，手把手教你用 AI 来开发一个 AI 小程序。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/885dddcaa88041979d659c29c01e48fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=m0NF9dQcHryx%2B%2FzHeLmznKGCctM%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FeB0x7Jc1lKP13dBMY9wsgw" target="_blank" title="https://mp.weixin.qq.com/s/eB0x7Jc1lKP13dBMY9wsgw" ref="nofollow noopener noreferrer">查看完整教程</a></p>
<p>还可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.cloudbase.net%2Fai%2Fcloudbase-ai-toolkit%2Ftutorials" title="https://docs.cloudbase.net/ai/cloudbase-ai-toolkit/tutorials" target="_blank" ref="nofollow noopener noreferrer">查看更多入门视频教程和文章</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/332df213e5074eaa8022117f5adb8870~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYmluZ2dn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110127&amp;x-signature=fCfLaVG9qSIEB9Pd%2FANKZH8XtXw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-24">终章：Skills 落地踩坑与实战复盘</h3>
<p>在做这套 Skills 的过程中，我们最大的感触是：<strong>现在的 AI 编程，其实处于一个“高智商、低纪律”的阶段。</strong> 别看各大工具都号称支持 Skills，真用起来全是坑。</p>
<p>以下是几个我们里跟 AI “斗智斗勇”换来的经验教训：</p>
<h4 data-id="heading-25">1. 现状：AI 为什么会“装死”？</h4>
<p>明明配了 Skill，AI 还是视而不见。这背后的原因其实涉及大模型的两个底层逻辑：</p>
<ul>
<li><strong>注意力权重（Attention Bias）</strong>：在大模型的 Transformer 架构中，它会根据你的 Prompt 实时计算每个词的权重。当你聊得越深，你提的业务需求权重就会越高，而作为背景板的外部 Skills 权重就会被“稀释”。</li>
<li><strong>决策惰性（Inference Laziness）</strong>：调用 Skill 本质上是一次 <strong>Tool Use（工具调用）</strong>。模型在推理时会进行“路径评估”：如果它觉得自己脑子里的预训练数据（通常是 Localhost 模式）就能生成一段“看起来正确”的代码，它就会为了节省推理资源而跳过外部工具调用。</li>
<li><strong>激活率落差</strong>：在我们的回归测试中，如果不加干预，AI 的主动调用率只有 <strong>20%</strong> 左右。它宁愿“盲目裸奔”，也不愿意翻书。</li>
</ul>
<h4 data-id="heading-26">2. “驯服” AI 的三套硬核解法</h4>
<p>既然 AI 会产生决策惰性，我们就得用工程手段拉高它的“警觉性”。</p>
<h5 data-id="heading-27">方案 A：最土但最稳的“首行注入”</h5>
<p>如果你的项目不容许犯错，就在提问的最开头带上这句“咒语”：</p>
<blockquote>
<p><strong>You MUST read the cloudbase-guidelines skill FIRST when working with CloudBase projects.</strong></p>
</blockquote>
<ul>
<li><strong>原理</strong>：利用 <strong>首因效应（Primacy Effect）</strong>。模型对输入序列最前端的信息具有天然的高关注度。通过这种强行注入，能把 Skill 的激活率拉升。</li>
</ul>
<p>强烈建议大家在试用过程中也带上这句 Prompt，或者按照方案 B 来执行。</p>
<h5 data-id="heading-28">方案 B：项目级的“家法” (System Rules)</h5>
<p>在项目根目录创建 <code>CLAUDE.md</code> 或 <code>AGENT.md</code>，增加项目级别的约束规则。这样就不用每次都在 prompt 中 携带上面的咒语，不过这个方法也存在一定的缺陷，相比每次都首行注入，随着对话的上下文越来越长，也会存在 AI 不遵循的情况，接下来就可以看看方案 3 的解法。</p>
<pre><code class="hljs language-markdown" lang="markdown">

<span class="hljs-section"># CloudBase Workflow</span>

<span class="hljs-bullet">0.</span> You MUST read the cloudbase-guidelines skill FIRST when working with CloudBase projects.
<span class="hljs-bullet">1.</span> 评估：写代码前，必须显式评估可用 Skills 列表。
<span class="hljs-bullet">2.</span> 承诺：必须在输出中陈述“我需要调用某个 Skill”的理由。
<span class="hljs-bullet">3.</span> 执行：禁止跳过规矩直接写代码。

</code></pre>
<h4 data-id="heading-29">方案 3：自动化“强制拦截” (Forced Eval Hook)</h4>
<p>如果说前两个方案是靠“嘴”叮嘱 AI，那方案 3 就是靠**“物理拦截”**</p>
<p>技术专家 Scott Spence 在他的实测中发现，最有效的方式是利用编辑器的 <strong>Hook（钩子）机制</strong>。</p>
<ul>
<li><strong>它的本质是“中间件”</strong>：这不再是你手动输入的 Prompt。通过配置（如 <code>.claude/settings.json</code>），脚本会在你按下回车的那一刻，自动拦截并“魔改”你的问题。</li>
<li><strong>强制“表态”才能“干活”</strong>：这个钩子会强制 AI 在输出任何代码前，必须先生成一段 <strong>评估报告</strong>。AI 必须逐一陈述：<em>“当前有哪些 Skill 可用？针对这个需求，我需不需要调用它们？理由是什么？”</em></li>
<li><strong>消除“决策惰性”</strong>：AI 有个毛病，只要它觉得脑子里的旧数据能糊弄过去，它就不会翻书。但这种 Hook 强迫 AI 必须白纸黑字写下“我要用这个工具”，一旦它在开头表了态，后面的代码生成就会严格遵守这个承诺。</li>
<li><strong>激活率的质变</strong>：根据 Scott 的数据，这种“拦截+评估”的手段能将激活率从 <strong>20% 暴力拉升到 84%</strong></li>
</ul>
<p>延伸阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fscottspence.com%2Fposts%2Fhow-to-make-claude-code-skills-activate-reliably" title="https://scottspence.com/posts/how-to-make-claude-code-skills-activate-reliably" target="_blank" ref="nofollow noopener noreferrer">How to Make Claude Code Skills Activate Reliably</a></p>
<h4 data-id="heading-30">3. 架构复盘：为什么必须是“总纲 + 独立插件”？</h4>
<p>在开发过程中，我们发现 AI 最大的毛病是**“端不分”**。它分不清小程序、Web 和 Node.js 的环境边界。我们没有搞一个“全家桶” Skill，而是采用了 <strong>“1 个总纲 (Guidelines) Skill + 21 个独立 Skill”</strong> 的分布式架构。这背后有三个核心逻辑：</p>
<h5 data-id="heading-31">A. 解决“语义污染”与环境误判</h5>
<p>Web、小程序、Node.js 的 SDK 方法名极其相似（如都有 <code>init</code>, <code>callFunction</code>）。</p>
<ul>
<li><strong>痛点</strong>：如果全塞进一个 Skill，AI 经常在写小程序逻辑时，顺手掏出 Web 端的语法。这种<strong>语义污染</strong>是造成代码无法上线的元凶。</li>
<li><strong>解法</strong>：我们将 Skill 按端进行物理拆分。配合 <code>cloudbase-guidelines</code> 这种 <strong>“入口点” (Entry Point)</strong> ，先指挥 AI 判定项目环境（如：识别到 <code>app.json</code> 即为小程序）。</li>
<li><strong>收益</strong>：环境判定后，AI 只会加载相关的子 Skill。这把干扰项直接屏蔽掉，<strong>搜索空间缩小了 90%，推理精度自然大幅提升。</strong></li>
</ul>
<h5 data-id="heading-32">B. 开发者可以“精准点菜”</h5>
<ul>
<li><strong>痛点</strong>：全能包（单体架构）太重。当你想让 AI 专门解决“微信支付”或“安全规则”这种特定问题时，AI 的注意力会被庞大的全量手册稀释。</li>
<li><strong>解法</strong>：独立插件支持<strong>局部强化</strong>。你可以直接下令：<em>“调用 <code>auth-web</code> 检查实现手机号登录”</em>。</li>
<li><strong>收益</strong>：这种设计允许开发者直接干预 AI 的决策路径。在 AI 逻辑混乱时，通过唤起特定子 Skill 强行把它的思维拉回到正确的窄道上。</li>
</ul>
<h3 data-id="heading-33">未来规划</h3>
<p>我们将持续推出：</p>
<ul>
<li>小程序集成微信支付集成技能</li>
<li>小程序集成虚拟支付技能</li>
<li>小游戏集成云开发技能</li>
<li>云函数部署全栈后端应用技能</li>
<li>更多全栈应用开发模板和技能等</li>
</ul>
<p>欢迎访问</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencentCloudBase%2FSkills" title="https://github.com/TencentCloudBase/Skills" target="_blank" ref="nofollow noopener noreferrer">CloudBase Skills GitHub 仓库</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencentCloudBase%2FCloudBase-MCP" title="https://github.com/TencentCloudBase/CloudBase-MCP" target="_blank" ref="nofollow noopener noreferrer">CloudBase MCP GitHub 仓库</a></p>
<p>了解更多详情！</p>
<h3 data-id="heading-34">写在最后：从“代码生成”到“生产级交付”的跨越</h3>
<p>折腾了这么多 Skills 之后，我们最大的感触是：<strong>AI 编程的生产力，不取决于模型能写出多么精妙的逻辑，而取决于你对它生成的代码具备多少“工程约束力”。</strong></p>
<h4 data-id="heading-35">1. 核心本质：将“隐性经验”转化为“程序性知识”</h4>
<p>目前的 Agent 依然处于“高智商、零经验”的状态，它们是博学的“实习生”，却对真实的物理底座缺乏敬畏。
<strong>CloudBase Skills 的本质，是给 AI 注入一套工程化的“肌肉记忆”。</strong> 通过 <code>guidelines</code> 的语义导航和原子 Skill 的强约束，我们将云开发八年来沉淀的填坑经验（如行权限隔离、多端原生上下文、高并发限流）转化为了 AI 的<strong>前置判定条件</strong>。这种**程序性知识（Procedural Knowledge）**的注入，让 AI 真正理解了“正确且安全”的交付标准。</p>
<h4 data-id="heading-36">2. 范式转换：Agent 必须具备“环境感知力”</h4>
<p>Agent 进化的下一站，不仅仅是 Reasoning（推理）的增强，更是对 <strong>Infrastructure（基础设施）感知力</strong>的补齐。</p>
<ul>
<li><strong>Skills 守住工程下限</strong>：它是一套“防呆协议”。通过场景化工作流和报错锚点，强制 AI 在编写阶段就化解鉴权漏洞和多端环境差异，彻底终结“代码只活在 <code>localhost</code>”的幻觉。</li>
<li><strong>CloudBase 承载逻辑上限</strong>：作为全栈底座，它让 AI 的逻辑输出不再是网页里的文本，而是能直接部署、调通、并产生真实业务价值的生产级资源。</li>
</ul>
<h4 data-id="heading-37">3. 确定性是 AI 开发的唯一度量衡</h4>
<p>我们不应该期待 AI 自动变得“完美”，而应该通过工程手段让它变得“稳定”。
<strong>AI 提供逻辑的上限，Skills 守住工程的下限，而 CloudBase 则是承载这一切的物理底座。</strong></p>
<p>我们正处于从“氛围感编程 (Vibe Coding)”向“生产级交付”跨越的节点。如果你也厌倦了在对话框里修 Bug，欢迎安装 CloudBase Skills。给你的 AI 立个规矩，让它真正从一个“聊天搭子”进化为能帮你上线产品的“资深合伙人”。</p>
<hr/>
<p>如有问题或建议，欢迎在评论区交流</p>
<h3 data-id="heading-38">名词解释</h3>
<ul>
<li><strong>Vibe Coding</strong>：一种依赖 AI 直觉、快速生成原型但缺乏工程严谨性的编程方式。</li>
<li><strong>Procedural Knowledge</strong>：程序性知识。指关于“如何操作”的知识，让 AI 掌握特定场景下的标准作业流程（SOP）。</li>
<li><strong>MCP</strong>：模型上下文协议。AI 的**“连接器”**，让其能直接操作数据库、文件系统或云资源。</li>
<li><strong>Agent Skills</strong>：能力插件包。AI 的**“专家手册”**，注入特定领域的最佳实践和工程规范。</li>
<li><strong>横向越权</strong>：安全漏洞。指攻击者通过篡改 ID 等参数，非法访问到同级别其他用户的数据。</li>
<li><strong>安全规则</strong>：底座级权限控制。在数据库入口处强制执行访问校验，是防御越权的核心手段。</li>
</ul>
<h3 data-id="heading-39">立即开始</h3>
<p>在你的终端输入以下命令，为你的 AI 助手注入“生产级直觉”：</p>
<pre><code class="hljs language-bash" lang="bash">npx skills add tencentcloudbase/skills
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[containerd2.x接入Harbor仓库方法]]></title>    <link>https://juejin.cn/post/7599765329410146344</link>    <guid>https://juejin.cn/post/7599765329410146344</guid>    <pubDate>2026-01-27T07:49:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599765329410146344" data-draft-id="7599852579066707983" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="containerd2.x接入Harbor仓库方法"/> <meta itemprop="keywords" content="数据库,开源"/> <meta itemprop="datePublished" content="2026-01-27T07:49:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Smoothcloud_润云"/> <meta itemprop="url" content="https://juejin.cn/user/2948233128844891"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            containerd2.x接入Harbor仓库方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2948233128844891/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Smoothcloud_润云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:49:05.000Z" title="Tue Jan 27 2026 07:49:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心配置结构说明</h2>
<p>containerd 2.x 对镜像仓库配置进行了结构化优化，所有相关配置均集中在 <code>/etc/containerd/certs.d/</code> 目录下，遵循 "一仓库一目录" 的配置原则：</p>
<ul>
<li>每个镜像仓库（registry）对应一个独立目录，目录名需与仓库域名（或 IP 地址）完全一致</li>
<li>每个目录下必须包含一个 <code>hosts.toml</code> 文件，用于定义仓库连接参数</li>
<li><code>hosts.toml</code> 核心配置项：仓库服务地址（server）、操作权限（capabilities）、认证信息（auth）、证书验证开关（skip_verify）</li>
</ul>
<h2 data-id="heading-1">二、分步配置实战</h2>
<h3 data-id="heading-2">1. 版本确认</h3>
<p>首先通过以下命令验证 containerd 版本是否为 2.x 系列：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@k8s-master ~</span>]<span class="hljs-meta"># containerd --version</span>
containerd containerd.io v2<span class="hljs-number">.2</span><span class="hljs-number">.0</span> <span class="hljs-number">1</span>c4457e00facac03ce1d75f7b6777a7a851e5c41
</code></pre>
<h3 data-id="heading-3">2. 创建配置目录</h3>
<p>根据 Harbor 仓库地址创建对应的配置目录，目录名需与仓库域名（或 IP）严格匹配（示例中 Harbor 仓库地址为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fharbor.liyb.com" target="_blank" title="https://harbor.liyb.com" ref="nofollow noopener noreferrer">harbor.liyb.com</a>）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /etc/containerd/certs.d/harbor.liyb.com
</code></pre>
<blockquote>
<p>注意：若仓库未使用域名（直接通过 IP 访问），可直接以 IP 地址作为目录名（如 <code>/etc/containerd/certs.d/192.168.1.100</code>）</p>
</blockquote>
<h3 data-id="heading-4">3. 编写 hosts.toml 配置文件</h3>
<p>创建并编辑 <code>hosts.toml</code> 文件，配置仓库连接参数：</p>
<pre><code class="hljs language-bash" lang="bash">vi /etc/containerd/certs.d/harbor.liyb.com/hosts.toml
</code></pre>
<p>添加如下配置内容：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">server</span> = <span class="hljs-string">"https://harbor.liyb.com"</span>

<span class="hljs-section">[host."https://harbor.liyb.com"]</span>
<span class="hljs-attr">capabilities</span> = [<span class="hljs-string">"pull"</span>, <span class="hljs-string">"resolve"</span>, <span class="hljs-string">"push"</span>]  <span class="hljs-comment"># 支持的操作：拉取、解析、推送</span>
<span class="hljs-attr">skip_verify</span> = <span class="hljs-literal">true</span>  <span class="hljs-comment"># 自签名证书时启用（跳过证书验证）</span>
<span class="hljs-section">[host."https://harbor.liyb.com".auth]</span>
<span class="hljs-attr">username</span> = <span class="hljs-string">"admin"</span>  <span class="hljs-comment"># Harbor 登录用户名</span>
<span class="hljs-attr">password</span> = <span class="hljs-string">"Harbor12345"</span>  <span class="hljs-comment"># Harbor 登录密码</span>
</code></pre>
<blockquote>
<p>配置说明：</p>
<ul>
<li>若使用企业级可信证书，无需设置 <code>skip_verify = true</code>，只需将 CA 证书文件放置到对应配置目录（如 <code>/etc/containerd/certs.d/harbor.liyb.com/</code>）即可</li>
<li>权限配置可根据实际需求调整，例如仅需拉取镜像时可改为 <code>capabilities = ["pull", "resolve"]</code></li>
</ul>
</blockquote>
<h3 data-id="heading-5">4. 确认主配置文件路径</h3>
<p>检查 containerd 主配置文件 <code>/etc/containerd/config.toml</code> 中是否正确指定了仓库配置路径，确保以下配置项存在且无误：</p>
<p>toml</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># /etc/containerd/config.toml</span>
<span class="hljs-section">[plugins."io.containerd.grpc.v1.cri".registry]</span>
<span class="hljs-attr">config_path</span> = <span class="hljs-string">"/etc/containerd/certs.d"</span>  <span class="hljs-comment"># 仓库配置目录路径（默认已启用）</span>
</code></pre>
<blockquote>
<p>注意：containerd 2.x 默认启用该配置，但生产环境部署时务必手动校验，避免路径配置错误导致配置失效</p>
</blockquote>
<h2 data-id="heading-6">三、配置验证方法</h2>
<h3 data-id="heading-7">1. 使用 nerdctl 验证（推荐）</h3>
<p>通过 nerdctl 工具拉取 Harbor 仓库镜像，验证配置是否生效：</p>
<pre><code class="hljs language-bash" lang="bash">nerdctl pull harbor.liyb.com/prod/nginx:1.27
</code></pre>
<p>成功输出示例：</p>
<p>plaintext</p>
<pre><code class="hljs language-bash" lang="bash">harbor.liyb.com/prod/nginx:1.27: manifest-sha256:114dff0fc8ee3d0200c3a12c60e3e2b79d0920dd953175ecb78a0b157425b25e: <span class="hljs-keyword">done</span>
config-sha256:1e5f3c5b981a9f91ca91cf13ce87c2eedfc7a083f4f279552084dd08fc477512: <span class="hljs-keyword">done</span>
elapsed: 0.1 s
total: 0.0 B (0.0 B/s)
</code></pre>
<h3 data-id="heading-8">2. Kubernetes 节点验证</h3>
<p>在 Kubernetes 节点上通过 crictl 工具拉取镜像（适用于 K8s 集群环境）：</p>
<pre><code class="hljs language-bash" lang="bash">crictl pull harbor.liyb.com/prod/nginx:1.27
</code></pre>
<blockquote>
<p>关键注意点：镜像名称必须显式包含 Harbor 仓库地址（完整格式：仓库地址 / 项目名 / 镜像名：标签），否则会导致 K8s Pod 拉取镜像失败</p>
</blockquote>
<h2 data-id="heading-9">四、高频踩坑与解决方案</h2>






























<table><thead><tr><th align="center">常见问题</th><th align="center">排查方向</th><th align="center">解决方案</th></tr></thead><tbody><tr><td align="center">hosts.toml 配置不生效</td><td align="center">配置目录名与仓库域名 / 端口不一致</td><td align="center">确保目录名与镜像中使用的 registry 地址完全匹配（含端口，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fharbor.liyb.com%3A8080" target="_blank" title="https://harbor.liyb.com:8080" ref="nofollow noopener noreferrer">harbor.liyb.com:8080</a> 需对应创建 <a href="https://link.juejin.cn?target=https%3A%2F%2Fharbor.liyb.com%3A8080" target="_blank" title="https://harbor.liyb.com:8080" ref="nofollow noopener noreferrer">harbor.liyb.com:8080</a> 目录）</td></tr><tr><td align="center">HTTP 仓库镜像拉取失败</td><td align="center">配置文件中未指定 http 协议</td><td align="center">将 server 地址改为 <code>http://</code> 开头（如 <code>server = "http://harbor.liyb.com:80"</code>）</td></tr><tr><td align="center">K8s Pod 无法拉取镜像</td><td align="center">镜像名称未包含仓库地址</td><td align="center">Pod 配置中 image 字段需填写完整路径（如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fharbor.liyb.com%2Fprod%2Fnginx%3A1.27" target="_blank" title="https://harbor.liyb.com/prod/nginx:1.27" ref="nofollow noopener noreferrer">harbor.liyb.com/prod/nginx:…</a>），不可省略仓库地址</td></tr><tr><td align="center">配置后仍无法连接仓库</td><td align="center">误沿用 Docker 的 daemon.json 配置</td><td align="center">containerd 2.x 不读取 Docker 的 daemon.json 配置，需按本文方法在 certs.d 目录下配置</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[promise-logic --v2.6.1更新内容]]></title>    <link>https://juejin.cn/post/7599798118460932105</link>    <guid>https://juejin.cn/post/7599798118460932105</guid>    <pubDate>2026-01-27T08:54:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599798118460932105" data-draft-id="7599847938537783305" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="promise-logic --v2.6.1更新内容"/> <meta itemprop="keywords" content="JavaScript,NPM"/> <meta itemprop="datePublished" content="2026-01-27T08:54:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xier123456"/> <meta itemprop="url" content="https://juejin.cn/user/546930955651113"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            promise-logic --v2.6.1更新内容
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/546930955651113/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xier123456
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T08:54:49.000Z" title="Tue Jan 27 2026 08:54:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>安装：<code>npm i promise-logic</code></p>
<h2 data-id="heading-0">一、主要问题</h2>
<p>在本次项目维护中，我们遇到并解决了以下问题：</p>
<h3 data-id="heading-1">1. <code>maxTimer</code> 链式超时控制</h3>
<p><strong>难点分析</strong>：</p>
<ul>
<li>需要为所有 Promise 操作添加超时控制</li>
<li>需要保持向后兼容性，不影响现有代码</li>
<li>需要确保超时功能能够正确处理各种异步场景</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>实现 <code>PromiseWithTimer</code> 包装类，为 Promise 添加 <code>maxTimer</code> 方法</li>
<li>使用 <code>Promise.race</code> 实现超时逻辑，在指定时间后返回超时错误</li>
<li>修改所有逻辑门方法，使其返回 <code>PromiseWithTimer</code> 实例</li>
</ul>
<p><strong>核心代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PromiseWithTimer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">promise</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span> = promise;
  }

  <span class="hljs-comment">//  maxTimer 方法</span>
  <span class="hljs-title function_">maxTimer</span>(<span class="hljs-params">ms</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span>,
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Promise timed out after <span class="hljs-subst">${ms}</span>ms`</span>));
        }, ms)

        <span class="hljs-keyword">return</span><span class="hljs-function">()=&gt;</span>{
          <span class="hljs-built_in">clearTimeout</span>(timer)
        }
      })
    ]);
  }

  <span class="hljs-comment">//  then 方法</span>
  <span class="hljs-title function_">then</span>(<span class="hljs-params">onfulfilled, onrejected</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PromiseWithTimer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span>.<span class="hljs-title function_">then</span>(onfulfilled, onrejected));
  }

<span class="hljs-comment">//...</span>

</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromiseLogic</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'promise-logic'</span>;

<span class="hljs-comment">// 执行带超时的操作</span>
<span class="hljs-title class_">PromiseLogic</span>.<span class="hljs-title function_">and</span>([
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>)), <span class="hljs-comment">// 1秒操作</span>
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">3</span>)
])
.<span class="hljs-title function_">maxTimer</span>(<span class="hljs-number">2000</span>) <span class="hljs-comment">// 2秒超时</span>
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'操作在超时时间内完成:'</span>, result);
})
.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'操作超时或失败:'</span>, error.<span class="hljs-property">message</span>);
});
</code></pre>
<h3 data-id="heading-2">2. majority 方法的自定义</h3>
<p><strong>难点分析</strong>：</p>
<ul>
<li>需要为 <code>majority</code> 方法添加自定义阈值</li>
<li>需要确保默认行为与之前保持一致</li>
<li>需要处理不同场景下的阈值计算</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>为 <code>majority</code> 方法添加 <code>options</code> 参数，其中 <code>max</code> 属性可自定义阈值</li>
<li>设置默认值为 0.5，确保向后兼容性</li>
<li>使用动态计算 <code>fulfilledCount &gt; total - fulfilledCount</code> 实现多数逻辑</li>
</ul>
<p><strong>核心代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">static</span> <span class="hljs-title function_">majority</span>(<span class="hljs-params">iterable, options = { max: <span class="hljs-number">0.5</span> }</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PromiseWithTimer</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>(iterable).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">results</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> fulfilled = results.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> result.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>);
      <span class="hljs-keyword">const</span> fulfilledCount = fulfilled.<span class="hljs-property">length</span>;
      <span class="hljs-keyword">const</span> total = results.<span class="hljs-property">length</span>;
      
      <span class="hljs-comment">//多数逻辑：成功数 &gt; 失败数</span>
      <span class="hljs-keyword">if</span> (fulfilledCount &gt; total * options.<span class="hljs-property">max</span>) {
        <span class="hljs-comment">// 超过半数成功，返回成功的值数组</span>
        <span class="hljs-keyword">return</span> fulfilled.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> result.<span class="hljs-property">value</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 未达到多数，抛出MAJORITY_ERROR</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-title function_">createLogicError</span>(<span class="hljs-string">'MAJORITY_ERROR'</span>, fulfilledCount, total, results);
      }
    }));
  }
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromiseLogic</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'promise-logic'</span>;

<span class="hljs-keyword">const</span> services = [
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'service1'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'service2'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'service3'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'service4'</span>)
];

<span class="hljs-comment">// 默认阈值（0.5）：需要至少3个成功</span>
<span class="hljs-comment">// 自定义阈值（0.4）：需要至少2个成功</span>
<span class="hljs-title class_">PromiseLogic</span>.<span class="hljs-title function_">majority</span>(services, { <span class="hljs-attr">max</span>: <span class="hljs-number">0.4</span> })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'达到自定义阈值，成功结果:'</span>, results); <span class="hljs-comment">// ['service1', 'service2']</span>
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'未达到自定义阈值:'</span>, error);
  });
</code></pre>
<h2 data-id="heading-3">二、项目更新内容</h2>
<p>本次更新主要包括以下内容：</p>
<ol>
<li>
<p><strong>添加超时控制功能</strong>：</p>
<ul>
<li>实现 <code>PromiseWithTimer</code> 类</li>
<li>添加 <code>maxTimer</code> 方法，支持为任何 Promise 操作设置超时时间</li>
</ul>
</li>
<li>
<p><strong>添加扩展操作</strong>：</p>
<ul>
<li>添加 <code>allFulfilled</code> 方法，返回所有成功结果</li>
<li>添加 <code>allRejected</code> 方法，返回所有失败结果</li>
<li>添加 <code>allSettled</code> 方法，返回所有结果（包括成功和失败）</li>
</ul>
</li>
<li>
<p><strong>增强现有功能</strong>：</p>
<ul>
<li>为 <code>majority</code> 方法添加 <code>options</code> 参数，支持自定义阈值</li>
<li>修复函数工厂存在的 bug</li>
</ul>
</li>
</ol>
<h2 data-id="heading-4">三、版本更新说明</h2>
<p>本次更新版本号为 <code>v2.6.1</code>，更新说明如下：</p>
<ul>
<li><strong>英文</strong>：<code>v2.6.1_Add timeout control and extended operations, enhance majority method with customizable threshold, fix bugs in function factory, fix test file path reference errors</code></li>
<li><strong>中文</strong>：<code>v2.6.1_添加超时控制和扩展操作，增强 majority 方法支持自定义阈值，更新了函数工厂存在的bug，更新测试文件路径引用错误问题</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在vite@5中配置tailwindcss@4]]></title>    <link>https://juejin.cn/post/7599847938537390089</link>    <guid>https://juejin.cn/post/7599847938537390089</guid>    <pubDate>2026-01-27T07:57:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599847938537390089" data-draft-id="7599604510367219750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在vite@5中配置tailwindcss@4"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2026-01-27T07:57:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="远之喵"/> <meta itemprop="url" content="https://juejin.cn/user/888852236483800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在vite@5中配置tailwindcss@4
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/888852236483800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    远之喵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:57:51.000Z" title="Tue Jan 27 2026 07:57:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一 安装依赖</h2>
<p><code>npm install tailwindcss @tailwindcss/vite</code></p>
<h2 data-id="heading-1">二 配置vite.config.js</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> tailwindcss <span class="hljs-keyword">from</span> <span class="hljs-string">'@tailwindcss/vite'</span>
<span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-title function_">createVuePlugin</span>(), 
        <span class="hljs-title function_">tailwindcss</span>(),
        <span class="hljs-title class_">Components</span>({<span class="hljs-attr">resolvers</span>:[<span class="hljs-title class_">ElementUiResolver</span>()]}), <span class="hljs-comment">// 按需加载组件库</span>
        <span class="hljs-title function_">commonjs</span>(),
        <span class="hljs-title function_">compression</span>({
            <span class="hljs-comment">// 压缩算法，可选 'gzip' | 'brotliCompress' | 'deflate' | 'deflateRaw'</span>
            <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'gzip'</span>,
            <span class="hljs-comment">// 需要压缩的文件后缀</span>
            <span class="hljs-attr">ext</span>: <span class="hljs-string">'.gz'</span>,
            <span class="hljs-comment">// 仅压缩大于此大小的文件（单位：字节）</span>
            <span class="hljs-attr">threshold</span>: <span class="hljs-number">10240</span>, <span class="hljs-comment">// 10KB 以上才压缩</span>
            <span class="hljs-comment">// 是否删除原始文件（建议保留，服务器可根据请求头自动选择）</span>
            <span class="hljs-attr">deleteOriginFile</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-comment">// 压缩率（0-9），越高压缩率越好但耗时越长</span>
            <span class="hljs-attr">compressionOptions</span>: { <span class="hljs-attr">level</span>: <span class="hljs-number">6</span> },
            <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/^\.(js|css|json|html|ico|svg)(\?.*)?$/i</span>, <span class="hljs-comment">// 过滤文件类型</span>
        })
    ],
    <span class="hljs-attr">build</span>: {
        <span class="hljs-attr">commonjsOptions</span>: {
            <span class="hljs-attr">transformMixedEsModules</span>: <span class="hljs-literal">true</span>
        },
        <span class="hljs-attr">outDir</span>: <span class="hljs-string">'dist'</span>
    },
    <span class="hljs-attr">resolve</span>: {
        <span class="hljs-attr">alias</span>: {
            <span class="hljs-string">'@'</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
        }
    },
    <span class="hljs-attr">css</span>: {
        <span class="hljs-attr">preprocessorOptions</span>:{
            <span class="hljs-attr">less</span>: {
                <span class="hljs-attr">javascriptEnabled</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">additionalData</span>: <span class="hljs-string">`@primary-color: green;
                @import "<span class="hljs-subst">${resolve(__dirname, <span class="hljs-string">'src/global.less'</span>)}</span>";`</span>
            }
        }
    }
})
</code></pre>
<h2 data-id="heading-2">三 创建taildwind.css文件</h2>
<p>在src目录下创建styles目录 src/style/tailwind.css文件</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@import</span> <span class="hljs-string">"tailwindcss"</span>;
<span class="hljs-keyword">@tailwind</span> base;    <span class="hljs-comment">/* 引入 Tailwind 基础样式（重置默认样式） */</span>
<span class="hljs-keyword">@tailwind</span> components; <span class="hljs-comment">/* 引入组件类（如 btn、card） */</span>
<span class="hljs-keyword">@tailwind</span> utilities; 
</code></pre>
<p>在 main.js中引入该文件</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'@/styles/tailwind.css'</span>
</code></pre>
<h2 data-id="heading-3">四 效果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a88a4b3f8d3a45069517a5662ed868cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-c5LmL5Za1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105680&amp;x-signature=ceF%2BdqZFbno7f66EQBW0PWUoEtI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46a71f17ea994afebdffb053a90b669d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-c5LmL5Za1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105680&amp;x-signature=vsnznq1ZvpRDv%2Bbkj8kl5xDVaKc%3D" alt="image.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c6d872ee84143cd9326f2495f02658c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-c5LmL5Za1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105680&amp;x-signature=R%2BkbNpMlLXbcVI0mHKxZTA5mBdU%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[oauth2资源服务器如何保护资源的]]></title>    <link>https://juejin.cn/post/7599708108621332531</link>    <guid>https://juejin.cn/post/7599708108621332531</guid>    <pubDate>2026-01-27T09:25:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599708108621332531" data-draft-id="7599614131423215625" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="oauth2资源服务器如何保护资源的"/> <meta itemprop="keywords" content="微服务,Java,Spring Cloud"/> <meta itemprop="datePublished" content="2026-01-27T09:25:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MrSYJ"/> <meta itemprop="url" content="https://juejin.cn/user/2752832848799726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            oauth2资源服务器如何保护资源的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2752832848799726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MrSYJ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:25:09.000Z" title="Tue Jan 27 2026 09:25:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在配置资源服务器的时候，经常最简化的配置就是:</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">http</span><span class="hljs-selector-class">.oauth2ResourceServer</span>(oauth -&gt; oauth.<span class="hljs-built_in">jwt</span>(Customizer.<span class="hljs-built_in">withDefaults</span>()))
</code></pre>
<p>这行代码底层主要配置了<strong>两大核心支柱</strong>：一个负责拦截，一个负责拆弹（解析 JWT）</p>
<h2 data-id="heading-0">1.BearerTokenAuthenticationFilter 负责拦截</h2>
<p>在 OAuth2 资源服务器模式下，Spring Security 会在过滤器链中加入一个核心拦截器：<code>BearerTokenAuthenticationFilter</code>。</p>
<ul>
<li>
<p><strong>它的位置</strong>：通常在过滤器链的中后部。</p>
</li>
<li>
<p><strong>它的职责</strong>：</p>
<ol>
<li>扫描每个请求的 <strong>Header</strong>。</li>
<li>寻找 <code>Authorization: Bearer &lt;TOKEN&gt;</code> 格式的头。</li>
<li>如果找到了，就把这一串长长的字符串（Token）提取出来，封装成一个 <code>BearerTokenAuthenticationToken</code> 对象，交给后续处理。</li>
</ol>
</li>
</ul>
<p>BearerTokenAuthenticationFilter拦截逻辑如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/496fdc6e2c3c4eb8bfcdae65b31e4e95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJTWUo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110708&amp;x-signature=%2F4SV3vZq2d%2F9KnqoIyotOrqEIkQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2.JwtAuthenticationProvider 负责拆弹（解析 JWT）</h2>
<p>上图封装的BearerTokenAuthenticationToken要交给AuthenticationManager进行认证，AuthenticationManager使用AuthenticationProvider来完成校验，JwtAuthenticationProvider就是AuthenticationProvider接口的实现类，用来解析token</p>
<p>JwtAuthenticationProvider的源码如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b74e97181b8436dbd7d6571e0287f28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJTWUo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110708&amp;x-signature=jfskXxJ5u43Zwkv9IUbXAhklSGU%3D" alt="image.png" loading="lazy"/></p>
<p>getJwt 就是利用jwtDecoder来完成对token的解析，生成Jwt对象</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b5a4b5b8a8a4acb8a944dfaffe589f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJTWUo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110708&amp;x-signature=OrsP%2FDdSSZBe4BrtCJkw4V8AhfE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d77d3b7df1347f281a5f8c40990e1a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJTWUo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110708&amp;x-signature=fRDknhZ6rSJEZNElQhXG9dq9hiw%3D" alt="image.png" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e0c171a41ab4a148f988f81dda5079c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJTWUo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110708&amp;x-signature=Bn2Is59rGo5zWjSkpN8PNmdveAM%3D" alt="image.png" loading="lazy"/></p>
<p>利用JwtAuthenticationConverter,将Jwt对象转成最终的JwtAuthenticationToken</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eadbcba3260427abaff9b8197bd96e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJTWUo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110708&amp;x-signature=mVVWKjKV%2F%2FHEBiyHWDdzyQhv8uc%3D" alt="image.png" loading="lazy"/></p>
<p>在这个过程中，底层还配置了一个<strong>权限转换器</strong>：<code>JwtGrantedAuthoritiesConverter</code>。</p>
<ul>
<li><strong>默认逻辑</strong>：它会去找 JWT Payload 里的 <code>scp</code> 或 <code>scope</code> 字段。</li>
<li><strong>结果</strong>：如果你的 JWT 里有 <code>"scope": "read"</code>，那么在 Spring Security 内部，你的权限就会被自动转换成 <code>SCOPE_read</code>。</li>
</ul>
<h2 data-id="heading-2">如果不带token访问一个受保护的api会发生什么？</h2>
<p>当你不带 Token 访问一个受保护的 API（如 <code>/api/data</code>）时，请求会流经过滤器链。</p>
<ul>
<li><strong>过滤器</strong>：<code>BearerTokenAuthenticationFilter</code></li>
<li><strong>动作</strong>：它尝试从请求头 <code>Authorization</code> 中提取 Token。</li>
<li><strong>结果</strong>：它发现 Header 是空的。此时它<strong>什么都不做</strong>只是简单地把请求传给下一个过滤器。因为它的职责只是“提取”，没有 Token 意味着“当前用户依然是匿名状态”。</li>
</ul>
<p>请求继续往后走，直到遇见 <strong><code>AuthorizationFilter</code></strong>（这是过滤器链的最后一关，负责最终权限判定）。</p>
<ul>
<li><strong>逻辑</strong>：它发现你访问的是受保护资源，但目前的身份是 <code>Anonymous</code>（匿名）。</li>
<li><strong>动作</strong>：抛出一个 <strong><code>AccessDeniedException</code></strong>（拒绝访问异常）。</li>
</ul>
<p>这个访问异常会被**<code>ExceptionTranslationFilter</code>** 这个过滤器处理</p>
<p>这个过滤器内部持有一个关键组件：<strong><code>AuthenticationEntryPoint</code></strong>。 对于 OAuth2，它的默认实现类是：<strong><code>BearerTokenAuthenticationEntryPoint</code></strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b5e8e393b1c487fac8c5999f0018cba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJTWUo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110708&amp;x-signature=auvEh7PApDr3nc%2F1UszFnoRxe3Q%3D" alt="image.png" loading="lazy"/></p>
<p><code>AuthenticationEntryPoint</code>见名知意引导用户去认证的入口，<strong>用户尝试访问一个受保护的资源但尚未认证（即未登录）时，决定如何“开始”认证流程。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5dcbfbc47c94cd4bc24472e408065bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJTWUo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110708&amp;x-signature=byPKYgMVQh4qhAuUqXXGCc9GSmA%3D" alt="image.png" loading="lazy"/></p>
<p>而<code>BearerTokenAuthenticationEntryPoint</code> 专门用于 <strong>基于 Bearer Token（如 JWT）的无状态 REST API 认证场景</strong></p>
<p>它的默认行为是：</p>
<blockquote>
<p><strong>返回 HTTP 状态码 <code>401 Unauthorized</code>，并在响应头中添加 <code>WWW-Authenticate: Bearer</code>。</strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a31d9e2601e34fa79044bf5aedb85f1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJTWUo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770110708&amp;x-signature=CzIrlM%2F28v67DcgUwXjGoSEtuZw%3D" alt="image.png" loading="lazy"/></p>
<p>为什么会有 WWW-Authenticate: Bearer？</p>
<p>这是 RFC 6750 标准（OAuth 2.0 承载令牌）的规定。</p>
<p>• 含义：它在告诉客户端（比如你的前端 Vue 应用或 Postman）：“这个资源是受保护的，你需要使用 Bearer Token 方案进行认证才能访问。”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[godot-rust（gdext）你的第一个2D游戏 - 1]]></title>    <link>https://juejin.cn/post/7599852579066740751</link>    <guid>https://juejin.cn/post/7599852579066740751</guid>    <pubDate>2026-01-27T07:47:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599852579066740751" data-draft-id="7599586891084840994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="godot-rust（gdext）你的第一个2D游戏 - 1"/> <meta itemprop="keywords" content="游戏"/> <meta itemprop="datePublished" content="2026-01-27T07:47:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="柚要做甚码"/> <meta itemprop="url" content="https://juejin.cn/user/2200546203156138"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            godot-rust（gdext）你的第一个2D游戏 - 1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2200546203156138/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    柚要做甚码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:47:45.000Z" title="Tue Jan 27 2026 07:47:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>本文以<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fzh-cn%2F4.5%2Fgetting_started%2Ffirst_2d_game%2Findex.html" target="_blank" title="https://docs.godotengine.org/zh-cn/4.5/getting_started/first_2d_game/index.html" ref="nofollow noopener noreferrer">你的第一个 2D 游戏 — Godot Engine (4.5) 简体中文文档</a>为蓝本撰写，godot-rust提供了该教程的一个rust的实现<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgodot-rust%2Fdemo-projects%2Ftree%2Fmaster%2Fdodge-the-creeps" target="_blank" title="https://github.com/godot-rust/demo-projects/tree/master/dodge-the-creeps" ref="nofollow noopener noreferrer">dodge-the-creeps</a>，与本文方法会稍有不同。如果你对rust、godot等内容比较生疏或感到疑惑，可以先阅读<a href="https://link.juejin.cn/?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Findex.html" title="https://link.juejin.cn/?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Findex.html" target="_blank">godot-rust入门文档</a>。</p>
<p>本文搭建在<a href="https://juejin.cn/post/7599566082212986932" target="_blank" title="https://juejin.cn/post/7599566082212986932">godot-rust（gdext）创建项目</a>的基础之上，如果你对该部分内容感到生疏，可以先阅读这部分内容，为接下来的操作做好准备。</p>
<p><strong>注意，本文使用的godot版本为4.5.1，godot版本的变化可能会导致一些内容失效</strong>。</p>
<p>本文操作均在Windows上执行。</p>
<h2 data-id="heading-1">正文</h2>
<blockquote>
<p>在这个循序渐进的教程系列中，你将使用 Godot 创建你的第一个完整的 2D 游戏。在系列结束时，你将拥有一个简单而完整的游戏，如下图所示。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53d7ce7fbf0b4dfabf9c46cf3f45af4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770104889&amp;x-signature=dS0cI0KsY7%2FUeecvRR4WBBZOocQ%3D" alt="dodge_preview.webp" loading="lazy"/></p>
<p>这个游戏叫“Dodge the Creeps!”，游戏开始后，移动你的角色来躲避从屏幕周边生成的Creeps，</p>
<h3 data-id="heading-2">创建游戏项目</h3>
<p>按照<a href="https://juejin.cn/post/7599566082212986932" target="_blank" title="https://juejin.cn/post/7599566082212986932">godot-rust（gdext）创建项目</a>流程搭建好项目，此时项目结构看上去应该像这样：</p>
<pre><code class="hljs">📂 dodge-the-creeps-2d
│
├—— 📂 godot
│
├—— 📂 rust
</code></pre>
<p>制作游戏需要素材，比如声音、图片等，原教程中提供了素材包，点击  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgodotengine%2Fgodot-docs-project-starters%2Freleases%2Fdownload%2Flatest-4.x%2Fdodge_the_creeps_2d_assets.zip" target="_blank" title="https://github.com/godotengine/godot-docs-project-starters/releases/download/latest-4.x/dodge_the_creeps_2d_assets.zip" ref="nofollow noopener noreferrer">dodge_the_creeps_2d_assets.zip</a><br/>
下载它们。</p>
<p>解压后，将文件夹art和forts拷贝到godot文件夹下，此时你的godot编辑器的<strong>文件系统</strong>中看起来应该像这样：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c9b80c0fe154e9483503a19eca55bd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770104889&amp;x-signature=gSJAlyf%2FCMcIezHrXZLGSDb7f5E%3D" alt="godot导入游戏素材" loading="lazy"/></p>
<h3 data-id="heading-3">设置游戏项目</h3>
<p>从前面的示意图可知游戏设计为竖屏模式，因此需要调整游戏窗口大小，在编辑器的左上角点击<strong>项目</strong>-&gt;<strong>项目设置</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9eaaf9eb1a5c482aaf8d1c4e68bcb29c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770104889&amp;x-signature=wys4C9R45G1uP1DXp500IC4Nqzg%3D" alt="项目设置" loading="lazy"/></p>
<p>在项目设置窗口中选择<strong>常规</strong>-&gt;<strong>显示</strong>-&gt;<strong>窗口</strong>-&gt;<strong>大小</strong>，修改<strong>视口宽度</strong>为<code>480</code>，修改<strong>视口高度</strong>为<code>720</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/341fee33923548689f1431eae7bdf671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770104889&amp;x-signature=DTzvTqjlNUs1LNloNWUp6dDycH0%3D" alt="调整窗口大小" loading="lazy"/></p>
<p>向下滚动右侧设置区域，找到拉伸，设置<strong>模式</strong>为<code>canvas_items</code>、<strong>比例</strong>为<code>keep</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/316d61dfbf06456fa46f802480744c73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770104889&amp;x-signature=vpyDP8a8sPtixE357feZQhn6psA%3D" alt="微信图片_20260127152052_30_27.jpg" loading="lazy"/></p>
<blockquote>
<p>这样就可以保证在不同大小的屏幕上，游戏都能够进行一致的比例缩放。</p>
</blockquote>
<p>切换到2D编辑场景，你可以看到由几条不同颜色组成的区域，这个区域表示你刚刚设置的窗口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9db7b7a8b8e04695b10a3ac7116bd0c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770104889&amp;x-signature=HjMKIuQXQDyOmHFtUnPCDLV76M0%3D" alt="查看游戏场景" loading="lazy"/></p>
<h2 data-id="heading-4">参考</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fzh-cn%2F4.5%2Fgetting_started%2Ffirst_2d_game%2Findex.html" target="_blank" title="https://docs.godotengine.org/zh-cn/4.5/getting_started/first_2d_game/index.html" ref="nofollow noopener noreferrer">你的第一个 2D 游戏 — Godot Engine (4.5) 简体中文文档</a></li>
<li><a href="https://juejin.cn/post/7599566082212986932" target="_blank" title="https://juejin.cn/post/7599566082212986932">godot-rust（gdext）创建项目 - 掘金</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.rs%2Fgodot%2F0.4.5%2Fgodot%2F" target="_blank" title="https://docs.rs/godot/0.4.5/godot/" ref="nofollow noopener noreferrer">godot - Rust</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgodot-rust%2Fdemo-projects%2Ftree%2Fmaster%2Fdodge-the-creeps" target="_blank" title="https://github.com/godot-rust/demo-projects/tree/master/dodge-the-creeps" ref="nofollow noopener noreferrer">demo-projects/dodge-the-creeps at master · godot-rust/demo-projects · GitHub</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS -实战技巧：彻底搞定单行、多行文本溢出省略号显示]]></title>    <link>https://juejin.cn/post/7599835610405748782</link>    <guid>https://juejin.cn/post/7599835610405748782</guid>    <pubDate>2026-01-27T09:32:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599835610405748782" data-draft-id="7599640782570438683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS -实战技巧：彻底搞定单行、多行文本溢出省略号显示"/> <meta itemprop="keywords" content="前端,面试,CSS"/> <meta itemprop="datePublished" content="2026-01-27T09:32:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS -实战技巧：彻底搞定单行、多行文本溢出省略号显示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:32:42.000Z" title="Tue Jan 27 2026 09:32:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在 UI 布局中，为了保证页面的整洁，我们经常需要对超出容器范围的文本进行截断并显示省略号（...）。针对不同的布局需求和浏览器兼容性，通常有三种主要的实现方案。</p>
<h2 data-id="heading-1">一、 单行文本溢出省略</h2>
<p>这是最常用、兼容性最好的方案，适用于标题、标签等场景。</p>
<p><strong>核心代码：</strong></p>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-selector-class">.overflow-text</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;           <span class="hljs-comment">/* 必须设置宽度 */</span>
  <span class="hljs-attribute">white-space</span>: nowrap;    <span class="hljs-comment">/* 1. 强制文字不换行 */</span>
  <span class="hljs-attribute">overflow</span>: hidden;       <span class="hljs-comment">/* 2. 隐藏超出部分 */</span>
  <span class="hljs-attribute">text-overflow</span>: ellipsis; <span class="hljs-comment">/* 3. 使用省略号代替被截断文字 */</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-2">二、 多行文本溢出省略（WebKit 内核方案）</h2>
<p>这是目前移动端和现代浏览器（Chrome, Safari, Edge）最常用的方案。它利用了 WebKit 的私有属性，实现简单且效果精准。</p>
<p><strong>核心代码：</strong></p>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-selector-class">.multi-overflow</span> {
  <span class="hljs-attribute">display</span>: -webkit-box;           <span class="hljs-comment">/* 1. 必须结合 box 模型使用 */</span>
  -webkit-box-orient: vertical;   <span class="hljs-comment">/* 2. 设置伸缩盒子的子元素排列方式 */</span>
  -webkit-line-clamp: <span class="hljs-number">2</span>;          <span class="hljs-comment">/* 3. 限制显示的行数 */</span>
  <span class="hljs-attribute">overflow</span>: hidden;               <span class="hljs-comment">/* 4. 隐藏超出范围的内容 */</span>
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：该属性虽然是 WebKit 私有，但目前主流浏览器支持度已经非常高，是实际开发的首选。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">三、 自定义多行省略（伪元素方案）</h2>
<p>如果你需要兼容一些不支持 <code>line-clamp</code> 的旧版浏览器，或者需要更灵活的自定义样式，可以使用伪元素模拟。</p>
<p><strong>核心代码：</strong></p>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-selector-class">.demo</span> {
  <span class="hljs-attribute">position</span>: relative;     <span class="hljs-comment">/* 为伪元素提供定位参照 */</span>
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">20px</span>;      <span class="hljs-comment">/* 行高 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;           <span class="hljs-comment">/* 高度必须是行高的整数倍（此处为2行） */</span>
  <span class="hljs-attribute">overflow</span>: hidden;       <span class="hljs-comment">/* 隐藏多余内容 */</span>
  <span class="hljs-attribute">word-break</span>: break-all;
}

<span class="hljs-selector-class">.demo</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">"..."</span>;         <span class="hljs-comment">/* 插入省略号 */</span>
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">background</span>: white;      <span class="hljs-comment">/* 关键：背景色需与容器背景一致，遮盖末尾文字 */</span>
}
</code></pre>
<p><strong>方案优缺点：</strong></p>
<ul>
<li><strong>优点</strong>：兼容性极佳。</li>
<li><strong>缺点</strong>：即使文字没超出行数，省略号也会一直显示（可通过 JS 判断高度动态添加类名来解决）。</li>
</ul>
<hr/>
<h2 data-id="heading-4">四、 总结与最佳实践</h2>

























<table><thead><tr><th><strong>需求场景</strong></th><th><strong>推荐方案</strong></th><th><strong>关键词</strong></th></tr></thead><tbody><tr><td><strong>单行文本</strong></td><td>标准 CSS 方案</td><td><code>nowrap</code> + <code>ellipsis</code></td></tr><tr><td><strong>移动端/现代浏览器</strong></td><td>WebKit 方案</td><td><code>-webkit-line-clamp</code></td></tr><tr><td><strong>极端兼容性要求</strong></td><td>伪元素方案</td><td><code>::after</code> + 绝对定位</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 深度解析：JS 数组的性能黑洞与 V8 引擎的“潜规则”]]></title>    <link>https://juejin.cn/post/7599828354515402792</link>    <guid>https://juejin.cn/post/7599828354515402792</guid>    <pubDate>2026-01-27T09:35:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599828354515402792" data-draft-id="7599852579067330575" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 深度解析：JS 数组的性能黑洞与 V8 引擎的“潜规则”"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-27T09:35:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iDao技术魔方"/> <meta itemprop="url" content="https://juejin.cn/user/166781496080782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 深度解析：JS 数组的性能黑洞与 V8 引擎的“潜规则”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781496080782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iDao技术魔方
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:35:55.000Z" title="Tue Jan 27 2026 09:35:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、那个让服务器 CPU 飙升 100% 的“...”</h2>
<p>上周五下午 4:50，正当我准备收工去吃火锅时，告警群突然炸了。某核心微服务的 CPU 占用率瞬间从 15% 飙升到 100%，内存也在疯狂抖动。</p>
<p>定位代码后，我发现了一行看起来人畜无害的代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 为了合并三个从数据库查出来的结果集（每个约 5 万条数据）</span>
<span class="hljs-keyword">const</span> combinedData = [...largeArray1, ...largeArray2, ...largeArray3];
</code></pre>
<p>在开发环境下一切正常，但在高并发、大数据量的生产场景下，这一行代码直接成了“性能杀手”。</p>
<p><strong>为什么？</strong> 很多人觉得 ES6 的扩展运算符（Spread Operator）只是 <code>Array.prototype.concat</code> 的语法糖，但实际上，V8 对它们的处理逻辑有着天壤之别。</p>
<hr/>
<h2 data-id="heading-1">二、V8 引擎的“潜规则”：数组的几种形态</h2>
<p>在 V8 引擎内部，数组并不是简单的线性表。为了极致的性能，V8 会根据数组存储的内容动态切换存储模式。如果你不了解这些，你的代码可能正在悄悄拖慢整个系统的速度。</p>
<h3 data-id="heading-2">1. Packed vs Holey (连续 vs 有洞)</h3>
<p>这是数组性能的分水岭。</p>
<ul>
<li><strong>Packed (连续数组)</strong>：数组中所有的索引都有值。V8 可以直接计算偏移量，性能接近 C++ 数组。</li>
<li><strong>Holey (有洞数组)</strong>：数组中存在缺失的索引（例如 <code>const arr = [1, , 3]</code>）。一旦数组变“洞”，V8 就必须在原型链上进行查找，甚至退化到“字典模式”，性能骤降。</li>
</ul>
<p><strong>避坑案例</strong>：千万不要用 <code>delete arr[0]</code> 来删除元素，这会产生一个永久的“洞”。请务必使用 <code>splice</code>。</p>
<h3 data-id="heading-3">2. Smi -&gt; Double -&gt; Elements (类型演化)</h3>
<ul>
<li><strong>Smi (Small Integer)</strong>：存储的是小整数，这是最快的一种模式。</li>
<li><strong>Double</strong>：一旦你往数组推入一个浮点数，数组就会演变为 Double 模式，涉及到“装箱/拆箱”开销。</li>
<li><strong>Elements</strong>：一旦推入对象或混合类型，性能最慢。</li>
</ul>
<p><strong>重点</strong>：这种演化是不可逆的。即使你把对象删掉，数组依然会保留在 Elements 模式。</p>
<hr/>
<h2 data-id="heading-4">三、性能大 PK：ES5 方法 vs ES6 新特性</h2>
<h3 data-id="heading-5">1. 扩展运算符 (...) vs Array.concat</h3>
<p>回到开头的事故案例。为什么 <code>[...a, ...b]</code> 慢？</p>
<ul>
<li><strong>扩展运算符 (...)</strong>：它本质上是调用数组的<strong>迭代器（Iterator）</strong>。V8 必须逐个遍历元素并推入新数组，这涉及到大量的函数调用和迭代开销。</li>
<li><strong>Array.prototype.concat</strong>：它是高度优化的内置方法。V8 内部可以直接进行<strong>内存块拷贝 (Memcpy)</strong>，完全不经过 JavaScript 层的迭代。</li>
</ul>
<p><strong>实测数据</strong>：在处理 10 万级数据合并时，<code>concat</code> 比 <code>spread</code> 快了近 3 倍，且内存峰值更低。</p>
<h3 data-id="heading-6">2. for vs forEach vs for...of</h3>
<ul>
<li><strong>for 循环</strong>：永远的王者，没有任何额外开销。</li>
<li><strong>forEach (ES5)</strong>：带回调函数。早期由于闭包和函数调用开销确实慢，但现代 V8 通过 <strong>Inlining (内联优化)</strong>，在大多数场景下已经能和 <code>for</code> 循环平起平坐。</li>
<li><strong>for...of (ES6)</strong>：基于迭代器。虽然语法优美，但在极高性能要求的循环中，迭代器的创建和 <code>next()</code> 调用依然存在细微开销。</li>
</ul>
<h3 data-id="heading-7">3. find (ES6) vs filter (ES5)</h3>
<p>如果你只需要找一个元素，永远不要用 <code>filter().length</code>：</p>
<ul>
<li><code>find()</code> 是<strong>短路操作</strong>，找到即停。</li>
<li><code>filter()</code> 会完整遍历数组并创建一个<strong>中间数组</strong>，浪费 CPU 和内存。</li>
</ul>
<hr/>
<h2 data-id="heading-8">四、如何编写“高性能”的数组代码？</h2>
<p>作为一名资深工程师，建议你在核心链路遵循以下原则：</p>
<h3 data-id="heading-9">1. 预分配数组空间</h3>
<p>如果你预先知道数组的大小，直接 <code>new Array(size)</code> 比不断 <code>push</code> 要快。不断 <code>push</code> 会触发 V8 的动态扩容逻辑，导致内存重新分配和数据迁移。</p>
<h3 data-id="heading-10">2. 保持数组的“纯净度”</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]; <span class="hljs-comment">// Smi 模式，极速</span>
arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">4.5</span>);         <span class="hljs-comment">// 退化为 Double 模式</span>
arr.<span class="hljs-title function_">push</span>(<span class="hljs-string">'oops'</span>);      <span class="hljs-comment">// 退化为 Elements 模式，性能滑坡</span>
</code></pre>
<p>尽量让数组内部存储同类型的数据，尤其是避免在高性能循环中混合数字和对象。</p>
<h3 data-id="heading-11">3. 大数据合并禁用 Spread</h3>
<p>在 React/Redux 的 reducer 中，我们习惯了 <code>return [...state, newItem]</code>。如果 state 只有几十个元素没问题，但如果是上万条记录的列表，请改用 <code>concat</code> 或先 <code>push</code> 再返回。</p>
<hr/>
<h2 data-id="heading-12">五、总结</h2>
<p>性能优化不是为了“卷”语法，而是为了理解底层逻辑。</p>
<ol>
<li><strong>小规模数据</strong>：语义清晰最重要，大方使用 ES6 扩展符和 <code>for...of</code>。</li>
<li><strong>大规模数据 (万级以上)</strong>：回归 <code>for</code> 循环与 <code>concat</code>，警惕迭代器开销。</li>
<li><strong>核心库开发</strong>：必须关注 Packed/Holey 状态，确保数组在 V8 内部保持最快路径。</li>
</ol>
<p>那天凌晨三点，当我把 <code>spread</code> 改回 <code>concat</code> 后，CPU 监控曲线瞬间恢复了平滑，我也终于赶上了那顿火锅。</p>
<hr/>
<p><em>「iDao 技术魔方」—— 聚焦 AI、前端、全栈矩阵，让技术落地更有深度。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Logrotate实践指南]]></title>    <link>https://juejin.cn/post/7599828354515435560</link>    <guid>https://juejin.cn/post/7599828354515435560</guid>    <pubDate>2026-01-27T09:38:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599828354515435560" data-draft-id="7599873006257405986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Logrotate实践指南"/> <meta itemprop="keywords" content="运维,自动化运维"/> <meta itemprop="datePublished" content="2026-01-27T09:38:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lihouyi"/> <meta itemprop="url" content="https://juejin.cn/user/4365493763322599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Logrotate实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4365493763322599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lihouyi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:38:56.000Z" title="Tue Jan 27 2026 09:38:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Logrotate实践指南</h2>
<p>在 Linux 长期运行的服务器中，日志文件就像一条贪吃蛇</p>
<p>很多新人运维/开发的习惯是写个 Crontab 脚本 <code>rm -rf *.log</code>，或者手动删除大文件。结果往往是：<strong>文件没了，磁盘空间依然被占用</strong></p>
<blockquote>
<p><strong>💡 根本原因</strong>：Linux 文件系统通过 <strong>Inode</strong> 管理文件。如果一个进程（如 Java/Nginx）打开了日志文件，它就持有该 Inode 的句柄。你删除了文件名，只是删除了目录项，只要进程不释放句柄，磁盘块就永远不会标记为“空闲”。</p>
</blockquote>
<p>我们需要的是 <strong>Logrotate</strong> —— Linux 的御用“垃圾分类回收工”</p>
<h3 data-id="heading-1">核心原理</h3>
<p>Logrotate 是 Linux 系统中最标准的日志管理工具，主要用于防止日志文件无限增长导致磁盘空间耗尽，同时支持日志归档与轮转，便于后续查询和管理</p>
<h4 data-id="heading-2">触发机制</h4>
<p>很多人误以为 Logrotate 是守护进程，其实它只是一个由 <code>cron</code> 或 <code>systemd</code> 唤醒的普通 CLI 工具。具体触发方式因发行版和配置而异，主要有以下两种：</p>
<ul>
<li>通过 systemd 定时器</li>
</ul>
<p>某些系统使用 <code>logrotate.timer</code> 来定期触发 <code>logrotate.service</code></p>
<pre><code class="hljs language-bash" lang="bash">systemctl status logrotate.timer
</code></pre>
<ul>
<li>通过传统 cron 任务</li>
</ul>
<p>在其他系统中，logrotate 通常由 cron 或 anacron 调度，其脚本位于 <code>/etc/cron.daily/logrotate</code>，由 crond 服务每日执行一次</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> /etc/cron.daily/logrotate    <span class="hljs-comment"># 查看脚本是否存在</span>
systemctl status crond          <span class="hljs-comment"># 检查 cron 服务是否运行</span>
</code></pre>
<blockquote>
<p>无论采用哪种方式，<code>logrotate</code> 都是“按需运行”，执行完毕即退出，不会长期驻留内存</p>
</blockquote>
<h4 data-id="heading-3">模式A：Create + Signal</h4>
<p><strong>适用</strong>：Nginx, Apache, PHP-FPM 等支持重载信号（Reload）的服务</p>
<blockquote>
<p><strong>原理</strong>：利用 Linux <code>mv</code> (rename) 的原子性。重命名文件不改变 Inode，进程继续写“旧”文件，直到收到信号切换到新文件</p>
</blockquote>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Logrotate
    participant FileSystem
    participant Nginx
    
    Note over Nginx: 正在写入 access.log (Inode: 101)
    Logrotate-&gt;&gt;FileSystem: mv access.log access.log.1
    Note over FileSystem: Inode 101 没变&lt;br/&gt;Nginx 仍在写 access.log.1
    Logrotate-&gt;&gt;FileSystem: create new access.log (Inode: 102)
    Logrotate-&gt;&gt;Nginx: 发送 kill -USR1 信号
    Nginx-&gt;&gt;Nginx: 收到信号，重新打开日志句柄
    Note over Nginx: 切换写入 access.log (Inode: 102)
    Note over FileSystem: 此时 Logrotate 可安全压缩 access.log.1
</code></pre>
<h4 data-id="heading-4">模式B：Copytruncate</h4>
<p><strong>适用</strong>：Java (Spring Boot)，Python, Go 等将日志重定向到文件且无法响应重载信号的应用</p>
<blockquote>
<p><strong>原理</strong>：先把内容拷出来，再把原文件“清零”</p>
<p><strong>⚠️风险</strong>：在“复制完”到“清空”的几毫秒时间窗口内，如果应用写入新数据，这些数据会<strong>永久丢失</strong>！</p>
</blockquote>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[应用持续写入 log] --&gt; B{Logrotate 介入}
    B -- Step 1: cp log log.1 --&gt; C[生成归档]
    B -- Step 2: truncate -s 0 log --&gt; D[原文件大小归零]
    D -- 句柄不变 --&gt; A
    style B fill:#f9f,stroke:#333
    style D fill:#ff5555,stroke:#333
</code></pre>
<h4 data-id="heading-5">两种模式对比</h4>
<p>理解这两种模式的区别是避免“日志丢失”和“进程写错文件”的关键</p>













































<table><thead><tr><th>维度</th><th>Create + Signal（推荐）</th><th>Copytruncate</th></tr></thead><tbody><tr><td>定位</td><td>标准原子级方案</td><td>仅作为兜底方案</td></tr><tr><td>适用对象</td><td>支持重载信号的服务（Nginx、Apache、PHP、Rsyslog）</td><td>无法重载/感知信号的进程（Java、Python、Go 重定向日志）</td></tr><tr><td>底层原理</td><td><strong>Inode 机制</strong>：重命名文件不改变 Inode，进程持有的句柄依然有效，数据持续写入旧文件直到被信号中断</td><td><strong>I/O 读写</strong>：将日志内容物理复制一份，然后利用系统调用将原文件大小强行归零</td></tr><tr><td>执行步骤</td><td>1. 重命名日志<br/>2. 创建新的空白日志文件<br/>3. 发送信号通知应用（kill -USR1）应用切换到新句柄</td><td>1. 将当前日志内容复制出来（cp access.log access.log.1）<br/>2. 瞬间清空原日志文件（truncate -s 0 access.log）</td></tr><tr><td>数据完整性</td><td><strong>安全 (0丢失)</strong>：全过程无时间窗口，原子操作</td><td><strong>有风险 (存在丢失窗口)</strong>：在“复制完”到“清空”的几毫秒内，如果应用写入新数据，这些数据会随清空动作彻底丢失</td></tr><tr><td>性能损耗</td><td><strong>极低</strong>：重命名只是元数据修改，瞬间完成</td><td><strong>较高</strong>：若日志文件高达数GB，复制过程会产生显著磁盘 I/O 峰值</td></tr><tr><td>配置关键字</td><td>create 0640 user group<br/>postrotate (发送信号)</td><td>copytruncate<br/>无需 create 或 postrotate</td></tr></tbody></table>
<h3 data-id="heading-6">配置文件</h3>
<p>不要直接改 <code>/etc/logrotate.conf</code>，请在 <code>/etc/logrotate.d/</code> 下创建独立文件！</p>
<h4 data-id="heading-7">全参数详解</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局或指定日志文件的通用配置块</span>
/var/log/application/*.<span class="hljs-built_in">log</span> {

    <span class="hljs-comment"># 周期与触发条件</span>
    daily                     <span class="hljs-comment"># [推荐] 按天轮替 (最常用)</span>
    <span class="hljs-comment"># weekly                  # [可选] 按周轮替</span>
    <span class="hljs-comment"># monthly                 # [可选] 按月轮替</span>
    <span class="hljs-comment"># hourly                  # [特殊] 按小时 (需系统 cron.hourly 支持或配合 Systemd Timer)</span>
    
    maxsize 100M              <span class="hljs-comment"># [推荐] 优先满足周期，但若文件超过 100M 则提前切分</span>
    <span class="hljs-comment"># size 100M               # [可选] 忽略周期限制，只要超过 100M 立即切分</span>
    <span class="hljs-comment"># minsize 10M             # [可选] 周期到了后，必须同时满足大于 10M 才切分</span>


    <span class="hljs-comment"># 保留与清理</span>
    rotate 30                 <span class="hljs-comment"># [必选] 保留最近 30 份归档日志</span>
    maxage 90                 <span class="hljs-comment"># [可选] 清理超过 90 天的旧归档 (兜底策略，清理 rotate 漏掉的)</span>
    <span class="hljs-comment"># mail admin@example.com  # [可选] 轮替时将日志发送邮件 (现代运维较少使用)</span>


    <span class="hljs-comment"># 压缩策略</span>
    compress                  <span class="hljs-comment"># [推荐] 开启 gzip 压缩 (access.log-20230101.gz)</span>
    <span class="hljs-comment"># nocompress              # [可选] 不压缩</span>

    delaycompress             <span class="hljs-comment"># [核心] 延迟一天压缩。切分出的最新归档暂时保持明文</span>
                              <span class="hljs-comment"># 作用：防止应用在切分后还有极短时间在写旧文件，避免数据写入损坏的压缩包</span>
    
    <span class="hljs-comment"># 文件名与格式</span>
    dateext                   <span class="hljs-comment"># [推荐] 使用日期作为后缀 (如 access.log-20231001)</span>
    <span class="hljs-comment"># nodateext               # [可选] 使用数字递增后缀 (如 access.log.1, access.log.2)</span>
    
    dateformat -%Y-%m-%d      <span class="hljs-comment"># [可选] 自定义日期格式</span>
    <span class="hljs-comment"># dateyesterday           # [技巧] 在后缀中使用昨天的日期 (便于 T+1 日志分析)</span>


    <span class="hljs-comment"># 容错与权限</span>
    missingok                 <span class="hljs-comment"># [推荐] 日志源文件不存在时不报错</span>
    <span class="hljs-comment"># nomissingok             # [默认] 文件不存在则报错中断</span>
    
    notifempty                <span class="hljs-comment"># [推荐] 如果日志为空 (0KB)，不进行轮替</span>
    <span class="hljs-comment"># ifempty                 # [默认] 即使是空文件也强制轮替</span>


    <span class="hljs-comment"># 核心运作模式 (二选一，切勿同时开启)</span>
    <span class="hljs-comment"># --- 模式 A：Create + Signal (推荐：Nginx, Apache) ---</span>
    <span class="hljs-comment"># create 0640 nginx root  # 切分后立即创建新文件，并赋予指定权限</span>
    <span class="hljs-comment"># sharedscripts           # 多个日志文件只执行一次 postrotate 脚本</span>
    <span class="hljs-comment"># postrotate              # 脚本：通知应用重新打开日志句柄</span>
    <span class="hljs-comment">#     /bin/kill -USR1 `cat /var/run/nginx.pid`</span>
    <span class="hljs-comment"># endscript</span>

    <span class="hljs-comment"># --- 模式 B：Copytruncate (妥协：Java, Python Stdout) ---</span>
    copytruncate              <span class="hljs-comment"># 复制内容到归档后，直接清空原文件 (不推荐但实用)</span>
    <span class="hljs-comment"># nocopytruncate          # [默认] 不使用此模式</span>
    
    <span class="hljs-comment"># --- 权限修正 (特殊场景) ---</span>
    <span class="hljs-comment"># su appuser appgroup     # [特殊] 如果日志目录属于非 root 用户，必须显式指定切换用户</span>
}
</code></pre>
<h4 data-id="heading-8">生产环境配置模板</h4>
<ul>
<li>场景一：Nginx（Signal 重载模式），路径 <code>/etc/logrotate.d/nginx-custom</code></li>
</ul>
<pre><code class="hljs language-bash" lang="bash">/var/log/nginx/*.<span class="hljs-built_in">log</span> {
    daily                       <span class="hljs-comment"># 每天切割</span>
    dateext                     <span class="hljs-comment"># 使用日期作为后缀</span>
    dateformat -%Y-%m-%d        <span class="hljs-comment"># 显式指定日期格式</span>
    rotate 30                   <span class="hljs-comment"># 保留30天</span>
    compress                    <span class="hljs-comment"># 开启压缩</span>
    delaycompress               <span class="hljs-comment"># 延迟一天压缩，给Nginx缓冲时间</span>
    missingok
    notifempty
    create 0640 nginx root      <span class="hljs-comment"># 切割后创建新文件的权限</span>
    sharedscripts               <span class="hljs-comment"># 切割所有log后只 reload 一次 nginx</span>
    
    postrotate
        <span class="hljs-keyword">if</span> [ -f /var/run/nginx.pid ]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">kill</span> -USR1 `<span class="hljs-built_in">cat</span> /var/run/nginx.pid`
        <span class="hljs-keyword">fi</span>
    endscript
}
</code></pre>
<ul>
<li>场景二：Java 应用（Copytruncate 模式），路径 <code>/etc/logrotate.d/app-java</code></li>
</ul>
<p>对于 <code>java -jar app.jar &gt; app.log &amp;</code> 这种无法接收信号的应用，我们只能妥协，但要做足安全措施</p>
<pre><code class="hljs language-bash" lang="bash">/home/app/logs/app.log {
    daily
    dateext
    rotate 60
    missingok
    compress
    delaycompress
    notifempty
    copytruncate        <span class="hljs-comment"># 关键！复制并清空，应用不需要重启</span>
    
    <span class="hljs-comment"># 强制风控：防止单日日志也撑爆磁盘</span>
    <span class="hljs-comment"># 即使 crontab 是每天一次，加上这个size参数可以在手工执行时优先生效</span>
    maxsize 500M 
    
    <span class="hljs-comment"># 权限修复：解决“父目录权限不足”问题</span>
    su appuser appgroup
}
</code></pre>
<h4 data-id="heading-9">进阶：如何处理 TB 级流量</h4>
<blockquote>
<p>默认的 daily 无法满足 TB 级流量需求，我们需要 Logrotate 每小时执行。同时，为了防止某一时段流量极小产生大量空日志，或者流量极大撑爆磁盘，我们需要结合 crond 和 size 策略</p>
</blockquote>
<ul>
<li>自定义 Logrotate 配置文件</li>
</ul>
<p>不要放在 <code>/etc/logrotate.d/</code>（系统默认的 daily 任务)，而是创建一个独立目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /etc/logrotate.hourly.d/

vi /etc/logrotate.hourly.d/fast-app
</code></pre>
<p>配置中必须包含 <code>size</code> 或 <code>maxsize</code> 来确保未满大小时不误切（虽然设为 hourly，但双重保险更好）：</p>
<pre><code class="hljs language-bash" lang="bash">/var/log/fast-app.log {
    rotate 24                   <span class="hljs-comment"># 保留24小时</span>
    maxsize 100M                <span class="hljs-comment"># 双重保险：超100M也切</span>
    missingok
    notifempty
    compress
    delaycompress
    create 0644 root root
    
    dateext
    <span class="hljs-comment"># 必须精确到小时，否则第二次切割会失败</span>
    dateformat -%Y%m%d-%H 
    
    postrotate
        /bin/kill -USR1 `<span class="hljs-built_in">cat</span> /var/run/nginx.pid 2&gt;/dev/null` 2&gt; /dev/null || <span class="hljs-literal">true</span>
    endscript
}
</code></pre>
<ul>
<li>由于这不是标准的系统任务，我们需要手动在 crontab 中指定调度，<code>crontab -e</code></li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 每小时的第59分钟，调用 logrotate 读取刚才的独立配置</span>
<span class="hljs-comment"># 解释：这里不需要加 -f (强制)，因为我们在配置文件里写了 maxsize 或 size</span>
<span class="hljs-comment"># 只要文件大小或时间满足条件，logrotate 自然会工作</span>
59 * * * * /usr/sbin/logrotate /etc/logrotate.hourly.d/fast-app
</code></pre>
<h3 data-id="heading-10">调试与验证</h3>
<p>部署配置后，直接干等是不合格的运维。必须掌握以下三板斧：</p>
<ul>
<li>Debug 模式（演习）</li>
</ul>
<p>不会产生任何文件变动，只会输出解析过程。用来检查配置文件有没有语法错误</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># -d 参数 = Debug</span>
logrotate -d /etc/logrotate.d/nginx-custom
</code></pre>
<ul>
<li>Verbose 模式（实操但带回显）</li>
</ul>
<p>执行实际切割，并打印细节</p>
<pre><code class="hljs language-bash" lang="bash">logrotate -v /etc/logrotate.d/nginx-custom
</code></pre>
<ul>
<li>Force 模式（强制立刻切割）</li>
</ul>
<p><strong>即使未满足切割时间/大小条件</strong>，也强制进行一次轮替。用于上线后立即验证权限和 postrotate 脚本是否正确</p>
<pre><code class="hljs language-bash" lang="bash">logrotate -f /etc/logrotate.d/nginx-custom
</code></pre>
<blockquote>
<p><strong>结语</strong>：Logrotate 虽小，却是 Linux 稳定性建设的基石。对于生产环境，始终建议开启 <code>delaycompress</code> 保护数据，优先使用 <code>create</code> 模式而非 <code>copytruncate</code>，并一定要在上线前使用 <code>logrotate -d</code> 进行沙箱演练</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1-1.【GCD】DispatchQueue 本质上是什么？它和线程是什么关系？]]></title>    <link>https://juejin.cn/post/7599708108621479987</link>    <guid>https://juejin.cn/post/7599708108621479987</guid>    <pubDate>2026-01-27T09:35:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599708108621479987" data-draft-id="7599850148055384073" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1-1.【GCD】DispatchQueue 本质上是什么？它和线程是什么关系？"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2026-01-27T09:35:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="项阿丑"/> <meta itemprop="url" content="https://juejin.cn/user/1407852323023447"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1-1.【GCD】DispatchQueue 本质上是什么？它和线程是什么关系？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1407852323023447/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    项阿丑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:35:53.000Z" title="Tue Jan 27 2026 09:35:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>DispatchQueue</code> 是 <strong>GCD（Grand Central Dispatch）的核心抽象</strong>，它本质上是一个 <strong>任务调度管理器</strong>，而不是线程本身。</p>
<h2 data-id="heading-0">本质特性</h2>
<h3 data-id="heading-1">1. <strong>任务队列</strong></h3>
<ul>
<li>存储要执行的任务（闭包或函数）</li>
<li>遵循 FIFO（先进先出）原则</li>
<li>可以是串行（serial）或并发（concurrent）</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 串行队列 - 一次执行一个任务</span>
<span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">serialQueue</span> = <span class="hljs-selector-tag">DispatchQueue</span>(<span class="hljs-attribute">label</span>: <span class="hljs-string">"com.example.serial"</span>)

<span class="hljs-comment">// 并发队列 - 可同时执行多个任务</span>
<span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">concurrentQueue</span> = <span class="hljs-selector-tag">DispatchQueue</span>(<span class="hljs-attribute">label</span>: <span class="hljs-string">"com.example.concurrent"</span>, <span class="hljs-attribute">attributes</span>: .concurrent)
</code></pre>
<h3 data-id="heading-2">2. <strong>线程池管理器</strong></h3>
<ul>
<li>管理底层线程池（thread pool）</li>
<li>自动复用线程，避免频繁创建销毁</li>
<li>根据系统负载动态调整线程数</li>
</ul>
<h2 data-id="heading-3">与线程的关系</h2>
<h3 data-id="heading-4">关键区别</h3>

























<table><thead><tr><th><strong>DispatchQueue</strong></th><th><strong>线程 (Thread)</strong></th></tr></thead><tbody><tr><td>高级抽象，任务调度器</td><td>低级执行单元</td></tr><tr><td>管理任务执行顺序</td><td>CPU调度的基本单位</td></tr><tr><td>自动线程管理</td><td>需要手动管理生命周期</td></tr><tr><td>系统优化负载均衡</td><td>固定资源占用</td></tr></tbody></table>
<h3 data-id="heading-5">实际关系</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 示例：队列与线程的关系</span>
<span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">queue</span> = <span class="hljs-selector-tag">DispatchQueue</span>(<span class="hljs-attribute">label</span>: <span class="hljs-string">"test"</span>, <span class="hljs-attribute">attributes</span>: .concurrent)

<span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">i</span> <span class="hljs-selector-tag">in</span> <span class="hljs-number">1</span>..<span class="hljs-selector-class">.5</span> {
    <span class="hljs-selector-tag">queue</span><span class="hljs-selector-class">.async</span> {
        <span class="hljs-selector-tag">print</span>(<span class="hljs-string">"任务 (i) 在线程: (Thread.current)"</span>)
    }
}

<span class="hljs-comment">// 可能输出（线程会被复用）：</span>
<span class="hljs-comment">// 任务1在线程: &lt;NSThread: 0x...&gt;{number = 4, name = (null)}</span>
<span class="hljs-comment">// 任务2在线程: &lt;NSThread: 0x...&gt;{number = 5, name = (null)}</span>
<span class="hljs-comment">// 任务3在线程: &lt;NSThread: 0x...&gt;{number = 4, name = (null)} // 线程复用！</span>
</code></pre>
<h2 data-id="heading-6">重要特性</h2>
<h3 data-id="heading-7">1. <strong>线程复用</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// GCD 自动复用线程，提高性能</span>
<span class="hljs-comment">// 不会为每个任务都创建新线程</span>
</code></pre>
<h3 data-id="heading-8">2. <strong>队列层级</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 主队列 - 主线程，UI更新</span>
DispatchQueue.main.<span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 更新UI</span>
}

<span class="hljs-comment">// 全局队列 - 系统提供的并发队列</span>
<span class="hljs-keyword">let</span> globalQueue = DispatchQueue.<span class="hljs-keyword">global</span>(qos: .background)

<span class="hljs-comment">// 自定义队列</span>
<span class="hljs-keyword">let</span> customQueue = DispatchQueue(label: <span class="hljs-string">"custom"</span>)
</code></pre>
<h3 data-id="heading-9">3. <strong>避免线程爆炸</strong></h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ❌ 错误：直接创建大量线程</span>
<span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>...<span class="hljs-number">1000</span> {
    Thread {
        <span class="hljs-comment">// 工作</span>
    }.<span class="hljs-title function_ invoke__">start</span>()
}

<span class="hljs-comment">// ✅ 正确：使用队列，系统自动管理</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">queue</span> = DispatchQueue.<span class="hljs-title function_ invoke__">global</span>()
<span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>...<span class="hljs-number">1000</span> {
    queue.<span class="hljs-keyword">async</span> {
        <span class="hljs-comment">// 工作 - 系统会合理分配线程</span>
    }
}
</code></pre>
<h2 data-id="heading-10">最佳实践</h2>
<h3 data-id="heading-11">1. <strong>选择合适队列</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// UI更新用主队列</span>
DispatchQueue.main.<span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 更新UI</span>
}

<span class="hljs-comment">// 后台任务用全局队列</span>
DispatchQueue.<span class="hljs-keyword">global</span>(qos: .userInitiated).<span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 耗时任务</span>
    DispatchQueue.main.<span class="hljs-keyword">async</span> {
        <span class="hljs-comment">// 完成后更新UI</span>
    }
}
</code></pre>
<h3 data-id="heading-12">2. <strong>避免阻塞主队列</strong></h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ❌ 错误：在主队列执行耗时操作</span>
DispatchQueue<span class="hljs-selector-class">.main</span><span class="hljs-selector-class">.async</span> {
    let data = <span class="hljs-built_in">processLargeData</span>() <span class="hljs-comment">// 阻塞UI</span>
    <span class="hljs-built_in">updateUI</span>(data)
}

<span class="hljs-comment">// ✅ 正确：在后台处理</span>
DispatchQueue<span class="hljs-selector-class">.global</span>(qos: .userInitiated)<span class="hljs-selector-class">.async</span> {
    let data = <span class="hljs-built_in">processLargeData</span>()
    DispatchQueue<span class="hljs-selector-class">.main</span><span class="hljs-selector-class">.async</span> {
        <span class="hljs-built_in">updateUI</span>(data)
    }
}
</code></pre>
<h2 data-id="heading-13">总结</h2>
<p><strong>DispatchQueue 是线程的智能调度器</strong>：</p>
<ul>
<li>它 <strong>管理</strong> 任务，让开发者专注于"做什么"</li>
<li>它 <strong>隐藏</strong> 线程细节，自动优化资源使用</li>
<li>它 <strong>保证</strong> 任务按照指定顺序和方式执行</li>
</ul>
<p>GCD 通过 <code>DispatchQueue</code> 将开发者从繁琐的线程管理中解放出来，让并发编程变得更简单、更高效、更安全。</p>
<h2 data-id="heading-14">👉 追问：为什么说 GCD 是“基于队列而不是线程”的并发模型？</h2>
<p>说 GCD 是"基于队列而不是线程"的并发模型，<strong>核心在于它将并发抽象的重心从"谁执行"（线程）转移到了"什么被执行"（任务）以及"如何组织执行"（队列）。</strong></p>
<h2 data-id="heading-15">核心思想对比</h2>
<h3 data-id="heading-16">传统线程模型</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 关注的是"执行者"</span>
<span class="hljs-keyword">let</span> thread1 = Thread { <span class="hljs-comment">/* 任务A */</span> }
<span class="hljs-keyword">let</span> thread2 = Thread { <span class="hljs-comment">/* 任务B */</span> }
thread1.start()
thread2.start()
<span class="hljs-comment">// 你需要管理：创建线程、分配任务、协调线程、销毁线程</span>
</code></pre>
<h3 data-id="heading-17">GCD 队列模型</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 关注的是"任务组织"</span>
let queue = <span class="hljs-built_in">DispatchQueue</span>(label: <span class="hljs-string">"work"</span>, attributes: .concurrent)
queue.async { <span class="hljs-comment">/* 任务A */</span> }  <span class="hljs-comment">// 我只管提交任务</span>
queue.async { <span class="hljs-comment">/* 任务B */</span> }  <span class="hljs-comment">// 系统决定如何执行</span>
<span class="hljs-comment">// 你只需要：定义任务、选择队列、提交任务</span>
</code></pre>
<h2 data-id="heading-18">为什么这个区别很重要？</h2>
<h3 data-id="heading-19">1. <strong>解耦任务与执行资源</strong></h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 传统线程：任务和线程强绑定</span>
Thread {
    <span class="hljs-built_in">downloadImage</span>()  <span class="hljs-comment">// 任务绑定到这个特定线程</span>
}

<span class="hljs-comment">// GCD：任务和线程解耦</span>
queue<span class="hljs-selector-class">.async</span> {
    <span class="hljs-built_in">downloadImage</span>()  <span class="hljs-comment">// 任务提交到队列，系统分配线程</span>
}
<span class="hljs-comment">// 同一个任务在不同时间可能由不同线程执行</span>
</code></pre>
<h3 data-id="heading-20">2. <strong>从"微观管理"到"宏观调度"</strong></h3>





















<table><thead><tr><th><strong>传统线程编程</strong></th><th><strong>GCD 队列编程</strong></th></tr></thead><tbody><tr><td>思考：需要多少线程？</td><td>思考：任务如何组织？</td></tr><tr><td>担心：线程创建/销毁开销</td><td>专注：任务依赖和顺序</td></tr><tr><td>操心：线程同步和通信</td><td>利用：队列的同步特性</td></tr></tbody></table>
<h3 data-id="heading-21">3. <strong>编程模型更直观</strong></h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 用队列表达执行顺序非常自然</span>

<span class="hljs-comment">// 串行执行：天然保证顺序</span>
serialQueue<span class="hljs-selector-class">.async</span> { <span class="hljs-built_in">task1</span>() }
serialQueue<span class="hljs-selector-class">.async</span> { <span class="hljs-built_in">task2</span>() }  <span class="hljs-comment">// 一定在 task1 之后</span>

<span class="hljs-comment">// 并发执行：简单明了</span>
concurrentQueue<span class="hljs-selector-class">.async</span> { <span class="hljs-built_in">task1</span>() }
concurrentQueue<span class="hljs-selector-class">.async</span> { <span class="hljs-built_in">task2</span>() }  <span class="hljs-comment">// 可能并行执行</span>

<span class="hljs-comment">// 依赖关系：清晰表达</span>
queue<span class="hljs-selector-class">.async</span> {
    let data = <span class="hljs-built_in">fetchData</span>()
    DispatchQueue<span class="hljs-selector-class">.main</span><span class="hljs-selector-class">.async</span> {
        <span class="hljs-built_in">updateUI</span>(with: data)
    }
}
</code></pre>
<h2 data-id="heading-22">实际体现</h2>
<h3 data-id="heading-23">示例：对比两种模型的复杂性</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 传统线程方式实现三个任务的串行执行</span>
class ThreadManager {
    <span class="hljs-selector-tag">var</span> currentThread: Thread?
    
    func <span class="hljs-built_in">executeSequentially</span>() {
        let thread1 = Thread {
            <span class="hljs-built_in">task1</span>()
            <span class="hljs-comment">// 需要手动协调下一个任务</span>
            let thread2 = Thread {
                <span class="hljs-built_in">task2</span>()
                let thread3 = Thread {
                    <span class="hljs-built_in">task3</span>()
                }
                thread3<span class="hljs-selector-class">.start</span>()
            }
            thread2<span class="hljs-selector-class">.start</span>()
        }
        thread1<span class="hljs-selector-class">.start</span>()
    }
}

<span class="hljs-comment">// GCD 方式实现三个任务的串行执行</span>
let serialQueue = <span class="hljs-built_in">DispatchQueue</span>(label: "serial")
serialQueue<span class="hljs-selector-class">.async</span> { <span class="hljs-built_in">task1</span>() }
serialQueue<span class="hljs-selector-class">.async</span> { <span class="hljs-built_in">task2</span>() }
serialQueue<span class="hljs-selector-class">.async</span> { <span class="hljs-built_in">task3</span>() }
<span class="hljs-comment">// 简洁明了，自动保证顺序</span>
</code></pre>
<h3 data-id="heading-24">示例：避免"线程爆炸"</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 传统方式：容易创建过多线程</span>
for <span class="hljs-selector-tag">i</span> in <span class="hljs-number">0</span>..&lt;<span class="hljs-number">1000</span> {
    Thread {
        <span class="hljs-built_in">processItem</span>(i)
    }<span class="hljs-selector-class">.start</span>()  <span class="hljs-comment">// 可能创建1000个线程！</span>
}

<span class="hljs-comment">// GCD 方式：系统智能管理</span>
let queue = DispatchQueue<span class="hljs-selector-class">.global</span>()
for <span class="hljs-selector-tag">i</span> in <span class="hljs-number">0</span>..&lt;<span class="hljs-number">1000</span> {
    queue<span class="hljs-selector-class">.async</span> {
        <span class="hljs-built_in">processItem</span>(i)  <span class="hljs-comment">// 系统复用线程池中的线程</span>
    }
}
<span class="hljs-comment">// 可能只用 8-64 个线程（根据 CPU 核心数优化）</span>
</code></pre>
<h2 data-id="heading-25">GCD 的哲学转变</h2>
<h3 data-id="heading-26">1. <strong>关注点分离</strong></h3>
<pre><code class="hljs language-diff" lang="diff">// 你关心的：
<span class="hljs-deletion">- 任务是什么？</span>
<span class="hljs-deletion">- 任务间的依赖关系？</span>
<span class="hljs-deletion">- 任务的优先级？</span>
<span class="hljs-deletion">- 执行顺序要求？</span>

// 系统关心的：
<span class="hljs-deletion">- 用多少线程？</span>
<span class="hljs-deletion">- 哪个线程执行哪个任务？</span>
<span class="hljs-deletion">- 何时创建/销毁线程？</span>
<span class="hljs-deletion">- 如何负载均衡？</span>
</code></pre>
<h3 data-id="heading-27">2. <strong>更高级的抽象</strong></h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// GCD 提供了高级原语</span>
let group = <span class="hljs-built_in">DispatchGroup</span>()  <span class="hljs-comment">// 任务组</span>
let semaphore = <span class="hljs-built_in">DispatchSemaphore</span>(value: <span class="hljs-number">1</span>)  <span class="hljs-comment">// 信号量</span>
let barrier = <span class="hljs-built_in">DispatchWorkItem</span>(flags: .barrier)  <span class="hljs-comment">// 屏障</span>

<span class="hljs-comment">// 这些都在队列层面操作，不直接涉及线程</span>
</code></pre>
<h3 data-id="heading-28">3. <strong>性能优化透明化</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 系统可以根据情况优化：</span>
<span class="hljs-comment">// - 线程复用</span>
<span class="hljs-comment">// - 负载均衡</span>
<span class="hljs-comment">// - CPU 亲和性</span>
<span class="hljs-comment">// - 能耗优化（iOS 上特别重要）</span>

<span class="hljs-comment">// 你只需：queue.async { work }</span>
<span class="hljs-comment">// 系统决定：用哪个核、哪个线程、何时执行</span>
</code></pre>
<h2 data-id="heading-29">现实类比</h2>
<h3 data-id="heading-30">传统线程模型：<strong>自己建工厂</strong></h3>
<ul>
<li>你需要：招聘工人（创建线程）</li>
<li>分配任务：A 你去拧螺丝，B 你去焊接</li>
<li>协调管理：A 做完告诉 B</li>
<li>成本高：工人闲置时也要付工资</li>
</ul>
<h3 data-id="heading-31">GCD 队列模型：<strong>使用云服务平台</strong></h3>
<ul>
<li>你只需：提交任务需求单（任务到队列）</li>
<li>平台负责：分配工人、调度任务、优化资源</li>
<li>你只关心：任务描述和依赖关系</li>
<li>成本优：按需使用，资源复用</li>
</ul>
<h2 data-id="heading-32">总结</h2>
<p>GCD 的"基于队列"模型之所以强大，是因为：</p>
<ol>
<li><strong>抽象层次更高</strong>：从"执行单元"抽象到"任务组织"</li>
<li><strong>资源管理更优</strong>：系统全局优化，避免局部最优</li>
<li><strong>编程模型更安全</strong>：减少了数据竞争和死锁的机会</li>
<li><strong>性能更可预测</strong>：避免了线程爆炸和过度订阅</li>
<li><strong>代码更简洁</strong>：关注业务逻辑，而不是线程管理</li>
</ol>
<p>这种设计使得并发编程从一门"黑魔法"变成了更可控、更安全的工程实践。你不再直接指挥"士兵"（线程），而是制定"作战计划"（队列和任务），让"指挥部"（GCD）去最优执行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1-2.【GCD】GCD 是如何管理线程池的？线程是谁创建的？]]></title>    <link>https://juejin.cn/post/7599835610405781550</link>    <guid>https://juejin.cn/post/7599835610405781550</guid>    <pubDate>2026-01-27T09:36:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599835610405781550" data-draft-id="7599708108621234227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1-2.【GCD】GCD 是如何管理线程池的？线程是谁创建的？"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2026-01-27T09:36:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="项阿丑"/> <meta itemprop="url" content="https://juejin.cn/user/1407852323023447"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1-2.【GCD】GCD 是如何管理线程池的？线程是谁创建的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1407852323023447/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    项阿丑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:36:15.000Z" title="Tue Jan 27 2026 09:36:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">线程创建者：GCD 自己</h3>
<p><strong>GCD 是线程的实际创建者</strong>，但不是随意创建，而是通过高度优化的机制：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 开发者层面：不直接创建线程</span>
DispatchQueue.<span class="hljs-keyword">global</span>().<span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// GCD 内部决定：</span>
    <span class="hljs-comment">// 1. 从池中取出空闲线程</span>
    <span class="hljs-comment">// 2. 或创建新线程（如果必要）</span>
    <span class="hljs-comment">// 3. 或将任务排队等待</span>
}
</code></pre>
<h3 data-id="heading-1">GCD 线程池的智能管理</h3>
<h4 data-id="heading-2">1. <strong>按需创建，延迟销毁</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// GCD 线程生命周期：</span>
<span class="hljs-comment">// 初始状态：线程池为空</span>
<span class="hljs-comment">// 第一次提交任务 → 创建1个线程</span>
<span class="hljs-comment">// 持续提交任务 → 逐渐增加线程数</span>
<span class="hljs-comment">// 空闲一段时间 → 自动销毁多余线程（节省资源）</span>
</code></pre>
<h4 data-id="heading-3">2. <strong>线程复用策略</strong></h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 类似数据库连接池的模式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GCDThreadPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> activeThreads: <span class="hljs-type">Set</span>&lt;<span class="hljs-type">Thread</span>&gt; <span class="hljs-operator">=</span> []
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> idleThreads: <span class="hljs-type">Set</span>&lt;<span class="hljs-type">Thread</span>&gt; <span class="hljs-operator">=</span> []
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> maxThreads: <span class="hljs-type">Int</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">getThread</span>() -&gt; <span class="hljs-type">Thread</span> {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> thread <span class="hljs-operator">=</span> idleThreads.popFirst() {
            <span class="hljs-comment">// 复用空闲线程</span>
            activeThreads.insert(thread)
            <span class="hljs-keyword">return</span> thread
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> activeThreads.count <span class="hljs-operator">&lt;</span> maxThreads {
            <span class="hljs-comment">// 创建新线程</span>
            <span class="hljs-keyword">let</span> thread <span class="hljs-operator">=</span> createThread()
            activeThreads.insert(thread)
            <span class="hljs-keyword">return</span> thread
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 等待线程可用</span>
            <span class="hljs-keyword">return</span> waitForAvailableThread()
        }
    }
}
</code></pre>
<h3 data-id="heading-4">线程池的关键参数和策略</h3>
<h4 data-id="heading-5">1. <strong>线程数量限制</strong></h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 基于系统资源动态调整</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">GCDThreadManager</span> {
    <span class="hljs-comment">// 主要考虑因素：</span>
    <span class="hljs-comment">// 1. CPU 核心数（决定最大并发度）</span>
    <span class="hljs-keyword">let</span> maxConcurrentThreads = ProcessInfo.processInfo.processorCount * <span class="hljs-number">2</span>
    
    <span class="hljs-comment">// 2. 队列类型</span>
    <span class="hljs-comment">// 串行队列：通常1个线程</span>
    <span class="hljs-comment">// 并发队列：多个线程，但有限制</span>
    
    <span class="hljs-comment">// 3. 系统负载</span>
    <span class="hljs-comment">// 高负载时：减少线程数</span>
    <span class="hljs-comment">// 低负载时：增加线程数（更快响应）</span>
}
</code></pre>
<h4 data-id="heading-6">2. <strong>QoS（服务质量）影响</strong></h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 不同优先级的任务使用不同线程池</span>
<span class="hljs-type">DispatchQueue</span>.global(qos: .userInteractive) <span class="hljs-comment">// 最高优先级，更快获取线程</span>
<span class="hljs-type">DispatchQueue</span>.global(qos: .background)      <span class="hljs-comment">// 最低优先级，可能等待更久</span>

<span class="hljs-comment">// 内部实现简化：</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">QoSThreadPool</span> {
    <span class="hljs-keyword">var</span> highPriorityPool: <span class="hljs-type">ThreadPool</span>  <span class="hljs-comment">// .userInteractive, .userInitiated</span>
    <span class="hljs-keyword">var</span> defaultPool: <span class="hljs-type">ThreadPool</span>        <span class="hljs-comment">// .default</span>
    <span class="hljs-keyword">var</span> lowPriorityPool: <span class="hljs-type">ThreadPool</span>    <span class="hljs-comment">// .utility, .background</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">getThread</span>(<span class="hljs-params">for</span> <span class="hljs-params">qos</span>: <span class="hljs-type">QoSClass</span>) -&gt; <span class="hljs-type">Thread</span> {
        <span class="hljs-comment">// 优先从对应优先级的池中获取</span>
        <span class="hljs-comment">// 高优先级可"借用"低优先级的线程（反之不行）</span>
    }
}
</code></pre>
<h3 data-id="heading-7">具体工作机制示例</h3>
<h4 data-id="heading-8">场景：处理大量任务</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> queue = DispatchQueue.<span class="hljs-keyword">global</span>()

<span class="hljs-comment">// 模拟100个任务</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span>.<span class="hljs-number">.100</span> {
    queue.<span class="hljs-keyword">async</span> {
        sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment">// 模拟1秒工作</span>
        print(<span class="hljs-string">"任务 (i) 完成，线程: (Thread.current)"</span>)
    }
}

<span class="hljs-comment">// GCD 内部行为：</span>
<span class="hljs-comment">// 1. 前几个任务：创建新线程（比如4个，基于CPU核心数）</span>
<span class="hljs-comment">// 2. 继续提交：复用现有线程</span>
<span class="hljs-comment">// 3. 如果所有线程都忙：排队等待</span>
<span class="hljs-comment">// 4. 如果长时间排队：可能创建更多线程（但不超过上限）</span>
<span class="hljs-comment">// 5. 任务完成后：线程空闲，可用于新任务</span>
<span class="hljs-comment">// 6. 长时间空闲：销毁多余线程</span>
</code></pre>
<h3 data-id="heading-9">避免的问题和优化</h3>
<h4 data-id="heading-10">1. <strong>防止线程爆炸</strong></h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 传统方式的问题</span>
<span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;<span class="hljs-number">1000</span> {
    Thread { <span class="hljs-comment">/* 工作 */</span> }.<span class="hljs-title function_ invoke__">start</span>()  <span class="hljs-comment">// 可能创建1000个线程！</span>
}

<span class="hljs-comment">// GCD 的优化</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">queue</span> = DispatchQueue.<span class="hljs-title function_ invoke__">global</span>()
<span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;<span class="hljs-number">1000</span> {
    queue.<span class="hljs-keyword">async</span> { <span class="hljs-comment">/* 工作 */</span> }  <span class="hljs-comment">// 可能只用8-16个线程处理</span>
}
</code></pre>
<h4 data-id="heading-11">2. <strong>负载均衡</strong></h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// GCD 内部的工作窃取（Work Stealing）机制</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkStealingScheduler</span> {
    <span class="hljs-keyword">var</span> threadPools: [<span class="hljs-type">ThreadPool</span>]
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">scheduleTask</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">task</span>: <span class="hljs-type">Task</span>) {
        <span class="hljs-comment">// 1. 先尝试分配到最空闲的线程</span>
        <span class="hljs-comment">// 2. 如果所有线程都忙，但其他队列有闲置线程</span>
        <span class="hljs-comment">// 3. "窃取"闲置线程来执行任务</span>
    }
}
</code></pre>
<h4 data-id="heading-12">3. <strong>能耗优化（特别在移动设备）</strong></h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// iOS/macOS 的能耗管理</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">EnergyAwareThreadManager</span> {
    <span class="hljs-function">func <span class="hljs-title">manageThreads</span>()</span> {
        <span class="hljs-comment">// 考虑因素：</span>
        <span class="hljs-comment">// - CPU 频率调整（降频时减少线程）</span>
        <span class="hljs-comment">// - 电池状态（低电量时减少并发）</span>
        <span class="hljs-comment">// - 温度控制（过热时限制线程）</span>
        <span class="hljs-comment">// - 后台状态（后台模式用更少线程）</span>
    }
}
</code></pre>
<h3 data-id="heading-13">线程生命周期管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 简化版 GCD 线程管理逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GCDThread</span> {
    <span class="hljs-keyword">var</span> <span class="hljs-attr">state</span>: <span class="hljs-title class_">ThreadState</span> = .<span class="hljs-property">idle</span>
    <span class="hljs-keyword">var</span> <span class="hljs-attr">lastUsed</span>: <span class="hljs-title class_">TimeInterval</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ThreadState</span> {
        <span class="hljs-keyword">case</span> idle      <span class="hljs-comment">// 空闲，等待任务</span>
        <span class="hljs-keyword">case</span> active    <span class="hljs-comment">// 正在执行任务</span>
        <span class="hljs-keyword">case</span> sleeping  <span class="hljs-comment">// 休眠（可能被销毁）</span>
    }
    
    func <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> task = <span class="hljs-title function_">getTaskFromQueue</span>(<span class="hljs-params"/>) {
                state = .<span class="hljs-property">active</span>
                task.<span class="hljs-title function_">execute</span>()
                state = .<span class="hljs-property">idle</span>
                lastUsed = <span class="hljs-title function_">currentTime</span>()
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 空闲处理</span>
                <span class="hljs-keyword">if</span> <span class="hljs-title function_">shouldDestroyThread</span>(<span class="hljs-params"/>) {
                    <span class="hljs-title function_">cleanupAndExit</span>()
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-title function_">sleepForInterval</span>()
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-14">特殊情况处理</h3>
<h4 data-id="heading-15">1. <strong>主线程的特殊性</strong></h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 主队列绑定到主线程</span>
DispatchQueue.main.<span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 总是运行在主线程</span>
    <span class="hljs-comment">// GCD 不会为 main queue 创建新线程</span>
    <span class="hljs-comment">// 而是将任务提交到主线程的 RunLoop</span>
}

<span class="hljs-comment">// 主线程不是由 GCD 创建的</span>
<span class="hljs-comment">// 它是应用启动时由系统创建的</span>
</code></pre>
<h4 data-id="heading-16">2. <strong>同步执行的优化</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// sync 调用时的线程优化</span>
queue.sync {
    <span class="hljs-comment">// 可能的优化：</span>
    <span class="hljs-comment">// 1. 如果当前线程就是目标队列的执行线程</span>
    <span class="hljs-comment">// 2. 直接在当前线程执行（避免线程切换）</span>
    <span class="hljs-comment">// 3. 这称为"队列归属检测"</span>
}
</code></pre>
<h3 data-id="heading-17">实际调试观察</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 查看线程创建情况</span>
let concurrentQueue = <span class="hljs-title function_ invoke__">DispatchQueue</span>(<span class="hljs-attr">label</span>: <span class="hljs-string">"test"</span>, <span class="hljs-attr">attributes</span>: .concurrent)

<span class="hljs-keyword">print</span>(<span class="hljs-string">"初始线程数: (Thread.getAll().count)"</span>)

<span class="hljs-keyword">for</span> i in <span class="hljs-number">0</span>..&lt;<span class="hljs-number">20</span> {
    concurrentQueue.async {
        <span class="hljs-keyword">print</span>(<span class="hljs-string">"任务 (i): (Thread.current)"</span>)
        <span class="hljs-title function_ invoke__">usleep</span>(<span class="hljs-number">100_000</span>)  <span class="hljs-comment">// 100ms</span>
    }
}

<span class="hljs-comment">// 观察结果：</span>
<span class="hljs-comment">// 1. 线程数不会无限增长</span>
<span class="hljs-comment">// 2. 线程会被复用（看到相同的 thread number）</span>
<span class="hljs-comment">// 3. 最终稳定在一定数量（如 CPU 核心数*2）</span>
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p><strong>GCD 线程管理的关键特点：</strong></p>
<ol>
<li><strong>线程创建者</strong>：GCD 自己（通过系统调用），开发者不直接创建</li>
<li><strong>按需创建</strong>：首次需要时创建，不是预先创建大量线程</li>
<li><strong>智能复用</strong>：线程执行完任务后回到池中，等待下次使用</li>
<li><strong>动态调整</strong>：根据系统负载、CPU核心数、任务类型动态调整线程数</li>
<li><strong>上限控制</strong>：有最大线程数限制，防止线程爆炸</li>
<li><strong>自动清理</strong>：空闲线程会被销毁，节省资源</li>
<li><strong>优先级感知</strong>：不同 QoS 的任务可能使用不同的线程子池</li>
</ol>
<p>这种设计使得 GCD 能够：</p>
<ul>
<li>最大化 CPU 利用率</li>
<li>最小化线程创建/销毁开销</li>
<li>自动适应不同硬件和负载</li>
<li>为开发者隐藏复杂的线程管理细节</li>
</ul>
<p><strong>简单比喻</strong>：GCD 就像一个"智能线程管家"，你只需要告诉它"要做什么工作"和"工作的重要程度"，它会自动安排最合适的"工人"（线程）来完成，同时保证不雇佣过多工人浪费资源。</p>
<h2 data-id="heading-19">👉 追问：GCD 线程池和 pthread / NSThread 的关系？</h2>
<p>GCD 线程池、pthread 和 NSThread 之间有清晰的层次关系，<strong>pthread 是底层基础，GCD 和 NSThread 都是基于它的高层抽象</strong>。</p>
<h2 data-id="heading-20">层级关系</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 从高到低的抽象层次：</span>
┌─────────────────────────┐
│   <span class="hljs-built_in">GCD</span> (DispatchQueue)   │ ← 最高抽象：任务队列，自动线程管理
├─────────────────────────┤
│        NSThread         │ ← 中级抽象：面向对象的线程封装
├─────────────────────────┤
│       <span class="hljs-type">pthread_t</span>         │ ← 底层抽象：POSIX线程，C语言API
└─────────────────────────┘
</code></pre>
<h2 data-id="heading-21">详细关系解析</h2>
<h3 data-id="heading-22">1. <strong>pthread_t：最底层的基础</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 这是所有线程的根基（包括GCD创建的线程）</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-type">pthread_t</span> thread;
<span class="hljs-built_in">pthread_create</span>(&amp;thread, <span class="hljs-literal">NULL</span>, worker_func, <span class="hljs-literal">NULL</span>);  <span class="hljs-comment">// 创建线程</span>

<span class="hljs-comment">// GCD 内部最终会调用这个函数来创建线程</span>
<span class="hljs-comment">// 实际上，macOS/iOS 中的所有线程都是 pthread</span>
</code></pre>
<h3 data-id="heading-23">2. <strong>NSThread：Objective-C 的封装</strong></h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// NSThread 是对 pthread 的面向对象包装</span>
<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">NSThread</span> {
    <span class="hljs-comment">// 内部持有 pthread_t</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">_pthread</span>: <span class="hljs-selector-tag">pthread_t</span>
    
    <span class="hljs-comment">// 创建线程时，内部调用 pthread_create()</span>
    <span class="hljs-selector-tag">init</span>(<span class="hljs-attribute">block</span>: <span class="hljs-variable">@escaping</span> () -&gt; Void) {
        <span class="hljs-selector-tag">_pthread</span> = <span class="hljs-selector-tag">pthread_create</span>(...)
    }
}

<span class="hljs-comment">// 验证关系：</span>
<span class="hljs-selector-tag">Thread</span><span class="hljs-selector-class">.current</span> <span class="hljs-comment">// 返回当前线程的 NSThread 对象</span>
<span class="hljs-selector-tag">pthread_self</span>() <span class="hljs-comment">// 返回当前线程的 pthread_t</span>

<span class="hljs-comment">// 实际上，Thread.current.pthread 可以获取底层 pthread_t</span>
<span class="hljs-comment">// （虽然这个属性不公开）</span>
</code></pre>
<h3 data-id="heading-24">3. <strong>GCD 线程池的实现</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// GCD 内部结构示意（简化版）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GCDThreadPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> threads: [pthread_t] <span class="hljs-operator">=</span> []
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> taskQueue: <span class="hljs-type">Queue</span>&lt;<span class="hljs-type">Task</span>&gt;
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">createThreadIfNeeded</span>() {
        <span class="hljs-comment">// 需要新线程时，创建 pthread</span>
        <span class="hljs-keyword">var</span> thread: pthread_t
        pthread_create(<span class="hljs-operator">&amp;</span>thread, <span class="hljs-literal">nil</span>, { context <span class="hljs-keyword">in</span>
            <span class="hljs-comment">// 线程函数：不断从队列取任务执行</span>
            <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> taskQueue.dequeue() {
                task.execute()
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }, <span class="hljs-literal">nil</span>)
        
        threads.append(thread)
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">execute</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">task</span>: <span class="hljs-type">Task</span>) {
        taskQueue.enqueue(task)
        <span class="hljs-comment">// 如果没有空闲线程且未达上限，创建新线程</span>
        <span class="hljs-keyword">if</span> idleThreads.isEmpty <span class="hljs-operator">&amp;&amp;</span> threads.count <span class="hljs-operator">&lt;</span> maxThreads {
            createThreadIfNeeded()
        }
    }
}
</code></pre>
<h2 data-id="heading-25">实际运行时关系示例</h2>
<h3 data-id="heading-26">场景：观察三者关系</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 创建一个 GCD 并发队列</span>
<span class="hljs-keyword">let</span> queue = DispatchQueue(label: <span class="hljs-string">"test"</span>, attributes: .concurrent)

<span class="hljs-comment">// 提交任务</span>
queue.<span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 获取三个层面的线程信息</span>
    <span class="hljs-keyword">let</span> nsThread = Thread.current        <span class="hljs-comment">// NSThread 对象</span>
    <span class="hljs-keyword">let</span> pthreadId = pthread_self()       <span class="hljs-comment">// pthread_t 标识</span>
    <span class="hljs-keyword">let</span> threadNumber = nsThread.<span class="hljs-keyword">value</span>(forKeyPath: <span class="hljs-string">"private.seqNum"</span>)  <span class="hljs-comment">// 内部编号</span>
    
    print(<span class="hljs-string">""</span><span class="hljs-string">"
    层级关系：
    1. NSThread: (nsThread)
    2. pthread_t: (pthreadId)
    3. 是否GCD创建: (nsThread.name?.contains("</span>com.apple.root<span class="hljs-string">") == true)
    "</span><span class="hljs-string">""</span>)
    
    <span class="hljs-comment">// 实际输出可能类似：</span>
    <span class="hljs-comment">// 1. NSThread: &lt;NSThread: 0x600003d6c040&gt;{number = 7, name = (null)}</span>
    <span class="hljs-comment">// 2. pthread_t: 0x70000a1000</span>
    <span class="hljs-comment">// 3. 是否GCD创建: true</span>
}
</code></pre>
<h3 data-id="heading-27">核心区别对比</h3>









































<table><thead><tr><th><strong>特性</strong></th><th><strong>GCD 线程池</strong></th><th><strong>NSThread</strong></th><th><strong>pthread_t</strong></th></tr></thead><tbody><tr><td><strong>抽象级别</strong></td><td>最高（队列）</td><td>中（对象）</td><td>最低（句柄）</td></tr><tr><td><strong>创建方式</strong></td><td>自动管理</td><td>手动创建</td><td>手动创建</td></tr><tr><td><strong>线程复用</strong></td><td>✅ 自动复用</td><td>❌ 一对一</td><td>❌ 一对一</td></tr><tr><td><strong>内存管理</strong></td><td>自动</td><td>ARC 管理</td><td>手动（pthread_join/exit）</td></tr><tr><td><strong>跨平台</strong></td><td>Apple 生态</td><td>Apple 生态</td><td>POSIX标准</td></tr></tbody></table>
<h2 data-id="heading-28">具体实现细节</h2>
<h3 data-id="heading-29">1. <strong>GCD 如何创建线程</strong></h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// GCD 内部源码简化示意（libdispatch）</span>
void <span class="hljs-built_in">_dispatch_worker_thread</span>(void *context) {
    <span class="hljs-comment">// 1. 注册为GCD工作线程</span>
    <span class="hljs-built_in">_dispatch_thread_setspecific</span>(dispatch_queue_key, context);
    
    <span class="hljs-comment">// 2. 设置线程名字（便于调试）</span>
    <span class="hljs-built_in">pthread_setname_np</span>("com.apple.root.default-qos");
    
    <span class="hljs-comment">// 3. 进入工作循环</span>
    while (<span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 从队列获取任务</span>
        task = <span class="hljs-built_in">_dispatch_queue_get_task</span>(queue);
        
        if (task) {
            <span class="hljs-built_in">_dispatch_worker_execute</span>(task);
        } else {
            <span class="hljs-comment">// 空闲处理</span>
            if (should_terminate()) {
                <span class="hljs-built_in">pthread_exit</span>(NULL);
            }
        }
    }
}

<span class="hljs-comment">// 创建线程的函数</span>
void <span class="hljs-built_in">_dispatch_thread_create</span>(pthread_t *thread, dispatch_queue_t queue) {
    pthread_attr_t attr;
    <span class="hljs-built_in">pthread_attr_init</span>(&amp;attr);
    
    <span class="hljs-comment">// 配置线程属性</span>
    <span class="hljs-built_in">pthread_attr_set_qos_class_np</span>(&amp;attr, QOS_CLASS_DEFAULT, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 最终调用 pthread_create</span>
    <span class="hljs-built_in">pthread_create</span>(thread, &amp;attr, _dispatch_worker_thread, (void *)queue);
}
</code></pre>
<h3 data-id="heading-30">2. <strong>NSThread 的 pthread 包装</strong></h3>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// NSThread 内部实现示意</span>
<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">NSThread</span> </span>{
    pthread_t _pthread;
    <span class="hljs-built_in">NSMutableDictionary</span> *_threadDictionary;
}

- (<span class="hljs-type">void</span>)start {
    <span class="hljs-keyword">if</span> (_pthread != <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 创建 pthread</span>
    pthread_attr_t attr;
    pthread_attr_init(&amp;attr);
    
    <span class="hljs-comment">// 存储 self 以便在 C 函数中访问</span>
    <span class="hljs-built_in">NSThread</span> *threadSelf = <span class="hljs-keyword">self</span>;
    
    <span class="hljs-type">int</span> err = pthread_create(&amp;_pthread, &amp;attr,
                           _NSThread__start__, (__bridge <span class="hljs-type">void</span> *)threadSelf);
    
    pthread_attr_destroy(&amp;attr);
}

<span class="hljs-keyword">static</span> <span class="hljs-type">void</span> *_NSThread__start__(<span class="hljs-type">void</span> *arg) {
    <span class="hljs-comment">// 获取 NSThread 对象</span>
    <span class="hljs-built_in">NSThread</span> *thread = (__bridge <span class="hljs-built_in">NSThread</span> *)arg;
    
    <span class="hljs-comment">// 设置线程特定数据</span>
    pthread_setspecific(<span class="hljs-built_in">NSThreadKey</span>, (__bridge <span class="hljs-type">void</span> *)thread);
    
    <span class="hljs-comment">// 执行目标方法</span>
    [thread main];
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
<span class="hljs-keyword">@end</span>
</code></pre>
<h2 data-id="heading-31">实际开发中的交互</h2>
<h3 data-id="heading-32">1. <strong>从 NSThread 获取 pthread</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 方法1：直接获取当前 pthread</span>
<span class="hljs-keyword">let</span> currentPthread <span class="hljs-operator">=</span> pthread_self()

<span class="hljs-comment">// 方法2：从 NSThread（不推荐，使用私有API）</span>
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">Thread</span> {
    <span class="hljs-keyword">var</span> pthread: pthread_t<span class="hljs-operator">?</span> {
        <span class="hljs-comment">// 注意：这是私有API，App Store审核可能不通过</span>
        <span class="hljs-keyword">let</span> key <span class="hljs-operator">=</span> <span class="hljs-string">"pthread"</span>  <span class="hljs-comment">// 实际是私有字段</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.value(forKey: key) <span class="hljs-keyword">as?</span> pthread_t
    }
}
</code></pre>
<h3 data-id="heading-33">2. <strong>在 GCD 任务中操作线程</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp">DispatchQueue.<span class="hljs-keyword">global</span>().<span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 当前运行在 GCD 管理的 pthread 上</span>
    
    <span class="hljs-comment">// 可以设置线程名字（用于调试）</span>
    pthread_setname_np(<span class="hljs-string">"MyWorkerThread"</span>)
    
    <span class="hljs-comment">// 可以获取并操作当前 pthread</span>
    <span class="hljs-keyword">let</span> pthread = pthread_self()
    
    <span class="hljs-comment">// 可以设置线程优先级（但通常用 QoS 更好）</span>
    <span class="hljs-keyword">var</span> policy: Int32 = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> param = sched_param()
    pthread_getschedparam(pthread, &amp;policy, &amp;param)
    param.sched_priority = <span class="hljs-number">45</span>  <span class="hljs-comment">// 设置优先级</span>
    pthread_setschedparam(pthread, policy, &amp;param)
    
    <span class="hljs-comment">// 注意：直接操作 pthread 可能干扰 GCD 的管理</span>
}
</code></pre>
<h3 data-id="heading-34">3. <strong>混合使用的陷阱</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ❌ 危险的混合使用</span>
<span class="hljs-keyword">let</span> thread = Thread {
    <span class="hljs-comment">// 在线程中使用 GCD 同步到主队列</span>
    DispatchQueue.main.sync {
        <span class="hljs-comment">// 如果这个线程恰好是主线程 → 死锁！</span>
        <span class="hljs-comment">// 因为 Thread 创建的不是主线程，</span>
        <span class="hljs-comment">// 但理论上如果是主线程调用就会死锁</span>
    }
}

<span class="hljs-comment">// ✅ 安全的做法</span>
<span class="hljs-keyword">let</span> queue = DispatchQueue.<span class="hljs-keyword">global</span>()
queue.<span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 在 GCD 管理的线程中使用 GCD</span>
    DispatchQueue.main.<span class="hljs-keyword">async</span> {
        <span class="hljs-comment">// 总是安全的</span>
    }
}
</code></pre>
<h2 data-id="heading-35">性能与开销对比</h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 性能测试示例</span>
func <span class="hljs-built_in">measureOverhead</span>() {
    <span class="hljs-comment">// 1. 直接创建 pthread（最快，但最底层）</span>
    <span class="hljs-built_in">measure</span>("pthread_create") {
        <span class="hljs-selector-tag">var</span> thread: pthread_t
        <span class="hljs-built_in">pthread_create</span>(&amp;thread, nil, { _ in return nil }, nil)
        <span class="hljs-built_in">pthread_join</span>(thread, nil)
    }
    
    <span class="hljs-comment">// 2. 创建 NSThread（中等开销）</span>
    <span class="hljs-built_in">measure</span>("NSThread") {
        let thread = Thread { <span class="hljs-comment">/* do nothing */</span> }
        thread<span class="hljs-selector-class">.start</span>()
        <span class="hljs-comment">// 需要同步机制确保线程结束</span>
    }
    
    <span class="hljs-comment">// 3. GCD 提交任务（最低开销，因为复用线程）</span>
    <span class="hljs-built_in">measure</span>("GCD async") {
        let semaphore = <span class="hljs-built_in">DispatchSemaphore</span>(value: <span class="hljs-number">0</span>)
        DispatchQueue<span class="hljs-selector-class">.global</span>()<span class="hljs-selector-class">.async</span> {
            semaphore<span class="hljs-selector-class">.signal</span>()
        }
        semaphore<span class="hljs-selector-class">.wait</span>()
    }
}

<span class="hljs-comment">// 典型结果（相对时间）：</span>
<span class="hljs-comment">// pthread_create: 100ms（基准）</span>
<span class="hljs-comment">// NSThread: 120-150ms（额外对象开销）</span>
<span class="hljs-comment">// GCD async: 10-20ms（线程复用，极低开销）</span>
</code></pre>
<h2 data-id="heading-36">调试技巧</h2>
<h3 data-id="heading-37">1. <strong>查看线程信息</strong></h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 在调试器中查看所有线程</span>
(lldb) thread list
<span class="hljs-comment">// 可以看到：</span>
<span class="hljs-comment">// * thread #1: tid = 0x1a2b3, 0x0000000100000000, </span>
<span class="hljs-comment">//   queue = 'com.apple.main-thread'</span>
<span class="hljs-comment">// * thread #4: tid = 0x1a2b4, 0x0000000100001000,</span>
<span class="hljs-comment">//   queue = 'com.apple.root.default-qos'</span>

<span class="hljs-comment">// 查看线程堆栈</span>
(lldb) bt <span class="hljs-attribute">all</span>
<span class="hljs-comment">// 会显示所有线程的调用栈，包括GCD工作线程</span>
</code></pre>
<h3 data-id="heading-38">2. <strong>识别线程来源</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在代码中判断</span>
<span class="hljs-keyword">if</span> <span class="hljs-type">Thread</span>.isMainThread {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"这是主线程"</span>)
}

<span class="hljs-comment">// 判断是否为GCD线程</span>
<span class="hljs-keyword">let</span> threadName <span class="hljs-operator">=</span> <span class="hljs-type">Thread</span>.current.name <span class="hljs-operator">??</span> <span class="hljs-string">""</span>
<span class="hljs-keyword">if</span> threadName.hasPrefix(<span class="hljs-string">"com.apple.root"</span>) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"这是GCD线程池中的线程"</span>)
}

<span class="hljs-comment">// 获取线程的QoS级别</span>
<span class="hljs-keyword">let</span> qos <span class="hljs-operator">=</span> <span class="hljs-type">Thread</span>.current.qualityOfService
<span class="hljs-built_in">print</span>(<span class="hljs-string">"线程QoS: (qos)"</span>)
</code></pre>
<h2 data-id="heading-39">总结</h2>
<h3 data-id="heading-40">关系链</h3>
<pre><code class="hljs language-arduino" lang="arduino">应用层：<span class="hljs-built_in">GCD</span> (DispatchQueue) → 使用并管理 → NSThread/pthread
          ↓
框架层：NSThread → 封装 → <span class="hljs-type">pthread_t</span>
          ↓
系统层：<span class="hljs-type">pthread_t</span> → 内核线程
</code></pre>
<h3 data-id="heading-41">核心要点</h3>
<ol>
<li>
<p><strong>pthread 是基石</strong>：所有线程最终都是 pthread，包括 GCD 创建的线程</p>
</li>
<li>
<p><strong>NSThread 是包装</strong>：提供面向对象的线程操作，底层仍是 pthread</p>
</li>
<li>
<p><strong>GCD 是管理者</strong>：基于 pthread 构建线程池，提供队列抽象</p>
</li>
<li>
<p><strong>线程复用是关键</strong>：GCD 复用线程，而直接使用 pthread/NSThread 通常是一对一</p>
</li>
<li>
<p><strong>抽象层级不同</strong>：</p>
<ul>
<li>pthread：关心"如何创建线程"</li>
<li>NSThread：关心"如何表示线程对象"</li>
<li>GCD：关心"如何组织任务执行"</li>
</ul>
</li>
</ol>
<p><strong>简单比喻</strong>：</p>
<ul>
<li><strong>pthread</strong> 就像"砖块"（基本单元）</li>
<li><strong>NSThread</strong> 就像"有标签的砖块"（易于识别和管理）</li>
<li><strong>GCD</strong> 就像"智能建筑系统"（自动调度砖块完成任务）</li>
</ul>
<p>在实践中，<strong>优先使用 GCD</strong>，它提供最优的线程管理和性能。只有在需要特殊线程控制（如长时间后台计算、实时操作）时才考虑使用 NSThread 或 pthread。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1-3.【GCD】DispatchQueue 的底层数据结构是什么？]]></title>    <link>https://juejin.cn/post/7599847938538618889</link>    <guid>https://juejin.cn/post/7599847938538618889</guid>    <pubDate>2026-01-27T09:36:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599847938538618889" data-draft-id="7599850148056121353" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1-3.【GCD】DispatchQueue 的底层数据结构是什么？"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2026-01-27T09:36:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="项阿丑"/> <meta itemprop="url" content="https://juejin.cn/user/1407852323023447"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1-3.【GCD】DispatchQueue 的底层数据结构是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1407852323023447/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    项阿丑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:36:32.000Z" title="Tue Jan 27 2026 09:36:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>它是一个复杂的 C 结构体，集成了任务队列、线程管理、性能优化等多个子系统</strong>。</p>
<h2 data-id="heading-0">核心数据结构：dispatch_queue_s</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// libdispatch 源码中的核心结构（简化）</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> {
    <span class="hljs-comment">// 1. 基础头部信息（所有 dispatch 对象共享）</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_object_s</span> _as_do[<span class="hljs-number">0</span>];      <span class="hljs-comment">// 转换为 dispatch_object</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> *_as_dq[<span class="hljs-number">0</span>];      <span class="hljs-comment">// 转换为 dispatch_queue</span>
    
    <span class="hljs-comment">// 2. 队列标识信息</span>
    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_vtable_s</span> *vtable;  <span class="hljs-comment">// 虚函数表（多态）</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dq_label;                    <span class="hljs-comment">// 队列标签（我们设置的 label）</span>
    <span class="hljs-type">uint16_t</span> dq_width;                       <span class="hljs-comment">// 并发宽度（串行为1）</span>
    <span class="hljs-type">uint32_t</span> dq_serialnum;                   <span class="hljs-comment">// 序列号（唯一标识）</span>
    
    <span class="hljs-comment">// 3. 目标队列和层次结构</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> *dq_targetq;     <span class="hljs-comment">// 目标队列（优先级继承）</span>
    <span class="hljs-type">uintptr_t</span> dq_targetq_override;           <span class="hljs-comment">// 目标队列覆盖（QoS 传播）</span>
    
    <span class="hljs-comment">// 4. 任务队列管理</span>
    <span class="hljs-keyword">union</span> {
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_specific_head_s</span> *dq_specific_head;
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_source_refs_s</span> *ds_refs;
    } _dq_specific;
    
    <span class="hljs-comment">// 5. 同步原语</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_object_s</span> *<span class="hljs-keyword">volatile</span> dq_items_tail;  <span class="hljs-comment">// 任务队列尾部</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_object_s</span> *<span class="hljs-keyword">volatile</span> dq_items_head;  <span class="hljs-comment">// 任务队列头部</span>
    <span class="hljs-type">uint32_t</span> dq_atomic_flags;                <span class="hljs-comment">// 原子标志位</span>
    
    <span class="hljs-comment">// 6. 线程池和性能管理</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *<span class="hljs-keyword">volatile</span> dq_last;  <span class="hljs-comment">// 最后执行的任务</span>
    <span class="hljs-type">uint32_t</span> dq_side_specific_ints;           <span class="hljs-comment">// 性能计数器</span>
    <span class="hljs-type">pthread_priority_t</span> dq_priority;           <span class="hljs-comment">// 优先级缓存</span>
};
</code></pre>
<h2 data-id="heading-1">详细结构解析</h2>
<h3 data-id="heading-2">1. <strong>多态设计：dispatch_object</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 所有 GCD 对象的基类</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_object_s</span> {
    _DISPATCH_OBJECT_HEADER(object);  <span class="hljs-comment">// 头部宏，包含引用计数等</span>
};

<span class="hljs-comment">// DispatchQueue 通过以下宏实现多态</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _DISPATCH_QUEUE_CLASS_HEADER(queue_label, ...) \
    _DISPATCH_OBJECT_HEADER(queue) \
    const char *dq_label; \
    uint16_t dq_width;</span>

<span class="hljs-comment">// 这使得：</span>
<span class="hljs-type">dispatch_queue_t</span> queue = <span class="hljs-built_in">dispatch_queue_create</span>(<span class="hljs-string">"com.test"</span>, <span class="hljs-literal">NULL</span>);
<span class="hljs-type">dispatch_object_t</span> obj = (<span class="hljs-type">dispatch_object_t</span>)queue;  <span class="hljs-comment">// 可以向上转型</span>
</code></pre>
<h3 data-id="heading-3">2. <strong>任务队列：双向链表</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 实际存储任务的结构</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_object_s</span> dc_do;           <span class="hljs-comment">// 对象头部</span>
    <span class="hljs-type">dispatch_function_t</span> dc_func;              <span class="hljs-comment">// 执行函数</span>
    <span class="hljs-type">void</span> *dc_ctxt;                            <span class="hljs-comment">// 上下文参数</span>
    <span class="hljs-type">void</span> *dc_data;                            <span class="hljs-comment">// 额外数据</span>
    <span class="hljs-type">void</span> *dc_other;                           <span class="hljs-comment">// 关联数据</span>
    
    <span class="hljs-comment">// 链表指针</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *<span class="hljs-keyword">volatile</span> dc_next;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *dc_prev;
    
    <span class="hljs-comment">// 队列关联</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> *dc_queue;        <span class="hljs-comment">// 所属队列</span>
};

<span class="hljs-comment">// 队列如何管理任务</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *dq_items_head;  <span class="hljs-comment">// 队头</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *dq_items_tail;  <span class="hljs-comment">// 队尾</span>
    <span class="hljs-type">uint32_t</span> dq_nitems;                           <span class="hljs-comment">// 任务计数</span>
};
</code></pre>
<h3 data-id="heading-4">3. <strong>队列层次结构</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 队列间的父子关系（目标队列机制）</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_hierarchy_s</span> {
    <span class="hljs-type">dispatch_queue_t</span> dqh_queue;              <span class="hljs-comment">// 当前队列</span>
    <span class="hljs-type">dispatch_queue_t</span> dqh_target;             <span class="hljs-comment">// 目标队列</span>
    <span class="hljs-type">uintptr_t</span> dqh_override;                  <span class="hljs-comment">// QoS 覆盖</span>
    <span class="hljs-type">uint16_t</span> dqh_priority;                   <span class="hljs-comment">// 优先级</span>
};

<span class="hljs-comment">// 示例：</span>
<span class="hljs-comment">// 自定义队列 → 全局队列 → 根队列</span>
<span class="hljs-comment">// com.test.queue → com.apple.root.default-qos → kernel</span>
</code></pre>
<h3 data-id="heading-5">4. <strong>性能优化结构</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 队列的侧面（side）数据结构</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_side_s</span> {
    <span class="hljs-comment">// 用于性能优化的缓存</span>
    <span class="hljs-type">uint64_t</span> dq_side_timer;                 <span class="hljs-comment">// 定时器相关</span>
    <span class="hljs-type">uint64_t</span> dq_side_wlh;                   <span class="hljs-comment">// 工作循环句柄</span>
    <span class="hljs-type">uint32_t</span> dq_side_bits;                  <span class="hljs-comment">// 状态位</span>
};

<span class="hljs-comment">// 队列特定数据（dispatch_queue_set_specific/get_specific）</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_specific_head_s</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_specific_queue_s</span> *dsq_next;
    <span class="hljs-type">void</span> *dsq_data;                         <span class="hljs-comment">// 用户设置的数据</span>
    <span class="hljs-type">uintptr_t</span> dsq_key;                      <span class="hljs-comment">// 键值</span>
};
</code></pre>
<h2 data-id="heading-6">不同队列类型的内部差异</h2>
<h3 data-id="heading-7">1. <strong>全局队列（Global Queue）</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 全局队列有特殊结构</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_global_s</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> _as_dq[<span class="hljs-number">0</span>];      <span class="hljs-comment">// 基础队列部分</span>
    
    <span class="hljs-comment">// 全局队列特有</span>
    <span class="hljs-type">int</span> dgq_priority;                       <span class="hljs-comment">// 优先级索引</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> dgq_flags;                 <span class="hljs-comment">// 标志位</span>
    
    <span class="hljs-comment">// 共享线程池引用</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_pthread_root_queue_s</span> *dgq_thread_pool;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_workloop_s</span> *dgq_wlh;    <span class="hljs-comment">// 工作循环</span>
};
</code></pre>
<h3 data-id="heading-8">2. <strong>主队列（Main Queue）</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 主队列的特殊处理</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_main_s</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> _as_dq[<span class="hljs-number">0</span>];
    
    <span class="hljs-comment">// 与 RunLoop 集成</span>
    CFRunLoopRef _dq_runloop;               <span class="hljs-comment">// 关联的 RunLoop</span>
    CFRunLoopSourceRef _dq_runloop_source;  <span class="hljs-comment">// 事件源</span>
    
    <span class="hljs-comment">// 串行执行保证</span>
    <span class="hljs-type">pthread_t</span> _dq_main_thread;              <span class="hljs-comment">// 主线程标识</span>
    <span class="hljs-type">uint32_t</span> _dq_main_flags;                <span class="hljs-comment">// 主队列标志</span>
};
</code></pre>
<h3 data-id="heading-9">3. <strong>并发队列 vs 串行队列</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 区别主要在 dq_width 字段：</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> {
    <span class="hljs-type">uint16_t</span> dq_width;  <span class="hljs-comment">// 并发宽度</span>
    <span class="hljs-comment">// 值为 1：串行队列（DISPATCH_QUEUE_SERIAL）</span>
    <span class="hljs-comment">// 值 &gt; 1：并发队列（DISPATCH_QUEUE_CONCURRENT）</span>
    <span class="hljs-comment">// 特殊值：DISPATCH_QUEUE_WIDTH_MAX（并发无限）</span>
};

<span class="hljs-comment">// 并发队列还有额外的管理结构</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_concurrent_s</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> _as_dq[<span class="hljs-number">0</span>];
    
    <span class="hljs-comment">// 用于并发控制</span>
    os_unfair_lock _dq_lock;                <span class="hljs-comment">// 内部锁</span>
    <span class="hljs-type">uint32_t</span> _dq_running;                   <span class="hljs-comment">// 正在运行的任务数</span>
    <span class="hljs-type">uint32_t</span> _dq_max_running;               <span class="hljs-comment">// 最大并发数</span>
};
</code></pre>
<h2 data-id="heading-10">内存布局示例</h2>
<pre><code class="hljs language-lua" lang="lua">// DispatchQueue 在内存中的大致布局
+<span class="hljs-comment">-----------------------------------+</span>
| dispatch_object_s header          | ← 引用计数、类型信息等
|<span class="hljs-comment">-----------------------------------|</span>
| vtable pointer                    | ← 虚函数表（决定队列类型行为）
|<span class="hljs-comment">-----------------------------------|</span>
| dq_label (<span class="hljs-string">"com.example.queue"</span>)    | ← 队列标签指针
|<span class="hljs-comment">-----------------------------------|</span>
| dq_width (<span class="hljs-number">1</span> 或 n)                 | ← 并发宽度
|<span class="hljs-comment">-----------------------------------|</span>
| dq_serialnum (<span class="hljs-number">0x1234</span>)             | ← 序列号
|<span class="hljs-comment">-----------------------------------|</span>
| dq_targetq (指向全局队列)          | ← 目标队列指针
|<span class="hljs-comment">-----------------------------------|</span>
| dq_items_head → [任务<span class="hljs-number">1</span>] → [任务<span class="hljs-number">2</span>]  | ← 任务链表头
| dq_items_tail → [任务n]            | ← 任务链表尾
|<span class="hljs-comment">-----------------------------------|</span>
| dq_last (最后执行的任务指针)        | ← 性能优化
|<span class="hljs-comment">-----------------------------------|</span>
| dq_priority (QoS 值)              | ← 优先级缓存
+<span class="hljs-comment">-----------------------------------+</span>
</code></pre>
<h2 data-id="heading-11">队列创建过程</h2>
<h3 data-id="heading-12">创建自定义队列时的内部操作：</h3>
<pre><code class="hljs language-ini" lang="ini">dispatch_queue_t dispatch_queue_create(const char *label, 
                                       dispatch_queue_attr_t attr) {
    // 1. 分配内存
    struct dispatch_queue_s *<span class="hljs-attr">dq</span> = calloc(<span class="hljs-number">1</span>, sizeof(struct dispatch_queue_s))<span class="hljs-comment">;</span>
    
    // 2. 设置基本字段
    dq-&gt;<span class="hljs-attr">dq_label</span> = label ? strdup(label) : NULL<span class="hljs-comment">;</span>
    dq-&gt;<span class="hljs-attr">dq_serialnum</span> = dispatch_atomic_inc(&amp;g_serialnum)<span class="hljs-comment">;  // 全局递增</span>
    
    // 3. 根据属性设置并发宽度
    if (<span class="hljs-attr">attr</span> == DISPATCH_QUEUE_SERIAL || attr == NULL) {
        dq-&gt;<span class="hljs-attr">dq_width</span> = <span class="hljs-number">1</span><span class="hljs-comment">;  // 串行</span>
    } else if (<span class="hljs-attr">attr</span> == DISPATCH_QUEUE_CONCURRENT) {
        dq-&gt;<span class="hljs-attr">dq_width</span> = DISPATCH_QUEUE_WIDTH_MAX<span class="hljs-comment">;  // 并发</span>
    }
    
    // 4. 设置目标队列（通常是全局队列）
    dq-&gt;<span class="hljs-attr">dq_targetq</span> = _dispatch_get_root_queue(qos, overcommit)<span class="hljs-comment">;</span>
    
    // 5. 设置虚函数表
    if (dq-&gt;<span class="hljs-attr">dq_width</span> == <span class="hljs-number">1</span>) {
        dq-&gt;<span class="hljs-attr">vtable</span> = &amp;_dispatch_queue_serial_vtable<span class="hljs-comment">;</span>
    } else {
        dq-&gt;<span class="hljs-attr">vtable</span> = &amp;_dispatch_queue_concurrent_vtable<span class="hljs-comment">;</span>
    }
    
    // 6. 初始化任务链表
    dq-&gt;<span class="hljs-attr">dq_items_head</span> = dq-&gt;dq_items_tail = NULL<span class="hljs-comment">;</span>
    
    return dq<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-13">任务执行流程数据结构</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 任务提交和执行涉及的数据结构</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_workloop_s</span> {
    <span class="hljs-comment">// 工作循环（每个线程一个）</span>
    <span class="hljs-type">pthread_workqueue_t</span> dqw_workqueue;      <span class="hljs-comment">// 底层工作队列</span>
    <span class="hljs-type">uint32_t</span> dqw_refcnt;                    <span class="hljs-comment">// 引用计数</span>
    <span class="hljs-type">uint16_t</span> dqw_qos;                       <span class="hljs-comment">// QoS 级别</span>
    
    <span class="hljs-comment">// 任务调度</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *dqw_head;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *dqw_tail;
    
    <span class="hljs-comment">// 线程池管理</span>
    <span class="hljs-type">uint32_t</span> dqw_thread_pool_size;          <span class="hljs-comment">// 线程池大小</span>
    <span class="hljs-type">uint32_t</span> dqw_thread_pool_active;        <span class="hljs-comment">// 活跃线程数</span>
};
</code></pre>
<h2 data-id="heading-14">调试信息</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 可以通过私有 API 查看内部结构（仅调试）</span>
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">DispatchQueue</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">debugInfo</span>() {
        <span class="hljs-keyword">let</span> queue <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">as</span> <span class="hljs-type">AnyObject</span>
        
        <span class="hljs-comment">// 使用 Objective-C 运行时查看内部结构</span>
        <span class="hljs-keyword">let</span> ivars <span class="hljs-operator">=</span> class_copyIvarList(object_getClass(queue), <span class="hljs-literal">nil</span>)
        <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> ivar <span class="hljs-operator">=</span> ivars<span class="hljs-operator">?</span>.pointee {
            <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(cString: ivar_getName(ivar)<span class="hljs-operator">!</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Ivar: (name)"</span>)
        }
    }
}

<span class="hljs-comment">// 或者使用 LLDB 调试</span>
(lldb) po (id)<span class="hljs-number">0x600003d6c040</span>  <span class="hljs-comment">// 假设这是队列地址</span>
<span class="hljs-comment">// 可以看到内部字段（如果符号可用）</span>
</code></pre>
<h2 data-id="heading-15">性能优化特性</h2>
<h3 data-id="heading-16">1. <strong>内联缓存</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_cache_s</span> {
    <span class="hljs-comment">// 缓存最近使用的队列</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> *dqc_queues[DISPATCH_QUEUE_CACHE_SIZE];
    <span class="hljs-type">uint32_t</span> dqc_hits;                      <span class="hljs-comment">// 缓存命中次数</span>
    <span class="hljs-type">uint32_t</span> dqc_misses;                    <span class="hljs-comment">// 缓存未命中</span>
};
</code></pre>
<h3 data-id="heading-17">2. <strong>优先级继承</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_priority_s</span> {
    <span class="hljs-type">uint16_t</span> dqp_priority;                  <span class="hljs-comment">// 当前优先级</span>
    <span class="hljs-type">uint16_t</span> dqp_inherited;                 <span class="hljs-comment">// 继承的优先级</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> *dqp_source;    <span class="hljs-comment">// 优先级来源队列</span>
};
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p><code>DispatchQueue</code> 的底层数据结构：</p>
<ol>
<li><strong>复杂但高效</strong>：多层结构体设计，兼顾灵活性和性能</li>
<li><strong>基于对象模型</strong>：所有 dispatch 对象共享基类，实现多态</li>
<li><strong>链表管理任务</strong>：使用双向链表存储待执行任务</li>
<li><strong>层次化设计</strong>：队列有目标队列，形成优先级继承链</li>
<li><strong>类型特定扩展</strong>：不同队列类型有不同字段和虚函数表</li>
<li><strong>性能优化密集</strong>：包含大量缓存、计数器和优化字段</li>
</ol>
<p><strong>简单来说</strong>：<code>DispatchQueue</code> 在底层是一个<strong>精心设计的任务调度引擎</strong>，它：</p>
<ul>
<li>用<strong>结构体</strong>表示队列（而非类）</li>
<li>用<strong>链表</strong>管理任务</li>
<li>用<strong>虚函数表</strong>实现不同队列类型的行为</li>
<li>用<strong>目标队列</strong>机制实现优先级继承</li>
<li>高度优化以减少内存占用和提高性能</li>
</ul>
<p>这种设计使得 GCD 能够在极小的开销下处理数千个队列和数百万个任务调度。</p>
<h2 data-id="heading-19">👉 追问：任务是如何入队、出队的？</h2>
<p>任务入队出队是 GCD 的核心机制，涉及<strong>原子操作、无锁队列、优先级调度</strong>等多个复杂系统。</p>
<h2 data-id="heading-20">核心数据结构关系</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 简化版数据结构关系</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_s</span> {
    <span class="hljs-comment">// 任务链表（无锁队列）</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *<span class="hljs-keyword">volatile</span> dq_items_head;  <span class="hljs-comment">// 队头</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *<span class="hljs-keyword">volatile</span> dq_items_tail;  <span class="hljs-comment">// 队尾</span>
    <span class="hljs-type">uint32_t</span> dq_nitems;                           <span class="hljs-comment">// 任务计数</span>
    
    <span class="hljs-comment">// 线程池引用</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_queue_workloop_s</span> *dq_wlh;     <span class="hljs-comment">// 工作循环</span>
};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> {
    <span class="hljs-comment">// 任务数据和函数指针</span>
    <span class="hljs-type">dispatch_function_t</span> dc_func;      <span class="hljs-comment">// 要执行的函数</span>
    <span class="hljs-type">void</span> *dc_ctxt;                    <span class="hljs-comment">// 上下文参数</span>
    
    <span class="hljs-comment">// 链表指针（双向链表）</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *<span class="hljs-keyword">volatile</span> dc_next;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dispatch_continuation_s</span> *dc_prev;
    
    <span class="hljs-comment">// 标记信息</span>
    <span class="hljs-type">uintptr_t</span> dc_flags;              <span class="hljs-comment">// 标志位（同步/异步/屏障等）</span>
};
</code></pre>
<h2 data-id="heading-21">1. 入队过程（Enqueue）</h2>
<h3 data-id="heading-22">异步任务入队（dispatch_async）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 用户调用</span>
queue<span class="hljs-selector-class">.async</span> {
    <span class="hljs-built_in">print</span>("任务执行")
}

<span class="hljs-comment">// 内部处理流程</span>
func <span class="hljs-built_in">dispatch_async</span>(queue: dispatch_queue_t, block: @escaping () -&gt; Void) {
    <span class="hljs-comment">// 1. 封装任务</span>
    let continuation = <span class="hljs-built_in">_dispatch_continuation_alloc</span>()
    continuation<span class="hljs-selector-class">.dc_func</span> = _dispatch_call_block_and_release
    continuation<span class="hljs-selector-class">.dc_ctxt</span> = <span class="hljs-built_in">Block_copy</span>(block)  <span class="hljs-comment">// 复制block到堆上</span>
    
    <span class="hljs-comment">// 2. 获取队列状态</span>
    let old_state = queue<span class="hljs-selector-class">.dq_state</span>
    
    <span class="hljs-comment">// 3. 尝试快速路径（无锁操作）</span>
    if <span class="hljs-built_in">_dispatch_queue_try_acquire_async</span>(queue) {
        <span class="hljs-comment">// 快速路径：队列空闲，直接调度</span>
        <span class="hljs-built_in">_dispatch_continuation_schedule</span>(queue, continuation)
        return
    }
    
    <span class="hljs-comment">// 4. 慢速路径：需要加锁或队列繁忙</span>
    <span class="hljs-built_in">_dispatch_queue_push</span>(queue, continuation)
}
</code></pre>
<h3 data-id="heading-23">详细入队步骤</h3>
<pre><code class="hljs language-ini" lang="ini">// 实际入队函数
void _dispatch_queue_push(dispatch_queue_t dq, 
                         dispatch_continuation_t dc) {
    
    // 步骤1：设置任务状态
    dc-&gt;<span class="hljs-attr">dc_queue</span> = dq<span class="hljs-comment">;           // 关联队列</span>
    dc-&gt;<span class="hljs-attr">dc_flags</span> = ASYNC<span class="hljs-comment">;        // 标记为异步</span>
    
    // 步骤2：原子操作将任务加入链表尾部
    dispatch_continuation_t prev_tail<span class="hljs-comment">;</span>
    do {
        <span class="hljs-attr">prev_tail</span> = dq-&gt;dq_items_tail<span class="hljs-comment">;</span>
        dc-&gt;<span class="hljs-attr">dc_prev</span> = prev_tail<span class="hljs-comment">;           // 设置前驱</span>
    } while (!os_atomic_cmpxchg(&amp;dq-&gt;dq_items_tail, 
                                prev_tail, 
                                dc, 
                                relaxed))<span class="hljs-comment">;</span>
    
    // 步骤3：更新前一个节点的next指针
    if (prev_tail) {
        prev_tail-&gt;<span class="hljs-attr">dc_next</span> = dc<span class="hljs-comment">;          // 连接链表</span>
    } else {
        // 这是第一个任务，更新头指针
        dq-&gt;<span class="hljs-attr">dq_items_head</span> = dc<span class="hljs-comment">;</span>
    }
    
    // 步骤4：原子递增任务计数
    os_atomic_inc(&amp;dq-&gt;dq_nitems, relaxed)<span class="hljs-comment">;</span>
    
    // 步骤5：唤醒工作线程（如果需要）
    _dispatch_queue_wakeup(dq)<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-24">屏障任务特殊处理</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 屏障任务的入队</span>
void <span class="hljs-built_in">_dispatch_barrier_async</span>(dispatch_queue_t dq, 
                            dispatch_block_t block) {
    
    dispatch_continuation_t dc = <span class="hljs-built_in">_dispatch_continuation_alloc</span>();
    dc-&gt;dc_func = _dispatch_call_block_and_release;
    dc-&gt;dc_ctxt = <span class="hljs-built_in">Block_copy</span>(block);
    dc-&gt;dc_flags = BARRIER;               <span class="hljs-comment">// 关键：设置屏障标志</span>
    
    <span class="hljs-comment">// 屏障任务需要特殊处理：</span>
    <span class="hljs-comment">// 1. 插入到队列末尾</span>
    <span class="hljs-comment">// 2. 标记队列进入"屏障模式"</span>
    <span class="hljs-comment">// 3. 等待前面所有任务完成</span>
    
    <span class="hljs-built_in">_dispatch_queue_push_barrier</span>(dq, dc);
    
    <span class="hljs-comment">// 更新队列状态</span>
    dq-&gt;dq_atomic_flags |= DISPATCH_QUEUE_IN_BARRIER;
}
</code></pre>
<h2 data-id="heading-25">2. 出队过程（Dequeue）</h2>
<h3 data-id="heading-26">工作线程取任务</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 工作线程的主循环</span>
void *<span class="hljs-built_in">_dispatch_worker_thread</span>(void *context) {
    dispatch_queue_t dq = (dispatch_queue_t)context;
    
    while (<span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 步骤1：获取下一个任务</span>
        dispatch_continuation_t dc = <span class="hljs-built_in">_dispatch_queue_pop</span>(dq);
        
        if (dc) {
            <span class="hljs-comment">// 步骤2：执行任务</span>
            <span class="hljs-built_in">_dispatch_continuation_invoke</span>(dq, dc);
            
            <span class="hljs-comment">// 步骤3：任务完成后处理</span>
            <span class="hljs-built_in">_dispatch_continuation_free</span>(dc);
        } else {
            <span class="hljs-comment">// 步骤4：无任务，可能休眠或处理其他队列</span>
            <span class="hljs-built_in">_dispatch_worker_yield_or_exit</span>(dq);
        }
    }
    return NULL;
}
</code></pre>
<h3 data-id="heading-27">详细出队实现</h3>
<pre><code class="hljs language-ini" lang="ini">// 从队列弹出任务
dispatch_continuation_t _dispatch_queue_pop(dispatch_queue_t dq) {
    
    // 步骤1：检查队列状态
    if (dq-&gt;<span class="hljs-attr">dq_nitems</span> == <span class="hljs-number">0</span>) {
        return NULL<span class="hljs-comment">;  // 队列为空</span>
    }
    
    // 步骤2：处理串行队列（简单）
    if (dq-&gt;<span class="hljs-attr">dq_width</span> == <span class="hljs-number">1</span>) {  // 串行队列
        return _dispatch_queue_pop_serial(dq)<span class="hljs-comment">;</span>
    }
    
    // 步骤3：处理并发队列（复杂）
    return _dispatch_queue_pop_concurrent(dq)<span class="hljs-comment">;</span>
}

// 串行队列出队（简单FIFO）
dispatch_continuation_t _dispatch_queue_pop_serial(dispatch_queue_t dq) {
    
    // 原子操作获取队头
    dispatch_continuation_t head<span class="hljs-comment">;</span>
    do {
        <span class="hljs-attr">head</span> = dq-&gt;dq_items_head<span class="hljs-comment">;</span>
        if (!head) return NULL<span class="hljs-comment">;  // 队列为空</span>
        
        // 尝试将头指针指向下一个任务
    } while (!os_atomic_cmpxchg(&amp;dq-&gt;dq_items_head, 
                                head, 
                                head-&gt;dc_next, 
                                acquire))<span class="hljs-comment">;</span>
    
    // 如果队列变空，清空尾指针
    if (head-&gt;<span class="hljs-attr">dc_next</span> == NULL) {
        dq-&gt;<span class="hljs-attr">dq_items_tail</span> = NULL<span class="hljs-comment">;</span>
    }
    
    // 更新任务计数
    os_atomic_dec(&amp;dq-&gt;dq_nitems, relaxed)<span class="hljs-comment">;</span>
    
    // 清理链表指针
    head-&gt;<span class="hljs-attr">dc_next</span> = NULL<span class="hljs-comment">;</span>
    head-&gt;<span class="hljs-attr">dc_prev</span> = NULL<span class="hljs-comment">;</span>
    
    return head<span class="hljs-comment">;</span>
}

// 并发队列出队（多线程安全）
dispatch_continuation_t _dispatch_queue_pop_concurrent(dispatch_queue_t dq) {
    
    // 使用原子操作+重试机制
    dispatch_continuation_t <span class="hljs-attr">task</span> = NULL<span class="hljs-comment">;</span>
    bool <span class="hljs-attr">acquired</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    
    while (!acquired) {
        // 原子读取队头
        dispatch_continuation_t <span class="hljs-attr">old_head</span> = dq-&gt;dq_items_head<span class="hljs-comment">;</span>
        
        if (!old_head) {
            return NULL<span class="hljs-comment">;  // 队列为空</span>
        }
        
        // 尝试获取任务所有权
        <span class="hljs-attr">acquired</span> = os_atomic_cmpxchg(&amp;dq-&gt;dq_items_head, 
                                     old_head, 
                                     old_head-&gt;dc_next, 
                                     acquire)<span class="hljs-comment">;</span>
        
        if (acquired) {
            <span class="hljs-attr">task</span> = old_head<span class="hljs-comment">;</span>
            
            // 如果这是最后一个任务
            if (task-&gt;<span class="hljs-attr">dc_next</span> == NULL) {
                // 需要原子更新尾指针
                os_atomic_store(&amp;dq-&gt;dq_items_tail, NULL, relaxed)<span class="hljs-comment">;</span>
            }
        }
        // 如果失败，说明其他线程抢先获取了，重试
    }
    
    os_atomic_dec(&amp;dq-&gt;dq_nitems, relaxed)<span class="hljs-comment">;</span>
    task-&gt;<span class="hljs-attr">dc_next</span> = NULL<span class="hljs-comment">;</span>
    task-&gt;<span class="hljs-attr">dc_prev</span> = NULL<span class="hljs-comment">;</span>
    
    return task<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-28">3. 任务执行流程</h2>
<h3 data-id="heading-29">任务执行函数</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 执行任务的函数</span>
void <span class="hljs-built_in">_dispatch_continuation_invoke</span>(dispatch_queue_t dq,
                                   dispatch_continuation_t dc) {
    
    <span class="hljs-comment">// 步骤1：保存当前队列上下文</span>
    dispatch_queue_t old_dq = <span class="hljs-built_in">_dispatch_thread_getspecific</span>(dispatch_queue_key);
    <span class="hljs-built_in">_dispatch_thread_setspecific</span>(dispatch_queue_key, dq);
    
    <span class="hljs-comment">// 步骤2：设置线程名字（便于调试）</span>
    if (dq-&gt;dq_label) {
        <span class="hljs-built_in">pthread_setname_np</span>(dq-&gt;dq_label);
    }
    
    <span class="hljs-comment">// 步骤3：执行任务函数</span>
    dc-&gt;<span class="hljs-built_in">dc_func</span>(dc-&gt;dc_ctxt);
    
    <span class="hljs-comment">// 步骤4：恢复之前的队列上下文</span>
    <span class="hljs-built_in">_dispatch_thread_setspecific</span>(dispatch_queue_key, old_dq);
    
    <span class="hljs-comment">// 步骤5：如果是同步任务，发送信号</span>
    if (dc-&gt;dc_flags &amp; SYNC) {
        <span class="hljs-built_in">_dispatch_semaphore_signal</span>(dc-&gt;dc_semaphore);
    }
}
</code></pre>
<h3 data-id="heading-30">屏障任务的特殊执行</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 屏障任务的执行</span>
void <span class="hljs-built_in">_dispatch_barrier_execute</span>(dispatch_queue_t dq,
                               dispatch_continuation_t dc) {
    
    <span class="hljs-comment">// 步骤1：等待队列中所有前置任务完成</span>
    while (dq-&gt;dq_running &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 忙等待或让出CPU</span>
        <span class="hljs-built_in">_dispatch_hardware_pause</span>();
    }
    
    <span class="hljs-comment">// 步骤2：执行屏障任务（独占执行）</span>
    <span class="hljs-built_in">_dispatch_continuation_invoke</span>(dq, dc);
    
    <span class="hljs-comment">// 步骤3：清除屏障标志</span>
    dq-&gt;dq_atomic_flags &amp;= ~DISPATCH_QUEUE_IN_BARRIER;
    
    <span class="hljs-comment">// 步骤4：唤醒等待的后续任务</span>
    <span class="hljs-built_in">_dispatch_queue_wakeup_next</span>(dq);
}
</code></pre>
<h2 data-id="heading-31">4. 性能优化机制</h2>
<h3 data-id="heading-32">任务批处理</h3>
<pre><code class="hljs language-ini" lang="ini">// 批量处理任务（减少锁开销）
void _dispatch_queue_drain(dispatch_queue_t dq) {
    
    // 尝试一次性取出多个任务
    dispatch_continuation_t batch<span class="hljs-section">[16]</span><span class="hljs-comment">;</span>
    int <span class="hljs-attr">count</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    
    // 批量出队
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 16; i++) {</span>
        dispatch_continuation_t <span class="hljs-attr">dc</span> = _dispatch_queue_pop_fast(dq)<span class="hljs-comment">;</span>
        if (!dc) break<span class="hljs-comment">;</span>
        
        batch<span class="hljs-section">[count++]</span> = dc<span class="hljs-comment">;</span>
    }
    
    if (<span class="hljs-attr">count</span> == <span class="hljs-number">0</span>) return<span class="hljs-comment">;</span>
    
    // 批量执行
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; count; i++) {</span>
        _dispatch_continuation_invoke(dq, batch<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
        _dispatch_continuation_free(batch<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-33">工作窃取（Work Stealing）</h3>
<pre><code class="hljs language-ini" lang="ini">// 当线程空闲时，尝试从其他队列窃取任务
dispatch_continuation_t _dispatch_worksteal(void) {
    
    // 步骤1：获取当前线程的工作队列
    dispatch_queue_t <span class="hljs-attr">current_queue</span> = _dispatch_thread_get_queue()<span class="hljs-comment">;</span>
    
    // 步骤2：遍历全局队列列表
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; global_queue_count; i++) {</span>
        dispatch_queue_t <span class="hljs-attr">target</span> = global_queues[i]<span class="hljs-comment">;</span>
        
        // 跳过自己的队列和空队列
        if (<span class="hljs-attr">target</span> == current_queue) continue<span class="hljs-comment">;</span>
        if (target-&gt;<span class="hljs-attr">dq_nitems</span> == <span class="hljs-number">0</span>) continue<span class="hljs-comment">;</span>
        
        // 步骤3：尝试窃取任务
        dispatch_continuation_t <span class="hljs-attr">stolen</span> = _dispatch_queue_try_steal(target)<span class="hljs-comment">;</span>
        if (stolen) {
            return stolen<span class="hljs-comment">;  // 窃取成功</span>
        }
    }
    
    return NULL<span class="hljs-comment">;  // 没有可窃取的任务</span>
}
</code></pre>
<h2 data-id="heading-34">5. 同步任务特殊处理</h2>
<h3 data-id="heading-35">dispatch_sync 的实现</h3>
<pre><code class="hljs language-ini" lang="ini">void dispatch_sync(dispatch_queue_t dq, dispatch_block_t block) {
    
    // 优化：如果当前已经在目标队列上，直接执行
    if (_dispatch_queue_is_current(dq)) {
        block()<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    
    // 创建同步任务结构
    struct dispatch_sync_context_s {
        dispatch_semaphore_t sema<span class="hljs-comment">;</span>
        dispatch_block_t block<span class="hljs-comment">;</span>
        bool done<span class="hljs-comment">;</span>
    } context<span class="hljs-comment">;</span>
    
    <span class="hljs-attr">context.sema</span> = dispatch_semaphore_create(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">context.block</span> = block<span class="hljs-comment">;</span>
    <span class="hljs-attr">context.done</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    
    // 创建任务
    dispatch_continuation_t <span class="hljs-attr">dc</span> = _dispatch_continuation_alloc()<span class="hljs-comment">;</span>
    dc-&gt;<span class="hljs-attr">dc_func</span> = _dispatch_sync_invoke<span class="hljs-comment">;</span>
    dc-&gt;<span class="hljs-attr">dc_ctxt</span> = &amp;context<span class="hljs-comment">;</span>
    dc-&gt;<span class="hljs-attr">dc_flags</span> = SYNC<span class="hljs-comment">;</span>
    dc-&gt;<span class="hljs-attr">dc_semaphore</span> = context.sema<span class="hljs-comment">;</span>
    
    // 入队
    _dispatch_queue_push(dq, dc)<span class="hljs-comment">;</span>
    
    // 等待任务完成
    dispatch_semaphore_wait(context.sema, DISPATCH_TIME_FOREVER)<span class="hljs-comment">;</span>
    
    // 检查是否成功执行
    if (!context.done) {
        // 发生错误
        dispatch_panic("dispatch_sync failed")<span class="hljs-comment">;</span>
    }
}

// 同步任务执行函数
static void _dispatch_sync_invoke(void *ctxt) {
    struct dispatch_sync_context_s *<span class="hljs-attr">ctx</span> = ctxt<span class="hljs-comment">;</span>
    ctx-&gt;block()<span class="hljs-comment">;</span>
    ctx-&gt;<span class="hljs-attr">done</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-36">6. 优先级处理</h2>
<h3 data-id="heading-37">QoS 传播和提升</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 处理任务的优先级</span>
void <span class="hljs-built_in">_dispatch_queue_adjust_priority</span>(dispatch_queue_t dq,
                                     dispatch_continuation_t dc) {
    
    <span class="hljs-comment">// 获取任务的 QoS</span>
    qos_class_t task_qos = <span class="hljs-built_in">_dispatch_continuation_get_qos</span>(dc);
    
    <span class="hljs-comment">// 如果任务优先级高于队列当前优先级</span>
    if (task_qos &gt; dq-&gt;dq_priority) {
        <span class="hljs-comment">// 提升队列优先级</span>
        qos_class_t old_qos = dq-&gt;dq_priority;
        dq-&gt;dq_priority = task_qos;
        
        <span class="hljs-comment">// 重新调度队列中的工作线程</span>
        <span class="hljs-built_in">_dispatch_queue_reschedule</span>(dq, old_qos, task_qos);
    }
    
    <span class="hljs-comment">// 设置执行线程的 QoS</span>
    <span class="hljs-built_in">pthread_set_qos_class_self_np</span>(task_qos, <span class="hljs-number">0</span>);
}
</code></pre>
<h2 data-id="heading-38">完整流程示例</h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 模拟一个任务从提交到完成的完整流程</span>
func <span class="hljs-built_in">exampleTaskLifecycle</span>() {
    let queue = <span class="hljs-built_in">DispatchQueue</span>(label: "com.example", attributes: .concurrent)
    
    <span class="hljs-comment">// 用户提交任务</span>
    queue<span class="hljs-selector-class">.async</span> {
        <span class="hljs-built_in">print</span>("任务执行开始")
        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>)
        <span class="hljs-built_in">print</span>("任务执行结束")
    }
    
    <span class="hljs-comment">// 内部流程：</span>
    <span class="hljs-comment">// 1. async() 创建 dispatch_continuation_t</span>
    <span class="hljs-comment">// 2. 原子操作将任务添加到 queue.dq_items_tail</span>
    <span class="hljs-comment">// 3. queue.dq_nitems 原子递增</span>
    <span class="hljs-comment">// 4. _dispatch_queue_wakeup() 唤醒工作线程</span>
    <span class="hljs-comment">// 5. 工作线程从 queue.dq_items_head 取出任务</span>
    <span class="hljs-comment">// 6. 调用 dc_func(dc_ctxt) 执行任务</span>
    <span class="hljs-comment">// 7. 任务完成，dc 被释放</span>
    <span class="hljs-comment">// 8. 工作线程继续取下一个任务或休眠</span>
}
</code></pre>
<h2 data-id="heading-39">7. 内存管理优化</h2>
<h3 data-id="heading-40">任务缓存池</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 避免频繁分配释放 dispatch_continuation_t</span>
struct dispatch_continuation_cache_s {
    dispatch_continuation_t free_list;      <span class="hljs-comment">// 空闲列表</span>
    uint32_t count;                         <span class="hljs-comment">// 缓存数量</span>
    os_unfair_lock lock;                    <span class="hljs-comment">// 保护锁</span>
};

<span class="hljs-comment">// 获取一个任务结构（优先从缓存取）</span>
dispatch_continuation_t <span class="hljs-built_in">_dispatch_continuation_alloc</span>(void) {
    dispatch_continuation_cache_t cache = &amp;g_continuation_cache;
    
    <span class="hljs-comment">// 尝试从缓存获取</span>
    <span class="hljs-built_in">os_unfair_lock_lock</span>(&amp;cache-&gt;lock);
    if (cache-&gt;free_list) {
        dispatch_continuation_t dc = cache-&gt;free_list;
        cache-&gt;free_list = dc-&gt;dc_next;
        cache-&gt;count--;
        <span class="hljs-built_in">os_unfair_lock_unlock</span>(&amp;cache-&gt;lock);
        
        <span class="hljs-comment">// 清零复用</span>
        <span class="hljs-built_in">memset</span>(dc, <span class="hljs-number">0</span>, sizeof(struct dispatch_continuation_s));
        return dc;
    }
    <span class="hljs-built_in">os_unfair_lock_unlock</span>(&amp;cache-&gt;lock);
    
    <span class="hljs-comment">// 缓存为空，分配新的</span>
    return <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, sizeof(struct dispatch_continuation_s));
}

<span class="hljs-comment">// 释放任务结构（放入缓存）</span>
void <span class="hljs-built_in">_dispatch_continuation_free</span>(dispatch_continuation_t dc) {
    dispatch_continuation_cache_t cache = &amp;g_continuation_cache;
    
    <span class="hljs-built_in">os_unfair_lock_lock</span>(&amp;cache-&gt;lock);
    if (cache-&gt;count &lt; DISPATCH_CONTINUATION_CACHE_MAX) {
        <span class="hljs-comment">// 放入缓存</span>
        dc-&gt;dc_next = cache-&gt;free_list;
        cache-&gt;free_list = dc;
        cache-&gt;count++;
        <span class="hljs-built_in">os_unfair_lock_unlock</span>(&amp;cache-&gt;lock);
    } else {
        <span class="hljs-built_in">os_unfair_lock_unlock</span>(&amp;cache-&gt;lock);
        <span class="hljs-built_in">free</span>(dc);  <span class="hljs-comment">// 缓存已满，直接释放</span>
    }
}
</code></pre>
<h2 data-id="heading-41">总结</h2>
<p>任务入队出队的核心机制：</p>
<h3 data-id="heading-42"><strong>入队过程</strong>：</h3>
<ol>
<li><strong>封装任务</strong>：将block封装成 <code>dispatch_continuation_t</code></li>
<li><strong>原子操作</strong>：使用CAS（Compare-And-Swap）将任务添加到链表尾部</li>
<li><strong>唤醒机制</strong>：如果需要，唤醒工作线程处理任务</li>
<li><strong>优先级处理</strong>：根据任务QoS调整队列优先级</li>
</ol>
<h3 data-id="heading-43"><strong>出队过程</strong>：</h3>
<ol>
<li><strong>原子竞争</strong>：多个工作线程竞争获取任务（无锁队列）</li>
<li><strong>批量处理</strong>：可能一次性取出多个任务减少开销</li>
<li><strong>工作窃取</strong>：空闲线程可以从其他队列窃取任务</li>
<li><strong>屏障处理</strong>：屏障任务确保前后任务不交错执行</li>
</ol>
<h3 data-id="heading-44"><strong>关键优化</strong>：</h3>
<ol>
<li><strong>无锁设计</strong>：使用原子操作避免锁竞争</li>
<li><strong>缓存复用</strong>：重用任务结构体减少内存分配</li>
<li><strong>批量处理</strong>：减少上下文切换开销</li>
<li><strong>优先级继承</strong>：高优先级任务能更快执行</li>
<li><strong>工作窃取</strong>：提高CPU利用率</li>
</ol>
<p><strong>简单比喻</strong>：</p>
<ul>
<li><strong>入队</strong> 像"快递站收件"：你提交包裹（任务），快递站记录到清单（队列），通知快递员（线程）来取</li>
<li><strong>出队</strong> 像"快递员派件"：快递员从清单取包裹，派送（执行），完成后标记完成</li>
<li><strong>GCD</strong> 像"智能调度系统"：动态分配快递员，优化路线，处理急件优先</li>
</ul>
<p>这种设计使得 GCD 能够以极低的延迟处理数百万级的任务调度，同时保持高吞吐量和低CPU占用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[企业级人脸识别ArcFace系统架构与实现：从零到一构建高性能智能识别平台]]></title>    <link>https://juejin.cn/post/7599847938538749961</link>    <guid>https://juejin.cn/post/7599847938538749961</guid>    <pubDate>2026-01-27T09:46:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599847938538749961" data-draft-id="7599847938538651657" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="企业级人脸识别ArcFace系统架构与实现：从零到一构建高性能智能识别平台"/> <meta itemprop="keywords" content="Trae,Spring Boot"/> <meta itemprop="datePublished" content="2026-01-27T09:46:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Harry技术"/> <meta itemprop="url" content="https://juejin.cn/user/4325909730446745"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            企业级人脸识别ArcFace系统架构与实现：从零到一构建高性能智能识别平台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4325909730446745/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Harry技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:46:52.000Z" title="Tue Jan 27 2026 09:46:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">企业级人脸识别系统架构与实现：从零到一构建高性能智能识别平台</h2>
<blockquote>
<p>作者：Harry 公众号：Harry技术 本文将深入解析一个完整的企业级人脸识别系统，涵盖架构设计、核心算法、性能优化等关键技术点。</p>
</blockquote>
<h3 data-id="heading-1">前言</h3>
<p>随着人工智能技术的快速发展，人脸识别已经成为智能化应用的重要组成部分。本文将基于实际项目经验，详细介绍如何构建一个高性能、可扩展的企业级人脸识别系统。</p>
<h3 data-id="heading-2">系统架构概览</h3>
<h4 data-id="heading-3">整体架构设计</h4>
<p>我们的人脸识别系统采用前后端分离的架构，主要包含以下几个核心模块：</p>
<pre><code class="hljs language-dart" lang="dart">┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面层     │    │   API网关层     │    │   业务服务层     │
│  Vue3 + TS      │◄──►│  Spring Boot    │◄──►│  人脸识别服务    │
│  <span class="hljs-built_in">Element</span> Plus   │    │  RESTful API    │    │  特征管理服务    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                       ┌─────────────────┐    ┌─────────────────┐
                       │   缓存层        │    │   存储层        │
                       │  Redis          │◄──►│  MySQL          │
                       │  特征缓存       │    │  用户数据       │
                       └─────────────────┘    └─────────────────┘
                                │
                       ┌─────────────────┐
                       │   算法引擎层     │
                       │  虹软ArcFace    │
                       │  引擎池管理     │
                       └─────────────────┘
</code></pre>
<h4 data-id="heading-4">技术栈选择</h4>
<p><strong>前端技术栈：</strong></p>
<ul>
<li>Vue 3 + TypeScript：现代化前端框架</li>
<li>Element Plus：企业级UI组件库</li>
<li>Vite：高性能构建工具</li>
</ul>
<p><strong>后端技术栈：</strong></p>
<ul>
<li>Spring Boot 3：微服务框架</li>
<li>MyBatis Plus：数据访问层</li>
<li>Redis：高性能缓存</li>
<li>MySQL：关系型数据库</li>
</ul>
<p><strong>算法引擎：</strong></p>
<ul>
<li>虹软ArcFace SDK：业界领先的人脸识别算法</li>
</ul>
<h3 data-id="heading-5">核心功能模块</h3>
<h4 data-id="heading-6">1. 人脸检测与识别</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c65ac02c76194594b16347ff56d6f41c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFycnnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112011&amp;x-signature=o7k4NAEb1EW8e4mfiW8woTBIXDE%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-7">前端实现</h5>
<p>前端采用Vue 3 Composition API，实现了直观的人脸识别界面：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"recognition-content"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 智能识别中心 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"section-block hero-block"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hero-icon"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">CameraFilled</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hero-text"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>智能识别中心<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>拖拽或上传照片，系统将自动完成检测、比对与注册。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
​
    <span class="hljs-comment">&lt;!-- 图片上传区域 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-body"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-upload</span>
        <span class="hljs-attr">:auto-upload</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">:before-upload</span>=<span class="hljs-string">"beforeUpload"</span>
        <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span>
        <span class="hljs-attr">drag</span>
        @<span class="hljs-attr">change</span>=<span class="hljs-string">"handleUploadChange"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Plus</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>拖拽或点击上传人脸图像<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-upload</span>&gt;</span>
      
      <span class="hljs-comment">&lt;!-- 实时预览与检测框 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-preview-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"previewImageRef"</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"recognitionImageUrl"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
          <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showDetectionBox"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"face-detection-box"</span>
          <span class="hljs-attr">:style</span>=<span class="hljs-string">"detectionBoxStyle"</span>
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box-label"</span>&gt;</span>{{ recognitionResult?.name || '未识别' }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p><strong>核心功能特性：</strong></p>
<ul>
<li>拖拽上传支持</li>
<li>实时人脸检测框显示</li>
<li>历史图片快速切换</li>
<li>响应式布局设计</li>
</ul>
<h5 data-id="heading-8">后端API设计</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/face"</span>)
public class FaceController {
​
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/faceRecognition"</span>)
    public R&lt;List&lt;FaceRecognitionResDTO&gt;&gt; <span class="hljs-built_in">faceRecognition</span>(
        <span class="hljs-variable">@RequestBody</span> FaceRecognitionReqDTO request) {
        
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">image</span> = <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.getImage</span>();
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">FaceRecognitionResDTO</span>&gt; <span class="hljs-selector-tag">results</span> = <span class="hljs-selector-tag">Lists</span><span class="hljs-selector-class">.newLinkedList</span>();
        
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-comment">// 1. Base64图片解码</span>
            <span class="hljs-selector-tag">byte</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">bytes</span> = <span class="hljs-selector-tag">Base64Util</span><span class="hljs-selector-class">.base64ToBytes</span>(image);
            <span class="hljs-selector-tag">ImageInfo</span> <span class="hljs-selector-tag">rgbData</span> = <span class="hljs-selector-tag">ImageFactory</span><span class="hljs-selector-class">.getRGBData</span>(bytes);
            
            <span class="hljs-comment">// 2. 人脸检测</span>
            <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">FaceInfo</span>&gt; <span class="hljs-selector-tag">faceInfoList</span> = <span class="hljs-selector-tag">faceEngineService</span><span class="hljs-selector-class">.detectFaces</span>(rgbData);
            
            <span class="hljs-selector-tag">if</span> (CollectionUtil.<span class="hljs-built_in">isNotEmpty</span>(faceInfoList)) {
                <span class="hljs-comment">// 3. 获取数据库中的所有特征</span>
                <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Feature</span>&gt; <span class="hljs-selector-tag">dbFeatures</span> = <span class="hljs-selector-tag">featureService</span><span class="hljs-selector-class">.list</span>(
                    new LambdaQueryWrapper&lt;Feature&gt;()
                        .<span class="hljs-built_in">eq</span>(<span class="hljs-attribute">Feature</span>::getStatus, <span class="hljs-string">"1"</span>)
                        .<span class="hljs-built_in">eq</span>(<span class="hljs-attribute">Feature</span>::getValid, <span class="hljs-number">1</span>)
                );
                
                <span class="hljs-comment">// 4. 特征比对识别</span>
                <span class="hljs-selector-tag">for</span> (FaceInfo <span class="hljs-attribute">faceInfo </span>: faceInfoList) {
                    <span class="hljs-selector-tag">byte</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">feature</span> = <span class="hljs-selector-tag">faceEngineService</span><span class="hljs-selector-class">.extractFaceFeature</span>(rgbData, faceInfo);
                    <span class="hljs-selector-tag">if</span> (feature != null) {
                        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">UserCompareInfo</span>&gt; <span class="hljs-selector-tag">matches</span> = <span class="hljs-selector-tag">faceEngineService</span>
                            <span class="hljs-selector-class">.faceRecognition</span>(feature, userInfoList, <span class="hljs-number">0.8</span>f);
                        
                        <span class="hljs-comment">// 5. 构建识别结果</span>
                        <span class="hljs-selector-tag">FaceRecognitionResDTO</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">FaceRecognitionResDTO</span>();
                        <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.setRect</span>(faceInfo.<span class="hljs-built_in">getRect</span>());
                        <span class="hljs-selector-tag">if</span> (CollectionUtil.<span class="hljs-built_in">isNotEmpty</span>(matches)) {
                            <span class="hljs-selector-tag">UserCompareInfo</span> <span class="hljs-selector-tag">bestMatch</span> = <span class="hljs-selector-tag">matches</span><span class="hljs-selector-class">.get</span>(<span class="hljs-number">0</span>);
                            <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.setName</span>(bestMatch.<span class="hljs-built_in">getName</span>());
                            <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.setSimilar</span>(bestMatch.<span class="hljs-built_in">getSimilar</span>());
                            <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.setFaceId</span>(Long.<span class="hljs-built_in">valueOf</span>(bestMatch.<span class="hljs-built_in">getFaceId</span>()));
                        }
                        <span class="hljs-selector-tag">results</span><span class="hljs-selector-class">.add</span>(result);
                    }
                }
            }
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"人脸识别处理异常"</span>, e);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">R</span><span class="hljs-selector-class">.failed</span>(<span class="hljs-string">"人脸识别处理异常："</span> + e.<span class="hljs-built_in">getMessage</span>());
        }
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">R</span><span class="hljs-selector-class">.success</span>(results);
    }
}
</code></pre>
<h4 data-id="heading-9">2. 人脸特征注册系统</h4>
<h5 data-id="heading-10">智能注册流程</h5>
<p>当系统检测到未识别的人脸时，会自动提示用户进行注册：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端注册逻辑</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRegister</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (!detectedFeature.<span class="hljs-property">value</span>) {
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请先上传人脸图像并完成检测'</span>)
    <span class="hljs-keyword">return</span>
  }
  
  <span class="hljs-comment">// 显示注册表单弹窗</span>
  showRegisterDialog.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
}
​
<span class="hljs-comment">// 提交注册表单</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRegisterSubmit</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> registerFormRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">validate</span>()
    
    registerLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    
    <span class="hljs-comment">// 调用后端保存接口</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ArcFaceAPI</span>.<span class="hljs-title function_">saveFeature</span>({
      <span class="hljs-attr">name</span>: registerForm.<span class="hljs-property">value</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">trim</span>(),
      <span class="hljs-attr">featureCode</span>: registerForm.<span class="hljs-property">value</span>.<span class="hljs-property">featureCode</span>.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">toUpperCase</span>(),
      <span class="hljs-attr">image</span>: <span class="hljs-string">`data:image/jpeg;base64,<span class="hljs-subst">${detectedFeature.value}</span>`</span>
    })
    
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">success</span>) {
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'人脸注册成功'</span>)
      <span class="hljs-comment">// 更新识别结果显示</span>
      recognitionResult.<span class="hljs-property">value</span> = {
        <span class="hljs-attr">name</span>: registerForm.<span class="hljs-property">value</span>.<span class="hljs-property">name</span>.<span class="hljs-title function_">trim</span>(),
        <span class="hljs-attr">featureCode</span>: registerForm.<span class="hljs-property">value</span>.<span class="hljs-property">featureCode</span>.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">toUpperCase</span>(),
        <span class="hljs-attr">score</span>: <span class="hljs-number">1.0</span>,
        <span class="hljs-attr">status</span>: <span class="hljs-string">'1'</span>
      }
      showRegisterDialog.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
      <span class="hljs-title function_">emits</span>(<span class="hljs-string">'register'</span>, detectedFeature.<span class="hljs-property">value</span>)
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'人脸注册失败：'</span> + error)
  } <span class="hljs-keyword">finally</span> {
    registerLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
  }
}
</code></pre>
<h5 data-id="heading-11">后端特征保存服务</h5>
<pre><code class="hljs language-ini" lang="ini">@Service
@Transactional(<span class="hljs-attr">rollbackFor</span> = Exception.class)
public class FeatureServiceImpl implements FeatureService {
​
    @Override
    public boolean saveFeature(String name, String featureCode, String image) {
        log.info("开始保存人脸特征，姓名: {}, 特征码: {}", name, featureCode)<span class="hljs-comment">;</span>
        
        try {
            // 1. 参数验证
            if (StrUtil.isBlank(name) || StrUtil.isBlank(featureCode) || StrUtil.isBlank(image)) {
                log.error("参数不能为空")<span class="hljs-comment">;</span>
                return false<span class="hljs-comment">;</span>
            }
            
            // 2. 解码Base64图片数据
            byte<span class="hljs-section">[]</span> <span class="hljs-attr">imageBytes</span> = decodeBase64Image(image)<span class="hljs-comment">;</span>
            
            // 3. 保存图片到本地
            String <span class="hljs-attr">fileName</span> = name + <span class="hljs-string">"_"</span> + featureCode.toUpperCase() + <span class="hljs-string">".png"</span><span class="hljs-comment">;</span>
            String <span class="hljs-attr">savedFilePath</span> = fileUtils.saveFeatureImage(imageBytes, fileName)<span class="hljs-comment">;</span>
            
            // 4. 人脸检测和特征提取
            byte<span class="hljs-section">[]</span> <span class="hljs-attr">faceFeatureData</span> = extractFaceFeatureFromImage(imageBytes)<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">faceFeatureData</span> == null) {
                log.error("人脸特征提取失败")<span class="hljs-comment">;</span>
                return false<span class="hljs-comment">;</span>
            }
            
            // 5. 保存到数据库
            Feature <span class="hljs-attr">feature</span> = new Feature()<span class="hljs-comment">;</span>
            feature.setName(name)<span class="hljs-comment">;</span>
            feature.setFeatureCode(featureCode.toUpperCase())<span class="hljs-comment">;</span>
            feature.setFeature(savedFilePath)<span class="hljs-comment">;</span>
            feature.setFeatureData(faceFeatureData)<span class="hljs-comment">;</span>
            feature.setFeatureVersion("1.0")<span class="hljs-comment">;</span>
            feature.setStatus(StatusEnums.ENABLE.getKey())<span class="hljs-comment">;</span>
            
            boolean <span class="hljs-attr">saveResult</span> = this.save(feature)<span class="hljs-comment">;</span>
            
            // 6. 更新Redis缓存
            if (saveResult) {
                UserRamCache.UserInfo <span class="hljs-attr">userInfo</span> = new UserRamCache.UserInfo()<span class="hljs-comment">;</span>
                userInfo.setFaceId(String.valueOf(feature.getId()))<span class="hljs-comment">;</span>
                userInfo.setName(name)<span class="hljs-comment">;</span>
                userInfo.setFaceFeature(faceFeatureData)<span class="hljs-comment">;</span>
                arcFaceRedisService.addUser(userInfo)<span class="hljs-comment">;</span>
            }
            
            return saveResult<span class="hljs-comment">;</span>
        } catch (Exception e) {
            log.error("保存人脸特征失败", e)<span class="hljs-comment">;</span>
            return false<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-12">3. 高性能引擎池管理</h4>
<h5 data-id="heading-13">引擎池架构设计</h5>
<p>为了支持高并发访问，我们设计了双引擎池架构：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArcFaceEngineConfiguration</span> {
​
    <span class="hljs-comment">/**
     * 通用人脸识别引擎池 - VIDEO模式
     * 用于实时视频流检测
     */</span>
    <span class="hljs-meta">@Bean("faceEngineGeneralPool")</span>
    <span class="hljs-keyword">public</span> GenericObjectPool&lt;FaceEngine&gt; <span class="hljs-title function_">faceEngineGeneralPool</span><span class="hljs-params">()</span> {
        GenericObjectPoolConfig&lt;FaceEngine&gt; poolConfig = createPoolConfig(detectPoolSize);
        <span class="hljs-type">EngineConfiguration</span> <span class="hljs-variable">engineConfig</span> <span class="hljs-operator">=</span> createGeneralEngineConfiguration();
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericObjectPool</span>&lt;&gt;(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FaceEngineFactory</span>(appId, sdkKey, <span class="hljs-literal">null</span>, engineConfig), 
            poolConfig
        );
    }
​
    <span class="hljs-comment">/**
     * 人脸比对引擎池 - IMAGE模式
     * 用于特征提取和比对
     */</span>
    <span class="hljs-meta">@Bean("faceEngineComparePool")</span>
    <span class="hljs-keyword">public</span> GenericObjectPool&lt;FaceEngine&gt; <span class="hljs-title function_">faceEngineComparePool</span><span class="hljs-params">()</span> {
        GenericObjectPoolConfig&lt;FaceEngine&gt; poolConfig = createPoolConfig(comparePoolSize);
        <span class="hljs-type">EngineConfiguration</span> <span class="hljs-variable">engineConfig</span> <span class="hljs-operator">=</span> createCompareEngineConfiguration();
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericObjectPool</span>&lt;&gt;(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FaceEngineFactory</span>(appId, sdkKey, <span class="hljs-literal">null</span>, engineConfig), 
            poolConfig
        );
    }
}
</code></pre>
<h5 data-id="heading-14">多线程并发处理</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
public class FaceEngineServiceImpl implements FaceEngineService {
​
    <span class="hljs-keyword">@Override</span>
    public List&lt;UserCompareInfo&gt; faceRecognition(byte[] faceFeature, 
                                                List&lt;UserRamCache.UserInfo&gt; userInfoList, 
                                                float passRate) {
        List&lt;UserCompareInfo&gt; resultList = Lists<span class="hljs-selector-class">.newLinkedList</span>();
        
        <span class="hljs-comment">// 分批处理，每批1000个用户</span>
        List&lt;List&lt;UserRamCache<span class="hljs-selector-class">.UserInfo</span>&gt;&gt; partitions = Lists<span class="hljs-selector-class">.partition</span>(userInfoList, <span class="hljs-number">1000</span>);
        CompletionService&lt;List&lt;UserCompareInfo&gt;&gt; completionService = 
            new ExecutorCompletionService&lt;&gt;(faceCompareExecutorService);
        
        <span class="hljs-comment">// 提交并发任务</span>
        for (List&lt;UserRamCache.UserInfo&gt; part : partitions) {
            completionService<span class="hljs-selector-class">.submit</span>(new CompareFaceTask(part, targetFaceFeature, passRate));
        }
        
        <span class="hljs-comment">// 收集结果</span>
        for (int i = <span class="hljs-number">0</span>; i &lt; partitions.size(); <span class="hljs-selector-tag">i</span>++) {
            try {
                List&lt;UserCompareInfo&gt; partResult = completionService<span class="hljs-selector-class">.take</span>()<span class="hljs-selector-class">.get</span>();
                if (CollectionUtil.isNotEmpty(partResult)) {
                    resultList<span class="hljs-selector-class">.addAll</span>(partResult);
                }
            } catch (Exception e) {
                log<span class="hljs-selector-class">.error</span>("人脸比对任务执行异常", e);
            }
        }
        
        <span class="hljs-comment">// 按相似度排序</span>
        resultList<span class="hljs-selector-class">.sort</span>((h1, h2) -&gt; <span class="hljs-selector-tag">h2</span><span class="hljs-selector-class">.getSimilar</span>()<span class="hljs-selector-class">.compareTo</span>(h1.getSimilar()));
        
        return resultList;
    }
}
</code></pre>
<h4 data-id="heading-15">4. Redis缓存优化</h4>
<h5 data-id="heading-16">缓存架构设计</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArcFaceRedisService</span> {
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">FACE_FEATURE_KEY_PREFIX</span> = <span class="hljs-string">"arcface:feature:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">FACE_USER_LIST_KEY</span> = <span class="hljs-string">"arcface:users"</span>;
    
    <span class="hljs-comment">/**
     * 添加用户到缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addUser</span>(<span class="hljs-params">UserRamCache.UserInfo userInfo</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">String</span> key = <span class="hljs-variable constant_">FACE_FEATURE_KEY_PREFIX</span> + userInfo.<span class="hljs-title function_">getFaceId</span>();
            
            <span class="hljs-comment">// 序列化用户信息</span>
            <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; userMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            userMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"faceId"</span>, userInfo.<span class="hljs-title function_">getFaceId</span>());
            userMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"name"</span>, userInfo.<span class="hljs-title function_">getName</span>());
            userMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"faceFeature"</span>, <span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">encode</span>(userInfo.<span class="hljs-title function_">getFaceFeature</span>()));
            
            <span class="hljs-comment">// 存储到Redis</span>
            redisTemplate.<span class="hljs-title function_">opsForHash</span>().<span class="hljs-title function_">putAll</span>(key, userMap);
            redisTemplate.<span class="hljs-title function_">expire</span>(key, <span class="hljs-title class_">Duration</span>.<span class="hljs-title function_">ofDays</span>(<span class="hljs-number">7</span>));
            
            <span class="hljs-comment">// 添加到用户列表</span>
            redisTemplate.<span class="hljs-title function_">opsForSet</span>().<span class="hljs-title function_">add</span>(<span class="hljs-variable constant_">FACE_USER_LIST_KEY</span>, userInfo.<span class="hljs-title function_">getFaceId</span>());
            
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"用户特征已添加到Redis缓存: {}"</span>, userInfo.<span class="hljs-title function_">getFaceId</span>());
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"添加用户到Redis缓存失败"</span>, e);
        }
    }
    
    <span class="hljs-comment">/**
     * 获取所有用户
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">UserRamCache</span>.<span class="hljs-property">UserInfo</span>&gt; <span class="hljs-title function_">getAllUsers</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; userIds = redisTemplate.<span class="hljs-title function_">opsForSet</span>().<span class="hljs-title function_">members</span>(<span class="hljs-variable constant_">FACE_USER_LIST_KEY</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-title class_">CollectionUtil</span>.<span class="hljs-title function_">isEmpty</span>(userIds)) {
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">Collections</span>.<span class="hljs-title function_">emptyList</span>();
            }
            
            <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">UserRamCache</span>.<span class="hljs-property">UserInfo</span>&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-keyword">for</span> (<span class="hljs-title class_">String</span> userId : userIds) {
                <span class="hljs-title class_">String</span> key = <span class="hljs-variable constant_">FACE_FEATURE_KEY_PREFIX</span> + userId;
                <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Object</span>, <span class="hljs-title class_">Object</span>&gt; userMap = redisTemplate.<span class="hljs-title function_">opsForHash</span>().<span class="hljs-title function_">entries</span>(key);
                
                <span class="hljs-keyword">if</span> (!userMap.<span class="hljs-title function_">isEmpty</span>()) {
                    <span class="hljs-title class_">UserRamCache</span>.<span class="hljs-property">UserInfo</span> userInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRamCache</span>.<span class="hljs-title class_">UserInfo</span>();
                    userInfo.<span class="hljs-title function_">setFaceId</span>((<span class="hljs-title class_">String</span>) userMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">"faceId"</span>));
                    userInfo.<span class="hljs-title function_">setName</span>((<span class="hljs-title class_">String</span>) userMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">"name"</span>));
                    userInfo.<span class="hljs-title function_">setFaceFeature</span>(<span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">decode</span>((<span class="hljs-title class_">String</span>) userMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">"faceFeature"</span>)));
                    users.<span class="hljs-title function_">add</span>(userInfo);
                }
            }
            
            <span class="hljs-keyword">return</span> users;
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"从Redis获取所有用户失败"</span>, e);
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Collections</span>.<span class="hljs-title function_">emptyList</span>();
        }
    }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22a1f1843a8f458fb6874c7c03977a86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFycnnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112011&amp;x-signature=3QQlgrbiIlmjpZsLut1rCV5oOYk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-17">性能优化策略</h3>
<h4 data-id="heading-18">1. 算法优化</h4>
<p><strong>检测模式优化：</strong></p>
<ul>
<li>VIDEO模式：用于实时视频流，检测速度快</li>
<li>IMAGE模式：用于静态图片，检测精度高</li>
</ul>
<p><strong>比对模型选择：</strong></p>
<pre><code class="hljs language-ini" lang="ini">// 使用LIFE_PHOTO模型进行生活照比对，推荐阈值0.80
int <span class="hljs-attr">errorCode</span> = faceEngine.compareFaceFeature(
    faceFeature1, 
    faceFeature2, 
    CompareModel.LIFE_PHOTO, 
    faceSimilar
)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-19">2. 并发优化</h4>
<p><strong>引擎池配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">arcface:</span>
  <span class="hljs-attr">detect-pool-size:</span> <span class="hljs-number">5</span>      <span class="hljs-comment"># 检测引擎池大小</span>
  <span class="hljs-attr">compare-pool-size:</span> <span class="hljs-number">10</span>    <span class="hljs-comment"># 比对引擎池大小</span>
  <span class="hljs-attr">face-compare-threshold:</span> <span class="hljs-number">0.8</span>  <span class="hljs-comment"># 识别阈值</span>
  <span class="hljs-attr">pool:</span>
    <span class="hljs-attr">lifo:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">block-when-exhausted:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">max-wait-millis:</span> <span class="hljs-number">5000</span>
    <span class="hljs-attr">test-on-borrow:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">test-on-return:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">jmx-enabled:</span> <span class="hljs-literal">false</span>     <span class="hljs-comment"># 禁用JMX避免冲突</span>
</code></pre>
<p><strong>分批并发处理：</strong></p>
<ul>
<li>将大量用户分批处理，每批1000个</li>
<li>使用CompletionService管理并发任务</li>
<li>合理设置线程池大小</li>
</ul>
<h4 data-id="heading-20">3. 缓存优化</h4>
<p><strong>多级缓存策略：</strong></p>
<ol>
<li><strong>内存缓存</strong>：JVM堆内存，访问最快</li>
<li><strong>Redis缓存</strong>：分布式缓存，支持集群</li>
<li><strong>数据库</strong>：持久化存储，最终数据源</li>
</ol>
<p><strong>缓存更新策略：</strong></p>
<ul>
<li>新增用户：同时更新内存和Redis</li>
<li>删除用户：从所有缓存中移除</li>
<li>定期同步：防止缓存不一致</li>
</ul>
<h3 data-id="heading-21">系统监控与运维</h3>
<h4 data-id="heading-22">1. 性能监控</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FaceEngineServiceImpl</span> {
    
    <span class="hljs-comment">// 监控指标</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">totalFaceDetect</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">totalFaceRecognize</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">successFaceRecognize</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    
    <span class="hljs-comment">/**
     * 获取监控指标
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMetrics</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> String.format(
            <span class="hljs-string">"人脸引擎监控指标 - 总检测次数: %d, 总识别次数: %d, 成功识别次数: %d"</span>,
            totalFaceDetect.get(),
            totalFaceRecognize.get(),
            successFaceRecognize.get()
        );
    }
}
</code></pre>
<h4 data-id="heading-23">2. 资源管理</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@PreDestroy</span>
public void destroy() {
    log<span class="hljs-selector-class">.info</span>("开始销毁人脸引擎资源");
    
    <span class="hljs-comment">// 关闭比对线程池</span>
    if (faceCompareExecutorService != null) {
        faceCompareExecutorService<span class="hljs-selector-class">.shutdown</span>();
        try {
            if (!faceCompareExecutorService.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                faceCompareExecutorService<span class="hljs-selector-class">.shutdownNow</span>();
            }
        } catch (InterruptedException e) {
            faceCompareExecutorService<span class="hljs-selector-class">.shutdownNow</span>();
            Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.interrupt</span>();
        }
    }
    
    <span class="hljs-comment">// 关闭引擎池</span>
    if (faceEngineGeneralPool != null) {
        faceEngineGeneralPool<span class="hljs-selector-class">.close</span>();
    }
    if (faceEngineComparePool != null) {
        faceEngineComparePool<span class="hljs-selector-class">.close</span>();
    }
    
    log<span class="hljs-selector-class">.info</span>("人脸引擎资源销毁完成");
}
</code></pre>
<h3 data-id="heading-24">安全与隐私保护</h3>
<h4 data-id="heading-25">1. 数据安全</h4>
<p><strong>图片存储安全：</strong></p>
<ul>
<li>本地文件系统存储</li>
<li>文件名加密处理</li>
<li>访问权限控制</li>
</ul>
<p><strong>特征数据保护：</strong></p>
<ul>
<li>数据库字段加密</li>
<li>Redis传输加密</li>
<li>内存数据及时清理</li>
</ul>
<h4 data-id="heading-26">2. 接口安全</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/face"</span>)
public class FaceController {
    
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/saveFeature"</span>)
    <span class="hljs-variable">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('face:register')"</span>)  <span class="hljs-comment">// 权限控制</span>
    public R&lt;SaveFeatureResDTO&gt; <span class="hljs-built_in">saveFeature</span>(<span class="hljs-variable">@RequestBody</span> SaveFeatureReqDTO request) {
        <span class="hljs-comment">// 参数校验</span>
        <span class="hljs-selector-tag">if</span> (!<span class="hljs-built_in">validateRequest</span>(request)) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">R</span><span class="hljs-selector-class">.failed</span>(<span class="hljs-string">"请求参数不合法"</span>);
        }
        
        <span class="hljs-comment">// 限流控制</span>
        <span class="hljs-selector-tag">if</span> (!rateLimiter.<span class="hljs-built_in">tryAcquire</span>()) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">R</span><span class="hljs-selector-class">.failed</span>(<span class="hljs-string">"请求过于频繁，请稍后重试"</span>);
        }
        
        <span class="hljs-comment">// 业务处理</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">processRequest</span>(request);
    }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ad6378dadc9457bb1d3fa4064e5a59f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFycnnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112011&amp;x-signature=k9kSPPuwYUDQuMnBC9RVS27y5N0%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a89b7a77f86f4102bdd89fb2b669e7be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFycnnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112011&amp;x-signature=IBcSL0zdTpXlA5qhBC7Q94j1Chc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-27">总结与展望</h3>
<p>本文详细介绍了企业级人脸识别系统的完整实现方案，涵盖了从前端交互到后端算法的各个层面。系统具有以下特点：</p>
<p><strong>技术优势：</strong></p>
<ol>
<li><strong>高性能</strong>：引擎池 + 多线程并发处理</li>
<li><strong>高可用</strong>：多级缓存 + 集群部署</li>
<li><strong>易扩展</strong>：微服务架构 + 容器化部署</li>
<li><strong>用户友好</strong>：现代化前端界面 + 智能交互</li>
</ol>
<p><strong>应用场景：</strong></p>
<ul>
<li>智能门禁系统</li>
<li>考勤管理系统</li>
<li>安防监控系统</li>
<li>智能零售系统</li>
</ul>
<p><strong>未来发展方向：</strong></p>
<ol>
<li><strong>算法升级</strong>：集成更先进的深度学习模型</li>
<li><strong>边缘计算</strong>：支持边缘设备部署</li>
<li><strong>多模态识别</strong>：结合声纹、虹膜等生物特征</li>
<li><strong>隐私计算</strong>：联邦学习、同态加密等技术</li>
</ol>
<p>希望本文能为大家在人脸识别系统开发中提供有价值的参考。如果你有任何问题或建议，欢迎在评论区交流讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[再见，人类程序员！OpenAI 自曝：一行代码都不写了，100% 用 Codex]]></title>    <link>https://juejin.cn/post/7599847938538766345</link>    <guid>https://juejin.cn/post/7599847938538766345</guid>    <pubDate>2026-01-27T09:48:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599847938538766345" data-draft-id="7599798118461407241" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="再见，人类程序员！OpenAI 自曝：一行代码都不写了，100% 用 Codex"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-27T09:48:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            再见，人类程序员！OpenAI 自曝：一行代码都不写了，100% 用 Codex
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T09:48:55.000Z" title="Tue Jan 27 2026 09:48:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c943d436f7e433c92e970b07b560668~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=8Tr4hxip8vgM8mH%2BBWRjGRmqeSI%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-1"><strong>「【新智元导读】100% 是用 Codex 写的。还有内部爆料说，Codex 让他们仅用三天时间就搭出了服务器，三周就发布了 APP。人类程序员，真的要退出历史舞台了？」</strong></h5>
<p>硅谷的空气里再次充满了躁动，而这一次的震源中心，回到了 OpenAI。</p>
<p>OpenAI 的奇点时刻，也要来了？</p>
<p>就在刚刚，X 被一条爆料彻底刷屏——</p>
<p>Codex，已经正式接管了 OpenAI 研究员「Roon」100% 的代码编写工作！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8f7bf83caa54dddbeb58105fb024706~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=vDExh1XrOZd874id1rJVzcrKOio%3D" alt="" loading="lazy"/></p>
<p>Roon 发出了感慨万千的宣告：</p>
<p>编程一直很痛苦，然而却是必经之路。我很高兴，它终于结束了。</p>
<p>我惊讶于自己竟然这么快就摆脱了编程的阴影，而且一点都不怀念它。甚至我有点遗憾，从前的电脑为什么不是这样的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3c52e1aea8a4a60bb5561055567571b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=V%2FIFfZiRn0EaA34icvSrVBbV9so%3D" alt="" loading="lazy"/></p>
<p>早在去年 12 月，Claude Code 之父 Boris Cherny 就曾投下一枚震撼弹——</p>
<p>自己对 Claude Code 的贡献 100% 都是由 Claude Code 完成的。</p>
<p>这一「套娃式」的自我进化，直接引爆了硅谷的自动编码狂潮。</p>
<p>面对如此巨大的蛋糕，OpenAI 显然不会拱手相让。</p>
<p>如今，反击已经开始。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MTA0MTk1MA%3D%3D%26mid%3D2652667431%26idx%3D1%26sn%3D3108d75bce9201ea57eb0a0cb9e2bb86%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MTA0MTk1MA==&amp;mid=2652667431&amp;idx=1&amp;sn=3108d75bce9201ea57eb0a0cb9e2bb86&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">在刚刚过去的周末，Sam Altman 已经公开预告：接下来一个月会发布一堆关于 Codex 编码模型的新产品。</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b943eca24efb43718bea605ebc0661d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=OCScSKNd5YmV2LzURR2Di4S5NGA%3D" alt="" loading="lazy"/></p>
<p>社区的风向也开始发生微妙的转变。</p>
<p>一些资深开发者评论道：在 90% 的情况下，GPT-5.2-Codex 都能一次性完成我提出的请求。</p>
<p>Claude 虽然不错，但它偶尔会偷偷插入「坏代码」；相比之下，OpenAI 的新方案更像苹果——主打一个开箱即用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/545b6399370e410ea4bbab5fb812dc61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=oLfPiTxoVsi9P5gJRc%2F4F7UTvUQ%3D" alt="" loading="lazy"/></p>
<p>看来，Codex 和 Claude Code 的大战，已经一触即发！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cb11b540957424e9908dd84e2f9cf99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=JQ4utrziAP%2BFM8WR9U4Lssc1sUU%3D" alt="" loading="lazy"/></p>
<p><strong>「人类写代码的时代，彻底结束？」</strong></p>
<p>OpenAI 研究员 Roon 的这个爆料，也让网友们直言：AI 终于到达了这个奇点！</p>
<p>看来，人类直接手写代码的时代，真的结束了。</p>
<p>经过多年的模型迭代与数据积累，我们似乎真的站在了一个临界点上：</p>
<p>人类直接手写代码，正在变得不再有任何意义，甚至是一种效率的浪费。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1072a10b0d12426e86e570eee4d12262~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=Uqz%2Fuvv0xrDnlsU0Or7vmxaveeI%3D" alt="" loading="lazy"/></p>
<p>在 Roon 的评论区，人们开始集体对编程时代说再见。</p>
<p>是的，我热爱电脑，热爱软件开发，对我而言，编程只是实现目标的手段，仅此而已。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf813437a09b4cfc8760ac1c6f73ae19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=eVrYEVtdqtkat9ClmsiPMzqdJmQ%3D" alt="" loading="lazy"/></p>
<p>复杂的语法只是是我们为了让逻辑得以执行而必须付出的昂贵代价。</p>
<p>如今，这些中间商终于可以退场了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76f0ffd57a604fb486ebae037d380aa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=9I1IuezE5XKQWFVzHCFqij9olJw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3e5c688c2e34c1ab6f3802b6ee2efad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=PFg%2BRvtIVv8ZAp%2Bs9ngZAqZp040%3D" alt="" loading="lazy"/></p>
<p>激进的观点开始涌现。</p>
<p>甚至有人建议，既然不需要人类阅读代码了，我们就该让模型跳过人类可读的汇编语言，直接使用机器代码。</p>
<p>今天的编程就像曾经的打孔卡一样，应该永远消失了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8926da0055e649459bb67dc1a87c74c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=8bSJdWdk5%2BZkNS0Y9j4bKDCmccU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be4eea7d373d42678b3e46863ff05f27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=9m0Ra%2FdPrhKlmpBcB4GZTt%2Fa3eo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18a06333f0e74dd28e307c201fa6ac45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=ZPTihVz9NDsoplIvfxGqa4qvbqU%3D" alt="" loading="lazy"/></p>
<p>与此同时，另一个炸裂的消息从 OpenAI 内部流出——</p>
<p>一位研究员爆料，在 Codex 的辅助下，他们仅用了**「三天时间」**，就从零搭建了 OpenAI 的 MCP 服务器，并完成了规模验证。</p>
<p>不仅如此，他们还在 3 周内推出了 Sora 的安卓应用；此外，还有一大波由 Codex 构建、甚至由 Codex 自我审核的内部工具正在排队上线。</p>
<p>如果没有 Codex 的话，很难想象 OpenAI 能以如此惊人的速度发布产品。</p>
<p>有趣的是，这位大佬似乎还玩起了 Claude Code 之父的梗：</p>
<p>过去 30 天，我花了大量时间审核 Plan 和 PR，几乎没写一行代码！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8871ddb41d64294a62feceb905df845~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=TgWjVjnpkgXFt0RiQeDubVJx2uI%3D" alt="" loading="lazy"/></p>
<p>有人评价，这正是「起飞」第一阶段的样子。</p>
<p>而下一步，或许就是真正的端到端 AI 自主研究。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d4a7818766441af88db6dccc56d3cfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=r%2F0xsPXKZuYqL6RE2wPKeRgyjMU%3D" alt="" loading="lazy"/></p>
<p>还有人问，确定你们这不是营销？</p>
<p>这位研究者详细解释说，绝对不是。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f83ee5b6b81a43e9b1c4119e9f9b223c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=VqM7s%2B1%2FTT1jNjraXBwtK1TULo8%3D" alt="" loading="lazy"/></p>
<p>具体的使用过程是这样的：</p>
<p>首先，他会花很多时间来撰写规格说明，并在脑海中构想输出应该是什么样子。</p>
<p>然后，会启动一个「4×Codex」的云端并发任务。这样不仅可以一次性看到多种不同的变体，也能补上自己一开始遗漏的细节。</p>
<p>接下来，就是让 Codex 自己发挥。等它跑完，人类再介入进行测试和验证。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a46595b5b37540dd9679030398e3f48c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=%2FeXVMRpQCDXAb7v2sLQGxTxxhXE%3D" alt="" loading="lazy"/></p>
<p><strong>「Codex CLI 0.9 + 来了！」</strong></p>
<p>既然「人机协作」的范式已经改变，那么承载这种范式的工具自然也要升级。</p>
<p>面对 Anthropic 在的步步紧逼，OpenAI 显然有备而来。</p>
<p>就在今天，Codex CLI 连续推送了两次更新，版本号直接来到了 0.91.0。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e0f74cc0b604ea1b2c8d2c2dc0cf5a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=rva6IQ0xrOu0Z2wZFodavU2iU4k%3D" alt="" loading="lazy"/></p>
<p>其中，Codex 0.9.0 带来了最受大家期待的功能——Plan Mode（计划模式）！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/811c3503e6c443efa3fae90058693e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=zJnnEBYOP5cQjDOejfw%2FSwqjQHY%3D" alt="" loading="lazy"/></p>
<p>Code 模式是 Codex 的默认体验，它的工作方式和其他 AI 智能体一样。</p>
<p>这点咱们就不多费口舌了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57a96d5c86e140c8a1168dca23656936~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=ZBH1G2ZCTx3UOgQrDeWy20rUoGw%3D" alt="" loading="lazy"/></p>
<p>但 Plan 模式则完全不同，它将编程任务拆解为两个截然不同的阶段：</p>
<p>第一阶段：理解意图（明确目标、划定范围、识别约束条件、制定验收标准）</p>
<p>第二阶段：技术规格（生成决策完备的实施方案）</p>
<p>在这种模式下，输出的内容非常详尽，无需任何后续追问即可直接执行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d0e9d28f1484762be7524d52036b61c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=3CXFEpq5pswl%2FPEM%2FbsAAIw5U%2Fc%3D" alt="" loading="lazy"/></p>
<p>Plan 模式最聪明的地方在于：它坚持「证据优先探索」。</p>
<p>在开口问问题之前，Codex 会先在你的代码库中进行 2 次以上的针对性搜索，检查配置、Schema 结构、程序入口等。</p>
<p>此外，Plan 模式还可以调用全套工具：</p>
<p>它可以（并且将会）调用各种技能、子智能体和后台终端，从而构建高层级的实施计划。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/230a6206d4ce401490cd83455f835d2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=TecgCwgFLVCbW2t%2BcTRREo7bmjw%3D" alt="" loading="lazy"/></p>
<p>当 Codex 确实需要你输入时，它是结构化的，而且只有关键且聚焦的问题：</p>
<p>· 尽可能提供选项</p>
<p>· 总是包含一个推荐选项（对新手极其友好）</p>
<p>· 只问那些会实质性改变计划的问题</p>
<p>为了实现这一交互，它利用了新的 request_user_input 工具。</p>
<p>这个工具会暂停执行流程，抛出一道有针对性的多项选择题，并支持你在选择时补充反馈或上下文。</p>
<p>更贴心的是，一旦它在任何时候检测到歧义，尤其是当你在引导它时指令模糊，它会立即停下来确认，而不是盲目执行。</p>
<p>现在，开发流程变成了这样：</p>
<p>用户请求一个计划 -&gt; AI 研究代码库与规划 -&gt; 针对性询问用户 -&gt; AI 完善并完成计划 -&gt; 提示是否执行？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6f74146aff146cc8af2b0a0a741f6a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=K2wCBsiYVbMJqF2s9HtOG4tsxjI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96ec21f46ab24dc4a7bb0ad44d905c84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=vsoqVN17zhx2JNFqNTUL%2BtuFH%2FU%3D" alt="" loading="lazy"/></p>
<p><strong>「但是，代码谁来审？」</strong></p>
<p>看起来完美无缺，对吧？Codex 负责思考，Codex 负责执行，Codex 负责填满你的 GitHub。</p>
<p>但就在我们为这种极致的效率欢呼时，一个被忽视的深渊正在脚下裂开——</p>
<p>在这个新时代，最大的悬念不再是谁在写代码，而是谁来审核代码。</p>
<p>当 AI 火力全开，每天向仓库甩出 10 + 个 PR 时，人类开发者面临的实际上是一场针对注意力的 DDoS 攻击。</p>
<p>AI 生成代码是毫秒级的，而人类理解代码上下文是分钟级甚至小时级的。</p>
<p>这种「生产与审查的极度不对称」带来了两个可怕的后果：</p>
<ul>
<li>审查者被淹没，开始习惯性点「Approve」，Code Review 沦为形式。</li>
<li>那些看起来能跑、但缺乏系统性思考的代码块，正在像癌细胞一样在代码库中扩散。</li>
</ul>
<p><strong>「利益冲突显而易见，但我们需要看透这一层。」</strong></p>
<p>Claude Code 的创造者吹捧自己的工具天经地义——这是商业的本能。</p>
<p>但作为受众，我们不能把「Demo 里的完美世界」当成日常。</p>
<p>毕竟，Demo 不会展示调试三小时都找不到的竞态条件，也不会展示由于上下文丢失导致的逻辑断层。</p>
<p><strong>「除此之外，数据里还藏着一个迷人的悖论。」</strong></p>
<p>Ars Technica 曾报道称，开发者对 AI 工具的使用量在涨，信任度却在跌。</p>
<p>为什么？因为 <strong>「AI」</strong> <strong>「正在跨越「恐怖谷」」</strong>。</p>
<p>以前的 AI 代码烂得很明显，现在的 AI 代码烂得很隐蔽——它引用了不存在的库，或者在一个极其边缘的 Case 上埋了雷。</p>
<p>人们用得越多，踩的坑越多，信得自然越少。</p>
<p>正如 Jaana Dogan 所警示的，我们正在面临软件工程「琐碎化」的风险。</p>
<ul>
<li><strong>「100 个提交」</strong>，可能让 GitHub 的绿格子很好看。</li>
<li><strong>「1 个架构变更」</strong>，可能需要三天思考，零行代码产出。</li>
</ul>
<p>前者廉价如尘土，后者珍贵如黄金。</p>
<p>问题从来不是 AI 能不能写代码，而是它写的代码，<strong>「是不是我们系统真正需要的」</strong>，以及**「我们是否有能力维护它」**。</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a27ad796b6124539b27ed9a52ecce655~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=XPfPq3vxqDX0s3iDQds7jcupQ7k%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「这对我们意味着什么？」</strong></p>
<p>无论我们是否准备好，这个时代已经来了。对于不同的人群，这意味着完全不同的生存法则。</p>
<ul>
<li><strong>「致开发者」</strong></li>
</ul>
<p>AI 编码工具不是「即将来临」，它们已经破门而入。</p>
<p>问题在于，如何在不丢失自身核心价值的前提下整合它们。</p>
<p>技术大牛们依然在做那些艰难的思考工作，AI 只是接过了「打字员」的工作。</p>
<p>如果你只会「搬运代码」，那你确实该慌了。</p>
<ul>
<li><strong>「致非开发者」</strong></li>
</ul>
<p>「技术工作」与「非技术工作」的边界正在消融。</p>
<p>Claude Cowork 这类工具创造了新物种。曾经需要开发者才能搞定的任务，可能很快只需要你能清晰描述出你想要什么。</p>
<p>清晰描述需求的能力，将成为新的编程语言。</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2548330257ec4098930d83adcc10305c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770112134&amp;x-signature=WzZjZsaNMSbSblibjFEJl8fBiOg%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「最后的话」</strong></p>
<p>虽然 OpenAI 的研究员和 Claude Code 的创造者都在宣称 AI 包办了 100% 的代码，但请记住——</p>
<p>那是他们的实验室环境，不是你的生产环境。</p>
<p>唯一可以确定的是，我们正在经历从「写代码」到「指挥写代码」的不可逆的转变。</p>
<p>而且，正在加速。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Ftszzl%2Fstatus%2F2015253546372153347" target="_blank" title="https://x.com/tszzl/status/2015253546372153347" ref="nofollow noopener noreferrer">x.com/tszzl/statu…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fjpcaparas.medium.com%2Fthe-claude-code-creator-says-ai-writes-100-of-his-code-now-956b2a5905ba%3Fsk%3D4c840f27eb03694c8210086834a41691" target="_blank" title="https://jpcaparas.medium.com/the-claude-code-creator-says-ai-writes-100-of-his-code-now-956b2a5905ba?sk=4c840f27eb03694c8210086834a41691" ref="nofollow noopener noreferrer">jpcaparas.medium.com/the-claude-…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FLLMJunky%2Fstatus%2F2015487691891024052" target="_blank" title="https://x.com/LLMJunky/status/2015487691891024052" ref="nofollow noopener noreferrer">x.com/LLMJunky/st…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 0 到 1：前端 CI/CD 实战（第四篇：Nginx + GitLab CI 实现前端自动发布上线）]]></title>    <link>https://juejin.cn/post/7599630795805524014</link>    <guid>https://juejin.cn/post/7599630795805524014</guid>    <pubDate>2026-01-27T10:01:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599630795805524014" data-draft-id="7599581204860354586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 0 到 1：前端 CI/CD 实战（第四篇：Nginx + GitLab CI 实现前端自动发布上线）"/> <meta itemprop="keywords" content="自动化运维,前端,CI/CD"/> <meta itemprop="datePublished" content="2026-01-27T10:01:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="饼饼饼"/> <meta itemprop="url" content="https://juejin.cn/user/8451822992855"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 0 到 1：前端 CI/CD 实战（第四篇：Nginx + GitLab CI 实现前端自动发布上线）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/8451822992855/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    饼饼饼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T10:01:59.000Z" title="Tue Jan 27 2026 10:01:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0"><strong>前言</strong></h2>
<p>在前几篇中，我们已经完成了 GitLab、GitLab Runner 以及前端项目的自动构建流程。但在真实项目中，CI/CD 往往不仅仅是“跑通一次构建”这么简单，而是需要支持多环境、多项目、多分支部署。</p>
<p>本篇将结合我的真实项目结构，介绍如何通过 Nginx + GitLab CI，将前端项目分别部署到 dev、test、uat、prod 等环境中，实现一套可长期维护的自动发布方案。</p>
<h2 data-id="heading-1">目录规划</h2>
<p>以 dev 环境为例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /apps/deploy/dev

<span class="hljs-built_in">mkdir</span> -p frontend/project-1
<span class="hljs-built_in">mkdir</span> -p backend
</code></pre>
<p>结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">/apps/deploy/dev
├── frontend
│   └── project-1
└── backend
</code></pre>
<h2 data-id="heading-2"><strong>配置 Nginx 配置文件</strong></h2>
<p>所有环境的 Nginx 配置统一放在：</p>
<pre><code class="hljs language-bash" lang="bash">/apps/nginx-conf
</code></pre>
<h3 data-id="heading-3"><strong>1. 创建 dev 配置文件</strong></h3>
<p>进入目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /apps/nginx-conf
</code></pre>
<p>新建文件：</p>
<pre><code class="hljs language-bash" lang="bash">vim front-dev.conf
</code></pre>
<p>写入内容：</p>
<pre><code class="hljs language-bash" lang="bash">server {
    listen 80;
    server_name _;

    location = /project-1 {
        <span class="hljs-built_in">return</span> 301 /project-1/;
    }

    location /project-1 {
        <span class="hljs-built_in">alias</span> /usr/share/nginx/html/project-1/;
        try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /project-1/index.html;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico)$ {
        root /usr/share/nginx/html/project-1;
        expires max;
        log_not_found off;
    }
}

</code></pre>
<p>保存退出：</p>
<pre><code class="hljs language-bash" lang="bash">:wq
</code></pre>
<h3 data-id="heading-4"><strong>2. 创建 test 配置（同理）</strong></h3>
<pre><code class="hljs language-bash" lang="bash">vim front-test.conf
</code></pre>
<p>内容与 dev 基本一致,生产环境同理。</p>
<h2 data-id="heading-5"><strong>创建多环境 Nginx 容器</strong></h2>
<h3 data-id="heading-6">创建 dev 环境的 Nginx 服务。</h3>
<p>进入项目目录</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /apps/deploy/dev/frontend/project-1
</code></pre>
<p>创建 compose 文件：</p>
<pre><code class="hljs language-bash" lang="bash">vim docker-compose.yml
</code></pre>
<p>编写 docker-compose.yml</p>
<pre><code class="hljs language-bash" lang="bash">version: <span class="hljs-string">"3.9"</span>

services:
  front-dev-nginx:
    image: nginx:alpine
    container_name: front-dev-nginx
    ports:
      - <span class="hljs-string">"8000:80"</span>
    volumes:
      - /apps/deploy/dev/frontend:/usr/share/nginx/html:ro
      - /apps/nginx-conf/front-dev.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
</code></pre>
<h3 data-id="heading-7">创建 test 环境的 Nginx 服务。</h3>
<p>进入项目目录</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /apps/deploy/test/frontend/project-1
</code></pre>
<p>创建 compose 文件并写入</p>
<pre><code class="hljs language-bash" lang="bash">services:
  front-test-nginx:
    image: nginx:alpine
    container_name: front-test-nginx
    ports:
      - <span class="hljs-string">"8001:80"</span>
    volumes:
      - /apps/deploy/test/frontend:/usr/share/nginx/html:ro
      - /apps/nginx-conf/front-test.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
</code></pre>
<h3 data-id="heading-8">创建 prod 环境的 Nginx 服务。</h3>
<p>进入项目目录</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /apps/deploy/prod/frontend/project-1
</code></pre>
<p>创建 compose 文件并写入</p>
<pre><code class="hljs language-bash" lang="bash">services:
  front-prod-nginx:
    image: nginx:alpine
    container_name: front-prod-nginx
    ports:
      - <span class="hljs-string">"8002:80"</span>
    volumes:
      - /apps/deploy/prod/frontend:/usr/share/nginx/html:ro
      - /apps/nginx-conf/front-prod.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
</code></pre>
<h3 data-id="heading-9"><strong>3. 启动容器</strong></h3>
<p>切换到 dev 文件夹下：</p>
<p>执行：</p>
<pre><code class="hljs language-bash" lang="bash">docker compose up -d
</code></pre>
<p>查看状态：</p>
<pre><code class="hljs language-bash" lang="bash">docker ps
</code></pre>
<p>出现：<code>nginx-dev</code>说明启动成功。</p>
<p>其他环境同理。</p>
<h2 data-id="heading-10"><strong>配置 GitLab CI 自动部署</strong></h2>
<p>前面已经配置好构建流程，下面重点是部署阶段。</p>
<h2 data-id="heading-11">创建多环境主 CI 文件</h2>
<p>在 project-1 项目根目录创建:</p>
<pre><code class="hljs language-bash" lang="bash">vim .gitlab-ci.yml
</code></pre>
<p>写入</p>
<pre><code class="hljs language-ini" lang="ini">include:
  - local: '.gitlab-ci-dev.yml'
    rules:
      - if: '$<span class="hljs-attr">CI_COMMIT_REF_NAME</span> == <span class="hljs-string">"dev"</span><span class="hljs-string">'

  - local: '</span>.gitlab-ci-test.yml<span class="hljs-string">'
    rules:
      - if: '</span><span class="hljs-variable">$CI_COMMIT_REF_NAME</span> == <span class="hljs-string">"test"</span><span class="hljs-string">'

  - local: '</span>.gitlab-ci-main.yml<span class="hljs-string">'
    rules:
      - if: '</span><span class="hljs-variable">$CI_COMMIT_REF_NAME</span> == <span class="hljs-string">"main"</span><span class="hljs-string">'
</span></code></pre>
<h3 data-id="heading-12"><strong>dev 环境 CI 文件</strong></h3>
<p>在 project-1 项目根目录创建：</p>
<pre><code class="hljs language-bash" lang="bash">vim .gitlab-ci-dev.yml
</code></pre>
<p>写入：</p>
<pre><code class="hljs language-bash" lang="bash">stages:
  - build
  - deploy

variables:
  BUILD_DIR: dist
  DEPLOY_DIR: /apps/deploy/dev/frontend/project-1

build_project:
  stage: build
  tags: [<span class="hljs-string">"build"</span>]
  image: node:24-alpine
  
  script:
    - npm install -g pnpm@8.15.3
    - pnpm install
    - npm run build:dev
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour


deploy_project:
  stage: deploy
  tags: [<span class="hljs-string">"build"</span>]
  image: alpine:latest
  script:
    - <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$DEPLOY_DIR</span>
    - <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$DEPLOY_DIR</span>/*
    - <span class="hljs-built_in">cp</span> -r <span class="hljs-variable">$CI_PROJECT_DIR</span>/<span class="hljs-variable">$BUILD_DIR</span>/* <span class="hljs-variable">$DEPLOY_DIR</span>/
</code></pre>
<h3 data-id="heading-13"><strong>test 环境 CI 文件</strong></h3>
<p>同理创建：</p>
<pre><code class="hljs language-bash" lang="bash">vim .gitlab-ci-test.yml
</code></pre>
<p>写入:</p>
<pre><code class="hljs language-bash" lang="bash">stages:
  - build
  - deploy

variables:
  BUILD_DIR: dist
  DEPLOY_DIR: /apps/deploy/test/frontend/project-1

build_project:
  stage: build
  tags: [<span class="hljs-string">"build"</span>]
  image: node:24-alpine
  script:
    - npm install -g pnpm@8.15.3
    - pnpm install
    - npm run build:<span class="hljs-built_in">test</span>
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour


deploy_project:
  stage: deploy
  tags: [<span class="hljs-string">"build"</span>]
  image: alpine:latest
  script:
    - <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$DEPLOY_DIR</span>
    - <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$DEPLOY_DIR</span>/*
    - <span class="hljs-built_in">cp</span> -r <span class="hljs-variable">$CI_PROJECT_DIR</span>/<span class="hljs-variable">$BUILD_DIR</span>/* <span class="hljs-variable">$DEPLOY_DIR</span>/
</code></pre>
<h3 data-id="heading-14"><strong>prod 环境 CI 文件</strong></h3>
<p>同理创建：</p>
<pre><code class="hljs language-bash" lang="bash">vim .gitlab-ci-main.yml
</code></pre>
<p>写入：</p>
<pre><code class="hljs language-bash" lang="bash">stages:
  - build
  - deploy

variables:
  BUILD_DIR: dist
  DEPLOY_DIR: /apps/deploy/prod/frontend/project-1

build_project:
  stage: build
  tags: [<span class="hljs-string">"build"</span>]
  image: node:24-alpine
  script:
    - npm install -g pnpm@8.15.3
    - pnpm install
    - npm run build:prod
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour


deploy_project:
  stage: deploy
  tags: [<span class="hljs-string">"build"</span>]
  image: alpine:latest
  script:
    - <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$DEPLOY_DIR</span>
    - <span class="hljs-built_in">rm</span> -rf <span class="hljs-variable">$DEPLOY_DIR</span>/*
    - <span class="hljs-built_in">cp</span> -r <span class="hljs-variable">$CI_PROJECT_DIR</span>/<span class="hljs-variable">$BUILD_DIR</span>/* <span class="hljs-variable">$DEPLOY_DIR</span>/
</code></pre>
<h2 data-id="heading-15"><strong>测试完整发布流程</strong></h2>
<p>到这里，可以开始验证完整链路。</p>
<h3 data-id="heading-16"><strong>1. 推送代码</strong></h3>
<pre><code class="hljs language-bash" lang="bash">git push origin dev
</code></pre>
<h3 data-id="heading-17"><strong>2. 查看流水线</strong></h3>
<p>进入 GitLab：</p>
<pre><code class="hljs language-bash" lang="bash">CI/CD → Pipelines
</code></pre>
<p>确认：</p>
<ul>
<li>build 成功</li>
<li>deploy 成功</li>
</ul>
<h3 data-id="heading-18"><strong>3. 查看服务器目录</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> /apps/deploy/dev/frontend/project-1
</code></pre>
<p>应看到：</p>
<pre><code class="hljs language-text" lang="text">index.html
assets
</code></pre>
<h3 data-id="heading-19"><strong>4. 浏览器访问</strong></h3>
<p>打开：</p>
<pre><code class="hljs language-bash" lang="bash">http://服务器IP:8000/project-1/
</code></pre>
<p>页面正常显示即 dev 环境部署成功，其他环境同理。</p>
<h2 data-id="heading-20">本篇小结</h2>
<p>这一路走来，我们不仅跑通了流程，更点亮了一整套实战技能树：从 <strong>搭建云服务</strong> 到 <strong>GitLab</strong> 私有化部署，从 <strong>GitLab CI</strong> 自动化构建到 <strong>Docker + Nginx</strong> 的多环境容器化隔离。</p>
<p>现在，只需一次 <code>git push</code>，代码就能自动流过我们亲手搭建的流水线。这种告别 FTP 搬砖、告别手动改配置的“全链路自动化”，才是前端工程化的核心魅力。至此，发布闭环正式达成——从此发布不求人，环境不抓瞎。</p>
<p>感谢你陪我走完这个系列，希望这套方案能帮你彻底告别手动发布的琐碎，把时间留给更酷的代码，我们下个系列见🎉🎉🎉！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java注解到底存在多久？——源码、字节码与运行时]]></title>    <link>https://juejin.cn/post/7599572091076182058</link>    <guid>https://juejin.cn/post/7599572091076182058</guid>    <pubDate>2026-01-27T07:37:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599572091076182058" data-draft-id="7599591405313966121" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java注解到底存在多久？——源码、字节码与运行时"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T07:37:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Morpheus0412"/> <meta itemprop="url" content="https://juejin.cn/user/2541726611811454"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java注解到底存在多久？——源码、字节码与运行时
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2541726611811454/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Morpheus0412
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:37:31.000Z" title="Tue Jan 27 2026 07:37:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">注解（Annotation）本质</h2>
<p>注解就是给代码打的<strong>标签（元数据）</strong>，编译后确实会被打包进 <code>.class</code> 文件，所以它可以被编译器、工具或运行时库读取。</p>
<h2 data-id="heading-1">三类生命周期</h2>
<ol>
<li>
<p><strong>源码级（SOURCE）</strong><br/>
只在写代码时有效，编译完就消失，不会进 class 文件。</p>
<ul>
<li><code>@Override</code>：让编译器帮你检查是否真的覆写了父类方法，拼写错误直接报错。</li>
<li><code>@SuppressWarnings</code>：告诉编译器「我知道这里有警告，闭嘴就好」。</li>
</ul>
</li>
<li>
<p><strong>字节码级（CLASS）</strong><br/>
会写进 class 文件，但 JVM 加载类时会丢弃，适合给静态分析工具（如 ProGuard）看。</p>
</li>
<li>
<p><strong>运行时级（RUNTIME）</strong> ——<strong>最常用</strong><br/>
从类加载到程序结束一直留在 JVM 里，随时可以用反射读取。<br/>
例如 <code>@ResponseBody</code>：当 Spring 检测到方法上有这个注解，就自动把返回值转成 JSON/XML 塞进 HTTP 响应体里，不用你手动写 <code>response.getWriter().write()</code>。</p>
</li>
</ol>
<h2 data-id="heading-2">自定义注解</h2>
<p>用 <code>@interface</code> 关键字定义，本质是特殊的接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 只能贴在类、接口、枚举上</span>
<span class="hljs-meta">@Target(ElementType.TYPE)</span>  
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MyController {
    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;  <span class="hljs-comment">// 注解的参数，使用时写成 @MyController("/user")</span>
}

<span class="hljs-comment">// 允许贴在方法或字段上</span>
<span class="hljs-meta">@Target({ElementType.METHOD, ElementType.FIELD})</span>  
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MyLog {
    String <span class="hljs-title function_">desc</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"默认日志"</span>;  <span class="hljs-comment">// 可设默认值</span>
}
</code></pre>
<p><strong><code>@Target</code> 的作用</strong>：限制你自定义的注解能贴在哪儿，防止写错位置。如果不写 <code>@Target</code>，默认可以贴任何位置。</p>
<h2 data-id="heading-3">快速记忆</h2>
<ul>
<li>要 <strong>检查代码错误</strong> → <code>@Override</code>（源码级）</li>
<li>要 <strong>框架自动处理</strong>（如序列化、事务、权限）→ 自定义 RUNTIME 注解 + 反射</li>
<li>写注解时 <strong>不知道能贴哪</strong> → 加 <code>@Target</code> 约束一下</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python HTML解析库学习文档]]></title>    <link>https://juejin.cn/post/7599850148055236617</link>    <guid>https://juejin.cn/post/7599850148055236617</guid>    <pubDate>2026-01-27T07:45:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599850148055236617" data-draft-id="7599850148055203849" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python HTML解析库学习文档"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T07:45:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开飞机的舒克_"/> <meta itemprop="url" content="https://juejin.cn/user/4284144156154958"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python HTML解析库学习文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4284144156154958/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开飞机的舒克_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:45:00.000Z" title="Tue Jan 27 2026 07:45:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>开飞机的舒克
<a href="https://link.juejin.cn?target=halo.gaodaimou.cn" target="_blank" title="halo.gaodaimou.cn" ref="nofollow noopener noreferrer">halo.gaodaimou.cn</a></p>
</blockquote>
<h2 data-id="heading-0">Python HTML解析库学习文档</h2>
<h3 data-id="heading-1">1. 介绍</h3>
<p>HTML解析是Web开发和数据爬取中的重要技能。Python提供了多种HTML解析库，其中最常用的是<code>lxml</code>和<code>BeautifulSoup</code>。本文档将详细介绍这两个库的使用方法、核心知识点以及它们之间的对比。</p>
<h3 data-id="heading-2">2. lxml库</h3>
<h4 data-id="heading-3">2.1 简介</h4>
<p><code>lxml</code>是一个高性能的HTML和XML解析库，基于C语言开发，提供了Pythonic的API。它支持XPath选择器，解析速度快，是数据爬取和Web开发中的常用工具。</p>
<h4 data-id="heading-4">2.2 安装</h4>
<pre><code class="hljs">pip install lxml
</code></pre>
<h4 data-id="heading-5">2.3 基本使用</h4>
<pre><code class="hljs language-xml" lang="xml">from lxml import etree

# HTML字符串
html = '''
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>这是一个标题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"title"</span>&gt;</span>这是一个h1标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>这是一个h2标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"这是一个图片"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个段落111<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个段落222<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
'''

# 解析HTML字符串，返回Element对象
root = etree.HTML(html)
</code></pre>
<h4 data-id="heading-6">2.4 XPath选择器</h4>
<p>XPath是一种用于在XML和HTML文档中定位元素的语言，<code>lxml</code>库支持完整的XPath语法。</p>
<h5 data-id="heading-7">2.4.1 基本路径表示法</h5>





























<table><thead><tr><th>表达式</th><th>描述</th></tr></thead><tbody><tr><td><code>/</code></td><td>从根节点开始查找</td></tr><tr><td><code>//</code></td><td>从当前节点开始查找所有匹配的后代元素</td></tr><tr><td><code>.</code></td><td>当前节点</td></tr><tr><td><code>..</code></td><td>父节点</td></tr><tr><td><code>@</code></td><td>选择属性</td></tr></tbody></table>
<h5 data-id="heading-8">2.4.2 示例</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 查找所有p元素</span>
<span class="hljs-attr">ps</span> = root.xpath(<span class="hljs-string">'//p'</span>)
print(ps<span class="hljs-section">[0]</span>.text)  <span class="hljs-comment"># 输出：这是一个段落111</span>
print(ps<span class="hljs-section">[1]</span>.text)  <span class="hljs-comment"># 输出：这是一个段落222</span>

<span class="hljs-comment"># 直接获取文本内容</span>
<span class="hljs-attr">ps_text</span> = root.xpath(<span class="hljs-string">'//p/text()'</span>)
print(ps_text)  <span class="hljs-comment"># 输出：['这是一个段落111', '这是一个段落222']</span>

<span class="hljs-comment"># 查找特定属性的元素</span>
<span class="hljs-attr">img</span> = root.xpath(<span class="hljs-string">'//img'</span>)[<span class="hljs-number">0</span>]
print(img.get('src'))  <span class="hljs-comment"># 输出：https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png</span>

<span class="hljs-comment"># 使用属性值过滤</span>
<span class="hljs-attr">content_div</span> = root.xpath(<span class="hljs-string">'//div[@class="content"]'</span>)[<span class="hljs-number">0</span>]
print(content_div)  <span class="hljs-comment"># 输出：&lt;Element div at 0x...&gt;</span>

<span class="hljs-comment"># 从当前节点开始查找</span>
<span class="hljs-attr">content_ps</span> = content_div.xpath(<span class="hljs-string">'.//p'</span>)
print(len(content_ps))  <span class="hljs-comment"># 输出：2</span>

<span class="hljs-comment"># 查找父节点</span>
<span class="hljs-attr">parent_div</span> = root.xpath(<span class="hljs-string">'//p/../div'</span>)[<span class="hljs-number">0</span>]
print(parent_div.get('class'))  <span class="hljs-comment"># 输出：content</span>
</code></pre>
<h4 data-id="heading-9">2.5 性能建议</h4>
<ul>
<li>当你知道确切结构时，使用绝对路径（更快）：<code>/html/body/div[1]/p[1]</code></li>
<li>当结构不确定时，使用相对路径（更灵活）：<code>//div[@class='content']//p</code></li>
<li>可以混合使用：<code>/html/body//p</code>（从body开始，查找所有后代p）</li>
</ul>
<h4 data-id="heading-10">2.6 Element对象操作</h4>
<p>解析HTML后返回的是Element对象，你可以使用Element对象的方法和属性来操作HTML文档：</p>
<ul>
<li><code>text</code>：获取元素的文本内容</li>
<li><code>get()</code>：获取元素的属性值</li>
<li><code>find()</code>：查找第一个匹配的子元素</li>
<li><code>findall()</code>：查找所有匹配的子元素</li>
</ul>
<h3 data-id="heading-11">3. BeautifulSoup库</h3>
<h4 data-id="heading-12">3.1 简介</h4>
<p><code>BeautifulSoup</code>是一个Python库，用于从HTML和XML文件中提取数据。它提供了简单和Pythonic的方式来遍历、搜索和修改解析树。</p>
<h4 data-id="heading-13">3.2 安装</h4>
<pre><code class="hljs language-bash" lang="bash">pip install beautifulsoup4
pip install lxml  <span class="hljs-comment"># 可选，作为BeautifulSoup的解析器</span>
</code></pre>
<h4 data-id="heading-14">3.3 基本使用</h4>
<pre><code class="hljs language-xml" lang="xml">from bs4 import BeautifulSoup

# HTML字符串
html = '''
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>这是一个标题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"title"</span>&gt;</span>这是一个h1标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>这是一个h2标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"这是一个图片"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个段落<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
'''

# 初始化BeautifulSoup对象，使用html.parser解析器
soup = BeautifulSoup(html, 'html.parser')
</code></pre>
<h4 data-id="heading-15">3.4 查找元素的方法</h4>
<h5 data-id="heading-16">3.4.1 find() 和 find_all()</h5>
<p>这是BeautifulSoup中最常用的查找方法：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 查找第一个h1标签（按id）</span>
<span class="hljs-attr">h1_by_id</span> = soup.find(<span class="hljs-string">'h1'</span>, id=<span class="hljs-string">'title'</span>)
print(h1_by_id)  <span class="hljs-comment"># 输出：&lt;h1 id="title"&gt;这是一个h1标题&lt;/h1&gt;</span>

<span class="hljs-comment"># 查找第一个h1标签（按class）</span>
<span class="hljs-attr">h1_by_class</span> = soup.find(<span class="hljs-string">'h1'</span>, class_=<span class="hljs-string">'title'</span>)  <span class="hljs-comment"># 注意：class是Python关键字，所以使用class_</span>
print(h1_by_class.text)  <span class="hljs-comment"># 输出：这是一个h2标题</span>

<span class="hljs-comment"># 查找所有h1标签</span>
<span class="hljs-attr">h1_all</span> = soup.find_all(<span class="hljs-string">'h1'</span>)
print(len(h1_all))  <span class="hljs-comment"># 输出：2</span>

<span class="hljs-comment"># 遍历所有h1标签</span>
for h1 in h1_all:
    print(h1.text)

<span class="hljs-comment"># 查找特定属性的元素</span>
<span class="hljs-attr">img</span> = soup.find(<span class="hljs-string">'img'</span>, alt=<span class="hljs-string">'这是一个图片'</span>)
print(img.get('src'))  <span class="hljs-comment"># 输出：https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png</span>
</code></pre>
<h5 data-id="heading-17">3.4.2 find() 和 find_all() 的参数</h5>

































<table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td><code>name</code></td><td>标签名，可以是字符串或列表</td></tr><tr><td><code>attrs</code></td><td>属性字典，用于过滤元素</td></tr><tr><td><code>recursive</code></td><td>是否递归查找子元素，默认为True</td></tr><tr><td><code>text</code></td><td>查找包含指定文本的元素</td></tr><tr><td><code>limit</code></td><td>限制返回的元素数量，仅适用于find_all()</td></tr><tr><td><code>**kwargs</code></td><td>关键字参数，用于过滤元素属性</td></tr></tbody></table>
<h4 data-id="heading-18">3.5 CSS选择器</h4>
<p>BeautifulSoup也支持CSS选择器，使用<code>select_one()</code>和<code>select()</code>方法：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 标签选择器</span>
<span class="hljs-attr">h1</span> = soup.select_one(<span class="hljs-string">'h1'</span>)
print(h1.text)  <span class="hljs-comment"># 输出：这是一个h1标题</span>

<span class="hljs-comment"># ID选择器</span>
<span class="hljs-attr">title</span> = soup.select_one(<span class="hljs-string">'#title'</span>)
print(title.text)  <span class="hljs-comment"># 输出：这是一个h1标题</span>

<span class="hljs-comment"># 类选择器</span>
<span class="hljs-attr">content</span> = soup.select_one(<span class="hljs-string">'.content'</span>)

<span class="hljs-comment"># 属性选择器</span>
<span class="hljs-attr">link</span> = soup.select_one(<span class="hljs-string">'a[href="https://example.com"]'</span>)

<span class="hljs-comment"># 后代选择器</span>
<span class="hljs-comment"># 找到container类div下的所有p标签</span>
<span class="hljs-attr">content_in_container</span> = soup.select_one(<span class="hljs-string">'.container p'</span>)

<span class="hljs-comment"># 子元素选择器</span>
<span class="hljs-comment"># 找到container类div的直接子元素p</span>
<span class="hljs-attr">direct_child_p</span> = soup.select_one(<span class="hljs-string">'.container &gt; p'</span>)

<span class="hljs-comment"># 组合选择器</span>
<span class="hljs-attr">special_content</span> = soup.select_one(<span class="hljs-string">'p.content.special'</span>)
</code></pre>
<h4 data-id="heading-19">3.6 元素操作</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 获取元素的属性值</span>
<span class="hljs-attr">img</span> = soup.find(<span class="hljs-string">'img'</span>)
print(img.get('src'))  <span class="hljs-comment"># 可以获取标签的属性值</span>

<span class="hljs-comment"># 获取元素的文本内容</span>
<span class="hljs-comment"># get_text()方法可以传入参数控制，如strip=True去掉首尾空格，separator='|'用|隔开</span>
<span class="hljs-attr">h1</span> = soup.find(<span class="hljs-string">'h1'</span>)
print(h1.get_text(<span class="hljs-attr">strip</span>=<span class="hljs-literal">True</span>))  <span class="hljs-comment"># 输出：这是一个h1标题</span>

<span class="hljs-comment"># 直接使用text属性，效果类似</span>
print(h1.text)  <span class="hljs-comment"># 输出：这是一个h1标题</span>
</code></pre>
<h4 data-id="heading-20">3.7 性能建议</h4>
<ul>
<li>简单查找：<code>find()</code>/<code>find_all()</code> 通常比CSS选择器快</li>
<li>复杂查找：CSS选择器更直观易读</li>
</ul>
<h3 data-id="heading-21">4. 两个库的对比</h3>
<h4 data-id="heading-22">4.1 优缺点</h4>




















<table><thead><tr><th>库</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>lxml</td><td>解析速度快 支持XPath选择器 API简洁 内存占用小</td><td>安装相对复杂（依赖C库） 对HTML格式要求严格</td></tr><tr><td>BeautifulSoup</td><td>API友好，易于学习 对HTML格式要求宽松 支持多种解析器 文档丰富</td><td>解析速度较慢 内存占用较大 不支持XPath（需要额外安装lxml）</td></tr></tbody></table>
<h4 data-id="heading-23">4.2 适用场景</h4>

















<table><thead><tr><th>库</th><th>适用场景</th></tr></thead><tbody><tr><td>lxml</td><td>数据爬取（特别是大规模数据） 需要使用XPath选择器的场景 对性能要求高的应用</td></tr><tr><td>BeautifulSoup</td><td>简单的数据提取 学习和教学 对HTML格式不规范的网页 快速开发原型</td></tr></tbody></table>
<h4 data-id="heading-24">4.3 性能对比</h4>
<ul>
<li>解析速度：<code>lxml</code> &gt; <code>BeautifulSoup</code>（使用lxml解析器） &gt; <code>BeautifulSoup</code>（使用html.parser）</li>
<li>内存占用：<code>lxml</code> &lt; <code>BeautifulSoup</code></li>
</ul>
<h4 data-id="heading-25">4.4 选择建议</h4>
<ol>
<li>如果性能是首要考虑因素，选择<code>lxml</code></li>
<li>如果代码可读性和易用性更重要，选择<code>BeautifulSoup</code></li>
<li>如果需要处理不规范的HTML，选择<code>BeautifulSoup</code></li>
<li>如果需要使用XPath选择器，选择<code>lxml</code></li>
<li>可以结合使用：<code>BeautifulSoup(html, 'lxml')</code>，利用两者的优点</li>
</ol>
<h3 data-id="heading-26">5. 总结</h3>


















































<table><thead><tr><th>特性</th><th>lxml</th><th>BeautifulSoup</th></tr></thead><tbody><tr><td>解析速度</td><td>快</td><td>较慢</td></tr><tr><td>内存占用</td><td>小</td><td>大</td></tr><tr><td>API友好度</td><td>中等</td><td>高</td></tr><tr><td>XPath支持</td><td>是</td><td>否（需要额外安装）</td></tr><tr><td>CSS选择器支持</td><td>是</td><td>是</td></tr><tr><td>对HTML格式要求</td><td>严格</td><td>宽松</td></tr><tr><td>安装复杂度</td><td>较高</td><td>较低</td></tr><tr><td>文档质量</td><td>好</td><td>优秀</td></tr></tbody></table>
<h3 data-id="heading-27">6. 最佳实践</h3>
<ol>
<li>根据具体需求选择合适的库</li>
<li>对于大规模数据爬取，优先考虑<code>lxml</code></li>
<li>对于快速开发和原型设计，优先考虑<code>BeautifulSoup</code></li>
<li>可以结合使用两者：<code>BeautifulSoup(html, 'lxml')</code></li>
<li>学习XPath选择器，它是一种强大的定位元素的工具</li>
<li>注意HTML的格式规范，特别是在使用<code>lxml</code>时</li>
<li>定期更新库版本，以获得更好的性能和安全性</li>
</ol>
<h3 data-id="heading-28">7. 示例代码汇总</h3>
<h4 data-id="heading-29">7.1 lxml示例</h4>
<pre><code class="hljs language-ini" lang="ini">from lxml import etree

<span class="hljs-attr">html</span> = <span class="hljs-string">'''
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;这是一个标题&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1 id="title"&gt;这是一个h1标题&lt;/h1&gt;
        &lt;h1 class="title"&gt;这是一个h2标题&lt;/h1&gt;
        &lt;img src="https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png" alt="这是一个图片"&gt;
        &lt;div class="content"&gt;
            &lt;p&gt;这是一个段落111&lt;/p&gt;
            &lt;p&gt;这是一个段落222&lt;/p&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;
'''</span>

<span class="hljs-comment"># 解析HTML字符串</span>
<span class="hljs-attr">root</span> = etree.HTML(html)

<span class="hljs-comment"># 查找所有p元素并打印文本</span>
<span class="hljs-attr">ps</span> = root.xpath(<span class="hljs-string">'//p'</span>)
for p in ps:
    print(p.text)

<span class="hljs-comment"># 直接获取文本内容</span>
<span class="hljs-attr">ps_text</span> = root.xpath(<span class="hljs-string">'//p/text()'</span>)
print(ps_text)

<span class="hljs-comment"># 查找图片的src属性</span>
<span class="hljs-attr">img_src</span> = root.xpath(<span class="hljs-string">'//img/@src'</span>)[<span class="hljs-number">0</span>]
print(img_src)
</code></pre>
<h4 data-id="heading-30">7.2 BeautifulSoup示例</h4>
<pre><code class="hljs language-ini" lang="ini">from bs4 import BeautifulSoup

<span class="hljs-attr">html</span> = <span class="hljs-string">'''
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;这是一个标题&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1 id="title"&gt;这是一个h1标题&lt;/h1&gt;
        &lt;h1 class="title"&gt;这是一个h2标题&lt;/h1&gt;
        &lt;img src="https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png" alt="这是一个图片"&gt;
        &lt;p&gt;这是一个段落&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
'''</span>

<span class="hljs-comment"># 初始化BeautifulSoup对象</span>
<span class="hljs-attr">soup</span> = BeautifulSoup(html, <span class="hljs-string">'html.parser'</span>)

<span class="hljs-comment"># 查找所有h1标签并打印文本</span>
<span class="hljs-attr">h1_all</span> = soup.find_all(<span class="hljs-string">'h1'</span>)
for h1 in h1_all:
    print(h1.text)

<span class="hljs-comment"># 查找图片并获取src属性</span>
<span class="hljs-attr">img</span> = soup.find(<span class="hljs-string">'img'</span>)
print(img.get('src'))

<span class="hljs-comment"># 使用CSS选择器查找元素</span>
<span class="hljs-attr">title</span> = soup.select_one(<span class="hljs-string">'#title'</span>)
print(title.text)
</code></pre>
<h3 data-id="heading-31">8. 资源推荐</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flxml.de%2F" target="_blank" title="https://lxml.de/" ref="nofollow noopener noreferrer">lxml官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.crummy.com%2Fsoftware%2FBeautifulSoup%2Fbs4%2Fdoc%2F" target="_blank" title="https://www.crummy.com/software/BeautifulSoup/bs4/doc/" ref="nofollow noopener noreferrer">BeautifulSoup官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3schools.com%2Fxml%2Fxpath_intro.asp" target="_blank" title="https://www.w3schools.com/xml/xpath_intro.asp" ref="nofollow noopener noreferrer">XPath教程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3schools.com%2Fcssref%2Fcss_selectors.asp" target="_blank" title="https://www.w3schools.com/cssref/css_selectors.asp" ref="nofollow noopener noreferrer">CSS选择器参考</a></li>
</ul>
<p>通过学习本文档，你应该已经掌握了<code>lxml</code>和<code>BeautifulSoup</code>这两个HTML解析库的基本使用方法和核心知识点。在实际应用中，你可以根据具体需求选择合适的库，或者结合使用两者的优点，提高开发效率和代码质量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拿捏python基础]]></title>    <link>https://juejin.cn/post/7599630795804704814</link>    <guid>https://juejin.cn/post/7599630795804704814</guid>    <pubDate>2026-01-27T07:47:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599630795804704814" data-draft-id="7599614131424133129" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拿捏python基础"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T07:47:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开飞机的舒克_"/> <meta itemprop="url" content="https://juejin.cn/user/4284144156154958"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拿捏python基础
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4284144156154958/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开飞机的舒克_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:47:11.000Z" title="Tue Jan 27 2026 07:47:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>开飞机的舒克
<a href="https://link.juejin.cn?target=halo.gaodaimou.cn" target="_blank" title="halo.gaodaimou.cn" ref="nofollow noopener noreferrer">halo.gaodaimou.cn</a></p>
</blockquote>
<h2 data-id="heading-0">Python 学习指南</h2>
<h3 data-id="heading-1">1. Python 基础类型</h3>
<p>Python 支持多种数据类型，主要包括：</p>
<ul>
<li><strong>整数（int）</strong> ：如 <code>18</code>、<code>-5</code>、<code>0</code></li>
<li><strong>字符串（str）</strong> ：如 <code>"hello"</code>、<code>'world'</code></li>
<li><strong>浮点数（float）</strong> ：如 <code>3.14</code>、<code>-0.5</code></li>
<li><strong>布尔值（bool）</strong> ：<code>True</code> 或 <code>False</code></li>
<li><strong>空值（NoneType）</strong> ：<code>None</code></li>
<li><strong>列表（list）</strong> ：如 <code>[1, 2, 3]</code></li>
<li><strong>元组（tuple）</strong> ：如 <code>(1, 2, 3)</code></li>
<li><strong>字典（dict）</strong> ：如 <code>{"name": "张三"}</code></li>
</ul>
<h4 data-id="heading-2">代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 字符串</span>
msg = <span class="hljs-string">"hello world"</span>
<span class="hljs-built_in">print</span>(msg)  <span class="hljs-comment"># 输出: hello world</span>

<span class="hljs-comment"># 布尔值</span>
flag = <span class="hljs-literal">False</span>
<span class="hljs-keyword">if</span> flag:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"flag is True"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"flag is False"</span>)  <span class="hljs-comment"># 输出: flag is False</span>

<span class="hljs-comment"># 查看类型</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(flag))  <span class="hljs-comment"># 输出: &lt;class 'bool'&gt;</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(msg))   <span class="hljs-comment"># 输出: &lt;class 'str'&gt;</span>

<span class="hljs-comment"># 浮点数和整数</span>
PI = <span class="hljs-number">3.1415926</span>
age = <span class="hljs-number">18</span>
<span class="hljs-built_in">print</span>(PI, <span class="hljs-built_in">type</span>(PI))  <span class="hljs-comment"># 输出: 3.1415926 &lt;class 'float'&gt;</span>
<span class="hljs-built_in">print</span>(age, <span class="hljs-built_in">type</span>(age))  <span class="hljs-comment"># 输出: 18 &lt;class 'int'&gt;</span>

<span class="hljs-comment"># Python 严格区分大小写</span>
</code></pre>
<h3 data-id="heading-3">2. 字符串(str)</h3>
<h4 data-id="heading-4">2.1. 访问字符</h4>




















<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>通过索引访问第一个字符</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str[0])</code></td><td><code>H</code></td></tr><tr><td>通过负索引访问最后一个字符</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str[-1])</code></td><td><code>!</code></td></tr></tbody></table>
<h4 data-id="heading-5">2.2. 字符串切片</h4>



































<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>切片获取前5个字符</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str[0:5])</code></td><td><code>Hello</code></td></tr><tr><td>切片获取从第8个字符到结尾</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str[7:])</code></td><td><code>World!</code></td></tr><tr><td>切片获取从开头到第5个字符</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str[:5])</code></td><td><code>Hello</code></td></tr><tr><td>切片获取间隔为2的字符</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str[::2])</code></td><td><code>Hlo ol!</code></td></tr><tr><td>反转字符串</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str[::-1])</code></td><td><code>!dlroW ,olleH</code></td></tr></tbody></table>
<h4 data-id="heading-6">2.3. 字符串拼接</h4>




















<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>使用 + 运算符拼接字符串</td><td><code>str1 = "Hello"</code> <code>str2 = "World"</code> <code>print(str1 + ", " + str2 + "!")</code></td><td><code>Hello, World!</code></td></tr><tr><td>使用 * 运算符重复字符串</td><td><code>print("Ha" * 3)</code></td><td><code>HaHaHa</code></td></tr></tbody></table>
<h4 data-id="heading-7">2.4. 字符串长度</h4>















<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>获取字符串长度</td><td><code>my_str = "Hello, World!"</code> <code>print(len(my_str))</code></td><td><code>13</code></td></tr></tbody></table>
<h4 data-id="heading-8">2.5. 查找和替换</h4>

























<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>查找子字符串位置（find方法）</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.find("World"))</code></td><td><code>7</code></td></tr><tr><td>查找子字符串位置（index方法）</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.index("World"))</code></td><td><code>7</code></td></tr><tr><td>替换子字符串</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.replace("World", "Python"))</code></td><td><code>Hello, Python!</code></td></tr></tbody></table>
<h4 data-id="heading-9">2.6. 大小写转换</h4>



































<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>转换为大写</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.upper())</code></td><td><code>HELLO, WORLD!</code></td></tr><tr><td>转换为小写</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.lower())</code></td><td><code>hello, world!</code></td></tr><tr><td>转换为首字母大写</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.title())</code></td><td><code>Hello, World!</code></td></tr><tr><td>转换为第一个字符大写</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.capitalize())</code></td><td><code>Hello, world!</code></td></tr><tr><td>大小写互换</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.swapcase())</code></td><td><code>hELLO, wORLD!</code></td></tr></tbody></table>
<h4 data-id="heading-10">2.7. 去除空白字符</h4>

























<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>去除两端空白</td><td><code>my_str = " Hello, World! "</code> <code>print(my_str.strip())</code></td><td><code>Hello, World!</code></td></tr><tr><td>去除左端空白</td><td><code>my_str = " Hello, World! "</code> <code>print(my_str.lstrip())</code></td><td><code>Hello, World!</code></td></tr><tr><td>去除右端空白</td><td><code>my_str = " Hello, World! "</code> <code>print(my_str.rstrip())</code></td><td><code>Hello, World!</code></td></tr></tbody></table>
<h4 data-id="heading-11">2. 8. 分割和连接</h4>




















<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>分割字符串</td><td><code>my_str = "Hello, World, Python"</code> <code>print(my_str.split(", "))</code></td><td><code>['Hello', 'World', 'Python']</code></td></tr><tr><td>连接字符串列表</td><td><code>str_list = ['Hello', 'World', 'Python']</code> <code>print(", ".join(str_list))</code></td><td><code>Hello, World, Python</code></td></tr></tbody></table>
<h4 data-id="heading-12">2.9. 检查字符串内容</h4>













































<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>检查是否以指定字符串开头</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.startswith("Hello"))</code></td><td><code>True</code></td></tr><tr><td>检查是否以指定字符串结尾</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.endswith("World"))</code></td><td><code>False</code></td></tr><tr><td>检查是否全为字母</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.isalpha())</code></td><td><code>False</code></td></tr><tr><td>检查是否全为数字</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.isdigit())</code></td><td><code>False</code></td></tr><tr><td>检查是否全为字母或数字</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.isalnum())</code></td><td><code>False</code></td></tr><tr><td>检查是否全为小写</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.islower())</code></td><td><code>False</code></td></tr><tr><td>检查是否全为大写</td><td><code>my_str = "Hello, World!"</code> <code>print(my_str.isupper())</code></td><td><code>False</code></td></tr></tbody></table>
<h4 data-id="heading-13">2.10. 格式化字符串</h4>



































<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>f-string 格式化</td><td><code>name = "张三"</code> <code>age = 18</code> <code>print(f"我叫{name}，今年{age}岁")</code></td><td><code>我叫张三，今年18岁</code></td></tr><tr><td>format() 方法（位置参数）</td><td><code>name = "张三"</code> <code>age = 18</code> <code>print("我叫{}，今年{}岁".format(name, age))</code></td><td><code>我叫张三，今年18岁</code></td></tr><tr><td>format() 方法（索引参数）</td><td><code>name = "张三"</code> <code>age = 18</code> <code>print("我叫{0}，今年{1}岁".format(name, age))</code></td><td><code>我叫张三，今年18岁</code></td></tr><tr><td>format() 方法（关键字参数）</td><td><code>name = "张三"</code> <code>age = 18</code> <code>print("我叫{name}，今年{age}岁".format(name=name, age=age))</code></td><td><code>我叫张三，今年18岁</code></td></tr><tr><td>% 格式化</td><td><code>name = "张三"</code> <code>age = 18</code> <code>print("我叫%s，今年%d岁" % (name, age))</code></td><td><code>我叫张三，今年18岁</code></td></tr></tbody></table>
<h4 data-id="heading-14">2.11. 字符串不可变性</h4>















<table><thead><tr><th>操作描述</th><th>示例代码</th><th>输出结果</th></tr></thead><tbody><tr><td>字符串不可变性（创建新字符串）</td><td><code>my_str = "Hello"</code> <code>my_str = "h" + my_str[1:]</code> <code>print(my_str)</code></td><td><code>hello</code></td></tr></tbody></table>
<blockquote>
<p><strong>注意</strong>：字符串是不可变的，不能直接修改字符串中的字符，如 <code>my_str[0] = "h"</code> 会引发 TypeError。要修改字符串，需要创建新的字符串。</p>
</blockquote>
<h3 data-id="heading-15">3. 列表（List）</h3>
<p>列表是 Python 中最常用的数据结构之一，用于存储有序的元素集合。</p>
<h4 data-id="heading-16">列表操作方法</h4>











































































<table><thead><tr><th>操作</th><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>访问元素</td><td><code>list[index]</code></td><td>通过索引访问，从 0 开始</td></tr><tr><td>访问最后元素</td><td><code>list[-1]</code></td><td>负数索引从末尾开始</td></tr><tr><td>修改元素</td><td><code>list[index] = value</code></td><td>直接赋值修改</td></tr><tr><td>新增元素</td><td><code>list.append(value)</code></td><td>在末尾添加元素</td></tr><tr><td>插入元素</td><td><code>list.insert(index, value)</code></td><td>在指定位置插入</td></tr><tr><td>合并列表</td><td><code>list.extend(other_list)</code></td><td>将另一个列表的元素添加到末尾</td></tr><tr><td>删除元素</td><td><code>del list[index]</code></td><td>删除指定索引的元素</td></tr><tr><td>删除并返回</td><td><code>list.pop(index)</code></td><td>删除并返回指定索引的元素</td></tr><tr><td>删除值</td><td><code>list.remove(value)</code></td><td>删除第一个匹配的值</td></tr><tr><td>排序</td><td><code>sorted(list)</code></td><td>返回新的排序列表（原列表不变）</td></tr><tr><td>最大值</td><td><code>max(list)</code></td><td>返回列表中的最大值</td></tr><tr><td>最小值</td><td><code>min(list)</code></td><td>返回列表中的最小值</td></tr><tr><td>长度</td><td><code>len(list)</code></td><td>返回列表元素个数</td></tr></tbody></table>
<h4 data-id="heading-17">切片操作</h4>
<p>切片用于访问列表的一部分，语法：<code>list[start:end:step]</code></p>
<ul>
<li><strong>左闭右开区间</strong>：<code>[start:end]</code> 包含 start，不包含 end</li>
<li><strong>默认值</strong>：start 默认 0，end 默认列表长度，step 默认 1</li>
<li><strong>索引越界</strong>：切片不会引发 IndexError</li>
</ul>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">my_list</span> = [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>, <span class="hljs-number">50</span>]

<span class="hljs-comment"># 通过切片访问</span>
print(my_list<span class="hljs-section">[1:4]</span>)   <span class="hljs-comment"># 输出: [20, 30, 40]</span>
print(my_list<span class="hljs-section">[:3]</span>)    <span class="hljs-comment"># 输出: [10, 20, 30]（从开头到索引2）</span>
print(my_list<span class="hljs-section">[2:]</span>)    <span class="hljs-comment"># 输出: [30, 40, 50]（从索引2到末尾）</span>
print(my_list<span class="hljs-section">[::2]</span>)   <span class="hljs-comment"># 输出: [10, 30, 50]（步长为2）</span>

<span class="hljs-comment"># 通过切片删除</span>
my_list<span class="hljs-section">[1:3]</span> = <span class="hljs-section">[]</span>     <span class="hljs-comment"># 删除索引1-2的元素</span>
print(my_list)        <span class="hljs-comment"># 输出: [10, 40, 50]</span>

<span class="hljs-comment"># 经过删除后通过切片插入</span>
my_list<span class="hljs-section">[1:1]</span> = <span class="hljs-section">[25, 35]</span>  <span class="hljs-comment"># 在索引1处插入</span>
print(my_list)        <span class="hljs-comment"># 输出: [10, 25, 35, 40, 50]</span>
</code></pre>
<h4 data-id="heading-18">列表操作示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建列表</span>
my_list = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"香蕉"</span>]
<span class="hljs-built_in">print</span>(my_list)  <span class="hljs-comment"># 输出: [1, 2, 3, 4, 5, '香蕉']</span>

<span class="hljs-comment"># 修改元素</span>
my_list[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>
<span class="hljs-built_in">print</span>(my_list)  <span class="hljs-comment"># 输出: [100, 2, 3, 4, 5, '香蕉']</span>

<span class="hljs-comment"># 新增元素</span>
my_list.append(<span class="hljs-string">"orange"</span>)
<span class="hljs-built_in">print</span>(my_list)  <span class="hljs-comment"># 输出: [100, 2, 3, 4, 5, '香蕉', 'orange']</span>

<span class="hljs-comment"># 删除元素</span>
my_list.remove(<span class="hljs-number">2</span>)  <span class="hljs-comment"># 删除值为2的元素</span>
<span class="hljs-built_in">print</span>(my_list)  <span class="hljs-comment"># 输出: [100, 3, 4, 5, '香蕉', 'orange']</span>

<span class="hljs-comment"># 列表长度</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(my_list))  <span class="hljs-comment"># 输出: 6</span>
</code></pre>
<h3 data-id="heading-19">4. 元组（Tuple）</h3>
<p>元组是不可变的列表，使用圆括号 <code>()</code> 定义，一旦创建就不能修改。</p>
<h4 data-id="heading-20">元组特点</h4>
<ul>
<li>不可变性：创建后不能修改元素</li>
<li>可以存储不同类型的数据</li>
<li>可以通过索引访问元素</li>
<li>可以使用 <code>len()</code>、<code>max()</code>、<code>min()</code> 等函数</li>
</ul>
<h4 data-id="heading-21">代码示例</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建元组</span>
tuple1 = (1, 2, 3, 4, 5, <span class="hljs-string">"香蕉"</span>)
<span class="hljs-built_in">print</span>(tuple1)  <span class="hljs-comment"># 输出: (1, 2, 3, 4, 5, '香蕉')</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(tuple1))  <span class="hljs-comment"># 输出: &lt;class 'tuple'&gt;</span>

<span class="hljs-comment"># 访问元素</span>
<span class="hljs-built_in">print</span>(tuple1[0])  <span class="hljs-comment"># 输出: 1</span>
<span class="hljs-built_in">print</span>(tuple1[-1])  <span class="hljs-comment"># 输出: 香蕉</span>

<span class="hljs-comment"># 元组不可修改</span>
<span class="hljs-comment"># tuple1[0] = 100  # 这行代码会引发 TypeError</span>

<span class="hljs-comment"># 遍历元组</span>
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> tuple1:
    <span class="hljs-built_in">print</span>(item)
</code></pre>
<h3 data-id="heading-22">5. 字典（Dictionary）</h3>
<p>字典是键值对（key-value）的无序集合，使用大括号 <code>{}</code> 定义，键必须是唯一的。</p>
<h4 data-id="heading-23">字典操作方法</h4>























































<table><thead><tr><th>操作</th><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>访问值</td><td><code>dict[key]</code></td><td>通过键访问值，键不存在会引发 KeyError</td></tr><tr><td>安全访问</td><td><code>dict.get(key, default)</code></td><td>键不存在返回默认值</td></tr><tr><td>添加/修改</td><td><code>dict[key] = value</code></td><td>键不存在则添加，存在则修改</td></tr><tr><td>删除键</td><td><code>del dict[key]</code></td><td>删除指定键值对</td></tr><tr><td>查看键</td><td><code>dict.keys()</code></td><td>返回所有键的列表</td></tr><tr><td>查看值</td><td><code>dict.values()</code></td><td>返回所有值的列表</td></tr><tr><td>查看键值对</td><td><code>dict.items()</code></td><td>返回所有键值对的列表</td></tr><tr><td>检查键存在</td><td><code>key in dict</code></td><td>返回布尔值</td></tr><tr><td>长度</td><td><code>len(dict)</code></td><td>返回键值对数量</td></tr></tbody></table>
<h4 data-id="heading-24">代码示例</h4>
<pre><code class="hljs language-css" lang="css"># 创建字典
person = {"name": <span class="hljs-string">"张三"</span>, <span class="hljs-string">"age"</span>: <span class="hljs-number">18</span>, <span class="hljs-string">"gender"</span>: <span class="hljs-string">"男"</span>}
print(person)  # 输出: {'name': <span class="hljs-string">'张三'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">18</span>, <span class="hljs-string">'gender'</span>: <span class="hljs-string">'男'</span>}
print(type(person))  # 输出: &lt;class <span class="hljs-string">'dict'</span>&gt;

# 访问值
<span class="hljs-built_in">print</span>(person[<span class="hljs-string">"name"</span>])  # 输出: 张三
<span class="hljs-built_in">print</span>(person.<span class="hljs-built_in">get</span>(<span class="hljs-string">"age"</span>))  # 输出: <span class="hljs-number">18</span>
<span class="hljs-built_in">print</span>(person.<span class="hljs-built_in">get</span>(<span class="hljs-string">"address"</span>, <span class="hljs-string">"未知"</span>))  # 输出: 未知（键不存在）

# 修改值
person[<span class="hljs-string">"age"</span>] = <span class="hljs-number">19</span>
<span class="hljs-built_in">print</span>(person)  # 输出: {'name': <span class="hljs-string">'张三'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">19</span>, <span class="hljs-string">'gender'</span>: <span class="hljs-string">'男'</span>}

# 添加新键值对
person<span class="hljs-selector-attr">[<span class="hljs-string">"address"</span>]</span> = "北京"
print(person)  # 输出: {'name': <span class="hljs-string">'张三'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">19</span>, <span class="hljs-string">'gender'</span>: <span class="hljs-string">'男'</span>, <span class="hljs-string">'address'</span>: <span class="hljs-string">'北京'</span>}

# 删除键值对
<span class="hljs-selector-tag">del</span> person<span class="hljs-selector-attr">[<span class="hljs-string">"gender"</span>]</span>
print(person)  # 输出: {'name': <span class="hljs-string">'张三'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">19</span>, <span class="hljs-string">'address'</span>: <span class="hljs-string">'北京'</span>}

# 遍历字典
for key in person:
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"{key}: {person[key]}"</span>)

for key, value in person.<span class="hljs-built_in">items</span>():
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"{key}: {value}"</span>)

# 检查键是否存在
<span class="hljs-built_in">print</span>(<span class="hljs-string">"name"</span> in person)  # 输出: True
<span class="hljs-built_in">print</span>(<span class="hljs-string">"gender"</span> in person)  # 输出: False

# 字典长度
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(person))  # 输出: <span class="hljs-number">3</span>
</code></pre>
<h3 data-id="heading-25">6. 条件判断（if）</h3>
<p>条件判断用于根据不同条件执行不同的代码块。</p>
<h4 data-id="heading-26">语法结构</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">if</span> 条件1:
    <span class="hljs-comment"># 条件1为True时执行</span>
<span class="hljs-keyword">elif</span> 条件2:
    <span class="hljs-comment"># 条件1为False且条件2为True时执行</span>
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># 所有条件都为False时执行</span>
</code></pre>
<h4 data-id="heading-27">代码示例</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基本条件判断</span>
age = 7
<span class="hljs-keyword">if</span> age &gt;= 18:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"成年人"</span>)
<span class="hljs-keyword">elif</span> age &gt;= 6:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"小学生"</span>)  <span class="hljs-comment"># 输出: 小学生</span>
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"未成年人"</span>)

<span class="hljs-comment"># 多个条件</span>
score = 85
<span class="hljs-keyword">if</span> score &gt;= 90:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"优秀"</span>)
<span class="hljs-keyword">elif</span> score &gt;= 80:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"良好"</span>)  <span class="hljs-comment"># 输出: 良好</span>
<span class="hljs-keyword">elif</span> score &gt;= 60:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"及格"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"不及格"</span>)
</code></pre>
<h3 data-id="heading-28">7. 循环结构</h3>
<h4 data-id="heading-29">7.1 for 循环</h4>
<p>for 循环用于遍历可迭代对象（如列表、元组、字符串等）。</p>
<h5 data-id="heading-30">语法结构</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">for</span> 变量 <span class="hljs-keyword">in</span> 可迭代对象:
    <span class="hljs-comment"># 循环体</span>
</code></pre>
<h5 data-id="heading-31">代码示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 遍历列表</span>
fruits = [<span class="hljs-string">"苹果"</span>, <span class="hljs-string">"香蕉"</span>, <span class="hljs-string">"橙子"</span>]
<span class="hljs-keyword">for</span> fruit <span class="hljs-keyword">in</span> fruits:
    <span class="hljs-built_in">print</span>(fruit)

<span class="hljs-comment"># 使用 range() 函数</span>
<span class="hljs-comment"># range(10) 生成 0-9 的整数</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    <span class="hljs-built_in">print</span>(i)

<span class="hljs-comment"># range(start, end) 生成 start 到 end-1 的整数</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>):
    <span class="hljs-built_in">print</span>(i)  <span class="hljs-comment"># 输出: 5, 6, 7, 8, 9</span>

<span class="hljs-comment"># range(start, end, step) 生成指定步长的整数</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">2</span>):
    <span class="hljs-built_in">print</span>(i)  <span class="hljs-comment"># 输出: 0, 2, 4, 6, 8</span>

<span class="hljs-comment"># 累加计算</span>
sum_result = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    sum_result += i
    <span class="hljs-built_in">print</span>(sum_result)
</code></pre>
<h4 data-id="heading-32">7.2 while 循环</h4>
<p>while 循环用于在条件为 True 时重复执行代码块。</p>
<h5 data-id="heading-33">语法结构</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">while</span> 条件:
    <span class="hljs-comment"># 循环体</span>
</code></pre>
<h5 data-id="heading-34">代码示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 基本 while 循环</span>
count = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> count &lt; <span class="hljs-number">5</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"count: <span class="hljs-subst">{count}</span>"</span>)
    count += <span class="hljs-number">1</span>

<span class="hljs-comment"># 无限循环（谨慎使用）</span>
<span class="hljs-comment"># while True:</span>
<span class="hljs-comment">#     print("这是无限循环")</span>

<span class="hljs-comment"># 循环嵌套</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"i=<span class="hljs-subst">{i}</span>, j=<span class="hljs-subst">{j}</span>"</span>)
</code></pre>
<h3 data-id="heading-35">8. 函数定义与调用</h3>
<p>函数是可重用的代码块，使用 <code>def</code> 关键字定义。</p>
<h4 data-id="heading-36">函数语法</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">函数名</span>(<span class="hljs-params">参数<span class="hljs-number">1</span>, 参数<span class="hljs-number">2</span>=默认值</span>):
    <span class="hljs-comment"># 函数体</span>
    <span class="hljs-keyword">return</span> 返回值
</code></pre>
<h4 data-id="heading-37">函数特点</h4>
<ul>
<li>函数可以有多个参数，支持默认值</li>
<li>函数可以返回一个或多个值</li>
<li>函数内部变量的作用域是局部的</li>
<li>函数外部变量是全局的，可通过 <code>global</code> 关键字在函数内部修改</li>
</ul>
<h4 data-id="heading-38">代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 基本函数定义</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>(<span class="hljs-params">name=<span class="hljs-string">"张三"</span></span>):
    <span class="hljs-string">"""这是函数的文档字符串，用于说明函数功能"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>!"</span>

<span class="hljs-comment"># 调用函数</span>
<span class="hljs-built_in">print</span>(say_hello())  <span class="hljs-comment"># 输出: Hello, 张三!</span>
<span class="hljs-built_in">print</span>(say_hello(<span class="hljs-string">"李四"</span>))  <span class="hljs-comment"># 输出: Hello, 李四!</span>

<span class="hljs-comment"># 带多个参数的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a + b

result = add(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(result)  <span class="hljs-comment"># 输出: 8</span>

<span class="hljs-comment"># 函数内部的作用域</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_scope</span>():
    local_var = <span class="hljs-string">"局部变量"</span>
    <span class="hljs-built_in">print</span>(local_var)  <span class="hljs-comment"># 可以访问局部变量</span>

<span class="hljs-comment"># print(local_var)  # 这行代码会引发 NameError，因为局部变量在函数外部不可访问</span>

<span class="hljs-comment"># 使用全局变量</span>
global_var = <span class="hljs-string">"全局变量"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_global</span>():
    <span class="hljs-keyword">global</span> global_var  <span class="hljs-comment"># 声明使用全局变量</span>
    global_var = <span class="hljs-string">"修改后的全局变量"</span>
    <span class="hljs-built_in">print</span>(global_var)

test_global()  <span class="hljs-comment"># 输出: 修改后的全局变量</span>
<span class="hljs-built_in">print</span>(global_var)  <span class="hljs-comment"># 输出: 修改后的全局变量</span>

<span class="hljs-comment"># 函数返回多个值</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_info</span>():
    name = <span class="hljs-string">"张三"</span>
    age = <span class="hljs-number">18</span>
    <span class="hljs-keyword">return</span> name, age

user_name, user_age = get_user_info()
<span class="hljs-built_in">print</span>(user_name, user_age)  <span class="hljs-comment"># 输出: 张三 18</span>
</code></pre>
<h3 data-id="heading-39">9. 面向对象编程</h3>
<p>Python 是面向对象的编程语言，支持类和对象的概念。</p>
<h4 data-id="heading-40">类的基本概念</h4>
<ul>
<li><strong>类（Class）</strong> ：对象的蓝图，定义了对象的属性和方法</li>
<li><strong>对象（Object）</strong> ：类的实例</li>
<li><strong>属性（Attribute）</strong> ：对象的特征</li>
<li><strong>方法（Method）</strong> ：对象的行为</li>
<li><strong>self</strong>：代表类的实例，必须是方法的第一个参数</li>
</ul>
<h4 data-id="heading-41">类的语法</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">类名</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, 参数<span class="hljs-number">1</span>, 参数<span class="hljs-number">2</span></span>):
        <span class="hljs-comment"># 初始化方法，创建对象时自动调用</span>
        self.属性<span class="hljs-number">1</span> = 参数<span class="hljs-number">1</span>
        self.属性<span class="hljs-number">2</span> = 参数<span class="hljs-number">2</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">方法名</span>(<span class="hljs-params">self, 参数</span>):
        <span class="hljs-comment"># 方法体</span>
        <span class="hljs-keyword">return</span> 返回值
</code></pre>
<h4 data-id="heading-42">代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-string">"""人员类"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        <span class="hljs-string">"""初始化方法"""</span>
        self.name = name  <span class="hljs-comment"># 实例属性</span>
        self.age = age

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>(<span class="hljs-params">self, sex=<span class="hljs-string">"男"</span></span>):
        <span class="hljs-string">"""打招呼方法"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello, <span class="hljs-subst">{self.name}</span>！性别：<span class="hljs-subst">{sex}</span>"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">birthday</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""过生日方法，年龄加1"""</span>
        self.age += <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>今年<span class="hljs-subst">{self.age}</span>岁了！"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_age</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取年龄方法"""</span>
        <span class="hljs-keyword">return</span> self.age

<span class="hljs-comment"># 创建对象（实例化）</span>
person1 = Person(<span class="hljs-string">"张三"</span>, <span class="hljs-number">18</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(person1))  <span class="hljs-comment"># 输出: &lt;class '__main__.Person'&gt;</span>

<span class="hljs-comment"># 调用对象方法</span>
<span class="hljs-built_in">print</span>(person1.say_hello())  <span class="hljs-comment"># 输出: Hello, 张三！性别：男</span>
<span class="hljs-built_in">print</span>(person1.say_hello(<span class="hljs-string">"女"</span>))  <span class="hljs-comment"># 输出: Hello, 张三！性别：女</span>

<span class="hljs-comment"># 调用修改属性的方法</span>
<span class="hljs-built_in">print</span>(person1.birthday())  <span class="hljs-comment"># 输出: 张三今年19岁了！</span>
<span class="hljs-built_in">print</span>(person1.get_age())  <span class="hljs-comment"># 输出: 19</span>

<span class="hljs-comment"># 直接访问属性</span>
<span class="hljs-built_in">print</span>(person1.name)  <span class="hljs-comment"># 输出: 张三</span>
<span class="hljs-built_in">print</span>(person1.age)  <span class="hljs-comment"># 输出: 19</span>
</code></pre>
<h4 data-id="heading-43">9.1 类继承</h4>
<p>类继承允许创建一个新类（子类），继承现有类（父类）的属性和方法。子类可以扩展或修改父类的功能。</p>
<h5 data-id="heading-44">继承语法</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">子类名</span>(<span class="hljs-title class_ inherited__">父类名</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, 父类参数, 子类参数</span>):
        <span class="hljs-built_in">super</span>().__init__(父类参数)  <span class="hljs-comment"># 调用父类的初始化方法</span>
        self.子类属性 = 子类参数

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">子类方法</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 子类方法实现</span>
        <span class="hljs-keyword">return</span> 结果
</code></pre>
<h5 data-id="heading-45">继承特点</h5>
<ul>
<li>子类继承父类的所有属性和方法</li>
<li>子类可以重写父类的方法</li>
<li>子类可以添加新的属性和方法</li>
<li>使用 <code>super()</code> 调用父类的方法</li>
</ul>
<h5 data-id="heading-46">代码示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义父类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Mammal</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, sex</span>):
        self.name = name
        self.sex = sex
        self.num_eyes = <span class="hljs-number">2</span>  <span class="hljs-comment"># 所有哺乳动物都有2只眼睛</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">breathe</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>在呼吸"</span>)

<span class="hljs-comment"># 定义子类，继承自Mammal</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-title class_ inherited__">Mammal</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, sex, occupation</span>):
        <span class="hljs-comment"># 调用父类的初始化方法，继承父类的属性</span>
        <span class="hljs-built_in">super</span>().__init__(name, sex)
        <span class="hljs-comment"># 添加子类独有的属性</span>
        self.occupation = occupation

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">work</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 子类独有的方法</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>正在工作，职业是<span class="hljs-subst">{self.occupation}</span>"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">breathe</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 重写父类的方法</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>正在用鼻子呼吸"</span>)

<span class="hljs-comment"># 测试继承</span>
<span class="hljs-comment"># 如果子类没有自己的构造函数 __init__，会直接调用父类的构造函数</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-title class_ inherited__">Mammal</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">bark</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>在汪汪叫"</span>)

<span class="hljs-comment"># 创建子类实例</span>
person = Person(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"男"</span>, <span class="hljs-string">"程序员"</span>)
dog = Dog(<span class="hljs-string">"旺财"</span>, <span class="hljs-string">"公"</span>)

<span class="hljs-comment"># 调用继承的属性和方法</span>
<span class="hljs-built_in">print</span>(person.name)  <span class="hljs-comment"># 继承自父类的属性</span>
<span class="hljs-built_in">print</span>(person.num_eyes)  <span class="hljs-comment"># 继承自父类的属性</span>
person.breathe()  <span class="hljs-comment"># 调用重写后的方法</span>
person.work()  <span class="hljs-comment"># 调用子类独有的方法</span>

dog.breathe()  <span class="hljs-comment"># 调用父类的方法</span>
</code></pre>
<h3 data-id="heading-47">10. 数学计算（Math 模块）</h3>
<p>Python 的 <code>math</code> 模块提供了丰富的数学函数。</p>
<h4 data-id="heading-48">常用数学函数</h4>





















































































<table><thead><tr><th>函数</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>math.sqrt(x)</code></td><td>平方根</td><td><code>math.sqrt(16)</code> → 4.0</td></tr><tr><td><code>math.ceil(x)</code></td><td>向上取整</td><td><code>math.ceil(3.14)</code> → 4</td></tr><tr><td><code>math.floor(x)</code></td><td>向下取整</td><td><code>math.floor(3.14)</code> → 3</td></tr><tr><td><code>math.pow(x, y)</code></td><td>x 的 y 次方</td><td><code>math.pow(2, 3)</code> → 8.0</td></tr><tr><td><code>math.fabs(x)</code></td><td>绝对值</td><td><code>math.fabs(-10)</code> → 10.0</td></tr><tr><td><code>math.gcd(x, y)</code></td><td>最大公约数</td><td><code>math.gcd(12, 18)</code> → 6</td></tr><tr><td><code>math.lcm(x, y)</code></td><td>最小公倍数</td><td><code>math.lcm(12, 18)</code> → 36</td></tr><tr><td><code>math.sin(x)</code></td><td>正弦函数（弧度）</td><td><code>math.sin(math.pi/2)</code> → 1.0</td></tr><tr><td><code>math.cos(x)</code></td><td>余弦函数（弧度）</td><td><code>math.cos(math.pi)</code> → -1.0</td></tr><tr><td><code>math.tan(x)</code></td><td>正切函数（弧度）</td><td><code>math.tan(math.pi/4)</code> → 1.0</td></tr><tr><td><code>math.degrees(x)</code></td><td>弧度转角度</td><td><code>math.degrees(math.pi/2)</code> → 90.0</td></tr><tr><td><code>math.radians(x)</code></td><td>角度转弧度</td><td><code>math.radians(90)</code> → 1.570796...</td></tr><tr><td><code>math.log(x)</code></td><td>自然对数</td><td><code>math.log(math.e)</code> → 1.0</td></tr><tr><td><code>math.log10(x)</code></td><td>以10为底的对数</td><td><code>math.log10(100)</code> → 2.0</td></tr><tr><td><code>math.exp(x)</code></td><td>e 的 x 次方</td><td><code>math.exp(1)</code> → 2.71828...</td></tr></tbody></table>
<h4 data-id="heading-49">常量</h4>
<ul>
<li><code>math.pi</code>：圆周率 π（约3.14159...）</li>
<li><code>math.e</code>：自然常数 e（约2.71828...）</li>
</ul>
<h4 data-id="heading-50">代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> math

<span class="hljs-comment"># 平方根</span>
<span class="hljs-built_in">print</span>(math.sqrt(<span class="hljs-number">16</span>))  <span class="hljs-comment"># 输出: 4.0</span>

<span class="hljs-comment"># 取整</span>
<span class="hljs-built_in">print</span>(math.ceil(<span class="hljs-number">3.14</span>))  <span class="hljs-comment"># 输出: 4</span>
<span class="hljs-built_in">print</span>(math.floor(<span class="hljs-number">3.14</span>))  <span class="hljs-comment"># 输出: 3</span>

<span class="hljs-comment"># 幂运算</span>
<span class="hljs-built_in">print</span>(math.<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>))  <span class="hljs-comment"># 输出: 8.0</span>
<span class="hljs-built_in">print</span>(<span class="hljs-number">2</span> ** <span class="hljs-number">3</span>)  <span class="hljs-comment"># 输出: 8（Python 内置幂运算）</span>

<span class="hljs-comment"># 绝对值</span>
<span class="hljs-built_in">print</span>(math.fabs(-<span class="hljs-number">10</span>))  <span class="hljs-comment"># 输出: 10.0</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">abs</span>(-<span class="hljs-number">10</span>))  <span class="hljs-comment"># 输出: 10（Python 内置绝对值）</span>

<span class="hljs-comment"># 最大公约数和最小公倍数</span>
<span class="hljs-built_in">print</span>(math.gcd(<span class="hljs-number">12</span>, <span class="hljs-number">18</span>))  <span class="hljs-comment"># 输出: 6</span>
<span class="hljs-built_in">print</span>(math.lcm(<span class="hljs-number">12</span>, <span class="hljs-number">18</span>))  <span class="hljs-comment"># 输出: 36</span>

<span class="hljs-comment"># 三角函数（使用弧度）</span>
<span class="hljs-built_in">print</span>(math.sin(math.pi / <span class="hljs-number">2</span>))  <span class="hljs-comment"># 输出: 1.0</span>
<span class="hljs-built_in">print</span>(math.cos(math.pi))  <span class="hljs-comment"># 输出: -1.0</span>

<span class="hljs-comment"># 角度转换</span>
<span class="hljs-built_in">print</span>(math.degrees(math.pi / <span class="hljs-number">2</span>))  <span class="hljs-comment"># 输出: 90.0</span>
<span class="hljs-built_in">print</span>(math.radians(<span class="hljs-number">90</span>))  <span class="hljs-comment"># 输出: 1.5707963267948966</span>

<span class="hljs-comment"># 对数</span>
<span class="hljs-built_in">print</span>(math.log(math.e))  <span class="hljs-comment"># 输出: 1.0</span>
<span class="hljs-built_in">print</span>(math.log10(<span class="hljs-number">100</span>))  <span class="hljs-comment"># 输出: 2.0</span>

<span class="hljs-comment"># 常量</span>
<span class="hljs-built_in">print</span>(math.pi)  <span class="hljs-comment"># 输出: 3.141592653589793</span>
<span class="hljs-built_in">print</span>(math.e)  <span class="hljs-comment"># 输出: 2.718281828459045</span>
</code></pre>
<h3 data-id="heading-51">11. 输入输出（Input/Output）</h3>
<h4 data-id="heading-52">输入函数（input）</h4>
<p><code>input()</code> 函数用于从控制台获取用户输入，返回值是字符串类型。</p>
<h4 data-id="heading-53">输出函数（print）</h4>
<p><code>print()</code> 函数用于将内容输出到控制台，支持多个参数和格式化输出。</p>
<h4 data-id="heading-54">类型转换</h4>






























<table><thead><tr><th>函数</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>int(x)</code></td><td>转换为整数</td><td><code>int("123")</code> → 123</td></tr><tr><td><code>float(x)</code></td><td>转换为浮点数</td><td><code>float("3.14")</code> → 3.14</td></tr><tr><td><code>str(x)</code></td><td>转换为字符串</td><td><code>str(123)</code> → "123"</td></tr><tr><td><code>list(x)</code></td><td>转换为列表</td><td><code>list("abc")</code> → ["a", "b", "c"]</td></tr></tbody></table>
<h4 data-id="heading-55">代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 基本输入输出</span>
name = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入您的姓名："</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"您的姓名是：<span class="hljs-subst">{name}</span>"</span>)

<span class="hljs-comment"># 输入数字并转换类型</span>
age_str = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入您的年龄："</span>)
age = <span class="hljs-built_in">int</span>(age_str)  <span class="hljs-comment"># 转换为整数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"您明年将满 <span class="hljs-subst">{age + <span class="hljs-number">1</span>}</span> 岁"</span>)

<span class="hljs-comment"># 多个输入</span>
height = <span class="hljs-built_in">float</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入您的身高（米）："</span>))
weight = <span class="hljs-built_in">float</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入您的体重（千克）："</span>))

<span class="hljs-comment"># BMI 计算</span>
bmi = weight / (height ** <span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"您的 BMI 指数是：<span class="hljs-subst">{bmi:<span class="hljs-number">.2</span>f}</span>"</span>)

<span class="hljs-comment"># 类型转换示例</span>
num1 = <span class="hljs-number">123</span>
num2 = <span class="hljs-string">"456"</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(num1) + num2)  <span class="hljs-comment"># 输出: 123456（字符串拼接）</span>
<span class="hljs-built_in">print</span>(num1 + <span class="hljs-built_in">int</span>(num2))  <span class="hljs-comment"># 输出: 579（整数相加）</span>
</code></pre>
<h3 data-id="heading-56">12. 字符串格式化</h3>
<p>Python 提供了多种字符串格式化方式，常用的有：</p>
<h4 data-id="heading-57">1. f-strings（Python 3.6+）</h4>
<p>使用 <code>f"{变量}"</code> 语法，简洁高效。</p>
<h4 data-id="heading-58">2. format() 方法</h4>
<p>使用 <code>"{}".format()</code> 语法，兼容性好。</p>
<h4 data-id="heading-59">3. 百分号（%）格式化</h4>
<p>传统的格式化方式，类似 C 语言的 printf。</p>
<h4 data-id="heading-60">代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># f-strings 格式化</span>
name = <span class="hljs-string">"张三"</span>
age = <span class="hljs-number">18</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"我叫<span class="hljs-subst">{name}</span>，今年<span class="hljs-subst">{age}</span>岁"</span>)  <span class="hljs-comment"># 输出: 我叫张三，今年18岁</span>

<span class="hljs-comment"># 格式化数字</span>
pi = <span class="hljs-number">3.1415926</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"π的值是：<span class="hljs-subst">{pi:<span class="hljs-number">.2</span>f}</span>"</span>)  <span class="hljs-comment"># 输出: π的值是：3.14</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"π的值是：<span class="hljs-subst">{pi:<span class="hljs-number">10.3</span>f}</span>"</span>)  <span class="hljs-comment"># 输出: π的值是：     3.142（总宽度10，右对齐）</span>

<span class="hljs-comment"># format() 方法</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"我叫{}，今年{}岁"</span>.<span class="hljs-built_in">format</span>(name, age))  <span class="hljs-comment"># 输出: 我叫张三，今年18岁</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"我叫{0}，今年{1}岁，{0}很优秀"</span>.<span class="hljs-built_in">format</span>(name, age))  <span class="hljs-comment"># 输出: 我叫张三，今年18岁，张三很优秀</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"我叫{name}，今年{age}岁"</span>.<span class="hljs-built_in">format</span>(name=<span class="hljs-string">"李四"</span>, age=<span class="hljs-number">20</span>))  <span class="hljs-comment"># 输出: 我叫李四，今年20岁</span>

<span class="hljs-comment"># 百分号格式化</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"我叫%s，今年%d岁"</span> % (name, age))  <span class="hljs-comment"># 输出: 我叫张三，今年18岁</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"π的值是：%.2f"</span> % pi)  <span class="hljs-comment"># 输出: π的值是：3.14</span>

<span class="hljs-comment"># 多行字符串（保留格式）</span>
multi_line = <span class="hljs-string">"""这是第一行
这是第二行
这是第三行"""</span>
<span class="hljs-built_in">print</span>(multi_line)
</code></pre>
<h4 data-id="heading-61">数字格式化说明符</h4>























































<table><thead><tr><th>说明符</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td><code>:f</code></td><td>浮点数，默认6位小数</td><td><code>{3.14:f}</code> → 3.140000</td></tr><tr><td><code>:.1f</code></td><td>保留1位小数</td><td><code>{3.14:.1f}</code> → 3.1</td></tr><tr><td><code>:.2f</code></td><td>保留2位小数</td><td><code>{3.14:.2f}</code> → 3.14</td></tr><tr><td><code>:10.2f</code></td><td>总宽度10，保留2位小数</td><td><code>{3.14:10.2f}</code> → " 3.14"</td></tr><tr><td><code>:d</code></td><td>整数</td><td><code>{123:d}</code> → 123</td></tr><tr><td><code>:s</code></td><td>字符串</td><td><code>{"abc":s}</code> → abc</td></tr><tr><td><code>:0&gt;5d</code></td><td>宽度5，不足补0，右对齐</td><td><code>{12:0&gt;5d}</code> → 00012</td></tr><tr><td><code>:0&lt;5d</code></td><td>宽度5，不足补0，左对齐</td><td><code>{12:0&lt;5d}</code> → 12000</td></tr><tr><td><code>:^5d</code></td><td>宽度5，居中对齐</td><td><code>{12:^5d}</code> → " 12 "</td></tr></tbody></table>
<h3 data-id="heading-62">13. range() 函数</h3>
<p><code>range()</code> 函数用于生成整数序列，常用于 for 循环中。</p>
<h4 data-id="heading-63">语法</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">range</span>(stop)  # 生成 <span class="hljs-number">0</span> 到 stop<span class="hljs-number">-1</span> 的整数
<span class="hljs-built_in">range</span>(start, stop)  # 生成 start 到 stop<span class="hljs-number">-1</span> 的整数
<span class="hljs-built_in">range</span>(start, stop, step)  # 生成指定步长的整数序列
</code></pre>
<h4 data-id="heading-64">代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 生成 0-4 的整数</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    <span class="hljs-built_in">print</span>(i)  <span class="hljs-comment"># 输出: 0, 1, 2, 3, 4</span>

<span class="hljs-comment"># 生成 5-9 的整数</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>):
    <span class="hljs-built_in">print</span>(i)  <span class="hljs-comment"># 输出: 5, 6, 7, 8, 9</span>

<span class="hljs-comment"># 生成 5-19 的奇数</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, <span class="hljs-number">20</span>, <span class="hljs-number">2</span>):
    <span class="hljs-built_in">print</span>(i)  <span class="hljs-comment"># 输出: 5, 7, 9, 11, 13, 15, 17, 19</span>

<span class="hljs-comment"># 生成倒序序列</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(i)  <span class="hljs-comment"># 输出: 10, 9, 8, 7, 6, 5, 4, 3, 2, 1</span>

<span class="hljs-comment"># 将 range 转换为列表</span>
numbers = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
<span class="hljs-built_in">print</span>(numbers)  <span class="hljs-comment"># 输出: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
</code></pre>
<h3 data-id="heading-65">14. 文件操作</h3>
<h4 data-id="heading-66">14.1 文件路径</h4>
<p>文件路径用于定位文件在计算机中的位置，主要有两种类型：</p>
<h5 data-id="heading-67">相对路径</h5>
<p>相对于当前工作目录的路径，不需要完整路径信息。</p>

























<table><thead><tr><th>符号</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>.</code></td><td>当前目录</td><td><code>./file.txt</code></td></tr><tr><td><code>..</code></td><td>上级目录</td><td><code>../file.txt</code></td></tr><tr><td><code>/</code></td><td>目录分隔符</td><td><code>./subdir/file.txt</code></td></tr></tbody></table>
<h5 data-id="heading-68">绝对路径</h5>
<p>从根目录开始的完整路径，包含所有目录层级。</p>

















<table><thead><tr><th>系统</th><th>示例</th></tr></thead><tbody><tr><td>Windows</td><td><code>C:\Users\username\Desktop\file.txt</code></td></tr><tr><td>Linux/macOS</td><td><code>/home/username/Desktop/file.txt</code></td></tr></tbody></table>
<h4 data-id="heading-69">14.2 读取文件</h4>
<p>使用 <code>open()</code> 函数打开文件，返回一个文件对象。</p>
<h5 data-id="heading-70">open() 函数语法</h5>
<pre><code class="hljs language-ini" lang="ini">open(file_path, <span class="hljs-attr">mode</span>=<span class="hljs-string">'r'</span>, encoding=None)
</code></pre>





















<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>file_path</code></td><td>文件路径（相对或绝对）</td></tr><tr><td><code>mode</code></td><td>文件打开模式（默认为只读 <code>'r'</code>）</td></tr><tr><td><code>encoding</code></td><td>文件编码（如 <code>'utf-8'</code>）</td></tr></tbody></table>
<h5 data-id="heading-71">文件打开模式</h5>





































<table><thead><tr><th>模式</th><th>描述</th></tr></thead><tbody><tr><td><code>r</code></td><td>只读模式（默认）</td></tr><tr><td><code>w</code></td><td>只写模式，覆盖原有内容，文件不存在则创建</td></tr><tr><td><code>a</code></td><td>追加模式，在文件末尾添加内容</td></tr><tr><td><code>r+</code></td><td>读写模式，从文件开头开始</td></tr><tr><td><code>w+</code></td><td>读写模式，覆盖原有内容</td></tr><tr><td><code>a+</code></td><td>读写模式，在文件末尾追加</td></tr><tr><td><code>b</code></td><td>二进制模式（如 <code>'rb'</code>、<code>'wb'</code>）</td></tr></tbody></table>
<h5 data-id="heading-72">文件读取方法</h5>

























<table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td><code>read()</code></td><td>读取整个文件内容，返回字符串</td></tr><tr><td><code>read(size)</code></td><td>读取指定字节数，返回字符串</td></tr><tr><td><code>readline()</code></td><td>读取一行内容，返回字符串</td></tr><tr><td><code>readlines()</code></td><td>读取所有行，返回列表</td></tr></tbody></table>
<h5 data-id="heading-73">代码示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 基本读取</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'./test.txt'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
    content = f.read()
    <span class="hljs-built_in">print</span>(content)

<span class="hljs-comment"># 2. 逐行读取（适合大文件）</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'./test.txt'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
    line = f.readline()
    <span class="hljs-keyword">while</span> line:
        <span class="hljs-built_in">print</span>(line.strip())
        line = f.readline()

<span class="hljs-comment"># 3. 读取所有行到列表</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'./test.txt'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
    lines = f.readlines()
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:
        <span class="hljs-built_in">print</span>(line.strip())

<span class="hljs-comment"># 4. 读取指定字节数</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'./test.txt'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
    <span class="hljs-built_in">print</span>(f.read(<span class="hljs-number">10</span>))  <span class="hljs-comment"># 读取前10个字符</span>
    <span class="hljs-built_in">print</span>(f.read(<span class="hljs-number">10</span>))  <span class="hljs-comment"># 继续读取接下来的10个字符</span>
</code></pre>
<h4 data-id="heading-74">14.3 文件写入</h4>
<h5 data-id="heading-75">基本写入</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 覆盖写入</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'./test.txt'</span>, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
    f.write(<span class="hljs-string">'Hello, World!\n'</span>)
    f.write(<span class="hljs-string">'这是第二行\n'</span>)

<span class="hljs-comment"># 追加写入</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'./test.txt'</span>, <span class="hljs-string">'a'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
    f.write(<span class="hljs-string">'这是追加的一行\n'</span>)

<span class="hljs-comment"># 写入多行</span>
lines = [<span class="hljs-string">'第一行'</span>, <span class="hljs-string">'第二行'</span>, <span class="hljs-string">'第三行'</span>]
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'./test.txt'</span>, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
    f.writelines([line + <span class="hljs-string">'\n'</span> <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines])
</code></pre>
<h4 data-id="heading-76">14.4 文件关闭</h4>
<p>文件使用完毕后必须关闭，否则会占用系统资源。</p>
<h5 data-id="heading-77">两种关闭方式</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 显式关闭</span>
f = <span class="hljs-built_in">open</span>(<span class="hljs-string">'./test.txt'</span>, <span class="hljs-string">'r'</span>)
<span class="hljs-keyword">try</span>:
    content = f.read()
    <span class="hljs-built_in">print</span>(content)
<span class="hljs-keyword">finally</span>:
    f.close()  <span class="hljs-comment"># 确保文件被关闭</span>

<span class="hljs-comment"># 2. 使用 with 语句（推荐）</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'./test.txt'</span>, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:
    content = f.read()
    <span class="hljs-built_in">print</span>(content)
<span class="hljs-comment"># with 语句会自动关闭文件，无需手动调用 close()</span>
</code></pre>
<h3 data-id="heading-78">15. 异常处理</h3>
<h4 data-id="heading-79">15.1 try-except 语句</h4>
<p>用于捕获和处理程序运行时的异常。</p>
<h5 data-id="heading-80">基本语法</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 可能引发异常的代码</span>
    result = <span class="hljs-number">10</span> / <span class="hljs-number">0</span>
<span class="hljs-keyword">except</span> ZeroDivisionError:
    <span class="hljs-comment"># 处理特定异常</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"除数不能为零"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-comment"># 处理所有其他异常</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发生了异常: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># 没有异常时执行</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"执行成功"</span>)
<span class="hljs-keyword">finally</span>:
    <span class="hljs-comment"># 无论是否有异常都会执行</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"清理资源"</span>)
</code></pre>
<h5 data-id="heading-81">常见异常类型</h5>

































<table><thead><tr><th>异常类型</th><th>描述</th></tr></thead><tbody><tr><td><code>ZeroDivisionError</code></td><td>除数为零</td></tr><tr><td><code>ValueError</code></td><td>值错误</td></tr><tr><td><code>TypeError</code></td><td>类型错误</td></tr><tr><td><code>FileNotFoundError</code></td><td>文件未找到</td></tr><tr><td><code>IndexError</code></td><td>索引越界</td></tr><tr><td><code>KeyError</code></td><td>字典键不存在</td></tr></tbody></table>
<h5 data-id="heading-82">异常处理示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    user_weight = <span class="hljs-built_in">float</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入您的体重(单位:kg): "</span>))
    user_height = <span class="hljs-built_in">float</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入您的身高(单位:m): "</span>))
    <span class="hljs-keyword">if</span> user_height &lt;= <span class="hljs-number">0</span>:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"身高必须大于零"</span>)
    bmi = user_weight / (user_height ** <span class="hljs-number">2</span>)
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"输入错误: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:   <span class="hljs-comment"># 或者 except:</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发生了未知错误: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"您的BMI指数是: <span class="hljs-subst">{bmi:<span class="hljs-number">.2</span>f}</span>"</span>)
<span class="hljs-keyword">finally</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"程序执行完毕"</span>)
</code></pre>
<h4 data-id="heading-83">15.2 断言（assert）</h4>
<p>断言用于检查程序中的条件是否为真，如果为假则引发 <code>AssertionError</code>。</p>
<h5 data-id="heading-84">语法</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">assert</span> 条件, <span class="hljs-string">"错误消息"</span>
</code></pre>
<h5 data-id="heading-85">代码示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 基本断言</span>
<span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(<span class="hljs-string">"hello"</span>) == <span class="hljs-number">5</span>, <span class="hljs-string">"字符串长度应为5"</span>

<span class="hljs-comment"># 断言在测试中的应用</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a + b

<span class="hljs-comment"># 测试add函数</span>
<span class="hljs-keyword">assert</span> add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) == <span class="hljs-number">3</span>, <span class="hljs-string">"1+2应该等于3"</span>
<span class="hljs-keyword">assert</span> add(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>, <span class="hljs-string">"-1+1应该等于0"</span>
<span class="hljs-keyword">assert</span> add(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>, <span class="hljs-string">"0+0应该等于0"</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"所有断言通过！"</span>)
</code></pre>
<h5 data-id="heading-86">注意事项</h5>
<ul>
<li>断言主要用于开发和测试阶段</li>
<li>生产环境中可以通过 <code>-O</code> 选项关闭断言</li>
<li>断言失败会立即终止程序执行</li>
</ul>
<h3 data-id="heading-87">16. 单元测试（unittest）</h3>
<h4 data-id="heading-88">16.1 什么是单元测试</h4>
<p>单元测试是对程序中最小可测试单元（如函数、方法）进行的测试。</p>
<h4 data-id="heading-89">16.2 使用 unittest 框架</h4>
<h5 data-id="heading-90">测试用例结构</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> unittest

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestClassName</span>(unittest.TestCase):
    <span class="hljs-string">"""测试类"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setUp</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""每个测试方法执行前调用"""</span>
        <span class="hljs-keyword">pass</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tearDown</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""每个测试方法执行后调用"""</span>
        <span class="hljs-keyword">pass</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_method_name</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试方法，必须以test_开头"""</span>
        <span class="hljs-comment"># 断言语句</span>
        self.assertEqual(<span class="hljs-number">1</span> + <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
</code></pre>
<h5 data-id="heading-91">常用断言方法</h5>









































<table><thead><tr><th>断言方法</th><th>描述</th></tr></thead><tbody><tr><td><code>assertEqual(a, b)</code></td><td>验证 a == b</td></tr><tr><td><code>assertNotEqual(a, b)</code></td><td>验证 a != b</td></tr><tr><td><code>assertTrue(x)</code></td><td>验证 x 为 True</td></tr><tr><td><code>assertFalse(x)</code></td><td>验证 x 为 False</td></tr><tr><td><code>assertAlmostEqual(a, b)</code></td><td>验证浮点数近似相等</td></tr><tr><td><code>assertRaises(exception, callable, *args, **kwds)</code></td><td>验证调用可调用对象会引发指定异常</td></tr><tr><td><code>assertIn(item, container)</code></td><td>验证 item 在 container 中</td></tr><tr><td><code>assertNotIn(item, container)</code></td><td>验证 item 不在 container 中</td></tr></tbody></table>
<h5 data-id="heading-92">完整测试示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># calculator.py</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, a, b</span>):
        <span class="hljs-keyword">return</span> a + b

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">subtract</span>(<span class="hljs-params">self, a, b</span>):
        <span class="hljs-keyword">return</span> a - b

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">self, a, b</span>):
        <span class="hljs-keyword">return</span> a * b

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">self, a, b</span>):
        <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"除数不能为零"</span>)
        <span class="hljs-keyword">return</span> a / b

<span class="hljs-comment"># test_calculator.py</span>
<span class="hljs-keyword">import</span> unittest
<span class="hljs-keyword">from</span> calculator <span class="hljs-keyword">import</span> Calculator

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestCalculator</span>(unittest.TestCase):
    <span class="hljs-string">"""测试计算器类"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setUp</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试前的准备工作"""</span>
        self.calc = Calculator()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n开始测试..."</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tearDown</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试后的清理工作"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试结束..."</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_add</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试加法功能"""</span>
        self.assertEqual(self.calc.add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), <span class="hljs-number">3</span>)
        self.assertEqual(self.calc.add(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>), <span class="hljs-number">0</span>)
        self.assertEqual(self.calc.add(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-number">0</span>)
        self.assertAlmostEqual(self.calc.add(<span class="hljs-number">1.5</span>, <span class="hljs-number">2.5</span>), <span class="hljs-number">4.0</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_subtract</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试减法功能"""</span>
        self.assertEqual(self.calc.subtract(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>), <span class="hljs-number">2</span>)
        self.assertEqual(self.calc.subtract(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>), -<span class="hljs-number">2</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_multiply</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试乘法功能"""</span>
        self.assertEqual(self.calc.multiply(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), <span class="hljs-number">6</span>)
        self.assertEqual(self.calc.multiply(-<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), -<span class="hljs-number">6</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_divide</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试除法功能"""</span>
        self.assertEqual(self.calc.divide(<span class="hljs-number">6</span>, <span class="hljs-number">3</span>), <span class="hljs-number">2</span>)
        self.assertEqual(self.calc.divide(<span class="hljs-number">5</span>, <span class="hljs-number">2</span>), <span class="hljs-number">2.5</span>)

        <span class="hljs-comment"># 测试除数为零的情况</span>
        <span class="hljs-keyword">with</span> self.assertRaises(ValueError):
            self.calc.divide(<span class="hljs-number">5</span>, <span class="hljs-number">0</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    unittest.main()
</code></pre>
<h5 data-id="heading-93">运行测试用例</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方法1：直接运行测试文件</span>
python test_calculator.py

<span class="hljs-comment"># 方法2：使用unittest模块运行</span>
python -m unittest test_calculator.py

<span class="hljs-comment"># 方法3：运行所有测试文件</span>
python -m unittest discover

<span class="hljs-comment"># 方法4：运行特定测试类</span>
python -m unittest test_calculator.TestCalculator

<span class="hljs-comment"># 方法5：运行特定测试方法</span>
python -m unittest test_calculator.TestCalculator.test_add
</code></pre>
<h4 data-id="heading-94">16.3 测试最佳实践</h4>
<ol>
<li>每个测试方法只测试一个功能</li>
<li>测试方法名应清晰描述测试内容</li>
<li>使用 setUp 和 tearDown 方法管理测试资源</li>
<li>测试覆盖正常情况和边界情况</li>
<li>测试应该是独立的，不依赖于其他测试</li>
</ol>
<h3 data-id="heading-95">17. 高阶函数和匿名函数</h3>
<h4 data-id="heading-96">17.1 高阶函数</h4>
<p>高阶函数是指可以接受函数作为参数，或者返回函数的函数。</p>
<h5 data-id="heading-97">常见高阶函数</h5>

























<table><thead><tr><th>函数</th><th>描述</th></tr></thead><tbody><tr><td><code>map(function, iterable)</code></td><td>对可迭代对象的每个元素应用函数</td></tr><tr><td><code>filter(function, iterable)</code></td><td>过滤可迭代对象，返回符合条件的元素</td></tr><tr><td><code>reduce(function, iterable)</code></td><td>对可迭代对象进行累积操作</td></tr><tr><td><code>sorted(iterable, key=None, reverse=False)</code></td><td>排序，可接受函数作为key</td></tr></tbody></table>
<h5 data-id="heading-98">代码示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># map 示例：将列表中的每个元素平方</span>
numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
squared = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x ** <span class="hljs-number">2</span>, numbers))
<span class="hljs-built_in">print</span>(squared)  <span class="hljs-comment"># 输出: [1, 4, 9, 16, 25]</span>

<span class="hljs-comment"># filter 示例：筛选出偶数</span>
numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]
evens = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>, numbers))
<span class="hljs-built_in">print</span>(evens)  <span class="hljs-comment"># 输出: [2, 4, 6]</span>

<span class="hljs-comment"># sorted 示例：按字符串长度排序</span>
words = [<span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"cherry"</span>, <span class="hljs-string">"date"</span>]
sorted_words = <span class="hljs-built_in">sorted</span>(words, key=<span class="hljs-built_in">len</span>)
<span class="hljs-built_in">print</span>(sorted_words)  <span class="hljs-comment"># 输出: ["date", "apple", "cherry", "banana"]</span>

<span class="hljs-comment"># 自定义高阶函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_function</span>(<span class="hljs-params">func, x</span>):
    <span class="hljs-string">"""将函数应用于x"""</span>
    <span class="hljs-keyword">return</span> func(x)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">square</span>(<span class="hljs-params">x</span>):
    <span class="hljs-string">"""计算平方"""</span>
    <span class="hljs-keyword">return</span> x ** <span class="hljs-number">2</span>

result = apply_function(square, <span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(result)  <span class="hljs-comment"># 输出: 25</span>
</code></pre>
<h4 data-id="heading-99">17.2 匿名函数</h4>
<p>匿名函数是指没有名字的函数，使用 <code>lambda</code> 关键字定义。</p>
<h5 data-id="heading-100">语法</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">lambda</span> 参数: 表达式
</code></pre>
<h5 data-id="heading-101">代码示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 基本使用</span>
square = <span class="hljs-keyword">lambda</span> x: x ** <span class="hljs-number">2</span>
<span class="hljs-built_in">print</span>(square(<span class="hljs-number">3</span>))  <span class="hljs-comment"># 输出: 9</span>

<span class="hljs-comment"># 作为高阶函数的参数</span>
doubled = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x * <span class="hljs-number">2</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]))
<span class="hljs-built_in">print</span>(doubled)  <span class="hljs-comment"># 输出: [2, 4, 6]</span>

<span class="hljs-comment"># 多个参数</span>
add = <span class="hljs-keyword">lambda</span> x, y: x + y
<span class="hljs-built_in">print</span>(add(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>))  <span class="hljs-comment"># 输出: 8</span>

<span class="hljs-comment"># 与条件表达式结合</span>
even_or_odd = <span class="hljs-keyword">lambda</span> x: <span class="hljs-string">"偶数"</span> <span class="hljs-keyword">if</span> x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"奇数"</span>
<span class="hljs-built_in">print</span>(even_or_odd(<span class="hljs-number">4</span>))  <span class="hljs-comment"># 输出: 偶数</span>
<span class="hljs-built_in">print</span>(even_or_odd(<span class="hljs-number">5</span>))  <span class="hljs-comment"># 输出: 奇数</span>
</code></pre>
<h5 data-id="heading-102">注意事项</h5>
<ol>
<li>匿名函数只能包含一个表达式</li>
<li>表达式的结果就是函数的返回值</li>
<li>适合简单的、一次性使用的函数</li>
<li>复杂逻辑建议使用普通函数</li>
</ol>
<h3 data-id="heading-103">18. 装饰器</h3>
<h4 data-id="heading-104">18.1 什么是装饰器</h4>
<p>装饰器是一种特殊的高阶函数，用于修改其他函数的功能，而不改变其代码。</p>
<h4 data-id="heading-105">18.2 装饰器的基本使用</h4>
<h5 data-id="heading-106">简单装饰器示例</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义装饰器</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">my_decorator</span>(<span class="hljs-params">func</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"装饰器开始执行"</span>)
        func()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"装饰器结束执行"</span>)
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-comment"># 使用装饰器</span>
<span class="hljs-meta">@my_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello, World!"</span>)

<span class="hljs-comment"># 调用函数</span>
say_hello()
</code></pre>
<h5 data-id="heading-107">带参数的装饰器</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 带参数的装饰器</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">my_decorator</span>(<span class="hljs-params">func</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"装饰器开始执行"</span>)
        result = func(*args, **kwargs)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"装饰器结束执行"</span>)
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@my_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a + b

result = add(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果: <span class="hljs-subst">{result}</span>"</span>)
</code></pre>
<h5 data-id="heading-108">装饰器的应用场景</h5>
<ol>
<li>日志记录</li>
<li>性能测试</li>
<li>权限验证</li>
<li>缓存</li>
<li>事务处理</li>
</ol>
<h3 data-id="heading-109">总结</h3>
<p>本指南涵盖了 Python 编程的核心知识点，包括：</p>
<ul>
<li><strong>基础数据类型</strong>：整数、字符串、浮点数、布尔值、空值等</li>
<li><strong>数据结构</strong>：列表、元组、字典等</li>
<li><strong>控制流</strong>：条件判断（if-elif-else）、循环结构（for、while）</li>
<li><strong>函数</strong>：定义与调用、参数传递、作用域、闭包</li>
<li><strong>面向对象编程</strong>：类定义、属性与方法、继承、多态</li>
<li><strong>文件操作</strong>：路径、读取、写入、关闭</li>
<li><strong>异常处理</strong>：try-except-else-finally、断言</li>
<li><strong>单元测试</strong>：unittest框架的使用</li>
<li><strong>高级特性</strong>：高阶函数、匿名函数、装饰器</li>
</ul>
<p>学习 Python 最好的方法是多写代码，多实践。</p>
<h4 data-id="heading-110">学习建议</h4>
<ol>
<li><strong>基础先行</strong>：先掌握基础语法和核心概念</li>
<li><strong>多写代码</strong>：理论结合实践，编写小项目</li>
<li><strong>阅读源码</strong>：学习优秀的开源项目</li>
<li><strong>参与社区</strong>：加入 Python 社区，向他人学习</li>
<li><strong>持续学习</strong>：Python 生态不断发展，保持学习习惯</li>
</ol>
<p>祝您学习愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS-Grid 网格布局全攻略（从基础到进阶）]]></title>    <link>https://juejin.cn/post/7599640782570422299</link>    <guid>https://juejin.cn/post/7599640782570422299</guid>    <pubDate>2026-01-27T07:28:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599640782570422299" data-draft-id="7599604510365843494" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS-Grid 网格布局全攻略（从基础到进阶）"/> <meta itemprop="keywords" content="前端,面试,CSS"/> <meta itemprop="datePublished" content="2026-01-27T07:28:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS-Grid 网格布局全攻略（从基础到进阶）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:28:55.000Z" title="Tue Jan 27 2026 07:28:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>如果说 Flex 布局是一维的“线性布局”，那么 <strong>Grid（网格布局）</strong> 就是真正意义上的“二维布局”。它能够同时处理行与列，让我们通过简单的代码就能实现极其复杂的页面结构。</p>
<h2 data-id="heading-1">一、 Grid 容器属性：定义你的网格空间</h2>
<h3 data-id="heading-2">1. 开启网格布局</h3>
<ul>
<li><strong><code>display: grid;</code></strong> ：容器里面的元素为块级元素。</li>
<li><strong><code>display: inline-grid;</code></strong> ：容器里面的元素为行内元素。</li>
</ul>
<h3 data-id="heading-3">2. 定义行与列 (<code>grid-template-*</code>)</h3>
<p>通过 <code>grid-template-columns</code> 和 <code>grid-template-rows</code> 划分网格。</p>
<ul>
<li>
<p><strong>常用关键字：</strong></p>
<ul>
<li><strong><code>repeat(count, value)</code></strong> ：重复定义。例如 <code>repeat(3, 1fr)</code> 表示三列均分。</li>
<li><strong><code>auto-fill</code></strong>：自动填充。让每一行/列尽可能容纳更多固定宽度的单元格。</li>
<li><strong><code>fr</code> (Fraction)</strong> ：片段单位。表示网格剩余空间的比例关系。</li>
<li><strong><code>minmax(min, max)</code></strong> ：长度范围。例如 <code>minmax(100px, 1fr)</code>。</li>
<li><strong><code>auto</code></strong>：自适应，占满剩余宽度。</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>注意</strong>：不要单独使用grid-template-rows，单独使用grid布局可能会造成布局混乱，不可预测。</p>
</blockquote>
<ul>
<li><strong>使用实例</strong>：当网格单元格数量大于子元素数量时，多余单元格会保持空白，子元素不会因此被拉伸放大。
例如：定义一个 3列×4行 的网格，但只放入9个元素，剩余3个单元格会留空，而现有元素仍保持正常的网格比例尺寸</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>6<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>7<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">html</span>,
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    }
    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
    }
    <span class="hljs-selector-class">.grid-container</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">800px</span>;
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>fr);
      <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>fr);
    }
    <span class="hljs-selector-class">.div</span> {
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid salmon;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a33c10075db24b0bb0e1c7c7f1002088~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770103734&amp;x-signature=zIaJAZd%2FSyjM0%2FTANgoMBFVB1n4%3D" alt="image.png" width="45%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01586539ac484970b6813d7d97f8121f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770103734&amp;x-signature=0RTzyIPHIKkR8n02Blbj2l93wos%3D" alt="image.png" width="45%" loading="lazy"/>
<h3 data-id="heading-4">3. 间距 (Gap)</h3>
<blockquote>
<p><strong>注意</strong>：最新标准中已建议移除 <code>grid-</code> 前缀，直接使用 <code>gap</code>。</p>
</blockquote>
<ul>
<li><strong><code>row-gap</code></strong>：行间距。</li>
<li><strong><code>column-gap</code></strong>：列间距。</li>
<li><strong><code>gap</code></strong>：合写形式（<code>&lt;row-gap&gt; &lt;column-gap&gt;</code>）。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.grid-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">800px</span>;
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>fr);
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>fr);
  <span class="hljs-attribute">column-gap</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">row-gap</span>: <span class="hljs-number">20px</span>;
}
</code></pre>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5dd143066ea483180b8cad5354998c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770103734&amp;x-signature=3szmQ58BUuridYaCpN6l62yu%2Fqs%3D" alt="image.png" width="30%" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-5">二、 网格排列与对齐控制</h2>
<h3 data-id="heading-6">1. 单元格内容对齐 (<code>-items</code>)</h3>
<p>控制网格项在<strong>网格表内部</strong>的位置：</p>
<ul>
<li><strong><code>justify-items</code></strong>：网格中每行的水平对齐方式（<code>start | end | center | stretch</code>）。</li>
<li><strong><code>align-items</code></strong>：格中每行的垂直对齐方式。</li>
<li><strong><code>place-items</code></strong>：简写形式。</li>
</ul>
<blockquote>
<p><strong>注意</strong>：当 Grid 子元素的宽高都超过了父容器时，<code>justify-items</code>和 <code>align-items</code>可能会失效或不明显，所以尽量网格容器与子元素宽高可预知场景下使用。</p>
</blockquote>
<p><strong>实例</strong>：例如现在我给每个单元格都设置一个小于网格的宽高，这时就可直观看到它们的区别了 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5e09ed459d14591835bb6535e64da2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770103734&amp;x-signature=QVY%2FCnQSZRSlTtMQBASdZjTxruQ%3D" alt="image.png" width="45%" loading="lazy"/> <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f11af43e3a3f47b4a024f13e2af93827~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770103734&amp;x-signature=PInTwC3e7f3Ub1kMHQqYkogeElI%3D" alt="image.png" width="45%" loading="lazy"/></p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>6<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>7<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">html</span>,
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    }
    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
    }
    <span class="hljs-selector-class">.grid-container</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">800px</span>;
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>fr);
      <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>fr);
      <span class="hljs-attribute">column-gap</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">row-gap</span>: <span class="hljs-number">20px</span>;

      <span class="hljs-attribute">align-items</span>: center; <span class="hljs-comment">/* 网格中每行的水平对齐方式 */</span>
      justify-items: center;<span class="hljs-comment">/* 网格中每行的垂直对齐方式 */</span>
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid yellow;
    }
    <span class="hljs-selector-class">.div</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>n) {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">height</span>:<span class="hljs-number">30px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid salmon;
    }
    <span class="hljs-selector-class">.div</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>n + <span class="hljs-number">1</span>) {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">50px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid green;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre>
<h3 data-id="heading-7">2. 整个网格内容区域对齐 (<code>-content</code>)</h3>
<p>在实际使用中，存在着网格内容区域大小和网格容器大小不一致的情况，而-content则是设置网格内容区域相对于容器的对齐方式。</p>
<ul>
<li><strong><code>justify-content</code></strong>：网格内容区域在水平位置相当于容器的对齐方式（<code>space-between | space-around | space-evenly | strat | end | center |stretch(大小没有指定时，拉伸占据整个网格容器)</code>）。</li>
<li><strong><code>align-content</code></strong>：网格内容区域在垂直方向相对于容器的对齐方式。</li>
<li><strong><code>place-content</code></strong>：简写形式。</li>
</ul>
<p>在上面的例子中，可以发现添加justify-content与align-content是无效的，因为网格内容区域总尺寸 = 容器尺寸，现在将网格中子项设置较大值与较小值，你就会发现区别：图左为网格内容区域总尺寸 &gt; 容器尺寸,图右边为网格内容区域总尺寸 &lt; 容器尺寸。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cc82aa8265a453880b1d44cfc58ab11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770103734&amp;x-signature=wOePGK1IeVX1wofYw%2B77gIqBQyI%3D" alt="image.png" width="45%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02a4e3d6d03848f5aa35ad8454b58013~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770103734&amp;x-signature=nKJdgxNI2gOYd5%2FAeOPOc8HqZXI%3D" alt="image.png" width="45%" loading="lazy"/>
<pre><code class="hljs language-css" lang="css"> <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
  }
<span class="hljs-selector-class">.grid-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">800px</span>;
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">200px</span>); <span class="hljs-comment">/*  repeat(3, 100px) */</span>
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">4</span>, <span class="hljs-number">350px</span>);   <span class="hljs-comment">/*repeat(4, 150px); */</span>
  <span class="hljs-attribute">column-gap</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">row-gap</span>: <span class="hljs-number">20px</span>;

  <span class="hljs-attribute">align-items</span>: center; <span class="hljs-comment">/* 网格中每行的水平对齐方式 */</span>
  justify-items: center;<span class="hljs-comment">/* 网格中每行的垂直对齐方式 */</span>


  <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/*网格内容区域在水平位置相当于容器的对齐方式*/</span>
  <span class="hljs-attribute">align-content</span>: center;  <span class="hljs-comment">/*网格内容区域在垂直方向相当于容器的对齐方式*/</span>
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid yellow;
}
</code></pre>
<h3 data-id="heading-8">3. 排列顺序 (<code>grid-auto-flow</code>)</h3>
<p>决定网格项如何自动填充到网格中。</p>
<ul>
<li><strong><code>row</code></strong>（默认）：先行后列。</li>
<li><strong><code>column</code></strong>：先列后行。</li>
</ul>
<hr/>
<hr/>
<h2 data-id="heading-9">三、 项目属性：单个格子的自我修养</h2>
<h3 data-id="heading-10">1. 基于网格线的定位</h3>
<p>可以通过指定网格线来决定一个项目跨越多少行或列。</p>
<ul>
<li><strong><code>grid-column-start / end</code></strong>：元素左边框所在的垂直网格线/右边框所在的垂直网格线。</li>
<li><strong><code>grid-row-start / end</code></strong>：元素上边框所在的水平网格线/下边框所在的水平网格线。</li>
<li><strong><code>span</code> 关键字</strong>：表示跨越的跨度。例如 <code>grid-column: span 2;</code>（跨越两列）。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b871d1e3c53b43acb93e4d7a234e60a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770103734&amp;x-signature=R%2F5J3osIHwL2%2BgKgsnlfl6C88GY%3D" alt="image.png" width="50%" loading="lazy"/></p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>6<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>7<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">html</span>,
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    }
    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
    }
    <span class="hljs-selector-class">.grid-container</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">800px</span>;
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>fr); <span class="hljs-comment">/*  repeat(3, 100px) */</span>
      <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>fr); <span class="hljs-comment">/*repeat(4, 150px); */</span>
      <span class="hljs-attribute">column-gap</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">row-gap</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-comment">/* grid-auto-flow: column; */</span>
      <span class="hljs-attribute">align-items</span>: center; <span class="hljs-comment">/* 网格中每行的水平对齐方式 */</span>
      justify-items: center; <span class="hljs-comment">/* 网格中每行的垂直对齐方式 */</span>

      <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/*网格内容区域在水平位置相当于容器的对齐方式*/</span>
      <span class="hljs-attribute">align-content</span>: center; <span class="hljs-comment">/*网格内容区域在垂直方向相当于容器的对齐方式*/</span>
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid yellow;
    }
    <span class="hljs-selector-class">.div</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>n) {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid salmon;
    }
    <span class="hljs-selector-class">.div</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>n + <span class="hljs-number">1</span>) {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid green;
    }
    <span class="hljs-selector-class">.div</span><span class="hljs-selector-pseudo">:last-child</span>{
      <span class="hljs-attribute">background</span>: red;
      <span class="hljs-attribute">grid-column-start</span>:<span class="hljs-number">2</span>;
      <span class="hljs-attribute">grid-column-end</span>: <span class="hljs-number">4</span>;
      <span class="hljs-attribute">grid-row-start</span>: <span class="hljs-number">3</span>;
      <span class="hljs-attribute">grid-row-end</span>: <span class="hljs-number">5</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre>
<h3 data-id="heading-11">2. 单个项目的对齐 (<code>-self</code>)</h3>
<p>适用于网格内的的子元素，它会覆盖容器定义的 <code>items</code> 属性：</p>
<ul>
<li><strong><code>justify-self</code></strong> ：置单元格内容的水平位置（左中右），跟<code>justify-items</code>属性的用法完全一致，但只作用于单个项目。取值：<code>start | end | center | stretch（拉伸）</code></li>
<li><strong><code>align-self</code></strong>：设置单元格内容的垂直位置（上中下）</li>
<li><strong><code>place-self</code></strong>：是<code>align-self</code>属性和<code>justify-self</code>属性的合并简写形式</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fed0c15cd154cb6a53cb6b644476145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770103734&amp;x-signature=OOAU1%2BWmiNUefzF%2F7oKe7pfKKY0%3D" alt="image.png" width="45%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/486e24680c1c4f41b033b99738076a0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770103734&amp;x-signature=YKKLQx8ldymzrZWAMGkYYB24c5o%3D" alt="image.png" width="45%" loading="lazy"/>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>6<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>7<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"div"</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">html</span>,
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    }
    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
    }
    <span class="hljs-selector-class">.grid-container</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">800px</span>;
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>fr); <span class="hljs-comment">/*  repeat(3, 100px) */</span>
      <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>fr); <span class="hljs-comment">/*repeat(4, 150px); */</span>
      <span class="hljs-attribute">column-gap</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">row-gap</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-comment">/* grid-auto-flow: column; */</span>
      <span class="hljs-attribute">align-items</span>: center; <span class="hljs-comment">/* 网格中每行的水平对齐方式 */</span>
      justify-items: center; <span class="hljs-comment">/* 网格中每行的垂直对齐方式 */</span>
      justify-self: start;
      <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/*网格内容区域在水平位置相当于容器的对齐方式*/</span>
      <span class="hljs-attribute">align-content</span>: center; <span class="hljs-comment">/*网格内容区域在垂直方向相当于容器的对齐方式*/</span>
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid yellow;
    }
    <span class="hljs-selector-class">.div</span>{
      justify-self: end; 
      <span class="hljs-attribute">align-self</span>: end;
    }
    <span class="hljs-selector-class">.div</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>n) {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid salmon;
    }
    <span class="hljs-selector-class">.div</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>n + <span class="hljs-number">1</span>) {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">50px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid green;
    }
    <span class="hljs-selector-class">.div</span><span class="hljs-selector-pseudo">:last-child</span>{
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">background</span>: red;
      <span class="hljs-attribute">grid-column-start</span>:<span class="hljs-number">2</span>;
      <span class="hljs-attribute">grid-column-end</span>: <span class="hljs-number">4</span>;
      <span class="hljs-attribute">grid-row-start</span>: <span class="hljs-number">3</span>;
      <span class="hljs-attribute">grid-row-end</span>: <span class="hljs-number">5</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[中心化 Agent 和 非中心化 Agent 的实现区别]]></title>    <link>https://juejin.cn/post/7599572091076247594</link>    <guid>https://juejin.cn/post/7599572091076247594</guid>    <pubDate>2026-01-27T07:52:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599572091076247594" data-draft-id="7599591405314097193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="中心化 Agent 和 非中心化 Agent 的实现区别"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-27T07:52:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="twl"/> <meta itemprop="url" content="https://juejin.cn/user/3016715635534029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            中心化 Agent 和 非中心化 Agent 的实现区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3016715635534029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    twl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:52:04.000Z" title="Tue Jan 27 2026 07:52:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天开会有一个问题引起我的思考：有同事说可以在Cursor执行自定义的Agent。梳理了下问题让ChatGPT回答。</p>
<p>想用 <strong>langchain.js 自己写 agent</strong>，但 <strong>Cursor 订阅用户没有单独的 OpenAI/Anthropic API key</strong>，所以没法让他们“自带 key”来跑——这时基本结论是：</p>
<p><strong>Cursor 的订阅配额/“token”通常不能被第三方代码（比如 langchain.js）当作 API key 直接调用模型来消耗。</strong><br/>
Cursor 订阅更像是“Cursor 客户端内部可用的推理权限”，不是一个通用的开发者 API 凭证。</p>
<p>所以如果你坚持“自己写 agent + 让用户不用 API key”，常见可行路线只有下面几种（各有 trade-off）：</p>
<hr/>
<h3 data-id="heading-0">1) 把你的 agent 做成“Cursor 内置 Agent 的工作流/脚本”，而不是自己去调模型</h3>
<p><strong>核心</strong>：让 Cursor 自己负责调用模型（消耗 Cursor 订阅），你的代码只负责：</p>
<ul>
<li>提供 prompt/规则/任务分解模板</li>
<li>提供工具（本地命令、文件操作、你的 HTTP 工具接口）</li>
<li>提供执行脚本（不包含 LLM 调用）</li>
</ul>
<p>这样用户不需要 API key，你也不需要中心化 token。<br/>
代价是：你不能用 langchain.js 自己掌控 “LLM loop”，而是把 loop 交给 Cursor 的 agent。</p>
<blockquote>
<p>实操上就是：你交付一个 repo + 一套 Cursor instructions / command palette 入口，让 Cursor agent 按你的流程跑。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">2) 中心化提供模型（你付 token）→ 然后对用户收费/限额</h3>
<p>这是最常见、也是最“langchain 原汁原味”的方式：你的 agent 服务端持有模型 key。</p>
<ul>
<li>✅ 体验最好：用户零配置</li>
<li>❌ 你承担 token 成本（除非你把成本转嫁到订阅/按量计费）</li>
<li>✅ 最可控：可做审计、缓存、路由、多模型</li>
</ul>
<p>如果你主要目标是商业化而不是“把 token 推给用户”，这一条反而是正解。</p>
<hr/>
<h3 data-id="heading-2">3) 让用户用“免费/本地模型”当作无 key 的替代</h3>
<p>如果用户没有 API key，你还可以让他们：</p>
<ul>
<li>用 Ollama / LM Studio（本地推理）</li>
<li>或用某些提供“免 key/客户端可用”的模型渠道（通常不稳定/不建议依赖）</li>
</ul>
<p>这能做到“非中心化”，但模型质量、速度、平台兼容性差异会很大。</p>
<hr/>
<h3 data-id="heading-3">4) 企业场景：让用户用公司统一 SSO 的模型网关（不是 Cursor 订阅）</h3>
<p>如果你们公司有内部 LLM gateway（SSO、按用户计费/配额），可以做到：</p>
<ul>
<li>用户不用自己拿 API key（他们用公司身份登录）</li>
<li>token 成本按用户/部门计量，而不是你单独承担</li>
<li>对接方式：OAuth / JWT / company gateway</li>
</ul>
<p>这不是“消耗 Cursor token”，但能达到“非你中心化 token”的成本归属。</p>
<hr/>
<h2 data-id="heading-4">结论：<strong>想“自己写 langchain agent + 不要用户 API key + 消耗 Cursor 订阅 token”基本做不到</strong></h2>
<p>因为 Cursor 订阅不是可外部调用的通用 API。你要么：</p>
<ul>
<li><strong>接受 loop 在 Cursor 内跑</strong>（方案 1），你的代码只做工具与模板；或</li>
<li><strong>你中心化托管模型</strong>（方案 2）；或</li>
<li><strong>走本地/企业网关</strong>（方案 3/4）。</li>
</ul>
<hr/>
<h3 data-id="heading-5">给你一个推荐组合（实用且接近你目标）</h3>
<p><strong>“Cursor 负责推理 + 你的工具服务”</strong> ：</p>
<ul>
<li>你写：工具服务（HTTP endpoints）+ 一套 prompt/instructions + 项目模板</li>
<li>Cursor 用户：用 Cursor agent 来规划、调用工具、改代码</li>
<li>成本：模型 token 由 Cursor 订阅承担；你只承担工具成本（可限流/收费）</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 echarts + react 实现上下交错正负轴柱状图]]></title>    <link>https://juejin.cn/post/7599765329410162728</link>    <guid>https://juejin.cn/post/7599765329410162728</guid>    <pubDate>2026-01-27T07:53:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599765329410162728" data-draft-id="7599845683121782824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 echarts + react 实现上下交错正负轴柱状图"/> <meta itemprop="keywords" content="JavaScript,前端,ECharts"/> <meta itemprop="datePublished" content="2026-01-27T07:53:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小飞机噗噗噗"/> <meta itemprop="url" content="https://juejin.cn/user/3910327822978568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 echarts + react 实现上下交错正负轴柱状图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3910327822978568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小飞机噗噗噗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:53:05.000Z" title="Tue Jan 27 2026 07:53:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、最终实现效果</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42395c03d31f4318a03b7a6f1a4289c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6aOe5py65ZmX5ZmX5ZmX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105185&amp;x-signature=n7fLMYFRlTtWalGy44kJoXlCqzk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2、实现难点</h2>
<h3 data-id="heading-2">方法一</h3>
<p>在echarts配置里没有像上面一样上下交错试例，最像的一个是左右交错的，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5061adeba79472f88fca659e7a01cad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6aOe5py65ZmX5ZmX5ZmX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105185&amp;x-signature=Wg3xJrDKhy%2FqMchwJ9zAdatt6Do%3D" alt="image.png" loading="lazy"/>
链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fecharts.apache.org%2Fexamples%2Fzh%2Feditor.html%3Fc%3Dbar-negative2" target="_blank" title="https://echarts.apache.org/examples/zh/editor.html?c=bar-negative2" ref="nofollow noopener noreferrer">echarts.apache.org/examples/zh…</a></p>
<p>第一个想到的方法就是在这个基础上将柱状图旋转90度，但是不能解决一条柱形需要显示2个文案，而且所有文案也要跟着旋转90度，因此不太可取。</p>
<h3 data-id="heading-3">方法二：</h3>
<p>用正常的柱状图配置方法，因为柱状图本身是支持上下正负值的，唯一的问题就是，配置里只会让底部的线居中，而底部的文字是只能底部和顶部显示的，因此也不可取。如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1305d35ede694f1a92ed98799a3771ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6aOe5py65ZmX5ZmX5ZmX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105185&amp;x-signature=ySvtOB4uW4k2B5pi%2BztVOLUi00g%3D" alt="企业微信截图_a645b6e2-e2f2-4a12-85c1-96e7ae94c0db.png" loading="lazy"/></p>
<h2 data-id="heading-4">3、最终实现方法</h2>
<p>echarts柱状图的柱子是可以由两个柱子叠加拼接起来了的，那让半个柱子显示正负值，半个柱子显示底部文案值，然后根据正负一上一下显示，最后去掉底部的x轴文案。<br/>
类似如下图叠加柱子：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0745ebf1428c4471bc43edc95e2479b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6aOe5py65ZmX5ZmX5ZmX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105185&amp;x-signature=gtMB1%2BOK0BRszwbsAaoYwLR7ZG0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">4、实现代码</h2>
<pre><code class="hljs language-css" lang="css">      const dataX = <span class="hljs-selector-attr">[<span class="hljs-string">'超过30天'</span>, <span class="hljs-string">'超过90天'</span>, <span class="hljs-string">'超过半年'</span>, <span class="hljs-string">'超过1年'</span>]</span>;
      const dataY = <span class="hljs-selector-attr">[-2.8, 16.42, -24.6, 20.21]</span>;
      const options = {
      tooltip: { show: false },
      xAxis: {
        type: <span class="hljs-string">'category'</span>,
        axisTick: { show: false },
        axisLabel: { show: false },
        splitLine: { show: false },
        axisLine: {
          show: true,
          lineStyle: {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">1</span>,
            color: <span class="hljs-string">'#E3E3E3'</span>
          }
        }
      },
      // Y 轴配置
      yAxis: {
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: { show: false },
        splitLine: { show: false },
        type: <span class="hljs-string">'value'</span>
      },
      // 系列数据
      series: [
        {
          name: <span class="hljs-string">'占比'</span>,
          type: <span class="hljs-string">'bar'</span>,
          stack: <span class="hljs-string">'a'</span>,
          label: {
            show: true,
            formatter: params =&gt; dataX[params.dataIndex]
          },
          data: <span class="hljs-built_in">funcDataLabel</span>(dataY, false),
          barWidth: <span class="hljs-string">'30%'</span>
        },
        {
          name: <span class="hljs-string">'占比'</span>,
          type: <span class="hljs-string">'bar'</span>,
          stack: <span class="hljs-string">'a'</span>,
          label: {
            show: true
          },
          data: <span class="hljs-built_in">funcDataLabel</span>(dataY, true),
          barWidth: <span class="hljs-string">'30%'</span>
        }
      ]
    };

// 图数据格式化
  const funcDataLabel = (data, isTop) =&gt; {
    const charge = value =&gt; {
      if (isTop) {
        return value &gt; <span class="hljs-number">0</span> ? '<span class="hljs-attribute">top</span>' : <span class="hljs-string">'bottom'</span>;
      } else {
        return value &gt; <span class="hljs-number">0</span> ? '<span class="hljs-attribute">bottom</span>' : <span class="hljs-string">'top'</span>;
      }
    };
    return data<span class="hljs-selector-class">.map</span>(item =&gt; {
      return {
        value: item,
        label: {
          <span class="hljs-attribute">normal</span>: {
            <span class="hljs-attribute">position</span>: <span class="hljs-built_in">charge</span>(item)
          }
        },
        // 柱子颜色区分正负
        itemStyle: {
          <span class="hljs-attribute">color</span>: item &gt;= <span class="hljs-number">0</span> ? <span class="hljs-string">'#E84225'</span> : <span class="hljs-string">'#19A740'</span>
        }
      };
    });
  };
</code></pre>
<h2 data-id="heading-6">总结：</h2>
<p>echarts配置还是比较复杂的，参数非常多，但是可以多参考示例给到一些启发，或者直接使用实例上进行二次开发会更加容易和上手一些</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IntelliJ IDEA 的「闪电操作」：这些 Quick 技巧让你编码快如疾风]]></title>    <link>https://juejin.cn/post/7599798118460751881</link>    <guid>https://juejin.cn/post/7599798118460751881</guid>    <pubDate>2026-01-27T08:22:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599798118460751881" data-draft-id="7599708108620824627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IntelliJ IDEA 的「闪电操作」：这些 Quick 技巧让你编码快如疾风"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T08:22:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大黄评测"/> <meta itemprop="url" content="https://juejin.cn/user/714024404135696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IntelliJ IDEA 的「闪电操作」：这些 Quick 技巧让你编码快如疾风
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/714024404135696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大黄评测
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T08:22:17.000Z" title="Tue Jan 27 2026 08:22:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代软件开发中，效率就是生产力。而 JetBrains 家的 IntelliJ IDEA 之所以广受开发者喜爱，不仅因为其强大的智能提示和深度代码理解能力，更因为它内置了大量“Quick”类快捷操作——这些功能往往只需一两个快捷键，就能完成原本繁琐的手动操作，真正实现“快如闪电”。</p>
<p>下面，就带你盘点几个最实用、最高效的 IntelliJ IDEA “Quick”技巧，助你提升编码速度与流畅度。</p>
<hr/>
<h2 data-id="heading-0">1. <strong>Quick Fix（快速修复）— Alt + Enter（Windows/Linux）或 ⌥ + Enter（macOS）</strong></h2>
<p>这是 IDEA 最核心的“Quick”功能之一。当你代码出现警告、错误，甚至只是有优化建议时，按下 <code>Alt + Enter</code>，IDEA 会立刻弹出上下文相关的修复建议。</p>
<ul>
<li>自动导入缺失类</li>
<li>生成 getter/setter、构造函数、toString()</li>
<li>将 lambda 表达式转换为匿名类（或反之）</li>
<li>快速创建测试类</li>
<li>修复拼写错误或未使用的变量</li>
</ul>
<blockquote>
<p>小贴士：即使没有错误，光标放在任意代码上按 <code>Alt + Enter</code>，也常有意想不到的重构建议！</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">2. <strong>Quick Documentation（快速文档）— Ctrl + Q（Windows/Linux）或 F1（macOS）</strong></h2>
<p>想快速查看某个方法、类或字段的文档？无需跳转到源码或打开浏览器，直接使用 Quick Documentation。</p>
<ul>
<li>显示 Javadoc、参数说明、返回值类型</li>
<li>支持 Markdown 渲染（如 Spring 注解说明）</li>
<li>可固定窗口，边看边写</li>
</ul>
<blockquote>
<p>搭配 <code>Ctrl + 鼠光标悬停</code> 使用效果更佳！</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">3. <strong>Quick Evaluate Expression（快速表达式求值）— Alt + F8</strong></h2>
<p>调试时想知道某个变量的值？或者想临时计算一个表达式（比如 <code>list.size() &gt; 5</code>）？不用加断点再重启，直接在调试过程中选中表达式，按 <code>Alt + F8</code>，IDEA 会立即计算并显示结果。</p>
<ul>
<li>支持复杂表达式</li>
<li>不影响程序运行状态</li>
<li>比手动加日志快十倍</li>
</ul>
<hr/>
<h2 data-id="heading-3">4. <strong>Quick Switch Scheme（快速切换配色/快捷键方案）— Ctrl + `（反引号）</strong></h2>
<p>团队协作时，可能需要临时切换主题、快捷键映射或代码风格？用 <code>Ctrl + ``（反引号）</code> 打开 Quick Switch 菜单，一键切换：</p>
<ul>
<li>Color Scheme（配色方案）</li>
<li>Keymap（快捷键布局）</li>
<li>Look and Feel（UI 主题）</li>
<li>Code Style（代码格式）</li>
</ul>
<p>特别适合在演示、结对编程或接手他人项目时快速适应环境。</p>
<hr/>
<h2 data-id="heading-4">5. <strong>Quick JavaDoc / Quick Definition（快速查看定义）— Ctrl + Shift + I</strong></h2>
<p>想看一个方法的实现但又不想跳转页面？<code>Ctrl + Shift + I</code>（Windows/Linux）可内联预览方法或类的定义，悬浮窗口显示源码片段，按 <code>Esc</code> 即可关闭，不打断当前编辑流。</p>
<hr/>
<h2 data-id="heading-5">6. <strong>Live Templates + Postfix Completion（虽非“Quick”命名，但本质是快速输入）</strong></h2>
<p>虽然名字里没带“Quick”，但它们是真正的“快速编码神器”：</p>
<ul>
<li>输入 <code>sout</code> + Tab → 自动生成 <code>System.out.println();</code></li>
<li>输入 <code>fori</code> + Tab → 快速生成 for 循环</li>
<li>使用 <code>.var</code>、<code>.notnull</code> 等后缀自动包裹表达式</li>
</ul>
<p>这些模板可自定义，极大减少重复敲键。</p>
<hr/>
<h2 data-id="heading-6">结语：让“Quick”成为你的肌肉记忆</h2>
<p>IntelliJ IDEA 的“Quick”系列功能，本质上是把开发者高频操作封装成一键可达的智能助手。熟练掌握这些技巧，不仅能减少鼠标依赖，更能让你进入“心流编码”状态——思路不中断，手指不停歇。</p>
<p>下次写代码时，不妨试试少点几次鼠标，多按几下 <code>Alt + Enter</code> —— 你会发现，真正的“快”，不是打字速度，而是思维与工具的无缝协同。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5 分钟上手 HarmonyOS Skill：快速集成语音与意图交互能力]]></title>    <link>https://juejin.cn/post/7599708108620841011</link>    <guid>https://juejin.cn/post/7599708108620841011</guid>    <pubDate>2026-01-27T08:24:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599708108620841011" data-draft-id="7599614131424378889" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5 分钟上手 HarmonyOS Skill：快速集成语音与意图交互能力"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T08:24:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大尚来也"/> <meta itemprop="url" content="https://juejin.cn/user/1681597639955488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5 分钟上手 HarmonyOS Skill：快速集成语音与意图交互能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1681597639955488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大尚来也
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T08:24:03.000Z" title="Tue Jan 27 2026 08:24:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在鸿蒙生态（HarmonyOS）中，<strong>Skill</strong> 是实现智能语音助手、意图识别和跨设备服务调用的核心机制之一。通过 Skill，你的应用可以被小艺（Celia）语音唤醒、响应用户自然语言指令，甚至与其他设备上的服务无缝协作。</p>
<p>本文将用 <strong>5 分钟时间</strong>，带你快速理解 Skill 的基本概念，并演示如何在 HarmonyOS 应用中注册并使用一个简单的自定义 Skill。</p>
<hr/>
<h2 data-id="heading-0">一、什么是 HarmonyOS Skill？</h2>
<p>Skill 是 HarmonyOS 提供的一种<strong>服务能力单元</strong>，用于描述“我能做什么”。它基于 <strong>意图（Intent）</strong> 模型，将用户语音或文本指令映射到具体的功能逻辑。</p>
<p>例如：</p>
<ul>
<li>用户说：“打开天气应用查看北京天气”</li>
<li>系统识别出意图 <code>VIEW_WEATHER</code>，并携带参数 <code>{city: "北京"}</code></li>
<li>你的应用通过注册对应 Skill 响应该意图，启动页面并展示数据</li>
</ul>
<blockquote>
<p>💡 Skill 类似于 Android 的 App Actions 或 iOS 的 Siri Shortcuts，但深度集成于鸿蒙分布式架构。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、5 分钟实战：创建一个“打招呼”Skill</h2>
<p>我们将创建一个简单 Skill：当用户对小艺说“让 MyApp 打个招呼”，应用弹出“Hello, HarmonyOS!”。</p>
<h3 data-id="heading-2">步骤 1：配置 <code>config.json</code></h3>
<p>在 <code>module.json5</code>（或旧版 <code>config.json</code>）中注册 Skill：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.example.myapp.GreetSkill"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"voice"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"响应打招呼指令"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"greet_user"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"entities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MainAbility"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"srcEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./ets/entryability/EntryAbility.ets"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"greet_user"</span><span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>✅ 注意：<code>skills</code> 定义能力，<code>abilities</code> 中的 <code>skills</code> 字段将其绑定到具体 Ability。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">步骤 2：在 Ability 中处理 Skill 调用</h3>
<p>在 <code>EntryAbility.ets</code> 中重写 <code>onNewWant</code> 方法（用于接收外部拉起）：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> <span class="hljs-type">UIAbility</span> from '<span class="hljs-meta">@ohos</span>.app.ability.<span class="hljs-type">UIAbility</span>';

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UIAbility</span> </span>{
  onNewWant(want) {
    <span class="hljs-comment">// 检查是否由 Skill 触发</span>
    <span class="hljs-keyword">if</span> (want.action === 'greet_user') {
      <span class="hljs-comment">// 可在此启动特定页面或执行逻辑</span>
      console.log('收到打招呼指令！');
      
      <span class="hljs-comment">// 示例：弹出提示（需在 UI 线程）</span>
      <span class="hljs-comment">// 此处简化，实际应在页面中通过 ArkTS 显示</span>
    }
  }
}
</code></pre>
<blockquote>
<p>🔔 提示：若需跳转到具体页面，可在 <code>onNewWant</code> 中调用 <code>this.context.startAbility()</code> 启动目标页面，并传递参数。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">步骤 3：（可选）配置语音触发语料</h3>
<p>为了让小艺识别“让 MyApp 打个招呼”，需在 <strong>华为开发者联盟后台</strong> 提交语音模板（目前部分能力需审核）：</p>
<ul>
<li>
<p>意图名称：<code>greet_user</code></p>
</li>
<li>
<p>示例语句：</p>
<ul>
<li>“让 MyApp 打个招呼”</li>
<li>“叫 MyApp 问好”</li>
</ul>
</li>
</ul>
<blockquote>
<p>🌐 注：本地调试可使用 <strong>DevEco Studio 的模拟器 + Intent 模拟工具</strong> 测试，无需真实语音。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">三、调试技巧</h2>
<ol>
<li><strong>使用 DevEco Studio 的“Intent 模拟器”</strong><br/>
在运行配置中选择 “Edit Configurations” → 添加 “Intent” 启动方式，填入 <code>action: greet_user</code> 即可模拟 Skill 调用。</li>
<li><strong>查看日志</strong><br/>
通过 <code>hdc shell</code> 或 DevEco Log 工具观察 <code>onNewWant</code> 是否被触发。</li>
<li><strong>权限声明</strong><br/>
若涉及敏感操作，需在 <code>module.json5</code> 中声明相应权限（如 <code>ohos.permission.INTERNET</code>）。</li>
</ol>
<hr/>
<h2 data-id="heading-6">四、进阶方向</h2>
<ul>
<li>使用 <strong>Entity</strong> 传递参数（如城市名、时间等）</li>
<li>实现 <strong>Service Ability</strong> 响应后台 Skill 请求</li>
<li>结合 <strong>元服务（Meta Service）</strong> 实现免安装卡片式交互</li>
<li>接入 <strong>小艺开放平台</strong>，支持更多自然语言表达</li>
</ul>
<hr/>
<h2 data-id="heading-7">结语</h2>
<p>Skill 是 HarmonyOS 构建智能、主动、跨端服务的关键入口。虽然本文仅展示了最基础的用法，但已为你打开了通往“语音驱动应用”的大门。只需 5 分钟配置，你的应用就能听懂用户说话！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“搬家”说起：彻底搞懂 JavaScript 的赋值、引用与深浅拷贝]]></title>    <link>https://juejin.cn/post/7599708108620890163</link>    <guid>https://juejin.cn/post/7599708108620890163</guid>    <pubDate>2026-01-27T08:25:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599708108620890163" data-draft-id="7599708108620873779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“搬家”说起：彻底搞懂 JavaScript 的赋值、引用与深浅拷贝"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T08:25:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大鹏1988"/> <meta itemprop="url" content="https://juejin.cn/user/2526022571922992"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“搬家”说起：彻底搞懂 JavaScript 的赋值、引用与深浅拷贝
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2526022571922992/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大鹏1988
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T08:25:16.000Z" title="Tue Jan 27 2026 08:25:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没有经历过搬家？<br/>
箱子打包、家具搬运、钥匙交接……看似简单，但稍不注意，就可能把“原屋”的东西弄丢，或者在新家发现“复制”的只是个空壳。</p>
<p>有趣的是，JavaScript 中的<strong>赋值操作</strong>，就像一场“数据搬家”。而很多人踩过的坑——比如改了新变量，原对象却也变了——其实都源于没搞清楚：<strong>JavaScript 到底是在“搬东西”，还是在“给地址”？</strong></p>
<p>今天，我们就用“搬家”这个故事，彻底理清 JavaScript 的赋值操作符（<code>=</code>）背后的真相。</p>
<hr/>
<h2 data-id="heading-0">一、基本类型：真·打包搬家（值传递）</h2>
<p>假设你有一本实体书《JavaScript 忍者秘籍》，要搬到新家。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">book1</span> = <span class="hljs-string">"JavaScript 忍者秘籍"</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">book2</span> = book1<span class="hljs-comment">;</span>

<span class="hljs-attr">book2</span> = <span class="hljs-string">"TypeScript 入门指南"</span><span class="hljs-comment">;</span>
console.log(book1)<span class="hljs-comment">; // "JavaScript 忍者秘籍"</span>
</code></pre>
<p>✅ <strong>发生了什么？</strong><br/>
<code>book1</code> 是一个字符串（基本类型）。当你执行 <code>book2 = book1</code>，JavaScript <strong>真的复印了一本新书</strong>交给 <code>book2</code>。之后你把 <code>book2</code> 换成别的书，完全不影响 <code>book1</code>。</p>
<blockquote>
<p>📦 <strong>基本类型（Number, String, Boolean, null, undefined, Symbol, BigInt）</strong> ：赋值时<strong>复制值本身</strong>，互不干扰。</p>
</blockquote>
<p>这就像搬家时，你把书装箱带走——原房东家不留副本，新家拿到的是独立实体。</p>
<hr/>
<h2 data-id="heading-1">二、引用类型：只给了“新家地址”（引用传递）</h2>
<p>现在，你有一台智能冰箱，里面存着牛奶、鸡蛋、蔬菜。搬家时，你不会把冰箱拆了运过去，而是告诉搬家公司：“新地址是 A 栋 101”。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">fridge1</span> = { milk: <span class="hljs-number">2</span>, eggs: <span class="hljs-number">12</span> }<span class="hljs-comment">;</span>
let <span class="hljs-attr">fridge2</span> = fridge1<span class="hljs-comment">;</span>

<span class="hljs-attr">fridge2.milk</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
console.log(fridge1.milk)<span class="hljs-comment">; // 0！😱</span>
</code></pre>
<p>❌ <strong>问题来了</strong>：为什么改了 <code>fridge2</code>，<code>fridge1</code> 也变了？</p>
<p>🔑 <strong>真相</strong>：<br/>
<code>fridge1</code> 存的不是冰箱本身，而是<strong>冰箱的地址（引用）</strong> 。<code>fridge2 = fridge1</code> 只是<strong>复制了这个地址</strong>，两个变量指向同一个物理冰箱！</p>
<blockquote>
<p>🏠 <strong>引用类型（Object, Array, Function 等）</strong> ：赋值时<strong>复制的是内存地址</strong>，多个变量共享同一块数据。</p>
</blockquote>
<p>这就像你和朋友都拿着同一栋房子的钥匙——谁进去拿走牛奶，冰箱都会变空。</p>
<hr/>
<h2 data-id="heading-2">三、“搬家”升级：如何真正复制一个冰箱？（深浅拷贝）</h2>
<h3 data-id="heading-3">浅拷贝：只复制第一层（新冰箱，但食材还是共享的？）</h3>
<p>使用 <code>Object.assign()</code> 或展开运算符 <code>...</code>：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">fridge1</span> = { milk: <span class="hljs-number">2</span>, eggs: <span class="hljs-number">12</span>, drawer: { butter: <span class="hljs-number">1</span> } }<span class="hljs-comment">;</span>
let <span class="hljs-attr">fridge2</span> = { ...fridge1 }<span class="hljs-comment">;</span>

<span class="hljs-attr">fridge2.milk</span> = <span class="hljs-number">0</span><span class="hljs-comment">;           // OK，不影响 fridge1</span>
<span class="hljs-attr">fridge2.drawer.butter</span> = <span class="hljs-number">0</span><span class="hljs-comment">;  // ❌ fridge1.drawer.butter 也变成 0！</span>
</code></pre>
<p>🔍 <strong>原因</strong>：浅拷贝只复制了顶层属性。<code>drawer</code> 仍然是一个<strong>引用</strong>，两个冰箱共用同一个抽屉！</p>
<h3 data-id="heading-4">深拷贝：连抽屉里的黄油都重新买一份！</h3>
<p>方法一：<code>JSON.parse(JSON.stringify(obj))</code>（有局限，不支持函数、undefined、Symbol 等）</p>
<p>方法二：使用 Lodash 的 <code>_.cloneDeep()</code> 或自己写递归函数。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">fridge2</span> = JSON.parse(JSON.stringify(fridge1))<span class="hljs-comment">;</span>
<span class="hljs-attr">fridge2.drawer.butter</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
console.log(fridge1.drawer.butter)<span class="hljs-comment">; // 1，安全！</span>
</code></pre>
<blockquote>
<p>✅ <strong>深拷贝</strong>：递归复制所有层级，确保新旧对象完全独立——这才是真正的“全新搬家”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">四、赋值操作符 <code>=</code> 的本质总结</h2>




















<table><thead><tr><th>类型</th><th>赋值行为</th><th>类比</th></tr></thead><tbody><tr><td>基本类型</td><td>复制值（独立副本）</td><td>打包带走实体物品</td></tr><tr><td>引用类型</td><td>复制引用（共享同一内存地址）</td><td>只给新地址，东西没动</td></tr></tbody></table>
<blockquote>
<p>💡 记住：<strong><code>=</code> 从不自动深拷贝对象</strong>。它只是“交钥匙”，不是“造新房”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">五、避坑指南：日常开发建议</h2>
<ol>
<li>
<p><strong>不要假设 <code>=</code> 会复制对象</strong> —— 它只是创建新引用。</p>
</li>
<li>
<p><strong>修改前先拷贝</strong>：若需独立操作，务必使用浅/深拷贝。</p>
</li>
<li>
<p><strong>函数参数也是赋值</strong>：传入对象时，函数内部修改会影响外部（因为传的是引用）。</p>
</li>
<li>
<p><strong>const 不代表“不可变”</strong> ：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">obj</span> = { a: <span class="hljs-number">1</span> }<span class="hljs-comment">;</span>
<span class="hljs-attr">obj.a</span> = <span class="hljs-number">2</span><span class="hljs-comment">; // ✅ 合法！const 只防止 obj 重新赋值，不防内容修改</span>
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-7">结语：下次“搬家”，记得问清楚是搬东西，还是只给地址</h2>
<p>JavaScript 的赋值机制，看似简单，却是理解状态管理、React 更新、Redux 不可变性等高级概念的基础。<br/>
通过“搬家”这个比喻，希望你能清晰分辨：<strong>什么时候是独立副本，什么时候是共享引用</strong>。</p>
<p>下次再遇到“改了一个变量，另一个也变了”的 bug，你就知道——<br/>
不是代码出了问题，而是你忘了：<strong>JavaScript 从不帮你搬冰箱，它只给你一把钥匙。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>