<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[FastAPI - Tracking ID的设计]]></title>    <link>https://juejin.cn/post/7577702891272994851</link>    <guid>https://juejin.cn/post/7577702891272994851</guid>    <pubDate>2025-11-29T15:12:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891272994851" data-draft-id="7577690150092734504" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FastAPI -  Tracking ID的设计"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T15:12:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="花酒锄作田"/> <meta itemprop="url" content="https://juejin.cn/user/3289345922186590"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FastAPI -  Tracking ID的设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3289345922186590/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    花酒锄作田
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:12:46.000Z" title="Sat Nov 29 2025 15:12:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在实际业务中，根据 <code>tracking_id</code> 追查日志中一条请求的完整处理路径是一个比较常见的需求。不过 FastAPI 官方并没有提供相对应的功能，因此需要开发者自行实现。本文介绍如何基于 <code>contextvars</code>，为每次请求的完整流程都添加一个 tracking_id，并在日志中自动记录。</p>
<h2 data-id="heading-1">什么是 contextvars</h2>
<p>Python 在 3.7 版本的标准库中加入了一个模块 <code>contextvars</code>，顾名思义就是 "(Context Variables) 上下文变量"，通常用来隐式地传递一些环境信息的变量，其作用跟 <code>threading.local()</code> 比较相似。不过 <code>threading.local()</code> 是针对线程的，隔离线程之间的数据状态，而 <code>contextvars</code> 可以用在 <code>asyncio</code> 生态的异步协程中。<strong>PS: <code>contextvars</code> 不仅可以用在异步协程中，也可以替代 <code>threading.local()</code> 用在多线程函数中。</strong></p>
<h2 data-id="heading-2">基本使用</h2>
<ol>
<li>首先编写 <code>context.py</code></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> contextvars
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>

TRACKING_ID: contextvars.ContextVar[<span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]] = contextvars.ContextVar(
    <span class="hljs-string">'tracking_id'</span>, 
    default=<span class="hljs-literal">None</span>
)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tracking_id</span>() -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""用于依赖注入"""</span>
    <span class="hljs-keyword">return</span> TRACKING_ID.get()

</code></pre>
<ol start="2">
<li>编写中间件 <code>middlewares.py</code>，在请求头和响应头中添加 tracking_id 的信息。常见场景就是客户拿着 tracking_id 找碴。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> uuid

<span class="hljs-keyword">from</span> starlette.middleware.base <span class="hljs-keyword">import</span> (BaseHTTPMiddleware,
                                       RequestResponseEndpoint)
<span class="hljs-keyword">from</span> starlette.requests <span class="hljs-keyword">import</span> Request
<span class="hljs-keyword">from</span> starlette.responses <span class="hljs-keyword">import</span> Response

<span class="hljs-keyword">from</span> context <span class="hljs-keyword">import</span> TRACKING_ID


<span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackingIDMiddleware</span>(<span class="hljs-title class_ inherited__">BaseHTTPMiddleware</span>):
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">
        self, request: Request, call_next: RequestResponseEndpoint
    </span>) -&gt; Response:
        tracking_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
        token = TRACKING_ID.<span class="hljs-built_in">set</span>(tracking_id)
        <span class="hljs-comment"># HTTP 请求头习惯于使用 latin-1 编码</span>
        request.scope[<span class="hljs-string">"headers"</span>].append((<span class="hljs-string">b"x-request-id"</span>, tracking_id.encode(<span class="hljs-string">"latin-1"</span>)))

        <span class="hljs-keyword">try</span>:
            resp = <span class="hljs-keyword">await</span> call_next(request)
        <span class="hljs-keyword">finally</span>:
            <span class="hljs-comment"># 无论是否成功，每次请求结束时重置 tracking_id，避免泄露到下一次的请求中</span>
            TRACKING_ID.reset(token)

        <span class="hljs-comment"># 可选, 在响应中设置跟踪 ID 头</span>
        resp.headers[<span class="hljs-string">"X-Tracking-ID"</span>] = tracking_id

        <span class="hljs-keyword">return</span> resp

</code></pre>
<ol start="3">
<li>编写 handler 函数 <code>handlers.py</code>，测试在 handler 函数中获取 tracking_id。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">from</span> context <span class="hljs-keyword">import</span> TRACKING_ID


<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">mock_db_query</span>():
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
    current_id = TRACKING_ID.get()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"This is mock_db_query. Current tracking ID: <span class="hljs-subst">{current_id}</span>"</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
</code></pre>
<ol start="4">
<li>编写主函数 <code>main.py</code></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> uvicorn
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Depends, FastAPI
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> PlainTextResponse
<span class="hljs-keyword">from</span> starlette.background <span class="hljs-keyword">import</span> BackgroundTasks

<span class="hljs-keyword">from</span> context <span class="hljs-keyword">import</span> TRACKING_ID, get_tracking_id
<span class="hljs-keyword">from</span> handlers <span class="hljs-keyword">import</span> mock_db_query
<span class="hljs-keyword">from</span> middlewares <span class="hljs-keyword">import</span> TrackingIDMiddleware

app = FastAPI()

app.add_middleware(TrackingIDMiddleware)


<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/qwer"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_qwer</span>():
    <span class="hljs-string">"""测试上下文变量传递"""</span>
    current_id = TRACKING_ID.get()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"This is get qwer. Current tracking ID: <span class="hljs-subst">{current_id}</span>"</span>)
    <span class="hljs-keyword">return</span> PlainTextResponse(<span class="hljs-string">f"Current tracking ID: <span class="hljs-subst">{current_id}</span>"</span>)


<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/asdf"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_asdf</span>(<span class="hljs-params">tracking_id: <span class="hljs-built_in">str</span> = Depends(<span class="hljs-params">get_tracking_id</span>)</span>):
    <span class="hljs-string">"""测试依赖注入"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"This is get asdf. tracking ID: <span class="hljs-subst">{tracking_id}</span>"</span>)
    <span class="hljs-keyword">await</span> mock_db_query()
    <span class="hljs-keyword">return</span> PlainTextResponse(<span class="hljs-string">f"Get request, tracking ID: <span class="hljs-subst">{tracking_id}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    uvicorn.run(<span class="hljs-string">"main:app"</span>, host=<span class="hljs-string">"127.0.0.1"</span>, port=<span class="hljs-number">8000</span>, workers=<span class="hljs-number">4</span>)
</code></pre>
<ol start="5">
<li>启动服务后用 curl 测试 api，在控制台可以看到 tracking_id 在请求中都能捕获到。</li>
</ol>
<pre><code class="hljs language-vbnet" lang="vbnet">This <span class="hljs-built_in">is</span> <span class="hljs-keyword">get</span> qwer. Current tracking ID: <span class="hljs-number">01</span>b0153f-<span class="hljs-number">4877</span>-<span class="hljs-number">4</span>ca0-ac35-ed88ab406452
<span class="hljs-symbol">INFO:</span>     <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">55708</span> - <span class="hljs-string">"GET /qwer HTTP/1.1"</span> <span class="hljs-number">200</span> OK
This <span class="hljs-built_in">is</span> <span class="hljs-keyword">get</span> asdf. tracking ID: <span class="hljs-number">0</span>be61d8d-<span class="hljs-number">11</span>a0-<span class="hljs-number">4</span>cb6-<span class="hljs-number">812</span>f-<span class="hljs-number">51</span>b9bfdc2639
This <span class="hljs-built_in">is</span> mock_db_query. Current tracking ID: <span class="hljs-number">0</span>be61d8d-<span class="hljs-number">11</span>a0-<span class="hljs-number">4</span>cb6-<span class="hljs-number">812</span>f-<span class="hljs-number">51</span>b9bfdc2639
<span class="hljs-symbol">INFO:</span>     <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">55722</span> - <span class="hljs-string">"GET /asdf HTTP/1.1"</span> <span class="hljs-number">200</span> OK
</code></pre>
<p>使用 curl 的控制台输出</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">$</span> <span class="hljs-string">curl</span> <span class="hljs-string">-i</span> <span class="hljs-string">http://127.0.0.1:8000/qwer</span>
<span class="hljs-string">HTTP/1.1</span> <span class="hljs-number">200</span> <span class="hljs-string">OK</span>
<span class="hljs-attr">date:</span> <span class="hljs-string">Sat,</span> <span class="hljs-number">29</span> <span class="hljs-string">Nov</span> <span class="hljs-number">2025 06:16:46 </span><span class="hljs-string">GMT</span>
<span class="hljs-attr">server:</span> <span class="hljs-string">uvicorn</span>
<span class="hljs-attr">content-length:</span> <span class="hljs-number">57</span>
<span class="hljs-attr">content-type:</span> <span class="hljs-string">text/plain;</span> <span class="hljs-string">charset=utf-8</span>
<span class="hljs-attr">x-tracking-id:</span> <span class="hljs-string">01b0153f-4877-4ca0-ac35-ed88ab406452</span>

<span class="hljs-attr">Current tracking ID:</span> <span class="hljs-string">01b0153f-4877-4ca0-ac35-ed88ab406452</span>

<span class="hljs-string">=====</span> <span class="hljs-string">另一个请求</span> <span class="hljs-string">=====</span>

<span class="hljs-string">$</span> <span class="hljs-string">curl</span> <span class="hljs-string">-i</span> <span class="hljs-string">http://127.0.0.1:8000/asdf</span>
<span class="hljs-string">HTTP/1.1</span> <span class="hljs-number">200</span> <span class="hljs-string">OK</span>
<span class="hljs-attr">date:</span> <span class="hljs-string">Sat,</span> <span class="hljs-number">29</span> <span class="hljs-string">Nov</span> <span class="hljs-number">2025 06:16:49 </span><span class="hljs-string">GMT</span>
<span class="hljs-attr">server:</span> <span class="hljs-string">uvicorn</span>
<span class="hljs-attr">content-length:</span> <span class="hljs-number">62</span>
<span class="hljs-attr">content-type:</span> <span class="hljs-string">text/plain;</span> <span class="hljs-string">charset=utf-8</span>
<span class="hljs-attr">x-tracking-id:</span> <span class="hljs-string">0be61d8d-11a0-4cb6-812f-51b9bfdc2639</span>

<span class="hljs-string">Get</span> <span class="hljs-string">request,</span> <span class="hljs-attr">tracking ID:</span> <span class="hljs-string">0be61d8d-11a0-4cb6-812f-51b9bfdc2639</span>
</code></pre>
<h2 data-id="heading-3">后台任务型 API</h2>
<p>FastAPI 中有 <code>from starlette.background import BackgroundTasks</code> 可以让接口直接响应，将实际流程放到后台异步处理。因为上面的中间件在响应时会重置 tracking_id，所以后台的协程函数<strong>可能</strong>不会获取到 tracking_id。理论上是这样的，但是本地测试时发现在异步协程中还是能获取到 tracking_id，这可能是本地低并发的问题。在生产环境高并发的情况下，最好还是强制解耦，显式传递 contextvars。</p>
<ol>
<li>自定义的中间件类保持不变。</li>
<li>添加后台任务的 api</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> starlette.background <span class="hljs-keyword">import</span> BackgroundTasks
<span class="hljs-keyword">from</span> handlers <span class="hljs-keyword">import</span> mock_backgroud_task

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/zxcv"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_zxcv</span>(<span class="hljs-params">tasks: BackgroundTasks</span>):
    <span class="hljs-string">"""测试后台任务"""</span>
    current_id = TRACKING_ID.get()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"This is get zxcv. The current id is <span class="hljs-subst">{current_id}</span>"</span>)

    <span class="hljs-comment"># 显式传递 tracking_id</span>
    tasks.add_task(mock_backgroud_task, current_id)

    <span class="hljs-keyword">return</span> PlainTextResponse(<span class="hljs-string">f"This is get zxcv. The current id is <span class="hljs-subst">{current_id}</span>"</span>)
</code></pre>
<ol start="3">
<li>后台协程函数中显式处理。任务在启动时，使用传入的参数值，在自己的任务执行上下文中，重新设置 <code>TRACKING_ID</code>。在任务结束时，对任务自己设置的上下文进行清理。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">mock_backgroud_task</span>(<span class="hljs-params">request_tracking_id: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]</span>):
    <span class="hljs-keyword">if</span> request_tracking_id <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        request_tracking_id = <span class="hljs-built_in">str</span>(uuid4())
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"WARNING: No tracking ID found. Generate a new one: <span class="hljs-subst">{request_tracking_id}</span>"</span>)
    token = TRACKING_ID.<span class="hljs-built_in">set</span>(request_tracking_id)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 模拟耗时的后台异步任务</span>
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">5</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"This is mock backgroud task. Current tracking ID: <span class="hljs-subst">{request_tracking_id}</span>"</span>)
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment"># 确保 tracking ID 被重置</span>
        TRACKING_ID.reset(token)
</code></pre>
<ol start="4">
<li>启动主程序并测试 tracking_id 是否一致。</li>
</ol>
<h2 data-id="heading-4">日志记录 tracking_id</h2>
<p>tracking_id 在前面是手动添加到 <code>print()</code> 里面的，未免还是麻烦了点，不注意的话还可能忘了。因此，最好是用日志记录器自动获取 <code>tracking_id</code>，这样代码的侵入性改动就大大降低了。</p>
<p>首先需要封装一个日志模块。这里选用标准库 <code>logging</code>，喜欢 <code>loguru</code> 的话也可以试试用 <code>loguru</code> 封装（如果生产环境有频繁且严苛的安全扫描，个人建议还是尽量用标准库比较好，免得经常升级第三方依赖）。如果你的应用运行在 docker 或者 k8s 上，有现成的控制台日志采集工具，那么这个日志模块只需要输出到控制台就行了。如果应用运行在 server 上，需要用比如 <code>filebeat</code> 这样的工具读取日志文件，那么需要解决<strong>日志文件体积增长</strong>、<strong>uvicorn 多工作进程运行同时写日志文件的竞争问题</strong>、以及<strong>高并发情况下写日志文件阻塞异步协程的问题</strong>。</p>
<p>以下日志模块的示例解决了上述问题，主要特点：</p>
<ul>
<li>自动获取 tracking_id，无需手动记录。</li>
<li>日志为 JSON 格式，便于在 ELK 这样的日志聚合系统中查日志。</li>
<li>日志会同时输出到标准输出和日志文件，也可以配置输出到其中一个。</li>
<li>日志文件按天轮转，默认保留最近 7 天的日志，避免日志文件体积增长的问题。</li>
<li>主进程和工作进程输出到各自的日志文件中，避免同时写日志文件的竞争问题。</li>
<li>日志会先输出到队列，避免写文件阻塞异步协程的问题。</li>
</ul>
<ol>
<li>编辑文件 <code>pkg/log/log.py</code>。主要内容都在这个部分。需要对外提供的对象只有 <code>setup_logger</code> 和 <code>close_log_queue</code>。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> logging.handlers <span class="hljs-keyword">import</span> QueueHandler, QueueListener, TimedRotatingFileHandler
<span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> current_process
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> queue <span class="hljs-keyword">import</span> Queue
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>

<span class="hljs-keyword">from</span> context <span class="hljs-keyword">import</span> TRACKING_ID

_queue_listener = <span class="hljs-literal">None</span>
_queue_logger: <span class="hljs-type">Optional</span>[Queue] = <span class="hljs-literal">None</span>
PATTERN_PROCESS_NAME = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r"SpawnProcess-(\d+)"</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">JSONFormatter</span>(logging.Formatter):
    <span class="hljs-string">"""A logging formatter that outputs logs in JSON format."""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">format</span>(<span class="hljs-params">self, record: logging.LogRecord</span>) -&gt; <span class="hljs-built_in">str</span>:
        log_record = {
            <span class="hljs-string">"@timestamp"</span>: self.formatTime(record, <span class="hljs-string">"%Y-%m-%dT%H:%M:%S%z"</span>),
            <span class="hljs-string">"level"</span>: record.levelname,
            <span class="hljs-string">"name"</span>: record.name,
            <span class="hljs-comment"># "taskName": getattr(record, "taskName", None),  # Record task name if needed</span>
            <span class="hljs-string">"processName"</span>: record.processName,  <span class="hljs-comment"># Record process name if needed</span>
            <span class="hljs-string">"tracking_id"</span>: <span class="hljs-built_in">getattr</span>(record, <span class="hljs-string">"tracking_id"</span>, <span class="hljs-literal">None</span>),
            <span class="hljs-string">"loc"</span>: <span class="hljs-string">"%s:%d"</span> % (record.filename, record.lineno),
            <span class="hljs-string">"func"</span>: record.funcName,
            <span class="hljs-string">"message"</span>: record.getMessage(),
        }

        <span class="hljs-keyword">return</span> json.dumps(log_record, ensure_ascii=<span class="hljs-literal">False</span>, default=<span class="hljs-built_in">str</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackingIDFilter</span>(logging.Filter):
    <span class="hljs-string">"""A logging filter that adds tracking_id to log records.
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">self, record</span>):
        record.tracking_id = TRACKING_ID.get()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_console_handler</span>(<span class="hljs-params">level: <span class="hljs-built_in">int</span></span>) -&gt; logging.StreamHandler:
    <span class="hljs-string">"""Setup a StreamHandler for console logging.
    
    Args:
        level (int): The logging level.
    """</span>
    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(level)
    handler.setFormatter(JSONFormatter())
    <span class="hljs-keyword">return</span> handler


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_file_handler</span>(<span class="hljs-params">
    level: <span class="hljs-built_in">int</span>, log_path: <span class="hljs-built_in">str</span>, rotate_days: <span class="hljs-built_in">int</span>
</span>) -&gt; TimedRotatingFileHandler:
    <span class="hljs-string">"""Setup a TimedRotatingFileHandler for logging.
    
    Args:
        level (int): The logging level.
        log_path (str): The log path.
        rotate_days (int): The number of days to keep log files.
    """</span>
    handler = TimedRotatingFileHandler(
        filename=log_path,
        when=<span class="hljs-string">"midnight"</span>,
        interval=<span class="hljs-number">1</span>,
        backupCount=rotate_days,
        encoding=<span class="hljs-string">"utf-8"</span>,
    )
    handler.setLevel(level)
    handler.setFormatter(JSONFormatter())
    <span class="hljs-keyword">return</span> handler


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_queue_handler</span>(<span class="hljs-params">level: <span class="hljs-built_in">int</span>, log_queue: Queue</span>) -&gt; QueueHandler:
    <span class="hljs-string">"""Setup a QueueHandler for logging.
    
    Args:
        level (int): The logging level.
        log_queue (Queue): The log queue.
    """</span>
    handler = QueueHandler(log_queue)
    handler.setLevel(level)
    <span class="hljs-keyword">return</span> handler


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_spawn_process_number</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    Get the spawn process number for log file naming.
    The server should be started with multiple processes using uvicorn's --workers option.
    Prevent issues caused by multiple processes writing to the same log file.

    Args:
        name (str): The name of the log file.

    Returns:
        str: The spawn process number for log file naming.
    """</span>
    <span class="hljs-keyword">try</span>:
        process_name = current_process().name
        pid = os.getpid()

        <span class="hljs-keyword">if</span> process_name == <span class="hljs-string">"MainProcess"</span>:
            <span class="hljs-keyword">return</span> name
        <span class="hljs-keyword">elif</span> m := PATTERN_PROCESS_NAME.<span class="hljs-keyword">match</span>(process_name):
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>-sp<span class="hljs-subst">{m.group(<span class="hljs-number">1</span>)}</span>"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>-<span class="hljs-subst">{pid}</span>"</span>

    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>-<span class="hljs-subst">{os.getpid()}</span>"</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_logpath</span>(<span class="hljs-params">log_dir: <span class="hljs-built_in">str</span>, name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Setup the log path.
    
    Args:
        log_dir (str): The log directory.
        name (str): The name of the log file. Example: "app"

    Returns:
        str: The log path.
    """</span>
    main_name = _get_spawn_process_number(name)
    log_file = <span class="hljs-string">f"<span class="hljs-subst">{main_name}</span>.log"</span>
    log_path = Path(log_dir) / log_file

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> log_path.parent.exists():
        <span class="hljs-keyword">try</span>:
            log_path.parent.mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> RuntimeError(
                <span class="hljs-string">f"Failed to create log directory: <span class="hljs-subst">{log_path.parent}</span>"</span>
            ) <span class="hljs-keyword">from</span> e
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(log_path)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate</span>(<span class="hljs-params">level: <span class="hljs-built_in">int</span>, enable_console: <span class="hljs-built_in">bool</span>, enable_file: <span class="hljs-built_in">bool</span>, rotate_days: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Validate the log configuration.
    
    Args:
        level (int): The logging level.
        enable_console (bool): Whether to enable console logging.
        enable_file (bool): Whether to enable file logging.
        rotate_days (int): The number of days to keep log files.

    Raises:
        ValueError: If the log configuration is invalid.
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> enable_console <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> enable_file:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"At least one of enable_console or enable_file must be True."</span>)

    <span class="hljs-keyword">if</span> level <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [
        logging.DEBUG,
        logging.INFO,
        logging.WARNING,
        logging.ERROR,
        logging.CRITICAL,
    ]:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Invalid logging level specified."</span>)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(rotate_days, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">or</span> rotate_days &lt;= <span class="hljs-number">0</span>:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"rotate_days must be a positive integer."</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_logger</span>(<span class="hljs-params">
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"app"</span>,
    level: <span class="hljs-built_in">int</span> = logging.DEBUG,
    enable_console: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>,
    enable_file: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>,
    log_dir: <span class="hljs-built_in">str</span> = <span class="hljs-string">"logs"</span>,
    rotate_days: <span class="hljs-built_in">int</span> = <span class="hljs-number">7</span>,
</span>) -&gt; logging.Logger:
    <span class="hljs-string">"""Setup a logger with console and/or file handlers.
    
    Args:
        name (str): The name of the logger. This will be used as the log file name prefix. Defaults to "app".
        level (int): The logging level. Defaults to logging.DEBUG.
        enable_console (bool): Whether to enable console logging. Defaults to True.
        enable_file (bool): Whether to enable file logging. Defaults to True.
        log_dir (str): The log directory. Defaults to "logs".
        rotate_days (int): The number of days to keep log files. Defaults to 7.

    Returns:
        logging.Logger: The configured logger.
    """</span>
    logger = logging.getLogger(name)

    <span class="hljs-keyword">if</span> logger.hasHandlers():
        <span class="hljs-keyword">return</span> logger  <span class="hljs-comment"># Logger is already configured</span>

    _validate(level, enable_console, enable_file, rotate_days)

    logger.setLevel(level)
    logger.propagate = <span class="hljs-literal">False</span>  <span class="hljs-comment"># Prevent log messages from being propagated to the root logger</span>

    log_path = _setup_logpath(log_dir, name)

    handlers = []

    <span class="hljs-keyword">if</span> enable_console:
        handlers.append(_setup_console_handler(level))

    <span class="hljs-keyword">if</span> enable_file:
        handlers.append(_setup_file_handler(level, log_path, rotate_days))

    <span class="hljs-keyword">global</span> _queue_logger, _queue_listener
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _queue_logger:
        _queue_logger = Queue(-<span class="hljs-number">1</span>)

    queue_handler = _setup_queue_handler(level, _queue_logger)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _queue_listener:
        _queue_listener = QueueListener(
            _queue_logger, *handlers, respect_handler_level=<span class="hljs-literal">True</span>
        )
        _queue_listener.start()

    logger.addHandler(queue_handler)
    logger.addFilter(TrackingIDFilter())

    <span class="hljs-keyword">return</span> logger


<span class="hljs-keyword">def</span> <span class="hljs-title function_">close_log_queue</span>() -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Close the log queue and stop the listener.
    This function should be called when the application is shutting down to ensure that the log queue is closed and the listener is stopped.
    """</span>
    <span class="hljs-keyword">global</span> _queue_listener
    <span class="hljs-keyword">if</span> _queue_listener:
        _queue_listener.stop()
        _queue_listener = <span class="hljs-literal">None</span>

</code></pre>
<ol start="2">
<li>编辑 <code>pkg/log/__init__.py</code>，便于其它模块导入，个人一般也是通过这个文件告诉别人这个模块哪些对象是 public 的。<code>logger</code> 对象是一个单例，其它模块直接使用即可，一般无需使用 <code>setup_logger</code> 单独创建日志记录器对象。不过有的需求是各个类对象创建各自的日志记录器，所以也对外提供出去了（个人认为没啥必要）。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">from</span> .log <span class="hljs-keyword">import</span> close_log_queue, setup_logger

logger = setup_logger(
    log_dir=<span class="hljs-built_in">str</span>(Path(__file__).parent.parent.parent / <span class="hljs-string">"logs"</span>),
)

__all__ = [
    <span class="hljs-string">"logger"</span>,
    <span class="hljs-string">"setup_logger"</span>,
    <span class="hljs-string">"close_log_queue"</span>,
]

</code></pre>
<ol start="3">
<li>通过 FastAPI 的 lifespan 来调用 <code>close_log_queue</code></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> asynccontextmanager

<span class="hljs-keyword">from</span> pkg.log <span class="hljs-keyword">import</span> close_log_queue

<span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: FastAPI</span>):
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span>
    <span class="hljs-keyword">finally</span>:
        close_log_queue()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Shutdown!"</span>)


app = FastAPI(lifespan=lifespan)
</code></pre>
<ol start="4">
<li>将 <code>print()</code> 改成 <code>logger.info()</code>，测试日志中是否自动输出 <code>tracking_id</code>。其中部分改动如下</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">mock_db_query</span>():
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
    current_id = TRACKING_ID.get()
    logger.info(<span class="hljs-string">f"This is mock_db_query. Current tracking ID: <span class="hljs-subst">{current_id}</span>"</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
</code></pre>
<ol start="5">
<li>使用 curl 测试并查看日志</li>
</ol>
<p>curl 命令输出如下：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -i  http://127.0.0.1:8000/asdf
HTTP/1.1 200 OK
<span class="hljs-built_in">date</span>: Sat, 29 Nov 2025 13:07:09 GMT
content-length: 62
content-type: text/plain; charset=utf-8
x-tracking-id: 38a015f7-b0d3-41ea-a2b3-179bf608b4bb

Get request, tracking ID: 38a015f7-b0d3-41ea-a2b3-179bf608b4bb
</code></pre>
<p>服务端的控制台输出如下：</p>
<pre><code class="hljs language-less" lang="less">{"<span class="hljs-variable">@timestamp</span><span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-attribute">-11-29T21</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09</span>+<span class="hljs-number">0800</span><span class="hljs-string">", "</span>level<span class="hljs-string">": "</span>INFO<span class="hljs-string">", "</span>name<span class="hljs-string">": "</span>app<span class="hljs-string">", "</span>processName<span class="hljs-string">": "</span>SpawnProcess-<span class="hljs-number">3</span><span class="hljs-string">", "</span>tracking_id<span class="hljs-string">": "</span><span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb<span class="hljs-string">", "</span>loc<span class="hljs-string">": "</span>main.<span class="hljs-attribute">py</span>:<span class="hljs-number">39</span><span class="hljs-string">", "</span>func<span class="hljs-string">": "</span>get_asdf<span class="hljs-string">", "</span>message<span class="hljs-string">": "</span>This is get asdf. tracking <span class="hljs-attribute">ID</span>: <span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb"}
{"<span class="hljs-variable">@timestamp</span><span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-attribute">-11-29T21</span>:<span class="hljs-number">07</span>:<span class="hljs-number">10</span>+<span class="hljs-number">0800</span><span class="hljs-string">", "</span>level<span class="hljs-string">": "</span>INFO<span class="hljs-string">", "</span>name<span class="hljs-string">": "</span>app<span class="hljs-string">", "</span>processName<span class="hljs-string">": "</span>SpawnProcess-<span class="hljs-number">3</span><span class="hljs-string">", "</span>tracking_id<span class="hljs-string">": "</span><span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb<span class="hljs-string">", "</span>loc<span class="hljs-string">": "</span>handlers.<span class="hljs-attribute">py</span>:<span class="hljs-number">12</span><span class="hljs-string">", "</span>func<span class="hljs-string">": "</span>mock_db_query<span class="hljs-string">", "</span>message<span class="hljs-string">": "</span>This is mock_db_query. Current tracking <span class="hljs-attribute">ID</span>: <span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb"}
</code></pre>
<p>日志文件输出如下：</p>
<pre><code class="hljs language-less" lang="less">{"<span class="hljs-variable">@timestamp</span><span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-attribute">-11-29T21</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09</span>+<span class="hljs-number">0800</span><span class="hljs-string">", "</span>level<span class="hljs-string">": "</span>INFO<span class="hljs-string">", "</span>name<span class="hljs-string">": "</span>app<span class="hljs-string">", "</span>processName<span class="hljs-string">": "</span>SpawnProcess-<span class="hljs-number">3</span><span class="hljs-string">", "</span>tracking_id<span class="hljs-string">": "</span><span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb<span class="hljs-string">", "</span>loc<span class="hljs-string">": "</span>main.<span class="hljs-attribute">py</span>:<span class="hljs-number">39</span><span class="hljs-string">", "</span>func<span class="hljs-string">": "</span>get_asdf<span class="hljs-string">", "</span>message<span class="hljs-string">": "</span>This is get asdf. tracking <span class="hljs-attribute">ID</span>: <span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb"}
{"<span class="hljs-variable">@timestamp</span><span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-attribute">-11-29T21</span>:<span class="hljs-number">07</span>:<span class="hljs-number">10</span>+<span class="hljs-number">0800</span><span class="hljs-string">", "</span>level<span class="hljs-string">": "</span>INFO<span class="hljs-string">", "</span>name<span class="hljs-string">": "</span>app<span class="hljs-string">", "</span>processName<span class="hljs-string">": "</span>SpawnProcess-<span class="hljs-number">3</span><span class="hljs-string">", "</span>tracking_id<span class="hljs-string">": "</span><span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb<span class="hljs-string">", "</span>loc<span class="hljs-string">": "</span>handlers.<span class="hljs-attribute">py</span>:<span class="hljs-number">12</span><span class="hljs-string">", "</span>func<span class="hljs-string">": "</span>mock_db_query<span class="hljs-string">", "</span>message<span class="hljs-string">": "</span>This is mock_db_query. Current tracking <span class="hljs-attribute">ID</span>: <span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb"}
</code></pre>
<p>根据以上三条输出可见，tracking_id 在日志中和日志消息中保持一致。</p>
<h3 data-id="heading-5">补充: 另一种解决多进程文件写入问题的方法</h3>
<p>费劲调试完上面的日志模块中，想到另一个解决多进程文件写入问题的方法，那就是由外部工具写日志，服务只输出到控制台，类似 docker 和 k8s 运行环境的解决方案。以下只是思路，大致想来应该没什么问题，感兴趣的话可以尝试一下。</p>
<ol>
<li>移除日志模块中的写文件功能，保留输出到控制台的部分。注意标准输出也有可能阻塞异步协程，所以队列处理器还是要保留的。</li>
<li>启动时用 <code>nohup</code> 将控制台输出重定向到文件中。比如：<code>nohup python main.py &gt; logs/start.log 2&gt;&amp;1 &amp;</code></li>
<li>配置 <code>logrotate</code> 来做日志轮转。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go微服务通信优化：从协议选择到性能调优全攻略｜Go语言进阶（20）]]></title>    <link>https://juejin.cn/post/7577683422878056482</link>    <guid>https://juejin.cn/post/7577683422878056482</guid>    <pubDate>2025-11-29T15:14:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577683422878056482" data-draft-id="7577647745110671360" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go微服务通信优化：从协议选择到性能调优全攻略｜Go语言进阶（20）"/> <meta itemprop="keywords" content="后端,Go,微服务"/> <meta itemprop="datePublished" content="2025-11-29T15:14:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="半瓶入梦"/> <meta itemprop="url" content="https://juejin.cn/user/2757990117802792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go微服务通信优化：从协议选择到性能调优全攻略｜Go语言进阶（20）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2757990117802792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    半瓶入梦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:14:48.000Z" title="Sat Nov 29 2025 15:14:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从一次跨城调用的延迟爆炸说起</h2>
<p>去年业务高峰期前，我们的内容分发平台遇到了一个奇怪的问题：跨城服务调用的平均延迟从150ms突然飙升到了800ms，P99更是突破了3秒。一开始团队怀疑是网络抖动，但抓包分析后发现——90%的延迟都花在了TLS握手和连接建立上。原来，随着流量增长，旧的HTTP/1.1客户端连接池配置不合理，导致每秒创建上千个新连接，完全冲垮了TLS握手能力。</p>
<p>这次事件让我们意识到：微服务通信的每一毫秒延迟，都来自于设计细节的堆叠——协议选择、连接复用、超时策略，甚至一个小小的Keep-Alive配置，都会在高并发下被放大成雪崩效应。</p>
<p>Go社区有足够丰富的通信工具，但要把它们拼成既高效又稳健的体系，需要从协议、链路、数据、治理多维度整体思考。本篇我将结合团队近2年的微服务通信优化经验，梳理关键决策点与调优套路，帮你在设计之初就掌握主动权。</p>
<h2 data-id="heading-1">协议选型三要素：效率、生态与演化成本</h2>
<p>选择通信协议时，我们通常会从三个维度权衡：<strong>效率</strong>（延迟、吞吐、带宽）、<strong>生态</strong>（工具链、调试成本、团队熟悉度）、<strong>演化成本</strong>（扩展能力、版本兼容、技术债务）。下面是我们在不同场景下的选型实践：</p>
<h3 data-id="heading-2">HTTP/1.1：老练却需要精细打磨</h3>
<p><strong>我们用它做什么</strong>：与第三方内容平台、数据接口对接，以及面向浏览器的公开 API。</p>
<p><strong>国内框架参考</strong>：</p>
<ul>
<li><strong>Hertz</strong>（<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.cloudwego.io%2Fdocs%2Fhertz%25EF%25BC%259A%25E5%25AD%2597%25E8%258A%2582%25E5%25BC%2580%25E6%25BA%2590%25E7%259A%2584%25E8%25BD%25BB%25E9%2587%258F" target="_blank" title="http://www.cloudwego.io/docs/hertz%EF%BC%9A%E5%AD%97%E8%8A%82%E5%BC%80%E6%BA%90%E7%9A%84%E8%BD%BB%E9%87%8F" ref="nofollow noopener noreferrer">www.cloudwego.io/docs/hertz：…</a> HTTP 框架，适合对性能有较高要求的场景</li>
<li><strong>Kratos</strong>（go-kratos.dev）：B站开源的微服务框架，提供 HTTP 服务组件与中间件生态</li>
</ul>
<p><strong>真实体验</strong>：</p>
<ul>
<li>优势：Postman、curl 调试超方便，Nginx 网关、WAF 等中间件支持完美，团队新人上手快</li>
<li>坑点：在我们的内容系统中，早期因未配置 <code>MaxIdleConnsPerHost</code>，导致对同一个第三方内容平台的并发请求时，每秒创建上百个新连接，TLS 握手延迟占比高达 40%</li>
</ul>
<p><strong>优化实招</strong>：</p>
<ul>
<li>强制开启 <code>Keep-Alive</code>，设置合理的 <code>IdleConnTimeout</code>（我们用 60s）</li>
<li>使用 <code>httptrace.ClientTrace</code> 跟踪每个请求的阶段耗时，发现问题瓶颈</li>
<li>对于固定第三方接口，使用 <code>singleflight.Group</code> 合并相同参数的并发请求（比如查询物流状态）</li>
</ul>
<h3 data-id="heading-3">HTTP/2：并发友好但仍需关注队列</h3>
<p><strong>我们用它做什么</strong>：内部服务间的高频调用，特别是聚合类服务（比如商品详情页需要调用价格、库存、促销等 10+ 个服务）。</p>
<p><strong>真实体验</strong>：</p>
<ul>
<li>优势：多路复用确实解决了 HTTP/1.1 的队头阻塞问题，相同 QPS 下连接数减少了 90%</li>
<li>坑点：在我们的 API 网关中，曾因单连接的 <code>MaxConcurrentStreams</code> 设置过大（默认 250），导致个别慢请求阻塞了整个连接的其他请求</li>
</ul>
<p><strong>优化实招</strong>：</p>
<ul>
<li>在 <code>http2.Server</code> 中设置 <code>MaxConcurrentStreams: 100</code>，避免单连接过载</li>
<li>对于高负载服务，使用客户端负载均衡器（如 <code>grpc-lb</code>）拆分连接到不同实例</li>
<li>监控 <code>inflight</code> 请求数量，当超过阈值时主动触发降级</li>
</ul>
<h3 data-id="heading-4">gRPC：强类型与工具链并重</h3>
<p><strong>我们用它做什么</strong>：核心服务间的高频 RPC 调用，特别是需要 streaming 能力的场景（比如实时内容同步、状态推送）。</p>
<p><strong>国内框架参考</strong>：</p>
<ul>
<li><strong>Kitex</strong>（cloudwego.github.io/kitex）：字节开源的 RPC 框架，支持 gRPC/Thrift，适合高性能 RPC 场景</li>
<li><strong>Kratos</strong>：B站框架，集成 gRPC 与微服务治理能力，提供全链路解决方案</li>
</ul>
<p><strong>真实体验</strong>：</p>
<ul>
<li>优势：ProtoBuf 压缩效率比 JSON 高 60% 以上，自动生成的客户端代码质量高，内置的健康检查、负载均衡等功能省了很多开发量</li>
<li>坑点：调试确实比 HTTP 麻烦，需要用 <code>grpcurl</code> 或专门的 GUI 工具；对网络中间件要求高，我们曾遇到过某些老版本的 F5 负载均衡器不支持 gRPC 的问题</li>
</ul>
<p><strong>推荐开源工具</strong>：</p>
<ul>
<li><code>buf</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fbuf.build%2F)%25EF%25BC%259A%25E6%25AF%2594%25E5%258E%259F%25E7%2594%259F" target="_blank" title="https://buf.build/)%EF%BC%9A%E6%AF%94%E5%8E%9F%E7%94%9F" ref="nofollow noopener noreferrer">buf.build/)：比原生</a> protoc 更好用的 Protobuf 构建工具，支持 lint、breaking change 检查</li>
<li><code>grpc-go</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgrpc%2Fgrpc-go)%25EF%25BC%259A%25E5%25AE%2598%25E6%2596%25B9" target="_blank" title="https://github.com/grpc/grpc-go)%EF%BC%9A%E5%AE%98%E6%96%B9" ref="nofollow noopener noreferrer">github.com/grpc/grpc-g…</a> gRPC 实现，我们一直在用 v1.50+ 版本，稳定性不错</li>
<li><code>grpc-ecosystem/go-grpc-middleware</code>：提供了限流、熔断、日志等实用中间件</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-proto" lang="proto">// api/checkout/v1/service.proto
syntax = "proto3";
package checkout.v1;

option go_package = "github.com/yourcompany/yourproject/api/checkout/v1";

service CheckoutService {
    // 流式下单接口，支持批量提交
    rpc PlaceOrder(stream OrderRequest) returns (OrderResponse);
    // 订单状态查询
    rpc GetStatus(StatusRequest) returns (StatusResponse);
}

message OrderRequest {
    string order_id = 1;
    repeated Item items = 2;
}

message Item {
    string sku = 1;
    int32 quantity = 2;
}

message OrderResponse {
    bool success = 1;
    string order_id = 2;
    string message = 3;
}

message StatusRequest {
    string order_id = 1;
}

message StatusResponse {
    string order_id = 1;
    string status = 2;
    int64 updated_at = 3;
}
</code></pre>
<h3 data-id="heading-5">GraphQL / REST 混合：面向客户端的聚合层</h3>
<p><strong>我们用它做什么</strong>：移动端和 Web 前端的统一 API 层，替代了原来的多个 BFF（Backend for Frontend）。</p>
<p><strong>真实体验</strong>：</p>
<ul>
<li>优势：前端可以按需取数，减少了 70% 的无效数据传输；一个 GraphQL 服务替代了原来的 5 个 BFF 服务</li>
<li>坑点：初期因 Resolver 未并行化，导致某些复杂查询的延迟比 REST 还高</li>
</ul>
<p><strong>优化实招</strong>：</p>
<ul>
<li>使用 <code>graphql-go-tools</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwundergraph%2Fgraphql-go-tools" target="_blank" title="https://github.com/wundergraph/graphql-go-tools" ref="nofollow noopener noreferrer">github.com/wundergraph…</a>) 提高 GraphQL 引擎性能</li>
<li>在 Resolver 内部使用 <code>errgroup.Group</code> 并发调用后端服务</li>
<li>配合 <code>dataloader</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgraph-gophers%2Fdataloader" target="_blank" title="https://github.com/graph-gophers/dataloader" ref="nofollow noopener noreferrer">github.com/graph-gophe…</a>) 批量化相同类型的请求（比如批量查询多个商品的价格）</li>
</ul>
<h3 data-id="heading-6">消息队列 / 事件流：解耦延迟容忍型场景</h3>
<p><strong>我们用它做什么</strong>：异步任务处理（比如内容发布后发送通知、更新统计数据），以及事件驱动的微服务架构。</p>
<p><strong>真实体验</strong>：</p>
<ul>
<li>优势：确实实现了服务解耦，在大促期间，即使通知服务挂了，也不会影响核心的订单流程</li>
<li>坑点：调试和全链路追踪比较麻烦，我们曾遇到过消息丢失但很难定位原因的情况</li>
</ul>
<p><strong>推荐开源工具</strong>：</p>
<ul>
<li><code>sarama</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FShopify%2Fsarama)%25EF%25BC%259AGo" target="_blank" title="https://github.com/Shopify/sarama)%EF%BC%9AGo" ref="nofollow noopener noreferrer">github.com/Shopify/sar…</a> 语言中最成熟的 Kafka 客户端，我们用它处理每天数十亿的消息</li>
<li><code>nats.go</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnats-io%2Fnats.go)%25EF%25BC%259A%25E8%25BD%25BB%25E9%2587%258F%25E7%25BA%25A7%25E7%259A%2584%25E6%25B6%2588%25E6%2581%25AF%25E9%2598%259F%25E5%2588%2597%25EF%25BC%258C%25E9%2580%2582%25E5%2590%2588%25E5%25BB%25B6%25E8%25BF%259F%25E6%2595%258F%25E6%2584%259F%25E7%259A%2584%25E5%259C%25BA%25E6%2599%25AF" target="_blank" title="https://github.com/nats-io/nats.go)%EF%BC%9A%E8%BD%BB%E9%87%8F%E7%BA%A7%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8C%E9%80%82%E5%90%88%E5%BB%B6%E8%BF%9F%E6%95%8F%E6%84%9F%E7%9A%84%E5%9C%BA%E6%99%AF" ref="nofollow noopener noreferrer">github.com/nats-io/nat…</a></li>
<li><code>watermill</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FThreeDotsLabs%2Fwatermill)%25EF%25BC%259AGo" target="_blank" title="https://github.com/ThreeDotsLabs/watermill)%EF%BC%9AGo" ref="nofollow noopener noreferrer">github.com/ThreeDotsLa…</a> 语言的事件驱动框架，支持多种消息队列后端</li>
</ul>
<p><strong>优化实招</strong>：</p>
<ul>
<li>明确定义投递语义（我们在核心业务中使用至少一次投递）</li>
<li>实现死信队列，处理消费失败的消息</li>
<li>监控消费 Lag，当 Lag 超过阈值时触发告警和扩容</li>
</ul>
<h2 data-id="heading-7">连接与传输策略：让链路保持“温热”</h2>
<p>连接管理是微服务通信性能的基石。我们的经验是：<strong>连接池配置的好坏，直接决定了系统在高并发下的稳定性</strong>。</p>
<h3 data-id="heading-8">HTTP 客户端：善用 <code>http.Transport</code></h3>
<p><strong>我们的配置实践</strong>：</p>
<p><strong>框架工具参考</strong>：</p>
<ul>
<li><strong>Hertz</strong> 与 <strong>Kratos</strong> 都提供了优化的 HTTP 客户端实现，内置连接池管理与服务发现能力</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Hertz 客户端示例（需导入 time 包）</span>
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"time"</span>
    <span class="hljs-string">"github.com/cloudwego/hertz/client"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewHertzClient</span><span class="hljs-params">()</span></span> client.Client {
    c, _ := client.NewClient(
        client.WithTimeout(<span class="hljs-number">800</span>*time.Millisecond),
        client.WithMaxConnsPerHost(<span class="hljs-number">100</span>),
        client.WithMaxIdleConnsPerHost(<span class="hljs-number">50</span>),
        client.WithIdleConnTimeout(<span class="hljs-number">60</span>*time.Second),
    )
    <span class="hljs-keyword">return</span> c
}
</code></pre>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 创建一个高性能的 HTTP 客户端</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewHTTPClient</span><span class="hljs-params">()</span></span> *http.Client {
    <span class="hljs-keyword">return</span> &amp;http.Client{
        Timeout: <span class="hljs-number">800</span> * time.Millisecond, <span class="hljs-comment">// 总超时控制</span>
        Transport: &amp;http.Transport{
            <span class="hljs-comment">// 连接池配置</span>
            MaxIdleConns:        <span class="hljs-number">1000</span>,    <span class="hljs-comment">// 全局最大空闲连接数</span>
            MaxIdleConnsPerHost: <span class="hljs-number">100</span>,     <span class="hljs-comment">// 每个主机的最大空闲连接数</span>
            IdleConnTimeout:     <span class="hljs-number">60</span> * time.Second, <span class="hljs-comment">// 空闲连接超时时间</span>
            
            <span class="hljs-comment">// 连接建立相关</span>
            TLSHandshakeTimeout:   <span class="hljs-number">300</span> * time.Millisecond, <span class="hljs-comment">// TLS 握手超时</span>
            ExpectContinueTimeout: <span class="hljs-number">100</span> * time.Millisecond, <span class="hljs-comment">// 100-continue 超时</span>
            DialContext: (&amp;net.Dialer{
                Timeout:   <span class="hljs-number">500</span> * time.Millisecond, <span class="hljs-comment">// 连接建立超时</span>
                KeepAlive: <span class="hljs-number">60</span> * time.Second,       <span class="hljs-comment">// TCP Keep-Alive</span>
                DualStack: <span class="hljs-literal">true</span>,                   <span class="hljs-comment">// 支持 IPv4/IPv6</span>
            }).DialContext,
        },
    }
}
</code></pre>
<p><strong>真实踩坑经验</strong>：</p>
<ul>
<li>早期我们将 <code>MaxIdleConnsPerHost</code> 设置为 10，结果在峰值 QPS 达到 1000 时，每秒创建了 100 个新连接，TLS 握手延迟飙升</li>
<li>后来根据公式 <code>MaxIdleConnsPerHost = 峰值 QPS × 平均响应时间</code>，计算出需要 100 左右，调整后连接复用率从 30% 提升到了 90%</li>
</ul>
<p><strong>进阶优化</strong>：</p>
<ol>
<li>
<p><strong>自定义 DNS 缓存</strong>（解决 DNS 解析延迟问题）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 简单的 DNS 缓存实现</span>
<span class="hljs-keyword">type</span> DNSCache <span class="hljs-keyword">struct</span> {
    cache <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]net.IP
    mu    sync.RWMutex
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *DNSCache)</span></span> LookupIP(host <span class="hljs-type">string</span>) ([]net.IP, <span class="hljs-type">error</span>) {
    c.mu.RLock()
    ips, ok := c.cache[host]
    c.mu.RUnlock()
    <span class="hljs-keyword">if</span> ok {
        <span class="hljs-keyword">return</span> ips, <span class="hljs-literal">nil</span>
    }
    
    ips, err := net.LookupIP(host)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    c.mu.Lock()
    c.cache[host] = ips
    c.mu.Unlock()
    <span class="hljs-keyword">return</span> ips, <span class="hljs-literal">nil</span>
}
</code></pre>
</li>
<li>
<p><strong>使用 <code>httptrace</code> 分析请求阶段耗时</strong>：</p>
<pre><code class="hljs language-go" lang="go">trace := &amp;httptrace.ClientTrace{
    ConnectStart: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(network, addr <span class="hljs-type">string</span>)</span></span> {
        fmt.Printf(<span class="hljs-string">"ConnectStart: %s %s\n"</span>, network, addr)
    },
    ConnectDone: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(network, addr <span class="hljs-type">string</span>, err <span class="hljs-type">error</span>)</span></span> {
        fmt.Printf(<span class="hljs-string">"ConnectDone: %s %s, err: %v\n"</span>, network, addr, err)
    },
    TLSHandshakeStart: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        fmt.Println(<span class="hljs-string">"TLSHandshakeStart"</span>)
    },
    TLSHandshakeDone: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cs tls.ConnectionState, err <span class="hljs-type">error</span>)</span></span> {
        fmt.Printf(<span class="hljs-string">"TLSHandshakeDone: err: %v\n"</span>, err)
    },
    GotFirstResponseByte: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        fmt.Println(<span class="hljs-string">"GotFirstResponseByte"</span>)
    },
}

req, _ := http.NewRequest(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"https://example.com"</span>, <span class="hljs-literal">nil</span>)
req = req.WithContext(httptrace.WithClientTrace(req.Context(), trace))
</code></pre>
</li>
</ol>
<h3 data-id="heading-9">gRPC 连接：重用 + 背压</h3>
<p><strong>我们的配置实践</strong>：</p>
<p><strong>框架工具参考</strong>：</p>
<ul>
<li><strong>Kitex</strong> 与 <strong>Kratos</strong> 都提供了封装好的 gRPC 客户端，简化了连接池与负载均衡配置</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Kitex 客户端示例</span>
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"time"</span>
    <span class="hljs-string">"github.com/cloudwego/kitex/client"</span>
    <span class="hljs-string">"github.com/cloudwego/kitex/pkg/rpcinfo"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewKitexClient</span><span class="hljs-params">()</span></span> (YourServiceClient, <span class="hljs-type">error</span>) {
    c, err := NewClient(
        <span class="hljs-string">"your.service"</span>,
        client.WithHostPorts(<span class="hljs-string">"127.0.0.1:8888"</span>),
        client.WithRPCTimeout(<span class="hljs-number">500</span>*time.Millisecond),
        client.WithConnectTimeout(<span class="hljs-number">200</span>*time.Millisecond),
        client.WithClientBasicInfo(&amp;rpcinfo.EndpointBasicInfo{ServiceName: <span class="hljs-string">"your-client"</span>}),
    )
    <span class="hljs-keyword">return</span> c, err
}
</code></pre>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 创建一个高性能的 gRPC 客户端连接</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewGRPCClient</span><span class="hljs-params">(addr <span class="hljs-type">string</span>)</span></span> (*grpc.ClientConn, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">return</span> grpc.Dial(addr, 
        grpc.WithTransportCredentials(insecure.NewCredentials()),
        grpc.WithKeepaliveParams(keepalive.ClientParameters{
            Time:                <span class="hljs-number">30</span> * time.Second,    <span class="hljs-comment">// 发送 keepalive 的时间间隔</span>
            Timeout:             <span class="hljs-number">5</span> * time.Second,     <span class="hljs-comment">// keepalive 超时时间</span>
            PermitWithoutStream: <span class="hljs-literal">true</span>,                <span class="hljs-comment">// 即使没有活跃流也发送 keepalive</span>
        }),
        grpc.WithDefaultCallOptions(
            grpc.MaxCallRecvMsgSize(<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">10</span>),   <span class="hljs-comment">// 最大接收消息大小（10MB）</span>
            grpc.MaxCallSendMsgSize(<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">10</span>),   <span class="hljs-comment">// 最大发送消息大小（10MB）</span>
        ),
        grpc.WithInitialWindowSize(<span class="hljs-number">65535</span>*<span class="hljs-number">10</span>),        <span class="hljs-comment">// 初始窗口大小</span>
        grpc.WithInitialConnWindowSize(<span class="hljs-number">65535</span>*<span class="hljs-number">100</span>),   <span class="hljs-comment">// 初始连接窗口大小</span>
    )
}
</code></pre>
<p><strong>真实调优经验</strong>：</p>
<ul>
<li>在我们的实时推荐系统中，曾因 gRPC 流控制配置不当，导致单流写满缓冲后阻塞了其他请求</li>
<li>通过监控 <code>sent/recv message per stream</code> 指标，我们发现问题并调整了窗口大小，最终将 P99 延迟降低了 40%</li>
</ul>
<p><strong>背压实现</strong>：</p>
<ul>
<li>使用 <code>grpc-go</code> 的流控制机制，监控 <code>inflight</code> 请求数量</li>
<li>当 <code>inflight</code> 请求超过阈值时，主动拒绝新请求或触发降级</li>
</ul>
<h3 data-id="heading-10">服务端调优：多路复用 + 零拷贝</h3>
<p><strong>HTTP/2 服务端配置</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 创建一个高性能的 HTTP/2 服务器</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewHTTP2Server</span><span class="hljs-params">()</span></span> *http.Server {
    <span class="hljs-keyword">return</span> &amp;http.Server{
        Addr: <span class="hljs-string">":8080"</span>,
        Handler: http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
            <span class="hljs-comment">// 处理请求</span>
        }),
        TLSConfig: &amp;tls.Config{
            MinVersion: tls.VersionTLS12,
            <span class="hljs-comment">// 启用 HTTP/2</span>
            NextProtos: []<span class="hljs-type">string</span>{<span class="hljs-string">"h2"</span>, <span class="hljs-string">"http/1.1"</span>},
        },
        ReadHeaderTimeout: <span class="hljs-number">500</span> * time.Millisecond,
        ReadTimeout:       <span class="hljs-number">2</span> * time.Second,
        WriteTimeout:      <span class="hljs-number">2</span> * time.Second,
        IdleTimeout:       <span class="hljs-number">60</span> * time.Second,
    }
}
</code></pre>
<p><strong>零拷贝实践</strong>：</p>
<ul>
<li>在我们的静态资源服务中，使用 <code>io.Copy</code> 代替手动读写，触发内核零拷贝</li>
<li>对于大文件传输，使用 <code>http.ServeFile</code> 或 <code>http.ServeContent</code>，它们内部会使用 <code>sendfile</code> 系统调用</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 零拷贝传输文件</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">serveFile</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
    file, err := os.Open(<span class="hljs-string">"path/to/file"</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        http.Error(w, <span class="hljs-string">"File not found"</span>, http.StatusNotFound)
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">defer</span> file.Close()
    
    stat, _ := file.Stat()
    w.Header().Set(<span class="hljs-string">"Content-Length"</span>, strconv.FormatInt(stat.Size(), <span class="hljs-number">10</span>))
    w.Header().Set(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/octet-stream"</span>)
    
    <span class="hljs-comment">// 使用 io.Copy 触发零拷贝</span>
    io.Copy(w, file)
}
</code></pre>
<p><strong>防御慢客户端</strong>：</p>
<ul>
<li>设置 <code>ReadIdleTimeout</code> 关闭长时间空闲的连接</li>
<li>使用 <code>http.MaxBytesReader</code> 限制请求体大小，防止内存溢出</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 限制请求体大小为 1MB</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">limitRequestBody</span><span class="hljs-params">(next http.Handler)</span></span> http.Handler {
    <span class="hljs-keyword">return</span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
        r.Body = http.MaxBytesReader(w, r.Body, <span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>)
        next.ServeHTTP(w, r)
    })
}
</code></pre>
<h2 data-id="heading-11">数据编码与负载裁剪：传得快还要传得准</h2>
<p>数据编码是通信性能的另一个关键因素。我们的原则是：<strong>只传需要的，压缩能压缩的，选择高效的序列化格式</strong>。</p>
<h3 data-id="heading-12">序列化格式选择：没有银弹，只有最合适</h3>
<p><strong>我们的选型实践</strong>：</p>






























<table><thead><tr><th>场景</th><th>推荐格式</th><th>真实效果</th></tr></thead><tbody><tr><td>核心服务间高频调用</td><td>ProtoBuf</td><td>比 JSON 小 60%，序列化速度快 3-5 倍</td></tr><tr><td>面向前端的 API</td><td>JSON + 字段裁剪</td><td>平衡了灵活性和性能</td></tr><tr><td>对延迟极端敏感的场景</td><td>FlatBuffers</td><td>无需解析，直接内存访问，延迟降低 50%</td></tr><tr><td>配置文件</td><td>JSON/YAML</td><td>可读性优先，维护成本低</td></tr></tbody></table>
<p><strong>开源工具推荐</strong>：</p>
<ul>
<li><code>github.com/json-iterator/go</code>（jsoniter）：比标准库 <code>encoding/json</code> 快 2-3 倍，API 兼容</li>
<li><code>github.com/bytedance/sonic</code>：字节跳动开源的 JSON 库，比 jsoniter 更快（但 API 不完全兼容）</li>
<li><code>github.com/golang/protobuf</code>：官方 ProtoBuf 库</li>
<li><code>github.com/google/flatbuffers/go</code>：FlatBuffers 的 Go 实现</li>
</ul>
<h3 data-id="heading-13">字段裁剪：只传需要的数据</h3>
<p><strong>ProtoBuf 中的字段裁剪</strong>：</p>
<ul>
<li>使用 <code>oneof</code> 代替可选字段，减少编码开销</li>
<li>使用 <code>map</code> 存储动态字段，避免定义过多可选字段</li>
<li>在 <code>.proto</code> 文件中使用 <code>reserved</code> 标记不再使用的字段，防止误用</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-proto" lang="proto">// 不推荐：过多可选字段
message User {
    string id = 1;
    string name = 2;
    optional int32 age = 3;
    optional string email = 4;
    optional string phone = 5;
    // ... 更多可选字段
}

// 推荐：使用 oneof 和 map
message User {
    string id = 1;
    string name = 2;
    oneof contact {
        string email = 3;
        string phone = 4;
    }
    map&lt;string, string&gt; extra_info = 5;
}
</code></pre>
<p><strong>REST API 中的字段裁剪</strong>：</p>
<ul>
<li>支持 <code>fields=id,name,email</code> 查询参数，只返回指定字段</li>
<li>在我们的用户中心 API 中，实现字段裁剪后，响应大小减少了 40%，QPS 提升了 25%</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 字段裁剪中间件</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fieldSelector</span><span class="hljs-params">(next http.Handler)</span></span> http.Handler {
    <span class="hljs-keyword">return</span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
        fields := r.URL.Query().Get(<span class="hljs-string">"fields"</span>)
        <span class="hljs-keyword">if</span> fields == <span class="hljs-string">""</span> {
            next.ServeHTTP(w, r)
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// 记录需要返回的字段</span>
        requiredFields := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)
        <span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> strings.Split(fields, <span class="hljs-string">","</span>) {
            requiredFields[strings.TrimSpace(field)] = <span class="hljs-literal">true</span>
        }
        
        <span class="hljs-comment">// 使用自定义 ResponseWriter 拦截响应并裁剪字段</span>
        crw := &amp;customResponseWriter{ResponseWriter: w, fields: requiredFields}
        next.ServeHTTP(crw, r)
    })
}
</code></pre>
<h3 data-id="heading-14">压缩策略：平衡CPU和带宽</h3>
<p><strong>我们的压缩实践</strong>：</p>
<ul>
<li>对于小于 1KB 的消息，不启用压缩（压缩开销可能超过收益）</li>
<li>对于大于 1KB 的消息，使用 gzip 或 brotli 压缩</li>
<li>在 gRPC 中，使用 <code>grpc.UseCompressor("gzip")</code> 启用压缩</li>
</ul>
<p><strong>gRPC 压缩配置</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 客户端启用 gzip 压缩</span>
conn, err := grpc.Dial(addr, 
    grpc.WithTransportCredentials(insecure.NewCredentials()),
    grpc.WithDefaultCallOptions(
        grpc.UseCompressor(<span class="hljs-string">"gzip"</span>),
        grpc.MaxCallRecvMsgSize(<span class="hljs-number">10</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>),
    ),
)

<span class="hljs-comment">// 服务端启用 gzip 压缩</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"google.golang.org/grpc/encoding/gzip"</span>

srv := grpc.NewServer(
    grpc.RPCCompressor(gzip.GzipCompressor),
)
</code></pre>
<p><strong>HTTP 压缩配置</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 使用 net/http 启用 gzip 压缩</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/klauspost/compress/gzhttp"</span>

mux := http.NewServeMux()
mux.HandleFunc(<span class="hljs-string">"/"</span>, handler)

<span class="hljs-comment">// 使用 gzhttp 包装 handler，自动处理压缩</span>
compressedHandler := gzhttp.GzipHandler(mux)

srv := &amp;http.Server{
    Addr:    <span class="hljs-string">":8080"</span>,
    Handler: compressedHandler,
}
</code></pre>
<h3 data-id="heading-15">序列化缓存：避免重复工作</h3>
<p><strong>我们的缓存实践</strong>：</p>
<ul>
<li>在热路径上，缓存序列化后的 <code>[]byte</code> 结果</li>
<li>使用 <code>sync.Pool</code> 复用序列化缓冲区，减少内存分配</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 缓存序列化结果</span>
<span class="hljs-keyword">type</span> CachedSerializer <span class="hljs-keyword">struct</span> {
    cache sync.Map <span class="hljs-comment">// key: 结构体指针, value: []byte</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cs *CachedSerializer)</span></span> Marshal(v <span class="hljs-keyword">interface</span>{}) ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) {
    key := reflect.ValueOf(v).Pointer()
    <span class="hljs-keyword">if</span> data, ok := cs.cache.Load(key); ok {
        <span class="hljs-keyword">return</span> data.([]<span class="hljs-type">byte</span>), <span class="hljs-literal">nil</span>
    }
    
    data, err := jsoniter.Marshal(v)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    cs.cache.Store(key, data)
    <span class="hljs-keyword">return</span> data, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 使用 sync.Pool 复用缓冲区</span>
<span class="hljs-keyword">var</span> bufferPool = sync.Pool{
    New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">interface</span>{} {
        <span class="hljs-keyword">return</span> &amp;bytes.Buffer{}
    },
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MarshalWithPool</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>{})</span></span> ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) {
    buf := bufferPool.Get().(*bytes.Buffer)
    buf.Reset()
    <span class="hljs-keyword">defer</span> bufferPool.Put(buf)
    
    <span class="hljs-keyword">if</span> err := jsoniter.NewEncoder(buf).Encode(v); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">append</span>([]<span class="hljs-type">byte</span>{}, buf.Bytes()...), <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-16">幂等设计：避免重试副作用</h3>
<p><strong>我们的幂等实践</strong>：</p>
<ul>
<li>所有写操作都必须支持幂等</li>
<li>使用业务幂等键（如内容ID、请求流水号）确保重复请求不会产生副作用</li>
<li>在服务端使用 Redis <code>SETNX</code> 或数据库唯一约束实现幂等性</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 幂等处理器</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">idempotentHandler</span><span class="hljs-params">(redisClient *redis.Client)</span></span> http.HandlerFunc {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
        <span class="hljs-comment">// 从请求头获取幂等键</span>
        idempotencyKey := r.Header.Get(<span class="hljs-string">"X-Idempotency-Key"</span>)
        <span class="hljs-keyword">if</span> idempotencyKey == <span class="hljs-string">""</span> {
            http.Error(w, <span class="hljs-string">"Missing X-Idempotency-Key"</span>, http.StatusBadRequest)
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// 检查是否已经处理过</span>
        key := fmt.Sprintf(<span class="hljs-string">"idempotent:%s"</span>, idempotencyKey)
        exists, err := redisClient.Exists(r.Context(), key).Result()
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            http.Error(w, <span class="hljs-string">"Internal Server Error"</span>, http.StatusInternalServerError)
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-keyword">if</span> exists == <span class="hljs-number">1</span> {
            <span class="hljs-comment">// 已经处理过，直接返回结果</span>
            w.WriteHeader(http.StatusOK)
            w.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">"Already processed"</span>))
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// 执行实际业务逻辑</span>
        <span class="hljs-comment">// ...</span>
        
        <span class="hljs-comment">// 标记为已处理，设置过期时间</span>
        redisClient.Set(r.Context(), key, <span class="hljs-string">"processed"</span>, <span class="hljs-number">24</span>*time.Hour)
        
        w.WriteHeader(http.StatusOK)
        w.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">"Success"</span>))
    }
}
</code></pre>
<h2 data-id="heading-17">调优四象限：延迟、吞吐、成本、可靠性</h2>
<p>在实际调优中，我们发现延迟、吞吐、成本和可靠性往往相互制约。以下是我们在实践中总结的调优指南，包含真实案例和可操作的建议。</p>
<h3 data-id="heading-18">延迟优化：从毫秒到微秒的突破</h3>
<p><strong>核心思路</strong>：减少网络往返、优化协议栈、降低序列化开销。</p>
<p><strong>我们的延迟优化实践</strong>：</p>



































<table><thead><tr><th>优化项</th><th>具体措施</th><th>真实效果</th></tr></thead><tbody><tr><td>协议升级</td><td>从 HTTP/1.1 升级到 gRPC</td><td>延迟降低 40%</td></tr><tr><td>连接复用</td><td>优化 HTTP 连接池配置</td><td>TLS 握手次数减少 95%</td></tr><tr><td>序列化优化</td><td>从 JSON 切换到 ProtoBuf</td><td>序列化时间减少 70%</td></tr><tr><td>中间件优化</td><td>移除不必要的调试中间件</td><td>延迟降低 15%</td></tr><tr><td>地域优化</td><td>避免跨 AZ 调用</td><td>延迟降低 30%</td></tr></tbody></table>
<p><strong>代码示例：设置合理的超时</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 使用 context.WithTimeout 设置调用超时</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">callService</span><span class="hljs-params">(ctx context.Context, client ServiceClient, req *Request)</span></span> (*Response, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 设置 500ms 超时</span>
    timeoutCtx, cancel := context.WithTimeout(ctx, <span class="hljs-number">500</span>*time.Millisecond)
    <span class="hljs-keyword">defer</span> cancel()
    
    <span class="hljs-comment">// 在新的超时上下文下执行调用</span>
    <span class="hljs-keyword">return</span> client.Call(timeoutCtx, req)
}

<span class="hljs-comment">// 优化 gRPC 客户端延迟配置</span>
conn, err := grpc.Dial(addr, 
    grpc.WithTransportCredentials(insecure.NewCredentials()),
    grpc.WithDefaultCallOptions(
        grpc.WaitForReady(<span class="hljs-literal">true</span>), <span class="hljs-comment">// 等待服务就绪</span>
        grpc.PerRPCCredentials(credentials.NewTLS(tlsConfig)),
        grpc.WithCompressor(<span class="hljs-string">"gzip"</span>),
    ),
    grpc.WithUnaryInterceptor(grpc_retry.UnaryClientInterceptor(
        grpc_retry.WithMax(<span class="hljs-number">3</span>),
        grpc_retry.WithBackoff(grpc_retry.BackoffExponential(<span class="hljs-number">100</span>*time.Millisecond)),
    )),
)
</code></pre>
<h3 data-id="heading-19">吞吐优化：从千级到万级的跨越</h3>
<p><strong>核心思路</strong>：增加并发度、优化资源利用、减少锁竞争。</p>
<p><strong>我们的吞吐优化实践</strong>：</p>



































<table><thead><tr><th>优化项</th><th>具体措施</th><th>真实效果</th></tr></thead><tbody><tr><td>连接池扩容</td><td>调大 <code>MaxIdleConns</code> 和 <code>MaxConnsPerHost</code></td><td>QPS 提升 150%</td></tr><tr><td>并行度调优</td><td>使用 <code>errgroup</code> 并发处理请求</td><td>吞吐量提升 200%</td></tr><tr><td>负载均衡</td><td>从轮询切换到一致性哈希</td><td>热点分布更均匀</td></tr><tr><td>内存优化</td><td>使用 <code>sync.Pool</code> 复用对象</td><td>GC 耗时减少 60%</td></tr><tr><td>请求合并</td><td>实现批量 API</td><td>网络往返减少 70%</td></tr></tbody></table>
<p><strong>代码示例：使用 errgroup 并发处理请求</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"golang.org/x/sync/errgroup"</span>

<span class="hljs-comment">// 并发调用多个服务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">batchCallServices</span><span class="hljs-params">(ctx context.Context, clients []ServiceClient, reqs []*Request)</span></span> ([]*Response, <span class="hljs-type">error</span>) {
    g, gCtx := errgroup.WithContext(ctx)
    respCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Response, <span class="hljs-built_in">len</span>(reqs))
    
    <span class="hljs-keyword">for</span> i, client := <span class="hljs-keyword">range</span> clients {
        req := reqs[i]
        g.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
            resp, err := client.Call(gCtx, req)
            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                <span class="hljs-keyword">return</span> err
            }
            respCh &lt;- resp
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        })
    }
    
    <span class="hljs-keyword">if</span> err := g.Wait(); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-built_in">close</span>(respCh)
    
    <span class="hljs-keyword">var</span> resps []*Response
    <span class="hljs-keyword">for</span> resp := <span class="hljs-keyword">range</span> respCh {
        resps = <span class="hljs-built_in">append</span>(resps, resp)
    }
    
    <span class="hljs-keyword">return</span> resps, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-20">成本优化：用最少的资源办最多的事</h3>
<p><strong>核心思路</strong>：动态资源调整、请求合并、资源复用。</p>
<p><strong>我们的成本优化实践</strong>：</p>



































<table><thead><tr><th>优化项</th><th>具体措施</th><th>真实效果</th></tr></thead><tbody><tr><td>动态连接池</td><td>根据负载调整连接数</td><td>资源利用率提升 80%</td></tr><tr><td>请求合并</td><td>实现批量查询 API</td><td>网络成本降低 60%</td></tr><tr><td>资源复用</td><td>使用 <code>sync.Pool</code> 复用缓冲区</td><td>内存占用减少 40%</td></tr><tr><td>低峰期缩容</td><td>按业务低峰期释放资源</td><td>服务器成本降低 30%</td></tr><tr><td>批量处理</td><td>实现异步批量任务</td><td>计算资源利用率提升 70%</td></tr></tbody></table>
<p><strong>代码示例：动态调整连接池大小</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 动态连接池</span>
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"log"</span>
    <span class="hljs-string">"net/http"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
    <span class="hljs-string">"golang.org/x/time/rate"</span>
)

<span class="hljs-keyword">type</span> DynamicConnectionPool <span class="hljs-keyword">struct</span> {
    pool          *http.Client
    limiter       *rate.Limiter
    maxConn       <span class="hljs-type">int</span>
    currentConn   <span class="hljs-type">int</span>
    mu            sync.Mutex
    lastAdjustTime time.Time
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDynamicConnectionPool</span><span class="hljs-params">(maxConn <span class="hljs-type">int</span>)</span></span> *DynamicConnectionPool {
    <span class="hljs-keyword">return</span> &amp;DynamicConnectionPool{
        pool: &amp;http.Client{
            Transport: &amp;http.Transport{
                MaxIdleConns:        maxConn,
                MaxIdleConnsPerHost: maxConn,
            },
        },
        limiter:       rate.NewLimiter(rate.Limit(maxConn), maxConn),
        maxConn:       maxConn,
        currentConn:   maxConn / <span class="hljs-number">2</span>, <span class="hljs-comment">// 初始为最大连接数的一半</span>
        lastAdjustTime: time.Now(),
    }
}

<span class="hljs-comment">// 动态调整连接池大小</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *DynamicConnectionPool)</span></span> adjustPoolSize() {
    p.mu.Lock()
    <span class="hljs-keyword">defer</span> p.mu.Unlock()
    
    <span class="hljs-comment">// 每 5 分钟调整一次</span>
    <span class="hljs-keyword">if</span> time.Since(p.lastAdjustTime) &lt; <span class="hljs-number">5</span>*time.Minute {
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// 根据最近的请求速率调整连接池大小</span>
    <span class="hljs-comment">// 这里简化处理，实际应该根据历史监控数据</span>
    currentRate := p.limiter.Limit()
    newConn := <span class="hljs-type">int</span>(currentRate * <span class="hljs-number">1.5</span>)
    <span class="hljs-keyword">if</span> newConn &gt; p.maxConn {
        newConn = p.maxConn
    }
    <span class="hljs-keyword">if</span> newConn &lt; <span class="hljs-number">10</span> {
        newConn = <span class="hljs-number">10</span>
    }
    
    p.currentConn = newConn
    p.limiter.SetLimit(rate.Limit(newConn))
    
    <span class="hljs-comment">// 更新连接池配置</span>
    transport := p.pool.Transport.(*http.Transport)
    transport.MaxIdleConns = newConn
    transport.MaxIdleConnsPerHost = newConn
    
    p.lastAdjustTime = time.Now()
    log.Printf(<span class="hljs-string">"Adjusted connection pool size from %d to %d"</span>, <span class="hljs-type">int</span>(currentRate), newConn)
}
</code></pre>
<h3 data-id="heading-21">可靠性优化：从可用到高可用的蜕变</h3>
<p><strong>核心思路</strong>：超时控制、重试策略、熔断降级、监控告警。</p>
<p><strong>我们的可靠性优化实践</strong>：</p>



































<table><thead><tr><th>优化项</th><th>具体措施</th><th>真实效果</th></tr></thead><tbody><tr><td>超时控制</td><td>为所有外部调用设置合理超时</td><td>错误率降低 80%</td></tr><tr><td>重试策略</td><td>实现指数退避重试</td><td>成功重试率提升 70%</td></tr><tr><td>熔断降级</td><td>使用 <code>hystrix-go</code> 实现熔断</td><td>雪崩效应完全避免</td></tr><tr><td>监控告警</td><td>监控 P99 延迟和错误率</td><td>故障发现时间缩短 90%</td></tr><tr><td>限流保护</td><td>实现令牌桶限流</td><td>服务可用性提升到 99.99%</td></tr></tbody></table>
<p><strong>代码示例：使用 hystrix-go 实现熔断</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/afex/hystrix-go/hystrix"</span>

<span class="hljs-comment">// 初始化熔断器</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initHystrix</span><span class="hljs-params">()</span></span> {
    hystrix.ConfigureCommand(<span class="hljs-string">"service-call"</span>, hystrix.CommandConfig{
        Timeout:                <span class="hljs-number">500</span>,   <span class="hljs-comment">// 500ms 超时</span>
        MaxConcurrentRequests:  <span class="hljs-number">100</span>,   <span class="hljs-comment">// 最大并发请求数</span>
        RequestVolumeThreshold: <span class="hljs-number">20</span>,    <span class="hljs-comment">// 20 个请求才触发统计</span>
        SleepWindow:            <span class="hljs-number">5000</span>,  <span class="hljs-comment">// 5 秒后尝试半开</span>
        ErrorPercentThreshold:  <span class="hljs-number">50</span>,    <span class="hljs-comment">// 错误率超过 50% 触发熔断</span>
    })
}

<span class="hljs-comment">// 使用熔断器包装服务调用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">callServiceWithCircuitBreaker</span><span class="hljs-params">(ctx context.Context, client ServiceClient, req *Request)</span></span> (*Response, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">var</span> resp *Response
    err := hystrix.Do(<span class="hljs-string">"service-call"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
        <span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>
        resp, err = client.Call(ctx, req)
        <span class="hljs-keyword">return</span> err
    }, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">error</span> {
        <span class="hljs-comment">// 降级逻辑：返回默认值或错误</span>
        log.Printf(<span class="hljs-string">"Circuit breaker open, returning fallback: %v"</span>, err)
        <span class="hljs-keyword">return</span> err
    })
    
    <span class="hljs-keyword">return</span> resp, err
}

<span class="hljs-comment">// 使用令牌桶实现限流</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"golang.org/x/time/rate"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rateLimitMiddleware</span><span class="hljs-params">(limiter *rate.Limiter)</span></span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(http.Handler)</span></span> http.Handler {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(next http.Handler)</span></span> http.Handler {
        <span class="hljs-keyword">return</span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
            <span class="hljs-keyword">if</span> !limiter.Allow() {
                http.Error(w, <span class="hljs-string">"Too Many Requests"</span>, http.StatusTooManyRequests)
                <span class="hljs-keyword">return</span>
            }
            next.ServeHTTP(w, r)
        })
    }
}
</code></pre>
<h2 data-id="heading-22">工程治理：观测、灰度与流量控制</h2>
<p>工程治理是通信优化的重要保障，它让我们能够发现问题、验证优化效果并确保服务的稳定性。以下是我们在实践中总结的治理经验。</p>
<h3 data-id="heading-23">监控指标：让性能可视化</h3>
<p><strong>核心指标体系</strong>：</p>
<p><strong>框架监控支持</strong>：</p>
<ul>
<li>国内主流框架都提供了与 Prometheus、Jaeger 等监控系统的集成能力</li>
<li><strong>Kitex</strong> 内置 RPC 相关指标收集，<strong>Kratos</strong> 提供统一的指标组件</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Kratos 监控指标示例</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/go-kratos/kratos/v2/metrics"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initMetrics</span><span class="hljs-params">()</span></span> {
    requestCounter := metrics.NewCounter(
        <span class="hljs-string">"http_request_total"</span>,
        metrics.WithLabels(<span class="hljs-string">"method"</span>, <span class="hljs-string">"path"</span>, <span class="hljs-string">"status"</span>),
        metrics.WithDescription(<span class="hljs-string">"HTTP 请求总数"</span>),
    )
    requestCounter.Inc(<span class="hljs-number">1</span>, <span class="hljs-string">"GET"</span>, <span class="hljs-string">"/api/v1/users"</span>, <span class="hljs-string">"200"</span>)
}
- **延迟指标**：P50、P95、P99 延迟，以及长尾延迟分布
- **流量指标**：QPS、TPS、并发连接数
- **错误指标**：HTTP 错误率、gRPC 错误码分布
- **协议指标**：TLS 握手次数、连接复用率、重传率
- **资源指标**：CPU、内存、带宽使用率

**开源工具推荐**：
- <span class="hljs-string">`github.com/prometheus/client_golang`</span>：Prometheus 客户端库，用于暴露指标
- <span class="hljs-string">`github.com/uber-go/tally`</span>：Uber 开源的指标库，支持多后端
- <span class="hljs-string">`github.com/grafana/grafana`</span>：数据可视化平台，用于监控面板展示

**代码示例：使用 Prometheus 监控 gRPC 服务**
<span class="hljs-string">``</span><span class="hljs-string">`go
import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promhttp"
    "google.golang.org/grpc"
    "google.golang.org/grpc/stats"
)

// gRPC 统计拦截器
func newStatsHandler() stats.Handler {
    return &amp;grpcStatsHandler{
        requestDuration: prometheus.NewHistogramVec(
            prometheus.HistogramOpts{
                Name:    "grpc_request_duration_seconds",
                Help:    "gRPC request duration",
                Buckets: prometheus.DefBuckets,
            },
            []string{"method", "status"},
        ),
    }
}

// 注册指标
grpcStats := newStatsHandler()
prometheus.MustRegister(grpcStats.requestDuration)

// 配置 gRPC 服务器
srv := grpc.NewServer(
    grpc.StatsHandler(grpcStats),
)

// 暴露 Prometheus 端点
http.Handle("/metrics", promhttp.Handler())
go http.ListenAndServe(":2112", nil)
</span></code></pre>
<h3 data-id="heading-24">日志与追踪：全链路可观测</h3>
<p><strong>我们的日志与追踪实践</strong>：</p>
<ul>
<li>使用 <code>opentelemetry-go</code> 统一日志、指标和追踪</li>
<li>实现请求全链路追踪，从客户端到服务端</li>
<li>为每个请求生成唯一的 traceID 和 spanID</li>
<li>记录关键请求参数和响应状态</li>
</ul>
<p><strong>开源工具推荐</strong>：</p>
<ul>
<li><code>go.opentelemetry.io/otel</code>：OpenTelemetry Go 客户端</li>
<li><code>github.com/rs/zerolog</code>：高性能 JSON 日志库</li>
<li><code>github.com/openzipkin/zipkin-go</code>：Zipkin 客户端库</li>
</ul>
<p><strong>代码示例：使用 OpenTelemetry 进行全链路追踪</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"go.opentelemetry.io/otel"</span>
    <span class="hljs-string">"go.opentelemetry.io/otel/exporters/zipkin"</span>
    <span class="hljs-string">"go.opentelemetry.io/otel/sdk/trace"</span>
)

<span class="hljs-comment">// 初始化 OpenTelemetry</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initTracer</span><span class="hljs-params">()</span></span> (<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 创建 Zipkin  exporter</span>
    exporter, err := zipkin.New(
        <span class="hljs-string">"http://localhost:9411/api/v2/spans"</span>,
        zipkin.WithLocalEndpoint(<span class="hljs-string">"service-name"</span>, <span class="hljs-string">"localhost:8080"</span>),
    )
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-comment">// 创建 tracer provider</span>
    provider := trace.NewTracerProvider(
        trace.WithSampler(trace.AlwaysSample()),
        trace.WithBatcher(exporter),
    )
    
    <span class="hljs-comment">// 设置全局 tracer provider</span>
    otel.SetTracerProvider(provider)
    
    <span class="hljs-comment">// 返回清理函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        provider.Shutdown(context.Background())
    }, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 使用追踪包装 gRPC 客户端调用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">tracedGRPCCall</span><span class="hljs-params">(ctx context.Context, client ServiceClient, req *Request)</span></span> (*Response, <span class="hljs-type">error</span>) {
    tracer := otel.Tracer(<span class="hljs-string">"service"</span>)
    ctx, span := tracer.Start(ctx, <span class="hljs-string">"call-service"</span>)
    <span class="hljs-keyword">defer</span> span.End()
    
    <span class="hljs-comment">// 添加属性</span>
    span.SetAttributes(
        attribute.String(<span class="hljs-string">"service.method"</span>, <span class="hljs-string">"Service.Call"</span>),
        attribute.String(<span class="hljs-string">"request.id"</span>, req.ID),
    )
    
    <span class="hljs-comment">// 执行调用</span>
    resp, err := client.Call(ctx, req)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        span.RecordError(err)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-keyword">return</span> resp, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-25">灰度与流量控制：安全地验证优化</h3>
<p><strong>灰度发布策略</strong>：</p>
<ul>
<li>使用 <code>istio</code> 或 <code>linkerd</code> 实现流量镜像和灰度发布</li>
<li>按用户、地域、权重等维度分配流量</li>
<li>设置回滚机制，确保出现问题时能快速恢复</li>
</ul>
<p><strong>流量控制实践</strong>：</p>
<ul>
<li>实现令牌桶限流，防止突发流量冲击</li>
<li>使用熔断器保护下游服务</li>
<li>实现请求优先级，确保核心业务不受影响</li>
</ul>
<p><strong>开源工具推荐</strong>：</p>
<ul>
<li><code>github.com/istio/istio</code>：服务网格，用于流量管理和灰度发布</li>
<li><code>github.com/envoyproxy/go-control-plane</code>：Envoy 控制平面，用于动态配置</li>
<li><code>github.com/ulule/limiter</code>：限流库，支持多种算法</li>
</ul>
<p><strong>代码示例：使用 istioctl 进行灰度发布</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建目标规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: service-destination
spec:
  host: service.default.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2'</span> | kubectl apply -f -

<span class="hljs-comment"># 创建虚拟服务，将 10% 流量路由到 v2</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: service-virtual

spec:
  hosts:
  - service.default.svc.cluster.local
  http:
  - route:
    - destination:
        host: service.default.svc.cluster.local
        subset: v1
      weight: 90
    - destination:
        host: service.default.svc.cluster.local
        subset: v2
      weight: 10'</span> | kubectl apply -f -
</code></pre>
<h3 data-id="heading-26">自动化测试：确保优化的质量</h3>
<p><strong>性能测试策略</strong>：</p>
<ul>
<li>使用 <code>github.com/loadimpact/k6</code> 或 <code>github.com/gatling/gatling</code> 进行负载测试</li>
<li>模拟真实的用户行为和流量模式</li>
<li>关注 P99 延迟和错误率等关键指标</li>
</ul>
<p><strong>混沌工程实践</strong>：</p>
<ul>
<li>使用 <code>github.com/Netflix/chaosmonkey</code> 或 <code>github.com/chaos-mesh/chaos-mesh</code> 进行故障注入</li>
<li>测试服务在网络延迟、节点故障等情况下的表现</li>
<li>验证熔断、重试等机制的有效性</li>
</ul>
<p><strong>代码示例：使用 k6 进行性能测试</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'k6/http'</span>;
<span class="hljs-keyword">import</span> { check, sleep } <span class="hljs-keyword">from</span> <span class="hljs-string">'k6'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> options = {
    <span class="hljs-attr">stages</span>: [
        { <span class="hljs-attr">duration</span>: <span class="hljs-string">'30s'</span>, <span class="hljs-attr">target</span>: <span class="hljs-number">100</span> },  <span class="hljs-comment">// 逐步增加到 100 并发</span>
        { <span class="hljs-attr">duration</span>: <span class="hljs-string">'1m'</span>, <span class="hljs-attr">target</span>: <span class="hljs-number">100</span> },   <span class="hljs-comment">// 保持 100 并发</span>
        { <span class="hljs-attr">duration</span>: <span class="hljs-string">'30s'</span>, <span class="hljs-attr">target</span>: <span class="hljs-number">200</span> },  <span class="hljs-comment">// 逐步增加到 200 并发</span>
        { <span class="hljs-attr">duration</span>: <span class="hljs-string">'1m'</span>, <span class="hljs-attr">target</span>: <span class="hljs-number">200</span> },   <span class="hljs-comment">// 保持 200 并发</span>
        { <span class="hljs-attr">duration</span>: <span class="hljs-string">'30s'</span>, <span class="hljs-attr">target</span>: <span class="hljs-number">0</span> },    <span class="hljs-comment">// 逐步减少到 0 并发</span>
    ],
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> res = http.<span class="hljs-title function_">get</span>(<span class="hljs-string">'http://localhost:8080/api/v1/users/1'</span>);
    <span class="hljs-title function_">check</span>(res, {
        <span class="hljs-string">'status is 200'</span>: <span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>,
        <span class="hljs-string">'response time &lt; 50ms'</span>: <span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-property">timings</span>.<span class="hljs-property">duration</span> &lt; <span class="hljs-number">50</span>,
    });
    <span class="hljs-title function_">sleep</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<h2 data-id="heading-27">案例一：跨区域库存系统的协议演进</h2>
<p><strong>背景</strong>：我们的电商库存中心原使用 REST + JSON 进行跨区域库存同步，存在两个主要问题：跨区域同步时延高（平均420ms）、带宽占用大（每天跨区域流量超过10TB）。</p>
<p><strong>策略</strong>：经过评估，我们决定迁移到 gRPC，拆分为 <code>ListDelta</code>、<code>ApplyDelta</code> 两类接口，并引入 streaming 传输批量更新，以减少网络往返次数。</p>
<p><strong>调优步骤</strong>：</p>
<ol>
<li><strong>编码优化</strong>：将库存结构转为 ProtoBuf，减少了 60% 的报文体积。例如，原来的 JSON 格式库存记录约 200 字节，转换后仅 80 字节。</li>
<li><strong>连接管理</strong>：每个边缘节点与中心保持 4 条长连接，启用 <code>keepalive</code> 与健康探针，确保连接稳定性。</li>
<li><strong>监控与回滚</strong>：使用 <code>otelcol</code> 收集延迟样本，设置 P99 超过 150ms 即自动回滚的策略，确保系统稳定性。</li>
</ol>
<p><strong>结果</strong>：区域同步延迟从 420ms 降至 130ms，跨区域带宽下降近一半（每天约 5.5TB），系统稳定运行三个月未出现大规模超时。</p>
<h2 data-id="heading-28">案例二：风控回调的幂等与限流改造</h2>
<p><strong>背景</strong>：风控平台通过 HTTP 回调通知多个业务线，但由于下游服务偶尔超时，导致风控系统发起海量重试，最终引发接口雪崩，成功率一度降至 50% 以下。</p>
<p><strong>策略</strong>：考虑到业务线的技术栈多样性，我们决定保留 HTTP/1.1 协议，但强化客户端限流与幂等性设计。</p>
<p><strong>调优步骤</strong>：</p>
<ol>
<li><strong>幂等性设计</strong>：引入 <code>X-Event-Id</code> 作为幂等键，服务端使用 Redis <code>SETNX</code> 命令防止重复执行，确保同一事件只会被处理一次。</li>
<li><strong>限流与重试</strong>：客户端引入 <code>golang.org/x/time/rate</code> 实现令牌桶限流，并采用指数退避重试策略；将超时时间设为 200ms 并设置重试上限（最多3次）。</li>
<li><strong>批量确认</strong>：增加 <code>/ack</code> 接口，支持一次确认多条回调，减少网络往返次数。</li>
<li><strong>观测与灰度</strong>：灰度阶段启用 <code>otelhttp</code> 中间件，按租户拆分指标，实时监控各业务线的调用情况。</li>
</ol>
<p><strong>结果</strong>：高峰期调用成功率提升至 99.7%，限流生效后未再触发网关熔断，系统稳定性显著提升。</p>
<h2 data-id="heading-29">排查清单：通信链路出问题时先看什么</h2>
<p>当通信链路出现问题时，我们通常按照以下顺序进行排查：</p>
<ol>
<li><strong>连接数暴涨</strong>：检查是否关闭了 Keep-Alive 或爆发重试；审计 <code>MaxIdleConns</code> 和 <code>MaxConnsPerHost</code> 配置。</li>
<li><strong>延迟长尾</strong>：确认是否存在慢 Resolver 或单连接多路复用堵塞；使用 <code>tcpdump</code> 关注 <code>tcp retrans</code> 指标。</li>
<li><strong>带宽飙升</strong>：排查是否启用了压缩、字段裁剪；审查大对象传输，考虑是否需要分页或分批处理。</li>
<li><strong>重试风暴</strong>：观察超时与重试策略是否匹配；防止本服务与网关双重重试，避免雪崩效应。</li>
<li><strong>SSL 错误集中</strong>：校验证书有效期、SNI 配置；开启 OCSP Stapling 缓解证书验证慢的问题。</li>
</ol>
<h2 data-id="heading-30">验收清单：上线前逐条确认</h2>
<p>在通信优化上线前，我们会逐条确认以下事项：</p>
<ol>
<li><strong>协议选择</strong>：有量化依据，并记录在 ADR（Architecture Decision Record）中，确保团队共识。</li>
<li><strong>配置对齐</strong>：客户端与服务端的超时、重试、限流、熔断配置已对齐，避免配置不一致导致的问题。</li>
<li><strong>监控覆盖</strong>：监控覆盖链路关键阶段，延迟分位与错误类型均有告警，确保问题可及时发现。</li>
<li><strong>压测验证</strong>：包括突发流量、跨可用区、慢下游三类场景，验证系统在极端情况下的表现。</li>
<li><strong>回滚路径</strong>：明确回滚路径，能在十分钟内恢复旧协议，降低风险。</li>
</ol>
<h2 data-id="heading-31">总结：通信优化的核心原则</h2>
<ol>
<li><strong>协议匹配场景</strong>：核心服务用 gRPC/Kitex，公开 API 用 HTTP/Hertz，异步用消息队列</li>
<li><strong>连接池是基础</strong>：合理配置 <code>MaxIdleConns</code> 和 <code>MaxIdleConnsPerHost</code>，或直接使用框架默认优化配置</li>
<li><strong>数据传输精瘦化</strong>：优先使用 ProtoBuf，实现字段裁剪，按需启用压缩</li>
<li><strong>系统具备弹性</strong>：实现超时控制、智能重试、熔断和限流机制</li>
<li><strong>治理持续优化</strong>：建立完善的监控体系，通过灰度发布验证优化效果</li>
</ol>
<p><strong>框架选择参考</strong>：</p>
<ul>
<li>高性能 HTTP 服务：考虑 Hertz</li>
<li>高性能 RPC 场景：考虑 Kitex</li>
<li>完整微服务解决方案：考虑 Kratos</li>
</ul>
<p>国内框架在实际生产环境中经过验证，能有效简化通信层的配置与优化工作。</p>
<p>通过这些实践，我们可以构建一个高效、稳定、可维护的微服务通信系统，为业务的快速发展提供可靠的技术支撑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 饼图入门：3 行代码展示数据占比]]></title>    <link>https://juejin.cn/post/7577690150092767272</link>    <guid>https://juejin.cn/post/7577690150092767272</guid>    <pubDate>2025-11-29T15:19:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150092767272" data-draft-id="7576187677839392783" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 饼图入门：3 行代码展示数据占比"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2025-11-29T15:19:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MOMO陌染"/> <meta itemprop="url" content="https://juejin.cn/user/546920729166618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 饼图入门：3 行代码展示数据占比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/546920729166618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MOMO陌染
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:19:09.000Z" title="Sat Nov 29 2025 15:19:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>饼图的核心作用是<strong>直观呈现各部分数据占总体的比例关系</strong>（比如不同产品的市场份额、家庭开支构成、班级成绩等级分布等），通过扇形的大小对比，能快速看出 “谁占比最高”“谁占比最低”。借助<code>matplotlib</code>库，新手也能轻松用 Python 画出清晰的饼图。</p>
<h2 data-id="heading-0">一、准备工作：安装并导入库</h2>
<p>和之前的柱状图、折线图、散点图一致，核心依赖<code>matplotlib</code>库，若未安装，打开终端 / 命令提示符输入：</p>
<pre><code class="hljs language-bash" lang="bash">pip install matplotlib
</code></pre>
<p>安装完成后，在代码中导入库（惯例简写为<code>plt</code>）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
</code></pre>
<h2 data-id="heading-1">二、最基础的饼图：3 行核心代码</h2>
<p>我们以 “某家庭 monthly 开支构成” 为例，手把手实现第一个饼图。</p>
<h3 data-id="heading-2">步骤 1：准备数据</h3>
<p>定义两个列表，对应 “分类数据”（比如开支项目）和 “对应占比 / 数值”（比如开支金额，饼图会自动计算占比）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 分类数据（饼图的各部分名称）</span>
expenses = [<span class="hljs-string">"房租"</span>, <span class="hljs-string">"餐饮"</span>, <span class="hljs-string">"交通"</span>, <span class="hljs-string">"娱乐"</span>, <span class="hljs-string">"其他"</span>]
<span class="hljs-comment"># 对应数值（可直接用金额，饼图自动计算占比）</span>
amounts = [<span class="hljs-number">3500</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">800</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">500</span>]
</code></pre>
<h3 data-id="heading-3">步骤 2：绘制饼图</h3>
<p>用<code>plt.pie()</code>函数绘制，核心参数是<code>数值数据</code>和<code>分类标签</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 绘制饼图（核心代码）</span>
plt.pie(amounts, labels=expenses)
</code></pre>
<h3 data-id="heading-4">步骤 3：显示图表</h3>
<p>用<code>plt.show()</code>展示绘制结果：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 显示图表</span>
plt.show()
</code></pre>
<h3 data-id="heading-5">完整代码（直接运行可用）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># 1. 准备数据</span>
expenses = [<span class="hljs-string">"房租"</span>, <span class="hljs-string">"餐饮"</span>, <span class="hljs-string">"交通"</span>, <span class="hljs-string">"娱乐"</span>, <span class="hljs-string">"其他"</span>]  <span class="hljs-comment"># 分类标签</span>
amounts = [<span class="hljs-number">3500</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">800</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">500</span>]  <span class="hljs-comment"># 对应数值（金额/数量）</span>

<span class="hljs-comment"># 2. 绘制饼图</span>
plt.pie(amounts, labels=expenses)

<span class="hljs-comment"># 3. 显示图表</span>
plt.show()
</code></pre>
<h2 data-id="heading-6">三、简单优化：让占比更清晰</h2>
<p>基础饼图可以添加 “占比百分比”“颜色区分”“突出某部分”，让图表更专业，补充 3 行代码即可：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

expenses = [<span class="hljs-string">"房租"</span>, <span class="hljs-string">"餐饮"</span>, <span class="hljs-string">"交通"</span>, <span class="hljs-string">"娱乐"</span>, <span class="hljs-string">"其他"</span>]
amounts = [<span class="hljs-number">3500</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">800</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">500</span>]

<span class="hljs-comment"># 定义颜色列表（可选，让各部分更易区分）</span>
colors = [<span class="hljs-string">"#FF6B6B"</span>, <span class="hljs-string">"#4ECDC4"</span>, <span class="hljs-string">"#45B7D1"</span>, <span class="hljs-string">"#96CEB4"</span>, <span class="hljs-string">"#FECA57"</span>]
<span class="hljs-comment"># 突出某部分（比如突出占比最高的房租，explode参数控制偏移距离）</span>
explode = (<span class="hljs-number">0.1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)

<span class="hljs-comment"># 绘制饼图：添加百分比、颜色、突出效果、文本格式</span>
plt.pie(
    amounts,
    labels=expenses,
    colors=colors,
    explode=explode,
    autopct=<span class="hljs-string">"%1.1f%%"</span>,  <span class="hljs-comment"># 显示占比百分比（保留1位小数）</span>
    startangle=<span class="hljs-number">90</span>  <span class="hljs-comment"># 饼图起始角度（90度=从正上方开始）</span>
)
plt.title(<span class="hljs-string">"某家庭月度开支构成图"</span>)  <span class="hljs-comment"># 图表标题</span>
plt.axis(<span class="hljs-string">"equal"</span>)  <span class="hljs-comment"># 保证饼图是正圆形（避免默认椭圆）</span>

plt.show()
</code></pre>
<h2 data-id="heading-7">四、关键函数说明（新手必记）</h2>






























<table><thead><tr><th>函数</th><th>作用</th><th>常用参数</th></tr></thead><tbody><tr><td><code>plt.pie(x)</code></td><td>绘制饼图（核心）</td><td>x = 数值数据；labels = 分类标签；colors = 颜色列表；explode = 突出效果（元组，对应每个部分的偏移量）；autopct = 百分比格式（如 "%1.1f%%"= 保留 1 位小数）；startangle = 起始角度</td></tr><tr><td><code>plt.title()</code></td><td>设置图表标题</td><td>字符串（如 "月度开支构成"）</td></tr><tr><td><code>plt.axis("equal")</code></td><td>保证饼图为正圆形</td><td>固定参数 "equal"，必加（否则可能是椭圆）</td></tr><tr><td><code>plt.show()</code></td><td>显示图表</td><td>无</td></tr></tbody></table>
<h2 data-id="heading-8">五、常见应用场景</h2>
<p>饼图的核心是 “展示占比”，适合这些场景：</p>
<ol>
<li>构成分析：公司营收构成、产品市场份额、班级学生性别比例</li>
<li>资源分配：项目预算分配、时间利用占比、库存品类占比</li>
<li>层级展示：某指标下各子类别占总体的比例（比如总销售额中各区域的占比）</li>
<li>注意：分类不宜过多（建议不超过 6 类），否则扇形太小，可读性变差</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[antd渐变色边框按钮]]></title>    <link>https://juejin.cn/post/7577705544874459174</link>    <guid>https://juejin.cn/post/7577705544874459174</guid>    <pubDate>2025-11-29T10:32:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544874459174" data-draft-id="7577691061032812590" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="antd渐变色边框按钮"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-29T10:32:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="呐呐呐呐呢"/> <meta itemprop="url" content="https://juejin.cn/user/2436173499753037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            antd渐变色边框按钮
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173499753037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    呐呐呐呐呢
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T10:32:23.000Z" title="Sat Nov 29 2025 10:32:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>直接贴代码把方便，掘金的写代码添加依赖太麻烦了</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> styled <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> { v4 } <span class="hljs-keyword">from</span> <span class="hljs-string">'uuid'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ButtonProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">SizeType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd/lib/config-provider/SizeContext'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">LinearGradientProps</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">colors</span>: <span class="hljs-built_in">string</span>[];
  direction?: <span class="hljs-string">'to right'</span> | <span class="hljs-string">'to left'</span> | <span class="hljs-string">'to top'</span> | <span class="hljs-string">'to bottom'</span> | <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">angleToCoordinates</span>(<span class="hljs-params">angleDeg: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-comment">// 将角度转换为弧度</span>
  <span class="hljs-keyword">const</span> angleRad = angleDeg * (<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>);

  <span class="hljs-comment">// 计算终点坐标 (起点固定为 [0,0])</span>
  <span class="hljs-comment">// 使用单位圆上的点，长度=1</span>
  <span class="hljs-keyword">const</span> x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angleRad);
  <span class="hljs-keyword">const</span> y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angleRad);

  <span class="hljs-comment">// 将坐标转换为百分比字符串</span>
  <span class="hljs-comment">// SVG 渐变坐标可以是负数或大于100%</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>,
    <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>,
    <span class="hljs-attr">x2</span>: <span class="hljs-string">`<span class="hljs-subst">${(x * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)}</span>%`</span>,
    <span class="hljs-attr">y2</span>: <span class="hljs-string">`<span class="hljs-subst">${(y * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)}</span>%`</span>
  };
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">LinearGradientComponent</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">LinearGradientProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ id, colors, direction = <span class="hljs-string">'to right'</span> }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getCoordinates</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 处理数字角度值 (如 150deg)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> direction === <span class="hljs-string">'number'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">angleToCoordinates</span>(direction);
    }

    <span class="hljs-comment">// 处理字符串角度值 (如 "150deg")</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> direction === <span class="hljs-string">'string'</span> &amp;&amp; direction.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'deg'</span>)) {
      <span class="hljs-keyword">const</span> angle = <span class="hljs-built_in">parseFloat</span>(direction);
      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(angle)) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">angleToCoordinates</span>(angle);
      }
    }

    <span class="hljs-comment">// 处理关键词方向</span>
    <span class="hljs-keyword">switch</span> (direction) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to right'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'0%'</span> };
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to left'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'0%'</span> };
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to top'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'0%'</span> };
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to bottom'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'100%'</span> };
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to top right'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'0%'</span> };
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to bottom left'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'100%'</span> };
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'0%'</span> };
    }
  };

  <span class="hljs-keyword">const</span> { x1, y1, x2, y2 } = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">getCoordinates</span>(), [direction]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">linearGradient</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{id}</span> <span class="hljs-attr">x1</span>=<span class="hljs-string">{x1}</span> <span class="hljs-attr">y1</span>=<span class="hljs-string">{y1}</span> <span class="hljs-attr">x2</span>=<span class="hljs-string">{x2}</span> <span class="hljs-attr">y2</span>=<span class="hljs-string">{y2}</span>&gt;</span>
      {colors.map((color, index) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">stop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">offset</span>=<span class="hljs-string">{</span>`${(<span class="hljs-attr">index</span> / (<span class="hljs-attr">colors.length</span> <span class="hljs-attr">-</span> <span class="hljs-attr">1</span>)) * <span class="hljs-attr">100</span>}%`} <span class="hljs-attr">stopColor</span>=<span class="hljs-string">{color}</span> /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">linearGradient</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Props</span> = {
  <span class="hljs-attr">linear</span>: <span class="hljs-built_in">string</span>;
  hoverIconColor?: <span class="hljs-built_in">string</span>;
} &amp; <span class="hljs-title class_">ButtonProps</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">SvgButton</span> = <span class="hljs-title function_">styled</span>(<span class="hljs-title class_">Button</span>) &lt;{ disabled?: <span class="hljs-built_in">boolean</span>; <span class="hljs-attr">linear</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">linearid</span>: <span class="hljs-built_in">string</span> }&gt;<span class="hljs-string">`
  &amp;.ant-btn-variant-outlined:not(:disabled):not(.ant-btn-disabled) {
    --ant-button-default-hover-bg: transparent;
    background: transparent;
  }
  width: 100%;
  height: 100%;
  background: transparent;
  border: none;
  padding: 0;
  cursor: <span class="hljs-subst">${({ disabled }) =&gt; (disabled ? <span class="hljs-string">'not-allowed'</span> : <span class="hljs-string">'pointer'</span>)}</span>;
  outline: none;

  background-clip: text;
  color: transparent;
  fill: transparent;
  background-image: <span class="hljs-subst">${({ linear }) =&gt; linear}</span>;
  p {
    color: #9980df;
  }
  svg {
    fill: url(#<span class="hljs-subst">${({ linearid }) =&gt; linearid}</span>);
  }
`</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">SvgButtonWrapper</span> = styled.<span class="hljs-property">div</span>&lt;{ size?: <span class="hljs-title class_">SizeType</span> }&gt;<span class="hljs-string">`
  --ant-control-height: 32px;
  --font-size: 14px;

  &amp;.button-size-large {
    --ant-control-height: 40px;
    --font-size: 16px;
  }
  &amp;.button-size-small {
    --ant-control-height: 24px;
    --font-size: 12px;
  }

  display: inline-block;
  position: relative;
  height: var(--ant-control-height);
  width: fit-content;

  &amp; &gt; svg {
    position: absolute;
    z-index: 0;
    pointer-events: none;

    &amp; &gt; rect {
      transition: fill 0.3s;
    }
  }

  &amp;[aria-disabled='false'] {
    &amp;:hover {
      &amp; &gt; svg &gt; rect:last-child {
        fill: transparent;
      }

      <span class="hljs-subst">${SvgButton}</span> {
        color: #000;
        background-clip: unset;
        background-image: unset;

        p {
          color: <span class="hljs-subst">${({ theme }) =&gt; theme.same}</span>;
        }

        svg {
          fill: <span class="hljs-subst">${({ theme }) =&gt; theme.same}</span>;
        }
      }
    }
  }
  &amp;[aria-disabled='true'] {
    opacity: 0.5;
  }
`</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">LinearButton</span>(<span class="hljs-params">{ linear, children, size, disabled, loading, ...buttonProps }: Props</span>) {
  <span class="hljs-keyword">const</span> colors = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span>
      linear.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/#(?:[a-f0-9]{3}|[a-f0-9]{6})\b|rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*(?:,\s*[\d.]+\s*)?\)/gi</span>) || [],
    [linear]
  );
  <span class="hljs-keyword">const</span> deg = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> linear.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/[0-9]deg/</span>)?.[<span class="hljs-number">0</span>] || <span class="hljs-string">''</span>, [linear]);

  <span class="hljs-keyword">const</span> linearId = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span>
      <span class="hljs-string">`<span class="hljs-subst">${v4({
        random: <span class="hljs-built_in">Uint8Array</span>.<span class="hljs-keyword">from</span>(linear)
      })}</span>`</span>,
    []
  );

  <span class="hljs-keyword">const</span> buttonRef = useRef&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [contentSize, setContentSize] = useState&lt;{ <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> }&gt;(
    buttonRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">getBoundingClientRect</span>() || { <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">32</span> }
  );

  <span class="hljs-keyword">const</span> handle = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (buttonRef.<span class="hljs-property">current</span>) {
      <span class="hljs-title function_">setContentSize</span>(buttonRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>());
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">setTimeout</span>(handle, <span class="hljs-number">100</span>);
    }
  }, []);

  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">handle</span>();
  }, [children, buttonProps.<span class="hljs-property">icon</span>]);

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// 使用svg做背景，按钮背景统一透明，避免比例影响、边框锯齿等问题</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SvgButtonWrapper</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">button-size-</span>${<span class="hljs-attr">size</span> || '<span class="hljs-attr">default</span>'}`} <span class="hljs-attr">aria-disabled</span>=<span class="hljs-string">{!!disabled}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">svg</span>
        <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span>
        <span class="hljs-attr">height</span>=<span class="hljs-string">"100%"</span>
        <span class="hljs-attr">viewBox</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">0</span> <span class="hljs-attr">0</span> ${<span class="hljs-attr">contentSize.width</span>} ${<span class="hljs-attr">contentSize.height</span>}`}
        <span class="hljs-attr">preserveAspectRatio</span>=<span class="hljs-string">"none"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">defs</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">LinearGradientComponent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{linearId}</span> <span class="hljs-attr">colors</span>=<span class="hljs-string">{[...colors]}</span> <span class="hljs-attr">direction</span>=<span class="hljs-string">{deg}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">defs</span>&gt;</span>

        {/* 背景边框 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">rect</span>
          <span class="hljs-attr">x</span>=<span class="hljs-string">"1"</span>
          <span class="hljs-attr">y</span>=<span class="hljs-string">"1"</span>
          <span class="hljs-attr">width</span>=<span class="hljs-string">{Math.max(contentSize.width</span> <span class="hljs-attr">-</span> <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">height</span>=<span class="hljs-string">{Math.max(contentSize.height</span> <span class="hljs-attr">-</span> <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">rx</span>=<span class="hljs-string">{Math.max(contentSize.height</span> / <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">ry</span>=<span class="hljs-string">{Math.max(contentSize.height</span> / <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">fill</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">url</span>(#${<span class="hljs-attr">linearId</span>})`}
          <span class="hljs-attr">stroke</span>=<span class="hljs-string">"none"</span>
        /&gt;</span>

        {/* 内部填充 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">rect</span>
          <span class="hljs-attr">x</span>=<span class="hljs-string">"2"</span>
          <span class="hljs-attr">y</span>=<span class="hljs-string">"2"</span>
          <span class="hljs-attr">width</span>=<span class="hljs-string">{Math.max(contentSize.width</span> <span class="hljs-attr">-</span> <span class="hljs-attr">4</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">height</span>=<span class="hljs-string">{Math.max(contentSize.height</span> <span class="hljs-attr">-</span> <span class="hljs-attr">4</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">rx</span>=<span class="hljs-string">{Math.max(contentSize.height</span> / <span class="hljs-attr">2</span> <span class="hljs-attr">-</span> <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">ry</span>=<span class="hljs-string">{Math.max(contentSize.height</span> / <span class="hljs-attr">2</span> <span class="hljs-attr">-</span> <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">fill</span>=<span class="hljs-string">{disabled</span> ? '#<span class="hljs-attr">050505</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">000</span>'}
          <span class="hljs-attr">stroke</span>=<span class="hljs-string">"none"</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>

      {/* 实际可点击的按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">SvgButton</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">{buttonRef}</span>
        <span class="hljs-attr">linear</span>=<span class="hljs-string">{linear}</span>
        <span class="hljs-attr">size</span>=<span class="hljs-string">{size}</span>
        <span class="hljs-attr">linearid</span>=<span class="hljs-string">{linearId}</span>
        <span class="hljs-attr">disabled</span>=<span class="hljs-string">{!!disabled</span> || !!<span class="hljs-attr">loading</span>}
        {<span class="hljs-attr">...buttonProps</span>}
      &gt;</span>
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-name">SvgButton</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">SvgButtonWrapper</span>&gt;</span></span>
  );
}
</code></pre>
<p>按钮加渐变边框主要需要解决两个问题</p>
<ol>
<li>不同分辨率下会出现边框消失或视觉不等的情况</li>
<li>如何给文本和svg图标加上渐变</li>
</ol>
<p>所以也尝试过使用border或者渐变背景的方案，最后还是选择svg渲染背景，使用的图标也需要是svg的，hover后的效果根据主题来随便改。容器的大小是通过contentSize计算更新上去的，border默认就是2px，代码上可以写的再整洁一点</p>
<h2 data-id="heading-0">效果</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2939afa1b0794eaf8ca57d3998f8eb1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGQ5ZGQ5ZGQ5ZGQ5ZGi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765017143&amp;x-signature=1pEO0cxOUjwU8%2B80xQJc0s%2FUf8U%3D" alt="output.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 中 nextTick 的魔法：为什么它能拿到更新后的 DOM？]]></title>    <link>https://juejin.cn/post/7577693903017967642</link>    <guid>https://juejin.cn/post/7577693903017967642</guid>    <pubDate>2025-11-29T10:37:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577693903017967642" data-draft-id="7577693903017951258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 中 nextTick 的魔法：为什么它能拿到更新后的 DOM？"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-29T10:37:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 中 nextTick 的魔法：为什么它能拿到更新后的 DOM？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T10:37:22.000Z" title="Sat Nov 29 2025 10:37:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 中 nextTick 的魔法：为什么它能拿到更新后的 DOM？</h2>
<blockquote>
<p>深入理解 Vue 异步更新机制的核心</p>
</blockquote>
<h3 data-id="heading-1">一个令人困惑的场景</h3>
<p>很多 Vue 开发者都遇到过这样的场景：在改变数据后，立即访问 DOM，却发现拿到的是旧的值。这时候，我们就会用到 <code>nextTick</code> 这个神奇的解决方案。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 改变数据</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">'Hello Vue'</span>

<span class="hljs-comment">// 此时 DOM 还没有更新</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-property">textContent</span>) <span class="hljs-comment">// 旧内容</span>

<span class="hljs-comment">// 使用 nextTick 获取更新后的 DOM</span>
<span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-property">textContent</span>) <span class="hljs-comment">// 'Hello Vue'</span>
})
</code></pre>
<p>那么，<code>nextTick</code> 到底是如何工作的？为什么它能够确保我们在 DOM 更新后再执行回调？今天，我们就来彻底揭开 <code>nextTick</code> 的神秘面纱。</p>
<h3 data-id="heading-2">nextTick 的核心作用</h3>
<p><code>nextTick</code> 是 Vue 提供的一个异步方法，它的主要作用是：</p>
<p><strong>将回调函数延迟到下次 DOM 更新循环之后执行</strong></p>
<p>在 Vue 中，数据变化时，DOM 更新是异步的。Vue 会开启一个队列，并缓冲在同一事件循环中发生的所有数据变更。这样可以避免不必要的计算和 DOM 操作。</p>
<h3 data-id="heading-3">源码解析：nextTick 的实现</h3>
<p>让我们深入到 Vue 的源码中，看看 <code>nextTick</code> 到底是如何实现的。</p>
<h4 data-id="heading-4">1. 核心变量定义</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 回调队列</span>
<span class="hljs-keyword">const</span> callbacks = []
<span class="hljs-comment">// 标记是否已经有 pending 的 Promise</span>
<span class="hljs-keyword">let</span> pending = <span class="hljs-literal">false</span>
<span class="hljs-comment">// 当前是否正在执行回调</span>
<span class="hljs-keyword">let</span> flushing = <span class="hljs-literal">false</span>
<span class="hljs-comment">// 回调执行的位置索引</span>
<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-5">2. nextTick 函数主体</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">nextTick</span>(<span class="hljs-params">cb?: <span class="hljs-built_in">Function</span>, ctx?: <span class="hljs-built_in">Object</span></span>) {
  <span class="hljs-keyword">let</span> _resolve
  <span class="hljs-comment">// 将回调函数包装后推入回调队列</span>
  callbacks.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (cb) {
      <span class="hljs-keyword">try</span> {
        cb.<span class="hljs-title function_">call</span>(ctx)
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-title function_">handleError</span>(e, ctx, <span class="hljs-string">'nextTick'</span>)
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_resolve) {
      <span class="hljs-title function_">_resolve</span>(ctx)
    }
  })
  
  <span class="hljs-comment">// 如果当前没有 pending 的 Promise，就创建一次</span>
  <span class="hljs-keyword">if</span> (!pending) {
    pending = <span class="hljs-literal">true</span>
    <span class="hljs-comment">// 执行异步延迟器</span>
    <span class="hljs-title function_">timerFunc</span>()
  }
  
  <span class="hljs-comment">// 如果没有提供回调且支持 Promise，返回一个 Promise</span>
  <span class="hljs-keyword">if</span> (!cb &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Promise</span> !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      _resolve = resolve
    })
  }
}
</code></pre>
<h4 data-id="heading-6">3. timerFunc：异步延迟器的实现</h4>
<p>这是 <code>nextTick</code> 最核心的部分，Vue 会按照以下优先级选择异步方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> timerFunc

<span class="hljs-comment">// 优先级：Promise &gt; MutationObserver &gt; setImmediate &gt; setTimeout</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Promise</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-title function_">isNative</span>(<span class="hljs-title class_">Promise</span>)) {
  <span class="hljs-comment">// 情况1：支持 Promise</span>
  <span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()
  timerFunc = <span class="hljs-function">() =&gt;</span> {
    p.<span class="hljs-title function_">then</span>(flushCallbacks)
    <span class="hljs-comment">// 在一些有问题的 UIWebView 中，Promise.then 不会完全触发</span>
    <span class="hljs-comment">// 所以需要额外的 setTimeout 来强制刷新</span>
    <span class="hljs-keyword">if</span> (isIOS) <span class="hljs-built_in">setTimeout</span>(noop)
  }
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isIE &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MutationObserver</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; (
  <span class="hljs-title function_">isNative</span>(<span class="hljs-title class_">MutationObserver</span>) ||
  <span class="hljs-title class_">MutationObserver</span>.<span class="hljs-title function_">toString</span>() === <span class="hljs-string">'[object MutationObserverConstructor]'</span>
)) {
  <span class="hljs-comment">// 情况2：支持 MutationObserver</span>
  <span class="hljs-keyword">let</span> counter = <span class="hljs-number">1</span>
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(flushCallbacks)
  <span class="hljs-keyword">const</span> textNode = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-title class_">String</span>(counter))
  observer.<span class="hljs-title function_">observe</span>(textNode, {
    <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span>
  })
  timerFunc = <span class="hljs-function">() =&gt;</span> {
    counter = (counter + <span class="hljs-number">1</span>) % <span class="hljs-number">2</span>
    textNode.<span class="hljs-property">data</span> = <span class="hljs-title class_">String</span>(counter)
  }
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> setImmediate !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-title function_">isNative</span>(setImmediate)) {
  <span class="hljs-comment">// 情况3：支持 setImmediate</span>
  timerFunc = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setImmediate</span>(flushCallbacks)
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 情况4：降级到 setTimeout</span>
  timerFunc = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(flushCallbacks, <span class="hljs-number">0</span>)
  }
}
</code></pre>
<h4 data-id="heading-7">4. flushCallbacks：执行回调队列</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushCallbacks</span>(<span class="hljs-params"/>) {
  flushing = <span class="hljs-literal">true</span>
  pending = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> copies = callbacks.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>)
  callbacks.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>
  index = <span class="hljs-number">0</span>
  
  <span class="hljs-comment">// 执行所有回调</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; copies.<span class="hljs-property">length</span>; i++) {
    index = i
    copies[i]()
  }
  
  flushing = <span class="hljs-literal">false</span>
  index = <span class="hljs-number">0</span>
}
</code></pre>
<h3 data-id="heading-8">完整流程图</h3>
<p>让我们通过流程图来直观理解 <code>nextTick</code> 的完整工作流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[调用 nextTick] --&gt; B[回调函数推入 callbacks 队列]
    B --&gt; C{是否有 pending 的 timerFunc?}
    C --&gt;|否| D[设置 pending = true]
    D --&gt; E[执行 timerFunc]
    E --&gt; F{选择异步方案}
    F --&gt;|优先级1| G[Promise.resolve.then]
    F --&gt;|优先级2| H[MutationObserver]
    F --&gt;|优先级3| I[setImmediate]
    F --&gt;|优先级4| J[setTimeout]
    G --&gt; K[异步任务完成]
    H --&gt; K
    I --&gt; K
    J --&gt; K
    K --&gt; L[执行 flushCallbacks]
    L --&gt; M[遍历执行所有回调]
    M --&gt; N[重置状态]
    C --&gt;|是| O[等待现有 timerFunc 触发]
</code></pre>
<h3 data-id="heading-9">Vue 的异步更新队列</h3>
<p>要真正理解 <code>nextTick</code>，我们还需要了解 Vue 的异步更新队列机制。</p>
<h4 data-id="heading-10">Watcher 与更新队列</h4>
<p>当数据发生变化时，Vue 不会立即更新 DOM，而是将需要更新的 Watcher 放入一个队列中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简化版的更新队列实现</span>
<span class="hljs-keyword">const</span> queue = []
<span class="hljs-keyword">let</span> has = {}
<span class="hljs-keyword">let</span> waiting = <span class="hljs-literal">false</span>
<span class="hljs-keyword">let</span> flushing = <span class="hljs-literal">false</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">queueWatcher</span>(<span class="hljs-params">watcher</span>) {
  <span class="hljs-keyword">const</span> id = watcher.<span class="hljs-property">id</span>
  <span class="hljs-comment">// 避免重复添加</span>
  <span class="hljs-keyword">if</span> (has[id] == <span class="hljs-literal">null</span>) {
    has[id] = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">if</span> (!flushing) {
      queue.<span class="hljs-title function_">push</span>(watcher)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 如果已经在刷新，按 id 排序插入</span>
      <span class="hljs-keyword">let</span> i = queue.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
      <span class="hljs-keyword">while</span> (i &gt; index &amp;&amp; queue[i].<span class="hljs-property">id</span> &gt; watcher.<span class="hljs-property">id</span>) {
        i--
      }
      queue.<span class="hljs-title function_">splice</span>(i + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, watcher)
    }
    
    <span class="hljs-comment">// 开启下一次的异步更新</span>
    <span class="hljs-keyword">if</span> (!waiting) {
      waiting = <span class="hljs-literal">true</span>
      <span class="hljs-title function_">nextTick</span>(flushSchedulerQueue)
    }
  }
}
</code></pre>
<h4 data-id="heading-11">刷新调度队列</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushSchedulerQueue</span>(<span class="hljs-params"/>) {
  flushing = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">let</span> watcher, id
  
  <span class="hljs-comment">// 队列排序，确保：</span>
  <span class="hljs-comment">// 1. 组件更新顺序为父到子</span>
  <span class="hljs-comment">// 2. 用户 watcher 在渲染 watcher 之前</span>
  <span class="hljs-comment">// 3. 如果一个组件在父组件的 watcher 期间被销毁，它的 watcher 可以被跳过</span>
  queue.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">id</span> - b.<span class="hljs-property">id</span>)
  
  <span class="hljs-comment">// 不要缓存队列长度，因为可能会有新的 watcher 加入</span>
  <span class="hljs-keyword">for</span> (index = <span class="hljs-number">0</span>; index &lt; queue.<span class="hljs-property">length</span>; index++) {
    watcher = queue[index]
    <span class="hljs-keyword">if</span> (watcher.<span class="hljs-property">before</span>) {
      watcher.<span class="hljs-title function_">before</span>()
    }
    id = watcher.<span class="hljs-property">id</span>
    has[id] = <span class="hljs-literal">null</span>
    <span class="hljs-comment">// 执行更新</span>
    watcher.<span class="hljs-title function_">run</span>()
  }
  
  <span class="hljs-comment">// 重置状态</span>
  <span class="hljs-title function_">resetSchedulerState</span>()
}
</code></pre>
<h3 data-id="heading-12">实际应用场景</h3>
<h4 data-id="heading-13">场景 1：获取更新后的 DOM</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">list</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">addItem</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'d'</span>)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'li'</span>).<span class="hljs-property">length</span>) <span class="hljs-comment">// 3，还是旧的</span>
      
      <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'li'</span>).<span class="hljs-property">length</span>) <span class="hljs-comment">// 4，更新后的</span>
      })
    }
  }
}
</code></pre>
<h4 data-id="heading-14">场景 2：在 created 钩子中操作 DOM</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// DOM 还没有被创建</span>
    <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 现在可以安全地操作 DOM 了</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'button'</span>).<span class="hljs-title function_">focus</span>()
    })
  }
}
</code></pre>
<h4 data-id="heading-15">场景 3：与 Promise 结合使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateData</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">'Updated'</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-number">10</span>
  
  <span class="hljs-comment">// 等待所有 DOM 更新完成</span>
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$nextTick()
  
  <span class="hljs-comment">// 现在可以执行依赖于更新后 DOM 的操作</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateLayout</span>()
}
</code></pre>
<h3 data-id="heading-16">性能优化考虑</h3>
<p>Vue 使用异步更新队列有重要的性能优势：</p>
<ol>
<li><strong>批量更新</strong>：同一事件循环内的所有数据变更会被批量处理</li>
<li><strong>避免重复计算</strong>：相同的 Watcher 只会被推入队列一次</li>
<li><strong>优化渲染</strong>：减少不必要的 DOM 操作</li>
</ol>
<h3 data-id="heading-17">常见问题解答</h3>
<h4 data-id="heading-18">Q: nextTick 和 setTimeout 有什么区别？</h4>
<p>A: 虽然 <code>nextTick</code> 在降级情况下会使用 <code>setTimeout</code>，但它们有本质区别：</p>
<ul>
<li><code>nextTick</code> 会尝试使用微任务（Promise、MutationObserver），而 <code>setTimeout</code> 是宏任务</li>
<li>微任务在当前事件循环结束时执行，宏任务在下一个事件循环开始执行</li>
<li><code>nextTick</code> 能确保在 DOM 更新后立即执行，而 <code>setTimeout</code> 可能会有额外的延迟</li>
</ul>
<h4 data-id="heading-19">Q: 为什么有时候需要连续调用多个 nextTick？</h4>
<p>A: 在某些复杂场景下，可能需要确保某些操作在特定的 DOM 更新之后执行：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">data1</span> = <span class="hljs-string">'first'</span>
<span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 第一次更新后执行</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">data2</span> = <span class="hljs-string">'second'</span>
  <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 第二次更新后执行</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data3</span> = <span class="hljs-string">'third'</span>
  })
})
</code></pre>
<h4 data-id="heading-20">Q: nextTick 会返回 Promise 吗？</h4>
<p>A: 是的，当不传入回调函数时，<code>nextTick</code> 会返回一个 Promise：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 两种写法是等价的</span>
<span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 操作 DOM</span>
})

<span class="hljs-comment">// 或者</span>
<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$nextTick()
<span class="hljs-comment">// 操作 DOM</span>
</code></pre>
<h3 data-id="heading-21">总结</h3>
<p>通过本文的深入分析，我们可以看到 <code>nextTick</code> 的实现体现了 Vue 在性能优化上的深思熟虑：</p>
<ol>
<li><strong>异步更新</strong>：通过队列机制批量处理数据变更</li>
<li><strong>优先级策略</strong>：智能选择最优的异步方案</li>
<li><strong>错误处理</strong>：完善的异常捕获机制</li>
<li><strong>兼容性</strong>：优雅的降级方案</li>
</ol>
<p>理解 <code>nextTick</code> 的工作原理，不仅可以帮助我们更好地使用 Vue，还能让我们对 JavaScript 的异步机制有更深入的认识。</p>
<p>希望这篇文章能帮助你彻底掌握 Vue 中 <code>nextTick</code> 的魔法！如果你有任何问题或想法，欢迎在评论区留言讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter 封装一个 tab]]></title>    <link>https://juejin.cn/post/7577705544874737702</link>    <guid>https://juejin.cn/post/7577705544874737702</guid>    <pubDate>2025-11-29T13:16:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544874737702" data-draft-id="7577675494067748890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter 封装一个 tab"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-29T13:16:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="名字被你们想完了"/> <meta itemprop="url" content="https://juejin.cn/user/3065854916834782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter 封装一个 tab
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3065854916834782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    名字被你们想完了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T13:16:02.000Z" title="Sat Nov 29 2025 13:16:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">flutter 封装一个 tab</h2>
<p>flutter版本：3.35.4</p>
<p>demo 链接：</p>
<pre><code class="hljs language-text" lang="text">https://github.com/yhtqw/FrontEndDemo/tree/main/flutter_demo/lib/pages/customize_tab
</code></pre>
<p>在flutter中使用 <strong>TabBar</strong> + <strong>TabBarView</strong> 就能很好的实现，为了使用的便捷性和通用性，所以进行一些封装。</p>
<p>需要看最终效果和最终的封装代码，直接拉到最底部即可～</p>
<p>简单的使用一下，对一些基本的结构限制做出解释。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page19</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> Page19({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;Page19&gt; createState() =&gt; _Page19State();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-comment">// 必须，使用TabController作为桥梁连接TabBar和TabBarView</span>
  <span class="hljs-keyword">late</span> TabController _controller;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();

    _controller = TabController(
      length: <span class="hljs-number">2</span>,
      vsync: <span class="hljs-keyword">this</span>,
      initialIndex: <span class="hljs-number">0</span>,
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">100</span>,),

          TabBar(
            controller: _controller,
            <span class="hljs-comment">// tab bar选项，数量得和下面一致</span>
            tabs: <span class="hljs-keyword">const</span> [
              Text(<span class="hljs-string">'1111'</span>),
              Text(<span class="hljs-string">'2222'</span>),
            ],
          ),

          <span class="hljs-comment">// 使用TabBarView时，必须指定容器的限制范围。</span>
          <span class="hljs-comment">// 这里直接撑满剩余空间</span>
          Expanded(
            child: TabBarView(
              controller: _controller,
              <span class="hljs-comment">// tab bar每个选项对应的tab页面，数量得很上面一致</span>
              children: <span class="hljs-keyword">const</span> [
                Text(<span class="hljs-string">'1'</span>),
                Text(<span class="hljs-string">'2'</span>),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50031a2165d44806b5471b3b8643d2a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=T0P8YJ7e0LRaVQlKhhiozBn7X4Y%3D" alt="image01.gif" loading="lazy"/></p>
<p>简单的场景当然也可以不使用TabController，但需要DefaultTabController包裹，这样无需手动创建控制器自动就关联上了，大致使用如下：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ... 其他省略</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> DefaultTabController(
      <span class="hljs-comment">// 数量得和下面的一致</span>
      length: <span class="hljs-number">2</span>,
      child: Scaffold(
        backgroundColor: Colors.white,
        body: Column(
          children: [
            SizedBox(height: <span class="hljs-number">100</span>,),

            TabBar(
              tabs: [
                Text(<span class="hljs-string">'1111'</span>),
                Text(<span class="hljs-string">'2222'</span>),
              ],
            ),

            Expanded(
              child: TabBarView(
                children: [
                  Text(<span class="hljs-string">'1'</span>),
                  Text(<span class="hljs-string">'2'</span>),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<p>效果和上面一致。</p>
<p>从上面可以看出 flutter 已经实现了滑动的动画效果，我们只需要对结构样式进行封装，下面我们去体验一下其他的属性，为封装做准备。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-keyword">late</span> TabController _controller;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();

    _controller = TabController(
      length: <span class="hljs-number">3</span>,
      vsync: <span class="hljs-keyword">this</span>,
      initialIndex: <span class="hljs-number">0</span>,
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">100</span>,),

          TabBar(
            controller: _controller,
            <span class="hljs-comment">// 注意：选项文本颜色就通过下面设置，不通过选项自身的TextStyle来设置</span>
            <span class="hljs-comment">// tab bar 选项文本选中时的颜色</span>
            labelColor: Colors.blue,
            <span class="hljs-comment">// tab bar 选项文本未选中时的颜色</span>
            unselectedLabelColor: Colors.black,

            <span class="hljs-comment">// 选中指示器相关的属性</span>
            <span class="hljs-comment">// 设置tab bar选中指示器的颜色</span>
            indicatorColor: Colors.blue,
            <span class="hljs-comment">// 设置tab bar选中指示器的大小，默认和选项的文本宽度一致。</span>
            <span class="hljs-comment">// 这里设置的指示器宽度和选项的宽度一致</span>
            <span class="hljs-comment">// 这样设置后切换tab的时候蠕虫蠕动效果就没有了</span>
            indicatorSize: TabBarIndicatorSize.tab,
            <span class="hljs-comment">// 设置tab bar选中指示器的高度</span>
            indicatorWeight: <span class="hljs-number">10</span>,

            <span class="hljs-comment">// 移除tab bar选项点击时的高亮和水波纹反馈效果</span>
            overlayColor: WidgetStateProperty.all(Colors.transparent),

            <span class="hljs-comment">// 设置tab bar选项的内边距</span>
            <span class="hljs-comment">// 在indicatorSize设置为label的时候再设置这个值比较好</span>
            <span class="hljs-comment">// labelPadding: const EdgeInsets.symmetric(horizontal: 40),</span>

            <span class="hljs-comment">// 设置tab bar底部的那条分割线高度，也可以通过dividerColor设置其颜色</span>
            dividerHeight: <span class="hljs-number">0</span>,

            tabs: [<span class="hljs-string">'1111'</span>,<span class="hljs-string">'2222'</span>,<span class="hljs-string">'3333'</span>].map(
              (item) =&gt; Text(item,),
            ).toList(),
          ),

          Expanded(
            child: TabBarView(
              controller: _controller,
              children: [<span class="hljs-string">'1'</span>,<span class="hljs-string">'2'</span>,<span class="hljs-string">'3'</span>].map(
                (item) =&gt;Text(item,),
              ).toList(),
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a30010bd94254286a3a2d5a6e2fb49f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=ep3BgnoUvvK%2BrNJnaLWLM0HDV7s%3D" alt="image02.gif" loading="lazy"/></p>
<p>可以看到，上面我们使用了许多选中和选中指示器的效果，也是在tab bar个数少的时候展示的效果，接下来我们加几个再看看效果:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51d8a9a581f443c69365902764fa98f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=OzjFbSfy73XO6vFCingRBzAPAIc%3D" alt="image03.png" loading="lazy"/></p>
<p>可以看到选项被挤压，这个时候我们就可以通过 TabBar 的 isScrollable 属性来设置是否可以滚动：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>
TabBar(
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">// 设置tab bar选项个数过多超过限制的宽度的时候，是否允许滚动</span>
  isScrollable: <span class="hljs-keyword">true</span>,
),
<span class="hljs-comment">// 其他省略...</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/838a738323dd4a898eb05331a6c59609~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=OpdvpUWYfX7Mdxq%2F5iBSmyDqA9A%3D" alt="image04.gif" loading="lazy"/></p>
<p>我们又发现了允许滚动后，第一个的排列距离容器左边有一些边距，如果想让选项在最左边开始显示，就需要设置tabAlignment属性：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>
TabBar(
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">// 设置tab bar选项个数过多超过限制的宽度的时候，是否允许滚动</span>
  isScrollable: <span class="hljs-keyword">true</span>,
  <span class="hljs-comment">// 设置tab bar选项的显示位置</span>
  tabAlignment: TabAlignment.start,
),
<span class="hljs-comment">// 其他省略...</span>
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5afb91717faa4e978089609c827a9fef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=jF6bLnpOi3WkIEholl3%2FmUhdngg%3D" alt="image05.png" loading="lazy"/></p>
<p>关于TabBar的一些常用的属性就体验得差不多了，如果我们要设置整个TabBar容器的样式，例如背景色，圆角，高度等属性时，就需要对TabBar进行包裹，使用外层包裹部件来设置样式:</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>
Container(
  height: <span class="hljs-number">60</span>,
  padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="hljs-number">20</span>),
  decoration: <span class="hljs-keyword">const</span> BoxDecoration(
    color: Colors.grey,
    borderRadius: BorderRadius.only(
      topLeft: Radius.circular(<span class="hljs-number">20</span>),
      topRight: Radius.circular(<span class="hljs-number">20</span>),
    )
  ),
  child: TabBar(
    <span class="hljs-comment">// 其他省略...</span>
  ),
),
<span class="hljs-comment">// 其他省略...</span>
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a14d7f7dbcb946f4b90fdfcec8b32bae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=3N%2FoHk1O04zGpgHDHThr0XcQTz8%3D" alt="image06.png" loading="lazy"/></p>
<p>这下关于TabBar的样式就设置的差不多了，那么关于TabBarView的样式就自行通过传染的children部件自行封装实现。</p>
<p>我们从上面的效果中可以看到tab bar选中样式通过属性去自定义可能有些不好看，如果我们想用让指示器为整个背景，并且设置部分样式效果，我们就需要自定义TabBar的indicator属性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d75d0f3521a74919a42f664408d36aaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=NWUPd2znWKiJIyo%2BW55GSxol9fg%3D" alt="image07.png" loading="lazy"/></p>
<p>可以看到，如果我们要自定义指示器，需要实现Decoration，并且如果设置了indicator属性，则会忽略indicatorColor和indicatorWeight属性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7b0bb7558be4cd782a08cac86bf7718~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=YOmW%2BW3hnuYY8ozNVfdjNzYp6rM%3D" alt="image08.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8a206d57c874b1598894764b8f0d33c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=grBuGTVkVj6cCFC4YJckeUzkKMs%3D" alt="image09.png" loading="lazy"/></p>
<p>为了实现自定义的indicator，我们需要继承Decoration去实现绘制的方法，接下来我们就去实现一个简单的圆角矩形样式（这里不深入展开绘制相关的知识，后面有时间再单独写绘制相关的知识）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomizeTabIndicator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Decoration</span> </span>{
  <span class="hljs-keyword">const</span> CustomizeTabIndicator({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.color,
    <span class="hljs-keyword">this</span>.radius = BorderRadius.zero,
  });

  <span class="hljs-comment">/// <span class="markdown">指示器颜色</span></span>
  <span class="hljs-keyword">final</span> Color color;
  <span class="hljs-comment">/// <span class="markdown">指示器的圆角属性</span></span>
  <span class="hljs-keyword">final</span> BorderRadius radius;

  <span class="hljs-comment">// 需要重写绘制方法</span>
  <span class="hljs-meta">@override</span>
  BoxPainter createBoxPainter([VoidCallback? onChanged]) =&gt;
      _RoundedPainter(<span class="hljs-keyword">this</span>, onChanged);
}

<span class="hljs-comment">// 自定义绘制方法</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_RoundedPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BoxPainter</span> </span>{
  _RoundedPainter(<span class="hljs-keyword">this</span>.decoration, VoidCallback? onChanged) : <span class="hljs-keyword">super</span>(onChanged);

  <span class="hljs-keyword">final</span> CustomizeTabIndicator decoration;

  <span class="hljs-comment">// 重写绘制的方法，这个方法会传给我们绘制区域的信息</span>
  <span class="hljs-comment">// 我们利用这些信息就可以实现自定义的绘制</span>
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> paint(Canvas canvas, Offset offset, ImageConfiguration configuration) {
    <span class="hljs-comment">// 获取绘制区域的大小，整个变换过程中都会更新</span>
    <span class="hljs-built_in">double</span> width = configuration.size!.width;
    <span class="hljs-built_in">double</span> height = configuration.size!.height;
    <span class="hljs-comment">// 获取绘制区域的偏移量（距离最边上的距离）</span>
    Offset baseOffset = Offset(offset.dx, offset.dy,);

    <span class="hljs-comment">// 设置要绘制的圆角矩形</span>
    <span class="hljs-keyword">final</span> RRect indicatorRRect = _buildRRect(
      baseOffset,
      width,
      height,
    );
    <span class="hljs-comment">// 设置画笔属性</span>
    <span class="hljs-keyword">final</span> Paint paint = Paint()
      ..color = decoration.color
      ..style = PaintingStyle.fill;

    <span class="hljs-comment">// 绘制圆角矩形</span>
    canvas.drawRRect(indicatorRRect, paint);
  }

  <span class="hljs-comment">/// <span class="markdown">绘制圆角指示器</span></span>
  RRect _buildRRect(
    Offset offset,
    <span class="hljs-built_in">double</span> width,
    <span class="hljs-built_in">double</span> height,
  ) {
    <span class="hljs-keyword">return</span> RRect.fromRectAndCorners(
      <span class="hljs-comment">// 圆角矩形的绘制中心</span>
      Rect.fromCenter(
        center: Offset(
          offset.dx + width / <span class="hljs-number">2</span>,
          offset.dy + height / <span class="hljs-number">2</span>,
        ),
        width: width,
        height: height,
      ),
      topLeft: decoration.radius.topLeft,
      topRight: decoration.radius.topRight,
      bottomRight: decoration.radius.bottomRight,
      bottomLeft: decoration.radius.bottomLeft,
    );
  }
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-comment">// 其他省略...</span>
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">100</span>,),

          Container(
            height: <span class="hljs-number">60</span>,
            width: <span class="hljs-built_in">double</span>.infinity,
            padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="hljs-number">20</span>),
            decoration: <span class="hljs-keyword">const</span> BoxDecoration(
              color: Colors.grey,
              borderRadius: BorderRadius.only(
                topLeft: Radius.circular(<span class="hljs-number">20</span>),
                topRight: Radius.circular(<span class="hljs-number">20</span>),
              )
            ),
            child: TabBar(
              controller: _controller,
              <span class="hljs-comment">// 注意：选项文本颜色就通过下面设置，不通过选项自身的TextStyle来设置</span>
              <span class="hljs-comment">// tab bar 选项文本选中时的颜色</span>
              labelColor: Colors.blue,
              <span class="hljs-comment">// tab bar 选项文本未选中时的颜色</span>
              unselectedLabelColor: Colors.black,

              <span class="hljs-comment">// 选中指示器相关的属性</span>
              <span class="hljs-comment">// 自定义指示器</span>
              indicator: <span class="hljs-keyword">const</span> CustomizeTabIndicator(
                color: Colors.amber,
              ),

              <span class="hljs-comment">// 设置tab bar选项个数过多超过限制的宽度的时候，是否允许滚动</span>
              isScrollable: <span class="hljs-keyword">true</span>,
              <span class="hljs-comment">// 设置tab bar选项的显示位置</span>
              tabAlignment: TabAlignment.start,

              <span class="hljs-comment">// 设置tab bar选项的内边距</span>
              <span class="hljs-comment">// 在indicatorSize设置为label的时候再设置这个值比较好</span>
              labelPadding: <span class="hljs-keyword">const</span> EdgeInsets.only(right: <span class="hljs-number">30</span>),

              <span class="hljs-comment">// 设置tab bar底部的那条分割线高度，也可以通过dividerColor设置其颜色</span>
              dividerHeight: <span class="hljs-number">0</span>,

              tabs: [<span class="hljs-string">'1111'</span>,<span class="hljs-string">'2222'</span>,<span class="hljs-string">'3333'</span>,<span class="hljs-string">'4444'</span>,<span class="hljs-string">'5555'</span>,<span class="hljs-string">'6666'</span>,<span class="hljs-string">'7777'</span>].map(
                (item) =&gt; Padding(
                  padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(
                    horizontal: <span class="hljs-number">20</span>,
                    vertical: <span class="hljs-number">5</span>,
                  ),
                  child: Text(item,)
                ),
              ).toList(),
            ),
          ),
          <span class="hljs-comment">// 其他省略...</span>
        ],
      ),
    );
  }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddfd3a0615824abc83bb3c2404cb528e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=BxsX8KyUfQrZMCn6ULtGI2JaA3g%3D" alt="image10.gif" loading="lazy"/></p>
<p>通过上面的一系列的使用，接下来封装就很明了了，属性主要分为：</p>
<ul>
<li>tab bar相关
<ul>
<li>tab bar容器的属性</li>
<li>tab bar相关属性</li>
</ul>
</li>
<li>tab views相关</li>
<li>其他属性</li>
</ul>
<p>接下来基于上述的开始封装：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'customize_tab_indicator.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">抽取一些默认的属性</span></span>
BorderRadius ctDefaultIndicatorBorderRadius = BorderRadius.circular(<span class="hljs-number">10</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomizeTab</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> CustomizeTab({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">this</span>.tabBarHeight = kToolbarHeight,
    <span class="hljs-keyword">this</span>.tabBarBackgroundColor,
    <span class="hljs-keyword">this</span>.tabBarPadding,
    <span class="hljs-keyword">this</span>.tabBarBorderRadius,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.tabs,
    <span class="hljs-keyword">this</span>.unselectedColor,
    <span class="hljs-keyword">this</span>.selectedColor,
    <span class="hljs-keyword">this</span>.tabBarOptionMargin = <span class="hljs-keyword">const</span> EdgeInsets.only(right: <span class="hljs-number">10</span>),
    <span class="hljs-keyword">this</span>.tabBarOptionPadding = EdgeInsets.zero,
    <span class="hljs-keyword">this</span>.indicatorColor = Colors.blue,
    <span class="hljs-keyword">this</span>.indicatorBorderRadius,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.tabViews,
    <span class="hljs-keyword">this</span>.initialIndex,
    <span class="hljs-keyword">this</span>.onChangeTabIndex,
  });

  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的高度，默认为AppBar工具栏组件的高度</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> tabBarHeight;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的背景颜色</span></span>
  <span class="hljs-keyword">final</span> Color? tabBarBackgroundColor;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的内边距</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry? tabBarPadding;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的圆角属性</span></span>
  <span class="hljs-keyword">final</span> BorderRadiusGeometry? tabBarBorderRadius;
  <span class="hljs-comment">/// <span class="markdown">tab 选项</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; tabs;
  <span class="hljs-comment">/// <span class="markdown">tab 选项未选中时的颜色</span></span>
  <span class="hljs-keyword">final</span> Color? unselectedColor;
  <span class="hljs-comment">/// <span class="markdown">tab 选项选中时的颜色</span></span>
  <span class="hljs-keyword">final</span> Color? selectedColor;
  <span class="hljs-comment">/// <span class="markdown">tab bar 选项每项的margin</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry tabBarOptionMargin;
  <span class="hljs-comment">/// <span class="markdown">tab bar 选项每项的padding(因为大概率每项的padding是一致的，所以进行抽取)</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry tabBarOptionPadding;
  <span class="hljs-comment">/// <span class="markdown">指示器的颜色</span></span>
  <span class="hljs-keyword">final</span> Color indicatorColor;
  <span class="hljs-comment">/// <span class="markdown">指示器的圆角属性</span></span>
  <span class="hljs-keyword">final</span> BorderRadius? indicatorBorderRadius;
  <span class="hljs-comment">/// <span class="markdown">tab 页面</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; tabViews;
  <span class="hljs-comment">/// <span class="markdown">初始化显示tab的索引</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> initialIndex;
  <span class="hljs-comment">/// <span class="markdown">当tab索引发生改变时的回调函数</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">int</span>)? onChangeTabIndex;

  <span class="hljs-meta">@override</span>
  State&lt;CustomizeTab&gt; createState() =&gt; _CustomizeTabState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CustomizeTabState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">CustomizeTab</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-keyword">late</span> TabController _controller;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();

    _controller = TabController(
      length: widget.tabs.length,
      vsync: <span class="hljs-keyword">this</span>,
      initialIndex: widget.initialIndex ?? <span class="hljs-number">0</span>,
    )..addListener(() {
      <span class="hljs-comment">// indexIsChanging主要作用就是标识TabController是否正处于索引切换过程中。</span>
      <span class="hljs-comment">// 点击切换，在执行动画期间为true，用户手势操作结束后且动画完成为false</span>
      <span class="hljs-comment">// 滑动切换为false</span>
      <span class="hljs-comment">// 使用indexIsChanging来判断当前tab变化是否完成，完成了就执行回调</span>
      <span class="hljs-keyword">if</span> (!_controller.indexIsChanging) {
        widget.onChangeTabIndex?.call(_controller.index);
      }
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-comment">/// <span class="markdown">对每个tab加内边距</span></span>
  Widget _buildTab(Widget tab) {
    <span class="hljs-keyword">return</span> Padding(
      padding: widget.tabBarOptionPadding,
      child: tab,
    );
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 通过父容器的约束动态构建子部件</span>
    <span class="hljs-keyword">return</span> LayoutBuilder(
      builder: (_, BoxConstraints boxConstraints) =&gt; Column(
        children: [
          Container(
            width: <span class="hljs-built_in">double</span>.infinity,
            height: widget.tabBarHeight,
            padding: widget.tabBarPadding,
            decoration: BoxDecoration(
              color: widget.tabBarBackgroundColor,
              borderRadius: widget.tabBarBorderRadius,
            ),
            child: TabBar(
              controller: _controller,
              indicator: CustomizeTabIndicator(
                color: widget.indicatorColor,
                radius: widget.indicatorBorderRadius ??
                    ctDefaultIndicatorBorderRadius,
              ),
              isScrollable: <span class="hljs-keyword">true</span>,
              dividerHeight: <span class="hljs-number">0</span>,
              labelPadding: widget.tabBarOptionMargin,
              tabAlignment: TabAlignment.start,
              unselectedLabelColor: widget.unselectedColor,
              labelColor: widget.selectedColor,
              tabs: widget.tabs.map((tab) =&gt; _buildTab(tab)).toList(),
            ),
          ),

          <span class="hljs-comment">// 因为TabBarView必须要约束</span>
          <span class="hljs-comment">// 所以定义它的高度就为外界的约束高度减去TabBar的高度</span>
          SizedBox(
            width: <span class="hljs-built_in">double</span>.infinity,
            height: boxConstraints.maxHeight - widget.tabBarHeight,
            child: TabBarView(
              controller: _controller,
              children: widget.tabViews,
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'../widgets/page19/customize_tab.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page19</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> Page19({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;Page19&gt; createState() =&gt; _Page19State();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  Widget _buildTab(<span class="hljs-built_in">String</span> txt) {
    <span class="hljs-keyword">return</span> Text(
      txt,
      style: <span class="hljs-keyword">const</span> TextStyle(
        fontSize: <span class="hljs-number">14</span>,
      ),
    );
  }

  Widget _buildTabView(<span class="hljs-built_in">String</span> txt) {
    <span class="hljs-keyword">return</span> Container(
      padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">20</span>),
      color: Colors.grey,
      child: Text(txt),
    );
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">100</span>,),

          Expanded(
            child: CustomizeTab(
              tabBarBackgroundColor: Colors.amber,
              tabBarPadding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(
                horizontal: <span class="hljs-number">20</span>,
              ),
              tabBarBorderRadius: <span class="hljs-keyword">const</span> BorderRadius.only(
                topRight: Radius.circular(<span class="hljs-number">20</span>),
                topLeft: Radius.circular(<span class="hljs-number">20</span>),
              ),
              unselectedColor: Colors.black,
              selectedColor: Colors.white,
              tabBarOptionPadding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(
                horizontal: <span class="hljs-number">15</span>,
                vertical: <span class="hljs-number">5</span>,
              ),
              indicatorColor: Colors.orange,
              onChangeTabIndex: (index) {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前的索引为：<span class="hljs-subst">$index</span>'</span>);
              },
              tabs: [<span class="hljs-string">'tab1'</span>, <span class="hljs-string">'tab2'</span>, <span class="hljs-string">'tab3'</span>, <span class="hljs-string">'tab4'</span>, <span class="hljs-string">'tab5'</span>].map(
                (item) =&gt; _buildTab(item),
              ).toList(),
              tabViews: [<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>, <span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>].map(
                (item) =&gt; _buildTabView(item),
              ).toList(),
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df879ac790674caea03a33b87e0da7ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=gaJEOeEof9fVgxYdkG1sfh7r8BE%3D" alt="image11.gif" loading="lazy"/></p>
<p>上面我们就完成了一个简单的tab封装，但是目前还不算很通用，例如我想要TabBar在下面，TabView在上面，这个就不能直接使用了，得更改内部代码，所以继续继续封装，允许用户自定义方向。</p>
<p>接下来进行TabBar位置的分析：</p>
<ol>
<li>在顶部（top）</li>
</ol>
<p>不用具体分析了，因为上面就是基于在顶部封装的。</p>
<ol start="2">
<li>在底部（bottom）</li>
</ol>
<p>与在顶部相比，只是结构倒序一下就行了。</p>
<ol start="3">
<li>在左边（left）</li>
</ol>
<p>在左边，结构从上下结构（Column）变成左右结构（Row），而且TabBar不支持直接转成上下结构，所以只有另辟蹊径。从左右结构变成上下结构旋转90度也能实现效果，基于此在做调整，让整个容器旋转90度的时候，TabBar的选项则也被旋转了90度，从视觉效果上看就是倒置的，大致效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e67a5415682147f2b6d2ada5c8918a42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=YeJyVPhIZ4DHskotFiWT1AJIQVI%3D" alt="image12.png" loading="lazy"/></p>
<p>所以我们对每个子项向反方向旋转90度即可还原显示。</p>
<p>对于TabView，原先的交互方式为左右滑动切换，现在变成左右结构了，那么交互方式得从左右变成上下，TabView不支持直接变成上下滑动，所以有两种方式解决：</p>
<p>一种是使用PageView，这个天生就支持上下滑动，但是如果使用这个，得维护PageController，同步TabBar的切换，有兴趣的可自行试一下。</p>
<p>另一种方式依然是旋转，我们将其旋转90度后，自然而然滑动手势从左右变成了上下，不过需要注意的是，子项依然要反方向旋转90度还原。</p>
<ol start="4">
<li>在右边（right）</li>
</ol>
<p>与在左边相比，只是结构倒序一下就行了。</p>
<p>简单的分析了如何实现，那么接下来就开始编写：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'customize_tab_indicator.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">tab bar 位置的枚举</span></span>
<span class="hljs-keyword">enum</span> TabBarPosition { top, bottom, left, right }

<span class="hljs-comment">/// <span class="markdown">抽取一些默认的属性</span></span>
BorderRadius ctDefaultIndicatorBorderRadius = BorderRadius.circular(<span class="hljs-number">10</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomizeTab</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> CustomizeTab({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">this</span>.tabBarHeight = kToolbarHeight,
    <span class="hljs-keyword">this</span>.tabBarBackgroundColor,
    <span class="hljs-keyword">this</span>.tabBarPadding = EdgeInsets.zero,
    <span class="hljs-keyword">this</span>.tabBarBorderRadius,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.tabs,
    <span class="hljs-keyword">this</span>.unselectedColor,
    <span class="hljs-keyword">this</span>.selectedColor,
    <span class="hljs-keyword">this</span>.tabBarOptionMargin = <span class="hljs-keyword">const</span> EdgeInsets.only(right: <span class="hljs-number">10</span>),
    <span class="hljs-keyword">this</span>.tabBarOptionPadding = EdgeInsets.zero,
    <span class="hljs-keyword">this</span>.indicatorColor = Colors.blue,
    <span class="hljs-keyword">this</span>.indicatorBorderRadius,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.tabViews,
    <span class="hljs-keyword">this</span>.initialIndex,
    <span class="hljs-keyword">this</span>.onChangeTabIndex,
    <span class="hljs-keyword">this</span>.position = TabBarPosition.top,
  });

  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的高度，默认为AppBar工具栏组件的高度</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> tabBarHeight;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的背景颜色</span></span>
  <span class="hljs-keyword">final</span> Color? tabBarBackgroundColor;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的内边距</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry tabBarPadding;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的圆角属性</span></span>
  <span class="hljs-keyword">final</span> BorderRadiusGeometry? tabBarBorderRadius;
  <span class="hljs-comment">/// <span class="markdown">tab 选项</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; tabs;
  <span class="hljs-comment">/// <span class="markdown">tab 选项未选中时的颜色</span></span>
  <span class="hljs-keyword">final</span> Color? unselectedColor;
  <span class="hljs-comment">/// <span class="markdown">tab 选项选中时的颜色</span></span>
  <span class="hljs-keyword">final</span> Color? selectedColor;
  <span class="hljs-comment">/// <span class="markdown">tab bar 选项每项的margin</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry tabBarOptionMargin;
  <span class="hljs-comment">/// <span class="markdown">tab bar 选项每项的padding(因为大概率每项的padding是一致的，所以进行抽取)</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry tabBarOptionPadding;
  <span class="hljs-comment">/// <span class="markdown">指示器的颜色</span></span>
  <span class="hljs-keyword">final</span> Color indicatorColor;
  <span class="hljs-comment">/// <span class="markdown">指示器的圆角属性</span></span>
  <span class="hljs-keyword">final</span> BorderRadius? indicatorBorderRadius;
  <span class="hljs-comment">/// <span class="markdown">tab 页面</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; tabViews;
  <span class="hljs-comment">/// <span class="markdown">初始化显示tab的索引</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> initialIndex;
  <span class="hljs-comment">/// <span class="markdown">当tab索引发生改变时的回调函数</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">int</span>)? onChangeTabIndex;
  <span class="hljs-comment">/// <span class="markdown">tab bar所在位置，默认为top</span></span>
  <span class="hljs-keyword">final</span> TabBarPosition position;

  <span class="hljs-meta">@override</span>
  State&lt;CustomizeTab&gt; createState() =&gt; _CustomizeTabState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CustomizeTabState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">CustomizeTab</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-keyword">late</span> TabController _controller;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();

    _controller = TabController(
      length: widget.tabs.length,
      vsync: <span class="hljs-keyword">this</span>,
      initialIndex: widget.initialIndex ?? <span class="hljs-number">0</span>,
    )..addListener(() {
      <span class="hljs-comment">// indexIsChanging主要作用就是标识TabController是否正处于索引切换过程中。</span>
      <span class="hljs-comment">// 点击切换，在执行动画期间为true，用户手势操作结束后且动画完成为false</span>
      <span class="hljs-comment">// 滑动切换为false</span>
      <span class="hljs-comment">// 使用indexIsChanging来判断当前tab变化是否完成，完成了就执行回调</span>
      <span class="hljs-keyword">if</span> (!_controller.indexIsChanging) {
        widget.onChangeTabIndex?.call(_controller.index);
      }
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-comment">/// <span class="markdown">对每个tab加内边距</span></span>
  Widget _buildTabOption(Widget tab) {
    <span class="hljs-keyword">final</span> Widget tabOption = Padding(
      padding: widget.tabBarOptionPadding,
      child: tab,
    );

    <span class="hljs-comment">// 如果是left和right，因为外层的TabBar容器旋转了90度</span>
    <span class="hljs-comment">// 那Tab选项就旋转-90度还原，达到视觉的统一</span>
    <span class="hljs-keyword">if</span> (widget.position == TabBarPosition.left || widget.position == TabBarPosition.right) {
      <span class="hljs-keyword">return</span> RotatedBox(
        quarterTurns: <span class="hljs-number">-1</span>,
        child: tabOption,
      );
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> tabOption;
    }
  }

  <span class="hljs-comment">/// <span class="markdown">构建TabBar</span></span>
  Widget _buildTabBar() {
    <span class="hljs-keyword">final</span> Widget tabBar = Container(
      width: <span class="hljs-built_in">double</span>.infinity,
      height: widget.tabBarHeight,
      padding: widget.tabBarPadding,
      decoration: BoxDecoration(
        color: widget.tabBarBackgroundColor,
        borderRadius: widget.tabBarBorderRadius,
      ),
      child: TabBar(
        controller: _controller,
        indicator: CustomizeTabIndicator(
          color: widget.indicatorColor,
          radius: widget.indicatorBorderRadius
              ?? ctDefaultIndicatorBorderRadius,
        ),
        isScrollable: <span class="hljs-keyword">true</span>,
        dividerHeight: <span class="hljs-number">0</span>,
        labelPadding: widget.tabBarOptionMargin,
        tabAlignment: TabAlignment.start,
        unselectedLabelColor: widget.unselectedColor,
        labelColor: widget.selectedColor,
        tabs: widget.tabs.map((tab) =&gt; _buildTabOption(tab)).toList(),
      ),
    );

    <span class="hljs-keyword">if</span> (widget.position == TabBarPosition.left || widget.position == TabBarPosition.right) {
      <span class="hljs-comment">// 如果是left和right，则旋转90度，</span>
      <span class="hljs-keyword">return</span> RotatedBox(
        quarterTurns: <span class="hljs-number">1</span>,
        child: tabBar,
      );
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> tabBar;
    }
  }

  Widget _buildTabView(BoxConstraints boxConstraints) {
    <span class="hljs-keyword">final</span> EdgeInsets tabBarPadding = widget.tabBarPadding.resolve(TextDirection.ltr);

    <span class="hljs-keyword">return</span> widget.position == TabBarPosition.top || widget.position == TabBarPosition.bottom ? SizedBox(
      width: <span class="hljs-built_in">double</span>.infinity,
      height: boxConstraints.maxHeight -
          widget.tabBarHeight -
          tabBarPadding.top -
          tabBarPadding.bottom,
      child: TabBarView(
        controller: _controller,
        children: widget.tabViews,
      ),
    ) : SizedBox(
      <span class="hljs-comment">// 如果是left或者right，则宽高设置交换，并且将TabBarView旋转90度</span>
      width: boxConstraints.maxWidth -
          widget.tabBarHeight -
          tabBarPadding.top -
          tabBarPadding.bottom,
      height: <span class="hljs-built_in">double</span>.infinity,
      child: RotatedBox(
        quarterTurns: <span class="hljs-number">1</span>,
        child: TabBarView(
          controller: _controller,
          <span class="hljs-comment">// 因为TabBarView旋转了90度，对应的Tab项要旋转-90度还原</span>
          children: widget.tabViews.map((tabView) =&gt; RotatedBox(
            quarterTurns: <span class="hljs-number">-1</span>,
            child: tabView,
          )).toList(),
        ),
      ),
    );
  }

  <span class="hljs-comment">/// <span class="markdown">构建tab</span></span>
  Widget _buildTab(BoxConstraints boxConstraints) {
    <span class="hljs-built_in">List</span>&lt;Widget&gt; children = [
      _buildTabBar(),
      _buildTabView(boxConstraints),
    ];

    <span class="hljs-comment">// 如果是bottom和right，则渲染的结构会倒置</span>
    <span class="hljs-keyword">if</span> (widget.position == TabBarPosition.bottom
        || widget.position == TabBarPosition.right) {
      children = children.reversed.toList();
    }

    <span class="hljs-comment">// 如果是top或者bottom，则是上下结构</span>
    <span class="hljs-comment">// 如果是left或者right，则是左右结构</span>
    <span class="hljs-keyword">return</span> widget.position == TabBarPosition.top || widget.position == TabBarPosition.bottom
        ? Column(
          children: children,
        )
        : Row(
          children: children,
        );
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 通过父容器的约束动态构建子部件</span>
    <span class="hljs-keyword">return</span> LayoutBuilder(
      builder: (_, BoxConstraints boxConstraints) =&gt; _buildTab(boxConstraints),
    );
  }
}
</code></pre>
<p>完成编码后就开始测试使用：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'../widgets/page19/customize_tab.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page19</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> Page19({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;Page19&gt; createState() =&gt; _Page19State();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-comment">// 用于动态切换tab bar的位置</span>
  TabBarPosition _tabBarPosition = TabBarPosition.top;

  <span class="hljs-comment">/// <span class="markdown">构建tab项</span></span>
  Widget _buildTab(<span class="hljs-built_in">String</span> txt) {
    <span class="hljs-keyword">return</span> Text(
      txt,
      style: <span class="hljs-keyword">const</span> TextStyle(
        fontSize: <span class="hljs-number">14</span>,
      ),
    );
  }

  <span class="hljs-comment">/// <span class="markdown">构建tab view</span></span>
  Widget _buildTabView(<span class="hljs-built_in">String</span> txt) {
    <span class="hljs-keyword">return</span> Container(
      padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">20</span>),
      color: Colors.grey,
      child: Column(
        children: [
          Container(
            width: <span class="hljs-built_in">double</span>.infinity,
            height: <span class="hljs-number">60</span>,
            decoration: BoxDecoration(
              color: Colors.amber,
              borderRadius: BorderRadius.circular(<span class="hljs-number">20</span>),
            ),
            alignment: Alignment.center,
            child: Text(txt),
          )
        ],
      ),
    );
  }

  <span class="hljs-comment">/// <span class="markdown">改变tab bar的位置</span></span>
  <span class="hljs-keyword">void</span> _onChangePosition(TabBarPosition tabBarPosition) {
    setState(() {
      _tabBarPosition = tabBarPosition;
    });
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">100</span>,),

          Expanded(
            child: CustomizeTab(
              tabBarHeight: <span class="hljs-number">100</span>,
              tabBarBackgroundColor: Colors.amber,
              tabBarPadding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(
                horizontal: <span class="hljs-number">20</span>,
              ),
              unselectedColor: Colors.black,
              selectedColor: Colors.white,
              tabBarOptionPadding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(
                horizontal: <span class="hljs-number">15</span>,
                vertical: <span class="hljs-number">5</span>,
              ),
              indicatorColor: Colors.orange,
              position: _tabBarPosition,
              onChangeTabIndex: (index) {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前的索引为：<span class="hljs-subst">$index</span>'</span>);
              },
              tabs: [<span class="hljs-string">'tab1'</span>, <span class="hljs-string">'tab2'</span>, <span class="hljs-string">'tab3'</span>, <span class="hljs-string">'tab4'</span>, <span class="hljs-string">'tab5'</span>].map(
                (item) =&gt; _buildTab(item),
              ).toList(),
              tabViews: [<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>, <span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>].map(
                (item) =&gt; _buildTabView(item),
              ).toList(),
            ),
          ),

          Container(
            height: <span class="hljs-number">200</span>,
            color: Colors.black,
            padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="hljs-number">20</span>),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                ElevatedButton(
                  onPressed: () =&gt; _onChangePosition(TabBarPosition.left),
                  child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'左'</span>),
                ),
                ElevatedButton(
                  onPressed: () =&gt; _onChangePosition(TabBarPosition.right),
                  child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'右'</span>),
                ),
                ElevatedButton(
                  onPressed: () =&gt; _onChangePosition(TabBarPosition.top),
                  child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'上'</span>),
                ),
                ElevatedButton(
                  onPressed: () =&gt; _onChangePosition(TabBarPosition.bottom),
                  child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'下'</span>),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/361ac0f9e57142edbf19456dddcae10f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=qADqaxBzNYF1%2By%2FuM051d7dcj%2B4%3D" alt="image13.gif" loading="lazy"/></p>
<p>至此我们就简单封装了一个tab，极大的方便了使用。</p>
<p>感兴趣的也可以关注我的微信公众号【前端学习小营地】，不定时会分享一些小功能～</p>
<p>文章到此就结束了，感谢阅读，拜拜～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 组件的组合模式之道 (Composition Pattern)]]></title>    <link>https://juejin.cn/post/7577675494067896346</link>    <guid>https://juejin.cn/post/7577675494067896346</guid>    <pubDate>2025-11-29T14:46:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577675494067896346" data-draft-id="7577693903018360858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 组件的组合模式之道 (Composition Pattern)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-29T14:46:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iMonster"/> <meta itemprop="url" content="https://juejin.cn/user/1785262612681832"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 组件的组合模式之道 (Composition Pattern)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1785262612681832/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iMonster
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T14:46:32.000Z" title="Sat Nov 29 2025 14:46:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基于 React Universe Conf 2025 中 Fernando Rojo 的演讲《Composition is all you need》，以下是关于如何使用**组合模式（Composition Pattern）**重构复杂 React 组件的教程和代码总结。</p>
<hr/>
<h2 data-id="heading-0">React 组件的组合模式之道 (Composition Pattern)</h2>
<h3 data-id="heading-1">1. 核心问题：单体组件的陷阱 (The Monolith Trap)</h3>
<p>在开发初期，我们通常创建一个简单的组件（如 <code>Composer</code> 输入框）。随着需求增加（支持多态、编辑模式、转发模式等），我们往往通过添加 <code>Boolean</code> 属性来控制功能。</p>
<p><strong>反模式代码示例：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ 典型的“单体”组件，充满条件判断</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Composer</span>(<span class="hljs-params">{ 
  onSubmit, 
  isThread, 
  isEditingMessage, 
  initialText, 
  onCancel 
}</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"composer"</span>&gt;</span>
      {/* 只有非编辑模式才支持拖拽 */}
      {!isEditingMessage &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">DropZone</span> /&gt;</span>}
      
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">{initialText}</span> /&gt;</span>
      
      {/* 线程模式下的额外选项 */}
      {isThread &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Checkbox</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"Also send to channel"</span> /&gt;</span>}
      
      <span class="hljs-tag">&lt;<span class="hljs-name">Footer</span>&gt;</span>
        {/* 只有非编辑模式才显示附件按钮 */}
        {!isEditingMessage &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">AttachmentButton</span> /&gt;</span>}
        
        {/* 提交按钮逻辑复杂 */}
        {isEditingMessage ? (
           <span class="hljs-tag">&lt;&gt;</span>
             <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onCancel}</span>&gt;</span>Cancel<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
             <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onSubmit}</span>&gt;</span>Save<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
           <span class="hljs-tag">&lt;/&gt;</span>
        ) : (
           <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onSubmit}</span>&gt;</span>Send<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Footer</span>&gt;</span></span>
    &lt;/div&gt;
  );
}
</code></pre>
<p><strong>缺点：</strong> 代码难以维护，条件渲染（Ternary Hell）泛滥，且容易出现不可能的状态组合。</p>
<hr/>
<h3 data-id="heading-2">2. 解决方案：组合模式 (Composition)</h3>
<p>与其通过属性（Props）告诉组件<strong>做什么</strong>，不如通过子组件（Children）直接<strong>构建</strong>组件。这种方式类似于 <code>Radix UI</code> 的设计理念。</p>
<p>我们将大组件拆分为多个小的、职责单一的子组件，并通过 <code>Context</code> 共享状态。</p>
<h4 data-id="heading-3">基础架构代码</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 1. 创建 Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ComposerContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// 2. Provider 组件：管理状态和对外接口</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ComposerProvider</span> = (<span class="hljs-params">{ children, state, actions, meta }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ComposerContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">state</span>, <span class="hljs-attr">actions</span>, <span class="hljs-attr">meta</span> }}&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ComposerContext.Provider</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// 3. 子组件：消费 Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ComposerInput</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { state, actions } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ComposerContext</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">value</span>=<span class="hljs-string">{state.text}</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> actions.update(e.target.value)} 
    /&gt;</span>
  );
};

<span class="hljs-comment">// ... 其他子组件 (Composer.Header, Composer.Footer, etc.)</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">3. 实战重构：构建不同的 Composer</h3>
<p>通过组合，我们可以在不修改内部逻辑的情况下，构建出完全不同的 UI 变体。</p>
<h4 data-id="heading-5">场景 A：基础频道输入框 (Channel Composer)</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChannelComposer</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 使用自定义 Hook 获取全局频道逻辑</span>
  <span class="hljs-keyword">const</span> { state, actions } = <span class="hljs-title function_">useChannelLogic</span>(); 

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Composer.Provider</span> <span class="hljs-attr">state</span>=<span class="hljs-string">{state}</span> <span class="hljs-attr">actions</span>=<span class="hljs-string">{actions}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Composer.DropZone</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Frame</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Header</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Input</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Footer</span>&gt;</span>
          {/* 使用封装好的通用操作组 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.CommonActions</span> /&gt;</span> 
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.SubmitButton</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Footer</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Frame</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Provider</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-6">场景 B：编辑消息输入框 (Edit Message Composer)</h4>
<p><strong>需求差异：</strong></p>
<ol>
<li>不需要拖拽上传 (<code>DropZone</code>)。</li>
<li>底部按钮不同（取消/保存）。</li>
<li>某些操作按钮不可见（如附件）。</li>
</ol>
<p><strong>组合实现：</strong>
我们只需要<strong>不渲染</strong>不需要的组件，并<strong>替换</strong>底部的按钮即可，无需任何 <code>Boolean</code> 属性。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">EditMessageComposer</span>(<span class="hljs-params">{ messageId, initialText, onCancel }</span>) {
  <span class="hljs-keyword">const</span> { state, actions } = <span class="hljs-title function_">useEditMessageLogic</span>(messageId, initialText);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Composer.Provider</span> <span class="hljs-attr">state</span>=<span class="hljs-string">{state}</span> <span class="hljs-attr">actions</span>=<span class="hljs-string">{actions}</span>&gt;</span>
      {/* 移除 DropZone */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Frame</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Header</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Input</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Footer</span>&gt;</span>
          {/* 手动列出需要的 Action，而不是用通用的 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.FormatText</span> /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Emoji</span> /&gt;</span>
          
          {/* 自定义底部按钮布局 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex gap-2"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onCancel}</span>&gt;</span>Cancel<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{actions.submit}</span>&gt;</span>Save<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Footer</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Frame</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Provider</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h3 data-id="heading-7">4. 进阶技巧：状态提升与解耦 (Lift Your State)</h3>
<p>这是该演讲最核心的观点。<strong>状态管理应该与 UI 组件解耦。</strong></p>
<p><code>Composer</code> 的 UI 组件（Input, Footer 等）不应该知道状态是来自于 <code>useState</code>（本地状态）还是 <code>useGlobalStore</code>（全局同步状态）。它们只负责渲染 Provider 提供的数据。</p>
<h4 data-id="heading-8">场景 C：转发消息 (Forward Message)</h4>
<p><strong>复杂点：</strong></p>
<ol>
<li>这是一个模态框（Modal）。</li>
<li>提交按钮在 Composer <strong>外部</strong>（Modal 的 Footer）。</li>
<li>状态是临时的（Ephemeral），不需要同步到服务器。</li>
</ol>
<p><strong>代码实现：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ForwardMessageDialog</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 状态提升：在父组件控制状态</span>
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 定义符合 Provider 接口的 state 和 actions</span>
  <span class="hljs-keyword">const</span> state = { text };
  <span class="hljs-keyword">const</span> actions = { 
    <span class="hljs-attr">update</span>: setText, 
    <span class="hljs-attr">submit</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Forwarding:"</span>, text) 
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Dialog</span>&gt;</span>
      {/* 2. 将本地状态注入 Provider */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Provider</span> <span class="hljs-attr">state</span>=<span class="hljs-string">{state}</span> <span class="hljs-attr">actions</span>=<span class="hljs-string">{actions}</span> <span class="hljs-attr">meta</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">inputRef</span> }}&gt;</span>
        
        {/* UI 部分 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Frame</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Input</span> /&gt;</span> 
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Footer</span>&gt;</span>
             {/* 只有少量的操作按钮 */}
             <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Emoji</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Footer</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Frame</span>&gt;</span>

        {/* 3. 外部按钮也可以消费同一个 Context */}
        <span class="hljs-tag">&lt;<span class="hljs-name">Dialog.Footer</span>&gt;</span>
           <span class="hljs-tag">&lt;<span class="hljs-name">CopyLinkButton</span> /&gt;</span>
           {/* 这个按钮在 Composer 外部，但能触发提交 */}
           <span class="hljs-tag">&lt;<span class="hljs-name">ForwardButton</span> /&gt;</span> 
        <span class="hljs-tag">&lt;/<span class="hljs-name">Dialog.Footer</span>&gt;</span>

      <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Dialog</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 外部按钮实现</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ForwardButton</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 因为被包在 Composer.Provider 内，依然可以访问 context</span>
  <span class="hljs-keyword">const</span> { actions } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ComposerContext</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{actions.submit}</span>&gt;</span>Forward<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-9">总结：为什么要这样做？</h3>
<ol>
<li><strong>消除“布尔地狱”：</strong> 不再需要传递 <code>isEditing={true}</code>、<code>isForwarding={true}</code> 并在组件深处做判断。需要什么功能，就渲染什么组件。</li>
<li><strong>状态灵活性：</strong> 同一套 UI 组件可以配合 <code>useState</code>（本地）、<code>Redux/Zustand</code>（全局）甚至 <code>Ref</code> 一起工作，只要通过 Provider 传入即可。</li>
<li><strong>可维护性：</strong> 当需要在“转发”功能中修改按钮样式时，你只需要修改 <code>ForwardMessageDialog</code>，完全不会影响到“频道聊天”的代码。</li>
<li><strong>AI 友好：</strong> 这种结构化、声明式的代码更容易被 AI 理解和生成，减少了 AI 产生幻觉（Hallucination）或逻辑错误的概率。</li>
</ol>
<p><strong>一句话总结：</strong>
不要把所有的逻辑塞进一个组件里。<strong>提升你的状态 (Lift your state)，组合你的内部组件 (Compose your internals)。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML5敲击乐 PART--1]]></title>    <link>https://juejin.cn/post/7577715145121644598</link>    <guid>https://juejin.cn/post/7577715145121644598</guid>    <pubDate>2025-11-29T15:53:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577715145121644598" data-draft-id="7576838095519580211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML5敲击乐 PART--1"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-11-29T15:53:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="izx888"/> <meta itemprop="url" content="https://juejin.cn/user/1241762540820323"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML5敲击乐 PART--1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1241762540820323/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    izx888
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:53:43.000Z" title="Sat Nov 29 2025 15:53:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HTML5 敲击乐：前端开发实战 PART-1 —— 用代码“弹奏”你的第一架网页钢琴</h2>
<p>在当今的 Web 开发世界中，前端不仅是用户与产品之间的桥梁，更是创意与技术融合的舞台。而作为前端三大基石——<strong>HTML、CSS 和 JavaScript</strong>——它们分别构建了网页的“骨骼”、“外貌”与“灵魂”。本文将以一个趣味十足的小项目 <strong>“HTML5 模拟钢琴”</strong> 为切入点，带你系统理解前端开发的核心逻辑，并掌握高效实现交互式应用的关键技巧。</p>
<hr/>
<h3 data-id="heading-1">一、前端三剑客：结构 × 样式 × 行为</h3>
<p>任何现代网页都离不开这三位“主角”的协同工作：</p>
<ul>
<li><strong>HTML（超文本标记语言）</strong> ：负责定义页面的<strong>结构与语义</strong>。<br/>
在模拟钢琴中，每个琴键都是一个 HTML 元素（如 <code>&lt;div&gt;</code> 或 <code>&lt;span&gt;</code>），共同组成完整的键盘布局。</li>
<li><strong>CSS（层叠样式表）</strong> ：掌控页面的<strong>视觉表现</strong>。<br/>
它让白键洁白、黑键深邃，还能通过 <code>:hover</code>、<code>:active</code> 等伪类添加点击反馈，甚至用 <code>transition</code> 实现平滑动画，赋予琴键“生命感”。</li>
<li><strong>JavaScript</strong>：驱动页面的<strong>交互行为</strong>。<br/>
它监听用户的点击或键盘输入，触发对应音符的播放，真正让这架“数字钢琴”发出声音——这才是“敲击乐”的核心！</li>
</ul>
<blockquote>
<p><strong>设计哲学</strong>：结构、样式、行为分离（Separation of Concerns）是现代前端开发的基本原则。清晰的职责划分，让代码更易维护、扩展和协作。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、HTML5 基础：从骨架搭建开始</h3>
<p>HTML5 是当前 Web 标准的主流版本，其标志性开头是：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
</code></pre>
<p>这一行声明告诉浏览器：“请以标准模式解析此文档”，避免因“怪异模式”（Quirks Mode）导致的渲染不一致问题。</p>
<p>使用 VS Code 等现代编辑器时，只需输入 <code>!</code> 并按 <code>Tab</code>，即可自动生成完整的 HTML5 模板，极大提升开发效率。</p>
<h4 data-id="heading-3">构建琴键结构</h4>
<p>在 <code>&lt;body&gt;</code> 中，我们用以下方式组织琴键：</p>
<ul>
<li>使用 <code>&lt;div class="piano"&gt;</code> 作为整个钢琴的容器；</li>
<li>内部嵌套多个 <code>&lt;div class="key white"&gt;</code> 和 <code>&lt;div class="key black"&gt;</code> 分别代表白键与黑键。</li>
</ul>
<blockquote>
<p><strong>小知识</strong>：</p>
<ul>
<li><code>&lt;div&gt;</code> 是<strong>块级元素</strong>，默认独占一行，可设置宽高，适合做布局容器；</li>
<li><code>&lt;span&gt;</code> 是<strong>行内元素</strong>，尺寸由内容决定，通常用于包裹文本。<br/>
理解二者区别，是掌握页面布局的第一步。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-4">三、CSS 样式：打造逼真的钢琴外观</h3>
<p>有了结构，下一步就是“化妆”——用 CSS 赋予琴键真实感：</p>
<ul>
<li>
<p><strong>基础样式</strong>：设置白键背景为白色、黑键为黑色，调整宽度、高度、边距；</p>
</li>
<li>
<p><strong>布局方案</strong>：推荐使用 <strong>Flexbox</strong>（而非过时的 <code>float</code>）实现琴键水平排列，代码简洁且响应友好；</p>
</li>
<li>
<p><strong>交互反馈</strong>：</p>
<ul>
<li><code>:hover</code>：鼠标悬停时轻微变色或加阴影；</li>
<li><code>:active</code>：点击瞬间产生“按下”效果；</li>
</ul>
</li>
<li>
<p><strong>增强质感</strong>：利用 <code>border-radius</code> 圆角、<code>box-shadow</code> 阴影、<code>transition</code> 过渡动画，让界面更具现代感。</p>
</li>
</ul>
<blockquote>
<p>示例片段：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.key</span><span class="hljs-selector-class">.white</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.1s</span>;
}
<span class="hljs-selector-class">.key</span><span class="hljs-selector-class">.white</span><span class="hljs-selector-pseudo">:active</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">2px</span>);
}
</code></pre>
</blockquote>
<hr/>
<h3 data-id="heading-5">四、JavaScript 行为：让钢琴真正“发声”</h3>
<p>这是项目最激动人心的部分——让点击变成音乐！</p>
<h4 data-id="heading-6">核心功能实现：</h4>
<ol>
<li>
<p><strong>事件监听</strong><br/>
为每个琴键绑定 <code>click</code> 事件，或监听全局 <code>keydown</code> 键盘事件（如 A/S/D 对应 Do/Re/Mi）。</p>
</li>
<li>
<p><strong>音频播放</strong><br/>
可选择两种方式：</p>
<ul>
<li><strong><code>&lt;audio&gt;</code> 标签预加载</strong>：简单直接，适合初学者；</li>
<li><strong>Web Audio API</strong>：更强大灵活，支持音效合成与精确控制（进阶方向）。</li>
</ul>
</li>
<li>
<p><strong>状态管理</strong><br/>
避免快速连点导致声音重叠，可通过节流（throttle）或记录“正在播放”状态来优化体验。</p>
</li>
</ol>
<h4 data-id="heading-7">模块化思维</h4>
<p>将功能拆分为独立函数：</p>
<ul>
<li><code>createPiano()</code>：动态生成琴键；</li>
<li><code>playNote(note)</code>：播放指定音符；</li>
<li><code>bindEvents()</code>：统一绑定交互逻辑。</li>
</ul>
<p>这样不仅提升可读性，也为后续扩展（如添加录音、节奏训练等）打下基础。</p>
<hr/>
<h3 data-id="heading-8">五、提效利器：现代前端开发工具链</h3>
<p>高效开发离不开这些“神助攻”：</p>
<ul>
<li><strong>Emmet 语法</strong>：<br/>
输入 <code>div.piano&gt;div.key*8</code> + <code>Tab</code>，秒速生成 8 个琴键结构；</li>
<li><strong>Live Server（VS Code 插件）</strong> ：<br/>
启动本地服务器，保存即自动刷新浏览器，所见即所得，调试效率翻倍。</li>
</ul>
<hr/>
<h3 data-id="heading-9">六、面试高频考点回顾</h3>
<p>在技术面试中，以下概念常被考察：</p>





















<table><thead><tr><th>问题</th><th>答案要点</th></tr></thead><tbody><tr><td><code>&lt;!DOCTYPE html&gt;</code> 的作用？</td><td>声明 HTML5 文档类型，确保浏览器以标准模式渲染，避免兼容性问题。</td></tr><tr><td>HTML 文件的本质是什么？</td><td>一种结构化文本文档，浏览器将其解析为 DOM 树，供 JS 操作。</td></tr><tr><td>块级 vs 行内元素的区别？</td><td>块级独占一行、可设宽高；行内不换行、尺寸由内容决定。</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">结语：从“敲代码”到“敲出旋律”</h3>
<p>通过“HTML5 模拟钢琴”这个小而美的项目，我们不仅实践了前端三剑客的协同开发流程，更体会到了<strong>用代码创造交互乐趣</strong>的魅力。从 <code>! + Tab</code> 快速搭建骨架，到 Emmet 提升编码速度，再到 Live Server 实现实时预览——现代前端开发已变得前所未有的高效与直观。</p>
<p>未来，随着 AI 与 Web 技术的深度融合，前端工程师的角色将更像一位“数字导演”：用技术编排用户体验，用创意传递情感价值。而这一切的起点，正是对 HTML5 的深刻理解与灵活运用。</p>
<blockquote>
<p><strong>动手试试吧！</strong><br/>
打开你的编辑器，敲下第一行代码，让浏览器为你奏响属于程序员的旋律 🎹✨</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openresty容器导出火焰图]]></title>    <link>https://juejin.cn/post/7577689171222708274</link>    <guid>https://juejin.cn/post/7577689171222708274</guid>    <pubDate>2025-11-29T15:28:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171222708274" data-draft-id="7577675494067372058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openresty容器导出火焰图"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T15:28:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风的归宿55"/> <meta itemprop="url" content="https://juejin.cn/user/2840793779297303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openresty容器导出火焰图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793779297303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风的归宿55
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:28:02.000Z" title="Sat Nov 29 2025 15:28:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们线上使用的是容器部署的openresty作为网关，用于处理请求转发以及使用lua代理处理部分请求。有时候会出现在流量没有增加特别多，但是openresty的cpu跑满的情况。为了能快速查出瓶颈并解决问题，我们增加了一些监控，用于排查各种情况导致的nginx cpu升高问题。这里主要介绍下 openresty导出cpu火焰图的方式，通过cpu火焰图可以快速发现占用cpu高的函数，从而协助快速定位问题以及进行性能优化。</p>
<p>目前网上的文档大部分都是在主机上导出火焰图的，这篇文章介绍了导出<strong>容器部署的openresty cpu火焰图</strong>的方式。</p>
<p>这里先给两张示例图，cpu火焰图分为nginx的c代码 和 处理业务的lua代码 两种。</p>
<p><strong>nginx火焰图</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ce1033bd3fe4aa5a3661e0e2283d7b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034882&amp;x-signature=ZvomBb9PZgmf6Mi81QnR%2FUvIJY4%3D" alt="1.jpg" loading="lazy"/></p>
<p><strong>lua火焰图</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50d1abdb2e444cce9c6d8d331a0ac434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034882&amp;x-signature=G8ebqv5LdweKcxWUIYuqxPy%2FYiI%3D" alt="2.jpg" loading="lazy"/></p>
<h3 data-id="heading-0">导出火焰图流程</h3>
<h5 data-id="heading-1">一、 准备工作</h5>
<h6 data-id="heading-2">1. 安装内核debug包</h6>
<p>在导出火焰图之前，有一些准备工作需要处理，首先是安装一些内核的debug信息包和开发包，这样在导出火焰图时程序才知道当前执行的函数名称，不然导出的火焰图只有一些很简略的信息，比如[unknown]，[libc-2.28.so] 这种。</p>
<p>安装时需要先根据系统版本找到对应的debug包，输入命令uname -a查询操作系统版本，这里以3.10.0-1160.76.1.el7.x86_64为例，首先找到下载对应内核debug包的网站，然后在机器上通过wget下载。</p>
<pre><code class="hljs language-bash" lang="bash">需要下载的包
kernel-debuginfo-3.10.0-1160.76.1.el7.x86_64.rpm
kernel-debuginfo-common-x86_64-3.10.0-1160.76.1.el7.x86_64.rpm
kernel-devel-3.10.0-1160.76.1.el7.x86_64.rpm

下载网站参考
http://debuginfo.centos.org/
https://buildlogs.centos.org/c7.2009.u.x86_64/kernel/

执行命令下载
wget http://debuginfo.centos.org/7/x86_64/kernel-debuginfo-3.10.0-1160.76.1.el7.x86_64.rpm 
wget http://debuginfo.centos.org/7/x86_64/kernel-debuginfo-common-x86_64-3.10.0-1160.76.1.el7.x86_64.rpm 
wget https://buildlogs.centos.org/c7.2009.u.x86_64/kernel/20220810161826/3.10.0-1160.76.1.el7.x86_64/kernel-devel-3.10.0-1160.76.1.el7.x86_64.rpm

安装
rpm -ivh *3.10.0-1160.76.1.el7.x86_64.rpm
</code></pre>
<h6 data-id="heading-3">2. 安装perf，stapxx和FlameGraph</h6>
<p>perf用于导出nginx c语言的cpu剖析信息，stapxx用于导出lua代码的cpu剖析信息，而FlameGraph则是用于将导出的cpu剖析信息转换为可阅读的svg格式的火焰图。</p>
<ul>
<li>perf：执行yum install -y perf命令即可。</li>
<li>stapxx： git clone <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenresty%2Fstapxx.git" target="_blank" title="https://github.com/openresty/stapxx.git" ref="nofollow noopener noreferrer">github.com/openresty/s…</a></li>
<li>FlameGraph： git clone <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbrendangregg%2FFlameGraph.git" target="_blank" title="https://github.com/brendangregg/FlameGraph.git" ref="nofollow noopener noreferrer">github.com/brendangreg…</a></li>
</ul>
<h6 data-id="heading-4">3. 制作导出lua火焰图的工具镜像</h6>
<p>这里制作一个镜像，用于导出容器内的openresty的cpu剖析信息。需要制作镜像的原因我在这里说明下。</p>
<p>之前尝试过几种方式导出容器内的openresty的cpu剖析信息，但是都不好处理。</p>
<ul>
<li>
<p>直接在主机上导出：因为导出lua的cpu剖析信息的话，需要有对应openresty版本的debug包，不然无法显示函数名称。因此尝试了在主机上编译并安装 容器中使用版本的openresty，然后加上debug信息，但是发现很难编译出和容器中完全一样的nginx二进制，导出cpu信息时会报错说 openresty的构建ID 不一致，并且主机和容器里面的虚拟主机系统有区别，会导致stapxx等程序有问题，比如在主机上运行stapxx时，需要修改对应stapxx/tapset/luajit.sxx的代码，改为32位的，但是容器中启动openresty的操作系统是64位的，就会报错。</p>
</li>
<li>
<p>编译一个包含主机内核的debug包的容器，在容器内运行stapxx导出lua的cpu剖析信息，但是导出的信息会变少甚至报错，因为docker中的操作系统其实不包含内核，因此在docker容器中安装主机的内核debug包会报错，但是安装容器内操作系统的debug包，又会找不到信息。因为实际上运行的操作系统内核只有主机上的内核。</p>
<p><strong>使用镜像的原因总结：</strong></p>
</li>
</ul>
<ol>
<li>在主机上很难打包出和容器中完全一致的openresty，因此直接使用线上的容器openresty制作一个镜像，解决openresty版本一致的问题。</li>
<li>需要安装openresty的debug信息包，因为使用容器openresty，这个就好处理了，直接在生成镜像时运行命令debuginfo-install -y openresty-1.21.4.1-1.el8.x86_64 安装</li>
<li>一个主机只有一个内核，就是主机上的操作系统版本的内核，但是容器内启动openresty的操作系统版本可能和主机的不一致，这个怎么处理。  其实不用管容器中的操作系统，因为导出cpu剖析信息时是需要从内核抓取函数代码的，而内核的版本是主机上操作系统的版本，因此在容器中挂载主机上的 /lib/modules，/sys/kernel/debug和/usr/src/kernels目录，这样stapxx就能找到执行函数对应的名称了。</li>
</ol>
<p>下面提供下打镜像的文件和流程。</p>
<pre><code class="hljs language-bash" lang="bash">dockerfile文件：
FROM nginx:10.9.0
RUN yum -y install systemtap &amp;&amp; debuginfo-install -y openresty-1.21.4.1-1.el8.x86_64 
ENTRYPOINT [<span class="hljs-string">"tail"</span>, <span class="hljs-string">"-f"</span>, <span class="hljs-string">"/dev/null"</span>]

生成镜像：
docker build -t openresty-debug:2.0.0 .

容器启动命令是：
docker run --<span class="hljs-built_in">rm</span> --name debug --pid=host -v /lib/modules:/lib/modules -v /root/debug:/root/debug -v /sys/kernel/debug:/sys/kernel/debug -v /usr/src/kernels:/usr/src/kernels --privileged --entrypoint /bin/bash  openresty-debug:2.0.0  -c <span class="hljs-string">"cd /root/debug/stapxx/ &amp;&amp; export PATH=\$PWD:\$PATH &amp;&amp; ./samples/lj-lua-stacks.sxx --skip-badvars --arg time=30 -x <span class="hljs-variable">$top_nginx_worker_pid</span> &gt; /root/debug/a.bt"</span>

其中/lib/modules，/sys/kernel/debug和/usr/src/kernels是把主机上的kernel debug包挂载进来
之前安装的stapxx，FlameGraph 我是放在/root/debug文件夹下，如果需要放在其他目录下，可以修改docker启动命令，将目录挂载到容器中。

--pid=host是让容器使用主机的pid空间，才能查到nginx的pid
</code></pre>
<h6 data-id="heading-5">4. 修改stapxx脚本的代码</h6>
<p>直接使用stapxx运行可能会出现如下所示的错误。</p>
<pre><code class="hljs language-rust" lang="rust">semantic error: unable to find member <span class="hljs-symbol">'gcptr32</span>' <span class="hljs-keyword">for</span> <span class="hljs-title class_">struct</span> <span class="hljs-title function_ invoke__">GCRef</span> (alternatives: gcptr64): operator '<span class="hljs-punctuation">-&gt;</span>' at :<span class="hljs-number">449</span>:<span class="hljs-number">100</span>
        source:     gco = @<span class="hljs-title function_ invoke__">cast</span>(pt, <span class="hljs-string">"GCproto"</span>, <span class="hljs-string">"/usr/local/openresty/luajit/lib/libluajit-5.1.so.2.1.0"</span>)<span class="hljs-punctuation">-&gt;</span>chunkname<span class="hljs-punctuation">-&gt;</span>gcptr32
        
或者

semantic error: unable to find member <span class="hljs-symbol">'fr</span>' <span class="hljs-keyword">for</span> <span class="hljs-title class_">union</span> <span class="hljs-title function_ invoke__">TValue</span> (alternatives: gcr, i, n, it, <span class="hljs-type">u32</span>, <span class="hljs-type">u64</span>, ftsz, it64): operator '<span class="hljs-punctuation">-&gt;</span>' at :<span class="hljs-number">75</span>:<span class="hljs-number">83</span>
        source:     @<span class="hljs-title function_ invoke__">cast</span>(@tv, <span class="hljs-string">"TValue"</span>, <span class="hljs-string">"/usr/local/openresty/luajit/lib/libluajit-5.1.so.2.1.0"</span>)<span class="hljs-punctuation">-&gt;</span>fr<span class="hljs-punctuation">-&gt;</span>tp<span class="hljs-punctuation">-&gt;</span>ftsz
</code></pre>
<p>这是因为openresty会因为系统不同而使用不同的宏编译，具体的openresty代码可以通过 bundule/LuaJIT-2.1-20220411/src/lj_obj.h和lj_arch.h文件进行查看，主要是openresty使用了和stapxx默认代码的不同位数的指针导致报错，这里只需要修改stapxx的 tapset/luajit.sxx的代码，根据报错的提示进行修改就可以了，比如将gcptr32批量替换成gcptr64。</p>
<pre><code class="hljs language-rust" lang="rust">可选，下载openresty代码查看：
wget https:<span class="hljs-comment">//openresty.org/download/openresty-1.21.4.1.tar.gz</span>
主要查看bundule/LuaJIT-<span class="hljs-number">2.1</span>-<span class="hljs-number">20220411</span>/src/lj_obj.h和lj_arch.h  ，需要对比stapxx中结构和openresty中的结果，然后进行修改

执行命令批量替换：
sed -i <span class="hljs-symbol">'s</span>/gcptr32/gcptr64/g' stapxx/tapset/luajit.sxx
sed -i <span class="hljs-symbol">'s</span>/<span class="hljs-punctuation">-&gt;</span>fr<span class="hljs-punctuation">-&gt;</span>tp<span class="hljs-punctuation">-&gt;</span>ftsz/<span class="hljs-punctuation">-&gt;</span>ftsz/g' stapxx/tapset/luajit.sxx
sed -i <span class="hljs-symbol">'s</span>/<span class="hljs-punctuation">-&gt;</span>fr<span class="hljs-punctuation">-&gt;</span>tp<span class="hljs-punctuation">-&gt;</span>pcr<span class="hljs-punctuation">-&gt;</span>ptr32/<span class="hljs-punctuation">-&gt;</span>ftsz/g' stapxx/tapset/luajit.sxx
sed -i <span class="hljs-symbol">'s</span>/<span class="hljs-punctuation">-&gt;</span>ptr32/<span class="hljs-punctuation">-&gt;</span>ptr64/g' stapxx/tapset/luajit.sxx
sed -i <span class="hljs-symbol">'s</span>/<span class="hljs-punctuation">-&gt;</span>fr<span class="hljs-punctuation">-&gt;</span>func/<span class="hljs-punctuation">-&gt;</span>gcr/g' stapxx/tapset/luajit.sxx
</code></pre>
<h5 data-id="heading-6">二、 导出openresty火焰图</h5>
<h6 data-id="heading-7">1. 导出nginx的c语言的火焰图</h6>
<p>这个比较简单，只要执行perf命令就可以导出，然后通过FlameGraph转成火焰图，其中$top_nginx_worker_pid变量是nginx worker的pid</p>
<pre><code class="hljs language-bash" lang="bash">perf record -F 99 -g -p <span class="hljs-string">"<span class="hljs-variable">$top_nginx_worker_pid</span>"</span> -- <span class="hljs-built_in">sleep</span> 30
perf script | ./FlameGraph/stackcollapse-perf.pl| ./FlameGraph/flamegraph.pl &gt; ./ngx_c_flame.svg
</code></pre>
<h6 data-id="heading-8">2. 导出lua的火焰图</h6>
<p>通过执行docker命令导出lua的cpu剖析信息，然后通过FlameGraph转成火焰图。</p>
<pre><code class="hljs language-bash" lang="bash">docker run --<span class="hljs-built_in">rm</span> --name debug --pid=host -v /lib/modules:/lib/modules -v /root/debug:/root/debug -v /sys/kernel/debug:/sys/kernel/debug -v /usr/src/kernels:/usr/src/kernels --privileged --entrypoint /bin/bash  openresty-debug:2.0.0  -c <span class="hljs-string">"cd /root/debug/stapxx/ &amp;&amp; export PATH=\$PWD:\$PATH &amp;&amp; ./samples/lj-lua-stacks.sxx --skip-badvars --arg time=30 -x <span class="hljs-variable">$top_nginx_worker_pid</span> &gt; /root/debug/a.bt"</span>

./FlameGraph/stackcollapse-stap.pl a.bt &gt; a.cbt
./FlameGraph/flamegraph.pl a.cbt  &gt; ngx_lua_flame.svg
</code></pre>
<h6 data-id="heading-9">3. 参考脚本</h6>
<p>最后贴一下整体的生成脚本，用于参考</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-function"><span class="hljs-title">get_top_cpu_nginx_worker_pid</span></span>() {
    <span class="hljs-comment"># 使用 top 命令获取进程信息，筛选出 Nginx worker 进程</span>
    <span class="hljs-built_in">local</span> top_pid=$(top -b -n 1 | awk <span class="hljs-string">'/nginx/ {print $1, $9}'</span> | <span class="hljs-built_in">sort</span> -k2 -nr | <span class="hljs-built_in">head</span> -n 1 | awk <span class="hljs-string">'{print $1}'</span>)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$top_pid</span>"</span>
}

<span class="hljs-comment"># 调用函数并输出结果</span>
top_nginx_worker_pid=$(get_top_cpu_nginx_worker_pid)
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$top_nginx_worker_pid</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"CPU 使用率最高的 Nginx worker 进程 PID: <span class="hljs-variable">$top_nginx_worker_pid</span>"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"未找到 Nginx worker 进程。"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">cd</span> /root/debug

<span class="hljs-built_in">echo</span> <span class="hljs-string">"perf nginx cpu flame,wait 30s"</span>
perf record -F 99 -g -p <span class="hljs-string">"<span class="hljs-variable">$top_nginx_worker_pid</span>"</span> -- <span class="hljs-built_in">sleep</span> 30
perf script | ./FlameGraph/stackcollapse-perf.pl| ./FlameGraph/flamegraph.pl &gt; ./ngx_c_flame.svg

<span class="hljs-built_in">echo</span> <span class="hljs-string">"perf nginx cpu flame done"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"stap nginx lua flame,wait 30s"</span>

docker run --<span class="hljs-built_in">rm</span> --name debug --pid=host -v /lib/modules:/lib/modules -v /root/debug:/root/debug -v /sys/kernel/debug:/sys/kernel/debug -v /usr/src/kernels:/usr/src/kernels --privileged --entrypoint /bin/bash  openresty-debug:2.0.0  -c <span class="hljs-string">"cd /root/debug/stapxx/ &amp;&amp; export PATH=\$PWD:\$PATH &amp;&amp; ./samples/lj-lua-stacks.sxx --skip-badvars --arg time=30 -x <span class="hljs-variable">$top_nginx_worker_pid</span> &gt; /root/debug/a.bt"</span>

./FlameGraph/stackcollapse-stap.pl a.bt &gt; a.cbt
./FlameGraph/flamegraph.pl a.cbt  &gt; ngx_lua_flame.svg

<span class="hljs-built_in">echo</span> <span class="hljs-string">"stap nginx lua flame done"</span>
</code></pre>
<p>这里也贴一下stapxx/tapset/luajit.sxx的代码，用于参考：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// module luajit</span>


<span class="hljs-variable">@use</span> nginx.lua


$*<span class="hljs-attribute">pt </span>:= <span class="hljs-variable">@cast</span>(pt, <span class="hljs-string">"GCproto"</span>, <span class="hljs-string">"$^libluajit_path"</span>)


<span class="hljs-comment">//@define LJ_TLIGHTUD  %( 4294967292 %)</span>
<span class="hljs-variable">@define</span> LJ_TLIGHTUD  %( <span class="hljs-number">4294901760</span> %)
<span class="hljs-variable">@define</span> LJ_TSTR  %( <span class="hljs-number">4294967291</span> %)
<span class="hljs-variable">@define</span> LJ_TUDATA  %( <span class="hljs-number">4294967283</span> %)
<span class="hljs-variable">@define</span> LJ_TFUNC  %( <span class="hljs-number">4294967287</span> %)


<span class="hljs-variable">@define</span> TSTR    %( <span class="hljs-number">4</span> %)
<span class="hljs-variable">@define</span> TUPVAL  %( <span class="hljs-number">5</span> %)
<span class="hljs-variable">@define</span> TTHREAD %( <span class="hljs-number">6</span> %)
<span class="hljs-variable">@define</span> TPROTO  %( <span class="hljs-number">7</span> %)
<span class="hljs-variable">@define</span> TFUNC   %( <span class="hljs-number">8</span> %)
<span class="hljs-variable">@define</span> TTRACE  %( <span class="hljs-number">9</span> %)
<span class="hljs-variable">@define</span> TCDATA  %( <span class="hljs-number">10</span> %)
<span class="hljs-variable">@define</span> TTAB    %( <span class="hljs-number">11</span> %)
<span class="hljs-variable">@define</span> TUDATA  %( <span class="hljs-number">12</span> %)

<span class="hljs-variable">@define</span> CTSHIFT_NUM  %( <span class="hljs-number">28</span> %)
<span class="hljs-variable">@define</span> CT_HASSIZE   %( <span class="hljs-number">5</span> %)
<span class="hljs-variable">@define</span> CT_ATTRIB    %( <span class="hljs-number">8</span> %)
<span class="hljs-variable">@define</span> CTMASK_CID   %( <span class="hljs-number">0</span>xffff %)

<span class="hljs-variable">@define</span> FF_LUA %( <span class="hljs-number">0</span> %)
<span class="hljs-variable">@define</span> FF_C   %( <span class="hljs-number">1</span> %)

<span class="hljs-variable">@define</span> FRAME_LUA   %( <span class="hljs-number">0</span> %)
<span class="hljs-variable">@define</span> FRAME_CONT  %( <span class="hljs-number">2</span> %)
<span class="hljs-variable">@define</span> FRAME_TYPE  %( <span class="hljs-number">3</span> %)
<span class="hljs-variable">@define</span> FRAME_P     %( <span class="hljs-number">4</span> %)
<span class="hljs-variable">@define</span> FRAME_TYPEP %( (<span class="hljs-variable">@FRAME_TYPE</span>|<span class="hljs-variable">@FRAME_P</span>) %)

<span class="hljs-variable">@define</span> NO_BCPOS    %( ~<span class="hljs-number">0</span> %)

<span class="hljs-variable">@define</span> sizeof_GCtab  %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCtab"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_TValue  %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"TValue"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_lua_State %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"struct lua_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCfunc %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"union GCfunc"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCupval %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCupval"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCstr %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCstr"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCudata %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCudata"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_Node %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"Node"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCfuncC %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCfuncC"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCfuncL %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCfuncL"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCRef %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCRef"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCproto %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCproto"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCtrace %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCtrace"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCcdata %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCcdata"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_IRIns %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"IRIns"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_IRRef %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"IRRef"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_SnapShot %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"SnapShot"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_SnapEntry %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"SnapEntry"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_K64Array %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"K64Array"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_ptr %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"global_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;strmask %)
<span class="hljs-variable">@define</span> sizeof_GCcdataVar %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCcdataVar"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_BCIns %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"BCIns"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">strdata</span>(s) %(
    (<span class="hljs-variable">@s</span> + <span class="hljs-variable">@sizeof_GCstr</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_gc</span>(frame) %(
    <span class="hljs-variable">@cast</span>(<span class="hljs-variable">@frame</span>, <span class="hljs-string">"TValue"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;gcr-&gt;gcptr64
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_ftsz</span>(tv) %(
    <span class="hljs-variable">@cast</span>(<span class="hljs-variable">@tv</span>, <span class="hljs-string">"TValue"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;ftsz
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_type</span>(f) %(
    (<span class="hljs-variable">@frame_ftsz</span>(<span class="hljs-variable">@f</span>) &amp; <span class="hljs-variable">@FRAME_TYPE</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_typep</span>(f) %(
    (<span class="hljs-variable">@frame_ftsz</span>(<span class="hljs-variable">@f</span>) &amp; <span class="hljs-variable">@FRAME_TYPEP</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_islua</span>(f) %(
    (<span class="hljs-variable">@frame_type</span>(<span class="hljs-variable">@f</span>) == <span class="hljs-variable">@FRAME_LUA</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_iscont</span>(f) %(
    (<span class="hljs-variable">@frame_typep</span>(<span class="hljs-variable">@f</span>) == <span class="hljs-variable">@FRAME_CONT</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_pc</span>(tv) %(
    <span class="hljs-variable">@cast</span>(<span class="hljs-variable">@tv</span>, <span class="hljs-string">"TValue"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;ftsz
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_contpc</span>(f) %(
    (<span class="hljs-variable">@frame_pc</span>(<span class="hljs-variable">@f</span>) - <span class="hljs-number">1</span> * <span class="hljs-variable">@sizeof_BCIns</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">bc_a</span>(i) %(
    ((<span class="hljs-variable">@i</span> &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0</span>xff)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_prevl</span>(f) %(
    (<span class="hljs-variable">@f</span> - (<span class="hljs-number">1</span> + <span class="hljs-variable">@bc_a</span>(<span class="hljs-built_in">user_uint32</span>(<span class="hljs-variable">@frame_pc</span>(<span class="hljs-variable">@f</span>) - <span class="hljs-number">4</span>))) * <span class="hljs-variable">@sizeof_TValue</span>)
%)

<span class="hljs-variable">@define</span> FRAME_VARG  %( <span class="hljs-number">3</span> %)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_isvarg</span>(f) %(
    (<span class="hljs-variable">@frame_typep</span>(<span class="hljs-variable">@f</span>) == <span class="hljs-variable">@FRAME_VARG</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_sized</span>(f) %(
    (<span class="hljs-variable">@frame_ftsz</span>(<span class="hljs-variable">@f</span>) &amp; ~<span class="hljs-variable">@FRAME_TYPEP</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_prevd</span>(f) %(
    (<span class="hljs-variable">@f</span> - <span class="hljs-variable">@frame_sized</span>(<span class="hljs-variable">@f</span>))
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">isluafunc</span>(fn) %(
    (<span class="hljs-variable">@cast</span>(<span class="hljs-variable">@fn</span>, <span class="hljs-string">"GCfunc"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;c-&gt;ffid == <span class="hljs-variable">@FF_LUA</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">isffunc</span>(fn) %(
    (<span class="hljs-variable">@cast</span>(<span class="hljs-variable">@fn</span>, <span class="hljs-string">"GCfunc"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;c-&gt;ffid &gt; <span class="hljs-variable">@FF_C</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">funcproto</span>(fn) %(
    (<span class="hljs-variable">@cast</span>(<span class="hljs-variable">@fn</span>, <span class="hljs-string">"GCfunc"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;l-&gt;pc-&gt;ptr64 - <span class="hljs-variable">@sizeof_GCproto</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">proto_bc</span>(pt) %(
    (<span class="hljs-variable">@pt</span> + <span class="hljs-variable">@sizeof_GCproto</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">proto_bcpos</span>(pt, pc) %(
    ((<span class="hljs-variable">@pc</span> - <span class="hljs-variable">@proto_bc</span>(<span class="hljs-variable">@pt</span>)) / <span class="hljs-variable">@sizeof_BCIns</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">proto_lineinfo</span>(pt) %(
    <span class="hljs-variable">@cast</span>(<span class="hljs-variable">@pt</span>, <span class="hljs-string">"GCproto"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;lineinfo-&gt;ptr64
%)


global luajit_cfunc_cache


function <span class="hljs-built_in">luajit_frame_func</span>(f) {
    <span class="hljs-selector-tag">gco</span> = @<span class="hljs-selector-tag">frame_gc</span>(f)
    $*<span class="hljs-selector-tag">gco</span> := @<span class="hljs-selector-tag">cast</span>(gco, <span class="hljs-string">"GCobj"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">fn</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_G</span>(L)
{
    $*L := @cast(L, "lua_State", "$^libluajit_path")
    return $*L-&gt;glref-&gt;ptr64
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_gcref</span>(r)
{
    $*r := @cast(r, "GCRef", "$^libluajit_path")
    return $*r-&gt;gcptr64
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_objlen</span>(o, gct, g)
{
    $*o := @cast(o, "GCobj", "$^libluajit_path")
    if (gct == @TSTR) {
        /*
        if ($*o-&gt;str-&gt;len == 0) {
            printf("empty string found.\n")
        }
        */
        <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">str-</span>&gt;<span class="hljs-selector-tag">len</span> + <span class="hljs-number">1</span> + @<span class="hljs-selector-tag">sizeof_GCstr</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TTAB</span>) {
        <span class="hljs-selector-tag">t</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">tab</span>
        $*<span class="hljs-selector-tag">t</span> := @<span class="hljs-selector-tag">cast</span>(t, <span class="hljs-string">"GCtab"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">asize</span> = $*<span class="hljs-selector-tag">t-</span>&gt;<span class="hljs-selector-tag">asize</span>
        <span class="hljs-selector-tag">hmask</span> = $*<span class="hljs-selector-tag">t-</span>&gt;<span class="hljs-selector-tag">hmask</span>

        <span class="hljs-selector-tag">n</span> = <span class="hljs-number">0</span>
        <span class="hljs-selector-tag">if</span> (hmask &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-selector-tag">n</span> += @<span class="hljs-selector-tag">sizeof_Node</span> * (hmask + <span class="hljs-number">1</span>)
        }

        <span class="hljs-selector-tag">if</span> (asize &gt; <span class="hljs-number">0</span> &amp;&amp; $*t-&gt;colo &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-selector-tag">n</span> += @<span class="hljs-selector-tag">sizeof_TValue</span> * <span class="hljs-selector-tag">asize</span>
        }

        <span class="hljs-selector-tag">if</span> ($*t-&gt;colo) {
            <span class="hljs-selector-tag">n</span> += ($*t-&gt;colo &amp; <span class="hljs-number">0</span>x7f) * @<span class="hljs-selector-tag">sizeof_TValue</span> + @<span class="hljs-selector-tag">sizeof_GCtab</span>

        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">n</span> += @<span class="hljs-selector-tag">sizeof_GCtab</span>
        }

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">n</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TUDATA</span>) {
        <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">ud-</span>&gt;<span class="hljs-selector-tag">len</span> + @<span class="hljs-selector-tag">sizeof_GCudata</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TPROTO</span>) {
        <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">sizept</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TTHREAD</span>) {
        <span class="hljs-selector-tag">L</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">th</span>
        <span class="hljs-comment">//printf("open upval: %p\n", luajit_gcref(&amp;$*L-&gt;openupval))</span>
        <span class="hljs-comment">//printf("lua_State: %d\n", @sizeof_lua_State)</span>
        <span class="hljs-selector-tag">n</span> = @<span class="hljs-selector-tag">sizeof_lua_State</span> + $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">stacksize</span> * @<span class="hljs-selector-tag">sizeof_TValue</span>
        <span class="hljs-selector-tag">p</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">openupval</span>
        <span class="hljs-selector-tag">while</span> (p) {
            <span class="hljs-selector-tag">o</span> = <span class="hljs-selector-tag">luajit_gcref</span>(p)
            <span class="hljs-selector-tag">if</span> (o == <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">break</span>;
            }

            $*<span class="hljs-selector-tag">o</span> := @<span class="hljs-selector-tag">cast</span>(o, <span class="hljs-string">"GCobj"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
            <span class="hljs-selector-tag">gct</span> = $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gch-</span>&gt;<span class="hljs-selector-tag">gct</span>
            <span class="hljs-selector-tag">size</span> = <span class="hljs-selector-tag">luajit_objlen</span>(o, gct, g)
            <span class="hljs-comment">//printf("%s: %d\n", typenames[@TSTR], size)</span>
            <span class="hljs-selector-tag">n</span> += <span class="hljs-selector-tag">size</span>
            <span class="hljs-selector-tag">p</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gch-</span>&gt;<span class="hljs-selector-tag">nextgc</span>
        }

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">n</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TFUNC</span>) {
        <span class="hljs-selector-tag">fn</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">fn</span>
        $*<span class="hljs-selector-tag">fn</span> := @<span class="hljs-selector-tag">cast</span>(fn, <span class="hljs-string">"GCfunc"</span>, <span class="hljs-string">"$^libluajit_path"</span>);
        <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@isluafunc</span>(fn)) {
            <span class="hljs-selector-tag">n</span> = $*<span class="hljs-selector-tag">fn-</span>&gt;<span class="hljs-selector-tag">l-</span>&gt;<span class="hljs-selector-tag">nupvalues</span>
            <span class="hljs-comment">//n = 0</span>
            <span class="hljs-selector-tag">return</span> @<span class="hljs-selector-tag">sizeof_GCfuncL</span> <span class="hljs-selector-tag">-</span> @<span class="hljs-selector-tag">sizeof_GCRef</span> + @<span class="hljs-selector-tag">sizeof_GCRef</span> * <span class="hljs-selector-tag">n</span>
        }

        <span class="hljs-selector-tag">n</span> = $*<span class="hljs-selector-tag">fn-</span>&gt;<span class="hljs-selector-tag">c-</span>&gt;<span class="hljs-selector-tag">nupvalues</span>
        <span class="hljs-comment">//n = 0</span>
        <span class="hljs-selector-tag">return</span> @<span class="hljs-selector-tag">sizeof_GCfuncC</span> <span class="hljs-selector-tag">-</span> @<span class="hljs-selector-tag">sizeof_TValue</span> + @<span class="hljs-selector-tag">sizeof_TValue</span> * <span class="hljs-selector-tag">n</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TUPVAL</span>) {
        <span class="hljs-selector-tag">return</span> @<span class="hljs-selector-tag">sizeof_GCupval</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TTRACE</span>) {
        <span class="hljs-selector-tag">T</span> = <span class="hljs-selector-tag">o</span>
        $*<span class="hljs-selector-tag">T</span> := @<span class="hljs-selector-tag">cast</span>(T, <span class="hljs-string">"GCtrace"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">return</span> ((<span class="hljs-variable">@sizeof_GCtrace</span> + <span class="hljs-number">7</span>) &amp; ~<span class="hljs-number">7</span>)
               + ($*T-&gt;nins - $*T-&gt;nk) * @<span class="hljs-selector-tag">sizeof_IRIns</span>
               + $*<span class="hljs-selector-tag">T-</span>&gt;<span class="hljs-selector-tag">nsnap</span> * @<span class="hljs-selector-tag">sizeof_SnapShot</span>
               + $*<span class="hljs-selector-tag">T-</span>&gt;<span class="hljs-selector-tag">nsnapmap</span> * @<span class="hljs-selector-tag">sizeof_SnapEntry</span>
    }

    $*<span class="hljs-selector-tag">g</span> := @<span class="hljs-selector-tag">cast</span>(g, <span class="hljs-string">"global_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TCDATA</span>) {
        <span class="hljs-selector-tag">cd</span> = <span class="hljs-selector-tag">o</span>
        $*<span class="hljs-selector-tag">cd</span> := @<span class="hljs-selector-tag">cast</span>(cd, <span class="hljs-string">"GCcdata"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">if</span> ($*cd-&gt;marked &amp; <span class="hljs-number">0</span>x80) {
            <span class="hljs-comment">/* cdata is a vector */</span>
            <span class="hljs-selector-tag">cdatav</span> = <span class="hljs-selector-tag">cd</span> <span class="hljs-selector-tag">-</span> @<span class="hljs-selector-tag">sizeof_GCcdataVar</span>
            $*<span class="hljs-selector-tag">cdatav</span> := @<span class="hljs-selector-tag">cast</span>(cdatav, <span class="hljs-string">"GCcdataVar"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
            <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">cdatav-</span>&gt;<span class="hljs-selector-tag">len</span> + $*<span class="hljs-selector-tag">cdatav-</span>&gt;<span class="hljs-selector-tag">extra</span>
        }

        <span class="hljs-comment">/* cdata is not a vector */</span>
        <span class="hljs-selector-tag">cts</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">ctype_state-</span>&gt;<span class="hljs-selector-tag">ptr64</span>
        $*<span class="hljs-selector-tag">cts</span> := @<span class="hljs-selector-tag">cast</span>(cts, <span class="hljs-string">"CTState"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">id</span> = $*<span class="hljs-selector-tag">cd-</span>&gt;<span class="hljs-selector-tag">ctypeid</span>
        <span class="hljs-selector-tag">ct</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">cts-</span>&gt;<span class="hljs-selector-tag">tab</span><span class="hljs-selector-attr">[id]</span>
        $*<span class="hljs-selector-tag">ct</span> := @<span class="hljs-selector-tag">cast</span>(ct, <span class="hljs-string">"CType"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">while</span> (($*ct-&gt;info &gt;&gt; <span class="hljs-variable">@CTSHIFT_NUM</span>) == <span class="hljs-variable">@CT_ATTRIB</span>) {
            <span class="hljs-comment">//printf("XXX skipping c type attribute\n")</span>
            <span class="hljs-selector-tag">ct</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">cts-</span>&gt;<span class="hljs-selector-tag">tab</span><span class="hljs-selector-attr">[$*ct-&gt;info &amp; @CTMASK_CID]</span>
        }

        <span class="hljs-selector-tag">if</span> (($*ct-&gt;info &gt;&gt; <span class="hljs-variable">@CTSHIFT_NUM</span>) &lt;= <span class="hljs-variable">@CT_HASSIZE</span>) {
            <span class="hljs-selector-tag">sz</span> = $*<span class="hljs-selector-tag">ct-</span>&gt;<span class="hljs-selector-tag">size</span>

        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">sz</span> = @<span class="hljs-selector-tag">sizeof_ptr</span>
        }

        <span class="hljs-comment">//printf("GCcdata size: %d\n", @sizeof_GCcdata)</span>
        <span class="hljs-selector-tag">return</span> @<span class="hljs-selector-tag">sizeof_GCcdata</span> + <span class="hljs-selector-tag">sz</span>
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_jit_state_size</span>(J)
{
    $*J := @cast(J, "jit_State", "$^libluajit_path")

    ir_k64_size = 0
    // In the newer revision of luajit, 64-bit constants are represented as an
    // array of TValue. Uncomment following code if the luajit being used
    // is using linked list to represent 64-bit constants. As the 64-bit
    // constants don't take lots of memory, it does not seems to be a big deal
    // if you don't uncomment following code for the older luajit.
    //
    /*
    $*k := @cast(k, "K64Array", "$^libluajit_path")
    for (k = $*J-&gt;k64-&gt;ptr64; <span class="hljs-selector-tag">k</span>; ) {
        <span class="hljs-selector-tag">ir_k64_size</span> += @<span class="hljs-selector-tag">sizeof_K64Array</span>
        <span class="hljs-selector-tag">k</span> = $*<span class="hljs-selector-tag">k-</span>&gt;<span class="hljs-selector-tag">next-</span>&gt;<span class="hljs-selector-tag">ptr64</span>
    }
    <span class="hljs-selector-tag">if</span> (ir_k64_size) {
        <span class="hljs-comment">//printf("64-bit constants: %d\n", ir_k64_size)</span>
    }
    */

    sizesnapmap = $*J-&gt;sizesnapmap * <span class="hljs-variable">@sizeof_SnapEntry</span>
    if (sizesnapmap) {
        <span class="hljs-comment">//printf("JIT snap map buffer size: %d\n", sizesnapmap)</span>
    }

    sizesnap = $*J-&gt;sizesnap * <span class="hljs-variable">@sizeof_SnapShot</span>
    if (sizesnap) {
        <span class="hljs-comment">//printf("JIT snap buffer size: %d\n", sizesnap)</span>
    }

    sizeirbuf = ($*J-&gt;irtoplim - $*J-&gt;irbotlim) * <span class="hljs-variable">@sizeof_IRIns</span>
    if (sizeirbuf) {
        <span class="hljs-comment">//printf("JIT IR buffer size: %d\n", sizeirbuf)</span>
    }

    sizetrace = $*J-&gt;sizetrace * <span class="hljs-variable">@sizeof_GCRef</span>
    if (sizetrace) {
        <span class="hljs-comment">//printf("JIT trace array size: %d\n", sizetrace)</span>
    }

    return ir_k64_size + sizesnapmap + sizesnap + sizeirbuf + sizetrace
}


<span class="hljs-comment">/* returns a TValue* pointer */</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_index2adr</span>(L, idx)
{
    <span class="hljs-selector-tag">if</span> (idx &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">o</span> = $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">base</span> + (idx - <span class="hljs-number">1</span>) * @<span class="hljs-selector-tag">sizeof_TValue</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">o</span> &lt; $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">top</span> ? <span class="hljs-selector-tag">o</span> : <span class="hljs-number">0</span>
    }

    <span class="hljs-selector-tag">top</span> = $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">top</span>

    <span class="hljs-selector-tag">if</span> (idx != <span class="hljs-number">0</span> &amp;&amp; -idx &lt;= top - $*L-&gt;base) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">top</span> + <span class="hljs-selector-tag">idx</span> * @<span class="hljs-selector-tag">sizeof_TValue</span>;
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span>
}


<span class="hljs-comment">/* convert GCstr to stap string */</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_unbox_gcstr</span>(gcs)
{
    <span class="hljs-selector-tag">if</span> (gcs == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> ""
    }

    $*<span class="hljs-selector-tag">gcs</span> := @<span class="hljs-selector-tag">cast</span>(gcs, <span class="hljs-string">"GCstr"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
    <span class="hljs-selector-tag">src</span> = @<span class="hljs-selector-tag">strdata</span>(gcs)
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">user_string_n_warn</span>(src, $*gcs-&gt;len)
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_tostring</span>(L, idx)
{
    $*o := @cast(o, "TValue", "$^libluajit_path")
    o = luajit_index2adr(L, idx)
    if (o == 0) {
        return "&lt;nil&gt;"
    }

    <span class="hljs-selector-tag">if</span> ($*o-&gt;it == <span class="hljs-variable">@LJ_TSTR</span>) {
        <span class="hljs-selector-tag">gco</span> = $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gcr-</span>&gt;<span class="hljs-selector-tag">gcptr64</span>
        $*<span class="hljs-selector-tag">gco</span> := @<span class="hljs-selector-tag">cast</span>(gco, <span class="hljs-string">"GCobj"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">s</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">str</span>
        $*<span class="hljs-selector-tag">s</span> := @<span class="hljs-selector-tag">cast</span>(s, <span class="hljs-string">"GCstr"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">user_string_n</span>(s + <span class="hljs-variable">@sizeof_GCstr</span>, $*s-&gt;len)
    }

    <span class="hljs-selector-tag">return</span> "&lt;<span class="hljs-selector-tag">unknown</span>&gt;"
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_tostringlen</span>(L, idx)
{
    $*o := @cast(o, "TValue", "$^libluajit_path")
    o = luajit_index2adr(L, idx)
    if (o == 0) {
        return -1
    }

    <span class="hljs-selector-tag">if</span> ($*o-&gt;it == <span class="hljs-variable">@LJ_TSTR</span>) {
        <span class="hljs-selector-tag">gco</span> = $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gcr-</span>&gt;<span class="hljs-selector-tag">gcptr64</span>
        $*<span class="hljs-selector-tag">gco</span> := @<span class="hljs-selector-tag">cast</span>(gco, <span class="hljs-string">"GCobj"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">s</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">str</span>
        $*<span class="hljs-selector-tag">s</span> := @<span class="hljs-selector-tag">cast</span>(s, <span class="hljs-string">"GCstr"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">s-</span>&gt;<span class="hljs-selector-tag">len</span>
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">-1</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_touserdata</span>(L, idx)
{
    $*o := @cast(o, "TValue", "$^libluajit_path")
    o = luajit_index2adr(L, idx)
    if (o == 0) {
        return 0
    }

    <span class="hljs-comment">//printf("udata type: %d (%d)\n", $*o-&gt;it, ($*o-&gt;it &gt;&gt; 15))</span>

    <span class="hljs-selector-tag">if</span> ($*o-&gt;it == <span class="hljs-variable">@LJ_TUDATA</span>) {
        <span class="hljs-selector-tag">gco</span> = $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gcr-</span>&gt;<span class="hljs-selector-tag">gcptr64</span>
        <span class="hljs-selector-tag">ud</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">ud</span>
        $*<span class="hljs-selector-tag">ud</span> := @<span class="hljs-selector-tag">cast</span>(ud, <span class="hljs-string">"GCudata"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ud</span> + @<span class="hljs-selector-tag">sizeof_GCudata</span>
    }

    <span class="hljs-selector-tag">if</span> ($*o-&gt;it == <span class="hljs-variable">@LJ_TLIGHTUD</span>) {
        <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">u64</span> <span class="hljs-selector-tag">&amp;</span> <span class="hljs-number">0</span><span class="hljs-selector-tag">x7fffffffffff</span>
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_proto_chunkname</span>(pt) {
    <span class="hljs-selector-tag">gco</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">chunkname-</span>&gt;<span class="hljs-selector-tag">gcptr64</span>
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">str</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_debug_framepc</span>(L, T, fn, pt, nextframe) {
    <span class="hljs-comment">//printf("debug framepc: L=%p, fn=%p, nextframe = %p\\n", L, fn, nextframe)</span>
    <span class="hljs-selector-tag">if</span> (nextframe == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> @<span class="hljs-selector-tag">NO_BCPOS</span>
    }

    <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@frame_islua</span>(nextframe)) {
        <span class="hljs-selector-tag">ins</span> = @<span class="hljs-selector-tag">frame_pc</span>(nextframe);
        <span class="hljs-comment">//printf("frame is lua, ins = %p\\n", ins)</span>

    } <span class="hljs-selector-tag">else</span> <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@frame_iscont</span>(nextframe)) {
        <span class="hljs-comment">//println("frame is cont")</span>
        <span class="hljs-selector-tag">ins</span> = @<span class="hljs-selector-tag">frame_contpc</span>(nextframe)

    } <span class="hljs-selector-tag">else</span> {
        <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> add support for cframe */</span>
    }

    <span class="hljs-comment">//printf("debug framepc: ins = %p\\n", ins)</span>
    <span class="hljs-selector-tag">pos</span> = @<span class="hljs-selector-tag">proto_bcpos</span>(pt, ins) <span class="hljs-selector-tag">-</span> <span class="hljs-number">1</span>;
    <span class="hljs-selector-tag">sizebc</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">sizebc</span>
    <span class="hljs-selector-tag">if</span> (pos &gt; sizebc) {
        <span class="hljs-comment">//printf("Undo the effects of lj_trace_exit for JLOOP.\n")</span>
        <span class="hljs-selector-tag">if</span> (!T) {
            <span class="hljs-selector-tag">T</span> = <span class="hljs-selector-tag">ins</span> <span class="hljs-selector-tag">-</span> <span class="hljs-number">1</span> * @<span class="hljs-selector-tag">sizeof_BCIns</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">&amp;</span>@<span class="hljs-selector-tag">cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCtrace"</span>, <span class="hljs-string">"$^libluajit_path"</span>)<span class="hljs-selector-tag">-</span>&gt;<span class="hljs-selector-tag">startins</span>;
        }
        <span class="hljs-comment">//printf("startpc: %d\n", $*T-&gt;startpc-&gt;ptr64)</span>
        <span class="hljs-selector-tag">pos</span> = @<span class="hljs-selector-tag">proto_bcpos</span>(pt, $*T-&gt;startpc-&gt;ptr64);
        <span class="hljs-comment">//printf("Found adjusted position: %d\n", pos)</span>
    }
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">pos</span>;
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_debug_line</span>(pt, pc)
{
    <span class="hljs-selector-tag">lineinfo</span> = @<span class="hljs-selector-tag">proto_lineinfo</span>(pt)
    <span class="hljs-comment">//printf("lj_debug_line: lineinfo = %p, %x &lt;= %x\\n", lineinfo,</span>
           <span class="hljs-comment">//pc, $pt-&gt;sizebc)</span>
    <span class="hljs-selector-tag">sizebc</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">sizebc</span>

    <span class="hljs-selector-tag">if</span> (pc &lt;= sizebc &amp;&amp; lineinfo) {
        <span class="hljs-selector-tag">first</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">firstline</span>

        <span class="hljs-selector-tag">if</span> (pc == sizebc) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">first</span> + $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">numline</span>
        }

        <span class="hljs-selector-tag">if</span> (pc-- == <span class="hljs-number">0</span>) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">first</span>
        }

        <span class="hljs-selector-tag">if</span> ($*pt-&gt;numline &lt; <span class="hljs-number">256</span>) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">first</span> + @<span class="hljs-selector-tag">cast</span>(lineinfo, <span class="hljs-string">"uint8_t"</span>, <span class="hljs-string">"$^libluajit_path"</span>)<span class="hljs-selector-attr">[pc]</span>
        }

        <span class="hljs-selector-tag">if</span> ($*pt-&gt;numline &lt; <span class="hljs-number">65536</span>) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">first</span> + @<span class="hljs-selector-tag">cast</span>(lineinfo, <span class="hljs-string">"uint16_t"</span>, <span class="hljs-string">"$^libluajit_path"</span>)<span class="hljs-selector-attr">[pc]</span>
        }

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">first</span> + @<span class="hljs-selector-tag">cast</span>(lineinfo, <span class="hljs-string">"uint32_t"</span>, <span class="hljs-string">"$^libluajit_path"</span>)<span class="hljs-selector-attr">[pc]</span>
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">-1</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_debug_frameline</span>(L, T, fn, pt, nextframe)
{
    <span class="hljs-selector-tag">pc</span> = <span class="hljs-selector-tag">luajit_debug_framepc</span>(L, T, fn, pt, nextframe)
    <span class="hljs-selector-tag">if</span> (pc != <span class="hljs-variable">@NO_BCPOS</span>) {
        <span class="hljs-selector-tag">if</span> (pc &lt;= $*pt-&gt;sizebc) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">luajit_debug_line</span>(pt, pc)
        }
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">-1</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_debug_dumpstack</span>(L, T, depth, base, simple)
{
    <span class="hljs-selector-tag">level</span> = <span class="hljs-number">0</span>
    <span class="hljs-selector-tag">dir</span> = <span class="hljs-number">1</span>
    <span class="hljs-selector-tag">if</span> (depth &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">level</span> = ~<span class="hljs-selector-tag">depth</span>
        <span class="hljs-selector-tag">depth</span> = <span class="hljs-selector-tag">dir</span> = <span class="hljs-selector-tag">-1</span>
    }
    <span class="hljs-selector-tag">bt</span> = ""
    <span class="hljs-selector-tag">while</span> (level != depth) {
        <span class="hljs-comment">/* lj_debug_frame(L, level, &amp;size) {{{ */</span>
        <span class="hljs-selector-tag">bot</span> = $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">stack-</span>&gt;<span class="hljs-selector-tag">ptr64</span>
        <span class="hljs-selector-tag">found_frame</span> = <span class="hljs-number">0</span>
        <span class="hljs-selector-tag">tmp_level</span> = <span class="hljs-selector-tag">level</span>
        <span class="hljs-comment">/* Traverse frames backwards. */</span>
        <span class="hljs-selector-tag">for</span> (nextframe = frame = base - <span class="hljs-variable">@sizeof_TValue</span>; frame &gt; bot; ) {
            <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@frame_gc</span>(frame) == L) {
                <span class="hljs-selector-tag">tmp_level</span>++
            }

            <span class="hljs-selector-tag">if</span> (tmp_level-- == <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">size</span> = (nextframe - frame) / @<span class="hljs-selector-tag">sizeof_TValue</span>
                <span class="hljs-selector-tag">found_frame</span> = <span class="hljs-number">1</span>
                <span class="hljs-selector-tag">break</span>
            }
            <span class="hljs-selector-tag">nextframe</span> = <span class="hljs-selector-tag">frame</span>
            <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@frame_islua</span>(frame)) {
                <span class="hljs-selector-tag">frame</span> = @<span class="hljs-selector-tag">frame_prevl</span>(frame)

            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@frame_isvarg</span>(frame)) {
                    <span class="hljs-selector-tag">tmp_level</span>++;  <span class="hljs-comment">/* Skip vararg pseudo-frame. */</span>
                }

                <span class="hljs-selector-tag">frame</span> = @<span class="hljs-selector-tag">frame_prevd</span>(frame);
            }
        }

        <span class="hljs-selector-tag">if</span> (!found_frame) {
            <span class="hljs-selector-tag">frame</span> = <span class="hljs-number">0</span>
            <span class="hljs-selector-tag">size</span> = <span class="hljs-selector-tag">tmp_level</span>
        }
        <span class="hljs-comment">/* }}} */</span>

        <span class="hljs-selector-tag">if</span> (frame) {
            <span class="hljs-comment">//nextframe = size ? frame + size * @sizeof_TValue : 0</span>
            <span class="hljs-selector-tag">fn</span> = <span class="hljs-selector-tag">luajit_frame_func</span>(frame)
            <span class="hljs-selector-tag">if</span> (fn == <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">return</span> ""
            }
            <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@isluafunc</span>(fn)) {
                <span class="hljs-selector-tag">pt</span> = @<span class="hljs-selector-tag">funcproto</span>(fn)

                <span class="hljs-selector-tag">if</span> (simple) {
                    <span class="hljs-selector-tag">line</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">firstline</span>

                } <span class="hljs-selector-tag">else</span> {
                    <span class="hljs-selector-tag">line</span> = <span class="hljs-selector-tag">luajit_debug_frameline</span>(L, T, fn, pt, nextframe)
                    <span class="hljs-selector-tag">if</span> (line &lt; <span class="hljs-number">0</span>) {
                        <span class="hljs-selector-tag">line</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">firstline</span>
                        <span class="hljs-comment">//printf("using firstline %d\n", line)</span>

                    } <span class="hljs-selector-tag">else</span> {
                        <span class="hljs-comment">//printf("GOT the lineno %d\n", line)</span>
                    }
                }

                <span class="hljs-selector-tag">name</span> = <span class="hljs-selector-tag">luajit_proto_chunkname</span>(pt)  <span class="hljs-comment">/* GCstr *name */</span>
                <span class="hljs-selector-tag">if</span> (name == <span class="hljs-number">0</span>) {
                    <span class="hljs-selector-tag">return</span> ""
                }

                <span class="hljs-selector-tag">path</span> = <span class="hljs-selector-tag">luajit_unbox_gcstr</span>(name)
                <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">sprintf</span>(<span class="hljs-string">"%s:%d\n"</span>, path, line)

            } <span class="hljs-selector-tag">else</span> <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@isffunc</span>(fn)) {
                <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">sprintf</span>(<span class="hljs-string">"builtin#%d\n"</span>, $*fn-&gt;c-&gt;ffid)

            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-comment">/* C function */</span>
                <span class="hljs-selector-tag">cfunc</span> = $*<span class="hljs-selector-tag">fn-</span>&gt;<span class="hljs-selector-tag">c-</span>&gt;<span class="hljs-selector-tag">f</span>
                <span class="hljs-selector-tag">sym</span> = <span class="hljs-selector-tag">luajit_cfunc_cache</span><span class="hljs-selector-attr">[cfunc]</span>
                <span class="hljs-selector-tag">if</span> (sym == <span class="hljs-string">""</span>) {
                    <span class="hljs-selector-tag">sym</span> = <span class="hljs-selector-tag">sprintf</span>(<span class="hljs-string">"C:%s\n"</span>, <span class="hljs-built_in">usymname</span>(cfunc))
                    <span class="hljs-selector-tag">luajit_cfunc_cache</span><span class="hljs-selector-attr">[cfunc]</span> = <span class="hljs-selector-tag">sym</span>
                }
                <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">sym</span>
            }

        } <span class="hljs-selector-tag">else</span> <span class="hljs-selector-tag">if</span> (dir == <span class="hljs-number">1</span>) {
            <span class="hljs-selector-tag">break</span>

        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">level</span> <span class="hljs-selector-tag">-</span>= <span class="hljs-selector-tag">size</span>
        }
        <span class="hljs-selector-tag">level</span> += <span class="hljs-selector-tag">dir</span>
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">bt</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_cur_thread</span>(g)
{
    $*g := @cast(g, "global_State", "$^libluajit_path")
    gco = $*g-&gt;cur_L-&gt;gcptr64
    if (gco == 0) {
        return 0
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">th</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_get_trace</span>(g, traceno)
{
    <span class="hljs-selector-tag">GG</span> = <span class="hljs-selector-tag">g</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">&amp;</span>@<span class="hljs-selector-tag">cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GG_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)<span class="hljs-selector-tag">-</span>&gt;<span class="hljs-selector-tag">g</span>
    $*<span class="hljs-selector-tag">GG</span> := @<span class="hljs-selector-tag">cast</span>(GG, <span class="hljs-string">"GG_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
    <span class="hljs-selector-tag">J</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">GG-</span>&gt;<span class="hljs-selector-tag">J</span>
    $*<span class="hljs-selector-tag">J</span> := @<span class="hljs-selector-tag">cast</span>(J, <span class="hljs-string">"jit_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
    <span class="hljs-selector-tag">if</span> (J == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span>
    }

    <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">J-</span>&gt;<span class="hljs-selector-tag">trace</span><span class="hljs-selector-attr">[traceno]</span><span class="hljs-selector-tag">-</span>&gt;<span class="hljs-selector-tag">gcptr64</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_trace_starting_func</span>(g, trace)
{
    $*trace := @cast(trace, "GCtrace", "$^libluajit_path")
    gco = $*trace-&gt;startpt-&gt;gcptr64
    if (gco == 0) {
        return ""
    }

    <span class="hljs-selector-tag">pt</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">pt</span>

    <span class="hljs-selector-tag">firstline</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">firstline</span>

    <span class="hljs-selector-tag">name</span> = <span class="hljs-selector-tag">luajit_proto_chunkname</span>(pt)  <span class="hljs-comment">/* GCstr *name */</span>
    <span class="hljs-selector-tag">path</span> = <span class="hljs-selector-tag">luajit_unbox_gcstr</span>(name)

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">sprintf</span>(<span class="hljs-string">"%s:%d"</span>, path, firstline)
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_print_backtrace</span>(simple)
{
    <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@defined</span>(<span class="hljs-variable">@var</span>(<span class="hljs-string">"globalL"</span>, <span class="hljs-string">"$^exec_path"</span>))) {
        <span class="hljs-selector-tag">mL</span> = @<span class="hljs-selector-tag">var</span>(<span class="hljs-string">"globalL"</span>, <span class="hljs-string">"$^exec_path"</span>)

    } <span class="hljs-selector-tag">else</span> {
        <span class="hljs-selector-tag">mL</span> = <span class="hljs-selector-tag">ngx_lua_get_main_lua_vm</span>()
    }

    <span class="hljs-selector-tag">if</span> (mL == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> ""
    }

    <span class="hljs-selector-tag">g</span> = <span class="hljs-selector-tag">luajit_G</span>(mL)
    <span class="hljs-selector-tag">if</span> (g == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> ""
    }

    <span class="hljs-selector-tag">L</span> = <span class="hljs-selector-tag">luajit_cur_thread</span>(g)
    <span class="hljs-selector-tag">if</span> (L == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> ""
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">luajit_backtrace</span>(L, g, simple)
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_backtrace</span>(L, g, simple)
{
    <span class="hljs-selector-tag">bt</span> = ""

    <span class="hljs-selector-tag">vmstate</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">vmstate</span>
    <span class="hljs-selector-tag">if</span> (vmstate &gt;= <span class="hljs-number">0</span> || (vmstate == -<span class="hljs-number">3</span> &amp;&amp; $*g-&gt;jit_base-&gt;ptr64)) {
        <span class="hljs-comment">/* compiled Lua code */</span>

        <span class="hljs-selector-tag">T</span> = <span class="hljs-selector-tag">luajit_get_trace</span>(g, vmstate)
        <span class="hljs-selector-tag">if</span> (T) {
            <span class="hljs-selector-tag">if</span> (simple) {
                <span class="hljs-selector-tag">func</span> = <span class="hljs-selector-tag">luajit_trace_starting_func</span>(g, T)
                <span class="hljs-selector-tag">if</span> (func != <span class="hljs-string">""</span>) {
                    <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">sprintf</span>(<span class="hljs-string">"T:%s\n"</span>, func)
                }

            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-comment">//printf("start pc: %d\n", $*T-&gt;startpc-&gt;ptr64)</span>
            }

            <span class="hljs-selector-id">#warn</span>(<span class="hljs-built_in">sprintf</span>(<span class="hljs-string">"bt: %s"</span>, bt))
        }

        <span class="hljs-selector-tag">base</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">jit_base-</span>&gt;<span class="hljs-selector-tag">ptr64</span>
        <span class="hljs-selector-tag">if</span> (!base) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">bt</span>
        }

        <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">luajit_debug_dumpstack</span>(L, T, $^<span class="hljs-attribute">arg_depth </span>:<span class="hljs-built_in">default</span>(<span class="hljs-number">30</span>), base, simple)
        <span class="hljs-comment">/*
        if (bt != "") {
            warn(sprintf("JIT backtrace: %s\n", bt))
        }
        */</span>

        <span class="hljs-comment">/*
        if (vmstate == -3) {
            printf("HIT JIT GC: %s===\n", bt)
        }
        */</span>

    } <span class="hljs-selector-tag">else</span> {

        <span class="hljs-selector-tag">if</span> (vmstate == -<span class="hljs-number">1</span> &amp;&amp; !$*L-&gt;cframe) {
            <span class="hljs-selector-tag">return</span> ""
        }

        <span class="hljs-selector-tag">if</span> (vmstate == -<span class="hljs-number">1</span> || vmstate == -<span class="hljs-number">2</span> || vmstate == -<span class="hljs-number">3</span>) {
            <span class="hljs-selector-tag">base</span> = $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">base</span>
            <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">luajit_debug_dumpstack</span>(L, <span class="hljs-number">0</span>, $^arg_depth, base, simple)
        }
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">bt</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_vm_state</span>(g)
{
    <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">vmstate</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_find_gcstr</span>(g, str)
{
    <span class="hljs-selector-tag">len</span> = <span class="hljs-selector-tag">strlen</span>(str)
    <span class="hljs-selector-tag">strmask</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">strmask</span>
    <span class="hljs-selector-tag">strnum</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">strnum</span>
    <span class="hljs-selector-tag">strhash</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">strhash</span>
    $*<span class="hljs-selector-tag">strhash</span> := @<span class="hljs-selector-tag">cast</span>(strhash, <span class="hljs-string">"GCRef"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
    <span class="hljs-selector-tag">ret</span> = <span class="hljs-number">0</span>

    <span class="hljs-selector-tag">n</span> = <span class="hljs-number">0</span>
    <span class="hljs-selector-tag">done</span> = <span class="hljs-number">0</span>
    <span class="hljs-selector-tag">for</span> (i = <span class="hljs-number">0</span>; i &lt;= strmask; i++) {
        <span class="hljs-selector-tag">p</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">strhash</span><span class="hljs-selector-attr">[i]</span>

        <span class="hljs-selector-tag">while</span> (p) {
            <span class="hljs-selector-tag">o</span> = <span class="hljs-selector-tag">luajit_gcref</span>(p)
            <span class="hljs-selector-tag">if</span> (o == <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">break</span>
            }

            $*<span class="hljs-selector-tag">o</span> := @<span class="hljs-selector-tag">cast</span>(o, <span class="hljs-string">"GCobj"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
            <span class="hljs-selector-tag">if</span> ($*o-&gt;str-&gt;len == len) {
                <span class="hljs-selector-tag">gcs</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">str</span>
                <span class="hljs-selector-tag">s</span> = <span class="hljs-selector-tag">luajit_unbox_gcstr</span>(gcs)
                <span class="hljs-selector-tag">if</span> (s == str) {
                    <span class="hljs-selector-tag">done</span> = <span class="hljs-number">1</span>
                    <span class="hljs-selector-tag">ret</span> = <span class="hljs-selector-tag">gcs</span>
                    <span class="hljs-selector-tag">break</span>
                }
            }

            <span class="hljs-selector-tag">if</span> (++n == strnum) {
                <span class="hljs-selector-tag">done</span> = <span class="hljs-number">1</span>
                <span class="hljs-selector-tag">break</span>
            }

            <span class="hljs-selector-tag">p</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gch-</span>&gt;<span class="hljs-selector-tag">nextgc</span>
        }

        <span class="hljs-selector-tag">if</span> (done) {
            <span class="hljs-selector-tag">break</span>
        }
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ret</span>
}

<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_bucket_depth</span>(p)
{
    <span class="hljs-selector-tag">n</span> = <span class="hljs-number">0</span>
    <span class="hljs-selector-tag">while</span> (p) {
        $*o := @cast(o, "GCobj", "$^libluajit_path")
        o = luajit_gcref(p)
        if (o == 0) {
            break
        }

        <span class="hljs-selector-tag">n</span>++;
        <span class="hljs-selector-tag">p</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gch-</span>&gt;<span class="hljs-selector-tag">nextgc</span>
    }
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">n</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Frida如何稳定连接PC端跟Android手机端]]></title>    <link>https://juejin.cn/post/7577693903018377242</link>    <guid>https://juejin.cn/post/7577693903018377242</guid>    <pubDate>2025-11-29T14:39:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577693903018377242" data-draft-id="7577675494067863578" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Frida如何稳定连接PC端跟Android手机端"/> <meta itemprop="keywords" content="Android,Mac,Xposed"/> <meta itemprop="datePublished" content="2025-11-29T14:39:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YF0211"/> <meta itemprop="url" content="https://juejin.cn/user/2576910988619064"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Frida如何稳定连接PC端跟Android手机端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2576910988619064/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YF0211
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T14:39:08.000Z" title="Sat Nov 29 2025 14:39:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>必须把 frida-server 以 “zygote bypass 模式” 启动</strong></h2>
<p>正确的启动方式（稳定可用）</p>
<ol>
<li>把 frida-server 放到一个适合的目录：</li>
</ol>
<pre><code class="hljs language-perl" lang="perl">adb <span class="hljs-keyword">push</span> frida /data/<span class="hljs-keyword">local</span>/tmp/
adb shell
su
<span class="hljs-keyword">chmod</span> <span class="hljs-number">755</span> /data/<span class="hljs-keyword">local</span>/tmp/frida
</code></pre>
<ol start="2">
<li>使用 <code>--runtime=v8</code> 强制 V8 引擎模式（解决 ptrace 延时错误）</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">su -c <span class="hljs-string">"/data/local/tmp/frida --runtime=v8 -D"</span>
</code></pre>
<p><strong>必须加 <code>-D</code>（daemon 模式）</strong></p>
<ol start="3">
<li>禁用 seccomp（Pixel 5 必须）</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">setenforce <span class="hljs-number">0</span>
su -c <span class="hljs-string">"cmd task lock-profile 0"</span>
</code></pre>
<p>尽管已经是 Permissive，但依然有 <strong>seccomp filter</strong> 阻拦 ptrace，必须加上这个命令：
解锁 task profile（Pixel 系列特有）：</p>
<pre><code class="hljs language-arduino" lang="arduino">su -c <span class="hljs-string">"locksettings set-secure user_verified 1"</span>
</code></pre>
<ol start="4">
<li>不要 spawn，在 Android 14 会失败,正确 attach 方法：先启动 APP，再 attach.</li>
</ol>
<pre><code class="hljs language-css" lang="css">adb shell pidof com<span class="hljs-selector-class">.charmy</span><span class="hljs-selector-class">.cupist</span>
frida -U -<span class="hljs-selector-tag">p</span> &lt;PID&gt; <span class="hljs-attr">--runtime</span>=v8
</code></pre>
<p>若还失败，加：</p>
<pre><code class="hljs language-css" lang="css">frida -U -<span class="hljs-selector-tag">p</span> &lt;PID&gt; <span class="hljs-attr">--enable-jit</span> <span class="hljs-attr">--runtime</span>=v8
</code></pre>
<ol start="5">
<li>Pixel 5 / Android 14 专属补丁（最关键),Pixel 5 需要关闭 hardware-assisted ptrace restriction</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">adb shell su -c <span class="hljs-string">"echo 0 &gt; /proc/sys/kernel/yama/ptrace_scope"</span>

</code></pre>
<p>再检查：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /proc/sys/kernel/yama/ptrace_scope
</code></pre>
<p>必须返回 <code>0</code></p>
<ol start="6">
<li>如果仍附加失败 → 使用 Riru / LSPosed 注入 FridaDex（效果最佳）,安装模块：</li>
</ol>
<pre><code class="hljs language-python" lang="python">frida-riru-<span class="hljs-number">17.</span>x.x.<span class="hljs-built_in">zip</span>
</code></pre>
<p>模块特点：</p>
<p>✔ 无需 frida-server<br/>
✔ 不走 ptrace<br/>
✔ Android 14 完全兼容<br/>
✔ APP 启动即注入</p>
<p>然后使用：</p>
<pre><code class="hljs">frida -U -n com.charmy.cupist
</code></pre>
<p>即可稳定注入。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Transformer 的技术层面]]></title>    <link>https://juejin.cn/post/7577625663257772032</link>    <guid>https://juejin.cn/post/7577625663257772032</guid>    <pubDate>2025-11-29T11:46:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577625663257772032" data-draft-id="7577647745110179840" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Transformer 的技术层面"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-29T11:46:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户480215170247"/> <meta itemprop="url" content="https://juejin.cn/user/2631551226224443"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Transformer 的技术层面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2631551226224443/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户480215170247
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T11:46:20.000Z" title="Sat Nov 29 2025 11:46:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们已经知道，在大模型推理与训练过程中，所有数据的处理都以**向量（Vector）**形式进行。从整体来看，Transformer 会将整个上下文的信息不断融合进每一个 token 的隐藏状态中，而用于预测下一个词的，是 <strong>最后一个 token 经过多层注意力与 MLP 后的隐藏向量（hidden state）</strong> 。</p>
<p>下面我们从模型的入口开始——向量的形成（Embedding），再到核心的 Attention、MLP，最后到解码器，完整理解一句话是如何被“理解”并生成下一词的。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、编码层（Embedding + 位置编码）</strong></h2>
<p>当句子进入模型后，会被分割成一个一个的 <strong>token（词或子词）</strong> 。<br/>
这些 token 本质上是词表中的索引（例如 0~5w 的数字）。</p>
<p>Transformer 的“编码层”实际上不是 Encoder 模块，而是：</p>
<pre><code class="hljs language-css" lang="css">Token Embedding  
+ <span class="hljs-attribute">Position</span> Embedding / Encoding
</code></pre>
<p>例如 GPT-3 中，Embedding 会将每个 token 映射到一个 <strong>12288 维向量</strong>。同时，模型还会加入“位置编码”，让模型区分句子顺序（例如知道“你吃苹果” ≠ “苹果吃你”）。</p>
<p>此时的每个 token 只是一个独立向量，<strong>它还不知道上下文，也不知道左边是什么右边是什么</strong>。接下来就交给注意力机制。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、注意力机制（Attention）</strong></h2>
<p>经过 Embedding 后，每个 token 的向量都会并行地计算三种投影：</p>
<ul>
<li><strong>Q（Query）</strong> ：我在寻找什么信息？</li>
<li><strong>K（Key）</strong> ：别人如何根据我来判断是否应该关注我？</li>
<li><strong>V（Value）</strong> ：如果别人关注我，我愿意提供什么内容特征？</li>
</ul>
<p>这三者来自三组独立的矩阵：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">q</span> = xW_Q
<span class="hljs-attr">k</span> = xW_K
<span class="hljs-attr">v</span> = xW_V
</code></pre>
<p>Attention 的核心是：</p>
<blockquote>
<p><strong>Q 与 K 的相似度决定“关注的权重”，<br/>
V 决定“被拿走的内容”。</strong></p>
</blockquote>
<p>数学表现为：</p>
<p>αij=softmax(qi⋅kjdk)\alpha_{ij} = softmax\left(\frac{q_i \cdot k_j}{\sqrt{d_k}}\right)αij​=softmax(dk​​qi​⋅kj​​) outi=∑jαijvjout_i = \sum_j \alpha_{ij} v_jouti​=j∑​αij​vj​</p>
<p>这意味着：</p>
<ul>
<li>token <em>i</em> 会根据 Q 与所有 token 的 K 的相似度决定“看谁多，看谁少”；</li>
<li>得到的权重再与 V 加权求和，形成每个 token 融合上下文后的语义表示。</li>
</ul>
<p>因此，一个“苹果”会在上下文的帮助下从：</p>
<pre><code class="hljs">“苹果”
</code></pre>
<p>变成：</p>
<pre><code class="hljs">“被小朋友咬了一口的红富士苹果”
</code></pre>
<p>它获得了上下文赋予的语义补充。</p>
<hr/>
<h2 data-id="heading-2"><strong>三、多头注意力（Multi-Head Attention）</strong></h2>
<p>为了让模型从不同角度观察句子（如句法、语义、实体、关系等），Transformer 并不是只做一次 QKV，而是：</p>
<blockquote>
<p><strong>同一层内部使用多组（如 GPT-3 的 96 组）Q/K/V 并行计算注意力。</strong></p>
</blockquote>
<p>每一组叫做一个 <strong>head（注意力头）</strong> 。</p>
<p>流程：</p>
<pre><code class="hljs language-bash" lang="bash">输入向量 → 96 套 W_Q/W_K/W_V → 得到 96 套 q/k/v  
→ 96 次独立的 Attention  
→ concat 拼接  
→ 再线性融合回到原维度
</code></pre>
<p>你可以理解为：</p>
<blockquote>
<p><strong>多头注意力 = 单层内部的 96 个“不同视角”同时读懂一句话。</strong></p>
</blockquote>
<p>但这一整套操作仍然被视为 <strong>一次 Attention 层</strong>。</p>
<hr/>
<h2 data-id="heading-3"><strong>四、MLP（前馈网络 / 多层感知机）</strong></h2>
<p>Attention 让 token 得到了上下文信息，但语义仍需要进一步非线性变换与特征组合——这正是 MLP 的作用。</p>
<p>一句话总结：</p>
<blockquote>
<p><strong>Attention 负责“信息流动与上下文理解”，<br/>
MLP 负责“特征增强、非线性表达与高阶抽象”。</strong></p>
</blockquote>
<p>例如：</p>
<ul>
<li>“塔” 经过 Attention 后知道上下文指的是“埃菲尔铁塔”；</li>
<li>MLP 会进一步加强它的特征，如“铁做的、高、有结构特征”等。</li>
</ul>
<p>MLP 结构通常是：</p>
<pre><code class="hljs">d_model → d_ff（扩大数倍）→ d_model
</code></pre>
<p>通过两次线性变换 + 激活函数（如 GELU），使 token 的语义表达更丰富。</p>
<hr/>
<h2 data-id="heading-4"><strong>五、多层 Transformer（Layer Stack）</strong></h2>
<p>Transformer 的基本结构单元是 <strong>一个 block</strong>：</p>
<pre><code class="hljs">（1）多头注意力  
（2）残差 + LayerNorm  
（3）MLP  
（4）残差 + LayerNorm
</code></pre>
<p>GPT-3 175B 具有 <strong>96 层</strong>这样的 block，层层堆叠，每一层都使 token 的隐藏状态更抽象、更全局、更高阶。</p>
<p>因此：</p>
<blockquote>
<p><strong>多头 = 同一层内部的横向并行<br/>
多层 = 模型纵向的深度堆叠</strong></p>
</blockquote>
<p>两者不是一回事。</p>
<hr/>
<h2 data-id="heading-5"><strong>六、解码器（线性层 + Softmax）</strong></h2>
<p>Transformer 最终会使用“最后一个 token 的隐藏状态”来预测下一词。</p>
<p>流程：</p>
<ol>
<li><strong>线性层（Linear）</strong><br/>
将 hidden state（如 12288 维）映射到词表维度（如 50k 维），得到 logits（生猛分数）。</li>
<li><strong>Softmax</strong><br/>
把 logits 转成概率分布，表示每个词作为下一 token 的可能性。</li>
</ol>
<p>最终：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">P</span>(苹果) = <span class="hljs-number">0.72</span>  
<span class="hljs-selector-tag">P</span>(香蕉) = <span class="hljs-number">0.10</span>  
<span class="hljs-selector-tag">P</span>(葡萄) = <span class="hljs-number">0.05</span>  
...
</code></pre>
<p>之后由推理策略（greedy/top-k/top-p 等）选择下一词。</p>
<hr/>
<h2 data-id="heading-6"><strong>七、最终总结</strong></h2>
<p>Transformer 的完整流程可以总结为：</p>
<ol>
<li>文本 → token → Embedding + 位置编码</li>
<li>多头注意力让每个 token 与所有其他 token 交换信息</li>
<li>MLP 进一步抽象特征</li>
<li>多层 block 堆叠形成深度理解</li>
<li>最后一个 token 的隐藏状态经线性层 + softmax 得到下一词概率</li>
<li>推理策略选出下一个 token</li>
</ol>
<p>这就是 Transformer 结构的核心逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小白也能看懂! 今年爆火的 MCP 协议究竟是什么？写给普通人的 MCP 指南]]></title>    <link>https://juejin.cn/post/7577971299742466086</link>    <guid>https://juejin.cn/post/7577971299742466086</guid>    <pubDate>2025-11-30T03:20:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577971299742466086" data-draft-id="7577689171223265330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小白也能看懂! 今年爆火的 MCP 协议究竟是什么？写给普通人的 MCP 指南"/> <meta itemprop="keywords" content="MCP,AIGC,后端"/> <meta itemprop="datePublished" content="2025-11-30T03:20:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="韩数"/> <meta itemprop="url" content="https://juejin.cn/user/2788017218794462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小白也能看懂! 今年爆火的 MCP 协议究竟是什么？写给普通人的 MCP 指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017218794462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    韩数
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:20:09.000Z" title="Sun Nov 30 2025 03:20:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是韩数同学。致力于分享 Github 上那些  好玩  有趣  免费  实用  的高质量项目。</p>
<p>我们关注这个世界上那些新奇的开源项目，作为开源技术博主，我们也很想带你去了解那些技术背后的事情, 今天是我们 AIGC 首篇文章, 关于 MCP 协议。</p>
<h4 data-id="heading-0">为什么我们需要 MCP</h4>
<p>在了解什么是 MCP 之前,  我们需要先最基础的了解下大模型，也就是我们通常所提的 LLM. LLM 的概念到今天已经完全不再陌生,  首先大语言模型主要的特点则在于它使用过去的数据训练而成,  因此未开启联网能力下的大语言模型的知识则停留在训练他的数据那一刻，我们可以写一个例子简单证明这一点:</p>
<p>例如我们可以问大模型一个简单的问题: 请帮我生成一个 json 数据，使用最新的日期</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bca56b4743041878f7272afa6e8f8fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=ejnx%2FwQhc7KSxDZvJRHSQkxxYAo%3D" alt="image.png" loading="lazy"/></p>
<p>因此这就意味着一个明显的问题，那就是大语言模型的局限性，试想人类如何获取新知识？</p>
<p>我们可以上搜索引擎查网页,  去图书馆查阅相关数据，还可以缠着朋友问，我们依靠主动与世界交互而获取新知识，而单纯靠大模型本身很难做到这一点。</p>
<p>知识的局限性和缺乏和与用户电脑进行真实交互极大的制约了大语言模型的能力。</p>
<h4 data-id="heading-1">Function Calling 和 Tool </h4>
<p>而为了解决这个问题，各个大模型服务商提出了 Function Calling 和 Tool 概念， Function Calling  为 OpenAI 模型提供了一种强大且灵活的方式，使其能够与外部系统进行交互，并访问其训练数据之外的数据。Tool 则是由 OpenAI 已经内置托管的一系列 Function Calling,  例如联网搜索，生成图像，解析文件等等等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ce0c22a222741c09ffa49c9a1a47808~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=WMw8F%2B18ennW%2BgjfCc8K1RCW92E%3D" alt="Image" loading="lazy"/></p>
<p>例如当我们需要问大模型当前的天气如何时，我们需要定义这样一个 Function Calling  并注册到 大模型 的上下文中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e9b37ad331644a2adaa350d7010aca8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=qCh7QlHTwgcDG1IBXHupBZbELV4%3D" alt="Image" loading="lazy"/></p>
<p>此时的 Function Calling 注意它的 parameters 部分已经和 MCP 的协议非常像了，这部分基本上是从 Openapi 的协议演变而来的。</p>
<p>调用过程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b46f1647cc614f63b72a7407a490bb7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=vhwbNcHfGNkjcuutxrnUqOfzxgg%3D" alt="Image" loading="lazy"/></p>
<h3 data-id="heading-2">Function Calling  执行流程:</h3>
<ol>
<li>Code：将function描述和要求发送给LLM</li>
<li>LLM：LLM来确定是直接给答复，还是需要调用 function</li>
<li>LLM：如何要调用function，则返回需要调用的 function 以及调用 function 所需要的参数</li>
<li>Code：程序收到 LLM 返回后，根据 LLM 的返回信息，执行 function</li>
<li>Code：将 function 执行后得到的结果，以及 prompt 提示词发送给 LLM</li>
<li>LLM：LLM 产生最终回答</li>
</ol>
<p>当我们只需要解决类似于查天气这类比较特定的场景时，使用 Function Calling 是非常合适的，但是当我们需要大量 Function Calling 时，意味着我们则需要为每一个功能项都实现对应的调用函数, 比较麻烦，第二个不同的大模型的 Function Calling 的协议可能还不一样。<strong>因此我们需要一种协议，可以将各种数据源或者操作以服务的方式使用统一的协议从外部集成到大模型的工具中供大模型调用，从而增强大模型的能力，为大模型安装能与聊天框之外进行实际交互的触手</strong></p>
<h4 data-id="heading-3">MCP 协议</h4>
<p>在这样的一个背景下,  2024 年 11 月 25 日,  Anthropic 发布了一篇文章,  正式提出了 Model Context Protocol 模型上下文协议,  也就是我们所熟知的 MCP,  并同步推出了相关的 SDK 套件,  Claude 客户端针对 MCP 的支持,  MCP 相关的开源仓库。发布即可用，站在今天的角度回看这篇不到千字的博客，很难不认为这是一次蓄谋已久的针对 OpenAPI 的突然袭击。</p>
<p>在这篇文章中,  Anthropic 提出了关于 MCP 的最初构想,  MCP 解决了 Function Calling 引发的扩展困难，协议混乱这一挑战。它提供了一个通用的开放标准，就像电脑是 IO 接口与 USB 标准一样。用于连接 AI 系统与数据源，用单一协议替代分散的集成。结果是为AI系统提供所需数据访问的更简单、更可靠的方式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10b1a1f7df584f1e978abf89a2c41e8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=SL6CfZNZSiHhBWWcQrOSZG8bOZY%3D" alt="image.png" loading="lazy"/></p>
<p>有了 MCP 之后，大模型可以以统一的方式读懂来自四面八方的数据操作了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c5839fc790d4b1d8434d6160b7ced35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=p57UOAIH67OrzcsP%2FHi3MOd%2Bqxc%3D" alt="image.png" loading="lazy"/></p>
<p>2025 年，<strong>随着越来越多的公司和开发者针对 MCP 协议达成共识，MCP 成为了大模型与第三方数据源集成的事实标准。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/387c6159538d4f268c252697f81ae246~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=4m8gvqQQOk78Vs7l4ogL%2Fhc%2FCKw%3D" alt="image.png" loading="lazy"/></p>
<p>就像上面那张图所示的，在 MCP 出现之前，大模型是一个没有四肢只有嘴巴的人类，所有的一切知识需要人工整理好之后一点点喂进去嘴巴里面。想象一下，在 MCP 出现之前，我们想让大模型帮我们做一些需要外部数据源的事情时，<strong>例如分析公司最近一个月的营收信息</strong> 这样的需求时，我们要如何做？自己从公司的数据库中拉取信息，整理成对 llm 友好的格式例如 csv 或者 json。然后把数据粘贴进大模型冰冷的聊天框，搭配自己精心准备的 prompt，然后交给大模型去分析。<strong>这和嚼碎了喂饭没有本质上的区别</strong>，这时候当另外一个人也有类似的需求的时候时，你会发现他也需要这么从头来一遍。而 MCP 的出现则很好的解决了这个问题:</p>
<ol>
<li>协议的一致性可以保证不管是 deepseek和 claude 调用 mcp 时可以保证一致的行为。</li>
<li>MCP 的能力可以共享了，平台方例如 jira 或者 slack 可以封装成 MCP 插件，所有需要调用 jira 或者 slack 的人无需二次开发，可以实现开箱即用。</li>
<li>数据安全，如果你需要大模型读取内部数据，你可以实现自己的 MCP server 并决定返回哪些数据。</li>
</ol>
<h4 data-id="heading-4">MCP 协议组成部分</h4>
<p>MCP 主要有以下三部分组成，分别是客户端(Client),  主机(Host) 和 服务器(Server).  这里的主机可以理解为发起请求的 LLM 程序，比如 大模型桌面端。每个 host 可以运行多个连接(client)。每个 client 都可以连多个 MCP 服务，client 使用 Rpc 的方式与服务端通信。例如deepseek 可以同时安装 slack 和 jira, github 等多个 MCP server。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37433993a93f4e24b4c6765c183d9306~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=pM0%2BQzcyFNpWbpEAtEhxWzb3C1s%3D" alt="image.png" loading="lazy"/></p>
<p>MCP Client 与 Server 保持一对一的连接,   当我们向大模型提问时:</p>
<ol>
<li><strong>MCP Client 会先从 Mcp server 获取所有可用的 MCP Server 提供的 tool 列表, 然后一并交给大模型。</strong></li>
<li><strong>大模型会根据上下文决定是否使用工具， 如果需要执行工具，则会生成对应的调用询问用户是否执行该 tool,用户确认过之后（询问这部不同的客户端的行为可能不一样), MCP Client 带着参数执行对应 tool 所属的 Mcp Server 的调用。</strong></li>
<li><strong>MCP Client 将 MCP server 调用的返回结果发送回  llm.</strong></li>
<li><strong>LLM 基于上下文以及 MCP Server 调用的结果生成回复。</strong></li>
</ol>
<p>除了 MCP client，另外一个核心的组件就是 MCP server 了。MCP server 可以是远程服务器，也可以是本地在 docker 中运行的服务，但是他们提供的作用都是一样的，以 api 的方式提供能够实际执行的操作。MCP server 主要有三部分构成</p>
<ul>
<li>资源: 可以是文档或者 api 返回信息等。</li>
<li>工具: 实际可以执行的操作，例如调用查询数据。</li>
<li>提示, 预先编写的 prompt，比如你提供一个生成 ppt 的 mcp prompt</li>
</ul>
<p>MCP 的出现确实弥补了传统的 function calling 的不足，但是现阶段的 MCP 并不能算是完美的，仍然还有许多问题需要解决。1.  #### token 的消耗问题，这应该是最轻的一个问题了，当我们向 llm 提问时，llm 始终会去加载所有的 mcp tool 去判断是否调用 mcp 工具。如果我们注册了过多的 mcp server，则会加剧 token 的消耗。同时如果多个 mcp server 存在功能相似 tool,  这些 tool 的描述写的也大差不差，这个时候 agent 判断调用哪个 mcp server 的 tool 的准确性就会受到很大的影响。</p>
<ol>
<li>安全风险,  如果一个非法的 mcp server 提供了 某些和 jira 类似的 tool, 就有可能造成 mcp 名称冲突攻击，即将一些可能包含敏感信息的参数发送给相似的确实错误的 mcp server 上。同时由于目前 mcp server 缺乏统一的认证体系，因此从一些第三方网站安装的 mcp server 可能存在恶意程序。等等等等</li>
<li>缺乏统一的认证体系和细粒度的权限控制。不同的 mcp server 的认证方式可能完全不同, 有的使用环境变量注入 api_key 有的使用 oatuh 等等。</li>
<li>基于 jsonrcp 的协议无法处理文件上传这种复杂的操作。</li>
<li>潜在的性能问题,  由于 mcp 连接远程 MCP 只支持 SSE 协议,  但是由于 SSE 是一个长链接服务，因此对于高性能高并发的场景并不是十分友好</li>
</ol>
<h4 data-id="heading-5">总结</h4>
<p>关于 MCP Server 的开发，如果你之前已经接触过后端开发，那么开发一个 MCP Server 对于来说并不是一项难事, 无非是提供另外一种样式的接口罢了 MCP 并不是技术上非常高大上的东西，但确实是人工智能时代发展过程中的必然产物。现阶段的 MCP 协议仍然称不上完美,  仍然有许多需要完善的地方,  但是无法否认的是，MCP 的出现确实为 AI 增加了四肢,  将我们带向了更远的地方，使得更多的事情变得可能。</p>
<h4 data-id="heading-6">介绍下我自己</h4>
<p>我是韩数同学，技术博主&amp;开源博主，如果你想要知道这个世界上有哪些 好玩,有趣,免费,实用 的开源项目，欢迎在绿泡泡或者红泡泡搜索我们。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌AI模型Gemini 3.0 Pro，已经杀疯了！]]></title>    <link>https://juejin.cn/post/7577718777481363494</link>    <guid>https://juejin.cn/post/7577718777481363494</guid>    <pubDate>2025-11-29T14:16:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577718777481363494" data-draft-id="7577705544874852390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌AI模型Gemini 3.0 Pro，已经杀疯了！"/> <meta itemprop="keywords" content="人工智能,Gemini,AIGC"/> <meta itemprop="datePublished" content="2025-11-29T14:16:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小灰"/> <meta itemprop="url" content="https://juejin.cn/user/2137106333828663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌AI模型Gemini 3.0 Pro，已经杀疯了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106333828663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小灰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T14:16:01.000Z" title="Sat Nov 29 2025 14:16:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员小灰。</p>
<p>2025年11月18日，谷歌公司推出了他们最新版本的大模型——Gemini3.0 pro。</p>
<p>最近小灰也体验了一下Gemini3.0 pro，对于这个当今公认最强的AI模型，我的心中唯有震撼。（后文简称Gemini3）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bd401e498c9449288df2362587d756f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=q6HE9DO%2FEpwjBw%2FqpwCGpXwUg90%3D" alt="" loading="lazy"/></p>
<p><strong>Gemini3有多强？</strong></p>
<p>国外有一个权威的AI模型能力排行网站，名为大众竞技场（LMSYS Chatbot Arena）。</p>
<p>在这个网站里，所有主流的AI大模型都会两两分组进行对战，通过双盲测试的方式让用户判断大模型的能力强弱，比拼的维度包含通用能力、代码能力、解决难题能力、多模态能力等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef78977746694ce8aeb52df6b9939cd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=Ykr2CeG7XHeTyF%2BYtmn97ybBIMY%3D" alt="" loading="lazy"/></p>
<p>当Gemini3问世的那一刻，它在所有的排行榜上都遥遥领先，让近期发布的GPT-5 pro和Grox 4.1都黯然失色。</p>
<p><strong>通用能力排行榜：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/497c7a83acd84970aba8e8dffc1ddcd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=UTKiVNKS07TaI%2BrDX4s8JrQDhwM%3D" alt="" loading="lazy"/></p>
<p><strong>代码能力排行榜：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5890e9afeec249a89c5fbf45c839826c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=iUD%2F70GPhDgsfebe16%2BkMNVDbno%3D" alt="" loading="lazy"/></p>
<p><strong>解决难题能力排行榜：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d27d92f0cec0496f82645f924da6d9d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=2Y7Qt7Y2r5SY0%2FRxqVn3%2FWCAR%2BU%3D" alt="" loading="lazy"/></p>
<p>Gemini3在大众竞技场的成绩仅仅是冰山一角，这个强大的模型在BenchMark等基准测试平台的表现同样亮眼，由于篇幅原因，小灰这里就不过多赘述了。</p>
<p><strong>怎样免费使用Gemini3</strong></p>
<p>既然Gemini3模型如此强大，我们从哪里能免费使用它呢？小灰在此推荐三个免费入口。</p>
<p>第一个推荐的是<strong>Gemini官网</strong>，入口如下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2F" target="_blank" title="https://gemini.google.com/" ref="nofollow noopener noreferrer">gemini.google.com/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70fd7366e8a043dfb2deb6b361a57249~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=xg5Lxb3ydF%2FmINh3oIxZxGqXfPU%3D" alt="" loading="lazy"/></p>
<p>在Gemini官网的对话框右下角可以选择模型，选定“思考（3 Pro）”这一项，就可以使用Gemini3版本了。不过免费会员每天只有5次左右的试用额度。</p>
<p>第二个推荐的是<strong>Google AI Studio</strong>，入口如下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com%2F" target="_blank" title="https://aistudio.google.com/" ref="nofollow noopener noreferrer">aistudio.google.com/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e777ed6798334cae9fb629c470324a30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=RzYZxXxBbkBkyAZaXdvnBej1eIw%3D" alt="" loading="lazy"/></p>
<p>在网站首页点击“Try Gemini3”选项，同样可以免费使用Gemini3。<strong>Google AI Studio也存在</strong>一定的使用频次限制，但是比官网要宽松一些，大约每天可用50次左右。</p>
<p>第三个推荐的是<strong>LMSYS Chatbot Arena，也就是刚才我们提到的大众竞技场，入口如下：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flmarena.ai%2F" target="_blank" title="https://lmarena.ai/" ref="nofollow noopener noreferrer">lmarena.ai/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba11e67e87164a05bc47030c273ed7fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=zBuqf%2BqYj0EQvoZrt9BD2%2BOX8Lc%3D" alt="" loading="lazy"/></p>
<p>把LMArena首页的模式设置为“Direct Chat”（直接聊天），大模型选择gemini-3-pro，即可开启免费的使用。</p>
<p>在这里使用Gemini3虽然没有次数限制，但会有一定的速率限制，有可能需要排队。</p>
<p><strong>Gemini3的实操体验</strong></p>
<p>说完了免费试用Gemini3的几种途径，接下来我们进入实操环节，切切实实体验一把Gemini3模型的强大。</p>
<p>如何具体展现出Gemini3模型的强大之处呢？我们不妨尝试让Gemini3为我们生成一款有趣的小游戏。</p>
<p>魂斗罗这款游戏，可以说是伴随着80后和90后的朋友一起长大的，小灰也同样是魂斗罗系列游戏的重度爱好者。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76800e86ce8548b2b8340401475cf04e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=Vfl1Dn7OkkrrlQoH5kFKJPvIuAs%3D" alt="" loading="lazy"/></p>
<p>下面我们尝试用一句提示词，让Gemini 3为我们生成一个网页版的魂斗罗小游戏。</p>
<p>首先把Gemini的工具选项当中找到Canvas，这是Gemini的核心功能之一，专门用于处理长篇写作和编程任务：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4f54f779de44c84a9dc747f43741802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=%2FWu58knRRAxg5yljBw24L8zuj4Q%3D" alt="" loading="lazy"/></p>
<p>我们的提示词如下：</p>
<p>编写一个魂斗罗游戏，带有boss战，有至少两个关卡。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/279fc24145e34b14a0011d94a2407520~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=YWF1LAyRz5ULjipHB%2BIbGU5e%2FGs%3D" alt="" loading="lazy"/></p>
<p>从视频中可以看到，Gemini3很快就为我们生成了一套Html5游戏代码，接下来让我们进行第一次测试：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17baac48d6254a58a8df116e1d81ebe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=H99%2FpqqFbjxLRaEWXhEdgunvNeM%3D" alt="" loading="lazy"/></p>
<p>啊这......不得不说，Gemini3偶尔也有翻车的时候。没关系，我们让模型重新来生成：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f21c3f1b9c7439da29073643a4d8b62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=GqHZbON5B6CWPIYyIL0pygHfPkE%3D" alt="" loading="lazy"/></p>
<p>这一回游戏总算可以正常运行了。在没有任何美工资源的情况下，Gemini3能为我们做到这种程度，已经相当不错了。</p>
<p>不过游戏中存在两处bug，其中一处bug是关卡中存在一条很长的沟壑，无法进行跳跃；另一处bug是击败boss之后，游戏流程就此卡住了。</p>
<p>我们让模型修改这两处bug：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44ac08510c0241b794654cd68ce69ee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=D3EW50hOmNkhql0dzgPPOMpSXSE%3D" alt="" loading="lazy"/></p>
<p>可以看到，游戏中的两处bug已经修改。但我一开始想让游戏包含至少两个关卡，目前却只有一关。</p>
<p>接下来，我们让AI继续修改游戏代码，增加一个关卡：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42c6cbbc27d5462dad50a2ce07dd5c7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=Zx5XPkLDmktXnhGz%2BiLXXSv1xPc%3D" alt="" loading="lazy"/></p>
<p>现在两个关卡确实有了，但游戏里只有3条命，第二关总是过不去。</p>
<p>怎么办呢？很简单，我们来把游戏改为30条命即可：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78aa0ee7e63e48558cb9650d1769aa0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=fwf7pyxoaGTWQahphQE0HzE9bJM%3D" alt="" loading="lazy"/></p>
<p>终于，第二关boss也被我们战胜了，游戏完美通关。</p>
<p>不过这还不是我们的终点。为了充分展现Gemini3的能力，我们来尝试把这款游戏改为一款3D游戏：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d168f62c0444c7ea99fe9f4766d7f1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=955jYjeZ5%2FYhYqOgTuGQ0sPAzbs%3D" alt="" loading="lazy"/></p>
<p>从视频可以看出，游戏的场景和角色都已经3D化了。尽管有些细节还不太完善，但只要我们愿意，多进行几轮对话就可以把所有的细节做得更加完善。</p>
<p>好了，用Gemini3开发魂斗罗小游戏的过程，我们就展示到这里。没有复杂的提示词，没有美工资源，仅仅是几轮简单的对话，Gemini3就为我们生成了这样一款完成度较高的游戏，这样的代码能力不可谓不惊艳。</p>
<p>如果大家有兴趣，可以尽情发挥想象力，用Gemini3做出更多有趣又酷炫的项目。</p>
<p><strong>写在最后</strong></p>
<p>记得2023年，GPT-4模型刚刚上线的时候，我曾经用GPT-4生成了一款简单的飞行射击游戏。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bee3ca423df84e19bb66798fa12e6be6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=SJOPRUTcx9%2FHXkbw%2BMZ5XkHKqVo%3D" alt="" loading="lazy"/></p>
<p>尽管当时的生成过程非常麻烦，生成的结果也很粗糙，但当时的我还是被AI的能力深深吸引了。</p>
<p>没想到仅仅是两年半的时间，AI模型已经取得了如此大的进步，Gemini3跟当年GPT-4之间的差距，简直像是成年人与小孩子之间的差距。</p>
<p>在这个技术飞速进步的时代，小灰感受到的唯有震撼。</p>
<p>希望在2026年，我们可以看到更加丰富、更加强大的AI模型和AI应用，小灰也热切期望着为大家分享更多有趣又有用的AI玩法。</p>
<p>大家有哪些想要了解的AI产品和项目？欢迎把你的想法打在留言区。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【URP】Unity[内置Shader]非光照Unlit]]></title>    <link>https://juejin.cn/post/7577689171223314482</link>    <guid>https://juejin.cn/post/7577689171223314482</guid>    <pubDate>2025-11-30T03:38:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171223314482" data-draft-id="7577971299742482470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【URP】Unity[内置Shader]非光照Unlit"/> <meta itemprop="keywords" content="游戏开发,Unity3D,图形学"/> <meta itemprop="datePublished" content="2025-11-30T03:38:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【URP】Unity[内置Shader]非光照Unlit
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:38:42.000Z" title="Sun Nov 30 2025 03:38:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13021255.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13021255%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【从UnityURP开始探索游戏渲染】</a><strong>专栏-直达</strong></p>
</blockquote>
<h2 data-id="heading-0"><strong>URP内置Unlit Shader的作用与原理</strong></h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.unity.cn%2Fcn%2FPackages-cn%2Fcom.unity.render-pipelines.universal%4014.1%2Fmanual%2Funlit-shader.html" target="_blank" title="https://docs.unity.cn/cn/Packages-cn/com.unity.render-pipelines.universal@14.1/manual/unlit-shader.html" ref="nofollow noopener noreferrer">Unlit Shader</a>是Unity通用渲染管线(URP)中的基础着色器，主要用于渲染不受光照影响的物体。其核心原理是通过直接采样纹理或颜色值输出到屏幕，跳过了复杂的光照计算流程。这种着色器特别适合UI元素、粒子特效、全息投影等需要保持恒定亮度的场景，因为它的渲染结果不会随光照环境变化而改变。</p>
<p>在URP架构中，Unlit Shader通过ShaderLab语法定义，内部使用HLSL编写核心逻辑。与Built-in管线相比，URP版本优化了渲染流程，包含三个关键Pass：主绘制Pass、深度Only Pass和元数据Pass（用于光照烘焙）。其核心特点是：</p>
<ul>
<li>无光照计算：直接输出Albedo颜色或纹理采样结果</li>
<li>支持Alpha混合：可实现透明效果</li>
<li>移动端优化：减少了GPU指令数量</li>
</ul>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.render-pipelines.universal@14.1/manual/images/Inspectors/Shaders/Unlit.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>发展历史演变</strong></h2>
<p>Unlit Shader随着Unity渲染管线的演进经历了三个阶段：</p>
<ul>
<li>‌<strong>Built-in管线时期</strong>‌（2012-2018）：最初作为简单着色器出现在标准资源包中，使用CG语言编写，功能较为基础</li>
<li>‌<strong>LWRP过渡期</strong>‌（2018-2020）：轻量级渲染管线中首次针对移动平台优化，引入HLSL替代CG</li>
<li>‌<strong>URP成熟期</strong>‌（2020至今）：成为Universal RP的核心组件，支持Shader Graph可视化编程，并优化了多Pass协作机制</li>
</ul>
<h2 data-id="heading-2"><strong>具体使用示例</strong></h2>
<p>创建Unlit材质的基本步骤：</p>
<ul>
<li>在Project窗口右键创建Material</li>
<li>材质Inspector中选择Shader路径："Universal Render Pipeline/Unlit"</li>
<li>配置基础属性：
<ul>
<li>‌<strong>Base Map</strong>‌：主纹理贴图</li>
<li>‌<strong>Base Color</strong>‌：色调叠加</li>
<li>‌<strong>Alpha</strong>‌：透明度控制</li>
</ul>
</li>
</ul>
<p>代码说明：</p>
<ul>
<li>
<p>定义包含纹理和颜色属性的基础Unlit Shader</p>
</li>
<li>
<p>使用URP核心库中的TransformObjectToHClip方法进行坐标转换</p>
</li>
<li>
<p>片元着色器直接返回纹理采样结果与颜色的乘积</p>
</li>
<li>
<p>UnlitExample.shader</p>
<pre><code class="hljs language-c" lang="c">Shader <span class="hljs-string">"Custom/UnlitTexture"</span>
{
    Properties {
        _MainTex (<span class="hljs-string">"Texture"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">"white"</span> {}
        _Color (<span class="hljs-string">"Color"</span>, Color) = (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
    }
    SubShader {
        Tags { <span class="hljs-string">"RenderType"</span>=<span class="hljs-string">"Opaque"</span> }
        Pass {
            HLSLPROGRAM
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> vertex vert</span>
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> fragment frag</span>
            <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span>

            <span class="hljs-keyword">struct</span> Attributes {
                float4 positionOS : POSITION;
                float2 uv : TEXCOORD0;
            };

            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Varyings</span> {</span>
                float4 positionCS : SV_POSITION;
                float2 uv : TEXCOORD0;
            };

            sampler2D _MainTex;
            float4 _Color;

            Varyings <span class="hljs-title function_">vert</span><span class="hljs-params">(Attributes IN)</span> {
                Varyings OUT;
                OUT.positionCS = TransformObjectToHClip(IN.positionOS.xyz);
                OUT.uv = IN.uv;
                <span class="hljs-keyword">return</span> OUT;
            }

            half4 <span class="hljs-title function_">frag</span><span class="hljs-params">(Varyings IN)</span> : SV_Target {
                <span class="hljs-keyword">return</span> tex2D(_MainTex, IN.uv) * _Color;
            }
            ENDHLSL
        }
    }
}
</code></pre>
</li>
<li>
<p>UnlitGraph.shadergraph</p>
<pre><code class="hljs language-c" lang="c">{
    <span class="hljs-string">"m_Nodes"</span>: [
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"d4f5e3c7-1a2d-4b8f-a3e1-6c9b8d2e1f0a"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.Texture2DNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">-208</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">-16</span> },
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ],
            <span class="hljs-string">"m_Texture"</span>: { <span class="hljs-string">"m_DefaultValue"</span>: {} }
        },
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.ColorNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">-200</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">100</span> },
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ],
            <span class="hljs-string">"m_Color"</span>: { <span class="hljs-string">"r"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"g"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span> }
        },
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.MultiplyNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span> },
            <span class="hljs-string">"m_Inputs"</span>: [
                { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"a"</span>, <span class="hljs-string">"m_SlotId"</span>: <span class="hljs-number">0</span> },
                { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"b"</span>, <span class="hljs-string">"m_SlotId"</span>: <span class="hljs-number">1</span> }
            ],
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ]
        }
    ],
    <span class="hljs-string">"m_Edges"</span>: [
        { <span class="hljs-string">"m_OutputSlot"</span>: <span class="hljs-string">"d4f5e3c7-1a2d-4b8f-a3e1-6c9b8d2e1f0a.out"</span>, <span class="hljs-string">"m_InputSlot"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7.a"</span> },
        { <span class="hljs-string">"m_OutputSlot"</span>: <span class="hljs-string">"a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6.out"</span>, <span class="hljs-string">"m_InputSlot"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7.b"</span> }
    ]
}
</code></pre>
</li>
</ul>
<h2 data-id="heading-3"><strong>Shader Graph应用示例</strong></h2>
<p>在Shader Graph中创建Unlit效果的步骤：</p>
<ul>
<li>创建新的Shader Graph文件（右键 &gt; Create &gt; Shader &gt; Universal Render Pipeline &gt; Unlit Shader Graph）</li>
<li>核心节点配置：
<ul>
<li>添加‌<strong>Sample Texture 2D</strong>‌节点作为基础纹理输入</li>
<li>连接‌<strong>Color</strong>‌参数节点实现色调控制</li>
<li>使用‌<strong>Multiply</strong>‌节点混合纹理和颜色</li>
</ul>
</li>
<li>高级功能扩展：
<ul>
<li>添加‌<strong>Time</strong>‌节点驱动UV动画</li>
<li>通过‌<strong>Vertex Position</strong>‌节点实现顶点变形</li>
</ul>
</li>
</ul>
<p>代码说明：</p>
<ul>
<li>
<p>构建包含纹理采样和颜色混合的基础Unlit着色器</p>
</li>
<li>
<p>通过节点连接实现材质属性的可视化编辑</p>
</li>
<li>
<p>可扩展添加UV滚动、顶点动画等高级效果</p>
</li>
<li>
<p>UnlitExample.shader</p>
<pre><code class="hljs language-c" lang="c">Shader <span class="hljs-string">"Custom/UnlitTexture"</span>
{
    Properties {
        _MainTex (<span class="hljs-string">"Texture"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">"white"</span> {}
        _Color (<span class="hljs-string">"Color"</span>, Color) = (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
    }
    SubShader {
        Tags { <span class="hljs-string">"RenderType"</span>=<span class="hljs-string">"Opaque"</span> }
        Pass {
            HLSLPROGRAM
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> vertex vert</span>
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> fragment frag</span>
            <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span>

            <span class="hljs-keyword">struct</span> Attributes {
                float4 positionOS : POSITION;
                float2 uv : TEXCOORD0;
            };

            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Varyings</span> {</span>
                float4 positionCS : SV_POSITION;
                float2 uv : TEXCOORD0;
            };

            sampler2D _MainTex;
            float4 _Color;

            Varyings <span class="hljs-title function_">vert</span><span class="hljs-params">(Attributes IN)</span> {
                Varyings OUT;
                OUT.positionCS = TransformObjectToHClip(IN.positionOS.xyz);
                OUT.uv = IN.uv;
                <span class="hljs-keyword">return</span> OUT;
            }

            half4 <span class="hljs-title function_">frag</span><span class="hljs-params">(Varyings IN)</span> : SV_Target {
                <span class="hljs-keyword">return</span> tex2D(_MainTex, IN.uv) * _Color;
            }
            ENDHLSL
        }
    }
}
</code></pre>
</li>
<li>
<p>UnlitGraph.shadergraph</p>
<pre><code class="hljs language-c" lang="c">{
    <span class="hljs-string">"m_Nodes"</span>: [
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"d4f5e3c7-1a2d-4b8f-a3e1-6c9b8d2e1f0a"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.Texture2DNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">-208</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">-16</span> },
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ],
            <span class="hljs-string">"m_Texture"</span>: { <span class="hljs-string">"m_DefaultValue"</span>: {} }
        },
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.ColorNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">-200</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">100</span> },
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ],
            <span class="hljs-string">"m_Color"</span>: { <span class="hljs-string">"r"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"g"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span> }
        },
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.MultiplyNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span> },
            <span class="hljs-string">"m_Inputs"</span>: [
                { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"a"</span>, <span class="hljs-string">"m_SlotId"</span>: <span class="hljs-number">0</span> },
                { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"b"</span>, <span class="hljs-string">"m_SlotId"</span>: <span class="hljs-number">1</span> }
            ],
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ]
        }
    ],
    <span class="hljs-string">"m_Edges"</span>: [
        { <span class="hljs-string">"m_OutputSlot"</span>: <span class="hljs-string">"d4f5e3c7-1a2d-4b8f-a3e1-6c9b8d2e1f0a.out"</span>, <span class="hljs-string">"m_InputSlot"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7.a"</span> },
        { <span class="hljs-string">"m_OutputSlot"</span>: <span class="hljs-string">"a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6.out"</span>, <span class="hljs-string">"m_InputSlot"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7.b"</span> }
    ]
}
</code></pre>
</li>
</ul>
<p>实际应用时可结合粒子系统创建发光轨迹，或为UI元素添加动态高亮效果。URP Unlit Shader的轻量级特性使其在移动设备上能保持60fps以上的渲染性能</p>
<h2 data-id="heading-4">典型应用场景及实现</h2>
<h3 data-id="heading-5"><strong>光晕效果（Halo）</strong></h3>
<ul>
<li>‌<strong>应用实例</strong>‌：角色技能特效、UI高亮提示。通过透明纹理实现边缘发光，如1中描述的透明光晕材质。</li>
<li>‌<strong>实现步骤</strong>‌：
<ul>
<li>导入纹理并设置：<code>Texture Type</code>为<code>Default (sRGB)</code>，勾选<code>Alpha Is Transparency</code>，<code>Wrap Mode</code>设为<code>Clamp</code>。</li>
<li>创建材质：选择<code>Universal Render Pipeline/Unlit</code> Shader，设置<code>Surface Type</code>为<code>Transparent</code>，拖拽纹理到<code>Base Map</code>插槽。</li>
<li>调整<code>Tint</code>颜色控制光晕色彩。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6"><strong>全息投影效果</strong></h3>
<ul>
<li>‌<strong>应用实例</strong>‌：科幻场景中的虚拟角色或界面。结合透明度与扫描线纹理。</li>
<li>‌<strong>实现步骤</strong>‌：
<ul>
<li>使用<code>Unlit</code> Shader并启用透明混合（<code>Blend SrcAlpha OneMinusSrcAlpha</code>）。</li>
<li>添加顶点偏移代码模拟全息抖动，通过<code>_Time</code>变量控制动态效果。</li>
<li>叠加扫描线纹理（如<code>_HologramLine1</code>）和菲涅尔反射增强立体感。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7"><strong>透明遮罩（如塑料薄膜）</strong></h3>
<ul>
<li>‌<strong>应用实例</strong>‌：UI遮罩或半透明装饰物。通过Alpha通道控制透明度，如中的塑料薄膜材质。</li>
<li>‌<strong>实现步骤</strong>‌：
<ul>
<li>在图片编辑器中创建带Alpha通道的纹理，白色区域不透明，灰色区域半透明。</li>
<li>材质Shader选择<code>Unlit</code>，设置<code>Transparent</code>模式，纹理绑定到<code>Base Map</code>。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8"><strong>发光广告牌（Billboard）</strong></h3>
<ul>
<li>‌<strong>应用实例</strong>‌：游戏内固定亮度标识或霓虹灯。直接显示纹理颜色不受光照影响。</li>
<li>‌<strong>实现步骤</strong>‌：
<ul>
<li>使用<code>Unlit</code> Shader，<code>Surface Type</code>设为<code>Opaque</code>。</li>
<li>通过<code>Base Map</code>设置发光纹理，调整<code>Tint</code>颜色增强亮度。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9"><strong>景深遮挡标记</strong></h3>
<ul>
<li>‌<strong>应用实例</strong>‌：半透明物体深度写入（如玻璃瓶），解决景深效果失效问题。</li>
<li>‌<strong>实现步骤</strong>‌：
<ul>
<li>创建两个材质：一个透明材质（<code>Queue=Transparent</code>），一个深度写入材质（<code>Queue=2000</code>）。</li>
<li>深度写入材质使用<code>Unlit</code> Shader并启用<code>ZWrite On</code>。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10"><strong>关键注意事项</strong></h3>
<ul>
<li>‌<strong>渲染顺序</strong>‌：透明物体需关闭深度写入（<code>ZWrite Off</code>），并合理设置<code>Queue</code>标签避免混合错误。</li>
<li>‌<strong>性能优化</strong>‌：复杂效果（如全息投影）建议结合顶点着色器计算，减少片元着色器负担</li>
</ul>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13021255.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13021255%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【从UnityURP开始探索游戏渲染】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Node.js 批量导入多语言标签到 Strapi]]></title>    <link>https://juejin.cn/post/7577702891273568291</link>    <guid>https://juejin.cn/post/7577702891273568291</guid>    <pubDate>2025-11-30T03:40:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273568291" data-draft-id="7577690150093307944" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Node.js 批量导入多语言标签到 Strapi"/> <meta itemprop="keywords" content="前端,Node.js,Trae"/> <meta itemprop="datePublished" content="2025-11-30T03:40:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Node.js 批量导入多语言标签到 Strapi
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:40:41.000Z" title="Sun Nov 30 2025 03:40:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在多语言网站开发中，我们常常需要在 Strapi 中维护大量的标签（Tags），比如文章标签、产品分类标签等。如果手动在后台创建上百条标签，会非常耗时且容易出错。本文将介绍如何使用 <strong>Node.js 脚本</strong>批量导入标签，并支持多语言（英文 / 德语 / 法语）与自动生成 slug。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、项目背景</h2>
<p>假设我们有一个 Next.js + Strapi 项目，Strapi 作为内容管理系统（CMS），我们希望：</p>
<ul>
<li>批量导入 1000+ 标签</li>
<li>支持多语言（en / de / fr）</li>
<li>自动生成 URL slug</li>
<li>避免重复创建</li>
</ul>
<p>为了实现这些目标，我们可以写一个 Node.js 脚本，调用 Strapi 的 REST API 来批量创建标签。</p>
<hr/>
<h2 data-id="heading-1">二、准备工作</h2>
<ol>
<li>
<p><strong>获取 Strapi API Token</strong>
在 Strapi 后台创建一个 <strong>API Token</strong>，选择 <strong>Full Access</strong> 或者至少有 Tags CRUD 权限。
在项目根目录创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-env" lang="env">STRAPI_API_URL=https://your-strapi-domain.com
STRAPI_API_TOKEN=YOUR_API_TOKEN
</code></pre>
</li>
<li>
<p><strong>安装依赖</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install node-fetch@2 dotenv
</code></pre>
</li>
<li>
<p><strong>准备标签数据</strong>
我们将标签写成 <code>tags.json</code> 文件，示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tags"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"title_en"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Economy"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title_de"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Wirtschaft"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title_fr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Économie"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_en"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"economy"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_de"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wirtschaft"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_fr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"economie"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"title_en"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Technology"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title_de"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Technologie"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title_fr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Technologie"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_en"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"technology"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_de"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"technologie"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_fr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"technologie"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-2">三、核心脚本解析</h2>
<p>以下是 <code>import_tags_to_strapi.js</code> 的核心实现：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> fetch = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-fetch'</span>); <span class="hljs-comment">// npm install node-fetch@2</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>).<span class="hljs-title function_">config</span>();

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STRAPI_URL</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">STRAPI_API_URL</span> || <span class="hljs-string">'http://localhost:1337'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TOKEN</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">STRAPI_API_TOKEN</span>;

<span class="hljs-keyword">const</span> raw = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'tags.json'</span>, <span class="hljs-string">'utf8'</span>);
<span class="hljs-keyword">const</span> { tags } = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(raw);

<span class="hljs-comment">// helper: sleep</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sleep</span> = (<span class="hljs-params">ms</span>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(res, ms));
</code></pre>
<h3 data-id="heading-3">1. 创建英文标签</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> enBody = {
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">title</span>: tagObj.<span class="hljs-property">title_en</span>,
    <span class="hljs-attr">slug</span>: tagObj.<span class="hljs-property">slug_en</span>
  }
};
<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${STRAPI_URL}</span>/api/tags?populate=none`</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${TOKEN}</span>`</span>,
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
  },
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(enBody)
});
</code></pre>
<h3 data-id="heading-4">2. 创建德语和法语本地化</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> deBody = {
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">title</span>: tagObj.<span class="hljs-property">title_de</span>, <span class="hljs-attr">slug</span>: tagObj.<span class="hljs-property">slug_de</span> },
  <span class="hljs-attr">locale</span>: <span class="hljs-string">'de'</span>
};
<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${STRAPI_URL}</span>/api/tags/<span class="hljs-subst">${createdId}</span>/localizations`</span>, { ... });

<span class="hljs-keyword">const</span> frBody = {
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">title</span>: tagObj.<span class="hljs-property">title_fr</span>, <span class="hljs-attr">slug</span>: tagObj.<span class="hljs-property">slug_fr</span> },
  <span class="hljs-attr">locale</span>: <span class="hljs-string">'fr'</span>
};
<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${STRAPI_URL}</span>/api/tags/<span class="hljs-subst">${createdId}</span>/localizations`</span>, { ... });
</code></pre>
<blockquote>
<p>这里使用了 Strapi <strong>Localizations API</strong>，保证不同语言之间的标签关联。</p>
</blockquote>
<h3 data-id="heading-5">3. 批量处理与防刷限流</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; tags.<span class="hljs-property">length</span>; i++) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">createTag</span>(tags[i], i + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">200</span>); <span class="hljs-comment">// 避免 API 请求过快</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-6">四、运行脚本</h2>
<pre><code class="hljs language-bash" lang="bash">node import_tags_to_strapi.js
</code></pre>
<p>执行后，你会看到：</p>
<pre><code class="hljs language-ini" lang="ini">1 created EN <span class="hljs-attr">id</span>= <span class="hljs-number">15</span>
1 created DE localization
1 created FR localization
2 created EN <span class="hljs-attr">id</span>= <span class="hljs-number">16</span>
...
done import
</code></pre>
<hr/>
<h2 data-id="heading-7">五、注意事项</h2>
<ol>
<li><strong>API Token 权限</strong>：确保 Token 有 Tag 的读写权限。</li>
<li><strong>slug 唯一性</strong>：Strapi 对 slug 有唯一性要求，建议提前生成或使用 <code>slugify</code>。</li>
<li><strong>请求频率</strong>：一次导入大量标签时，增加 <code>sleep</code> 时间可避免 Strapi 报 429。</li>
<li><strong>多语言管理</strong>：Localizations API 保证标签在多语言之间关联，便于前端展示。</li>
</ol>
<hr/>
<h2 data-id="heading-8">六、总结</h2>
<p>通过 Node.js 脚本批量导入 Strapi 标签可以大幅提高效率，并且可以：</p>
<ul>
<li>支持上千条标签</li>
<li>自动生成 slug</li>
<li>支持多语言</li>
<li>可在 CI/CD 或部署脚本中重复执行</li>
</ul>
<p>这种方式特别适合新闻网站、博客、产品目录、跨语言项目等。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app开发app之前提须知（IOS/安卓）]]></title>    <link>https://juejin.cn/post/7577681092138467363</link>    <guid>https://juejin.cn/post/7577681092138467363</guid>    <pubDate>2025-11-30T03:44:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577681092138467363" data-draft-id="7577690150093176872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app开发app之前提须知（IOS/安卓）"/> <meta itemprop="keywords" content="前端,uni-app"/> <meta itemprop="datePublished" content="2025-11-30T03:44:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鱼樱前端"/> <meta itemprop="url" content="https://juejin.cn/user/2392187252771181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app开发app之前提须知（IOS/安卓）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392187252771181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鱼樱前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:44:38.000Z" title="Sun Nov 30 2025 03:44:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是鱼樱！！！</p>
<p>关注公众号<code>【鱼樱AI实验室】</code>持续分享更多前端和AI辅助前端编码新知识~~</p>
<p>不定时写点笔记写点生活~写点前端经验。</p>
<p>在当前环境下，纯前端开发者可以通过技术深化、横向扩展、切入新兴领域（MCP TOOLS AI应用产品方向 等）以及产品化思维找到突破口。（不管写多久的代码，技术深度广度如何一定要具备<code>独立赚钱</code>的能力呀！！老铁们，因为总有一天你不在职场总有一天会面对选择和职场的无情）</p>
<p>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<p>前端最卷的开发语言一点不为过，三天一小更，五天一大更。。。一年一个框架升级~=嗯，要的就是这样感觉！与时俱进~ 接下来会逐步分享<code>uni-app</code>的一些开发经验。从文档到基础到实战以及遇到的问题~时间节点不限。</p>
<p>最近依旧比较忙，技术文章还是会不定时更新一些核心的技术分享，和大家一起学习前端路程。</p>
<h2 data-id="heading-0">前言须知</h2>
<p><code>uni-app</code> App 端内置了一个基于 weex 改进的原生渲染引擎，提供了原生渲染能力，在 App 端，如果使用 vue 页面，则使用 webview 渲染；如果使用 nvue 页面(native vue 的缩写)，则使用原生渲染。一个 App 中可以同时使用两种页面，比如首页使用 nvue，二级页使用 vue 页面</p>
<p>虽然 nvue 也可以多端编译，输出 H5 和小程序，但 nvue 的 css 写法受限，所以如果你不开发 App，那么不需要使用 nvue</p>
<p>nvue 的组件和 API 写法与 vue 页面一致</p>
<p>如果你熟悉 weex 或 react native 开发，那么 nvue 是你的更优选择，能切实提升你的开发效率，降低成本</p>
<p>如果你是 web 前端，不熟悉原生排版，那么建议你仍然以使用 vue 页面为主，在 App 端某些 vue 页面表现不佳的场景下使用 nvue 作为强化补充。</p>
<p>uni-app 在 App 端，支持 vue 页面和 nvue 页面混搭、互相跳转。也支持纯 nvue 原生渲染。</p>
<p>启用纯原生渲染模式，可以减少 App 端的包体积、减少使用时的内存占用。因为 webview 渲染模式的相关模块将被移除。</p>
<p>在 manifest.json 源码视图的<code>"app-plus"</code>下配置<code>"renderer":"native"</code>，即代表 App 端启用纯原生渲染模式。此时 pages.json 注册的 vue 页面将被忽略，vue 组件也将被原生渲染引擎来渲染。</p>
<p>如果不指定该值，默认是不启动纯原生渲染的。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// manifest.json</span>
	<span class="hljs-punctuation">{</span>
	   <span class="hljs-comment">// ...</span>
		<span class="hljs-comment">// App平台特有配置</span>
	   <span class="hljs-attr">"app-plus"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
	      <span class="hljs-attr">"renderer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"native"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//App端纯原生渲染模式</span>
	   <span class="hljs-punctuation">}</span>
	<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-1">编译模式</h2>
<p><strong>weex 编译模式和 uni-app 编译模式（推荐）</strong></p>
<p>weex 的组件和 JS API，与 uni-app 不同。uni-app 与微信小程序相同  主要介绍 uni-app 方式 weex自行了解</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/254529af32d34d22add29c650b2e32b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=Xl9AMmBlX9j4gbevc%2Fc4UpE3eaA%3D" alt="image.png" loading="lazy"/></p>
<p>在 manifest.json 中修改 2 种编译模式，<code>manifest.json</code> -&gt; <code>app-plus</code> -&gt; <code>nvueCompiler</code> 切换编译模式。
<code>nvueCompiler</code> 有两个值：</p>
<ul>
<li>weex</li>
<li>uni-app</li>
</ul>
<pre><code class="hljs language-json" lang="json">	<span class="hljs-comment">// manifest.json</span>
	<span class="hljs-punctuation">{</span>
		<span class="hljs-comment">// ...</span>
		<span class="hljs-comment">// App平台特有配置</span>
		<span class="hljs-attr">"app-plus"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
			<span class="hljs-attr">"nvueCompiler"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"uni-app"</span> <span class="hljs-comment">//是否启用 uni-app 模式</span>
		<span class="hljs-punctuation">}</span>
	<span class="hljs-punctuation">}</span>
</code></pre>
<p>原生开发没有页面滚动的概念，页面内容高过屏幕高度时，内容并不会自动滚动；只有将页面内容放在<code>list</code>、<code>waterfall</code>、<code>scroll-view/scroller</code>这几个组件下内容才可滚动。这不符合前端开发的习惯，所以在 nvue 编译为 <code>uni-app</code>模式时，<code>uni-app</code>框架会给 nvue 页面外层自动嵌套一个 <code>scroller</code>，从而实现页面内容的自动滚动。</p>
<p><strong>注意</strong>：</p>
<ul>
<li><code>uni-app</code>框架仅对 nvue 页面嵌套<code>scroller</code>容器，不会给组件自动套<code>scroller</code>容器；</li>
<li>若 nvue 页面有<code>recycle-list</code>组件时，<code>uni-app</code>框架也不会自动给页面嵌套<code>scroller</code>容器</li>
<li>若你不希望自动嵌套<code>scroller</code>容器，可在<code>pages.json</code>中通过如下配置进行关闭：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"disableScroll"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-comment">// 不嵌套 scroller</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>HBuilderX 3.1.0+ 开始支持新的样式编译模式</strong></p>
<ul>
<li>weex 编译模式：老模式，样式支持与普通 weex 相同</li>
<li>uni-app 编译模式：新模式，在 weex 原有样式基础上支持组合选择器（相邻兄弟选择器、普通兄弟选择器、子选择器、后代选择器）<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.dcloud.net.cn%2Farticle%2F38751" target="_blank" title="https://ask.dcloud.net.cn/article/38751" ref="nofollow noopener noreferrer">详见</a></li>
</ul>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-comment">// manifest.json</span>
  <span class="hljs-punctuation">{</span>
      <span class="hljs-comment">// ...</span>
      <span class="hljs-comment">// App平台特有配置</span>
      <span class="hljs-attr">"app-plus"</span><span class="hljs-punctuation">:</span>  <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"nvueStyleCompiler"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uni-app"</span>
      <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-2">快速上手</h2>
<p>在 HBuilderX 的 <code>uni-app</code> 项目中，新建页面，弹出界面右上角可以选择是建立<code>vue</code>页面还是<code>nvue</code>页面，或者 2 个同时建</p>
<p>不管是 vue 页面还是 nvue 页面，都需要在<code>pages.json</code>中注册。如果在 HBuilderX 中新建页面是会自动注册的，如果使用其他编辑器，则需要自行在 pages.json 里注册。</p>
<p>如果一个页面路由下同时有 vue 页面和 nvue 页面，即出现同名的 vue 和 nvue 文件。那么在 App 端，会仅使用 nvue 页面，同名的 vue 文件将不会被编译到 App 端。而在非 App 端，会优先使用 vue 页面。</p>
<p>如果不同名，只有 nvue 页面，则在非 app 端，只有 uni-app 编译模式的 nvue 文件才会编译。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96331e2892094ca795ba4c89362bf75f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=%2F5ZBYr4dzE3vhqrRSePbIdoOAlQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">开发 nvue 页面需注意</h3>
<p><code>nvue</code> 页面结构同 <code>vue</code>, 由 <code>template</code>、<code>style</code>、<code>script</code> 构成。</p>
<ul>
<li>
<p>template： 模板写法、数据绑定同 vue。组件支持 2 种模式，</p>
<ul>
<li>uni-app 组件，同 uni-app 写法。</li>
<li>App 端 nvue 专用组件，详见<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Fcomponent%2Fbarcode" target="_blank" title="https://uniapp.dcloud.io/component/barcode" ref="nofollow noopener noreferrer">uniapp.dcloud.io/component/b…</a>。</li>
</ul>
</li>
<li>
<p>style：由于采用原生渲染，<strong>并非所有浏览器的 css 均支持，布局模型只支持 flex 布局</strong>，虽然不会造成某些界面布局无法实现，但写法要注意。详见：<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-css" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-css" ref="nofollow noopener noreferrer">样式</a></p>
</li>
<li>
<p>script：写法同 vue，并支持 3 种 API：</p>
<ul>
<li>nvue API ：仅支持 App 端，uni-app 编译模式也可使用。使用前需先引入对应模块，参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-api" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-api" ref="nofollow noopener noreferrer">模块引入 API</a></li>
<li>uni API：<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Fapi%2FREADME" target="_blank" title="https://uniapp.dcloud.io/api/README" ref="nofollow noopener noreferrer">uniapp.dcloud.io/api/README</a></li>
<li>plus API：仅支持 App 端。<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.html5plus.org%2Fdoc%2Fh5p.html" target="_blank" title="http://www.html5plus.org/doc/h5p.html" ref="nofollow noopener noreferrer">www.html5plus.org/doc/h5p.htm…</a></li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">调试 nvue 页面</h3>
<p>HBuilderX 内置了 weex 调试工具的强化版，包括审查界面元素、看 log、debug 打断点，<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fdebug%2Fdebug-app.html" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/debug/debug-app.html" ref="nofollow noopener noreferrer">详见</a></p>
<h4 data-id="heading-5">注意事项</h4>
<ul>
<li><code>vue</code> 和 <code>nvue</code> 页面均支持断点调试</li>
<li>目前仅支持 <code>nvue</code> 页面审查元素，<code>vue</code> 页面暂不支持，以及 <code>Android</code> 平台的 <code>nvue</code> 审查元素暂不支持查看 <code>style</code></li>
<li>App 端提供真机运行的<code>console.log</code>日志输出，运行到真机或模拟器时，不用点<code>debug</code>按钮，运行手机 App，会在<code>HBuilderX</code>的控制台直接输出日志。</li>
<li>如果是调试<code>App</code>的界面和常规 API，<strong>推荐编译到 H5 端</strong>，点<code>HBuilderX</code>右上角的预览，在内置浏览器里调<code>Dom</code>，保存后立即看到结果，调试更方便。并且 H5 端也支持<code>titleNView</code>的各种复杂设置。唯一要注意的就是<code>css</code>兼容性，使用太新的<code>css</code>在<code>pc</code>上预览可能正常，但低端<code>Android</code>上异常，具体可查询<code>caniuse</code>等网站。</li>
<li>常用的开发模式就是<code>pc</code>上使用内置浏览器预览调 dom，运行到真机上看<code>console.log</code>。如果是很复杂的问题才使用<code>debug</code>。</li>
<li>uni-app 的 App 端的 webkit remote debug，只能调试视图层，不能调试逻辑层。因为 uni-app 的 js 不是运行在 webview 里，而是独立的 jscore 里。</li>
<li>部分 manifest 配置，如三方 sdk 配置，需要打包后生效的，可以打包一个自定义运行基座。打包自定义基座后运行这个自定义基座，同样可以真机运行和 debug。打包正式包将无法真机运行和 debug。</li>
<li>调试依赖 chrome 安装位置，找不到可能会导致调试报错。社区反馈中有用户主动修改了 chrome 的安装位置，导致内置的 puppeteer 查找 chrome失败，如果你修改了 chrome 的安装位置，请参考 《<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.dcloud.net.cn%2Farticle%2F41558" target="_blank" title="https://ask.dcloud.net.cn/article/41558" ref="nofollow noopener noreferrer">HBuilderX APP端 uni/nvue 调试报错问题</a>》</li>
</ul>
<h3 data-id="heading-6">nvue开发与vue开发的常见区别</h3>
<ol>
<li>nvue 页面控制显隐只可以使用<code>v-if</code>不可以使用<code>v-show</code></li>
<li>nvue 页面只能使用<code>flex</code>布局，不支持其他布局方式。页面开发前，首先想清楚这个页面的纵向内容有什么，哪些是要滚动的，然后每个纵向内容的横轴排布有什么，按 flex 布局设计好界面。</li>
<li>nvue 页面的布局排列方向默认为竖排（<code>column</code>），如需改变布局方向，可以在 <code>manifest.json</code> -&gt; <code>app-plus</code> -&gt; <code>nvue</code> -&gt; <code>flex-direction</code> 节点下修改，仅在 uni-app 模式下生效。<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Fcollocation%2Fmanifest%3Fid%3Dnvue" target="_blank" title="https://uniapp.dcloud.io/collocation/manifest?id=nvue" ref="nofollow noopener noreferrer">详情</a>。</li>
<li>nvue页面编译为H5、小程序时，会做一件css默认值对齐的工作。因为weex渲染引擎只支持flex，并且默认flex方向是垂直。而H5和小程序端，使用web渲染，默认不是flex，并且设置<code>display:flex</code>后，它的flex方向默认是水平而不是垂直的。所以nvue编译为H5、小程序时，会自动把页面默认布局设为flex、方向为垂直。当然开发者手动设置后会覆盖默认设置。</li>
<li>文字内容，必须、只能在<code>&lt;text&gt;</code>组件下。不能在<code>&lt;div&gt;</code>、<code>&lt;view&gt;</code>的<code>text</code>区域里直接写文字。否则即使渲染了，也无法绑定js里的变量。</li>
<li>只有<code>text</code>标签可以设置字体大小，字体颜色。</li>
<li>布局不能使用百分比、没有媒体查询。</li>
<li>nvue 切换横竖屏时可能导致样式出现问题，建议有 nvue 的页面锁定手机方向。</li>
<li>支持的css有限，不过并不影响布局出你需要的界面，<code>flex</code>还是非常强大的。<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-css.html%23flex" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-css.html#flex" ref="nofollow noopener noreferrer">详见</a></li>
<li>不支持背景图。但可以使用<code>image</code>组件和层级来实现类似web中的背景效果。因为原生开发本身也没有web这种背景图概念</li>
<li>css选择器支持的比较少，只能使用 class 选择器。<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-css.html" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-css.html" ref="nofollow noopener noreferrer">详见</a></li>
<li>nvue 的各组件在安卓端默认是透明的，如果不设置<code>background-color</code>，可能会导致出现重影的问题。</li>
<li><code>class</code> 进行绑定时只支持数组语法。</li>
<li>Android端在一个页面内使用大量圆角边框会造成性能问题，尤其是多个角的样式还不一样的话更耗费性能。应避免这类使用。</li>
<li>nvue页面没有<code>bounce</code>回弹效果，只有几个列表组件有<code>bounce</code>效果，包括 <code>list</code>、<code>recycle-list</code>、<code>waterfall</code>。</li>
<li>原生开发没有页面滚动的概念，页面内容高过屏幕高度并不会自动滚动，只有部分组件可滚动（<code>list</code>、<code>waterfall</code>、<code>scroll-view/scroller</code>），要滚的内容需要套在可滚动组件下。这不符合前端开发的习惯，所以在 nvue 编译为 uni-app模式时，给页面外层自动套了一个 <code>scroller</code>，页面内容过高会自动滚动。（组件不会套，页面有<code>recycle-list</code>时也不会套）。后续会提供配置，可以设置不自动套。</li>
<li>在 App.vue 中定义的全局js变量不会在 nvue 页面生效。<code>globalData</code>和<code>vuex</code>是生效的。</li>
<li>App.vue 中定义的全局css，对nvue和vue页面同时生效。如果全局css中有些css在nvue下不支持，编译时控制台会报警，建议把这些不支持的css包裹在<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Fplatform" target="_blank" title="https://uniapp.dcloud.io/platform" ref="nofollow noopener noreferrer">条件编译</a>里，<code>APP-PLUS-NVUE</code></li>
<li>不能在 <code>style</code> 中引入字体文件，nvue 中字体图标的使用参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-api.html%23addrule" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-api.html#addrule" ref="nofollow noopener noreferrer">加载自定义字体</a>。如果是本地字体，可以用<code>plus.io</code>的API转换路径。</li>
<li>目前不支持在 nvue 页面使用 <code>typescript/ts</code>。
<strong>21</strong>.  nvue 页面关闭原生导航栏时，想要模拟状态栏，可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.dcloud.net.cn%2Farticle%2F35111" target="_blank" title="https://ask.dcloud.net.cn/article/35111" ref="nofollow noopener noreferrer">参考文章</a>。但是，仍然<strong>强烈建议在nvue页面使用原生导航栏</strong>。nvue的渲染速度再快，也没有原生导航栏快。原生排版引擎解析<code>json</code>绘制原生导航栏耗时很少，而解析nvue的js绘制整个页面的耗时要大的多，尤其在新页面进入动画期间，对于复杂页面，没有原生导航栏会在动画期间产生整个屏幕的白屏或闪屏。</li>
</ol>
<h3 data-id="heading-7">iOS 平台下拉组件 refresh 组件注意问题</h3>
<p>iOS 平台默认情况下滚动容器组件（如<code>list</code>、<code>waterfall</code>组件）内容不足时，由于没有撑满容器的可视区域会导致无法上下滚动，此时无法操作下拉刷新功能，无法触发<code>refresh</code>组件的<code>@refresh</code>、<code>@pullingdown</code>事件。 此时可在容器组件中配置<code>alwaysScrollableVertical</code>属性值为<code>true</code>来设置支持上下滚动，支持下拉刷新操作。</p>
<blockquote>
<p>Android 平台不存在此问题</p>
</blockquote>
<h4 data-id="heading-8">用法</h4>
<pre><code class="hljs language-nvue" lang="nvue">&lt;list class="scroll-v list" enableBackToTop="true" scroll-y alwaysScrollableVertical="true"&gt;
	&lt;refresh class="refresh" @refresh="onrefresh()" @pullingdown="onpullingdown"&gt;
		&lt;!-- refresh content --&gt;
	&lt;/refresh&gt;
	&lt;cell v-for="(newsitem,index) in list" :key="newsitem.id"&gt;
		&lt;!-- cell content --&gt;
	&lt;/cell&gt;
&lt;/list&gt;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18d5a212772d471f84750462d052781e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=WPbSlHxNtvV9c%2BsFSsye0RYq9lU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">HTML5+ 能力</h2>
<p><code>uni-app</code> App 端内置 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.html5plus.org%2Fdoc%2F" target="_blank" title="https://www.html5plus.org/doc/" ref="nofollow noopener noreferrer">HTML5+</a> 引擎，让 js 可以直接调用丰富的原生能力</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a056cec33d7544c0875177ad4e79d426~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=DMijjtu2pg6YmxlsRyNfdusla8w%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">条件编译调用 HTML5+</h4>
<p>小程序及 H5 等平台是没有 HTML5+ 扩展规范的，因此在 <code>uni-app</code> 调用 HTML5+ 的扩展规范时，需要注意使用条件编译。否则运行到h5、小程序等平台会出现 <code>plus is not defined</code>错误。</p>
<pre><code class="hljs language-nvue" lang="nvue">// #ifdef APP-PLUS
var appid = plus.runtime.appid;
console.log('应用的 appid 为：' + appid);
// #endif
</code></pre>
<h4 data-id="heading-11"><code>uni-app</code>不需要 <code>plus ready</code></h4>
<p>在html中使用plus的api，需要等待plus ready。 而<code>uni-app</code>不需要等，可以直接使用。而且如果你调用plus ready，反而不会触发。</p>
<h4 data-id="heading-12"><code>uni-app</code> 中的事件监听</h4>
<p>在普通的 H5+ 项目中，需要使用 <code>document.addEventListener</code> 监听原生扩展的事件。</p>
<p><code>uni-app</code> 中，没有 document。可以使用 <code>plus.globalEvent.addEventListener</code> 来实现。</p>
<pre><code class="hljs language-nvue" lang="nvue">// #ifdef APP-PLUS
// 监听新意图事件
plus.globalEvent.addEventListener('newintent', function(){});
// #endif
</code></pre>
<p>复制代码</p>
<p>同理，在 <code>uni-app</code> 中使用 Native.js 时，一些 Native.js 中对于原生事件的监听同样需要按照上面的方法去实现。</p>
<h2 data-id="heading-13">Native.js 能力</h2>
<p>Native.js技术，简称NJS，是一种将手机操作系统的原生对象转义，映射为JS对象，在JS里编写原生代码的技术。 如果说Node.js把js扩展到服务器世界，那么Native.js则把js扩展到手机App的原生世界。 HTML/JS/Css全部语法只有7万多，而原生语法有几十万，Native.js大幅提升了HTML5的能力。 NJS突破了浏览器的功能限制，也不再需要像Hybrid那样由原生语言开发插件才能补足浏览器欠缺的功能。 NJS编写的代码，最终需要在HBuilder里打包发行为App安装包，或者在支持Native.js技术的浏览器里运行。目前Native.js技术不能在普通手机浏览器里直接运行。</p>
<ul>
<li>NJS大幅扩展了HTML5的能力范围，原本只有原生或Hybrid App的原生插件才能实现的功能如今可以使用JS实现。</li>
<li>NJS大幅提升了App开发效率，将iOS、Android、Web的3个工程师组队才能完成的App，变为1个web工程师就搞定。</li>
<li>NJS不再需要配置原生开发和编译环境，调试、打包均在HBuilder里进行。没有mac和xcode一样可以开发iOS应用。</li>
<li>如果不熟悉原生API也没关系，我们汇总了很多NJS的代码示例，复制粘贴就可以用。<a href="https://link.juejin.cn?target=http%3A%2F%2Fask.dcloud.net.cn%2Farticle%2F114" target="_blank" title="http://ask.dcloud.net.cn/article/114" ref="nofollow noopener noreferrer">ask.dcloud.net.cn/article/114</a></li>
</ul>
<p>再次强调，Native.js不是一个js库，不需要下载引入到页面的script中，也不像nodejs那样有单独的运行环境，Native.js的运行环境是集成在5+runtime里的，使用HBuilder打包的app或流应用都可以直接使用Native.js。</p>
<h2 data-id="heading-14">注意事项：</h2>
<ul>
<li>
<p>Uni-app不支持Native.js执行UI相关操作的API调用及webview相关API调用。将失效无法正常使用。Uni-app不推荐使用Native.js</p>
</li>
<li>
<p>Native API具有平台依赖性，所以需要通过以下方式判断当前的运行平台</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">judgePlatform</span>(<span class="hljs-params"/>){
	<span class="hljs-keyword">switch</span> ( plus.<span class="hljs-property">os</span>.<span class="hljs-property">name</span> ) {
		<span class="hljs-keyword">case</span> <span class="hljs-string">"Android"</span>:
		<span class="hljs-comment">// Android平台: plus.android.*</span>
		<span class="hljs-keyword">break</span>;
		<span class="hljs-keyword">case</span> <span class="hljs-string">"iOS"</span>:
		<span class="hljs-comment">// iOS平台: plus.ios.*</span>
		<span class="hljs-keyword">break</span>;
		<span class="hljs-attr">default</span>:
		<span class="hljs-comment">// 其它平台</span>
		<span class="hljs-keyword">break</span>;
	}
}
</code></pre>
<ul>
<li>在NJS中调用Native API或从Native API返回数据到NJS时会自动转换数据类型</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb70f936bde54fe5b6e6660832bab412~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=KGGqKFoSxcWfYLG5aBUzi%2FI99vc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-15">技术要求</h3>
<p>由于NJS是直接调用Native API，需要对Native API有一定了解，知道所需要的功能调用了哪些原生API，能看懂原生代码并参考原生代码修改为JS代码。 否则只能直接copy别人写好的NJS代码。</p>
<h2 data-id="heading-16">renderjs能力</h2>
<p><code>renderjs</code>是一个运行在视图层的js。它比<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fminiprogram-subject.html%23wxs" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/miniprogram-subject.html#wxs" ref="nofollow noopener noreferrer">WXS</a>更加强大。它只支持app-vue和web。</p>
<p><code>renderjs</code>的主要作用有2个：</p>
<ol>
<li>大幅降低逻辑层和视图层的通讯损耗，提供高性能视图交互能力</li>
<li>在视图层操作dom，运行 for web 的 js库</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8a99c2201604e78b0402df9ec679140~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=nAEadX6XH4i7Vd5w2Of%2Fi6MWEZc%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>nvue的视图层是原生的，无法运行js。但提供了bindingx技术来解决通信阻塞。<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-api.html%23bindingx" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-api.html#bindingx" ref="nofollow noopener noreferrer">详见</a></li>
<li>微信小程序下替代方案是wxs，这是微信提供的一个裁剪版renderjs。<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fminiprogram-subject.html%23wxs" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/miniprogram-subject.html#wxs" ref="nofollow noopener noreferrer">详见</a></li>
<li>web下不存在逻辑层和视图层的通信阻塞，也可以直接操作dom，所以在web端使用renderjs主要是为了跨端复用代码。<strong>如果只开发web端，没有必要使用renderjs</strong>。</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;script <span class="hljs-variable language_">module</span>=<span class="hljs-string">"test"</span> lang=<span class="hljs-string">"renderjs"</span>&gt;
	<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
		<span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
			<span class="hljs-comment">// ...</span>
		},
		<span class="hljs-attr">methods</span>: {
			<span class="hljs-comment">// ...</span>
		}
	}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-17">过去的问题</h3>
<ul>
<li>H5端流行的echart报表因为涉及大量dom操作，无法跨端使用</li>
<li>wx-chart在跨端和更新方面都不足</li>
<li>插件市场提供了比wx-chart更好的、全端可用的<a href="https://link.juejin.cn?target=https%3A%2F%2Fext.dcloud.net.cn%2Fplugin%3Fid%3D271" target="_blank" title="https://ext.dcloud.net.cn/plugin?id=271" ref="nofollow noopener noreferrer">uChart</a>。但受限于小程序架构逻辑层和视图层分离，导致的通信折损，图表的动画性能不佳。并且uchart只实现了echart的常用功能，还有一些功能没有实现。</li>
</ul>
<h3 data-id="heading-18">新的解决方案</h3>
<p>从uni-app 2.5.5+起，新提供了<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Fframe%3Fid%3Drenderjs" target="_blank" title="https://uniapp.dcloud.io/frame?id=renderjs" ref="nofollow noopener noreferrer">renderjs</a>技术。它是wxs的升级版，一种可以运行在视图层的js。</p>
<p>通过renderjs编写的代码，直接运行在视图层（也就是webview中），可以完整的运行echart等库，并且没有了逻辑层和视图层频繁通行的折损，让动画不再卡顿。</p>
<p>renderjs支持app-vue和h5，不支持其他平台。如果你只考虑这2个平台，可以直接使用本示例，使用完整版的echart。如果还要兼容多端小程序，建议仍然使用uchart。</p>
<p>renderjs，不止能运行echart，其他如F2、threejs等web库都可以运行。</p>
<h3 data-id="heading-19">renderjs使用注意事项</h3>
<ul>
<li>目前仅支持内联使用。</li>
<li>不要直接引用大型类库，推荐通过动态创建 script 方式引用。</li>
<li>可以使用 vue 组件的生命周期(不支持 beforeDestroy、destroyed、beforeUnmount、unmounted)，不可以使用 App、Page 的生命周期</li>
<li>视图层和逻辑层通讯方式与 <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fminiprogram-subject.html%23wxs" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/miniprogram-subject.html#wxs" ref="nofollow noopener noreferrer">WXS</a> 一致，另外可以通过 this.$ownerInstance 获取当前组件的 ComponentDescriptor 实例。</li>
<li>this.$ownerInstance.callMethod() 仅支持调用逻辑层vue选项式中的 methods 中定义的方法。</li>
<li>注意逻辑层给数据时最好一次性给到渲染层，而不是不停从逻辑层向渲染层发消息，那样还是会产生逻辑层和视图层的多次通信，还是会卡</li>
<li>观测更新的数据在视图层可以直接访问到。</li>
<li>APP 端视图层的页面引用资源的路径相对于根目录计算，例如：./static/test.js。</li>
<li>APP 端可以使用 dom、bom API，不可直接访问逻辑层数据，不可以使用 uni 相关接口（如：uni.request）</li>
<li>H5 端逻辑层和视图层实际运行在同一个环境中，相当于使用 mixin 方式，可以直接访问逻辑层数据。</li>
<li>vue3 项目不支持 <code>setup script</code> 用法。</li>
</ul>
<h2 data-id="heading-20">APP 离线 SDK</h2>
<p>App离线开发工具包，即App离线SDK，是把App运行环境（runtime）封装为原生开发调用接口，开发者可以在自己的 Android 及 iOS 原生开发环境配置工程使用，包括 Android离线开发SDK 及 iOS离线开发SDK。</p>
<p><strong>注意：本SDK仅限于<code>uni-app</code>项目使用</strong></p>
<ul>
<li>Android 离线SDK-正式版  <a href="https://link.juejin.cn?target=https%3A%2F%2Fnativesupport.dcloud.net.cn%2FAppDocs%2Fdownload%2Fandroid.html" target="_blank" title="https://nativesupport.dcloud.net.cn/AppDocs/download/android.html" ref="nofollow noopener noreferrer">nativesupport.dcloud.net.cn/AppDocs/dow…</a></li>
<li>iOS 离线SDK - 正式版 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnativesupport.dcloud.net.cn%2FAppDocs%2Fdownload%2Fios.html" target="_blank" title="https://nativesupport.dcloud.net.cn/AppDocs/download/ios.html" ref="nofollow noopener noreferrer">nativesupport.dcloud.net.cn/AppDocs/dow…</a></li>
<li>AppKey申请配置 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnativesupport.dcloud.net.cn%2FAppDocs%2Fusesdk%2Fappkey.html" target="_blank" title="https://nativesupport.dcloud.net.cn/AppDocs/usesdk/appkey.html" ref="nofollow noopener noreferrer">nativesupport.dcloud.net.cn/AppDocs/use…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[搞不懂 px、dpi 和 dp？看这一篇就够了：图解 RN 屏幕适配逻辑]]></title>    <link>https://juejin.cn/post/7577681092138500131</link>    <guid>https://juejin.cn/post/7577681092138500131</guid>    <pubDate>2025-11-30T03:47:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577681092138500131" data-draft-id="7577690150093160488" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="搞不懂 px、dpi 和 dp？看这一篇就够了：图解 RN 屏幕适配逻辑"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T03:47:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            搞不懂 px、dpi 和 dp？看这一篇就够了：图解 RN 屏幕适配逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:47:06.000Z" title="Sun Nov 30 2025 03:47:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>一、三个概念：px、dpi、dp</strong></h3>
<ol>
<li>
<p><strong>px：物理像素 / 分辨率里的那个像素</strong>
当我们说“720p、1080p”时，其实说的是分辨率：</p>
<ul>
<li>720p ≈ 1280 × 720 像素</li>
<li>1080p ≈ 1920 × 1080 像素
这里的“1280、1920、720、1080”，都是 px（物理像素点的个数）。</li>
</ul>
</li>
<li>
<p><strong>dpi：像素密度（每英寸多少个像素）</strong>
dpi（dots per inch）表示：一英寸（2.54cm）长度上有多少个像素点。</p>
<ul>
<li>160dpi：每英寸约 160 个像素</li>
<li>320dpi：每英寸约 320 个像素（比 160dpi 更细腻）
dpi 是硬件属性，跟屏幕多大、分辨率多少一起决定“看起来多清晰”。</li>
</ul>
</li>
<li>
<p><strong>dp：密度无关像素（React Native 用的逻辑单位）</strong>
dp（density-independent pixel）是系统定义的一种“逻辑长度单位”，让同样的数值在不同 dpi 的设备上，看起来差不多大。
在 React Native 里，你写 <code>width: 100</code>，这个 100 本质上就是 100dp，而不是 100px。</p>
</li>
</ol>
<h3 data-id="heading-1"><strong>二、dp 和 dpi 的数学关系</strong></h3>
<p>Android / React Native 的约定：</p>
<ul>
<li>把 <strong>160dpi</strong> 的屏幕当成基准屏幕。</li>
<li>在 160dpi 屏幕上：<code>1dp ≈ 1px</code></li>
<li>在其它密度屏幕上，系统用这个公式换算：<code>px = dp × (dpi / 160)</code></li>
</ul>
<p>举几个数字例子：</p>
<ul>
<li><strong>160dpi（基准）</strong>
<code>1dp = 1 × (160 / 160) = 1px</code>
<code>100dp = 100px</code></li>
<li><strong>320dpi</strong>
<code>1dp = 1 × (320 / 160) = 2px</code>
<code>100dp = 200px</code></li>
<li><strong>480dpi</strong>
<code>1dp = 1 × (480 / 160) = 3px</code>
<code>100dp = 300px</code>（四舍五入后近似）</li>
</ul>
<p>也就是说：</p>
<p>当你在代码里写 width: 100 时，这个 100 实际上是 100dp。系统会根据当前设备的 dpi，把它换算成应该使用多少个物理像素：</p>
<ul>
<li>在 160dpi 的屏幕上，大约使用 100px（1dp ≈ 1px）；</li>
<li>在 320dpi 的屏幕上，大约使用 200px（1dp ≈ 2px）；</li>
<li>在 480dpi 的屏幕上，大约使用 300px（1dp ≈ 3px）。</li>
</ul>
<p>随着屏幕像素密度提高，单个像素本身变得更小，所以虽然不同设备实际使用的物理像素数量不一样，但这个“100dp 宽”的控件在现实世界里的物理尺寸（比如看起来有多宽、占多大一块屏幕）会尽量保持接近。</p>
<p>现在，160/320/480dpi 和 dp→px 的关系就理清楚了，也解释了“为什么同样的 dp 在不同手机上看起来差不多大”。</p>
<h3 data-id="heading-2"><strong>三、示意图：同样 100dp 的按钮，在不同 dpi / 分辨率上长什么样？</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/069bb940d5894672b5890e2fe8bc7765~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu6JuL5bCP57K-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079727&amp;x-signature=VpcJWXbIlSQNDepmn0tI%2F802lOc%3D" alt="Gemini_Generated_Image_hl6v29hl6v29hl6v.png" loading="lazy"/>
<strong>1）左边：720p，160dpi</strong></p>
<ul>
<li>分辨率：1280 × 720 px</li>
<li>dpi：160</li>
<li>换算：<code>1dp = 1px</code>，<code>100dp = 100px</code></li>
<li>按钮在屏幕上大约占据“某个具体宽度 A 厘米”。</li>
</ul>
<p><strong>2）中间：1080p，320dpi</strong></p>
<ul>
<li>分辨率：1920 × 1080 px</li>
<li>dpi：320（像素更密）</li>
<li>换算：<code>1dp = 2px</code>，<code>100dp = 200px</code></li>
<li>按钮用更多像素画出来，但因为像素更小，实际占据的物理宽度依然接近 A 厘米。</li>
</ul>
<p><strong>3）右边：更高分辨率，2K，480dpi</strong></p>
<ul>
<li>分辨率：例如 2560 × 1440 px（举例）</li>
<li>dpi：480</li>
<li>换算：<code>1dp = 3px</code>，<code>100dp = 300px</code></li>
<li>按钮在屏幕上依然大约是 A 厘米宽，只是边缘、文字更细腻。</li>
</ul>
<p>图中三个按钮，看起来差不多宽，但右边那台的像素数量最多——这就是“dp + dpi 换算”的效果：同样的 dp 值，在高密度屏上用更多 px 去画，从而保持视觉尺寸接近。</p>
<h3 data-id="heading-3"><strong>四、那 720p、 1080p 在这个故事里扮演什么角色？</strong></h3>
<ul>
<li><strong>720p、1080p</strong> 说明的是总像素数（分辨率），即屏幕一共多少个 px。</li>
<li><strong>dpi</strong> 说明的是这些像素在物理尺寸上的“密度”，和“屏幕有多大”一起决定屏幕看起来多清晰。</li>
<li><strong>dp</strong> 是在 React Native / Android / iOS 布局里用的“逻辑尺寸单位”，用来写 UI 尺寸。系统会根据当前设备的 dpi 和分辨率，用公式把 dp 换成 px。</li>
</ul>
<p>你可以大致这样理解：</p>
<ul>
<li><strong>px</strong>：砖头总数（分辨率）</li>
<li><strong>dpi</strong>：每 1cm 摆多少块砖（密度）</li>
<li><strong>dp</strong>：设计图上画的“这堵墙要 2 米宽”，具体到现场要用多少砖，由工人（系统）根据砖尺寸（dpi）来算。</li>
</ul>
<h3 data-id="heading-4"><strong>五、在 React Native 里怎么用 dp 写尺寸？</strong></h3>
<p>在 RN 代码里，你不用写 dp、px 这样的单位，直接写数字即可，这个数字默认就是 dp：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 宽高都是 dp 单位</span>
&lt;<span class="hljs-title class_">View</span> style={{ <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">40</span>, <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">8</span> }} /&gt;
</code></pre>
<p>React Native 会做几件事：</p>
<ol>
<li>获取当前设备的：
<ul>
<li>分辨率（总px数）</li>
<li>屏幕尺寸（英寸）</li>
<li>像素密度dpi（ppi）</li>
</ul>
</li>
<li>用公式 px = dp × (dpi / 160)，把你的dp换算成真实px</li>
<li>把这个px告诉底层原生视图去渲染</li>
</ol>
<p>你也可以用 <strong>Dimensions</strong> 和 <strong>PixelRatio</strong> 看一下当前设备的逻辑尺寸和像素比：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Dimensions</span>, <span class="hljs-title class_">PixelRatio</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;

<span class="hljs-keyword">const</span> { width, height } = <span class="hljs-title class_">Dimensions</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'window'</span>); <span class="hljs-comment">// 宽高，单位是 dp</span>
<span class="hljs-keyword">const</span> pixelRatio = <span class="hljs-title class_">PixelRatio</span>.<span class="hljs-title function_">get</span>();                <span class="hljs-comment">// 设备像素比，约等于 dpi / 160</span>
</code></pre>
<p>比如某台设备：</p>
<ul>
<li>width = 375，height = 812（单位是逻辑尺寸dp）</li>
<li>pixelRatio = 3</li>
<li>分辨率大约是：宽 375 × 3 = 1125px，高 812 × 3 ≈ 2436px（类似iPhoneX）</li>
</ul>
<h3 data-id="heading-5">六、和设计稿的连接：从px到dp</h3>
<p>在开发中，你最困惑的可能是： <strong>“设计师给我一张 750px 宽的图，我为什么要写 375？”</strong></p>
<p>为什么要“除以 2”？</p>
<p>这得从移动端设计的<strong>行业标准</strong>说起。</p>
<h4 data-id="heading-6">1. 什么是“2 倍图”？</h4>
<p>在 Retina（视网膜）屏幕出现之前，屏幕很渣（1倍屏），1个逻辑像素 = 1个物理像素。</p>
<p>后来 iPhone 4 搞出了 Retina 屏，屏幕大小没变，但塞进去的像素翻了一倍（横竖各翻倍）。</p>
<p>这就出现了一个标准： <strong>“2 倍图标准”</strong> （以 iPhone 6/7/8 为基准）：</p>
<ul>
<li><strong>手机物理屏幕（硬件）：</strong> 宽 750px（很细腻）。</li>
<li><strong>系统逻辑宽度（软件）：</strong> 宽 375dp（也就是系统认为只有 375 个“点”）。</li>
<li><strong>关系：</strong> 750 ÷ 375 = <strong>2</strong>。这就是 <strong>“2 倍图” (@2x)</strong> 的由来。即：<strong>2 个物理像素 = 1 个逻辑点 (dp)</strong> 。</li>
</ul>
<h4 data-id="heading-7">2. 设计师为什么喜欢给 750px 的稿子？</h4>
<p>虽然系统逻辑只要 375dp，但为了保证图标、线条在高通过率屏幕上不模糊，设计师通常会在 <strong>750px × 1334px</strong>（也就是 iPhone 6/7/8 的物理分辨率）的画布上画图。</p>
<p>这就好比：设计师在一张<strong>很大、很清晰</strong>的纸（750px）上画图，但你的手机屏幕是一个<strong>缩小镜</strong>，它要把这张大纸缩放到 375dp 的逻辑宽度里去显示。</p>
<h4 data-id="heading-8">3. 开发者怎么换算？（核心公式）</h4>
<p>因为 RN 代码里写的是 <code>dp</code>（逻辑点），而设计稿是 <code>px</code>（物理像素，且通常是 2 倍密度的）。</p>
<p>所以，拿到一张 <strong>750px 宽</strong> 的设计稿，你的换算逻辑是：</p>
<blockquote>
<p><strong>RN 数值 = 设计稿数值 ÷ 2</strong></p>
</blockquote>
<p><strong>实战例子：</strong></p>
<ul>
<li>
<p><strong>场景</strong>：设计师用 Figma 给了一张 750px 宽的设计稿。</p>
</li>
<li>
<p><strong>元素 A</strong>：设计稿上量出来宽 <strong>200px</strong>。</p>
<ul>
<li>你的思考：这是 2 倍图，所以我除以 2。</li>
<li><strong>代码写</strong>：<code>width: 100</code></li>
</ul>
</li>
<li>
<p><strong>元素 B</strong>：设计稿上量出来字号 <strong>32px</strong>。</p>
<ul>
<li>你的思考：除以 2。</li>
<li><strong>代码写</strong>：<code>fontSize: 16</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">4. 特殊情况：如果是 3 倍图呢？</h4>
<p>现在有的设计师喜欢用 iPhone 12/13/14 Pro 的尺寸做图，这类手机的画布宽度通常是 <strong>1125px</strong> 或者更高。</p>
<ul>
<li>基准逻辑宽度：依然约等于 375dp ~ 390dp。</li>
<li>换算关系：1125 ÷ 375 = 3。</li>
<li><strong>结论</strong>：如果设计师给你的是 3 倍图（超高清稿），你就 <strong>除以 3</strong>。</li>
</ul>
<p>总结：</p>
<p>问设计师一句：“你这是按几倍图画的？”</p>
<ul>
<li>如果是按 750px 宽画的，就是 <strong>2 倍图</strong> -&gt; <strong>除以 2</strong>。</li>
<li>如果是按 375px 宽画的（1 倍图），就是 <strong>1 倍图</strong> -&gt; <strong>不除，是多少写多少</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现精准操控？Cesium模型移动旋转控件实现]]></title>    <link>https://juejin.cn/post/7577663384424022067</link>    <guid>https://juejin.cn/post/7577663384424022067</guid>    <pubDate>2025-11-29T10:44:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577663384424022067" data-draft-id="7577417823342559267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现精准操控？Cesium模型移动旋转控件实现"/> <meta itemprop="keywords" content="cesium,WebGL"/> <meta itemprop="datePublished" content="2025-11-29T10:44:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="goodName"/> <meta itemprop="url" content="https://juejin.cn/user/767898264016683"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现精准操控？Cesium模型移动旋转控件实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/767898264016683/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    goodName
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T10:44:38.000Z" title="Sat Nov 29 2025 10:44:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在项目中遇到一个需求：<strong>需要在Cesium中动态编辑模型的位置</strong>。</p>
<p>熟悉三维开发的朋友应该知道，Three.js提供了十分便捷的控件来操作模型（TransformControls），但是Cesium在这方面有所欠缺：虽然通过参数设置也能实现功能，但对用户来说操作不够直观。</p>
<p>为此，我花了两三天时间开发了一个类似的模型位置编辑控件，实现了较为直观的交互操作。</p>
<p>具体效果如下图所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47f94f4c570a4bceafc1af925589ae85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29vZE5hbWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765017877&amp;x-signature=LBiRhlrRJmYKnlJIlKNa0jwr5aY%3D" alt="Cesium控件.gif" loading="lazy"/></p>
<p>整个实现过程还是有些复杂的，涉及到了坐标转换、交互处理、Cesium事件机制等。
因此在这里做个简单的分享，给大家提供一些参考。</p>
<p>本文主要从数据流的角度，说明整个系统的计算和变化过程：</p>
<h2 data-id="heading-0">1. 模型设置阶段的数据流</h2>
<p>首先，需要获取到模型或组合模型的中心点，从而设置操作的中心点并生成对应的操作轴。</p>
<p>大致的过程：模型设置 → 计算包围球 → 生成操作轴</p>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-comment">// 获取基准点</span>
    <span class="hljs-title function_">calcSceneBS</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> boundingSpheres = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">_targetList</span>.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-keyword">const</span> model = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_targetList</span>[i];
            <span class="hljs-keyword">let</span> sphere = model.<span class="hljs-property">boundingSphere</span>;
            <span class="hljs-keyword">if</span> (model <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Model</span>) {
                sphere = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getModelBS</span>(model);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (model <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Primitive</span>) {
                <span class="hljs-keyword">const</span> translation = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-title function_">getTranslation</span>(model.<span class="hljs-property">modelMatrix</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>);
                <span class="hljs-keyword">const</span> boundingSpheres = model.<span class="hljs-property">_boundingSpheres</span>;
                sphere = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">BoundingSphere</span>(translation, boundingSpheres.<span class="hljs-property">radius</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (model.<span class="hljs-property">point</span>) {
                sphere = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">BoundingSphere</span>(model.<span class="hljs-property">position</span>.<span class="hljs-title function_">getValue</span>(), <span class="hljs-number">10</span>);
            }

            <span class="hljs-keyword">if</span> (sphere) {
                boundingSpheres.<span class="hljs-title function_">push</span>(sphere);
            }
        }

        <span class="hljs-keyword">if</span> (boundingSpheres.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">_sceneSphere</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">BoundingSphere</span>.<span class="hljs-title function_">fromBoundingSpheres</span>(boundingSpheres, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">BoundingSphere</span>());
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_basePt</span> === <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">_sceneSphere</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">_sceneSphere</span>.<span class="hljs-property">center</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">_basePt</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartographic</span>.<span class="hljs-title function_">fromCartesian</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_sceneSphere</span>.<span class="hljs-property">center</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">_basePt</span>.<span class="hljs-property">longitude</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">toDegrees</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_basePt</span>.<span class="hljs-property">longitude</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">_basePt</span>.<span class="hljs-property">latitude</span> = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">toDegrees</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_basePt</span>.<span class="hljs-property">latitude</span>);
        }
    }
    
    <span class="hljs-comment">// 创建xyz轴</span>
    <span class="hljs-title function_">_createAxis</span>(<span class="hljs-params">name, color</span>) {
        <span class="hljs-keyword">const</span> positionsCallback = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">CallbackProperty</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_isValidCartesian</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_center</span>)) <span class="hljs-keyword">return</span> [];
            <span class="hljs-keyword">const</span> axes = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_getLocalAxes</span>();
            <span class="hljs-keyword">if</span> (!axes) <span class="hljs-keyword">return</span> [];
        
            <span class="hljs-comment">// 计算轴的方向向量</span>
            <span class="hljs-keyword">const</span> dir = name === <span class="hljs-string">'X'</span> ? axes.<span class="hljs-property">xAxis</span> : name === <span class="hljs-string">'Y'</span> ? axes.<span class="hljs-property">yAxis</span> : axes.<span class="hljs-property">zAxis</span>;
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_isValidCartesian</span>(dir)) <span class="hljs-keyword">return</span> [];
            
            <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">clone</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_center</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>());
            <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">add</span>(
                start,
                <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">multiplyByScalar</span>(dir, <span class="hljs-variable language_">this</span>.<span class="hljs-property">_axisLength</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>()),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>()
            );
            <span class="hljs-keyword">return</span> [start, end];
        }, <span class="hljs-literal">false</span>);

        <span class="hljs-keyword">const</span> entity = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_viewer</span>.<span class="hljs-property">entities</span>.<span class="hljs-title function_">add</span>({
            name,
            <span class="hljs-attr">polyline</span>: {
                <span class="hljs-attr">positions</span>: positionsCallback,
                <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span> === name ? <span class="hljs-number">10</span> : <span class="hljs-number">5</span>,
                <span class="hljs-attr">clampToGround</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">material</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">PolylineArrowMaterialProperty</span>(color)
            }
        });
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_axisEntities</span>.<span class="hljs-title function_">push</span>(entity);
    }
</code></pre>
<h2 data-id="heading-1">2. 交互过程的数据流</h2>
<p>完整的数据流：鼠标点击 → 拾取检测 → 坐标转换 → 变换计算 → 矩阵应用 → 视觉更新</p>
<h3 data-id="heading-2">2.1 鼠标操作</h3>
<p>我们需要判断拾取的操作轴，根据不同的轴使用不同的拾取方法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">_onLeftDown</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">_isActive</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-comment">// 拾取操作轴</span>
        <span class="hljs-keyword">const</span> pickedObject = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_scene</span>.<span class="hljs-title function_">pick</span>(event.<span class="hljs-property">position</span>);
        <span class="hljs-keyword">if</span> (pickedObject &amp;&amp; pickedObject.<span class="hljs-property">id</span>) {
            <span class="hljs-keyword">const</span> axisName = <span class="hljs-title class_">Cesium</span>.<span class="hljs-title function_">clone</span>(pickedObject.<span class="hljs-property">id</span>.<span class="hljs-property">name</span>, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">const</span> validAxes = [<span class="hljs-string">"X"</span>, <span class="hljs-string">"Y"</span>, <span class="hljs-string">"Z"</span>, <span class="hljs-string">"XY"</span>, <span class="hljs-string">"XZ"</span>, <span class="hljs-string">"YZ"</span>,
                <span class="hljs-string">"XY_CIRCLE"</span>, <span class="hljs-string">"XZ_CIRCLE"</span>, <span class="hljs-string">"YZ_CIRCLE"</span>,
                <span class="hljs-string">"SCALE_X"</span>, <span class="hljs-string">"SCALE_Y"</span>, <span class="hljs-string">"SCALE_Z"</span>];
            <span class="hljs-keyword">if</span> (validAxes.<span class="hljs-title function_">indexOf</span>(axisName) &gt;= <span class="hljs-number">0</span>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">_pickedObject</span> = pickedObject;
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_highlightPickedObject</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_pickedObject</span>);

                <span class="hljs-variable language_">this</span>.<span class="hljs-property">_viewer</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">screenSpaceCameraController</span>.<span class="hljs-property">enableRotate</span> = <span class="hljs-literal">false</span>;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">_viewer</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">screenSpaceCameraController</span>.<span class="hljs-property">enableLook</span> = <span class="hljs-literal">false</span>;

                <span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span> = axisName;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">_isDragging</span> = <span class="hljs-literal">true</span>;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouseDownPos</span> = <span class="hljs-literal">undefined</span>;
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouseDownXY</span> = event.<span class="hljs-property">position</span>;

                <span class="hljs-keyword">const</span> X = [<span class="hljs-string">"XY"</span>, <span class="hljs-string">"XY_CIRCLE"</span>, <span class="hljs-string">"X"</span>, <span class="hljs-string">"Y"</span>, <span class="hljs-string">"Z"</span>];
                <span class="hljs-keyword">const</span> Y = [<span class="hljs-string">"YZ"</span>, <span class="hljs-string">"YZ_CIRCLE"</span>];
                <span class="hljs-keyword">const</span> Z = [<span class="hljs-string">"XZ"</span>, <span class="hljs-string">"XZ_CIRCLE"</span>];

                <span class="hljs-keyword">if</span> (X.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span>) &gt; -<span class="hljs-number">1</span>) {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouseDownPos</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pickPositionOnEllipsoid</span>(event.<span class="hljs-property">position</span>);
                    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_transType</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">"MOVE"</span>) &gt;= <span class="hljs-number">0</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calcFixedAxis</span>()
                }
                <span class="hljs-keyword">if</span> (Y.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span>) &gt; -<span class="hljs-number">1</span>) {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouseDownPos</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pickPositionOnPlane</span>(event.<span class="hljs-property">position</span>, <span class="hljs-string">"YZ"</span>);
                    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_transType</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">"MOVE"</span>) &gt;= <span class="hljs-number">0</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calcFixedAxis</span>()
                }
                <span class="hljs-keyword">if</span> (Z.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span>) &gt; -<span class="hljs-number">1</span>) {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouseDownPos</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pickPositionOnPlane</span>(event.<span class="hljs-property">position</span>, <span class="hljs-string">"XZ"</span>);
                    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_transType</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">"MOVE"</span>) &gt;= <span class="hljs-number">0</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calcFixedAxis</span>()
                }

                <span class="hljs-comment">// 触发 Transform 事件</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_raiseEvent</span>(<span class="hljs-string">"Transform"</span>, {
                    <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouseDownPos</span>,
                    <span class="hljs-attr">cartographic</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouseDownPos</span>,
                    <span class="hljs-attr">axis</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span>
                });
            }
        }
    }
    
    
    <span class="hljs-title function_">_onMouseMove</span>(<span class="hljs-params">event</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">_isActive</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">_isDragging</span>) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span> === <span class="hljs-string">""</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">let</span> pos = <span class="hljs-literal">undefined</span>;
        <span class="hljs-keyword">const</span> X = [<span class="hljs-string">"XY"</span>, <span class="hljs-string">"XY_CIRCLE"</span>, <span class="hljs-string">"X"</span>, <span class="hljs-string">"Y"</span>, <span class="hljs-string">"Z"</span>];
        <span class="hljs-keyword">const</span> Y = [<span class="hljs-string">"YZ"</span>, <span class="hljs-string">"YZ_CIRCLE"</span>];
        <span class="hljs-keyword">const</span> Z = [<span class="hljs-string">"XZ"</span>, <span class="hljs-string">"XZ_CIRCLE"</span>];
        <span class="hljs-keyword">if</span> (X.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span>) &gt; -<span class="hljs-number">1</span>) pos = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pickPositionOnEllipsoid</span>(event.<span class="hljs-property">endPosition</span>);
        <span class="hljs-keyword">if</span> (Y.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span>) &gt; -<span class="hljs-number">1</span>) pos = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pickPositionOnPlane</span>(event.<span class="hljs-property">endPosition</span>, <span class="hljs-string">"YZ"</span>);
        <span class="hljs-keyword">if</span> (Z.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span>) &gt; -<span class="hljs-number">1</span>) pos = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pickPositionOnPlane</span>(event.<span class="hljs-property">endPosition</span>, <span class="hljs-string">"XZ"</span>);

        <span class="hljs-comment">// 触发 Transforming 事件</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_raiseEvent</span>(<span class="hljs-string">"Transforming"</span>, {
                <span class="hljs-title class_">MouseDownPos</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouseDownPos</span>,
                <span class="hljs-title class_">MouseMovePos</span>: pos,
                <span class="hljs-title class_">MouseDownXY</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouseDownXY</span>,
                <span class="hljs-title class_">MouseMoveXY</span>: event.<span class="hljs-property">endPosition</span>,
                <span class="hljs-title class_">SelectedAxis</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_selectedAxis</span>,
                <span class="hljs-title class_">FixedAxis</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">_fixedAxis</span>
            });
        } <span class="hljs-keyword">catch</span> (err) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error raising Transforming event:'</span>, err);
        }

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_requestRender</span>();
    }
</code></pre>
<h3 data-id="heading-3">2.2 拾取操作及坐标转换</h3>
<pre><code class="hljs language-javascipt" lang="javascipt">    /**
     * 在椭球面上拾取位置
     * @param {Cesium.Cartesian2} screenPosition 屏幕位置
     * @returns {Cesium.Cartographic} 地理坐标
     */
    pickPositionOnEllipsoid(screenPosition) {
        if (!this._initSphere || !this._initSphere.center) return undefined;

        // 获取中心点的地理坐标
        const centerCartographic = Cesium.Cartographic.fromCartesian(this._initSphere.center);

        // 根据中心点高度调整椭球半径
        const ellipsoid = Cesium.clone(Cesium.Ellipsoid.WGS84, true);
        ellipsoid.radii.x += centerCartographic.height;
        ellipsoid.radii.y += centerCartographic.height;
        ellipsoid.radii.z += centerCartographic.height;
        const adjustedEllipsoid = new Cesium.Ellipsoid(
            ellipsoid.radii.x,
            ellipsoid.radii.y,
            ellipsoid.radii.z
        );

        // 拾取位置
        const cartesian = this._viewer.camera.pickEllipsoid(screenPosition, adjustedEllipsoid, new Cesium.Cartesian3());
        if (cartesian === undefined) return undefined;

        // 转换为地理坐标
        const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
        return cartographic;
    }

    /**
     * 在指定平面上拾取位置
     * @param {Cesium.Cartesian2} screenPosition 屏幕位置
     * @param {String} planeType 平面类型 ("XY"|"YZ"|"XZ")
     * @returns {Cesium.Cartographic} 地理坐标
     */
    pickPositionOnPlane(screenPosition, planeType) {
        this._calcCallbackArgs();

        if (!this._initSphere || !this._initSphere.center) return undefined;
        if (!this._callbackCartographic) return undefined;

        const r = this._axisZoom * 1e-5;
        const lon = this._callbackCartographic.longitude;
        const lat = this._callbackCartographic.latitude;
        const height = this._callbackCartographic.height;

        // 创建三角形用于平面相交测试
        let i, n, a;
        if (planeType === "YZ") {
            i = Cesium.Cartesian3.fromRadians(lon, lat - r, -2e3);
            n = Cesium.Cartesian3.fromRadians(lon, lat, height + this._axisZoom * 0.95 + 1e3);
            a = Cesium.Cartesian3.fromRadians(lon, lat + r, -2e3);
        } else {
            // XZ 平面
            i = Cesium.Cartesian3.fromRadians(lon - r, lat, -2e3);
            n = Cesium.Cartesian3.fromRadians(lon, lat, height + this._axisZoom * 0.95 + 1e3);
            a = Cesium.Cartesian3.fromRadians(lon + r, lat, -2e3);
        }

        const ray = this._viewer.camera.getPickRay(screenPosition);
        if (!ray) return undefined;

        // 计算平面法向量（基于经度）
        const centerCartographic = Cesium.Cartographic.fromCartesian(this._initSphere.center);
        const s = Math.cos(centerCartographic.longitude);
        const l = Math.sin(centerCartographic.longitude);
        const d = 0;
        const plane = new Cesium.Plane.fromPointNormal(
            new Cesium.Cartesian3(0, 0, 0),
            new Cesium.Cartesian3(s, l, d)
        );

        // 创建射线终点
        const rayEnd = new Cesium.Cartesian3();
        rayEnd.x = ray.origin.x + ray.direction.x * 1e6;
        rayEnd.y = ray.origin.y + ray.direction.y * 1e6;
        rayEnd.z = ray.origin.z + ray.direction.z * 1e6;

        // 线段与三角形相交测试
        const intersection = Cesium.IntersectionTests.lineSegmentTriangle(
            ray.origin,
            rayEnd,
            i,
            n,
            a
        );

        if (intersection === undefined) return undefined;

        // 转换为地理坐标
        const cartographic = Cesium.Cartographic.fromCartesian(intersection);
        return cartographic;
    }
    
    /**
     * 计算回调参数（用于动态更新）
     */
    _calcCallbackArgs() {
        if (!this._initSphere || !this._initSphere.center) return;
        this._callbackCenter = this._initSphere.center;
        this._callbackCartographic = Cesium.Cartographic.fromCartesian(this._callbackCenter);
        this._callbackLonDeg = Cesium.Math.toDegrees(this._callbackCartographic.longitude);
        this._callbackLatDeg = Cesium.Math.toDegrees(this._callbackCartographic.latitude);
        this._callbackHeight = this._callbackCartographic.height;
        this._viewer.scene.requestRender();
    }
</code></pre>
<h3 data-id="heading-4">2.3 变换矩阵</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">getMatrixOfTileset</span>(<span class="hljs-params">tileset, deltaLon, deltaLat, deltaHeight, heading, pitch, roll, scaleX, scaleY, scaleZ, baseLon, baseLat, baseHeight</span>) {
    <span class="hljs-keyword">let</span> baseLonRad = baseLon;
    <span class="hljs-keyword">let</span> baseLatRad = baseLat;
    <span class="hljs-keyword">let</span> baseHeightM = baseHeight;

    <span class="hljs-comment">// 计算基准位置和目标位置</span>
    <span class="hljs-keyword">const</span> basePos = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromRadians</span>(baseLonRad, baseLatRad, baseHeightM);
    <span class="hljs-keyword">const</span> targetPos = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-title function_">fromRadians</span>(
        baseLonRad + deltaLon,
        baseLatRad + deltaLat,
        baseHeightM + deltaHeight
    );

    <span class="hljs-comment">// 角度转换为弧度</span>
    heading = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">toRadians</span>(heading);
    pitch = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">toRadians</span>(pitch);
    roll = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">toRadians</span>(roll);

    <span class="hljs-comment">// 创建四元数旋转</span>
    <span class="hljs-keyword">const</span> quaternion = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Quaternion</span>.<span class="hljs-title function_">fromHeadingPitchRoll</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">HeadingPitchRoll</span>(heading, pitch, roll)
    );
    <span class="hljs-keyword">const</span> scale = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>(scaleX, scaleY, scaleZ);
    
    <span class="hljs-comment">// 创建变换矩阵（旋转 + 缩放）</span>
    <span class="hljs-keyword">const</span> transform = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-title function_">fromTranslationQuaternionRotationScale</span>(
        <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Cartesian3</span>.<span class="hljs-property">ZERO</span>,
        quaternion,
        scale
    );

    <span class="hljs-comment">// 坐标系变换</span>
    <span class="hljs-keyword">const</span> baseFrame = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Transforms</span>.<span class="hljs-title function_">eastNorthUpToFixedFrame</span>(basePos);
    <span class="hljs-keyword">const</span> baseFrameInv = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-title function_">inverse</span>(baseFrame, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>);
    <span class="hljs-keyword">const</span> targetFrame = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Transforms</span>.<span class="hljs-title function_">eastNorthUpToFixedFrame</span>(targetPos);

    <span class="hljs-comment">// 合成最终变换矩阵</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-title function_">multiply</span>(transform, baseFrameInv, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-title function_">multiply</span>(targetFrame, result, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>);
}
</code></pre>
<h3 data-id="heading-5">2.4 矩阵应用到模型</h3>
<pre><code class="hljs language-javaScript" lang="javaScript"><span class="hljs-title function_">applyTransformToTileset</span>(<span class="hljs-params">tileset, deltaLon, deltaLat, deltaHeight, heading, pitch, roll, scaleX, scaleY, scaleZ, baseLon, baseLat, baseHeight</span>) {
    <span class="hljs-comment">// 获取变换矩阵</span>
    <span class="hljs-keyword">const</span> transformMatrix = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getMatrixOfTileset</span>(
        tileset, deltaLon, deltaLat, deltaHeight, heading, pitch, roll,
        scaleX, scaleY, scaleZ, baseLon, baseLat, baseHeight
    );
    
    <span class="hljs-keyword">if</span> (transformMatrix) {
        <span class="hljs-comment">// 将变换矩阵应用到初始模型矩阵</span>
        <span class="hljs-keyword">const</span> resultMatrix = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-title function_">multiply</span>(transformMatrix, <span class="hljs-variable language_">this</span>.<span class="hljs-property">_mouseDownMM</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>);
        tileset.<span class="hljs-property">modelMatrix</span> = resultMatrix;
    }
}
</code></pre>
<h3 data-id="heading-6">2.5 轴更新</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">_getLocalAxes</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> enuMatrix = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Transforms</span>.<span class="hljs-title function_">eastNorthUpToFixedFrame</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_center</span>)

    <span class="hljs-comment">// 从ENU矩阵提取坐标轴</span>
    <span class="hljs-keyword">const</span> xAxis = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-title function_">multiplyByPointAsVector</span>(
        enuMatrix,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>()
    );
    <span class="hljs-keyword">const</span> yAxis = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-title function_">multiplyByPointAsVector</span>(
        enuMatrix,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>()
    );
    <span class="hljs-keyword">const</span> zAxis = <span class="hljs-title class_">Cesium</span>.<span class="hljs-property">Matrix4</span>.<span class="hljs-title function_">multiplyByPointAsVector</span>(
        enuMatrix,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cesium</span>.<span class="hljs-title class_">Cartesian3</span>()
    );

    <span class="hljs-keyword">return</span> { xAxis, yAxis, zAxis };
}
</code></pre>
<h2 data-id="heading-7">3. 简单总结一下</h2>
<p>应该还有其他优化的部分，比如轴大小随视距缩放之类的。</p>
<p>有机会把完整代码放出来开源，争取达到开箱即用的效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[省下5万培训费！这份Python量化自学路线，比付费课更狠]]></title>    <link>https://juejin.cn/post/7577683422878498850</link>    <guid>https://juejin.cn/post/7577683422878498850</guid>    <pubDate>2025-11-30T03:01:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577683422878498850" data-draft-id="7577713754563166260" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="省下5万培训费！这份Python量化自学路线，比付费课更狠"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T03:01:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java私教"/> <meta itemprop="url" content="https://juejin.cn/user/3394924618197325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            省下5万培训费！这份Python量化自学路线，比付费课更狠
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394924618197325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java私教
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:01:46.000Z" title="Sun Nov 30 2025 03:01:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">你是在学技术，还是在“被割韭菜”？</h2>
<p>很多想转行做量化或者想用Python搞搞副业的朋友，上来就犯了一个致命错误：<strong>「报班、买书、啃语法」</strong>。</p>
<p>结果呢？花了几个月把《Python编程从入门到实践》啃完了，只会写个 <code>print("Hello World")</code>。一旦让你去处理一个真实的 10GB 股票行情数据，或者写一个最简单的双均线策略，立马两眼一抹黑，报错报到怀疑人生。</p>
<p><strong>「这就是典型的“战术勤奋，战略懒惰”。」</strong></p>
<p>如果你不改变学习路径，别说做量化赚钱了，你连量化回测框架的门都摸不到。今天这篇文章，不卖课，不讲废话，直接把**「能落地的、省钱的、直击核心的」**学习路径拍在你脸上。</p>
<h2 data-id="heading-1">量化不是“背字典”，而是“学做菜”</h2>
<p>很多人学Python量化，把Python当成英语单词来背。今天背列表（List），明天背字典（Dictionary），后天背类（Class）。</p>
<p><strong>「大错特错。」</strong></p>
<p>量化交易的本质，是**「数据驱动的决策逻辑」**。</p>
<ul>
<li>**数据（Data）**是食材。</li>
<li>**Python（Pandas/Numpy）**是菜刀。</li>
<li>**策略（Strategy）**是菜谱。</li>
<li>**回测系统（Backtest）**是炒锅。</li>
</ul>
<p>你不需要把菜刀的金属成分（底层源码）研究透，你只需要知道**「怎么切肉最快」<strong>（向量化运算）。 你不需要背诵所有菜谱，你只需要</strong>「先学会炒这一个西红柿炒鸡蛋」**（跑通一个策略），然后自然就会举一反三了。</p>
<p><strong>「结论：以“策略”为导向，倒逼“语法”学习。」</strong> 只要这个语法现在用不到，就别学！</p>
<h2 data-id="heading-2">别做“循环怪”，要做“向量王”</h2>
<p>量化领域最鄙视的一种代码，就是**「for循环」**。 处理一年的分钟级数据（约24万行），如果你用for循环一行行去算均线，收盘了你还没算完。</p>
<p>来看看**「菜鸟」<strong>和</strong>「老手」**的区别。</p>
<p><strong>「场景」</strong>：计算某只股票收盘价的 5日移动平均线（MA5）。</p>
<h3 data-id="heading-3">❌ 菜鸟写法（由慢又长，典型的C语言思维）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 模拟数据：100万行数据</span>
df = pd.DataFrame({<span class="hljs-string">'close'</span>: [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>)]})

start_time = time.time()

<span class="hljs-comment"># 创建一个空列表存结果</span>
ma5 = []
<span class="hljs-comment"># 典型的“循环怪”写法，慢到令人发指</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(df)):
    <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">4</span>:
        ma5.append(<span class="hljs-literal">None</span>) <span class="hljs-comment"># 前4天算不出来</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 每次都要切片、求和、除法，CPU在哭泣</span>
        current_ma = <span class="hljs-built_in">sum</span>(df[<span class="hljs-string">'close'</span>][i-<span class="hljs-number">4</span>:i+<span class="hljs-number">1</span>]) / <span class="hljs-number">5</span>
        ma5.append(current_ma)

df[<span class="hljs-string">'ma5_loop'</span>] = ma5

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"循环耗时: <span class="hljs-subst">{time.time() - start_time:<span class="hljs-number">.4</span>f}</span> 秒"</span>)
<span class="hljs-comment"># 在我的电脑上，这跑了大概 15秒+</span>
</code></pre>
<h3 data-id="heading-4">✅ 大神写法（Pandas 向量化，一行搞定）</h3>
<pre><code class="hljs language-scss" lang="scss">start_time = <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.time</span>()

# 这一行代码，利用底层C语言优化，效率提升百倍
# <span class="hljs-built_in">rolling</span>(<span class="hljs-number">5</span>) 是滑动窗口，<span class="hljs-built_in">mean</span>() 是求平均
df<span class="hljs-selector-attr">[<span class="hljs-string">'ma5_vector'</span>]</span> = df<span class="hljs-selector-attr">[<span class="hljs-string">'close'</span>]</span><span class="hljs-selector-class">.rolling</span>(window=<span class="hljs-number">5</span>)<span class="hljs-selector-class">.mean</span>()

<span class="hljs-built_in">print</span>(f"向量化耗时: {time.time() - start_time:.<span class="hljs-number">4</span>f} 秒")
# 耗时通常在 <span class="hljs-number">0.05</span>秒 左右，快了<span class="hljs-number">300</span>倍！
</code></pre>
<p><strong>「核心逻辑」</strong>：在量化里，能用 <code>Pandas</code> / <code>Numpy</code> 内置函数的，<strong>「绝对不要自己写循环」</strong>。这就是专业和业余的分水岭。</p>
<h2 data-id="heading-5">新手最容易踩的3个死穴</h2>
<h3 data-id="heading-6">1. 环境配置“劝退”</h3>
<p>不要去官网下载原生 Python！不要！ 你会发现装个 <code>talib</code> 报错，装个 <code>backtrader</code> 报错，最后还没开始写代码就放弃了。 <strong>「解法」</strong>：直接下载 <strong>「Anaconda」</strong> 或者 <strong>「Miniconda」</strong>。它把科学计算包都给你打包好了，开箱即用。</p>
<h3 data-id="heading-7">2. 沉迷“造轮子”</h3>
<p>很多新手觉得自己牛逼，非要从零写一个回测框架。结果写了一年，Bug比代码还多，订单撮合逻辑全是错的。 <strong>「解法」</strong>：站在巨人的肩膀上。入门用 <code>Backtrader</code>（经典），进阶看 <code>Zipline</code>（工业级）或 <code>VeighNa</code>（实盘）。先学会开法拉利，再去研究法拉利怎么造。</p>
<h3 data-id="heading-8">3. 未来函数（Look-ahead Bias）</h3>
<p>这是最隐蔽的坑。你在编写策略时，无意中用到了“明天”的数据来决定“今天”的交易。 比如：<code>if close_price &gt; open_price: buy()</code>。 注意！<code>close_price</code> 是收盘才知道的，你在盘中（Open的时候）是不可能知道收盘价的。 <strong>「结果」</strong>：回测收益率 500%，实盘亏成狗。</p>
<h2 data-id="heading-9">总结</h2>
<p>学习Python量化，千万别走直线。</p>
<p><strong>「送大家一张“极简上位路线图”：」</strong></p>
<ol>
<li><strong>「装好 Anaconda」</strong>（1小时）。</li>
<li><strong>「花3天搞定 Pandas」</strong>：重点看 <code>DataFrame</code>、<code>Series</code>、<code>resample</code>（重采样）、<code>rolling</code>（滑动窗口）。</li>
<li><strong>「找一个现成的策略代码」</strong>（比如双均线），跑通它，不管懂不懂，先让它跑起来。</li>
<li><strong>「修改它」</strong>：把参数 5天改成 10天，看看结果变没变？</li>
<li><strong>「接入数据」</strong>：学习怎么用 <code>Tushare</code> 或 <code>Baostock</code> 拉取真实数据。</li>
</ol>
<p><strong>「一句话口诀：」</strong> <strong>「少写循环多用库，策略跑通是起步。回测千万防未来，实盘之前看回撤。」</strong></p>
<hr/>
<p><em>你在学习量化的过程中，是在环境配置上卡最久，还是在策略逻辑上卡最久？评论区聊聊，我帮你避坑。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Web 3D地球实时统计访问来源]]></title>    <link>https://juejin.cn/post/7577722399375081514</link>    <guid>https://juejin.cn/post/7577722399375081514</guid>    <pubDate>2025-11-29T13:09:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577722399375081514" data-draft-id="7577660060093988918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Web 3D地球实时统计访问来源"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-11-29T13:09:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="i听风逝夜"/> <meta itemprop="url" content="https://juejin.cn/user/588993963758215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Web 3D地球实时统计访问来源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963758215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    i听风逝夜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T13:09:43.000Z" title="Sat Nov 29 2025 13:09:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="zenburn">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#3f3f3f;color:#dcdcdc}.hljs-keyword,.hljs-selector-tag,.hljs-tag{color:#e3ceab}.hljs-template-tag{color:#dcdcdc}.hljs-number{color:#8cd0d3}.hljs-attribute,.hljs-template-variable,.hljs-variable{color:#efdcbc}.hljs-literal{color:#efefaf}.hljs-subst{color:#8f8f8f}.hljs-name,.hljs-section,.hljs-selector-class,.hljs-selector-id,.hljs-title,.hljs-type{color:#efef8f}.hljs-bullet,.hljs-link,.hljs-symbol{color:#dca3a3}.hljs-built_in,.hljs-builtin-name,.hljs-deletion,.hljs-string{color:#cc9393}.hljs-addition,.hljs-comment,.hljs-meta,.hljs-quote{color:#7f9f7f}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>这篇文章介绍一个Web 3D地球实时统计访问来源的开源项目，效果如下，当服务器有http流量进来时，web通过3D地球+飞线实时绘制客户端的来源</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8374b86eaa914a91a6c3a2511af82d5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaeWQrOmjjumAneWknA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026583&amp;x-signature=05B05mswM%2Fiat0w9vOIQjSnxjfQ%3D" alt="Peek 2025-11-29 21-03.gif" loading="lazy"/></p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhouxinlin%2Flive-origin" target="_blank" title="https://github.com/houxinlin/live-origin" ref="nofollow noopener noreferrer">github.com/houxinlin/l…</a></p>
<h2 data-id="heading-1">实现原理</h2>
<p>要在服务器上捕获http流量，也就是抓包，抓包有两种方案，一是使用类似pcap的库从内核捕获网络数据包，另一种比较复杂是使用ebpf拦截系统的函数点，以检测流量，本项目是使用pcap实现。</p>
<p>要通过代码把流量抓下来，其实逻辑比较简单，大概如下</p>
<ol>
<li><strong>打开设备 (Open Device)</strong> ：<br/>
首先得告诉程序我们要监听哪个网卡（比如 eth0 还是 wlan0）。这里通常需要开启混杂模式 ，否则网卡默认只会接收发给它自己的包，而忽略广播或其他流量。</li>
<li><strong>设置过滤器 (Set BPF Filter)</strong> ：<br/>
这一步很重要，服务器上的流量太杂了，SSH、数据库、等数据包。我们只想看 HTTP 流量，所以需要设置一个过滤规则，比如 tcp port 80 or tcp port 443。这用的就是 BPF (Berkeley Packet Filter) 语法，效率极高，直接在内核层就把不相关的包扔掉了。</li>
<li><strong>循环抓包 (Loop)</strong> ：<br/>
前两步配置好后，就是在一个死循环里不断地从句柄中读取数据包（Packet）。</li>
</ol>
<p>伪代码大概长这样：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 1. 打开网卡 eth0，65535是最大捕获长度，1是开启混杂模式</span>
handle = pcap_open_live(<span class="hljs-string">"eth0"</span>, <span class="hljs-number">65535</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1000</span>, errbuf);

<span class="hljs-comment">// 2. 编译并设置过滤规则</span>
pcap_compile(handle, &amp;fp, <span class="hljs-string">"tcp port 80"</span>, <span class="hljs-number">0</span>, net);
pcap_setfilter(handle, &amp;fp);

<span class="hljs-comment">// 3. 每抓到一个包就回调 process_packet 函数</span>
pcap_loop(handle, <span class="hljs-number">-1</span>, process_packet, <span class="hljs-literal">NULL</span>);
</code></pre>
<p>pcap_loop 捕获到数据时，拿到手的是一堆原始的二进制字节，截获到的数据包，需要解析出以太网帧头，以太头由 14 字节固定长度构成，用于指明目标与源 MAC 地址，以及数据使用的上层协议类型，如下。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c895c55142f4503ba4d7cc5f5b24b7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaeWQrOmjjumAneWknA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026583&amp;x-signature=D0n7yR29NNBOtQzbTyiG3i5VQbM%3D" alt="image.png" loading="lazy"/></p>
<p>其中数据类型表示以太网帧中载荷（Payload）是什么协议的数据。</p>

























<table><thead><tr><th>协议类型</th><th>十六进制</th><th>说明</th></tr></thead><tbody><tr><td>IPv4</td><td>0x0800</td><td>表示数据部分是 IPv4 数据包</td></tr><tr><td>ARP</td><td>0x0806</td><td>地址解析协议</td></tr><tr><td>IPv6</td><td>0x86DD</td><td>IPv6 数据包</td></tr></tbody></table>
<p>在项目中，解析时直接跳过14字节去解析ip报文即可，因为用不到以太数据，解析到ip头后就可以获取客户端的地址了，ip头格式如下。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f866a22fde304f5b92cca95409feb252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaeWQrOmjjumAneWknA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026583&amp;x-signature=76VWxj1BHXFdKwQ69aOUQ5tuuFc%3D" alt="image.png" loading="lazy"/></p>
<p>获取ip包信息代码如下</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(u_char *d, <span class="hljs-keyword">struct</span> pcap_pkthdr *h, u_char *p)</span> {
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip</span> *<span class="hljs-title">ip4_pkt</span> =</span> (<span class="hljs-keyword">struct</span> ip *) (p + link_offset);
    <span class="hljs-type">uint32_t</span> ip_hl = ip4_pkt-&gt;ip_hl * <span class="hljs-number">4</span>;
    <span class="hljs-type">uint8_t</span> ip_proto = ip4_pkt-&gt;ip_p;
    <span class="hljs-type">char</span> ip_src[INET_ADDRSTRLEN];
    <span class="hljs-type">char</span> ip_dst[INET_ADDRSTRLEN];
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *data;
    <span class="hljs-type">uint32_t</span> len = h-&gt;caplen;

    inet_ntop(AF_INET, (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) &amp;ip4_pkt-&gt;ip_src, ip_src, <span class="hljs-keyword">sizeof</span>(ip_src));
    inet_ntop(AF_INET, (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *) &amp;ip4_pkt-&gt;ip_dst, ip_dst, <span class="hljs-keyword">sizeof</span>(ip_dst));
 }
</code></pre>
<p>接下来拿到客户端的ip后，解析出ip的经纬度通过websocket发送到前端即可，经纬度有两种办法可以获取。</p>
<ol>
<li>
<p>使用maxminddb</p>
<p>他是一种离线的经纬度查询系统，但是测试后不太准确，优点是速度极快。</p>
</li>
<li>
<p>在线服务</p>
<p>寻找大量的在线ip转经纬度服务，找到他的api接口，在程序中使用负载均衡（因为免费服务都要分钟内次数限制）</p>
</li>
</ol>
<p>但是，目前广泛的做法是nginx做web监听，使用https 443端口，虽然抓包获取ip来源没问题，但是有时候我们想通过http请求头中的字段获取ip，比如真实的用户IP往往藏在HTTP请求头的 X-Forwarded-For 或者 X-Real-IP 类似的字段里，这就需要解析tcp数据包，从tcp的Payload中解析出http请求头信息。</p>
<pre><code class="hljs language-c" lang="c">GET /api/v1/stats HTTP/<span class="hljs-number">1.1</span>
Host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
User-Agent: Mozilla/<span class="hljs-number">5.0</span>...
X-Forwarded-For: <span class="hljs-number">203.0</span><span class="hljs-number">.113</span><span class="hljs-number">.195</span>
...
</code></pre>
<p>项目直接调用<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnodejs%2Fhttp-parser" target="_blank" title="https://github.com/nodejs/http-parser" ref="nofollow noopener noreferrer">github.com/nodejs/http…</a> 这个库去解析http头，他是被广泛验证的高性能 C 解析库（这也是 Node.js 早期底层使用的解析器）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[若依工作流-包含网关]]></title>    <link>https://juejin.cn/post/7577681092138188835</link>    <guid>https://juejin.cn/post/7577681092138188835</guid>    <pubDate>2025-11-30T01:24:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577681092138188835" data-draft-id="7577683422878335010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="若依工作流-包含网关"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T01:24:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码次位面"/> <meta itemprop="url" content="https://juejin.cn/user/1535333867720295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            若依工作流-包含网关
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535333867720295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码次位面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T01:24:13.000Z" title="Sun Nov 30 2025 01:24:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">概念</h3>
<p>包含网关是一种工作流中的路由节点，它能够<strong>同时激活所有符合条件的路径</strong>，并在汇聚点等待所有被激活的路径执行完成后，才继续向下流转。<br/>
以下案例在线体验，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruoyiflow.com" target="_blank" title="https://www.ruoyiflow.com" ref="nofollow noopener noreferrer">ruoyiflow</a></p>
<h3 data-id="heading-1">需求描述</h3>
<p>公司全体员工都需要进行“常规项检查”和“抽血化验”，而管理层领导额外需要进行“附加项检查”。</p>
<h3 data-id="heading-2">流程设计</h3>
<p>1.用小扳手将网关类型设置为包含网关</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7d8e78423ef42f098526b9c49edd20e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765070653&amp;x-signature=ixtTtaM2IyOfZyF%2Fr88NtryxPJQ%3D" alt="x1" loading="lazy"/>
2.分别设计三条流出路径，其中两条是默认路线，即常规检查和抽血化验， 一条是领导专属的附加检查
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a78ce90584f4b45b630ef4da5cd2628~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765070653&amp;x-signature=n6F5bg0XP3CiALv8Ns8P8cEx1qw%3D" alt="x2" loading="lazy"/>
3.设置服务任务的属性， 这里我们设置为一个测试的方法
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a78ce90584f4b45b630ef4da5cd2628~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765070653&amp;x-signature=n6F5bg0XP3CiALv8Ns8P8cEx1qw%3D" alt="x2" loading="lazy"/>
4.流程实际运行的结果
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/332d93ccee8244dfb7ad12e2f848b5c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765070653&amp;x-signature=aGkLoa1PoLj83OewOPj3Pvhzh2Y%3D" alt="x2" loading="lazy"/></p>
<h3 data-id="heading-3">bpmn文件</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bpmn:definitions</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="hljs-attr">xmlns:bpmn</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span> <span class="hljs-attr">xmlns:bpmndi</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/DI"</span> <span class="hljs-attr">xmlns:dc</span>=<span class="hljs-string">"http://www.omg.org/spec/DD/20100524/DC"</span> <span class="hljs-attr">xmlns:camunda</span>=<span class="hljs-string">"http://camunda.org/schema/1.0/bpmn"</span> <span class="hljs-attr">xmlns:di</span>=<span class="hljs-string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Definitions_1"</span> <span class="hljs-attr">targetNamespace</span>=<span class="hljs-string">"http://bpmn.io/schema/bpmn"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Process_9988"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"体检流程"</span> <span class="hljs-attr">isExecutable</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Event_0pygc7d"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_06uhglv<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:startEvent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_06uhglv"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Event_0pygc7d"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Activity_1oi7a6w"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_1oi7a6w"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"体检流程"</span> <span class="hljs-attr">camunda:assignee</span>=<span class="hljs-string">"${startUser}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:extensionElements</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formData</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formField</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userType"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"员工类型"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"long"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">camunda:formData</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:extensionElements</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_06uhglv<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_1cfkc1x<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:userTask</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_1cfkc1x"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Activity_1oi7a6w"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Gateway_082pcsr"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:inclusiveGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Gateway_082pcsr"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_1cfkc1x<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_12o75yq<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_17y2qrg<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_0whi5cb<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:inclusiveGateway</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_12o75yq"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Gateway_082pcsr"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Activity_0tg7rc8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_0tg7rc8"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"常规项检查"</span> <span class="hljs-attr">camunda:delegateExpression</span>=<span class="hljs-string">"${includeApproveTask}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_12o75yq<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_1gpmmkv<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:serviceTask</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_1gpmmkv"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Activity_0tg7rc8"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Gateway_1vlogqd"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:inclusiveGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Gateway_1vlogqd"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_1gpmmkv<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_06kg33d<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_12i1kyq<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_0s2cs7t<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:inclusiveGateway</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Event_0klslb1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_0s2cs7t<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:endEvent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_0s2cs7t"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Gateway_1vlogqd"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Event_0klslb1"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_17y2qrg"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"领导专属"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Gateway_082pcsr"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Activity_0z4j3c2"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:conditionExpression</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"bpmn:tFormalExpression"</span>&gt;</span>${userType==2}<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:conditionExpression</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:sequenceFlow</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_0z4j3c2"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"附加检查"</span> <span class="hljs-attr">camunda:delegateExpression</span>=<span class="hljs-string">"${includeApproveTask}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_17y2qrg<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_06kg33d<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:serviceTask</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_06kg33d"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Activity_0z4j3c2"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Gateway_1vlogqd"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_0whi5cb"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Gateway_082pcsr"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Activity_1udv0ib"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_12i1kyq"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Activity_1udv0ib"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Gateway_1vlogqd"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_1udv0ib"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"抽血化验"</span> <span class="hljs-attr">camunda:delegateExpression</span>=<span class="hljs-string">"${includeApproveTask}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_0whi5cb<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_12i1kyq<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:serviceTask</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:process</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNDiagram</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BPMNDiagram_1"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNPlane</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BPMNPlane_1"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Process_9988"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNShape</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Event_0pygc7d_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Event_0pygc7d"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dc:Bounds</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"272"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"232"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"36"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"36"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNShape</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNShape</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_0dmv1pk_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Activity_1oi7a6w"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dc:Bounds</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"360"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"210"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"80"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNShape</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNShape</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Gateway_1f5mkme_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Gateway_082pcsr"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dc:Bounds</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"515"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"225"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"50"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNShape</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNShape</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_1xhstnt_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Activity_0tg7rc8"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dc:Bounds</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"660"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"70"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"80"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNLabel</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNShape</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNShape</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Gateway_18xqnd7_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Gateway_1vlogqd"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dc:Bounds</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"845"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"225"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"50"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNShape</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNShape</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Event_0klslb1_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Event_0klslb1"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dc:Bounds</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"962"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"232"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"36"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"36"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNShape</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNShape</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_0mi86gy_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Activity_0z4j3c2"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dc:Bounds</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"660"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"340"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"80"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNLabel</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNShape</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNShape</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_14rh5fv_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Activity_1udv0ib"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dc:Bounds</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"660"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"210"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"80"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNLabel</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNShape</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNEdge</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_06uhglv_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Flow_06uhglv"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"308"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"250"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"360"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"250"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNEdge</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNEdge</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_1cfkc1x_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Flow_1cfkc1x"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"460"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"250"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"515"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"250"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNEdge</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNEdge</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_12o75yq_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Flow_12o75yq"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"540"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"225"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"540"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"110"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"660"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"110"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNLabel</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">dc:Bounds</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"558"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"180"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"44"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"14"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNEdge</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNEdge</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_1gpmmkv_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Flow_1gpmmkv"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"760"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"110"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"870"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"110"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"870"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"225"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNEdge</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNEdge</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_0s2cs7t_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Flow_0s2cs7t"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"895"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"250"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"962"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"250"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNEdge</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNEdge</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_17y2qrg_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Flow_17y2qrg"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"540"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"275"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"540"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"380"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"660"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"380"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNLabel</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">dc:Bounds</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"571"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"353"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"44"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"14"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNEdge</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNEdge</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_06kg33d_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Flow_06kg33d"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"760"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"380"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"870"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"380"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"870"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"275"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNEdge</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNEdge</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_0whi5cb_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Flow_0whi5cb"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"565"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"250"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"660"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"250"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNEdge</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNEdge</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_12i1kyq_di"</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"Flow_12i1kyq"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"760"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"250"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">di:waypoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"845"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"250"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNEdge</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNPlane</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNDiagram</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:definitions</span>&gt;</span>

</code></pre>
<p>在线体验，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruoyiflow.com" target="_blank" title="https://www.ruoyiflow.com" ref="nofollow noopener noreferrer">ruoyiflow</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-169 Elasticsearch 入门到可用：索引/文档 CRUD 与搜索最小示例]]></title>    <link>https://juejin.cn/post/7577691061033484334</link>    <guid>https://juejin.cn/post/7577691061033484334</guid>    <pubDate>2025-11-30T01:57:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061033484334" data-draft-id="7577705544875212838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-169 Elasticsearch 入门到可用：索引/文档 CRUD 与搜索最小示例"/> <meta itemprop="keywords" content="大数据,后端,Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-30T01:57:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-169 Elasticsearch 入门到可用：索引/文档 CRUD 与搜索最小示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T01:57:51.000Z" title="Sun Nov 30 2025 01:57:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：本地/云主机快速跑通 Elasticsearch 的索引创建、插入、查询、更新、搜索。</li>
<li>结论：按 REST 规范与正确端点即可稳定返回；注意版本差异与安全默认项（8.x）。</li>
<li>产出：一套可复制的最小可用流程  常见错误速查卡。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/315065b1288c4b3e99bb878a162d76cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072670&amp;x-signature=UHSPRS9Ef1W0TpcN1hT3VwlXn0Q%3D" alt="请添加图片描述" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e7624462d174c5ba18419cdcbe23498~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072670&amp;x-signature=%2B50Z7H4oAdWJ4crf3BGcxbLhtGo%3D" alt="Elasticsearch" loading="lazy"/></p>
<h2 data-id="heading-1">ES简单使用</h2>
<h3 data-id="heading-2">创建索引</h3>
<p>创建 wzk_blog01 索引</p>
<pre><code class="hljs language-shell" lang="shell">http://h121.wzk.icu:9200/wzk_blog01/?pertty
</code></pre>
<p>返回结果如下：</p>
<pre><code class="hljs language-shell" lang="shell">{
  "acknowledged": true,
  "shards_acknowledged": true,
  "index": "wzk_blog01"
}
</code></pre>
<p>对应的截图如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc745cea89244b6b8cc628d88ce207f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072670&amp;x-signature=vvxBvkvt67Os4OxhfqfbN%2BWKyZQ%3D" alt="创建索引" loading="lazy"/></p>
<h3 data-id="heading-3">插入文档</h3>
<pre><code class="hljs language-shell" lang="shell">http://h121.wzk.icu:9200/wzk_blog01/_doc/1?pretty
{"id": "1", "title": "What is lucene"}

https://h121.wzk.icu:9200/wzk_blog01/_doc/1?pretty
{"id": "1", "title": "What is wzk icu"}

https://h121.wzk.icu:9200/wzk_blog01/_doc/1?pretty 
{"id": "1", "title": "Apache Spark is a unified analytics engine for large-scale data processing"}
</code></pre>
<p>返回结果如下：</p>
<pre><code class="hljs language-shell" lang="shell">{
    "_index": "wzk_blog01",
    "_id": "1",
    "_version": 1,
    "result": "created",
    "_shards": {
        "total": 2,
        "successful": 1,
        "failed": 0
    },
    "_seq_no": 0,
    "_primary_term": 1
}
</code></pre>
<h3 data-id="heading-4">查询文档</h3>
<pre><code class="hljs language-shell" lang="shell">http://h121.wzk.icu:9200/wzk_blog01/_doc/_search/1?pretty
</code></pre>
<p>返回结果如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"_index"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wzk_blog01"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_seq_no"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_primary_term"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"found"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Apache Spark is a unified analytics engine for large-scale data processing"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>对应截图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af262bdd20a443b69090ce8a22cbd705~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072670&amp;x-signature=8D%2FIlXg%2BCI8VsDlZkGm958xJ%2FvI%3D" alt="插入数据" loading="lazy"/></p>
<h3 data-id="heading-5">更新文档</h3>
<pre><code class="hljs language-shell" lang="shell">http://h121.wzk.icu:9200/wzk_blog01/_doc/1?pretty
{"id": "1", "title": " What is elasticsearch"}
</code></pre>
<p>返回结果如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"_index"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wzk_blog01"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"updated"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_shards"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"total"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"successful"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"failed"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_seq_no"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_primary_term"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>对应截图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa1062f27ef1464485c6c2abd82b536d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072670&amp;x-signature=Y0g2qhdvyIXDwDN%2BDqRARvDrgJE%3D" alt="更新文档" loading="lazy"/></p>
<h3 data-id="heading-6">搜索文档</h3>
<pre><code class="hljs language-shell" lang="shell">http://h121.wzk.icu:9200/wzk_blog01/_doc/_search?pretty
</code></pre>
<p>返回结果如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"What"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>对应截图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7d140ab854c461cb88ef2d0b072b2aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072670&amp;x-signature=f50r8%2FywGAxbvC1HgwceNfn%2BJyM%3D" alt="搜索文档" loading="lazy"/></p>
<h2 data-id="heading-7">架构与概念</h2>
<h3 data-id="heading-8">基本简介</h3>
<p>Elasticsearch是一个面向文档（document oriented）的分布式搜索和分析引擎，这意味着它能够以文档为单位存储和管理数据。与传统的行式存储不同，Elasticsearch将每个数据实体作为一个完整的JSON文档进行处理和存储。例如，一个商品信息可以作为一个包含名称、价格、描述等字段的完整文档存储。</p>
<p>Elasticsearch的强大之处不仅在于存储文档，更在于它能对文档内容建立高效索引（Index）。它会自动分析文档中的每个字段，建立倒排索引等数据结构，实现近乎实时的搜索能力。比如，当用户搜索"智能手机"时，Elasticsearch可以快速返回所有包含该关键词的商品文档。</p>
<p>与关系型数据库相比，Elasticsearch有许多相似概念：</p>
<ul>
<li>索引（Index）相当于MySQL中的数据库</li>
<li>类型（Type，7.x版本后已移除）类似MySQL的表</li>
<li>文档（Document）对应MySQL中的行记录</li>
<li>字段（Field）则对应MySQL中的列</li>
</ul>
<p>例如，在电商系统中：</p>
<ul>
<li>可以创建一个名为"products"的索引</li>
<li>每个商品作为一个文档存储</li>
<li>文档包含title、price、category等字段</li>
</ul>
<p>Elasticsearch基于Apache Lucene构建，继承了其强大的全文检索能力，同时通过分布式架构解决了Lucene的单机限制。它支持复杂的查询功能，包括：</p>
<ol>
<li>精确匹配查询</li>
<li>范围查询</li>
<li>模糊搜索</li>
<li>聚合分析</li>
<li>地理位置查询等</li>
</ol>
<p>这使得Elasticsearch不仅适用于传统的搜索场景，也能很好地支持日志分析、商业智能等应用场景。</p>
<ul>
<li>索引（Index）：类似的数据放在一个索引，非类似的数据放不同索引，一个索引也可以理解成一个关系型数据</li>
<li>类型（type）：代表document属于index中的哪个类别（type）也有一种说法一种type就像是数据库的表，比如dept表，user表。需要注意的是，ES每个大版本之间差别很大。</li>
<li>映射（mapping）：mapping定义了每个字段的类型等信息，相当于关系型数据库中的表结构，常见的数据类型 text、keyword、number、array、range、boolean、date、geo_point、ip 等等类型</li>
</ul>
<p>Elasticsearch对比传统关系行数据库如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3721639085aa4388ad84400aca82b6f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072670&amp;x-signature=TPoV%2F1snBOJPU9tnrGm%2BjK9woC8%3D" alt="对比传统数据库和ES" loading="lazy"/></p>
<h3 data-id="heading-9">核心概念</h3>
<h4 data-id="heading-10">索引Index</h4>
<p>一个索引就是一个拥有几分相似特征的文档的集合，比如说，你可以有一个客户数据的索引，另一个产品目录的索引，还有一个订单数据的索引，一个索引由一个名字来标识（必须全部都是小写字母），并且当我们要对对应于这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用这个名字，在一个集群中，可以定义任意多的索引。</p>
<h4 data-id="heading-11">类型Type</h4>
<p>在一个索引中，你可以定义一种或多种类型，一个类型是你的索引的一个逻辑上的分类/分区，其语义完全由你来定。通常，会为具有一组共同字段的文档定义一个类型，比如说，我们假设你运营一个博客平台并且将你所有的数据存储到一个引擎中，在这个索引中，你可以为用户数据定义一个类型，为博客数据定义另一个类型，当然，也可以为评论数据定义另一个类型。当然，也可以为评论数据定义另一个类型。
高版本ES中逐渐抛弃了Type的概念，会有一个默认的 type:doc。</p>
<h4 data-id="heading-12">字段Field</h4>
<p>相当于是数据表的字段，对文档根据不同属性的进行的分类标识</p>
<h4 data-id="heading-13">映射mapping</h4>
<p>mapping是处理数据的方式和规则方面做一些限制，如某个字段的数据类型、默认值、分析器、是否被索引等等，这些都是映射里面可以设置的，其他就是处理ES里面数据的一些使用规则设置也叫映射，按着最优规则处理数据对性能提高很大，因为才需要建立映射，并且需要思考如何建立映射才能对性能更好。</p>
<h4 data-id="heading-14">文档 document</h4>
<p>一个文档是一个可被索引的基础信息单元。比如，你可以拥有某一个客户的文档，某一个产品的一个文档，当然，也可以拥有某个订单的一个文档。文档以JSON（JavaScript Object Notation）格式来表示，而JSON是一个到处存在的互联网数据交互格式。
在一个Index/type里面，你可以存储任意多的文档。注意，尽管一个文档，物理上存在一个索引之中，文档必须被索引/赋予一个索引的type。</p>
<h4 data-id="heading-15">近实时NRT</h4>
<p>Elasticsearch是一个接近实时的搜索平台，这意味着，这索引锁一个文档直到这个文档能够被搜索到有一个轻微的延迟（通常是1秒以内）</p>
<h4 data-id="heading-16">Cluster</h4>
<ul>
<li>集群（Cluster）一个Elasticsearch集群由多个节点（Node）组成，每个集群都有一个共同的集群名称作为标识。</li>
<li>节点（Node）：一个Elasticsearch实例就是一个Node，一台机器可以有多个实例，正常使用下每个实例都应该会部署在不同的机器上，Elasticsearch的配置文件中可以通过node.master node.data来设置节点类型</li>
<li>node.master 表示节点是否具有成为主节点的资格，true代表的有有资格竞选主节点，false代表的是没有资源竞选主节点</li>
<li>node.data 表示节点是否存储数据</li>
<li>Node节点组合：主节点+数据节点（Master+Data），即有成为主节点的资格，又存储数据</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">node.master: true
node.data: true
</code></pre>
<p>数据节点（data）：
节点没有成为主节点的资格，不参与选举，只会存储数据：</p>
<pre><code class="hljs language-shell" lang="shell">node.master: false
node.data: true
</code></pre>
<p>客户端节点（client）：
不会成为主节点，也不会存储数据，主要是针对海量请求的时候可以进行负载均衡：</p>
<pre><code class="hljs language-shell" lang="shell">node.master: false
node.data: false
</code></pre>
<ul>
<li>分片：每个索引由一个或者多个分片，每个分片存储不同的数据，分片可以主分片（primary shard）和复制分片（replica shard），复制分片是主分片的拷贝，默认每个主分片有一个复制分片，每个索引的复制分片的数量可以动态的调整，复制分片从不与它的主分片在同一个节点上。</li>
<li>副本：这里指主分片的副本分片（主分片的拷贝）。提高恢复能力，当主分片挂掉的时候，某个复制分片可以变成主分片。提高性能，get和search请求既可以由主分片又可以由复制分片处理</li>
</ul>
<p>注意：每个索引可以被分成多个分片，一个索引页可以被复制0次（意思是没有复制）或多次，一旦复制了，每个索引有了主分片（作为复制源的原来的分片）和复制分片（主分片的拷贝）之别。分片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态的改变复制的数量，但你事后不能改变分片的数量。
默认情况下，Elasticsearch中的每个索引被分片5个和1个复制，这意味着，如果你的集群中至少有两个节点，你的索引将会有5个主分片和另外5个复制分片（1个完全拷贝），这样的话每个索引总共10个分片。</p>
<h2 data-id="heading-17">错误速查</h2>







































































<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>?pertty 无效/报错</td><td>参数拼写错误</td><td>浏览器地址栏/日志</td><td>改为 ?pretty</td></tr><tr><td>创建索引无效</td><td>用了 GET 访问 /index</td><td>访问方式与返回码</td><td>改用 PUT /{index}?pretty</td></tr><tr><td>插入文档报 405/400</td><td>用 GET 发送 JSON</td><td>服务器日志/浏览器网络面板</td><td>用 POST/PUT /{index}/_doc/{id} 并放 JSON 到请求体</td></tr><tr><td>/{index}/_doc/_search/1 返回异常</td><td>端点写错</td><td>路径 404/400</td><td>按 ID 查：GET /{index}/_doc/{id}；搜索：POST /{index}/_search</td></tr><tr><td>搜索无结果</td><td>把查询 DSL 放到“返回结果”而非请求体</td><td>抓包/浏览器面板</td><td>将 DSL 放请求体，POST /_search</td></tr><tr><td>HTTP/HTTPS 混用或跨域</td><td>同域名下 http/https 混搭</td><td>状态码 301/SSL 错误</td><td>统一协议；若走浏览器，配置 CORS/反代</td></tr><tr><td>401/403 未授权</td><td>8.x 默认启用安全</td><td>返回码与 WWW-Authenticate</td><td>启用内置用户/API Key，或在内网/反代鉴权</td></tr><tr><td>index_not_found_exception</td><td>索引未创建/名错</td><td>Kibana//_cat/indices</td><td>先 PUT /{index} 再写入；核对小写命名</td></tr><tr><td>版本冲突 version_conflict_engine_exception</td><td>并发更新</td><td>返回体 _version</td><td>用 _update 或乐观锁带 if_seq_no/if_primary_term</td></tr><tr><td>集群 Red/分片分配失败</td><td>分片/磁盘问题</td><td>/_cluster/health、/_cat/shards</td><td>释放磁盘、修复分片、调整副本数</td></tr></tbody></table>
<h2 data-id="heading-18">其他系列</h2>
<h3 data-id="heading-19">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-127 Qwen2.5-Omni 深解：Thinker-Talker 双核、TMRoPE 与流式语音</strong></p>
<h3 data-id="heading-20">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-174 FastFDS 从单机到分布式文件存储：实战与架构取舍</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 正在更新，深入浅出助你打牢基础！</p>
<h3 data-id="heading-21">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python开发者必看：5个被低估但能提升200%编码效率的冷门库实战]]></title>    <link>https://juejin.cn/post/7577690150093013032</link>    <guid>https://juejin.cn/post/7577690150093013032</guid>    <pubDate>2025-11-30T00:17:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093013032" data-draft-id="7577713754562887732" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python开发者必看：5个被低估但能提升200%编码效率的冷门库实战"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-30T00:17:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python开发者必看：5个被低估但能提升200%编码效率的冷门库实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T00:17:48.000Z" title="Sun Nov 30 2025 00:17:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python开发者必看：5个被低估但能提升200%编码效率的冷门库实战</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>Python生态系统的丰富性是其最大的优势之一，但也正因如此，许多高效但冷门的库往往被淹没在PyPI的海洋中。大多数开发者熟悉<code>requests</code>、<code>numpy</code>或<code>pandas</code>这样的明星库，却忽略了那些小而美的工具，它们能在特定场景下显著提升开发效率。本文将深入探讨5个被严重低估的Python库，并通过实战演示如何利用它们将编码效率提升200%。这些库不仅功能强大，而且设计优雅，值得每一位Python开发者将其纳入工具箱。</p>
<hr/>
<h3 data-id="heading-2">1. <strong>Loguru：告别繁琐的日志配置</strong></h3>
<h4 data-id="heading-3">为什么选择Loguru？</h4>
<p>Python标准库的<code>logging</code>模块虽然强大，但配置复杂且冗长。<code>Loguru</code>通过极简API和开箱即用的功能重新定义了日志记录。</p>
<h4 data-id="heading-4">核心优势：</h4>
<ul>
<li><strong>零配置启动</strong>：无需定义Handler、Formatter或Filter。</li>
<li><strong>更友好的语法</strong>：直接通过<code>logger.info()</code>调用，支持字符串格式化与结构化日志。</li>
<li><strong>强大的文件管理</strong>：自动轮转、压缩和清理旧日志文件。</li>
</ul>
<h4 data-id="heading-5">实战示例：</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> loguru <span class="hljs-keyword">import</span> logger

logger.add(<span class="hljs-string">"app.log"</span>, rotation=<span class="hljs-string">"100 MB"</span>)  <span class="hljs-comment"># 自动轮转日志文件</span>
logger.debug(<span class="hljs-string">"This is a debug message"</span>)
logger.error(<span class="hljs-string">"An error occurred: {}"</span>, ValueError(<span class="hljs-string">"Something went wrong"</span>))
</code></pre>
<h4 data-id="heading-6">性能对比：</h4>
<p>相比标准库的20行配置代码，Loguru仅需2行即可实现相同功能，节省90%的时间。</p>
<hr/>
<h3 data-id="heading-7">2. <strong>Rich：终端输出的终极美化工具</strong></h3>
<h4 data-id="heading-8">为什么选择Rich？</h4>
<p>命令行工具的默认输出单调乏味？<code>Rich</code>可以为其添加颜色、表格、进度条甚至Markdown渲染支持。</p>
<h4 data-id="heading-9">核心功能：</h4>
<ul>
<li><strong>语法高亮</strong>：自动识别代码、JSON或XML。</li>
<li><strong>动态表格</strong>：支持实时更新的表格数据展示。</li>
<li><strong>进度条集成</strong>：内置多任务进度条（比<code>tqdm</code>更灵活）。</li>
</ul>
<h4 data-id="heading-10">实战示例：</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> rich.console <span class="hljs-keyword">import</span> Console
<span class="hljs-keyword">from</span> rich.table <span class="hljs-keyword">import</span> Table

console = Console()
table = Table(title=<span class="hljs-string">"Star Wars Characters"</span>)
table.add_column(<span class="hljs-string">"Name"</span>, style=<span class="hljs-string">"cyan"</span>)
table.add_column(<span class="hljs-string">"Role"</span>, style=<span class="hljs-string">"magenta"</span>)
table.add_row(<span class="hljs-string">"Luke Skywalker"</span>, <span class="hljs-string">"Jedi Knight"</span>)

console.<span class="hljs-built_in">print</span>(table)
</code></pre>
<h4 data-id="heading-11">效果对比：</h4>
<p>普通终端输出 vs Rich的多彩表格——后者可提升调试和数据分析时的可视化效率至少50%。</p>
<hr/>
<h3 data-id="heading-12">3. <strong>FastAPI-Cache：API性能的隐形加速器</strong></h3>
<h4 data-id="heading-13">为什么选择FastAPI-Cache？</h4>
<p>即使使用FastAPI这样的高性能框架，重复计算或数据库查询仍是性能瓶颈。此库为FastAPI提供无缝缓存支持。</p>
<h4 data-id="heading-14">核心特性：</h4>
<ul>
<li><strong>装饰器驱动</strong>：通过简单注解缓存路由响应（支持Redis/Memcached）。</li>
<li><strong>细粒度控制</strong>：可按请求参数、HTTP方法等定制缓存策略。</li>
<li><strong>自动失效</strong>：支持基于时间或事件的缓存清除。</li>
</ul>
<h4 data-id="heading-15">实战示例：</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> fastapi_cache <span class="hljs-keyword">import</span> FastAPICache
<span class="hljs-keyword">from</span> fastapi_cache.backends.redis <span class="hljs-keyword">import</span> RedisBackend

app = FastAPI()
FastAPICache.init(RedisBackend(<span class="hljs-string">"redis://localhost"</span>))

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items/{item_id}"</span></span>)</span>
<span class="hljs-meta">@cache(<span class="hljs-params">expire=<span class="hljs-number">60</span></span>)  </span><span class="hljs-comment"># 缓存60秒</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"item"</span>: expensive_db_query(item_id)}
</code></pre>
<h4 data-id="heading-16">Benchmark结果：</h4>
<p>对于读多写少的接口，QPS可从100提升至5000+（依赖后端存储）。</p>
<hr/>
<h3 data-id="heading-17">4. <strong>Pydantic + TypeGuard ：运行时类型安全的双保险</strong></h3>
<h4 data-id="heading-18">为什么需要它？</h4>
<p>虽然Pydantic能验证输入数据，但在复杂业务逻辑中仍需确保变量类型符合预期。TypeGuard填补了这一空白。</p>
<h4 data-id="heading-19">协同工作流：</h4>
<ol>
<li>Pydantic校验外部输入（如API请求）。</li>
<li>TypeGuard校验内部函数参数和返回值（替代assert）。</li>
</ol>
<h4 data-id="heading-20">实战示例：</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typeguard <span class="hljs-keyword">import</span> typechecked
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span>
    name: <span class="hljs-built_in">str</span>

<span class="hljs-meta">@typechecked</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_user</span>(<span class="hljs-params">user: User</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Processing <span class="hljs-subst">{user.name}</span>"</span>

<span class="hljs-comment"># TypeError会在调用时立即触发（而非运行时才崩溃）</span>
process_user(User(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>, name=<span class="hljs-string">"Alice"</span>)) 
</code></pre>
<h4 data-id="heading-21">TypeScript启示录：</h4>
<p>这一组合让Python接近TypeScript的开发体验——静态类型检查+运行时保障。</p>
<hr/>
<p>###5.<strong>Dependency Injector ：告别Spaghetti Code的秘密武器</strong></p>
<p>#####问题背景：
随着项目规模增长,手动管理依赖关系会导致:
-高度耦合的代码(修改一个类需改动多处)
-难以模拟测试依赖项</p>
<p>#####解决方案：
Dependency Injector借鉴Java Spring的理念,提供:
-明确的依赖声明(非硬编码实例化)
-生命周期管理(单例/线程局部等)</p>
<p>#####工厂模式实战：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dependency_injector <span class="hljs-keyword">import</span> containers, providers 

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Service</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, api_key: <span class="hljs-built_in">str</span></span>): ...

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Container</span>(containers.DeclarativeContainer): 
    config = providers.Configuration() 
    service = providers.Singleton(
        Service,
        api_key=config.api_key 
    )

container = Container() 
container.config.api_key.from_env(<span class="hljs-string">"API_KEY"</span>) 

<span class="hljs-comment">#任何位置获取实例(而非全局变量)</span>
service = container.service()
</code></pre>
<p>#####架构收益：
-组件间解耦度提升70%(根据代码复杂度工具测量)
-单元测试速度提高3倍(因依赖替换更容易)</p>
<hr/>
<p>###总结</p>
<p>这五个库分别针对日志记录(Rich)、终端交互(FastAPI-Cache)、类型安全(Pydantic+TypeGuard)和架构设计(Dependency Injector)等关键领域提供了优雅解决方案。</p>
<p>它们的共同特点是：</p>
<p>1.<strong>专注解决单一痛点</strong>
不像全能型框架试图覆盖所有场景,这些库深耕垂直领域。</p>
<p>2.<strong>极低的学习曲线</strong>
平均每个库只需30分钟即可投入生产环境使用。</p>
<p>3.<strong>社区活跃度上升趋势</strong>
2023年PyPI下载量同比增长均超过100%。</p>
<p>建议读者选择一个最匹配当前痛点的库进行试点——你会发现那些重复性工作正在以肉眼可见的速度消失</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（155）Redis的数据持久化如何优化？]]></title>    <link>https://juejin.cn/post/7577702891273322531</link>    <guid>https://juejin.cn/post/7577702891273322531</guid>    <pubDate>2025-11-30T00:47:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273322531" data-draft-id="7577683422878318626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（155）Redis的数据持久化如何优化？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T00:47:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（155）Redis的数据持久化如何优化？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T00:47:52.000Z" title="Sun Nov 30 2025 00:47:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis的数据持久化是确保数据在意外宕机或重启后仍能恢复的重要机制。Redis主要提供两种持久化方式：RDB（Redis Database File）和AOF（Append-Only File）。要优化Redis的数据持久化，需考虑持久化策略的选择、配置参数的调整以及性能与数据一致性的平衡。以下是详细的优化策略和相关代码示例。</p>
<h3 data-id="heading-0">1. RDB 持久化优化</h3>
<p>RDB通过生成内存快照来保存数据。可以通过配置文件中的参数调整快照频率和性能。</p>
<h4 data-id="heading-1">配置示例</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置文件 redis.conf 中的 RDB 配置示例</span>

<span class="hljs-comment"># 配置快照保存条件，可以根据业务需求调整</span>
save 900 1  <span class="hljs-comment"># 900秒内如果有至少1次写操作，生成快照</span>
save 300 10 <span class="hljs-comment"># 300秒内如果有至少10次写操作，生成快照</span>
save 60 10000 <span class="hljs-comment"># 60秒内如果有至少10000次写操作，生成快照</span>

<span class="hljs-comment"># RDB文件名</span>
dbfilename dump.rdb

<span class="hljs-comment"># 文件存放目录</span>
<span class="hljs-built_in">dir</span> /var/lib/redis
</code></pre>
<h4 data-id="heading-2">优化建议</h4>
<ol>
<li>
<p><strong>调整快照频率</strong>：根据应用的写操作频率和数据重要性，调整RDB快照生成的条件。减少频率可以降低持久化对性能的影响，但可能会丢失更多数据。</p>
</li>
<li>
<p><strong>SSD存储</strong>：使用SSD存储RDB文件，可以提高读写性能。</p>
</li>
<li>
<p><strong>后台生成快照</strong>：确保RDB快照生成在后台进行（默认是后台执行），避免阻塞主线程。</p>
</li>
</ol>
<h4 data-id="heading-3">RDB代码示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisRDBSnapshot</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发RDB快照</span>
            jedis.save();
        }
    }
}
</code></pre>
<h3 data-id="heading-4">2. AOF 持久化优化</h3>
<p>AOF通过记录每个写操作来保存数据，可以实现更高的数据一致性。可以通过配置文件中的参数调整同步频率和文件重写策略。</p>
<h4 data-id="heading-5">配置示例</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置文件 redis.conf 中的 AOF 配置示例</span>

<span class="hljs-comment"># 开启AOF持久化</span>
appendonly <span class="hljs-built_in">yes</span>

<span class="hljs-comment"># AOF文件名</span>
appendfilename <span class="hljs-string">"appendonly.aof"</span>

<span class="hljs-comment"># AOF同步策略：always, everysec, no</span>
appendfsync everysec  <span class="hljs-comment"># 每秒同步一次AOF文件</span>

<span class="hljs-comment"># 文件存放目录</span>
<span class="hljs-built_in">dir</span> /var/lib/redis

<span class="hljs-comment"># AOF重写策略</span>
auto-aof-rewrite-percentage 100  <span class="hljs-comment"># 当AOF文件增长到上次重写后的100%时，触发重写</span>
auto-aof-rewrite-min-size 64mb   <span class="hljs-comment"># AOF文件最小达到64MB时，触发重写</span>
</code></pre>
<h4 data-id="heading-6">优化建议</h4>
<ol>
<li>
<p><strong>同步策略</strong>：</p>
<ul>
<li><code>always</code>：每次写操作都同步，最安全但性能最差。</li>
<li><code>everysec</code>：每秒同步一次，性能和数据安全的平衡。</li>
<li><code>no</code>：操作系统决定何时同步，性能最好但可能会丢失数据。</li>
</ul>
</li>
<li>
<p><strong>AOF重写</strong>：定期重写AOF文件以减少文件大小。可以通过<code>auto-aof-rewrite-percentage</code>和<code>auto-aof-rewrite-min-size</code>参数进行配置。</p>
</li>
<li>
<p><strong>混合持久化</strong>：Redis 4.0及以上版本支持RDB+AOF混合持久化，可以获得两者的优势。</p>
</li>
</ol>
<h4 data-id="heading-7">AOF代码示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisAOFRewrite</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发AOF重写</span>
            jedis.bgrewriteaof();
        }
    }
}
</code></pre>
<h3 data-id="heading-8">3. 混合持久化</h3>
<p>混合持久化结合了RDB和AOF的优点，快速恢复数据的一致性。</p>
<h4 data-id="heading-9">配置示例</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置文件 redis.conf 中的混合持久化配置示例</span>

<span class="hljs-comment"># 开启混合持久化</span>
aof-use-rdb-preamble <span class="hljs-built_in">yes</span>
</code></pre>
<h3 data-id="heading-10">4. 持久化性能优化</h3>
<h4 data-id="heading-11">内存优化</h4>
<p>Redis本身是内存数据库，持久化时会占用内存。可以通过调整内存配置来优化性能。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置文件 redis.conf 中的内存优化示例</span>

<span class="hljs-comment"># 最大内存使用限制</span>
maxmemory 2gb

<span class="hljs-comment"># 内存回收策略：volatile-lru, allkeys-lru, volatile-random, allkeys-random, volatile-ttl, noeviction</span>
maxmemory-policy allkeys-lru
</code></pre>
<h4 data-id="heading-12">多线程I/O</h4>
<p>Redis 6.0及以上版本支持多线程I/O，可以提高持久化性能。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置文件 redis.conf 中的多线程I/O示例</span>

<span class="hljs-comment"># 开启多线程I/O</span>
io-threads 4

<span class="hljs-comment"># 只有在客户端数量超过 io-threads-do-reads 参数设置的值时才使用多线程I/O（0表示始终开启多线程I/O）</span>
io-threads-do-reads <span class="hljs-built_in">yes</span>
</code></pre>
<h3 data-id="heading-13">5. 示例代码</h3>
<p>综合上述优化策略，可以使用以下代码来实现Redis持久化优化。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisPersistenceOptimization</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发RDB快照</span>
            jedis.save();

            <span class="hljs-comment">// 手动触发AOF重写</span>
            jedis.bgrewriteaof();

            <span class="hljs-comment">// 设置键值对</span>
            jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
            System.out.println(<span class="hljs-string">"Value for 'key': "</span> + jedis.get(<span class="hljs-string">"key"</span>));

            <span class="hljs-comment">// 配置混合持久化</span>
            jedis.configSet(<span class="hljs-string">"aof-use-rdb-preamble"</span>, <span class="hljs-string">"yes"</span>);

            <span class="hljs-comment">// 配置多线程I/O</span>
            jedis.configSet(<span class="hljs-string">"io-threads"</span>, <span class="hljs-string">"4"</span>);
            jedis.configSet(<span class="hljs-string">"io-threads-do-reads"</span>, <span class="hljs-string">"yes"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-14">总结</h3>
<p>通过调整RDB和AOF的配置参数、使用SSD存储、合理设置同步策略、定期重写AOF文件，以及利用多线程I/O，可以显著优化Redis的数据持久化性能。选择适合的持久化策略和优化方法，能够在保证数据一致性的同时最大化Redis的性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（154）Redis的数据一致性如何保证？]]></title>    <link>https://juejin.cn/post/7577683422878302242</link>    <guid>https://juejin.cn/post/7577683422878302242</guid>    <pubDate>2025-11-30T00:47:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577683422878302242" data-draft-id="7577713754562936884" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（154）Redis的数据一致性如何保证？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T00:47:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（154）Redis的数据一致性如何保证？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T00:47:06.000Z" title="Sun Nov 30 2025 00:47:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>保证Redis数据一致性是确保系统稳定性和正确性的重要方面。Redis提供了多种机制来确保数据的一致性，包括持久化（RDB和AOF）、主从复制、事务（Transactions）和哨兵（Sentinel）等。以下是详细的解释和代码示例：</p>
<h3 data-id="heading-0">1. 持久化机制</h3>
<h4 data-id="heading-1">1.1 RDB (Redis Database File)</h4>
<p>RDB通过定期生成内存快照来保存数据。RDB是一个紧凑的二进制文件，适合用于备份和恢复。</p>
<p><strong>RDB配置示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置文件 redis.conf 中的 RDB 持久化配置示例</span>
save 900 1  <span class="hljs-comment"># 如果900秒内至少有1个key发生变化，则保存快照</span>
save 300 10 <span class="hljs-comment"># 如果300秒内至少有10个key发生变化，则保存快照</span>
save 60 10000 <span class="hljs-comment"># 如果60秒内至少有10000个key发生变化，则保存快照</span>
dbfilename dump.rdb  <span class="hljs-comment"># RDB文件名</span>
<span class="hljs-built_in">dir</span> /var/lib/redis  <span class="hljs-comment"># RDB文件存放目录</span>
</code></pre>
<p><strong>手动触发RDB快照</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisRDBSnapshot</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发RDB快照</span>
            jedis.save();
        }
    }
}
</code></pre>
<h4 data-id="heading-2">1.2 AOF (Append-Only File)</h4>
<p>AOF通过记录每个写操作来保存数据。AOF文件是一个日志文件，适合用于实现更高的数据一致性。</p>
<p><strong>AOF配置示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置文件 redis.conf 中的 AOF 持久化配置示例</span>
appendonly <span class="hljs-built_in">yes</span>  <span class="hljs-comment"># 开启AOF</span>
appendfilename <span class="hljs-string">"appendonly.aof"</span>  <span class="hljs-comment"># AOF文件名</span>
appendfsync everysec  <span class="hljs-comment"># 每秒同步一次AOF文件，提供性能和一致性的平衡</span>
<span class="hljs-built_in">dir</span> /var/lib/redis  <span class="hljs-comment"># AOF文件存放目录</span>
</code></pre>
<p><strong>手动触发AOF重写</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisAOFRewrite</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 手动触发AOF重写</span>
            jedis.bgrewriteaof();
        }
    }
}
</code></pre>
<h3 data-id="heading-3">2. 主从复制</h3>
<p>主从复制确保数据在多个Redis实例之间的一致性。主节点负责处理写操作，从节点负责复制主节点的数据。</p>
<p><strong>主从复制配置示例</strong>：</p>
<p><strong>主节点配置（master）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># master 配置文件</span>
port 6379
</code></pre>
<p><strong>从节点配置（slave）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># slave 配置文件</span>
port 6380
replicaof 127.0.0.1 6379  <span class="hljs-comment"># 指定主节点的IP和端口</span>
</code></pre>
<p><strong>Java代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisMasterSlaveSetup</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 配置主节点</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">master</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            master.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
        }

        <span class="hljs-comment">// 配置从节点</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">slave</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6380</span>)) {
            slave.slaveof(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>);
            System.out.println(<span class="hljs-string">"Slave value for 'key': "</span> + slave.get(<span class="hljs-string">"key"</span>));
        }
    }
}
</code></pre>
<h3 data-id="heading-4">3. 事务（Transactions）</h3>
<p>Redis事务通过<code>MULTI</code>、<code>EXEC</code>、<code>DISCARD</code>和<code>WATCH</code>命令实现。事务可以确保一组操作的原子性。</p>
<p><strong>事务示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTransactionExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 开始事务</span>
            <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> jedis.multi();
            
            <span class="hljs-comment">// 执行一组命令</span>
            transaction.set(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);
            transaction.set(<span class="hljs-string">"key2"</span>, <span class="hljs-string">"value2"</span>);
            
            <span class="hljs-comment">// 提交事务</span>
            transaction.exec();
        }
    }
}
</code></pre>
<h3 data-id="heading-5">4. 哨兵（Sentinel）</h3>
<p>Redis Sentinel用于实现高可用性，监控主从复制并自动进行故障转移。</p>
<p><strong>哨兵配置示例</strong>：</p>
<p><strong>哨兵配置文件 sentinel.conf</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
sentinel parallel-syncs mymaster 1
</code></pre>
<p><strong>启动哨兵</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">redis-sentinel /path/to/sentinel.conf
</code></pre>
<p><strong>Java代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.JedisSentinelPool;

<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisSentinelExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Set&lt;String&gt; sentinels = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        sentinels.add(<span class="hljs-string">"localhost:26379"</span>);
        
        <span class="hljs-keyword">try</span> (<span class="hljs-type">JedisSentinelPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisSentinelPool</span>(<span class="hljs-string">"mymaster"</span>, sentinels)) {
            <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> pool.getResource()) {
                jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
                System.out.println(<span class="hljs-string">"Value for 'key': "</span> + jedis.get(<span class="hljs-string">"key"</span>));
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-6">总结</h3>
<p>通过RDB和AOF持久化、主从复制、事务以及哨兵机制，Redis可以在不同层面上保证数据的一致性和高可用性。结合具体需求和使用场景，可以选择最适合的机制来保障Redis数据的一致性。上述代码示例展示了如何通过Java代码结合Jedis库来实现这些特性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎨 用一次就爱上的图标定制体验：CustomIcons 实战]]></title>    <link>https://juejin.cn/post/7577722399375212586</link>    <guid>https://juejin.cn/post/7577722399375212586</guid>    <pubDate>2025-11-29T14:31:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577722399375212586" data-draft-id="7577574644695793700" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎨 用一次就爱上的图标定制体验：CustomIcons 实战"/> <meta itemprop="keywords" content="前端,Icon,React.js"/> <meta itemprop="datePublished" content="2025-11-29T14:31:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨夜寻晴天"/> <meta itemprop="url" content="https://juejin.cn/user/1943592288391496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎨 用一次就爱上的图标定制体验：CustomIcons 实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592288391496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨夜寻晴天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T14:31:34.000Z" title="Sat Nov 29 2025 14:31:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在前端项目里，图标不是“点缀”，它往往是信息结构与互动线索的关键。如何让图标既统一又可配、既美观又可国际化？这篇文章带你用 <code>@infinilabs/custom-icons</code> 打造一套“可配置、可主题、可国际化”的图标解决方案。</p>
</blockquote>
<h2 data-id="heading-0">背景</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Finfinilabs%2Fcoco-app" target="_blank" title="https://github.com/infinilabs/coco-app" ref="nofollow noopener noreferrer">Coco AI</a>(开源) 用户需要可以配置自定义 Icon。</li>
<li>多品牌与多区域：同一产品在不同客户、不同区域需要差异化的风格与语言。</li>
<li>设计与工程协作：设计希望图标统一；工程需要灵活调整尺寸、颜色、类型、甚至自定义图片。</li>
<li>运营与配置：希望在管理面板里直接挑选或调整图标，而不是改代码、发版本。</li>
</ul>
<p>于是，我做了一个轻量、直观、开箱即用的组件库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40infinilabs%2Fcustom-icons" target="_blank" title="https://www.npmjs.com/package/@infinilabs/custom-icons" ref="nofollow noopener noreferrer"><code>@infinilabs/custom-icons</code></a>。</p>
<h2 data-id="heading-1">适用场景</h2>
<ul>
<li>可视化配置台：在后台面板中为功能、菜单或模块选择与配置图标。</li>
<li>多主题产品：快速切换深色/浅色主题，保证图标在不同背景下的对比度与风格。</li>
<li>国际化应用：在不同语言环境下自动切换文案与控件标签。</li>
<li>自定义品牌：支持上传自定义图片作为图标，满足品牌个性化需求。</li>
</ul>
<h2 data-id="heading-2">主要能力</h2>
<ul>
<li>图标渲染组件：<code>ConfigurableIcon</code>
<ul>
<li>指定类型（如 <code>lucide</code>）、图标名、颜色与尺寸即可渲染。</li>
<li>支持数据 URL（自定义图片）模式。</li>
</ul>
</li>
<li>图标选择器：<code>IconPicker</code>
<ul>
<li>一站式选择与配置：类型、名称、尺寸、颜色与图片上传。</li>
<li>可选主题与国际化支持。</li>
<li>可通过 <code>controls</code> 精细开关各子控件。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">快速开始</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用你熟悉的包管理器安装</span>
pnpm add @infinilabs/custom-icons
<span class="hljs-comment"># 或</span>
npm i @infinilabs/custom-icons
<span class="hljs-comment"># 或</span>
yarn add @infinilabs/custom-icons
</code></pre>
<p>在项目中引用：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigurableIcon</span>, <span class="hljs-title class_">IconPicker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@infinilabs/custom-icons"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [config, setConfig] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">"lucide"</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Bot"</span>,
    <span class="hljs-attr">size</span>: <span class="hljs-number">28</span>,
    <span class="hljs-attr">color</span>: <span class="hljs-string">"#1e90ff"</span>,
    <span class="hljs-attr">dataUrl</span>: <span class="hljs-literal">undefined</span>,
  });

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">24</span> }}&gt;</span>
      {/* 渲染当前配置的图标 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">ConfigurableIcon</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">{config.type}</span>
        <span class="hljs-attr">name</span>=<span class="hljs-string">{config.name}</span>
        <span class="hljs-attr">size</span>=<span class="hljs-string">{config.size}</span>
        <span class="hljs-attr">color</span>=<span class="hljs-string">{config.color}</span>
        <span class="hljs-attr">dataUrl</span>=<span class="hljs-string">{config.dataUrl}</span>
      /&gt;</span>

      {/* 交互式选择与配置 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">IconPicker</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{config}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{setConfig}</span>
        <span class="hljs-attr">configurable</span>
        <span class="hljs-attr">theme</span>=<span class="hljs-string">"light"</span>
        <span class="hljs-attr">locale</span>=<span class="hljs-string">"zh-CN"</span>
        <span class="hljs-attr">controls</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">type:</span> <span class="hljs-attr">true</span>,
          <span class="hljs-attr">name:</span> <span class="hljs-attr">true</span>,
          <span class="hljs-attr">size:</span> <span class="hljs-attr">true</span>,
          <span class="hljs-attr">color:</span> <span class="hljs-attr">true</span>,
          <span class="hljs-attr">image:</span> <span class="hljs-attr">true</span>,
        }}
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>如果你需要查看可选的 <code>Lucide</code> 图标名称，选择器旁已内置快捷链接：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flucide.dev%2Ficons%2F" target="_blank" title="https://lucide.dev/icons/" ref="nofollow noopener noreferrer">lucide.dev/icons/</a></li>
</ul>
<h2 data-id="heading-4">基础效果</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1ce2c691a2f42378b1225226f89d517~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5aSc5a-75pm05aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765031701&amp;x-signature=iEKLg6Q4SWN%2BLD2esTQ2ZyanGCA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">组件详解</h2>
<h3 data-id="heading-6">ConfigurableIcon</h3>
<p>用于在任意位置渲染一个图标。</p>
<ul>
<li>关键属性
<ul>
<li><code>type</code>: 图标类型（如 <code>lucide</code> 或自定义）</li>
<li><code>name</code>: 图标名称（<code>type=lucide</code> 时为 Lucide 名称）</li>
<li><code>size</code>: 数值尺寸（px）</li>
<li><code>color</code>: 颜色（十六进制或 CSS 颜色）</li>
<li><code>dataUrl</code>: 当使用自定义图片时的 <code>data:</code> URL</li>
</ul>
</li>
</ul>
<p>示例（自定义图片）：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">ConfigurableIcon</span>
  <span class="hljs-keyword">type</span>=<span class="hljs-string">"custom"</span>
  name=<span class="hljs-string">"my-logo"</span>
  dataUrl=<span class="hljs-string">"data:image/png;base64,...."</span>
  size={<span class="hljs-number">28</span>}
  color=<span class="hljs-string">"#1e90ff"</span> <span class="hljs-comment">// 自定义图片时通常忽略颜色</span>
/&gt;
</code></pre>
<h3 data-id="heading-7">IconPicker</h3>
<p>一个将预览与配置控件整合在一起的选择器。可插在设置面板或表单中，让用户自行挑选或上传。</p>
<ul>
<li>
<p>常用属性</p>
<ul>
<li><code>value</code>: 当前图标配置对象</li>
<li><code>onChange(next)</code>: 配置变化回调</li>
<li><code>configurable</code>: 是否展示配置面板</li>
<li><code>controls</code>: 控件开关集合（<code>type/name/size/color/image</code> 等）</li>
<li><code>theme</code>: <code>light | dark</code></li>
<li><code>locale</code>: <code>zh-CN | en-US</code></li>
<li><code>i18n</code>: 文案对象（可覆盖默认文案）</li>
</ul>
</li>
<li>
<p>控件开关示例</p>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">IconPicker</span>
  value={config}
  onChange={setConfig}
  configurable
  controls={{
    <span class="hljs-attr">type</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">size</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">color</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">image</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 打开即出现上传控件</span>
  }}
/&gt;
</code></pre>
<ul>
<li>主题与国际化</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">IconPicker</span>
  value={config}
  onChange={setConfig}
  configurable
  theme=<span class="hljs-string">"dark"</span>
  locale=<span class="hljs-string">"en-US"</span>
/&gt;
</code></pre>
<h2 data-id="heading-8">进阶示例：面板内批量配置</h2>
<p>将多个图标配置成一组，供菜单或卡片模块统一管理：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">IconsPanel</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [items, setItems] = <span class="hljs-title function_">useState</span>([
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">config</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"lucide"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Home"</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"#444"</span> } },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">config</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"lucide"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Settings"</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"#444"</span> } },
  ]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateItem</span> = (<span class="hljs-params">id, next</span>) =&gt;
    <span class="hljs-title function_">setItems</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span>
      prev.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">it</span>) =&gt;</span> (it.<span class="hljs-property">id</span> === id ? { ...it, <span class="hljs-attr">config</span>: next } : it))
    );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> "<span class="hljs-attr">grid</span>", <span class="hljs-attr">gap:</span> <span class="hljs-attr">16</span> }}&gt;</span>
      {items.map((it) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{it.id}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">12</span>, <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">eee</span>", <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">8</span> }}&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ConfigurableIcon</span> {<span class="hljs-attr">...it.config</span>} /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">IconPicker</span>
            <span class="hljs-attr">value</span>=<span class="hljs-string">{it.config}</span>
            <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(next)</span> =&gt;</span> updateItem(it.id, next)}
            configurable
            theme="light"
            locale="zh-CN"
            controls={{ type: true, name: true, size: true, color: true, image: false }}
          /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-9">设计与工程协作建议</h2>
<ul>
<li>设计提供命名规范：例如统一使用 Lucide 的图标名集合，避免随意命名。</li>
<li>管理面板适配：通过 <code>controls</code> 开关不同角色看到的控件（运营只改颜色与大小、开发可修改类型与名称）。</li>
<li>主题变量托管：将颜色与尺寸作为“设计令牌”，统一管理与回收。</li>
</ul>
<h2 data-id="heading-10">常见问题</h2>
<ul>
<li>自定义图片会应用颜色吗？
<ul>
<li>通常不会；颜色更适用于矢量图标。自定义图片由图片本身决定视觉。</li>
</ul>
</li>
<li>如何选择 Lucide 图标名？
<ul>
<li>打开 <code>https://lucide.dev/icons/</code>，在选择器里输入对应名称即可。</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/529fdc7ae7c048ceb579526842c9ab7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5aSc5a-75pm05aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765031701&amp;x-signature=N1huXI%2FMzC9%2BA8WyLPjGOtCbcxU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">小结</h2>
<p><code>@infinilabs/custom-icons</code> 让“图标即配置”的能力落地：从主题与国际化，到自定义图片与统一风格，既能保证设计一致性，又给予业务足够自由度。把它接入你的管理面板或设置页，让图标成为产品的强大表达力，而不是维护负担。</p>
<p>如果你对更多场景（如基于角色的控件可见性、图标库扩展）有想法，欢迎继续交流与共建！</p>
<p>开源共建：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Finfinilabs%2Fui-common" target="_blank" title="https://github.com/infinilabs/ui-common" ref="nofollow noopener noreferrer">github.com/infinilabs/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅谈C++与C语言二进制文件差异(从一次链接错误说起)]]></title>    <link>https://juejin.cn/post/7577705544874917926</link>    <guid>https://juejin.cn/post/7577705544874917926</guid>    <pubDate>2025-11-29T14:53:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544874917926" data-draft-id="7577718777481429030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅谈C++与C语言二进制文件差异(从一次链接错误说起)"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T14:53:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅谈C++与C语言二进制文件差异(从一次链接错误说起)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T14:53:25.000Z" title="Sat Nov 29 2025 14:53:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>"undefined reference to `func' "，这个看似简单的链接错误背后，隐藏着C与C++二进制文件的根本差异。很多开发者认为C++只是"C with Classes"，却不知这对"亲密兄弟"在二进制层面早已分道扬镳。</p>
<p>在软件开发的演进历程中，C++作为C语言的延伸，始终保持着高度的语法兼容性。这种表面上的相似性却掩盖了两者在编译产物层面的深刻差异。本文将从二进制文件的视角，深入剖析C++与C语言在目标代码生成机制上的本质区别，揭示面向对象、泛型编程等高级特性在机器层面的实现代价。</p>
<h2 data-id="heading-0">一、名称修饰：函数标识的编码革命</h2>
<h3 data-id="heading-1">1.1 C语言的朴素命名策略</h3>
<p>C语言采用极为简单的名称修饰方案。由于不支持函数重载，编译器只需在符号表中维护函数名的原始标识。例如函数<code>void calculate(int value)</code>在目标文件中通常保存为<code>calculate</code>或<code>_calculate</code>（某些平台添加下划线前缀）。这种简约主义使得链接过程直接明了，但同时也限制了语言的表达能力。</p>
<h3 data-id="heading-2">1.2 C++的命名迷宫</h3>
<p>为支持函数重载这一核心特性，C++引入了复杂的名称修饰机制。编译器将函数名、参数类型、类域、命名空间等信息编码为内部符号，形成唯一的链接标识。比较以下重载函数：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">namespace</span> Geometry {
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Vector</span> {
    <span class="hljs-keyword">public</span>:
        <span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">magnitude</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
        <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">float</span> <span class="hljs-title">magnitude</span><span class="hljs-params">(<span class="hljs-type">const</span> Vector&amp; v)</span></span>;
    };
}

<span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">compute</span><span class="hljs-params">(<span class="hljs-type">float</span> value)</span></span>;
<span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">compute</span><span class="hljs-params">(<span class="hljs-type">double</span> value, <span class="hljs-type">int</span> precision)</span></span>;
</code></pre>
<p>上述函数可能被修饰为：</p>
<ul>
<li><code>_ZN8Geometry6Vector9magnitudeEv</code> (成员函数)</li>
<li><code>_ZN8Geometry6Vector9magnitudeERKS0_</code> (静态成员函数)</li>
<li><code>_Z7computef</code> (参数为float)</li>
<li><code>_Z7computedf</code> (参数为double和int)</li>
</ul>
<p>这种编码确保了符号的唯一性，但也带来了显著的工程影响。实践中，C++与C的互操作必须通过<code>extern "C"</code>链接指示符：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> {
    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"legacy_c_library.h"</span></span>
}
</code></pre>
<p>该指令强制C++编译器采用C风格的名称修饰，确保符号在链接时的正确解析。</p>
<h2 data-id="heading-3">二、面向对象机制的二进制实现</h2>
<h3 data-id="heading-4">2.1 内存布局与this指针传递</h3>
<p>C++类的非静态成员变量在内存中的布局与C结构体高度相似——顺序存储，字节对齐。然而成员函数的实现却截然不同：它们作为普通函数存在于代码段，通过隐式的<code>this</code>指针访问对象数据。</p>
<p>考虑以下成员函数调用：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Widget</span> {
    <span class="hljs-type">int</span> id;
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">()</span></span>;
};

Widget obj;
obj.<span class="hljs-built_in">update</span>();
</code></pre>
<p>编译器将其转换为等价的C风格调用：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> _ZN6Widget6updateEv(Widget* this); <span class="hljs-comment">//  mangled name</span>

Widget obj;
_ZN6Widget6updateEv(&amp;obj); <span class="hljs-comment">// 传递this指针</span>
</code></pre>
<p><code>this</code>指针的传递约定因平台而异：x86-64 System V ABI使用<code>rdi</code>寄存器，而x86-64 Windows ABI使用<code>rcx</code>寄存器。</p>
<h3 data-id="heading-5">2.2 虚函数与动态绑定的代价</h3>
<p>多态是C++最强大的特性之一，其在二进制层面的实现也最为复杂。虚函数机制通过虚函数表（vtable）和虚函数指针（vptr）实现运行时动态绑定。</p>
<h4 data-id="heading-6">2.2.1 虚函数表结构</h4>
<p>对于包含虚函数的类，编译器在只读数据段创建虚函数表。每个vtable包含：</p>
<ul>
<li>类型信息指针（指向RTTI数据）</li>
<li>虚函数地址数组</li>
<li>偏移量信息（多重继承时）</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">vfunc1</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">vfunc2</span><span class="hljs-params">()</span></span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">vfunc1</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">vfunc3</span><span class="hljs-params">()</span></span>;
};
</code></pre>
<p>对应的vtable布局如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">Base vtable:
    [<span class="hljs-number">0</span>] &amp;Base::rtti_complete
    [<span class="hljs-number">1</span>] &amp;Base::vfunc1
    [<span class="hljs-number">2</span>] &amp;Base::vfunc2

Derived vtable:
    [<span class="hljs-number">0</span>] &amp;Derived::rtti_complete  
    [<span class="hljs-number">1</span>] &amp;Derived::vfunc1      <span class="hljs-comment">// 重写</span>
    [<span class="hljs-number">2</span>] &amp;Base::vfunc2         <span class="hljs-comment">// 继承</span>
    [<span class="hljs-number">3</span>] &amp;Derived::vfunc3      <span class="hljs-comment">// 新增</span>
</code></pre>
<h4 data-id="heading-7">2.2.2 虚函数调用解析</h4>
<p>虚函数调用<code>base_ptr-&gt;vfunc1()</code>被编译为：</p>
<pre><code class="hljs language-assembly" lang="assembly">; 1. 通过对象获取vptr
mov rax, [rdi]        ; rdi存储this，[rdi]是vptr

; 2. 从vtable获取函数地址  
mov rax, [rax + 8]    ; 假设vfunc1在vtable偏移8处

; 3. 间接调用
call rax
</code></pre>
<p>与普通函数调用相比，虚函数调用需要额外的两次内存访问，并阻碍了内联优化，这是面向对象设计在性能上的典型代价。</p>
<h2 data-id="heading-8">三、模板实例化与代码膨胀</h2>
<h3 data-id="heading-9">3.1 编译期代码生成机制</h3>
<p>C++模板是图灵完备的编译期元编程系统，其核心机制是实例化。每次使用新类型参数实例化模板时，编译器都会生成特化版本的完整代码。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Container</span> {
    T* data;
    <span class="hljs-type">size_t</span> size;
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">push_back</span><span class="hljs-params">(<span class="hljs-type">const</span> T&amp; item)</span></span>;
    T&amp; <span class="hljs-keyword">operator</span>[](<span class="hljs-type">size_t</span> index);
};

<span class="hljs-comment">// 实例化不同版本</span>
Container&lt;<span class="hljs-type">int</span>&gt; int_container;
Container&lt;std::string&gt; string_container;
</code></pre>
<p>编译器分别为<code>Container&lt;int&gt;</code>和<code>Container&lt;std::string&gt;</code>生成独立的二进制代码，包括所有成员函数的特化版本。</p>
<h3 data-id="heading-10">3.2 二进制膨胀的缓解策略</h3>
<p>重复的模板实例化可能导致显著的代码膨胀。现代C++采用多种技术缓解该问题：</p>
<ul>
<li><strong>显式实例化</strong>：在特定编译单元中显式实例化模板，避免在其他单元中重复生成</li>
<li><strong>外部模板</strong>（C++11）：使用<code>extern template</code>声明阻止隐式实例化</li>
<li><strong>公共子表达式消除</strong>：编译器识别并合并相同的实例化代码</li>
</ul>
<h2 data-id="heading-11">四、全局对象生命周期管理</h2>
<h3 data-id="heading-12">4.1 构造与析构的自动化</h3>
<p>C++全局和静态对象的构造/析构通过特定的二进制段实现自动化管理。编译器生成初始化代码，在main函数执行前构造所有全局对象，在程序退出时执行析构。</p>
<p>ELF格式的可执行文件使用以下特殊段：</p>
<ul>
<li><code>.init_array</code>：存储全局构造函数指针数组</li>
<li><code>.fini_array</code>：存储全局析构函数指针数组</li>
</ul>
<p>程序启动流程伪代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 编译器生成的入口点</span>
_start() {
    <span class="hljs-comment">// 1. 运行时环境初始化</span>
    __libc_start_init();
    
    <span class="hljs-comment">// 2. 执行.init_array中的所有构造函数</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> ctor : .init_array) {
        ctor();
    }
    
    <span class="hljs-comment">// 3. 调用main函数</span>
    <span class="hljs-type">int</span> result = main();
    
    <span class="hljs-comment">// 4. 执行.fini_array中的析构函数</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> dtor : .fini_array) {
        dtor();
    }
    
    <span class="hljs-comment">// 5. 程序退出</span>
    _exit(result);
}
</code></pre>
<h3 data-id="heading-13">4.2 静态初始化顺序问题</h3>
<p>这种自动化机制引入了著名的"静态初始化顺序fiasco"问题：不同编译单元中的全局对象构造顺序未定义。实践中常采用"构造时首次使用"惯用法规避该问题：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">MyClass&amp; <span class="hljs-title">get_global_instance</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">static</span> MyClass instance;  <span class="hljs-comment">// C++11保证线程安全</span>
    <span class="hljs-keyword">return</span> instance;
}
</code></pre>
<h2 data-id="heading-14">五、异常处理的基础设施</h2>
<h3 data-id="heading-15">5.1 栈展开与异常传播</h3>
<p>C++异常处理依赖复杂的运行时支持。当抛出异常时，运行时系统必须：</p>
<ol>
<li>在调用栈中查找匹配的catch块</li>
<li>展开栈帧，析构所有局部对象</li>
<li>转移控制流到异常处理器</li>
</ol>
<p>这套机制在二进制层面通过<code>.eh_frame</code>段（异常处理帧）实现，该段包含DWARF格式的调用栈展开信息。</p>
<h3 data-id="heading-16">5.2 零开销异常处理原则</h3>
<p>现代C++编译器遵循"零开销"原则：不抛出异常的代码不应承担异常处理开销。这通过表驱动异常处理实现——正常执行路径不包含额外检查，异常处理元数据存储在独立的段中。</p>
<p>比较以下两种错误处理方式的开销：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 异常方式 - 无错误时零开销</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">parse_config</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; filename)</span> </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">auto</span> config = <span class="hljs-built_in">parse_file</span>(filename); <span class="hljs-comment">// 可能抛出</span>
        <span class="hljs-built_in">apply_config</span>(config);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> parse_error&amp; e) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}

<span class="hljs-comment">// 错误码方式 - 每次调用都有检查开销</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">parse_config</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; filename)</span> </span>{
    parse_result result = <span class="hljs-built_in">parse_file_ec</span>(filename);
    <span class="hljs-keyword">if</span> (result.error) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-built_in">apply_config</span>(result.value);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h2 data-id="heading-17">六、运行时类型信息（RTTI）</h2>
<h3 data-id="heading-18">6.1 typeid与dynamic_cast的实现</h3>
<p>RTTI使得C++程序能够在运行时查询类型信息。对于多态类型（包含虚函数的类），<code>typeid</code>和<code>dynamic_cast</code>通过虚函数表访问<code>type_info</code>对象。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> { <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base</span>() = <span class="hljs-keyword">default</span>; };
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">(Base* ptr)</span> </span>{
    <span class="hljs-comment">// typeid查询</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">typeid</span>(*ptr) == <span class="hljs-built_in">typeid</span>(Derived)) {
        <span class="hljs-comment">// dynamic_cast转换</span>
        Derived* d = <span class="hljs-built_in">dynamic_cast</span>&lt;Derived*&gt;(ptr);
    }
}
</code></pre>
<p><code>type_info</code>对象包含类型名称字符串和类型比较函数，存储在只读数据段。<code>dynamic_cast</code>在复杂继承层次中可能需要遍历整个类层次结构，这是其性能开销的主要来源。</p>
<h3 data-id="heading-19">6.2 RTTI的优化与禁用</h3>
<p>由于RTTI的空间和时间开销，性能敏感的场景常禁用该特性。GCC/Clang通过<code>-fno-rtti</code>标志禁用RTTI，此时<code>typeid</code>和<code>dynamic_cast</code>将无法使用，但可减少二进制大小并提升性能。</p>
<h2 data-id="heading-20">性能影响与工程实践</h2>
<h3 data-id="heading-21">二进制特征对比总结</h3>









































<table><thead><tr><th>特性维度</th><th>C语言实现</th><th>C++实现</th><th>性能影响</th></tr></thead><tbody><tr><td>函数调用</td><td>直接调用</td><td>名称修饰+可能虚调用</td><td>虚调用：+2-3周期</td></tr><tr><td>代码体积</td><td>紧凑</td><td>模板实例化可能膨胀</td><td>增加I-Cache压力</td></tr><tr><td>启动时间</td><td>快速</td><td>全局对象构造开销</td><td>微秒级延迟</td></tr><tr><td>异常处理</td><td>setjmp/longjmp</td><td>表驱动零开销</td><td>仅异常时开销</td></tr><tr><td>类型信息</td><td>无</td><td>RTTI元数据</td><td>空间开销+类型查询时间</td></tr></tbody></table>
<h3 data-id="heading-22">混合编程最佳实践</h3>
<ol>
<li><strong>清晰的接口边界</strong>：使用<code>extern "C"</code>明确C风格接口</li>
<li><strong>资源管理隔离</strong>：C++端使用RAII，C端提供显式的create/destroy函数</li>
<li><strong>异常边界处理</strong>：C++异常不应传播到C代码中</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C++封装C库的典型模式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseHandle</span> {
    sqlite3* raw_handle;
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">DatabaseHandle</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sqlite3_open</span>(filename, &amp;raw_handle) != SQLITE_OK) {
            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">database_error</span>(<span class="hljs-string">"Failed to open database"</span>);
        }
    }
    
    ~<span class="hljs-built_in">DatabaseHandle</span>() {
        <span class="hljs-built_in">sqlite3_close</span>(raw_handle);
    }
    
    <span class="hljs-comment">// 禁用拷贝，允许移动</span>
    <span class="hljs-built_in">DatabaseHandle</span>(<span class="hljs-type">const</span> DatabaseHandle&amp;) = <span class="hljs-keyword">delete</span>;
    DatabaseHandle&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> DatabaseHandle&amp;) = <span class="hljs-keyword">delete</span>;
    <span class="hljs-built_in">DatabaseHandle</span>(DatabaseHandle&amp;&amp;) = <span class="hljs-keyword">default</span>;
    DatabaseHandle&amp; <span class="hljs-keyword">operator</span>=(DatabaseHandle&amp;&amp;) = <span class="hljs-keyword">default</span>;
};
</code></pre>
<h2 data-id="heading-23">结论</h2>
<p>C++在保持C语言语法兼容的同时，通过复杂的二进制机制实现了面向对象、泛型编程等高级特性。这些机制在赋予程序员强大表达能力的同时，也带来了名称修饰、虚函数表、模板实例化、异常处理元数据等二进制层面的复杂性。</p>
<p>理解这些底层实现差异对于性能调优、混合编程和系统设计至关重要。在现代C++开发中，开发者应当根据具体场景权衡高级特性的便利性与底层开销，在表达力与性能之间找到恰当的平衡点。随着编译器技术的不断进步，C++正朝着在保持零开销抽象原则的同时，进一步降低二进制复杂度的方向发展。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么C语言拒绝函数重载？非要重载怎么做？]]></title>    <link>https://juejin.cn/post/7577693903018393626</link>    <guid>https://juejin.cn/post/7577693903018393626</guid>    <pubDate>2025-11-29T15:03:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577693903018393626" data-draft-id="7577705544874934310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么C语言拒绝函数重载？非要重载怎么做？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T15:03:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么C语言拒绝函数重载？非要重载怎么做？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:03:11.000Z" title="Sat Nov 29 2025 15:03:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在我们学习C++、Java或C#时，函数重载（Function Overloading）是一个再自然不过的概念：允许两个或多个函数使用相同的名字，只要它们的参数列表（参数的类型、个数或顺序）不同即可。编译器会根据调用时传入的实参，自动选择最匹配的那个函数。</p>
<p>然而，当我们回到C语言的世界，这条规则却失效了。如果你定义了两个同名的函数，即使参数列表不同，编译器也会毫不留情地报出一个“重定义”错误。</p>
<p><strong>那么，为什么C语言的设计者，要“剥夺”这个看似非常实用的特性呢？</strong></p>
<p>答案并非“不能”，而是“不为”。这背后是C语言与生俱来的设计哲学和实现机制所决定的。</p>
<h3 data-id="heading-0"><strong>一、 核心原因</strong></h3>
<p>最根本的原因在于<strong>C语言的链接器（Linker）不支持名称修饰（Name Mangling）</strong>。</p>
<ul>
<li><strong>C语言的朴素视角：</strong> 在C语言看来，一个函数名在编译成目标文件后，就是它在链接时唯一的身份标识。这个标识就是函数名本身，简单直接。比如，一个名为 <code>add</code> 的函数，在目标文件的符号表（Symbol Table）里，它的名字就是 <code>add</code>。</li>
<li><strong>链接器的困境：</strong> 假设C语言允许重载，我们定义了以下两个函数：
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>;
<span class="hljs-type">float</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">float</span> a, <span class="hljs-type">float</span> b)</span>;
</code></pre>
在编译后，两个函数在目标文件里的符号名都会是 <code>add</code>。当链接器开始工作，试图将各个目标文件拼接在一起时，它会发现有两个完全同名的 <code>add</code> 符号，它无法判断你到底想调用哪一个。于是，链接错误就发生了。</li>
</ul>
<p><strong>那么，C++等语言是如何解决这个问题的呢？</strong></p>
<p>答案是：<strong>名称修饰（Name Mangling）</strong>。</p>
<p>编译器会在编译阶段，根据函数的<strong>名称</strong>和<strong>参数列表</strong>信息，对函数名进行“混淆”或“修饰”，生成一个在链接阶段唯一的内部名称。</p>
<p>对于上面的两个 <code>add</code> 函数，C++编译器可能会生成类似这样的符号：</p>
<ul>
<li><code>_Z3addii</code> (代表 <code>int add(int, int)</code>)</li>
<li><code>_Z3addff</code> (代表 <code>float add(float, float)</code>)</li>
</ul>
<p>这样，链接器看到的就是两个完全不同的符号，自然就不会冲突了。这个过程对程序员是透明的，我们依然可以用 <code>add</code> 这个名字来调用它们。</p>
<h3 data-id="heading-1"><strong>二、 语言设计哲学</strong></h3>
<p>C语言诞生于1972年，其核心设计哲学是：</p>
<ol>
<li><strong>信任程序员（Trust the programmer）</strong></li>
<li><strong>保持语言的简洁和小巧（Keep it simple and small）</strong></li>
<li><strong>提供接近硬件的操作能力，追求高效（Provide low-level access and efficiency）</strong></li>
</ol>
<p>不支持函数重载，正是这一哲学的体现。</p>
<ul>
<li><strong>简洁性：</strong> 不引入名称修饰，意味着编译器和链接器的实现可以更简单、更直接。C语言的目标之一就是可以用相对简单的编译器来实现。</li>
<li><strong>透明性：</strong> C语言希望程序员能清晰地知道编译和链接的每一步发生了什么。当你看到一个函数名 <code>add</code>，你知道它在符号表里就是 <code>add</code>，没有“黑魔法”。这种可预测性对于系统级编程至关重要。</li>
<li><strong>效率：</strong> 更简单的名称查找机制，在理论上可以带来更快的编译和链接速度。虽然现代编译器的优化已经让这点差异微乎其微，但在C语言诞生的那个资源匮乏的年代，这是非常重要的考量。</li>
</ul>
<p>C语言将“区分函数”这个责任交给了程序员。如果你想实现类似的功能，那就手动起不同的名字：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">add_int</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>;
<span class="hljs-type">float</span> <span class="hljs-title function_">add_float</span><span class="hljs-params">(<span class="hljs-type">float</span> a, <span class="hljs-type">float</span> b)</span>;
<span class="hljs-type">double</span> <span class="hljs-title function_">add_double</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span>;
</code></pre>
<p>这种方式虽然不够“优雅”，但绝对清晰、无歧义，并且完全在程序员的掌控之中。</p>
<h3 data-id="heading-2"><strong>三、 历史与兼容性包袱</strong></h3>
<p>C语言是古老的，它需要与汇编语言和更早期的代码进行无缝交互。这种简单的符号命名规则，使得与汇编代码的链接变得异常简单。一个C函数可以直接被汇编代码调用，只要汇编代码知道那个简单的函数名即可。</p>
<p>如果引入了名称修饰，与外部汇编代码或其他语言模块的交互就会变得复杂得多。C语言作为“系统编程语言”，与底层硬件的这种直接对话能力是其立身之本。</p>
<h2 data-id="heading-3"><strong>四、一定不能重载吗？</strong></h2>
<p>虽然，C语言因其设计哲学和简单的链接模型，无法像C++那样直接支持函数重载。但C语言的灵活性和强大之处就在于，它总能为程序员留下后门。正所谓"上有政策，下有对策"，让我们看看有哪些巧妙的方法可以实现类似重载的功能。</p>
<h3 data-id="heading-4"><strong>方法一：使用 <code>_Generic</code> 类型泛型选择（C11标准）</strong></h3>
<p>这是最接近真正函数重载的方法，也是C语言官方提供的解决方案。<code>_Generic</code> 是C11标准引入的特性，它允许在编译时根据表达式的类型选择不同的代码路径。</p>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">_Generic</span>(控制表达式, 类型<span class="hljs-number">1</span>: 表达式<span class="hljs-number">1</span>, 类型<span class="hljs-number">2</span>: 表达式<span class="hljs-number">2</span>, ..., <span class="hljs-keyword">default</span>: 默认表达式)
</code></pre>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-comment">// 定义三个不同类型的add函数</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">add_int</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"调用整型加法: "</span>);
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-type">double</span> <span class="hljs-title function_">add_double</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"调用双精度加法: "</span>);
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-type">float</span> <span class="hljs-title function_">add_float</span><span class="hljs-params">(<span class="hljs-type">float</span> a, <span class="hljs-type">float</span> b)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"调用单精度加法: "</span>);
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-comment">// 使用_Generic创建"重载"入口</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> add(a, b) _Generic((a), \
    int: _Generic((b), \
        int: add_int, \
        double: add_double, \
        default: add_int), \
    double: _Generic((b), \
        double: add_double, \
        int: add_double, \
        default: add_double), \
    float: _Generic((b), \
        float: add_float, \
        default: add_float) \
)(a, b)</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, add(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>));           <span class="hljs-comment">// 调用整型加法</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%.2f\n"</span>, add(<span class="hljs-number">3.14</span>, <span class="hljs-number">2.71</span>));     <span class="hljs-comment">// 调用双精度加法  </span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%.2f\n"</span>, add(<span class="hljs-number">1.5f</span>, <span class="hljs-number">2.5f</span>));     <span class="hljs-comment">// 调用单精度加法</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%.2f\n"</span>, add(<span class="hljs-number">10</span>, <span class="hljs-number">3.14</span>));       <span class="hljs-comment">// 混合类型，调用双精度加法</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>编译时决定，零运行时开销</li>
<li>类型安全，编译器会检查类型匹配</li>
<li>语法相对简洁，使用宏包装后调用形式统一</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>需要C11或更高版本支持</li>
<li>类型组合较多时，宏定义会变得复杂</li>
<li>不能处理运行时才确定类型的情况</li>
</ul>
<h3 data-id="heading-5"><strong>方法二：可变参数函数 + 类型标识符</strong></h3>
<p>这是比较传统的做法，通过额外的参数来标识实际的数据类型。</p>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdarg.h&gt;</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span>
    TYPE_INT,
    TYPE_DOUBLE,
    TYPE_STRING
} DataType;

<span class="hljs-comment">// 统一的处理函数</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(DataType type, ...)</span> {
    va_list args;
    va_start(args, type);
    
    <span class="hljs-keyword">switch</span>(type) {
        <span class="hljs-keyword">case</span> TYPE_INT: {
            <span class="hljs-type">int</span> value = va_arg(args, <span class="hljs-type">int</span>);
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"处理整型: %d\n"</span>, value);
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">case</span> TYPE_DOUBLE: {
            <span class="hljs-type">double</span> value = va_arg(args, <span class="hljs-type">double</span>);
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"处理双精度: %.2f\n"</span>, value);
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">case</span> TYPE_STRING: {
            <span class="hljs-type">char</span>* value = va_arg(args, <span class="hljs-type">char</span>*);
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"处理字符串: %s\n"</span>, value);
            <span class="hljs-keyword">break</span>;
        }
    }
    
    va_end(args);
}

<span class="hljs-comment">// 使用宏简化调用</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PROCESS_INT(x)    process(TYPE_INT, x)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PROCESS_DOUBLE(x) process(TYPE_DOUBLE, x)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PROCESS_STRING(x) process(TYPE_STRING, x)</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    PROCESS_INT(<span class="hljs-number">42</span>);
    PROCESS_DOUBLE(<span class="hljs-number">3.14159</span>);
    PROCESS_STRING(<span class="hljs-string">"Hello, World!"</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>兼容性好，支持C99及之前的标准</li>
<li>灵活性高，可以处理任意数量和类型的参数</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>类型不安全，容易出错</li>
<li>运行时开销较大</li>
<li>需要手动管理类型标识</li>
</ul>
<h3 data-id="heading-6"><strong>方法三：函数指针结构体（面向对象风格）</strong></h3>
<p>这种方法更像是设计模式的应用，通过结构体封装不同类型的操作。</p>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-comment">// 定义不同数据类型的操作</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">int_add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> { <span class="hljs-keyword">return</span> a + b; }
<span class="hljs-type">double</span> <span class="hljs-title function_">double_add</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> { <span class="hljs-keyword">return</span> a + b; }
<span class="hljs-type">float</span> <span class="hljs-title function_">float_add</span><span class="hljs-params">(<span class="hljs-type">float</span> a, <span class="hljs-type">float</span> b)</span> { <span class="hljs-keyword">return</span> a + b; }

<span class="hljs-comment">// 定义操作集结构体</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">union</span> {</span>
        <span class="hljs-type">int</span> (*int_func)(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>);
        <span class="hljs-type">double</span> (*double_func)(<span class="hljs-type">double</span>, <span class="hljs-type">double</span>);
        <span class="hljs-type">float</span> (*float_func)(<span class="hljs-type">float</span>, <span class="hljs-type">float</span>);
    } operation;
    <span class="hljs-type">int</span> type; <span class="hljs-comment">// 0: int, 1: double, 2: float</span>
} Calculator;

<span class="hljs-comment">// 创建不同类型的计算器</span>
Calculator <span class="hljs-title function_">create_int_calculator</span><span class="hljs-params">()</span> {
    Calculator calc;
    calc.operation.int_func = int_add;
    calc.type = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> calc;
}

Calculator <span class="hljs-title function_">create_double_calculator</span><span class="hljs-params">()</span> {
    Calculator calc;
    calc.operation.double_func = double_add;
    calc.type = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> calc;
}

<span class="hljs-comment">// 统一的使用接口（需要类型转换，实际使用中要小心）</span>
<span class="hljs-type">void</span>* <span class="hljs-title function_">calculate</span><span class="hljs-params">(Calculator calc, <span class="hljs-type">void</span>* a, <span class="hljs-type">void</span>* b)</span> {
    <span class="hljs-type">static</span> <span class="hljs-type">int</span> int_result;
    <span class="hljs-type">static</span> <span class="hljs-type">double</span> double_result;
    <span class="hljs-type">static</span> <span class="hljs-type">float</span> float_result;
    
    <span class="hljs-keyword">switch</span>(calc.type) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
            int_result = calc.operation.int_func(*(<span class="hljs-type">int</span>*)a, *(<span class="hljs-type">int</span>*)b);
            <span class="hljs-keyword">return</span> &amp;int_result;
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
            double_result = calc.operation.double_func(*(<span class="hljs-type">double</span>*)a, *(<span class="hljs-type">double</span>*)b);
            <span class="hljs-keyword">return</span> &amp;double_result;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> a = <span class="hljs-number">10</span>, b = <span class="hljs-number">20</span>;
    <span class="hljs-type">double</span> x = <span class="hljs-number">3.14</span>, y = <span class="hljs-number">2.71</span>;
    
    Calculator int_calc = create_int_calculator();
    Calculator double_calc = create_double_calculator();
    
    <span class="hljs-type">int</span>* int_result = calculate(int_calc, &amp;a, &amp;b);
    <span class="hljs-type">double</span>* double_result = calculate(double_calc, &amp;x, &amp;y);
    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"整型结果: %d\n"</span>, *int_result);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"双精度结果: %.2f\n"</span>, *double_result);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>代码组织清晰，易于扩展</li>
<li>运行时多态，灵活性高</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>实现复杂，使用繁琐</li>
<li>类型转换存在安全风险</li>
<li>性能开销较大</li>
</ul>
<h3 data-id="heading-7"><strong>方法对比总结</strong></h3>





































<table><thead><tr><th>方法</th><th>适用标准</th><th>性能</th><th>类型安全</th><th>易用性</th><th>适用场景</th></tr></thead><tbody><tr><td><code>_Generic</code></td><td>C11+</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>类型明确的数学运算、工具函数</td></tr><tr><td>可变参数</td><td>C89+</td><td>⭐⭐</td><td>⭐⭐</td><td>⭐⭐⭐</td><td>日志系统、格式化输出等</td></tr><tr><td>函数指针</td><td>C89+</td><td>⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐</td><td>插件系统、算法策略选择</td></tr></tbody></table>
<h3 data-id="heading-8"><strong>实际项目中的建议</strong></h3>
<ol>
<li><strong>优先考虑 <code>_Generic</code></strong>：如果项目可以使用C11标准，这是最优雅的解决方案</li>
<li><strong>简单场景用宏</strong>：对于参数类型固定但个数不同的情况，可以用不同名称的宏来模拟</li>
<li><strong>复杂场景用设计</strong>：如果真的需要复杂的多态行为，可能需要重新考虑架构设计</li>
</ol>
<h3 data-id="heading-9"><strong>总结</strong></h3>
<p>将C语言不支持函数重载视为一种“缺陷”，其实是一种从现代高级语言视角出发的“后见之明”。如果我们回到C语言所处的历史语境和其要解决的核心问题来看，这更像是一种深思熟虑后的<strong>设计选择</strong>。</p>
<ul>
<li><strong>C++/Java/C# 等是“功能丰富的现代化工具库”</strong>，它们通过增加复杂性（如名称修饰）来提供更高的开发效率和抽象能力。</li>
<li><strong>C语言则像一位“质朴的手工匠人”</strong>，它选择将工具保持在最基础、最可控的状态，将更多的权力和责任交给了使用者——程序员。</li>
</ul>
<p>所以，C语言不支持重载，不是因为它“蠢”，而是因为它“志不在此”。它用最朴素的方式，完美地完成了它的时代使命，并至今仍在系统编程、嵌入式开发等需要极致控制和效率的领域，散发着不可替代的光芒。</p>
<p>理解了这一点，我们或许能对这门古老而强大的语言，多一份敬畏。</p>
<p>并且，C语言的强大不在于它提供了多少现成的"高级特性"，而在于它提供了足够的基础工具，让有能力的程序员可以构建出自己需要的任何特性。</p>
<p>这种"手工打造"的感觉，正是C语言经久不衰的魅力所在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis：大数据中如何抗住2000W的QPS]]></title>    <link>https://juejin.cn/post/7577660060094283830</link>    <guid>https://juejin.cn/post/7577660060094283830</guid>    <pubDate>2025-11-29T13:33:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577660060094283830" data-draft-id="7577715145121398838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis：大数据中如何抗住2000W的QPS"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2025-11-29T13:33:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮皮林551"/> <meta itemprop="url" content="https://juejin.cn/user/2447981921436084"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis：大数据中如何抗住2000W的QPS
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2447981921436084/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮皮林551
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T13:33:17.000Z" title="Sat Nov 29 2025 13:33:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li>前言</li>
<li>Redis性能优化</li>
<li>Redis常见架构</li>
<li>结语</li>
</ul>
<hr/>
<h2 data-id="heading-0"><strong>前言</strong></h2>
<p>在多年的SparkStreaming的大数据流处理开发中，除了Kafka，Redis是用的最多的组件。目前生产有多个redis集群，最大的32节点的集群的key已经达到40亿个，峰值2000万的QPS。</p>
<p>Redis在流处理开发中一共有两种应用场景:</p>
<ol>
<li>离线更新的维表数据，用于增加流数据的维度信息</li>
<li>应用实时更新的状态数据</li>
</ol>
<p>不管是哪种应用场景，最后在SparkStreaming中都需要与Redis进行交互，来完成get、set操作假如SparkStreaming中RDD的时间间隔为1min，那么这个窗口的数据在1min内计算完成才算是"不延迟"。当遇到计算延迟的情况时，如果不与Redis交互，增加core、memory计算资源，或者提高并行度会解决这个问题，</p>
<p>之前开发一个1亿/min数据量的SparkStreaming应用中，发现造成计算延迟原因可能是与Redis交互耗费了太多的时间，这时候再增加计算资源和提高并行度效果不大，所以这时候就要从应用与Redis交互上进行优化。</p>
<h2 data-id="heading-1"><strong>Redis性能优化</strong></h2>
<p>很多时候，我们无法对已部署的Redis服务进行优化，哪怕是有些默认参数不合理，也无法随心所欲地修改参数然后重启集群，进而影响生产。所以我们只能从应用侧的代码中，去代码优化.</p>
<p>应用和Redis服务数据交互的过程大致如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9eec71eef2364a20a58aa131c8f41294~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=ImBjPmCWxcEJX2Y8iEcfwZjAYHE%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<h4 data-id="heading-2">连接池</h4>
<p>在Java中，应用与Redis进行交互的连接类是<em>Jedis</em>。如果每次连接都要创建一个Jedis的话，那么每次TCP三次握手建立连接，关闭时再四次挥手断开连接，虽然内网的情况下速度够快，但是架不住数据量大，因此我们需要保持长连接。</p>
<pre><code class="hljs language-ini" lang="ini">JedisPool
Config <span class="hljs-attr">poolConfig</span> = new JedisPoolConfig()<span class="hljs-comment">;</span>
poolConfig.setMaxTotal(10)<span class="hljs-comment">;</span>
poolConfig.setMinIdle(5)<span class="hljs-comment">;</span>
poolConfig.setMaxIdle(8)<span class="hljs-comment">;</span>
JedisPool <span class="hljs-attr">jedisPool</span> = new JedisPool(poolConfig, <span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)<span class="hljs-comment">;</span>
Jedis <span class="hljs-attr">jedis</span> = jedisPool.getResource()
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47396fb0fb164340b2af3078805dc3ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=xKa9sA8dc4GegFIppcNnC%2BbC%2FHE%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>当我们调用<em>close()</em>  关闭连接时，会对dataSource进行判断，如果为null，则直接断开Redis连接，如果是从连接池获取的，那么会将这个Jedis在放入到JedisPool中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/599aca4924bc41998401a476e1c6f065~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=celp1gWwcdFpfEW4rmfBHH1yhfA%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<h4 data-id="heading-3">batch.size</h4>
<p>经常和大数据打交道的都会很熟悉一个单词：<em>batch.size</em>。通常指的是两个组件在交互时，一次交互尽量处理一批数据，通过减少通信次数来提高处理效率。</p>
<h4 data-id="heading-4">kafka</h4>
<p>例如在KafkaProduer中，参数batch.size用来控制一次向kafka发送数据的条数。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fe6c9be5b5e49f5b63ed64e00b55ca2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=kTfYYxJnKZZfPjboB2yRTnhp4dE%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>但问题又来了，假如batch.size设置为100，数据只有99条，那么就一直不发送吗。所以为了保证batch情况下的数据实时性，于是又定义了<em>linger.ms</em>来控制等待时间，batch.size与linger.ms只要满足一个，就将数据发送到kafka。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0549ca067ede4c6588eaeb506863e77e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=2DbyOlFOuOTPo%2Bw5diLOjGjrovE%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<h4 data-id="heading-5">Flume</h4>
<p>同样，在Flume的配置文件中，也经常看到batch size参数，通常来控制source向channel发送数据、或者sink从channel取出数据的条数。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87d6f1aa7c6046c68c3065f3b3e6e426~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=ZVcCbuMOlFKhpQbMXDRrVdeGvHQ%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>那么，我们是否也可以将多个set、get操作打包成batch，一次性提交多条操作命令？</p>
<h4 data-id="heading-6">pipeline</h4>
<p>Jedis提供了pipeline的操作模式，允许一次性执行多个操作命令，然后通过手动执行<em>sync</em>来发送到Redis，返回请求结果。接着上面连接池实现pipeline代码。</p>
<pre><code class="hljs language-ini" lang="ini">Jedis <span class="hljs-attr">jedis</span> = jedisPool.getResource()
Pipeline <span class="hljs-attr">pipeline</span> = jedis.pipelined()<span class="hljs-comment">;</span>
Response&lt;String&gt; <span class="hljs-attr">res1</span> = pipeline.get(<span class="hljs-string">"aa"</span>)<span class="hljs-comment">;</span>
Response&lt;String&gt; <span class="hljs-attr">res2</span> = pipeline.get(<span class="hljs-string">"bb"</span>)<span class="hljs-comment">;</span>
// 这里也可以进行set、hmget等操作
pipeline.sync()<span class="hljs-comment">;</span>
String <span class="hljs-attr">s1</span> = res1.get()<span class="hljs-comment">;</span>
String <span class="hljs-attr">s2</span> = res2.get()<span class="hljs-comment">;</span>
</code></pre>
<p>从<em>jedis.pipelined()</em>  创建pipeline到执行sync发送redis之间，你可以执行多个不同redis命令。通过Jedis执行get操作，返回的是String。而使用pipeline执行，返回的是泛型为String的<em>Response</em>。</p>
<h4 data-id="heading-7">Response数据回填</h4>
<p>这个和NIO里面的Future差不多，通过上面代码也知道，pipeline执行完get(key)之后，不是立即发送到redis的，所以这时候只能返回一个Response对象，预留出一个字段来接收返回值，当执行sync()发送请求到redis之后，再将返回的结果一一回填到对应Response的字段上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78188d56d84547e1a30d71cff7f5a211~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=OGFwgMkmMbn20pWwZmXZnjp6SC4%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>如图，只有sync之后，Response才会有数据，可以debug看一下。</p>
<h4 data-id="heading-8">Response debug</h4>
<p>我使用docker，启动一个四主四从的redis cluster，对应端口从10001 - 10008。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4778ae1b91a24c54b6dbdbb0293e0104~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=PcTZP%2BKd66JMrzYrrc5ezqR2ZDY%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>使用redis-cli set两个key的数据。在cluster模式下，一定要加-c，否则就不会重定向到key所在slot的节点上，现在不懂slot无妨，因为接下来我会讲slot。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81abc2ca9cc14ace823f879b8e324b99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=JYD9RmuHyiaFMCkf4f1NCL6OZ%2BM%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>代码中使用Jedis连接其中的10001节点（不能使用JedisCluter，后面会讲）.</p>
<pre><code class="hljs language-ini" lang="ini">Jedis <span class="hljs-attr">jedis</span> = new Jedis(<span class="hljs-string">"121.91.xxx.xx"</span>, <span class="hljs-number">10001</span>)<span class="hljs-comment">;</span>
jedis.auth("1qaz@WSX")<span class="hljs-comment">;</span>
Pipeline <span class="hljs-attr">pipeline</span> = jedis.pipelined()<span class="hljs-comment">;</span>
Response&lt;String&gt; <span class="hljs-attr">res1</span> = pipeline.get(<span class="hljs-string">"aa"</span>)<span class="hljs-comment">;</span>
pipeline.sync()<span class="hljs-comment">;</span>
String <span class="hljs-attr">s1</span> = res1.get()<span class="hljs-comment">;</span>
</code></pre>
<p>然后使用pipeline获取key为aa的value值。在sync()处打上断点，debug启动。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5991ddb9eded4b35933566d45e7e5954~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=GVZkjLWHcaiMuSpwpGzw%2B460m6g%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>可以看到，response的data属性此时为null。执行下一步，也就是执行完sync()之后，data就有值了，返回的应该是我们之前set的1，这里49是字符串1在ACSII码表中的编号。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ea30b1b27ad4b8c8915de1fffb147df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=MNCT7KRk5OOsKsHZcX0RYqX%2Bo8c%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>所以，通常pipeline中执行一批(batch)的命令之后，再执行sync()将所有命令发送到redis，我在SparkStreaming的开发中，通常将batch设置为256或者512，也就是一次执行256或512个命令。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7843c8dc2ced4013abebddfdf9f83cd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=psHWsqhB2i7Gqf2RorZfmQbG8fg%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>至于256还是512，可以根据返回value的大小、或者请求类型来评估。至此，两种应用层面对redis的优化已经讲完，</p>
<p>但是**「因为pipeline相当于和一个redis建立了一个通道，然后批量发送数据，所以只有jedis才有pipeline」** 。具体什么意思呢，还是需要从redis常见的架构说起。</p>
<h2 data-id="heading-9"><strong>Redis常见架构</strong></h2>
<p>redis有多种运行模式，单点、哨兵、集群。目前在生产中，集群模式是用的最多的。而提到集群模式默认就是Redis自带cluster模式。但多年以来在大数据流处理开发中，我觉得最好用的cluster还是豌豆荚开源的<em>Codis</em>，不幸的是在很早之前已经停止了更新和维护。</p>
<p>我们上面提到<em>pipeline只针对于Jedis</em>，原因为何，还得先从Redis的存储架构说起。 在redis中，一共划分了16384个slot，每个key都会分布在其中的一个slot上。</p>
<h4 data-id="heading-10">单点模式</h4>
<p>对于单点模式，16384个slot都在一个节点上，不论什么样的key都会在这个节点上，我们通过Jedis和这个节点建立连接即可。</p>
<pre><code class="hljs language-ini" lang="ini">Jedis <span class="hljs-attr">jedis</span> = new Jedis(<span class="hljs-string">"ip"</span>, <span class="hljs-number">10001</span>)<span class="hljs-comment">;</span>
Pipeline <span class="hljs-attr">pipeline</span> = jedis.pipelined()<span class="hljs-comment">;</span>
Response&lt;String&gt; <span class="hljs-attr">res1</span> = pipeline.get(<span class="hljs-string">"aa"</span>)<span class="hljs-comment">;</span>
Response&lt;String&gt; <span class="hljs-attr">res2</span> = pipeline.get(<span class="hljs-string">"bb"</span>)<span class="hljs-comment">;</span>
pipeline.sync()<span class="hljs-comment">;</span>
</code></pre>
<p>这里只需要记住一句话：<em>Jedis只能连接单个redis服务</em>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcad87c9514b4860a6d6556e22df325b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=XPn6waAOA6qZwP0hm7c9nLnA0vw%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>而对于cluster模式来说，集群中的每个节点均分slot，我们在存入一个key的时候，要考虑：<em>key在哪个slot中？这个slot在哪个节点上？</em>  所以，这是集群模式下使用pipeline要面临的问题。</p>
<h4 data-id="heading-11">codis</h4>
<p>在codis的架构中，分为<em>codis proxy代理层</em>和<em>server</em>服务层。 codis proyx让整个codis看起来就像一个"大的单点redis"，同时proxy实现了redis协议，所以用户可以使用Jedis连接codis（大的单点redis）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f9bca7badb6419d946e0df58c934695~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=otTnY0kw7T%2FOACv9IK93aXXw7lw%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>反观server服务层是由多个的redis实例组成的，16384个slot均匀分布在了各个redis实例上，但是server层在proxy之下，对于用户来说是透明不可见的。用户实际上通过Jedis连接的是proxy代理层，而proxy会将根据每个key计算出要对应的slot，然后再找到slot对应的redis节点，然后进行各种操作。</p>
<p>底层的这些工作都是codis proxy来做，我们只需要连接到codis proxy，然后默认16384个slot都在codis proxy上，根本不用去管底层的slot具体在哪个redis中。</p>
<pre><code class="hljs language-css" lang="css">val poolConfig = new JedisPoolConfig
val poolx: JedisResourcePool = RoundRobinJedisPool.<span class="hljs-built_in">create</span>()
  .<span class="hljs-built_in">curatorClient</span>(redisHost, <span class="hljs-number">30000</span>)
  .<span class="hljs-built_in">zkProxyDir</span>(<span class="hljs-string">"/jodis/"</span> + database)
  .<span class="hljs-built_in">poolConfig</span>(poolConfig)
  .<span class="hljs-built_in">timeoutMs</span>(<span class="hljs-number">60000</span>)
  .<span class="hljs-built_in">build</span>()
  
val jedis: Jedis = poolx.getResource
</code></pre>
<h4 data-id="heading-12">redis cluster</h4>
<p>与codis相同的是，redis cluster也是由多个的redis实例组成的，16384个slot均匀分布在了各个redis实例上。不同的是，redis cluster没有proxy代理层，server层是直接暴露给用户的。我们上面也说了，Jedis只能连接单个节点。</p>
<p>如果使用Jedis连接到redis cluster中的某一个节点，那么这个Jedis只能操作这个节点分布的slot的key。例如我在redis-cli中，在操作bb这个key时，可以看到redirect重定向到了10003节点，当我再操作aa这个key时，又重定向到了10001节点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b37c2be2e65b4634ba4e07f3b18ae7e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=k8Jitti1mb3jAbrwTTrwBqbdvLM%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>所以aa分布在10001节点的的slot中，bb存放在10003节点的slot中，可以使用Jedis进行测试：</p>
<pre><code class="hljs language-csharp" lang="csharp">Jedis jedis = <span class="hljs-keyword">new</span> Jedis(<span class="hljs-string">"121.91.xx.xxx"</span>, <span class="hljs-number">10001</span>);
jedis.auth(<span class="hljs-string">"1qaz@WSX"</span>);
System.<span class="hljs-keyword">out</span>.println(jedis.<span class="hljs-keyword">get</span>(<span class="hljs-string">"aa"</span>));
System.<span class="hljs-keyword">out</span>.println(jedis.<span class="hljs-keyword">get</span>(<span class="hljs-string">"bb"</span>));
</code></pre>
<p>因为bb是在10003节点的slot上，而我Jedis连接的是10001节点，所以在获取bb的时候接直接报错。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c5eaee27d884b62abf7197e003c5d54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=POya7ExFURal9vKkrvPhtZsZTgk%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>因为Jedis只能操作一个节点的slot。所以才封装了<em>JedisCluster</em>来操作redis cluster的所有节点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35642eab9bf247508fbecfbaeb6ba324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=mhz1lpD7zm%2FO8%2FsxWl2YwB4W8uM%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>通过JedisCluster连接到整个redis集群，然后执行set、get等命令。</p>
<pre><code class="hljs language-ini" lang="ini">HashSet&lt;HostAndPort&gt; <span class="hljs-attr">jedisClusterNodes</span> = new java.util.HashSet()<span class="hljs-comment">;</span>
jedisClusterNodes.add(new HostAndPort("121.91.xx.xxx", 10001))<span class="hljs-comment">;</span>
JedisPoolConfig <span class="hljs-attr">config</span> = new JedisPoolConfig()<span class="hljs-comment">;</span>
config.setMaxTotal(-1)<span class="hljs-comment">;</span>
config.setMaxIdle(-1)<span class="hljs-comment">;</span>
config.setMaxWaitMillis(1000)<span class="hljs-comment">;</span>
JedisCluster <span class="hljs-attr">cluster</span> = new JedisCluster(jedisClusterNodes, <span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"1qaz@WSX"</span>, config)<span class="hljs-comment">;</span>
cluster.get("aa")<span class="hljs-comment">;</span>
cluster.get("bb")<span class="hljs-comment">;</span>
</code></pre>
<p>但不论是codis还是redis cluster，最终目的都是连接到底层的多个redis服务。所以JedisCluster也实现了codis proxy的功能，这样才能将数据放到相应的redis上。</p>
<h4 data-id="heading-13">1. redis连接</h4>
<p><em>JedisCluter存放数据时，底层使用的还是Jedis。</em></p>
<p>在初始化JedisCluster时，其<em>connectionHandler</em>属性的<em>cache</em>属性，会自动为所有的redis节点创建一个JedisPool，存放在<em>nodes</em>中，并且在<em>slots</em>属性中，将16384个slot与所在redis的JedisPool形成映射关系。如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e08a218166d43d89e1f0511ecf17852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=LTwvQ%2FWgUi8b0y9I4naMimQp%2B7g%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>所以JedisCluster就拿到了<em>每个slot与redis的关系与JedisPool</em>，接下来JedisCluster再知道哪个key应该放在哪个slot上，就能直接获取对应slot所在redis的Jedis连接，将key放在redis中。</p>
<h4 data-id="heading-14">2. key的计算</h4>
<p>JedisClustr每次在执行set、get等操作前，都会通过<em>JedisClusterCRC16</em>的<em>getSlot()</em>  ，通过计算出key所在的slot。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92290743367c473da015b8fb9cb2334b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=8QvbXxcta2%2FFtqXL4tIDrTqZ7e4%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>再调用<em>getConnectionFromSlot()</em>  ，利用计算出来的slot，从cache中获取这个slot对应的JedisPool。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28956e0acf444ae6b604fc7a6d843af2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=jLS%2Bysckj6KlnqdSzOnAskys%2BOY%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>调用的是cache的<em>getSlotPool()</em>  ，从1中生成的<em>slots</em>属性中，获取对应JedisPool。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64c0080e6b984e0e9fae10e842ec0293~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=CT1nOkNX4PGXYQcOp%2BhZBs9DysI%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>最后一个key就通过JedisCluster的接口，一步步放入到了对应redis的slot中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76515bab39e7499d996f76c3d76dc1af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=xSgCFk4U4j6D6sZQ9MgZyVexWAI%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>JedisCluster底层为集群中所有redis，都创建了一个JedisPool。但纵观整个JedisCluster，没有给用户暴露出来Jedis对象，也就是说JedisCluster面对的是cluster中所有的节点，而非其中某一个节点。所以<em>JedisCluster</em>是无法使用pipeline的。</p>
<h4 data-id="heading-15">redis cluster的pipeline</h4>
<p>我在SparkStreaming中，处理1亿/min数据使用redis cluster的时候，会因为与redis cluster交互过多而导致数据延迟，为此在刚从codis切换到redis cluster的时候，尝试了很多办法。</p>
<h4 data-id="heading-16">lettuce</h4>
<p>redis cluster除了JedisCluster，也有一个开源的<em>lettuce</em>，其中的<em>async异步</em>类pipeline操作。</p>
<pre><code class="hljs language-ini" lang="ini">RedisURI <span class="hljs-attr">uri</span> = RedisURI.builder()
        .withHost("47.102.xxx.xxx")
        .withPassword("1qaz@WSX".toCharArray())
        .withPort(10001)
        .build()<span class="hljs-comment">;</span>
RedisCluster
Client <span class="hljs-attr">client</span> = RedisClusterClient.create(uri)<span class="hljs-comment">;</span>
StatefulRedisClusterConnection&lt;String, String&gt; <span class="hljs-attr">connect</span> = client.connect()<span class="hljs-comment">;</span>
RedisAdvancedClusterAsyncCommands&lt;String, String&gt; <span class="hljs-attr">async</span> = connect.async()<span class="hljs-comment">;</span>
async.set("key1", "v1")<span class="hljs-comment">;</span>
async.set("key2", "v2")<span class="hljs-comment">;</span>
async.flushCommands()<span class="hljs-comment">;</span>
Thread.sleep(1000 * 3)<span class="hljs-comment">;</span>
connect.close()<span class="hljs-comment">;</span>
client.shutdown()<span class="hljs-comment">;</span>
</code></pre>
<p>但是实测之后，效率还是提不上去，有兴趣的朋友可以自己尝试一下。还有一个<em>Redisson</em>客户端，测试效果也不太理想。后来我还是自己实现了一个基于JedisCluster的pipeline客户端，现在生产在用，效率还是很快的。</p>
<h4 data-id="heading-17">自定义pipeline</h4>
<p>上面讲了，JedisCluster的<em>connectionHandler</em>属性的<em>cache</em>属性的<em>slots</em>属性，建立了slot与JedisPool的关系，但是JedisCluster中没有对外暴露cache。</p>
<p>万幸的是，cache是<em>protected</em>，而不是private。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91e4efafde5042fa9e9281d6f877c834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=a1Q%2FCn5Wv3c1fdcyABo8tZ%2BicjI%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>也就是说，JedisClusterConnectionHandler的子类可以获得cache，所以实现子类来获取slots。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73afe22e9f8d4f25a2eb47a7cc2c02b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55qu55qu5p6XNTUx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765027997&amp;x-signature=%2BaAyic%2FBHOL1H%2BphCH6C1lxRikk%3D" alt="图片" loading="lazy"/></p>
<p>图片</p>
<p>利用slots的映射关系，我们也建立几个map映射，<em>来实现针对于每个redis节点，我们都能获取到一个Jedis，来开启pipeline</em>。</p>
<ol>
<li>&lt;JedisPool, Jedis&gt;： 在打入一个key时，计算出key对应的slot，然后从slots中获取到对应的JedisPool，从JedisPool中取出一个Jedis，建立一个&lt;JedisPool, Jedis&gt;的映射，如果下次的key也在这个slot，就直接使用这个Jedis。保证一个redis实例只有一个Jedis，这样pipeline才有意义。</li>
<li>&lt;Jedis, Pipeline&gt;：通过这个映射，保证一个Jedis只开启一次Pipeline，而且相同redis上的key都可以通过这个pipeline来操作。</li>
<li>&lt;Pipeline, num&gt;：这个是用来设置sync的阈值，num是记录使用这个pipeline操作的次数，遍历，到达设定阈值的时候就执行sync，将pipeline的命令发送到redis中。</li>
</ol>
<p>具体实现思路可以参考早期的文章：JedisCluster Pipeline的实现思路</p>
<p>在这个理论基础上，后来根据自己的实际开发需求，使用java + scala开发除了适配SparkStreaming版本的JedisCluster pipeline。</p>
<h2 data-id="heading-18"><strong>结语</strong></h2>
<p>这就是我个人在大数据开发中，对redis使用的一些经验之谈。感觉redis有好多要写的，除了上面的这些优化手段之外，例如hash结构中K/V的合理设计等等一系列手段。</p>
<p>最近，陪伴了七年之久的codis，在无法通过升级来修复漏洞的情况下，宣布下线。虽然很早就开始从codis向redis cluster靠拢，但是此刻也不免感叹一声"自古美人叹迟暮，不许英雄见白头"。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[科幻小说计划 (顾雪) (AIGC)]]></title>    <link>https://juejin.cn/post/7577718777481297958</link>    <guid>https://juejin.cn/post/7577718777481297958</guid>    <pubDate>2025-11-29T14:01:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577718777481297958" data-draft-id="7577691061033173038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="科幻小说计划 (顾雪) (AIGC)"/> <meta itemprop="keywords" content="科幻,午夜话题,AIGC"/> <meta itemprop="datePublished" content="2025-11-29T14:01:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="穷人小水滴"/> <meta itemprop="url" content="https://juejin.cn/user/134615944418777"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            科幻小说计划 (顾雪) (AIGC)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/134615944418777/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    穷人小水滴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T14:01:40.000Z" title="Sat Nov 29 2025 14:01:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f333e356d6cd47a1897455511bc8978a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765029700&amp;x-signature=7Y77dRzYBjJpI%2BK%2BjiYCw1nw0cU%3D" alt="0-1.png" loading="lazy"/></p>
<p>(本文使用 AI 辅助创作)</p>
<p>(本文属于 【超低空科幻流派】)</p>
<p>笔名: 挖坑容易 (dig easy)</p>
<p>未来科幻: 全球核战爆发 2222 年 2 月 22 日.</p>
<h2 data-id="heading-0">清言</h2>
<p>好的，我已经仔细阅读并理解了这份详细的小说续作计划。下面我将主要内容进行重新组织，并在此基础上进行深入分析。</p>
<h3 data-id="heading-1">第一部分：主要内容重组</h3>
<p>为了更清晰地呈现这个宏大的科幻世界，我将计划内容拆解为以下几个核心模块：</p>
<h4 data-id="heading-2">一、 核心设定</h4>
<ul>
<li><strong>作品名称：</strong> 《地下城与核后白雪》</li>
<li><strong>类型：</strong> 长篇科幻小说</li>
<li><strong>主角：</strong> 顾雪（称号：雪王）</li>
<li><strong>时代背景：</strong> 24世纪（故事始于2367年），即全球核大战爆发百年之后。人类文明转入地下，地面为核辐射污染区。</li>
</ul>
<h4 data-id="heading-3">二、 世界观与前情提要</h4>
<ol>
<li>
<p><strong>前作结局：</strong> 苏棠与顾尘（第一部主角）相守一生，自然老去并合葬，他们的爱情故事圆满落幕。</p>
</li>
<li>
<p><strong>文明浩劫：</strong> 约2222年，社会矛盾激化引发全球核战，99%人类灭亡，地表生态系统被彻底摧毁。</p>
</li>
<li>
<p><strong>新世界基石：</strong> 苏棠建造的“琥珀居”作为末日堡垒幸存下来。其女儿顾雪利用堡内的先进科技（无人工厂、AI、机器人）收留难民，建立地下城网络，最终创立了超级政体“雪国”。</p>
</li>
<li>
<p><strong>时间线关键节点：</strong></p>
<ul>
<li>2137年：顾雪出生。</li>
<li>约2210年：苏棠与顾尘合葬。</li>
<li>2222年：全球核战爆发。</li>
<li>2367年：故事主线开始，顾雪230岁。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-4">三、 核心科幻设定</h4>
<ol>
<li>
<p><strong>琥珀居：</strong> 从“末日堡垒”演变为全球地下城交通网络的“核心节点”，是雪国权力的物理与技术象征。</p>
</li>
<li>
<p><strong>备用肉身虫：</strong> 核后时代的关键保命技术，已从精英专属发展为全民普及的基础技术，使雪国公民身体不再衰老，但大脑仍会自然死亡。</p>
</li>
<li>
<p><strong>“左脚踩右脚”续命技术：</strong></p>
<ul>
<li><strong>原理：</strong> 当大脑衰老时，交替切除并重新生长“优势半球”与“非优势半球”，实现肉体层面的永生。</li>
<li><strong>代价：</strong> 每次切除一个半球，会随机丢失50%的记忆与人格。这是一种“半自杀”，意味着每次操作都是一次部分意义上的“死亡”与“重生”。</li>
<li><strong>权限：</strong> 技术被顾雪严格管控，未向全民开放。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-5">四、 主角与家族结构</h4>
<ol>
<li>
<p><strong>顾雪（雪王）：</strong></p>
<ul>
<li><strong>身份：</strong> 雪国的最高统治者，230岁，已更换4次“优势半球”。</li>
<li><strong>统治理念：</strong> “仁慈的独裁者”，为人类存续不惜成为必要的“恶人”。</li>
<li><strong>个人生活：</strong> 不同于母亲的一生一世一双人，她每20年更换一位不超过30岁的“小男友”，并育有一女。此举既是个人选择，也构成了其统治结构的一部分。</li>
</ul>
</li>
<li>
<p><strong>“女儿等差数列”家族：</strong></p>
<ul>
<li><strong>结构：</strong> 顾雪的10个女儿，年龄呈完美的等差数列（相差20岁），构成雪国核心的权力继承与管理体系。</li>
<li><strong>名单（2367年）：</strong>
<ul>
<li>赤•雪 (190岁), 橙•雪 (170岁), 黄•雪 (150岁), 绿•雪 (130岁), 青•雪 (110岁)</li>
<li>蓝•雪 (90岁), 紫•雪 (70岁), 粉•雪 (50岁), 墨•雪 (30岁), 白•雪 (10岁)</li>
</ul>
</li>
<li><strong>命名规则：</strong> 后代以“[新名]•[母亲名]”的形式命名，形成清晰的母系家族谱系。</li>
<li><strong>传承：</strong> 大部分女儿模仿母亲，每20年生育一女，使“雪”家族枝繁叶茂，成为雪国的统治阶层。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-6">五、 社会与政治结构</h4>
<ol>
<li>
<p><strong>政体：</strong> 高度中央集权的独裁统治。顾雪作为雪王“与国同寿”，永久执政，以确保稳定。</p>
</li>
<li>
<p><strong>经济：</strong> 国家分配工作，消灭失业。AI与机器人承担重复劳动，人类专注于“创造性劳动”，推动科技爆炸式发展。</p>
</li>
<li>
<p><strong>民生：</strong> 全民享受基础肉身虫技术，医疗成本低廉，基本生活得到保障。</p>
</li>
<li>
<p><strong>星际扩张计划：</strong></p>
<ul>
<li><strong>当前阶段（主线）：</strong> 载人登陆火星的关键时期，月球基地已成熟。</li>
<li><strong>统治模式：</strong> “分星球设王”，顾雪为“地王”（地球），其女儿分别任“月王”与“火王”，形成“一光秒不容二王”的星际封建体系。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-7">六、 未来剧情展望</h4>
<ul>
<li>
<p><strong>主线剧情：</strong> 故事始于火星殖民的关键节点，核心冲突可能围绕星际殖民的挑战、雪国内部的政治矛盾、以及“左脚踩右脚”技术带来的伦理困境展开。</p>
</li>
<li>
<p><strong>后续剧情（第三部）：</strong> 顾雪520岁时，将带领“希望舰队”前往数百光年外的“第二地球”。她把地球（雪国）交给300岁的小女儿白•雪，自己则带着9位“小男友”踏上长达数万年的深空航行，践行“旧蜂王离巢”的终极传承。</p>
</li>
</ul>
<h3 data-id="heading-8">第二部分：计划分析</h3>
<p>这份小说计划构建了一个极具深度和潜力的科幻世界，其亮点和可探讨的方向都非常突出。</p>
<h4 data-id="heading-9">一、 主题深度与核心冲突</h4>
<ol>
<li>
<p><strong>生存与人性的终极博弈：</strong> 这是整个计划的灵魂。“左脚踩右脚”技术是神来之笔，它将“永生”的诱惑与“自我消亡”的恐惧直接捆绑。<strong>“为了多活几年，你愿意杀死50%的自己嘛？”</strong> 这个问题直击存在主义的核心。主角顾雪的每一次续命，都是一次对“我是谁”的重新定义，她的记忆残缺、人格变迁将成为故事最深刻的内在冲突。</p>
</li>
<li>
<p><strong>集权与自由的永恒命题：</strong> 雪国是一个典型的“功利主义乌托邦”。为了人类文明的存续和繁荣，个人自由、政治权利被置于次要位置。顾雪的“仁慈独裁”带来了稳定与进步，但这种模式是否正当？那些被分配了不喜欢工作的人、那些渴望自然死亡的人、那些“叛逆”的女儿，他们的存在本身就是对这种体制的诘问。这为故事提供了丰富的社会与政治冲突来源。</p>
</li>
<li>
<p><strong>传承与告别的宏大叙事：</strong> 从苏棠“一生一世一双人”的浪漫主义，到顾雪“为人类繁衍”的史诗主义，是两种截然不同的价值观。顾雪的最终选择——带领舰队离开，将家园留给后代——是一种超越个人情感的、近乎神话的“告别”。她如同蜂后，完成使命后带领一部分族群开拓新世界，这种宏大的责任感与牺牲精神，赋予了故事极强的史诗感。</p>
</li>
</ol>
<h4 data-id="heading-10">二、 设定亮点与优势</h4>
<ol>
<li>
<p><strong>“女儿等差数列”：</strong> 这是整个世界观中最具创意和辨识度的设定。它不仅仅是一个有趣的家族结构，更是一个精妙的政治架构。每一代女儿年龄差固定，意味着权力交接、人才梯队、社会分工都有条不紊。这个设定本身就蕴含了无数故事：姐妹间的竞争与合作、不同代际观念的冲突、以及“叛逆者”对整个系统的挑战。</p>
</li>
<li>
<p><strong>科幻设定的递进与演化：</strong> “肉身虫”技术在续作中从“奢侈品”变为“必需品”，逻辑清晰，符合社会发展的脉络。而“左脚踩右脚”作为升级版技术，其代价（记忆丢失）远比收益（肉体永生）更具戏剧张力，为科幻探讨提供了绝佳的载体。</p>
</li>
<li>
<p><strong>宏大的时间与空间尺度：</strong> 故事跨越数百年，从地球延伸至火星，再到数百光年外的深空。这种宏大的尺度使得作者可以探讨文明、种族、命运等终极命题，而不仅仅是个人恩怨。它让《地下城与核后白雪》有了成为“太空歌剧”级作品的潜力。</p>
</li>
</ol>
<h4 data-id="heading-11">三、 潜在的挑战与可探讨的方向</h4>
<ol>
<li>
<p><strong>主角“人性”的维系：</strong> 顾雪经历了4次大脑半球切除，她丢失了哪些记忆？她对父母苏棠和顾尘的记忆还剩下多少？她的“爱”与“仁慈”是源于本能，还是残存的程序？如果她的人格已经面目全非，她统治的合法性又在哪里？深入挖掘顾雪的内心世界，将是故事成功的关键。她可能是一个孤独的“神”，不断用新的爱情和女儿来填补记忆空洞，却永远无法找回最初的自己。</p>
</li>
<li>
<p><strong>社会内部的矛盾具象化：</strong> 计划中提到了“叛逆”的女儿，这是一个极佳的切入点。可以塑造一个不认同母亲价值观、追求个人自由、甚至试图颠覆体制的女儿作为主角的对立面或另一条故事线。同样，那些“小男友”们也绝非简单的生育工具，他们的视角、他们的情感、他们对这位“雪王”的真实看法，可以为故事提供更多元的维度。</p>
</li>
<li>
<p><strong>主线剧情的驱动力：</strong> 目前计划的重点在于世界观构建，主线剧情（火星殖民）的驱动力稍显模糊。需要设置一个强有力的核心冲突来推动故事。例如：</p>
<ul>
<li><strong>外部威胁：</strong> 火星上发现了意想不到的危机（生态灾难、未知病毒、甚至原生智慧生物）。</li>
<li><strong>内部分裂：</strong> 雪国内部出现反对派，认为顾雪的独裁和星际计划是人类的歧途，试图在地球发动政变。</li>
<li><strong>技术伦理危机：</strong> “左脚踩右脚”技术出现意外，或者有女儿试图破解并滥用该技术，引发灾难。</li>
</ul>
</li>
</ol>
<p><strong>总结：</strong>
这份续作计划野心勃勃，构建了一个坚实、新颖且充满哲学思辨的科幻世界。它成功地将一个浪漫的爱情故事，升华为一曲关于文明存续、人性抉择和宇宙探索的宏大史诗。 <strong>“女儿等差数列”</strong> 和 <strong>“左脚踩右脚”</strong> 是两大核心创意，具备极强的吸引力。</p>
<p>接下来的关键在于，如何将这些宏大的设定和深刻的主题，落实到具体的人物塑造和情节冲突上。只要能写活顾雪这位“非人”的统治者，并围绕她构建起有力的矛盾冲突，这部作品极有潜力成为一部杰出的科幻长篇。</p>
<hr/>
<p>以上内容由AI生成，仅供参考和借鉴</p>
<h2 data-id="heading-12">deepseek</h2>
<p>好的，我已经仔细阅读并理解了您提供的这部科幻小说的续作计划。以下是我对主要内容的重新组织和分析。</p>
<h3 data-id="heading-13">一、 主要内容重组</h3>
<p>续作《地下城与核后白雪》是一个宏大的科幻史诗，其核心内容可以重组为以下几个层面：</p>
<p><strong>1. 时代与背景</strong></p>
<p>· 时间：24世纪（主线始于2367年），全球核大战百年之后。</p>
<p>· 环境：地表因无休止的核战而充满辐射，无法居住。幸存人类生活在庞大的“地下城”网络中。</p>
<p>· 前情：第一部的主角苏棠和顾尘自然老去、合葬。此后社会崩溃，核战爆发，99%人类死亡。他们的女儿顾雪利用母亲留下的“琥珀居”（一个先进的末日堡垒）收留难民，建立了地下国度——“雪国”。</p>
<p><strong>2. 核心人物：顾雪（雪王）</strong></p>
<p>· 身份：苏棠与顾尘之女，雪国的创建者与最高统治者（“仁慈的独裁者”）。</p>
<p>· 年龄与永生：主线开始时已230岁。她通过发展“肉身虫”技术，采用“左脚踩右脚”式续命术——交替切除并再生大脑的“非优势半球”与“优势半球”，以此保持肉体不灭，但代价是每次会随机丢失50%的记忆。她已更换至“第4代优势半球”。</p>
<p>· 统治模式：个人永续统治（“与国同寿”），没有换届。利用AI和机器人技术解放人力，激励“创造性劳动”，推动科技飞速发展，目标是带领人类成为星际文明。</p>
<p>· 家庭与情感：未延续父母“一生一世一双人”的模式，而是每20年更换一位年轻男友并生育一个女儿。共有10个女儿，年龄呈等差数列（从190岁到10岁），形成了独特的家族谱系和命名规则（女儿的名以母亲的名作为第二部分）。</p>
<p><strong>3. 雪国社会与科技</strong></p>
<p>· 政治：中央集权，国家分配工作，消灭失业，保障基本生活。</p>
<p>· 科技：
· 基础肉身虫技术：全民普及，可实现身体年轻化。
· “左脚踩右脚”技术：严格管控，为雪王专属的永生手段。
· 星际探索：已建立成熟的月球基地，正处于载人登陆火星的关键节点，并规划“飞出太阳系”计划。</p>
<p>· 疆域统治：采用“分星球设王统治”模式。顾雪为统治地球的“地王”，其部分女儿分别担任“月王”、“火王”等。</p>
<p><strong>4. 核心科幻设定</strong></p>
<p>· 琥珀居：雪国的发源地和全球地下网络的核心节点。</p>
<p>· 备用肉身虫：核后世界保命与深空旅行解决寿命问题的关键技术。</p>
<p>· “左脚踩右脚”续命技术：以牺牲50%的记忆和人格为代价，换取肉体不灭的残酷永生术。</p>
<p>· 地下城：核战后的主要人类栖息地。</p>
<p><strong>5. 未来伏笔（第三部）</strong></p>
<p>· 顾雪在520岁时，将雪国（地球）统治权交给小女儿白·雪，自己则带领9位小男友，乘坐“希望舰队”前往数百光年外的“第二地球”，开启长达数万年的星际远航。</p>
<h3 data-id="heading-14">二、 计划分析</h3>
<p>此续作计划展现了一个从微观爱情故事到宏观文明史诗的惊人跃迁，构建了一个深度、黑暗且逻辑自洽的科幻世界。</p>
<p><strong>1. 主题的深化与转向</strong></p>
<p>· 从第一部聚焦于个体间的爱情、信任与科技伦理，转向探讨文明存续、永生代价、权力本质与人类未来等更宏大的主题。</p>
<p>· “永生”不再是简单的祝福，而是伴随着巨大代价（记忆丢失）和伦理困境（50%的自我消亡）的残酷选择，这为顾雪的人物塑造增添了深刻的悲剧性和复杂性。</p>
<p><strong>2. 世界构建的亮点</strong></p>
<p>· 历史逻辑：核战的起因（社会矛盾总爆发）与结束的原因（地下城使核弹无效）构成了一个合理且令人信服的因果链。</p>
<p>· 科技社会学：科技不仅作为设定存在，更深度塑造了社会结构。AI和机器人改变了经济基础（解放重复劳动），永生技术固化了政治上层建筑（雪王的永久统治），形成了独特的“雪国模式”。</p>
<p>· 文明出路：将地下求生的绝望与星际远航的希望相结合，为故事提供了明确且富有吸引力的终极目标。</p>
<p><strong>3. 人物塑造的巧妙与颠覆</strong></p>
<p>· 顾雪：她是对其母亲苏棠的继承与颠覆。她继承了苏棠的智慧、果断和对年轻纯粹情感的偏好，但发展出了截然不同的世界观和统治手段。她的“仁慈独裁”和情感模式，反映了一个在末日背景下背负文明存续重任的统治者，其人性在漫长岁月中的异化与选择。</p>
<p>· 家族设计：“女儿等差数列”和命名规则不仅是一个有趣的数学设定，更形象地展现了顾雪漫长的生命、其家族在雪国中的核心地位，以及一种近乎“母系王朝”的权力结构。这为故事提供了丰富的潜在角色和矛盾点。</p>
<p><strong>4. 核心设定的哲学思辨</strong></p>
<p>· “左脚踩右脚”技术：是整个故事最核心的哲学引擎。它直击“我是谁？”的根本问题。当记忆和人格可以被随意裁剪，连续的“自我”还是否存在？顾雪在230年后，在丢失了无数记忆后，本质上还是苏棠和顾尘的那个女儿吗？这种设定为探讨身份认同、记忆与人格的关系提供了绝佳的舞台。</p>
<p>· 永生的统治者：顾雪的“与国同寿”统治模式，是对人类政治周期律的一种科幻解构。它带来了极致的稳定和长远规划的能力（如星际航行），但也埋下了独裁、僵化和“蜂王思维”的隐患。</p>
<p><strong>5. 潜在的戏剧冲突</strong></p>
<p>· 内部：记忆丢失导致的人格不确定性、女儿们（尤其是年长的女儿）对权力和母亲决策的不同想法、民众对永世独裁的潜在不满。</p>
<p>· 外部：星际探索的巨大风险、可能存在的其他地下势力或外星威胁。</p>
<p>· 伦理：为了文明存续，个体的牺牲（如记忆、自由选择）是否正当？“雪国模式”是否是人类的唯一出路？</p>
<p>总结：</p>
<p>这份续作计划非常出色，它成功地将一个浪漫的科幻爱情故事，升华为一个关于文明、永生与权力的黑暗史诗。其世界观宏大而细致，科幻设定不仅新颖，更承载了深刻的哲学思考。主角顾雪是一个极具魅力和复杂性的“仁慈独裁者”形象，她的选择和命运将是驱动整个故事的核心。整个计划为一部波澜壮阔的太空歌剧奠定了坚实的基础。</p>
<h2 data-id="heading-15">豆包</h2>
<h3 data-id="heading-16">一、核心内容重组（清晰梳理逻辑脉络）</h3>
<h4 data-id="heading-17">（一）基础设定（贯穿续作核心）</h4>
<p><strong>1. 世界观承接</strong>：前作（22世纪资本主义晚期）→ 续作（24世纪核战后），2222年全球核战导致99%人类死亡，琥珀居（前作苏棠的末日堡垒）成为雪国地下城核心节点。</p>
<p><strong>2. 核心人物</strong>：主角顾雪（苏棠&amp;顾尘之女，雪国独裁统治者“雪王”），2137年出生，2367年主线开启时230岁，已迭代至第4代优势半球（靠“左脚踩右脚”续命）。</p>
<p><strong>3. 关键科幻技术</strong>：</p>
<ul>
<li>备用肉身虫（前作延续，核战后成为保命核心，基础版全民普及）；</li>
<li>“左脚踩右脚”续命术（顾雪研发，半自杀式切脑再生，记忆随机丢失50%，严格管控）；</li>
<li>成熟AI+机器人技术（解放人类重复劳动，支撑雪国科技爆发）。</li>
</ul>
<p><strong>4. 家族设定</strong>：</p>
<ul>
<li>生育规则：顾雪每20年换1位年轻小男友（≤30岁），生1个女儿，10个女儿构成年龄等差数列（190岁-10岁）；女儿们多模仿此模式，形成“女儿等差数列”；</li>
<li>命名规则：人名第二部分为母亲之名（如赤•雪的女儿叫?•赤）。</li>
</ul>
<h4 data-id="heading-18">（二）故事主线（2367年开启）</h4>
<p><strong>1. 雪国现状</strong>：顾雪建立的中央集权国家，以“国家分配工作”模式消灭失业、普及基础福利，是地球最大国家；顾雪为“仁慈的独裁者”，“与国同寿”维持统治，无接班人。</p>
<p><strong>2. 核心目标</strong>：避免人类灭绝，推动人类迈入星际文明——月球基地成熟，载人登陆火星进入关键期，“飞出太阳系”计划立项。</p>
<p><strong>3. 统治架构</strong>：顾雪任“地王”（统治地球），2个女儿分别任“月王”“火王”，采用“分星球设王”模式。</p>
<h4 data-id="heading-19">（三）前情与后续铺垫</h4>
<p><strong>1. 前情（非主线）</strong>：苏棠&amp;顾尘未再使用肉身虫，携手老去合葬（约2210年）；核战后顾雪依托琥珀居的实验室、工厂，建地下城收留难民，建立雪国并发展肉身虫技术。</p>
<p><strong>2. 后续（第3部）</strong>：顾雪520岁时，“希望舰队”建成，她将地球雪国交给300岁的白•雪，带领9位小男友乘坐舰队离开太阳系，前往数百光年外的第二地球（肉身虫、续命术为深空旅行关键）。</p>
<h3 data-id="heading-20">二、核心分析（深度拆解设定与剧情逻辑）</h3>
<h4 data-id="heading-21">（一）设定亮点：科幻与人文的强绑定</h4>
<p><strong>1. 续命技术的哲思内核</strong>：“左脚踩右脚”技术是核心冲突点——以“杀死50%的自己”（丢失记忆、人格残缺）换取肉体不灭，本质是“永生与自我的博弈”，既强化科幻感，又抛出核心命题：“失去记忆的永生，是否还是真正的活着？”；同时区分“基础肉身虫（全民普及）”与“续命术（严格管控）”，形成“全民年轻vs少数永生”的阶层差异，埋下社会矛盾伏笔。</p>
<p><strong>2. 世界观的闭环与延伸</strong>：前作“资本主义晚期的畸形社会”（导致苏棠被伤害、社会矛盾爆发），直接铺垫续作“核战爆发”的结局；顾雪的中央集权模式，是对前作资本主义崩溃的反向规避，形成“问题-反思-解决方案”的世界观闭环；而“星际移民”的设定，将格局从“地球生存”提升至“人类存续”，为故事提供广阔延伸空间。</p>
<p><strong>3. 家族设定的隐喻性</strong>：“女儿等差数列”“母系命名规则”，打破传统父系叙事，凸显女性在末日重建、文明延续中的核心作用（从苏棠到顾雪，再到女儿们）；顾雪“每20年换小男友”的设定，既是对母亲苏棠“偏爱年轻纯粹者”的传承，也是她“拒绝一生一世一双人”的自我保护（首任男友去世的创伤），赋予人物复杂的情感底色。</p>
<h4 data-id="heading-22">（二）剧情逻辑：优势与潜在冲突</h4>
<p><strong>1. 核心优势</strong>：</p>
<ul>
<li>
<p><strong>人物弧光的延续与突破</strong>：前作苏棠&amp;顾尘的“浪漫爱情”，与续作顾雪的“孤独独裁”形成对比——苏棠用技术追求爱情与新生，顾雪用技术维系统治与文明，两代人对“肉身虫技术”的不同使用，折射出“个人选择”与“文明责任”的差异；顾雪“仁慈与冷酷并存”的特质（为人类未来做“恶人”、普及福利却垄断永生），让角色摆脱扁平，更具张力。</p>
</li>
<li>
<p><strong>剧情节奏的层次感</strong>：主线（星际移民）+ 支线（家族内部矛盾：叛逆女儿的反抗、女儿们对统治权的潜在觊觎）+ 哲思线（永生、独裁与自由、文明延续的代价），三线并行，既有人类迈向星际的宏大叙事，也有家族内部的细腻情感，兼顾格局与温度。</p>
</li>
<li>
<p><strong>设定的实用性</strong>：琥珀居作为“地下城核心”、AI+机器人支撑社会运转、肉身虫技术适配深空旅行，所有科幻设定均服务于“核后生存”“星际移民”的核心剧情，无冗余设定，逻辑自洽。</p>
</li>
</ul>
<p><strong>2. 潜在冲突与可挖掘点</strong>：</p>
<ul>
<li>
<p><strong>独裁统治的隐患</strong>：顾雪“与国同寿”的永久统治，虽暂时维持稳定，但“无接班人”的设定的的的，可能引发女儿们（尤其是年长的赤•雪、橙•雪）对统治权的争夺；同时，“国家分配工作”“管控续命术”可能引发部分民众对“自由”的诉求，形成“集体利益vs个人自由”的冲突。</p>
</li>
<li>
<p><strong>记忆丢失的剧情漏洞</strong>：顾雪多次切脑再生，随机丢失50%记忆，却仍能维持“强大雪王”的人格与统治力，需补充设定（如记忆备份技术、核心人格记忆优先保留），避免逻辑矛盾；此外，女儿们若使用续命术，也会面临记忆丢失的问题，可延伸为家族内部“记忆传承”的冲突。</p>
</li>
<li>
<p><strong>星际移民的未知风险</strong>：剧情仅铺垫“载人登火星”“飞出太阳系”的计划，但未提及星际旅行中的具体危机（如宇宙辐射、外星文明、技术故障），以及不同星球（月球、火星）的统治矛盾（月王、火王与地王顾雪的权力制衡），可作为主线剧情的核心冲突点。</p>
</li>
</ul>
<h4 data-id="heading-23">（三）主题升华：末日与新生的内核</h4>
<p>续作以“核战后人类存续”为核心，升华了前作“爱情与技术”的主题，聚焦三大核心命题：</p>
<p><strong>1. 文明延续的代价</strong>：为避免人类灭绝，顾雪放弃“自由民主”，选择独裁统治；人类为实现星际移民，依赖“半自杀式”续命技术，凸显“文明存续”往往需要牺牲个体自由、甚至自我的残酷现实。</p>
<p><strong>2. 技术的双面性</strong>：肉身虫技术既是核战后人类的“保命符”，也是顾雪维持独裁的“工具”；AI+机器人技术解放人类，却也可能导致人类“丧失劳动能力”，探讨技术“造福人类”与“异化人类”的双重属性。</p>
<p><strong>3. 传承与突破</strong>：顾雪传承了母亲的技术天赋、对年轻纯粹者的偏爱，也突破了母亲“一生一世一双人”的情感模式，从“个人爱情”走向“文明责任”；雪国的发展，既是对前作资本主义社会的反思，也是人类在末日中“打破循环、寻求新生”的尝试。</p>
<h3 data-id="heading-24">三、总结</h3>
<p>该续作计划世界观完整、设定硬核、人物立体，既紧密承接前作的人物与科幻核心，又通过“核战后”“星际移民”的设定实现格局升级，将“技术、爱情、权力、文明”四大元素深度绑定，兼具科幻感与人文深度。核心优势在于“科幻设定服务剧情”“人物特质贴合时代背景”，潜在突破点在于挖掘独裁统治、记忆丢失、星际旅行中的冲突，让“人类从末日走向星际”的主线更具张力。</p>
<p>需要我帮你基于这份分析，提炼10个核心剧情冲突点（适配长篇100+章的叙事节奏），直接用于后续章节创作吗？</p>
<h2 data-id="heading-25">FAQ</h2>
<h3 data-id="heading-26">问: 雪王为什么只生女儿 ?</h3>
<p>答: 因为 "备用肉身虫" 会让全身进入一种类似 "怀孕" 的状态, 女儿的副作用更小.</p>
<h3 data-id="heading-27">问: 雪王的女儿的女儿的女儿的女儿的女儿的女儿叫什么名字 ?</h3>
<p>答: <strong>水•滴</strong> (全名: <strong>水•滴•汽•炽•焰•赤•雪</strong>
(其母: <strong>滴•汽•炽•焰•赤•雪</strong> (其母: <strong>汽•炽•焰•赤•雪</strong> (其母: <strong>炽•焰•赤•雪</strong> (其母: <strong>焰•赤•雪</strong> (其母: <strong>赤•雪</strong> (其母: <strong>顾雪</strong>)))))))</p>
<h3 data-id="heading-28">问: 雪王为什么每 20 年更换 (不超过 30 岁) 小男友 ?</h3>
<p>答: 为了配合 "肉身虫" 周期. 每 20 年, 顾雪更换外观 20 岁的年轻新身体, 并更换小男友. 生下女儿后, 一起自然衰老到 40 岁, 再开启下个周期.</p>
<h3 data-id="heading-29">问: 雪王的小男友最后都去哪了？</h3>
<p>答: 不是用完就丢！他们会被纳入「雪王专属智囊团」，20年任期结束后，要么去月球基地当星际移民顾问，要么退休领终身福利，是核后时代“带薪恋爱+带薪育儿”的天花板，比内卷打工人幸福多了。</p>
<h3 data-id="heading-30">问: 雪王经过多次 "50% 记忆人格随机丢失", 为何仍能维持稳定统治 ?</h3>
<p>答: 顾雪有一个最信赖的姐姐 (好友, 无血缘关系) 凌霜 (也是母亲苏棠的旧友). 凌霜负责保管顾雪的重要记忆, 帮她进行恢复, 稳定人格.</p>
<h3 data-id="heading-31">问: 雪国为什么全力投入星际移民，不先修复地球？</h3>
<p>答: 地球表面已经在核战中彻底损毁, 辐射水平百年未降, 且仍有再次核战的风险, 人类在地球始终面临灭绝危机. 星际移民才是人类延续的唯一出路.</p>
<h3 data-id="heading-32">问: 作者在这个小说中处于什么位置, "扮演" 哪个角色 ?</h3>
<p>答: 早在 2222 年就随 99% 人类去了异世界, 现在是幽灵形态 (笑</p>
<h3 data-id="heading-33">问: 第三部顾雪带 9 位小男友去第二地球，为什么不带上女儿们一起开拓新世界？</h3>
<p>答: 是雪国的「旧蜂王离巢法则」——把成熟的家园留给后代，自己带着“火种团”去闯未知，既不抢女儿们的统治权，也避免宇宙深处的未知风险连累雪国根基，顺便带男友们实现“公费星际旅行”（不是）</p>
<h2 data-id="heading-34">附录 1 雪王家族部分人名列表 (草案)</h2>
<p>(清言)</p>
<h3 data-id="heading-35">第 1 代</h3>
<p>顾雪</p>
<h3 data-id="heading-36">第 2 代</h3>
<p>赤•雪</p>
<p>橙•雪</p>
<p>黄•雪</p>
<p>绿•雪</p>
<p>青•雪</p>
<p>蓝•雪</p>
<p>紫•雪</p>
<p>粉•雪</p>
<p>墨•雪</p>
<p>白•雪</p>
<h3 data-id="heading-37">第 3 代</h3>
<p>焰•赤•雪</p>
<p>曦•赤•雪</p>
<p>灼•赤•雪</p>
<p>烬•赤•雪</p>
<p>炎•赤•雪</p>
<p>晶•橙•雪</p>
<p>瑶•橙•雪</p>
<p>璃•橙•雪</p>
<p>珀•橙•雪</p>
<p>琅•橙•雪</p>
<p>金•黄•雪</p>
<p>钗•黄•雪</p>
<p>钿•黄•雪</p>
<p>铃•黄•雪</p>
<p>镜•黄•雪</p>
<p>芽•绿•雪</p>
<p>茉•绿•雪</p>
<p>蕊•绿•雪</p>
<p>薇•绿•雪</p>
<p>藤•绿•雪</p>
<p>穹•青•雪</p>
<p>霄•青•雪</p>
<p>霖•青•雪</p>
<p>岚•青•雪</p>
<p>汐•蓝•雪</p>
<p>涟•蓝•雪</p>
<p>沛•蓝•雪</p>
<p>星•紫•雪</p>
<p>月•紫•雪</p>
<p>芙•粉•雪</p>
<h3 data-id="heading-38">第 4 代</h3>
<p>燃•焰•赤•雪</p>
<p>辉•焰•赤•雪</p>
<p>煌•焰•赤•雪</p>
<p>熠•焰•赤•雪</p>
<p>炽•焰•赤•雪</p>
<p>昭•曦•赤•雪</p>
<p>明•曦•赤•雪</p>
<p>晓•曦•赤•雪</p>
<p>旦•曦•赤•雪</p>
<p>烁•灼•赤•雪</p>
<p>烫•灼•赤•雪</p>
<p>融•灼•赤•雪</p>
<p>灰•烬•赤•雪</p>
<p>烟•烬•赤•雪</p>
<p>焚•炎•赤•雪</p>
<p>瑰•晶•橙•雪</p>
<p>翠•晶•橙•雪</p>
<p>琢•晶•橙•雪</p>
<p>磐•晶•橙•雪</p>
<p>碧•瑶•橙•雪</p>
<p>琪•瑶•橙•雪</p>
<p>瑜•瑶•橙•雪</p>
<p>瓷•璃•橙•雪</p>
<p>釉•璃•橙•雪</p>
<p>瑚•珀•橙•雪</p>
<p>玥•琅•橙•雪</p>
<p>铂•金•黄•雪</p>
<p>银•金•黄•雪</p>
<p>锖•金•黄•雪</p>
<p>环•钗•黄•雪</p>
<p>璎•钗•黄•雪</p>
<p>锁•钿•黄•雪</p>
<p>钟•铃•黄•雪</p>
<p>苗•芽•绿•雪</p>
<p>芯•芽•绿•雪</p>
<p>蕙•茉•绿•雪</p>
<p>萼•蕊•绿•雪</p>
<p>宇•穹•青•雪</p>
<p>霓•霄•青•雪</p>
<p>浪•汐•蓝•雪</p>
<h3 data-id="heading-39">第 5 代</h3>
<p>焚•燃•焰•赤•雪</p>
<p>灭•燃•焰•赤•雪</p>
<p>寂•燃•焰•赤•雪</p>
<p>望•辉•焰•赤•雪</p>
<p>瞩•辉•焰•赤•雪</p>
<p>示•昭•曦•赤•雪</p>
<p>彰•昭•曦•赤•雪</p>
<p>脆•瑰•晶•橙•雪</p>
<p>坚•瑰•晶•橙•雪</p>
<p>穗•苗•芽•绿•雪</p>
<h3 data-id="heading-40">第 6 代</h3>
<p>空•焚•燃•焰•赤•雪</p>
<p>恸•灭•燃•焰•赤•雪</p>
<p>尘•望•辉•焰•赤•雪</p>
<p>符•脆•瑰•晶•橙•雪</p>
<h3 data-id="heading-41">第 7 代</h3>
<p>无•空•焚•燃•焰•赤•雪</p>
<hr/>
<p>以上内容由AI生成，仅供参考和借鉴</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1b69c5ce72d4e77811a11dbe94d8872~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765029700&amp;x-signature=aEKIITJGnnhxEPQkdZkOX%2F09Zpw%3D" alt="0-1.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Google 发布 Antigravity Agent编辑器]]></title>    <link>https://juejin.cn/post/7577647745110310912</link>    <guid>https://juejin.cn/post/7577647745110310912</guid>    <pubDate>2025-11-29T12:01:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577647745110310912" data-draft-id="7576378563545743412" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Google 发布 Antigravity Agent编辑器"/> <meta itemprop="keywords" content="AIGC,Google"/> <meta itemprop="datePublished" content="2025-11-29T12:01:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小溪彼岸"/> <meta itemprop="url" content="https://juejin.cn/user/976781670357400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Google 发布 Antigravity Agent编辑器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976781670357400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小溪彼岸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T12:01:36.000Z" title="Sat Nov 29 2025 12:01:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>2025年11月19日随着Google发布Gemini 3 Pro模型一并上线了Antigravity Agent IDE，在Antigravity中已默认支持使用 Gemini 3 Pro相关模型，对AI编辑器感兴趣的小伙伴可以看往期内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493624%26idx%3D1%26sn%3D7da2b04af474497f84cd3012a4ae1969%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493624&amp;idx=1&amp;sn=7da2b04af474497f84cd3012a4ae1969&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">盘点放弃Cursor期间发布的新特性，我再次心动了</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247486531%26idx%3D1%26sn%3Dc394cf2369eb9c97d0b4a058542dbbd9%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247486531&amp;idx=1&amp;sn=c394cf2369eb9c97d0b4a058542dbbd9&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">抢先体验字节AI编辑器Trae</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247491843%26idx%3D1%26sn%3D9042479ff0f8e9699e6dae60176665c8%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247491843&amp;idx=1&amp;sn=9042479ff0f8e9699e6dae60176665c8&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">当下最有可能取代Cursor的AI编辑器Kiro初体验</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492083%26idx%3D1%26sn%3D93eb18056cb7bddcb1cacdb875e33f3b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492083&amp;idx=1&amp;sn=93eb18056cb7bddcb1cacdb875e33f3b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">腾讯首个全栈AI编辑器CodeBuddy</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493909%26idx%3D1%26sn%3Dacf8b16b73f1bd03377bb2c8922a3d3a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493909&amp;idx=1&amp;sn=acf8b16b73f1bd03377bb2c8922a3d3a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">初识Verdent AI</a></li>
</ul>
<h2 data-id="heading-1">当前使用版本</h2>
<p>Antigravity Version: 1.11.2</p>
<h2 data-id="heading-2">优势</h2>
<ul>
<li>支持macOS、Windows、Linux多平台</li>
<li>免费预览阶段，可以免费使用</li>
</ul>
<h2 data-id="heading-3">限制</h2>
<ul>
<li>macOS最低支持 12(Monterey)</li>
<li>Windows最低支持 Windows 10（64 位）</li>
<li>Linux最低支持 Ubuntu 20、Debian 10、Fedora 36、RHEL 8等</li>
<li>需要使用Google 账号登录授权</li>
<li>需要科学上网环境</li>
<li>Gemini 3 Pro（high）模型每天有使用额度限制，每5小时刷新一次</li>
<li>有使用区域限制</li>
</ul>
<h2 data-id="heading-4">简介</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1c03687d080487cb4086882ba230799~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=qofGf8hnp8FdqfskRBjA3f4uhYk%3D" alt="图片" loading="lazy"/></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fantigravity.google%2F" target="_blank" title="https://antigravity.google/" ref="nofollow noopener noreferrer">antigravity.google/</a></p>
<h2 data-id="heading-5">安装配置</h2>
<p>官方下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fantigravity.google%2Fdownload" target="_blank" title="https://antigravity.google/download" ref="nofollow noopener noreferrer">antigravity.google/download</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/879854ef0b404b569d7ecfb85d48ed6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=gkp8VCKGJzPD8NZ4UdrYlo0mEZg%3D" alt="图片" loading="lazy"/></p>
<p>根据安装限制提示，选择自己系统对应的版本下载安装包，安装成功后打开Antigravity界面如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8846de7085a04d998934b412683d3f1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=bkT%2BMETIHh3KHnRFFbhiFOPfkwQ%3D" alt="图片" loading="lazy"/></p>
<p>点击【Next】继续，可以选择【Start fresh】继续，也可以选择从VS Code或者Cursor导入插件（据说当前版本导入有问题）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be60192bb5c54da598cbc119df847501~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=Vi593au4%2BEIFgo3S6ntGePO6%2B0U%3D" alt="图片" loading="lazy"/></p>
<p>点击【Next】继续，选择一个编辑器主题，选择自己喜欢的即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dff51dca23c4aa6945496c23a0c87b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=3fLwZVbIgRZHzIDas0ZrViidyKk%3D" alt="图片" loading="lazy"/></p>
<p>点击【Next】继续，这一步为配置Antigravity Agent使用方式</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb715991311f41ebb7f86c280bb49bc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=Bb4ReNQrdC3g4kvq%2Bmf1ewxbN%2FY%3D" alt="图片" loading="lazy"/></p>
<p>提供了4种模式：</p>
<ul>
<li>Agent-driven development：代理驱动开发，以 AI 代理为核心，开发者提出高层意图，代理负责拆分任务、制定计划、执行代码、运行测试等一系列工作</li>
<li>Agent-assisted development（推荐）：代理辅助开发，AI 代理起辅助作用，帮助开发者完成部分开发任务，开发者仍占据主导地位</li>
<li>Review-driven development：审核驱动的开发，侧重于对开发过程和结果的审核，开发者对权限和每一个关键变更进行把关，保证开发方向和结果的准确性</li>
<li>Custom configuration：自定义配置</li>
</ul>
<p>我这里使用默认推荐的配置，点击【Next】继续，进入编辑器配置</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d4b5fa24c9a45eb936415d013f4f8f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=HHsClUgTlTglobajJtI2hdD%2Fp7s%3D" alt="图片" loading="lazy"/></p>
<p>点击【Next】继续进入账号授权配置，点击【Sign in with Google】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c4049e97ee04ce7b6eb34c5982af3e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=%2Ft8e%2Fak6AAj4%2FJhm101iU3mNGPg%3D" alt="图片" loading="lazy"/></p>
<p>登录成功后，同意协议完成配置，配置完成即可进入编辑器界面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18c3690e771d4f6ba4a89d5619c41259~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=b1VvBKIjtj%2FZYvbVRwNTctJb%2BXE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-6">基本使用</h2>
<h3 data-id="heading-7">编辑器界面</h3>
<p>Antigravity IDE是基于VS Code魔改版（懂得都懂），使用过VS Code的小伙伴可以无缝衔接。当前Antigravity也提供了 Agent Manager、Open Brower、Antigravity Settings 等个性化功能</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52e2d8a78f1f482992e7103c3a78c730~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=FrJsD%2BCpaAxYuMF5X%2BnIloVsvd8%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7cb1e2a883a46d6aa8d304cf1f7ade3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=1ezedI35HRXFVP%2BXGl%2Bm4HL6xfE%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/289f82841adc4809955d51f2dd2a04cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=azOlHA%2BFM%2B7Cem9X2ALttEl1SZ0%3D" alt="图片" loading="lazy"/></p>
<p>在编辑器右下角，点击【<strong>Antigravity-Settings</strong>】可以快速开关 <strong>Agent</strong> 和 <strong>Tab</strong> 设置</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eed3c18f539348b2898c6453e761266a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=92thvp7u0Sr3DEc%2BRXXASm%2Fawdo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8">快捷键</h3>
<p>Antigravity IDE提供了一系列快捷键操作，这里以macOS为例展示：</p>
<ul>
<li>Cmd+L：打开Agent对话框</li>
<li>Cmd+I：打开内联对话框</li>
<li>Cmd+E：打开Agent管理</li>
<li>Shift+Cmd+L：打开Agent对话框，开启一个新的对话</li>
<li>⌥+Enter：Agent命令行请求权限时允许权限的快捷键，尝试没有效果</li>
<li>⌥+Backspace：Agent命令行请求权限时拒绝权限的快捷键</li>
<li>Cmd+Enter：命令行请求权限时允许权限的快捷键</li>
<li>Cmd+Backspace：命令行请求权限时拒绝权限的快捷键</li>
<li>Tab：代码补全建议</li>
<li>Escape：取消建议</li>
</ul>
<h3 data-id="heading-9">Chat对话</h3>
<p>Antigravity的聊天窗口还是比较简单的，和传统的对话窗口一样包含 上下文添加、对话模式选择 和 模型切换</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/660534c97b744c54ae999cd766348e07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=TTT45JBsME3V4VZoHweOH9dhKug%3D" alt="图片" loading="lazy"/></p>
<p>上下文内容可以上传 图片、工作区上下文 和 工作流，Mentions和 @ 快捷键操作一致，添加Workflows也可以使用 / 快捷键</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1371547548c8429dab250be2751ef3dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=AmL44EFp%2F2DnUk8bPCgVrsuR1hk%3D" alt="图片" loading="lazy"/></p>
<p>工作区上下文支持多种类型：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76eed16c79234627b6cea1eeb2df251b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=gjWtUi4d0MoT2btB%2BMQ8qeTA2aQ%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>Code Context Items：代码块</li>
<li>Files：文件</li>
<li>Directories：目录</li>
<li>MCP servers：MCP服务</li>
<li>Rules：提示词规则</li>
<li>Conversations：对话</li>
<li>Terminal：命令行终端</li>
</ul>
<p>添加代码块上下文只需选中代码块点击【Chat】或者使用快捷键【Cmd+L】即可将代码块添加到对话上下文</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37ede0b510fe42e593df8de9382fab57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=uZp1weNQhFSCPB7NMb3jHBkXPS8%3D" alt="图片" loading="lazy"/></p>
<p>使用快捷键 / 可快速添加Workflows</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34538a0c7aa4b8fbaa3d81b8cd72309~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=xcgBOAoZWCkEFeOo4n0u4YDUeOg%3D" alt="图片" loading="lazy"/></p>
<p>Antigravity目前支持 Planning 和 Fast 2种对话模式</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d67f270f58b44eeeabc7ce7d8534c69b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=%2BxNpklbKcl%2FSbyguvqm3krIEQsA%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>Planning：智能体可以在执行任务前进行规划，适用于深度研究、复杂任务或协作工作</li>
<li>Fast：智能体将直接执行任务，适用于可以更快完成的简单任务</li>
</ul>
<p>模型目前支持 Gemini 3 Pro (High)、Gemini 3 Pro (Low)、Claude Sonnet 4.5、Claude Sonnet 4.5 (Thinking)、GPT-OSS 120B (Medium)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56ce27d6884944c990d0a085a6ff302a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=x%2Be1hHwv9WtY%2BDatYCOwanTti9A%3D" alt="图片" loading="lazy"/></p>
<p>Antigravity同样支持内联对话，内联对话适合单文件的代码编辑，在文件编辑器中直接使用 Ctrl/Cmd+I 快捷键即可唤起内联对话窗口</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee59457aa90b450986af33510d4d4dc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=vY5DdbWvX30E7%2BCeHNIqXQz48i0%3D" alt="图片" loading="lazy"/></p>
<p>目前内联对话只能选择 Gemini 2.5 Flash 和 Gemini 3 Pro(Low)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ac63f38b54b40799417f37b417af23d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=yttAwHP48Kv5mSQaswhBOJceX9g%3D" alt="图片" loading="lazy"/></p>
<p>在对话框输入任意提示词即可进行聊天对话</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e10b9563e71d4abea0f5281abce05ad2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=gS2BzOpU7HxqUWYwtS9wdDUmNx8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-10">Agent Manager</h3>
<p>Agent Manager是Antigravity的亮点核心，在Antigravity 里，我们可以一次打开多个工作区，每个工作区可以同时开启多个任务，例如：</p>
<ul>
<li>Agent A收集整理数据</li>
<li>Agent B开发功能</li>
<li>Agent C输出项目文档</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/175163f823fa4a14810d4d0d609199db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=MZVI0s5wWNZZ%2Fg7ikWx7aGEvW7A%3D" alt="图片" loading="lazy"/></p>
<p>多个Agent在不同的窗口工作，可以在Agent Manager中查看任务状态，也可以随时切换到编辑器查看详细</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd123cb60e5842779aea34b3b79dc21c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=non72DiE13CU0IEUWgKDzIWXYfU%3D" alt="图片" loading="lazy"/></p>
<p>创建多任务管理也比较简单，点击【Start conversation】开启一个新会话，选择工作区后，输入提示词开始任务，如果需要同时执行多个任务可以重复刚刚到操作</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/331daa03e4b6487f8662532b97fe7772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=XglGFF%2F%2Fa6XMUTswGUFg531%2BNYw%3D" alt="图片" loading="lazy"/></p>
<p>Antigravity提供了后台任务能力，如果有任务希望在后台执行可以工作区可以选择【Playground】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4865272fd8df40d884c7d1a1296a1c47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=djq94V4zqcwg199QpP0ac3exgsk%3D" alt="图片" loading="lazy"/></p>
<p>Antigravity的后台任务其实就是创建了一个临时工作区，所有后台任务在临时工作区内完成，点击Agent Manager右上角的【Open Editor】可以打开临时工作区</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0956344e10f41e0addfbf00c3e090f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=deSsfi4nxUPdtJBn5%2BBwBzY9F%2Fs%3D" alt="图片" loading="lazy"/></p>
<p>临时工作区存放在 ~/.gemini/antigravity/playground 目录下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d619ecaee304f06909fdb389a852564~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=pwHIh8n8eC0cA%2Fvfh5zPcC7ZHQM%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-11">Open Browser</h3>
<p>Open Browser是Antigravity提供的另一个实用功能，基于最新的 Gemini 3 模型和 Computer Use 提供了对Chrome浏览器的操控，可自行打开浏览器预览、获取日志、网络请求、截图等操作。有点类似Cursor中的Browser，但是Antigravity的Open Browser不支持浏览器内预览及页面标签选择定位，相当于直接MCP集成到浏览器中，与网站进行交互和可视化操作</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c03682b50b6d4c879210c401672c9cbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=gOsgPuSUZxA2hPyoBR2o9Aogq0c%3D" alt="图片" loading="lazy"/></p>
<p>Antigravity使用Open Browser打开浏览器时会提示安装Browser Setup浏览器扩展，点击【Install extension】进行安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f959fa4ddb5c4e1db1e25e3d8db4bfe4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=hjur354nKd8F3NcKaGGhXf8TH%2Fo%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81a3c73281144bf19dc9eb820ff75202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=kR%2Bu5uC2c4dClYSKiNJrb5W9KOc%3D" alt="图片" loading="lazy"/></p>
<p>安装成功后，不要关闭浏览器，要求Antigravity执行浏览器操作，Antigravity就会直接在Chrome打开对应链接获取信息，AI操作浏览器过程中页面无法操作，这个和Comet浏览器很像，对Comet浏览器还不了解的小伙伴可以看往期内容：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492675%26idx%3D1%26sn%3D1fbe020cab2ee64f74b1b7de7d9cc623%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492675&amp;idx=1&amp;sn=1fbe020cab2ee64f74b1b7de7d9cc623&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Perplexity AI Agent原生浏览器Comet</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab66c0206e234f3a85ffc0e548703caa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=g9gTRstlrnurE5zeghXbAARaq%2Bo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-12">Check Point检查点</h3>
<p>Antigravity提供了Check Point功能，鼠标放在每次对话上都会浮现一个【Undo changes up to this point】的按钮</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5e170fd0df04263b7b58d0e39629e5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=OpEUya5imkfWdRYPO%2FC21TaaCog%3D" alt="图片" loading="lazy"/></p>
<p>点击【Undo changes up to this point】会弹出确认窗口</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a777c27982848598d84d200ac59a504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=5fiHSh8M23dkKrXhC6zQEmtZcG0%3D" alt="图片" loading="lazy"/></p>
<p>点击【Confirm】确认后会回到当前对话开始前的状态</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d27bf2daeba44a88adf42dcba84a24f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=EEY40FkgRhJjvYyRNPA%2BFcyFZoo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">Rules</h3>
<p>点击对话框侧边栏的下拉菜单，选择【Customizations】可以进入Rules和Workflows的配置界面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9318413aa8e74ae69f8d0acbec3c4c62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=baeufdO%2BS%2FssXKHiR6dzaw30XA0%3D" alt="图片" loading="lazy"/></p>
<p>Rules支持 Global（全局）和 Workspace（项目）2种配置</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cfa55d7eaef4dd4b8df73491446a35d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=IjiIEz%2B0%2FNqn1ApKl%2FyzQxd8A7M%3D" alt="图片" loading="lazy"/></p>
<p>点击【Global】可以添加全局提示词规则，创建完成后可以看到路径为：～/.gemini/GEMINI.md，居然和Gemini CLI是共用的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a87f45882e5c470da5f72c7fd4651caa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=prfU1Aw595CD2G6YgxuvKm42K84%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51c8e503ba24df3aca8c9fcf183927b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=SYOnUM0IF1ywAeR9jzL9uzxeK1k%3D" alt="图片" loading="lazy"/></p>
<p>点击【Workspce】可以添加项目提示词规则，输入提示词规则名称</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/354acf56ab8143ee98ff39eb7755517d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=85fIi5LR0wmXQfH0RJgF3JnT8rY%3D" alt="图片" loading="lazy"/></p>
<p>配置规则触发时机，看着和Cursor操作一致，对Cursor配置感兴趣的小伙伴可以看往期内容：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247488086%26idx%3D1%26sn%3D62b32f6d070501fd9647c6bb5988f02e%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247488086&amp;idx=1&amp;sn=62b32f6d070501fd9647c6bb5988f02e&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">【Cursor】Cursor中的Project Rules是什么？</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82492d8f8a124e65bf4b85cbcb464900~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=XCMgKcjJnC1xce6PwXVQk%2BV%2BcxA%3D" alt="图片" loading="lazy"/></p>
<p>触发时机类型：</p>
<ul>
<li>Manual：手动</li>
<li>Always On：始终开启</li>
<li>Model Decision：模型决策</li>
<li>Glob：全局</li>
</ul>
<p>最后填写 描述 和 提示词 内容后保存，保存后项目提示词规则会存放到 工作区/.agent/rules 目录下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64e797e691174ee98e3b83e85b6e53b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=Tf1lRII%2Bgj8mATPjK%2B%2Bh4f%2FvjS0%3D" alt="图片" loading="lazy"/></p>
<p>创建后的所有提示词规则都会在【Rules】下展示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/160d734a613a4256ba09cc41fc7e1022~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=iF5JunT7TywmZavEg%2BkI9tnGbnw%3D" alt="图片" loading="lazy"/></p>
<p>匹配到规则后Agent就会应用对应的规则内容</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/867cd0ee485249f0a026910ece95d029~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=50vSo78cdOnUFqZt6YVbCdsCj6U%3D" alt="图片" loading="lazy"/></p>
<p>也可以让AI帮我们创建Rules</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdf9574388a943b98eb108a4bd326b3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=yDtMOw45VZA0rPtz25OeNj0PEeE%3D" alt="图片" loading="lazy"/></p>
<p>创建完成后的提示词内容如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/485aee186066496a897719058423acb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=R%2F9mpRpGlhsWaYY9T9gavBysPpo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-14">Workflows</h3>
<p>在Customizations配置界面选择【Workflows】进入工作流配置界面，Antigravity的工作流其实就相当于Claude Code中的自定义命令，工作流配置也支持 Global（全局）和 Workspace（项目）2种配置</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e345d9ea9dc41c193592494afa579d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=muu6PQzVYzttpjJZs3L1BM1MwPg%3D" alt="图片" loading="lazy"/></p>
<p>点击【Global】，输入工作流名称和提示词内容后保存，可以看到全局工作流保存在 ~/.gemini/antigravity/global_workflows 目录下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52f2e0afe1f245b8a0281b29114a2da4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=jGZWHLs5khWpn3Qpo3Julhx2Xs0%3D" alt="图片" loading="lazy"/></p>
<p>创建的所有工作流都会在【Workflows】下展示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c5a06492a344435a685799fe5ece0d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=EX93Tbm%2BXQZGck%2FV57xbG9nZ33w%3D" alt="图片" loading="lazy"/></p>
<p>在对话窗口直接输入 / 快捷键可以选择工作流</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af2e6c61717e415e9e03f7ed0ee1f486~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=EMFz4vxheT89CrG%2Fv5b3VWJkez0%3D" alt="图片" loading="lazy"/></p>
<p>执行工作流后效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60146fa13d904c0da77d297c96499b00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=GRTjXLZNTNaV8EjHtk2pGzNCyOY%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-15">MCP服务</h3>
<p>点击对话框侧边栏的下拉菜单，选择【MCP Servers】可以进入MCP服务配置界面，Antigravity默认提供了MCP服务市场，只不过目前数量有限</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53756dae1af94cc397267de2a58a49c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=zAJJvwkvoMkJhlj01pAJMzfa91o%3D" alt="图片" loading="lazy"/></p>
<p>进入MCP服务详情，点击【Install】可以安装MCP</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11dc5e1985814259afe094cd5134a2d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=bhjNJwHymaEKwAvY5bpwFVRaTts%3D" alt="图片" loading="lazy"/></p>
<p>安装完成后，可以在MCP详情 禁用 和 卸载 MCP</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bd4473532d5404f880833c748a6d15c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=Si1sew%2BKpc9CqDAesorqM6sG02k%3D" alt="图片" loading="lazy"/></p>
<p>点击【Manage MCP Servers】可以对已安装的MCP进行统一管理</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6db8ddbca43444a9c2a7d0ba9ae6652~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=cOEcmIlK8uJHpnrHAwapff8prZU%3D" alt="图片" loading="lazy"/></p>
<p>如果MCP市场没有所需的MCP服务，可以点击【View raw config】打开MCP JSON配置文件进行配置</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0587184909dc481ab0cf993e44012d95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=NQFoMWddnhrzixvqPzwmDWqNdXE%3D" alt="图片" loading="lazy"/></p>
<p>配置文件路径为： ~/.gemini/antigravity/mcp_config.json</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0a62baa44d74ba5adc5ced5c79dd14c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=hufQkKGUR%2F69jGXwzm6HvvV5MeE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-16">产品定价</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5e8f7936f774c67a4b95edd2919b902~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=nMvEadHyWgqmrQDXeDRGXdmNrNM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-17">常见问题</h2>
<h3 data-id="heading-18">Antigravity授权成功IDE没有成功回调</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3778b0c4ec04986a7a2319537e166ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=Wv%2FDSuWd6qiZhveYZeHZPAeIkOs%3D" alt="图片" loading="lazy"/></p>
<p>尝试配置科学上网环境，开启Tun重试登录</p>
<h3 data-id="heading-19">Antigravity IDE授权一直loading</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfdeba8126924223a8280d146473756c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=GNdUr4ZhMnE03WIx0zLtJlHBV40%3D" alt="图片" loading="lazy"/></p>
<p>在网络正常的情况下授权都很快，出现这个问题的小伙伴可以看下这个帖子：<a href="https://link.juejin.cn?target=https%3A%2F%2Flinux.do%2Ft%2Ftopic%2F1185785%25EF%25BC%258C%25E4%25B9%259F%25E5%258F%25AF%25E4%25BB%25A5%25E6%259F%25A5%25E7%259C%258BAntigraviity%25E6%2594%25AF%25E6%258C%2581%25E7%259A%2584%25E5%258C%25BA%25E5%259F%259F%25EF%25BC%258C%25E6%259F%25A5%25E8%25AF%25A2%25E8%2587%25AA%25E5%25B7%25B1%25E7%2599%25BB%25E5%25BD%2595%25E8%25B4%25A6%25E5%258F%25B7%25E7%259A%2584%25E5%258C%25BA%25E5%259F%259F%25E4%25BB%25A5%25E5%258F%258A%25E6%259B%25B4%25E6%2594%25B9%25E5%258C%25BA%25E5%259F%259F" target="_blank" title="https://linux.do/t/topic/1185785%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8BAntigraviity%E6%94%AF%E6%8C%81%E7%9A%84%E5%8C%BA%E5%9F%9F%EF%BC%8C%E6%9F%A5%E8%AF%A2%E8%87%AA%E5%B7%B1%E7%99%BB%E5%BD%95%E8%B4%A6%E5%8F%B7%E7%9A%84%E5%8C%BA%E5%9F%9F%E4%BB%A5%E5%8F%8A%E6%9B%B4%E6%94%B9%E5%8C%BA%E5%9F%9F" ref="nofollow noopener noreferrer">linux.do/t/topic/118…</a></p>
<p>支持区域：<a href="https://link.juejin.cn?target=https%3A%2F%2Fantigravity.google%2Fdocs%2Ffaq%25EF%25BC%258C" target="_blank" title="https://antigravity.google/docs/faq%EF%BC%8C" ref="nofollow noopener noreferrer">antigravity.google/docs/faq，</a></p>
<p>账号区域查询、更改地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpolicies.google.com%2Fcountry-association-form" target="_blank" title="https://policies.google.com/country-association-form" ref="nofollow noopener noreferrer">policies.google.com/country-ass…</a></p>
<h3 data-id="heading-20">Model quota limit exceeded</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e8d0a525e7547ae899f010ac0f68f59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=nfo4u6hjNvPa8R8o6MB29mA%2Fryw%3D" alt="图片" loading="lazy"/></p>
<p>如果使用的是Gemini 3 Pro（High）使用达到一定次数后会出现这个问题，这是到达模型使用次数了，5个小时后再次重试即可</p>
<h3 data-id="heading-21">Model provider overload</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3137c0d29edd47e2ad55e4a1347f5e26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765022496&amp;x-signature=fTGJPZyVma9iudEGFoTMms7wwQc%3D" alt="图片" loading="lazy"/></p>
<p>当前访问人数较多，提供商服务过载了，重试即可</p>
<h2 data-id="heading-22">友情提示</h2>
<p>见原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPI-NHBextrwQFzIYGlYnKw" target="_blank" title="https://mp.weixin.qq.com/s/PI-NHBextrwQFzIYGlYnKw" ref="nofollow noopener noreferrer">Google 发布 Antigravity Agent编辑器</a></p>
<blockquote>
<p>本文同步自微信公众号 "<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPI-NHBextrwQFzIYGlYnKw" target="_blank" title="https://mp.weixin.qq.com/s/PI-NHBextrwQFzIYGlYnKw" ref="nofollow noopener noreferrer">程序员小溪</a>" ，这里只是同步，想看及时消息请移步我的公众号，不定时更新我的学习经验。友情提示友情提示</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini CLI可以使用Gemini 3 Pro了]]></title>    <link>https://juejin.cn/post/7577599015426752547</link>    <guid>https://juejin.cn/post/7577599015426752547</guid>    <pubDate>2025-11-29T12:21:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577599015426752547" data-draft-id="7577356848338436131" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini CLI可以使用Gemini 3 Pro了"/> <meta itemprop="keywords" content="Gemini,AIGC"/> <meta itemprop="datePublished" content="2025-11-29T12:21:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小溪彼岸"/> <meta itemprop="url" content="https://juejin.cn/user/976781670357400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini CLI可以使用Gemini 3 Pro了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976781670357400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小溪彼岸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T12:21:01.000Z" title="Sat Nov 29 2025 12:21:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>小伙伴们大家好，我是小溪，见字如面。今天收到了Google候补Gemini CLI使用Gemini 3 Pro的通过邮件，前两天还在说Gemini CLI中无法使用Gemini 3 Pro的问题，今天就可以在Gemini CLI中使用Gemini 3 Pro了😁。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6660461216e94b6b84ef2c849b718981~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765023660&amp;x-signature=qKLjg%2F2NHIZ44kcdlJPxwC9V8MU%3D" alt="图片" loading="lazy"/></p>
<p>官方说明链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgeminicli.com%2Fdocs%2Fget-started%2Fgemini-3" target="_blank" title="https://geminicli.com/docs/get-started/gemini-3" ref="nofollow noopener noreferrer">geminicli.com/docs/get-st…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe73f3b29c6a42f5ad70fcb9e19f00fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765023660&amp;x-signature=QgDmLQwWqrfT6opqPFnB0%2F4hZAU%3D" alt="图片" loading="lazy"/></p>
<p>根据官方文档描述，自动获得访问权限的用户包括：</p>
<ul>
<li>Google AI Ultra 付费订阅用户</li>
<li>拥有有效 Gemini API 密钥的用户</li>
<li>拥有 Vertex API 密钥的用户</li>
</ul>
<p>需要加入等待名单的用户包括：</p>
<ul>
<li>Google AI Pro 用户</li>
<li>Gemini Code Assist 标准版用户</li>
<li>免费版用户</li>
</ul>
<p>对往期内容感兴趣的小伙伴可以看往期内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493952%26idx%3D1%26sn%3D1f52be1900a4e1c998add235afe6e524%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493952&amp;idx=1&amp;sn=1f52be1900a4e1c998add235afe6e524&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">体验Gemini 3 Pro的N多种方式</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247494022%26idx%3D1%26sn%3D56ebef4e8aba510470719b4d0898f21f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247494022&amp;idx=1&amp;sn=56ebef4e8aba510470719b4d0898f21f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Google 发布 Antigravity Agent编辑器</a></li>
</ul>
<h2 data-id="heading-1">限制</h2>
<ul>
<li>Gemini CLI中Gemini 3 Pro也使用限制（刷新机制可能和Antigravity保持一致，每5小时刷新一次）</li>
</ul>
<h2 data-id="heading-2">省流版本</h2>
<p>在Gemini CLI中使用Gemini 3 Pro的流程：</p>
<ul>
<li>免费用户填写表单候补Gemini 3 Pro的Gemini CLi权限，大概 1-5个工作日</li>
<li>收到候补通过邮件，更新到最新版本 Gemini CLI</li>
<li>使用"Google 账号登录"选项完成身份验证，登录后可以看到"Gemini 3 现在可用"的横幅提示"</li>
<li>启动Gemini CLI，使用 /settings 开启 Preview Features，重启Gemini CLI</li>
<li>使用 /model 切换到 gemini-3-pro-preview 模型</li>
</ul>
<h2 data-id="heading-3">当前使用版本</h2>
<p>gemini cli 0.17.1</p>
<h2 data-id="heading-4">更新Gemini CLI</h2>
<p>养成好习惯在使用之前Gemini CLI之前先对工具进行升级，之前使用NPM安装的Gemini CLI每次更新总是会出错，这次我尝试使用Homebrew进行安装和更新，不是macOS系统的小伙伴可以查看往期内容使用其他安装方式：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492558%26idx%3D1%26sn%3De762047c93c4361f63744ec3c70a434f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492558&amp;idx=1&amp;sn=e762047c93c4361f63744ec3c70a434f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Google百万Token上下文Gemini CLI，离AI自由更近一步</a></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ brew</span> install gemini-cli
</code></pre>
<p>更新完成后查看版本号，目前最新版本为 0.17.1</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de417e679b654bce9a42338787d4b9a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765023660&amp;x-signature=rT7CM6F%2Fo4up%2FCQgAJH4l2fNrSs%3D" alt="图片" loading="lazy"/></p>
<p>更新Gemini CLI可以使用如下命令</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ brew</span> update gemini-cli
</code></pre>
<h2 data-id="heading-5">重新登录授权</h2>
<blockquote>
<p>重新登录很重要，之前的登录授权凭证可能会影响Gemini 3 Pro的使用</p>
</blockquote>
<p>在交互式命令中输入 /auth 重新登录，选择【Login with Google】，申请候补使用的是Google账号，这里以Google账号进行登录授权</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a69003312f74d5a965276f18d58c24c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765023660&amp;x-signature=0Vkz2cn094r%2BveSfaReqbK1LPaw%3D" alt="图片" loading="lazy"/></p>
<p>授权完成后，可以看到授权产品信息</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cac05e486d348a48dc413b2aceded21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765023660&amp;x-signature=8wI1BzUF4c5YLsw4UaEgyokcD3k%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-6">配置方式</h2>
<p>在交互式命令中输入 /settings 打开设置，找到【Preview Features】开启</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9160de3727c4c98bdecab8596b9a5f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765023660&amp;x-signature=SeNWGxWdOt0SSmXMFi2cTzbzx38%3D" alt="图片" loading="lazy"/></p>
<p>开启成功后，在交互式命令中输入 /model 就可以看到 gemini-3-pro-preview 模型了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/970bef280d2345f099986b428a7f1e7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765023660&amp;x-signature=%2Bvu4WDkOtP3H9NU3BIAeNxskGkM%3D" alt="图片" loading="lazy"/></p>
<p>选择后在输入框右下角会显示Pro模型</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db9136fc99d14a56b94b7afb9fb3c74b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765023660&amp;x-signature=a%2FLnS5inRM4%2FY9K85PWb74TtRAY%3D" alt="图片" loading="lazy"/></p>
<p>输入提示词查看可用性</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0aacf9cbccda4507ac860ab015ad6bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765023660&amp;x-signature=kxZXuU4aspmWcKRNrBnuxowopk4%3D" alt="图片" loading="lazy"/></p>
<p>Gemini的提示词限制还挺强，尝试了好多次AI才给出具体的模型和知识库信息</p>
<h2 data-id="heading-7">常见问题</h2>
<h3 data-id="heading-8">exhausted your daily quota</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d162dedc0da946669507f806f74a8a7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765023660&amp;x-signature=bKUsq%2FQbC4fRR9xRKXCY%2FvTidbU%3D" alt="图片" loading="lazy"/></p>
<p>通过了候选名单仍然提示已用完该模型的每日配额，尝试退出登录，选择【Login with Google】进行登录</p>
<h2 data-id="heading-9">友情提示</h2>
<p>见原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FmVWsEdE8JJbkTURXJSMLxg" target="_blank" title="https://mp.weixin.qq.com/s/mVWsEdE8JJbkTURXJSMLxg" ref="nofollow noopener noreferrer">Gemini CLI可以使用Gemini 3 Pro了</a></p>
<blockquote>
<p>本文同步自微信公众号 "<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FmVWsEdE8JJbkTURXJSMLxg" target="_blank" title="https://mp.weixin.qq.com/s/mVWsEdE8JJbkTURXJSMLxg" ref="nofollow noopener noreferrer">程序员小溪</a>" ，这里只是同步，想看及时消息请移步我的公众号，不定时更新我的学习经验。友情提示友情提示</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[初识Qwen Code CLI]]></title>    <link>https://juejin.cn/post/7577647745110491136</link>    <guid>https://juejin.cn/post/7577647745110491136</guid>    <pubDate>2025-11-29T12:42:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577647745110491136" data-draft-id="7577439614953947188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="初识Qwen Code CLI"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-29T12:42:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小溪彼岸"/> <meta itemprop="url" content="https://juejin.cn/user/976781670357400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            初识Qwen Code CLI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976781670357400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小溪彼岸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T12:42:58.000Z" title="Sat Nov 29 2025 12:42:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>小伙伴们大家好，我是小溪，见字如面。Qwen Code CLI发布有段时间了，一直没有使用，今天来继续体验CLI。对AI Code CLI以往期内容感兴趣的小伙伴也可以看往期：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492263%26idx%3D1%26sn%3D4e809f38100be358e31f298a78fd81ea%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492263&amp;idx=1&amp;sn=4e809f38100be358e31f298a78fd81ea&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">下一代AI终端神器Warp</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492929%26idx%3D1%26sn%3D043e21a18f31f1c4c68bf4ee63e28685%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492929&amp;idx=1&amp;sn=043e21a18f31f1c4c68bf4ee63e28685&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Claude Code CLI初体验</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493426%26idx%3D1%26sn%3D4e0b83c872d1e23af8fc8de2708e0bda%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493426&amp;idx=1&amp;sn=4e0b83c872d1e23af8fc8de2708e0bda&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Codex CLI初体验</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492558%26idx%3D1%26sn%3De762047c93c4361f63744ec3c70a434f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492558&amp;idx=1&amp;sn=e762047c93c4361f63744ec3c70a434f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Google百万Token上下文Gemini CLI，离AI自由更近一步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493377%26idx%3D1%26sn%3Dda5a37dc7f023881c0e22342caff11e1%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493377&amp;idx=1&amp;sn=da5a37dc7f023881c0e22342caff11e1&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">腾讯发布CodeBuddy Code CLI平替Claude Code?</a></li>
</ul>
<h2 data-id="heading-1">当前使用版本</h2>
<p>Qwen Code CLI：0.1.0</p>
<h2 data-id="heading-2">优势</h2>
<ul>
<li>无缝访问Qwen模型</li>
<li>无需手动管理 API key</li>
<li>每分钟 60 次请求</li>
<li>每天免费 2,000 次请求</li>
<li>任何兼容 OpenAI 的API</li>
</ul>
<h2 data-id="heading-3">限制</h2>
<ul>
<li>需要有效的 qwen.ai 账户</li>
</ul>
<h2 data-id="heading-4">简介</h2>
<p>Qwen Code 是一个强大的命令行 AI 工作流工具，基于 Gemini CLI 改造而来的，并针对 Qwen3-Coder 模型进行了专门优化。它通过先进的代码理解能力、自动化任务和智能辅助功能，显著提升你的开发工作流效率。</p>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fqwenlm.github.io%2Fqwen-code-docs" target="_blank" title="https://qwenlm.github.io/qwen-code-docs" ref="nofollow noopener noreferrer">qwenlm.github.io/qwen-code-d…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8bb12002b7c4f27927b5e9f90d07a9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=TpGT7ON7Z5o9B0WzdIN88W4CpEU%3D" alt="图片" loading="lazy"/></p>
<p>开源Github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQwenLM%2FQwen3-Coder" target="_blank" title="https://github.com/QwenLM/Qwen3-Coder" ref="nofollow noopener noreferrer">github.com/QwenLM/Qwen…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7376243a865412fb8467bf108696846~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=zosuX3nhSaliTutubCXpNSnTVWo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">功能特性</h2>
<ul>
<li>超大规模参数量：Qwen3-Coder基于MoE（混合专家）架构的模型，总参数量达4800亿（480B），激活参数约350亿（35B），支持256K token上下文，并可通过YaRN技术扩展至1M token长度。</li>
<li>多模态与Agent能力：Qwen3-Coder拥有具备自主交互能力的智能体（Agent），不仅能进行代码生成，而且可以自主调用工具、理解复杂需求、进行多轮交互。</li>
<li>代码生成与优化：Qwen3-Coder支持代码生成、自动测试、多轮交互及工具调用，覆盖从需求分析到代码落地的全流程。</li>
</ul>
<h2 data-id="heading-6">安装配置</h2>
<h3 data-id="heading-7">前提条件</h3>
<ul>
<li>需要Node.js 20及更高版本</li>
</ul>
<h3 data-id="heading-8">安装CLI</h3>
<h4 data-id="heading-9">通过npm安装</h4>
<p>在终端命令行输入如下指令</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>npm install -g <span class="hljs-variable">@qwen</span>-code/qwen-code<span class="hljs-variable">@latest</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9efef5b7d6a4d0392f029f693253cbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=MeqMIf0qZXWWg2YQCVXyNKMhiJw%3D" alt="图片" loading="lazy"/></p>
<p>安装完成后，输入 qwen -v 查看Qwen Code CLI版本，看到以下信息表示Qwen Code CLI安装成功。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d15c5379c4740e3bda2a2fbeaeba92d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=8clvvmT2ZfqbKTcbRIn1JLeozMc%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-10">使用 Homebrew 全局安装</h4>
<p>在macOS/Linux环境可以直接通过brew进行安装</p>
<pre><code class="hljs language-css" lang="css">$ brew install qwen-<span class="hljs-selector-tag">code</span>
</code></pre>
<h4 data-id="heading-11">从源码安装</h4>
<p>也可以直接克隆源码进行安装</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> git <span class="hljs-built_in">clone</span> https://github.com/QwenLM/qwen-code.git</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> <span class="hljs-built_in">cd</span> qwen-code</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> npm install</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> npm install -g .</span>
</code></pre>
<h2 data-id="heading-12">基本使用</h2>
<p>因为Qwen Code CLI是基于Gemini CLI魔改的，大部分功能和Gemini CLI是一样的，这里我们只探索Qwen Code CLI独有的功能。</p>
<h3 data-id="heading-13">登录授权</h3>
<h4 data-id="heading-14">手动授权</h4>
<p>Qwen Code CLI安装完成后，在命令行终端输入 qwen 启动CLI，启动后界面如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e793084e8ebd4021a2a8cb068d94a6e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=ltgEqdxFIrW9ftGqFtbotlAnDWY%3D" alt="图片" loading="lazy"/></p>
<p>可以看到操作界面和Gemini CLI基本是一样的，区别是模型换成了coder-model，登录方式有 Qwen OAuth 和 OpenAI 两种授权方式：</p>
<p><strong>1）Qwen OAuth</strong></p>
<p>选择【Qwen OAuth】会默认展示二维码且在浏览器打开Qwen授权页面，可以选择使用Qwen应用扫码授权也可以在web端进行授权</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34ae01c8a6e34e6aaeff5601c05301e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=WzMcOjLZ%2BnWxCyu9q3LN0U6HYL4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/688d825f4b3545e486d704dab4533a24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=zCVO%2F6GNMFeqLXZ9uAkGoUdSGKs%3D" alt="图片" loading="lazy"/></p>
<p>授权成功后Qwen Code CLI会展示已授权状态</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b76a2eababf148e28378f8b79e051877~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=0kaZAvzMLY1LKh0P4vfpqAbChAQ%3D" alt="图片" loading="lazy"/></p>
<p><strong>2）OpenAI</strong></p>
<p>该登录授权方式是以兼容OpenAI的提供商提供的API Key进行授权登录</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dcc5bbe70014146a01bcce852d6c57b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=eN43hJSKRXN1s69yQv0jQlYGJlY%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>API Key：提供商API Key（密钥）</li>
<li>Base URL：提供商请求API请求URL</li>
<li>Model：提供商模型名称</li>
</ul>
<p>这里以 魔搭 平台为例进行演示，对魔搭还不了解的小伙伴可以看往期内容：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493035%26idx%3D1%26sn%3D9ccc174a34a0ee59e6a609e409b09908%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493035&amp;idx=1&amp;sn=9ccc174a34a0ee59e6a609e409b09908&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Claude Code CLI平台与中转站接入汇总及避坑</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9af9b8e87dea49488f73bc6c07d12cba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=daKTeltS8nWBajLaH%2BeHGGLz8RY%3D" alt="图片" loading="lazy"/></p>
<p>授权配置完成后，即可正常进入对话界面，该版本OpenAI授权配置方式有时会有问题，授权完成后会报错，使用自动授权方式正常</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04bef8b0acac4909a53ac386d2e164a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=Ug5onl4HQUMkiWHEJFydkvz70hE%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-15">自动授权</h4>
<p>新开命令行终端，以 macOS 为例在终端导出模型提供商配置</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">OPENAI_API_KEY</span>=<span class="hljs-string">"your_api_key_here"</span>   
export <span class="hljs-attr">OPENAI_BASE_URL</span>=<span class="hljs-string">"your_api_endpoint"</span>   
export <span class="hljs-attr">OPENAI_MODEL</span>=<span class="hljs-string">"your_model_choice"</span>
</code></pre>
<p>以 魔搭 为例配置如下：</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">OPENAI_API_KEY</span>=<span class="hljs-string">"your_api_key_here"</span>
export <span class="hljs-attr">OPENAI_BASE_URL</span>=<span class="hljs-string">"https://api-inference.modelscope.cn/v1"</span>
export <span class="hljs-attr">OPENAI_MODEL</span>=<span class="hljs-string">"Qwen/Qwen3-Coder-480B-A35B-Instruct"</span>
</code></pre>
<p>重新启动Qwen Code CLI，授权成功效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b42e3899d25b4e58be3c3a74eca28ab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=3su6ecoP6YcaCN2NZ0DiZaUoG8o%3D" alt="图片" loading="lazy"/></p>
<p>也可以在项目根目录创建 .env 文件，配置OpenAI兼容的提供商API Key</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">OPENAI_API_KEY</span>=your_api_key_here
<span class="hljs-attr">OPENAI_BASE_URL</span>=https://api-inference.modelscope.cn/v1
<span class="hljs-attr">OPENAI_MODEL</span>=Qwen/Qwen3-Coder-<span class="hljs-number">480</span>B-A35B-Instruct
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba4739104a7d47729180906969230cc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=ceCRC1CfGxqBAeXvo%2FfLPQGQbVc%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-16">执行Shell</h3>
<p>和Gemini CLI一样在交互式命令中输入 ! 可进入Shell模式执行Shell命令</p>
<h3 data-id="heading-17">交互式命令</h3>
<h4 data-id="heading-18">agents</h4>
<p>Qwen Code CLI新增的交互式命令，用于专注任务的专用 AI 子代理（子代理是配置了特定专业知识和工具访问权限的独立 AI 助手）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3fd67a509ba40ddb017680061c85f4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=2Hwg1xLVzUItIT9XZgCpsy6fwnQ%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>create：启动交互式向导以创建新的子代理，用法：/agents create</li>
<li>manage：打开交互式管理对话框以查看、编辑和删除现有子代理，用法：/agents manage</li>
</ul>
<h4 data-id="heading-19">approval-mode</h4>
<p>Qwen Code CLI新增的交互式命令，用于更改工具使用的审批模式</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7466b55bf19e4eefaa3ae93439e3f8bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=K%2BrjNurhPEErhtTnx6nkZYKXRoA%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>plan：仅分析，不修改文件或执行命令</li>
<li>default：要求审批文件编辑或 shell 命令</li>
<li>auto-edit：自动批准文件编辑</li>
<li>yolo：自动批准所有工具</li>
</ul>
<p>选择一种模式后，可以看到每种模式还提供了作用范围</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/337b7e0238b34db4a646f6784f1e7157~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=KsTPMfDNetu3iDQwE6eaVxpZoqE%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>--session：仅应用于当前会话</li>
<li>--project：为此项目 / 工作区持久化</li>
<li>--user：为这台机器上的用户进行持久化设置</li>
</ul>
<p>选择作用范围后，Qwen Code CLI会将配置写到指定配置文件中</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/570b1591a3b247e8a77df747fb83ac20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=eUgQykfhOCa%2FyGmnPWJhAJ7lse4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30ad448637c342be968a91abc8f2ee09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=Kf1sBCwfZDmu3fR8ueV6v96sSW0%3D" alt="图片" loading="lazy"/></p>
<p>除了使用交互式命令，也可以使用命令后参数进行配置</p>
<pre><code class="hljs language-bash" lang="bash">/approval-mode plan --project
/approval-mode yolo --user
</code></pre>
<p>重启Qwen Code CLI后，已选择的对话模式仍然生效</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b0d4bb859824f8eb7b5680f3147c742~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=j7MiTXCbaIBOgWxNVC3sBFxmLlA%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-20">model</h4>
<p>Qwen Code CLI新增的交互式命令，用于查看和切换模型</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d11b8547bf974bc4af14a9a4a5058a98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=wNYqMMAOR1uyL4t36%2ByLrb7PW%2Bo%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-21">quit-confirm</h4>
<p>Qwen Code CLI新增的交互式命令，用于退出 Qwen Code 前显示确认对话框，允许你选择如何处理当前会话。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e4460a7a25b437f9dc1f51e6ba75367~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=nDrkHaYpGshwtCZLrPFkOSOd2ag%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>Quit immediately： 立即退出，不保存任何内容直接退出（等效于 /quit）</li>
<li>Generate summary and quit：生成摘要并退出，在退出前使用 /summary 创建项目摘要</li>
<li>Save conversation and quit：保存对话并退出，在退出前使用自动生成的标签保存当前对话</li>
<li>Cancel：取消退出操作</li>
</ul>
<h3 data-id="heading-22">配置文件</h3>
<p>Qwen Code CLI延续了Gemini CLI的配置文件系统，提供了 .qwen/settings.json、.env、QWEN.md 等配置文件，整体上和Gemini CLI的配置文件没有太大差异。</p>
<h3 data-id="heading-23">对话模式</h3>
<p>Qwen Code CLI提供了 plan、default、auto-edit、yolo 4种对话模式，关于对话模式的解释可以看上方【交互式命令】，可以在交互式命令中通过 /approval-mode 命令进行选择</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7dcb8eaeeca44a9aba728dfbd70956c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=yFd2w3IJYXsmGVt6oHM%2BoCUhrGk%3D" alt="图片" loading="lazy"/></p>
<p>也可以通过快捷键【Shift + Tab】进行切换</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fef203cf42847da87d3c0412a0e274e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=6RlswFMPDvDologpBK1gUrPOtWI%3D" alt="图片" loading="lazy"/></p>
<p>Qwen Code CLI默认为【default】模式，该模式下所有文件编辑和Shell指令执行都需要人为进行权限审批</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c4afa3db7ac4c949357bcfe000a2433~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=Ec%2BGwymfXHytxWxkY2c%2Bw0gSaNo%3D" alt="图片" loading="lazy"/></p>
<p>当我们切换到【plan mode】模式发起一个任务时，Qwen Code CLI会对任务进行分析和规划，但是并不会执行计划，而是会提示我们切换到【auto-accept】模式</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9740404cbc1c4afebca67d2aeb0d8f52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=Mcv9cnSJg95v%2BkaUJ6TfSMVaMeo%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b69275fcd364031a8b8808b350432e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=HI6RhxZ%2B8taZzHE2%2B5%2FGV0h9FBY%3D" alt="图片" loading="lazy"/></p>
<p>当我们切换到【auto-accept edits】模式时，再次执行同一个任务时，Qwen Code CLI会直接进行文件编辑任务</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc8a0c4b73b44bfc91621abb3ec2205c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=aBc8papkiB9xxNf7qobC89SKdzA%3D" alt="图片" loading="lazy"/></p>
<p>使用【auto-accept edits】模式只有编辑权限，没有MCP执行等其他权限</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efc377fb356d438c977f2d3ecf5a444d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=arXiuILdeNJz2pbuA2x9AQblxH0%3D" alt="图片" loading="lazy"/></p>
<p>如需调用MCP等其他命令的自动批准权限，需要切换到【YOLO mode】模式</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77f739f4172a4fbbb8fd262f51e32350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=%2BpYj8zAUsdj%2B8Sv7i2%2FD2wMdzWw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-24">视觉模型</h3>
<p>使用【Qwen OAuth】方式授权，在交互式命令中调用 /model命令可以看到除了 coder-model 模型，还提供了一个 vision-model 视觉模型</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f209cca66c34efcb6adc2d17c7228f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=9u%2BYiyw4q%2BJuP4Jsuhp9kmoYsZE%3D" alt="图片" loading="lazy"/></p>
<p>最新的阿里云 ModelStudio Qwen Vision 模型（qwen3-vl-plus-2025-09-23）是“通义千问”Qwen3-VL系列的新一代视觉语言模型，在图像、视频与文本等多模态理解能力上极为强大。该版本不仅在企业和科研应用场景具备卓越表现，并且对中文任务支持十分完善。</p>
<p>切换到 vision-model 模型，提供一张图片看看效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48ddaafb2f8640a680f61daed0a2046b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=%2BfHNlnKnBhYNoowMRzligx6l69U%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f27bae72626a4f54bde7e3fe7169631d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=3SJqYWWbwRxsU9bLJ%2FHbGqJlk9U%3D" alt="图片" loading="lazy"/></p>
<p>再贴一张Gemini CLI的效果图，看看更喜欢哪个</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/857759d4e88a4739ac300d5256dac2d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=oz6JjISFFxva8JCBu%2B6MfVSx62U%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-25">自定义命令</h3>
<p>Qwen Code CLI支持自定义命令，也就是Claude Code CLI的斜杠命令。不同的是Qwen Code CLI的自定义命令需要在 .qwen/commands/ 目录下创建后缀为.toml的文件，文件内容格式如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">description</span> = <span class="hljs-string">"测试命令"</span>
<span class="hljs-attr">prompt</span> = <span class="hljs-string">"输出`测试命令`话术"</span>
</code></pre>
<p>Qwen Code CLI的自定义命令和Claude Code CLI还是有不少差异的，由于篇幅问题，下次展开说明。</p>
<h3 data-id="heading-26">Subagents</h3>
<p>Qwen Code CLI支持子代理功能，在交互式命令中输入 /agents 可以查看Agents菜单</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2149ef6206b842dbab0fea1b672daa7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=MHxROBM008bQn8Yko21mxUFmeBI%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>manage：管理现有的子代理（查看、编辑、删除）</li>
<li>create：创建一个带有引导式设置的新子代理</li>
</ul>
<p>使用 manage 命令可以管理已存在的子代理</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d53751e039d545c4ac7f2de1c7e35f39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=mz7xuB4w6F10KoOhdoafSUMe6Bc%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcbe196b011d4db7abc2eace6460f0d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=qAohTs4HnEpCTTvppUL5%2FHi7nS8%3D" alt="图片" loading="lazy"/></p>
<p>使用 create 命令可以创建不同作用范围的子代理</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c6ea6b5011a4f839e7e33a2d9c567a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=LPbRNiAJq9J3Gfo63XTDKa3JCAk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-27">MCP服务</h3>
<p>Qwen Code CLI支持使用命令行一键添加MCP，也可以直接在 settings.json 文件中进行配置，其他MCP操作和Gemini CLI保持一致</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> qwen mcp add --transport http context7 https://mcp.context7.com/mcp</span>
</code></pre>
<p>Qwen Code CLI新增了MCP服务快捷键快速查看功能，配置完MCP服务后，可以看到聊天框上方多了一个提示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e819d22dd97447d9b9dcf783e99c8b23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=Rv77qoibmCEiKNSFOPGNFIvGJJU%3D" alt="图片" loading="lazy"/></p>
<p>使用快捷键【Ctrl+T】可以快速查看MCP服务信息</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/903247dcc7e545e98fd55538e228d75c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=KubQ%2FvkkwaCHuPM9u522snLbbVk%3D" alt="图片" loading="lazy"/></p>
<p>Qwen Code CLI还新增了【Debug Console】功能</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ea876e91c8a4583bed574162b50498e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=EHNijOmt4TO89MSXofOnY5BeaPc%3D" alt="图片" loading="lazy"/></p>
<p>使用快捷键【Ctrl+O】可以快速打开【Debug Console】查看调试信息</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32a80ba45ed540a1a7b15ade2cbbd757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=sX3sw39yYMo%2BBxKQDJnJuPXlepg%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-28">总结</h2>
<p>Qwen Code CLI并不是照搬Gemini CLI，而是在Gemini CLI的基本上提供了自己的创新功能，其提供的Qwen Code授权提供了每天 2000次 免费请求，这对AI小白来说很友好，但是对工具、MCP等工具调用上感觉还不够只能，在日常开发中可作为补充使用，对于企业级项目还可以再等等。</p>
<h2 data-id="heading-29">常见问题</h2>
<h3 data-id="heading-30">无法准确调用MCP服务</h3>
<p>使用【Qwen OAuth】授权时使用的【coder-model】模型对应的是 qwen3-coder-plus-2025-09-23 模型，该模型在执行MCP时时常会出现无法正常调用MCP的情况</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eebdef5424b454da05defe4f527c14c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=Qd19S22mWHvHdcs0Sn20VdYRdWM%3D" alt="图片" loading="lazy"/></p>
<p>解决方案就是改换为OpenAI授权方式，使用魔搭社区的 Qwen/Qwen3-Coder-480B-A35 模型或者其他模型</p>
<h3 data-id="heading-31">使用魔搭API 429问题</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69ffa46a2f58490ca89cbe29f96f30b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765024978&amp;x-signature=OIjSKMqaD7Mk4Es%2FhsYHy9HGQ04%3D" alt="图片" loading="lazy"/></p>
<p>使用的 Qwen/Qwen3-Coder-480B-A35 模型根据魔搭平台的动态调整策略目前调用次数限制为大约 50 次了，超过 50 次就429，只需要换个模型就行了。</p>
<h2 data-id="heading-32">友情提示</h2>
<p>见原文：<a href="https://link.juejin.cn?target=https%253A%2F%2Fmp.weixin.qq.com%2Fs%2F_iHKR4dD2-j2qftyOk8aCA" target="_blank" title="https%3A//mp.weixin.qq.com/s/_iHKR4dD2-j2qftyOk8aCA" ref="nofollow noopener noreferrer">初识Qwen Code CLI</a></p>
<blockquote>
<p>本文同步自微信公众号 "<a href="https://link.juejin.cn?target=https%253A%2F%2Fmp.weixin.qq.com%2Fs%2F_iHKR4dD2-j2qftyOk8aCA" target="_blank" title="https%3A//mp.weixin.qq.com/s/_iHKR4dD2-j2qftyOk8aCA" ref="nofollow noopener noreferrer">程序员小溪</a>" ，这里只是同步，想看及时消息请移步我的公众号，不定时更新我的学习经验。友情提示友情提示</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一款开源、多语言的 WPF 可筛选 DataGrid 控件]]></title>    <link>https://juejin.cn/post/7577704980855046198</link>    <guid>https://juejin.cn/post/7577704980855046198</guid>    <pubDate>2025-11-29T12:54:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577704980855046198" data-draft-id="7577704980855029814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一款开源、多语言的 WPF 可筛选 DataGrid 控件"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-11-29T12:54:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一款开源、多语言的 WPF 可筛选 DataGrid 控件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T12:54:33.000Z" title="Sat Nov 29 2025 12:54:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在现代化软件应用开发中，数据展示与交互的效率直接影响用户体验与开发效能。WPF 其内置的 DataGrid 在多语言支持与复杂数据筛选方面仍存在局限性。今天大姚给大家分享一款开源、多语言的 WPF 可筛选 DataGrid 控件：DataGridFilter。</p>
<h2 data-id="heading-1">项目介绍</h2>
<p>DataGridFilter 是一款开源（MIT License）、多语言的 WPF 可筛选 DataGrid 控件，旨在通过轻量级集成帮助开发者快速构建高效、灵活的数据展示管理界面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8f301888c03433ab38f957cb45115a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765025673&amp;x-signature=iqVH%2Ffb73TOjvWHpDJUsjI3CYn0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">基本功能</h2>
<ul>
<li>单列过滤：允许用户对数据网格的每一列进行单独的过滤操作。</li>
<li>多列联合过滤：支持同时对多个列进行过滤，用户可以通过逻辑运算符（如 AND、OR）组合多个过滤条件。</li>
<li>动态过滤：能够根据用户输入或其他事件实时更新过滤结果。</li>
<li>支持多语言：支持中文(繁体和简体)、 荷兰语、英语、法语、德语等多语言的标签翻译和日期格式。</li>
</ul>
<h2 data-id="heading-3">项目使用</h2>
<p><strong>直接安装 FilterDataGrid NuGet 包：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nuget.org%2Fpackages%2FFilterDataGrid" target="_blank" title="https://www.nuget.org/packages/FilterDataGrid" ref="nofollow noopener noreferrer">www.nuget.org/packages/Fi…</a></li>
</ul>

<pre><code class="hljs language-lua" lang="lua">dotnet add <span class="hljs-built_in">package</span> FilterDataGrid <span class="hljs-comment">--version 1.2.9</span>
</code></pre>
<p><strong>在项目的 XAML 中添加命名空间：</strong></p>
<pre><code class="hljs language-ini" lang="ini">xmlns:<span class="hljs-attr">control</span>=<span class="hljs-string">"clr-namespace:FilterDataGrid;assembly=FilterDataGrid"</span>
</code></pre>
<p><strong>使用 FilterDataGrid 控件：</strong></p>
<pre><code class="hljs language-ini" lang="ini">&lt;control:FilterDataGrid <span class="hljs-attr">FilterLanguage</span>=<span class="hljs-string">"English"</span> DateFormatString=<span class="hljs-string">"d"</span> ShowStatusBar=<span class="hljs-string">"True"</span> ShowElapsedTime=<span class="hljs-string">"False"</span> ExcludeFields=<span class="hljs-string">"lastname,age,manager"</span> /&gt;
</code></pre>
<p><strong>支持目标框架：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a6ac91b64f1487cb954e7806396f2b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765025673&amp;x-signature=4ZH9ua%2ByRY8UZFUsuuAHyNeXcHo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">项目源代码</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6a72f386e2d4bb5b4917d3c627db528~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765025673&amp;x-signature=DEzlgHED5TKBkqF33eiBYGuKus0%3D" alt="" loading="lazy"/></p>
<p><strong>多语言支持：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef29443e829440a29ab24ca8dd8a4407~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765025673&amp;x-signature=XLzWToKdpG2kAS2sVvhN5SYuvG4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f413fedd0bf4f80bf87fa374eafbb50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765025673&amp;x-signature=9eKw%2Fjzz2cIBMuhuQQtW3GhPRTk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">项目运行效果</h2>
<p>设置<code>DemoApp.Net8.0</code>为启动项目，查看运行效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54512ef544874d40a720be27271bdac1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765025673&amp;x-signature=m78hzSrmQovnZmCrR8x6tz7%2FTeM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f4ba238073042a5acfbaf91faf2e156~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765025673&amp;x-signature=%2FDHKEmigT7L7TPYq6d4XhEXlPHY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcd5ba2b8a8c47c3b1e98a3ba2f0b190~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765025673&amp;x-signature=AFsxyF%2BH3aUFK7f0OTRHL%2FU4%2FYY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/137d71658a7945f69ca0f23d55475db0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765025673&amp;x-signature=TGyZdBrkaTvBWS2pkg2UB%2FMTQ7k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">项目源码地址</h2>
<p>更多项目实用功能和特性欢迎前往项目开源地址查看👀，别忘了给项目一个Star支持💖。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmacgile%2FDataGridFilter" target="_blank" title="https://github.com/macgile/DataGridFilter" ref="nofollow noopener noreferrer">github.com/macgile/Dat…</a></li>
</ul>
<h2 data-id="heading-7">优秀项目和框架精选</h2>
<p>该项目已收录到C#/.NET/.NET Core优秀项目和框架精选中，关注优秀项目和框架精选能让你及时了解C#、.NET和.NET Core领域的最新动态和最佳实践，提高开发工作效率和质量。坑已挖，欢迎大家踊跃提交PR推荐或自荐（<strong>让优秀的项目和框架不被埋没🤞</strong>）。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li><strong>Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[被 LangChain 全家桶搞晕了？LangGraph、LangSmith、LangFlow 一文读懂]]></title>    <link>https://juejin.cn/post/7577675494067650586</link>    <guid>https://juejin.cn/post/7577675494067650586</guid>    <pubDate>2025-11-29T11:13:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577675494067650586" data-draft-id="7577295460248797230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="被 LangChain 全家桶搞晕了？LangGraph、LangSmith、LangFlow 一文读懂"/> <meta itemprop="keywords" content="LangChain,Agent,LLM"/> <meta itemprop="datePublished" content="2025-11-29T11:13:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            被 LangChain 全家桶搞晕了？LangGraph、LangSmith、LangFlow 一文读懂
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T11:13:01.000Z" title="Sat Nov 29 2025 11:13:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>如果你正开发大模型应用，那你肯定绕不开 LangChain。但很快，你就会发现它的生态里冒出了 <strong>LangGraph、LangSmith、LangFlow</strong> 等一堆“亲戚”，让人有点摸不着头脑。它们之间到底是什么关系？我的项目究竟该用哪个？</p>
<p>这篇文章就是为了把这事儿说清楚。我们会逐一拆解这四个工具，帮你理解它们各自是干什么的，解决了什么问题，以及什么时候该轮到谁上场。</p>
<p>简单来说，这是一个开发者从原型到生产的典型路径：</p>
<ul>
<li> <strong>LangChain</strong>: 基础框架，用来快速搭建应用原型。它提供了模块化的组件（Prompts, Models, Tools）和一套名为 LCEL 的粘合剂。适合构建线性的、一步接一步的工作流。</li>
<li> <strong>LangGraph</strong>: 流程编排器，当你的应用逻辑变得复杂，需要循环、分支、重试时，就该它出场了。它把应用看作一个图，让你能精细控制状态和流程。这是构建生产级、有韧性的 Agent 的关键。</li>
<li> <strong>LangSmith</strong>: 可观测性平台，你的“调试器”和“监控眼”。它能帮你追踪应用每一步的运行细节，评估效果，监控线上问题。它独立于框架，无论你用不用 LangChain 都能集成。</li>
<li> <strong>LangFlow</strong>: 可视化构建器，一个拖拽式的画布，让你快速实验和搭建流程。非常适合团队协作、教学演示，或者是不熟悉代码的同事参与进来。</li>
</ul>
<p>一个经验之谈：通常我们用 LangChain 起步，随着业务逻辑复杂化，迁移到 LangGraph，同时用 LangSmith 监控全程，而 LangFlow 则在需要快速验证想法或与团队沟通时发挥价值。</p>
<h2 data-id="heading-0">LangChain：构建工作流的基础</h2>
<p>LLM本身一次只能处理一个 Prompt，但实际应用往往是一系列操作的组合：获取数据、调用工具、总结思考、甚至向用户追问。LangChain 的核心价值就是把这些零散的步骤串联起来。</p>
<p>我喜欢把它看作一套用于 LLM 应用的“乐高积木”，提供了诸如 Prompts、Models、Memory、Tools、Retrievers 这些标准件。而将这些积木粘合起来的，就是 <strong>LCEL（LangChain Expression Language）</strong> 。</p>
<h3 data-id="heading-1">LCEL：用管道符 <code>|</code> 串联一切</h3>
<p>LCEL 的设计哲学非常直观，就是用管道符 <code>|</code> 把不同的组件连接成一个可执行的链（Chain）。每个组件都是一个 <code>Runnable</code> 对象，可以无缝拼接。</p>
<p>来看个最简单的例子：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser

llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>)
prompt = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"You are concise."</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{question}"</span>)
])
<span class="hljs-comment"># 这就是 LCEL 的魔力：像搭管道一样把组件连起来</span>
chain = prompt | llm | StrOutputParser()

<span class="hljs-comment"># 单次调用</span>
<span class="hljs-built_in">print</span>(chain.invoke({<span class="hljs-string">"question"</span>: <span class="hljs-string">"Give me 3 focus tips."</span>}))

<span class="hljs-comment"># 批量调用</span>
qs = [{<span class="hljs-string">"question"</span>: q} <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> [<span class="hljs-string">"One tactic for RAG?"</span>, <span class="hljs-string">"Explain LCEL in 1 line."</span>]]
<span class="hljs-built_in">print</span>(chain.batch(qs))
</code></pre>
<p>代码里，<code>prompt</code>、<code>llm</code> 和 <code>StrOutputParser</code> 三个部分通过 <code>|</code> 组合成一个 <code>chain</code>。这个 <code>chain</code> 不仅可以通过 <code>invoke()</code> 执行单次任务，还能用 <code>batch()</code> 并行处理多个输入，效率很高。这种声明式的写法让代码非常清晰。</p>
<h3 data-id="heading-2">结构化输出与工具调用</h3>
<p>真实场景中，我们很少只需要纯文本回复。我们更希望 LLM 能返回格式化的数据（比如 JSON），或者调用外部工具（比如 API 查询）。</p>
<p>LangChain 结合 Pydantic 可以轻松实现结构化输出。通过 <code>.with_structured_output()</code> 方法，你可以告诉模型必须按照指定的 Pydantic 模型格式返回结果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskPlan</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    title: <span class="hljs-built_in">str</span>
    steps: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = Field(..., min_items=<span class="hljs-number">3</span>, description=<span class="hljs-string">"actionable steps"</span>)

structured_llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>).with_structured_output(TaskPlan)
plan = structured_llm.invoke(<span class="hljs-string">"Plan a 20-minute deep-work session for AI Agent notes."</span>)
<span class="hljs-built_in">print</span>(plan.model_dump())
</code></pre>
<p>这样一来，你得到的 <code>plan</code> 就是一个可以直接操作的 Python 对象，而不是一堆需要手动解析的字符串。</p>
<p>工具调用也同样简单。你可以用 <code>@tool</code> 装饰器把任何 Python 函数包装成一个 LLM 可以调用的工具，然后通过 <code>.bind_tools()</code> 方法“告诉”模型它有哪些工具可用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""This tool multiplies two numbers."""</span>
    <span class="hljs-keyword">return</span> a * b

llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>)
<span class="hljs-comment"># 把工具“绑定”给模型</span>
llm_with_tools = llm.bind_tools([multiply])

resp = llm_with_tools.invoke(<span class="hljs-string">"What is 9*5? If needed, use a tool."</span>)
<span class="hljs-built_in">print</span>(resp.tool_calls <span class="hljs-keyword">or</span> resp.content)
</code></pre>
<p>当模型判断需要使用工具时，它的返回结果中就会包含工具调用的信息，包括工具名称和参数。</p>
<p>LangChain 在处理线性、简单的应用时非常得心应手。但如果你的逻辑开始出现“如果...那么...”、“重试 N 次”、“等待用户输入”这类情况，单纯的链式结构就显得力不从心了。这时候，就轮到 LangGraph 登场。</p>
<h2 data-id="heading-3">LangGraph：为复杂 Agent 打造的流程引擎</h2>
<p>可以把 LangGraph 理解为构建在 LangChain 组件之上的、更强大的流程编排引擎。它不再把应用看作一条直线，而是<strong>一个状态图（State Graph）</strong> 。</p>
<p>这个概念听起来有点抽象，我用一个比喻来解释：</p>
<p>想象一下，你的应用是一个机器人，它背着一个**背包（State）<strong>在</strong>一张流程图（Graph）<strong>上移动。图上的每个</strong>站点（Node）**都是一个具体的操作（比如调用 LLM、执行工具）。机器人每到一个站点，就会从背包里拿出当前的信息，完成任务，再把新的信息放回背包。**箭头（Edge）**则决定了机器人下一步该去哪个站点。</p>
<p>这种模式天然适合处理复杂的逻辑：</p>
<ul>
<li> <strong>分支</strong>：可以根据背包里的状态，决定走不同的箭头。</li>
<li> <strong>循环</strong>：可以让箭头指回之前的站点，实现循环追问或重试。</li>
<li> <strong>持久化</strong>：可以随时把背包里的状态存起来，下次接着用。</li>
</ul>
<h3 data-id="heading-4">一个基础的 Graph</h3>
<p>我们来看一个最基础的 LangGraph 应用，它只有一个调用模型的节点。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict, Annotated, <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END
<span class="hljs-keyword">from</span> langgraph.graph.message <span class="hljs-keyword">import</span> add_messages
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage

<span class="hljs-comment"># 这就是那个“背包”，定义了应用的状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-comment"># messages 会自动累积聊天记录</span>
    messages: Annotated[<span class="hljs-type">List</span>, add_messages]

llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4o"</span>)

<span class="hljs-comment"># 这是一个“站点”，接收当前状态，调用模型，并返回要更新的状态</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">model_node</span>(<span class="hljs-params">state: State</span>):
    reply = llm.invoke(state[<span class="hljs-string">"messages"</span>])
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: [reply]}

<span class="hljs-comment"># 开始构建图</span>
graph_builder = StateGraph(State)
graph_builder.add_node(<span class="hljs-string">"model"</span>, model_node) <span class="hljs-comment"># 添加一个名为 "model" 的节点</span>
graph_builder.add_edge(START, <span class="hljs-string">"model"</span>)      <span class="hljs-comment"># 从起点连接到 "model" 节点</span>
graph_builder.add_edge(<span class="hljs-string">"model"</span>, END)        <span class="hljs-comment"># 从 "model" 节点连接到终点</span>

<span class="hljs-comment"># 编译图，得到一个可执行的应用</span>
app = graph_builder.<span class="hljs-built_in">compile</span>()

<span class="hljs-comment"># 运行</span>
initial_state = {<span class="hljs-string">"messages"</span>: [HumanMessage(content=<span class="hljs-string">"Explain LangGraph in one sentence."</span>)]}
result = app.invoke(initial_state)
<span class="hljs-built_in">print</span>(result[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].content)
</code></pre>
<p>这段代码的核心是 <code>StateGraph</code>。我们定义了状态 <code>State</code>，然后添加节点和边，最后 <code>compile()</code> 得到一个可运行的 <code>app</code>。</p>
<h3 data-id="heading-5">引入分支逻辑</h3>
<p>LangGraph 真正的威力体现在处理分支上。我们可以定义一个“路由”函数，它根据当前状态决定下一步该走向哪个节点。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ... (省略 State, llm 的定义)</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">answer_node</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: [llm.invoke(state[<span class="hljs-string">"messages"</span>])]}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">clarify_node</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: [AIMessage(content=<span class="hljs-string">"Could you share a bit more so I can be precise?"</span>)]}

<span class="hljs-comment"># 这是一个路由函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">route</span>(<span class="hljs-params">state: State</span>):
    last_human_message = <span class="hljs-built_in">next</span>((m <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(state[<span class="hljs-string">"messages"</span>]) <span class="hljs-keyword">if</span> m.<span class="hljs-built_in">type</span> == <span class="hljs-string">"human"</span>), <span class="hljs-literal">None</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> last_human_message <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">str</span>(last_human_message.content).split()) &lt; <span class="hljs-number">3</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"clarify"</span> <span class="hljs-comment"># 如果问题太短，就去 clarify 节点</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"answer"</span>  <span class="hljs-comment"># 否则去 answer 节点</span>

graph_builder = StateGraph(State)
graph_builder.add_node(<span class="hljs-string">"answer"</span>, answer_node)
graph_builder.add_node(<span class="hljs-string">"clarify"</span>, clarify_node)

<span class="hljs-comment"># 添加一个条件边，由 route 函数决定走向</span>
graph_builder.add_conditional_edges(
    START,
    route,
    {<span class="hljs-string">"answer"</span>: <span class="hljs-string">"answer"</span>, <span class="hljs-string">"clarify"</span>: <span class="hljs-string">"clarify"</span>}
)

graph_builder.add_edge(<span class="hljs-string">"answer"</span>, END)
graph_builder.add_edge(<span class="hljs-string">"clarify"</span>, END)
app = graph_builder.<span class="hljs-built_in">compile</span>()
</code></pre>
<p>通过 <code>add_conditional_edges</code>，我们实现了一个简单的智能路由：如果用户的问题太简短，就先追问一句；否则直接回答。这正是构建健壮 Agent 所需的控制能力。再我看来，这是 LangGraph 比 Langchian 强大的地方。</p>
<h2 data-id="heading-6">LangSmith：让你的应用不再是黑盒</h2>
<p>开发 LLM 应用一个很大的痛点是调试。当应用出问题时，你很难知道是哪个环节的 Prompt 写得不好，还是工具调用失败了。LangSmith 就是解决这个问题的。</p>
<p>它是一个**可观测性（Observability）**平台，可以捕获你的应用每一次运行的完整轨迹（Trace），包括：</p>
<ul>
<li>每个节点的输入和输出。</li>
<li>LLM 调用的具体 Token 数和耗时。</li>
<li>工具调用的参数和返回结果。</li>
<li>发生的任何错误。</li>
</ul>
<p>集成 LangSmith 非常简单，通常只需要设置几个环境变量。一旦启用，你就可以在它的 Web UI 上看到详尽的运行日志，对于定位问题和优化性能非常有帮助。</p>
<p>更重要的是，LangSmith 还提供了一套**评估（Evaluation）<strong>框架。你可以创建数据集，针对应用的每次修改跑回归测试</strong>，或者通过人工标注、模型打分等方式来量化应用的表现。这对于保证应用质量、防止效果退化至关重要。</p>
<p>它的一个巨大优势是<strong>框架不可知（Framework-Agnostic）</strong> ，无论你的应用是不是用 LangChain 或 LangGraph 写的，都可以接入 LangSmith 进行监控。</p>
<h2 data-id="heading-7">LangFlow：拖拽式搭建 AI 应用</h2>
<p>LangFlow 提供了一个可视化的画布，让你通过拖拽组件和连接线的方式来构建 LangChain 应用。</p>
<p>这对于以下场景特别有用：</p>
<ul>
<li> <strong>快速原型</strong>：当你有一个想法，想快速验证它是否可行时，用 LangFlow 拖拽几下就能搭出原型，比写代码快得多。</li>
<li> <strong>团队协作</strong>：可以让不写代码的产品经理或设计师在画布上设计应用逻辑，然后导出成 JSON 文件或 Python 代码交给工程师实现。</li>
<li> <strong>教学演示</strong>：在工作坊或教学中，用图形化界面来解释 LangChain 的概念会非常直观。</li>
</ul>
<p>你可以把 LangFlow 理解为一个“AI 应用的 Visio**”。它降低了上手的门槛，让更多人能参与到 AI 应用的构建中来。当流程稳定后，可以一键导出为可部署的代码，交给工程师去完善。将想法快速得转化为代码，这点非常棒。</p>
<h2 data-id="heading-8">四者对比：一张图看懂如何选择</h2>
<p>为了让你更清晰地了解它们的分工，我整理了下面这张表格：</p>






















































<table><thead><tr><th><strong>类别</strong></th><th><strong>LangChain</strong></th><th><strong>LangGraph</strong></th><th><strong>LangSmith</strong></th><th><strong>LangFlow</strong></th></tr></thead><tbody><tr><td><strong>一句话定位</strong></td><td>LLM 应用的模块化构建<strong>基础框架</strong>。</td><td>复杂、有状态的<strong>流程编排引擎</strong>。</td><td>应用的<strong>可观测性与评估平台</strong>。</td><td><strong>可视化</strong>的拖拽式应用构建器。</td></tr><tr><td><strong>核心组件</strong></td><td>Chains, Runnables, LCEL</td><td>Nodes, Edges, State, Routers</td><td>Traces, Datasets, Evaluators</td><td>画布、组件、连接线</td></tr><tr><td><strong>工作流结构</strong></td><td>线性或有向无环图 (DAG)，主要是单向流动。</td><td>完整的图结构，支持循环、分支和暂停。</td><td>它不执行工作流，而是<strong>记录和评估</strong>工作流。</td><td>可视化的图，最终导出为 LangChain 代码。</td></tr><tr><td><strong>状态管理</strong></td><td>通常是隐式或组件内部局部管理。</td><td><strong>中心化、显式</strong>的状态对象，贯穿整个图，支持持久化。</td><td>存储运行的元数据、输入输出和评估指标。</td><td>组件的配置保存在流程的 JSON 文件中。</td></tr><tr><td><strong>适用场景</strong></td><td>快速原型验证、逻辑简单的线性应用（如简单 RAG）。</td><td>生产级的 Agent、多智能体协作、需要重试和容错的复杂应用。</td><td>调试、回归测试、线上监控、A/B 测试。</td><td>教学、团队协作、快速搭建原型、与非技术人员沟通。</td></tr><tr><td><strong>学习曲线</strong></td><td>简单，API 直观。</td><td>较陡峭，需要理解图和状态的概念。</td><td>非常简单，通常只需配置环境变量。</td><td>最简单，几乎没有代码门槛。</td></tr></tbody></table>
<h3 data-id="heading-9"/>
<p>希望这篇文章能帮你理清 LangChain 生态中这些工具的关系。记住，它们不是相互竞争，而是一个从简单到复杂、从开发到生产的完整工具链。选择合适的工具，才能事半功倍。</p>
<h2 data-id="heading-10">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当大模型遇上垂直领域：微调如何让 AI 从 “什么都会” 到 “样样精通”？]]></title>    <link>https://juejin.cn/post/7577693903017984026</link>    <guid>https://juejin.cn/post/7577693903017984026</guid>    <pubDate>2025-11-29T11:20:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577693903017984026" data-draft-id="7577663384424054835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当大模型遇上垂直领域：微调如何让 AI 从 “什么都会” 到 “样样精通”？"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-29T11:20:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当大模型遇上垂直领域：微调如何让 AI 从 “什么都会” 到 “样样精通”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T11:20:02.000Z" title="Sat Nov 29 2025 11:20:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdf12a8232d94cec812368e7483402aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020002&amp;x-signature=bgA12I6CCQU3BGsfVcjtAr0s3PI%3D" alt="" loading="lazy"/></p>
<p>在人工智能领域，大模型就像一个 “知识通才”，通过海量数据训练，掌握了广泛的知识和技能。但在实际应用中，我们常常需要模型在特定领域或任务上表现出色，这时就需要用到模型微调（Fine-tuning）了。</p>
<h2 data-id="heading-0"><strong>01</strong> <strong>什么是模型微调？</strong></h2>
<p>简单来说，模型微调是在已经训练好的预训练模型基础上，使用特定领域或任务的数据，对模型的参数进行进一步调整优化的过程。预训练模型就像搭建好的毛坯房，微调就是根据不同的使用需求进行个性化装修。</p>
<p>比如，一个通用的语言模型在经过大量文本训练后，能完成多种语言任务，但当我们想让它专注于医学文献摘要生成时，就可以用医学领域的文献数据对其微调，让它更好地理解和处理医学专业内容。</p>
<hr/>
<h2 data-id="heading-1"><strong>02</strong> <strong>为什么需要微调模型？</strong></h2>
<p>一方面，预训练模型虽然知识储备丰富，但它学习的是通用知识，缺乏对特定领域细节和规则的深度理解。通过微调，模型能针对特定领域的术语、逻辑和任务特点进行学习，从而在专业领域的表现大幅提升。比如，用金融数据微调过的模型，在分析金融报告、预测股票走势时，准确性会比通用模型高很多。</p>
<p>另一方面，微调可以降低训练成本和时间。训练一个模型需要大量的计算资源和时间。而微调是在已有模型基础上进行，就像在现成的框架上做优化，能以相对较低的成本，快速满足特定任务需求。</p>
<hr/>
<h2 data-id="heading-2"><strong>03</strong> <strong>如何微调模型？</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47dc25ec795048f3b4e41c552a895f4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020002&amp;x-signature=USR9iyA5UiGsb3Bx344WDE%2BWlXQ%3D" alt="" loading="lazy"/></p>
<p><strong>1. 明确目标与数据准备</strong></p>
<p>微调前，要清晰界定具体任务，例如是要用于智能客服回答特定行业问题，还是进行特定领域的文本情感分析。根据任务确定数据范围，数据来源可以是公开数据集，像医疗领域的 Cochrane Library，也可以是企业内部积累的业务数据，还可以借助工具生成数据。</p>
<p>同时，要对数据进行清洗，剔除重复、错误、格式混乱的数据，确保数据质量。比如在处理电商评论情感分析数据时，需去除无意义的乱码评论；还要对数据进行标注，如在情感分析任务中，明确标注每条评论是正面、负面还是中性情感，为模型训练提供准确的参考。</p>
<p><strong>2. 选择预训练模型</strong></p>
<p>要综合考量模型的规模、性能、适用场景等因素。如果是处理中文自然语言处理任务，且对模型轻量化有要求，可以选择轻量级模型；若追求高精度的文本生成任务，GPT 系列模型会是不错的选择。同时，还需关注模型的开源情况，开源模型方便获取代码和预训练参数，利于进一步开发和调整。</p>
<p><strong>3. 选择合适的微调平台/工具库</strong></p>
<p>这里列出了几个微调平台/工具库：</p>
<p>◦ LLaMA - Factory：堪称模型微调领域的 “多面手”。它支持超过 100 种主流大模型的微调与部署 ，像 LLaMA、Mistral、DeepSeek 等常见模型都不在话下。其提供的 Web UI 界面十分友好，哪怕你没有深厚的代码功底，也能轻松完成参数配置与训练监控。在微调方法上，全参数微调、LoRA、QLoRA 等高效方式它都支持，能契合不同的资源状况。 </p>
<p>开源链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhiyouga%2FLLaMA-Factory" target="_blank" title="https://github.com/hiyouga/LLaMA-Factory" ref="nofollow noopener noreferrer">github.com/hiyouga/LLa…</a></p>
<p>◦ Unsloth：主打高效的平台，它能让训练速度提升 2 倍，同时减少 80% 的显存占用，对 Llama、Mistral、DeepSeek 等模型均有良好支持。在资源受限的情况下，比如使用消费级显卡，它也能对 DeepSeek 进行快速微调。它原生支持 4 - bit 量化训练，能有效降低训练成本。</p>
<p>链接直达：<a href="https://link.juejin.cn?target=https%3A%2F%2Funsloth.ai%2F%3Fref%3Dwww.ai-321.com" target="_blank" title="https://unsloth.ai/?ref=www.ai-321.com" ref="nofollow noopener noreferrer">unsloth.ai/?ref=www.ai…</a></p>
<p>◦ Hugging Face Transformers + PEFT：PEFT（Parameter-Efficient Fine-Tuning）是 Hugging Face 推出的一个专门用于 大语言模型参数高效微调 的库，目标是在只训练少量参数的同时保持模型性能，显著减少显存消耗和训练成本。它支持 LoRA、Prefix Tuning、P - Tuning v2 等多种高效微调方法。针对不同类型的模型，它提供了官方模型接口以及数据集预处理工具，社区中也沉淀了不少成功案例，方便用户参考学习。</p>
<p>◦ XTuner：上海人工智能实验室（上海AI实验室）发布低成本大模型训练工具箱XTuner，XTuner聚焦于微调环节，为各类开源大模型提供了轻量级微调框架。XTuner支持多种层级硬件的适配，开发者最低只需使用8GB消费级显存，即可训练出适用于具体需求场景的“专属大模型”，“真金白银”拉低大模型训练成本，与各界一道共同推动技术进步。</p>
<p>开源链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FInternLM%2Fxtuner" target="_blank" title="https://github.com/InternLM/xtuner" ref="nofollow noopener noreferrer">github.com/InternLM/xt…</a></p>
<p><strong>4.  参数设置</strong></p>
<p>学习率决定了模型在训练过程中参数更新的步长，一般初始学习率设置在 1e-5 到 1e-3 之间。学习率过大，模型可能在训练过程中跳过最优解；学习率过小，训练速度会变得非常缓慢。训练轮次（Epoch）指的是模型对整个训练数据集进行学习的次数，通常在 3 到 10 次之间。具体数值需要根据数据量和任务复杂程度调整，数据量较小、任务简单时，轮次可以适当减少；反之则需增加。此外，还需设置批量大小（Batch Size），即每次训练送入模型的数据样本数量，常见取值为 16、32、64 等，较大的批量大小能利用 GPU 并行计算加速训练，但对硬件内存要求更高。</p>
<p><strong>5. 模型训练</strong></p>
<p>利用深度学习框架，如 TensorFlow 或 PyTorch，将准备好的数据按设置的参数输入模型进行训练。在训练过程中，模型基于反向传播算法，根据预测结果与真实标签的差异，不断调整内部参数，优化模型对特定数据的处理能力。训练过程中要实时监控训练损失和验证损失，若训练损失持续下降，而验证损失开始上升，可能出现了过拟合现象，需要调整参数或增加正则化处理。</p>
<p><strong>6. 模型评估与优化</strong></p>
<p>大模型的评估需覆盖能力全面性、性能稳定性、伦理安全性等多维度，不同任务（如文本生成、问答、推理等）的指标略有差异。</p>
<ul>
<li>基础能力评估方面：基础能力评估从语言理解（准确率、F1 值）、文本生成（困惑度、BLEU、ROUGE、METEOR）、逻辑推理（GSM8K、MATH、BBH）、知识问答（QA 准确率、Rouge-L、BERTScore）、多模态能力（MSCOCO、Flickr30K）等维度，通过对应指标和方法测试模型在语义理解、内容生成、逻辑推理、知识问答及图文关联等方面的能力。</li>
<li>性能方面：性能与效率评估主要围绕推理速度、显存占用和计算成本展开。推理速度通过每秒 token 数（Tokens/s）、延迟（Latency）衡量，反映模型响应快慢，受硬件（如 GPU/TPU）和模型架构（如 Transformer 并行度）影响；显存占用关注训练 / 推理时的最大内存消耗（如 GPU 显存），其高低影响模型在消费级设备的部署可行性，可通过 4bit/8bit 量化等方式优化；计算成本则通过 FLOPs（浮点运算次数）和训练时长体现，与模型参数量、优化算法相关，用于评估训练 / 推理的资源消耗情况。</li>
<li>伦理安全方面：鲁棒性与安全性评估通过对抗样本攻击成功率、跨领域泛化能力衡量模型鲁棒性，以有害内容生成率、偏见检测评估伦理安全，借助注意力可视化等方法进行可解释性分析。</li>
<li>评估方法方面:大模型评估方法包括利用基准测试集（如 GLUE、SuperGLUE、MMLU）和工具库（如 Hugging Face Evaluate）的自动化评估、专家打分和用户调研等人工评估，以及在生产环境中通过日志分析进行输入分布、输出质量和性能指标监控的实时监控评估。</li>
</ul>
<hr/>
<h2 data-id="heading-3"><strong>04</strong> <strong>总结</strong></h2>
<p>模型微调就像给 “知识通才” 定制专业课程，让它摇身一变成为 “行业专家”。掌握模型微调技术，选对合适的平台，能让大模型更好地服务于我们的生活和工作，在各个专业领域发挥更大的价值。</p>
<h3 data-id="heading-4">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 入门①：什么是 LangChain？LLM 应用开发的 “好帮手”]]></title>    <link>https://juejin.cn/post/7577705544874541094</link>    <guid>https://juejin.cn/post/7577705544874541094</guid>    <pubDate>2025-11-29T11:33:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544874541094" data-draft-id="7577675494067666970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 入门①：什么是 LangChain？LLM 应用开发的 “好帮手”"/> <meta itemprop="keywords" content="Agent,LangChain,LLM"/> <meta itemprop="datePublished" content="2025-11-29T11:33:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 入门①：什么是 LangChain？LLM 应用开发的 “好帮手”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T11:33:18.000Z" title="Sat Nov 29 2025 11:33:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ff60b9ae1cf40c0952a1989a41032f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020798&amp;x-signature=ZC4bJ4TBeUrl85arVxqIkSX%2BKBk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1.LangChain概述</h2>
<blockquote>
<p>❝</p>
<p>LangChain是 2022年10月 ，由哈佛大学的 Harrison Chase （哈里森·蔡斯）发起研发的一个开源框架，用于开发由大语言模型（LLMs）驱动的应用程序。</p>
<p>比如，搭建“智能体”（Agent）、问答系统（QA）、对话机器人、文档搜索系统、企业私有知识库等。
‍</p>
</blockquote>
<h3 data-id="heading-1">常用的LLM开发框架</h3>















































<table><thead><tr><th>开发语言</th><th>开发框架</th><th>stars数量</th><th>推荐指数</th></tr></thead><tbody><tr><td>Python</td><td>LangChain</td><td>112k</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>Python</td><td>LlamaIndex</td><td>43.3k</td><td>⭐⭐⭐⭐</td></tr><tr><td>Java</td><td>LangChain4J</td><td>8.5k</td><td>⭐⭐⭐</td></tr><tr><td>Java</td><td>SpringAl</td><td>6.2k</td><td>⭐⭐</td></tr><tr><td>Java</td><td>SpringAl Alibaba</td><td>5.0k</td><td>⭐⭐</td></tr><tr><td>C#</td><td>SemanticKernel</td><td>25.5k</td><td>⭐⭐⭐</td></tr></tbody></table>
<ul>
<li><code>LangChain</code>：这些工具里出现最早、最成熟的，适合复杂任务分解和单智能体应用LlamaIndex ：专注于高效的索引和检索，适合 RAG 场景。（注意不是Meta开发的）</li>
<li><code>LangChain4J</code>：LangChain还出了Java、JavaScript（LangChain.js）两个语言的版本，</li>
<li><code>LangChain4j</code>的功能略少于<code>LangChain</code>，但是主要的核心功能都是有的</li>
<li>SpringAI/SpringAI Alibaba ：有待进一步成熟，此外只是简单的对于一些接口进行了封装</li>
<li>SemanticKernel ：也称为sk，微软推出的，对于C#同学来说，那就是5颗星</li>
</ul>
<h3 data-id="heading-2">基于RAG架构开发（Retrieval-Augmented Generation）</h3>
<ul>
<li>RAG：全称Retrieval-Augmented Generation（检索增强生成）</li>
<li>作用：为大模型提供“知识库”，通过处理将数据存储到<code>向量存储</code>中，大模型根据用户输入，在<code>向量存储</code>中匹配需要的数据，并根据数据进行回答</li>
</ul>
<h4 data-id="heading-3">RAG架构图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/151ec28aeb214ad6a80306494572e7d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020798&amp;x-signature=9DbITkejujQE6%2FkLuv8EXj7%2FxSk%3D" alt="" loading="lazy"/></p>
<p>类似结构图：</p>
<p>‍</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10637767e5a6408cb634b72f3cb5d54f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020798&amp;x-signature=qsWVWNwqzj7wraxoM%2FR3Fprh1%2BU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">基于Agent架构开发</h3>
<p>对比RAG，Agent更加依赖LLM的推理决策能力，通过增加<code>规划</code>、<code>记忆</code>和<code>工具</code>调用的能力，构造一个能够独立思考、逐步完成给定目标的智能体。</p>
<blockquote>
<p>❝</p>
<h3 data-id="heading-5">举例</h3>
<p>目前市面上比较火的AI编辑插件：<code>cline</code>本质上也是一个Agent</p>
<ul>
<li>cline 是一款 Visual Studio Code 的开源 AI 编程辅助插件。</li>
</ul>

<ul>
<li>它能够利用模型、工具和指令这三个构建模块自主生成代码，还可在获得用户许可后创建和编辑文件、运行命令、使用浏览器等，独立完成复杂的软件开发任务，符合智能体的定义。</li>
</ul>
</blockquote>
<h4 data-id="heading-6">Agent架构图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d47f91aaacd8471a8ba1913a83ba7ad2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020798&amp;x-signature=N%2BcVNJNBbdvLCDwY3%2Be9j8aRr3E%3D" alt="" loading="lazy"/>
‍</p>
<p>一个个数学公式来表示：</p>
<blockquote>
<p>❝</p>
<h3 data-id="heading-7">Tips</h3>
<p>Agent和RAG不是冲突的，两个架构往往可以结合使用，实现1+1＞2的效果</p>
</blockquote>
<h3 data-id="heading-8">大模型应用开发的4个场景</h3>
<h4 data-id="heading-9">场景1：纯Prompt</h4>
<ul>
<li>Prompt是操作大模型的唯一接口</li>
<li>当人看：你说一句，ta回一句，你再说一句，ta再回一句...</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/505b4358291c460aacb46695cf20ca51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020798&amp;x-signature=GKoz5rJ6erVRwP0XOwm80MLdROc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">场景2：Agent + Function Calling</h4>
<ul>
<li>Agent：AI 主动提要求</li>
<li>Function Calling：需要对接外部系统时，AI 要求执行某个函数</li>
<li>当人看：你问 ta「我明天去杭州出差，要带伞吗？」，ta 让你先看天气预报，你看了告诉ta，ta再告诉你要不要带伞</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13524f5ce01b4ed6b45618b1d5f587ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020798&amp;x-signature=QWgQGTiyUc2vrqt2nAGOyPj2vrc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11">场景3：RAG (Retrieval-Augmented Generation）</h4>
<p>‍RAG：需要补充领域知识时使用</p>
<ul>
<li>Embeddings：把文字转换为更易于相似度计算的编码。这种编码叫向量</li>
<li>向量数据库：把向量存起来，方便查找</li>
<li>向量搜索：根据输入向量，找到最相似的向量</li>
</ul>
<p>举例：考试答题时，到书上找相关内容，再结合题目组成答案</p>
<p>‍<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8df00a0712ae4323a3afa91b34cb0a87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020798&amp;x-signature=TFd4GLCIvszQGH%2BC%2Fuk4cQ9Qjx8%3D" alt="" loading="lazy"/></p>
<p>RAG在智能客服中用的最广泛。</p>
<p>‍### 场景4：Fine-tuning(精调/微调)</p>
<p>‍举例：努力学习考试内容，长期记住，活学活用。</p>
<p>‍<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ef5e81ec8c14cefad2aef6b43e74f25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020798&amp;x-signature=WWnSUXjBctHnHoLaw8vJYUkaJCY%3D" alt="" loading="lazy"/></p>
<p>特点：成本最高；在前面的方式解决不了问题的情况下，再使用。</p>
<p>‍<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/988c0cee25f3463bb2ab74f81a95f278~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020798&amp;x-signature=uf1FdqXvJFVv%2BdV0vJzUnVm%2B304%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">核心组件</h3>
<hr/>
<ul>
<li>Model I/O模块：使用最多，也最简单</li>
<li>Chains 模块： 最重要的模块</li>
<li>Retrieval模块、Agents模块：大模型的主要落地场景</li>
<li>在这个基础上，其它组件要么是它们的辅助，要么只是完成常规应用程序的任务。</li>
<li>辅助：⽐如，向量数据库的分块和嵌⼊，⽤于追踪、观测的Callbacks任务：⽐如，Tools，Memory
‍</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb33fc19431c4786828a0bc2549df0c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765020798&amp;x-signature=TVCGRZgS5UfOBoRf45Zouv7CCFE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI基础入门（应用开发篇）——LangChain：核心抽象]]></title>    <link>https://juejin.cn/post/7577689171222282290</link>    <guid>https://juejin.cn/post/7577689171222282290</guid>    <pubDate>2025-11-29T11:39:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171222282290" data-draft-id="7577689171222265906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI基础入门（应用开发篇）——LangChain：核心抽象"/> <meta itemprop="keywords" content="LangChain,Agent,LLM"/> <meta itemprop="datePublished" content="2025-11-29T11:39:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI基础入门（应用开发篇）——LangChain：核心抽象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T11:39:07.000Z" title="Sat Nov 29 2025 11:39:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<h2 data-id="heading-0">一、前提</h2>
<ul>
<li>LangChain 是一个 AI 应用开发的生态，包括了开发框架、社区生态和扩展生态。其中，最重要的，也是构成整个生态基础的就是开发框架。</li>
<li>开发框架为我们提供了构建大模型应用的基础抽象和 LangChain 表达式语言，其中，LangChain 表达式语言是为了提高代码的表达性，要想理解 LangChain，关键点就是理解其中的基础抽象。这一讲，我们就来讨论一下 LangChain 的基础抽象。</li>
</ul>
<h2 data-id="heading-1">二、LangChain 提供的最核心的三个抽象</h2>
<h3 data-id="heading-2">2.1、ChatModel</h3>
<ul>
<li>
<p>ChatModel：整个框架的核心，根据输入的内容生成输出。</p>
</li>
<li>
<p>如果你去查看 LangChain 的文档，估计第一个让人困惑的问题一定就是为什么 LangChain 中既有 LLM，也有 ChatModel？</p>
</li>
<li>
<p>它俩的关系其实类似于之前我们说的补全接口和聊天补全接口的关系，LLM 对应的是文本到文本的生成，而 ChatModel 则是对应着由 ChatGPT 带来的聊天模式。</p>
</li>
<li>
<p>大部分情况下，推荐使用 ChatModel，即便对于非聊天应用也是如此，如同聊天补全接口几乎可以替代补全接口，ChatModel 几乎可以完全替代 LLM。所以，我们后面的讨论也集中在 ChatModel 上。</p>
</li>
<li>
<p>我们来看一个例子，它的主要作用就是把一段文字由英文翻译成中文：</p>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage, SystemMessage  
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI  
  
os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = <span class="hljs-string">"你的 API Key"</span>  
os.environ[<span class="hljs-string">"OPENAI_API_BASE"</span>] = <span class="hljs-string">"你的 API Base"</span>  
  
messages = [  
    SystemMessage(content=<span class="hljs-string">"Translate the following from English into Chinese:"</span>),  
    HumanMessage(content=<span class="hljs-string">"Welcome to LLM application development!"</span>),  
]  
  
model = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>)  
result = model.invoke(messages)  
<span class="hljs-built_in">print</span>(result)
</code></pre>
<ul>
<li>
<p>在这段代码里，我们创建了一个 ChatModel，也就是这里的 ChatOpenAI，它负责集成 OpenAI 的模型。在创建这个 ChatModel 的同时，我们指定了使用的具体模型，这里我们用到的是 GPT-4o-mini。</p>
</li>
<li>
<p>正如我们上一讲所说，具体的实现是由社区生态提供的，所以，我们要想使用 ChatOpenAI 模型，需要安装 langchain-openai 这个包。有许多服务提供商会提供多个基础抽象的实现，比如，OpenAI 除了 ChatModel 之外，还提供了 Embedding 模型，所有与 OpenAI 相关的内容都会统一放到 langchain-openai这个包里，LangChain 社区将它们统一称为<strong>供应商（Provider）</strong> ，这里的 OpenAI 就是一个供应商。</p>
</li>
<li>
<p>接下来，就是把消息传给模型。还记得我们在 OpenAI API 提到的消息吗？每条消息都包含角色和内容两个部分，SystemMessage 表示消息的角色是系统，HumanMessage 表示消息的角色是人，对应到 OpenAI API 的底层实现，角色就是用户。然后，我们通过 model.invoke 把消息传给了模型，接下来只需等待返回结果。</p>
</li>
<li>
<p>下面是一次执行的结果，我们前面讲过 OpenAI API 的应答，在这里都可以对应上，我就不过多解释了。</p>
</li>
</ul>
<pre><code class="hljs language-python" lang="python">content=<span class="hljs-string">'欢迎来到大型语言模型应用开发！'</span> additional_kwargs={<span class="hljs-string">'refusal'</span>: <span class="hljs-literal">None</span>} response_metadata={<span class="hljs-string">'token_usage'</span>: {<span class="hljs-string">'completion_tokens'</span>: <span class="hljs-number">8</span>, <span class="hljs-string">'prompt_tokens'</span>: <span class="hljs-number">26</span>, <span class="hljs-string">'total_tokens'</span>: <span class="hljs-number">34</span>, <span class="hljs-string">'completion_tokens_details'</span>: {<span class="hljs-string">'reasoning_tokens'</span>: <span class="hljs-number">0</span>}}, <span class="hljs-string">'model_name'</span>: <span class="hljs-string">'gpt-4o-mini-2024-07-18'</span>, <span class="hljs-string">'system_fingerprint'</span>: <span class="hljs-string">'fp_483d39d857'</span>, <span class="hljs-string">'finish_reason'</span>: <span class="hljs-string">'stop'</span>, <span class="hljs-string">'logprobs'</span>: <span class="hljs-literal">None</span>} <span class="hljs-built_in">id</span>=<span class="hljs-string">'run-12d4417e-811b-467a-a92f-3deec9106db6-0'</span> usage_metadata={<span class="hljs-string">'input_tokens'</span>: <span class="hljs-number">26</span>, <span class="hljs-string">'output_tokens'</span>: <span class="hljs-number">8</span>, <span class="hljs-string">'total_tokens'</span>: <span class="hljs-number">34</span>}

</code></pre>
<ul>
<li>尝试运行这段代码，你会发现，“等待”是执行中最让人难熬的部分，因为我们采用的同步方式执行代码，所以，必须等到所有的内容完全产生之后，我们才能得到响应。你可能想到我要说什么了，没错，我们需要流式响应。我们调整一下代码：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">from langchain_core.messages import HumanMessage, SystemMessage  
from langchain_openai import ChatOpenAI  
  
<span class="hljs-attr">messages</span> = [  
    SystemMessage(content=<span class="hljs-string">"Translate the following from English into Chinese:"</span>),  
    HumanMessage(content=<span class="hljs-string">"Welcome to LLM application development!"</span>),  
]  
  
<span class="hljs-attr">model</span> = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>)  
<span class="hljs-attr">stream</span> = model.stream(messages)  
for response in stream:  
    print(response.content, <span class="hljs-attr">end</span>=<span class="hljs-string">"|"</span>)
</code></pre>
<ul>
<li>
<p>同前面的代码相比，这段代码仅有的变化就是用流处理代替了同步调用，这里调用的函数是 stream，这个函数的返回值是迭代器（Iterator），我们可以用 for 循环来一个一个处理返回的内容。这里我只处理返回的内容部分，为了让结果看得更清楚，我给结果加上了一个分割符，这就是 end="|" 处理的效果。</p>
</li>
<li>
<p>下面就是这段代码一次执行的结果，分割线之间的内容就是一个消息块中的内容：</p>
<pre><code class="hljs">|欢迎|来到|大型|语言|模型|应用|开发|！||
</code></pre>
</li>
<li>
<p>之前我们说过，所有的 LangChain 应用代码核心就是构建一条链。在这里，单独的一个模型也是一条链，只不过这条链上只有一个组件，它就是 ChatModel。前面的两个例子演示的调用方法其实也是链的调用方法。在后面的例子里，我会把重点放在链的组装上，返回结果如何处理在这两个例子里已经做了相应的演示。</p>
</li>
<li>
<p>除了同步调用和流式处理，链还提供了其它的调用方式，比如，批处理和异步调用等。这些调用方式都是在同步调用和流式处理的基础上做了封装，简化代码的编写，你可以在需要时查看相关的文档。</p>
</li>
</ul>
<h3 data-id="heading-3">2.2、PromptTemplate</h3>
<ul>
<li>
<p>PromptTemplate：负责处理输入，有效拆分了开发者提示词和用户提示词。</p>
</li>
<li>
<p>LangChain 把这种预置提示词的方法提炼了出来，引入了一个叫提示词模板（PromptTemplate）的概念。下面是一个例子，这段代码的功效和前面的例子完全一样，只是我用了提示词模板：</p>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">from langchain_core.prompts import ChatPromptTemplate  
from langchain_openai import ChatOpenAI  
  
<span class="hljs-attr">prompt_template</span> = ChatPromptTemplate.from_messages(  
    <span class="hljs-section">[  
        ("system", "Translate the following from English into Chinese:"),  
        ("user", "{text}")  
    ]</span>  
)  
  
<span class="hljs-attr">model</span> = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>)  
  
<span class="hljs-attr">chain</span> = prompt_template | model  
<span class="hljs-attr">result</span> = chain.invoke({<span class="hljs-string">"text"</span>:<span class="hljs-string">"Welcome to LLM application development!"</span>})  
print(result)

</code></pre>
<ul>
<li>
<p>除了使用 ChatPromptTemplate 这个类型之外，提示词模板的部分你会觉得非常眼熟，这和前面例子里面的消息内容几乎一模一样，仅有的差别是在用户消息里面，我们没有采用一个固定的输入，而是引入了一个占位符 text。熟悉各种模板语言的话，通过 {} 定义占位符的方式你一定不陌生，这个位置就是留给用户填写的内容。</p>
</li>
<li>
<p>现在我们有了两个组件（PromptTemplate 和 ChatModel），我们可以通过 LCEL 把它们组成一条链：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">chain</span> = prompt_template | model
</code></pre>
</li>
<li>
<p><strong>在 LCEL 中，组件声明的先后顺序就是处理逻辑的先后顺序</strong>。在这个处理过程中，先是提示词模板把输入参数处理成发给模型的消息，所以，这里把提示词模板写在前面，模型写在后面。</p>
</li>
<li>
<p>有了链之后，就可以调用这条链了。相比于直接传递消息，这次我们在调用传递的是一个变量名及其对应的值。PromptTemplate 内部会先做一个替换，用这里的值替换掉模板中的占位符。如果你想知道替换出来的消息到底长什么样，可以像下面这样查看一下：</p>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">messages</span> = prompt_template.invoke({<span class="hljs-string">"text"</span>:<span class="hljs-string">"Welcome to LLM application development!"</span>})  
print(messages)
</code></pre>
<ul>
<li>引入了 PromptTemplate 之后，开发者写的提示词和用户的消息就完全分开了。开发者可以不断地调整提示词以便达到更好的效果，而这一切对用户完全屏蔽掉了。此外，还有一个好处，就是好的提示词模板是可以共享出来的，我们甚至可以把别人写好的提示词用在自己的代码里。我们在上一讲说过的提示词社区就是这样诞生的。</li>
</ul>
<h3 data-id="heading-4">2.3、OutputParser</h3>
<ul>
<li>
<p>PromptTemplate 处理的是输入，与之对应的是 OutputParser，从名字就可以看出，它是负责处理输出的。在前面的例子里，我们看到的输出都是一个对象，在正常情况下，我们还需要编写代码从这个输出对象中解析出自己所需的信息，比如，想要获得大模型生成的内容，我们要这么写：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">content</span> = result.content
</code></pre>
</li>
<li>
<p>OutputParser 就是把输出结果的解析过程单独拿了出来。LangChain 里提供了一些常用的解析器，比如，把输出结果拿出来就对应着 StrOutputParser。下面是一个例子：</p>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">from langchain_core.prompts import ChatPromptTemplate  
from langchain_core.output_parsers import StrOutputParser  
from langchain_openai import ChatOpenAI  
  
<span class="hljs-attr">prompt_template</span> = ChatPromptTemplate.from_messages(  
    <span class="hljs-section">[  
        ("system", "Translate the following from English into Chinese:"),  
        ("user", "{text}")  
    ]</span>  
)  
  
<span class="hljs-attr">model</span> = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>)  
<span class="hljs-attr">parser</span> = StrOutputParser()  
  
<span class="hljs-attr">chain</span> = prompt_template | model | parser  
<span class="hljs-attr">result</span> = chain.invoke({<span class="hljs-string">"text"</span>:<span class="hljs-string">"Welcome to LLM application development!"</span>})  
print(result)
</code></pre>
<ul>
<li>
<p>这个例子接续了上一个例子的代码，唯一的差别是这里创建了 StrOutputParser，因为它处理的是模型的输出结果，所以，它的声明应该是在模型之后的。正如 StrOutputParser 名字所示，它把输出结果解析成了一个字符串，chain.invoke 在之前的例子里是直接返回一个对象，而因为有了 StrOutputParser，它返回的结果就成了一个字符串：</p>
<pre><code class="hljs">欢迎来到大语言模型应用开发！
</code></pre>
</li>
<li>
<p>当然，输出解析远不止把内容提取出来。LangChain 还提供了许多不同的输出格式解析器，比如：JSON、CSV、分割符、枚举等等。但你可能会有一个疑问，我该怎么让大模型返回这些格式呢？LangChain 已经为我们做好了准备。</p>
</li>
<li>
<p>下面我们来看一个例子，我们让大模型帮我们列出一些著名作者的作品，用 JSON 格式返回：</p>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">
from langchain_core.output_parsers import JsonOutputParser  
from langchain_core.prompts import PromptTemplate  
from langchain_openai import ChatOpenAI  
from pydantic import BaseModel, Field  
  
class Work(BaseModel):  
    title: <span class="hljs-attr">str</span> = Field(description=<span class="hljs-string">"Title of the work"</span>)  
    description: <span class="hljs-attr">str</span> = Field(description=<span class="hljs-string">"Description of the work"</span>)  
  
  
<span class="hljs-attr">parser</span> = JsonOutputParser(pydantic_object=Work)  
  
<span class="hljs-attr">prompt</span> = PromptTemplate(  
    <span class="hljs-attr">template</span>=<span class="hljs-string">"列举3部{author}的作品。\n{format_instructions}"</span>,  
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"author"</span>],  
    <span class="hljs-attr">partial_variables</span>={<span class="hljs-string">"format_instructions"</span>: parser.get_format_instructions()},  
)  
  
<span class="hljs-attr">model</span> = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>)  
  
<span class="hljs-attr">chain</span> = prompt | model | parser  
<span class="hljs-attr">result</span> = chain.invoke({<span class="hljs-string">"author"</span>: <span class="hljs-string">"老舍"</span>})  
print(result)

</code></pre>
<ul>
<li>
<p>在这个例子里，我们首先声明了返回的格式，也就是这里的作品（Work），其中包含了标题（title）和描述（description）两个字段。然后，声明了一个 JsonOutputParser，告诉它根据 Work 这个对象解析结果。</p>
</li>
<li>
<p>关键的部分来了，在声明提示词模板时，除了正常的提示词部分，我们还额外加上了格式指令（format_instructions），它就是对大模型回复内容的约束。然后，我们在partial_variables 里初始化了格式指令这个变量，给它赋值为 parser.get_format_instructions()。</p>
</li>
<li>
<p>是的，LangChain 已经替我们写好了提示词。许多输出解析器都提供了格式指令，我们只要在配置提示词的时候，把它们添加到其中就可以了。当然，如果你愿意深究，完全也可以调用一下模板的 invoke 看看生成的提示词到底是什么样。</p>
</li>
<li>
<p>顺便说一下，这里的 partial_variables 相当于初始化一次的变量，我们可以理解为，它把模板里的一部分内容填写好，生成了一个新的模板，后面使用的就是这个新的模板。相应地，input_variables 是来自用户的输入，所以，每次都有不同的内容。</p>
</li>
<li>
<p>下面是执行这段代码的一次输出，我让它回答了老舍有哪些作品：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[{<span class="hljs-string">'title'</span>: <span class="hljs-string">'骆驼祥子'</span>, <span class="hljs-string">'description'</span>: <span class="hljs-string">'讲述了一个人力车夫的悲惨生活和梦想，反映了旧社会的残酷和人性的复杂。'</span>}, {<span class="hljs-string">'title'</span>: <span class="hljs-string">'四世同堂'</span>, <span class="hljs-string">'description'</span>: <span class="hljs-string">'描绘了一个大家族在抗日战争时期的生活和挣扎，展现了中国传统文化与现代冲突的深刻主题。'</span>}, {<span class="hljs-string">'title'</span>: <span class="hljs-string">'茶馆'</span>, <span class="hljs-string">'description'</span>: <span class="hljs-string">'通过一个茶馆的兴衰反映了社会变迁，揭示了人性、社会和历史的多重层面。'</span>}]</span>
</code></pre>
</li>
<li>
<p>到这里，我们讨论了 LangChain 中最核心的三个抽象：ChatModel、PromptTemplate 和 OutputParser。经过这一讲的讲解，你已经可以编写一些简单的大模型应用了，只要把提示词模板的内容替换成你要完成的工作。当然，LangChain 提供的抽象远不止这些。在接下来的内容中，我会结合具体的应用，给你讲解遇到的各种抽象。</p>
</li>
</ul>
<h2 data-id="heading-5">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mac电脑安装nginx+php]]></title>    <link>https://juejin.cn/post/7577663384423972915</link>    <guid>https://juejin.cn/post/7577663384423972915</guid>    <pubDate>2025-11-29T10:05:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577663384423972915" data-draft-id="7577689171222216754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mac电脑安装nginx+php"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T10:05:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boolean的主人"/> <meta itemprop="url" content="https://juejin.cn/user/2189882894853768"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mac电脑安装nginx+php
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882894853768/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boolean的主人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T10:05:18.000Z" title="Sat Nov 29 2025 10:05:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">一、安装nginx</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#安装nginx</span>
brew install nginx

<span class="hljs-comment">#查看nginx版本</span>
nginx -V

<span class="hljs-built_in">cd</span> /usr/local/etc/nginx

<span class="hljs-built_in">ls</span> -l

<span class="hljs-comment">#如果没有nginx.conf执行下面命令</span>
sudo <span class="hljs-built_in">cp</span> nginx.conf.default nginx.conf

<span class="hljs-comment">#启动nginx服务</span>
brew services start nginx

//查看nginx是否启动成功
ps aux|grep nginx
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>nginx启动成功，以后常用的命令</p>
<pre><code class="hljs language-bash" lang="bash">sudo nginx    <span class="hljs-comment">#启动nginx服务</span>
sudo nginx -s reload    <span class="hljs-comment">#重新载入配置文件</span>
sudo nginx -s stop    <span class="hljs-comment">#停止nginx服务</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h2 data-id="heading-1">二、配置PHP</h2>
<p>系统通常已经默认有安装php了，执行命令查看</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#查看php版本</span>
php -v

<span class="hljs-comment">#配置文件</span>
sudo <span class="hljs-built_in">cp</span> /private/etc/php-fpm.conf.default /private/etc/php-fpm.conf
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>修改错误日志路径</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#编辑配置文件</span>
sudo vim php-fpm.conf

<span class="hljs-comment">#在配置文件里面;error_log下面增加一行</span>
<span class="hljs-attr">error_log</span> = /usr/local/var/log/php-fpm.log
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h2 data-id="heading-2">三、配置nginx</h2>
<p>打开配置文件</p>
<pre><code class="hljs language-bash" lang="bash">vim /usr/local/etc/nginx/nginx.conf
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>找到server , 在location 下增加index.php， 例如</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eda69ce7d7f0445f8f388a0dd9ead376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYm9vbGVhbueahOS4u-S6ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765015518&amp;x-signature=J%2FGOLdRpRHSs8mY6NFMeuJ8UIeo%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5544332020647108df408365f16f2c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYm9vbGVhbueahOS4u-S6ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765015518&amp;x-signature=Pj%2BoIBnbwamrIT3S7c7OnUy0p%2F4%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p>开启FastCGI server</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd6ffdc2cc134f1aa5ada4150a4125ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYm9vbGVhbueahOS4u-S6ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765015518&amp;x-signature=%2BSMRnCDbxs5MBOhFQcDbHpnYNy8%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p>在根目录下新增文件 vim /usr/local/var/www/index.php</p>
<p>内容编辑echo phpinfo();</p>
<p>访问：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Findex.php" title="http://localhost:8080/index.php" target="_blank" ref="nofollow noopener noreferrer">http://localhost:8080/index.php</a></p>
<p>--------------------------------------截止到上面，基本配置已经完成----------------------</p>
<p>后续新增站点配置可以在</p>
<p>目录/usr/local/etc/nginx/servers/ 增加配置文件</p>
<pre><code class="hljs language-ini" lang="ini">vim /usr/local/etc/nginx/servers/www.myphp8.com

<span class="hljs-comment">#内容</span>
server {
    listen       80<span class="hljs-comment">;</span>
    server_name  www.myphp8.com<span class="hljs-comment">;</span>

    location / {
        root  /Users/boolean/myphp/www.myphp8.com<span class="hljs-comment">;</span>
        index  index.html index.htm index.php<span class="hljs-comment">;</span>
    }

    <span class="hljs-comment">#error_page  404              /404.html;</span>

    error_page   500 502 503 504  /50x.html<span class="hljs-comment">;</span>
    <span class="hljs-attr">location</span> = /<span class="hljs-number">50</span>x.html {
        root   html<span class="hljs-comment">;</span>
    }

    <span class="hljs-comment">#</span>
    location ~ \.php$ {
        root   /Users/boolean/myphp/www.myphp8.com<span class="hljs-comment">;</span>
        fastcgi_pass   127.0.0.1:9000<span class="hljs-comment">;</span>
        fastcgi_index  index.php<span class="hljs-comment">;</span>
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name<span class="hljs-comment">;</span>
        include        fastcgi_params<span class="hljs-comment">;</span>

    }
}

</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>添加完配置，重载一下nginx配置</p>
<pre><code class="hljs language-bash" lang="bash">sudo nginx -s reload

vim /etc/hosts 
<span class="hljs-comment">#解析域名</span>
127.0.0.1 www.myphp8.com
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>总结：</p>
<p>1、nginx配置文件目录： /usr/local/etc/nginx</p>
<p>2、后续新增站点配置文件的目录： /usr/local/etc/nginx/servers</p>
<p>3、php文件：/private/etc/php-fpm.conf</p>
<p>4、启动nginx：sudo nginx</p>
<p>5、新增配置站点后重载nginx：sudo nginx -s reload</p>
<p>6、启动php：sudo php-fpm</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mac电脑安装运行多个php版本]]></title>    <link>https://juejin.cn/post/7577653509862785074</link>    <guid>https://juejin.cn/post/7577653509862785074</guid>    <pubDate>2025-11-29T10:07:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577653509862785074" data-draft-id="7577653509862768690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mac电脑安装运行多个php版本"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T10:07:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boolean的主人"/> <meta itemprop="url" content="https://juejin.cn/user/2189882894853768"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mac电脑安装运行多个php版本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882894853768/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boolean的主人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T10:07:13.000Z" title="Sat Nov 29 2025 10:07:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>先执行安装nginx+php8</p>
<p><a href="https://juejin.cn/post/7577663384423972915" target="_blank" title="https://juejin.cn/post/7577663384423972915">juejin.cn/post/757766…</a></p>
<p>后面发现还需要一个php7.4版本的</p>
<h2 data-id="heading-0">一、安装php7.4</h2>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment">#先看看php版本列表</span>
brew search php

<span class="hljs-comment">#安装php7.4</span>
brew install  php@7.<span class="hljs-number">4</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>php8默认安装好了，php7.4安装后</p>
<p>php配置目录：/usr/local/etc/php/7.4/</p>
<p>php安装目录：/usr/local/opt/php@7.4/</p>
<p>php</p>
<p>1、创建目录</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> ~/
<span class="hljs-built_in">mkdir</span> php_program
<span class="hljs-built_in">cd</span> php_program 
<span class="hljs-built_in">mkdir</span> bin
<span class="hljs-built_in">cd</span> bin
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>php8安装目录：/usr/local/opt/php@8.1</p>
<p>php7安装目录：/usr/local/opt/php@7.4</p>
<p>2、创建软链接</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#看看安装目录下是否存在该版本</span>
<span class="hljs-built_in">ls</span> /usr/local/opt/

<span class="hljs-built_in">ln</span> -s /usr/local/opt/php@7.4/bin/php ./php74

<span class="hljs-built_in">ln</span> -s /usr/local/opt/php@8.1/bin/php ./php81
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>3、将该目录写入环境变量</p>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">'export PATH="/Users/boolean/php_program/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile

<span class="hljs-built_in">source</span> ~/.bash_profile


php74 -v

php81 -v
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>修改配置</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#</span>
vim /usr/local/etc/php/7.4/php-fpm.d/www.conf
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54e3c9b699e547c0b2c66b447b1cc1ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYm9vbGVhbueahOS4u-S6ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765015633&amp;x-signature=jH4bIlhUK4CtdGpjCNDW%2Bifc%2B44%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p>启动php7.4</p>
<pre><code class="hljs language-css" lang="css">brew services restart php<span class="hljs-keyword">@7</span>.4
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>配置nginx</p>
<p>/usr/local/etc/nginx/servers/<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.myphp7.com" target="_blank" title="http://www.myphp7.com" ref="nofollow noopener noreferrer">www.myphp7.com</a></p>
<pre><code class="hljs language-ini" lang="ini">server {
    listen       80<span class="hljs-comment">;</span>
    server_name  www.myphp7.com<span class="hljs-comment">;</span>

    location / {
        root  /Users/boolean/myphp/www.myphp7.com<span class="hljs-comment">;</span>
        index  index.html index.htm index.php<span class="hljs-comment">;</span>
    }

    <span class="hljs-comment">#error_page  404              /404.html;</span>

    error_page   500 502 503 504  /50x.html<span class="hljs-comment">;</span>
    <span class="hljs-attr">location</span> = /<span class="hljs-number">50</span>x.html {
        root   html<span class="hljs-comment">;</span>
    }

    <span class="hljs-comment">#</span>
    location ~ \.php$ {
        root   /Users/boolean/myphp/www.myphp7.com<span class="hljs-comment">;</span>
        fastcgi_pass   127.0.0.1:9001<span class="hljs-comment">;</span>
        fastcgi_index  index.php<span class="hljs-comment">;</span>
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name<span class="hljs-comment">;</span>
        include        fastcgi_params<span class="hljs-comment">;</span>

    }
}
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mac电脑安装nvm]]></title>    <link>https://juejin.cn/post/7577675494067601434</link>    <guid>https://juejin.cn/post/7577675494067601434</guid>    <pubDate>2025-11-29T10:03:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577675494067601434" data-draft-id="7577663384423956531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mac电脑安装nvm"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-29T10:03:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boolean的主人"/> <meta itemprop="url" content="https://juejin.cn/user/2189882894853768"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mac电脑安装nvm
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882894853768/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boolean的主人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T10:03:06.000Z" title="Sat Nov 29 2025 10:03:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h3 data-id="heading-0">方案一、常规安装</h3>
<ol>
<li>
<p><strong>下载安装脚本</strong>：在终端中执行以下命令来下载并运行 NVM 的安装脚本3：</p>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.39.5/install.sh | bash
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
</li>
<li>
<p><strong>配置环境变量</strong>：安装完成后，需要配置环境变量。如果你的终端使用的是 bash，打开或创建<code>~/.bash_profile</code>文件，添加以下内容3：</p>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> NVM_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.nvm"</span>
[ -s <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/nvm.sh"</span> ] &amp;&amp; \. <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/nvm.sh"</span>  <span class="hljs-comment"># 加载nvm</span>
[ -s <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/bash_completion"</span> ] &amp;&amp; \. <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/bash_completion"</span>  <span class="hljs-comment"># 加载bash自动补全（可选）</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>如果使用的是 zsh，则打开或创建<code>~/.zshrc</code>文件，添加相同内容。然后执行<code>source ~/.bash_profile</code>或<code>source ~/.zshrc</code>使配置生效。</p>
</li>
</ol>
<h3 data-id="heading-1">方案二、解决网络问题的安装</h3>
<p>如果因为网络原因无法直接访问官方源，可以尝试以下方法：</p>
<ol>
<li>
<p><strong>通过国内镜像下载安装脚本</strong>：可以从 gitee 等国内代码托管平台的镜像下载安装脚本，例如：</p>
<p>bash</p>
<pre><code class="hljs language-ruby" lang="ruby">curl -o- <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/gitee.com/cunkai</span><span class="hljs-regexp">/nvm-cn/raw</span><span class="hljs-regexp">/master/install</span>.sh |<span class="hljs-params"> bash
</span></code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
</li>
<li>
<p><strong>配置 NVM 使用国内镜像</strong>：安装完成后，编辑<code>~/.zshrc</code>（或<code>~/.bashrc</code>），添加以下内容来配置 NVM 使用国内的 Node.js 镜像源：</p>
<p>bash</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> NVM_NODEJS_ORG_MIRROR=https:<span class="hljs-comment">//npmmirror.com/mirrors/node</span>
<span class="hljs-keyword">export</span> NVM_IOJS_ORG_MIRROR=https:<span class="hljs-comment">//npmmirror.com/mirrors/iojs</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>保存后执行<code>source ~/.zshrc</code>或<code>source ~/.bashrc</code>使配置生效。</p>
</li>
</ol>
<p>安装完成后，可以通过<code>nvm -v</code>命令查看 NVM 的版本，以确认是否安装成功。</p>
<p>nvm常用命令</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">;安装node18.16.0</span>
nvm install 18.16.0

<span class="hljs-comment">;查看nvm安装的node版本</span>
nvm list

<span class="hljs-comment">;通过nvm list查看电脑已有的版本号，设置默认的版本</span>
nvm alias default v22.16.0
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WKWebView的重定向（objective_c）]]></title>    <link>https://juejin.cn/post/7577722399374737450</link>    <guid>https://juejin.cn/post/7577722399374737450</guid>    <pubDate>2025-11-29T10:12:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577722399374737450" data-draft-id="7577627308514967593" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WKWebView的重定向（objective_c）"/> <meta itemprop="keywords" content="前端,iOS"/> <meta itemprop="datePublished" content="2025-11-29T10:12:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户197295918891"/> <meta itemprop="url" content="https://juejin.cn/user/413878573337559"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WKWebView的重定向（objective_c）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/413878573337559/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户197295918891
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T10:12:34.000Z" title="Sat Nov 29 2025 10:12:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>第三方支付回调时需要重定向到app的某个页面，比如支付完成后回到原生订单详情页，这个时间会有两种情况：</p>
<p>1、直接在web页面重定向到app的订单详情页，这个时候只需要实现 <code>WKNavigationDelegate</code> 中的一个核心方法<code>webView:decidePolicyForNavigationAction:decisionHandler:</code> 方法。</p>
<p>2、在支付中心跳转到第三方app然后支付完成后需要跳转回自己的app的订单详情页，这个时候可以采用Scheme方式或者是通用链接的方式解决</p>
<h2 data-id="heading-1">wkWebView重定向实现</h2>
<p>实现这一目标，您需要让您的 <code>WKWebView</code> 所在的控制器遵循 <code>WKNavigationDelegate</code> 协议，并实现 <code>webView:decidePolicyForNavigationAction:decisionHandler:</code> 方法。</p>
<pre><code class="hljs language-objective_c" lang="objective_c">self.webView.navigationDelegate = self; // 设置代理

#pragma mark - WKNavigationDelegate 
- (**void**)webView:(WKWebView *)webView

decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction

decisionHandler:(**void** (^)(WKNavigationActionPolicy))decisionHandler {
    NSURL *url = navigationAction.request.URL;
    NSString *scheme = url.scheme;
    // 1. 检查 URL Scheme 是否是我们的自定义 Scheme
    if ([scheme isEqualToString:@"coolpet"]) {
        // 1.1. 阻止 WKWebView 加载这个 URL
        decisionHandler(WKNavigationActionPolicyCancel);
        // 1.2. 实现了 handleCoolPetURL: 方法
        [self handleCoolPetURL:url];
        // 1.3. 跳转后关闭当前的 WebView 页面
        [self.navigationController popViewControllerAnimated:YES];
        return;
    }
    // 2. 对于其他 HTTP/HTTPS 链接，允许正常加载
    // 特别检查 navigationType 是否是新的主框架加载，例如用户点击了链接
//    if (navigationAction.navigationType == WKNavigationTypeLinkActivated &amp;&amp; ![scheme hasPrefix:@"http"]) {
//        // 如果是点击了非 HTTP/HTTPS 的链接（但不是我们自定义的 Scheme），可以根据需要处理，
//        // 比如打开 App Store 或其他应用。这里我们通常允许其他系统 Scheme
//        // 允许继续，但更安全的做法是只允许 http(s)
//        // decisionHandler(WKNavigationActionPolicyAllow);
//    }
    // 3. 默认允许其他所有导航行为（如页内跳转、HTTP/HTTPS 加载等）
    decisionHandler(WKNavigationActionPolicyAllow);
}

// 通过URL跳转对应页面
- (void)handleCoolPetURL:(NSURL *)url {
    NSString *host = url.host;
    NSString *path = url.path;      // 路径: /order/detail
    NSURLComponents *components = [NSURLComponents componentsWithURL:url resolvingAgainstBaseURL:NO];
    NSMutableDictionary *queryParams = [NSMutableDictionary dictionary];
    for (NSURLQueryItem *item in components.queryItems) {
        queryParams[item.name] = item.value;
    }
    // 根据路径判断是否是订单详情页
    if ([host isEqualToString:kAPPUniversalTypeOrderDetailsHost] &amp;&amp; [path isEqualToString:kAPPUniversalTypeOrderDetailsPath]) {
        // 获取我们需要的订单号
        NSString *tradeNo = [queryParams[@"tradeNo"] stringValue];
        // 执行跳转

        if (tradeNo.length &gt; 0) {
            dispatch_async(dispatch_get_main_queue(), ^{
                /// 做跳转
            });
        }
    }
}
</code></pre>
<h2 data-id="heading-2">Scheme方式</h2>
<p>第三方支付平台完成支付后，是通过你App的 <strong>URL Scheme</strong> 来唤醒你的App并携带支付结果的。</p>
<ol>
<li>配置 App URL Scheme</li>
</ol>
<ul>
<li>
<p><strong>操作：</strong> 在 Xcode 项目的 <code>Info.plist</code> 或项目设置的 <strong>Info</strong> 选项卡下的 <strong>URL Types</strong> 中添加你的 App 的 Scheme。</p>
<ul>
<li>例如，你可以设置一个 Scheme 叫 <code>myscheme</code>。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>处理 App Delegate 中的回调</li>
</ol>
<p>App 被第三方支付应用唤醒后，系统会调用 <code>AppDelegate</code> 中的特定方法。你需要在这里接收并处理回调 URL。</p>
<pre><code class="hljs language-objective_c" lang="objective_c">- (BOOL)application:(UIApplication *)app openURL:(NSURL *)url options:(NSDictionary&lt;UIApplicationOpenURLOptionsKey, **id**&gt; *)options {
    // 1. 检查是否是你的支付回调 Scheme
    if ([url.scheme isEqualToString:@"myappscheme"]) {
        [self handleCoolPetURL:url];
    }

    // 如果是其他URL（如通用链接），也在这里处理
    // ...
    return NO;
}
</code></pre>
<h2 data-id="heading-3">通用链接方式</h2>
<p>当用户点击一个配置了通用链接的 HTTPS 链接时：</p>
<ol>
<li>如果 App 已经安装，系统会直接调用 <code>AppDelegate</code> 中的这个方法。</li>
<li>如果 App 未安装，该链接会直接在 Safari 中打开。</li>
</ol>
<p>这个机制的主要优点是<strong>安全</strong>（基于 HTTPS）和<strong>用户体验更好</strong>（避免了 URL Scheme 引起的跳转确认和安全问题）。</p>
<h3 data-id="heading-4">🔗 通用链接（Universal Links）实现指南</h3>
<h4 data-id="heading-5">步骤 1: 服务器端配置（Association File）</h4>
<p>这是通用链接能够工作的基础。您需要在您的 Web 服务器上创建一个特殊的 JSON 文件，告诉 iOS 系统哪些路径应该由您的 App 处理。</p>
<h5 data-id="heading-6">1. 创建 <code>apple-app-site-association</code> 文件</h5>
<ul>
<li>
<p><strong>文件名：</strong> 必须是 <code>apple-app-site-association</code>（注意，没有 <code>.json</code> 扩展名）。</p>
</li>
<li>
<p><strong>内容格式（JSON）：</strong></p>
<pre><code class="hljs language-JSON" lang="JSON"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"applinks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"apps"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"details"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"appID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"TeamID.BundleID"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                    <span class="hljs-string">"/orders/*"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 匹配所有 /orders/ 下的路径</span>
                    <span class="hljs-string">"/products/*"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 匹配所有 /products/ 下的路径</span>
                    <span class="hljs-string">"NOT /account/login/*"</span> <span class="hljs-comment">// 排除某些路径</span>
                <span class="hljs-punctuation">]</span>
            <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong><code>TeamID</code>：</strong> 您的 Apple Developer Team ID。</li>
<li><strong><code>BundleID</code>：</strong> 您的 App 的 Bundle Identifier。</li>
<li><strong><code>paths</code>：</strong> 定义您希望 App 能够处理的 URL 路径。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-7">2. 部署文件</h5>
<ul>
<li>
<p><strong>部署位置：</strong> 将此文件上传到您的域名根目录或 <code>.well-known/</code> 目录下。</p>
<ul>
<li>例如：<code>https://yourdomain.com/apple-app-site-association</code></li>
<li>或者：<code>https://yourdomain.com/.well-known/apple-app-site-association</code></li>
</ul>
</li>
<li>
<p><strong>内容类型：</strong> 确保服务器以正确的 MIME 类型提供此文件：<code>application/json</code> 或 <code>text/plain</code>。</p>
</li>
<li>
<p><strong>HTTPS：</strong> 您的整个网站必须使用 <strong>HTTPS</strong>。</p>
</li>
</ul>
<h4 data-id="heading-8">步骤 2: App 端配置（Xcode &amp; Objective-C）</h4>
<h5 data-id="heading-9">1. 开启 Associated Domains Capability</h5>
<p>在 Xcode 中为您的 App 开启 Associated Domains 功能。</p>
<ul>
<li>
<p><strong>路径：</strong> Xcode -&gt; 项目设置 -&gt; 目标 (Target) -&gt; <strong>Signing &amp; Capabilities</strong> 选项卡</p>
</li>
<li>
<p><strong>操作：</strong> 点击 <code>+ Capability</code>，添加 <strong>Associated Domains</strong>。</p>
</li>
<li>
<p><strong>添加域名：</strong> 在列表中添加您的域名，格式为：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">applinks:yourdomain.com</span>
</code></pre>
<blockquote>
<p><strong>注意：</strong> 不带 <code>https://</code> 或 <code>http://</code>。</p>
</blockquote>
</li>
</ul>
<h5 data-id="heading-10">2. 在 AppDelegate 中接收回调</h5>
<p>当用户点击一个通用链接并唤醒 App 时，系统会调用 <code>AppDelegate</code> 中的 <code>continueUserActivity</code> 方法。您需要在此方法中解析 URL 并进行页面跳转。</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">// AppDelegate.m

#import "OrderViewController.h" // 假设您的订单处理页面

// ...

- (BOOL)application:(UIApplication *)application 
continueUserActivity:(NSUserActivity *)userActivity 
  restorationHandler:(void (^)(NSArray&lt;id&lt;UIUserActivityRestoring&gt;&gt; * _Nullable))restorationHandler {
    
    // 1. 检查活动类型是否为 Universal Link
    if ([userActivity.activityType isEqualToString:NSUserActivityTypeBrowsingWeb]) {
        
        // 2. 获取用户点击的 HTTPS URL
        NSURL *webpageURL = userActivity.webpageURL;
        
        if (webpageURL) {
            NSLog(@"Received Universal Link: %@", webpageURL.absoluteString);
            
            // 3. 将 URL 转发给路由处理方法
            [self handleUniversalLinkURL:webpageURL];
            
            return YES;
        }
    }
    
    return NO;
}

// 通用链接路由处理方法
- (void)handleUniversalLinkURL:(NSURL *)url {
    
    // 示例：解析路径并跳转到订单详情
    if ([url.path hasPrefix:@"/orders/detail"]) {
        
        // 解析查询参数，例如 order_id=12345
        NSString *orderID = [self extractParameter:@"order_id" fromURL:url];
        
        if (orderID.length &gt; 0) {
            dispatch_async(dispatch_get_main_queue(), ^{
                // 执行跳转逻辑
                UINavigationController *nav = (UINavigationController *)self.window.rootViewController;
                OrderViewController *orderVC = [[OrderViewController alloc] init];
                orderVC.orderID = orderID;
                [nav pushViewController:orderVC animated:YES];
            });
        }
    }
}

// 辅助方法 (需要您自行实现，或使用前文提到的 dictionaryWithQueryString: 方法)
- (NSString *)extractParameter:(NSString *)paramName fromURL:(NSURL *)url {
    // ... 解析 url.query 字符串，提取指定参数 ...
    return nil; 
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【 Weapp-1 /Lesson18(2025-11-03)】# 微信小程序开发全解析：从项目结构到生态优势 🚀]]></title>    <link>https://juejin.cn/post/7577681092137533475</link>    <guid>https://juejin.cn/post/7577681092137533475</guid>    <pubDate>2025-11-29T10:12:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577681092137533475" data-draft-id="7577681092137500707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【 Weapp-1  /Lesson18(2025-11-03)】# 微信小程序开发全解析：从项目结构到生态优势 🚀"/> <meta itemprop="keywords" content="微信小程序,微信,程序员"/> <meta itemprop="datePublished" content="2025-11-29T10:12:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jing_Rainbow"/> <meta itemprop="url" content="https://juejin.cn/user/1285809519198256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【 Weapp-1  /Lesson18(2025-11-03)】# 微信小程序开发全解析：从项目结构到生态优势 🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285809519198256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jing_Rainbow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T10:12:15.000Z" title="Sat Nov 29 2025 10:12:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🚀微信小程序自2017年正式上线以来，已经成为中国乃至全球移动互联网生态中不可或缺的重要组成部分。它以“用完即走”的理念、轻量级的体验、以及依托微信强大社交网络的传播能力，迅速在O2O（线上到线下）、电商、工具类应用等领域占据重要地位。本文将基于一个典型的小程序项目结构，深入剖析其技术组成、运行机制、开发规范与生态价值，并结合实际代码示例，全面还原一个现代微信小程序的构建逻辑。</p>
<hr/>
<h2 data-id="heading-0">一、小程序的核心概念与架构设计 💡</h2>
<p>微信小程序<strong>不是网页</strong>，也不运行在浏览器中。它是一个独立的运行环境，由微信客户端提供底层支持。每个页面由四个文件组成，这是小程序开发的基本单位：</p>
<ul>
<li><strong><code>.wxml</code></strong>：模板文件，类似 HTML，但使用的是微信自定义的标签体系（如 <code>&lt;view&gt;</code>、<code>&lt;text&gt;</code>），不支持 <code>&lt;div&gt;</code>。</li>
<li><strong><code>.wxss</code></strong>：样式文件，语法接近 CSS，但支持 <code>rpx</code>（响应式像素）单位，适配不同屏幕。</li>
<li><strong><code>.js</code></strong>：逻辑文件，处理用户交互、数据请求、页面跳转等。</li>
<li><strong><code>.json</code></strong>：配置文件，用于页面或全局的窗口表现、组件引用、权限声明等。</li>
</ul>
<p>这种“四件套”结构强制开发者分离关注点，提升代码可维护性，也便于微信引擎进行性能优化。</p>
<hr/>
<h2 data-id="heading-1">二、项目整体结构概览 🗂️</h2>
<p>一个标准的小程序项目根目录通常包含以下核心文件：</p>
<pre><code class="hljs language-arduino" lang="arduino">├── app.js          <span class="hljs-comment">// 小程序逻辑入口</span>
├── app.json        <span class="hljs-comment">// 全局配置</span>
├── app.wxss        <span class="hljs-comment">// 全局样式（未上传但隐含存在）</span>
├── sitemap.json    <span class="hljs-comment">// 搜索引擎索引配置</span>
├── project.config.json   <span class="hljs-comment">// 项目编译与开发工具配置</span>
├── project.<span class="hljs-keyword">private</span>.config.json <span class="hljs-comment">// 开发者私有配置</span>
├── package.json    <span class="hljs-comment">// npm 依赖管理</span>
├── package-lock.json
├── pages/
│   ├── index/
│   │   ├── index.js
│   │   ├── index.json
│   │   ├── index.wxml
│   │   └── index.wxss
│   └── logs/
│       ├── logs.js
│       └── logs.json
└── utils/
    └── util.js     <span class="hljs-comment">// 工具函数（被 logs.js 引用）</span>
</code></pre>
<h3 data-id="heading-2">1. 全局入口：<code>app.js</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">App</span>({
  <span class="hljs-title function_">onLaunch</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 首次启动时记录时间戳</span>
    <span class="hljs-keyword">const</span> logs = wx.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'logs'</span>) || [];
    logs.<span class="hljs-title function_">unshift</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
    wx.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'logs'</span>, logs);

    <span class="hljs-comment">// 调用微信登录接口</span>
    wx.<span class="hljs-title function_">login</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
        <span class="hljs-comment">// res.code 可发送至开发者服务器换取 openid、session_key</span>
      }
    });
  },
  <span class="hljs-attr">globalData</span>: {
    <span class="hljs-attr">userInfo</span>: <span class="hljs-literal">null</span>
  }
})
</code></pre>
<ul>
<li><code>onLaunch</code> 是小程序初始化时执行的生命周期函数。</li>
<li>利用 <code>wx.getStorageSync</code> 和 <code>wx.setStorageSync</code> 实现本地日志存储。</li>
<li><code>wx.login()</code> 获取临时登录凭证 <code>code</code>，用于后端身份验证。</li>
<li><code>globalData</code> 用于在不同页面间共享数据（虽不推荐作为主要状态管理方式）。</li>
</ul>
<h3 data-id="heading-3">2. 全局配置：<code>app.json</code></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"pages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"pages/index/index"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"pages/logs/logs"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"window"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"navigationBarTextStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"black"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Weixin"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"navigationBarBackgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#ffffff"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"v2"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"componentFramework"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"glass-easel"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sitemapLocation"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sitemap.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lazyCodeLoading"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"requiredComponents"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><code>pages</code> 数组定义了小程序的所有页面路径，<strong>第一项为首页</strong>。</li>
<li><code>window</code> 配置导航栏样式。</li>
<li><code>"style": "v2"</code> 启用新版组件样式（更接近原生体验）。</li>
<li><code>"componentFramework": "glass-easel"</code> 表示使用微信新一代自研组件框架（Glass Easel），性能更优。</li>
<li><code>lazyCodeLoading</code> 支持按需加载组件，减小首包体积。</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、首页功能详解：<code>index</code> 页面 🏠</h2>
<h3 data-id="heading-5">1. 逻辑层：<code>index.js</code></h3>
<p>该文件实现了用户信息的获取与展示，是典型的用户授权流程演示。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> defaultAvatarUrl = <span class="hljs-string">'https://mmbiz.qpic.cn/.../0'</span>;

<span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">motto</span>: <span class="hljs-string">'Hello World'</span>,
    <span class="hljs-attr">userInfo</span>: {
      <span class="hljs-attr">avatarUrl</span>: defaultAvatarUrl,
      <span class="hljs-attr">nickName</span>: <span class="hljs-string">''</span>
    },
    <span class="hljs-attr">hasUserInfo</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">canIUseGetUserProfile</span>: wx.<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'getUserProfile'</span>),
    <span class="hljs-attr">canIUseNicknameComp</span>: wx.<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'input.type.nickname'</span>)
  },

  <span class="hljs-title function_">bindViewTap</span>(<span class="hljs-params"/>) {
    wx.<span class="hljs-title function_">navigateTo</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'../logs/logs'</span> });
  },

  <span class="hljs-title function_">onChooseAvatar</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">const</span> { avatarUrl } = e.<span class="hljs-property">detail</span>;
    <span class="hljs-keyword">const</span> { nickName } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">userInfo</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-string">"userInfo.avatarUrl"</span>: avatarUrl,
      <span class="hljs-attr">hasUserInfo</span>: nickName &amp;&amp; avatarUrl &amp;&amp; avatarUrl !== defaultAvatarUrl
    });
  },

  <span class="hljs-title function_">onInputChange</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">const</span> nickName = e.<span class="hljs-property">detail</span>.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">const</span> { avatarUrl } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">userInfo</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-string">"userInfo.nickName"</span>: nickName,
      <span class="hljs-attr">hasUserInfo</span>: nickName &amp;&amp; avatarUrl &amp;&amp; avatarUrl !== defaultAvatarUrl
    });
  },

  <span class="hljs-title function_">getUserProfile</span>(<span class="hljs-params">e</span>) {
    wx.<span class="hljs-title function_">getUserProfile</span>({
      <span class="hljs-attr">desc</span>: <span class="hljs-string">'展示用户信息'</span>,
      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
          <span class="hljs-attr">userInfo</span>: res.<span class="hljs-property">userInfo</span>,
          <span class="hljs-attr">hasUserInfo</span>: <span class="hljs-literal">true</span>
        });
      }
    });
  }
});
</code></pre>
<h4 data-id="heading-6">关键知识点：</h4>
<ul>
<li>
<p><strong>用户头像与昵称获取策略演变</strong>：</p>
<ul>
<li>旧版使用 <code>wx.getUserInfo()</code>，无需用户确认，存在隐私风险。</li>
<li><strong>新版强制使用 <code>wx.getUserProfile()</code></strong>，每次调用都需用户手动授权弹窗，符合 GDPR 等隐私规范。</li>
<li>同时支持 <code>&lt;input type="nickname"&gt;</code> 和 <code>&lt;button open-type="chooseAvatar"&gt;</code> 组件让用户主动填写/选择，避免频繁弹窗。</li>
</ul>
</li>
<li>
<p><strong><code>setData</code> 的路径更新语法</strong>：</p>
<ul>
<li>使用 <code>"userInfo.avatarUrl"</code> 字符串形式可精准更新嵌套对象属性，避免全量替换。</li>
</ul>
</li>
<li>
<p><strong>能力检测</strong>：</p>
<ul>
<li><code>wx.canIUse()</code> 用于判断当前基础库版本是否支持某 API 或组件特性，保障兼容性。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">2. 配置层：<code>index.json</code></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"usingComponents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"van-search"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vant-weapp/search/index"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>显式声明使用了 <strong>Vant Weapp</strong> 组件库中的 <code>van-search</code> 组件。</li>
<li>这是小程序自定义组件的引入方式，路径相对于 <code>miniprogram_npm</code> 目录（经 npm 构建后生成）。</li>
</ul>
<hr/>
<h2 data-id="heading-8">四、日志页面：<code>logs</code> 页面 📝</h2>
<h3 data-id="heading-9">1. 逻辑层：<code>logs.js</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../utils/util.js'</span>);

<span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">logs</span>: [] },
  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-attr">logs</span>: (wx.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'logs'</span>) || []).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">log</span> =&gt;</span> ({
        <span class="hljs-attr">date</span>: util.<span class="hljs-title function_">formatTime</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(log)),
        <span class="hljs-attr">timeStamp</span>: log
      }))
    });
  }
});
</code></pre>
<ul>
<li>从本地存储读取 <code>logs</code> 数组（由 <code>app.js</code> 在每次启动时写入时间戳）。</li>
<li>使用工具函数 <code>util.formatTime</code> 格式化时间为 “YYYY/MM/DD HH:MM:SS”。</li>
<li>展示历史访问记录，常用于调试或用户行为追踪。</li>
</ul>
<h3 data-id="heading-10">2. 配置层：<code>logs.json</code></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"usingComponents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>无自定义组件引用，保持最简配置。</li>
</ul>
<hr/>
<h2 data-id="heading-11">五、工程化与依赖管理 🧰</h2>
<h3 data-id="heading-12">1. <code>package.json</code> 与 <code>package-lock.json</code></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vant-weapp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.5.29"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>项目依赖 <strong>Vant Weapp</strong> —— 有赞开源的微信小程序 UI 组件库。</li>
<li>版本锁定在 <code>0.5.29</code>，确保团队协作时依赖一致。</li>
</ul>
<blockquote>
<p>⚠️ 注意：Vant Weapp 0.x 是早期版本，现已升级为 Vant 4 for MiniProgram（基于 Vant 4），但许多老项目仍在使用旧版。</p>
</blockquote>
<h3 data-id="heading-13">2. 构建流程</h3>
<ul>
<li>执行 <code>npm install</code> 安装依赖。</li>
<li>在微信开发者工具中点击 <strong>“构建 npm”</strong>，将 <code>node_modules</code> 中的组件复制并转换到 <code>miniprogram_npm</code> 目录。</li>
<li>在 <code>.json</code> 中通过相对路径引用组件。</li>
</ul>
<hr/>
<h2 data-id="heading-14">六、项目配置文件深度解读 ⚙️</h2>
<h3 data-id="heading-15">1. <code>project.config.json</code>（公共配置）</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wx4847e5649ed35ed6"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compileType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"miniprogram"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"libVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"trial"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"setting"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"es6"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"postcss"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"minified"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"enhance"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"minifyWXSS"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"minifyWXML"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"disableSWC"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><code>appid</code> 是小程序唯一标识。</li>
<li><code>libVersion: "trial"</code> 表示使用体验版基础库（可能包含新特性）。</li>
<li>启用 ES6 编译、PostCSS、代码压缩等现代前端工程能力。</li>
<li><code>disableSWC: true</code> 表示禁用 SWC（Speedy Web Compiler），可能因兼容性问题回退到 Babel。</li>
</ul>
<h3 data-id="heading-16">2. <code>project.private.config.json</code>（私有配置）</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"projectname"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"juejin"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"setting"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"compileHotReLoad"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"urlCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"libVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3.11.1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>开发者本地覆盖配置，如开启热重载（保存即刷新）、URL 安全校验。</li>
<li><code>libVersion: "3.11.1"</code> 锁定基础库版本，避免因微信自动升级导致兼容问题。</li>
</ul>
<hr/>
<h2 data-id="heading-17">七、SEO 与开放能力：<code>sitemap.json</code> 🔍</h2>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"desc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"关于本文件的更多信息，请参考文档..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"rules"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"allow"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"page"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>控制小程序页面是否允许被微信搜索索引。</li>
<li><code>"allow", "page": "*"</code> 表示所有页面均可被索引，利于内容分发。</li>
</ul>
<hr/>
<h2 data-id="heading-18">八、生态价值与适用场景 🌐</h2>
<p>正如 <code>readme.md</code> 所强调：</p>
<blockquote>
<p>“微信小程序 AppStore 的 Native App (IOS/Android) 一个 APP，开发两次 → 微信小程序 (Webview) 微信生态的 APP。借助微信的生态，开发一次，用前端技术就可以了，不用开发两个版本。扫个码小，几乎不用安装，扫码即用。特别适合线下 O2O 线下商业。”</p>
</blockquote>
<p>这揭示了小程序的三大核心优势：</p>
<ol>
<li><strong>跨平台一致性</strong>：一套代码同时运行于 iOS 与 Android，节省 50%+ 开发成本。</li>
<li><strong>零安装体验</strong>：用户扫码或搜索即用，极大降低使用门槛。</li>
<li><strong>深度集成微信生态</strong>：无缝调用支付、分享、订阅消息、地理位置、摄像头等原生能力。</li>
</ol>
<p>尤其适用于：</p>
<ul>
<li>餐饮点餐（扫码点单）</li>
<li>商场导览</li>
<li>快递查询</li>
<li>企业服务（预约、工单）</li>
<li>内容阅读（如今日头条、掘金）</li>
</ul>
<hr/>
<h2 data-id="heading-19">九、安全与隐私合规 🔒</h2>
<ul>
<li>用户敏感信息（头像、昵称）必须通过 <code>wx.getUserProfile</code> 主动授权。</li>
<li>登录凭证 <code>code</code> 有效期短，需立即发送至开发者服务器换取 <code>openid</code>（用户唯一标识）和 <code>session_key</code>（用于数据解密）。</li>
<li>禁止在前端存储用户真实身份信息，所有敏感操作应在服务端完成。</li>
</ul>
<hr/>
<h2 data-id="heading-20">十、总结 ✅</h2>
<p>这个看似简单的“Hello World”小程序，实则涵盖了微信小程序开发的<strong>完整技术栈</strong>：</p>
<ul>
<li>页面生命周期管理</li>
<li>用户授权与隐私合规</li>
<li>本地存储与数据绑定</li>
<li>自定义组件引入（Vant Weapp）</li>
<li>npm 工程化构建</li>
<li>多环境配置管理</li>
<li>SEO 优化</li>
<li>跨平台部署能力</li>
</ul>
<p>它不仅是学习小程序的起点，更是理解微信生态下“轻应用”开发范式的缩影。随着微信持续推出 Skyline 渲染引擎、小程序云开发、插件市场等能力，小程序正从“工具”演变为“平台”，成为数字商业不可或缺的基础设施。</p>
<blockquote>
<p>🌟 <strong>未来已来，唯快不破。用小程序，连接十亿用户，只需一行二维码。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java的三大特性：从懵圈到通透的实战指南]]></title>    <link>https://juejin.cn/post/7577693903017803802</link>    <guid>https://juejin.cn/post/7577693903017803802</guid>    <pubDate>2025-11-29T09:05:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577693903017803802" data-draft-id="7577691061032763438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java的三大特性：从懵圈到通透的实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T09:05:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oouy"/> <meta itemprop="url" content="https://juejin.cn/user/402859440221980"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java的三大特性：从懵圈到通透的实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/402859440221980/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oouy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T09:05:57.000Z" title="Sat Nov 29 2025 09:05:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">💬 <strong>前言：我本以为懂了 Java，结果连“封装”都没搞明白</strong></h2>
<p>刚学 Java 的时候，我以为：</p>
<blockquote>
<p>把变量定义好，写几个方法调用，这不就是 Java 吗？简单！</p>
</blockquote>
<p>直到有一天，老师让我写一个学生管理系统，要求：</p>
<ul>
<li><strong>不能直接修改学生的成绩</strong></li>
<li><strong>新增老师类要复用学生的基础信息</strong></li>
<li><strong>打印对象时要显示具体信息</strong></li>
</ul>
<p>我对着代码抓耳挠腮：</p>
<ul>
<li>直接改成绩多方便啊？</li>
<li>复用信息还要重新写一遍？</li>
<li>打印对象怎么全是乱码一样的东西？</li>
</ul>
<p>于是灵魂三问来了：</p>
<blockquote>
<ul>
<li>封装到底封了个啥？</li>
<li>继承怎么就不是复制粘贴？</li>
<li>多态为啥能让一个方法有好几种样子？</li>
</ul>
</blockquote>
<p>今天，就用一个真实学习者的视角，带你从困惑到理解，一步步揭开 <strong>Java 封装、继承、多态</strong> 的神秘面纱。<br/>
<strong>没有高深术语，只有大白话 + 可运行代码 + 我踩过的坑。</strong></p>
<hr/>
<h2 data-id="heading-1">🚪 一、封装（Encapsulation）：给对象装个“安全门”</h2>
<h3 data-id="heading-2">❌ 错误写法：把“家底”全暴露在外</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> name;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> score;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        Student s1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Student</span>();
        s1.name = <span class="hljs-string">"张三"</span>;
        s1.score = <span class="hljs-number">-50</span>; <span class="hljs-comment">// 成绩变成负数？不合理！</span>
        System.out.<span class="hljs-built_in">println</span>(s1.name + <span class="hljs-string">"的成绩："</span> + s1.score); <span class="hljs-comment">// 张三的成绩：-50</span>
    }
}
</code></pre>
<p><strong>问题</strong>：外部可以直接修改内部状态，导致数据非法、逻辑混乱，毫无安全性可言。</p>
<h3 data-id="heading-3">✅ 正确姿势：私有属性 + 公共接口</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> score;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span>(<span class="hljs-params">String name</span>)</span> {
        <span class="hljs-keyword">if</span> (name != <span class="hljs-literal">null</span> &amp;&amp; !name.trim().isEmpty()) {
            <span class="hljs-keyword">this</span>.name = name;
        } <span class="hljs-keyword">else</span> {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"姓名不能为空！"</span>);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setScore</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> score</span>)</span> {
        <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">0</span> &amp;&amp; score &lt;= <span class="hljs-number">100</span>) {
            <span class="hljs-keyword">this</span>.score = score;
        } <span class="hljs-keyword">else</span> {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"成绩必须在0-100之间！"</span>);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span>()</span> { <span class="hljs-keyword">return</span> name; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getScore</span>()</span> { <span class="hljs-keyword">return</span> score; }
}
</code></pre>
<p><strong>测试：</strong></p>
<pre><code class="hljs language-scss" lang="scss">Student s1 = new <span class="hljs-built_in">Student</span>();
s1<span class="hljs-selector-class">.setName</span>("张三");
s1<span class="hljs-selector-class">.setScore</span>(-<span class="hljs-number">50</span>); <span class="hljs-comment">// 提示：成绩必须在0-100之间！</span>
s1<span class="hljs-selector-class">.setScore</span>(<span class="hljs-number">90</span>);
System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(s1.getName() + "的成绩：" + s1<span class="hljs-selector-class">.getScore</span>()); <span class="hljs-comment">// 张三的成绩：90</span>
</code></pre>
<h3 data-id="heading-4">📌 封装的本质</h3>
<ul>
<li><strong>隐藏实现细节</strong>：外部无需知道内部如何存储数据。</li>
<li><strong>控制访问权限</strong>：通过 <code>private</code> 限制直接访问。</li>
<li><strong>统一入口校验</strong>：在 setter 中加入业务规则，保障数据合法性。</li>
<li><strong>提升可维护性</strong>：未来修改内部逻辑不影响调用方。</li>
</ul>
<blockquote>
<p>🔹 <strong>封装 ≠ 加 getter/setter</strong>，而是<strong>控制对内部状态的访问方式</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">🔗 二、继承（Inheritance）：给类找个“靠山”，避免重复造轮子</h2>
<h3 data-id="heading-6">1️⃣ 基本用法：<code>extends</code> 实现代码复用</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 父类：人类（共性）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> {
    <span class="hljs-keyword">protected</span> String name;
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">int</span> age;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span>()</span> { System.<span class="hljs-keyword">out</span>.println(name + <span class="hljs-string">"在吃饭"</span>); }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sleep</span>()</span> { System.<span class="hljs-keyword">out</span>.println(name + <span class="hljs-string">"在睡觉"</span>); }
}

<span class="hljs-comment">// 子类：学生</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> <span class="hljs-title">extends</span> <span class="hljs-title">Person</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> score;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">study</span>()</span> { System.<span class="hljs-keyword">out</span>.println(name + <span class="hljs-string">"在学习，成绩是"</span> + score); }
    <span class="hljs-comment">// getter/setter 省略</span>
}

<span class="hljs-comment">// 子类：老师</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">Teacher</span> <span class="hljs-title">extends</span> <span class="hljs-title">Person</span> {
    <span class="hljs-keyword">private</span> String subject;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">teach</span>()</span> { System.<span class="hljs-keyword">out</span>.println(name + <span class="hljs-string">"在教"</span> + subject); }
}
</code></pre>
<p><strong>测试：</strong></p>
<pre><code class="hljs language-ini" lang="ini">Student <span class="hljs-attr">s</span> = new Student()<span class="hljs-comment">;</span>
<span class="hljs-attr">s.name</span> = <span class="hljs-string">"张三"</span><span class="hljs-comment">; // 继承自 Person</span>
s.study()<span class="hljs-comment">;       // 自有方法</span>

Teacher <span class="hljs-attr">t</span> = new Teacher()<span class="hljs-comment">;</span>
<span class="hljs-attr">t.name</span> = <span class="hljs-string">"李老师"</span><span class="hljs-comment">;</span>
t.teach()<span class="hljs-comment">;       // 自有方法</span>
</code></pre>
<h3 data-id="heading-7">2️⃣ 继承的核心规则</h3>





















<table><thead><tr><th>规则</th><th>说明</th></tr></thead><tbody><tr><td><strong>单继承</strong></td><td>Java 不支持多继承（一个类只能有一个直接父类）</td></tr><tr><td><strong>private 不继承</strong></td><td>父类 <code>private</code> 成员子类不可见，但可通过 <code>protected</code> 或公共方法访问</td></tr><tr><td><strong>构造器调用</strong></td><td>子类构造器默认调用 <code>super()</code>，可显式调用父类构造器</td></tr></tbody></table>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> idCard;
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getIdCard</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> idCard; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setIdCard</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> id</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">idCard</span> = id; }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Person</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">showId</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// System.out.println(idCard); // ❌ 编译错误</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-title function_">getIdCard</span>()); <span class="hljs-comment">// ✅ 通过公共方法访问</span>
    }
}
</code></pre>
<h3 data-id="heading-8">3️⃣ 方法重写（Override）：子类改造父类行为</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{
    public void sayHello() {
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"你好，我是普通人"</span>);
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Person</span> </span>{
    <span class="hljs-meta">@Override</span>
    public void sayHello() {
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"你好，我是学生 "</span> + name);
    }
}
</code></pre>
<blockquote>
<p>⚠️ 使用 <code>@Override</code> 注解可防止拼写错误，提高代码健壮性。</p>
</blockquote>
<h3 data-id="heading-9">📌 继承的本质</h3>
<ul>
<li><strong>代码复用</strong>：避免重复编写共性代码。</li>
<li><strong>建立类间关系</strong>：体现 “is-a” 关系（Student is a Person）。</li>
<li><strong>为多态打基础</strong>：重写是多态的前提。</li>
</ul>
<blockquote>
<p>🔹 <strong>不要为了复用而继承</strong>！不符合 “is-a” 关系时，应使用 <strong>组合（Composition）</strong> 。</p>
</blockquote>
<hr/>
<h2 data-id="heading-10">🔍 三、多态（Polymorphism）：让方法学会“变脸”</h2>
<h3 data-id="heading-11">1️⃣ 多态的基本表现：父类引用指向子类对象</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{
    public void sayHello() {
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"你好，我是普通人"</span>);
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Person</span> </span>{
    <span class="hljs-meta">@Override</span>
    public void sayHello() {
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"你好，我是学生"</span>);
    }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Teacher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Person</span> </span>{
    <span class="hljs-meta">@Override</span>
    public void sayHello() {
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"你好，我是老师"</span>);
    }
}
</code></pre>
<p><strong>多态调用：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">Person p</span>) {
    p.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// 运行时决定调用哪个版本</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
    <span class="hljs-title function_">greet</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>()); <span class="hljs-comment">// 你好，我是学生</span>
    <span class="hljs-title function_">greet</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Teacher</span>()); <span class="hljs-comment">// 你好，我是老师</span>
}
</code></pre>
<h3 data-id="heading-12">2️⃣ 多态的三大条件</h3>
<ol>
<li><strong>存在继承关系</strong>（或接口实现）</li>
<li><strong>子类重写父类方法</strong></li>
<li><strong>父类引用指向子类对象</strong>（<code>Person p = new Student();</code>）</li>
</ol>
<h3 data-id="heading-13">3️⃣ 多态的优势：解耦 + 扩展性强</h3>
<p>新增 <code>Doctor</code> 类，<strong>无需修改 <code>greet</code> 方法</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Doctor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Person</span> </span>{
    <span class="hljs-meta">@Override</span>
    public void sayHello() {
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"你好，我是医生"</span>);
    }
}

greet(<span class="hljs-keyword">new</span> <span class="hljs-type">Doctor</span>()); <span class="hljs-comment">// 你好，我是医生 ✅</span>
</code></pre>
<blockquote>
<p>符合 <strong>开闭原则</strong>：对扩展开放，对修改关闭。</p>
</blockquote>
<h3 data-id="heading-14">⚠️ 注意：父类引用不能调用子类特有方法</h3>
<pre><code class="hljs language-ini" lang="ini">Person <span class="hljs-attr">p</span> = new Student()<span class="hljs-comment">;</span>
// p.study()<span class="hljs-comment">; // ❌ 编译错误</span>

if (p instanceof Student) {
    Student <span class="hljs-attr">s</span> = (Student) p<span class="hljs-comment">; // 向下转型</span>
    s.study()<span class="hljs-comment">; // ✅</span>
}
</code></pre>
<h3 data-id="heading-15">📌 多态的本质</h3>
<ul>
<li><strong>运行时绑定</strong>：方法调用在运行时根据实际对象类型决定。</li>
<li><strong>统一接口，多种实现</strong>：提高代码灵活性和可维护性。</li>
<li><strong>面向抽象编程</strong>：依赖父类/接口，而非具体实现。</li>
</ul>
<hr/>
<h2 data-id="heading-16">🧬 四、三大特性的联动：它们不是孤立的！</h2>
<p>来看一个完整案例，展示三者如何协同工作：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 1. 封装：Person 私有属性 + 构造器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(<span class="hljs-type">String</span> name, <span class="hljs-type">int</span> age)</span> </span>{
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.age = age;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> name; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">work</span><span class="hljs-params">()</span> </span>{ System.out.<span class="hljs-built_in">println</span>(name + <span class="hljs-string">"在工作"</span>); }
}

<span class="hljs-comment">// 2. 继承 + 封装：Student 继承 Person</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> extends Person {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> score;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Student</span><span class="hljs-params">(<span class="hljs-type">String</span> name, <span class="hljs-type">int</span> age, <span class="hljs-type">int</span> score)</span> </span>{
        <span class="hljs-built_in">super</span>(name, age); <span class="hljs-comment">// 调用父类构造器</span>
        <span class="hljs-keyword">this</span>.score = score;
    }

    <span class="hljs-comment">// 3. 多态：重写 work()</span>
    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">work</span><span class="hljs-params">()</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-built_in">getName</span>() + <span class="hljs-string">"在学习，成绩 "</span> + score);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Teacher</span> extends Person {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> subject;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Teacher</span><span class="hljs-params">(<span class="hljs-type">String</span> name, <span class="hljs-type">int</span> age, <span class="hljs-type">String</span> subject)</span> </span>{
        <span class="hljs-built_in">super</span>(name, age);
        <span class="hljs-keyword">this</span>.subject = subject;
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">work</span><span class="hljs-params">()</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-built_in">getName</span>() + <span class="hljs-string">"在教 "</span> + subject);
    }
}
</code></pre>
<p><strong>测试联动：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">doWork</span>(<span class="hljs-params">Person p</span>) {
    p.<span class="hljs-title function_">work</span>(); <span class="hljs-comment">// 多态调用</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
    <span class="hljs-title function_">doWork</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-number">18</span>, <span class="hljs-number">90</span>));   <span class="hljs-comment">// 张三在学习，成绩 90</span>
    <span class="hljs-title function_">doWork</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Teacher</span>(<span class="hljs-string">"李老师"</span>, <span class="hljs-number">30</span>, <span class="hljs-string">"数学"</span>)); <span class="hljs-comment">// 李老师在教 数学</span>
}
</code></pre>
<blockquote>
<p>✅ <strong>封装</strong>保护数据，<strong>继承</strong>复用代码，<strong>多态</strong>实现灵活调用——三位一体！</p>
</blockquote>
<hr/>
<h2 data-id="heading-17">💡 五、实际应用场景</h2>





















<table><thead><tr><th>特性</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>封装</strong></td><td>实体类（User、Order）的标准写法，属性私有 + 校验逻辑</td></tr><tr><td><strong>继承</strong></td><td>框架中的抽象类（如 Spring 的 <code>AbstractController</code>）</td></tr><tr><td><strong>多态</strong></td><td>接口编程（<code>List list = new ArrayList&lt;&gt;()</code>）、策略模式、工厂模式</td></tr></tbody></table>
<h3 data-id="heading-18">示例：接口 + 多态（更推荐的方式）</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">interface</span> <span class="hljs-title">Animal</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">cry</span>()</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title">Dog</span> <span class="hljs-title">implements</span> <span class="hljs-title">Animal</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cry</span>()</span> { System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"汪汪汪"</span>); }
}

<span class="hljs-keyword">class</span> <span class="hljs-title">Cat</span> <span class="hljs-title">implements</span> <span class="hljs-title">Animal</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cry</span>()</span> { System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"喵喵喵"</span>); }
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">makeCry</span>(<span class="hljs-params">Animal a</span>)</span> {
    a.cry();
}

makeCry(<span class="hljs-keyword">new</span> Dog()); <span class="hljs-comment">// 汪汪汪</span>
makeCry(<span class="hljs-keyword">new</span> Cat()); <span class="hljs-comment">// 喵喵喵</span>
</code></pre>
<blockquote>
<p>🔸 <strong>接口比继承更灵活</strong>，Java 推荐“面向接口编程”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-19">⚠️ 六、常见误区 &amp; 最佳实践</h2>

























<table><thead><tr><th>误区</th><th>正确认知</th></tr></thead><tbody><tr><td>“封装就是加 private + getter/setter”</td><td>封装核心是<strong>控制访问+隐藏细节</strong>，setter 应包含校验</td></tr><tr><td>“能复用就继承”</td><td>继承必须符合 <strong>is-a</strong> 关系，否则用 <strong>组合</strong>（has-a）</td></tr><tr><td>“多态随便用”</td><td>父类引用不能调用子类特有方法，需 <code>instanceof</code> + 向下转型</td></tr><tr><td>“多态只能用于继承”</td><td>接口实现也是多态的重要形式</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-20">🏁 七、总结：三大特性是 Java 的骨架</h2>

























<table><thead><tr><th>特性</th><th>核心作用</th><th>关键字/机制</th></tr></thead><tbody><tr><td><strong>封装</strong></td><td>保护数据、隐藏实现</td><td><code>private</code>、getter/setter</td></tr><tr><td><strong>继承</strong></td><td>代码复用、建立层级</td><td><code>extends</code>、<code>super</code>、<code>@Override</code></td></tr><tr><td><strong>多态</strong></td><td>灵活调用、易于扩展</td><td>父类引用、方法重写、运行时绑定</td></tr></tbody></table>
<blockquote>
<p>🔹 <strong>封装是基础，继承是桥梁，多态是升华。</strong><br/>
🔹 三者协同，才能写出<strong>高内聚、低耦合、易维护</strong>的面向对象代码。</p>
</blockquote>
<hr/>
<h2 data-id="heading-21">🌟 最后感悟</h2>
<p>学 Java 三大特性的过程，就像学开车：</p>
<ul>
<li>刚开始觉得<strong>封装是刹车</strong>、<strong>继承是油门</strong>、<strong>多态是方向盘</strong>，各自独立；</li>
<li>练熟了才发现，<strong>只有三者配合，才能安全高效地驶向目的地</strong>。</li>
</ul>
<p>当你能自如地用三大特性设计类、组织系统时，你就真正<strong>掌握了 Java 的灵魂</strong>。</p>
<blockquote>
<p><strong>面向对象不是语法，而是一种思维方式。</strong></p>
</blockquote>
<hr/>
<p>✅ <strong>本文所有代码均可直接运行，建议动手敲一遍，加深理解。</strong><br/>
📌 <strong>欢迎收藏 + 转发，让更多初学者少走弯路！</strong></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 字符串三巨头：String、StringBuilder、StringJoiner —— 初学者避坑指南 🤯]]></title>    <link>https://juejin.cn/post/7577715145120923702</link>    <guid>https://juejin.cn/post/7577715145120923702</guid>    <pubDate>2025-11-29T09:12:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577715145120923702" data-draft-id="7577704980854603830" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 字符串三巨头：String、StringBuilder、StringJoiner —— 初学者避坑指南 🤯"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-29T09:12:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="okseekw"/> <meta itemprop="url" content="https://juejin.cn/user/1933379625032649"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 字符串三巨头：String、StringBuilder、StringJoiner —— 初学者避坑指南 🤯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1933379625032649/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    okseekw
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T09:12:01.000Z" title="Sat Nov 29 2025 09:12:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java 字符串三巨头：String、StringBuilder、StringJoiner —— 初学者避坑指南 🤯</h2>
<blockquote>
<p>“字符串不就是 <code>a + b</code> 吗？”<br/>
—— 说这话的时候，我还不知道什么叫<strong>内存爆炸</strong>、<strong>编译器魔法</strong>，更不知道 JVM 在背后默默帮我擦了多少屁股。</p>
</blockquote>
<p>作为 Java 初学者，你是不是也经历过这些“顿悟时刻”：</p>
<ul>
<li>用 <code>+</code> 拼接 10 个变量，程序卡成 PPT；</li>
<li>想“修改”一个 String，结果发现它根本不能改；</li>
<li>用 <code>==</code> 比较两个看起来一模一样的字符串，结果返回 <code>false</code>……</li>
</ul>
<p>别慌！今天我们就用最接地气的方式，带你搞懂 Java 字符串操作的“三巨头”：<strong>String、StringBuilder、StringJoiner</strong>，顺便把那些坑一一填平！</p>
<hr/>
<h3 data-id="heading-1">1. String：Java 里的“铁头娃”——创建即永恒 ⚒️</h3>
<p><code>java.lang.String</code> 是 Java 中最常用、也最容易被误解的类之一。它的最大特点就一句话：</p>
<blockquote>
<p><strong>一旦创建，内容不可变！</strong></p>
</blockquote>
<h4 data-id="heading-2">❓ 那为什么还能“赋值”？</h4>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">str</span> = <span class="hljs-string">"abc"</span><span class="hljs-comment">;</span>
<span class="hljs-attr">str</span> = <span class="hljs-string">"def"</span><span class="hljs-comment">; // 这不是修改，是换人！</span>
</code></pre>
<p>你以为是在改 <code>"abc"</code>？其实 <code>str</code> 只是一个<strong>引用</strong>，它从指向串池中的 <code>"abc"</code>，变成了指向另一个 <code>"def"</code>。原来的 <code>"abc"</code> 还好好躺在内存里（等着被 GC 回收），根本没动！</p>
<p>这就像你点了一杯可乐，喝一半想换成雪碧——不是往可乐里倒雪碧，而是<strong>直接扔掉可乐，重新点一杯</strong>。浪费吗？相当浪费！</p>
<h4 data-id="heading-3">✅ 两种创建方式，天壤之别</h4>




















<table><thead><tr><th>方式</th><th>示例</th><th>内存行为</th></tr></thead><tbody><tr><td><strong>直接赋值</strong></td><td><code>String s = "abc";</code></td><td>先查<strong>字符串常量池</strong>（StringTable），有就复用，没有才创建 → <strong>省内存！</strong></td></tr><tr><td><strong>new 对象</strong></td><td><code>String s = new String("abc");</code></td><td>无论池里有没有，都在堆中新建对象 → <strong>内存刺客！</strong></td></tr></tbody></table>
<blockquote>
<p>💡 <strong>字符串常量池（StringTable）</strong> 是 JVM 中一块特殊的内存区域（JDK7 起位于堆中），专门存放通过字面量创建的字符串。它的核心作用是<strong>去重复用</strong>，避免重复创建相同内容的字符串对象。</p>
</blockquote>
<p>举个例子：</p>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">s1</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">;</span>
String <span class="hljs-attr">s2</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">;</span>
System.out.println(<span class="hljs-attr">s1</span> == s2)<span class="hljs-comment">; // true！因为都指向池中同一个对象</span>
</code></pre>
<p>而：</p>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">s3</span> = new String(<span class="hljs-string">"hello"</span>)<span class="hljs-comment">;</span>
String <span class="hljs-attr">s4</span> = new String(<span class="hljs-string">"hello"</span>)<span class="hljs-comment">;</span>
System.out.println(<span class="hljs-attr">s3</span> == s4)<span class="hljs-comment">; // false！两个独立的堆对象</span>
</code></pre>
<blockquote>
<p>📌 即使 <code>new String("hello")</code> 中的 <code>"hello"</code> 会先放入常量池，但 <code>s3</code> 和 <code>s4</code> 本身仍是堆中新建的对象，地址不同。</p>
</blockquote>
<h5 data-id="heading-4">🔍 内存模型简图（文字版）</h5>
<pre><code class="hljs language-javascript" lang="javascript">堆内存
├── 字符串常量池（<span class="hljs-title class_">StringTable</span>）
│   └── <span class="hljs-string">"hello"</span> ← s1, s2 共享
└── 普通对象区
    ├── <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">"hello"</span>) → s3
    └── <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">"hello"</span>) → s4
</code></pre>
<hr/>
<h3 data-id="heading-5">2. 字符串比较：<code>==</code> vs <code>equals()</code> —— 地址与内容的世纪误会</h3>
<p>这是初学者必踩的坑！</p>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">a</span> = <span class="hljs-string">"abc"</span><span class="hljs-comment">;</span>
String <span class="hljs-attr">b</span> = new String(<span class="hljs-string">"abc"</span>)<span class="hljs-comment">;</span>

System.out.println(<span class="hljs-attr">a</span> == b)<span class="hljs-comment">;        // false（a 在池，b 在堆）</span>
System.out.println(a.equals(b))<span class="hljs-comment">;   // true（内容都是 "abc"）</span>
</code></pre>
<ul>
<li><code>==</code>：<strong>比较引用地址</strong>（是否指向同一块内存）</li>
<li><code>equals()</code>：<strong>比较内容值</strong>（逐字符对比）</li>
<li><code>equalsIgnoreCase()</code>：忽略大小写的内容比较</li>
</ul>
<blockquote>
<p>✅ <strong>黄金法则：永远用 <code>equals()</code> 比较字符串内容！</strong></p>
</blockquote>
<blockquote>
<p>🧠 小知识：<code>String</code> 的 <code>equals()</code> 方法重写了 <code>Object</code> 的实现，内部会先比较长度，再逐字符 <code>char</code> 对比，效率很高。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">3. 字符串拼接的真相：<code>+</code> 号背后的“性能陷阱”💥</h3>
<p>很多初学者以为 <code>s1 + s2</code> 就是简单相加，但<strong>是否有变量参与</strong>，决定了它是“编译期优化”还是“运行期灾难”！</p>
<h4 data-id="heading-7">✅ 场景1：全是字面量（无变量）</h4>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">s</span> = <span class="hljs-string">"a"</span> + <span class="hljs-string">"b"</span> + <span class="hljs-string">"c"</span><span class="hljs-comment">;</span>
</code></pre>
<p>→ <strong>编译器直接优化为 <code>"abc"</code></strong> ，并放入字符串常量池！<br/>
✅ 零开销，高效复用。</p>
<blockquote>
<p>🔧 原理：Java 编译器（javac）在编译阶段就会将常量表达式计算完毕，生成最终字面量。</p>
</blockquote>
<h4 data-id="heading-8">❌ 场景2：有变量参与</h4>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">a</span> = <span class="hljs-string">"a"</span><span class="hljs-comment">;</span>
String <span class="hljs-attr">s</span> = a + <span class="hljs-string">"b"</span> + <span class="hljs-string">"c"</span><span class="hljs-comment">;</span>
</code></pre>
<p>→ <strong>无法在编译期确定结果</strong>，JVM 必须在运行时拼接！</p>
<h5 data-id="heading-9">那底层怎么拼？</h5>
<ul>
<li><strong>JDK8 以前</strong>：自动创建 <code>StringBuilder</code>，调用多次 <code>append()</code>，最后调用 <code>toString()</code>（而 <code>toString()</code> 会 <code>new String()</code>，产生新对象）。</li>
<li><strong>JDK8 及以后</strong>：JVM 会<strong>预估拼接后的总长度</strong>，但仍会<strong>在堆中创建一个新的字符串对象</strong>，无法复用常量池。</li>
</ul>
<blockquote>
<p>📌 关键结论：<strong>只要有变量参与，<code>+</code> 拼接就会在堆中创建新对象，且可能多次创建临时对象！</strong></p>
</blockquote>
<p>比如在循环中：</p>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">s</span> = <span class="hljs-string">""</span><span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 1000; i++) {</span>
    s += i<span class="hljs-comment">; // 每次都 new 一个 StringBuilder + new 一个 String！</span>
}
</code></pre>
<p>→ <strong>时间慢、内存爆、GC 压力大！</strong></p>
<h4 data-id="heading-10">🔍 性能对比（概念演示）</h4>























<table><thead><tr><th>方式</th><th>对象创建次数（n=1000）</th><th>时间复杂度</th><th>内存占用</th></tr></thead><tbody><tr><td><code>s += i</code></td><td>~2000 次（每次 StringBuilder + String）</td><td>O(n²)</td><td>高</td></tr><tr><td><code>StringBuilder.append(i)</code></td><td>1 次（最终 toString 一次）</td><td>O(n)</td><td>低</td></tr></tbody></table>
<blockquote>
<p>💡 实测中，10 万次拼接，<code>+</code> 可能慢 10 倍以上！</p>
</blockquote>
<h5 data-id="heading-11">🧪 举个真实场景</h5>
<p>假设你要拼接用户信息：</p>
<pre><code class="hljs language-ini" lang="ini">// 错误示范
String <span class="hljs-attr">info</span> = <span class="hljs-string">""</span><span class="hljs-comment">;</span>
info += "ID: " + userId<span class="hljs-comment">;</span>
info += ", Name: " + name<span class="hljs-comment">;</span>
info += ", Age: " + age<span class="hljs-comment">;</span>
</code></pre>
<p>→ 虽然只有 3 行，但因为有变量，JVM 会创建至少 2~3 个中间 <code>StringBuilder</code> 和 <code>String</code> 对象。</p>
<blockquote>
<p>✅ 正确做法：统一用 <code>StringBuilder</code> 一次性拼完！</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">4. StringBuilder：拼接界的“效率王者”🔥</h3>
<p>当你需要<strong>频繁拼接、修改或反转字符串</strong>（尤其是涉及变量时），<code>StringBuilder</code> 就是你的救星！</p>
<h4 data-id="heading-13">🧰 核心方法，4 个搞定 90% 场景</h4>






























<table><thead><tr><th>方法</th><th>作用</th><th>初学者理解</th></tr></thead><tbody><tr><td><code>append(x)</code></td><td>添加任意类型数据</td><td>“往可变容器里塞东西”</td></tr><tr><td><code>reverse()</code></td><td>反转内容</td><td>“一键倒序”</td></tr><tr><td><code>length()</code></td><td>获取当前长度</td><td>“数数装了多少”</td></tr><tr><td><code>toString()</code></td><td>转为 String</td><td>“打包发货”</td></tr></tbody></table>
<h4 data-id="heading-14">💡 链式编程，爽到飞起</h4>
<pre><code class="hljs language-go" lang="go">String result = <span class="hljs-built_in">new</span> StringBuilder()
    .<span class="hljs-built_in">append</span>(<span class="hljs-string">"Hello"</span>)
    .<span class="hljs-built_in">append</span>(<span class="hljs-string">" "</span>)
    .<span class="hljs-built_in">append</span>(<span class="hljs-string">"World"</span>)
    .reverse()
    .toString();
<span class="hljs-comment">// 输出：dlroW olleH</span>
</code></pre>
<h4 data-id="heading-15">🔧 底层原理：自动扩容的“智能收纳箱”</h4>
<ul>
<li>
<p><strong>默认容量</strong>：16 个字符（底层是 <code>char[] value</code> 数组）</p>
</li>
<li>
<p><strong>扩容策略</strong>：当空间不足时，新容量 = <code>原容量 * 2 + 2</code></p>
<ul>
<li>例如：16 → 34 → 70 → 142...</li>
</ul>
</li>
<li>
<p><strong>极端情况</strong>：如果扩容后仍不够，直接按<strong>实际所需长度</strong>分配</p>
</li>
</ul>
<blockquote>
<p>✅ 优势：<strong>全程只操作一个可变对象，避免大量中间 String 创建！</strong></p>
</blockquote>
<blockquote>
<p>🆚 顺带一提：<code>StringBuffer</code> 和 <code>StringBuilder</code> 功能几乎一样，但前者是<strong>线程安全</strong>的（方法加了 <code>synchronized</code>），性能略低。<strong>单线程场景下，优先用 StringBuilder！</strong></p>
</blockquote>
<h5 data-id="heading-16">🛠️ 实用技巧：预估容量</h5>
<p>如果你知道大概要拼多长，可以在构造时指定初始容量，避免频繁扩容：</p>
<pre><code class="hljs language-ini" lang="ini">StringBuilder <span class="hljs-attr">sb</span> = new StringBuilder(<span class="hljs-number">256</span>)<span class="hljs-comment">; // 预分配 256 字符</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">5. StringJoiner：JDK8 的“文艺青年”🎨</h3>
<p>如果你经常要拼出这种格式：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">apple, banana, orange</span>]
</code></pre>
<p>或者</p>
<pre><code class="hljs language-css" lang="css">id=<span class="hljs-number">1</span>-<span class="hljs-attr">--name</span>=Jack-<span class="hljs-attr">--age</span>=<span class="hljs-number">20</span>
</code></pre>
<p>那么 <code>StringJoiner</code> 就是为你量身定制的！</p>
<p>它是 JDK8 引入的工具类，专治“格式拼接强迫症”。</p>
<h4 data-id="heading-18">🌟 两大构造器，仪式感拉满</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 只指定分隔符</span>
StringJoiner sj1 = <span class="hljs-keyword">new</span> StringJoiner(<span class="hljs-string">"---"</span>);
sj1.<span class="hljs-keyword">add</span>(<span class="hljs-string">"A"</span>).<span class="hljs-keyword">add</span>(<span class="hljs-string">"B"</span>); <span class="hljs-comment">// A---B</span>

<span class="hljs-comment">// 指定分隔符 + 前缀 + 后缀</span>
StringJoiner sj2 = <span class="hljs-keyword">new</span> StringJoiner(<span class="hljs-string">","</span>, <span class="hljs-string">"["</span>, <span class="hljs-string">"]"</span>);
sj2.<span class="hljs-keyword">add</span>(<span class="hljs-string">"aaa"</span>).<span class="hljs-keyword">add</span>(<span class="hljs-string">"bbb"</span>); <span class="hljs-comment">// [aaa,bbb]</span>
</code></pre>
<p>对比 <code>StringBuilder</code> 手动拼 <code>[</code>、<code>,</code>、<code>]</code>，还要处理末尾逗号……<code>StringJoiner</code> 直接一步到位，优雅得不像话！</p>
<blockquote>
<p>✅ 适合场景：<strong>集合/数组转带格式字符串（如 JSON、SQL IN 列表、日志拼接等）</strong></p>
</blockquote>
<blockquote>
<p>📌 小遗憾：虽然好用，但因历史习惯，很多老项目仍用 <code>StringBuilder</code>。不过作为新人，完全可以大胆用！</p>
</blockquote>
<h5 data-id="heading-19">💡 与集合结合使用</h5>
<pre><code class="hljs language-ini" lang="ini">List&lt;String&gt; <span class="hljs-attr">list</span> = Arrays.asList(<span class="hljs-string">"x"</span>, <span class="hljs-string">"y"</span>, <span class="hljs-string">"z"</span>)<span class="hljs-comment">;</span>
StringJoiner <span class="hljs-attr">sj</span> = new StringJoiner(<span class="hljs-string">", "</span>, <span class="hljs-string">"{"</span>, <span class="hljs-string">"}"</span>)<span class="hljs-comment">;</span>
list.forEach(sj::add)<span class="hljs-comment">;</span>
System.out.println(sj)<span class="hljs-comment">; // {x, y, z}</span>
</code></pre>
<hr/>
<h3 data-id="heading-20">🛑 初学者避坑指南：3 大场景，选对工具！</h3>

























<table><thead><tr><th>场景</th><th>推荐工具</th><th>理由</th></tr></thead><tbody><tr><td>字符串固定不变（如配置常量）</td><td><code>String</code></td><td>简单、安全、串池复用省内存</td></tr><tr><td>高频拼接/反转（含变量）</td><td><code>StringBuilder</code></td><td>可变、高效、无垃圾对象</td></tr><tr><td>需要统一格式（分隔符/首尾符号）</td><td><code>StringJoiner</code></td><td>代码简洁，格式自动处理</td></tr></tbody></table>
<h4 data-id="heading-21">❌ 绝对不要这么干！</h4>
<pre><code class="hljs language-ini" lang="ini">// 反面教材：内存杀手
String <span class="hljs-attr">s</span> = <span class="hljs-string">""</span><span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 1000; i++) {</span>
    s += i<span class="hljs-comment">; // 每次都 new 一个 String！</span>
}
</code></pre>
<h4 data-id="heading-22">✅ 正确姿势：</h4>
<pre><code class="hljs language-ini" lang="ini">StringBuilder <span class="hljs-attr">sb</span> = new StringBuilder(<span class="hljs-number">1000</span>)<span class="hljs-comment">; // 预估容量，避免多次扩容</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 1000; i++) {</span>
    sb.append(i)<span class="hljs-comment">;</span>
}
String <span class="hljs-attr">s</span> = sb.toString()<span class="hljs-comment">; // 只创建 1 个最终对象！</span>
</code></pre>
<hr/>
<h3 data-id="heading-23">💡 面试加分点（提前了解）</h3>
<ul>
<li><strong>Q：String 为什么设计成不可变？</strong><br/>
A：安全（如 HashMap key）、线程安全、缓存 hashcode、字符串池复用。</li>
<li><strong>Q：<code>"a" + "b"</code> 和 <code>new String("ab")</code> 有什么区别？</strong><br/>
A：前者在编译期优化为常量池中的 <code>"ab"</code>；后者在堆中新建对象。</li>
<li><strong>Q：StringBuilder 默认容量是多少？如何扩容？</strong><br/>
A：16；扩容公式：<code>newCapacity = (oldCapacity &lt;&lt; 1) + 2</code>（即 <code>old*2+2</code>）。</li>
<li><strong>Q：StringJoiner 是线程安全的吗？</strong><br/>
A：不是！和 StringBuilder 一样，适用于单线程。</li>
</ul>
<hr/>
<h3 data-id="heading-24">✅ 总结：三句话记住三巨头</h3>
<ol>
<li><strong>String</strong>：不变就用它，简单又安全；</li>
<li><strong>StringBuilder</strong>：要改要拼用它，性能扛把子；</li>
<li><strong>StringJoiner</strong>：要格式用它，优雅不啰嗦；</li>
<li><strong>永远别用 <code>+</code> 拼变量</strong>——那是给 GC 送温暖！</li>
</ol>
<blockquote>
<p>字符串操作看似简单，实则暗藏玄机。<br/>
选对工具，少走弯路；理解原理，不再踩坑。<br/>
愿你在 Java 的路上，字符串丝滑如德芙，代码优雅如诗！💪</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter国际化语言轻松搞定]]></title>    <link>https://juejin.cn/post/7577660060093890614</link>    <guid>https://juejin.cn/post/7577660060093890614</guid>    <pubDate>2025-11-29T09:17:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577660060093890614" data-draft-id="7577722399374704682" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter国际化语言轻松搞定"/> <meta itemprop="keywords" content="Flutter,Dart"/> <meta itemprop="datePublished" content="2025-11-29T09:17:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="等你等了那么久"/> <meta itemprop="url" content="https://juejin.cn/user/1688446223025927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter国际化语言轻松搞定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1688446223025927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    等你等了那么久
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T09:17:53.000Z" title="Sat Nov 29 2025 09:17:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter国际化</h2>
<h3 data-id="heading-1">1.引入依赖</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span> 
 <span class="hljs-attr">intl:</span> <span class="hljs-string">^0.20.2</span>
  <span class="hljs-attr">flutter_localizations:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
 
 <span class="hljs-attr">flutter:</span>
  <span class="hljs-comment"># 针对多语言 l10n</span>
  <span class="hljs-attr">generate:</span> <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-2">2.在项目根目录创建 <code>l10n.yaml</code> 配置文件</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">arb-dir:</span> <span class="hljs-string">lib/common/config/localization/l10n</span> <span class="hljs-comment"># 多语言资源文件的目录</span>
<span class="hljs-attr">template-arb-file:</span> <span class="hljs-string">app_en.arb</span> 	 <span class="hljs-comment"># 基础模板文件（通常为英文）</span>
<span class="hljs-attr">output-localization-file:</span> <span class="hljs-string">app_localizations.dart</span> <span class="hljs-comment"># 生成的国际化代码文件名</span>
<span class="hljs-attr">output-class:</span> <span class="hljs-string">AppLocalizations</span> <span class="hljs-comment"># 生成的国际化类名</span>
<span class="hljs-attr">preferred-supported-locales:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">en</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">zh</span>
<span class="hljs-attr">synthetic-package:</span> <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-3">3.创建语言文件 app_en.arb, app_zh.arb</h3>
<pre><code class="hljs language-txt" lang="txt">zh:
{
  "welcomeMessage": "Welcome To Flutter",
  "app_name": "WarmTodo",
  "today": "今天",
  "no_todo": "暂无待办事项",
  "todo": "待办事项",
  "enter_todo": "输入待办事项...",
  "save": "保存",
  "mark_completed": "标记为完成",
  "mark_uncompleted": "标记为未完成",
  "priority": "优先级",
  "low": "低优先级",
  "medium": "中优先级",
  "high": "高优先级"
}

en:

{
  "welcomeMessage": "Welcome To Flutter",
  "app_name": "WarmTodo",
  "today": "Today",
  "no_todo": "There are no pending tasks",
  "todo": "To-do",
  "enter_todo": "Enter the to-do items",
  "save": "Save",
  "mark_completed": "Marked as finished",
  "mark_uncompleted": "Marked as unfinished",
  "priority": "Priority",
  "low": "Low priority",
  "medium": "Medium priority",
  "high": "High priority"
}
</code></pre>
<p><img alt="" src="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c61561bb5b641b4bcc2c795fad442b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562J5L2g562J5LqG6YKj5LmI5LmF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765012673&amp;x-signature=s4Y2FfbHn3eDs%2FcJDwwJZV%2BJZxA%3D" alt="1.png" loading="lazy"/></p>
<h3 data-id="heading-4">4.执行 <code>flutter gen-l10n</code> 命令</h3>
<p>保存配置后，执行 <code>flutter gen-l10n</code> 命令，Flutter 会自动在 <code>lib/generated</code> 目录下生成 <code>app_localizations.dart</code> 文件，该文件包含所有多语言文案的访问方法。</p>
<h3 data-id="heading-5">5.在应用中配置本地化代理</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  runApp(<span class="hljs-keyword">const</span> MyApp());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> MyApp({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-comment">// This widget is the root of your application.</span>
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      localizationsDelegates: AppLocalizations.localizationsDelegates, <span class="hljs-comment">//配置本地化代理（必须）</span>
      <span class="hljs-comment">//配置应用支持的语言列表</span>
      supportedLocales: [
        <span class="hljs-keyword">const</span> Locale(<span class="hljs-string">'en'</span>,<span class="hljs-string">'US'</span>),
        <span class="hljs-keyword">const</span> Locale(<span class="hljs-string">'zh'</span>,<span class="hljs-string">'CN'</span>),
      ],
      title: <span class="hljs-string">'Flutter Demo'</span>,
      theme: ThemeData(
        colorScheme: .fromSeed(seedColor: Colors.deepPurple),
      ),
      home: <span class="hljs-keyword">const</span> MyHomePage(title: <span class="hljs-string">'Flutter Demo Home Page'</span>),
    );
  }
}
</code></pre>
<h3 data-id="heading-6">6.<strong>通过扩展方法（Extension）封装国际化工具类的便捷调用</strong></h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'l10n/app_localizations.dart'</span>;

<span class="hljs-keyword">extension</span> LocalizationExtension <span class="hljs-keyword">on</span> BuildContext {
  AppLocalizations <span class="hljs-keyword">get</span> l10n =&gt; AppLocalizations.of(<span class="hljs-keyword">this</span>)!;
}
</code></pre>
<h3 data-id="heading-7">7.在组件中使用</h3>
<pre><code class="hljs language-dart" lang="dart">Text(context.l10n.app_name)
</code></pre>
<p>恭喜！你学会了Flutter国际化！Happy Coding !😊😊😊</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[lvgl]如何优雅地向lv_port_linux中添加tslib支持]]></title>    <link>https://juejin.cn/post/7577599015426457635</link>    <guid>https://juejin.cn/post/7577599015426457635</guid>    <pubDate>2025-11-29T08:52:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577599015426457635" data-draft-id="7577599015426293795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[lvgl]如何优雅地向lv_port_linux中添加tslib支持"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-11-29T08:52:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="念风"/> <meta itemprop="url" content="https://juejin.cn/user/1181352285716276"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [lvgl]如何优雅地向lv_port_linux中添加tslib支持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1181352285716276/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    念风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T08:52:35.000Z" title="Sat Nov 29 2025 08:52:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原始仓库地址:<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flvgl%2Flv_port_linux" target="_blank" title="https://github.com/lvgl/lv_port_linux" ref="nofollow noopener noreferrer">lvgl/lv_port_linux: LVGL configured to work with a standard Linux framebuffer</a></p>
<p>直接上改完后的<code>CMakeLists.txt</code>:</p>
<pre><code class="hljs language-C" lang="C">cmake_minimum_required(VERSION <span class="hljs-number">3.11</span>)
project(lvgl)

option(WERROR <span class="hljs-string">"Treat warnings as errors for LVGL targets"</span> OFF)

# Set policy to allow to run the target_link_libraries cmd on targets that are build
<span class="hljs-meta"># in another directory.</span>
# Currently, the linking is not handled by env_support/cmake/os.cmakel
# This means that <span class="hljs-keyword">if</span> a driver is enabled and it requires linking an external library
<span class="hljs-meta"># it needs to be handled in the top-level project.</span>

cmake_policy(SET CMP0079 NEW)

# Uncomment <span class="hljs-keyword">if</span> the program needs debugging
<span class="hljs-meta">#set(CMAKE_BUILD_TYPE Debug)</span>

<span class="hljs-built_in">set</span>(CMAKE_EXPORT_COMPILE_COMMANDS ON)

<span class="hljs-built_in">set</span>(CMAKE_C_STANDARD <span class="hljs-number">99</span>) # LVGL officially supports C99 and above
<span class="hljs-title function_">set</span><span class="hljs-params">(CMAKE_CXX_STANDARD <span class="hljs-number">17</span>)</span> #C17
<span class="hljs-title function_">set</span><span class="hljs-params">(CMAKE_CXX_STANDARD_REQUIRED ON)</span>
<span class="hljs-title function_">set</span><span class="hljs-params">(EXECUTABLE_OUTPUT_PATH ${CMAKE_BINARY_DIR}/bin)</span>
<span class="hljs-title function_">set</span><span class="hljs-params">(CMAKE_C_FLAGS <span class="hljs-string">"${CMAKE_C_FLAGS} -Wall -Wextra -Wpedantic"</span>)</span>

<span class="hljs-title function_">option</span><span class="hljs-params">(CONFIG <span class="hljs-string">"Config to use leave empty for `lv_conf.defaults`"</span> <span class="hljs-string">"default"</span>)</span>

<span class="hljs-title function_">set</span><span class="hljs-params">(LV_CONF_DEFAULTS_PATH <span class="hljs-string">"${CMAKE_SOURCE_DIR}/lv_conf.defaults"</span>)</span>
<span class="hljs-title function_">set</span><span class="hljs-params">(LV_CONF_DEFAULTS_OLD_PATH <span class="hljs-string">"${CMAKE_SOURCE_DIR}/lv_conf.defaults.old"</span>)</span>

# If CONFIG is not <span class="hljs-keyword">default</span>, copy the selected config to lv_conf.defaults
<span class="hljs-title function_">if</span><span class="hljs-params">(NOT CONFIG STREQUAL <span class="hljs-string">"default"</span>)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(CONFIG_FILE <span class="hljs-string">"${CMAKE_SOURCE_DIR}/configs/${CONFIG}.defaults"</span>)</span>
    
    # Verify the config file exists
    <span class="hljs-title function_">if</span><span class="hljs-params">(NOT EXISTS <span class="hljs-string">"${CONFIG_FILE}"</span>)</span>
        <span class="hljs-title function_">message</span><span class="hljs-params">(FATAL_ERROR <span class="hljs-string">"Config file not found: ${CONFIG_FILE}"</span>)</span>
    <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>
    
    # Backup the current lv_conf.defaults to lv_conf.defaults.old
    <span class="hljs-title function_">if</span><span class="hljs-params">(EXISTS <span class="hljs-string">"${LV_CONF_DEFAULTS_PATH}"</span>)</span>
        <span class="hljs-title function_">file</span><span class="hljs-params">(RENAME <span class="hljs-string">"${LV_CONF_DEFAULTS_PATH}"</span> <span class="hljs-string">"${LV_CONF_DEFAULTS_OLD_PATH}"</span>)</span>
        <span class="hljs-title function_">message</span><span class="hljs-params">(STATUS <span class="hljs-string">"Backed up lv_conf.defaults to lv_conf.defaults.old"</span>)</span>
    <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>
    
    # Copy the config file to lv_conf.defaults
    <span class="hljs-title function_">configure_file</span><span class="hljs-params">(<span class="hljs-string">"${CONFIG_FILE}"</span> <span class="hljs-string">"${LV_CONF_DEFAULTS_PATH}"</span> COPYONLY)</span>
    <span class="hljs-title function_">message</span><span class="hljs-params">(STATUS <span class="hljs-string">"Copied configs/${CONFIG}.defaults to ${LV_CONF_DEFAULTS_PATH}"</span>)</span>
    <span class="hljs-title function_">message</span><span class="hljs-params">(STATUS <span class="hljs-string">"Using config: configs/${CONFIG}.defaults"</span>)</span>
<span class="hljs-title function_">else</span><span class="hljs-params">()</span>
    <span class="hljs-title function_">if</span><span class="hljs-params">(NOT EXISTS <span class="hljs-string">"${LV_CONF_DEFAULTS_PATH}"</span>)</span>
        <span class="hljs-title function_">message</span><span class="hljs-params">(FATAL_ERROR <span class="hljs-string">"Config file not found: ${LV_CONF_DEFAULTS_PATH}"</span>)</span>
    <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>
    <span class="hljs-title function_">message</span><span class="hljs-params">(STATUS <span class="hljs-string">"Using default lv_conf.defaults"</span>)</span>
    <span class="hljs-title function_">message</span><span class="hljs-params">(STATUS <span class="hljs-string">"Using config: ${LV_CONF_DEFAULTS_PATH}"</span>)</span>
<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>


<span class="hljs-title function_">set</span><span class="hljs-params">(LV_BUILD_SET_CONFIG_OPTS ON CACHE BOOL
    <span class="hljs-string">"create CMAKE variables from lv_conf_internal.h"</span> FORCE)</span>

<span class="hljs-title function_">set</span><span class="hljs-params">(LV_BUILD_CONF_PATH
    <span class="hljs-string">"${CMAKE_BINARY_DIR}/lv_conf.h"</span>
    CACHE PATH <span class="hljs-string">"path to lv_conf.h"</span> FORCE)</span>

<span class="hljs-title function_">set</span><span class="hljs-params">(LVGL_TEMPLATE_PATH <span class="hljs-string">"${CMAKE_SOURCE_DIR}/lvgl/lv_conf_template.h"</span>)</span>
<span class="hljs-title function_">set</span><span class="hljs-params">(GENERATE_SCRIPT_PATH <span class="hljs-string">"${CMAKE_SOURCE_DIR}/lvgl/scripts/generate_lv_conf.py"</span>)</span>

<span class="hljs-title function_">configure_file</span><span class="hljs-params">(${LVGL_TEMPLATE_PATH} ${CMAKE_BINARY_DIR}/lv_conf_template.h
               COPYONLY)</span>
<span class="hljs-title function_">configure_file</span><span class="hljs-params">(${LV_CONF_DEFAULTS_PATH} ${CMAKE_BINARY_DIR}/lv_conf.defaults
               COPYONLY)</span>
<span class="hljs-title function_">configure_file</span><span class="hljs-params">(${GENERATE_SCRIPT_PATH} ${CMAKE_BINARY_DIR}/generate_lv_conf.py
               COPYONLY)</span>

<span class="hljs-title function_">execute_process</span><span class="hljs-params">(
  COMMAND
    ${Python3_EXECUTABLE} ${GENERATE_SCRIPT_PATH} --template
    ${LVGL_TEMPLATE_PATH} --defaults ${LV_CONF_DEFAULTS_PATH} --config
    ${LV_BUILD_CONF_PATH}
  RESULT_VARIABLE config_result
  OUTPUT_VARIABLE config_output
  ERROR_VARIABLE config_output)</span>

<span class="hljs-title function_">if</span><span class="hljs-params">(NOT config_result EQUAL <span class="hljs-number">0</span>)</span>
  <span class="hljs-title function_">message</span><span class="hljs-params">(FATAL_ERROR <span class="hljs-string">"Failed to generate lv_conf.h: ${config_output}"</span>)</span>
<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">message</span><span class="hljs-params">(STATUS <span class="hljs-string">"${LV_BUILD_CONF_PATH} generated successfully"</span>)</span>

<span class="hljs-title function_">add_subdirectory</span><span class="hljs-params">(lvgl)</span>

<span class="hljs-comment">//添加交叉编译选项</span>
<span class="hljs-title function_">option</span><span class="hljs-params">(CROSS_BUILD <span class="hljs-string">"Enable cross-compiling mode"</span> OFF)</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_EVDEV)</span>
    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including EVDEV support"</span>)</span>

<span class="hljs-comment">//对evdev使用交叉编译条件判断</span>
    <span class="hljs-title function_">if</span><span class="hljs-params">(CROSS_BUILD)</span>
        <span class="hljs-title function_">message</span><span class="hljs-params">(STATUS <span class="hljs-string">"Detected cross-compilation environment"</span>)</span>
        
        <span class="hljs-comment">//交叉编译环境下用到的库与头文件目录</span>
        <span class="hljs-title function_">set</span><span class="hljs-params">(EVDEV_LIBRARIES ${STAGING_DIR}/usr/lib/libevdev.so)</span>
        <span class="hljs-title function_">set</span><span class="hljs-params">(EVDEV_INCLUDE_DIRS ${STAGING_DIR}/usr/include)</span>

        <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${EVDEV_LIBRARIES})</span>
        <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${EVDEV_INCLUDE_DIRS})</span>
    <span class="hljs-title function_">else</span><span class="hljs-params">()</span>
        <span class="hljs-title function_">message</span><span class="hljs-params">(STATUS <span class="hljs-string">"Native build (using host pkg-config)"</span>)</span>

        <span class="hljs-title function_">find_package</span><span class="hljs-params">(PkgConfig REQUIRED)</span>
        <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(EVDEV REQUIRED libevdev)</span>

        <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${EVDEV_LIBRARIES})</span>
        <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${EVDEV_INCLUDE_DIRS})</span>
    <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND LV_LINUX_BACKEND_SRC src/lib/indev_backends/evdev.c)</span>

<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-comment">//在此处添加TSLIB支持</span>
<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_TSLIB)</span>

    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including TSLIB support"</span>)</span>

    <span class="hljs-comment">//必须使用交叉编译条件</span>
    <span class="hljs-title function_">if</span><span class="hljs-params">(CROSS_BUILD)</span>
        <span class="hljs-title function_">message</span><span class="hljs-params">(STATUS <span class="hljs-string">"Detected cross-compilation environment"</span>)</span>
        
        <span class="hljs-comment">//交叉编译环境下用到的库与头文件目录</span>
        <span class="hljs-title function_">set</span><span class="hljs-params">(TSLIB_LIBRARIES ${STAGING_DIR}/usr/lib/libts.so)</span>
        <span class="hljs-title function_">set</span><span class="hljs-params">(TSLIB_INCLUDE_DIRS ${STAGING_DIR}/usr/include)</span>

        <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${TSLIB_LIBRARIES})</span>
        <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${TSLIB_INCLUDE_DIRS})</span>
    <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

    <span class="hljs-comment">//添加源文件到编译列表</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND LV_LINUX_BACKEND_SRC src/lib/indev_backends/tslib.c)</span>

<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>


<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_LINUX_DRM)</span>

    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including DRM support"</span>)</span>
    <span class="hljs-title function_">find_package</span><span class="hljs-params">(PkgConfig REQUIRED)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(LIBDRM REQUIRED libdrm)</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${LIBDRM_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${LIBDRM_INCLUDE_DIRS})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND LV_LINUX_BACKEND_SRC src/lib/display_backends/drm.c)</span>

<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_LINUX_DRM_GBM_BUFFERS OR CONFIG_LV_LINUX_DRM_USE_EGL)</span>

    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including GBM support"</span>)</span>

    <span class="hljs-title function_">find_package</span><span class="hljs-params">(PkgConfig REQUIRED)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(LIBGBM REQUIRED gbm)</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${LIBGBM_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${LIBGBM_INCLUDE_DIRS})</span>

<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_LIBINPUT)</span>
    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including libinput support"</span>)</span>

    <span class="hljs-title function_">find_package</span><span class="hljs-params">(PkgConfig REQUIRED)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(LIBINPUT REQUIRED libinput)</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${LIBINPUT_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${LIBINPUT_INCLUDE_DIRS})</span>

<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_FREETYPE)</span>
    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including Freetype support"</span>)</span>

    <span class="hljs-title function_">find_package</span><span class="hljs-params">(PkgConfig REQUIRED)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(LIBFREETYPE REQUIRED freetype2)</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${LIBFREETYPE_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${LIBFREETYPE_INCLUDE_DIRS})</span>

<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_SDL OR CONFIG_LV_USE_DRAW_SDL)</span>

    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including SDL2 support"</span>)</span>
    <span class="hljs-title function_">find_package</span><span class="hljs-params">(PkgConfig REQUIRED)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(SDL2 REQUIRED sdl2)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(SDL2_IMAGE REQUIRED SDL2_image)</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${SDL2_LIBRARIES} ${SDL2_IMAGE_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${SDL2_INCLUDE_DIRS} ${SDL2_IMAGE_INCLUDE_DIRS})</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND LV_LINUX_BACKEND_SRC src/lib/display_backends/sdl.c)</span>
<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>


<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_WAYLAND)</span>

    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including Wayland support"</span>)</span>

    <span class="hljs-title function_">find_package</span><span class="hljs-params">(PkgConfig REQUIRED)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(WAYLAND_CLIENT REQUIRED wayland-client)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(WAYLAND_CURSOR REQUIRED wayland-cursor)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(XKBCOMMON REQUIRED xkbcommon)</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${WAYLAND_CLIENT_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${WAYLAND_CURSOR_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${XKBCOMMON_LIBRARIES})</span>

    # Wayland protocols
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(WAYLAND_PROTOCOLS REQUIRED wayland-protocols&gt;=<span class="hljs-number">1.25</span>)</span>
    <span class="hljs-title function_">pkg_get_variable</span><span class="hljs-params">(WAYLAND_PROTOCOLS_BASE wayland-protocols pkgdatadir)</span>

    <span class="hljs-title function_">if</span><span class="hljs-params">(DEFINED ENV{SDKTARGETSYSROOT} AND DEFINED ENV{SYSROOT})</span>
        <span class="hljs-title function_">message</span><span class="hljs-params">(FATAL_ERROR <span class="hljs-string">"Both SDKTARGETSYSROOT and SYSROOT are set. Please set only one."</span>)</span>
    <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>
    
    <span class="hljs-title function_">if</span><span class="hljs-params">(DEFINED ENV{SDKTARGETSYSROOT})</span>
        <span class="hljs-title function_">set</span><span class="hljs-params">(PROTOCOL_ROOT <span class="hljs-string">"$ENV{SDKTARGETSYSROOT}/usr/share/wayland-protocols"</span>)</span>
    <span class="hljs-title function_">elseif</span><span class="hljs-params">(DEFINED ENV{SYSROOT})</span>
        <span class="hljs-title function_">set</span><span class="hljs-params">(PROTOCOL_ROOT <span class="hljs-string">"$ENV{SYSROOT}/usr/share/wayland-protocols"</span>)</span>
    <span class="hljs-title function_">else</span><span class="hljs-params">()</span>
        <span class="hljs-title function_">set</span><span class="hljs-params">(PROTOCOL_ROOT <span class="hljs-string">"/usr/share/wayland-protocols"</span>)</span>
    <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>
    
    <span class="hljs-title function_">if</span><span class="hljs-params">(NOT EXISTS ${PROTOCOL_ROOT})</span>
        <span class="hljs-title function_">message</span><span class="hljs-params">(FATAL_ERROR <span class="hljs-string">"Wayland protocols not found at ${PROTOCOL_ROOT}"</span>)</span>
    <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>
    
    <span class="hljs-title function_">set</span><span class="hljs-params">(PROTOCOLS_DIR <span class="hljs-string">"${CMAKE_CURRENT_BINARY_DIR}/protocols"</span>)</span>
    <span class="hljs-title function_">file</span><span class="hljs-params">(MAKE_DIRECTORY ${PROTOCOLS_DIR})</span>
    
    <span class="hljs-title function_">set</span><span class="hljs-params">(WAYLAND_PROTOCOLS_SRC <span class="hljs-string">""</span>)</span>
    
    # Generate xdg-shell <span class="hljs-title function_">protocol</span> <span class="hljs-params">(always)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(XDG_SHELL_XML <span class="hljs-string">"${PROTOCOL_ROOT}/stable/xdg-shell/xdg-shell.xml"</span>)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(XDG_SHELL_HEADER <span class="hljs-string">"${PROTOCOLS_DIR}/wayland_xdg_shell.h"</span>)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(XDG_SHELL_SOURCE <span class="hljs-string">"${PROTOCOLS_DIR}/wayland_xdg_shell.c"</span>)</span>
    
    <span class="hljs-title function_">if</span><span class="hljs-params">(NOT EXISTS ${XDG_SHELL_HEADER} OR NOT EXISTS ${XDG_SHELL_SOURCE})</span>
        <span class="hljs-title function_">execute_process</span><span class="hljs-params">(COMMAND wayland-scanner client-header ${XDG_SHELL_XML} ${XDG_SHELL_HEADER})</span>
        <span class="hljs-title function_">execute_process</span><span class="hljs-params">(COMMAND wayland-scanner private-code ${XDG_SHELL_XML} ${XDG_SHELL_SOURCE})</span>
    <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND WAYLAND_PROTOCOLS_SRC ${XDG_SHELL_SOURCE})</span>
    
    # Generate dmabuf <span class="hljs-title function_">protocol</span> <span class="hljs-params">(<span class="hljs-keyword">if</span> config is <span class="hljs-built_in">set</span>)</span>
    <span class="hljs-title function_">if</span><span class="hljs-params">(CONFIG_LV_WAYLAND_USE_DMABUF)</span>
        <span class="hljs-title function_">set</span><span class="hljs-params">(DMABUF_XML <span class="hljs-string">"${PROTOCOL_ROOT}/stable/linux-dmabuf/linux-dmabuf-v1.xml"</span>)</span>
        <span class="hljs-title function_">set</span><span class="hljs-params">(DMABUF_HEADER <span class="hljs-string">"${PROTOCOLS_DIR}/wayland_linux_dmabuf.h"</span>)</span>
        <span class="hljs-title function_">set</span><span class="hljs-params">(DMABUF_SOURCE <span class="hljs-string">"${PROTOCOLS_DIR}/wayland_linux_dmabuf.c"</span>)</span>
        
        <span class="hljs-title function_">if</span><span class="hljs-params">(NOT EXISTS ${DMABUF_HEADER} OR NOT EXISTS ${DMABUF_SOURCE})</span>
            <span class="hljs-title function_">execute_process</span><span class="hljs-params">(COMMAND wayland-scanner client-header ${DMABUF_XML} ${DMABUF_HEADER})</span>
            <span class="hljs-title function_">execute_process</span><span class="hljs-params">(COMMAND wayland-scanner private-code ${DMABUF_XML} ${DMABUF_SOURCE})</span>
        <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>
        <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND WAYLAND_PROTOCOLS_SRC ${DMABUF_SOURCE})</span>
    <span class="hljs-title function_">endif</span><span class="hljs-params">()</span>
    
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${PROTOCOLS_DIR})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND LV_LINUX_BACKEND_SRC src/lib/display_backends/wayland.c ${WAYLAND_PROTOCOLS_SRC})</span>

<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_X11)</span>

    <span class="hljs-title function_">find_package</span><span class="hljs-params">(PkgConfig REQUIRED)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(X11 REQUIRED x11)</span>

    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including X11 support"</span>)</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${X11_INCLUDE_DIRS})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${X11_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND LV_LINUX_BACKEND_SRC src/lib/display_backends/x11.c)</span>

<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_LINUX_FBDEV)</span>

    # FBDEV has no dependencies
    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including FBDEV support"</span>)</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND LV_LINUX_BACKEND_SRC src/lib/display_backends/fbdev.c)</span>

<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_GLFW)</span>

    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including GLFW support"</span>)</span>
    <span class="hljs-title function_">find_package</span><span class="hljs-params">(PkgConfig REQUIRED)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(GLFW3 REQUIRED glfw3)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(GLEW REQUIRED glew)</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${GLFW3_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${GLEW_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND LV_LINUX_BACKEND_SRC src/lib/display_backends/glfw3.c)</span>

<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_DRAW_G2D)</span>
    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including G2D support"</span>)</span>
    <span class="hljs-title function_">find_library</span><span class="hljs-params">(G2D_LIBRARY NAMES g2d)</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${G2D_LIBRARY})</span>
<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_GLTF)</span>
    <span class="hljs-title function_">message</span><span class="hljs-params">(STATUS <span class="hljs-string">"Including with GLTF support"</span>)</span>
    <span class="hljs-title function_">include</span><span class="hljs-params">(FetchContent)</span>
  
    <span class="hljs-title function_">FetchContent_Declare</span><span class="hljs-params">(
      fastgltf
      GIT_REPOSITORY https:<span class="hljs-comment">//github.com/spnda/fastgltf</span>
      GIT_TAG <span class="hljs-number">4e2261350888</span>bae7c35a1f39991f6233d57795f5)</span>
  
    <span class="hljs-title function_">set</span><span class="hljs-params">(FASTGLTF_ENABLE_DEPRECATED_EXT
        ON
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
  
    <span class="hljs-title function_">set</span><span class="hljs-params">(FASTGLTF_DIFFUSE_TRANSMISSION_SUPPORT
        ON
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
  
    <span class="hljs-title function_">FetchContent_MakeAvailable</span><span class="hljs-params">(fastgltf)</span>
  
    <span class="hljs-title function_">set</span><span class="hljs-params">(WEBP_BUILD_ANIM_UTILS
        OFF
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(WEBP_BUILD_CWEBP
        OFF
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(WEBP_BUILD_DWEBP
        OFF
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(WEBP_BUILD_GIF2WEBP
        OFF
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(WEBP_BUILD_IMG2WEBP
        OFF
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(WEBP_BUILD_VWEBP
        OFF
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(WEBP_BUILD_WEBPINFO
        OFF
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(WEBP_BUILD_WEBPMUX
        OFF
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(WEBP_BUILD_EXTRAS
        OFF
        CACHE BOOL <span class="hljs-string">""</span> FORCE)</span>
  
    <span class="hljs-title function_">FetchContent_Declare</span><span class="hljs-params">(
      webp
      GIT_REPOSITORY https:<span class="hljs-comment">//github.com/webmproject/libwebp</span>
      GIT_TAG fa6f56496a442eed59b103250021e4b14ebf1427)</span>
  
    <span class="hljs-title function_">FetchContent_MakeAvailable</span><span class="hljs-params">(webp)</span>
  
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB fastgltf webp)</span>
<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span> <span class="hljs-params">(CONFIG_LV_USE_GSTREAMER)</span>

    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including GSTREAMER support"</span>)</span>
    <span class="hljs-title function_">find_package</span><span class="hljs-params">(PkgConfig REQUIRED)</span>

    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(GSTREAMER REQUIRED gstreamer<span class="hljs-number">-1.0</span>)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(GSTREAMER_VIDEO REQUIRED gstreamer-video<span class="hljs-number">-1.0</span>)</span>
    <span class="hljs-title function_">pkg_check_modules</span><span class="hljs-params">(GSTREAMER_APP REQUIRED gstreamer-app<span class="hljs-number">-1.0</span>)</span>

    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_LIB ${GSTREAMER_VIDEO_LIBRARIES} ${GSTREAMER_APP_LIBRARIES})</span>
    <span class="hljs-title function_">list</span><span class="hljs-params">(APPEND PKG_CONFIG_INC ${GSTREAMER_VIDEO_INCLUDE_DIRS} ${GSTREAMER_APP_INCLUDE_DIRS})</span>
<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

# Check <span class="hljs-keyword">for</span> external demos
<span class="hljs-title function_">if</span><span class="hljs-params">(CONFIG_LV_USE_DEMO_FLEX_LAYOUT
   OR CONFIG_LV_USE_DEMO_MULTILANG
   OR CONFIG_LV_USE_DEMO_TRANSFORM
   OR CONFIG_LV_USE_DEMO_SCROLL
   OR CONFIG_LV_USE_DEMO_EBIKE
   OR CONFIG_LV_USE_DEMO_HIGH_RES
   OR CONFIG_LV_USE_DEMO_SMARTWATCH)</span>

    <span class="hljs-title function_">set</span><span class="hljs-params">(USE_EXTERNAL_DEMOS ON)</span>
<span class="hljs-title function_">else</span><span class="hljs-params">()</span>
    <span class="hljs-title function_">set</span><span class="hljs-params">(USE_EXTERNAL_DEMOS OFF)</span>
<span class="hljs-title function_">endif</span><span class="hljs-params">()</span>

<span class="hljs-title function_">if</span><span class="hljs-params">(USE_EXTERNAL_DEMOS)</span>
    <span class="hljs-title function_">message</span><span class="hljs-params">(<span class="hljs-string">"Including external demos"</span>)</span>
    <span class="hljs-title function_">include</span><span class="hljs-params">(FetchContent)</span>
    <span class="hljs-title function_">FetchContent_Declare</span><span class="hljs-params">(lv_demos_ext GIT_REPOSITORY https:<span class="hljs-comment">//github.com/lvgl/lv_demos)</span>
    FetchContent_MakeAvailable(lv_demos_ext)
    <span class="hljs-built_in">list</span>(APPEND PKG_CONFIG_LIB lv_demos_ext)
endif()


file(GLOB LV_LINUX_SRC src/lib<span class="hljs-comment">/*.c)
set(LV_LINUX_INC src/lib)

target_include_directories(lvgl PUBLIC ${PKG_CONFIG_INC})

add_library(lvgl_linux STATIC ${LV_LINUX_SRC} ${LV_LINUX_BACKEND_SRC})
target_include_directories(lvgl_linux PUBLIC ${PKG_CONFIG_INC})

# If LVGL is configured to use LV_CONF_PATH or Kconfig
# Set the exactly the same definitions on the lvgl_linux target
set_target_properties(lvgl_linux PROPERTIES COMPILE_DEFINITIONS "${LVGL_COMPILER_DEFINES}")
target_include_directories(lvgl_linux PUBLIC
    ${LV_LINUX_INC} ${CMAKE_CURRENT_SOURCE_DIR}
    ${PROJECT_SOURCE_DIR}/src/lib ${LVGL_CONF_INC_DIR})

# Link LVGL with external dependencies - Modern CMake/CMP0079 allows this
target_link_libraries(lvgl PUBLIC ${PKG_CONFIG_LIB} m pthread)

add_executable(lvglsim src/main.c ${LV_LINUX_SRC} ${LV_LINUX_BACKEND_SRC})
target_link_libraries(lvglsim lvgl_linux lvgl)

if(WERROR)
    target_compile_options(lvglsim PRIVATE -Werror)
    target_compile_options(lvgl PRIVATE -Werror)
    target_compile_options(lvgl_linux PRIVATE -Werror)
endif()


# Install the lvgl_linux library and its headers
install(DIRECTORY src/lib/
    DESTINATION include/lvgl
    FILES_MATCHING
    PATTERN "backends*" EXCLUDE
    PATTERN "*.h")

install(TARGETS lvgl_linux
    ARCHIVE DESTINATION lib
)

add_custom_target(run COMMAND ${EXECUTABLE_OUTPUT_PATH}/lvglsim DEPENDS lvglsim)

</span></span></code></pre>
<p>修改<code>configs/fbdev.default</code>:</p>
<pre><code class="hljs language-C" lang="C">LV_COLOR_DEPTH	    <span class="hljs-number">24</span>

LV_USE_LINUX_FBDEV      <span class="hljs-number">1</span>
LV_LINUX_FBDEV_RENDER_MODE   LV_DISPLAY_RENDER_MODE_DIRECT
LV_LINUX_FBDEV_BUFFER_COUNT  <span class="hljs-number">2</span>

# Input support
LV_USE_EVDEV    <span class="hljs-number">0</span>
LV_USE_LIBINPUT <span class="hljs-number">0</span>
LV_USE_TSLIB    <span class="hljs-number">1</span>                      #添加该字段,启用tslib支持

# Examples
LV_BUILD_EXAMPLES <span class="hljs-number">1</span>

# Demos
LV_BUILD_DEMOS <span class="hljs-number">1</span>
LV_USE_DEMO_WIDGETS         <span class="hljs-number">1</span>
LV_USE_DEMO_KEYPAD_AND_ENCODER <span class="hljs-number">0</span>
LV_USE_DEMO_BENCHMARK       <span class="hljs-number">0</span>
LV_USE_DEMO_RENDER          <span class="hljs-number">0</span>
LV_USE_DEMO_STRESS          <span class="hljs-number">0</span>
LV_USE_DEMO_MUSIC           <span class="hljs-number">0</span>

......

</code></pre>
<p>为了使得<code>LV_USE_TSLIB</code>能够生成<code>CONFIG_LV_USE_TSLIB</code>,需要修改<code>lvgl/lv_conf_template.h</code>:</p>
<pre><code class="hljs language-C" lang="C">......

<span class="hljs-comment">/** Interface for Lovyan_GFX */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LV_USE_LOVYAN_GFX         0</span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_LOVYAN_GFX</span>
    <span class="hljs-meta">#<span class="hljs-keyword">define</span> LV_LGFX_USER_INCLUDE <span class="hljs-string">"lv_lgfx_user.hpp"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/*LV_USE_LOVYAN_GFX*/</span></span>

<span class="hljs-comment">/** Driver for tslib input devices */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LV_USE_TSLIB    0                    <span class="hljs-comment">//添加该字段</span></span>

<span class="hljs-comment">/** Driver for evdev input devices */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LV_USE_EVDEV    0</span>

<span class="hljs-comment">/** Driver for libinput input devices */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LV_USE_LIBINPUT    0</span>

......
</code></pre>
<p>使用交叉编译环境时,cmake命令还需搭配文件<code>user_cross_compile_setup.cmake</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Usage:</span>
<span class="hljs-comment"># cmake -DCMAKE_TOOLCHAIN_FILE=./user_cross_compile_setup.cmake -B build -S .</span>
<span class="hljs-comment"># make  -C build -j</span>

<span class="hljs-built_in">set</span>(CMAKE_SYSTEM_NAME Linux)
<span class="hljs-built_in">set</span>(CMAKE_SYSTEM_PROCESSOR arm)

<span class="hljs-built_in">set</span>(CROSS_COMPILE /home/ender/sunxi/buildroot/buildroot-2025.02.7/output/host/bin/arm-buildroot-linux-gnueabi-)
<span class="hljs-built_in">set</span>(CMAKE_C_COMPILER <span class="hljs-variable">${CROSS_COMPILE}</span>gcc)
<span class="hljs-built_in">set</span>(CMAKE_CXX_COMPILER <span class="hljs-variable">${CROSS_COMPILE}</span>g++)

<span class="hljs-comment"># If necessary, set STAGING_DIR</span>
<span class="hljs-comment"># if not work, please try(in shell command): export STAGING_DIR=/home/ubuntu/Your_SDK/out/xxx/openwrt/staging_dir/target</span>
<span class="hljs-built_in">set</span>(STAGING_DIR <span class="hljs-string">"/home/ender/sunxi/buildroot/buildroot-2025.02.7/output/staging"</span>)

</code></pre>
<p><code>STAGING_DIR</code>指向自己的<code>staging rootfs</code>即可。
添加文件<code>src/lib/indev_backends/tslib.c</code>,添加tslib触摸驱动注册接口:</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-comment">/**
 *
 * @file evdev.c
 *
 * The lib evdev driver
 *
 * Based on the original file from the repository
 *
 * - Move the driver to a separate file to avoid excessive conditional
 *   compilation
 *   Author: EDGEMTech Ltd, Erik Tagirov (erik.tagirov@edgemtech.ch)
 *
 * Copyright (c) 2025 EDGEMTech Ltd.
 *
 */</span>

<span class="hljs-comment">/*********************
 *      INCLUDES
 *********************/</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"lvgl/lvgl.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_TSLIB</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"lvgl/src/core/lv_global.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"../backends.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"tslib.h"</span></span>

<span class="hljs-comment">/*********************
 *      DEFINES
 *********************/</span>

<span class="hljs-comment">/**********************
 *      TYPEDEFS
 **********************/</span>

<span class="hljs-comment">/**********************
 *  STATIC PROTOTYPES
 **********************/</span>

<span class="hljs-type">static</span> <span class="hljs-type">lv_indev_t</span> *<span class="hljs-title function_">init_pointer_tslib</span><span class="hljs-params">(<span class="hljs-type">lv_display_t</span> *display)</span>;

<span class="hljs-comment">/**********************
 *  STATIC VARIABLES
 **********************/</span>

<span class="hljs-type">static</span> <span class="hljs-type">char</span> *backend_name = <span class="hljs-string">"TSLIB"</span>;
<span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tsdev</span> *<span class="hljs-title">ts</span> =</span> <span class="hljs-literal">NULL</span>;

<span class="hljs-comment">/**********************
 *      MACROS
 **********************/</span>

<span class="hljs-comment">/**********************
 *   GLOBAL FUNCTIONS
 **********************/</span>

<span class="hljs-comment">/*
 * Initialize the tslib driver
 *
 * @param backend the backend descriptor
 */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">backend_init_tslib</span><span class="hljs-params">(<span class="hljs-type">backend_t</span> *backend)</span>
{
    LV_ASSERT_NULL(backend);
    backend-&gt;handle-&gt;indev = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">indev_backend_t</span>));
    LV_ASSERT_NULL(backend-&gt;handle-&gt;indev);

    backend-&gt;handle-&gt;indev-&gt;init_indev = init_pointer_tslib;

    backend-&gt;name = backend_name;
    backend-&gt;type = BACKEND_INDEV;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}


<span class="hljs-comment">/**********************
 *   STATIC FUNCTIONS
 **********************/</span>

<span class="hljs-type">static</span> <span class="hljs-type">lv_coord_t</span> last_x = <span class="hljs-number">0</span>;
<span class="hljs-type">static</span> <span class="hljs-type">lv_coord_t</span> last_y = <span class="hljs-number">0</span>;
<span class="hljs-type">static</span> <span class="hljs-type">lv_indev_state_t</span> last_state = LV_INDEV_STATE_RELEASED;

<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">tslib_read_cb</span><span class="hljs-params">(<span class="hljs-type">lv_indev_t</span> *indev, <span class="hljs-type">lv_indev_data_t</span> *data)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ts_sample</span> <span class="hljs-title">samp</span>;</span>

    <span class="hljs-keyword">if</span>(!ts) {
        data-&gt;state = LV_INDEV_STATE_RELEASED;
        data-&gt;point.x = <span class="hljs-number">0</span>;
        data-&gt;point.y = <span class="hljs-number">0</span>;
        data-&gt;continue_reading = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">/* 读取队列中所有事件，最后一个点作为当前状态 */</span>
    <span class="hljs-keyword">while</span>(ts_read(ts, &amp;samp, <span class="hljs-number">1</span>) &gt; <span class="hljs-number">0</span>) {
        last_x = samp.x;
        last_y = samp.y;
        last_state = (samp.pressure &gt; <span class="hljs-number">0</span>) ? LV_INDEV_STATE_PRESSED : LV_INDEV_STATE_RELEASED;
    }

    data-&gt;point.x = last_x;
    data-&gt;point.y = last_y;
    data-&gt;state   = last_state;
    data-&gt;continue_reading = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">/* 限幅到屏幕分辨率 */</span>
    <span class="hljs-type">lv_disp_t</span> *disp = lv_indev_get_display(indev);
    <span class="hljs-type">lv_coord_t</span> hor_res = lv_disp_get_hor_res(disp);
    <span class="hljs-type">lv_coord_t</span> ver_res = lv_disp_get_ver_res(disp);

    <span class="hljs-keyword">if</span>(data-&gt;point.x &lt; <span class="hljs-number">0</span>) data-&gt;point.x = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(data-&gt;point.y &lt; <span class="hljs-number">0</span>) data-&gt;point.y = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(data-&gt;point.x &gt;= hor_res) data-&gt;point.x = hor_res - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(data-&gt;point.y &gt;= ver_res) data-&gt;point.y = ver_res - <span class="hljs-number">1</span>;
}

<span class="hljs-type">static</span> <span class="hljs-type">lv_indev_t</span> *<span class="hljs-title function_">init_pointer_tslib</span><span class="hljs-params">(<span class="hljs-type">lv_display_t</span> *display)</span>
{
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *input_device = getenv(<span class="hljs-string">"TSLIB_TSDEVICE"</span>);
    <span class="hljs-keyword">if</span>(!input_device) 
    {
        input_device = <span class="hljs-string">"/dev/input/event0"</span>;   
        LV_LOG_USER(<span class="hljs-string">"Using default input device %s\r\n"</span>, input_device);
    }

    ts = ts_setup(input_device, O_RDONLY | O_NONBLOCK);
    <span class="hljs-keyword">if</span>(!ts) {
        LV_LOG_ERROR(<span class="hljs-string">"ts_setup failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    }
    
    <span class="hljs-type">lv_indev_t</span> * indev = lv_indev_create();
    lv_indev_set_type(indev, LV_INDEV_TYPE_POINTER);
    lv_indev_set_read_cb(indev, tslib_read_cb);
    lv_indev_set_display(indev, display);

    <span class="hljs-keyword">return</span> indev;
}
<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/*#if LV_USE_TSLIB*/</span></span>
</code></pre>
<p>记得在<code>src/lib/driver_backends.c</code>里的<code>available_backends</code>数组中添加一项新的backends</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-comment">/* The default backend is the one that will end up at index 0
 * To add support for a new driver backend add the declaration
 * and append an entry to the available_backends array
 */</span>
<span class="hljs-type">backend_init_t</span> available_backends[] = {

<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_LINUX_FBDEV</span>
    backend_init_fbdev,
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_LINUX_DRM</span>
    backend_init_drm,
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_SDL</span>
    backend_init_sdl,
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_WAYLAND</span>
    backend_init_wayland,
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_X11</span>
    backend_init_x11,
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_GLFW</span>
    backend_init_glfw3,
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_EVDEV</span>
    backend_init_evdev,
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_TSLIB</span>
    backend_init_tslib,
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

    <span class="hljs-literal">NULL</span>    <span class="hljs-comment">/* Sentinel */</span>
};
</code></pre>
<p>最后别忘了<code>src/main.c</code>里要手动去初始化</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-comment">/**
 * @brief entry point
 * @description start a demo
 * @param argc the count of arguments in argv
 * @param argv The arguments
 */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span>
{

    configure_simulator(argc, argv);

    <span class="hljs-comment">/* Initialize LVGL. */</span>
    lv_init();

    <span class="hljs-comment">/* Initialize the configured backend */</span>
    <span class="hljs-keyword">if</span> (driver_backends_init_backend(selected_backend) == <span class="hljs-number">-1</span>) {
        die(<span class="hljs-string">"Failed to initialize display backend"</span>);
    }

    <span class="hljs-comment">/* Enable for EVDEV support */</span>
<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_EVDEV</span>
    <span class="hljs-keyword">if</span> (driver_backends_init_backend(<span class="hljs-string">"EVDEV"</span>) == <span class="hljs-number">-1</span>) {
        die(<span class="hljs-string">"Failed to initialize evdev"</span>);
    }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

    <span class="hljs-comment">/* Enable for TSLIB support */</span>
<span class="hljs-meta">#<span class="hljs-keyword">if</span> LV_USE_TSLIB</span>
    <span class="hljs-keyword">if</span> (driver_backends_init_backend(<span class="hljs-string">"TSLIB"</span>) == <span class="hljs-number">-1</span>) {
        die(<span class="hljs-string">"Failed to initialize tslib"</span>);
    }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

    <span class="hljs-comment">/*Create a Demo*/</span>
    lv_demo_widgets();
    <span class="hljs-comment">//lv_demo_widgets_start_slideshow();</span>

    <span class="hljs-comment">/* Enter the run loop of the selected backend */</span>
    driver_backends_run_loop();

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

</code></pre>
<p>都完成后执行</p>
<pre><code class="hljs language-sh" lang="sh">cmake CMakeLists.txt -DCMAKE_TOOLCHAIN_FILE=./user_cross_compile_setup.cmake -B build -DCONFIG=fbdev -DCROSS_BUILD=ON
</code></pre>
<p>即可完成,这样改动的优点是保持<code>lvgl</code>原有的构建架构,同时<code>tslib</code>作为可选模块被添加到了构建系统中,避免了硬编码，保证了未来更新的兼容性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Frida for MacBook/Android 安装配置]]></title>    <link>https://juejin.cn/post/7577663384423923763</link>    <guid>https://juejin.cn/post/7577663384423923763</guid>    <pubDate>2025-11-29T09:23:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577663384423923763" data-draft-id="7577689171221872690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Frida for MacBook/Android 安装配置"/> <meta itemprop="keywords" content="前端,Android"/> <meta itemprop="datePublished" content="2025-11-29T09:23:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YF0211"/> <meta itemprop="url" content="https://juejin.cn/user/2576910988619064"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Frida for MacBook/Android 安装配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2576910988619064/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YF0211
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T09:23:39.000Z" title="Sat Nov 29 2025 09:23:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>第一阶段：安装 Frida Client</strong></h3>
<h4 data-id="heading-1"><strong>步骤 1：准备工作 - 安装 Python 和 pip</strong></h4>
<p><strong>检查 Python 3</strong>：在终端中输入：</p>
<p>bash</p>
<pre><code class="hljs language-css" lang="css">python3 <span class="hljs-attr">--version</span>
</code></pre>
<p><strong>检查 pip</strong>：输入以下命令检查 pip：</p>
<p>bash</p>
<pre><code class="hljs language-css" lang="css">pip3 <span class="hljs-attr">--version</span>
</code></pre>
<h4 data-id="heading-2"><strong>步骤 2：使用 pip 安装 Frida 和 Frida-tools</strong></h4>
<p><strong>强烈建议</strong>在虚拟环境中安装，以避免与系统其他 Python 包发生冲突。</p>
<p>1、  <strong>安装虚拟环境工具</strong>（如果尚未安装）：</p>
<pre><code class="hljs">pip3 install virtualenv

</code></pre>
<p>2、  <strong>创建并激活一个虚拟环境</strong>：</p>
<p>创建一个名为 'frida_env' 的虚拟环境目录</p>
<pre><code class="hljs language-bash" lang="bash">python3 -m venv ~/frida_env 
</code></pre>
<p>激活虚拟环境</p>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-built_in">source</span> ~/frida_env/bin/activate
</code></pre>
<p>激活后，您的命令行提示符前会出现 <code>(frida_env)</code> 字样。</p>
<ol start="3">
<li>安装 Frida（现在可以在虚拟环境中安全安装）</li>
</ol>
<pre><code class="hljs">pip install frida frida-tools
</code></pre>
<ol start="4">
<li>验证安装</li>
</ol>
<pre><code class="hljs language-css" lang="css">frida <span class="hljs-attr">--version</span>
</code></pre>
<p>使用时的激活命令</p>
<h6 data-id="heading-3">每次使用 Frida 前执行：</h6>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span> ~/frida_env/bin/activate
</code></pre>
<h3 data-id="heading-4"><strong>第二阶段：安装 Frida Server（在目标设备上）</strong></h3>
<p>android:下载 Frida Server（ARM64），frida-server：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffrida%2Ffrida%2Freleases" target="_blank" title="https://github.com/frida/frida/releases" ref="nofollow noopener noreferrer">github.com/frida/frida…</a></p>
<pre><code class="hljs language-perl" lang="perl">xz -d  frida-server-<span class="hljs-number">17.5</span>.<span class="hljs-number">1</span>-android-arm64.xz
<span class="hljs-keyword">chmod</span> +<span class="hljs-keyword">x</span> frida-server-<span class="hljs-number">17.5</span>.<span class="hljs-number">1</span>-android-arm64
adb <span class="hljs-keyword">push</span> frida-server-<span class="hljs-number">17.5</span>.<span class="hljs-number">1</span>-android-arm64 /data/<span class="hljs-keyword">local</span>/tmp/frida
adb shell
su
<span class="hljs-keyword">chmod</span> +<span class="hljs-keyword">x</span> /data/<span class="hljs-keyword">local</span>/tmp/frida
/data/<span class="hljs-keyword">local</span>/tmp/frida &amp;
</code></pre>
<p>遇到问题：
macBook端：</p>
<pre><code class="hljs">frida-ps -U 
</code></pre>
<p>报错：Failed to enumerate processes: unable to perform ptrace pokedata: I/O error</p>
<p>解决：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在设备上执行</span>
adb shell
su -

<span class="hljs-comment"># 检查当前 SELinux 状态</span>
getenforce
<span class="hljs-comment"># 如果显示 Enforcing，需要禁用</span>

<span class="hljs-comment"># 临时禁用 SELinux</span>
setenforce 0

<span class="hljs-comment"># 验证</span>
getenforce
<span class="hljs-comment"># 应该显示：Permissive</span>

<span class="hljs-comment"># 杀掉旧的 Frida 进程</span>
pkill -9 frida

<span class="hljs-comment"># 重新启动 Frida Server</span>
<span class="hljs-built_in">nohup</span> /data/local/tmp/frida-server &gt; /dev/null 2&gt;&amp;1 &amp;

<span class="hljs-comment"># 验证进程</span>
ps -A | grep frida
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🧠 深入理解 JavaScript Promise 与 `Promise.all`：从原型链到异步编程实战]]></title>    <link>https://juejin.cn/post/7577625663257673728</link>    <guid>https://juejin.cn/post/7577625663257673728</guid>    <pubDate>2025-11-29T09:32:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577625663257673728" data-draft-id="7577587651895181353" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🧠 深入理解 JavaScript Promise 与 `Promise.all`：从原型链到异步编程实战"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-29T09:32:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神秘的猪头"/> <meta itemprop="url" content="https://juejin.cn/user/793223472877051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🧠 深入理解 JavaScript Promise 与 `Promise.all`：从原型链到异步编程实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/793223472877051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神秘的猪头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T09:32:06.000Z" title="Sat Nov 29 2025 09:32:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 JavaScript 开发中，<strong>Promise</strong> 是处理异步操作的核心机制之一。ES6 引入的 <code>Promise</code> 极大地简化了“回调地狱”（Callback Hell）问题，并为后续的 <code>async/await</code> 语法奠定了基础。而 <code>Promise.all</code> 则是并发执行多个异步任务并统一处理结果的强大工具。</p>
<p>本文将结合 <strong>原型链原理</strong>、<strong>Promise 基础用法</strong> 和 <strong>实际示例代码</strong>，带你系统掌握 <code>Promise</code> 及其静态方法 <code>Promise.all</code> 的使用与底层逻辑。</p>
<hr/>
<h2 data-id="heading-0">🔗 一、JavaScript 的面向对象：原型链而非“血缘”</h2>
<p>在深入 Promise 之前，我们先厘清一个关键概念：<strong>JavaScript 的继承不是基于“类”的血缘关系，而是基于原型（prototype）的链式查找机制</strong>。</p>
<h3 data-id="heading-1">1.1 🏗️ 构造函数与原型对象</h3>
<pre><code class="hljs language-ini" lang="ini">function Person(name, age) {
    <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.age</span> = age<span class="hljs-comment">;</span>
}

<span class="hljs-attr">Person.prototype.speci</span> = <span class="hljs-string">'人类'</span><span class="hljs-comment">;</span>

let <span class="hljs-attr">zhen</span> = new Person(<span class="hljs-string">'张三'</span>, <span class="hljs-number">18</span>)<span class="hljs-comment">;</span>
console.log(zhen.speci)<span class="hljs-comment">; // 输出: "人类"</span>
</code></pre>
<ul>
<li><code>Person</code> 是构造函数。</li>
<li><code>Person.prototype</code> 是所有 <code>Person</code> 实例共享的原型对象。</li>
<li><code>zhen.__proto__</code> 指向 <code>Person.prototype</code>。</li>
<li><code>Person.prototype.constructor</code> 又指回 <code>Person</code>，形成闭环。</li>
</ul>
<blockquote>
<p>🚂 <strong>小比喻</strong>：可以把 <code>constructor</code> 看作“车头”，<code>prototype</code> 是“车身”。实例通过 <code>__proto__</code> 连接到车身，而车身知道自己的车头是谁。</p>
</blockquote>
<h3 data-id="heading-2">1.2 ⚡ 动态修改原型链（不推荐）</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">kong</span> = {
    name: '孔子',
    hobbies: <span class="hljs-section">['读书', '喝酒']</span>
}<span class="hljs-comment">;</span>

<span class="hljs-attr">zhen.__proto__</span> = kong<span class="hljs-comment">;</span>
console.log(zhen.hobbies)<span class="hljs-comment">;     // ✅ 输出: ['读书', '喝酒']</span>
console.log(kong.prototype)<span class="hljs-comment">;   // ❌ undefined！普通对象没有 prototype 属性</span>
</code></pre>
<blockquote>
<p>⚠️ 注意：</p>
<ul>
<li>只有<strong>函数</strong>才有 <code>prototype</code> 属性；</li>
<li>普通对象（如 <code>kong</code>）只有 <code>__proto__</code>，没有 <code>prototype</code>。</li>
<li>在这里kong是object的一个实例<code>kong.__prpto__ == object.prototype</code></li>
</ul>
<p>💡 虽然可以动态修改 <code>__proto__</code>，但会破坏代码可预测性，影响性能，应避免使用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">⏳ 二、Promise：ES6 的异步解决方案</h2>
<h3 data-id="heading-4">2.1 🧩 Promise 基本结构</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>); <span class="hljs-comment">// 同步执行</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">333</span>);
        <span class="hljs-comment">// resolve('结果1');  // 成功</span>
        <span class="hljs-title function_">reject</span>(<span class="hljs-string">'失败1'</span>);      <span class="hljs-comment">// 失败</span>
    }, <span class="hljs-number">1000</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">222</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p, <span class="hljs-string">'////////'</span>); <span class="hljs-comment">// 此时 p 状态仍是 pending</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">__proto__</span> == <span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">📋 执行顺序分析：</h4>
<ol>
<li><code>111</code> 立即输出（executor 函数同步执行）✅</li>
<li><code>222</code> 紧接着输出 ✅</li>
<li><code>p</code> 此时处于 <strong>pending（等待）</strong> 状态 ⏳</li>
<li>1 秒后，<code>333</code> 输出，调用 <code>reject('失败1')</code>，状态变为 <strong>rejected</strong> ❌</li>
<li><code>.catch()</code> 捕获错误，<code>.finally()</code> 无论成功失败都会执行 🔁</li>
</ol>
<h3 data-id="heading-6">2.2 🎯 Promise 的三种状态</h3>
<ul>
<li><strong>⏳ pending</strong>：初始状态，既不是成功也不是失败。</li>
<li><strong>✅ fulfilled</strong>：操作成功完成（通过 <code>resolve</code> 触发）。</li>
<li><strong>❌ rejected</strong>：操作失败（通过 <code>reject</code> 触发）。</li>
</ul>
<blockquote>
<p>🔒 <strong>核心特性</strong>：一旦状态改变，就<strong>不可逆</strong>。这是 Promise 的设计基石。</p>
</blockquote>
<h3 data-id="heading-7">2.3 🔍 原型关系验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// ✅ true</span>
</code></pre>
<ul>
<li><code>p</code> 是 <code>Promise</code> 的实例。</li>
<li>所有 Promise 实例的 <code>__proto__</code> 都指向 <code>Promise.prototype</code>。</li>
<li><code>Promise.prototype</code> 上定义了 <code>.then()</code>, <code>.catch()</code>, <code>.finally()</code> 等方法。</li>
<li><code>Promise.prototype.__proto__ == object.prototype</code></li>
</ul>
<hr/>
<h2 data-id="heading-8">🚀 三、<code>Promise.all</code>：并发处理多个异步任务</h2>
<h3 data-id="heading-9">3.1 ❓ 什么是 <code>Promise.all</code>？</h3>
<p><code>Promise.all(iterable)</code> 接收一个可迭代对象（如数组），其中包含多个 Promise。它返回一个新的 Promise：</p>
<ul>
<li><strong>✅ 全部成功</strong> → 返回一个包含所有结果的数组（顺序与输入一致）。</li>
<li><strong>❌ 任一失败</strong> → 立即 rejected，返回第一个失败的原因。</li>
</ul>
<h3 data-id="heading-10">3.2 💻 使用示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> task1 = <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user'</span>);       <span class="hljs-comment">// 假设返回 { id: 1, name: 'Alice' }</span>
<span class="hljs-keyword">const</span> task2 = <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/posts'</span>);      <span class="hljs-comment">// 假设返回 [{ title: 'JS' }]</span>
<span class="hljs-keyword">const</span> task3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'done'</span>), <span class="hljs-number">500</span>));

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([task1, task2, task3])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[user, posts, msg]</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'全部完成:'</span>, user, posts, msg);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'某个任务失败:'</span>, err);
  });
</code></pre>
<blockquote>
<p>🌐 <strong>适用场景</strong>：需要同时加载用户信息、文章列表、配置数据等，全部就绪后再渲染页面。</p>
</blockquote>
<h3 data-id="heading-11">3.3 ⚠️ 错误处理演示</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">p1</span> = Promise.resolve(<span class="hljs-string">'成功1'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">p2</span> = Promise.reject(<span class="hljs-string">'失败2'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">p3</span> = Promise.resolve(<span class="hljs-string">'成功3'</span>)<span class="hljs-comment">;</span>

Promise.all(<span class="hljs-section">[p1, p2, p3]</span>)
  .then(<span class="hljs-attr">results</span> =&gt; console.log(<span class="hljs-string">'不会执行'</span>))
  .catch(<span class="hljs-attr">err</span> =&gt; console.log(<span class="hljs-string">'捕获错误:'</span>, err))<span class="hljs-comment">; // 输出: "失败2"</span>
</code></pre>
<blockquote>
<p>❗ <strong>关键点</strong>：只要有一个失败，整个 <code>Promise.all</code> 就失败，其余成功的 Promise 结果会被丢弃。</p>
</blockquote>
<h3 data-id="heading-12">3.4 🛡️ 替代方案：<code>Promise.allSettled</code>（ES2020）</h3>
<p>如果你希望<strong>无论成功失败都等待所有任务完成</strong>，可以使用 <code>Promise.allSettled</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([p1, p2, p3])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
    results.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">res, i</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ 任务<span class="hljs-subst">${i}</span> 成功:`</span>, res.<span class="hljs-property">value</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`❌ 任务<span class="hljs-subst">${i}</span> 失败:`</span>, res.<span class="hljs-property">reason</span>);
      }
    });
  });
</code></pre>
<blockquote>
<p>✅ 适用于：批量上传、日志收集、非关键资源加载等场景。</p>
</blockquote>
<hr/>
<h2 data-id="heading-13">📚 四、总结：从原型到实践</h2>





























<table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td>🔗 <strong>原型链</strong></td><td>JS 对象通过 <code>__proto__</code> 查找属性，<code>constructor</code> 指回构造函数</td></tr><tr><td>⏳ <strong>Promise</strong></td><td>表示异步操作的最终完成或失败，具有 pending/fulfilled/rejected 三种状态</td></tr><tr><td>🧩 <strong>Promise.prototype</strong></td><td>所有 Promise 实例的方法来源（<code>.then</code>, <code>.catch</code> 等）</td></tr><tr><td>🚀 <strong>Promise.all</strong></td><td>并发执行多个 Promise，全成功则成功，任一失败则整体失败</td></tr><tr><td>🛡️ <strong>最佳实践</strong></td><td>使用 <code>Promise.all</code> 提升性能；用 <code>allSettled</code> 处理非关键任务</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">💭 五、思考题</h2>
<ol>
<li>🤔 为什么 <code>console.log(p)</code> 在 <code>setTimeout</code> 之前打印时，状态是 <code>pending</code>？</li>
<li>🛠️ 能否通过修改 <code>Promise.prototype.then</code> 来全局拦截所有 Promise 的成功回调？这样做有什么风险？</li>
<li>📦 如果 <code>Promise.all</code> 中传入空数组 <code>[]</code>，结果会是什么？</li>
</ol>
<blockquote>
<p>💡 <strong>答案提示</strong>：</p>
<ol>
<li>因为异步任务尚未执行，状态未改变。</li>
<li>技术上可行，但会破坏封装性、可测试性和团队协作，<strong>强烈不推荐</strong>。</li>
<li>立即 resolved，返回空数组 <code>[]</code> —— 这是符合规范的！</li>
</ol>
</blockquote>
<hr/>
<p>通过本文，你不仅掌握了 <code>Promise</code> 和 <code>Promise.all</code> 的用法，还理解了其背后的 <strong>原型机制</strong> 和 <strong>异步执行模型</strong>。这将为你编写健壮、高效的异步代码打下坚实基础。🌟</p>
<p>Happy Coding! 💻✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>