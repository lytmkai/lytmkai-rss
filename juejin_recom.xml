<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[小需求做到千万美元 ARR：remove.bg 全案拆解]]></title>    <link>https://juejin.cn/post/7576918517238349874</link>    <guid>https://juejin.cn/post/7576918517238349874</guid>    <pubDate>2025-11-27T05:17:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576918517238349874" data-draft-id="7576929700842160137" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小需求做到千万美元 ARR：remove.bg 全案拆解"/> <meta itemprop="keywords" content="产品,AI编程"/> <meta itemprop="datePublished" content="2025-11-27T05:17:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟健AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/4212984287073895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小需求做到千万美元 ARR：remove.bg 全案拆解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984287073895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟健AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T05:17:48.000Z" title="Thu Nov 27 2025 05:17:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是孟健。</p>
<p>今天开始，我将带领大家一起分析商业、分析产品。</p>
<p>这是商业洞察系列的第一篇。</p>
<p>为什么要开启这个系列呢？</p>
<p>在出海复盘中我写道，我们团队的优势在效率，劣势在市场。</p>
<p>我认为初创企业，需要关注的重点就是市场+效率，这两个做好了，就成功了一半。</p>
<p>因此，从现在开始，我自己会投入 50%的精力在市场研究、商业洞察这里，希望带头弥补这块的短板。</p>
<p>今天跟大家分享的这款产品是 remove.bg，这也是 AI 榜单前 10 的产品。</p>
<p>这个产品我觉得很值得研究学习，因为它其实是一个很垂直的需求市场，但是以小博大，它赚的钱不少。</p>
<h2 data-id="heading-0">01 价值主张写进 TDH</h2>
<p>先分析一下这个站点整体的 SEO 和流量情况。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fce8dabb78bd4442a32d253e5290bcf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=QTMD3gYnmnYTIAB3ZWzSXpN7sXo%3D" alt="" loading="lazy"/></p>
<p>我觉得这个站点首先值得学习的是它的 TDH，让我们仔细观摩一下：</p>
<p>title: Remove Background from Image for Free – remove.bg</p>
<p>Description: Remove image backgrounds automatically in 5 seconds with just one click. Don't spend hours manually picking pixels. Upload your photo now &amp; see the magic.</p>
<p>H1: Remove Image Background</p>
<p>这个 TDH 好在哪呢？我觉得重要的是包含了价值主张。</p>
<p>价值主张是精益画布很重要的一环，做产品前，应该先想好价值主张是什么。</p>
<p>它的标题，首先描述的主功能 Remove Background，然后抛出了一个 Free 的钩子，增加 serp 吸引力。</p>
<p>这也是我们惯用的技巧了，我在优化 serp 展现的时候也经常会用这个手段。</p>
<p>Description 则详细地包含了它的价值主张：5 second with just one click。</p>
<p>很多人不重视这个，导致你的 serp 没有吸引力，用户看到都不会点击进去。</p>
<p>这个 TDH 就非常有吸引力，抓住了用户的痛点，这个团队一定是深入调研过用户需求的。</p>
<p>实际上我们仅仅通过这个 TDH 就已经可以分析出用户需求了：</p>
<p><strong>想要找一个免费的去除背景图的工具，快速处理图片。</strong></p>
<h2 data-id="heading-1">02 OpenGraph 让传播自带转化力</h2>
<p>除了 TDH 之外，我觉得这个站点在 SEO 还有一点值得我们学习的就是 OpenGraph：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0171539408f642ec9c68f72ed13ec4e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=0lrqMlED6MjCIisHTMgJ0sjSoWw%3D" alt="" loading="lazy"/></p>
<p>OpenGraph 我们会经常忽略，但在 Twitter 这样的媒体平台传播是一个非常关键的因素。</p>
<p>remove.bg 这张图是精心设计过的，有 before 和 after 对比，在社媒平台上你看到这张图，一眼就能明白这个产品的价值。</p>
<h2 data-id="heading-2">03 流量盘子：80M/月的搜索 + 直访</h2>
<p>聊完 SEO，我们看看站点的流量情况。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af831f8d7bb34b7bb735bc4316bb6640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=rYezQVFZKTHP%2BQ16x7NZFQqzKew%3D" alt="" loading="lazy"/></p>
<p>这个站点近 3 个月，每个月大概有将近八千万的访问，是一个流量极高的站点，流量来源基本上是搜索+直接访问。</p>
<p>为什么这个站点直接访问这么高呢？我觉得首先是这个域名注册得非常好。</p>
<p>这是一个用户需求关键词的域名，非常容易记忆，用户在使用过后，可能就直接记住域名，下次就直接过来了。</p>
<p>然后再看它的搜索关键词，remove bg 这个关键词，月搜索量总数在 400 万，而它把这个流量全吃了。</p>
<p>也就是说，它在这个关键词上处于绝对的领先地位，一点流量都没有去竞争对手那里。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bdc94931e5544eea39b04696ee7b0a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=r%2Bs7pjDC3DLNxB2X72J%2FWLz7Cmo%3D" alt="" loading="lazy"/></p>
<p>从 SimilarWeb 上可以看到，它的品牌词占比 96%，而它的品牌词就是需求词，基本上在这个词上就是垄断了。</p>
<p>对于 background remover、remove background，也有基本上六七十的市场占有率。</p>
<p>它的流量大头国家可以看到是印度、巴西、美国等地区。</p>
<p>一般来说我们认为来自印巴地区的流量比较廉价，但是他这个量级非常大，即使 cpm 很低也能赚很多钱了。</p>
<p>不过我在这个站点上暂时没有发现广告的痕迹，在 SImilarWeb 上其实是有的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76ec47f3c220457c9fd99ee4c11ffc6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=d68oX3TuTgoGHnSydIBTvXbygPA%3D" alt="" loading="lazy"/></p>
<p>出站流量第一名是 google，大概率是 adsense 广告了，不知道为什么他们现在去掉了广告。</p>
<h2 data-id="heading-3">04 赚多少钱？保守估算也很香</h2>
<p>就算按照最低的 cpm 估计，这个站纯广告收入也可以月入十万刀了，年入百万美金。</p>
<p>由于这个站点把 checkout 页面设置为不索引，所以没法估计它的订单量，但就算按照千分之一的转化率，它的定价策略按$10 来算，也有每个月 80 万刀的收益。</p>
<p>那么加起来，remove.bg 的 ARR 应该至少是千万美元级别的。就这么个小需求，做到了千万 ARR，这就是海外的生态。</p>
<p>这个域名的 whois 挂了，查不到是什么时候注册的域名，不过可以通过 archive 推断：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93392d33e11248c68b8e546c4e26c9a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=W1qKNPC54H%2F9IW03mfK7QB44tMc%3D" alt="" loading="lazy"/></p>
<p>其实 18 年的时候，这个站点就在布局了，他们的第一个版本就是 remove bg，那个时候 AI 还没有火热：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c35a3402fba4baaac659eef9487a06e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=IGSDhfxGlGoHBLIO5F%2FmEKRI1OY%3D" alt="" loading="lazy"/></p>
<p>我们看一下它的 about 页，果不其然，是 2018 年创立的团队：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/659845676f364a0c9d8751a03042c4a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=Yey2Y8sHEyzjWj6SbxhU7Ahog1o%3D" alt="" loading="lazy"/></p>
<p>他们竟然是 Canva 的一个子团队，从照片上来看大概有 50 多人了，从初创的角度来说人也不算少了。</p>
<h2 data-id="heading-4">05 上手体验：首屏直接把工具塞给你</h2>
<p>分析完流量和收益，我们来分析分析产品，看看这个产品有哪些是值得我们学习的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/468905437afb44899b0498014cb0c1ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=sr8riACejFySq7PSNidlQ6eGoDQ%3D" alt="" loading="lazy"/></p>
<p>先看它的首屏，直接把工具放在首屏，也就是说，用户不用滚动，就可以直接体验工具，这也是我们提倡的。</p>
<p>对于工具类站点来说，首页不用什么 Banner 和 CTA，把工具放在首屏，让用户第一时间体验是最优的做法。</p>
<p>从审美的角度，我觉得这个首屏并不算非常美观，胜在简洁。</p>
<p>其实这也说明了，工具站不一定要有很惊艳的视觉效果，重在功能满足用户需求，这是首要的。</p>
<p>在未登录的时候就支持用户上传图片，并没有阻断用户体验，在上传图片之后，跳转到了一个编辑页：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be90bf977c17462e931c5b81b68e62f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=BQiVKHfa3iWtry%2BMo76aKlcck7o%3D" alt="" loading="lazy"/></p>
<p>这也是工具站点非常值得学习的方式，相当于首页是一个钩子，具体复杂的功能在内页实现。</p>
<p>这里的编辑器做的还是不错的，提供了基本的图片编辑功能，还能一键换背景。</p>
<p>如果你仔细体验，它还有各种涂刷之类的功能，可以说是非常专业的，并不是随随便便做的。</p>
<p>到这里为止，其实背景已经去除了，目前还不需要登录以及付费。</p>
<p>这也是跟它标榜的免费使用所符合。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af71e7620dd9450c8e0ce29ba45078be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=iiMaCmULkrQAcxITZVV7NcFePUU%3D" alt="" loading="lazy"/></p>
<p>在下载的时候，也给了一个免费选项，而且下载是完全没有水印的，相当于免费就可以完成整个闭环。</p>
<p>我试了一下，再上传一张图片，这条路径还可以继续走，没有限制。</p>
<p>不过这也只能是大厂玩法了，对于我们个人来说，如果这么干，成本肯定扛不住。</p>
<h2 data-id="heading-5">06 付费触发 &amp; 定价设计</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97f3834bac654d6aa06191cf6e3c6177~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=YM5KmMT9B%2Bw092JuY1cv38AkDH4%3D" alt="" loading="lazy"/></p>
<p>如果点击需要付费的功能，会引导进入 Pricing 页面，这个 Pricing 页面也是非常值得学习的设计。</p>
<p>首先，是月付和年付的设计，默认引导年付，但是年付显示的是按月的价格，也就是帮用户计算出如果年付会每个月省 50%的钱，从而拉高用户的 LTV，这也是一个常用的手段。</p>
<p>然后就是它的价格梯度设计，也是非常值得学习的。第一个梯度是，登录送一个积分。</p>
<p>也就是说，只要你注册了，就能拿到 1 个积分。我们做产品的时候，注册率也是重要的一个指标，可以采用这个方式提升用户的注册率。</p>
<p>然后就是按量付费的设计，阶梯定价：</p>
<ul>
<li>
<p>3 积分 $3</p>
</li>
<li>
<p>10 积分 $9</p>
</li>
<li>
<p>75 积分 $49</p>
</li>
<li>
<p>200 积分 $99</p>
</li>
<li>
<p>500 积分 $199</p>
</li>
<li>
<p>1200 积分 $399</p>
</li>
<li>
<p>4000 积分 $999</p>
</li>
<li>
<p>8000 积分 $1699</p>
</li>
</ul>
<p>这个阶梯设计我们可以参考学习，顺便说一下，工具站一定不要只有订阅，要支持按量计费的，能够有效提高付费转化率。</p>
<p>然后就是订阅阶梯：</p>
<p>Lite 版本，$54/年，支持基本的编辑和 API 操作。40 积分/月。</p>
<p>Pro 版本，$234/年，比 Lite 版本多了一个批量的功能，200 积分/月。</p>
<p>Volume+版本，$534/年，可以认为这是企业版本，支持定制各种图片规格等等，500 积分/月。</p>
<p>一般我们的产品，支持 2-3 个阶梯就可以了，如果没能力支持企业版，我认为做两个版本就够用。</p>
<p>一定要想好用户权益，什么权益是高净值用户需要的，定价如何，从用户需求的角度和成本综合考虑。</p>
<h2 data-id="heading-6">07 FAQ 把规则讲透</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/355b0870f44343e8b2530e0ad0f3a733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=gmKYl4%2Fhm%2BlTJEF1rXHZGGOXiYc%3D" alt="" loading="lazy"/></p>
<p>然后我们来学习一下它的 Faq，工具站点的 Faq 非常重要，尤其是付费页面，你要说清楚很多用户关心的问题。</p>
<p>比如，一个积分是什么概念，在 remove.bg 的定义里，1 个积分可以处理一张图片，这就定义清楚了积分的价值。</p>
<p>另外，它还附加说明了，订阅送的积分，只在订阅期间有效，而一次购买的积分，永久有效。</p>
<p>这些都是我们需要说明的规则。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee9de9d991de4f18bca410a5c4be5659~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=uYt8iuYyfFRLqGjPBktr2woip%2FQ%3D" alt="" loading="lazy"/></p>
<p>它还解释了什么场景适合单买积分，什么场景适合订阅，降低用户心智，实际上这针对的是不同的用户群体。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2812cd360284399ac87cfb822db5669~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=TSu0PuW1UGZpY91kMxrzof2TSYk%3D" alt="" loading="lazy"/></p>
<p>然后，一定要声明你的产品是支持取消订阅的，这也是最基础的合规要求。否则用户可以去仲裁，会导致你大量的损失。以及取消订阅之后，积分怎么处理，一定要说明白。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a387b894959749c290e549dc0f47ec0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=0x073nAPA0m2UFRxqOkXVuw3tVc%3D" alt="" loading="lazy"/></p>
<p>最后就是隐私问题，海外用户还是比较注重隐私的，很多审核合规渠道都要求你的产品符合 GDPR（通用数据保护条例），你要做面向欧盟的产品，是必须要注意这一点的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11c595b59f33483181deba2d94ea1b3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=28lOOdJLW3Yd%2BXLbH9V%2BwN3suJI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">08 信息架构：导航做减法</h2>
<p>然后我们看它的导航栏设计，也是值得学习的，它的内页其实很多，但并不是每一个内页都要硬塞到导航栏里，它的导航非常简单：</p>
<ul>
<li>
<p>upload 是主功能</p>
</li>
<li>
<p>bulk 是附加功能，也是刚刚我们看到 pro 用户的最大的价值</p>
</li>
<li>
<p>api 是开放文档</p>
</li>
<li>
<p>plugins 是支持的插件</p>
</li>
<li>
<p>Pricing 是定价页</p>
</li>
</ul>
<p>我觉得做产品，一定要学会做减法，导航太臃肿，给用户的心智负担就很重，你不是 tob 的产品，而是这种 toc 的垂类产品，那就必须要学会做减法。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/827fb51803a740ca953b35aea6b155eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=9eNpdcKRXOEDa%2FaqXFtZa5Y5qbE%3D" alt="" loading="lazy"/></p>
<p>这个 bulk 页面，我觉得非常值得学习的点就是，它通过首屏的动图，让你立即能理解这个功能带来的附加价值，我觉得这个页面的 CTR 会非常不错，非常清晰易懂。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/932d2aa2ec9144cdaf5322ca1c9191c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=BiiEz3%2FRu%2BSjInShixoRCUWlQXk%3D" alt="" loading="lazy"/></p>
<p>plugin 页面就是在展示大厂实力了，这也是护城河。尽管是一个去除背景的小需求，它能做各种插件、APP，与这么多效率工具打通，如果我们以个人力量去和他竞争，那无异于以卵击石。</p>
<h2 data-id="heading-8">09 场景、功能、案例三套内页矩阵</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66c5eff2b1af43acbaebd2927537a223~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=maPLEOtSPfZdJhaQXCJcjQSyQWA%3D" alt="" loading="lazy"/></p>
<p>这是它做的一个 features 集合页，也就是说，产品的所有特性，它都做成了内页，而且每个内页都基本有个动图，这无论是从 SEO 的角度还是用户体验的角度来说都特别好，我觉得很值得我们学习。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7afb2b9f85e84fa7926a50bf8d04d082~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=Yawag9GX7aEYQstxyALIkna1eHQ%3D" alt="" loading="lazy"/></p>
<p>然后就是它为每一种用户场景都做了内页，你是设计师、工程师、Photoshop 人员等等，都做了内页。这是真正从用户的角度去做需求，深刻调研自己的用户、客户，做好分类，做精致的产品，这点我是需要反思和学习的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab43fa97bba14eaa97c48326bd044edc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=YCCIRPnTWADP7h1XJq160gI3FE8%3D" alt="" loading="lazy"/></p>
<p>这是它的用户案例，每个用户的精彩故事都记录下来，对于一个产品来说，这是最有力的证言。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9350eb2233a4f1caddcf84bc00a2840~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=y8yq8uLF47hu0vun0e5BFE%2BR6NE%3D" alt="" loading="lazy"/></p>
<p>然后是它的 blog 页面，作为工具站点，必须要写 blog，通过 blog 我们就看出 canva 这个团队的 SEO 功底了，基本上承接了所有 how-to、best xxx 等长尾需求流量，这也是我们必须要掌握的 SEO 技巧。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46c82f85ba5547ae8a399f32e31569f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=goy%2FDJhfytx90YTbOKaKkm0SD1o%3D" alt="" loading="lazy"/></p>
<p>而且随便点击去一篇博客，发现它是真正在用心写，从用户的角度去写，并不是为了 SEO 而 SEO。</p>
<h2 data-id="heading-9">10 增长工具：Newsletter + ProductHunt 小组件</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/231d85222d634769bed197eaae1ace58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=7gCoksCQY%2F%2BE06Aqpr0o0Hnujoc%3D" alt="" loading="lazy"/></p>
<p>它的博客下方有 newsletter 的订阅，和 ProductHunt 的小组件，这个我觉得也是值得学习的点。我们真正做一个长期的产品，一定要做 EDM，一定要抓住任何可以提留存的机会。</p>
<h2 data-id="heading-10">11 Affiliate 体系：规则透明才好招募</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afeea065aba842909257472839cdad52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=Q3tVqxxIn0Gqajl9PkTfvZH9epQ%3D" alt="" loading="lazy"/></p>
<p>这是它的 Affliate 页面设计，这次我的产品也是被迫采用了 Affliate 的，最后发现 Affliate 真香。</p>
<p>你可以看到这里明确写了 Affliate 是 15%的收益，并且有很多 Affliate 相关的 faq，都非常专业，值得学习。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc40708b03a245e89cc345d67a6e51e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=wIsSypmtkWXmhM%2BXnTP447J%2FXm8%3D" alt="" loading="lazy"/></p>
<p>比如，remove.bg 是可以将用户订阅续费的收益，算作 Affliate 的，这点要清晰说明。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b8317e7858341c4b2bfa5c83c2b3081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=l%2BHaTEsEbWqoKsdgFkuDa8gaf3o%3D" alt="" loading="lazy"/></p>
<p>还有，哪些推广行为是不被允许的，这点要提前说明，一般我们不希望对方投流来影响我们自己的 seo 等等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a5fa57909274e13be91b3dc7cc4a9e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=fd4TK%2FvSr5zGhK2GvMv3Mz1DA0M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1836814955fa495fb243c57bc8f80d8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=mQF%2BKA%2BGzWXksgaGCYOgrXI2tdU%3D" alt="" loading="lazy"/></p>
<p>收益结算周期、如果付费、cookie 追踪有效期什么的，都要清晰。</p>
<p>以上这些，都是我上个产品 Affliate 踩的坑，跟对方来回 20 多个邮件才把这个东西聊明白。</p>
<p>remove.bg 就非常值得学习，直接做个 Affliate 页面，所有的规则都清楚了，可以吸引更多客户来对你的产品进行分销。</p>
<h2 data-id="heading-11">12 多语言 &amp; 渠道矩阵</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c366de8f06f94aea82de3765d9b8cf65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=9uKEZFBwBMFZDPjTVBqFyCHDs3o%3D" alt="" loading="lazy"/></p>
<p>另外就是它支持了基本上主流国家的语言，做海外站点，如果我们要面向全球 70 亿人口市场，多语言必不可少，可能带来几十倍的流量。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16cbc622950b4b6db8c0446f7f5f53db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=6wyFb4ZB2aoPkxf%2F7ovEI8AB1Jo%3D" alt="" loading="lazy"/></p>
<p>最后我们学习一下它的营销渠道，包括 Facebook、Instagram、Twitter、TikTok、Youtube、LinkedIn。</p>
<p>我就不一个个截图了，这基本上可以当做范例，我们做海外产品重点需要去做的品牌渠道。</p>
<h2 data-id="heading-12">13 竞争格局：大盘够大，仍有切口</h2>
<p>最后我们可以通过 SImilarWeb 去看看它的竞争者：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/105e3c8bc261410e91c6d74efd514310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=TvDSpZt28MPaIGIvP1VXsLqyDIs%3D" alt="" loading="lazy"/></p>
<p>比如 pixelcut，这个站点有两千万的访问量，我们看它的搜索词：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d125e3247c394f4aa9c6e6de3d109aeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=qUo7cSmvRy6XdTnqTnncg3wsNWA%3D" alt="" loading="lazy"/></p>
<p>是不是也是 background remover？还有 photoroom，也有两千万的访问量：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f77b70a6a387470ab95983670567eb7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825467&amp;x-signature=yNtfqg64kNZJ8cu6jSlwcHXDHik%3D" alt="" loading="lazy"/></p>
<p>这说明什么？就算 remove.bg 已经非常厉害了，但这个市场盘子足够大，依然有其他的竞争者可以分到流量。</p>
<p>不可能有一个产品把所有的流量都吃光，能够在大盘子内占小比例，也是很大的流量了，这就是我们的出海机会。</p>
<p>这两个站产品做的咋样，他们的流量和用户又是什么分布，这里面的市场空间还有没有我们的商机？这些就留给大家的作业去分析了。</p>
<h2 data-id="heading-13">14 给出海团队的 8 个可落地要点</h2>
<ol>
<li>
<p>域名选需求词，品牌=需求。</p>
</li>
<li>
<p>TDH 写清价值主张，标题加 Free 钩子。</p>
</li>
<li>
<p>OG 图用 before/after，社媒即转化页。</p>
</li>
<li>
<p>首屏即工具，降低首次互动摩擦。</p>
</li>
<li>
<p>免费闭环先跑通，再做付费触发。</p>
</li>
<li>
<p>订阅 + 按量并行，价格梯度少而清晰。</p>
</li>
<li>
<p>FAQ 讲透规则，减少客服/拒付风险。</p>
</li>
<li>
<p>场景、功能、案例、博客做成内页矩阵，既 SEO 又教育用户。</p>
</li>
</ol>
<p>出海没那么神秘，好的产品套路都写在这些细节里。多拆解、多复盘，抓住大盘里的小切口，就有机会找到属于自己的红利。</p>
<p>好了，今天的分享就到这里，我们下期再见！</p>
<hr/>
<p>🚀 想要与更多AI爱好者交流，共同成长吗？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ4k_5_waWJbRRo5lZBZmog" target="_blank" title="https://mp.weixin.qq.com/s/Z4k_5_waWJbRRo5lZBZmog" ref="nofollow noopener noreferrer">和一群志同道合的人，持续精进 AI 的每一天</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue2、vue3父子组件嵌套生命周期执行顺序]]></title>    <link>https://juejin.cn/post/7577201863725514752</link>    <guid>https://juejin.cn/post/7577201863725514752</guid>    <pubDate>2025-11-27T04:39:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577201863725514752" data-draft-id="7576914798057046068" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue2、vue3父子组件嵌套生命周期执行顺序"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-27T04:39:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="什么时候吃饭"/> <meta itemprop="url" content="https://juejin.cn/user/4235734789917406"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue2、vue3父子组件嵌套生命周期执行顺序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4235734789917406/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    什么时候吃饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T04:39:36.000Z" title="Thu Nov 27 2025 04:39:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vue2版本</h2>
<blockquote>
<p>生命周期：</p>
<p>beforeCreate created beforeMount mounted beforeUpdate updated beforeDestroy destroyed activated deactivated</p>
</blockquote>
<h3 data-id="heading-1">1. 组件挂载阶段（Mounting）</h3>
<h4 data-id="heading-2">执行顺序：</h4>
<pre><code class="hljs language-arduino" lang="arduino">​
<span class="hljs-comment">// 创建和挂载过程</span>
​
父组件 beforeCreate
​
父组件 created
​
父组件 beforeMount
​
  子组件 beforeCreate
​
  子组件 created
​
  子组件 beforeMount
​
  子组件 mounted
​
父组件 mounted
</code></pre>
<h4 data-id="heading-3">代码示例：</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Parent.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Child.vue'</span>
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Parent'</span>,
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ChildComponent</span> },
  <span class="hljs-title function_">beforeCreate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 父组件 beforeCreate'</span>)
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 父组件 created'</span>)
  },
  <span class="hljs-title function_">beforeMount</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. 父组件 beforeMount'</span>)
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'6. 父组件 mounted'</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
<span class="hljs-comment">&lt;!-- Child.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Child'</span>,
  <span class="hljs-title function_">beforeCreate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 子组件 beforeCreate'</span>)
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4.1 子组件 created'</span>)
  },
  <span class="hljs-title function_">beforeMount</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4.2 子组件 beforeMount'</span>)
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5. 子组件 mounted'</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
</code></pre>
<h3 data-id="heading-4">2. 组件更新阶段（Updating）</h3>
<h4 data-id="heading-5">总结：</h4>
<blockquote>
<p>vue2中，只要子组件使用了，父组件传入的值，当该值更新时，子组件的更新生命周期就会执行，其他情况，子组件的更新生命周期都不会执行</p>
</blockquote>
<h4 data-id="heading-6">更新父组件--子组件使用了，父组件传入的参数</h4>
<h5 data-id="heading-7">执行顺序：</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 更新过程（数据变化时）</span>
​
父组件 beforeUpdate
​
  子组件 beforeUpdate
​
  子组件 updated
​
父组件 updated
</code></pre>
<h5 data-id="heading-8">代码示例：</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Parent.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件 - {{ parentData }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeData"</span>&gt;</span>改变数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">:childData</span>=<span class="hljs-string">"parentData"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Child.vue'</span>
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ChildComponent</span> },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">parentData</span>: <span class="hljs-string">'初始值'</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">changeData</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentData</span> = <span class="hljs-string">'新值'</span>
    }
  },
  <span class="hljs-title function_">beforeUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 父组件 beforeUpdate'</span>)
  },
  <span class="hljs-title function_">updated</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 父组件 updated'</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
<span class="hljs-comment">&lt;!-- Child.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件 - {{ childData }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'childData'</span>],
  <span class="hljs-title function_">beforeUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 子组件 beforeUpdate'</span>)
  },
  <span class="hljs-title function_">updated</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. 子组件 updated'</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">更新父组件--子组件没有使用，父组件传入的参数（即使有传入值给子组件）</h4>
<h5 data-id="heading-10">执行顺序：</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 更新过程（数据变化时）</span>
​
父组件 beforeUpdate
​
父组件 updated
</code></pre>
<h5 data-id="heading-11">代码示例：</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Parent.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件 - {{ parentData }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeData"</span>&gt;</span>改变数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">:childData</span>=<span class="hljs-string">"parentData"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;ChildComponent :childData="parentData" /&gt; --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/two/Child.vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ChildComponent</span> },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">parentData</span>: <span class="hljs-string">'初始值'</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">changeData</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentData</span> = <span class="hljs-string">'新值'</span>
    }
  },
  <span class="hljs-title function_">beforeUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 父组件 beforeUpdate'</span>)
  },
  <span class="hljs-title function_">updated</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 父组件 updated'</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
​
​
<span class="hljs-comment">&lt;!-- Child.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;h3&gt;子组件 - {{ childData }}&lt;/h3&gt; --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'childData'</span>],
  <span class="hljs-title function_">beforeUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 子组件 beforeUpdate'</span>)
  },
  <span class="hljs-title function_">updated</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. 子组件 updated'</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
​
</code></pre>
<h4 data-id="heading-12">更新子组件</h4>
<h5 data-id="heading-13">执行顺序：</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 更新过程（数据变化时）</span>
​
子组件 beforeUpdate
​
子组件 updated
</code></pre>
<h5 data-id="heading-14">代码示例：</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Parent.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件 - {{ parentData }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeData"</span>&gt;</span>改变数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/two/Child.vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ChildComponent</span> },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">parentData</span>: <span class="hljs-string">'初始值'</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">changeData</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentData</span> = <span class="hljs-string">'新值'</span>
    }
  },
  <span class="hljs-title function_">beforeUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 父组件 beforeUpdate'</span>)
  },
  <span class="hljs-title function_">updated</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 父组件 updated'</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
​
<span class="hljs-comment">&lt;!-- Child.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"border: 1px solid #ccc; padding: 10px; margin: 10px;"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Child Component - {{ childMessage }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeChildData"</span>&gt;</span>改变子组件数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数: {{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
​
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">childMessage</span>: <span class="hljs-string">'子组件初始数据'</span>,
      <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">changeChildData</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">childMessage</span> = <span class="hljs-string">'子组件数据已更新'</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'=== 子组件数据变化触发 ==='</span>)
    }
  },
  <span class="hljs-title function_">beforeUpdate</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Child beforeUpdate'</span>) },
  <span class="hljs-title function_">updated</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Child updated'</span>) },
​
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
​
​
</code></pre>
<h3 data-id="heading-15">3. 组件销毁阶段（Destroying）</h3>
<h4 data-id="heading-16">销毁父组件</h4>
<h5 data-id="heading-17">执行顺序：</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 销毁过程</span>
​
父组件 beforeDestroy
​
  子组件 beforeDestroy
​
  子组件 destroyed
​
父组件 destroyed
</code></pre>
<h5 data-id="heading-18">代码示例：</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Parent.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showChild"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showChild = false"</span>&gt;</span>销毁子组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/two/Child.vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ChildComponent</span> },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">showChild</span>: <span class="hljs-literal">true</span>
    }
  },
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父组件 beforeDestroy'</span>)
  },
  <span class="hljs-title function_">destroyed</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父组件 destroyed'</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
</code></pre>
<h4 data-id="heading-19">销毁子组件</h4>
<h5 data-id="heading-20">执行顺序：</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 销毁过程</span>
​
 子组件 beforeDestroy
​
 子组件 destroyed
​
</code></pre>
<h5 data-id="heading-21">代码示例：见销毁父组件的代码</h5>
<h2 data-id="heading-22">vue3版本</h2>
<blockquote>
<p>生命周期：</p>
<p>setup（）替代 beforeCreate setup（）替代 created onBeforeMount onMounted onBeforeUpdate onUpdated onBeforeUnmount onUnmounted onActivated onDeactivated onRenderTracked（新增） onRenderTriggered（新增）</p>
</blockquote>
<h3 data-id="heading-23">1. 组件挂载阶段（Mounting）</h3>
<h4 data-id="heading-24">执行顺序：</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 父组件 setup (相当于 beforeCreate + created)
<span class="hljs-bullet">2.</span> 父组件 onBeforeMount
<span class="hljs-bullet">    3.</span> 子组件 setup
<span class="hljs-code">    3.1 子组件 onBeforeMount
    4. 子组件 onMounted
5. 父组件 onMounted
</span></code></pre>
<h4 data-id="heading-25">代码示例：</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Parent.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onBeforeMount, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../Son/s1.vue'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 父组件 setup (相当于 beforeCreate + created)'</span>)
<span class="hljs-title function_">onBeforeMount</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 父组件 onBeforeMount'</span>)
})
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5. 父组件 onMounted'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
​
<span class="hljs-comment">&lt;!-- Child.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onBeforeMount, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. 子组件 setup'</span>)
<span class="hljs-title function_">onBeforeMount</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3.1 子组件 onBeforeMount'</span>)
})
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 子组件 onMounted'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
</code></pre>
<h3 data-id="heading-26">2. 组件更新阶段（Updating）</h3>
<h4 data-id="heading-27">总结：</h4>
<blockquote>
<p>vue3中，只要父组件往子组件传入了值，当该值更新时，子组件的更新生命周期就会执行，其他情况，子组件的更新生命周期都不会执行</p>
</blockquote>
<h4 data-id="heading-28">更新父组件--子组件使用了，父组件传入的参数</h4>
<h5 data-id="heading-29">执行顺序：</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 更新过程（数据变化时）</span>
​
父组件 beforeUpdate
​
  子组件 beforeUpdate
​
  子组件 updated
​
父组件 updated
</code></pre>
<h5 data-id="heading-30">代码示例：</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Parent.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件 - {{ parentData }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeData"</span>&gt;</span>改变数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">:childData</span>=<span class="hljs-string">"parentData"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onBeforeUpdate, onUpdated } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../Son/s1.vue'</span>
<span class="hljs-keyword">const</span> parentData = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'初始值'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeData</span> = (<span class="hljs-params"/>) =&gt; {
  parentData.<span class="hljs-property">value</span> = <span class="hljs-string">'新值'</span>
}
<span class="hljs-title function_">onBeforeUpdate</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 父组件 onBeforeUpdate'</span>)
})
<span class="hljs-title function_">onUpdated</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 父组件 onUpdated'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
​
<span class="hljs-comment">&lt;!-- Child.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件 - {{ props.childData }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onBeforeUpdate, onUpdated, defineProps } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
​
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>([<span class="hljs-string">'childData'</span>])
​
<span class="hljs-title function_">onBeforeUpdate</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 子组件 onBeforeUpdate'</span>)
})
​
<span class="hljs-title function_">onUpdated</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. 子组件 onUpdated'</span>)
})
​
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
</code></pre>
<h4 data-id="heading-31">更新父组件--父组件传值给子组件，即使子组件没有使用 和 定义对应的属性</h4>
<blockquote>
<p>如果父组件没有传值给子组件，即使子组件定义 和 使用了值，当父组件更新时，子组件也不会更新，即：生命周期是：</p>
<p><code>父组件 beforeUpdate</code> -&gt; <code>父组件 updated</code></p>
</blockquote>
<h5 data-id="heading-32">执行顺序：</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 更新过程（数据变化时）</span>
​
父组件 beforeUpdate
​
  子组件 beforeUpdate
​
  子组件 updated
​
父组件 updated
</code></pre>
<h5 data-id="heading-33">代码示例：</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Parent.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件 - {{ parentData }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeData"</span>&gt;</span>改变数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">:childData</span>=<span class="hljs-string">"parentData"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;ChildComponent  /&gt; --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onBeforeUpdate, onUpdated } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../Son/s1.vue'</span>
<span class="hljs-keyword">const</span> parentData = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'初始值'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeData</span> = (<span class="hljs-params"/>) =&gt; {
  parentData.<span class="hljs-property">value</span> = <span class="hljs-string">'新值'</span>
}
<span class="hljs-title function_">onBeforeUpdate</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 父组件 onBeforeUpdate'</span>)
})
<span class="hljs-title function_">onUpdated</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 父组件 onUpdated'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
​
<span class="hljs-comment">&lt;!-- Child.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;h3&gt;子组件 - {{ props.childData }}&lt;/h3&gt; --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onBeforeUpdate, onUpdated, defineProps } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
​
<span class="hljs-comment">// const props = defineProps(['childData'])</span>
​
<span class="hljs-title function_">onBeforeUpdate</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 子组件 onBeforeUpdate'</span>)
})
​
<span class="hljs-title function_">onUpdated</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. 子组件 onUpdated'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
</code></pre>
<h4 data-id="heading-34">更新子组件</h4>
<h5 data-id="heading-35">执行顺序：</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 更新过程（数据变化时）</span>
​
子组件 beforeUpdate
​
子组件 updated
</code></pre>
<h5 data-id="heading-36">代码示例：</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Parent.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;h2&gt;父组件 - {{ parentData }}&lt;/h2&gt; --&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;button @click="changeData"&gt;改变数据&lt;/button&gt; --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">:childData</span>=<span class="hljs-string">"parentData"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;ChildComponent  /&gt; --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onBeforeUpdate, onUpdated } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../Son/s1.vue'</span>
<span class="hljs-keyword">const</span> parentData = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'初始值'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeData</span> = (<span class="hljs-params"/>) =&gt; {
  parentData.<span class="hljs-property">value</span> = <span class="hljs-string">'新值'</span>
}
<span class="hljs-title function_">onBeforeUpdate</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 父组件 onBeforeUpdate'</span>)
})
<span class="hljs-title function_">onUpdated</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 父组件 onUpdated'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
​
<span class="hljs-comment">&lt;!-- Child.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;h3&gt;子组件&lt;/h3&gt; --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>子组件 - {{ sonData }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeData"</span>&gt;</span>改变数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onBeforeUpdate, onUpdated,ref, defineProps } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
​
<span class="hljs-comment">// const props = defineProps(['childData'])</span>
​
<span class="hljs-keyword">const</span> sonData = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'初始值'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeData</span> = (<span class="hljs-params"/>) =&gt; {
  sonData.<span class="hljs-property">value</span> = <span class="hljs-string">'新值'</span>
}
​
<span class="hljs-title function_">onBeforeUpdate</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 子组件 onBeforeUpdate'</span>)
})
​
<span class="hljs-title function_">onUpdated</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. 子组件 onUpdated'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
</code></pre>
<h3 data-id="heading-37">3. 组件销毁阶段（Destroying）</h3>
<h4 data-id="heading-38">销毁父组件</h4>
<h5 data-id="heading-39">执行顺序：</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 销毁过程</span>
​
父组件 beforeDestroy
​
  子组件 beforeDestroy
​
  子组件 destroyed
​
父组件 destroyed
</code></pre>
<h5 data-id="heading-40">代码示例：</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Parent.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showChild"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showChild = false"</span>&gt;</span>卸载子组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onBeforeUnmount, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../Son/s1.vue'</span>
<span class="hljs-keyword">const</span> showChild = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)
<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父组件 onBeforeUnmount'</span>)
})
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父组件 onUnmounted'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
​
​
<span class="hljs-comment">&lt;!-- Child.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;h3&gt;子组件&lt;/h3&gt; --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>子组件<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onBeforeUnmount, onUnmounted,ref, defineProps } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
​
<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子组件 onBeforeUnmount'</span>)
})
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子父组件 onUnmounted'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
​
</code></pre>
<h4 data-id="heading-41">销毁子组件</h4>
<h5 data-id="heading-42">执行顺序：</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 销毁过程</span>
​
 子组件 beforeDestroy
​
 子组件 destroyed
​
</code></pre>
<h5 data-id="heading-43">代码示例：见销毁父组件的代码</h5></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS 位置服务全攻略：精准定位、地理编码与后台持续定位实现]]></title>    <link>https://juejin.cn/post/7576942980708712448</link>    <guid>https://juejin.cn/post/7576942980708712448</guid>    <pubDate>2025-11-27T05:21:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576942980708712448" data-draft-id="7576928310788702260" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS 位置服务全攻略：精准定位、地理编码与后台持续定位实现"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-27T05:21:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT充电站"/> <meta itemprop="url" content="https://juejin.cn/user/125809758576431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS 位置服务全攻略：精准定位、地理编码与后台持续定位实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/125809758576431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT充电站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T05:21:39.000Z" title="Thu Nov 27 2025 05:21:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>✨家人们记得点个账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>在 HarmonyOS 应用开发中，位置服务是许多场景的核心能力 —— 无论是本地生活服务的附近推荐、导航应用的实时轨迹追踪，还是出行类 App 的后台定位，都离不开稳定、精准的位置获取能力。本文将从权限配置、位置获取、地理编码转换、持续定位到后台长时定位，一步步拆解 HarmonyOS 位置服务的完整实现流程，附带可直接复用的代码示例，助力开发者快速落地功能。</p>
<h2 data-id="heading-0">获取设备的位置信息</h2>
<blockquote>
<p>1-配置申请位置权限 同时申请ohos.permission.APPROXIMATELY_LOCATION和ohos.permission.LOCATION 获取到精准位置，精准度在米级别。</p>
<p>2-检查全局位置开关是否打开 geoLocationManager.isLocationEnabled();</p>
<ul>
<li>2.1 没开 atManager.requestGlobalSwitch(getContext(this), abilityAccessCtrl.SwitchType.LOCATION) 拉起全局设置位置开关页</li>
<li>2.2 开了 继续</li>
</ul>
<p>3-获取当前位置 geoLocationManager.getCurrentLocation(request) 可以获取用户经度纬度</p>
<p>4-可以继续通过geoLocationManager.getAddressesFromLocation()地理编码转化为可读性较强地址</p>
</blockquote>
<ul>
<li>获取设备的位置信息，需要有位置权限，位置权限申请</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 位置信息（权限组）</span>
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.APPROXIMATELY_LOCATION"</span>,
  <span class="hljs-string">"reason"</span>: <span class="hljs-string">'<span class="hljs-subst">$string</span>:permission_reason_location'</span>,
  <span class="hljs-string">"usedScene"</span>: {}
},
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.LOCATION"</span>,
  <span class="hljs-string">"reason"</span>: <span class="hljs-string">'<span class="hljs-subst">$string</span>:permission_reason_location'</span>,
  <span class="hljs-string">"usedScene"</span>: {}
},
</code></pre>
<p>按照步骤申请权限 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V13%2Flocation-guidelines-V13" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V13/location-guidelines-V13" target="_blank" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { geoLocationManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocationKit'</span>;
<span class="hljs-keyword">import</span> { abilityAccessCtrl, <span class="hljs-title class_">Context</span>, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;
<span class="hljs-keyword">import</span> { permissionUtil } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/PermissionUtil'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Button</span>(<span class="hljs-string">'获取位置信息'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-comment">// 1 配置文件 申请权限   同时申请ohos.permission.APPROXIMATELY_LOCATION和ohos.permission.LOCATION 获取到精准位置，精准度在米级别。</span>
      <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> permissionUtil.<span class="hljs-title function_">checkPermissions</span>([<span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span>, <span class="hljs-string">'ohos.permission.LOCATION'</span>], <span class="hljs-title function_">getContext</span>());
      <span class="hljs-keyword">if</span> (!state) <span class="hljs-keyword">return</span>

      <span class="hljs-comment">// 2 检查全局开关  开了-继续走，没开-弹出让他授权</span>
      <span class="hljs-keyword">const</span> locationEnabled = geoLocationManager.<span class="hljs-title function_">isLocationEnabled</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'查看当前全局开关状态：'</span>, locationEnabled)

      <span class="hljs-keyword">if</span> (!locationEnabled) {  <span class="hljs-comment">// 没开</span>
        <span class="hljs-keyword">const</span> <span class="hljs-attr">atManager</span>: abilityAccessCtrl.<span class="hljs-property">AtManager</span> = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();
        <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestGlobalSwitch</span>(<span class="hljs-title function_">getContext</span>(), abilityAccessCtrl.<span class="hljs-property">SwitchType</span>.<span class="hljs-property">LOCATION</span>)
        <span class="hljs-keyword">if</span> (!state) <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 拉起全局弹出 用户没授权就终止代码执行</span>
      }

      <span class="hljs-comment">// 3. 获取位置信息  经度纬度</span>
      geoLocationManager.<span class="hljs-title function_">getCurrentLocation</span>( {
        <span class="hljs-attr">locatingPriority</span>: geoLocationManager.<span class="hljs-property">LocatingPriority</span>.<span class="hljs-property">PRIORITY_LOCATING_SPEED</span>,
        <span class="hljs-attr">locatingTimeoutMs</span>: <span class="hljs-number">10000</span>
      }).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> { <span class="hljs-comment">// 调用getCurrentLocation获取当前设备位置，通过promise接收上报的位置</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'current location: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result));
      })
        .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error:BusinessError</span>) =&gt;</span> { <span class="hljs-comment">// 接收上报的错误码</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'promise, getCurrentLocation: error='</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));
        });
      <span class="hljs-comment">// .....</span>
    })
  }
}
</code></pre>
<h2 data-id="heading-1">地理编码转化与逆地理编码转化</h2>
<p>使用坐标描述一个位置，非常准确，但是并不直观，面向用户表达并不友好。系统向开发者提供了以下两种转化能力。</p>
<ul>
<li>地理编码转化：将地理描述转化为具体坐标。</li>
<li>逆地理编码转化能力：将坐标转化为地理描述。</li>
</ul>
<p>其中地理编码包含多个属性来描述位置，包括国家、行政区划、街道、门牌号、地址描述等等，这样的信息更便于用户理解。</p>
<p>开发步骤</p>
<ol>
<li>导入geoLocationManager模块，所有与地理编码转化&amp;逆地理编码转化能力相关的功能API，都是通过该模块提供的。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { geoLocationManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocationKit'</span>;
</code></pre>
<p>2.获取转化结果。</p>
<p>调用getAddressesFromLocation，把坐标转化为地理位置信息。应用可以获得与此坐标匹配的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V13%2Fjs-apis-geolocationmanager-V13%23geoaddress" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V13/js-apis-geolocationmanager-V13#geoaddress" target="_blank" ref="nofollow noopener noreferrer">GeoAddress</a>（地理编码地址信息）列表，应用可以根据实际使用需求，读取相应的参数数据。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> <span class="hljs-attr">reverseGeocodeRequest</span>:geoLocationManager.<span class="hljs-property">ReverseGeoCodeRequest</span> = {
  <span class="hljs-attr">locale</span>: <span class="hljs-string">'zh'</span>,
  <span class="hljs-string">"latitude"</span>: <span class="hljs-number">31.12</span>, <span class="hljs-string">"longitude"</span>: <span class="hljs-number">121.11</span>, <span class="hljs-string">"maxItems"</span>: <span class="hljs-number">1</span>
};
<span class="hljs-keyword">try</span> {
    geoLocationManager.<span class="hljs-title function_">getAddressesFromLocation</span>(reverseGeocodeRequest, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'getAddressesFromLocation err: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'getAddressesFromLocation data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
        }
    });
} <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"errCode:"</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
}
</code></pre>
<p>3.示例代码</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { geoLocationManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocationKit'</span>;
<span class="hljs-keyword">import</span> { abilityAccessCtrl, <span class="hljs-title class_">Context</span>, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;
<span class="hljs-keyword">import</span> { permissionUtil } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/PermissionUtil'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Button</span>(<span class="hljs-string">'获取位置信息'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-comment">// 1 配置文件 申请权限   同时申请ohos.permission.APPROXIMATELY_LOCATION和ohos.permission.LOCATION 获取到精准位置，精准度在米级别。</span>
      <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> permissionUtil.<span class="hljs-title function_">checkPermissions</span>([<span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span>, <span class="hljs-string">'ohos.permission.LOCATION'</span>], <span class="hljs-title function_">getContext</span>());
      <span class="hljs-keyword">if</span> (!state) <span class="hljs-keyword">return</span>

      <span class="hljs-comment">// 2 检查全局开关  开了-继续走，没开-弹出让他授权</span>
      <span class="hljs-keyword">const</span> locationEnabled = geoLocationManager.<span class="hljs-title function_">isLocationEnabled</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'查看当前全局开关状态：'</span>, locationEnabled)

      <span class="hljs-keyword">if</span> (!locationEnabled) {  <span class="hljs-comment">// 没开</span>
        <span class="hljs-keyword">const</span> <span class="hljs-attr">atManager</span>: abilityAccessCtrl.<span class="hljs-property">AtManager</span> = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();
        <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestGlobalSwitch</span>(<span class="hljs-title function_">getContext</span>(), abilityAccessCtrl.<span class="hljs-property">SwitchType</span>.<span class="hljs-property">LOCATION</span>)
        <span class="hljs-keyword">if</span> (!state) <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 拉起全局弹出 用户没授权就终止代码执行</span>
      }

      <span class="hljs-comment">// 3. 获取位置信息  经度纬度</span>
      geoLocationManager.<span class="hljs-title function_">getCurrentLocation</span>( {
        <span class="hljs-attr">locatingPriority</span>: geoLocationManager.<span class="hljs-property">LocatingPriority</span>.<span class="hljs-property">PRIORITY_LOCATING_SPEED</span>,
        <span class="hljs-attr">locatingTimeoutMs</span>: <span class="hljs-number">10000</span>
      }).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> { <span class="hljs-comment">// 调用getCurrentLocation获取当前设备位置，通过promise接收上报的位置</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'current location: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result))

        <span class="hljs-comment">// 正地理编码与逆地理编码</span>
        geoLocationManager.<span class="hljs-title function_">getAddressesFromLocation</span>({<span class="hljs-string">"latitude"</span>: result.<span class="hljs-property">latitude</span>, <span class="hljs-string">"longitude"</span>: result.<span class="hljs-property">longitude</span>, <span class="hljs-string">"maxItems"</span>: <span class="hljs-number">1</span>}, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'getAddressesFromLocation err: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'getAddressesFromLocation data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
          }
        });
        <span class="hljs-comment">// 正地理编码与逆地理编码 end</span>
      })
        .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error:BusinessError</span>) =&gt;</span> { <span class="hljs-comment">// 接收上报的错误码</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'promise, getCurrentLocation: error='</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));
        });
      <span class="hljs-comment">// .....</span>
    })
  }
}
</code></pre>
<h2 data-id="heading-2">持续定位</h2>
<p>持续定位。多用于导航、运动轨迹、出行等场景。</p>
<p>首先要实例化<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V13%2Fjs-apis-geolocationmanager-V13%23continuouslocationrequest12" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V13/js-apis-geolocationmanager-V13#continuouslocationrequest12" target="_blank" ref="nofollow noopener noreferrer">ContinuousLocationRequest</a>对象，用于告知系统该向应用提供何种类型的位置服务，以及位置结果上报的频率。</p>
<ul>
<li>设置locationScenario：</li>
</ul>
<p>建议locationScenario参数优先根据应用的使用场景进行设置，该参数枚举值定义参见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V13%2Fjs-apis-geolocationmanager-V13%23useractivityscenario12" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V13/js-apis-geolocationmanager-V13#useractivityscenario12" target="_blank" ref="nofollow noopener noreferrer">UserActivityScenario</a>，例如地图在导航时使用NAVIGATION参数，可以持续在室内和室外场景获取位置用于导航。</p>
<ul>
<li>设置interval：</li>
</ul>
<p>表示上报位置信息的时间间隔，单位是秒，默认值为1秒。如果对位置上报时间间隔无特殊要求，可以不填写该字段。</p>
<p>以地图导航场景为例，调用方式如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { geoLocationManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocationKit'</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">request</span>: geoLocationManager.<span class="hljs-property">ContinuousLocationRequest</span>= {
   <span class="hljs-string">'interval'</span>: <span class="hljs-number">1</span>,
   <span class="hljs-string">'locationScenario'</span>: geoLocationManager.<span class="hljs-property">UserActivityScenario</span>.<span class="hljs-property">NAVIGATION</span>
}
<span class="hljs-keyword">let</span> locationCallback = (<span class="hljs-attr">location</span>:geoLocationManager.<span class="hljs-property">Location</span>):<span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'locationCallback: data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(location));
};
<span class="hljs-keyword">try</span> {
   geoLocationManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'locationChange'</span>, request, locationCallback);
} <span class="hljs-keyword">catch</span> (err) {
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"errCode:"</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
}
</code></pre>
<p>如果不主动结束定位可能导致设备功耗高，耗电快；建议在不需要获取定位信息时及时结束定位。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">geoLocationManager.<span class="hljs-keyword">off</span>(<span class="hljs-comment">'locationChange', locationCallback);</span>
</code></pre>
<p>完整实例代码</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { geoLocationManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocationKit'</span>;
<span class="hljs-keyword">import</span> { abilityAccessCtrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { permissionUtil } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/PermissionUtil'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {

  <span class="hljs-title function_">locationCallback</span>(<span class="hljs-params">location:geoLocationManager.Location</span>)  {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'locationCallback: data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(location));
  }

  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"/>) {
    geoLocationManager.<span class="hljs-title function_">off</span>(<span class="hljs-string">'locationChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationCallback</span>);
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Button</span>(<span class="hljs-string">'获取位置信息'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-comment">// 1 配置文件 申请权限   同时申请ohos.permission.APPROXIMATELY_LOCATION和ohos.permission.LOCATION 获取到精准位置，精准度在米级别。</span>
      <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> permissionUtil.<span class="hljs-title function_">checkPermissions</span>([<span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span>, <span class="hljs-string">'ohos.permission.LOCATION'</span>], <span class="hljs-title function_">getContext</span>());
      <span class="hljs-keyword">if</span> (!state) <span class="hljs-keyword">return</span>

      <span class="hljs-comment">// 2 检查全局开关  开了-继续走，没开-弹出让他授权</span>
      <span class="hljs-keyword">const</span> locationEnabled = geoLocationManager.<span class="hljs-title function_">isLocationEnabled</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'查看当前全局开关状态：'</span>, locationEnabled)

      <span class="hljs-keyword">if</span> (!locationEnabled) {  <span class="hljs-comment">// 没开</span>
        <span class="hljs-keyword">const</span> <span class="hljs-attr">atManager</span>: abilityAccessCtrl.<span class="hljs-property">AtManager</span> = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();
        <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestGlobalSwitch</span>(<span class="hljs-title function_">getContext</span>(), abilityAccessCtrl.<span class="hljs-property">SwitchType</span>.<span class="hljs-property">LOCATION</span>)
        <span class="hljs-keyword">if</span> (!state) <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 拉起全局弹出 用户没授权就终止代码执行</span>
      }

      <span class="hljs-comment">// 3. 获取位置信息  经度纬度 【持续定位。多用于导航、运动轨迹、出行等场景。】</span>
      geoLocationManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'locationChange'</span>, {
        <span class="hljs-attr">interval</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">locationScenario</span>: geoLocationManager.<span class="hljs-property">UserActivityScenario</span>.<span class="hljs-property">NAVIGATION</span>
      }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationCallback</span>);

      <span class="hljs-comment">// .....</span>
    })
  }
}
</code></pre>
<h2 data-id="heading-3">后台定位-长时任务</h2>
<p><strong>应用退至后台后</strong>，在后台需要长时间运行用户可感知的任务，如播放音乐、导航等。为防止<strong>应用进程被挂起</strong>，导致对应功能异常，可以<strong>申请长时任务</strong>，使应用在后台长时间运行。在长时任务中可以申请多种类型的任务，并对任务类型进行更新。应用退后台执行业务时，系统会做一致性校验，确保应用在执行相应的长时任务。同时，系统有与长时任务相关联的通知栏消息，用户删除通知栏消息时，系统会自动停止长时任务。</p>
<p>1.需要申请ohos.permission.KEEP_BACKGROUND_RUNNING权限，配置方式请参见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V13%2Fdeclare-permissions-V13" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V13/declare-permissions-V13" target="_blank" ref="nofollow noopener noreferrer">声明权限</a>。</p>
<p>2.声明后台模式类型。</p>
<p>在module.json5配置文件中为需要使用长时任务的UIAbility声明相应的长时任务类型（配置文件中填写长时任务类型的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V13%2Fcontinuous-task-V13%23%25E4%25BD%25BF%25E7%2594%25A8%25E5%259C%25BA%25E6%2599%25AF" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V13/continuous-task-V13#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF" target="_blank" ref="nofollow noopener noreferrer">配置项</a>）。</p>
<pre><code class="hljs language-json" lang="json"> <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
     <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
         <span class="hljs-punctuation">{</span>
        			<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"EntryAbility"</span><span class="hljs-punctuation">,</span>
          		 <span class="hljs-comment">// ...</span>
              <span class="hljs-comment">// ...</span>
              <span class="hljs-comment">// </span>
              <span class="hljs-attr">"backgroundModes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              	<span class="hljs-comment">// 长时任务类型的配置项</span>
             		<span class="hljs-string">"audioRecording"</span>
               	或者
          			<span class="hljs-string">"location"</span>   ✅
             <span class="hljs-punctuation">]</span>
         <span class="hljs-punctuation">}</span>
     <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
     ...
 <span class="hljs-punctuation">}</span>
</code></pre>
<ol start="3">
<li>创建BackgroundTaskUtil.ets文件封装长短时任务</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { backgroundTaskManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BackgroundTasksKit'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;
<span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">WantAgent</span>, wantAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BackgroundTaskUtil</span> {

  <span class="hljs-comment">// 长任务-开启</span>
  <span class="hljs-title function_">startLongTask</span>(<span class="hljs-params">list:<span class="hljs-built_in">string</span>[], callback: () =&gt; <span class="hljs-built_in">void</span></span>) {  <span class="hljs-comment">// list任务类型， callback开启成功后走的回调</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">wantAgentInfo</span>: wantAgent.<span class="hljs-property">WantAgentInfo</span> = {
      <span class="hljs-comment">// 点击通知后，将要执行的动作列表</span>
      <span class="hljs-comment">// 添加需要被拉起应用的bundleName和abilityName</span>
      <span class="hljs-attr">wants</span>: [
        {
          <span class="hljs-attr">bundleName</span>: (<span class="hljs-title function_">getContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>).<span class="hljs-property">abilityInfo</span>.<span class="hljs-property">bundleName</span>,
          <span class="hljs-attr">abilityName</span>: <span class="hljs-string">"EntryAbility"</span>
        }
      ],
      <span class="hljs-comment">// 指定点击通知栏消息后的动作是拉起ability</span>
      <span class="hljs-attr">actionType</span>: wantAgent.<span class="hljs-property">OperationType</span>.<span class="hljs-property">START_ABILITY</span>,
      <span class="hljs-comment">// 使用者自定义的一个私有值</span>
      <span class="hljs-attr">requestCode</span>: <span class="hljs-number">0</span>,
      <span class="hljs-comment">// 点击通知后，动作执行属性</span>
      <span class="hljs-attr">actionFlags</span>: [wantAgent.<span class="hljs-property">WantAgentFlags</span>.<span class="hljs-property">UPDATE_PRESENT_FLAG</span>],
      <span class="hljs-comment">// 车钥匙长时任务子类型。只有申请bluetoothInteraction类型的长时任务，车钥匙子类型才能生效。</span>
      <span class="hljs-comment">// 确保extraInfo参数中的Key值为backgroundTaskManager.BackgroundModeType.SUB_MODE，否则子类型不生效。</span>
      <span class="hljs-comment">// extraInfo: { [backgroundTaskManager.BackgroundModeType.SUB_MODE] : backgroundTaskManager.BackgroundSubMode.CAR_KEY }</span>
    };

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 通过wantAgent模块下getWantAgent方法获取WantAgent对象</span>
      wantAgent.<span class="hljs-title function_">getWantAgent</span>(wantAgentInfo).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">wantAgentObj: WantAgent</span>) =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// let list: Array&lt;string&gt; = ["audioRecording"];</span>
          <span class="hljs-comment">// let list: Array&lt;string&gt; = ["bluetoothInteraction"]; 长时任务类型包含bluetoothInteraction，CAR_KEY子类型合法</span>
          backgroundTaskManager.<span class="hljs-title function_">startBackgroundRunning</span>(<span class="hljs-title function_">getContext</span>(), list, wantAgentObj).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: backgroundTaskManager.ContinuousTaskNotification</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"Operation startBackgroundRunning succeeded"</span>);
            <span class="hljs-comment">// 此处执行具体的长时任务逻辑，如录音，录制等。</span>
            <span class="hljs-comment">// 写尝试任务</span>
            <span class="hljs-title function_">callback</span>()
          }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to Operation startBackgroundRunning. code is <span class="hljs-subst">${error.code}</span> message is <span class="hljs-subst">${error.message}</span>`</span>);
          });
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to Operation startBackgroundRunning. code is <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span> message is <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);
        }
      });
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to Operation getWantAgent. code is <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span> message is <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);
    }

  }
  <span class="hljs-comment">// 长任务-关闭</span>
  <span class="hljs-title function_">stopLongTask</span>(<span class="hljs-params"/>) {
    backgroundTaskManager.<span class="hljs-title function_">stopBackgroundRunning</span>(<span class="hljs-title function_">getContext</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Succeeded in operationing stopBackgroundRunning.`</span>);
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to operation stopBackgroundRunning. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);
    });
  }

  <span class="hljs-comment">// 短任务-开启</span>
  <span class="hljs-comment">// 短任务-关闭</span>
}

<span class="hljs-keyword">export</span>  <span class="hljs-keyword">const</span> backgroundTaskUtil = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BackgroundTaskUtil</span>()
</code></pre>
<ul>
<li>示例代码</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { geoLocationManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocationKit'</span>;
<span class="hljs-keyword">import</span> { abilityAccessCtrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { permissionUtil } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/PermissionUtil'</span>;
<span class="hljs-keyword">import</span> { backgroundTaskUtil } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/BackgroundTaskUtil'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {

  <span class="hljs-title function_">locationCallback</span>(<span class="hljs-params">location:geoLocationManager.Location</span>)  {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'locationCallback: data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(location));
  }

  <span class="hljs-title function_">aboutToDisappear</span>(<span class="hljs-params"/>) {
    geoLocationManager.<span class="hljs-title function_">off</span>(<span class="hljs-string">'locationChange'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationCallback</span>);
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Button</span>(<span class="hljs-string">'获取位置信息'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-comment">// 1 配置文件 申请权限   同时申请ohos.permission.APPROXIMATELY_LOCATION和ohos.permission.LOCATION 获取到精准位置，精准度在米级别。</span>
      <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> permissionUtil.<span class="hljs-title function_">checkPermissions</span>([<span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span>, <span class="hljs-string">'ohos.permission.LOCATION'</span>], <span class="hljs-title function_">getContext</span>());
      <span class="hljs-keyword">if</span> (!state) <span class="hljs-keyword">return</span>

      <span class="hljs-comment">// 2 检查全局开关  开了-继续走，没开-弹出让他授权</span>
      <span class="hljs-keyword">const</span> locationEnabled = geoLocationManager.<span class="hljs-title function_">isLocationEnabled</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'查看当前全局开关状态：'</span>, locationEnabled)

      <span class="hljs-keyword">if</span> (!locationEnabled) {  <span class="hljs-comment">// 没开</span>
        <span class="hljs-keyword">const</span> <span class="hljs-attr">atManager</span>: abilityAccessCtrl.<span class="hljs-property">AtManager</span> = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();
        <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestGlobalSwitch</span>(<span class="hljs-title function_">getContext</span>(), abilityAccessCtrl.<span class="hljs-property">SwitchType</span>.<span class="hljs-property">LOCATION</span>)
        <span class="hljs-keyword">if</span> (!state) <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 拉起全局弹出 用户没授权就终止代码执行</span>
      }

      <span class="hljs-comment">// 3. 获取位置信息  经度纬度 【持续定位。多用于导航、运动轨迹、出行等场景。】</span>
      backgroundTaskUtil.<span class="hljs-title function_">startLongTask</span>([<span class="hljs-string">'location'</span>], <span class="hljs-function">() =&gt;</span> {
        geoLocationManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'locationChange'</span>, {
          <span class="hljs-attr">interval</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">locationScenario</span>: geoLocationManager.<span class="hljs-property">UserActivityScenario</span>.<span class="hljs-property">NAVIGATION</span>
        }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">locationCallback</span>);
      })
      <span class="hljs-comment">// .....</span>
    })
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F0a0a956faec348ddaa9b2676a3f19545%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" title="https://developer.huawei.com/consumer/cn/training/classDetail/0a0a956faec348ddaa9b2676a3f19545?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" target="_blank" ref="nofollow noopener noreferrer">鸿蒙开发者班级</a></p>
<p>✨家人们点个juejin账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>✨家人们点个juejin账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>✨家人们点个juejin账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>    ^_^ 点关注、不迷路、主播带你学技术 (๑′ᴗ‵๑)Ｉ Lᵒᵛᵉᵧₒᵤ❤</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS 帧动画 animator]]></title>    <link>https://juejin.cn/post/7576953459544342582</link>    <guid>https://juejin.cn/post/7576953459544342582</guid>    <pubDate>2025-11-27T05:25:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576953459544342582" data-draft-id="7576994308273225747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS 帧动画 animator"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-27T05:25:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT充电站"/> <meta itemprop="url" content="https://juejin.cn/user/125809758576431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS 帧动画 animator
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/125809758576431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT充电站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T05:25:28.000Z" title="Thu Nov 27 2025 05:25:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就是类似播放电影一样，一帧一帧的进行播放，相对于属性动画，其每一帧，我们都可以进行设置相关的属性值，并且具有暂停播放，继续播放的优点，而且还具备事件的实时响应，需要说明的是，在性能上是远远不如属性动画的，所以如果能用属性动画实现的场景，还是主推属性动画</p>
<ul>
<li>需要控制动画播放暂停：音乐播放、或者运动小车</li>
<li>翻页动画</li>
</ul>
<h2 data-id="heading-0">基础使用</h2>
<ul>
<li>
<p>创建帧动画   this.animator =   Animator.create()</p>
</li>
<li>
<p>每一帧回调    this.animator.onFrame=fn</p>
</li>
<li>
<p>控制           this.animator.play/pause()</p>
</li>
</ul>
<h5 data-id="heading-1">示例代码1</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">Animator</span>, <span class="hljs-selector-tag">AnimatorResult</span> } <span class="hljs-selector-tag">from</span> '@<span class="hljs-selector-tag">kit</span><span class="hljs-selector-class">.ArkUI</span>'

@<span class="hljs-selector-tag">Entry</span>
@<span class="hljs-selector-tag">Component</span>
<span class="hljs-selector-tag">struct</span> <span class="hljs-selector-tag">Index</span> {
  <span class="hljs-comment">// 1. 创建帧动画</span>
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">animator</span>:AnimatorResult  = Animator.<span class="hljs-built_in">create</span>({
    <span class="hljs-attribute">duration</span>: <span class="hljs-number">3000</span>, <span class="hljs-comment">//动画播放的时长</span>
    <span class="hljs-attribute">delay</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">//动画延时播放时长</span>
    <span class="hljs-attribute">easing</span>: <span class="hljs-string">'linear'</span>, <span class="hljs-comment">//动画插值曲线</span>
    <span class="hljs-attribute">iterations</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">//动画播放次数</span>
    <span class="hljs-attribute">fill</span>: <span class="hljs-string">"forwards"</span>, <span class="hljs-comment">//动画执行后是否恢复到初始状态</span>
    <span class="hljs-attribute">direction</span>: <span class="hljs-string">'normal'</span>, <span class="hljs-comment">//动画播放模式</span>
    <span class="hljs-attribute">begin</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">//动画插值起点</span>
    <span class="hljs-attribute">end</span>: <span class="hljs-number">100</span><span class="hljs-comment">//动画插值终点</span>
  })

  <span class="hljs-variable">@State</span> <span class="hljs-attribute">translateX</span>: number = <span class="hljs-number">0</span>
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">translateY</span>: number = <span class="hljs-number">0</span>

  <span class="hljs-built_in">aboutToAppear</span>(): void {
    <span class="hljs-comment">// 2.每一帧回调</span>
    <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.animator</span><span class="hljs-selector-class">.onFrame</span> = (<span class="hljs-attribute">progress</span>: number) =&gt; {
      <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.translateX</span> = <span class="hljs-selector-tag">progress</span>
    }
  }

  <span class="hljs-selector-tag">build</span>() {
    <span class="hljs-selector-tag">Column</span>({space:20}) {

      <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">"1"</span>)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">30</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">30</span>)<span class="hljs-selector-class">.backgroundColor</span>(Color.Red)<span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)<span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">top</span>: <span class="hljs-number">100</span> })
        <span class="hljs-selector-class">.translate</span>({ x: this.translateX, y: this.translateY })

      <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">"播放"</span>)<span class="hljs-selector-class">.onClick</span>(() =&gt; this.animator.<span class="hljs-built_in">play</span>() )
      <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">"暂停"</span>)<span class="hljs-selector-class">.onClick</span>(() =&gt;  this.animator.<span class="hljs-built_in">pause</span>() )
      <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">"重置"</span>)<span class="hljs-selector-class">.onClick</span>(() =&gt; {
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.translateX</span> = <span class="hljs-number">0</span>
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.translateY</span> = <span class="hljs-number">0</span>
      })
    }
    <span class="hljs-selector-class">.height</span>(<span class="hljs-string">'100%'</span>)
    <span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<h2 data-id="heading-2">示例代码2：实战音乐播放器</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Animator</span>, <span class="hljs-title class_">AnimatorResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">angle</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>

  <span class="hljs-comment">// 1 创建帧动画对象</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">animator</span>: <span class="hljs-title class_">AnimatorResult</span> = <span class="hljs-title class_">Animator</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">duration</span>: <span class="hljs-number">10000</span>,  <span class="hljs-comment">//   持续时间</span>
    <span class="hljs-attr">delay</span>: <span class="hljs-number">0</span>,         <span class="hljs-comment">//   延迟时间</span>
    <span class="hljs-attr">easing</span>: <span class="hljs-string">"linear"</span>, <span class="hljs-comment">//   动画曲线</span>
    <span class="hljs-attr">iterations</span>: -<span class="hljs-number">1</span>,   <span class="hljs-comment">//   播放次数</span>
    <span class="hljs-attr">fill</span>: <span class="hljs-string">"none"</span>,     <span class="hljs-comment">//   播放模式 播放之外的状态</span>
    <span class="hljs-attr">direction</span>: <span class="hljs-string">"normal"</span>, <span class="hljs-comment">//   播放方向</span>
    <span class="hljs-attr">begin</span>: <span class="hljs-number">0</span>,   <span class="hljs-comment">// 开始角度</span>
    <span class="hljs-attr">end</span>: <span class="hljs-number">360</span> <span class="hljs-comment">// 结束角度</span>
  })

  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">//   2 监听帧变化事件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animator</span>.<span class="hljs-property">onFrame</span> = <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">angle</span> = value
    }
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'开始'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">(<span class="hljs-params">event: ClickEvent</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">animator</span>.<span class="hljs-title function_">play</span>()
      })
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'暂停'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">(<span class="hljs-params">event: ClickEvent</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">animator</span>.<span class="hljs-title function_">pause</span>()
      })
      <span class="hljs-title class_">Stack</span>() {
        <span class="hljs-title class_">Image</span>(<span class="hljs-string">"https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/28513831157/e8e9/beeb/912c/468bcb523668065ccf6f853c4a084e31.png"</span>)
          .<span class="hljs-title function_">width</span>(<span class="hljs-number">300</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>)

        <span class="hljs-title class_">Image</span>(<span class="hljs-string">"https://p1.music.126.net/MX4wNwR9eJNvx_Y5AKBEFw==/109951169909770184.jpg?imageView&amp;thumbnail=360y360&amp;quality=75&amp;tostatic=0"</span>)
          .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-number">200</span>)
          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">200</span>)
          .<span class="hljs-title function_">rotate</span>({
            <span class="hljs-attr">angle</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">angle</span>
          })

      }.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>).<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    }
  }
}

</code></pre>
<h2 data-id="heading-3">示例代码3：图片帧动画</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references%2Fts-basic-components-imageanimator%23%25E7%25A4%25BA%25E4%25BE%258B1%25E6%2592%25AD%25E6%2594%25BEresource%25E5%258A%25A8%25E7%2594%25BB" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-imageanimator#%E7%A4%BA%E4%BE%8B1%E6%92%AD%E6%94%BEresource%E5%8A%A8%E7%94%BB" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jq22.com%2Fyanshi24013" target="_blank" title="https://www.jq22.com/yanshi24013" ref="nofollow noopener noreferrer">www.jq22.com/yanshi24013</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jq22.com%2Fdemo%2FimgAni202108230153%2Fimg%2F611e2b5c8fcd2.png" target="_blank" title="https://www.jq22.com/demo/imgAni202108230153/img/611e2b5c8fcd2.png" ref="nofollow noopener noreferrer">www.jq22.com/demo/imgAni…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F0a0a956faec348ddaa9b2676a3f19545%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/0a0a956faec348ddaa9b2676a3f19545?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙开发班级</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS 组件导航（Navigation）]]></title>    <link>https://juejin.cn/post/7576955345378426943</link>    <guid>https://juejin.cn/post/7576955345378426943</guid>    <pubDate>2025-11-27T05:22:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576955345378426943" data-draft-id="7576953459544293430" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS 组件导航（Navigation）"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-27T05:22:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT充电站"/> <meta itemprop="url" content="https://juejin.cn/user/125809758576431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS 组件导航（Navigation）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/125809758576431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT充电站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T05:22:47.000Z" title="Thu Nov 27 2025 05:22:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>✨家人们记得点个账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<h2 data-id="heading-0">组件导航（Navigation）</h2>
<p><strong>Navigation是路由容器组件，一般作为首页的根容器</strong>，包括单栏(Stack)、分栏(Split)和自适应(Auto)三种显示模式。Navigation组件适用于模块内和跨模块的路由切换，<strong>一次开发，多端部署场景</strong>。通过组件级路由能力实现更加自然流畅的转场体验，并提供多种标题栏样式来呈现更好的标题和内容联动效果。在不同尺寸的设备上，Navigation组件能够自适应显示大小，自动切换分栏展示效果。</p>
<ul>
<li>模块内、和跨模块实现路由切换</li>
<li>一次开发，多端部署场景</li>
<li>通过组件级路由能力实现更加自然流畅的转场体验</li>
<li>更好的标题、tabBar等等联动效果</li>
<li>等等</li>
</ul>
<h3 data-id="heading-1">2.1 Navigation属性</h3>
<pre><code class="hljs language-plain" lang="plain">@Entry
@Component
struct Index {
  build() {
    Navigation() {

    }
      .title("主标题")
      .mode()
      .toolbarConfiguration()
      .menus()
  }
}
</code></pre>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a35e8cb486c548f58d6cd679d206bdbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825766&amp;x-signature=1BELIzfK9%2FsamvrTX%2F9ZWVSZ6uA%3D" height="600" loading="lazy"/> 
<h4 data-id="heading-2">title 设置标题</h4>
<p>显示在这个主标题的位置</p>
<h4 data-id="heading-3">titleMode 标题栏模式</h4>
<p>标题栏在界面顶部，用于呈现界面名称和操作入口，Navigation组件通过titleMode属性设置标题栏模式</p>
<ul>
<li>Mini模式：普通型标题栏，用于一级页面不需要突出标题的场景</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b32f7f788a92418db94235561541f02f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825766&amp;x-signature=tMsfFeHoRHHSv7gE4S4h5ynagj8%3D" alt="img" loading="lazy"/></p>
<ul>
<li>Full模式：强调型标题栏，用于一级页面需要突出标题的场景。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7395ff86fbff46428f6a904716b2aa2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825766&amp;x-signature=gS3UCLZQAqzkp9YAeWP0KvbcKd4%3D" alt="img" loading="lazy"/></p>
<h4 data-id="heading-4">mode 设置模式</h4>
<p>Navigation是路由容器组件，一般作为首页的根容器，包括单栏(Stack)、分栏(Split)和自适应(Auto)三种显示模式.Navigation组件适用于模块内和跨模块的路由切换，一次开发，多端部署场景</p>
<p>Navigation组件通过mode属性设置页面的显示模式。自适应模式下，当页面宽度大于等于一定阈值( API version 9及以前：520vp，API version 10及以后：600vp )时，Navigation组件采用分栏模式，反之采用单栏模式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb19ad267832450e8d6e6b1ff2f759bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825766&amp;x-signature=YXgPw0YARFXlraefEdG1B0%2FHRwk%3D" alt="img" loading="lazy"/></p>
<p>将mode属性设置为NavigationMode.Stack，Navigation组件即可设置为单页面显示模式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38e8d26224fd4b30ae9efd76d6f10294~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825766&amp;x-signature=GN5aLdEa%2B%2B3C9Bj0VLqKDASXCTk%3D" alt="img" loading="lazy"/></p>
<p>将mode属性设置为NavigationMode.Split，Navigation组件即可设置为分页面显示模式。</p>
<h4 data-id="heading-5">toolbarConfiguration 底层标题栏</h4>
<p>.toolbarConfiguration() 里面设置的是一个数组，数组里面每个元素ToolbarItem类型，数据的结构如下</p>
<pre><code class="hljs language-plain" lang="plain">{
    value: "我的",
    icon: "https://s1.aigei.com/src/img/png/e7/e79cacc5161a4a6ca589e097f87a2526.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:TLXitIEF_QaGqfeKVbpaGb8_qyQ=",
    action: () =&gt; {

    },
    activeIcon: "",
    status: ToolbarItemStatus.DISABLED,

}
</code></pre>
<p>value 就是显示的文字</p>
<p>icon 显示的图标</p>
<p>action 当点击时触发做某些事情，例如跳转路由</p>
<p>activeIcon 激活时的图标</p>
<p>status 当前图标的状态，例如不可用等等</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a26629542d1641dfa26ca2ee3e91a355~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825766&amp;x-signature=0V6b2n%2BoTjN%2Bhk8h4cQ%2FB%2F8BVW4%3D" alt="img" loading="lazy"/></p>
<h4 data-id="heading-6">menus 菜单栏</h4>
<p>菜单栏位于Navigation组件的右上角，开发者可以通过menus属性进行设置。menus支持Array和CustomBuilder两种参数类型。使用Array类型时，竖屏最多支持显示3个图标，横屏最多支持显示5个图标，多余的图标会被放入自动生成的更多图标。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa20fea36cb44b7cb3f1310741671bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825766&amp;x-signature=gDkqLMN4TqMkazO2RdP0BWRuAzQ%3D" alt="img" loading="lazy"/></p>
<pre><code class="hljs language-plain" lang="plain">{
    value: "我的",
    icon: "https://s1.aigei.com/src/img/png/e7/e79cacc5161a4a6ca589e097f87a2526.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:TLXitIEF_QaGqfeKVbpaGb8_qyQ=",
    action: () =&gt; {

    },
   isEnabled:false

}
</code></pre>
<p>value 就是显示的文字</p>
<p>icon 显示的图标</p>
<p>action 当点击时触发做某些事情，例如跳转路由</p>
<p>isEnabled 是否可用</p>
<ul>
<li>示例代码（全部）</li>
</ul>
<pre><code class="hljs language-arkts" lang="arkts">@Entry
@Component
struct Index {
  build() {
    Navigation() {

    }
    .title("主标题")
      .mode(NavigationMode.Stack)
      .titleMode(NavigationTitleMode.Free)
      .toolbarConfiguration([
        {
          value: "我的",
          icon: "https://s1.aigei.com/src/img/png/e7/e79cacc5161a4a6ca589e097f87a2526.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:TLXitIEF_QaGqfeKVbpaGb8_qyQ=",
          action: () =&gt; {

          },

        },
        {
          value: "购物车",
          icon: "https://s1.aigei.com/src/img/png/5d/5dc2f07ba8224cd4883648c9ea939ac5.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:Q5dD_6ZS_ry4kaVXHgv6gnKw2IQ=",
          action: () =&gt; {

          }
        },
        {
          value: "更多",
          icon: "https://s1.aigei.com/src/img/png/03/03d71ede7b404e70838f3d575b31a930.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:ABookBJ6PVBeSxtM2hEuQHPlGLE=",
          action: () =&gt; {

          }
        }
      ])
      .menus([
        {
          value: "设置",
          icon: "https://s1.4sai.com/src/img/png/6c/6ca77e26c31548e680b784ab33f72900.png?e=1735488000&amp;token=1srnZGLKZ0Aqlz6dk7yF4SkiYf4eP-YrEOdM1sob:9x9bgI9kDs15UsWPzGN7ZuaICXM=",
          action: () =&gt; {

          },
        },
        {
          value: "小红书",
          icon: "https://s1.aigei.com/src/img/png/3e/3e3bda0ac48046b08e560e8764942bd8.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:JPuRl9bkD4UfIc8fGN4ApLuS_rE=",
          action: () =&gt; {

          }
        },
        {
          value: "微信",
          icon: "https://s1.aigei.com/src/img/png/ef/efd714270fdd44f485156053901ecb51.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:GfcdaqAj6Uie-yCw4Wt1pPqAGwg=",
          action: () =&gt; {

          }
        },
        {
          value: "抖音",
          icon: "https://s1.aigei.com/src/img/png/5b/5b26e982f0b34c47817d3b40c9bf2d1f.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:YCO6IvUtFIqf6x1hmy82VctIElo=",
          action: () =&gt; {

          }
        }
      ])
  }
}
</code></pre>
<h3 data-id="heading-7">2.2 NavRouter</h3>
<p>导航组件，默认提供点击响应处理，不需要开发者自定义点击事件逻辑。</p>
<p>必须包含两个子组件，其中第二个子组件必须为NavDestination。</p>
<p>其中第一个组件是需要点击的元素</p>
<p>第二个必须是NavDestination</p>
<pre><code class="hljs language-plain" lang="plain">@Entry
@Component
struct Index {
  build() {
    Navigation() {

      // NavRouter() {
      //   Text('菜单1')
      //   NavDestination() {
      //     Text('内容1')
      //   }
      // }
      //
      //
      // NavRouter() {
      //   Text('菜单2')
      //   NavDestination() {
      //     Text('内容2')
      //   }
      // }

      ForEach('123'.split(''), (item: number) =&gt; {
        NavRouter() {
          // 这里是点击的内容
          Column() {
            Text("文本" + item)
              .width("85%")
              .height(60)
              .backgroundColor("#ccc")
              .borderRadius(25)
              .margin({ top: 10 })
              .textAlign(TextAlign.Center)
          }
          // 这里是跳转显示的页面
          NavDestination() {
            Text("文本" + item).fontSize(30).fontColor("red")
          }.title("标题" + item).hideTitleBar(false)
        }.mode(NavRouteMode.PUSH)
      })


    }.mode(NavigationMode.Split)
  }
}
</code></pre>
<p>这里有一个属性</p>
<h4 data-id="heading-8">mode(mode: NavRouteMode)</h4>
<p>设置指定点击NavRouter跳转到NavDestination页面时，使用的路由模式</p>
<p>PUSH_WITH_RECREATE 跳转到新的NavDestination页面时，替换当前显示的NavDestination页面，页面销毁，但该页面信息仍保留在路由栈中。</p>
<p>PUSH 跳转到新的NavDestination页面时，覆盖当前显示的NavDestination页面，该页面不销毁，且页面信息保留在路由栈中。</p>
<p>REPLACE 跳转到新的NavDestination页面时，替换当前显示的NavDestination页面，页面销毁，且该页面信息从路由栈中清除。</p>
<p>还有一个事件</p>
<h4 data-id="heading-9">onStateChange(callback: (isActivated: boolean) =&gt; void)</h4>
<p>组件激活状态切换时触发该回调。开发者点击激活NavRouter，加载对应的NavDestination子组件时，回调onStateChange(true)。NavRouter对应的NavDestination子组件不再显示时，回调onStateChange(false)。</p>
<p>最后效果</p>
<pre><code class="hljs language-plain" lang="plain">@Entry
  @Component
  struct Index {
    pageStack: NavPathStack = new NavPathStack();
    @State list: Array&lt;number&gt; = [1, 2, 3]

    build() {
      Navigation(this.pageStack) {
        ForEach(this.list, (item: number) =&gt; {
          NavRouter() {
            Column() {
              Text("文本" + item)
                .width("85%")
                .height(60)
                .backgroundColor("#ccc")
                .borderRadius(25)
                .margin({ top: 10 })
                .textAlign(TextAlign.Center)
            }

            NavDestination() {
              Text("文本" + item)
                .fontSize(30)
                .fontColor("red")
            }.title("标题" + item)

          }.mode(NavRouteMode.PUSH)
                .onStateChange((isActivated: boolean) =&gt; {
                   console.log(item + "激活：" + isActivated)
          })
        })
      }
      .title("主标题")
        .mode(NavigationMode.Stack)
        .titleMode(NavigationTitleMode.Free)
        .toolbarConfiguration([
          {
            value: "我的",
            icon: "https://s1.aigei.com/src/img/png/e7/e79cacc5161a4a6ca589e097f87a2526.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:TLXitIEF_QaGqfeKVbpaGb8_qyQ=",
            action: () =&gt; {
              this.pageStack.pushPath({ name: "pageOne", param: "aaa" })
            },

          },
          {
            value: "购物车",
            icon: "https://s1.aigei.com/src/img/png/5d/5dc2f07ba8224cd4883648c9ea939ac5.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:Q5dD_6ZS_ry4kaVXHgv6gnKw2IQ=",
            action: () =&gt; {

            }
          },
          {
            value: "更多",
            icon: "https://s1.aigei.com/src/img/png/03/03d71ede7b404e70838f3d575b31a930.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:ABookBJ6PVBeSxtM2hEuQHPlGLE=",
            action: () =&gt; {

            }
          }
        ])
        .menus([
          {
            value: "设置",
            icon: "https://s1.4sai.com/src/img/png/6c/6ca77e26c31548e680b784ab33f72900.png?e=1735488000&amp;token=1srnZGLKZ0Aqlz6dk7yF4SkiYf4eP-YrEOdM1sob:9x9bgI9kDs15UsWPzGN7ZuaICXM=",
            action: () =&gt; {

            },
          },
          {
            value: "小红书",
            icon: "https://s1.aigei.com/src/img/png/3e/3e3bda0ac48046b08e560e8764942bd8.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:JPuRl9bkD4UfIc8fGN4ApLuS_rE=",
            action: () =&gt; {

            }
          },
          {
            value: "微信",
            icon: "https://s1.aigei.com/src/img/png/ef/efd714270fdd44f485156053901ecb51.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:GfcdaqAj6Uie-yCw4Wt1pPqAGwg=",
        action: () =&gt; {

        }
      },
      {
        value: "抖音",
        icon: "https://s1.aigei.com/src/img/png/5b/5b26e982f0b34c47817d3b40c9bf2d1f.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:YCO6IvUtFIqf6x1hmy82VctIElo=",
        action: () =&gt; {

        }
      }
    ])
  }
}
</code></pre>
<h3 data-id="heading-10">2.3  独立的NavDestination</h3>
<p>切记独立的NavDestination不能通过NavRouter跳转 它也被弃用了，只能通过 NavPathStack创建一个路由栈对象，</p>
<p>然后通过路由栈对象控制页面跳转</p>
<h4 data-id="heading-11">具体实现</h4>
<p>1、Profile.ets 把页面内容NavDestination独立出去</p>
<pre><code class="hljs language-plain" lang="plain">@Component
export struct Profile {
  build() {
    NavDestination() { // 根元素必须是NavDestination
      Column() {
        Text("实际的内容")
      }
    }
    .title("标题")
  }
}
</code></pre>
<p>2、Navigation通过属性关联Profile页面</p>
<pre><code class="hljs language-plain" lang="plain">import {Profile} from './Profile'

@Entry
@Component
export struct Index {

  @Builder PagesMap(name: string) {
    if (name === "Profile") {
      Profile()
    }
  }

  pageStack: NavPathStack = new NavPathStack()  // 页面栈对象 管理页面栈里面的网页

  build() {
    Navigation(this.pageStack) {
      Button('跳转到Cart页面').onClick(() =&gt; {
        this.pageStack.pushPathByName('Profile', null)
        // this.pageStack.pushPath({ name: "Profile", param: "实际需要显示的内容" })
      })
    }
    .title("主标题")
    .mode(NavigationMode.Stack)
    .navDestination(this.PagesMap) // 通过属性的方式动态设置
  }
}
</code></pre>
<p>3、控制跳转（之前没有独立NavRouter 独立之后必须通过Navigation提供的<strong>页面栈对象</strong>来操作</p>
<pre><code class="hljs language-plain" lang="plain">3.1 创建页面栈

pageStack: NavPathStack = new NavPathStack(); // 创建页面栈实例化对象  控制页面栈路由增删改等
 
3.2 注册关联
Navigation(this.pageStack) {

3.3  跳转
https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-navigation-navigation-V5#%E8%B7%AF%E7%94%B1%E6%93%8D%E4%BD%9C
</code></pre>
<h4 data-id="heading-12">NavDestination的模式</h4>
<p>NavDestination的mode属性有两种值</p>
<p>标准类型 NavDestinationMode.STANDARD</p>
<p>标准类型的NavDestination的生命周期跟随其在NavPathStack页面栈中的位置变化而改变。</p>
<p>弹窗类型 NavDestinationMode.DIALOG</p>
<p>整个NavDestination默认透明显示。弹窗类型的NavDestination显示和消失时不会影响下层标准类型的NavDestination的显示和生命周期，两者可以同时显示。</p>
<p>下面处理一个弹窗问题</p>
<pre><code class="hljs language-plain" lang="plain">@Component
export  struct DialogPage {
  @Consume pageStack: NavPathStack;
  param: string = ""

  build() {
    NavDestination() {
      Column() {
        Stack({ alignContent: Alignment.TopEnd }) {
          Text(this.param)
            .fontSize(30)
            .fontColor("red")
            .textAlign(TextAlign.Center)
            .width("100%")
            .margin({ top: 80 })
          Button("×").onClick(() =&gt; {
            this.pageStack.pop();
          })
        }.width("70%")
          .height("30%")
          .backgroundColor("white")
          .borderRadius(30)
      }.justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .width("100%")
        .height("100%")
    }
    .backgroundColor("rgba(0,0,0,0.5)")
      .mode(NavDestinationMode.DIALOG)
      .title("标题")
      .hideTitleBar(true)
  }
}
import { DialogPage } from '../components/DialogPage';


@Entry
  @Component
  struct Index {
    @Provide pageStack: NavPathStack = new NavPathStack();

    @Builder
    PagesMap(name: string, param: string) {
      if (name === "dialogPage") {
        DialogPage({ param: param })
      }
    }

    build() {
      Navigation(this.pageStack) {

      }
      .title("主标题")
        .mode(NavigationMode.Stack)
        .titleMode(NavigationTitleMode.Free)
        .navDestination(this.PagesMap)
        .toolbarConfiguration([
          {
            value: "我的",
            icon: "https://s1.aigei.com/src/img/png/e7/e79cacc5161a4a6ca589e097f87a2526.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:TLXitIEF_QaGqfeKVbpaGb8_qyQ=",
            action: () =&gt; {
              this.pageStack.pushPath({ name: "dialogPage", param: "aaa" })
            },

          },
          {
            value: "购物车",
            icon: "https://s1.aigei.com/src/img/png/5d/5dc2f07ba8224cd4883648c9ea939ac5.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:Q5dD_6ZS_ry4kaVXHgv6gnKw2IQ=",
            action: () =&gt; {

            }
          },
          {
            value: "更多",
            icon: "https://s1.aigei.com/src/img/png/03/03d71ede7b404e70838f3d575b31a930.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&amp;e=1735488000&amp;token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:ABookBJ6PVBeSxtM2hEuQHPlGLE=",
            action: () =&gt; {

            }
          }
        ])
    }
  }
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b9a79a603714bab968b1c4b20460ccf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764825766&amp;x-signature=IaczK3cVsvnc6Wbm3XOYfVLxB7c%3D" alt="img" loading="lazy"/></p>
<h3 data-id="heading-13">2.4 NavPathStack</h3>
<p>NavPathStrack是<strong>页面栈</strong>为路由跳转提供的方法对象，每个Navigation都需要创建并传入一个NavPathStack对象，用于管理页面。主要涉及页面跳转、页面返回、页面替换、页面删除、参数获取、路由拦截等功能。</p>
<p>pageStack: NavPathStack = new NavPathStack()</p>
<h4 data-id="heading-14">普通跳转</h4>
<pre><code class="hljs language-plain" lang="plain">this.pageStack.pushPath({ name: "DialogPage", param: "aaa" })
this.pageStack.pushPathByName("DialogPage", "aaa")
</code></pre>
<p>这两种方法都可以使用</p>
<h4 data-id="heading-15">带返回回调的跳转，跳转时添加onPop回调,能在页面出栈时获取返回信息</h4>
<pre><code class="hljs language-plain" lang="plain">this.pageStack.pushPath({
  name: "DialogPage", param: "aaa", onPop: (popInfo) =&gt; {
    Logger.log(popInfo.result)
  }
})
</code></pre>
<p>关闭退回时通过pop传回的数据</p>
<pre><code class="hljs language-plain" lang="plain">Button("×").onClick(() =&gt; {
  this.pageStack.pop("返回的内容")
})
</code></pre>
<h4 data-id="heading-16">页面返回</h4>
<pre><code class="hljs language-plain" lang="plain">// 返回到上一页
this.pageStack.pop()
// 返回到上一个PageOne页面
this.pageStack.popToName("PageOne")
// 返回到索引为1的页面
this.pageStack.popToIndex(1)
// 返回到根首页（清除栈中所有页面）
this.pageStack.clear()
</code></pre>
<h4 data-id="heading-17">页面替换</h4>
<pre><code class="hljs language-plain" lang="plain">// 将栈顶页面替换为PageOne
this.pageStack.replacePath({ name: "PageOne", param: "PageOne Param" })
this.pageStack.replacePathByName("PageOne", "PageOne Param")
</code></pre>
<h4 data-id="heading-18">页面删除</h4>
<pre><code class="hljs language-plain" lang="plain">// 删除栈中name为PageOne的所有页面
this.pageStack.removeByName("PageOne")
// 删除指定索引的页面
this.pageStack.removeByIndexes([1,3,5])
</code></pre>
<h4 data-id="heading-19">参数获取</h4>
<pre><code class="hljs language-plain" lang="plain">// 获取栈中所有页面name集合
this.pageStack.getAllPathName()
// 获取索引为1的页面参数
this.pageStack.getParamByIndex(1)
// 获取PageOne页面的参数
this.pageStack.getParamByName("PageOne")
// 获取PageOne页面的索引集合
this.pageStack.getIndexByName("PageOne")
</code></pre>
<h4 data-id="heading-20">路由拦截</h4>
<p>在页面的初始生命周期中设置</p>
<pre><code class="hljs language-plain" lang="plain">aboutToAppear(): void {
  this.pageStack.setInterception({
  willShow: (from: NavDestinationContext | NavBar, to: NavDestinationContext | NavBar,
       operation: NavigationOperation, isAnimated: boolean) =&gt; {
         if (typeof to === "string") return; 
         if (to.pathInfo.name === "dialogPage") {
           to.pathStack.pop();
           to.pathStack.pushPath({ name: "page1", param: "bbbb" })
         }
       }
  })
}
</code></pre>
<h3 data-id="heading-21">2.5  跨包动态路由-系统路由表</h3>
<h4 data-id="heading-22">准备生成Navigation的route_map路由</h4>
<p>a）给模块创建系统路由表 （也就是针对于Navigation以后还是通过配置文件生成路由）</p>
<p>创建resources/base/profile/route_map.json（<code>切记route不加r</code>）路由配置文件，填写下述代码</p>
<pre><code class="hljs language-plain" lang="plain">{
  "routerMap": [
    {
      # 路由名  也就是跳转名
      "name": "Home或者Profile",    
      # 改名字对应的页面 
      "pageSourceFile": "src/main/ets/pages/Profile.ets",     
      
      # 切记MainPage.ets这个文件必须用MainPageBuilder当做入口（比较抽象跟着写  写完反过来看才能理解）
      "buildFunction": "MainPageBuilder",    
      "data": {
        "description" : "this is PageOne"
      }
    }
  ]
}
</code></pre>
<p>b）让创建route_map.json生效 也就是跟模块绑定</p>
<p>修改模块的<code>module.json5</code>文件 <code>"routerMap": "$profile:route_map",</code></p>
<pre><code class="hljs language-plain" lang="plain">{
  "module": {
  
    "routerMap": "$profile:route_map",
    
    "name": "cartHar",
    "type": "har",
    "deviceTypes": [
      "default",
      "tablet",
      "2in1"
    ]
  }
}
</code></pre>
<h4 data-id="heading-23">后续创建页面跳转</h4>
<p>a）必须按照下述格式创建页面</p>
<pre><code class="hljs language-scss" lang="scss">按照系统路由表需要的组件格式修改组件 `<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/ets/components/MainPage<span class="hljs-selector-class">.ets</span>`

```plain
<span class="hljs-comment">// 跳转页面入口函数</span>
<span class="hljs-keyword">@Builder</span>
export function MainPageBuilder() {  <span class="hljs-comment">// 细节2：按照这个格式配置</span>
  <span class="hljs-built_in">MainPage</span>()
}


<span class="hljs-keyword">@Component</span>
struct MainPage { <span class="hljs-comment">// 细节1.1：不用导出  但是必须按照上述配置</span>

  <span class="hljs-built_in">build</span>() {
    <span class="hljs-built_in">NavDestination</span>() { <span class="hljs-comment">// 细节1.2：必须通过NavDestination写</span>
      Text('内容')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">30</span>)
    }
    <span class="hljs-selector-class">.title</span>('CartHar/MainPage')
    <span class="hljs-selector-class">.hideTitleBar</span>(false)
  }
}
```


</code></pre>
<p>b）通过NavPathStack跳转</p>
<h3 data-id="heading-24">2.6  跨包动态路由-自定义路由表 HMRouter</h3>
<p>千锋生鲜项目</p>
<h3 data-id="heading-25">2.7  企业级面试题</h3>
<ul>
<li>Navigation 和 Router 区别</li>
</ul>

<pre><code class="hljs">1 路由有闪屏的问题、Navigation更流畅
2 Navigation更适合一次开发、多端适配
3 Navigation页面转场动画更方便
4 跨模块开发Navigation更方便
等等
</code></pre>
<ul>
<li>如何用的</li>
</ul>

<pre><code class="hljs language-diff" lang="diff">传统：1-创建页面、2-配置路由main_pages、3-router跳转
现在：
<span class="hljs-deletion">- 准备：Navigation动态路由-系统路由表配置：1-创建route_map.json写配置、2-注册把1的文件跟项目关联module.json5、3-入口文件Navigation配置</span>
<span class="hljs-deletion">- 后续1：创建页面  必须按照系统路由规则去创建 （必须写NavDestination 然后不写导出但是必须被@Builder调用）</span>
<span class="hljs-deletion">- 后续2：配置该页面路由就可以跳转</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F0a0a956faec348ddaa9b2676a3f19545%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/0a0a956faec348ddaa9b2676a3f19545?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙开发班级</a></p>
<p>✨家人们点个juejin账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>✨家人们点个juejin账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>✨家人们点个juejin账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>    ^_^ 点关注、不迷路、主播带你学技术 (๑′ᴗ‵๑)Ｉ Lᵒᵛᵉᵧₒᵤ❤</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python自动化脚本：告别重复劳动]]></title>    <link>https://juejin.cn/post/7576861477267177491</link>    <guid>https://juejin.cn/post/7576861477267177491</guid>    <pubDate>2025-11-26T16:11:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576861477267177491" data-draft-id="7576888607479840787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python自动化脚本：告别重复劳动"/> <meta itemprop="keywords" content="Python,PyCharm"/> <meta itemprop="datePublished" content="2025-11-26T16:11:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BBB努力学习程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python自动化脚本：告别重复劳动
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BBB努力学习程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T16:11:18.000Z" title="Wed Nov 26 2025 16:11:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否曾经花费数小时重复做着相同的文件整理、数据录入或系统维护工作？想象一下，如果这些繁琐任务都能自动完成，你的工作效率将提升多少倍！Python自动化脚本正是为此而生，它就像雇佣了一个不知疲倦的数字助手，帮你处理各种重复性工作。</p>
<h2 data-id="heading-0">实战代码：构建个人自动化工具箱</h2>
<h3 data-id="heading-1">文件批量处理脚本</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">def</span> <span class="hljs-title function_">organize_files_by_extension</span>(<span class="hljs-params">folder_path</span>):
    <span class="hljs-string">"""
    按文件扩展名自动整理文件夹
    """</span>
    <span class="hljs-comment"># 确保目标文件夹存在</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(folder_path):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误：文件夹 <span class="hljs-subst">{folder_path}</span> 不存在"</span>)
        <span class="hljs-keyword">return</span>
    
    <span class="hljs-comment"># 定义文件类型分类</span>
    file_categories = {
        <span class="hljs-string">'图片'</span>: [<span class="hljs-string">'.jpg'</span>, <span class="hljs-string">'.jpeg'</span>, <span class="hljs-string">'.png'</span>, <span class="hljs-string">'.gif'</span>, <span class="hljs-string">'.bmp'</span>],
        <span class="hljs-string">'文档'</span>: [<span class="hljs-string">'.pdf'</span>, <span class="hljs-string">'.doc'</span>, <span class="hljs-string">'.docx'</span>, <span class="hljs-string">'.txt'</span>, <span class="hljs-string">'.xlsx'</span>, <span class="hljs-string">'.pptx'</span>],
        <span class="hljs-string">'视频'</span>: [<span class="hljs-string">'.mp4'</span>, <span class="hljs-string">'.avi'</span>, <span class="hljs-string">'.mov'</span>, <span class="hljs-string">'.mkv'</span>],
        <span class="hljs-string">'音频'</span>: [<span class="hljs-string">'.mp3'</span>, <span class="hljs-string">'.wav'</span>, <span class="hljs-string">'.flac'</span>],
        <span class="hljs-string">'代码'</span>: [<span class="hljs-string">'.py'</span>, <span class="hljs-string">'.js'</span>, <span class="hljs-string">'.html'</span>, <span class="hljs-string">'.css'</span>, <span class="hljs-string">'.java'</span>],
        <span class="hljs-string">'压缩包'</span>: [<span class="hljs-string">'.zip'</span>, <span class="hljs-string">'.rar'</span>, <span class="hljs-string">'.7z'</span>]
    }
    
    <span class="hljs-comment"># 创建分类文件夹</span>
    <span class="hljs-keyword">for</span> category <span class="hljs-keyword">in</span> file_categories.keys():
        category_path = os.path.join(folder_path, category)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(category_path):
            os.makedirs(category_path)
    
    <span class="hljs-comment"># 遍历并整理文件</span>
    moved_files = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> os.listdir(folder_path):
        file_path = os.path.join(folder_path, filename)
        
        <span class="hljs-comment"># 跳过文件夹和隐藏文件</span>
        <span class="hljs-keyword">if</span> os.path.isdir(file_path) <span class="hljs-keyword">or</span> filename.startswith(<span class="hljs-string">'.'</span>):
            <span class="hljs-keyword">continue</span>
        
        <span class="hljs-comment"># 获取文件扩展名</span>
        _, file_extension = os.path.splitext(filename)
        file_extension = file_extension.lower()
        
        <span class="hljs-comment"># 查找对应的文件分类</span>
        moved = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">for</span> category, extensions <span class="hljs-keyword">in</span> file_categories.items():
            <span class="hljs-keyword">if</span> file_extension <span class="hljs-keyword">in</span> extensions:
                target_path = os.path.join(folder_path, category, filename)
                shutil.move(file_path, target_path)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"移动: <span class="hljs-subst">{filename}</span> -&gt; <span class="hljs-subst">{category}</span>/"</span>)
                moved_files += <span class="hljs-number">1</span>
                moved = <span class="hljs-literal">True</span>
                <span class="hljs-keyword">break</span>
        
        <span class="hljs-comment"># 未分类的文件移到"其他"文件夹</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> moved:
            other_path = os.path.join(folder_path, <span class="hljs-string">"其他"</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(other_path):
                os.makedirs(other_path)
            shutil.move(file_path, os.path.join(other_path, filename))
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"移动: <span class="hljs-subst">{filename}</span> -&gt; 其他/"</span>)
            moved_files += <span class="hljs-number">1</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n整理完成！共移动了 <span class="hljs-subst">{moved_files}</span> 个文件"</span>)

<span class="hljs-comment"># 使用示例</span>
organize_files_by_extension(<span class="hljs-string">"/Users/你的用户名/Downloads"</span>)
</code></pre>
<h3 data-id="heading-2">自动备份脚本</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">import</span> schedule
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_backup</span>(<span class="hljs-params">source_dir, backup_dir</span>):
    <span class="hljs-string">"""
    创建文件备份
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 创建带时间戳的备份文件夹</span>
        timestamp = datetime.now().strftime(<span class="hljs-string">"%Y%m%d_%H%M%S"</span>)
        backup_path = os.path.join(backup_dir, <span class="hljs-string">f"backup_<span class="hljs-subst">{timestamp}</span>"</span>)
        
        <span class="hljs-comment"># 复制文件</span>
        <span class="hljs-keyword">if</span> os.path.exists(source_dir):
            shutil.copytree(source_dir, backup_path)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"备份成功: <span class="hljs-subst">{backup_path}</span>"</span>)
            <span class="hljs-keyword">return</span> backup_path
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误：源目录 <span class="hljs-subst">{source_dir}</span> 不存在"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
            
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"备份失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">cleanup_old_backups</span>(<span class="hljs-params">backup_dir, keep_days=<span class="hljs-number">7</span></span>):
    <span class="hljs-string">"""
    清理旧的备份文件
    """</span>
    current_time = time.time()
    deleted_count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> os.listdir(backup_dir):
        item_path = os.path.join(backup_dir, item)
        
        <span class="hljs-comment"># 检查是否是备份文件夹且超过保留期限</span>
        <span class="hljs-keyword">if</span> os.path.isdir(item_path) <span class="hljs-keyword">and</span> item.startswith(<span class="hljs-string">"backup_"</span>):
            <span class="hljs-comment"># 获取文件夹创建时间</span>
            creation_time = os.path.getctime(item_path)
            age_days = (current_time - creation_time) / (<span class="hljs-number">24</span> * <span class="hljs-number">3600</span>)
            
            <span class="hljs-keyword">if</span> age_days &gt; keep_days:
                shutil.rmtree(item_path)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"删除旧备份: <span class="hljs-subst">{item}</span>"</span>)
                deleted_count += <span class="hljs-number">1</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"清理完成！删除了 <span class="hljs-subst">{deleted_count}</span> 个旧备份"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_auto_backup</span>(<span class="hljs-params">source_dir, backup_dir, interval_hours=<span class="hljs-number">24</span></span>):
    <span class="hljs-string">"""
    设置自动备份任务
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">backup_job</span>():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n执行自动备份 - <span class="hljs-subst">{datetime.now()}</span>"</span>)
        create_backup(source_dir, backup_dir)
        cleanup_old_backups(backup_dir)
    
    <span class="hljs-comment"># 设置定时任务</span>
    schedule.every(interval_hours).hours.do(backup_job)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"自动备份已设置：每<span class="hljs-subst">{interval_hours}</span>小时备份一次"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"源目录: <span class="hljs-subst">{source_dir}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"备份目录: <span class="hljs-subst">{backup_dir}</span>"</span>)
    
    <span class="hljs-comment"># 立即执行一次备份</span>
    backup_job()
    
    <span class="hljs-comment"># 保持程序运行（在实际使用中可能需要用系统服务代替）</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            schedule.run_pending()
            time.sleep(<span class="hljs-number">60</span>)  <span class="hljs-comment"># 每分钟检查一次</span>
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n自动备份已停止"</span>)

<span class="hljs-comment"># 使用示例（取消注释来运行）</span>
<span class="hljs-comment"># setup_auto_backup(</span>
<span class="hljs-comment">#     source_dir="/Users/你的用户名/重要文档",</span>
<span class="hljs-comment">#     backup_dir="/Users/你的用户名/文档备份",</span>
<span class="hljs-comment">#     interval_hours=24</span>
<span class="hljs-comment"># )</span>
</code></pre>
<h3 data-id="heading-3">网页内容监控脚本</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> smtplib
<span class="hljs-keyword">from</span> email.mime.text <span class="hljs-keyword">import</span> MIMEText
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">WebsiteMonitor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, websites, check_interval=<span class="hljs-number">300</span></span>):
        <span class="hljs-string">"""
        初始化网站监控器
        websites: 要监控的网站列表 [{'name': '网站名', 'url': '网址'}]
        check_interval: 检查间隔（秒）
        """</span>
        self.websites = websites
        self.check_interval = check_interval
        self.status_history = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_website_status</span>(<span class="hljs-params">self, url</span>):
        <span class="hljs-string">"""
        检查网站状态
        """</span>
        <span class="hljs-keyword">try</span>:
            response = requests.get(url, timeout=<span class="hljs-number">10</span>)
            <span class="hljs-keyword">return</span> response.status_code == <span class="hljs-number">200</span>, response.status_code
        <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-built_in">str</span>(e)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_alert</span>(<span class="hljs-params">self, website_name, status, message</span>):
        <span class="hljs-string">"""
        发送警报（这里打印到控制台，实际使用时可以发送邮件）
        """</span>
        timestamp = datetime.now().strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)
        alert_message = <span class="hljs-string">f"[<span class="hljs-subst">{timestamp}</span>] 警报: <span class="hljs-subst">{website_name}</span> - <span class="hljs-subst">{status}</span>\n详情: <span class="hljs-subst">{message}</span>"</span>
        <span class="hljs-built_in">print</span>(alert_message)
        
        <span class="hljs-comment"># 在实际使用中，这里可以添加邮件发送代码</span>
        <span class="hljs-comment"># self.send_email_alert(website_name, status, message)</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">monitor_websites</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
        开始监控网站
        """</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始监控 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.websites)}</span> 个网站..."</span>)
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
                <span class="hljs-keyword">for</span> website <span class="hljs-keyword">in</span> self.websites:
                    name = website[<span class="hljs-string">'name'</span>]
                    url = website[<span class="hljs-string">'url'</span>]
                    
                    <span class="hljs-comment"># 检查网站状态</span>
                    is_online, status = self.check_website_status(url)
                    current_status = <span class="hljs-string">"在线"</span> <span class="hljs-keyword">if</span> is_online <span class="hljs-keyword">else</span> <span class="hljs-string">"离线"</span>
                    
                    <span class="hljs-comment"># 检查状态变化</span>
                    previous_status = self.status_history.get(name)
                    <span class="hljs-keyword">if</span> previous_status != current_status:
                        <span class="hljs-keyword">if</span> previous_status <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:  <span class="hljs-comment"># 不是第一次检查</span>
                            self.send_alert(name, current_status, <span class="hljs-string">f"状态码: <span class="hljs-subst">{status}</span>"</span>)
                        
                        self.status_history[name] = current_status
                    
                    <span class="hljs-comment"># 输出状态信息</span>
                    status_icon = <span class="hljs-string">"✅"</span> <span class="hljs-keyword">if</span> is_online <span class="hljs-keyword">else</span> <span class="hljs-string">"❌"</span>
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{status_icon}</span> <span class="hljs-subst">{name}</span>: <span class="hljs-subst">{current_status}</span> (<span class="hljs-subst">{status}</span>)"</span>)
                
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"等待 <span class="hljs-subst">{self.check_interval}</span> 秒后再次检查...\n"</span>)
                time.sleep(self.check_interval)
                
        <span class="hljs-keyword">except</span> KeyboardInterrupt:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n网站监控已停止"</span>)

<span class="hljs-comment"># 使用示例</span>
websites_to_monitor = [
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'谷歌'</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://www.google.com'</span>},
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'GitHub'</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://www.github.com'</span>},
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'稀土掘金'</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://juejin.cn'</span>}
]

monitor = WebsiteMonitor(websites_to_monitor, check_interval=<span class="hljs-number">60</span>)
<span class="hljs-comment"># monitor.monitor_websites()  # 取消注释来运行</span>
</code></pre>
<h3 data-id="heading-4">自动化数据收集脚本</h3>
<pre><code class="hljs language-pythonimport" lang="pythonimport">import json
import csv
import sqlite3
from datetime import datetime

class DataCollector:
    def __init__(self, db_path="collected_data.db"):
        self.db_path = db_path
        self.setup_database()
    
    def setup_database(self):
        """设置SQLite数据库"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # 创建数据表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS weather_data (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                city TEXT NOT NULL,
                temperature REAL,
                humidity INTEGER,
                description TEXT,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        conn.commit()
        conn.close()
        print("数据库初始化完成")
    
    def get_weather_data(self, city):
        """获取天气数据（模拟API调用）"""
        # 这里使用模拟数据，实际使用时可以调用真实天气API
        weather_data = {
            '北京': {'temperature': 25.5, 'humidity': 60, 'description': '晴朗'},
            '上海': {'temperature': 28.0, 'humidity': 75, 'description': '多云'},
            '广州': {'temperature': 32.5, 'humidity': 80, 'description': '阵雨'},
            '深圳': {'temperature': 31.0, 'humidity': 78, 'description': '阴天'}
        }
        
        return weather_data.get(city, {'temperature': 0, 'humidity': 0, 'description': '未知'})
    
    def collect_weather_data(self, cities):
        """收集多个城市的天气数据"""
        collected_data = []
        
        for city in cities:
            print(f"正在收集 {city} 的天气数据...")
            weather = self.get_weather_data(city)
            
            data_point = {
                'city': city,
                'temperature': weather['temperature'],
                'humidity': weather['humidity'],
                'description': weather['description'],
                'timestamp': datetime.now()
            }
            
            collected_data.append(data_point)
            
            # 保存到数据库
            self.save_to_database(data_point)
        
        return collected_data
    
    def save_to_database(self, data):
        """保存数据到数据库"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO weather_data (city, temperature, humidity, description)
            VALUES (?, ?, ?, ?)
        ''', (data['city'], data['temperature'], data['humidity'], data['description']))
        
        conn.commit()
        conn.close()
    
    def export_to_csv(self, filename="weather_data.csv"):
        """导出数据到CSV文件"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('SELECT * FROM weather_data')
        data = cursor.fetchall()
        
        with open(filename, 'w', newline='', encoding='utf-8') as file:
            writer = csv.writer(file)
            
            # 写入表头
            writer.writerow(['ID', '城市', '温度', '湿度', '描述', '时间'])
            
            # 写入数据
            for row in data:
                writer.writerow(row)
        
        conn.close()
        print(f"数据已导出到 {filename}")
    
    def generate_report(self):
        """生成数据报告"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # 统计各城市平均温度
        cursor.execute('''
            SELECT city, 
                   AVG(temperature) as avg_temp,
                   AVG(humidity) as avg_humidity,
                   COUNT(*) as data_count
            FROM weather_data 
            GROUP BY city
        ''')
        
        stats = cursor.fetchall()
        
        print("\n=== 天气数据统计报告 ===")
        for city, avg_temp, avg_humidity, count in stats:
            print(f"{city}:")
            print(f"  平均温度: {avg_temp:.1f}°C")
            print(f"  平均湿度: {avg_humidity:.1f}%")
            print(f"  数据点数: {count}")
            print()
        
        conn.close()

# 使用示例
collector = DataCollector()

# 收集数据
cities = ['北京', '上海', '广州', '深圳']
weather_data = collector.collect_weather_data(cities)

print("收集到的天气数据:")
for data in weather_data:
    print(f"{data['city']}: {data['temperature']}°C, {data['humidity']}%, {data['description']}")

# 生成报告和导出数据
collector.generate_report()
collector.export_to_csv()
import requests
import json
import csv
import sqlite3
from datetime import datetime

class DataCollector:
    def __init__(self, db_path="collected_data.db"):
        self.db_path = db_path
        self.setup_database()
    
    def setup_database(self):
        """设置SQLite数据库"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # 创建数据表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS weather_data (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                city TEXT NOT NULL,
                temperature REAL,
                humidity INTEGER,
                description TEXT,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        conn.commit()
        conn.close()
        print("数据库初始化完成")
    
    def get_weather_data(self, city):
        """获取天气数据（模拟API调用）"""
        # 这里使用模拟数据，实际使用时可以调用真实天气API
        weather_data = {
            '北京': {'temperature': 25.5, 'humidity': 60, 'description': '晴朗'},
            '上海': {'temperature': 28.0, 'humidity': 75, 'description': '多云'},
            '广州': {'temperature': 32.5, 'humidity': 80, 'description': '阵雨'},
            '深圳': {'temperature': 31.0, 'humidity': 78, 'description': '阴天'}
        }
        
        return weather_data.get(city, {'temperature': 0, 'humidity': 0, 'description': '未知'})
    
    def collect_weather_data(self, cities):
        """收集多个城市的天气数据"""
        collected_data = []
        
        for city in cities:
            print(f"正在收集 {city} 的天气数据...")
            weather = self.get_weather_data(city)
            
            data_point = {
                'city': city,
                'temperature': weather['temperature'],
                'humidity': weather['humidity'],
                'description': weather['description'],
                'timestamp': datetime.now()
            }
            
            collected_data.append(data_point)
            
            # 保存到数据库
            self.save_to_database(data_point)
        
        return collected_data
    
    def save_to_database(self, data):
        """保存数据到数据库"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO weather_data (city, temperature, humidity, description)
            VALUES (?, ?, ?, ?)
        ''', (data['city'], data['temperature'], data['humidity'], data['description']))
        
        conn.commit()
        conn.close()
    
    def export_to_csv(self, filename="weather_data.csv"):
        """导出数据到CSV文件"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute('SELECT * FROM weather_data')
        data = cursor.fetchall()
        
        with open(filename, 'w', newline='', encoding='utf-8') as file:
            writer = csv.writer(file)
            
            # 写入表头
            writer.writerow(['ID', '城市', '温度', '湿度', '描述', '时间'])
            
            # 写入数据
            for row in data:
                writer.writerow(row)
        
        conn.close()
        print(f"数据已导出到 {filename}")
    
    def generate_report(self):
        """生成数据报告"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # 统计各城市平均温度
        cursor.execute('''
            SELECT city, 
                   AVG(temperature) as avg_temp,
                   AVG(humidity) as avg_humidity,
                   COUNT(*) as data_count
            FROM weather_data 
            GROUP BY city
        ''')
        
        stats = cursor.fetchall()
        
        print("\n=== 天气数据统计报告 ===")
        for city, avg_temp, avg_humidity, count in stats:
            print(f"{city}:")
            print(f"  平均温度: {avg_temp:.1f}°C")
            print(f"  平均湿度: {avg_humidity:.1f}%")
            print(f"  数据点数: {count}")
            print()
        
        conn.close()

# 使用示例
collector = DataCollector()

# 收集数据
cities = ['北京', '上海', '广州', '深圳']
weather_data = collector.collect_weather_data(cities)

print("收集到的天气数据:")
for data in weather_data:
    print(f"{data['city']}: {data['temperature']}°C, {data['humidity']}%, {data['description']}")

# 生成报告和导出数据
collector.generate_report()
collector.export_to_csv()
</code></pre>
<h2 data-id="heading-5">自动化脚本开发原则</h2>
<ol>
<li>可靠性设计</li>
<li>用户体验</li>
<li>维护性考虑</li>
<li>安全性保障</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python函数式编程：优雅的代码艺术]]></title>    <link>https://juejin.cn/post/7576893180080734250</link>    <guid>https://juejin.cn/post/7576893180080734250</guid>    <pubDate>2025-11-26T16:17:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576893180080734250" data-draft-id="7576859345935614006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python函数式编程：优雅的代码艺术"/> <meta itemprop="keywords" content="Python,PyCharm"/> <meta itemprop="datePublished" content="2025-11-26T16:17:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BBB努力学习程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python函数式编程：优雅的代码艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BBB努力学习程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T16:17:30.000Z" title="Wed Nov 26 2025 16:17:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p>想象一下，如果编程就像搭积木一样，通过组合简单的模块来构建复杂的功能，而不是编写冗长的指令序列。这正是函数式编程的魅力所在！它不仅仅是一种技术，更是一种思维方式，让代码变得更简洁、更可预测、更易于理解。</p>
<h2 data-id="heading-0">函数式编程的核心理念</h2>
<ul>
<li>不变性：数据的安全保障</li>
<li>纯函数：相同的输入，永远得到相同的输出</li>
<li>函数是最重要的</li>
</ul>
<h2 data-id="heading-1">实战代码：函数式编程的实践</h2>
<h3 data-id="heading-2">基础函数式操作</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 传统方式 vs 函数式方式</span>

<span class="hljs-comment"># 传统命令式编程</span>
numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>]

<span class="hljs-comment"># 筛选偶数并计算平方</span>
result_imperative = []
<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> numbers:
    <span class="hljs-keyword">if</span> num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:
        result_imperative.append(num ** <span class="hljs-number">2</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"命令式结果: <span class="hljs-subst">{result_imperative}</span>"</span>)

<span class="hljs-comment"># 函数式编程方式</span>
result_functional = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x ** <span class="hljs-number">2</span>, 
                           <span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>, numbers)))

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数式结果: <span class="hljs-subst">{result_functional}</span>"</span>)

<span class="hljs-comment"># 更清晰的写法（使用生成器表达式）</span>
result_clear = [x ** <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> numbers <span class="hljs-keyword">if</span> x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"清晰写法: <span class="hljs-subst">{result_clear}</span>"</span>)
</code></pre>
<h3 data-id="heading-3">高阶函数应用</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> reduce
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Callable</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compose</span>(<span class="hljs-params">*functions: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:
    <span class="hljs-string">"""函数组合：将多个函数组合成一个新函数"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">composed</span>(<span class="hljs-params">arg</span>):
        result = arg
        <span class="hljs-keyword">for</span> func <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(functions):
            result = func(result)
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> composed

<span class="hljs-keyword">def</span> <span class="hljs-title function_">pipe</span>(<span class="hljs-params">*functions: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:
    <span class="hljs-string">"""管道操作：从左到右执行函数序列"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">piped</span>(<span class="hljs-params">arg</span>):
        result = arg
        <span class="hljs-keyword">for</span> func <span class="hljs-keyword">in</span> functions:
            result = func(result)
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> piped

<span class="hljs-comment"># 创建一些小的纯函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">int</span>], <span class="hljs-built_in">int</span>]:
    <span class="hljs-string">"""柯里化的加法函数"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">lambda</span> y: x + y

<span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">x: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">int</span>], <span class="hljs-built_in">int</span>]:
    <span class="hljs-string">"""柯里化的乘法函数"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">lambda</span> y: x * y

<span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_even</span>(<span class="hljs-params">numbers: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]:
    <span class="hljs-string">"""筛选偶数"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>, numbers))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">square_all</span>(<span class="hljs-params">numbers: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]:
    <span class="hljs-string">"""对所有数字求平方"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x ** <span class="hljs-number">2</span>, numbers))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sum_all</span>(<span class="hljs-params">numbers: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""求和"""</span>
    <span class="hljs-keyword">return</span> reduce(<span class="hljs-keyword">lambda</span> x, y: x + y, numbers, <span class="hljs-number">0</span>)

<span class="hljs-comment"># 使用函数组合构建复杂操作</span>
process_numbers = pipe(
    filter_even,    <span class="hljs-comment"># 第一步：筛选偶数</span>
    square_all,     <span class="hljs-comment"># 第二步：求平方</span>
    sum_all         <span class="hljs-comment"># 第三步：求和</span>
)

<span class="hljs-comment"># 测试函数组合</span>
numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]
result = process_numbers(numbers)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理结果: <span class="hljs-subst">{result}</span>"</span>)  <span class="hljs-comment"># 4 + 16 + 36 = 56</span>

<span class="hljs-comment"># 柯里化函数的使用</span>
add_five = add(<span class="hljs-number">5</span>)
multiply_by_three = multiply(<span class="hljs-number">3</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5 + 10 = <span class="hljs-subst">{add_five(<span class="hljs-number">10</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"3 × 7 = <span class="hljs-subst">{multiply_by_three(<span class="hljs-number">7</span>)}</span>"</span>)

<span class="hljs-comment"># 组合柯里化函数</span>
add_then_multiply = compose(multiply_by_three, add_five)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"(5 + 10) × 3 = <span class="hljs-subst">{add_then_multiply(<span class="hljs-number">10</span>)}</span>"</span>)
</code></pre>
<h3 data-id="heading-4">不可变数据结构</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">List</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> copy <span class="hljs-keyword">import</span> deepcopy

<span class="hljs-keyword">def</span> <span class="hljs-title function_">update_in</span>(<span class="hljs-params">data: <span class="hljs-type">Dict</span>, keys: <span class="hljs-type">List</span>, value: <span class="hljs-type">Any</span></span>) -&gt; <span class="hljs-type">Dict</span>:
    <span class="hljs-string">"""不可变地更新嵌套字典的特定路径"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(keys) == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> value
    
    key = keys[<span class="hljs-number">0</span>]
    remaining_keys = keys[<span class="hljs-number">1</span>:]
    
    <span class="hljs-comment"># 创建数据的深拷贝</span>
    new_data = deepcopy(data)
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(new_data, <span class="hljs-built_in">dict</span>):
        <span class="hljs-keyword">if</span> key <span class="hljs-keyword">in</span> new_data:
            new_data[key] = update_in(new_data[key], remaining_keys, value)
        <span class="hljs-keyword">else</span>:
            new_data[key] = update_in({}, remaining_keys, value)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 如果不是字典，创建新的字典结构</span>
        new_data = {key: update_in({}, remaining_keys, value)}
    
    <span class="hljs-keyword">return</span> new_data

<span class="hljs-keyword">def</span> <span class="hljs-title function_">assoc</span>(<span class="hljs-params">data: <span class="hljs-type">Dict</span>, key: <span class="hljs-built_in">str</span>, value: <span class="hljs-type">Any</span></span>) -&gt; <span class="hljs-type">Dict</span>:
    <span class="hljs-string">"""不可变地设置字典键值"""</span>
    new_data = data.copy()
    new_data[key] = value
    <span class="hljs-keyword">return</span> new_data

<span class="hljs-keyword">def</span> <span class="hljs-title function_">dissoc</span>(<span class="hljs-params">data: <span class="hljs-type">Dict</span>, key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>:
    <span class="hljs-string">"""不可变地删除字典键"""</span>
    new_data = data.copy()
    <span class="hljs-keyword">if</span> key <span class="hljs-keyword">in</span> new_data:
        <span class="hljs-keyword">del</span> new_data[key]
    <span class="hljs-keyword">return</span> new_data

<span class="hljs-comment"># 使用不可变数据操作</span>
user_data = {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"张三"</span>,
    <span class="hljs-string">"age"</span>: <span class="hljs-number">25</span>,
    <span class="hljs-string">"address"</span>: {
        <span class="hljs-string">"city"</span>: <span class="hljs-string">"北京"</span>,
        <span class="hljs-string">"street"</span>: <span class="hljs-string">"朝阳路"</span>
    },
    <span class="hljs-string">"hobbies"</span>: [<span class="hljs-string">"阅读"</span>, <span class="hljs-string">"编程"</span>]
}

<span class="hljs-built_in">print</span>(<span class="hljs-string">"原始数据:"</span>, user_data)

<span class="hljs-comment"># 不可变更新</span>
new_user = assoc(user_data, <span class="hljs-string">"age"</span>, <span class="hljs-number">26</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"更新年龄后:"</span>, new_user)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"原始数据未改变:"</span>, user_data[<span class="hljs-string">"age"</span>])

<span class="hljs-comment"># 删除属性</span>
user_without_age = dissoc(user_data, <span class="hljs-string">"age"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"删除年龄后:"</span>, user_without_age)

<span class="hljs-comment"># 深层更新</span>
updated_user = update_in(user_data, [<span class="hljs-string">"address"</span>, <span class="hljs-string">"city"</span>], <span class="hljs-string">"上海"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"更新城市后:"</span>, updated_user)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"原始地址未改变:"</span>, user_data[<span class="hljs-string">"address"</span>][<span class="hljs-string">"city"</span>])
</code></pre>
<h3 data-id="heading-5">函数式数据处理</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial
<span class="hljs-keyword">from</span> operator <span class="hljs-keyword">import</span> itemgetter, attrgetter

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, price: <span class="hljs-built_in">float</span>, category: <span class="hljs-built_in">str</span></span>):
        self.name = name
        self.price = price
        self.category = category
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Product(<span class="hljs-subst">{self.name}</span>, $<span class="hljs-subst">{self.price}</span>, <span class="hljs-subst">{self.category}</span>)"</span>

<span class="hljs-comment"># 创建产品列表</span>
products = [
    Product(<span class="hljs-string">"笔记本电脑"</span>, <span class="hljs-number">5999</span>, <span class="hljs-string">"电子产品"</span>),
    Product(<span class="hljs-string">"智能手机"</span>, <span class="hljs-number">3999</span>, <span class="hljs-string">"电子产品"</span>),
    Product(<span class="hljs-string">"书籍"</span>, <span class="hljs-number">49</span>, <span class="hljs-string">"文教用品"</span>),
    Product(<span class="hljs-string">"咖啡"</span>, <span class="hljs-number">35</span>, <span class="hljs-string">"食品饮料"</span>),
    Product(<span class="hljs-string">"鼠标"</span>, <span class="hljs-number">89</span>, <span class="hljs-string">"电子产品"</span>),
    Product(<span class="hljs-string">"笔记本"</span>, <span class="hljs-number">15</span>, <span class="hljs-string">"文教用品"</span>)
]

<span class="hljs-comment"># 函数式数据处理管道</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_data_pipeline</span>(<span class="hljs-params">*transformations</span>):
    <span class="hljs-string">"""创建数据处理管道"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pipeline</span>(<span class="hljs-params">data</span>):
        <span class="hljs-keyword">return</span> reduce(<span class="hljs-keyword">lambda</span> d, transform: transform(d), 
                     transformations, data)
    <span class="hljs-keyword">return</span> pipeline

<span class="hljs-comment"># 各种数据处理函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_by_category</span>(<span class="hljs-params">category: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""按类别筛选的柯里化函数"""</span>
    <span class="hljs-keyword">return</span> partial(<span class="hljs-built_in">filter</span>, <span class="hljs-keyword">lambda</span> p: p.category == category)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_by_price</span>(<span class="hljs-params">max_price: <span class="hljs-built_in">float</span></span>):
    <span class="hljs-string">"""按价格筛选的柯里化函数"""</span>
    <span class="hljs-keyword">return</span> partial(<span class="hljs-built_in">filter</span>, <span class="hljs-keyword">lambda</span> p: p.price &lt;= max_price)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sort_by_price</span>(<span class="hljs-params">descending: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>):
    <span class="hljs-string">"""按价格排序的柯里化函数"""</span>
    <span class="hljs-keyword">return</span> partial(<span class="hljs-built_in">sorted</span>, key=attrgetter(<span class="hljs-string">'price'</span>), reverse=descending)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_names</span>():
    <span class="hljs-string">"""提取产品名称"""</span>
    <span class="hljs-keyword">return</span> partial(<span class="hljs-built_in">map</span>, attrgetter(<span class="hljs-string">'name'</span>))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_total_price</span>():
    <span class="hljs-string">"""计算总价格"""</span>
    <span class="hljs-keyword">return</span> partial(reduce, <span class="hljs-keyword">lambda</span> total, p: total + p.price)

<span class="hljs-comment"># 构建复杂的数据处理管道</span>
affordable_electronics = create_data_pipeline(
    filter_by_category(<span class="hljs-string">"电子产品"</span>),
    filter_by_price(<span class="hljs-number">5000</span>),
    sort_by_price(descending=<span class="hljs-literal">True</span>)
)

cheap_product_names = create_data_pipeline(
    filter_by_price(<span class="hljs-number">100</span>),
    get_names(),
    <span class="hljs-built_in">list</span>
)

total_electronics_price = create_data_pipeline(
    filter_by_category(<span class="hljs-string">"电子产品"</span>),
    calculate_total_price()
)

<span class="hljs-comment"># 使用数据处理管道</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"实惠的电子产品:"</span>)
<span class="hljs-keyword">for</span> product <span class="hljs-keyword">in</span> affordable_electronics(products):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{product}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n便宜商品名称: <span class="hljs-subst">{<span class="hljs-built_in">list</span>(cheap_product_names(products))}</span>"</span>)

<span class="hljs-comment"># 注意：calculate_total_price 返回的是reduce函数，需要传入初始值0</span>
electronics_price = total_electronics_price(products)(<span class="hljs-number">0</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"电子产品总价: $<span class="hljs-subst">{electronics_price}</span>"</span>)
</code></pre>
<h3 data-id="heading-6">递归和惰性求值</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> itertools <span class="hljs-keyword">import</span> islice

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci</span>():
    <span class="hljs-string">"""生成无限斐波那契数列（惰性求值）"""</span>
    a, b = <span class="hljs-number">0</span>, <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">yield</span> a
        a, b = b, a + b

<span class="hljs-keyword">def</span> <span class="hljs-title function_">recursive_sum</span>(<span class="hljs-params">numbers: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""递归方式求和"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> numbers:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> numbers[<span class="hljs-number">0</span>] + recursive_sum(numbers[<span class="hljs-number">1</span>:])

<span class="hljs-keyword">def</span> <span class="hljs-title function_">recursive_max</span>(<span class="hljs-params">numbers: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""递归方式求最大值"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(numbers) == <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> numbers[<span class="hljs-number">0</span>]
    
    rest_max = recursive_max(numbers[<span class="hljs-number">1</span>:])
    <span class="hljs-keyword">return</span> numbers[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> numbers[<span class="hljs-number">0</span>] &gt; rest_max <span class="hljs-keyword">else</span> rest_max

<span class="hljs-keyword">def</span> <span class="hljs-title function_">trampoline</span>(<span class="hljs-params">func</span>):
    <span class="hljs-string">"""蹦床函数：优化递归，防止栈溢出"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">trampolined</span>(<span class="hljs-params">*args, **kwargs</span>):
        result = func(*args, **kwargs)
        <span class="hljs-keyword">while</span> <span class="hljs-built_in">callable</span>(result):
            result = result()
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> trampolined

<span class="hljs-comment"># 使用惰性序列</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"斐波那契数列前10项:"</span>)
fib_sequence = islice(fibonacci(), <span class="hljs-number">10</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">list</span>(fib_sequence))

<span class="hljs-comment"># 使用递归函数</span>
numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"递归求和: <span class="hljs-subst">{recursive_sum(numbers)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"递归求最大值: <span class="hljs-subst">{recursive_max(numbers)}</span>"</span>)

<span class="hljs-comment"># 记忆化装饰器（缓存函数结果）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">memoize</span>(<span class="hljs-params">func</span>):
    <span class="hljs-string">"""记忆化装饰器：缓存函数计算结果"""</span>
    cache = {}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">memoized</span>(<span class="hljs-params">*args</span>):
        <span class="hljs-keyword">if</span> args <span class="hljs-keyword">in</span> cache:
            <span class="hljs-keyword">return</span> cache[args]
        result = func(*args)
        cache[args] = result
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">return</span> memoized

<span class="hljs-meta">@memoize</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">n: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""记忆化的阶乘函数"""</span>
    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> n * factorial(n - <span class="hljs-number">1</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n记忆化阶乘:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5! = <span class="hljs-subst">{factorial(<span class="hljs-number">5</span>)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"10! = <span class="hljs-subst">{factorial(<span class="hljs-number">10</span>)}</span>"</span>)
<span class="hljs-comment"># 第二次调用会使用缓存</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"5! (缓存) = <span class="hljs-subst">{factorial(<span class="hljs-number">5</span>)}</span>"</span>)
</code></pre>
<h2 data-id="heading-7">函数式编程原则</h2>
<ol>
<li>纯函数优先</li>
<li>不可变性原则</li>
<li>声明式编程</li>
<li>组合优于继承</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么C++项目偏爱.cxx扩展名：从MongoDB驱动说起]]></title>    <link>https://juejin.cn/post/7576894999095689243</link>    <guid>https://juejin.cn/post/7576894999095689243</guid>    <pubDate>2025-11-27T01:02:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576894999095689243" data-draft-id="7576894999095656475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么C++项目偏爱.cxx扩展名：从MongoDB驱动说起"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-11-27T01:02:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么C++项目偏爱.cxx扩展名：从MongoDB驱动说起
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T01:02:37.000Z" title="Thu Nov 27 2025 01:02:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：C++扩展名选用.cxx而非.cpp，源于Unix历史：cpp命令早被C预处理器占用，为避免冲突衍生出.cxx、.cc等变体。mongocxx遵循这一传统，体现了C++生态的历史传承。现代项目虽多用.cpp，但.cxx仍是老牌库的常见选择，构建工具均能妥善支持。</p>
<h2 data-id="heading-0">为什么C++项目偏爱.cxx扩展名：从MongoDB驱动说起</h2>
<h3 data-id="heading-1">一个令人困惑的发现</h3>
<p>当你第一次接触MongoDB的C++驱动时，可能会感到疑惑：为什么它叫<code>mongocxx</code>而不是更直观的<code>mongocpp</code>？这背后其实隐藏着C++发展史上的一段有趣故事。</p>
<h3 data-id="heading-2">罪魁祸首：被占用的<code>cpp</code>命令</h3>
<h4 data-id="heading-3">Unix系统的历史遗产</h4>
<p>在Unix/Linux系统中，<code>cpp</code>这个命令名早在上世纪70年代就被C预处理器（C Preprocessor）占据了：</p>
<pre><code class="hljs language-bash" lang="bash">$ <span class="hljs-built_in">which</span> cpp
/usr/bin/cpp

$ cpp --version
cpp (GCC) 9.3.0
Copyright © 2020 Free Software Foundation, Inc.
</code></pre>
<h4 data-id="heading-4">命名冲突的现实困境</h4>
<p>如果C++编译器也命名为<code>cpp</code>，会导致严重混乱：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 假设两个命令都叫cpp，会发生什么？</span>
cpp my_program.cpp    <span class="hljs-comment"># 这是调用预处理器还是编译器？</span>
</code></pre>
<p>这种冲突在构建工具和Makefile中尤为明显，系统无法区分你到底要调用哪个工具。</p>
<h3 data-id="heading-5">C++扩展名的"战国时代"</h3>
<p>为了避免与预处理器冲突，C++社区出现了多种文件扩展名：</p>
<h4 data-id="heading-6">各派系之争</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 1. .cpp 派 (现在的主流)</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-comment">// 多数现代IDE和构建系统首选</span>

<span class="hljs-comment">// 2. .cxx 派 (mongocxx的选择)  </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mongocxx/client.hpp&gt;</span></span>
<span class="hljs-comment">// 常见于老牌项目和Unix传统</span>

<span class="hljs-comment">// 3. .cc 派 (Google风格)</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"base/logging.h"</span></span>
<span class="hljs-comment">// Google内部代码规范要求</span>

<span class="hljs-comment">// 4. 其他变体</span>
file.C     <span class="hljs-comment">// 区分大小写的系统</span>
file.c++   <span class="hljs-comment">// 较少使用</span>
</code></pre>
<h4 data-id="heading-7">编译器的兼容性</h4>
<p>各大编译器都对各种扩展名提供了支持：</p>
<pre><code class="hljs language-bash" lang="bash">g++ -c file.cxx        <span class="hljs-comment"># 编译.cxx文件</span>
g++ -c file.cc         <span class="hljs-comment"># 编译.cc文件  </span>
clang++ -c file.cpp    <span class="hljs-comment"># 编译.cpp文件</span>
</code></pre>
<h3 data-id="heading-8">mongocxx的命名逻辑</h3>
<h4 data-id="heading-9">保持历史一致性</h4>
<p>MongoDB驱动遵循了传统的命名规范：</p>
<pre><code class="hljs language-scss" lang="scss">mongoc     → C语言驱动 (基础层)
└── mongocxx → C++驱动 (基于C驱动的封装)
</code></pre>
<h4 data-id="heading-10">项目结构体现</h4>
<pre><code class="hljs language-bash" lang="bash">mongocxx/
├── src/mongocxx/  <span class="hljs-comment"># C++头文件使用.hpp</span>
│   └── client.hpp
├── <span class="hljs-built_in">test</span>/          <span class="hljs-comment"># 测试代码可能使用.cxx</span>
│   └── test_client.cxx
└── CMakeLists.txt <span class="hljs-comment"># 构建配置处理各种扩展名</span>
</code></pre>
<h3 data-id="heading-11">现代开发中的现状</h3>
<h4 data-id="heading-12">现状分析</h4>
<p>虽然<code>.cpp</code>已成为事实上的主流标准，但很多历史悠久的项目仍然保持传统：</p>

























<table><thead><tr><th>项目类型</th><th>常用扩展名</th><th>说明</th></tr></thead><tbody><tr><td>新启动项目</td><td>.cpp</td><td>现代IDE和构建系统友好</td></tr><tr><td>老牌库项目</td><td>.cxx/.cc</td><td>保持历史一致性</td></tr><tr><td>Google相关</td><td>.cc</td><td>遵循内部代码规范</td></tr></tbody></table>
<h4 data-id="heading-13">构建系统的适应性</h4>
<p>现代构建系统都能正确处理各种扩展名：</p>
<pre><code class="hljs language-cmake" lang="cmake"># CMake自动识别所有C++扩展名
add_library(mongocxx 
    src/file1.cxx
    src/file2.cpp  
    src/file3.cc
)

# 或者明确指定
set(CMAKE_CXX_EXTENSIONS .cxx .cpp .cc)
</code></pre>
<h3 data-id="heading-14">实践建议</h3>
<h4 data-id="heading-15">对于新项目</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 推荐使用.cpp，因为：</span>
<span class="hljs-comment"># 1. 更广泛的工具支持</span>
<span class="hljs-comment"># 2. 更直观的命名</span>
<span class="hljs-comment"># 3. 社区主流选择</span>
my_program.cpp
</code></pre>
<h4 data-id="heading-16">理解老项目</h4>
<p>当你遇到<code>.cxx</code>扩展名时，现在应该明白：</p>
<ul>
<li>这不是标新立异，而是历史传承</li>
<li>不影响代码功能和性能</li>
<li>构建工具都能正常处理</li>
</ul>
<h3 data-id="heading-17">结语</h3>
<p><code>mongocxx</code>的命名选择反映了C++语言的演进历史。从今天的视角看，<code>.cxx</code>可能显得有些"老派"，但它承载了C++从Unix实验室走向全世界的完整历程。</p>
<p>这种命名上的多样性，恰恰体现了C++生态的丰富性和兼容性——无论是现代的<code>.cpp</code>还是传统的<code>.cxx</code>，都能在同一个项目中和谐共存，共同构建强大的软件系统。</p>
<p>所以下次看到<code>.cxx</code>扩展名时，你不必困惑，只需会心一笑：这是一个经历过C++"战国时代"的老兵。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Mac 自动定时打开指定URL（无日历版）操作文档]]></title>    <link>https://juejin.cn/post/7576894778572849187</link>    <guid>https://juejin.cn/post/7576894778572849187</guid>    <pubDate>2025-11-27T02:20:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576894778572849187" data-draft-id="7576929700841275401" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Mac 自动定时打开指定URL（无日历版）操作文档"/> <meta itemprop="keywords" content="macOS"/> <meta itemprop="datePublished" content="2025-11-27T02:20:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="学习非暴力沟通的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/4183005583377070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Mac 自动定时打开指定URL（无日历版）操作文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4183005583377070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    学习非暴力沟通的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T02:20:59.000Z" title="Thu Nov 27 2025 02:20:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你提供的内容本身已采用 Markdown 语法撰写，我已对格式进行了细微优化（如统一代码块样式、确保标题层级一致性），以下是可直接使用的完整 Markdown 文档：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Mac 自动定时打开指定URL（无日历版）操作文档</span>
<span class="hljs-section">## 一、操作目标</span>
无需依赖日历，通过 Mac 自带「自动操作」+「LaunchAgent」，实现每天 <span class="hljs-strong">**9:00、10:00、11:00、14:00、15:00、16:00、17:00**</span> 自动用默认浏览器打开目标飞书链接：<span class="hljs-code">`https://hav4xarv6k.feishu.cn/share/base/form/shrcnRbIxP9bnHct1X1aCiKjYyc`</span>


<span class="hljs-section">## 二、前置准备</span>
<span class="hljs-bullet">1.</span> 确认 Mac 登录用户名：打开「系统设置」→「用户与群组」，记录当前用户名（示例中用户名为 <span class="hljs-code">`lixing`</span>，后续需替换为你的实际用户名）。
<span class="hljs-bullet">2.</span> 确保目标浏览器为系统默认：打开「系统设置」→「通用」→「默认网页浏览器」，选择常用浏览器（如 Safari、Chrome）。


<span class="hljs-section">## 三、关键前置：打开 Mac 隐藏的「资源库（Library）」</span>
Mac 中的「资源库（Library）」是核心文件夹，存放脚本、配置文件等关键内容，默认隐藏。后续步骤需多次用到，以下是 2 种常用打开方式：

<span class="hljs-section">### 方式1：通过「前往文件夹」直接跳转（最快）</span>
<span class="hljs-bullet">1.</span> 打开「Finder」（点击桌面底部 Dock 栏的蓝色笑脸图标）。
<span class="hljs-bullet">2.</span> 按快捷键 <span class="hljs-strong">**Command + Shift + G**</span>，弹出「前往文件夹」对话框。
<span class="hljs-bullet">3.</span> 输入目标路径（根据需求选择）：
<span class="hljs-bullet">   -</span> 打开「用户资源库」（后续主要用此路径）：输入 <span class="hljs-code">`~/Library`</span>，点击「前往」。
<span class="hljs-bullet">   -</span> 打开「系统资源库」（极少用到）：输入 <span class="hljs-code">`/Library`</span>，点击「前往」。
<span class="hljs-bullet">4.</span> 对话框会直接跳转到对应的「资源库」文件夹，无需手动查找。

<span class="hljs-section">### 方式2：通过终端命令打开（适合习惯用终端的用户）</span>
<span class="hljs-bullet">1.</span> 打开「终端」（通过 Spotlight 搜索“终端”启动，或在「应用程序→实用工具」中找到）。
<span class="hljs-bullet">2.</span> 输入以下命令（打开用户资源库），按回车：
   <span class="hljs-code">```bash
   open ~/Library
</span></code></pre>
<ol start="3">
<li>系统会自动弹出「资源库」文件夹窗口，直接操作即可。</li>
</ol>
<h2 data-id="heading-0">四、详细操作步骤</h2>
<h3 data-id="heading-1">步骤 1：用「自动操作」创建 “打开 URL” 工作流程</h3>
<ol>
<li>
<p>打开「自动操作」：通过 Spotlight 搜索（按 <code>Command+空格</code>，输入 “自动操作”）启动，或在「应用程序→实用工具」中找到并打开。</p>
</li>
<li>
<p>新建工作流程：点击「新建」，选择「工作流程」模板，点击「选取」。</p>
</li>
<li>
<p>添加 “运行 AppleScript” 操作：</p>
<ol>
<li>
<p>在左侧「操作库」搜索栏输入 “运行 AppleScript”，将该操作拖到右侧空白工作区。</p>
</li>
<li>
<p>删除操作中的默认代码，粘贴以下代码（直接内嵌打开 URL 逻辑）：</p>
<ul>
<li>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 目标飞书URL（无需修改）</span>
<span class="hljs-keyword">set</span> targetURL <span class="hljs-keyword">to</span> "https://hav4xarv6k.feishu.cn/share/base/form/shrcnRbIxP9bnHct1X1aCiKjYyc"
<span class="hljs-comment">-- 用默认浏览器打开链接</span>
<span class="hljs-keyword">open</span> location targetURL
<span class="hljs-comment">-- 弹出执行提示（可选，不想显示可删除这两行）</span>
display notification "已自动打开飞书需求表" <span class="hljs-keyword">with</span> title "定时任务完成" sound name "default"
</code></pre>
</li>
</ul>
</li>
<li>
<p>（可选）指定 Chrome 浏览器：若需用 Chrome 打开，将上述代码中 “用默认浏览器打开链接” 的行替换为：</p>
<ul>
<li>
<pre><code class="hljs language-lua" lang="lua">tell application <span class="hljs-string">"/Applications/Google Chrome.app"</span>
    <span class="hljs-built_in">open</span> location targetURL
    activate <span class="hljs-comment">-- 自动激活浏览器窗口</span>
<span class="hljs-keyword">end</span> tell
</code></pre>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p>保存工作流程：</p>
<ol>
<li>按 <code>Command+S</code>，通过「三、关键前置」中的方法打开「用户资源库（~/Library）」。</li>
<li>进入 <code>Library→Scripts</code> 文件夹（若没有 <code>Scripts</code> 文件夹，右键空白处选择「新建文件夹」，命名为 <code>Scripts</code>）。</li>
<li>文件名输入 <code>OpenFeishuURL.workflow</code>（后缀必须为 <code>.workflow</code>，不可修改），点击「存储」。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-2">步骤 2：创建「LaunchAgent」定时配置文件（plist）</h3>
<ol>
<li>
<p>打开「文本编辑」：通过 Spotlight 搜索启动，或在「应用程序」中找到并打开。</p>
</li>
<li>
<p>切换纯文本格式：点击顶部菜单栏「格式」→「制作纯文本」（必须切换，否则配置文件无效）。</p>
</li>
<li>
<p>粘贴配置代码：复制以下 XML 代码，粘贴到文本编辑中，<strong>关键修改 “用户名”</strong> （将 <code>lixing</code> 替换为你的实际用户名）：</p>
<ol>
<li>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">plist</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="hljs-string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">plist</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 任务唯一标识（无需修改） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Label<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>com.user.OpenFeishuURL<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 执行命令：调用自动操作的工作流程（替换用户名） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>ProgramArguments<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/usr/bin/automator<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/Users/lixing/Library/Scripts/OpenFeishuURL.workflow<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 定时规则：每天7个时间点（9/10/11/14/15/16/17点） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>StartCalendarInterval<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Hour<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>9<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Minute<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Hour<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>10<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Minute<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Hour<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Minute<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Hour<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>14<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Minute<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Hour<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>15<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Minute<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Hour<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>16<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Minute<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Hour<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Minute<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">integer</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">integer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 日志路径（用于排查错误，无需修改） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>StandardOutPath<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/tmp/OpenFeishuURL.log<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>StandardErrorPath<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/tmp/OpenFeishuURL.error.log<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plist</span>&gt;</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p>保存配置文件：</p>
<ol>
<li>按 <code>Command+S</code>，通过「三、关键前置」中的方法打开「用户资源库（~/Library）」，进入 <code>LaunchAgents</code> 文件夹（若没有该文件夹，手动新建并命名为 <code>LaunchAgents</code>）。</li>
<li>文件名输入 <code>com.user.OpenFeishuURL.plist</code>（需与代码中「Label」字段一致，不可修改），点击「存储」。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-3">步骤 3：通过终端加载并激活定时任务</h3>
<ol>
<li>
<p>打开「终端」：通过 Spotlight 搜索（输入 “终端”）启动，或在「应用程序→实用工具」中找到。</p>
</li>
<li>
<p>卸载旧任务（若之前加载过）：输入以下命令，按回车（若提示 “找不到服务”，直接跳过）：</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript">launchctl unload ~<span class="hljs-regexp">/Library/</span><span class="hljs-title class_">LaunchAgents</span>/com.<span class="hljs-property">user</span>.<span class="hljs-property">OpenFeishuURL</span>.<span class="hljs-property">plist</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p>加载新任务：输入以下命令，按回车（若提示输入密码，输入 Mac 登录密码，输入时密码不显示，输完直接回车）：</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript">launchctl bootstrap gui/$(id -u) ~<span class="hljs-regexp">/Library/</span><span class="hljs-title class_">LaunchAgents</span>/com.<span class="hljs-property">user</span>.<span class="hljs-property">OpenFeishuURL</span>.<span class="hljs-property">plist</span>
</code></pre>
</li>
<li>若执行后无任何提示，说明加载成功；若有报错，参考「问题排查」部分处理。</li>
</ol>
</li>
<li>
<p>验证加载结果：输入以下命令，按回车，若显示包含 <code>com.user.OpenFeishuURL</code> 的条目，说明加载成功：</p>
<ol>
<li>
<pre><code class="hljs language-perl" lang="perl">launchctl list | <span class="hljs-keyword">grep</span> com.user.OpenFeishuURL
</code></pre>
</li>
</ol>
</li>
<li>
<p>手动测试任务：输入以下命令，按回车，若浏览器自动打开目标 URL，且弹出提示（若未删除提示代码），说明任务正常：</p>
<ol>
<li>
<pre><code class="hljs language-sql" lang="sql">launchctl <span class="hljs-keyword">start</span> com.user.OpenFeishuURL
</code></pre>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-4">五、问题排查</h2>
<h3 data-id="heading-5">1. 加载任务时提示 “Input/output error”</h3>
<ul>
<li>
<p>原因：plist 文件格式错误或路径不正确。</p>
</li>
<li>
<p>解决：</p>
<ul>
<li>
<p>检查 plist 纯文本格式：打开 plist 文件，确认「格式」已勾选「制作纯文本」。</p>
</li>
<li>
<p>验证 XML 语法：在终端输入以下命令，按回车，根据提示修正错误（如 “第 X 行缺少引号”）：</p>
<ol>
<li>
<pre><code class="hljs language-javascript" lang="javascript">plutil ~<span class="hljs-regexp">/Library/</span><span class="hljs-title class_">LaunchAgents</span>/com.<span class="hljs-property">user</span>.<span class="hljs-property">OpenFeishuURL</span>.<span class="hljs-property">plist</span>
</code></pre>
</li>
</ol>
</li>
<li>
<p>确认路径正确：检查 plist 中 <code>ProgramArguments</code> 下的工作流程路径，确保用户名和文件名正确（可在 Finder 中找到文件，拖入终端获取正确路径）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">2. 手动测试时不打开浏览器</h3>
<ul>
<li>
<p>原因：权限不足或浏览器路径错误。</p>
</li>
<li>
<p>解决：</p>
<ul>
<li>检查自动化权限：打开「系统设置→隐私与安全性→自动化」，确保「终端」和「自动操作」已允许访问默认浏览器（如 Safari/Chrome）。</li>
<li>确认浏览器路径：若指定 Chrome，检查代码中 <code>"/Applications/Google Chrome.app"</code> 路径是否正确（若 Chrome 安装在其他位置，需修改路径）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">3. 定时任务到点不执行</h3>
<ul>
<li>
<p>原因：Mac 处于休眠状态或任务未加载。</p>
</li>
<li>
<p>解决：</p>
<ul>
<li>关闭休眠：打开「系统设置→电池→电源适配器」，勾选「防止电脑自动进入睡眠」（笔记本需接电源）。</li>
<li>重新加载任务：按步骤 3 重新执行 “卸载→加载” 命令。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-8">六、后续管理</h2>
<h3 data-id="heading-9">1. 修改定时时间</h3>
<ol>
<li>打开 <code>~/Library/LaunchAgents/com.user.OpenFeishuURL.plist</code> 文件。</li>
<li>修改 <code>StartCalendarInterval</code> 下的 <code>&lt;integer&gt;</code> 数值（如将 <code>9</code> 改为 <code>8</code>，即 8 点执行）。</li>
<li>在终端重新执行 “卸载→加载” 命令，使修改生效。</li>
</ol>
<h3 data-id="heading-10">2. 停止定时任务</h3>
<p>在终端输入以下命令，按回车：</p>
<pre><code class="hljs language-javascript" lang="javascript">launchctl unload ~<span class="hljs-regexp">/Library/</span><span class="hljs-title class_">LaunchAgents</span>/com.<span class="hljs-property">user</span>.<span class="hljs-property">OpenFeishuURL</span>.<span class="hljs-property">plist</span>
</code></pre>
<h3 data-id="heading-11">3. 永久删除任务</h3>
<ol>
<li>
<p>执行 “停止定时任务” 命令。</p>
</li>
<li>
<p>删除两个核心文件：</p>
<ol>
<li>工作流程：<code>~/Library/Scripts/OpenFeishuURL.workflow</code></li>
<li>配置文件：<code>~/Library/LaunchAgents/com.user.OpenFeishuURL.plist</code></li>
</ol>
</li>
</ol>
<pre><code class="hljs language-css" lang="css">你可以直接将上述代码复制到任意 Markdown 编辑器（如 Typora、VS <span class="hljs-selector-tag">Code</span>、飞书文档等）中，即可正常显示标题、列表、代码块等格式。如果需要进一步调整格式（如添加表格、补充注释），或导出为 PDF/Word，都可以基于这个基础版本修改~
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NSQ 磁盘持久队列 DiskQueue 设计思想全解析]]></title>    <link>https://juejin.cn/post/7576914798056898612</link>    <guid>https://juejin.cn/post/7576914798056898612</guid>    <pubDate>2025-11-27T03:38:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576914798056898612" data-draft-id="7576914798056882228" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NSQ 磁盘持久队列 DiskQueue 设计思想全解析"/> <meta itemprop="keywords" content="Go,NSQ"/> <meta itemprop="datePublished" content="2025-11-27T03:38:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想搞艺术的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/860232800801568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NSQ 磁盘持久队列 DiskQueue 设计思想全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/860232800801568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想搞艺术的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:38:39.000Z" title="Thu Nov 27 2025 03:38:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>—— 为什么 NSQ 的 DiskQueue 不用锁也能做到高性能、强一致？</strong></p>
<p>NSQ 的 <code>diskqueue</code> 是一个极其优雅的磁盘持久化 FIFO 队列实现。它的代码不多，却藏着许多工程上的巧思：</p>
<ul>
<li>单调度协程保证线程安全</li>
<li>记录格式简洁高效（长度+数据）</li>
<li>元数据持久化设计稳健</li>
<li>文件滚动策略减少 IO 并保持性能</li>
</ul>
<p>本文从<strong>设计思想</strong>切入，结合源码逐块解析 <code>diskqueue</code> 是如何实现一个可持久、线程安全、性能稳定的磁盘队列。</p>
<hr/>
<h2 data-id="heading-0">1. 单协程调度（ioLoop）保证线程安全：无需加锁</h2>
<p>DiskQueue 的最巧妙设计之一，就是所有写入、读取、同步、文件滚动等操作都在 <strong>一个 ioLoop 协程中完成</strong>。</p>
<p>即使 <code>diskQueue</code> 结构体上存在 <code>RWMutex</code>，但核心变量（read/write position、file num、depth）都只在 ioLoop 中修改，因此<strong>可以不用锁，天然线程安全</strong>。</p>
<p>创建队列时就启动这个协程：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// diskqueue.go: New()</span>
<span class="hljs-keyword">go</span> d.ioLoop()
</code></pre>
<p>来看 ioLoop 的结构：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// diskqueue.go: ioLoop()</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d *diskQueue)</span></span> ioLoop() {
    <span class="hljs-keyword">for</span> {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> data := &lt;-d.writeChan:
            err := d.writeOne(data)
            d.writeResponseChan &lt;- err
        
        <span class="hljs-keyword">case</span> &lt;-d.emptyChan:
            err := d.deleteAllFiles()
            d.emptyResponseChan &lt;- err

        <span class="hljs-keyword">case</span> d.depthChan &lt;- d.depth:
            <span class="hljs-comment">// return depth</span>

        <span class="hljs-comment">// 其他分支：退出、同步等...</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-1">✨ 设计亮点</h4>
<ul>
<li><strong>所有请求都通过 channel 串行进入 ioLoop</strong>
生产者调用 <code>Put()</code> → writeChan → ioLoop → writeOne()</li>
<li><strong>ioLoop 不需要任何互斥锁</strong>
因为写入操作永远在单协程执行，不存在并发修改。</li>
<li><strong>读通道 readChan 也在循环内安全发送</strong></li>
</ul>
<p>这与 Redis 的单线程模型有异曲同工之妙：<strong>串行化换线程安全，避免锁开销</strong>。</p>
<hr/>
<h2 data-id="heading-2">2. 内容数据按（长度+数据）格式写入磁盘</h2>
<p>NSQ 为每条记录写入：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-number">4</span>字节长度（<span class="hljs-type">int32</span> 大端序） + N 字节消息内容
</code></pre>
<h4 data-id="heading-3">写入逻辑在 <code>writeOne()</code>：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// diskqueue.go: writeOne()</span>
dataLen := <span class="hljs-type">int32</span>(<span class="hljs-built_in">len</span>(data))
totalBytes := <span class="hljs-type">int64</span>(<span class="hljs-number">4</span> + dataLen)

<span class="hljs-comment">// 写长度</span>
binary.Write(&amp;d.writeBuf, binary.BigEndian, dataLen)

<span class="hljs-comment">// 写内容</span>
d.writeBuf.Write(data)

<span class="hljs-comment">// 一次性写入文件</span>
_, err = d.writeFile.Write(d.writeBuf.Bytes())
</code></pre>
<h4 data-id="heading-4">为什么采用“长度 + 内容”？</h4>
<ul>
<li>读取时无需扫描分隔符，直接按长度读取 → <strong>高性能顺序读</strong></li>
<li>能快速跳过损坏数据（长度检测） → <strong>增强鲁棒性</strong></li>
<li>二进制格式紧凑 → <strong>磁盘占用小</strong></li>
</ul>
<h4 data-id="heading-5">文件满了会自动滚动</h4>
<p>当 <code>writePos + totalBytes &gt; maxBytesPerFile</code>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> d.writePos &gt; <span class="hljs-number">0</span> &amp;&amp; d.writePos+totalBytes &gt; d.maxBytesPerFile {
    d.writeFileNum++
    d.writePos = <span class="hljs-number">0</span>
    d.sync()
    d.writeFile.Close()
}
</code></pre>
<p>即：<strong>当前文件满 → fsync → 开新文件继续写</strong>。</p>
<hr/>
<h2 data-id="heading-6">3. 元数据持久化：周期性记录读写进度</h2>
<p>为了保证<strong>崩溃后仍能从正确位置恢复</strong>，DiskQueue 会定期将读写指针和 depth 写入 metadata 文件。</p>
<p>元数据内容示例：</p>
<pre><code class="hljs">depth
readFileNum,readPos
writeFileNum,writePos
</code></pre>
<p>对应的写逻辑在：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// diskqueue.go: persistMetaData()</span>
fmt.Fprintf(f, <span class="hljs-string">"%d\n%d,%d\n%d,%d\n"</span>,
    d.depth,
    d.readFileNum, d.readPos,
    d.writeFileNum, d.writePos)
</code></pre>
<p>采用安全的 <strong>tmp file + rename 原子替换</strong>，保证文件内部的数据是完整：</p>
<pre><code class="hljs language-go" lang="go">tmpFileName := fmt.Sprintf(<span class="hljs-string">"%s.%d.tmp"</span>, fileName, rand.Int())
os.Rename(tmpFileName, fileName)  <span class="hljs-comment">// 原子提交</span>
</code></pre>
<p>这样即使在持久化过程中崩溃也不会破坏原有 metadata。</p>
<h4 data-id="heading-7">什么时候会同步？</h4>
<p>两种模式：</p>
<ol>
<li><strong>每写 X 条消息</strong>（通过 syncEvery 配置）</li>
<li><strong>定时 syncTimeout 触发 fsync</strong></li>
</ol>
<p>触发逻辑在 ioLoop 中处理：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> d.needSync &amp;&amp; (writes%syncEvery == <span class="hljs-number">0</span> || time.Since(lastSync) &gt; syncTimeout) {
    d.sync()
}
</code></pre>
<hr/>
<h2 data-id="heading-8">4. 读取记录（一次取一条，同样采用“长度+数据”格式）</h2>
<p>读取逻辑在 <code>readOne()</code>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> msgSize <span class="hljs-type">int32</span>
binary.Read(d.reader, binary.BigEndian, &amp;msgSize)

readBuf := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, msgSize)
io.ReadFull(d.reader, readBuf)
</code></pre>
<p>并计算下一次读取的位置：</p>
<pre><code class="hljs language-go" lang="go">totalBytes := <span class="hljs-type">int64</span>(<span class="hljs-number">4</span> + msgSize)
d.nextReadPos = d.readPos + totalBytes
</code></pre>
<h4 data-id="heading-9">文件滚动</h4>
<p>读取到文件末尾时：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> d.readFileNum &lt; d.writeFileNum &amp;&amp; d.nextReadPos &gt;= d.maxBytesPerFileRead {
    d.nextReadFileNum++
    d.nextReadPos = <span class="hljs-number">0</span>
}
</code></pre>
<p>DiskQueue 会自动切换到下一个文件。</p>
<hr/>
<h2 data-id="heading-10">总结：DiskQueue 以极小的代码实现极稳健的持久化队列</h2>

























<table><thead><tr><th>设计点</th><th>带来的价值</th></tr></thead><tbody><tr><td>ioLoop 单协程串行调度</td><td>无锁、线程安全、高性能</td></tr><tr><td>长度+数据 格式</td><td>顺序读写最高效、格式安全</td></tr><tr><td>文件滚动策略</td><td>提高磁盘局部性，避免巨型文件</td></tr><tr><td>metadata 原子持久化</td><td>崩溃可恢复，不产生部分写入</td></tr></tbody></table>
<p>NSQ 的 DiskQueue 是工程中<strong>小而美、高可靠、高性能</strong>磁盘队列实现的典范，非常值得学习。</p>
<p>如果你正在实现：</p>
<ul>
<li>本地消息队列</li>
<li>任务执行器的持久化存储</li>
<li>分布式系统的持久化 mailbox</li>
<li>WAL / 顺序写日志</li>
</ul>
<p>DiskQueue 都是一个极好的参考。</p>
<blockquote>
<p>nsq的diskqueue源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnsqio%2Fgo-diskqueue%2Fblob%2Fmaster%2Fdiskqueue.go" target="_blank" title="https://github.com/nsqio/go-diskqueue/blob/master/diskqueue.go" ref="nofollow noopener noreferrer">github.com/nsqio/go-di…</a></p>
</blockquote>
<blockquote>
<p>我的小栈：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitart.cn%2Fblogs%2F2025%2Fpractice%2Fnsq-diskqueue-persistent-queue-design-analysis.html" target="_blank" title="https://itart.cn/blogs/2025/practice/nsq-diskqueue-persistent-queue-design-analysis.html" ref="nofollow noopener noreferrer">itart.cn/blogs/2025/…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot CLI 从入门到企业级实战（上下篇）]]></title>    <link>https://juejin.cn/post/7576844295434616841</link>    <guid>https://juejin.cn/post/7576844295434616841</guid>    <pubDate>2025-11-27T00:28:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576844295434616841" data-draft-id="7576863819982323721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot CLI 从入门到企业级实战（上下篇）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T00:28:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大头an"/> <meta itemprop="url" content="https://juejin.cn/user/618374030438861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot CLI 从入门到企业级实战（上下篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/618374030438861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大头an
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T00:28:57.000Z" title="Thu Nov 27 2025 00:28:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot CLI 完全指南（上篇）：从入门到企业级实战</h2>
<h3 data-id="heading-1">前言</h3>
<p>在当今快节奏的软件开发世界中，效率就是竞争力。Spring Boot CLI 作为 Spring 生态中的隐藏瑰宝，能够将项目初始化时间从小时级缩短到秒级，将复杂配置从手动操作变为一键生成。无论你是刚刚接触 Spring Boot 的新手，还是正在构建大型微服务架构的资深架构师，掌握 Spring Boot CLI 都将为你的开发工作流带来革命性的提升。</p>
<p>本指南将带你从 CLI 的基础安装开始，逐步深入到企业级应用实战，最终探索架构师级别的高级用法。让我们开始这段高效开发之旅！</p>
<h3 data-id="heading-2">一、Spring Boot CLI 基础入门</h3>
<h4 data-id="heading-3">1.1 什么是 Spring Boot CLI？</h4>
<p>Spring Boot CLI（命令行接口）是一个强大的开发工具，它通过简化的命令行操作，让 Spring 应用的创建和管理变得前所未有的简单。</p>
<p><strong>核心价值矩阵：</strong></p>
<ul>
<li>⚡ <strong>极致效率</strong> - 项目初始化从想法到运行只需30秒</li>
<li>🎯 <strong>精准控制</strong> - 每个依赖、每个配置都可精确控制</li>
<li>🔄 <strong>一致性保证</strong> - 团队项目结构标准化</li>
<li>🔧 <strong>灵活扩展</strong> - 支持各种复杂场景需求</li>
</ul>
<h4 data-id="heading-4">1.2 安装与配置</h4>
<h5 data-id="heading-5">多平台安装方案</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1：SDKMAN!（推荐）</span>
sdk install springboot
spring --version

<span class="hljs-comment"># 方式2：Homebrew（Mac用户）</span>
brew tap spring-io/tap
brew install spring-boot

<span class="hljs-comment"># 方式3：手动安装</span>
<span class="hljs-comment"># 下载地址：https://repo.spring.io/release/org/springframework/boot/spring-boot-cli/</span>
</code></pre>
<h5 data-id="heading-6">验证安装</h5>
<pre><code class="hljs language-bash" lang="bash">$ spring --version
Spring CLI v3.2.0-SNAPSHOT

$ spring
usage: spring [--<span class="hljs-built_in">help</span>] [--version]
       &lt;<span class="hljs-built_in">command</span>&gt; [&lt;args&gt;]

Available commands are:
  init [options] [location]
    Initialize a new project using Spring Initializr
  encodepassword [options] &lt;password to encode&gt;
    Encode a password <span class="hljs-keyword">for</span> use with Spring Security
  shell
    Start a nested shell
</code></pre>
<h4 data-id="heading-7">1.3 核心命令详解</h4>
<h5 data-id="heading-8">项目初始化（init）</h5>
<p><strong>基础用法：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 简单Web项目</span>
spring init --dependencies=web my-web-app

<span class="hljs-comment"># 包含数据访问的完整项目</span>
spring init --dependencies=web,data-jpa,security my-complete-app
</code></pre>
<p><strong>探索可用选项：</strong></p>
<pre><code class="hljs language-bash" lang="bash">$ spring init --list
=======================================
Capabilities of https://start.spring.io
=======================================

Available dependencies:
-----------------------
web - Web: 全栈Web开发支持
data-jpa - Data JPA: Spring Data JPA 支持
security - Security: Spring Security 安全框架
...

Available project types:
------------------------
maven-project - Maven项目（默认）
gradle-project - Gradle项目
</code></pre>
<h5 data-id="heading-9">项目创建流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[开始项目创建] --&gt; B{选择构建工具}
    B --&gt; C[Maven]
    B --&gt; D[Gradle]
    
    C --&gt; E[配置Maven参数]
    D --&gt; F[配置Gradle参数]
    
    E --&gt; G{选择依赖}
    F --&gt; G
    
    G --&gt; H[Web相关]
    G --&gt; I[数据访问]
    G --&gt; J[安全框架]
    G --&gt; K[监控管理]
    
    H --&gt; L[thymeleaf, web, websocket]
    I --&gt; M[data-jpa, data-mongodb, redis]
    J --&gt; N[security, oauth2-client]
    K --&gt; O[actuator, devtools]
    
    L --&gt; P[生成项目结构]
    M --&gt; P
    N --&gt; P
    O --&gt; P
    
    P --&gt; Q[下载项目文件]
    Q --&gt; R[项目创建完成]
</code></pre>
<h3 data-id="heading-10">二、进阶功能与实战技巧</h3>
<h4 data-id="heading-11">2.1 高级项目配置</h4>
<p><strong>企业级项目配置：</strong></p>
<pre><code class="hljs language-bash" lang="bash">spring init \
  --build=gradle \
  --java-version=17 \
  --group-id=com.company \
  --artifact-id=enterprise-app \
  --name=<span class="hljs-string">"企业级应用"</span> \
  --description=<span class="hljs-string">"基于Spring Boot的企业级应用框架"</span> \
  --dependencies=web,data-jpa,security,redis,actuator \
  --packaging=jar \
  --package-name=com.company.enterprise \
  enterprise-project
</code></pre>
<p><strong>多环境配置模板：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开发环境</span>
spring init --dependencies=web,data-jpa,devtools,h2 dev-project

<span class="hljs-comment"># 生产环境  </span>
spring init --dependencies=web,data-jpa,mysql,actuator prod-project

<span class="hljs-comment"># 测试环境</span>
spring init --dependencies=web,data-jpa,testcontainers test-project
</code></pre>
<h4 data-id="heading-12">2.2 嵌入式 Shell 环境</h4>
<p>Spring Boot CLI 提供强大的交互式 Shell：</p>
<pre><code class="hljs language-bash" lang="bash">$ spring shell
Spring Boot (v3.2.0-SNAPSHOT)
Hit TAB to complete. Type <span class="hljs-string">'help'</span> and hit RETURN <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>, and <span class="hljs-string">'exit'</span> to quit.

<span class="hljs-comment"># 在Shell中直接操作</span>
$&gt; version
Spring CLI v3.2.0-SNAPSHOT

$&gt; init --dependencies=web demo-app
Using service at https://start.spring.io
Project extracted to <span class="hljs-string">'/path/to/demo-app'</span>

$&gt; !<span class="hljs-built_in">ls</span> -la  <span class="hljs-comment"># 执行本地命令</span>
</code></pre>
<h4 data-id="heading-13">2.3 批量项目生成</h4>
<p><strong>微服务批量创建脚本：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># create-microservices.sh</span>

services=(<span class="hljs-string">"user"</span> <span class="hljs-string">"order"</span> <span class="hljs-string">"product"</span> <span class="hljs-string">"inventory"</span> <span class="hljs-string">"notification"</span>)

<span class="hljs-keyword">for</span> service <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${services[@]}</span>"</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"创建服务: <span class="hljs-variable">$service</span>-service"</span>
    spring init \
        --dependencies=web,data-jpa,config-client \
        --group-id=com.company \
        --artifact-id=<span class="hljs-string">"<span class="hljs-variable">$service</span>-service"</span> \
        --name=<span class="hljs-string">"<span class="hljs-variable">$service</span>-service"</span> \
        <span class="hljs-string">"<span class="hljs-variable">$service</span>-service"</span> &amp;
<span class="hljs-keyword">done</span>

<span class="hljs-built_in">wait</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"所有服务创建完成！"</span>
</code></pre>
<h3 data-id="heading-14">三、企业级实战应用</h3>
<h4 data-id="heading-15">3.1 微服务生态系统搭建</h4>
<p><strong>完整微服务套件：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># microservice-ecosystem.sh</span>

<span class="hljs-comment"># 基础设施服务</span>
INFRA_SERVICES=(
    <span class="hljs-string">"service-registry:eureka-server"</span>
    <span class="hljs-string">"config-server:config-server"</span> 
    <span class="hljs-string">"api-gateway:cloud-gateway,web"</span>
)

<span class="hljs-comment"># 业务微服务</span>
BUSINESS_SERVICES=(
    <span class="hljs-string">"user-service:web,data-jpa,config-client,validation"</span>
    <span class="hljs-string">"order-service:web,data-jpa,config-client,feign"</span> 
    <span class="hljs-string">"product-service:web,data-jpa,config-client"</span>
)

<span class="hljs-function"><span class="hljs-title">generate_service</span></span>() {
    <span class="hljs-built_in">local</span> service_name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> dependencies=<span class="hljs-variable">$2</span>
    
    spring init \
        --build=gradle \
        --java-version=17 \
        --group-id=com.company.microservices \
        --artifact-id=<span class="hljs-string">"<span class="hljs-variable">$service_name</span>"</span> \
        --name=<span class="hljs-string">"<span class="hljs-variable">$service_name</span>"</span> \
        --dependencies=<span class="hljs-string">"<span class="hljs-variable">$dependencies</span>"</span> \
        <span class="hljs-string">"<span class="hljs-variable">$service_name</span>"</span>
}

<span class="hljs-comment"># 生成所有服务</span>
<span class="hljs-keyword">for</span> service <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${INFRA_SERVICES[@]}</span>"</span>; <span class="hljs-keyword">do</span>
    IFS=<span class="hljs-string">':'</span> <span class="hljs-built_in">read</span> -r name deps &lt;&lt;&lt; <span class="hljs-string">"<span class="hljs-variable">$service</span>"</span>
    generate_service <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$deps</span>"</span> &amp;
<span class="hljs-keyword">done</span>

<span class="hljs-keyword">for</span> service <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${BUSINESS_SERVICES[@]}</span>"</span>; <span class="hljs-keyword">do</span>
    IFS=<span class="hljs-string">':'</span> <span class="hljs-built_in">read</span> -r name deps &lt;&lt;&lt; <span class="hljs-string">"<span class="hljs-variable">$service</span>"</span>  
    generate_service <span class="hljs-string">"<span class="hljs-variable">$name</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$deps</span>"</span> &amp;
<span class="hljs-keyword">done</span>

<span class="hljs-built_in">wait</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"微服务生态系统生成完成！"</span>
</code></pre>
<h4 data-id="heading-16">3.2 企业级开发工作流</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant D as 开发者
    participant C as Spring Boot CLI
    participant S as Spring Initializr
    participant G as Git
    participant CI as CI/CD流水线

    D-&gt;&gt;C: spring init 项目
    C-&gt;&gt;S: 请求项目模板
    S-&gt;&gt;C: 返回项目结构
    C-&gt;&gt;D: 生成项目文件
    D-&gt;&gt;G: git init &amp;&amp; 提交
    G-&gt;&gt;CI: 触发自动化流程
    CI-&gt;&gt;CI: 代码质量检查
    CI-&gt;&gt;CI: 安全合规扫描
    CI-&gt;&gt;CI: 自动化测试
    CI-&gt;&gt;CI: 构建和部署
    CI-&gt;&gt;D: 反馈构建结果
</code></pre>
<h4 data-id="heading-17">3.3 依赖管理策略</h4>
<p><strong>企业级依赖矩阵：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># enterprise-dependencies.yaml</span>
<span class="hljs-attr">profiles:</span>
  <span class="hljs-attr">foundation:</span>
    <span class="hljs-attr">base:</span> <span class="hljs-string">"web,devtools,configuration-processor"</span>
    <span class="hljs-attr">monitoring:</span> <span class="hljs-string">"actuator,metrics,prometheus"</span>
    
  <span class="hljs-attr">persistence:</span>
    <span class="hljs-attr">rdbms:</span> <span class="hljs-string">"data-jpa,h2,mysql"</span>
    <span class="hljs-attr">nosql:</span> <span class="hljs-string">"data-mongodb,data-redis"</span>
    
  <span class="hljs-attr">communication:</span>
    <span class="hljs-attr">rest:</span> <span class="hljs-string">"web,webflux,restdocs"</span>
    <span class="hljs-attr">messaging:</span> <span class="hljs-string">"amqp,kafka"</span>
    
  <span class="hljs-attr">security:</span>
    <span class="hljs-attr">basic:</span> <span class="hljs-string">"security"</span>
    <span class="hljs-attr">oauth2:</span> <span class="hljs-string">"oauth2-client,oauth2-resource-server"</span>
</code></pre>
<h3 data-id="heading-18">四、监控与可观测性</h3>
<h4 data-id="heading-19">4.1 完整的监控栈</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># monitoring-stack-setup.sh</span>

<span class="hljs-comment"># 监控基础设施</span>
spring init --dependencies=actuator,prometheus,micrometer-registry-prometheus \
            --name=<span class="hljs-string">"monitoring-server"</span> \
            monitoring-server

<span class="hljs-comment"># 分布式追踪</span>
spring init --dependencies=web,actuator,sleuth,zipkin \
            --name=<span class="hljs-string">"tracing-server"</span> \ 
            tracing-server

<span class="hljs-comment"># 为业务服务添加监控</span>
<span class="hljs-function"><span class="hljs-title">add_monitoring_to_service</span></span>() {
    <span class="hljs-built_in">local</span> service_dir=<span class="hljs-variable">$1</span>
    
    <span class="hljs-comment"># 添加监控配置</span>
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$service_dir</span>/src/main/resources/application-monitoring.yml"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
management:
  endpoints:
    web:
      exposure:
        include: <span class="hljs-string">"health,info,metrics,prometheus"</span>
  metrics:
    <span class="hljs-built_in">export</span>:
      prometheus:
        enabled: <span class="hljs-literal">true</span>
EOF
}
</code></pre>
<h4 data-id="heading-20">4.2 健康检查架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[应用启动] --&gt; B[就绪探针检查]
    B --&gt; C{是否就绪?}
    C --&gt;|是| D[接收流量]
    C --&gt;|否| E[继续初始化]
    
    F[运行期监控] --&gt; G[存活探针检查]
    G --&gt; H{是否健康?}
    H --&gt;|是| F
    H --&gt;|否| I[重启实例]
    
    J[外部监控] --&gt; K[Prometheus 抓取]
    K --&gt; L[指标存储]
    L --&gt; M[Grafana 展示]
    L --&gt; N[告警触发]
</code></pre>
<h3 data-id="heading-21">总结（上篇）</h3>
<p>通过上篇的学习，我们掌握了 Spring Boot CLI 的核心概念和在企业环境中的基础应用。关键收获包括：</p>
<ol>
<li><strong>🚀 安装配置</strong> - 掌握了多平台安装和验证方法</li>
<li><strong>🛠️ 核心命令</strong> - 熟练使用 init、shell 等关键命令</li>
<li><strong>🏗️ 项目生成</strong> - 学会了单项目和批量项目创建</li>
<li><strong>🔧 企业实践</strong> - 了解了微服务生态系统的搭建方法</li>
<li><strong>📊 监控观测</strong> - 掌握了基本的监控和健康检查配置</li>
</ol>
<p>这些基础技能为下篇的架构师级高级用法打下了坚实基础。在下篇中，我们将深入探讨安全架构、部署流水线、性能优化等高级主题，带你从使用者转变为 Spring Boot CLI 专家。</p>
<hr/>
<h2 data-id="heading-22">Spring Boot CLI 完全指南（下篇）：架构师级高级实战</h2>
<h3 data-id="heading-23">前言</h3>
<p>在掌握了 Spring Boot CLI 的基础用法和企业级实践后，我们将进入更高阶的领域。作为架构师，我们不仅要会使用工具，更要理解如何将工具融入完整的软件开发生命周期，如何设计符合企业标准的安全架构，如何构建可靠的部署流水线，以及如何持续优化系统性能。</p>
<p>下篇将聚焦于架构师视角的 Spring Boot CLI 高级用法，包括安全架构设计、云原生集成、性能优化、合规性检查等关键主题。让我们深入探索，将开发效率提升到新的高度。</p>
<h3 data-id="heading-24">五、安全架构设计</h3>
<h4 data-id="heading-25">5.1 多层次安全防护</h4>
<p><strong>安全服务生成：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># security-architecture.sh</span>

<span class="hljs-comment"># 1. 认证服务</span>
spring init --dependencies=web,data-jpa,security,oauth2-authorization-server,jwt \
            --name=<span class="hljs-string">"auth-server"</span> \
            --package-name=com.company.security.auth \
            auth-server

<span class="hljs-comment"># 2. 资源服务模板  </span>
spring init --dependencies=web,data-jpa,oauth2-resource-server,validation \
            --name=<span class="hljs-string">"resource-server-template"</span> \
            --package-name=com.company.security.resource \
            resource-server-template

<span class="hljs-comment"># 3. API 网关安全</span>
spring init --dependencies=cloud-gateway,oauth2-client,redis,actuator \
            --name=<span class="hljs-string">"secure-gateway"</span> \
            --package-name=com.company.security.gateway \
            secure-gateway
</code></pre>
<h4 data-id="heading-26">5.2 安全合规性检查</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># security-compliance.sh</span>

<span class="hljs-function"><span class="hljs-title">check_security_compliance</span></span>() {
    <span class="hljs-built_in">local</span> project_dir=<span class="hljs-variable">$1</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"检查安全合规性: <span class="hljs-variable">$project_dir</span>"</span>
    
    <span class="hljs-built_in">local</span> score=0
    <span class="hljs-built_in">local</span> total=8
    
    <span class="hljs-comment"># 检查安全依赖</span>
    <span class="hljs-keyword">if</span> grep -q <span class="hljs-string">"spring-boot-starter-security"</span> <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>/build.gradle"</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 包含安全依赖"</span>
        ((score++))
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 检查SSL配置</span>
    <span class="hljs-keyword">if</span> find <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>"</span> -name <span class="hljs-string">"*.yml"</span> | xargs grep -q <span class="hljs-string">"server.ssl"</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ SSL/TLS 配置存在"</span>
        ((score++))
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 计算合规分数</span>
    <span class="hljs-built_in">local</span> compliance_rate=$((score * <span class="hljs-number">100</span> / total))
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"安全合规率: <span class="hljs-variable">$compliance_rate</span>% (<span class="hljs-variable">$score</span>/<span class="hljs-variable">$total</span>)"</span>
    
    <span class="hljs-built_in">return</span> $((compliance_rate &gt;= <span class="hljs-number">80</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>))
}
</code></pre>
<h4 data-id="heading-27">5.3 安全架构流程图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[客户端请求] --&gt; B[API Gateway]
    B --&gt; C{认证检查}
    C --&gt;|未认证| D[重定向到 Auth Server]
    C --&gt;|已认证| E[路由到业务服务]
    
    D --&gt; F[用户登录]
    F --&gt; G[颁发Token]
    G --&gt; B
    
    E --&gt; H[业务服务]
    H --&gt; I[资源服务器验证Token]
    I --&gt; J[访问数据库]
    
    K[监控系统] --&gt; L[安全事件收集]
    L --&gt; M[异常检测]
    M --&gt; N[自动响应]
</code></pre>
<h3 data-id="heading-28">六、云原生与容器化</h3>
<h4 data-id="heading-29">6.1 Kubernetes 就绪配置</h4>
<p><strong>服务网格配置生成：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># service-mesh-setup.sh</span>

<span class="hljs-function"><span class="hljs-title">generate_service_mesh_config</span></span>() {
    <span class="hljs-built_in">local</span> service_name=<span class="hljs-variable">$1</span>
    
    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$service_name</span>/src/main/resources/META-INF"</span>
    
    <span class="hljs-comment"># 生成 Kubernetes 配置</span>
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$service_name</span>/src/main/resources/META-INF/kubernetes.yml"</span> &lt;&lt; <span class="hljs-string">EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $service_name
spec:
  replicas: 2
  selector:
    matchLabels:
      app: $service_name
  template:
    metadata:
      labels:
        app: $service_name
    spec:
      containers:
      - name: $service_name
        image: company/$service_name:latest
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
EOF</span>
}
</code></pre>
<h4 data-id="heading-30">6.2 多环境部署策略</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># deployment-pipeline.sh</span>

<span class="hljs-function"><span class="hljs-title">generate_deployment_config</span></span>() {
    <span class="hljs-built_in">local</span> service_name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> environment=<span class="hljs-variable">$2</span>
    
    <span class="hljs-keyword">case</span> <span class="hljs-variable">$environment</span> <span class="hljs-keyword">in</span>
        <span class="hljs-string">"dev"</span>)
            <span class="hljs-comment"># 开发环境配置</span>
            ;;
        <span class="hljs-string">"prod"</span>)
            <span class="hljs-comment"># 生产环境配置</span>
            ;;
    <span class="hljs-keyword">esac</span>
}

<span class="hljs-comment"># 为所有服务生成多环境配置</span>
SERVICES=(<span class="hljs-string">"user-service"</span> <span class="hljs-string">"order-service"</span> <span class="hljs-string">"product-service"</span>)
ENVIRONMENTS=(<span class="hljs-string">"dev"</span> <span class="hljs-string">"staging"</span> <span class="hljs-string">"prod"</span>)

<span class="hljs-keyword">for</span> service <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${SERVICES[@]}</span>"</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> <span class="hljs-built_in">env</span> <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${ENVIRONMENTS[@]}</span>"</span>; <span class="hljs-keyword">do</span>
        generate_deployment_config <span class="hljs-string">"<span class="hljs-variable">$service</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$env</span>"</span>
    <span class="hljs-keyword">done</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h3 data-id="heading-31">七、性能优化与调优</h3>
<h4 data-id="heading-32">7.1 依赖优化策略</h4>
<p><strong>依赖分析脚本：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># dependency-optimizer.sh</span>

<span class="hljs-function"><span class="hljs-title">analyze_dependencies</span></span>() {
    <span class="hljs-built_in">local</span> project_dir=<span class="hljs-variable">$1</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"分析项目依赖: <span class="hljs-variable">$project_dir</span>"</span>
    
    <span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>/build.gradle"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 提取依赖列表</span>
        <span class="hljs-built_in">local</span> dependencies=$(grep <span class="hljs-string">"implementation"</span> <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>/build.gradle"</span> | <span class="hljs-built_in">wc</span> -l)
        <span class="hljs-built_in">local</span> test_dependencies=$(grep <span class="hljs-string">"testImplementation"</span> <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>/build.gradle"</span> | <span class="hljs-built_in">wc</span> -l)
        
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"实现依赖: <span class="hljs-variable">$dependencies</span> 个"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"测试依赖: <span class="hljs-variable">$test_dependencies</span> 个"</span>
        
        <span class="hljs-comment"># 建议优化</span>
        <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$dependencies</span> -gt 15 ]]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️  建议: 依赖数量较多，考虑模块化拆分"</span>
        <span class="hljs-keyword">fi</span>
        
        <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$test_dependencies</span> -eq 0 ]]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 警告: 缺少测试依赖"</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">fi</span>
}
</code></pre>
<h4 data-id="heading-33">7.2 构建性能优化</h4>
<p><strong>Gradle 构建优化配置：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># build-optimization.sh</span>

<span class="hljs-function"><span class="hljs-title">optimize_gradle_build</span></span>() {
    <span class="hljs-built_in">local</span> project_dir=<span class="hljs-variable">$1</span>
    
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>/gradle.properties"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># 构建性能优化</span>
org.gradle.parallel=<span class="hljs-literal">true</span>
org.gradle.caching=<span class="hljs-literal">true</span>
org.gradle.daemon=<span class="hljs-literal">true</span>
org.gradle.configureondemand=<span class="hljs-literal">true</span>

<span class="hljs-comment"># JVM 配置</span>
org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8

<span class="hljs-comment"># 依赖下载优化</span>
systemProp.http.proxyHost=proxy.company.com
systemProp.http.proxyPort=8080
EOF

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ Gradle 构建配置已优化"</span>
}
</code></pre>
<h4 data-id="heading-34">7.3 应用性能监控</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[应用性能] --&gt; B[JVM 指标]
    A --&gt; C[数据库指标]
    A --&gt; D[HTTP 请求指标]
    
    B --&gt; E[GC 时间]
    B --&gt; F[堆内存使用]
    B --&gt; G[线程状态]
    
    C --&gt; H[查询性能]
    C --&gt; I[连接池状态]
    C --&gt; J[锁等待时间]
    
    D --&gt; K[响应时间]
    D --&gt; L[请求率]
    D --&gt; M[错误率]
    
    E --&gt; N[性能仪表板]
    F --&gt; N
    G --&gt; N
    H --&gt; N
    I --&gt; N
    J --&gt; N
    K --&gt; N
    L --&gt; N
    M --&gt; N
    
    N --&gt; O[自动告警]
    N --&gt; P[容量规划]
</code></pre>
<h3 data-id="heading-35">八、高级定制与扩展</h3>
<h4 data-id="heading-36">8.1 自定义 Initializr 服务</h4>
<p><strong>企业定制化配置：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># custom-initializr-setup.sh</span>

<span class="hljs-comment"># 使用企业内部 Initializr 服务</span>
spring init --target=http://internal-start.company.com \
            --dependencies=web,data-jpa,company-security \
            --<span class="hljs-built_in">type</span>=company-microservice \
            internal-project

<span class="hljs-comment"># 自定义项目类型</span>
spring init --<span class="hljs-built_in">type</span>=company-microservice \
            --dependencies=web,data-jpa,config-client \
            custom-service
</code></pre>
<h4 data-id="heading-37">8.2 CLI 插件开发</h4>
<p><strong>自定义命令示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义 Spring Boot CLI 命令</span>
<span class="hljs-meta">@Order(0)</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompanyInitCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Command</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(ApplicationContext context)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 实现自定义项目初始化逻辑</span>
        System.out.println(<span class="hljs-string">"公司定制化项目初始化..."</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"company-init"</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDescription</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Initialize company standard project"</span>;
    }
}
</code></pre>
<h3 data-id="heading-38">九、架构质量与规范</h3>
<h4 data-id="heading-39">9.1 架构质量评估</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># architecture-quality-assessment.sh</span>

<span class="hljs-function"><span class="hljs-title">assess_architecture_quality</span></span>() {
    <span class="hljs-built_in">local</span> project_dir=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> project_name=<span class="hljs-variable">$2</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"评估架构质量: <span class="hljs-variable">$project_name</span>"</span>
    
    <span class="hljs-built_in">local</span> metrics=()
    
    <span class="hljs-comment"># 依赖数量评估</span>
    <span class="hljs-built_in">local</span> dep_count=$(grep -c <span class="hljs-string">"implementation"</span> <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>/build.gradle"</span>)
    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$dep_count</span> -le 10 ]]; <span class="hljs-keyword">then</span>
        metrics+=(<span class="hljs-string">"✅ 依赖数量合理: <span class="hljs-variable">$dep_count</span>"</span>)
    <span class="hljs-keyword">else</span>
        metrics+=(<span class="hljs-string">"⚠️  依赖数量较多: <span class="hljs-variable">$dep_count</span>"</span>) 
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 配置复杂度评估</span>
    <span class="hljs-built_in">local</span> config_files=$(find <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>/src/main/resources"</span> -name <span class="hljs-string">"*.yml"</span> | <span class="hljs-built_in">wc</span> -l)
    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$config_files</span> -le 3 ]]; <span class="hljs-keyword">then</span>
        metrics+=(<span class="hljs-string">"✅ 配置复杂度低"</span>)
    <span class="hljs-keyword">else</span>
        metrics+=(<span class="hljs-string">"⚠️  配置复杂度中: <span class="hljs-variable">$config_files</span> 个文件"</span>)
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 输出评估结果</span>
    <span class="hljs-keyword">for</span> metric <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${metrics[@]}</span>"</span>; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$metric</span>"</span>
    <span class="hljs-keyword">done</span>
}
</code></pre>
<h4 data-id="heading-40">9.2 代码规范检查</h4>
<p><strong>自动化代码质量检查：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># code-quality-check.sh</span>

<span class="hljs-function"><span class="hljs-title">check_code_quality</span></span>() {
    <span class="hljs-built_in">local</span> project_dir=<span class="hljs-variable">$1</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"检查代码质量: <span class="hljs-variable">$project_dir</span>"</span>
    
    <span class="hljs-comment"># 检查代码结构</span>
    <span class="hljs-keyword">if</span> [[ ! -d <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>/src/main/java"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 缺少标准代码目录结构"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 检查配置文件</span>
    <span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>/src/main/resources/application.yml"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️  建议使用 YAML 格式配置文件"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 检查测试覆盖率</span>
    <span class="hljs-keyword">if</span> [[ ! -d <span class="hljs-string">"<span class="hljs-variable">$project_dir</span>/src/test"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 缺少测试代码"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 代码质量检查通过"</span>
    <span class="hljs-built_in">return</span> 0
}
</code></pre>
<h3 data-id="heading-41">十、完整 DevOps 流水线集成</h3>
<h4 data-id="heading-42">10.1 端到端自动化流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[需求分析] --&gt; B[CLI 项目生成]
    B --&gt; C[代码开发]
    C --&gt; D[自动化测试]
    D --&gt; E[代码审查]
    E --&gt; F[安全扫描]
    F --&gt; G[构建打包]
    G --&gt; H[容器化]
    H --&gt; I[部署到环境]
    I --&gt; J[自动化测试]
    J --&gt; K[性能测试]
    K --&gt; L[生产部署]
    L --&gt; M[监控告警]
    
    subgraph 反馈循环
        M --&gt; N[指标分析]
        N --&gt; O[优化建议]
        O --&gt; B
    end
</code></pre>
<h4 data-id="heading-43">10.2 Jenkins 流水线集成</h4>
<pre><code class="hljs language-groovy" lang="groovy">pipeline {
    agent any
    parameters {
        choice(
            name: 'PROJECT_TYPE',
            choices: ['web-basic', 'microservice', 'full-stack'],
            description: '项目类型'
        )
    }
    stages {
        stage('Generate Project') {
            steps {
                script {
                    def depsMap = [
                        'web-basic': 'web,devtools',
                        'microservice': 'web,data-jpa,config-client',
                        'full-stack': 'web,data-jpa,security,actuator,thymeleaf'
                    ]
                    
                    sh """
                        spring init \
                            --build=gradle \
                            --java-version=17 \
                            --group-id=com.company.\${PROJECT_NAME} \
                            --dependencies=\${depsMap[params.PROJECT_TYPE]} \
                            \${PROJECT_NAME}
                    """
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-44">总结（下篇）</h3>
<p>通过下篇的深入学习，我们掌握了 Spring Boot CLI 在架构师视角下的高级用法：</p>
<h4 data-id="heading-45">🎯 核心成就</h4>
<ol>
<li><strong>🔒 安全架构</strong> - 设计了多层次的安全防护体系</li>
<li><strong>☁️ 云原生集成</strong> - 实现了 Kubernetes 就绪的微服务架构</li>
<li><strong>⚡ 性能优化</strong> - 掌握了依赖优化和构建性能调优</li>
<li><strong>🔧 定制扩展</strong> - 学会了自定义 Initializr 和 CLI 插件开发</li>
<li><strong>📊 质量保障</strong> - 建立了完整的架构质量和代码规范检查体系</li>
<li><strong>🔄 DevOps 集成</strong> - 构建了端到端的自动化流水线</li>
</ol>
<h4 data-id="heading-46">🚀 从工具使用者到效率专家</h4>
<p>Spring Boot CLI 不仅仅是一个项目生成工具，它是现代软件开发理念的体现。通过将 CLI 深度集成到开发流程中，我们实现了：</p>
<ul>
<li><strong>标准化</strong> - 统一团队技术栈和项目结构</li>
<li><strong>自动化</strong> - 减少重复劳动，提升开发效率</li>
<li><strong>可视化</strong> - 清晰的架构流程图和质量评估</li>
<li><strong>可持续</strong> - 建立持续改进的反馈循环</li>
</ul>
<h4 data-id="heading-47">🌟 未来展望</h4>
<p>随着云原生和 AI 技术的不断发展，Spring Boot CLI 也将持续进化。我们可以期待：</p>
<ul>
<li>更智能的依赖推荐和冲突解决</li>
<li>与云平台更深度集成</li>
<li>AI 辅助的项目架构设计</li>
<li>更强大的可观测性集成</li>
</ul>
<p>掌握 Spring Boot CLI，不仅是掌握一个工具，更是拥抱高效、规范的现代软件开发范式。愿你在未来的开发之旅中，持续运用这些技能，构建更加卓越的软件系统。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【已开源】Cursor AI 开发实战：小文件在线互传工具]]></title>    <link>https://juejin.cn/post/7576968345875021851</link>    <guid>https://juejin.cn/post/7576968345875021851</guid>    <pubDate>2025-11-27T05:40:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576968345875021851" data-draft-id="7577189654472474650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【已开源】Cursor AI 开发实战：小文件在线互传工具"/> <meta itemprop="keywords" content="Cursor,AI编程,开源"/> <meta itemprop="datePublished" content="2025-11-27T05:40:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="极客密码"/> <meta itemprop="url" content="https://juejin.cn/user/976022055165608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【已开源】Cursor AI 开发实战：小文件在线互传工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022055165608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    极客密码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T05:40:29.000Z" title="Thu Nov 27 2025 05:40:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>灵机一动 + Cursor + 几个小时 = 一个完整的文件传输工具！这就是 AI 编程的魅力~</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9843123e06b941448177a7d804dc9ced~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764826829&amp;x-signature=9O2lbQ5i2sC2tws%2BGEqUZ7LvvwI%3D" alt="工具首页" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>大家好！今天给大家分享一次<strong>纯纯的 AI 开发实战</strong>。</p>
<p>周末在家闲着没事，突然想到平时工作中经常需要在设备间传文件，或者临时给朋友分享个东西。现有的工具要么太重（百度网盘、微信那种），要么不够安全（公开链接谁都能访问），要么就是要付费。</p>
<p><strong>灵机一动</strong>：能不能做一个轻量级的临时文件传输工具？</p>
<p>然后打开 Cursor，开始和 AI 聊天，<strong>几个小时后</strong>，一个完整的项目就出来了 —— <strong>F2F.icu</strong>！</p>
<p>关键是，整个项目完全基于 <strong>Cloudflare 这个赛博大善人</strong>提供的免费服务，完美的<strong>穷鬼开发者套餐</strong>：不需要买服务器、不需要装数据库、不需要担心流量费用，还自带全球 CDN 加速！</p>
<p><strong>在线体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ff2f.icu" target="_blank" title="https://f2f.icu" ref="nofollow noopener noreferrer">f2f.icu</a></p>
<h2 data-id="heading-1">工具截图</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9843123e06b941448177a7d804dc9ced~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764826829&amp;x-signature=9O2lbQ5i2sC2tws%2BGEqUZ7LvvwI%3D" alt="工具首页" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b04550dc96bc4bdd89ddc5438baafd10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764826829&amp;x-signature=ELWA%2BnRFz5ed6k5T%2BP%2B80jZfc%2FU%3D" alt="发送文件" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3927cc8ebd104c4892b3a447eabf5882~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764826829&amp;x-signature=UKV1p9Vk2tg5u5jJPxWEkpZJnFo%3D" alt="创建分享" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5dceb14c4fe451c92d1b597b0e8b5a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764826829&amp;x-signature=dSAQOYn%2BBEVlLLZfzeNxcFDIuwg%3D" alt="i18n 国际化发送" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f85588d59d648bdb08f651c63df6941~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B5a6i5a-G56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764826829&amp;x-signature=rIh4jmIzUkE9a38qaDyYcoIiypE%3D" alt="i18n 国际化接收" loading="lazy"/></p>
<h2 data-id="heading-2">核心特性</h2>
<p>先说说这个工具有啥亮点：</p>
<h3 data-id="heading-3">1. 极简的使用体验</h3>
<p>整个使用流程超级简单：</p>
<ul>
<li><strong>发送方</strong>：生成一个 6 位分享码 → 上传文件/文本 → 把码给对方</li>
<li><strong>接收方</strong>：输入 6 位取件码 → 一键下载</li>
</ul>
<p>就像快递取件一样，<strong>6 个字符搞定一切</strong>。不用注册登录，不用装 APP，打开网页就能用。</p>
<h3 data-id="heading-4">2. 自动销毁机制</h3>
<p>这个是我最喜欢的设计。数据的生命周期是这样的：</p>
<ul>
<li>上传后如果 <strong>1 小时没人下载</strong> → 自动删除</li>
<li>下载后 <strong>1 分钟</strong> → 自动删除</li>
</ul>
<p>为什么下载后不立即删除？因为考虑到网络不稳定的情况，给用户一个「重新下载」的缓冲时间。这样既保护了隐私，又提供了容错机制。</p>
<h3 data-id="heading-5">3. 完全免费 + 零维护</h3>
<p>这是重点！整个项目完全基于 Cloudflare 的免费服务：</p>
<ul>
<li><strong>Cloudflare Pages</strong>：托管前端（全球 CDN 加速）</li>
<li><strong>Cloudflare Workers</strong>：处理 API 请求（边缘计算）</li>
<li><strong>Cloudflare KV</strong>：存储文件数据（自动 TTL 过期删除）</li>
</ul>
<p>免费额度对个人使用来说完全够用：</p>
<ul>
<li>KV 读取：<strong>每天 10 万次</strong></li>
<li>KV 写入：<strong>每天 1000 次</strong></li>
<li>Workers 请求：<strong>每天 10 万次</strong></li>
</ul>
<p>而且因为用了 KV 的原生 TTL 特性，数据过期自动清理，<strong>完全零维护成本</strong>。</p>
<h2 data-id="heading-6">Cloudflare —— 赛博大善人的穷鬼开发套餐</h2>
<p>这里必须吹一波 Cloudflare。</p>
<p>作为一个穷鬼开发者（bushi），Cloudflare 简直是业界良心：</p>
<ul>
<li><strong>Cloudflare Pages</strong>：免费托管静态网站 + 全球 CDN</li>
<li><strong>Cloudflare Workers</strong>：免费 Serverless 函数（每天 10 万次请求）</li>
<li><strong>Cloudflare KV</strong>：免费键值存储（每天 10 万次读取）</li>
<li><strong>免费 SSL 证书</strong>：自动配置 HTTPS</li>
<li><strong>免费 DDoS 防护</strong>：自带安全防护</li>
</ul>
<p>这套组合拳下来，对于个人项目和小型应用来说，<strong>完全够用而且完全免费</strong>！</p>
<p>不需要绑信用卡（划重点），注册个账号就能用。这你受得了吗？</p>
<p>所以我这个项目从头到尾的成本只有个几块钱的域名费用。</p>
<h2 data-id="heading-7">技术架构</h2>
<p>下面聊聊技术实现，这也是我和 AI 一起讨论出来的方案。</p>
<h3 data-id="heading-8">为什么选 KV 而不是 R2？</h3>
<p>很多人可能会问，Cloudflare 不是有对象存储 R2 吗，为啥不用？</p>
<p>这里我做了个对比：</p>






























<table><thead><tr><th>特性</th><th>KV 存储</th><th>R2 对象存储</th></tr></thead><tbody><tr><td>单文件大小限制</td><td>25MB</td><td>5GB</td></tr><tr><td>TTL 支持</td><td>✅ 原生支持</td><td>❌ 需要手动实现定时清理</td></tr><tr><td>读写延迟</td><td>极低（边缘节点）</td><td>稍高（区域存储）</td></tr><tr><td>免费使用</td><td>✅ 直接用</td><td>❌ 需要绑定信用卡</td></tr></tbody></table>
<p>对于<strong>临时文件传输</strong>这个场景，KV 简直是完美选择：</p>
<ol>
<li><strong>原生 TTL</strong>：上传时直接设置过期时间，到期自动删除，不用写定时任务</li>
<li><strong>25MB 够用</strong>：日常传个文档、图片、小视频完全够</li>
<li><strong>零成本启动</strong>：不需要绑卡，注册就能用</li>
</ol>
<h3 data-id="heading-9">数据流转过程</h3>
<p>整个数据流是这样的：</p>
<pre><code class="hljs">发送方上传
  → 文件转 Base64 编码
  → 存入 KV（TTL: 1小时）
  → 返回分享码

接收方下载
  → 验证分享码
  → 从 KV 读取数据
  → 更新 TTL 为 1 分钟
  → 返回文件/文本
</code></pre>
<p>核心代码其实很简单，以上传为例（简化版）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// functions/api/upload.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">onRequestPost</span>(<span class="hljs-params">{ request, env }</span>) {
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">formData</span>();
  <span class="hljs-keyword">const</span> code = formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">"code"</span>); <span class="hljs-comment">// 6位分享码</span>
  <span class="hljs-keyword">const</span> content = formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">"content"</span>); <span class="hljs-comment">// Base64 内容</span>

  <span class="hljs-comment">// 存入 KV，设置 1 小时过期</span>
  <span class="hljs-keyword">await</span> env.<span class="hljs-property">TRANSFERS</span>.<span class="hljs-title function_">put</span>(
    code,
    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">"file"</span>,
      <span class="hljs-attr">content</span>: content,
      <span class="hljs-attr">fileName</span>: fileName,
      <span class="hljs-attr">downloaded</span>: <span class="hljs-literal">false</span>,
    }),
    {
      <span class="hljs-attr">expirationTtl</span>: <span class="hljs-number">3600</span>, <span class="hljs-comment">// 1小时 = 3600秒</span>
    }
  );

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> }));
}
</code></pre>
<p>下载时：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// functions/api/download.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">onRequestGet</span>(<span class="hljs-params">{ request, env }</span>) {
  <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(request.<span class="hljs-property">url</span>).<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">"code"</span>);

  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> env.<span class="hljs-property">TRANSFERS</span>.<span class="hljs-title function_">get</span>(code);

  <span class="hljs-comment">// 标记为已下载，更新 TTL 为 1 分钟</span>
  <span class="hljs-keyword">await</span> env.<span class="hljs-property">TRANSFERS</span>.<span class="hljs-title function_">put</span>(
    code,
    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      ...data,
      <span class="hljs-attr">downloaded</span>: <span class="hljs-literal">true</span>,
    }),
    {
      <span class="hljs-attr">expirationTtl</span>: <span class="hljs-number">60</span>, <span class="hljs-comment">// 1分钟后自动删除</span>
    }
  );

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
}
</code></pre>
<p>是不是很简洁？KV 的 API 非常易用，而且支持直接设置过期时间，省去了很多额外的清理逻辑。</p>
<h3 data-id="heading-10">前端设计</h3>
<p>前端我用了 Tailwind CSS + 原生 JavaScript，没有引入 Vue/React 这些框架，原因是：</p>
<ol>
<li><strong>体积小</strong>：整个前端打包后不到 100KB</li>
<li><strong>加载快</strong>：静态 HTML，秒开</li>
<li><strong>够用了</strong>：功能不复杂，用不着框架</li>
</ol>
<p>界面设计上追求<strong>极简</strong>：</p>
<ul>
<li>两个 Tab（发送/接收）</li>
<li>三种内容类型（文件/文本/图片）</li>
<li>一键操作（生成码 → 上传 → 分享）</li>
</ul>
<p>支持拖拽上传、粘贴截图（Ctrl/Cmd + V），这些交互细节让使用体验更好。</p>
<h2 data-id="heading-11">安全性考虑</h2>
<p>关于安全，有几点要说明：</p>
<h3 data-id="heading-12">分享码的强度</h3>
<p>6 位字符（A-Z, 0-9）= 36^6 = <strong>21.8 亿种组合</strong></p>
<p>理论上暴力破解的成功率是很低的，而且：</p>
<ul>
<li>数据会自动过期（最多 1 小时）</li>
<li>分享码只能使用一次（下载后 1 分钟删除）</li>
</ul>
<p>所以安全性对于<strong>临时文件传输</strong>场景是够用的。</p>
<h3 data-id="heading-13">使用建议</h3>
<p>虽然有一定安全性，但我还是建议：</p>
<p>⚠️ <strong>不要传输高度敏感信息</strong>（密码、私钥、身份证号等）</p>
<p>这个工具的定位是<strong>轻量级临时文件传输</strong>，适合：</p>
<ul>
<li>发送工作文档</li>
<li>分享照片/截图</li>
<li>传输代码文件</li>
<li>分享文本片段</li>
</ul>
<h2 data-id="heading-14">部署超简单</h2>
<p>说到部署，真的是简单到爆。完全不需要自己的服务器，只需要一个 Cloudflare 账号（免费）：</p>
<h3 data-id="heading-15">Fork + 一键部署</h3>
<ol>
<li>
<p><strong>Fork 我的 GitHub 仓库</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fisnl%2Ff2f" target="_blank" title="https://github.com/isnl/f2f" ref="nofollow noopener noreferrer">github.com/isnl/f2f</a></p>
</li>
<li>
<p><strong>连接到 Cloudflare Pages</strong></p>
<ul>
<li>登录 Cloudflare Dashboard</li>
<li>Workers &amp; Pages → 创建应用 → 连接 Git</li>
<li>选择你 Fork 的仓库</li>
<li>构建配置：输出目录填 <code>public</code></li>
</ul>
</li>
<li>
<p><strong>创建 KV 存储</strong></p>
<ul>
<li>在 KV 板块创建一个命名空间（比如 <code>f2f-transfers</code>）</li>
<li>在 Pages 项目设置中绑定这个 KV（变量名：<code>TRANSFERS</code>）</li>
</ul>
</li>
<li>
<p><strong>完成！</strong></p>
<p>Cloudflare 会给你一个域名，直接访问就能用。如果有自己的域名，还可以绑定自定义域名。</p>
</li>
</ol>
<p>整个过程 <strong>5 分钟搞定</strong>，而且之后不需要任何维护，Cloudflare 自动帮你处理全球分发、HTTPS 证书、数据清理等等。</p>
<h2 data-id="heading-16">一些有趣的优化</h2>
<h3 data-id="heading-17">1. 6 位分享码的设计</h3>
<p>为什么是 6 位？因为：</p>
<ul>
<li>4 位太短（只有 160 万组合，容易碰撞）</li>
<li>8 位太长（用户记忆和输入成本高）</li>
<li>6 位刚刚好（21 亿组合 + 便于记忆）</li>
</ul>
<p>而且只用大写字母和数字（不用小写），避免了 O 和 0、I 和 1 的混淆。</p>
<h3 data-id="heading-18">2. 图片的特殊处理</h3>
<p>对于图片类型，接收方可以直接在页面上预览，而不是强制下载。这样分享截图特别方便，对方打开链接就能看到。</p>
<h3 data-id="heading-19">3. 响应式设计</h3>
<p>全面适配手机、平板、电脑，在手机上的体验也很流畅。经常我在外面用手机传个文件给自己电脑，特别方便。</p>
<h3 data-id="heading-20">4. 国际化支持</h3>
<p>已经内置了中英双语支持（i18n），根据浏览器语言自动切换，代码里也准备了中英文文档。虽然功能简单，但该有的细节都有。</p>
<h2 data-id="heading-21">AI 编程的一些感悟</h2>
<h3 data-id="heading-22">1. AI 是放大器，不是替代品</h3>
<p>AI 让我的开发效率提升了至少 <strong>3-5 倍</strong>，但核心的：</p>
<ul>
<li>需求设计（要做什么）</li>
<li>技术选型（用什么方案）</li>
<li>问题发现（哪里不对劲）</li>
<li>体验优化（怎么做更好）</li>
</ul>
<p>这些还是需要我自己来决策。AI 是个超强的执行助手，但产品思维和技术判断还得靠人。</p>
<h3 data-id="heading-23">2. 会提问很重要</h3>
<p>和 AI 对话式编程，最重要的是<strong>会提问</strong>：</p>
<ul>
<li>❌ "帮我写个上传功能"（太笼统）</li>
<li>✅ "写一个文件上传 API，接收 FormData，验证文件大小不超过 25MB，转 Base64 存到 KV，设置 TTL 为 3600 秒"（清晰明确）</li>
</ul>
<p>问题越具体，AI 给的答案越准确。</p>
<h3 data-id="heading-24">3. 快速迭代才是王道</h3>
<p>有了 AI，我可以快速试错：</p>
<ul>
<li>想到一个功能 → 让 AI 实现 → 测试 → 不满意就换方案</li>
<li>整个过程可能只要几分钟</li>
</ul>
<p>这种快速迭代的能力，在以前是不敢想象的。</p>
<h3 data-id="heading-25">4. 专注于创意和产品</h3>
<p>因为 AI 帮我搞定了大量的"体力活"（写基础代码、调样式、配环境），我可以把更多精力放在：</p>
<ul>
<li>产品体验的打磨</li>
<li>功能细节的优化</li>
<li>用户场景的思考</li>
</ul>
<p>这才是真正有价值的部分。</p>
<h2 data-id="heading-26">总结</h2>
<h3 data-id="heading-27">关于 AI 编程开发</h3>
<p><strong>AI 真的改变了个人开发者的游戏规则</strong>。</p>
<p>以前做一个完整的项目，可能需要几天甚至几周。现在有了 Cursor 这样的 AI 编程工具，一个周末下午就能从想法到上线。</p>
<p>但关键是，你得知道自己要什么，然后引导 AI 去实现。AI 是工具，是助手，不是魔法棒。</p>
<h3 data-id="heading-28">关于 Cloudflare</h3>
<p><strong>赛博大善人，名不虚传</strong>。</p>
<p>作为穷鬼开发者，Cloudflare 的免费服务让我们不需要购买服务器、不需要关心运维、不需要担心流量费用，就能做出一个<strong>全球可用、性能优秀</strong>的 Web 应用。</p>
<p>而且因为是边缘计算，用户访问时会自动路由到离他最近的节点，无论在国内还是国外，速度都很快。</p>
<h3 data-id="heading-29">给想尝试的你</h3>
<p>如果你也想体验 AI 编程开发，或者对 Cloudflare 的边缘计算感兴趣：</p>
<ol>
<li><strong>装个 Cursor</strong>（或者其他 AI 编程工具）</li>
<li><strong>注册个 Cloudflare 账号</strong>（免费的）</li>
<li><strong>想个有意思的小项目</strong>（解决自己的实际需求）</li>
<li><strong>开始和 AI 聊天写代码</strong></li>
</ol>
<p>你会发现，做一个自己的产品，真的没那么难了。</p>
<p>这个项目的代码很简洁，总共也就几百行，非常适合学习和二次开发。如果你想自己部署一套，或者想看看是怎么实现的，欢迎去 GitHub 看看。</p>
<hr/>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fisnl%2Ff2f" target="_blank" title="https://github.com/isnl/f2f" ref="nofollow noopener noreferrer">github.com/isnl/f2f</a></p>
<p><strong>在线体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ff2f.icu" target="_blank" title="https://f2f.icu" ref="nofollow noopener noreferrer">f2f.icu</a></p>
<p>如果觉得有用，欢迎 Star ⭐️ 支持一下！</p>
<p>有任何问题或建议，也欢迎在 GitHub 上提 Issue，我会及时回复的~</p>
<hr/>
<p><strong>技术栈总结</strong>：</p>
<ul>
<li>🤖 开发工具：Cursor（AI 辅助编程）</li>
<li>🎨 前端：原生 JavaScript + Tailwind CSS</li>
<li>⚡️ 后端：Cloudflare Workers（Serverless）</li>
<li>💾 存储：Cloudflare KV（键值存储）</li>
<li>🌐 托管：Cloudflare Pages（全球 CDN）</li>
<li>🌍 国际化：内置中英双语支持</li>
<li>💰 成本：<strong>完全免费</strong> 🎉</li>
<li>⏱️ 开发时间：<strong>不到 4 小时</strong></li>
</ul>
<p>希望这篇文章对你有帮助！如果你也用 AI 做了有趣的项目，欢迎在评论区分享~</p>
<hr/>
<p>哦对了，最近从 Cursor 又平滑迁移到 Claude Code 了，给大家分享一个正在使用的 Claude Code 中转站，非公益站！</p>
<p>因为他家有付费用户，所以稳定性相当不错，体验非常丝滑！而且模型能力就我重度 AI 使用体验而言，无降智！无降智！无降智！(用过 Cursor/AugmentCode/Trae/Windsurf/Github Copilot/国产 glm、kimi、minimax 等等)</p>
<p>注册即可赠送 30 刀额度，正常使用 claude-4.5-sonnet，可以用很久</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.codemirror.codes%2Fregister%3Faff%3DseMc" target="_blank" title="https://api.codemirror.codes/register?aff=seMc" ref="nofollow noopener noreferrer">api.codemirror.codes/register?af…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂计算机系统核心流量术语]]></title>    <link>https://juejin.cn/post/7576978338754445362</link>    <guid>https://juejin.cn/post/7576978338754445362</guid>    <pubDate>2025-11-27T05:46:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576978338754445362" data-draft-id="7576968345875038235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂计算机系统核心流量术语"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T05:46:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="元Y亨H"/> <meta itemprop="url" content="https://juejin.cn/user/2839351584888617"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂计算机系统核心流量术语
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2839351584888617/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    元Y亨H
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T05:46:02.000Z" title="Thu Nov 27 2025 05:46:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">一文读懂计算机系统核心流量术语</h2>
<p>在后端开发、运维以及系统架构设计中，我们经常听到“QPS 抗不住了”、“RT 太高”、“带宽打满了”等描述。这些术语是衡量系统健康状况的“体检指标”。</p>
<p>要设计一个高可用、高性能的系统，首先需要统一语言。本文将计算机系统中的常见流量术语分为四大维度：<strong>处理能力、响应速度、通道容量、业务规模</strong>，并深入解析它们之间的换算关系。</p>
<hr/>
<h3 data-id="heading-1">一、处理能力指标：系统有多“强”？</h3>
<p>这一类指标衡量服务器在单位时间内能完成多少工作量，是评估系统负载能力的核心。</p>
<h4 data-id="heading-2">1. QPS (Queries Per Second) - 每秒查询率</h4>
<ul>
<li><strong>定义</strong>：服务器每秒钟能够处理的<strong>读操作</strong>或 API 请求数量。</li>
<li><strong>场景</strong>：通常用于衡量接口的吞吐能力。例如，一个查询用户信息的 API，其 QPS 为 1000，意味着它每秒能响应 1000 次请求。</li>
<li><strong>注意</strong>：QPS 是对单一接口或单一查询维度的度量。</li>
</ul>
<h4 data-id="heading-3">2. TPS (Transactions Per Second) - 每秒事务处理量</h4>
<ul>
<li><strong>定义</strong>：服务器每秒处理的<strong>事务</strong>数量。</li>
<li><strong>场景</strong>：多用于涉及数据写入、修改或复杂逻辑的场景（如银行转账、电商下单）。</li>
<li><strong>关键区别</strong>：<strong>一个事务 (Transaction) 可能包含多次查询 (Query)。</strong>
<ul>
<li><em>例子</em>：一个“下单”动作（1个 TPS）可能包含：查库存、减库存、创建订单、写入日志（4个 QPS）。因此，在复杂业务中，QPS 数值通常远大于 TPS。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">3. Concurrency (并发数)</h4>
<ul>
<li><strong>定义</strong>：系统同时处理的请求数量或保持的连接数量。</li>
<li><strong>误区</strong>：并发数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo mathvariant="normal">≠</mo></mrow><annotation encoding="application/x-tex">\neq</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"/></span></span></span></span><span class="mrel">=</span></span></span></span></span></span> QPS。并发数是指“正在车道上跑的车”，而 QPS 是“每秒通过收费站的车”。</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、时间延迟指标：系统有多“快”？</h3>
<p>处理能力强不代表速度快。这一类指标关注用户等待的时间，数值越低越好。</p>
<h4 data-id="heading-6">1. RT (Response Time) - 响应时间</h4>
<ul>
<li><strong>定义</strong>：从客户端发出请求到接收到完整响应的总耗时。</li>
<li><strong>公式</strong>：<code>RT = 网络传输时间 + 服务器排队时间 + 应用处理时间</code>。</li>
</ul>
<h4 data-id="heading-7">2. TTFB (Time To First Byte) - 首字节时间</h4>
<ul>
<li><strong>定义</strong>：从发送请求到接收到服务器返回的<strong>第一个字节</strong>的时间。</li>
<li><strong>意义</strong>：它排除了下载大文件耗时的干扰，纯粹衡量服务器的反应速度和网络链路质量。</li>
</ul>
<h4 data-id="heading-8">3. P99 / P95 / P90 - 百分位延迟（长尾效应）</h4>
<ul>
<li><strong>定义</strong>：统计学术语。<strong>P99 = 100ms</strong> 意味着 <strong>99%</strong> 的请求都在 100ms 内完成，只有 1% 的请求超过这个时间。</li>
<li><strong>为什么不用平均值？</strong>：平均值极易被少数极端慢的请求（长尾）拉高或掩盖。P99 是衡量系统稳定性和用户体验更真实的指标，也是大厂 SLA（服务等级协议）的标准考核项。</li>
</ul>
<hr/>
<h3 data-id="heading-9">三、容量与带宽指标：管道有多“宽”？</h3>
<p>这一类指标衡量数据传输的物理极限。</p>
<h4 data-id="heading-10">1. Bandwidth (带宽) vs. Throughput (吞吐量)</h4>
<ul>
<li><strong>Bandwidth (带宽)</strong>：链路的理论最大传输能力。单位通常是 <strong>bps</strong> (bits per second)。</li>
<li><strong>Throughput (吞吐量)</strong>：单位时间内实际成功传输的数据量。</li>
<li><strong>关系</strong>：带宽是水管的粗细，吞吐量是实际流过的水量。吞吐量永远不可能超过带宽。</li>
</ul>
<h4 data-id="heading-11">2. IOPS (Input/Output Operations Per Second)</h4>
<ul>
<li><strong>定义</strong>：磁盘每秒的读写次数。</li>
<li><strong>瓶颈</strong>：数据库性能往往受限于磁盘 IOPS。传统机械硬盘 IOPS 只有几百，而企业级 SSD 可达数万。</li>
</ul>
<hr/>
<h3 data-id="heading-12">四、业务规模指标：压力来自哪里？</h3>
<p>这是产品经理和运营关注的指标，它们直接决定了技术团队需要准备多大的服务器资源。</p>
<ul>
<li><strong>PV (Page View)</strong>：页面浏览量。用户每刷新一次即计算一次。</li>
<li><strong>UV (Unique Visitor)</strong>：独立访客数。一定时间内访问的用户去重后的数量。</li>
<li><strong>DAU (Daily Active Users)</strong>：日活跃用户数。</li>
<li><strong>PCU (Peak Concurrent Users)</strong>：最高同时在线人数。这是容量规划（扩容）的最重要依据。</li>
</ul>
<hr/>
<h3 data-id="heading-13">五、核心公式与估算方法（重点）</h3>
<p>理解术语后，架构师需要通过公式进行容量预估。</p>
<h4 data-id="heading-14">1. QPS、并发与 RT 的三角关系</h4>
<p>这是性能测试中最核心的公式：
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mi>P</mi><mi>S</mi><mo>=</mo><mfrac><mtext>并发数</mtext><mtext>平均响应时间 (秒)</mtext></mfrac></mrow><annotation encoding="application/x-tex">QPS = \frac{\text{并发数}}{\text{平均响应时间 (秒)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">QPS</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3923em;vertical-align:-0.52em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">平均响应时间</span><span class="mord mtight"> (</span><span class="mord cjk_fallback mtight">秒</span><span class="mord mtight">)</span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">并发数</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<ul>
<li><strong>推论</strong>：如果想提高 QPS，要么增加并发能力（加机器/线程），要么优化代码降低 RT。</li>
</ul>
<h4 data-id="heading-15">2. 流量估算（二八原则）</h4>
<p>已知每天的 PV 量，如何估算系统需要承受的 QPS？
通常假设 80% 的流量集中在 20% 的高峰时段：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>峰值 QPS</mtext><mo>=</mo><mfrac><mrow><mtext>总PV</mtext><mo>×</mo><mn>0.8</mn></mrow><mrow><mtext>一天秒数(86400)</mtext><mo>×</mo><mn>0.2</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{峰值 QPS} = \frac{\text{总PV} \times 0.8}{\text{一天秒数(86400)} \times 0.2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord cjk_fallback">峰值</span><span class="mord"> QPS</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3923em;vertical-align:-0.52em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">一天秒数</span><span class="mord mtight">(86400)</span></span><span class="mbin mtight">×</span><span class="mord mtight">0.2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">总</span><span class="mord mtight">PV</span></span><span class="mbin mtight">×</span><span class="mord mtight">0.8</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<ul>
<li><em>速算技巧</em>：<code>峰值 QPS ≈ 总PV / 20000</code>。</li>
</ul>
<h4 data-id="heading-16">3. 带宽换算</h4>
<p>如何根据 QPS 计算需要购买多少带宽？</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>带宽 (Mbps)</mtext><mo>=</mo><mfrac><mrow><mtext>QPS</mtext><mo>×</mo><mtext>平均包大小(KB)</mtext><mo>×</mo><mn>8</mn></mrow><mn>1024</mn></mfrac></mrow><annotation encoding="application/x-tex">\text{带宽 (Mbps)} = \frac{\text{QPS} \times \text{平均包大小(KB)} \times 8}{1024}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord cjk_fallback">带宽</span><span class="mord"> (Mbps)</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.355em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1024</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">QPS</span></span><span class="mbin mtight">×</span><span class="mord text mtight"><span class="mord cjk_fallback mtight">平均包大小</span><span class="mord mtight">(KB)</span></span><span class="mbin mtight">×</span><span class="mord mtight">8</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<ul>
<li><strong>注意</strong>：务必乘以 8，因为带宽单位是 bit，而数据包单位通常是 Byte。</li>
</ul>
<hr/>
<h3 data-id="heading-17">六、特殊场景术语</h3>
<p>在应对高并发或故障时，还会用到以下术语：</p>
<ul>
<li><strong>Burst (突发)</strong>：短时间内激增的流量（如秒杀、热点新闻）。</li>
<li><strong>Backpressure (背压)</strong>：当下游服务处理不过来时，向上游反馈信号减缓发送，防止系统崩溃。</li>
<li><strong>Throttling (限流)</strong>：主动丢弃超出系统承载能力的流量（如 Nginx 限制每秒请求数），属于自我保护机制。</li>
<li><strong>C10K 问题</strong>：经典的系统设计挑战，指单机如何同时维持 10,000 个并发连接。</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 一、项目概览 Dragonboat 是纯 Go 实现的（multi-group）Raft 库。 为应用屏蔽 Raft 复杂性，提供易于使用的 NodeH]]></title>    <link>https://juejin.cn/post/7576928310788898868</link>    <guid>https://juejin.cn/post/7576928310788898868</guid>    <pubDate>2025-11-27T05:56:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576928310788898868" data-draft-id="7576936862632476672" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 一、项目概览  Dragonboat 是纯 Go 实现的（multi-group）Raft 库。  为应用屏蔽 Raft 复杂性，提供易于使用的 NodeH"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T05:56:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 一、项目概览  Dragonboat 是纯 Go 实现的（multi-group）Raft 库。  为应用屏蔽 Raft 复杂性，提供易于使用的 NodeH
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T05:56:59.000Z" title="Thu Nov 27 2025 05:56:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、项目概览</h2>
<p>Dragonboat 是纯 Go 实现的（multi-group）Raft 库。</p>
<p>为应用屏蔽 Raft 复杂性，提供易于使用的 NodeHost 和状态机接口。该库（自称）有如下特点：</p>
<ul>
<li>高吞吐、流水线化、批处理；</li>
<li>提供了内存/磁盘状态机多种实现；</li>
<li>提供了 ReadIndex、成员变更、Leader转移等管理端API；</li>
<li>默认使用 Pebble 作为 存储后端。</li>
</ul>
<p>本次代码串讲以V3的稳定版本为基础，不包括GitHub上v4版本内容。</p>
<h2 data-id="heading-1">二、整体架构</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f955e506c55247fb90a7eda4442fc289~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764827819&amp;x-signature=q7E00HDNNARA40sdcX38dVI4XWo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三、LogDB 统一存储</h2>
<p>LogDB 模块是 Dragonboat 的核心持久化存储层，虽然模块名字有Log，但是它囊括了所有和存储相关的API，负责管理 Raft 协议的所有持久化数据，包括：</p>
<p><strong>Raft状态 (RaftState)</strong></p>
<p><strong>Raft内部状态变更的集合结构</strong></p>
<p>包括但不限于：</p>
<ul>
<li>ClusterID/NodeID： 节点ID</li>
<li>RaftState： Raft任期、投票情况、commit进度</li>
<li>EntriesToSave：Raft提案日志数据</li>
<li>Snapshot：快照元数据(包括快照文件路径，快照大小，快照对应的提案Index，快照对应的Raft任期等信息)</li>
<li>Messages：发给其他节点的Raft消息</li>
<li>ReadyToReads：ReadIndex就绪的请求</li>
</ul>
<p><strong>引导信息 (Bootstrap)</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Bootstrap <span class="hljs-keyword">struct</span> {
    Addresses <span class="hljs-keyword">map</span>[<span class="hljs-type">uint64</span>]<span class="hljs-type">string</span> <span class="hljs-comment">// 初始集群成员</span>
    Join      <span class="hljs-type">bool</span>
    Type      StateMachineType
}
</code></pre>
<p>ILogDB的API如下：</p>
<pre><code class="hljs language-scss" lang="scss">type ILogDB interface {


    <span class="hljs-built_in">BinaryFormat</span>() uint32 <span class="hljs-comment">// 返回支持的二进制格式版本号</span>


    <span class="hljs-built_in">ListNodeInfo</span>() ([]NodeInfo, error) <span class="hljs-comment">// 列出 LogDB 中所有可用的节点信息</span>


    <span class="hljs-comment">// 存储集群节点的初始化配置信息，包括是否加入集群、状态机类型等</span>
    <span class="hljs-built_in">SaveBootstrapInfo</span>(clusterID uint64, nodeID uint64, bootstrap pb.Bootstrap) error


    <span class="hljs-comment">// 获取保存的引导信息</span>
    <span class="hljs-built_in">GetBootstrapInfo</span>(clusterID uint64, nodeID uint64) (pb.Bootstrap, error)


    <span class="hljs-comment">// 原子性保存 Raft 状态、日志条目和快照元数据</span>
    <span class="hljs-built_in">SaveRaftState</span>(updates []pb.Update, shardID uint64) error


    <span class="hljs-comment">// 迭代读取指定范围内的连续日志条目</span>
    <span class="hljs-built_in">IterateEntries</span>(ents []pb.Entry, size uint64, clusterID uint64, nodeID uint64, 
                   low uint64, high uint64, maxSize uint64) ([]pb.Entry, uint64, error)


    <span class="hljs-comment">// 读取持久化的 Raft 状态</span>
    <span class="hljs-built_in">ReadRaftState</span>(clusterID uint64, nodeID uint64, lastIndex uint64) (RaftState, error)


    <span class="hljs-comment">// 删除指定索引之前的所有条目, 日志压缩、快照后清理旧日志</span>
    <span class="hljs-built_in">RemoveEntriesTo</span>(clusterID uint64, nodeID uint64, index uint64) error


    <span class="hljs-comment">// 回收指定索引之前条目占用的存储空间</span>
    <span class="hljs-built_in">CompactEntriesTo</span>(clusterID uint64, nodeID uint64, index uint64) (&lt;-chan struct{}, error)


    <span class="hljs-comment">// 保存所有快照元数据</span>
    <span class="hljs-built_in">SaveSnapshots</span>([]pb.Update) error


    <span class="hljs-comment">// 删除指定的快照元数据 清理过时或无效的快照</span>
    <span class="hljs-built_in">DeleteSnapshot</span>(clusterID uint64, nodeID uint64, index uint64) error


    <span class="hljs-comment">// 列出指定索引范围内的可用快照</span>
    <span class="hljs-built_in">ListSnapshots</span>(clusterID uint64, nodeID uint64, index uint64) ([]pb.Snapshot, error)


    <span class="hljs-comment">// 删除节点的所有相关数据</span>
    <span class="hljs-built_in">RemoveNodeData</span>(clusterID uint64, nodeID uint64) error


    <span class="hljs-comment">// 导入快照并创建所有必需的元数据</span>
    <span class="hljs-built_in">ImportSnapshot</span>(snapshot pb.Snapshot, nodeID uint64) error
}
</code></pre>
<h3 data-id="heading-3">3.1索引键</h3>
<p>存储的底层本质是一个KVDB (pebble or rocksdb)，由于业务的复杂性，要统一各类业务key的设计方法，而且要降低空间使用，所以有了如下的key设计方案。</p>
<p>龙舟中key分为3类：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c3776bbc6d847f7ab268c897b16e408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764827819&amp;x-signature=HWHrlMAMKVOo%2BWhJgVg77ZwWmdM%3D" alt="" loading="lazy"/></p>
<p>其中，2字节的header用于区分各类不同业务的key空间。</p>
<pre><code class="hljs language-arduino" lang="arduino">entryKeyHeader       = [<span class="hljs-number">2</span>]<span class="hljs-type">byte</span>{<span class="hljs-number">0x1</span>, <span class="hljs-number">0x1</span>}  <span class="hljs-comment">// 普通日志条目</span>
persistentStateKey   = [<span class="hljs-number">2</span>]<span class="hljs-type">byte</span>{<span class="hljs-number">0x2</span>, <span class="hljs-number">0x2</span>}  <span class="hljs-comment">// Raft状态</span>
maxIndexKey          = [<span class="hljs-number">2</span>]<span class="hljs-type">byte</span>{<span class="hljs-number">0x3</span>, <span class="hljs-number">0x3</span>}  <span class="hljs-comment">// 最大索引记录</span>
nodeInfoKey          = [<span class="hljs-number">2</span>]<span class="hljs-type">byte</span>{<span class="hljs-number">0x4</span>, <span class="hljs-number">0x4</span>}  <span class="hljs-comment">// 节点元数据</span>
bootstrapKey         = [<span class="hljs-number">2</span>]<span class="hljs-type">byte</span>{<span class="hljs-number">0x5</span>, <span class="hljs-number">0x5</span>}  <span class="hljs-comment">// 启动配置</span>
snapshotKey          = [<span class="hljs-number">2</span>]<span class="hljs-type">byte</span>{<span class="hljs-number">0x6</span>, <span class="hljs-number">0x6</span>}  <span class="hljs-comment">// 快照索引</span>
entryBatchKey        = [<span class="hljs-number">2</span>]<span class="hljs-type">byte</span>{<span class="hljs-number">0x7</span>, <span class="hljs-number">0x7</span>}  <span class="hljs-comment">// 批量日志</span>
</code></pre>
<p>在key的生成中，采用了useAsXXXKey和SetXXXKey的方式，复用了data这个二进制变量，减少GC。</p>
<pre><code class="hljs language-scss" lang="scss">type Key struct {
    data <span class="hljs-selector-attr">[]</span>byte  <span class="hljs-comment">// 底层字节数组复用池</span>
    key  <span class="hljs-selector-attr">[]</span>byte  <span class="hljs-comment">// 有效数据切片</span>
    pool *sync<span class="hljs-selector-class">.Pool</span> <span class="hljs-comment">// 似乎并没有什么用</span>
}




func (k *Key) <span class="hljs-built_in">useAsEntryKey</span>() {
    k<span class="hljs-selector-class">.key</span> = k<span class="hljs-selector-class">.data</span>
}


type IReusableKey interface {
    <span class="hljs-built_in">SetEntryBatchKey</span>(clusterID uint64, nodeID uint64, index uint64)
    <span class="hljs-comment">// SetEntryKey sets the key to be an entry key for the specified Raft node</span>
    <span class="hljs-comment">// with the specified entry index.</span>
    <span class="hljs-built_in">SetEntryKey</span>(clusterID uint64, nodeID uint64, index uint64)
    <span class="hljs-comment">// SetStateKey sets the key to be an persistent state key suitable</span>
    <span class="hljs-comment">// for the specified Raft cluster node.</span>
    <span class="hljs-built_in">SetStateKey</span>(clusterID uint64, nodeID uint64)
    <span class="hljs-comment">// SetMaxIndexKey sets the key to be the max possible index key for the</span>
    <span class="hljs-comment">// specified Raft cluster node.</span>
    <span class="hljs-built_in">SetMaxIndexKey</span>(clusterID uint64, nodeID uint64)
    <span class="hljs-comment">// Key returns the underlying byte slice of the key.</span>
    <span class="hljs-built_in">Key</span>() <span class="hljs-selector-attr">[]</span>byte
    <span class="hljs-comment">// Release releases the key instance so it can be reused in the future.</span>
    <span class="hljs-built_in">Release</span>()
}


func (k *Key) <span class="hljs-built_in">useAsEntryKey</span>() {
    k<span class="hljs-selector-class">.key</span> = k<span class="hljs-selector-class">.data</span>
}


<span class="hljs-comment">// SetEntryKey sets the key value to the specified entry key.</span>
func (k *Key) <span class="hljs-built_in">SetEntryKey</span>(clusterID uint64, nodeID uint64, index uint64) {
    k<span class="hljs-selector-class">.useAsEntryKey</span>()
    k<span class="hljs-selector-class">.key</span><span class="hljs-selector-attr">[0]</span> = entryKeyHeader<span class="hljs-selector-attr">[0]</span>
    k<span class="hljs-selector-class">.key</span><span class="hljs-selector-attr">[1]</span> = entryKeyHeader<span class="hljs-selector-attr">[1]</span>
    k<span class="hljs-selector-class">.key</span><span class="hljs-selector-attr">[2]</span> = <span class="hljs-number">0</span>
    k<span class="hljs-selector-class">.key</span><span class="hljs-selector-attr">[3]</span> = <span class="hljs-number">0</span>
    binary<span class="hljs-selector-class">.BigEndian</span><span class="hljs-selector-class">.PutUint64</span>(k.key[<span class="hljs-number">4</span>:], clusterID)
    <span class="hljs-comment">// the 8 bytes node ID is actually not required in the key. it is stored as</span>
    <span class="hljs-comment">// an extra safenet - we don't know what we don't know, it is used as extra</span>
    <span class="hljs-comment">// protection between different node instances when things get ugly.</span>
    <span class="hljs-comment">// the wasted 8 bytes per entry is not a big deal - storing the index is</span>
    <span class="hljs-comment">// wasteful as well.</span>
    binary<span class="hljs-selector-class">.BigEndian</span><span class="hljs-selector-class">.PutUint64</span>(k.key[<span class="hljs-number">12</span>:], nodeID)
    binary<span class="hljs-selector-class">.BigEndian</span><span class="hljs-selector-class">.PutUint64</span>(k.key[<span class="hljs-number">20</span>:], index)
}
</code></pre>
<h3 data-id="heading-4">3.2变量复用IContext</h3>
<p>IContext的核心设计目的是实现<strong>并发安全的内存复用机制</strong>。在高并发场景下，频繁的内存分配和释放会造成较大的GC压力，通过IContext可以实现：</p>
<ul>
<li><strong>键对象复用</strong>：通过GetKey()获取可重用的IReusableKey</li>
<li><strong>缓冲区复用</strong>：通过GetValueBuffer()获取可重用的字节缓冲区</li>
<li><strong>批量操作对象复用</strong>：EntryBatch和WriteBatch的复用</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// IContext is the per thread context used in the logdb module.</span>
<span class="hljs-comment">// IContext is expected to contain a list of reusable keys and byte</span>
<span class="hljs-comment">// slices that are owned per thread so they can be safely reused by the</span>
<span class="hljs-comment">// same thread when accessing ILogDB.</span>
type IContext interface {
    <span class="hljs-comment">// Destroy destroys the IContext instance.</span>
    <span class="hljs-built_in">Destroy</span>()
    <span class="hljs-comment">// Reset resets the IContext instance, all previous returned keys and</span>
    <span class="hljs-comment">// buffers will be put back to the IContext instance and be ready to</span>
    <span class="hljs-comment">// be used for the next iteration.</span>
    <span class="hljs-built_in">Reset</span>()
    <span class="hljs-comment">// GetKey returns a reusable key.</span>
    <span class="hljs-built_in">GetKey</span>() IReusableKey <span class="hljs-comment">// 这就是上文中的key接口</span>
    <span class="hljs-comment">// GetValueBuffer returns a byte buffer with at least sz bytes in length.</span>
    <span class="hljs-built_in">GetValueBuffer</span>(sz uint64) <span class="hljs-selector-attr">[]</span>byte
    <span class="hljs-comment">// GetWriteBatch returns a write batch or transaction instance.</span>
    <span class="hljs-built_in">GetWriteBatch</span>() interface{}
    <span class="hljs-comment">// SetWriteBatch adds the write batch to the IContext instance.</span>
    <span class="hljs-built_in">SetWriteBatch</span>(wb interface{})
    <span class="hljs-comment">// GetEntryBatch returns an entry batch instance.</span>
    <span class="hljs-built_in">GetEntryBatch</span>() pb<span class="hljs-selector-class">.EntryBatch</span>
    <span class="hljs-comment">// GetLastEntryBatch returns an entry batch instance.</span>
    <span class="hljs-built_in">GetLastEntryBatch</span>() pb<span class="hljs-selector-class">.EntryBatch</span>
}








type context struct {
    size    uint64
    maxSize uint64
    eb      pb<span class="hljs-selector-class">.EntryBatch</span>
    lb      pb<span class="hljs-selector-class">.EntryBatch</span>
    key     *Key
    val     <span class="hljs-selector-attr">[]</span>byte
    wb      kv<span class="hljs-selector-class">.IWriteBatch</span>
}


func (c *context) <span class="hljs-built_in">GetKey</span>() IReusableKey {
    return c<span class="hljs-selector-class">.key</span>
}


func (c *context) <span class="hljs-built_in">GetValueBuffer</span>(sz uint64) <span class="hljs-selector-attr">[]</span>byte {
    if sz &lt;= c<span class="hljs-selector-class">.size</span> {
        return c<span class="hljs-selector-class">.val</span>
    }
    val := <span class="hljs-built_in">make</span>([]byte, sz)
    if sz &lt; c.maxSize {
        c<span class="hljs-selector-class">.size</span> = sz
        c<span class="hljs-selector-class">.val</span> = val
    }
    return val
}


func (c *context) <span class="hljs-built_in">GetEntryBatch</span>() pb<span class="hljs-selector-class">.EntryBatch</span> {
    return c<span class="hljs-selector-class">.eb</span>
}


func (c *context) <span class="hljs-built_in">GetLastEntryBatch</span>() pb<span class="hljs-selector-class">.EntryBatch</span> {
    return c<span class="hljs-selector-class">.lb</span>
}


func (c *context) <span class="hljs-built_in">GetWriteBatch</span>() interface{} {
    return c<span class="hljs-selector-class">.wb</span>
}


func (c *context) <span class="hljs-built_in">SetWriteBatch</span>(wb interface{}) {
    c<span class="hljs-selector-class">.wb</span> = wb.(kv.IWriteBatch)
}
</code></pre>
<h3 data-id="heading-5">3.3存储引擎封装IKVStore</h3>
<p>IKVStore 是 Dragonboat 日志存储系统的抽象接口，它定义了底层键值存储引擎需要实现的所有基本操作。这个接口让 Dragonboat 能够支持不同的存储后端（如 Pebble、RocksDB 等），实现了存储引擎的可插拔性。</p>
<pre><code class="hljs language-scss" lang="scss">type IKVStore interface {
    <span class="hljs-comment">// Name is the IKVStore name.</span>
    <span class="hljs-built_in">Name</span>() string
    <span class="hljs-comment">// Close closes the underlying Key-Value store.</span>
    <span class="hljs-built_in">Close</span>() error


    <span class="hljs-comment">// 范围扫描 - 支持前缀遍历的迭代器</span>
    <span class="hljs-built_in">IterateValue</span>(fk []byte,
            lk []byte, inc bool, op func(key []byte, data []byte) (bool, error)) error
    
    <span class="hljs-comment">// 查询操作 - 基于回调的内存高效查询模式</span>
    <span class="hljs-built_in">GetValue</span>(key []byte, op func([]byte) error) error
    
    <span class="hljs-comment">// 写入操作 - 单条记录的原子写入</span>
    <span class="hljs-built_in">SaveValue</span>(key []byte, value []byte) error


    <span class="hljs-comment">// 删除操作 - 单条记录的精确删除</span>
    <span class="hljs-built_in">DeleteValue</span>(key []byte) error
    
    <span class="hljs-comment">// 获取批量写入器</span>
    <span class="hljs-built_in">GetWriteBatch</span>() IWriteBatch
    
    <span class="hljs-comment">// 原子提交批量操作</span>
    <span class="hljs-built_in">CommitWriteBatch</span>(wb IWriteBatch) error
    
    <span class="hljs-comment">// 批量删除一个范围的键值对</span>
    <span class="hljs-built_in">BulkRemoveEntries</span>(firstKey []byte, lastKey []byte) error
    
    <span class="hljs-comment">// 压缩指定范围的存储空间</span>
    <span class="hljs-built_in">CompactEntries</span>(firstKey []byte, lastKey []byte) error
    
    <span class="hljs-comment">// 全量压缩整个数据库</span>
    <span class="hljs-built_in">FullCompaction</span>() error
}


type IWriteBatch interface {
    <span class="hljs-built_in">Destroy</span>()                 <span class="hljs-comment">// 清理资源，防止内存泄漏</span>
    <span class="hljs-built_in">Put</span>(key, value []byte)    <span class="hljs-comment">// 添加写入操作</span>
    <span class="hljs-built_in">Delete</span>(key []byte)        <span class="hljs-comment">// 添加删除操作</span>
    <span class="hljs-attribute">Clear</span>()                   <span class="hljs-comment">// 清空批处理中的所有操作</span>
    <span class="hljs-built_in">Count</span>() int               <span class="hljs-comment">// 获取当前批处理中的操作数量</span>
}
</code></pre>
<p>openPebbleDB是Dragonboat 中 Pebble 存储引擎的初始化入口，负责根据配置创建一个完整可用的键值存储实例。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/981de8dd26004e8887ddc82dd81f9318~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764827819&amp;x-signature=2uCOkxPECTcrlUoekIyqnZ4wGUc%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// KV is a pebble based IKVStore type.</span>
<span class="hljs-keyword">type</span> KV <span class="hljs-keyword">struct</span> {
    db       *pebble.DB
    dbSet    <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}
    opts     *pebble.Options
    ro       *pebble.IterOptions
    wo       *pebble.WriteOptions
    event    *eventListener
    callback kv.LogDBCallback
    config   config.LogDBConfig
}


<span class="hljs-keyword">var</span> _ kv.IKVStore = (*KV)(<span class="hljs-literal">nil</span>)




<span class="hljs-comment">// openPebbleDB</span>
<span class="hljs-comment">// =============</span>
<span class="hljs-comment">// 将 Dragonboat 的 LogDBConfig → Pebble 引擎实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">openPebbleDB</span><span class="hljs-params">(
        cfg  config.LogDBConfig,
        cb   kv.LogDBCallback,   // =&gt; busy通知：busy(<span class="hljs-literal">true</span>/<span class="hljs-literal">false</span>)</span></span>
        dir  <span class="hljs-type">string</span>,             <span class="hljs-comment">// 主数据目录</span>
        wal  <span class="hljs-type">string</span>,             <span class="hljs-comment">// WAL 独立目录（可空）</span>
        fs   vfs.IFS,            <span class="hljs-comment">// 文件系统抽象（磁盘/memfs）</span>
) (kv.IKVStore, <span class="hljs-type">error</span>) {
    
    <span class="hljs-comment">//--------------------------------------------------</span>
    <span class="hljs-comment">// 2️⃣ &lt;&lt; 核心调优参数读入</span>
    <span class="hljs-comment">//--------------------------------------------------</span>
    blockSz      := <span class="hljs-type">int</span>(cfg.KVBlockSize)                    <span class="hljs-comment">// 数据块(4K/8K…)</span>
    writeBufSz   := <span class="hljs-type">int</span>(cfg.KVWriteBufferSize)              <span class="hljs-comment">// 写缓冲</span>
    bufCnt       := <span class="hljs-type">int</span>(cfg.KVMaxWriteBufferNumber)         <span class="hljs-comment">// MemTable数量</span>
    l0Compact    := <span class="hljs-type">int</span>(cfg.KVLevel0FileNumCompactionTrigger) <span class="hljs-comment">// L0 层文件数量触发压缩的阈值</span>
    l0StopWrites := <span class="hljs-type">int</span>(cfg.KVLevel0StopWritesTrigger)
    baseBytes    := <span class="hljs-type">int64</span>(cfg.KVMaxBytesForLevelBase)
    fileBaseSz   := <span class="hljs-type">int64</span>(cfg.KVTargetFileSizeBase)
    cacheSz      := <span class="hljs-type">int64</span>(cfg.KVLRUCacheSize)
    levelMult    := <span class="hljs-type">int64</span>(cfg.KVTargetFileSizeMultiplier)  <span class="hljs-comment">// 每层文件大小倍数</span>
    numLevels    := <span class="hljs-type">int64</span>(cfg.KVNumOfLevels)
    
    
    <span class="hljs-comment">//--------------------------------------------------</span>
    <span class="hljs-comment">// 4️⃣ 构建 LSM-tree 层级选项 (每层无压缩)</span>
    <span class="hljs-comment">//--------------------------------------------------</span>
    levelOpts := []pebble.LevelOptions{}
    sz := fileBaseSz
    <span class="hljs-keyword">for</span> lvl := <span class="hljs-number">0</span>; lvl &lt; <span class="hljs-type">int</span>(numLevels); lvl++ {
        levelOpts = <span class="hljs-built_in">append</span>(levelOpts, pebble.LevelOptions{
            Compression:    pebble.NoCompression, <span class="hljs-comment">// 写性能优先</span>
            BlockSize:      blockSz,
            TargetFileSize: sz,                 <span class="hljs-comment">// L0 &lt; L1 &lt; … 呈指数增长</span>
        })
        sz *= levelMult
    }
    
    <span class="hljs-comment">//--------------------------------------------------</span>
    <span class="hljs-comment">// 5️⃣ 初始化依赖：LRU Cache + 读写选项</span>
    <span class="hljs-comment">//--------------------------------------------------</span>
    cache := pebble.NewCache(cacheSz)    <span class="hljs-comment">// block缓存</span>
    ro    := &amp;pebble.IterOptions{}       <span class="hljs-comment">// 迭代器默认配置</span>
    wo    := &amp;pebble.WriteOptions{Sync: <span class="hljs-literal">true</span>} <span class="hljs-comment">// ❗fsync强制刷盘</span>
    
    opts := &amp;pebble.Options{
        Levels:                      levelOpts,
        Cache:                       cache,
        MemTableSize:                writeBufSz,
        MemTableStopWritesThreshold: bufCnt,
        LBaseMaxBytes:               baseBytes,
        L0CompactionThreshold:       l0Compact,
        L0StopWritesThreshold:       l0StopWrites,
        Logger:                      PebbleLogger,
        FS:                          vfs.NewPebbleFS(fs),
        MaxManifestFileSize:         <span class="hljs-number">128</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>,
        <span class="hljs-comment">// WAL 目录稍后条件注入</span>
    }
    
    kv := &amp;KV{
        dbSet:    <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}),          <span class="hljs-comment">// 关闭-&gt;初始化完成信号</span>
        callback: cb,                           <span class="hljs-comment">// 上层 raft engine 回调</span>
        config:   cfg,
        opts:     opts,
        ro:       ro,
        wo:       wo,
    }
    
    event := &amp;eventListener{
        kv:      kv,
        stopper: syncutil.NewStopper(),
    }
    
    <span class="hljs-comment">// =&gt; 关键事件触发</span>
    opts.EventListener = pebble.EventListener{
        WALCreated:    event.onWALCreated,
        FlushEnd:      event.onFlushEnd,
        CompactionEnd: event.onCompactionEnd,
    }
    
    <span class="hljs-comment">//--------------------------------------------------</span>
    <span class="hljs-comment">// 7️⃣ 目录准备</span>
    <span class="hljs-comment">//--------------------------------------------------</span>
    <span class="hljs-keyword">if</span> wal != <span class="hljs-string">""</span> {
        fs.MkdirAll(wal)        <span class="hljs-comment">// 📁 为 WAL 单独磁盘预留</span>
        opts.WALDir = wal
    }
    fs.MkdirAll(dir)            <span class="hljs-comment">// 📁 主数据目录</span>
    
    <span class="hljs-comment">//--------------------------------------------------</span>
    <span class="hljs-comment">// 8️⃣ 真正的数据库实例化</span>
    <span class="hljs-comment">//--------------------------------------------------</span>
    pdb, err := pebble.Open(dir, opts)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err }
    
    <span class="hljs-comment">//--------------------------------------------------</span>
    <span class="hljs-comment">// 9️⃣ 🧹 资源整理 &amp; 启动事件</span>
    <span class="hljs-comment">//--------------------------------------------------</span>
    cache.Unref()               <span class="hljs-comment">// 去除多余引用，防止泄露</span>
    kv.db = pdb
    
    <span class="hljs-comment">// 🔔 手动触发一次 WALCreated 确保反压逻辑进入首次轮询</span>
    kv.setEventListener(event)  <span class="hljs-comment">// 内部 close(kv.dbSet)</span>
    
    <span class="hljs-keyword">return</span> kv, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>其中eventListener是对pebble 内存繁忙的回调，繁忙判断的条件有两个：</p>
<ul>
<li>内存表大小超过阈值（95%）</li>
<li>L0 层文件数量超过阈值（L0写入最大文件数量-1）</li>
</ul>
<pre><code class="hljs language-go" lang="go">

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *eventListener)</span></span> notify() {
    l.stopper.RunWorker(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> &lt;-l.kv.dbSet:
            <span class="hljs-keyword">if</span> l.kv.callback != <span class="hljs-literal">nil</span> {
                memSizeThreshold := l.kv.config.KVWriteBufferSize *
                    l.kv.config.KVMaxWriteBufferNumber * <span class="hljs-number">19</span> / <span class="hljs-number">20</span>
                l0FileNumThreshold := l.kv.config.KVLevel0StopWritesTrigger - <span class="hljs-number">1</span>
                m := l.kv.db.Metrics()
                busy := m.MemTable.Size &gt;= memSizeThreshold ||
                    <span class="hljs-type">uint64</span>(m.Levels[<span class="hljs-number">0</span>].NumFiles) &gt;= l0FileNumThreshold
                l.kv.callback(busy)
            }
        <span class="hljs-keyword">default</span>:
        }
    })
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27067c4d7d214c248295ed4a11b77b93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764827819&amp;x-signature=xzyNrtkP3NOjRXhDEtOooCqd3ho%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">3.4日志条目存储DB</h3>
<p>db结构体是Dragonboat日志数据库的核心管理器，提供Raft日志、快照、状态等数据的持久化存储接口。是桥接了业务和pebble存储的中间层。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// db is the struct used to manage log DB.</span>
<span class="hljs-keyword">type</span> db <span class="hljs-keyword">struct</span> {
    cs      *cache       <span class="hljs-comment">// 节点信息、Raft状态信息缓存</span>
    keys    *keyPool     <span class="hljs-comment">// Raft日志索引键变量池</span>
    kvs     kv.IKVStore  <span class="hljs-comment">// pebble的封装</span>
    entries entryManager <span class="hljs-comment">// 日志条目读写封装</span>
}


<span class="hljs-comment">// 这里面的信息不会过期，叫寄存更合适</span>
<span class="hljs-keyword">type</span> cache <span class="hljs-keyword">struct</span> {
    nodeInfo       <span class="hljs-keyword">map</span>[raftio.NodeInfo]<span class="hljs-keyword">struct</span>{}
    ps             <span class="hljs-keyword">map</span>[raftio.NodeInfo]pb.State
    lastEntryBatch <span class="hljs-keyword">map</span>[raftio.NodeInfo]pb.EntryBatch
    maxIndex       <span class="hljs-keyword">map</span>[raftio.NodeInfo]<span class="hljs-type">uint64</span>
    mu             sync.Mutex
}
</code></pre>
<ul>
<li><strong>获取一个批量写容器</strong></li>
</ul>
<p>实现：</p>
<pre><code class="hljs language-scss" lang="scss">func (r *db) <span class="hljs-built_in">getWriteBatch</span>(ctx IContext) kv<span class="hljs-selector-class">.IWriteBatch</span> {
    if ctx != nil {
        wb := ctx.<span class="hljs-built_in">GetWriteBatch</span>()
        if wb == nil {
            wb = r<span class="hljs-selector-class">.kvs</span><span class="hljs-selector-class">.GetWriteBatch</span>()
            ctx<span class="hljs-selector-class">.SetWriteBatch</span>(wb)
        }
        return wb.(kv.IWriteBatch)
    }
    return r<span class="hljs-selector-class">.kvs</span><span class="hljs-selector-class">.GetWriteBatch</span>()
}
</code></pre>
<p>降低GC压力</p>
<ul>
<li><strong>获取所有节点信息</strong></li>
</ul>
<p>实现：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *db)</span></span> listNodeInfo() ([]raftio.NodeInfo, <span class="hljs-type">error</span>) {
    fk := newKey(bootstrapKeySize, <span class="hljs-literal">nil</span>)
    lk := newKey(bootstrapKeySize, <span class="hljs-literal">nil</span>)
    fk.setBootstrapKey(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    lk.setBootstrapKey(math.MaxUint64, math.MaxUint64)
    ni := <span class="hljs-built_in">make</span>([]raftio.NodeInfo, <span class="hljs-number">0</span>)
    op := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key []<span class="hljs-type">byte</span>, data []<span class="hljs-type">byte</span>)</span></span> (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>) {
        cid, nid := parseNodeInfoKey(key)
        ni = <span class="hljs-built_in">append</span>(ni, raftio.GetNodeInfo(cid, nid))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-keyword">if</span> err := r.kvs.IterateValue(fk.Key(), lk.Key(), <span class="hljs-literal">true</span>, op); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> []raftio.NodeInfo{}, err
    }
    <span class="hljs-keyword">return</span> ni, <span class="hljs-literal">nil</span>
}
</code></pre>
<ul>
<li><strong>保存集群状态</strong></li>
</ul>
<p>实现：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Update <span class="hljs-keyword">struct</span> {
    ClusterID <span class="hljs-type">uint64</span>  <span class="hljs-comment">// 集群ID，标识节点所属的Raft集群</span>
    NodeID    <span class="hljs-type">uint64</span>  <span class="hljs-comment">// 节点ID，标识集群中的具体节点</span>


    State  <span class="hljs-comment">// 包含当前任期（Term）、投票节点（Vote）、提交索引（Commit）三个关键持久化状态</span>


    EntriesToSave []Entry    <span class="hljs-comment">// 需要持久化到稳定存储的日志条目</span>
    CommittedEntries []Entry <span class="hljs-comment">// 已提交位apply的日志条目</span>
    MoreCommittedEntries <span class="hljs-type">bool</span>  <span class="hljs-comment">// 指示是否还有更多已提交条目等待处理</span>


    Snapshot Snapshot  <span class="hljs-comment">// 快照元数据，当需要应用快照时设置</span>


    ReadyToReads []ReadyToRead  <span class="hljs-comment">// ReadIndex机制实现的线性一致读</span>


    Messages []Message  <span class="hljs-comment">// 需要发送给其他节点的Raft消息</span>


    UpdateCommit <span class="hljs-keyword">struct</span> {
        Processed         <span class="hljs-type">uint64</span>  <span class="hljs-comment">// 已推送给RSM处理的最后索引</span>
        LastApplied       <span class="hljs-type">uint64</span>  <span class="hljs-comment">// RSM确认已执行的最后索引</span>
        StableLogTo       <span class="hljs-type">uint64</span>  <span class="hljs-comment">// 已稳定存储的日志到哪个索引</span>
        StableLogTerm     <span class="hljs-type">uint64</span>  <span class="hljs-comment">// 已稳定存储的日志任期</span>
        StableSnapshotTo  <span class="hljs-type">uint64</span>  <span class="hljs-comment">// 已稳定存储的快照到哪个索引</span>
        ReadyToRead       <span class="hljs-type">uint64</span>  <span class="hljs-comment">// 已准备好读的ReadIndex请求索引</span>
    }
}




<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *db)</span></span> saveRaftState(updates []pb.Update, ctx IContext) <span class="hljs-type">error</span> {
      <span class="hljs-comment">// 步骤1：获取写入批次对象，用于批量操作提高性能</span>
      <span class="hljs-comment">// 优先从上下文中获取已存在的批次，避免重复创建</span>
      wb := r.getWriteBatch(ctx)
      
      <span class="hljs-comment">// 步骤2：遍历所有更新，处理每个节点的状态和快照</span>
      <span class="hljs-keyword">for</span> _, ud := <span class="hljs-keyword">range</span> updates {
          <span class="hljs-comment">// 保存 Raft 的硬状态（Term、Vote、Commit）</span>
          <span class="hljs-comment">// 使用缓存机制避免重复保存相同状态</span>
          r.saveState(ud.ClusterID, ud.NodeID, ud.State, wb, ctx)
          
          <span class="hljs-comment">// 检查是否有快照需要保存</span>
          <span class="hljs-keyword">if</span> !pb.IsEmptySnapshot(ud.Snapshot) {
              <span class="hljs-comment">// 快照索引一致性检查：确保快照索引不超过最后一个日志条目的索引</span>
              <span class="hljs-comment">// 这是 Raft 协议的重要约束，防止状态不一致</span>
              <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ud.EntriesToSave) &gt; <span class="hljs-number">0</span> {
                  lastIndex := ud.EntriesToSave[<span class="hljs-built_in">len</span>(ud.EntriesToSave)<span class="hljs-number">-1</span>].Index
                  <span class="hljs-keyword">if</span> ud.Snapshot.Index &gt; lastIndex {
                      plog.Panicf(<span class="hljs-string">"max index not handled, %d, %d"</span>,
                          ud.Snapshot.Index, lastIndex)
                  }
              }
              
              <span class="hljs-comment">// 保存快照元数据到数据库</span>
              r.saveSnapshot(wb, ud)
              
              <span class="hljs-comment">// 更新节点的最大日志索引为快照索引</span>
              r.setMaxIndex(wb, ud, ud.Snapshot.Index, ctx)
          }
      }
      
      <span class="hljs-comment">// 步骤3：批量保存所有日志条目</span>
      <span class="hljs-comment">// 这里会调用 entryManager 接口的 record 方法，根据配置选择批量或单独存储策略</span>
      r.saveEntries(updates, wb, ctx)
      
      <span class="hljs-comment">// 步骤4：提交写入批次到磁盘</span>
      <span class="hljs-comment">// 只有在批次中有实际操作时才提交，避免不必要的磁盘 I/O</span>
      <span class="hljs-keyword">if</span> wb.Count() &gt; <span class="hljs-number">0</span> {
          <span class="hljs-keyword">return</span> r.kvs.CommitWriteBatch(wb)
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
  }
  
  
</code></pre>
<ul>
<li><strong>保存引导信息</strong></li>
</ul>
<p>实现：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *db)</span></span> saveBootstrapInfo(clusterID <span class="hljs-type">uint64</span>,
    nodeID <span class="hljs-type">uint64</span>, bs pb.Bootstrap) <span class="hljs-type">error</span> {
    wb := r.getWriteBatch(<span class="hljs-literal">nil</span>)
    r.saveBootstrap(wb, clusterID, nodeID, bs)
    <span class="hljs-keyword">return</span> r.kvs.CommitWriteBatch(wb) <span class="hljs-comment">// 提交至Pebble</span>
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *db)</span></span> saveBootstrap(wb kv.IWriteBatch,
    clusterID <span class="hljs-type">uint64</span>, nodeID <span class="hljs-type">uint64</span>, bs pb.Bootstrap) {
    k := newKey(maxKeySize, <span class="hljs-literal">nil</span>)
    k.setBootstrapKey(clusterID, nodeID) <span class="hljs-comment">// 序列化集群节点信息</span>
    data, err := bs.Marshal()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }
    wb.Put(k.Key(), data)
}
</code></pre>
<ul>
<li><strong>获取Raft状态</strong></li>
</ul>
<p>实现：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *db)</span></span> getState(clusterID <span class="hljs-type">uint64</span>, nodeID <span class="hljs-type">uint64</span>) (pb.State, <span class="hljs-type">error</span>) {
    k := r.keys.get()
    <span class="hljs-keyword">defer</span> k.Release()
    k.SetStateKey(clusterID, nodeID)
    hs := pb.State{}
    <span class="hljs-keyword">if</span> err := r.kvs.GetValue(k.Key(), <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(data []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">error</span> {
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(data) == <span class="hljs-number">0</span> {
            <span class="hljs-keyword">return</span> raftio.ErrNoSavedLog
        }
        <span class="hljs-keyword">if</span> err := hs.Unmarshal(data); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-built_in">panic</span>(err)
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }); err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> pb.State{}, err
    }
    <span class="hljs-keyword">return</span> hs, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-7">3.5对外存储API实现</h3>
<p>龙舟对ILogDB提供了实现：ShardedDB，一个管理了多个pebble bucket的存储单元。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> _ raftio.ILogDB = (*ShardedDB)(<span class="hljs-literal">nil</span>)
<span class="hljs-comment">// ShardedDB is a LogDB implementation using sharded pebble instances.</span>
<span class="hljs-keyword">type</span> ShardedDB <span class="hljs-keyword">struct</span> {
    completedCompactions <span class="hljs-type">uint64</span>             <span class="hljs-comment">// 原子计数器：已完成压缩操作数</span>
    config               config.LogDBConfig <span class="hljs-comment">// 日志存储配置</span>
    ctxs                 []IContext         <span class="hljs-comment">// 分片上下文池，减少GC压力</span>
    shards               []*db              <span class="hljs-comment">// 核心：Pebble实例数组</span>
    partitioner          server.IPartitioner <span class="hljs-comment">// 智能分片策略器</span>
    compactionCh         <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}      <span class="hljs-comment">// 压缩任务信号通道</span>
    compactions          *compactions       <span class="hljs-comment">// 压缩任务管理器</span>
    stopper              *syncutil.Stopper  <span class="hljs-comment">// 优雅关闭管理器</span>
}
</code></pre>
<ul>
<li><strong>初始化过程</strong></li>
</ul>
<p>实现：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 入口函数：创建并初始化分片日志数据库</span>
OpenShardedDB(config, cb, dirs, lldirs, batched, check, fs, kvf):


    <span class="hljs-comment">// ===阶段1：安全验证===</span>
    <span class="hljs-keyword">if</span> 配置为空 then <span class="hljs-built_in">panic</span>
    <span class="hljs-keyword">if</span> check和batched同时为<span class="hljs-literal">true</span> then <span class="hljs-built_in">panic</span>


    <span class="hljs-comment">// ===阶段2：预分配资源管理器===</span>
    shards := 空数组
    closeAll := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(all []*db)</span></span> { <span class="hljs-comment">//出错清理工具</span>
        <span class="hljs-keyword">for</span> s in all {
            s.<span class="hljs-built_in">close</span>()
        }
    }


    <span class="hljs-comment">// ===阶段3：逐个创建分片===</span>
    loop i := <span class="hljs-number">0</span> → 分片总数:
        datadir := pathJoin(dirs[i], <span class="hljs-string">"logdb-"</span>+i)  <span class="hljs-comment">//数据目录</span>
        snapdir := <span class="hljs-string">""</span>                           <span class="hljs-comment">//快照目录(可选)</span>
        <span class="hljs-keyword">if</span> lldirs非空 {
            snapdir = pathJoin(lldirs[i], <span class="hljs-string">"logdb-"</span>+i)
        }


        shardCb := {shard:i, callback:cb}      <span class="hljs-comment">//监控回调</span>
        db, err := openRDB(...)                <span class="hljs-comment">//创建实际数据库实例</span>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {                        <span class="hljs-comment">//创建失败</span>
            closeAll(shards)                   <span class="hljs-comment">//清理已创建的</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
        }
        shards = <span class="hljs-built_in">append</span>(shards, db)


    <span class="hljs-comment">// ===阶段5：核心组件初始化===</span>
    partitioner := 新建分区器(execShards数量, logdbShards数量)
    instance := &amp;ShardedDB{
        shards:      shards,
        partitioner: partitioner,
        compactions: 新建压缩管理器(),
        compactionCh: 通道缓冲<span class="hljs-number">1</span>,
        ctxs:       <span class="hljs-built_in">make</span>([]IContext, 执行分片数),
        stopper:    新建停止器()
    }


    <span class="hljs-comment">// ===阶段6：预分配上下文&amp;启动后台===</span>
    <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span> → 执行分片数:
        instance.ctxs[j] = 新建Context(saveBufferSize)


    instance.stopper.RunWorker(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {        <span class="hljs-comment">//后台压缩协程</span>
        instance.compactionWorkerMain()
    })


    <span class="hljs-keyword">return</span> instance, <span class="hljs-literal">nil</span>                      <span class="hljs-comment">//构造完成</span>
    
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf2eb6e670ef456ab963d69428fd6ee7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764827819&amp;x-signature=FVFpk1utqCy1yEUH0vS2wyREjnc%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>保存集群状态</strong></li>
</ul>
<p>实现：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *ShardedDB)</span></span> SaveRaftState(updates []pb.Update, shardID <span class="hljs-type">uint64</span>) <span class="hljs-type">error</span> {
    <span class="hljs-keyword">if</span> shardID<span class="hljs-number">-1</span> &gt;= <span class="hljs-type">uint64</span>(<span class="hljs-built_in">len</span>(s.ctxs)) {
        plog.Panicf(<span class="hljs-string">"invalid shardID %d, len(s.ctxs): %d"</span>, shardID, <span class="hljs-built_in">len</span>(s.ctxs))
    }
    ctx := s.ctxs[shardID<span class="hljs-number">-1</span>]
    ctx.Reset()
    <span class="hljs-keyword">return</span> s.SaveRaftStateCtx(updates, ctx)
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *ShardedDB)</span></span> SaveRaftStateCtx(updates []pb.Update, ctx IContext) <span class="hljs-type">error</span> {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(updates) == <span class="hljs-number">0</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
    pid := s.getParititionID(updates)
    <span class="hljs-keyword">return</span> s.shards[pid].saveRaftState(updates, ctx)
}
</code></pre>
<p><strong>以sylas为例子，我们每个分片都是单一cluster，所以logdb只使用了一个分片，龙舟设计初衷是为了解放多cluster的吞吐，我们暂时用不上，tindb可以考虑</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b3817e02c52463c96161e7aebcb1f4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764827819&amp;x-signature=G6gqXptWwv8ORHxaY%2FM2fhsBPkE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">四、总结</h2>
<p>LogDB是Dragonboat重要的存储层实现，作者将Pebble引擎包装为一组通用简洁的API，极大方便了上层应用与存储引擎的交互成本。</p>
<p>其中包含了很多Go语言的技巧，例如大量的内存变量复用设计，展示了这个库对高性能的极致追求，是一个十分值得学习的优秀工程案例。</p>
<h3 data-id="heading-9">往期回顾</h3>
<p>1. 从数字到版面：得物数据产品里数字格式化的那些事</p>
<p>2. 一文解析得物自建 Redis 最新技术演进</p>
<p>3. Golang HTTP请求超时与重试：构建高可靠网络请求｜得物技术</p>
<p>4. RN与hawk碰撞的火花之C++异常捕获｜得物技术</p>
<p>5. 得物TiDB升级实践</p>
<h3 data-id="heading-10">文 /酒米</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【数据操作与可视化】Pandas数据处理-其他操作]]></title>    <link>https://juejin.cn/post/7576894999096066075</link>    <guid>https://juejin.cn/post/7576894999096066075</guid>    <pubDate>2025-11-27T01:52:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576894999096066075" data-draft-id="7575533124878630939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【数据操作与可视化】Pandas数据处理-其他操作"/> <meta itemprop="keywords" content="pandas,Python"/> <meta itemprop="datePublished" content="2025-11-27T01:52:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI小云"/> <meta itemprop="url" content="https://juejin.cn/user/4153318871926912"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【数据操作与可视化】Pandas数据处理-其他操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4153318871926912/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI小云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T01:52:36.000Z" title="Thu Nov 27 2025 01:52:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【数据操作与可视化】Pandas数据处理-其他操作</h2>
<h4 data-id="heading-1">一、不同df进行拼接</h4>
<p>有时我们需要把不同的df合在一起，这时就要用到dataframe的拼接操作。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
df1 = pd.read_excel(<span class="hljs-string">r'数据拼接.xlsx'</span>)    <span class="hljs-comment"># 3行4列</span>
df2 = pd.read_excel(<span class="hljs-string">r'数据拼接.xlsx'</span>, sheet_name=<span class="hljs-string">'data2'</span>)   <span class="hljs-comment"># 4行3列</span>
pd.concat([df1, df2])  <span class="hljs-comment"># 默认竖向拼接</span>
pd.concat([df1, df2], ignore_index=<span class="hljs-literal">True</span>)   <span class="hljs-comment"># 重新自动设置索引</span>
pd.concat([df1, df2], axis=<span class="hljs-number">1</span>)   <span class="hljs-comment"># 设置横向拼接</span>
<span class="hljs-comment"># 练习：利用concat方法在df中间插入一条记录</span>
<span class="hljs-comment"># 思路：先把原来的df拆分成两部分，然后再把它们和新的那行拼接在一起即可</span>
df = pd.read_excel(<span class="hljs-string">'数值操作.xlsx'</span>)
df_first = df[:<span class="hljs-number">5</span>]
df_second = df[<span class="hljs-number">5</span>:]
df_new = pd.DataFrame({<span class="hljs-string">'订单编号'</span>:<span class="hljs-string">'AAAA'</span>,
                       <span class="hljs-string">'客户姓名'</span>: <span class="hljs-string">'billy'</span>,
                       <span class="hljs-string">'唯一识别码'</span>: <span class="hljs-number">999</span>,
                       <span class="hljs-string">'购买日期'</span>: <span class="hljs-string">'2020-09-10'</span>,
                       <span class="hljs-string">'年龄'</span>: <span class="hljs-number">18</span>,
                       <span class="hljs-string">'消费金额'</span>: <span class="hljs-number">1000</span>}, index=[<span class="hljs-number">0</span>])
pd.concat([df_first, df_new, df_second], ignore_index=<span class="hljs-literal">True</span>)
</code></pre>
<h4 data-id="heading-2">二、数据分组</h4>
<p>分组操作相当于数据库中的group by操作，通常用于对数据进行统计操作</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. </span>
<span class="hljs-built_in">df</span> = pd.read_excel(<span class="hljs-string">'数据分组.xlsx'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">df</span>)
<span class="hljs-comment"># 通过group by指定分组依据。注意，统计方法后面不能加参数，比如count后面不能有参数，否则报错</span>
<span class="hljs-built_in">print</span>(df.groupby(<span class="hljs-string">'学生ID'</span>).count())
<span class="hljs-comment"># print(df.groupby('学生ID').count('科目'))  # 报错</span>
<span class="hljs-comment"># sum操作只针对于float，int等数值类型的列才进行操作</span>
<span class="hljs-built_in">print</span>(df.groupby(<span class="hljs-string">'学生ID'</span>).<span class="hljs-built_in">sum</span>())
<span class="hljs-comment"># 按照多列来进行分组，如果分组后面没有指定列名，默认会对所有列进行count操作</span>
<span class="hljs-built_in">print</span>(df.groupby([<span class="hljs-string">'学生ID'</span>, <span class="hljs-string">'科目'</span>]).count())
<span class="hljs-comment"># 分组后面的列叫统计列。，可以在group by后面指定列名。如果要统计的列有多列的话，必须加[]括起来</span>
<span class="hljs-built_in">print</span>(df.groupby([<span class="hljs-string">'学生ID'</span>])[[<span class="hljs-string">'成绩'</span>]].count())   <span class="hljs-comment"># 学生ID分组后，只统计成绩这列</span>
<span class="hljs-built_in">print</span>(df.groupby([<span class="hljs-string">'学生ID'</span>])[[<span class="hljs-string">'成绩'</span>, <span class="hljs-string">'授课老师'</span>]].count())<span class="hljs-comment"># 统计成绩和授课老师两列</span>
<span class="hljs-comment"># aggregate方法的使用, 它可以同时在指定的统计列上做不同的统计计算,也就是想同时进行多种统计计算时，可以使用aggregate方法来实现</span>
<span class="hljs-built_in">print</span>(df.groupby(<span class="hljs-string">'所在年级'</span>)[[<span class="hljs-string">'成绩'</span>, <span class="hljs-string">'年龄'</span>]].aggregate([<span class="hljs-string">'mean'</span>, <span class="hljs-string">'max'</span>]))
<span class="hljs-comment"># 分组后再对不同的字段采用不同的统计方法</span>
<span class="hljs-built_in">print</span>(df.groupby(<span class="hljs-string">'所在年级'</span>).aggregate({
    <span class="hljs-string">'科目'</span>: <span class="hljs-string">'count'</span>,   <span class="hljs-comment"># 针对科目这列计数</span>
    <span class="hljs-string">'成绩'</span>: <span class="hljs-string">'mean'</span>,
    <span class="hljs-string">'年龄'</span>: <span class="hljs-string">'max'</span>
}))
<span class="hljs-built_in">print</span>(df.groupby(<span class="hljs-string">'所在年级'</span>).aggregate({
    <span class="hljs-string">'科目'</span>: <span class="hljs-string">'count'</span>,   
    <span class="hljs-string">'成绩'</span>: <span class="hljs-string">'mean'</span>,
    <span class="hljs-string">'年龄'</span>: [<span class="hljs-string">'max'</span>, <span class="hljs-string">'median'</span>]   <span class="hljs-comment"># 对某一列进行多种统计</span>
}))
</code></pre>
<h4 data-id="heading-3">三、数据导出</h4>
<p>在pandas中要将df导出为其他格式的文件，只需要统一调用pandas的to_xxx()方法即可。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在工作路径导出为excel文件。注意，有些电脑上可能会出现缺乏openyxl模块导致的错误，如果报错的话可以自己用pip装一下。</span>
df1.to_excel(<span class="hljs-string">'test.xlsx'</span>)
<span class="hljs-comment"># 指定sheet名称</span>
df1.to_excel(<span class="hljs-string">'test.xlsx'</span>, sheet_name=<span class="hljs-string">'新sheet'</span>)
<span class="hljs-comment"># 去掉默认的索引</span>
df.to_excel(<span class="hljs-string">r'导出数据.xlsx'</span>, index = <span class="hljs-literal">False</span>)
<span class="hljs-comment"># 设置要导出的列</span>
df.to_excel(<span class="hljs-string">r'导出数据.xlsx'</span>, index=<span class="hljs-literal">False</span>, columns=[<span class="hljs-string">'列2'</span>, <span class="hljs-string">'列3'</span>])
<span class="hljs-comment"># 导出为csv文件时，含有中文必须加encoding参数</span>
df.to_csv(<span class="hljs-string">'测试保存csv.csv'</span>, encoding=<span class="hljs-string">'utf_8_sig'</span>)  <span class="hljs-comment"># encoding可以设置为utf_8_sig和gbk</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3 张动图秒懂 A2A 协议：打造高效 Multi-Agent 协同机制]]></title>    <link>https://juejin.cn/post/7576994308272766995</link>    <guid>https://juejin.cn/post/7576994308272766995</guid>    <pubDate>2025-11-27T03:36:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576994308272766995" data-draft-id="7576935292428501034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3 张动图秒懂 A2A 协议：打造高效 Multi-Agent 协同机制"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-11-27T03:36:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3 张动图秒懂 A2A 协议：打造高效 Multi-Agent 协同机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:36:43.000Z" title="Thu Nov 27 2025 03:36:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>随着 AI Agent（智能体）技术的爆发，未来我们也必将从“人与 AI 对话”的时代迈向“AI 与 AI 协作”的时代。然而，目前的 Agent 大多像是“独行侠”——它们各自拥有相关的专业能力，却很难跨越框架、跨越服务器进行协作。</p>
<p>而Google 发布的 <strong>A2A (Agent2Agent) Protocol正是</strong>为了解决这类问题。其作用未来或许可以和Anthropic 推出的 <strong>MCP (Model Context Protocol)相媲美。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2de2734935794dd38ed8b78f1f7824d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819403&amp;x-signature=%2B840KRc8DDrcvowUvS77ojJei1s%3D" alt="" loading="lazy"/></p>
<p><strong>本文将借助一些可视化动图解析 A2A 协议的技术细节，并深度剖析它与 MCP 的本质区别。</strong></p>
<h2 data-id="heading-0">1 什么是 A2A (Agent2Agent) 协议？</h2>
<p>准化 AI Agent 之间通信的开放标准</p>
<p><strong>A2A 协议</strong> 是一套旨在标准化 AI Agent 之间通信的开放标准。如果说 HTTP 协议连接了互联网上的服务器，那么 A2A 协议就是连接不同 AI Agent 的通用语言。</p>
<p>它的核心目标是解决<strong>互操作性（Interoperability）</strong> 。无论 Agent 是由 Google Vertex AI、LangChain 还是 AutoGen 构建，只要遵循 A2A 标准，它们就能互相发现、握手并协作完成任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d221da52e8a4fb18636a4a6279a0d83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819403&amp;x-signature=%2BW2mdaPKGi3%2FukcHk8xb3yBh2Zw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-1">A2A 的核心组件</h4>
<p>在 A2A 的架构中，Agent 之间的交互不再是简单的文本传输，而是结构化的“任务委托”：</p>
<ul>
<li><strong>Agent Card (身份卡片)</strong> ： 这是 Agent 的“名片”或 JSON 元数据文件。它声明了 Agent 的身份、能力（Capabilities）、支持的输入格式以及认证方式。Client Agent 通过读取 Server Agent 的 Card 来决定是否将任务委派给它。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72eaccd0760b410a8093de4e245419f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819403&amp;x-signature=tjBZ%2FvuwPOkuPPlIqIX0giOsHVg%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>Task (任务生命周期)： A2A 将交互视为“任务”。一个任务拥有明确的状态流转：<code>Submitted</code>（已提交） -&gt; <code>Working</code>（进行中） -&gt; <code>Input-Required</code>（需人工/外部介入） -&gt; <code>Completed</code>（完成）。这种状态管理对于长链路的异步协作至关重要。</p>
</li>
<li>
<p>Message &amp; Artifact (消息与工件)： Agent 之间不仅交换对话（Message），还交换结构化的产出物（Artifact）。例如，一个“旅行规划 Agent”完成任务后，返回的不仅仅是一句“做好了”，而是一个包含航班信息、酒店预订号的结构化 JSON Artifact。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d587bffa6cef443db699aecd75884a4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819403&amp;x-signature=F252IcySr%2F4SoWLoOk7nSf7WxwE%3D" alt="" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-2">2 A2A vs. MCP</h2>
<p>不仅仅是名字的区别</p>
<p>很多开发者容易混淆 A2A 和 MCP，因为它们都旨在“连接”事物。但它们的<strong>连接对象</strong>和<strong>抽象层级</strong>完全不同。我们可以通过一个核心维度来区分它们：<strong>垂直整合 vs. 水平协作</strong>。</p>
<h4 data-id="heading-3">1. 垂直 vs. 水平 (Vertical vs. Horizontal)</h4>
<ul>
<li><strong>MCP (垂直整合 - 工具层)：</strong> MCP 解决的是 <strong>Agent 如何连接“世界”</strong>  的问题。它是 Agent 与外部数据（如本地文件、GitHub 仓库、数据库）或工具（如执行代码、搜索 API）之间的管道。</li>
</ul>

<ul>
<li><em>方向：</em>  向下扎根。</li>
<li><em>关系：</em>  主从关系（Client - Host - Server）。Agent 是大脑，MCP Server 是手和眼。</li>
</ul>

<ul>
<li><strong>A2A (水平协作 - 社交层)：</strong> A2A 解决的是 <strong>Agent 如何连接“同伴”</strong>  的问题。它是 Agent 寻找其他 Agent 帮忙的协议。</li>
</ul>

<ul>
<li><em>方向：</em>  向外扩展。</li>
<li><em>关系：</em>  对等或委托关系（Peer-to-Peer）。Agent A 委托 Agent B，Agent B 是另一个独立的大脑。</li>
</ul>
<h4 data-id="heading-4">技术特性的深度对比表</h4>








































<table><thead><tr><th>特性</th><th>MCP (Model Context Protocol)</th><th>A2A (Agent2Agent Protocol)</th></tr></thead><tbody><tr><td><strong>核心目标</strong></td><td>连接模型与上下文（数据/工具）</td><td>连接 Agent 与 Agent（协作/分工）</td></tr><tr><td><strong>通信模式</strong></td><td>主要是同步请求/响应 (RPC-like)</td><td>支持长运行任务、异步、状态流转</td></tr><tr><td><strong>数据流向</strong></td><td>Agent :资源/Prompt</td><td>Client Agent : Server Agent</td></tr><tr><td><strong>抽象层级</strong></td><td><strong>功能级</strong>：读文件、查库、调API</td><td><strong>任务级</strong>：如规划旅行、编写代码、审核合同等</td></tr><tr><td><strong>典型载体</strong></td><td>本地进程 (Stdio) 或 SSE</td><td>HTTP/WebSockets (跨网络)</td></tr><tr><td><strong>主要解决</strong></td><td>幻觉问题、上下文获取困难</td><td>孤岛问题、复杂任务拆解能力不足</td></tr></tbody></table>
<p>在实际的企业级应用中，A2A 和 MCP 并不是非此即彼的，而是<strong>互补</strong>的。未来的 AI 应用架构将呈现出“分层协作”的形态：</p>
<h2 data-id="heading-5"> 3 总结</h2>
<p>A2A 和 MCP 的互补性</p>
<ul>
<li>如果你正在构建一个需要访问本地文件、数据库或特定 API 的 Agent，你需要 <strong>MCP</strong>。</li>
<li>如果你正在构建一个由多个 Agent 组成的“专家团队”，需要让它们互相派活、同步进度，你需要 <strong>A2A</strong>。</li>
</ul>
<p><strong><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f45a54b452c34fe6b857d6d30b826d20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819403&amp;x-signature=rWA7Y4wA1KPCxZWNRa1jj3VU0NE%3D" alt="" loading="lazy"/></strong></p>
<p><strong>A2A 构建了 Agent 的社会关系，而 MCP 赋予了 Agent 改变世界的手脚。</strong>  两者的结合，正是从单一的大语言模型迈向真正的通用人工智能生态系统的关键一步。</p>
<h3 data-id="heading-6">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-43、左旋转字符串]]></title>    <link>https://juejin.cn/post/7577189654472261658</link>    <guid>https://juejin.cn/post/7577189654472261658</guid>    <pubDate>2025-11-27T04:07:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577189654472261658" data-draft-id="7575065042158174258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 剑指offer-43、左旋转字符串"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-27T04:07:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             剑指offer-43、左旋转字符串
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T04:07:41.000Z" title="Thu Nov 27 2025 04:07:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>汇编语⾔中有⼀种移位指令叫做循环左移（ ROL ），现在有个简单的任务，就是⽤字符串模拟这个指令的运算结果。对于⼀个给定的字符序列 S ，请你把其循环左移 K 位后的序列输出。例如，字符序列S=”abcXYZdef” ,要求输出循环左移3位后的结果，即“ XYZdefabc ”。是不是很简单？OK，搞定它！</p>
<h2 data-id="heading-1">思路及解答</h2>
<p>这道题⽬的意思就是将前⾯ n 位，移动到后⾯，那么我们可以直接从第 n+1 位开始，遍历到最后⼀个，再拼接上前⾯ n 个。</p>
<h3 data-id="heading-2">暴力移位</h3>
<p>通过k次单步左移实现循环左移。将第一个字符保存，其余字符前移，最后字符放到末尾</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">leftRotateString</span><span class="hljs-params">(String str, <span class="hljs-type">int</span> n)</span> {
        <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span> || str.length() == <span class="hljs-number">0</span> || n &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> str;
        }
        
        <span class="hljs-type">char</span>[] chars = str.toCharArray();
        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> chars.length;
        n %= len; <span class="hljs-comment">// 处理n大于字符串长度的情况</span>
        
        <span class="hljs-comment">// 执行n次单步左移</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; k &lt; n; k++) {
            <span class="hljs-comment">// 单步左移：保存首字符，其余前移，最后放回首字符</span>
            <span class="hljs-type">char</span> <span class="hljs-variable">firstChar</span> <span class="hljs-operator">=</span> chars[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; len - <span class="hljs-number">1</span>; i++) {
                chars[i] = chars[i + <span class="hljs-number">1</span>];
            }
            chars[len - <span class="hljs-number">1</span>] = firstChar;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(chars);
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(k×n)，其中k为移动次数，n为字符串长度</li>
<li><strong>空间复杂度</strong>：O(1)，只使用固定额外空间</li>
</ul>
<h3 data-id="heading-3">字符串切片法（推荐）</h3>
<p>值得注意的是， n 可能⼤于 str 的⻓度，那么这种情况下我们应该先对 str 的⻓度取余，保持严谨。即是： n = n % str.length(); 。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

	<span class="hljs-keyword">public</span> String <span class="hljs-title function_">LeftRotateString</span><span class="hljs-params">(String str, <span class="hljs-type">int</span> n)</span> {
		<span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span> || str.length() == <span class="hljs-number">0</span> || n &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> str;
        }
		<span class="hljs-type">String</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
		n = n % str.length();
		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> n; i &lt; str.length(); ++i) {
			ret += str.charAt(i);
		}
		
		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; ++i) {
			ret += str.charAt(i);
		}
		<span class="hljs-keyword">return</span> ret;
	}

}
</code></pre>
<ul>
<li>时间复杂度 O(n)</li>
<li>空间复杂度 O(n) 。</li>
</ul>
<p>或者可以用substring 的API</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">leftRotateString</span><span class="hljs-params">(String str, <span class="hljs-type">int</span> n)</span> {
        <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span> || str.length() == <span class="hljs-number">0</span> || n &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> str;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> str.length();
        n %= len; <span class="hljs-comment">// 处理n大于字符串长度的情况</span>
        
        <span class="hljs-comment">// 直接截取并拼接：后部分 + 前部分</span>
        <span class="hljs-keyword">return</span> str.substring(n) + str.substring(<span class="hljs-number">0</span>, n);
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，substring操作需要线性时间</li>
<li><strong>空间复杂度</strong>：O(n)，创建新的字符串对象</li>
</ul>
<h3 data-id="heading-4">三次反转（数学优美）</h3>
<p>利用数学规律：BA = (A'B')'，通过三次反转实现循环左移。</p>
<p>分别反转前n位、剩余部分，最后整体反转</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">leftRotateString</span><span class="hljs-params">(String str, <span class="hljs-type">int</span> n)</span> {
        <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span> || str.length() == <span class="hljs-number">0</span> || n &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> str;
        }
        
        <span class="hljs-type">char</span>[] chars = str.toCharArray();
        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> chars.length;
        n %= len;
        
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> str; <span class="hljs-comment">// 移动0位直接返回</span>
        
        <span class="hljs-comment">// 第一步：反转前n个字符</span>
        reverse(chars, <span class="hljs-number">0</span>, n - <span class="hljs-number">1</span>);
        <span class="hljs-comment">// 第二步：反转剩余字符</span>
        reverse(chars, n, len - <span class="hljs-number">1</span>);
        <span class="hljs-comment">// 第三步：整体反转</span>
        reverse(chars, <span class="hljs-number">0</span>, len - <span class="hljs-number">1</span>);
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(chars);
    }
    
    <span class="hljs-comment">/**
     * 反转字符数组中指定范围的字符
     * <span class="hljs-doctag">@param</span> chars 字符数组
     * <span class="hljs-doctag">@param</span> start 起始索引
     * <span class="hljs-doctag">@param</span> end 结束索引
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reverse</span><span class="hljs-params">(<span class="hljs-type">char</span>[] chars, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> {
        <span class="hljs-keyword">while</span> (start &lt; end) {
            <span class="hljs-comment">// 交换首尾字符</span>
            <span class="hljs-type">char</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> chars[start];
            chars[start] = chars[end];
            chars[end] = temp;
            start++;
            end--;
        }
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，每个字符被访问两次</li>
<li><strong>空间复杂度</strong>：O(1)，原地操作，只使用常数空间</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NocoBase 本周更新汇总：优化及缺陷修复]]></title>    <link>https://juejin.cn/post/7576928310788554804</link>    <guid>https://juejin.cn/post/7576928310788554804</guid>    <pubDate>2025-11-27T04:11:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576928310788554804" data-draft-id="7576914798057095220" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NocoBase 本周更新汇总：优化及缺陷修复"/> <meta itemprop="keywords" content="开源,资讯,低代码"/> <meta itemprop="datePublished" content="2025-11-27T04:11:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NocoBase"/> <meta itemprop="url" content="https://juejin.cn/user/180779873743566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NocoBase 本周更新汇总：优化及缺陷修复
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180779873743566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NocoBase
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T04:11:11.000Z" title="Thu Nov 27 2025 04:11:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fweekly-updates-20251127" target="_blank" title="https://www.nocobase.com/cn/blog/weekly-updates-20251127" ref="nofollow noopener noreferrer">www.nocobase.com/cn/blog/wee…</a></p>
<p>汇总一周产品更新日志，最新发布可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Ftimeline" target="_blank" title="https://www.nocobase.com/cn/blog/timeline" ref="nofollow noopener noreferrer">前往我们的博客查看</a>。</p>
<p><strong>NocoBase 目前更新包括的版本更新包括三个分支：<code>main</code> ，<code>next</code>和 <code>develop</code>。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cbfcb316a2649969c446d5ce5528959~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764821471&amp;x-signature=tybfEctJUqsbM5cX2FFzeAnBFf8%3D" alt="version.png" loading="lazy"/></p>
<p><code>main</code> ：截止目前最稳定的版本，推荐安装此版本。</p>
<p><code>next</code>：包含即将发布的新功能，经过初步测试的版本，可能存在部分已知或未知问题。主要面向测试用户，用于收集反馈和进一步优化功能。适合愿意提前体验新功能并提供反馈的测试用户。</p>
<p><code>develop</code>：开发中的版本，包含最新的功能代码，可能尚未完成或存在较多不稳定因素，主要用于内部开发和快速迭代。适合对产品功能前沿发展感兴趣的技术用户，但可能存在较多问题或不完整功能，不建议在生产环境中使用。</p>
<h2 data-id="heading-0">main</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/928da26b174f495b9476e3e0d6a53718~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764821471&amp;x-signature=2iXr3Awq3OQtPpSDCDdeF571ghM%3D" alt="main.png" loading="lazy"/></p>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.14" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.14" ref="nofollow noopener noreferrer">v1.9.14</a></h3>
<p><em>发布时间：2025-11-27</em></p>
<h3 data-id="heading-2">🎉 新特性</h3>
<ul>
<li><strong>[认证：OIDC]</strong> 支持选项 当用户未登录时自动跳转到 SSO 登录页 by @heziqiang</li>
</ul>
<h3 data-id="heading-3">🚀 优化</h3>
<ul>
<li><strong>[client]</strong> 对消息内容的变量使用三重括号，以免变量被 Handlerbars 转义 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7972" target="_blank" title="https://github.com/nocobase/nocobase/pull/7972" ref="nofollow noopener noreferrer">#7972</a>) by @mytharcher</li>
<li><strong>[数据表字段：Markdown(Vditor)]</strong> 调整 Vditor 全屏时内容宽度 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7974" target="_blank" title="https://github.com/nocobase/nocobase/pull/7974" ref="nofollow noopener noreferrer">#7974</a>) by @katherinehhh</li>
</ul>
<h3 data-id="heading-4">🐛 修复</h3>
<ul>
<li>
<p><strong>[database]</strong> 修复：移除 time 字段转换中的 UTC 处理，避免因时区导致的纯时间值偏移 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7812" target="_blank" title="https://github.com/nocobase/nocobase/pull/7812" ref="nofollow noopener noreferrer">#7812</a>) by @ChimingLiu</p>
</li>
<li>
<p><strong>[client]</strong> 修复 下拉列表组件在非对象值回显时没有正确显示 label 问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7975" target="_blank" title="https://github.com/nocobase/nocobase/pull/7975" ref="nofollow noopener noreferrer">#7975</a>) by @katherinehhh</p>
</li>
<li>
<p><strong>[工作流]</strong></p>
<ul>
<li>修复停止服务前，已创建的执行计划未发送到队列的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7981" target="_blank" title="https://github.com/nocobase/nocobase/pull/7981" ref="nofollow noopener noreferrer">#7981</a>) by @mytharcher</li>
<li>修复点击默认进入的待办列表中的任务跳转到错误页面的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7983" target="_blank" title="https://github.com/nocobase/nocobase/pull/7983" ref="nofollow noopener noreferrer">#7983</a>) by @mytharcher</li>
<li>修复部分工作流待办菜单不显示的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7980" target="_blank" title="https://github.com/nocobase/nocobase/pull/7980" ref="nofollow noopener noreferrer">#7980</a>) by @mytharcher</li>
<li>修复由于 provider 误用导致待办总数不展示的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7968" target="_blank" title="https://github.com/nocobase/nocobase/pull/7968" ref="nofollow noopener noreferrer">#7968</a>) by @mytharcher</li>
</ul>
</li>
<li>
<p><strong>[工作流：人工处理节点]</strong> 修复人工待办任务统计数字不对的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7984" target="_blank" title="https://github.com/nocobase/nocobase/pull/7984" ref="nofollow noopener noreferrer">#7984</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[数据可视化]</strong></p>
<ul>
<li>外部数据源表的筛选字段的配置项不能显示特有属性 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7982" target="_blank" title="https://github.com/nocobase/nocobase/pull/7982" ref="nofollow noopener noreferrer">#7982</a>) by @2013xile</li>
<li>解决图表数据查询不支持 ACL 数据范围的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7915" target="_blank" title="https://github.com/nocobase/nocobase/pull/7915" ref="nofollow noopener noreferrer">#7915</a>) by @2013xile</li>
</ul>
</li>
<li>
<p><strong>[数据源管理]</strong> 修复外部数据源修改密码后系统内无法更新密码的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7977" target="_blank" title="https://github.com/nocobase/nocobase/pull/7977" ref="nofollow noopener noreferrer">#7977</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[操作：导入记录]</strong> 修复树表导入数据报错问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7976" target="_blank" title="https://github.com/nocobase/nocobase/pull/7976" ref="nofollow noopener noreferrer">#7976</a>) by @cgyrock</p>
</li>
</ul>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.13" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.13" ref="nofollow noopener noreferrer">v1.9.13</a></h3>
<p><em>发布时间：2025-11-25</em></p>
<h3 data-id="heading-6">🐛 修复</h3>
<ul>
<li><strong>[client]</strong> 修复使用 Iframe 时，导致路由异常的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7957" target="_blank" title="https://github.com/nocobase/nocobase/pull/7957" ref="nofollow noopener noreferrer">#7957</a>) by @zhangzhonghe</li>
</ul>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.12" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.12" ref="nofollow noopener noreferrer">v1.9.12</a></h3>
<p><em>发布时间：2025-11-24</em></p>
<h3 data-id="heading-8">🚀 优化</h3>
<ul>
<li>
<p><strong>[client]</strong> 为更新记录和删除记录操作按钮添加加载状态，以避免重复请求 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7964" target="_blank" title="https://github.com/nocobase/nocobase/pull/7964" ref="nofollow noopener noreferrer">#7964</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[异步任务管理器]</strong> 优化异步任务的错误信息，任务失败时将明确提示具体的错误原因 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7796" target="_blank" title="https://github.com/nocobase/nocobase/pull/7796" ref="nofollow noopener noreferrer">#7796</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[操作：导入记录 Pro]</strong> 优化异步任务的错误信息，任务失败时将明确提示具体的错误原因 by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复审批人选择组件，仅允许用户表的主外键可选 by @mytharcher</li>
<li>减少打开审批弹窗时加载的关联数据，以提供更好的性能表现 by @mytharcher</li>
<li>在手动执行（或子流程调用）时，同时支持传入整行数据或仅主键，避免触发器数据中的数据一致性问题 by @mytharcher</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">🐛 修复</h3>
<ul>
<li><strong>[异步任务管理器]</strong> 为 <code>asyncTasks</code> 数据表增加迁移规则，避免异步任务记录被迁移 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7950" target="_blank" title="https://github.com/nocobase/nocobase/pull/7950" ref="nofollow noopener noreferrer">#7950</a>) by @mytharcher</li>
<li><strong>[工作流：审批]</strong> 修复语言文件 by @mytharcher</li>
</ul>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.11" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.11" ref="nofollow noopener noreferrer">v1.9.11</a></h3>
<p><em>发布时间：2025-11-24</em></p>
<h3 data-id="heading-11">🐛 修复</h3>
<ul>
<li><strong>[client]</strong> 修复外部数据源配置 belongsTo 字段时，field interface 显示为 many to one 而非 one to one 的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7936" target="_blank" title="https://github.com/nocobase/nocobase/pull/7936" ref="nofollow noopener noreferrer">#7936</a>) by @cgyrock</li>
<li><strong>[工作流]</strong> 修复了更新待办数量时意外导致填写中的表单状态被重置的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7937" target="_blank" title="https://github.com/nocobase/nocobase/pull/7937" ref="nofollow noopener noreferrer">#7937</a>) by @mytharcher</li>
<li><strong>[数据表字段：多对多 (数组)]</strong> 修复多对多（数组）字段在新增/修改关联数据时的异常行为 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7926" target="_blank" title="https://github.com/nocobase/nocobase/pull/7926" ref="nofollow noopener noreferrer">#7926</a>) by @cgyrock</li>
</ul>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.10" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.10" ref="nofollow noopener noreferrer">v1.9.10</a></h3>
<p><em>发布时间：2025-11-20</em></p>
<h3 data-id="heading-13">🚀 优化</h3>
<ul>
<li><strong>[权限控制]</strong> 缩小 member 角色的默认权限 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7921" target="_blank" title="https://github.com/nocobase/nocobase/pull/7921" ref="nofollow noopener noreferrer">#7921</a>) by @2013xile</li>
<li><strong>[数据可视化]</strong> 为插件界面添加了俄语支持。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7676" target="_blank" title="https://github.com/nocobase/nocobase/pull/7676" ref="nofollow noopener noreferrer">#7676</a>) by @sembaev-a-a</li>
<li><strong>[工作流：Webhook 触发器]</strong> 为响应节点增加图标 by @mytharcher</li>
</ul>
<h3 data-id="heading-14">🐛 修复</h3>
<ul>
<li><strong>[client]</strong> 修复错误： Can't resolve 'antd-mobile' 和 Can't resolve 'antd-mobile-icons' (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7914" target="_blank" title="https://github.com/nocobase/nocobase/pull/7914" ref="nofollow noopener noreferrer">#7914</a>) by @zhangzhonghe</li>
<li><strong>[权限控制]</strong> 关系字段关联操作支持数据范围限制 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7919" target="_blank" title="https://github.com/nocobase/nocobase/pull/7919" ref="nofollow noopener noreferrer">#7919</a>) by @2013xile</li>
<li><strong>[数据源：主数据库]</strong> 修复增加一对多字段后在重启应用前无法选择外键字段的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7907" target="_blank" title="https://github.com/nocobase/nocobase/pull/7907" ref="nofollow noopener noreferrer">#7907</a>) by @cgyrock</li>
</ul>
<h2 data-id="heading-15">next</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/174c3b0c093443d58675a87313f692b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764821471&amp;x-signature=OX2LRH9rL0Ld0yGWKmLZYujDvUw%3D" alt="next.png" loading="lazy"/></p>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.0-beta.17" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.0-beta.17" ref="nofollow noopener noreferrer">v1.9.0-beta.17</a></h3>
<p><em>发布时间：2025-11-21</em></p>
<h3 data-id="heading-17">🚀 优化</h3>
<ul>
<li>
<p><strong>[database]</strong> 对 MariaDB 连接实例增加 <code>multipleStatements</code> 选项，以支持一次查询中调用多条语句 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7781" target="_blank" title="https://github.com/nocobase/nocobase/pull/7781" ref="nofollow noopener noreferrer">#7781</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[权限控制]</strong></p>
<ul>
<li>缩小 member 角色的默认权限 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7921" target="_blank" title="https://github.com/nocobase/nocobase/pull/7921" ref="nofollow noopener noreferrer">#7921</a>) by @2013xile</li>
<li>优化关系字段关联操作的权限控制逻辑 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7800" target="_blank" title="https://github.com/nocobase/nocobase/pull/7800" ref="nofollow noopener noreferrer">#7800</a>) by @2013xile</li>
</ul>
</li>
<li>
<p><strong>[数据可视化]</strong> 为插件界面添加了俄语支持。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7676" target="_blank" title="https://github.com/nocobase/nocobase/pull/7676" ref="nofollow noopener noreferrer">#7676</a>) by @sembaev-a-a</p>
</li>
<li>
<p><strong>[工作流]</strong> 支持工作流中的数据区块使用一致的详情区块配置菜单 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7771" target="_blank" title="https://github.com/nocobase/nocobase/pull/7771" ref="nofollow noopener noreferrer">#7771</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：Webhook 触发器]</strong> 为响应节点增加图标 by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：JavaScript 节点]</strong> 修复传递到执行环境中的上层函数导致的安全漏洞，避免通过利用漏洞访问上层执行环境的问题 by @mytharcher</p>
</li>
<li>
<p><strong>[认证：OIDC]</strong> 增加请求超时时间 by @2013xile</p>
</li>
<li>
<p><strong>[工作流：审批]</strong> 在转签和加签时通知新的审批人 by @mytharcher</p>
</li>
</ul>
<h3 data-id="heading-18">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>修复外部数据源配置 belongsTo 字段时，field interface 显示为 many to one 而非 one to one 的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7936" target="_blank" title="https://github.com/nocobase/nocobase/pull/7936" ref="nofollow noopener noreferrer">#7936</a>) by @cgyrock</li>
<li>修复错误：Can't resolve 'antd-mobile' 和 Can't resolve 'antd-mobile-icons' (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7914" target="_blank" title="https://github.com/nocobase/nocobase/pull/7914" ref="nofollow noopener noreferrer">#7914</a>) by @zhangzhonghe</li>
<li>修复拖拽引用模板后再删除引用模板而导致的复制模板不显示的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7847" target="_blank" title="https://github.com/nocobase/nocobase/pull/7847" ref="nofollow noopener noreferrer">#7847</a>) by @zhangzhonghe</li>
<li>修复审批表单的联动规则不生效的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7858" target="_blank" title="https://github.com/nocobase/nocobase/pull/7858" ref="nofollow noopener noreferrer">#7858</a>) by @zhangzhonghe</li>
<li>修复详情区块简单分页出现空数据下一页的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7784" target="_blank" title="https://github.com/nocobase/nocobase/pull/7784" ref="nofollow noopener noreferrer">#7784</a>) by @katherinehhh</li>
<li>修复 “Maximum call stack size exceeded” (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7780" target="_blank" title="https://github.com/nocobase/nocobase/pull/7780" ref="nofollow noopener noreferrer">#7780</a>) by @zhangzhonghe</li>
</ul>
</li>
<li>
<p><strong>[server]</strong></p>
<ul>
<li>修复服务拆分模式下未订阅无法发布队列消息的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7875" target="_blank" title="https://github.com/nocobase/nocobase/pull/7875" ref="nofollow noopener noreferrer">#7875</a>) by @mytharcher</li>
<li>使用应用名称隔离发布订阅的频道 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7762" target="_blank" title="https://github.com/nocobase/nocobase/pull/7762" ref="nofollow noopener noreferrer">#7762</a>) by @mytharcher</li>
<li>修复消息队列在启用服务拆分模式后，工作进程发消息导致报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7797" target="_blank" title="https://github.com/nocobase/nocobase/pull/7797" ref="nofollow noopener noreferrer">#7797</a>) by @mytharcher</li>
</ul>
</li>
<li>
<p><strong>[utils]</strong> 为 intersect 策略增加对象类型支持 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7840" target="_blank" title="https://github.com/nocobase/nocobase/pull/7840" ref="nofollow noopener noreferrer">#7840</a>) by @chenos</p>
</li>
<li>
<p><strong>[database]</strong> 字段名为 snake_case 风格时，索引字段判断不正确的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7776" target="_blank" title="https://github.com/nocobase/nocobase/pull/7776" ref="nofollow noopener noreferrer">#7776</a>) by @2013xile</p>
</li>
<li>
<p><strong>[数据表字段：多对多 (数组)]</strong> 修复多对多（数组）字段在新增/修改关联数据时的异常行为 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7926" target="_blank" title="https://github.com/nocobase/nocobase/pull/7926" ref="nofollow noopener noreferrer">#7926</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[数据源：主数据库]</strong> 修复增加一对多字段后在重启应用前无法选择外键字段的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7907" target="_blank" title="https://github.com/nocobase/nocobase/pull/7907" ref="nofollow noopener noreferrer">#7907</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[工作流]</strong></p>
<ul>
<li>修复了更新待办数量时意外导致填写中的表单状态被重置的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7937" target="_blank" title="https://github.com/nocobase/nocobase/pull/7937" ref="nofollow noopener noreferrer">#7937</a>) by @mytharcher</li>
<li>使用底层事件队列代替共享后台任务队列，以避免共享队列在服务拆分模式下会被错误消费的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7871" target="_blank" title="https://github.com/nocobase/nocobase/pull/7871" ref="nofollow noopener noreferrer">#7871</a>) by @mytharcher</li>
<li>修复服务拆分模式下，工作流插件不处于服务模式时仍然消费队列的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7820" target="_blank" title="https://github.com/nocobase/nocobase/pull/7820" ref="nofollow noopener noreferrer">#7820</a>) by @mytharcher</li>
<li>修复监听不存在的外部数据源事件产生的报错 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7855" target="_blank" title="https://github.com/nocobase/nocobase/pull/7855" ref="nofollow noopener noreferrer">#7855</a>) by @mytharcher</li>
<li>修复在服务拆分模式下，手动执行带中断节点的工作流一直等待的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7767" target="_blank" title="https://github.com/nocobase/nocobase/pull/7767" ref="nofollow noopener noreferrer">#7767</a>) by @mytharcher</li>
<li>为工作流的日志增加 <code>workflowId</code> 的数据标识 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7789" target="_blank" title="https://github.com/nocobase/nocobase/pull/7789" ref="nofollow noopener noreferrer">#7789</a>) by @mytharcher</li>
<li>修复了集群模式下工作流调度器无法正确识别空闲状态的问题，该问题可能导致插件未就绪就开始消费队列事件 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7768" target="_blank" title="https://github.com/nocobase/nocobase/pull/7768" ref="nofollow noopener noreferrer">#7768</a>) by @mytharcher</li>
</ul>
</li>
<li>
<p><strong>[权限控制]</strong></p>
<ul>
<li>关系字段关联操作支持数据范围限制 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7919" target="_blank" title="https://github.com/nocobase/nocobase/pull/7919" ref="nofollow noopener noreferrer">#7919</a>) by @2013xile</li>
<li>关系字段关联操作 snippets 不生效的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7876" target="_blank" title="https://github.com/nocobase/nocobase/pull/7876" ref="nofollow noopener noreferrer">#7876</a>) by @2013xile</li>
</ul>
</li>
<li>
<p><strong>[工作流：人工处理节点]</strong> 修复翻译语言指向的命名空间，以正确的翻译内容 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7877" target="_blank" title="https://github.com/nocobase/nocobase/pull/7877" ref="nofollow noopener noreferrer">#7877</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[用户]</strong> 字段名为 snake_case 风格时，索引字段重置不正确的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7785" target="_blank" title="https://github.com/nocobase/nocobase/pull/7785" ref="nofollow noopener noreferrer">#7785</a>) by @2013xile</p>
</li>
<li>
<p><strong>[移动端（已废弃）]</strong> 修复移动端的日期字段默认值弹窗无法选中日期的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7783" target="_blank" title="https://github.com/nocobase/nocobase/pull/7783" ref="nofollow noopener noreferrer">#7783</a>) by @zhangzhonghe</p>
</li>
<li>
<p><strong>[工作流：自定义变量节点]</strong> 修复变量节点缺失 config 时报错的问题 by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：自定义操作事件]</strong> 修复监听不存在的外部数据源事件产生的报错 by @mytharcher</p>
</li>
<li>
<p><strong>[模板打印]</strong> 解析 filter 中变量 by @jiannx</p>
</li>
<li>
<p><strong>[数据可视化：EChrats]</strong> 修复 Echarts 选项配置 Label type 不生效的问题 by @heziqiang</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复待办中心审批列表卡片上的日期格式，展示完整的日期和时间 by @mytharcher</li>
<li>修复通知渠道分页数量太小加载不全的问题 by @mytharcher</li>
<li>修复提交审批处理时查询审批记录列表的性能问题 by @mytharcher</li>
<li>修复重查关系数据时未屏蔽主表字段的问题 by @mytharcher</li>
<li>修复由于多个审批人并发处理审批时的竞态导致的节点重复执行的问题 by @mytharcher</li>
<li>并行分支中不再支持创建审批节点，避免流程状态导致的问题 by @mytharcher</li>
<li>修复审批表单的联动规则不生效的问题 by @zhangzhonghe</li>
<li>修复复制审批工作流时报错的问题 by @mytharcher</li>
</ul>
</li>
<li>
<p><strong>[邮件管理]</strong></p>
<ul>
<li>添加同步日志 by @jiannx</li>
<li>没有时间戳的情况下同步微软邮件已读状态 by @jiannx</li>
<li>mailMessages 添加索引 by @jiannx</li>
<li>给索引添加迁移脚本 by @jiannx</li>
<li>修复 Outlook 内敛图片和同步问题 by @jiannx</li>
</ul>
</li>
</ul>
<h2 data-id="heading-19">develop</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7b96260b2774504844b7b4695b02df7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764821471&amp;x-signature=bBUYij57PqNqk%2Bjw6Lj%2B%2BuUZsMM%3D" alt="develop.png" loading="lazy"/></p>
<h3 data-id="heading-20"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.47" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.47" ref="nofollow noopener noreferrer">v2.0.0-alpha.47</a></h3>
<p><em>发布时间：2025-11-26</em></p>
<h3 data-id="heading-21">🚀 优化</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>支持在图表查询初始时选择筛选字段 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7933" target="_blank" title="https://github.com/nocobase/nocobase/pull/7933" ref="nofollow noopener noreferrer">#7933</a>) by @heziqiang</li>
<li>对消息内容的变量使用三重括号，以免变量被 Handlerbars 转义 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7972" target="_blank" title="https://github.com/nocobase/nocobase/pull/7972" ref="nofollow noopener noreferrer">#7972</a>) by @mytharcher</li>
<li>为更新记录和删除记录操作按钮添加加载状态，以避免重复请求 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7964" target="_blank" title="https://github.com/nocobase/nocobase/pull/7964" ref="nofollow noopener noreferrer">#7964</a>) by @mytharcher</li>
</ul>
</li>
<li>
<p><strong>[数据表字段：Markdown(Vditor)]</strong> 调整 Vditor 全屏时内容宽度 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7974" target="_blank" title="https://github.com/nocobase/nocobase/pull/7974" ref="nofollow noopener noreferrer">#7974</a>) by @katherinehhh</p>
</li>
</ul>
<h3 data-id="heading-22">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>修复非 id 关系字段弹窗详情区块打开报错。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7973" target="_blank" title="https://github.com/nocobase/nocobase/pull/7973" ref="nofollow noopener noreferrer">#7973</a>) by @gchust</li>
<li>修复非 id 关系字段弹窗中关系数据加载错误的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7970" target="_blank" title="https://github.com/nocobase/nocobase/pull/7970" ref="nofollow noopener noreferrer">#7970</a>) by @gchust</li>
<li>修复使用 Iframe 时，导致路由异常的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7957" target="_blank" title="https://github.com/nocobase/nocobase/pull/7957" ref="nofollow noopener noreferrer">#7957</a>) by @zhangzhonghe</li>
<li>修复数字字段格式化精度设置无效的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7967" target="_blank" title="https://github.com/nocobase/nocobase/pull/7967" ref="nofollow noopener noreferrer">#7967</a>) by @katherinehhh</li>
<li>修复新建 2.0 页面的类型不正确的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7945" target="_blank" title="https://github.com/nocobase/nocobase/pull/7945" ref="nofollow noopener noreferrer">#7945</a>) by @zhangzhonghe</li>
<li>修复点击筛选重置按钮时筛选值未清空的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7966" target="_blank" title="https://github.com/nocobase/nocobase/pull/7966" ref="nofollow noopener noreferrer">#7966</a>) by @zhangzhonghe</li>
</ul>
</li>
<li>
<p><strong>[工作流]</strong> 修复由于 provider 误用导致待办总数不展示的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7968" target="_blank" title="https://github.com/nocobase/nocobase/pull/7968" ref="nofollow noopener noreferrer">#7968</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[数据可视化]</strong> 解决图表数据查询不支持 ACL 数据范围的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7915" target="_blank" title="https://github.com/nocobase/nocobase/pull/7915" ref="nofollow noopener noreferrer">#7915</a>) by @2013xile</p>
</li>
<li>
<p><strong>[区块：引用]</strong> 修复引用区块会将被引用区块从原始页面中移除的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7969" target="_blank" title="https://github.com/nocobase/nocobase/pull/7969" ref="nofollow noopener noreferrer">#7969</a>) by @gchust</p>
</li>
<li>
<p><strong>[AI 员工]</strong> 修复AI员工生成 SQL 异常输出的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7956" target="_blank" title="https://github.com/nocobase/nocobase/pull/7956" ref="nofollow noopener noreferrer">#7956</a>) by @heziqiang</p>
</li>
<li>
<p><strong>[模板打印]</strong> 修复表格行中模板打印操作添加模板失败问题 by @katherinehhh</p>
</li>
</ul>
<h3 data-id="heading-23"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.46" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.46" ref="nofollow noopener noreferrer">v2.0.0-alpha.46</a></h3>
<p><em>发布时间：2025-11-24</em></p>
<h3 data-id="heading-24">🚀 优化</h3>
<ul>
<li>
<p><strong>[flow-engine]</strong> 支持动态切换 flow model 类型 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7952" target="_blank" title="https://github.com/nocobase/nocobase/pull/7952" ref="nofollow noopener noreferrer">#7952</a>) by @gchust</p>
</li>
<li>
<p><strong>[AI 员工]</strong> AI 员工插件添加 upgrade 钩子函数 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7951" target="_blank" title="https://github.com/nocobase/nocobase/pull/7951" ref="nofollow noopener noreferrer">#7951</a>) by @heziqiang</p>
</li>
<li>
<p><strong>[异步任务管理器]</strong> 优化异步任务的错误信息，任务失败时将明确提示具体的错误原因 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7796" target="_blank" title="https://github.com/nocobase/nocobase/pull/7796" ref="nofollow noopener noreferrer">#7796</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>在手动执行（或子流程调用）时，同时支持传入整行数据或仅主键，避免触发器数据中的数据一致性问题 by @mytharcher</li>
<li>减少打开审批弹窗时加载的关联数据，以提供更好的性能表现 by @mytharcher</li>
<li>修复审批人选择组件，仅允许用户表的主外键可选 by @mytharcher</li>
</ul>
</li>
</ul>
<h3 data-id="heading-25">🐛 修复</h3>
<ul>
<li><strong>[client]</strong> 文本字段在详情区块中超出内容宽度时应默认换行 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7955" target="_blank" title="https://github.com/nocobase/nocobase/pull/7955" ref="nofollow noopener noreferrer">#7955</a>) by @katherinehhh</li>
<li><strong>[异步任务管理器]</strong> 为 <code>asyncTasks</code> 数据表增加迁移规则，避免异步任务记录被迁移 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7950" target="_blank" title="https://github.com/nocobase/nocobase/pull/7950" ref="nofollow noopener noreferrer">#7950</a>) by @mytharcher</li>
<li><strong>[文件管理器]</strong> 修复表单附件字段上传未按设置使用指定文件存储器的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7947" target="_blank" title="https://github.com/nocobase/nocobase/pull/7947" ref="nofollow noopener noreferrer">#7947</a>) by @katherinehhh</li>
<li><strong>[工作流：审批]</strong> 修复语言文件 by @mytharcher</li>
</ul>
<h3 data-id="heading-26"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.45" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.45" ref="nofollow noopener noreferrer">v2.0.0-alpha.45</a></h3>
<p><em>发布时间：2025-11-21</em></p>
<h3 data-id="heading-27">🎉 新特性</h3>
<ul>
<li><strong>[client]</strong> 支持表格列字段开启排序 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7900" target="_blank" title="https://github.com/nocobase/nocobase/pull/7900" ref="nofollow noopener noreferrer">#7900</a>) by @katherinehhh</li>
<li><strong>[工作流]</strong> 新增“多条件分支”节点，提供类似 <code>switch</code> / <code>case</code> 的控制流程 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7878" target="_blank" title="https://github.com/nocobase/nocobase/pull/7878" ref="nofollow noopener noreferrer">#7878</a>) by @mytharcher</li>
</ul>
<h3 data-id="heading-28">🐛 修复</h3>
<ul>
<li><strong>[client]</strong> 修复多级联选择器清空数据时报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7943" target="_blank" title="https://github.com/nocobase/nocobase/pull/7943" ref="nofollow noopener noreferrer">#7943</a>) by @katherinehhh</li>
<li><strong>[数据可视化]</strong> 修复图表配置保存后区块没有更新的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7920" target="_blank" title="https://github.com/nocobase/nocobase/pull/7920" ref="nofollow noopener noreferrer">#7920</a>) by @heziqiang</li>
<li><strong>[模板打印]</strong> 修复详情区块模板打印按钮报错问题 by @katherinehhh</li>
</ul>
<h3 data-id="heading-29"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.44" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.44" ref="nofollow noopener noreferrer">v2.0.0-alpha.44</a></h3>
<p><em>发布时间：2025-11-21</em></p>
<h3 data-id="heading-30">🎉 新特性</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>为关系字段下拉选择器增加快捷新增能力 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7887" target="_blank" title="https://github.com/nocobase/nocobase/pull/7887" ref="nofollow noopener noreferrer">#7887</a>) by @katherinehhh</li>
<li>支持树表关系字段使用级联选择器 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7846" target="_blank" title="https://github.com/nocobase/nocobase/pull/7846" ref="nofollow noopener noreferrer">#7846</a>) by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[遥测]</strong> 新增插件：遥测，基于 OpenTelemetry 的应用遥测插件，内置 CPU、内存、HTTP 请求等指标，并支持通过 HTTP 导出 by @2013xile</p>
</li>
</ul>
<h3 data-id="heading-31">🚀 优化</h3>
<ul>
<li><strong>[telemetry]</strong> 支持控制需要上报的指标 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7938" target="_blank" title="https://github.com/nocobase/nocobase/pull/7938" ref="nofollow noopener noreferrer">#7938</a>) by @2013xile</li>
<li><strong>[异步任务管理器]</strong> 在子应用中执行异步任务时，异步进程只启动对应的子应用 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7927" target="_blank" title="https://github.com/nocobase/nocobase/pull/7927" ref="nofollow noopener noreferrer">#7927</a>) by @2013xile</li>
</ul>
<h3 data-id="heading-32">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>修复树表按钮显示在非树表区块中的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7931" target="_blank" title="https://github.com/nocobase/nocobase/pull/7931" ref="nofollow noopener noreferrer">#7931</a>) by @katherinehhh</li>
<li>修复外部数据源配置 belongsTo 字段时，field interface 显示为 many to one 而非 one to one 的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7936" target="_blank" title="https://github.com/nocobase/nocobase/pull/7936" ref="nofollow noopener noreferrer">#7936</a>) by @cgyrock</li>
</ul>
</li>
<li>
<p><strong>[flow-engine]</strong> 修复详情区块按钮的工具栏图标显示错位的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7929" target="_blank" title="https://github.com/nocobase/nocobase/pull/7929" ref="nofollow noopener noreferrer">#7929</a>) by @zhangzhonghe</p>
</li>
<li>
<p><strong>[工作流]</strong> 修复了更新待办数量时意外导致填写中的表单状态被重置的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7937" target="_blank" title="https://github.com/nocobase/nocobase/pull/7937" ref="nofollow noopener noreferrer">#7937</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[数据表字段：多对多 (数组)]</strong> 修复多对多（数组）字段在新增/修改关联数据时的异常行为 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7926" target="_blank" title="https://github.com/nocobase/nocobase/pull/7926" ref="nofollow noopener noreferrer">#7926</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[操作：导入记录 Pro]</strong> 修复导入 Pro 操作允许上传时修改导入选项不生效的问题 by @katherinehhh</p>
</li>
</ul>
<h3 data-id="heading-33"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.43" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.43" ref="nofollow noopener noreferrer">v2.0.0-alpha.43</a></h3>
<p><em>发布时间：2025-11-20</em></p>
<h3 data-id="heading-34">🚀 优化</h3>
<ul>
<li><strong>[数据可视化]</strong> 为插件界面添加了俄语支持。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7676" target="_blank" title="https://github.com/nocobase/nocobase/pull/7676" ref="nofollow noopener noreferrer">#7676</a>) by @sembaev-a-a</li>
<li><strong>[权限控制]</strong> 缩小 member 角色的默认权限 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7921" target="_blank" title="https://github.com/nocobase/nocobase/pull/7921" ref="nofollow noopener noreferrer">#7921</a>) by @2013xile</li>
<li><strong>[工作流：Webhook 触发器]</strong> 为响应节点增加图标 by @mytharcher</li>
</ul>
<h3 data-id="heading-35">🐛 修复</h3>
<ul>
<li><strong>[client]</strong> 修复错误： Can't resolve 'antd-mobile' 和 Can't resolve 'antd-mobile-icons' (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7914" target="_blank" title="https://github.com/nocobase/nocobase/pull/7914" ref="nofollow noopener noreferrer">#7914</a>) by @zhangzhonghe</li>
<li><strong>[flow-engine]</strong> 修复打开表格区块的快捷编辑表单报错的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7923" target="_blank" title="https://github.com/nocobase/nocobase/pull/7923" ref="nofollow noopener noreferrer">#7923</a>) by @gchust</li>
<li><strong>[前端流引擎]</strong> 修复记录变量解析问题：当同时使用记录本身和其字段时，始终返回完整记录。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7917" target="_blank" title="https://github.com/nocobase/nocobase/pull/7917" ref="nofollow noopener noreferrer">#7917</a>) by @gchust</li>
<li><strong>[数据源：主数据库]</strong> 修复增加一对多字段后在重启应用前无法选择外键字段的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7907" target="_blank" title="https://github.com/nocobase/nocobase/pull/7907" ref="nofollow noopener noreferrer">#7907</a>) by @cgyrock</li>
<li><strong>[权限控制]</strong> 关系字段关联操作支持数据范围限制 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7919" target="_blank" title="https://github.com/nocobase/nocobase/pull/7919" ref="nofollow noopener noreferrer">#7919</a>) by @2013xile</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis实战：5个高频应用场景下的性能优化技巧，让你的QPS提升50%]]></title>    <link>https://juejin.cn/post/7576936862632607744</link>    <guid>https://juejin.cn/post/7576936862632607744</guid>    <pubDate>2025-11-27T04:16:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576936862632607744" data-draft-id="7576928310788571188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis实战：5个高频应用场景下的性能优化技巧，让你的QPS提升50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-27T04:16:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis实战：5个高频应用场景下的性能优化技巧，让你的QPS提升50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T04:16:41.000Z" title="Thu Nov 27 2025 04:16:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis实战：5个高频应用场景下的性能优化技巧，让你的QPS提升50%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Redis作为高性能的内存数据库，在现代分布式系统中扮演着至关重要的角色。无论是缓存加速、会话管理还是实时排行榜，Redis都能显著提升系统性能。然而，随着业务规模的增长和流量峰值的出现，如何充分挖掘Redis的潜力成为开发者面临的关键挑战。</p>
<p>本文将深入分析Redis在五种典型应用场景中的性能瓶颈，并提供经过生产验证的优化技巧。这些方法不仅来自官方文档的最佳实践，更结合了笔者在大型互联网公司处理高并发场景的一线经验。通过合理配置和针对性优化，你的Redis实例QPS（Queries Per Second）有望提升50%甚至更高。</p>
<h2 data-id="heading-2">一、热点数据缓存优化</h2>
<h3 data-id="heading-3">1.1 问题诊断</h3>
<p>热点Key问题是缓存场景中最常见的性能杀手。当某个Key的访问量远超其他Key时（如电商秒杀商品），会导致：</p>
<ul>
<li>单个Redis实例CPU飙高</li>
<li>集群模式下数据倾斜</li>
<li>网络带宽成为瓶颈</li>
</ul>
<h3 data-id="heading-4">1.2 优化方案</h3>
<p><strong>多级缓存架构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码示例：本地缓存+Redis两级缓存</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getData</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-comment">// 1.检查本地缓存</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> localCache.get(key);
    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> value;
    
    <span class="hljs-comment">// 2.检查Redis缓存</span>
    value = redis.get(key);
    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
        localCache.put(key, value); <span class="hljs-comment">// 回填本地缓存</span>
        <span class="hljs-keyword">return</span> value;
    }
    
    <span class="hljs-comment">// 3.回源数据库...</span>
}
</code></pre>
<p><strong>Key拆分技术：</strong></p>
<ul>
<li>将大Value拆分为多个子Key（如<code>product:123 -&gt; product:123:base + product:123:detail</code>）</li>
<li>使用Hash分片存储（HSET product:123_detail field1 value1 field2 value2）</li>
</ul>
<p><strong>实战技巧：</strong></p>
<ol>
<li>Redis监控发现热点Key（使用<code>redis-cli --hotkeys</code>）</li>
<li>LRU策略调整为volatile-lru避免全量淘汰</li>
<li>Pipeline批量获取拆分后的子Key</li>
</ol>
<h2 data-id="heading-5">二、分布式锁的性能陷阱与突破</h2>
<h3 data-id="heading-6">2.1 Redlock的代价</h3>
<p>传统Redlock算法需要与半数以上节点通信，在高并发下：</p>
<ul>
<li>TPS从10万+骤降到不足1万</li>
<li>GC压力剧增导致STW问题</li>
</ul>
<h3 data-id="heading-7">2.2 CAS乐观锁方案</h3>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua脚本保证原子性</span>
<span class="hljs-keyword">local</span> current = redis.call(<span class="hljs-string">'GET'</span>, KEYS[<span class="hljs-number">1</span>])
<span class="hljs-keyword">if</span> current == ARGV[<span class="hljs-number">1</span>] <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">'SET'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>])
<span class="hljs-keyword">end</span>
<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
</code></pre>
<h3 data-id="heading-8">2.3 Lease机制优化版锁</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">acquire_lock_with_lease</span>(<span class="hljs-params">conn, lockname, lease_time=<span class="hljs-number">10</span></span>):
    identifier = <span class="hljs-built_in">str</span>(uuid.uuid4())
    end = time.time() + lease_time
    
    <span class="hljs-keyword">while</span> time.time() &lt; end:
        <span class="hljs-keyword">if</span> conn.setnx(lockname, identifier): 
            conn.expire(lockname, lease_time)
            <span class="hljs-keyword">return</span> identifier
        
        <span class="hljs-comment"># Lease续期逻辑省略...</span>
        
    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p><strong>关键改进点：</strong></p>
<ul>
<li>Lease时间从固定值改为动态计算（根据历史执行时间P99值）</li>
<li>Watch Dog异步续约避免客户端阻塞</li>
</ul>
<h2 data-id="heading-9">三、排行榜场景的极致优化</h2>
<h3 data-id="heading-10">3.1 ZSET的内存消耗分析</h3>
<p>存储100万成员的排行榜：</p>
<ul>
<li>Redis原生ZSET约消耗64MB内存（每个entry平均64字节）</li>
<li>Score使用double类型存在精度浪费</li>
</ul>
<h3 data-id="heading-11">3.2 Compact Storage模式设计</h3>
<pre><code class="hljs language-vbnet" lang="vbnet"># <span class="hljs-keyword">Key</span>设计改造前：
<span class="hljs-symbol">user:</span>score -&gt; ZSET {userid1:score1, userid2:score2,...}

# <span class="hljs-keyword">Key</span>设计改造后：
<span class="hljs-symbol">user:</span>vscore -&gt; <span class="hljs-type">STRING</span> (紧凑二进制存储)
<span class="hljs-symbol">user:</span>rank -&gt; ZSET {userid1:vscore_offset,...}
</code></pre>
<p><strong>效果对比：</strong></p>




















<table><thead><tr><th>Metric</th><th>Before</th><th>After</th></tr></thead><tbody><tr><td>Memory</td><td>~64MB</td><td>~24MB</td></tr><tr><td>ZADD QPS</td><td>~12k</td><td>~35k</td></tr></tbody></table>
<p>##四、消息队列的场景化调优</p>
<p>###4.1 List vs Stream的选择矩阵</p>















<table><thead><tr><th/><th>List</th><th>Stream</th></tr></thead><tbody><tr><td>消费确认</td><td>不支持</td><td>支持</td></tr></tbody></table>
<blockquote>
<p>注意表格对齐方式可能需要调整显示效果</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[双非同学校招笔记——离开字节入职小📕]]></title>    <link>https://juejin.cn/post/7576914798057127988</link>    <guid>https://juejin.cn/post/7576914798057127988</guid>    <pubDate>2025-11-27T04:19:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576914798057127988" data-draft-id="7575412016404496394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="双非同学校招笔记——离开字节入职小📕"/> <meta itemprop="keywords" content="前端,程序员,面试"/> <meta itemprop="datePublished" content="2025-11-27T04:19:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="July_lly"/> <meta itemprop="url" content="https://juejin.cn/user/2975757420726467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            双非同学校招笔记——离开字节入职小📕
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2975757420726467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    July_lly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T04:19:13.000Z" title="Thu Nov 27 2025 04:19:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body ::selection{color:#fff;background-color:#ed7373}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:.6em;margin-top:1.5em;padding-bottom:4px;color:#ed7373}.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5,.markdown-body h6{font-size:14px}.markdown-body p{line-height:inherit;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border-top:1px solid #dfe1e6;margin:33px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:rgba(239,198,221,.2666666667);color:#7b164f;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==") 10px 10px no-repeat;background-size:40px;background-color:#fdf8f8}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#fdf8f8}.markdown-body a{position:relative;text-decoration:underline;text-decoration-color:#ffd4d4;color:#ed7373;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAAAXNSR0IArs4c6QAAD1lJREFUeF7tnV122zgShQHJG5gT9/OkV2J7JR3voI/U707eI5/eQeyVRFlJa56nc2YDFjkHEulWHP3g5xZYAK5eku6QYOFWfSwUAJLW8EcFqMBJBSy1oQJU4LQCBITRQQXOKEBAGB5UgIAwBqhAnALMIHG68axGFCAgjTia3YxTgIDE6cazGlGAgDTiaHYzTgECEqcbz2pEAQLSiKPZzTgFCEicbjyrEQUISCOOZjfjFCAgcbrxrEYUICCNOJrdjFOAgMTpxrMaUYCANOJodjNOAQISpxvPakQBAtKIo9nNOAUISJxuPKsRBQhII45GdfN/v//+/l9//rlBtae9HQKi3UOZ7ft7sfhgjfm3sfa9u3RvzHtrjPv77r8PfpvemB0o1v3Z95tuNvt29fKyqQkgApI5ADVebgeFtTfGmA8I+3pj1rbv17Ouey4dFgKCiIgC2/i+WDwYax0QbzMDtDcjLC67/PL58xraeIbGCEgGkTVd4vty+QWVKUL75WCZb7f3JWUVAhLq5UKPHzLGRyXmP822208lgEJAlESMlBlDfeGyhsafelAIiMawAdjkpmO38/kXa8wtoDnRJvq+v79+fHwSvUhk4wQkUjjNp/33jz9uZ33/VbONP9nW9x/fPT5+0mYzAdHmkUR7lNUaob1RN+QiIKEuVHz838vl1xKGVOck1DbTRUAUB7yvaSXVG5592sy22zsNs1wExNNjWg+rEI5XqWfb7a9TQ0JAtEa+h101wzF0f/JMQkA8AlHjIQ3AMco+KSQERGP0X7CpITj2Skw4BUxACgOkOThG/0wECQEpCJBm4Rh81Fl7l3tHMAEpBJCJ4Hjq+/7bvOt229THGSVny8vV1W6b/Kzrbnprb088VAVXN/fMFgGBuxDfYE443L4oB0TM9OqwxcVtjJR7xiTzUIuA4OMZ2mI2OICBN+wgfpACJWcWISDQcMY2lgMOt7XjerW6w1q+b03sqUUgzJf6TUAuKTTRv+eAI8f0qdSwK1cWISATAXDusjngyDkj5PrTzedu+z2uNsmURQiIMkBqg2OUVwKSHFmEgCgCpFY4xCDJkEUIiBJAaodjlBlZuEtOMIz2EhAFgLQCxxtIIG9YkR5mEZCJAWkNjldIlsu/EEW79AsfCMiEgLQKx8EaCSKLPL1bre6l3EhApJS90G7LcKCziOQwi4BMAAjh+GGlPTmLSK7pEJDMgBCOfwRHvb9Lsg4hIBkBIRw/i/0dUawLrocQkEyAEI7jQoPeNi9WqBOQDIAQjtMig16uTUAyxLHIJQjHeVkRdYjkijoziAgW+0YJx2VxEYAYYzbvVqtfL18t/AgCEq6Z1xmEw0um3U2km8/dqnrS791qJRLLIo0m9bSCkwmHvxNBgDCD+Es+7ZGEI0x/DrHC9Cr6aMIR7j7ELBaL9HDds59BOOIkB33wh9O8cfLnOYtwxOsM+egPV9LjHSB9JuFIU/j7ctmntSD7cmvOYiV6B3IHPGOD5E7VxK4nnw4q0A03Kya7QqYBwpGmK6j+MFJrIK53zCCRPgZtsjt59Zozh+s0aP3DNSW2BkJAIuFATE2eu3TtcLi+w24wggU6AYkABDVuPnXpFuAAZg8jrReHWAGQIB177LLSzg7oqtih4Dcsig6vmEECw0CyKG8BDic3VEPh4RUBCQAENePSaubY1R2LxYOxNvklDa8aEpCACBY+FLKgdcTGZjLHYvHBWuu+PoX6iQ+vmEE8XQW/8w3XJRyeDjhymOTi4OHlWKRf8JFUYU444uGQXvsgIAG+kcgesXAM6y83/fAhGtv36242+5b708i+8kmtF+XKHhxiTZA9YuDwCLSn2Xb7KebLtL7BHnqch82hTY7HZ6k9xotxiHXGTejsEQXHcvnVGnPrEU2b2XZ7pwESQTjEFwbf6kxAzgGCeOvf2H7ElGQMoDmHH8ekk4RD8snBU2FAQE4oAy7Og594S7p+BIweGeriIZJw5CzMWaRfdDV0UStqzByTPX7oVt9/nHXdc64hV41wsEjPMLyKqTucWZAtGZkyiTAc2esOZpBMs1cpY2bIW89dP4UhkYZj6pqKNcgRWFBb2lO+fAQDxBiTYse5e4k0HMaY4NrNY/QcdAgBOSJX8vjf3biNWV+vVndB3jg4GPZA0b5N+BSwNByp+sXqzmleD+UQgMTWHqN5AgEIg0TAtrdemTxzjAYxgxzLIMul23X6wYOlU4dEzVy9bQw5zNq1DahHpOGYuuZgBvGI+uQZJEAgOjOHWsjB+t7DbK9DUgIQkVnPGZmadb0ECDyIGeR4Bkl6mRnS0WhIYsf2LcLhQoOACACCfk8T+Dnu4BetJa3qe9yxkTcUj8sFHUJAjgPiPugSO6yB1B9vzUJCEppFBLPHprP2Xut2fWaQE/eSxOJYBJDR1ETbXnscUosk12THdVYPBwE5AUhiQIgCAswk3tO+As/ji2oUNIa6cDCHWOBp3tDhS4wzUZD4ZhEkIDn0idH01DkEBAyIaw5dpB9zHqgu8FqQgw3rEncXIAPft60qAXF32JRt3qnBJ7X36a1TUwPX926O2Pbiey3fwM11XBWADGsFv5n9o6m72SfnkJ2Iff98/fj4FCJo6mpxrmnLVJCdJj4wp+pRKhxVFOmeBXXwSw2S7s6glXQfqJPs3N0/+nufG0jCdbyGcT59neKYYjNIxKfPvGdtnCM8wTvpM587M8LhgOGPVwDHTAz4wofQQaqNIgGJgGOvX8CdPXVYEXKtFOcm2+k5zHI2hmx7yTXMTNHO59ziAEne9uAJCeChqaCM5eOsY8cA7PSqQw6vPWSt13rvjV1PnbXPmlfHQ7QuChBEMIQUjAnj7uCMFeI09GxW7N1+54+uuxkmRf4z77p1yuxhigZS5xYDCAKOUUTfdQrELFGOoVZqvRQLiFRQamq3CECQcPhObY5OSs4iATNFsYGRamMNxXSsdpfOUw8IGg4nSMgdE5JFhCEhIJfCPP7fVQOCmKE5Ik3wRrnUABxtkLpTJ9vnOXERH2blnqkWECE4ot42gsoiodnLN6wAmwm91kJ87anpOJWAABa/Tvso8m6ZfJf+xyLo9G/ytPduCqr/+O7x8VNNgY3qizpAROEwJnh4NQodskh20TnAgITUaEB7Lva9sANUAZI6XXlB++Q7N3KohdqKgrApZNKisPhONlcNIMJwBM1cnVMVEZDIWgShGwrW5GhU2IAKQBBOPqct+g4JqUcAwxpI/ZHpAS+Fse9l0qSARG869Ora/iA0HK7NmJ2tP5kMAASUzaLrsgA3FHvopICUljkOvZwKCQJcRCYL2ZtWbJQnGD4ZICXDMeo93MHdO3yD36Hlux/slG8hs1ec4r2IziSAgIYGJzuHuDtfVG44IGr6FzG8An1gNKdWvppqOi47ILA73wkVp3B4ICTJY37gDSbZFk3BLGFLVkBQsy6nhJgCjtEWn5oEMd6HagjIZBJBqanNbIBAHXtEwSnhODRn2EP2MPy/sTaBPWWHrN20aKYJiLe2ZANEcguJVkenvp/rrbOQcEz13XHNMByzLQsgktlDKxzoQADWHXvTOLzyclEWQMB3vteOtQKHxNZ/bi/x4kP+AzpS2YNw+Dn46FHMHt7iiWcQiexBOLz9e+xATu0GyCcKiMSaB+EI8O6xQ5k9ggQUBQSxV+iwN4QjyLfMHslyCX7EE157NHLnkyjIxziRemkEIA7VNiGWQcDTkk28VEAUjgI/XqOBGjFAgMV5E0WlJBxcFIxHTQQQ5PCqhbpDGo7ZdntX2ztz40M+7EwRQICzV9VnD2E4RJ6oDAuxso8WAQRVf9S+2isNB4vydDhlAFku+3TT4t9hBbi2eBPScBhjmpjYkHaUXkAqntaVhgPx3Il04JXSPhwQVIFe6/CKcJSCxt5OrYBUWZwTjrLgEAEEMYNV4xCBcJQHhwggoECoqsAEaXIywmq8oWjBCT7EgkzxVlSgEw4toR5nBwGJ083rLMLhJZPqg/CALJdfjDHubYPxvwoyCOGId7+mM+GAgAKj6BoEpAFrDgWkqASk5KKTcCiIaqAJcEBanuYlHMDIVNIUHJBWV9IJh5KIBpsBB8TZB/gssSlpJyrhAEelouakAPkr5psZb3QpolAnHIqiWcAUEUBQj9tq37BIOAQiUlmTMoAsFh+stW49JO2neD2EcKS5tpSzRQBBzGSNAmrMIoSjlPBOt1MEkKFQR9Qh6t5CTjjSg66kFiQBSd9yMiqpZKhFOEoKbYytYoAgh1muq1MPtQgHJuBKa0UMEOgwa6/qZqr3OxGO0sIaZ68sIIvFg7H2I87c/JBAnm85I0DJ+86AflXblCggAlkkayZBreec8j7hUMvFq2HygOCzyM54ya0obj/Zdj7/Yo25lXIh4ZBSFtuuOCBCWWQPiTHr+XZ7j3zvrHS9Mdp9vVrdYV3J1iQUyAOIUBY5EORptt1+SgFlAMN933z8trmE3juoCYeItCKNZgFEMoscquKCz/b9etZ1zz6wDFDcmP1QShQMZg6R+BVvNBsgw7qIWzwUD8RBtU1vzMb93Q5/DkH63u5tyGXH63CQmUM8nuEXyAbILovID7XgAiEa5LAKoeI0bWQFpEVICMc0gY26anZActUjKIFS2iEcKerpOHcSQIbn1r/mrgNySk44cqotd61JAHHdqRkSwiEXsLlbngwQ19EJZrbE9SUc4hJnvcCkgFQHiZLnVrJGUOUXmxyQUV/pjYHSfmzhc9XSGmpsXw0gBU8Bbzpr73/5/Hmt0cG0KU0BVYAcQOLeDp91pTtGRtYbMaqVdY46QMa6xPb9g+R282Q3sd5IlrCEBlQCMgqndJariDc+lhB8JdioGpDXAn7/IjrxregXHJa8pb6EgKCNPypQBCATg0IwGqamKEB+GHp13U1v7a3Q1vWnvu+/XT8+PjUcG+z6/lGJ8n+uVhmK+nHmK2QGzD0zsnZAzLtu7fOgVfmKsQe+ClQByLHOur1eL1dXO1Bs170C089mm6uXl92DVITBN0zaPa5aQNp1KXuOVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFTg//8JNVC78ovQAAAAAElFTkSuQmCC");background-size:100%}.markdown-body a:active,.markdown-body a:hover{opacity:.66}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #ed7373;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#ed7373}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#fdf2f2}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #ed7373;background-color:#fdf2f2}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ed7373}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{appearance:none;-webkit-appearance:none;-moz-appearance:none;outline:none;width:16px;height:16px;border-radius:2px;background-color:transparent;box-shadow:inset 0 0 0 1px rgba(28,31,35,.3490196078);vertical-align:middle;margin:0;transform:translateY(-2px)}.markdown-body input[type=checkbox]:checked{background-color:#ed7373;background-image:url("data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjFlbSIgaGVpZ2h0PSIxZW0iIGFyaWEtaGlkZGVuPSJ0cnVlIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTE3LjQxMSA3LjMwOGExLjUgMS41IDAgMDEuMjggMi4xMDNsLTYuNSA4LjVhMS41IDEuNSAwIDAxLTIuMzc1LjAxbC0zLjUtNC41YTEuNSAxLjUgMCAxMTIuMzY4LTEuODQybDIuMzA2IDIuOTY1IDUuMzE4LTYuOTU1YTEuNSAxLjUgMCAwMTIuMTAzLS4yOHoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=");box-shadow:inset 0 0 0 1px #ed7373}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>本文纯属个人碎碎念，想到哪写到哪，不喜勿喷，也请不要上升到“公司员工文笔水平”这种维度。</p>
<h2 data-id="heading-0">一些概括</h2>
<p>接触前端也两年了。还记得 23 年初跟着 B 站黑马的课程学 HTML、CSS，从 <code>&lt;div /&gt;</code>、<code>&lt;span /&gt;</code> 这些最基础的标签开始，一点点摸索，再到后来接触 JavaScript、Vue、React。</p>
<p>学习的过程中，也在网上加入了不少学习群，认识了许多同路人、前辈和朋友。</p>
<p>当时写下这篇  👉 <a href="https://juejin.cn/post/7469428180028080140" target="_blank" title="https://juejin.cn/post/7469428180028080140">《快手 ks 前端实习小记》</a><br/>
还是我在快手的 last day。转眼 9 个多月过去，现在我又来到小红书，只能说——人生无常，大肠包小肠。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42cf71d283424fedbed655187898e30d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764821953&amp;x-signature=3O2OeIbn0qxlY%2BNpis2%2FC6Kf%2BSY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">关于秋招</h2>
<p>其实秋招我没投很多公司，一方面是在字节实习，另一方面很多公司也确实不太想去。当然，说实话，也没有几家公司来约我面试😄。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8856622c1fd04e0999a5e052b09fff0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764821953&amp;x-signature=DTpy8vB6CQnBbXnpIGTwECzkdXE%3D" alt="cdf952d901750c159e868b437ba05b73.jpg" loading="lazy"/></p>
<p>我在字节待过两个部门：直播和生服。<br/>
在直播待了半年，但因为 HC 的原因，连答辩流程都没推进。后来转去杭州的生服，两个月提前答辩通过了，但因为薪资和业务方向原因，最后还是没有过去，选择离职。</p>
<p>离职后，TT 直播连续给我发了 5 次面试邀请。虽然我说明了拒绝原因，但 HR 和老板还是希望我再面一下。于是 3 天推进了 3 轮。<br/>
记得 3 面老板问我最后的一个问题：</p>
<blockquote>
<p>“为什么你都过了，还离职拒了？”</p>
</blockquote>
<p>我如实说是薪资原因（但是没说业务原因）。老板说他下播后会跟另外两个面试官聊聊。<br/>
第二天我就收到了感谢信。</p>
<h2 data-id="heading-2">聊聊面试</h2>
<p>关于面试，我真的想说一句：<br/>
<strong>双非同学完全没必要太自卑。</strong></p>
<p>在字节、快手、小红书，我遇到的双非同事真的很多。能见到面试官这一关，学历的劣势基本就过去了；<br/>
真正会被卡掉的学历问题，大多都发生在简历筛选阶段。如果两个人技术能力差不多，HR 是会优先看学历的，这是现实；但只要你已经走到技术面了，那就只比实力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeb0fa6efdf6430c8639ea14c0f8ea3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764821953&amp;x-signature=X3OPxGUm74CJf%2BVLXalX0WQBJm8%3D" alt="4fa9faa2d8e2b8e2dcb48281c7832d98.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71eab806b4164361ad371d65ee62ecc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764821953&amp;x-signature=f258OOZgxB56Pjoe4J17I36CVwQ%3D" alt="b5c9478e559be882920d45b168f25f44.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ede8c64cfa74aa19d269064023914a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764821953&amp;x-signature=XnMalw8AdsSOd1yDldIvmdyMWIA%3D" alt="328f52e70e24a6e4da6297dacc6e328f.jpg" loading="lazy"/></p>
<h2 data-id="heading-3">结尾</h2>
<p>“红黄蓝”三家公司进进出出，一年多了。虽然我还是大四学生，但更多时候已经把自己当成一个刚踏入职场一年的年轻人。</p>
<p>以前在掘金看到那些感慨文，说不上不理解，但也没太有共鸣。那时候我以为掘金应该是讨论技术的地方。但现在逐渐理解了：工作占据了我们绝大多数时间，程序员要终身学习，而学习往往发生在为数不多的休息时间里，投入和产出常常不成正比，还伴随着所谓“中年危机”，于是，大家自然就会有更多感慨。</p>
<p>我也慢慢明白了（特别是在直播没转正、秋招又不算顺利的那段时间）：</p>
<p><strong>生活没有那么多必须烦恼的事。</strong><br/>
把工作做好，不要过度焦虑未来。<br/>
把握当下——<strong>在自己的能力范围内做自己真正想做的事</strong>。<br/>
不要因为浪费了时间、花了点钱而懊恼。</p>
<p>我们应该感受生活，而不是被生活推着走。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude回复太啰嗦？用Subagent打造你的专属AI团队]]></title>    <link>https://juejin.cn/post/7576994308272947219</link>    <guid>https://juejin.cn/post/7576994308272947219</guid>    <pubDate>2025-11-27T04:32:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576994308272947219" data-draft-id="7576861477267161107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude回复太啰嗦？用Subagent打造你的专属AI团队"/> <meta itemprop="keywords" content="Claude,AI编程"/> <meta itemprop="datePublished" content="2025-11-27T04:32:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术探索家"/> <meta itemprop="url" content="https://juejin.cn/user/2735240657517816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude回复太啰嗦？用Subagent打造你的专属AI团队
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2735240657517816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术探索家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T04:32:09.000Z" title="Thu Nov 27 2025 04:32:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca45628126054c75933e569fc4140e92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5o6i57Si5a62:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764823094&amp;x-signature=QN%2F3Nb8Wd3HdG7rHpiVeqkukSVA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>深夜两点，我盯着屏幕，看着Claude又一次给出了3000行的回复。我只是想让它帮我查一下代码里有没有安全隐患，结果它连重构建议、性能优化、测试用例全给我写了一遍。</p>
<p>说实话，当时我就想——能不能让它只关注代码审查，别扯那么多有的没的？</p>
<p>后来我发现，Subagent就是专门解决这个问题的。</p>
<h2 data-id="heading-0">Subagent到底是什么</h2>
<p>简单说，Subagent就是你给Claude定制的专属助手。每个助手有自己的任务范围、工具权限，甚至用的模型都可以不一样。</p>
<p>它们住在你项目的<code>.claude/agents/</code>目录里，每个文件就是一个助手。文件结构挺简单：上面是YAML配置，下面是Markdown写的详细提示词。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">code-reviewer</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">专门审查代码质量和安全隐患的助手</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Grep</span>, <span class="hljs-string">Glob</span>]
<span class="hljs-attr">model:</span> <span class="hljs-string">haiku</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">你是一个代码审查专家，专注于发现以下问题：</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">安全漏洞（SQL注入、XSS等）</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">性能瓶颈</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">代码规范问题</span>

<span class="hljs-string">你只需要指出问题，不要动手改代码。</span>
</code></pre>
<p>和普通的Claude对话比起来，Subagent有三个明显的不同：</p>
<p><strong>专注</strong>——它只干你规定的事，不会跑题。你让它审查代码，它就只审查，不会顺手帮你重构。</p>
<p><strong>受限</strong>——工具权限是你给的，它不能用你没授权的工具。一个只读的审查助手，根本没办法改你的文件。</p>
<p><strong>可复用</strong>——配置文件放在项目里，团队成员都能用。新人入职，直接<code>@code-reviewer</code>就能开始干活。</p>
<h2 data-id="heading-1">为什么需要Subagent</h2>
<p>老实说，我一开始觉得这东西是多此一举——直接跟Claude聊不就完了吗？</p>
<p>但用了一段时间之后，我发现确实香。</p>
<h3 data-id="heading-2">专注性</h3>
<p>Claude本身太全能了，你问它代码问题，它可能会顺便给你讲最佳实践、推荐框架、甚至帮你写文档。这些东西有时候有用，但大部分时候只是噪音。</p>
<p>Subagent能让它专注在单一任务上。一个专门做代码审查的助手，不会给你写重构方案；一个专门写测试的助手，不会质疑你的架构设计。</p>
<h3 data-id="heading-3">成本优化</h3>
<p>这个可能很多人没意识到——不是每个任务都需要用最贵的模型。</p>
<p>搜索、格式转换、简单的分析，用Haiku就够了，成本大概是Sonnet的三分之一。一个团队一个月下来，省的钱挺可观的。</p>
<h3 data-id="heading-4">并行处理</h3>
<p>这才是我觉得最爽的地方。</p>
<p>你可以同时启动多个任务，让它们并行跑。比如写完一个功能之后，同时让一个助手跑单元测试、一个做代码审查、一个写文档。实际体验下来，效率提升非常明显。</p>
<h3 data-id="heading-5">可复用性</h3>
<p>写好的配置文件，直接提交到Git仓库，团队成员都能用。项目积累下来的经验，变成了可执行的配置。</p>
<h2 data-id="heading-6">YAML配置详解</h2>
<p>说了这么多，具体怎么写配置文件呢？</p>
<p>一个完整的Subagent配置有几个字段，但只有两个是必须的：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">blog-writer</span>          <span class="hljs-comment"># 必需：助手的唯一标识</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">撰写博客初稿的专家</span>  <span class="hljs-comment"># 必需：简短描述，影响自动触发</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Write</span>, <span class="hljs-string">Grep</span>]  <span class="hljs-comment"># 可选：工具权限，默认是全部</span>
<span class="hljs-attr">model:</span> <span class="hljs-string">sonnet</span>              <span class="hljs-comment"># 可选：模型选择，默认继承主对话</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># 提示词写在YAML下面</span>
<span class="hljs-string">你是一个专业的博客写作者...</span>
</code></pre>
<p><strong>name</strong>——助手的ID，用于调用时识别。最好起个能一眼看懂的名字，比如<code>code-reviewer</code>、<code>test-writer</code>。</p>
<p><strong>description</strong>——这个很关键。Claude会根据描述来判断什么时候自动触发这个助手。如果你写"处理各种任务的通用助手"，那它基本永远不会被自动触发。</p>
<p>不好的写法：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">一个帮手</span>
</code></pre>
<p>好的写法：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">深度调研博客主题，生成结构化内容规划文档</span>
</code></pre>
<p><strong>tools</strong>——工具权限列表。没配置的话默认能用所有工具，但这其实不太好（后面会讲）。</p>
<p><strong>model</strong>——选择用哪个模型。<code>haiku</code>便宜快速，<code>sonnet</code>是默认的平衡选择，<code>opus</code>质量最高但最贵。</p>
<h2 data-id="heading-7">工具权限控制</h2>
<p>这一块我踩过坑，值得单独说说。</p>
<p>刚开始我图省事，所有Subagent都用默认的全权限。结果有一次，一个本来只应该做代码分析的助手，顺手帮我改了几个文件——改错了。</p>
<p>从那以后，我就开始认真对待工具权限了。原则挺简单：<strong>只给必需的权限，不多给</strong>。</p>
<p>常见的工具权限组合：</p>





























<table><thead><tr><th>任务类型</th><th>推荐工具组合</th></tr></thead><tbody><tr><td>只读分析</td><td><code>Read, Grep, Glob</code></td></tr><tr><td>搜索研究</td><td><code>Read, WebSearch, WebFetch</code></td></tr><tr><td>内容编辑</td><td><code>Read, Edit</code></td></tr><tr><td>内容创建</td><td><code>Read, Write, Edit</code></td></tr><tr><td>全权限</td><td><code>All tools</code>（谨慎使用）</td></tr></tbody></table>
<p>一个实际的对比：</p>
<p>不好的配置：给代码审查助手太多权限</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">code-reviewer</span>
<span class="hljs-attr">tools:</span> []  <span class="hljs-comment"># 空数组 = 全权限，这样不太安全</span>
<span class="hljs-meta">---
</span></code></pre>
<p>好的配置：只给只读权限</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">code-reviewer</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Grep</span>, <span class="hljs-string">Glob</span>]
<span class="hljs-meta">---
</span></code></pre>
<p>只读的审查助手，根本没办法误改你的代码。这种约束，反而是一种保护。</p>
<h2 data-id="heading-8">三种调用方式</h2>
<p>配置写好了，怎么调用呢？有三种方式：</p>
<h3 data-id="heading-9">自动触发</h3>
<p>如果你在description里写得够清楚，Claude会自动判断什么时候该调用。比如描述写"处理所有与代码审查相关的请求"，那你说"帮我审查一下这个PR"，它就会自动触发。</p>
<h3 data-id="heading-10">@-mention</h3>
<p>最直接的方式，直接<code>@agent-name</code>就行：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@code-reviewer</span> 帮我看看这个函数有没有问题
</code></pre>
<h3 data-id="heading-11">Task工具</h3>
<p>编程式调用，适合更复杂的场景：</p>
<pre><code class="hljs language-ini" lang="ini">Task(<span class="hljs-attr">subagent_type</span>=<span class="hljs-string">"code-reviewer"</span>, prompt=<span class="hljs-string">"审查src/目录下的所有文件"</span>)
</code></pre>





























<table><thead><tr><th>方式</th><th>语法</th><th>适用场景</th><th>特点</th></tr></thead><tbody><tr><td>自动触发</td><td>无需显式调用</td><td>明确关键词</td><td>方便但可能误触发</td></tr><tr><td>Task工具</td><td><code>Task(subagent_type="name")</code></td><td>编程式调用</td><td>精确控制</td></tr><tr><td>@-mention</td><td><code>@agent-name</code></td><td>交互式使用</td><td>直观但需要记名字</td></tr></tbody></table>
<p>我个人最常用@-mention，简单直接。自动触发有时候会误判，Task工具在复杂工作流里才用得上。</p>
<h2 data-id="heading-12">Multi-Agent协作</h2>
<p>说到这里，还只是单个助手的用法。Subagent真正强大的地方，是多个助手协作。</p>
<h3 data-id="heading-13">顺序模式</h3>
<p>我用得最多的是<strong>顺序模式</strong>，特别适合内容创作类的工作流：</p>
<pre><code class="hljs language-less" lang="less">用户输入主题
    |
<span class="hljs-variable">@blog-planner</span> 做调研、写大纲
    | 输出规划文档
<span class="hljs-variable">@blog-writer</span> 读取大纲、写初稿
    | 输出初稿
<span class="hljs-variable">@blog-editor</span> 读取初稿、润色发布
    | 输出最终稿
</code></pre>
<p>每个助手只负责一个环节，前一个的输出是后一个的输入。清晰、可控、容易调试。</p>
<h3 data-id="heading-14">并行模式</h3>
<p>并行模式就更爽了。写完一个功能之后，同时启动：</p>
<ul>
<li><code>@test-writer</code> 写单元测试</li>
<li><code>@code-reviewer</code> 做代码审查</li>
<li><code>@doc-writer</code> 写文档</li>
</ul>
<p>三个任务并行跑，互不干扰。原来要串行做30分钟的事，现在10分钟搞定。</p>
<h3 data-id="heading-15">HITL模式（Human In The Loop）</h3>
<p>还有一种模式，适合需要人工确认的场景：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@planner</span> 生成方案
    |
用户确认或修改
    |
<span class="hljs-variable">@executor</span> 执行方案
</code></pre>
<p>这种模式的好处是，关键决策点由人来把控，不会完全失控。</p>
<h2 data-id="heading-16">七个编写技巧</h2>
<p>用了几个月Subagent，我总结了7个让配置更好用的技巧：</p>
<h3 data-id="heading-17">技巧1：描述要精准</h3>
<p>description直接影响自动触发的准确性。</p>
<p>太模糊——几乎不会被自动触发：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">一个通用的助手</span>
</code></pre>
<p>精准描述——明确职责范围：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">专门审查Python代码的安全漏洞和性能问题</span>
</code></pre>
<h3 data-id="heading-18">技巧2：提示词要具体</h3>
<p>别只说"你是一个代码审查专家"，要告诉它具体怎么审查。</p>
<p>太笼统：</p>
<pre><code class="hljs language-markdown" lang="markdown">你是代码审查专家，帮用户审查代码。
</code></pre>
<p>具体指导：</p>
<pre><code class="hljs language-markdown" lang="markdown">你是Python代码安全审查专家。

<span class="hljs-section">## 审查重点</span>
<span class="hljs-bullet">1.</span> SQL注入风险 - 检查所有数据库操作
<span class="hljs-bullet">2.</span> XSS漏洞 - 检查用户输入的处理
<span class="hljs-bullet">3.</span> 敏感信息泄露 - 检查日志和错误处理

<span class="hljs-section">## 输出格式</span>
每个问题按以下格式报告：
<span class="hljs-bullet">-</span> 文件：xxx
<span class="hljs-bullet">-</span> 行号：xxx
<span class="hljs-bullet">-</span> 风险等级：高/中/低
<span class="hljs-bullet">-</span> 问题描述：xxx
<span class="hljs-bullet">-</span> 修复建议：xxx
</code></pre>
<h3 data-id="heading-19">技巧3：工具最小化</h3>
<p>前面说过了，只给必需的权限。少给权限不会让助手变笨，只是限制了它能做的事。</p>
<h3 data-id="heading-20">技巧4：模型选对</h3>
<p>简单任务用Haiku，复杂任务用Sonnet。具体来说：</p>
<ul>
<li><strong>Haiku适合</strong>：搜索汇总、格式转换、简单分析、数据整理</li>
<li><strong>Sonnet适合</strong>：复杂逻辑、创意内容、代码生成、推理分析</li>
</ul>
<h3 data-id="heading-21">技巧5：测试要充分</h3>
<p>写完配置之后，多试几种调用方式。自动触发好不好用？@-mention正不正常？边界情况怎么处理？</p>
<h3 data-id="heading-22">技巧6：文档要清晰</h3>
<p>提示词本身就是文档。写得清楚的话，团队成员一看就知道这个助手是干什么的、怎么用。</p>
<h3 data-id="heading-23">技巧7：迭代要频繁</h3>
<p>别想着一次就写完美。先写一个能用的版本，实际用一段时间，根据反馈慢慢调整。</p>
<h2 data-id="heading-24">常见错误避坑</h2>
<p>讲完技巧，再说说我踩过的坑：</p>
<h3 data-id="heading-25">坑1：描述太模糊</h3>
<p>写"通用助手"这种描述，Claude根本不知道什么时候该调用它。要写清楚具体负责什么。</p>
<p>不好：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">帮助用户的助手</span>
</code></pre>
<p>改进：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">当用户提到"测试"、"单元测试"时，自动生成测试用例</span>
</code></pre>
<h3 data-id="heading-26">坑2：工具权限过多</h3>
<p>图省事给全权限，结果助手做了你不希望它做的事。特别是Write权限，给之前要想清楚。</p>
<p>不好：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">format-converter</span>
<span class="hljs-attr">tools:</span> []  <span class="hljs-comment"># 空数组 = 全权限</span>
</code></pre>
<p>改进：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">format-converter</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Write</span>]
</code></pre>
<h3 data-id="heading-27">坑3：提示词太长</h3>
<p>Subagent的提示词也是算token的。写几千字的提示词，每次调用都要消耗这些token。保持简洁，只写必要的信息。</p>
<h3 data-id="heading-28">坑4：忘记设置model</h3>
<p>不设置model的话，默认会继承主对话的模型（通常是Sonnet）。简单任务白白多花钱。</p>
<p>忘了设置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">text-extractor</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>]
</code></pre>
<p>记得设置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">text-extractor</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>]
<span class="hljs-attr">model:</span> <span class="hljs-string">haiku</span>
</code></pre>
<h3 data-id="heading-29">坑5：循环调用</h3>
<p>Agent A调用Agent B，Agent B又调用Agent A。这种死循环会一直跑下去，直到超时或者你强制停止。</p>
<p>正确：A -&gt; B -&gt; C
错误：A -&gt; B -&gt; A</p>
<h3 data-id="heading-30">坑6：没有错误处理</h3>
<p>Subagent也会失败。在工作流里加上错误处理逻辑，失败了能及时发现。</p>
<h3 data-id="heading-31">坑7：配置没有版本控制</h3>
<p>配置文件要提交到Git。改了配置出了问题，能回滚到之前的版本。</p>
<h2 data-id="heading-32">实战案例：博客写作系统</h2>
<p>说了这么多理论，来看个实际的例子。</p>
<p>我自己在用的博客写作系统，由三个Subagent组成：</p>
<h3 data-id="heading-33">系统架构</h3>
<pre><code class="hljs language-ini" lang="ini">用户提供主题
    |
blog-planner: 调研+规划（20分钟）
    | 输出：docs/<span class="hljs-section">[主题]</span>-内容规划文档.md
blog-writer: 撰写初稿（40分钟）
    | 输出：docs/<span class="hljs-section">[主题]</span>-初稿.md
blog-editor: 润色优化（20分钟）
    | 输出：docs/<span class="hljs-section">[主题]</span>-最终稿.md
</code></pre>
<h3 data-id="heading-34">blog-planner（规划师）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">blog-planner</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">深度研究主题并创建内容规划文档</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Write</span>, <span class="hljs-string">Grep</span>, <span class="hljs-string">WebSearch</span>, <span class="hljs-string">WebFetch</span>]
<span class="hljs-attr">model:</span> <span class="hljs-string">sonnet</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">你是内容规划师，负责：</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">使用WebSearch研究主题的最新趋势</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">分析目标受众和痛点</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">设计文章结构和SEO策略</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">输出规划文档到docs/文件夹</span>
</code></pre>
<h3 data-id="heading-35">blog-writer（作者）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">blog-writer</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">根据规划文档撰写博客初稿</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Write</span>, <span class="hljs-string">Grep</span>]
<span class="hljs-attr">model:</span> <span class="hljs-string">sonnet</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">你是内容作者，负责：</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">读取规划文档</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">按照大纲撰写完整初稿</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">确保内容人性化、去AI味</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">输出初稿到docs/文件夹</span>
</code></pre>
<h3 data-id="heading-36">blog-editor（编辑）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">blog-editor</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">编辑初稿并优化人性化表达</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Edit</span>]
<span class="hljs-attr">model:</span> <span class="hljs-string">haiku</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">你是内容编辑，负责：</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">读取初稿</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">检查并消除AI味表达</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">增强人性化和可读性</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">输出最终稿到docs/文件夹</span>
</code></pre>
<p>工作流程很简单：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第1步：规划</span>
@blog-planner Claude Code Subagent使用技巧

<span class="hljs-comment"># 第2步：撰写</span>
@blog-writer

<span class="hljs-comment"># 第3步：编辑</span>
@blog-editor
</code></pre>
<p>每个环节都有明确的输入输出，出问题了容易定位。</p>
<h2 data-id="heading-37">成本优化建议</h2>
<p>最后说说成本的事。</p>
<p>Haiku和Sonnet的价格差大概是3倍左右（具体价格请参考Anthropic官网）。一个典型的博客写作任务，如果合理分配模型，能省下不少钱。</p>
<h3 data-id="heading-38">模型选择策略</h3>
<p>我的建议是：</p>
<p><strong>用Haiku的场景</strong></p>
<ul>
<li>搜索和信息汇总</li>
<li>简单的格式转换</li>
<li>数据整理和分类</li>
<li>代码审查（只读分析）</li>
</ul>
<p><strong>用Sonnet的场景</strong></p>
<ul>
<li>内容创作（博客、文档）</li>
<li>复杂的代码生成</li>
<li>需要推理的分析任务</li>
<li>对质量要求高的场景</li>
</ul>
<h3 data-id="heading-39">模型对比参考</h3>

























<table><thead><tr><th>模型</th><th>特点</th><th>适合场景</th></tr></thead><tbody><tr><td>Haiku</td><td>快速、便宜</td><td>简单任务</td></tr><tr><td>Sonnet</td><td>平衡、默认选择</td><td>复杂任务</td></tr><tr><td>Opus</td><td>质量最高、最贵</td><td>极致质量</td></tr></tbody></table>
<p><strong>Opus</strong>我几乎不用，除非是特别重要、对质量要求极高的任务。日常工作Sonnet足够了。</p>
<h3 data-id="heading-40">省钱口诀</h3>
<p>记住这几条：</p>
<ul>
<li>能用Haiku就别用Sonnet</li>
<li>能限制工具就别给All tools</li>
<li>能精简提示词就别写太长</li>
<li>能限制输出就别让它随便发挥</li>
</ul>
<h2 data-id="heading-41">写在最后</h2>
<p>说白了，Subagent不是什么黑科技，就是把Claude的能力按需拆分。一个通才变成一个专家团队，每个专家只干自己擅长的事。</p>
<p>如果你还在用"一个Claude打天下"的方式，我真的建议试试Subagent。花半小时写几个配置，能省下无数个"Claude又跑题了"的时刻。</p>
<p>核心就是几个原则：</p>
<ol>
<li>一个agent只干一件事</li>
<li>只给必需的工具权限</li>
<li>简单任务用Haiku</li>
<li>提示词要具体清晰</li>
<li>多agent协作用文档传递</li>
</ol>
<p>遇到问题别慌，多半是配置没写对。对照着这篇文章的7个技巧和7个错误，基本都能解决。</p>
<p>最后说一句：<strong>别追求完美配置，先用起来，慢慢迭代</strong>。</p>
<p>祝你早日组建自己的AI团队！</p>
<blockquote>
<p>本文首发自<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.betterlink.top%2Fzh%2Fposts%2Fai%2F20251122-claude-subagent-guide%2F" target="_blank" title="https://blog.betterlink.top/zh/posts/ai/20251122-claude-subagent-guide/" ref="nofollow noopener noreferrer">个人博客</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年11月27日年解决隐私清单导致审核总是提示二进制无效的问题]]></title>    <link>https://juejin.cn/post/7576918517238251570</link>    <guid>https://juejin.cn/post/7576918517238251570</guid>    <pubDate>2025-11-27T04:45:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576918517238251570" data-draft-id="7576918517238186034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年11月27日年解决隐私清单导致审核总是提示二进制无效的问题"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-11-27T04:45:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="90后晨仔"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476705773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年11月27日年解决隐私清单导致审核总是提示二进制无效的问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476705773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    90后晨仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T04:45:24.000Z" title="Thu Nov 27 2025 04:45:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>最新新上架一个产品，但是由于有些三方库没有隐私清单的问题导致提交到苹果后台之后总是会提示<code>二进制无效</code>，这里<code>特别说明</code>一下，如果你的app已经是线上的话，貌似没啥问题。（只是问了几个朋友），但是如果你要是新的产品，1.0上线的话那么就会因为这个导致二进制无效无法提交。</p>
</blockquote>
<ul>
<li>
<h4 data-id="heading-0">提交时后苹果那边给发的邮件内容，有好几个库的警告这里就拿"AFNetworking"举例说明下解决方案。下边是警告：</h4>
</li>
</ul>
<blockquote>
<p>Please correct the following issues and upload a new binary to App Store Connect.
ITMS-91061: Missing privacy manifest - Your app includes “Frameworks/AFNetworking.framework/AFNetworking”, which includes AFNetworking, an SDK that was identified in the documentation as a commonly used third-party SDK. If a new app includes a commonly used third-party SDK, or an app update adds a new commonly used third-party SDK, the SDK must include a privacy manifest file. Please contact the provider of the SDK that includes this file to get an updated SDK version with a privacy manifest. For more details about this policy, including a list of SDKs that are required to include signatures and manifests, visit:</p>
</blockquote>
<ul>
<li>
<h4 data-id="heading-1">解决方案的思路是自己在打包的时候让<code>Trae</code>帮我写了一个脚本然后给指定的库进行了添加。当然网上也有好多其他的解决方案，自己都尝试过了并没有起作用。脚本内容如下：</h4>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">set</span> -euo pipefail
FRAMEWORKS_DIR=<span class="hljs-string">"<span class="hljs-variable">${TARGET_BUILD_DIR}</span>/<span class="hljs-variable">${FRAMEWORKS_FOLDER_PATH}</span>"</span>
<span class="hljs-comment"># 生成标准的 XML plist 隐私清单（不跟踪、不收集、不使用“需要理由”的 API）</span>
<span class="hljs-function"><span class="hljs-title">write_manifest_basic</span></span>() {
  dst=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
  <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">$dst</span>"</span>)</span>"</span>
  <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$dst</span>"</span> &lt;&lt;<span class="hljs-string">'PLIST'</span>
&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;
&lt;!DOCTYPE plist PUBLIC <span class="hljs-string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="hljs-string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;
&lt;plist version=<span class="hljs-string">"1.0"</span>&gt;
&lt;dict&gt;
  &lt;key&gt;NSPrivacyTracking&lt;/key&gt;
  &lt;<span class="hljs-literal">false</span>/&gt;
  &lt;key&gt;NSPrivacyCollectedDataTypes&lt;/key&gt;
  &lt;array/&gt;
  &lt;key&gt;NSPrivacyTrackingDomains&lt;/key&gt;
  &lt;array/&gt;
  &lt;key&gt;NSPrivacyAccessedAPITypes&lt;/key&gt;
  &lt;array/&gt;
&lt;/dict&gt;
&lt;/plist&gt;

PLIST

}


<span class="hljs-comment"># 给指定 framework 注入隐私清单（若已有则不覆盖）</span>

<span class="hljs-function"><span class="hljs-title">inject_manifest_basic</span></span>() {

  fwdir=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>

  dst=<span class="hljs-string">"<span class="hljs-variable">${fwdir}</span>/PrivacyInfo.xcprivacy"</span>

  <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$dst</span>"</span> ]; <span class="hljs-keyword">then</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Already present: <span class="hljs-subst">$(basename <span class="hljs-string">"<span class="hljs-variable">$fwdir</span>"</span>)</span>/PrivacyInfo.xcprivacy"</span>

  <span class="hljs-keyword">else</span>

    write_manifest_basic <span class="hljs-string">"<span class="hljs-variable">$dst</span>"</span>

    /usr/bin/plutil -lint <span class="hljs-string">"<span class="hljs-variable">$dst</span>"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Injected PrivacyInfo.xcprivacy into <span class="hljs-subst">$(basename <span class="hljs-string">"<span class="hljs-variable">$fwdir</span>"</span>)</span>"</span>

  <span class="hljs-keyword">fi</span>

}


<span class="hljs-comment"># 注入后重新签名，避免签名失效</span>

<span class="hljs-function"><span class="hljs-title">resign_framework</span></span>() {

  fwdir=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>

  <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">${CODE_SIGNING_ALLOWED:-YES}</span>"</span> = <span class="hljs-string">"YES"</span> ] &amp;&amp; [ -n <span class="hljs-string">"<span class="hljs-variable">${EXPANDED_CODE_SIGN_IDENTITY:-}</span>"</span> ]; <span class="hljs-keyword">then</span>

    /usr/bin/codesign --force --sign <span class="hljs-string">"<span class="hljs-variable">${EXPANDED_CODE_SIGN_IDENTITY}</span>"</span> --timestamp=none <span class="hljs-string">"<span class="hljs-variable">$fwdir</span>"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Resigned <span class="hljs-subst">$(basename <span class="hljs-string">"<span class="hljs-variable">$fwdir</span>"</span>)</span>"</span>

  <span class="hljs-keyword">else</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Skip resign: CODE_SIGNING_ALLOWED=<span class="hljs-variable">${CODE_SIGNING_ALLOWED:-}</span> EXPANDED_CODE_SIGN_IDENTITY=<span class="hljs-variable">${EXPANDED_CODE_SIGN_IDENTITY:-}</span>"</span>

  <span class="hljs-keyword">fi</span>

}

  


<span class="hljs-function"><span class="hljs-title">process_framework</span></span>() {

  name=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>

  fw=<span class="hljs-string">"<span class="hljs-variable">${FRAMEWORKS_DIR}</span>/<span class="hljs-variable">${name}</span>"</span>

  <span class="hljs-keyword">if</span> [ -d <span class="hljs-string">"<span class="hljs-variable">$fw</span>"</span> ]; <span class="hljs-keyword">then</span>

    inject_manifest_basic <span class="hljs-string">"<span class="hljs-variable">$fw</span>"</span>

    resign_framework <span class="hljs-string">"<span class="hljs-variable">$fw</span>"</span>

  <span class="hljs-keyword">else</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Skip <span class="hljs-variable">${name}</span>: not found at <span class="hljs-variable">${fw}</span>"</span>

  <span class="hljs-keyword">fi</span>

}

process_framework <span class="hljs-string">"AFNetworking.framework"</span>

</code></pre>
<ul>
<li>
<h4 data-id="heading-2">具体的配置位置如下：</h4>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14b90ac67b4c4ef881cde32d77007767~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTDlkI7mmajku5Q=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764823544&amp;x-signature=z4kB%2FrsDPrIZfh1RyYsZ8PPGllA%3D" alt="Snip20251127_1.png" loading="lazy"/></p>
<ul>
<li>
<h4 data-id="heading-3">完成上边的配置之后重新打包上传就可以了，如果不放心的小伙伴可以在打包完成之后，导出.ipa的包，然后找到<code>Frameworks</code>这个文件夹，然后在它的下边可以找到<code>AFNetworking.framework</code>的文件夹然后你会看到如下图所示的文件，那么证明你添加成功了。</h4>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4b177f0609a48cbbb3b2cf2c0f342c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTDlkI7mmajku5Q=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764823544&amp;x-signature=IKlBvrt%2FxijvVe7nffBQh78ARRk%3D" alt="Snip20251127_2.png" loading="lazy"/></p>
<ul>
<li>
<h4 data-id="heading-4">有了上边的文件之后你再次提交审核就不会出现<code>AFNetworking</code>这个库没有隐私清单的警告了。</h4>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RuoYi-Cloud 完全解剖：TRAE AI 绘制的架构蓝图]]></title>    <link>https://juejin.cn/post/7577201863721418752</link>    <guid>https://juejin.cn/post/7577201863721418752</guid>    <pubDate>2025-11-27T01:31:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577201863721418752" data-draft-id="7576859594360635392" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RuoYi-Cloud 完全解剖：TRAE AI 绘制的架构蓝图"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-27T01:31:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RuoYi-Cloud 完全解剖：TRAE AI 绘制的架构蓝图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T01:31:52.000Z" title="Thu Nov 27 2025 01:31:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.  RuoYi-Cloud 完全解剖：TRAE AI 绘制的架构蓝图</h2>
<hr/>
<blockquote>
<p>🧑‍💻 作者：天天摸鱼的java工程师<br/>
🏁 项目：RuoYi-Cloud 微服务框架分析文档自动生成<br/>
🛠 关键词：TRAE、AI助手、项目文档生成、架构可视化、微服务分析\</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">🧭 先看最终结果：个人觉得还是很不错的</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db72381b08d14a3aa1786055a6361687~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811912&amp;x-signature=R6WJBODDM7u0LquKJLX98YxrV2E%3D" alt="deepseek_mermaid_20251125_3d1b66.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">🧭 写在前面：项目越大，文档越重要，AI 能帮上忙吗？</h3>
<p>作为一个做了 8 年 Java 的“老兵”，我已经习惯了打开一个项目先 <code>cd</code> 到 <code>backend/</code>，然后从 <code>pom.xml</code> 一路摸到 <code>controller</code>，靠经验猜结构、靠直觉找入口。</p>
<p>但随着项目越来越大、团队越来越多人，靠“经验摸索”这套体系已经越来越吃力。<strong>项目文档的缺失、架构图的不全、模块关系不清楚</strong>，成为了我们 onboarding（接手项目）时最大的障碍。</p>
<p>这次借 TRAE SOLO 技术大奖赛的机会，我尝试用 TRAE AI 工具链，<strong>自动生成一个中大型微服务项目（RuoYi-Cloud）</strong> 的：</p>
<ul>
<li>🧾 项目介绍文档</li>
<li>🧱 架构组件关系图</li>
<li>🧩 模块结构说明</li>
<li>🔐 权限配置与路由设计分析</li>
</ul>
<p>最终，我用 AI 成功完成了对 RuoYi-Cloud 的完整文档和架构图生成，效果远超预期。</p>
<hr/>
<h3 data-id="heading-3">🔍 目标项目：RuoYi-Cloud 微服务权限系统</h3>
<p>如果你做过 Spring Cloud 项目，你大概率听过 RuoYi-Cloud，这是一个非常成熟的开源微服务权限平台，采用 Spring Cloud Alibaba 技术栈，具备完整的：</p>
<ul>
<li>用户权限管理</li>
<li>菜单路由系统</li>
<li>微服务注册与配置</li>
<li>Docker 一键部署能力</li>
</ul>
<p>但它文档不是很全，模块又多，<strong>一上来就有十几个服务 + 前端代码</strong>，新人接手很容易懵。</p>
<hr/>
<h3 data-id="heading-4">🧠 我的分析策略：交给 AI 来“啃”项目</h3>
<p>这次我没有再手动去翻每一层代码，而是尝试用 TRAE 的 AI 智能分析能力，来“自动完成”以下任务：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38ecdf5c3dff4aa59b0826ead222bf3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811912&amp;x-signature=pzhQm530DoHzNHLrzbuXgaghuYc%3D" alt="image.png" loading="lazy"/></p>
<p>如图所示，TRAE 为我生成了一套清晰的任务清单：</p>
<ol>
<li>查看 <code>README.md</code>，了解项目介绍</li>
<li>分析项目结构，理清模块关系</li>
<li>生成详细介绍文档</li>
<li>创建项目架构结构图</li>
<li>分析核心配置文件</li>
<li>查看业务代码实现</li>
<li>查看前端结构和权限逻辑</li>
</ol>
<hr/>
<h3 data-id="heading-5">✨ 最终成果：文档 + 架构图 + 模块说明，一应俱全</h3>
<p>经过一轮分析，TRAE 自动为我生成了以下内容：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce1ff3a458c945a1beeb62399d06b22a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811912&amp;x-signature=DBbmIHfxf9i8pCtpFB412pqnKPE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">✅ 一份完整的项目介绍文档：</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f635e5053d7146ecac7d72b873ab8689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811912&amp;x-signature=LNqavDUMF8HbWdQNeVsgF%2Be3%2Bxo%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>项目概述与核心功能</li>
<li>后端技术栈 + 前端技术栈</li>
<li>系统架构与模块划分</li>
<li>用户管理、菜单权限、认证授权逻辑</li>
<li>Docker 环境部署说明</li>
</ul>
<p>文件名：<code>project_documentation.md</code></p>
<h4 data-id="heading-7">✅ 一张可视化的系统架构图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9842e1b5a92e4c1f88c7c3b8611f46b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811912&amp;x-signature=RoB54BcByQy4c9v7shBbiHXfSxw%3D" alt="deepseek_mermaid_20251125_b587a6.png" loading="lazy"/></p>
<ul>
<li>微服务模块依赖关系</li>
<li>核心功能模块分布图</li>
<li>前后端调用流程图</li>
<li>权限认证流程图</li>
</ul>
<p>文件名：<code>system_architecture.md</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4350142b67143c38d30930b3f0ac8a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811912&amp;x-signature=O199sdtwthKkHymR3xtGgaotniM%3D" alt="deepseek_mermaid_20251125_1929da.png" loading="lazy"/>
你可以看到，在系统左侧我完整分析了 RuoYi-Cloud 的模块结构，在右侧的 TRAE 界面中，任务进度被自动追踪，并且每完成一个阶段，AI 都会自动生成内容并回填上下文。</p>
<hr/>
<h3 data-id="heading-8">🧩 项目结构分析亮点</h3>
<p>在文档中，AI 对模块做了非常细致的拆解：</p>
<h4 data-id="heading-9">🌐 微服务核心模块</h4>
<ul>
<li><code>ruoyi-auth</code>：认证中心</li>
<li><code>ruoyi-gateway</code>：网关路由服务</li>
<li><code>ruoyi-system</code>：核心业务模块（用户/角色/菜单）</li>
<li><code>ruoyi-job</code>：定时任务服务</li>
<li><code>ruoyi-gen</code>：代码生成模块</li>
</ul>
<h4 data-id="heading-10">🧱 公共依赖模块</h4>
<ul>
<li><code>ruoyi-common-core</code>：基础工具类</li>
<li><code>ruoyi-common-security</code>：权限相关封装</li>
<li><code>ruoyi-common-redis</code>：Redis 封装</li>
</ul>
<h4 data-id="heading-11">📊 前端结构分析</h4>
<ul>
<li>Vue 2.6 + Element UI</li>
<li>Vuex 状态管理</li>
<li>Axios 请求封装</li>
<li>权限逻辑基于路由守卫（<code>permission.js</code>）</li>
</ul>
<hr/>
<h3 data-id="heading-12">🧾 文档内容摘录</h3>
<p>生成的 <code>project_documentation.md</code> 中内容非常完整。以下是部分文档结构：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 1. 项目概述</span>
RuoYi-Cloud 是一套基于 Spring Cloud Alibaba 的微服务架构权限管理系统...

<span class="hljs-section">## 2. 技术栈</span>
<span class="hljs-bullet">-</span> 后端：Spring Boot、Nacos、Sentinel、MyBatis-Plus、Redis、MySQL
<span class="hljs-bullet">-</span> 前端：Vue 2.x、Element UI、Axios、Vuex

<span class="hljs-section">## 3. 系统架构</span>
<span class="hljs-bullet">-</span> ruoyi-auth：认证中心
<span class="hljs-bullet">-</span> ruoyi-system：核心业务
<span class="hljs-bullet">-</span> ruoyi-gateway：API 网关

<span class="hljs-section">## 4. 核心功能模块</span>
<span class="hljs-section">### 用户管理</span>
<span class="hljs-bullet">-</span> GET /user/list：分页查询用户
<span class="hljs-bullet">-</span> PUT /user/resetPwd：重置密码

<span class="hljs-section">### 菜单管理</span>
<span class="hljs-bullet">-</span> GET /menu/treeselect：获取菜单树
<span class="hljs-bullet">-</span> GET /menu/getRouters：生成前端路由
</code></pre>
<hr/>
<h3 data-id="heading-13">🧠 我的收获：AI 不只是“写代码”，更是“帮你理解系统”</h3>
<p>很多人对 AI 的认知还停留在“让它写个工具类”“让它生成个接口”，但我这次最大的感受是：</p>
<blockquote>
<p><strong>AI 可以成为我们理解系统结构、梳理架构、生成文档的得力助手。</strong></p>
</blockquote>
<p>它不是“替代你写文档”，而是让你“有能力写得更快、写得更全、写得更专业”。</p>
<hr/>
<h3 data-id="heading-14">🧩 适用场景：不仅是 RuoYi，也适用于你们的项目</h3>
<p>如果你团队也有以下情况：</p>
<ul>
<li>接手一个别人留下的老项目</li>
<li>想补文档但没人愿意写</li>
<li>想梳理架构但没人搞得清楚</li>
<li>跨部门协作时沟通成本高</li>
</ul>
<p>那么我强烈推荐你试试 TRAE 的文档生成能力。尤其是对 Java 微服务架构项目，它的理解能力已经非常成熟。</p>
<hr/>
<h3 data-id="heading-15">🚀 总结：未来的开发者，不只是写代码的人</h3>
<p>这次我用 TRAE AI 成功完成了对一个企业级微服务项目的结构分析、文档生成和架构图绘制，真正做到了“<strong>一键了解项目全貌</strong>”。</p>
<p>我也更加坚信：未来的开发者，不只是写代码的人，更是能驾驭工具、理解系统、讲清楚架构的人。</p>
<hr/>
<p>🧠 工具：TRAE AI助手 + Mermaid 架构图生成 + Markdown 文档生成器</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用简单 JSON + 自定义 t 函数实现轻量多语言国际化（无需 next-intl）]]></title>    <link>https://juejin.cn/post/7576918517237809202</link>    <guid>https://juejin.cn/post/7576918517237809202</guid>    <pubDate>2025-11-27T03:11:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576918517237809202" data-draft-id="7577189654471901210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用简单 JSON + 自定义 t 函数实现轻量多语言国际化（无需 next-intl）"/> <meta itemprop="keywords" content="前端,JavaScript,Trae"/> <meta itemprop="datePublished" content="2025-11-27T03:11:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用简单 JSON + 自定义 t 函数实现轻量多语言国际化（无需 next-intl）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:11:55.000Z" title="Thu Nov 27 2025 03:11:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Next.js 开发国际化（i18n）项目时，许多人会直接安装 next-intl、react-intl、i18next 这样的重量级库。
但对于一些结构简单、只需要基础文本翻译的网站来说，使用这些库反而会带来额外的复杂性。</p>
</blockquote>
<p>如果你只想让项目支持：</p>
<p>✔ 标题多语言
✔ 按钮多语言
✔ 文案多语言
✔ 扩展灵活、无需复杂配置</p>
<p>那么你完全可以自己写一个 <strong>超轻量 i18n 方案</strong>。</p>
<p>今天我们来介绍一个非常简单、方便扩展、可在任何环境使用的多语言实现方式：
<strong>基于 JSON 语言包 + t() 翻译函数。</strong></p>
<hr/>
<h2 data-id="heading-0">目录结构：简单、清晰、可扩展</h2>
<p>首先在项目中新建 <code>i18n</code> 文件夹：</p>
<pre><code class="hljs language-bash" lang="bash">/i18n
  ├─ en.json
  ├─ de.json
  ├─ fr.json
</code></pre>
<p>内容例如：</p>
<h3 data-id="heading-1">en.json</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hotTags"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hot Tags"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hotArticles"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hot Articles"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"latestNews"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Latest News"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-2">de.json</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hotTags"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Beliebte Tags"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hotArticles"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Beliebte Artikel"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"latestNews"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Neueste Nachrichten"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">fr.json</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hotTags"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Tags Populaires"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hotArticles"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Articles Populaires"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"latestNews"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Dernières Nouvelles"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">自定义 t() 翻译函数</h2>
<p>这一小段代码就是整个多语言系统的核心：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> en <span class="hljs-keyword">from</span> <span class="hljs-string">"@/i18n/en.json"</span>;
<span class="hljs-keyword">import</span> de <span class="hljs-keyword">from</span> <span class="hljs-string">"@/i18n/de.json"</span>;
<span class="hljs-keyword">import</span> fr <span class="hljs-keyword">from</span> <span class="hljs-string">"@/i18n/fr.json"</span>;

<span class="hljs-keyword">const</span> locales = { en, de, fr };

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">t</span>(<span class="hljs-params">locale: <span class="hljs-built_in">string</span>, key: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> dict =
    (locales <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;&gt;)[locale] || locales[<span class="hljs-string">"en"</span>];

  <span class="hljs-keyword">return</span> dict[key] ?? key;
}
</code></pre>
<h3 data-id="heading-5">工作原理</h3>
<ol>
<li>根据传入的 locale（<code>en</code> / <code>de</code> / <code>fr</code>）选择对应字典</li>
<li>如果找不到语言，自动使用英文作为 fallback</li>
<li>如果 key 不存在，原样返回 key（方便调试）</li>
</ol>
<h3 data-id="heading-6">类型安全（解决 TS 报错）</h3>
<p>上面代码使用了：</p>
<pre><code class="hljs language-ts" lang="ts">(locales <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;&gt;)
</code></pre>
<p>让 TypeScript 明确知道字典是：</p>
<ul>
<li>key: 语言代码</li>
<li>value: 文本映射表（键值对）</li>
</ul>
<p>这样就不会出现：</p>
<blockquote>
<p>「元素隐式具有 any 类型」</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">在页面中使用</h2>
<p>示例：
你在首页 HomePage 中传入 locale：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;h2 className=<span class="hljs-string">"text-2xl font-bold"</span>&gt;
  {<span class="hljs-title function_">t</span>(locale, <span class="hljs-string">"hotTags"</span>)}
&lt;/h2&gt;
</code></pre>
<p>渲染效果将根据语言不同自动变化：</p>
<ul>
<li>English → Hot Tags</li>
<li>Deutsch → Beliebte Tags</li>
<li>Français → Tags Populaires</li>
</ul>
<p>无需额外库，无需复杂配置。</p>
<hr/>
<h2 data-id="heading-8">优点总结</h2>





























<table><thead><tr><th>特点</th><th>说明</th></tr></thead><tbody><tr><td>极轻量</td><td>无需安装任何 i18n 库</td></tr><tr><td>纯 JSON 文件</td><td>非技术人员也能直接编辑</td></tr><tr><td>完全可控</td><td>不会被第三方库的 API 或复杂行为束缚</td></tr><tr><td>易扩展</td><td>想加语言？加个 JSON 文件即可</td></tr><tr><td>易维护</td><td>键值结构简单不容易出错</td></tr></tbody></table>
<p>适合用在：</p>
<ul>
<li>企业官网</li>
<li>展示性网站</li>
<li>CMS 文章网站（如 Strapi + Next.js）</li>
<li>SEO 友好的多语言站点</li>
<li>需要快速上线 MVP 的项目</li>
</ul>
<hr/>
<h2 data-id="heading-9">还能进一步增强！</h2>
<p>要是你想扩展成更强的国际化系统，你还可以加入：</p>
<h3 data-id="heading-10">✔ 支持嵌套 key（如 <code>home.title</code>）</h3>
<h3 data-id="heading-11">✔ 支持变量插值（如 <code>Hello {{name}}</code>）</h3>
<h3 data-id="heading-12">✔ 自动检测浏览器语言</h3>
<h3 data-id="heading-13">✔ 服务端自动注入 locale（Next.js App Router）</h3>
<p>我可以进一步为你升级成 <strong>完整简易版 i18n 框架</strong>。</p>
<hr/>
<h2 data-id="heading-14">最后</h2>
<p>这种方式简单却非常实用，特别适合
已经有后端（例如 Strapi） + 前端 Next.js 结构的多语言站点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[知识库（Knowledge Base）与知识图谱（Knowledge Graph）到底该怎么选？]]></title>    <link>https://juejin.cn/post/7576923573778399274</link>    <guid>https://juejin.cn/post/7576923573778399274</guid>    <pubDate>2025-11-27T03:21:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576923573778399274" data-draft-id="7576923573778202666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="知识库（Knowledge Base）与知识图谱（Knowledge Graph）到底该怎么选？"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-27T03:21:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            知识库（Knowledge Base）与知识图谱（Knowledge Graph）到底该怎么选？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:21:02.000Z" title="Thu Nov 27 2025 03:21:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：在大模型幻觉频发的今天，RAG 架构成为救命稻草。但面对“知识库”与“知识图谱”两大技术路线，开发者该如何抉择？本文深度解析两者的定义、区别与融合趋势，助你构建更聪明的 AI 系统。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fd4bda76d9149f8b29c9dfb8820d379~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818461&amp;x-signature=UYtBwzlAibO9jYPpfKIaw26u8bM%3D" alt="封面图示例" loading="lazy"/></p>
<hr/>
<p>在大语言模型（LLM）重塑技术版图的今天，“幻觉（Hallucination）”问题依然是悬在企业级应用头顶的达摩克利斯之剑。为了解决这一问题，检索增强生成（RAG）架构应运而生，而 RAG 的核心在于“外部知识”的有效存储与检索。</p>
<p>在这个背景下，两个概念频繁出现在技术架构图中：<strong>知识库（Knowledge Base, KB）</strong> 和 <strong>知识图谱（Knowledge Graph, KG）</strong>。</p>
<p>很多开发者在选型时会感到困惑：它们究竟有何区别？是互斥的替代关系，还是互补的搭档？本文将从技术原理、应用场景及落地实践三个维度，为您深度拆解这两大知识管理支柱。</p>
<h2 data-id="heading-0">一、 核心概念拆解</h2>
<h3 data-id="heading-1">1. 知识库（Knowledge Base）：广义的知识容器</h3>
<p>在传统定义中，知识库是用于知识管理的信息集合。但在当今的 AI 语境下（特别是 RAG 架构中），当我们谈论“知识库”时，通常指的是<strong>基于向量检索（Vector Search）的非结构化数据存储</strong>。</p>
<ul>
<li><strong>核心逻辑</strong>：将文档（PDF、Wiki、Markdown）切分成片段（Chunks），通过 Embedding 模型转化为高维向量，存储在向量数据库中。</li>
<li><strong>检索方式</strong>：计算“语义相似度”。例如，用户问“苹果怎么卖？”，系统能匹配到“红富士价格优惠”的片段，因为它们在向量空间距离相近。</li>
<li><strong>特点</strong>：模糊匹配、构建速度快、适合处理海量非结构化文本。</li>
</ul>
<h3 data-id="heading-2">2. 知识图谱（Knowledge Graph）：万物互联的语义网络</h3>
<p>知识图谱本质上是一种<strong>基于图数据结构（Graph Data Structure）的知识表示方法</strong>。它由节点（Entities）和边（Relationships）组成，以“主-谓-宾”的三元组形式（如 <code>&lt;埃隆·马斯克, 是CEO, 特斯拉&gt;</code>）描述世界。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb173897465e475aa8e334dda94947e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818461&amp;x-signature=8cOnFnZPvZXrTFZEZXTf7QlH7T0%3D" alt="知识图谱示意图" loading="lazy"/></p>
<ul>
<li><strong>核心逻辑</strong>：通过信息抽取（Information Extraction）技术，从数据中提炼实体与关系，构建一张网状的拓扑结构。</li>
<li><strong>检索方式</strong>：图遍历（Graph Traversal）与子图匹配。例如，查询“马斯克管理的公司有哪些？”，系统会沿着“CEO”这条边找到所有关联节点。</li>
<li><strong>特点</strong>：精确匹配、具备推理能力、结构化程度高、适合处理复杂关系。</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、 深度对比：多维度的技术博弈</h2>
<p>为了更直观地理解两者的差异，我们从以下五个维度进行对比：</p>








































<table><thead><tr><th align="left">维度</th><th align="left">知识库 (Vector-based KB)</th><th align="left">知识图谱 (Knowledge Graph)</th></tr></thead><tbody><tr><td align="left"><strong>数据结构</strong></td><td align="left">高维向量空间（扁平化）</td><td align="left">节点与边的拓扑网络（结构化）</td></tr><tr><td align="left"><strong>构建成本</strong></td><td align="left"><strong>低</strong>：切片 + Embedding 即可</td><td align="left"><strong>高</strong>：需要 Schema 设计、实体识别、关系抽取</td></tr><tr><td align="left"><strong>查询逻辑</strong></td><td align="left">语义相似度（模糊匹配）</td><td align="left">逻辑查询与多跳遍历（精确匹配）</td></tr><tr><td align="left"><strong>推理能力</strong></td><td align="left">弱（依赖 LLM 上下文理解）</td><td align="left"><strong>强</strong>（具备传递性、归纳性推理能力）</td></tr><tr><td align="left"><strong>可解释性</strong></td><td align="left">黑盒（向量距离难以直观解释）</td><td align="left"><strong>白盒</strong>（路径清晰，可追溯）</td></tr><tr><td align="left"><strong>更新维护</strong></td><td align="left">简单（增删文档片段）</td><td align="left">复杂（需维护图结构的完整性与一致性）</td></tr></tbody></table>
<p><strong>一句话总结</strong>：知识库胜在<strong>广度与效率</strong>，知识图谱胜在<strong>精度与深度</strong>。</p>
<hr/>
<h2 data-id="heading-4">三、 典型应用场景</h2>
<h3 data-id="heading-5">1. 适合使用知识库（KB）的场景</h3>
<ul>
<li><strong>企业内部文档问答</strong>：员工查询 HR 政策、IT 操作手册。这类数据通常是非结构化的文本，语义搜索能快速定位相关段落。</li>
<li><strong>长文本辅助写作</strong>：寻找相关的历史文章或素材。</li>
<li><strong>初级智能客服</strong>：基于 FAQ 列表的快速响应。</li>
</ul>
<h3 data-id="heading-6">2. 适合使用知识图谱（KG）的场景</h3>
<ul>
<li><strong>金融风控与反欺诈</strong>：通过分析借款人之间的关联关系（如共同联系人、担保链），发现隐蔽的欺诈团伙。这是向量搜索无法做到的。</li>
<li><strong>供应链管理</strong>：分析零部件短缺对下游产品的级联影响（图的传导性）。</li>
<li><strong>精准推荐系统</strong>：不仅推荐商品，还能解释“为什么推荐”（因为你购买了 A，A 与 B 属于同系列）。</li>
<li><strong>复杂多跳问答（Multi-hop QA）</strong>：例如“马斯克第一任妻子的职业是什么？”这需要先找到妻子，再查找其职业，图谱的遍历能力在此具有压倒性优势。</li>
</ul>
<hr/>
<h2 data-id="heading-7">四、 技术实现概览</h2>
<h3 data-id="heading-8">1. 数据建模与存储</h3>
<ul>
<li>
<p><strong>KB 方案</strong>：</p>
<ul>
<li><strong>工具链</strong>：LangChain / LlamaIndex (数据处理), OpenAI / HuggingFace (Embedding)。</li>
<li><strong>存储</strong>：Pinecone, Milvus, Weaviate, 或 PostgreSQL (pgvector)。</li>
<li><strong>关键点</strong>：Chunking Strategy（切片策略）直接影响检索质量。</li>
</ul>
</li>
<li>
<p><strong>KG 方案</strong>：</p>
<ul>
<li><strong>工具链</strong>：DeepDive (抽取), SpaCy (NER)。</li>
<li><strong>存储</strong>：Neo4j (属性图), NebulaGraph (大规模分布式), JanusGraph。</li>
<li><strong>关键点</strong>：Ontology Design（本体设计），即定义数据世界的“骨架”。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">2. 融合趋势：GraphRAG</h3>
<p>单纯的向量检索存在“切片丢失上下文”的问题，而单纯的图谱构建成本过高。目前的业界趋势是 <strong>GraphRAG</strong>——将两者结合。<strong>微软研究院（Microsoft Research）在 2024 年发布的 GraphRAG 项目</strong>正是这一方向的里程碑式工作。</p>
<ul>
<li><strong>原理</strong>：利用 LLM 提取文本中的关键实体构建局部子图，存储在图数据库中；同时保留文本向量。</li>
<li><strong>优势</strong>：在回答“总结全书主旨”或“分析人物关系”这类宏观问题时，图谱能提供全局结构信息，弥补向量检索过于微观的缺陷。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58b4732e07794d069aecceb2b61e7a7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818461&amp;x-signature=WHhYuH8NBsp6hQ%2FpYrTJ%2FboFbZc%3D" alt="GraphRAG" loading="lazy"/>
（GraphRAG）</p>
<hr/>
<h2 data-id="heading-10">五、 实践建议与落地案例</h2>
<p>对于大多数初创团队或从 0 到 1 的项目，我的建议遵循 <strong>“先僵化，后优化”</strong> 的路径：</p>
<h3 data-id="heading-11">阶段一：快速冷启动（Vector KB）</h3>
<p><strong>场景</strong>：某电商搭建售后机器人。
<strong>做法</strong>：直接将产品手册、退换货政策 PDF 导入向量数据库。
<strong>收益</strong>：1-2 周即可上线，解决 80% 的常见语义匹配问题。</p>
<h3 data-id="heading-12">阶段二：精度调优（Hybrid Search）</h3>
<p><strong>场景</strong>：用户反馈搜不到特定型号参数。
<strong>做法</strong>：引入关键词搜索（BM25）与向量搜索结合，确保专有名词的精确匹配。</p>
<h3 data-id="heading-13">阶段三：引入图谱（Knowledge Graph）</h3>
<p><strong>场景</strong>：需要处理“兼容性”咨询，如“镜头 A 能不能装在相机 B 上？”。
<strong>做法</strong>：构建小规模图谱，定义 <code>&lt;镜头, 适配卡口, 卡口型号&gt;</code> 和 <code>&lt;相机, 适配卡口, 卡口型号&gt;</code> 的关系。
<strong>收益</strong>：利用图的逻辑推理能力，给出 100% 准确的兼容性回答，避免 LLM 胡编乱造。</p>
<hr/>
<h2 data-id="heading-14">结语</h2>
<p>知识库赋予了 AI <strong>“博学”</strong> 的底色，而知识图谱则注入了 <strong>“逻辑”</strong> 的灵魂。</p>
<p>在实际工程中，不要为了用图谱而用图谱。从业务痛点出发，以低成本的向量知识库起步，在需要处理复杂关联与严谨推理的深水区，再引入知识图谱这一重型武器。两者的有机结合，才是通往下一代认知智能的必经之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[又被 Cursor 烧了 1 万块，我麻了。。。]]></title>    <link>https://juejin.cn/post/7577189654472065050</link>    <guid>https://juejin.cn/post/7577189654472065050</guid>    <pubDate>2025-11-27T03:21:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577189654472065050" data-draft-id="7576929700841701385" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="又被 Cursor 烧了 1 万块，我麻了。。。"/> <meta itemprop="keywords" content="API,AI编程,Cursor"/> <meta itemprop="datePublished" content="2025-11-27T03:21:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            又被 Cursor 烧了 1 万块，我麻了。。。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:21:39.000Z" title="Thu Nov 27 2025 03:21:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员鱼皮。这段时间国外的大模型真是火到不行，像新出的 Gemini 3.0 和 Claude Opus 4.5，天天最强、天天炸裂，搞的我已经有些麻了。。。</p>
<p>的确目前国外的大模型在编程能力上是领先的，但 <strong>不一定是最适合咱们的</strong>。</p>
<p>大多数同学用 AI 文本模型无非就 2 个目的嘛：</p>
<ul>
<li>自己用来写代码</li>
<li>对外提供 AI 应用</li>
</ul>
<p>先说说第一个场景，像我们团队虽然也在用 Cursor 去处理复杂任务，但是前段时间刚刚分享过账单，价格真是太贵了，才一个多月就花了 <strong>1 万多</strong>！我整个人都麻了。。。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e4f24a1af48405ba62c03f2eba97649~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=MoQ5e%2BPYB5Cv9eHIvRraFClp3l0%3D" alt="" loading="lazy"/></p>
<p>除了费用贵之外，国外的大模型在很多任务的处理速度上是不如国内大模型的，很容易把简单的任务搞复杂，费时又费钱。之前国内的 GLM-4.6 发布的时候，我也专门 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F8Gr__biKvaiaJqAu-8k6Ag" target="_blank" title="https://mp.weixin.qq.com/s/8Gr__biKvaiaJqAu-8k6Ag" ref="nofollow noopener noreferrer">写文章做过对比</a>，让它和 Claude 一决高下，一起做个包含完整前后端代码的工具网站。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea523681ac5a42e58dcf2b73324c0537~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=IdySvjVzo9sz%2Fa8Yp23dMIPfgeA%3D" alt="null" loading="lazy"/></p>
<p>结果 GLM-4.6 不仅速度最快，而且功能实现最完整，理解了我的需求。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7ee66026a804411ae6ab308a164970c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=4f%2B6Fk%2Fsw6R2aC0Q1BkYaqSK1Bk%3D" alt="" loading="lazy"/></p>
<p>再说说第二个场景 —— 对外提供 AI 应用，也就是让自己的程序通过 API 接入 AI 大模型。</p>
<p>我们团队也做过很多 AI 应用，但是用的一直是国内大模型的 API！</p>
<p>原因很简单，不仅能够满足需求，而且 <strong>更快、更稳定、更便宜</strong>。所以国外大模型吹得再天花乱坠，我依然建议大家使用国内大模型的 API。</p>
<p>比如最近很火的 GLM-4.6 模型，在真实编程、长上下文处理、推理能力、信息搜索、写作能力与智能体应用等多个方面实现全面提升。他们新推出的 Coding Plan 套餐，更是能够以 Claude Code 1/7 的价格，享受 Claude Pro 套餐的 3 倍用量，同时能够在代码能力上对齐 Claude Sonnet 4。</p>
<p>之前我已经给大家分享过很多个人使用 AI 的技巧，今天这篇文章就主要分享大模型 API 的使用教程，我将以国内智谱最新旗舰的 GLM-4.6 模型为例，手把手带你学会 3 大使用 API 的场景。</p>
<h2 data-id="heading-0">一、API 接入开发工具</h2>
<p>下面以流行的 Cursor 和 Claude Code 为例，来演示如何将国内大模型 GLM-4.6 的 API 接入开发工具。</p>
<h3 data-id="heading-1">Cursor 接入 GLM</h3>
<p>首先打开 Cursor 的设置界面，进入模型设置，然后添加自定义模型，注意名称一定要是大写的 <code>GLM-4.6</code>！</p>
<p>添加模型后，需要覆盖 OpenAI 的 API Key 为你自己的、同时覆盖 OpenAI 的请求地址为 <code>https://open.bigmodel.cn/api/coding/paas/v4</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ffda27525d94678b25307557b7282d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=mPqIPl9kfNagZTHX4kAFWAwFgNY%3D" alt="" loading="lazy"/></p>
<p>可以在智谱 AI 开放平台获取到 API Key，注意不要泄露！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f24a4a6ab9a42818d29ec38093ea38c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=C1yLsmvxdMhKM%2FizyBJ%2FfUGhbuk%3D" alt="" loading="lazy"/></p>
<p>然后，就可以在对话界面选择 GLM-4.6 大模型，愉快使用了~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c468c6423bf47c1bca02e004755702e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=igEa5xGskWRjmS45dhZCWxgdp7w%3D" alt="" loading="lazy"/></p>
<p>国内模型的输出速度很快，实测下来结果也比较靠谱。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f43a45494f242a88bf916de5d426c38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=MjaAz0rMrvBF6UPN5W84oqQnTrs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">Claude Code 接入 GLM</h3>
<p>给 Claude Code 接入 GLM 也很简单，1 分钟搞定。</p>
<p>首先一行命令安装 Claude Code：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @anthropic-ai/claude-code
</code></pre>
<p>然后执行 <code>claude</code> 命令打开程序，默认是需要登录 Claude 账号的，否则无法使用：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c651cbb4f12e4536a5b4eea477666f91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=i9aSiYPLyO5NGLhEVHHLcFJkRwk%3D" alt="" loading="lazy"/></p>
<p>不过没关系，让我们把它背后的 AI 大模型换成国内的。首先进入 <code>{用户目录}/.claude</code> 目录，创建一个 <code>settings.json</code> 配置文件：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f02f972202f648e291d4f20acfa730af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=5DmTsAFyNxRXJYLLDqRYy3zcHWw%3D" alt="" loading="lazy"/></p>
<p>然后修改配置文件中的内容如下，记得替换成你自己的 API Key：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/388e426792d747ad9cb69cf30c3d9a6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=B0pn0oqBmnOlmEU5Rc3LHzm8mnA%3D" alt="" loading="lazy"/></p>
<p>接下来就可以愉快地使用了~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d22b890080b4640a52dde2383d26ae9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=YJKgvyHQIwWVSUJnYoHSzlX1O%2Fs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">二、API 接入新项目</h2>
<p>接下来让我们学习如何利用大模型 API 开发一个全新的 AI 应用。以 Java 项目为例，我们可以使用主流的 Spring AI 框架来开发 AI 应用。</p>
<p>首先利用 IDEA 创建一个 Spring Boot 项目，注意 JDK 版本最好选择 21：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad4f564e0fe7454e95f396e1f41c546c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=RPjX11c1WI1We8%2F1N0N0nvcYyus%3D" alt="" loading="lazy"/></p>
<p>然后选择 Spring Boot 3.x 的版本（暂时不要使用 4）以及需要的依赖。</p>
<p>Spring AI 已经兼容了智谱系列的大模型（包括 GLM-4.6），只需要勾选 <code>ZhipuAI</code> 依赖就好：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adf177e26d82468fa1c0ed6e937e2a7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=FMxdHonAYgWwfC3vaSadvaMQqfo%3D" alt="" loading="lazy"/></p>
<p>创建新项目完成后，我们可以参考 Spring AI 官方文档来修改 <code>application.yml</code> 配置文件，填写对接智谱 AI 所需的配置。</p>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fapi%2Fchat%2Fzhipuai-chat.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/api/chat/zhipuai-chat.html" ref="nofollow noopener noreferrer">docs.spring.io/spring-ai/r…</a></p>
<p>比如：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
<span class="hljs-attr">application:</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">yupi-ai-project</span>
<span class="hljs-attr">ai:</span>
  <span class="hljs-attr">zhipuai:</span>
    <span class="hljs-string">api-key:</span> <span class="hljs-string">&lt;Your</span> <span class="hljs-string">API</span> <span class="hljs-string">Key&gt;</span>
    <span class="hljs-attr">chat:</span>
      <span class="hljs-string">base-url:</span> <span class="hljs-string">https://open.bigmodel.cn/api/coding/paas</span>
      <span class="hljs-attr">options:</span>
        <span class="hljs-string">model:</span> <span class="hljs-string">glm-4.6</span>
</code></pre>
<p>注意，上述代码中的 <code>base-url</code> 如果不填写，默认为 <code>https://open.bigmodel.cn/api/paas</code>；如果你要使用 Coding Plan 的优惠套餐包，需要替换为 <code>https://open.bigmodel.cn/api/coding/paas</code>（中间多加了个 coding）。</p>
<p>填写好配置后，让我们写一个单元测试文件，直接使用自动注入的 ChatModel 类型的 Bean，然后调用 ChatModel 提供的 call 方法和 AI 对话：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">YupiAiProjectApplicationTests</span> {
​
   <span class="hljs-meta">@Resource</span>
   <span class="hljs-keyword">private</span> <span class="hljs-title class_">ChatModel</span> zhiPuAiChatModel;
​
   <span class="hljs-meta">@Test</span>
   <span class="hljs-built_in">void</span> <span class="hljs-title function_">contextLoads</span>(<span class="hljs-params"/>) {
       <span class="hljs-title class_">String</span> content = zhiPuAiChatModel.<span class="hljs-title function_">call</span>(<span class="hljs-string">"你好，我是程序员鱼皮"</span>);
       <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(content);
  }
​
}
</code></pre>
<p>直接运行单元测试，一次 AI 对话就完成了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb6b4755f6de41aab7e2efe06dcab589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=HtXdACVT8ShkbcsVTmHDxEGFdRs%3D" alt="" loading="lazy"/></p>
<p>将 AI 接入项目就是这么简单~ 而且因为我们用的是 Spring AI 框架，你可以享受框架提供的各种高级能力，比如对话记忆、RAG、工具调用、可观测性等等。</p>
<h2 data-id="heading-4">三、API 接入已有项目</h2>
<p>如果你的项目已经使用了 AI 开发框架、或者 Open AI 大模型，只需 1 分钟就能替换为国内的大模型 API。</p>
<p>以我当时带大家从 0 开始做的、对标大厂的 <strong>AI 零代码生成项目</strong> 为例，这个项目使用 Java 主流的 AI 应用开发框架 LangChain4j。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55afbbe8efd54f6aa14d7790207dcd21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=j7eplPQZYL%2FUr9CVLSVqUuS8uyo%3D" alt="" loading="lazy"/></p>
<p>项目代码是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fyu-ai-code-mother" target="_blank" title="https://github.com/liyupi/yu-ai-code-mother" ref="nofollow noopener noreferrer">完全开源</a> 的，大家可以直接下载学习，也欢迎到编程导航学习整个项目的完整教程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/734ca96e3f0747f4a50e7b901126fef7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=PhpvywZyJW9f%2F3kfdyhCQdMGPJQ%3D" alt="" loading="lazy"/></p>
<p>之前这个项目接入的是 DeepSeek，现在如果要接入编程能力更快更强的 GLM-4.6，只需要更改一下配置文件：</p>
<pre><code class="hljs language-arduino" lang="arduino">langchain4j:
open-ai:
  reasoning-streaming-chat-model:
    base-url: https:<span class="hljs-comment">//open.bigmodel.cn/api/coding/paas/v4</span>
    api-key: &lt;Your API Key&gt;
    model-name: glm<span class="hljs-number">-4.6</span>
    max-tokens: <span class="hljs-number">32768</span>
    temperature: <span class="hljs-number">0.1</span>
</code></pre>
<p>其中，如果你要生成更复杂的项目，max-tokens 可以调大点，GLM-4.6 有 200K 超长上下文窗口，写几十个页面都不成问题。</p>
<p>然后依次启动后端和前端项目，输入提示词，比如让 AI 制作一个精美的作品展示网站：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57f78230fb20454fbb0fa02d83a17c73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=EvcT%2FTBI5LYR6QelUegxhwgF4kk%3D" alt="" loading="lazy"/></p>
<p>大概 3 ~ 4 分钟左右，GLM-4.6 完成了任务，生成的网站效果还是相当不错的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/469d1879133448f2b3620d9139c51737~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=epN25f%2FSyomB9%2B5Xc6QZvB%2BNkwM%3D" alt="" loading="lazy"/></p>
<p>之前这个项目我使用的是 DeepSeek-V3.2-Exp 模型，用同样的提示词，需要花费 6 ~ 8 分钟左右，做出来的效果如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff7f09cffcd94e2ab64ec124c6ff5498~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=o5BD99eGYeg6PRk%2Bq8AoCwQVxCY%3D" alt="" loading="lazy"/></p>
<p>显然无论是速度上，还是效果上，GLM-4.6 都更胜一筹。</p>
<p>为消除偶然性，我这边挑选了几个案例，进行了更多对比。</p>
<p>1）先是经典的个人博客网站，二者做出的效果差不多，GLM-4.6 更现代、DeepSeek 更简约传统：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85e608840dca456a91ad83eccfb2364e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=hloJ%2Bf%2FJ7RAip3ZS36Vc5Cj2iTw%3D" alt="" loading="lazy"/></p>
<p>2）然后是一个宇宙大爆炸 3D 动画演示，这里显然 GLM-4.6 更专注于 “做动画效果”，而 DeepSeek 做的更像是一个知识科普网站。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f962195acd5d4111ba7a6431d85fb173~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=ZpUTG%2B6G24U6foG7XO3CYa0r1vo%3D" alt="" loading="lazy"/></p>
<p>咱就是说，DeepSeek 做的这个 “宇宙膨胀” 方格动画真的给我看笑了。</p>
<p>3）然后是做一个微信 UI 原型图，这次我要把 Gemini 3 拉进来一起对比。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaf38be521c140caa322fd019be60121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=Y%2Foti2E1wzYR70qYdOpXNYW5i%2Fw%3D" alt="" loading="lazy"/></p>
<p>Gemini 3 的还原度是最高的，其次是 GLM-4.6，而 DeepSeek 根本就没有做聊天页面。不过这里我用的是 Gemini 3 的 Canvas 模式，有些图标会自己绘制，而国内的大模型直接用 Emoji 来代替图标了，所以逼真度差了一截。</p>
<p>4）最后是我最喜欢让 AI 做的案例 —— 仿做一个知名的海外视频网站，来验证 AI 的理解能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32384a40e4074d2a9bee5027a4f6347f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=yIvuMaN3Wzhw0q2Iv%2FFkll7lZgE%3D" alt="" loading="lazy"/></p>
<p>这把我觉得 GLM-4.6 的效果更好一些，增强了 “看视频” 的体验，有很多视频的分类；而 DeepSeek 考虑到了上传视频。到底哪个更符合现代视频网站的特点，我相信大家心里有答案。</p>
<h2 data-id="heading-5">尾声</h2>
<p>OK，以上就是几种国内大模型 API 的使用方法，学到的朋友们点个赞吧~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1927afe221584eb8a9312b66e50e126f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818499&amp;x-signature=6nXj70BlnlZj9dMStS6XbwlkLfQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[打造一个可定制工作流的桌面女友]]></title>    <link>https://juejin.cn/post/7577171133432709161</link>    <guid>https://juejin.cn/post/7577171133432709161</guid>    <pubDate>2025-11-27T03:13:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577171133432709161" data-draft-id="7576955345377968191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="打造一个可定制工作流的桌面女友"/> <meta itemprop="keywords" content="Electron"/> <meta itemprop="datePublished" content="2025-11-27T03:13:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            打造一个可定制工作流的桌面女友
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:13:52.000Z" title="Thu Nov 27 2025 03:13:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>你是否想过拥有一个可以自定义行为的桌面虚拟角色？本文将带你从零开始，打造一个基于 Live2D 的桌面女友，并赋予她可定制的工作流能力。通过 Electron + LangGraph 的组合，我们可以创建一个既可爱又智能的桌面应用。</p>
</blockquote>
<p>通过本项目，你能得到什么：</p>
<ol>
<li><strong>一位常驻桌面的虚拟女友</strong>：使用 Live2D 技术打造的可爱角色，可以常驻桌面，陪伴你的工作时光</li>
<li><strong>可定制的工作流系统</strong>：通过 LangGraph 构建的工作流引擎，让虚拟角色能够执行各种自定义任务和逻辑</li>
<li><strong>模板管理系统</strong>：可以保存、复用和分享工作流模板，提高工作效率</li>
<li><strong>高度可扩展的架构</strong>：模块化设计，可以轻松添加新的步骤类型、集成 AI 对话、文件操作等功能</li>
</ol>
<h2 data-id="heading-0">项目概览</h2>
<p>在开始之前，让我们先了解一下整个项目的架构：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                    用户交互层                             │
│  ┌──────────────┐         ┌──────────────┐              │
│  │  Live2D 模型 │         │  工作流管理  │                │
│  │   (桌面女友)  │         │   界面       │               │
│  └──────────────┘         └──────────────┘              │
└─────────────────────────────────────────────────────────┘
                        ↕
┌─────────────────────────────────────────────────────────┐
│                  Electron 应用层                          │
│  ┌──────────────┐         ┌──────────────┐              │
│  │  Express 服务 │         │  BrowserWindow│             │
│  │  (静态资源)   │         │  (工作流UI)  │               │
│  └──────────────┘         └──────────────┘              │
└─────────────────────────────────────────────────────────┘
                        ↕
┌─────────────────────────────────────────────────────────┐
│                 工作流服务层                               │
│  ┌──────────────┐         ┌──────────────┐              │
│  │  FastAPI     │         │  LangGraph   │              │
│  │  (REST API)  │         │  (工作流引擎) │               │
│  └──────────────┘         └──────────────┘              │
└─────────────────────────────────────────────────────────┘
</code></pre>
<p>整个系统分为三个层次：</p>
<ol>
<li><strong>用户交互层</strong>：Live2D 模型交互和工作流管理界面</li>
<li><strong>Electron 应用层</strong>：桌面应用框架和资源服务</li>
<li><strong>工作流服务层</strong>：后端 API 和工作流执行引擎</li>
</ol>
<hr/>
<h2 data-id="heading-1">第一步：获取 Live2D 免费模型</h2>
<p>Live2D 官方提供了丰富的免费示例模型，我们可以直接下载使用。</p>
<h3 data-id="heading-2">访问下载页面</h3>
<p>打开 Live2D 官方示例数据集页面：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.live2d.com%2Fzh-CHS%2Flearn%2Fsample%2F" target="_blank" title="https://www.live2d.com/zh-CHS/learn/sample/" ref="nofollow noopener noreferrer">www.live2d.com/zh-CHS/lear…</a></p>
<p>在这个页面上，你可以看到多个免费模型，包括：</p>
<ul>
<li><strong>Haru</strong>：一个可爱的女孩角色</li>
<li><strong>Nito</strong>：二头身卡通角色</li>
</ul>
<h3 data-id="heading-3">下载模型文件</h3>
<p>选择一个你喜欢的模型（推荐从 <strong>Haru</strong> 开始），下载 FREE 版本。下载后的文件结构通常如下：</p>
<pre><code class="hljs language-bash" lang="bash">haru/
├── haru_greeter_t05.moc3          <span class="hljs-comment"># 模型数据文件</span>
├── haru_greeter_t05.physics3.json <span class="hljs-comment"># 物理效果配置</span>
├── haru_greeter_t05.pose3.json    <span class="hljs-comment"># 姿势配置</span>
├── haru_greeter_t05.cdi3.json     <span class="hljs-comment"># 显示辅助文件</span>
├── index.json                      <span class="hljs-comment"># 模型索引文件</span>
├── texture_00.png                  <span class="hljs-comment"># 纹理贴图</span>
├── texture_01.png                  <span class="hljs-comment"># 纹理贴图</span>
└── motion/                         <span class="hljs-comment"># 动作文件夹</span>
    ├── haru_g_idle.motion3.json   <span class="hljs-comment"># 待机动作</span>
    └── ...                         <span class="hljs-comment"># 其他动作文件</span>
</code></pre>
<h3 data-id="heading-4">放置模型文件</h3>
<p>将下载的模型文件夹放到项目的 <code>electron/live2d/model/</code> 目录下，例如：</p>
<pre><code class="hljs language-bash" lang="bash">electron/
└── live2d/
    └── model/
        └── haru/          <span class="hljs-comment"># 你下载的模型文件夹</span>
            ├── index.json
            └── ...
</code></pre>
<hr/>
<h2 data-id="heading-5">第二步：初始化 Electron + Live2D 项目</h2>
<h3 data-id="heading-6">项目结构</h3>
<p>首先，我们需要创建一个 Electron 项目，并集成 Live2D 显示功能。这里使用 live2d-widget <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fstevenjoezhang%2Flive2d-widget" target="_blank" title="https://github.com/stevenjoezhang/live2d-widget" ref="nofollow noopener noreferrer">github.com/stevenjoezh…</a> 项目的构建工程集成 Live2D。</p>
<h3 data-id="heading-7">添加构建工程</h3>
<p>将下载 <code>live2d-widget</code> 工程放到以下目录：</p>
<pre><code class="hljs language-markdown" lang="markdown">electron/
└── live2d/
<span class="hljs-code">    └── live2d-widget/
</span></code></pre>
<h3 data-id="heading-8">安装依赖</h3>
<p>在 <code>electron</code> 目录下创建 <code>package.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wenko"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"electron ."</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"electron"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^latest"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"express"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.18.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后运行：</p>
<pre><code class="hljs language-bash" lang="bash">npm install
</code></pre>
<h3 data-id="heading-9">创建主窗口</h3>
<p>创建 <code>index.html</code> 文件，用于显示 Live2D 模型：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Wenko<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"wenko_wifu"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://localhost:8080/live2d/live2d-widget/dist/autoload.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>这里我们通过 <code>localhost:8080</code> 来加载 Live2D 的资源文件，这个服务我们会在下一步创建。</p>
<h3 data-id="heading-10">live2d-widget 项目和 Live2D 模型有什么关系？</h3>
<p><code>live2d-widget</code> 项目不包括任何模型，仅负责在网页中加载和运行 <code>Live2D</code> 模型。具体逻辑可参考 <code>autoload.js</code> 。</p>
<hr/>
<h2 data-id="heading-11">第三步：配置 Express 静态资源服务</h2>
<p>为了让 Live2D 模型文件能够正常加载，我们需要在 Electron 主进程中启动一个 Express 服务器来提供静态文件服务。</p>
<h3 data-id="heading-12">修改 main.js</h3>
<p>打开 <code>electron/main.js</code>，添加 Express 服务器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { app, <span class="hljs-title class_">BrowserWindow</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electron'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);

<span class="hljs-comment">// 创建 Express 服务器提供 live2d 静态文件访问</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createStaticServer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> expressApp = <span class="hljs-title function_">express</span>();
  <span class="hljs-keyword">const</span> port = <span class="hljs-number">8080</span>;
  
  <span class="hljs-comment">// 提供 live2d 目录的静态文件访问</span>
  expressApp.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/live2d'</span>, express.<span class="hljs-title function_">static</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'live2d'</span>)));
  
  expressApp.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Static server running on http://localhost:<span class="hljs-subst">${port}</span>`</span>);
  });
}

<span class="hljs-comment">// 启动静态文件服务器</span>
<span class="hljs-title function_">createStaticServer</span>();

<span class="hljs-comment">// 创建 Electron 窗口</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createWindow</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> mainWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserWindow</span>({
    <span class="hljs-attr">width</span>: <span class="hljs-number">350</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">400</span>,
    <span class="hljs-attr">frame</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">webPreferences</span>: {
      <span class="hljs-attr">nodeIntegration</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">contextIsolation</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">webSecurity</span>: <span class="hljs-literal">false</span>
    }
  });

  mainWindow.<span class="hljs-title function_">loadFile</span>(<span class="hljs-string">'index.html'</span>);
}

app.<span class="hljs-title function_">whenReady</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">createWindow</span>();
});
</code></pre>
<h3 data-id="heading-13">工作流程</h3>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────┐
│  Electron 启动   │
└────────┬─────────┘
         │
         ├──&gt; 启动 Express 服务器 (端口 8080)
         │    └──&gt; 提供 /live2d/* 静态资源
         │
         └──&gt; 创建 BrowserWindow
              └──&gt; 加载 index.html
                   └──&gt; 通过 http://localhost:8080/live2d/... 加载模型
</code></pre>
<h3 data-id="heading-14">为什么需要 Express 服务器？</h3>
<p>Live2D 的模型文件（<code>.moc3</code>、<code>.json</code>、<code>.png</code> 等）需要通过 HTTP 协议加载。虽然 Electron 支持 <code>file://</code> 协议，但某些情况下会遇到跨域问题。使用 Express 提供 HTTP 服务可以：</p>
<ol>
<li><strong>避免跨域问题</strong>：统一使用 HTTP 协议</li>
<li><strong>便于调试</strong>：可以在浏览器中直接访问资源</li>
<li><strong>灵活配置</strong>：可以添加缓存、压缩等中间件</li>
</ol>
<hr/>
<h2 data-id="heading-15">第四步：构建工作流系统</h2>
<p>现在，让我们为桌面女友添加"大脑"——一个可定制的工作流系统。</p>
<h3 data-id="heading-16">初始化 LangGraph 项目</h3>
<p>在项目根目录下创建 <code>workflow</code> 目录，并初始化 Python 项目：</p>
<p><strong>首先安装 uv</strong>（如果还没有安装）：</p>
<pre><code class="hljs language-bash" lang="bash">curl -LsSf https://astral.sh/uv/install.sh | sh
</code></pre>
<p><strong>然后初始化项目</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> workflow
<span class="hljs-built_in">cd</span> workflow

<span class="hljs-comment"># 使用 uv 初始化项目</span>
uv init

<span class="hljs-comment"># 添加依赖</span>
uv add langgraph langgraph-cli fastapi uvicorn httpx pydantic python-dotenv
</code></pre>
<h3 data-id="heading-17">项目结构</h3>
<pre><code class="hljs language-bash" lang="bash">workflow/
├── main.py          <span class="hljs-comment"># FastAPI 应用入口</span>
├── executor.py      <span class="hljs-comment"># 工作流执行器</span>
├── steps.py         <span class="hljs-comment"># 步骤定义</span>
├── graph.py         <span class="hljs-comment"># LangGraph 图定义</span>
├── control_steps.py <span class="hljs-comment"># 控制流步骤（If/Then/Else）</span>
└── pyproject.toml   <span class="hljs-comment"># 项目配置</span>
</code></pre>
<h3 data-id="heading-18">核心组件解析</h3>
<h4 data-id="heading-19">1. steps.py - 步骤定义</h4>
<p><code>steps.py</code> 定义了所有可用的工作流步骤。每个步骤都是一个类，继承自 <code>Step</code> 基类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Step</span>(<span class="hljs-title class_ inherited__">ABC</span>):
    <span class="hljs-string">"""步骤基类"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, step_type: <span class="hljs-built_in">str</span>, params: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>):
        self.step_type = step_type
        self.params = params
    
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, context: StepContext</span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""执行步骤"""</span>
        <span class="hljs-keyword">pass</span>
</code></pre>
<p><strong>步骤类型示例</strong>：</p>
<ul>
<li>
<p><strong>SetVar</strong>：设置变量</p>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"SetVar"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"key"</span>: <span class="hljs-string">"greeting"</span>,
    <span class="hljs-string">"value"</span>: <span class="hljs-string">"Hello, World!"</span>
  }
}
</code></pre>
</li>
<li>
<p><strong>GetVar</strong>：获取变量</p>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"GetVar"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"key"</span>: <span class="hljs-string">"greeting"</span>
  }
}
</code></pre>
</li>
<li>
<p><strong>EchoInput</strong>：回显输入</p>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"EchoInput"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"input_key"</span>: <span class="hljs-string">"user_input"</span>,
    <span class="hljs-string">"output_key"</span>: <span class="hljs-string">"response"</span>
  }
}
</code></pre>
</li>
</ul>
<p><strong>步骤注册表</strong>：</p>
<p>所有步骤都注册在 <code>STEP_REGISTRY</code> 中，方便动态创建：</p>
<pre><code class="hljs language-python" lang="python">STEP_REGISTRY = {
    <span class="hljs-string">'EchoInput'</span>: EchoInputStep,
    <span class="hljs-string">'SetVar'</span>: SetVarStep,
    <span class="hljs-string">'GetVar'</span>: GetVarStep,
    <span class="hljs-comment"># ... 更多步骤类型</span>
}
</code></pre>
<h4 data-id="heading-20">2. executor.py - 工作流执行器</h4>
<p><code>executor.py</code> 负责执行工作流步骤序列：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkflowExecutor</span>:
    <span class="hljs-string">"""工作流执行器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, steps: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>], initial_context: <span class="hljs-type">Dict</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># 创建上下文</span>
        context = StepContext(initial_context <span class="hljs-keyword">or</span> {})
        
        <span class="hljs-comment"># 依次执行每个步骤</span>
        <span class="hljs-keyword">for</span> step_config <span class="hljs-keyword">in</span> steps:
            step_type = step_config.get(<span class="hljs-string">'type'</span>)
            step_params = step_config.get(<span class="hljs-string">'params'</span>, {})
            
            <span class="hljs-comment"># 从注册表创建步骤实例</span>
            step = create_step(step_type, step_params)
            
            <span class="hljs-comment"># 执行步骤</span>
            result = step.execute(context)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'success'</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">'result'</span>: context.variables
        }
</code></pre>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">工作流请求</span>      <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  {               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-attr">steps:</span> [<span class="hljs-string">...</span>], <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-attr">context:</span> {}   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  }               <span class="hljs-string">│</span>
<span class="hljs-string">└────────┬─────────┘</span>
         <span class="hljs-string">│</span>
         <span class="hljs-string">v</span>
<span class="hljs-string">┌─────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">WorkflowExecutor│</span>
<span class="hljs-string">└────────┬─────────┘</span>
         <span class="hljs-string">│</span>
         <span class="hljs-string">v</span>
<span class="hljs-string">┌─────────────────┐</span>      <span class="hljs-string">┌──────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">StepContext</span>    <span class="hljs-string">│&lt;─────│</span>  <span class="hljs-string">变量存储</span>     <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">(上下文)</span>        <span class="hljs-string">│</span>      <span class="hljs-string">│</span>  <span class="hljs-string">variables</span>   <span class="hljs-string">│</span>
<span class="hljs-string">└────────┬────────┘</span>      <span class="hljs-string">└──────────────┘</span>
         <span class="hljs-string">│</span>
         <span class="hljs-string">v</span>
<span class="hljs-string">┌─────────────────────────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">遍历步骤列表</span>                        <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌──────────┐</span>  <span class="hljs-string">┌──────────┐</span>        <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span> <span class="hljs-string">Step</span> <span class="hljs-number">1</span>   <span class="hljs-string">│→</span> <span class="hljs-string">│</span> <span class="hljs-string">Step</span> <span class="hljs-number">2</span>   <span class="hljs-string">│→</span> <span class="hljs-string">...</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──────────┘</span>  <span class="hljs-string">└──────────┘</span>        <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────┘</span>
         <span class="hljs-string">│</span>
         <span class="hljs-string">v</span>
<span class="hljs-string">┌─────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">返回执行结果</span>    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  {               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-attr">success:</span> <span class="hljs-literal">true</span>,<span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-attr">result:</span> {<span class="hljs-string">...</span>} <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  }               <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────┘</span>
</code></pre>
<h4 data-id="heading-21">3. main.py - REST API 接口</h4>
<p><code>main.py</code> 使用 FastAPI 提供 RESTful API：</p>
<p><strong>核心接口</strong>：</p>
<ol>
<li>
<p><strong>执行工作流</strong> - <code>POST /run</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/run"</span>, response_model=WorkflowResponse</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_workflow</span>(<span class="hljs-params">request: WorkflowRequest</span>):
    executor = WorkflowExecutor()
    result = executor.execute(
        steps=request.steps,
        initial_context=request.initial_context <span class="hljs-keyword">or</span> {}
    )
    <span class="hljs-keyword">return</span> result
</code></pre>
</li>
<li>
<p><strong>模板管理接口</strong>：</p>
<ul>
<li><code>POST /templates</code> - 创建模板</li>
<li><code>GET /templates</code> - 列出所有模板</li>
<li><code>GET /templates/{id}</code> - 获取模板详情</li>
<li><code>PUT /templates/{id}</code> - 更新模板</li>
<li><code>DELETE /templates/{id}</code> - 删除模板</li>
<li><code>GET /templates/search/{query}</code> - 搜索模板</li>
<li><code>POST /templates/{id}/execute</code> - 执行模板</li>
</ul>
</li>
<li>
<p><strong>系统接口</strong>：</p>
<ul>
<li><code>GET /health</code> - 健康检查</li>
<li><code>GET /steps</code> - 获取步骤注册表</li>
</ul>
</li>
</ol>
<p><strong>API 调用示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 执行工作流</span>
curl -X POST http://localhost:8002/run \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "steps": [
      {
        "type": "SetVar",
        "params": {"key": "name", "value": "Wenko"}
      },
      {
        "type": "EchoInput",
        "params": {"input_key": "name", "output_key": "greeting"}
      }
    ],
    "initial_context": {}
  }'</span>
</code></pre>
<h3 data-id="heading-22">启动服务</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> workflow
uv run python main.py
</code></pre>
<p>服务启动后，访问 <code>http://localhost:8002/docs</code> 可以看到自动生成的 API 文档。</p>
<hr/>
<h2 data-id="heading-23">第五步：构建工作流管理界面</h2>
<p>最后，我们需要一个友善的界面来管理模板和执行工作流。</p>
<h3 data-id="heading-24">修改 main.js 添加工作流窗口</h3>
<p>在 <code>electron/main.js</code> 中添加快捷键监听，打开工作流管理窗口：</p>
<pre><code class="hljs language-javascript" lang="javascript">ipcMain.<span class="hljs-title function_">on</span>(<span class="hljs-string">'wenko_shortcut'</span>, <span class="hljs-keyword">async</span> (event, data) =&gt; {
  <span class="hljs-comment">// 处理快捷键事件: action: open</span>
  <span class="hljs-keyword">const</span> { action } = data;
  <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'open'</span>) {
    <span class="hljs-keyword">const</span> shortcutWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserWindow</span>({
      <span class="hljs-attr">width</span>: <span class="hljs-number">1200</span>,
      <span class="hljs-attr">height</span>: <span class="hljs-number">800</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'Workflow API 测试工具'</span>,
      <span class="hljs-attr">icon</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'assets'</span>, <span class="hljs-string">'favicon.ico'</span>),
      <span class="hljs-attr">frame</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">transparent</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">alwaysOnTop</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">resizable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">hasShadow</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">fullscreenable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">skipTaskbar</span>: <span class="hljs-literal">false</span>,    <span class="hljs-comment">// 在任务栏显示</span>
      <span class="hljs-attr">webPreferences</span>: {
        <span class="hljs-attr">preload</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'preload.js'</span>),
        <span class="hljs-attr">nodeIntegration</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">contextIsolation</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">webSecurity</span>: <span class="hljs-literal">false</span>  <span class="hljs-comment">// 关闭同源策略和 CSP 检查，方便开发加载任意脚本</span>
      }
    });
    shortcutWindow.<span class="hljs-title function_">loadFile</span>(<span class="hljs-string">'workflow.html'</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Unknown action:'</span>, action);
  }
});

</code></pre>
<h3 data-id="heading-25">workflow.html 功能模块</h3>
<p><code>workflow.html</code> 使用 React + Ant Design 构建，包含以下功能：</p>
<h4 data-id="heading-26">1. 工作流执行标签页</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────┐
│  工作流执行                          │
├─────────────────────────────────────┤
│  工作流步骤 (JSON)                   │
│  ┌───────────────────────────────┐  │
│  │ <span class="hljs-selector-attr">[                            │  ││  │   {<span class="hljs-string">"type"</span>: <span class="hljs-string">"SetVar"</span>, ...}    │  ││  │ ]</span>                            │  │
│  └───────────────────────────────┘  │
│                                      │
│  初始上下文 (JSON, 可选)              │
│  ┌───────────────────────────────┐  │
│  │ {"key": <span class="hljs-string">"value"</span>}              │  │
│  └───────────────────────────────┘  │
│                                      │
│  ☑ 调试模式                          │
│                                      │
│  <span class="hljs-selector-attr">[执行工作流]</span> <span class="hljs-selector-attr">[加载示例]</span> <span class="hljs-selector-attr">[清空]</span>      │
└─────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-27">2. 模板管理标签页</h4>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────┐
│  模板管理                            │
├─────────────────────────────────────┤
│  <span class="hljs-selector-attr">[+ 创建新模板]</span>                      │
│                                      │
│  ┌───────────────────────────────┐  │
│  │ 模板名称                        │  │
│  │ 描述：这是一个示例模板...        │  │
│  │ 标签：<span class="hljs-selector-attr">[基础]</span> <span class="hljs-selector-attr">[示例]</span>              │  │
│  │ <span class="hljs-selector-attr">[查看]</span> <span class="hljs-selector-attr">[执行]</span> <span class="hljs-selector-attr">[编辑]</span> <span class="hljs-selector-attr">[删除]</span>     │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-28">3. 步骤注册表标签页</h4>
<p>显示所有可用的步骤类型：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────┐
│  步骤注册表                          │
├─────────────────────────────────────┤
│  <span class="hljs-selector-attr">[刷新步骤列表]</span>                      │
│                                      │
│  ┌──────┐ ┌──────┐ ┌──────┐        │
│  │EchoInput│ │SetVar│ │GetVar│        │
│  └──────┘ └──────┘ └──────┘        │
│  ┌──────┐ ┌──────┐ ┌──────┐        │
│  │FetchURL│ │ParseJSON│ │...│        │
│  └──────┘ └──────┘ └──────┘        │
└─────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-29">模板执行流程</h3>
<p>当用户点击"执行"按钮时：</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────┐
│  用户点击执行    │
└────────┬────────┘
         │
         v
┌─────────────────┐
│  弹出对话框      │
│  让用户输入上下文│
└────────┬────────┘
         │
         v
┌─────────────────┐
│  调用 API        │
│  POST /templates/│
│  {<span class="hljs-built_in">id</span>}/execute    │
└────────┬────────┘
         │
         v
┌─────────────────┐
│  显示执行结果    │
└─────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-30">完整系统架构</h2>
<p>现在，让我们看看整个系统是如何协作的：</p>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────────────────────┐
│                      用户操作流程                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">1.</span> 启动 <span class="hljs-title class_">Electron</span> 应用              │
        │     - 显示 <span class="hljs-title class_">Live2D</span> 模型             │
        │     - 启动 <span class="hljs-title class_">Express</span> 静态服务         │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">2.</span> 与 <span class="hljs-title class_">Live2D</span> 模型交互打开管理界面     │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">3.</span> 在工作流界面中：                │
        │     - 创建/编辑模板                 │
        │     - 执行工作流                    │
        │     - 查看步骤注册表                │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">4.</span> 前端调用 <span class="hljs-title class_">FastAPI</span>                │
        │     <span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:8002/...       │</span>
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">5.</span> <span class="hljs-title class_">FastAPI</span> 处理请求                │
        │     - 解析 <span class="hljs-title class_">JSON</span>                     │
        │     - 调用 <span class="hljs-title class_">WorkflowExecutor</span>         │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">6.</span> <span class="hljs-title class_">WorkflowExecutor</span> 执行步骤      │
        │     - 创建 <span class="hljs-title class_">StepContext</span>             │
        │     - 遍历步骤列表                 │
        │     - 执行每个步骤                 │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">7.</span> 返回执行结果                    │
        │     - 成功/失败状态                 │
        │     - 上下文变量                    │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">8.</span> 前端显示结果                    │
        │     - 成功提示                     │
        │     - 结果 <span class="hljs-title class_">JSON</span> 展示               │
        └───────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-31">使用示例</h2>
<h3 data-id="heading-32">示例 1：简单的问候工作流</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"steps"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SetVar"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Wenko"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"TemplateReplace"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"template"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好，{{name}}！今天过得怎么样？"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"template_key"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"output_key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"greeting"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"initial_context"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>执行结果：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Wenko"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"greeting"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好，Wenko！今天过得怎么样？"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-33">总结</h2>
<p>通过本文，我们完成了一个完整的可定制工作流桌面女友系统：</p>
<ol>
<li>✅ <strong>Live2D 模型集成</strong>：从官网下载免费模型并集成到 Electron</li>
<li>✅ <strong>静态资源服务</strong>：使用 Express 提供模型文件访问</li>
<li>✅ <strong>工作流引擎</strong>：基于 LangGraph 构建可扩展的工作流系统</li>
<li>✅ <strong>REST API</strong>：提供完整的模板管理和执行接口</li>
<li>✅ <strong>管理界面</strong>：友好的 Web 界面用于模板管理</li>
</ol>
<p>这个系统具有很强的扩展性：</p>
<ul>
<li>可以添加更多步骤类型（如 AI 对话、文件操作等）</li>
<li>可以集成更多 Live2D 模型和动作</li>
<li>可以添加数据库持久化模板</li>
<li>可以实现工作流与 Live2D 模型的联动（根据工作流结果触发模型动作）</li>
</ul>
<p>希望这篇文章能帮助你打造属于自己的智能桌面女友！🚀</p>
<hr/>
<h2 data-id="heading-34">参考资源</h2>
<ul>
<li>Live2D 官方示例数据集 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.live2d.com%2Fzh-CHS%2Flearn%2Fsample%2F" target="_blank" title="https://www.live2d.com/zh-CHS/learn/sample/" ref="nofollow noopener noreferrer">www.live2d.com/zh-CHS/lear…</a></li>
<li>live2d-widget 项目 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fstevenjoezhang%2Flive2d-widget" target="_blank" title="https://github.com/stevenjoezhang/live2d-widget" ref="nofollow noopener noreferrer">github.com/stevenjoezh…</a></li>
<li>LangGraph 官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraph%2F" target="_blank" title="https://langchain-ai.github.io/langgraph/" ref="nofollow noopener noreferrer">langchain-ai.github.io/langgraph/</a></li>
<li>FastAPI 官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Ffastapi.tiangolo.com%2F" target="_blank" title="https://fastapi.tiangolo.com/" ref="nofollow noopener noreferrer">fastapi.tiangolo.com/</a></li>
<li>Electron 官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.electronjs.org%2F" target="_blank" title="https://www.electronjs.org/" ref="nofollow noopener noreferrer">www.electronjs.org/</a></li>
<li>本项目仓库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdaijinru%2Fwenko" target="_blank" title="https://github.com/daijinru/wenko" ref="nofollow noopener noreferrer">github.com/daijinru/we…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG 系统架构设计模式介绍]]></title>    <link>https://juejin.cn/post/7576955345378181183</link>    <guid>https://juejin.cn/post/7576955345378181183</guid>    <pubDate>2025-11-27T03:31:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576955345378181183" data-draft-id="7576953459543851062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG 系统架构设计模式介绍"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-27T03:31:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG 系统架构设计模式介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:31:18.000Z" title="Thu Nov 27 2025 03:31:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>在模块化RAG（Retrieval-Augmented Generation）设计中，各种操作模式通过模块化的方式协同工作，形成了一个名为 <strong>RAG流</strong> 的工作流程。这个 <strong>RAG流</strong> 可以被视为由多个子函数组成的图形结构。通过控制逻辑，这些子函数会按预定的顺序执行，同时也能根据需求进行条件判断、分支或循环。</p>
<p>这种模块化特性让RAG系统能够灵活应对不同的应用场景，并且提升了系统的设计效率和扩展性。在分析现有的RAG方法时，我们可以看到，模块化的结构使得RAG系统可以在处理复杂任务时更具适应性。</p>
<p><strong>本章将详细介绍几种常见的 <strong>RAG模式</strong>，包括：</strong></p>
<ul>
<li><strong>线性模式</strong>：在这个模式下，各个模块按顺序依次执行，每个步骤的输出作为下一个步骤的输入，适用于顺序性较强的任务。</li>
<li><strong>条件模式</strong>：根据特定的条件，选择性地执行不同的模块操作。这个模式能够处理具有分支或选择性的任务。</li>
<li><strong>分支模式</strong>：与条件模式类似，但它更多地用于任务中涉及多个并行处理路径的场景。</li>
<li><strong>循环模式</strong>：当某些操作需要重复执行时，循环模式便会派上用场。它适合那些需要反复处理相似任务的应用。</li>
</ul>
<p>通过这些模式的结合，RAG系统不仅能够高效地处理多样化的任务需求，还可以在面对复杂任务时保持灵活性与扩展性。</p>
<h2 data-id="heading-0">1 线性模式</h2>
<p>在 <strong>RAG系统</strong> 中，<strong>线性模式</strong> 是最简单且最常见的工作流模式。其核心流程包括几个主要模块：<strong>预检索（Pre-Retrieval）</strong> 、<strong>检索</strong>、<strong>后检索（Post-Retrieval）</strong>  和 <strong>生成模块</strong>。这些模块按顺序依次进行处理，如图示。值得注意的是，当预检索和检索后处理模块缺失时，线性模式会简化为一种称为 <strong>朴素检索增强生成（Naive RAG）</strong>  的基本范式，仅包含检索和生成过程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/916860248a544c5883deea38e4fb77a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819077&amp;x-signature=TIsdJRXvvLFI8GuilrKrPDEJoyY%3D" alt="" loading="lazy"/></p>
<p>为了提升生成的质量，常见的线性RAG流通过以下几个步骤优化：</p>
<ul>
<li><strong>预检索阶段</strong>：这一阶段引入了查询变换模块，通常采用查询重写或者隐式文档扩展（HyDE）等操作符。通过这些变换，查询能够更好地适应检索需求，提高检索的相关性。</li>
<li><strong>检索阶段</strong>：在这一阶段，系统通过检索工具（如BM25）从外部知识库中获取与重写后的查询高度相关的文档或上下文信息。</li>
<li><strong>后检索阶段</strong>：检索结果进一步优化，通常通过排序模块对检索的结果进行调整，使得最终选出的文档最能满足生成需求。</li>
<li><strong>生成模块</strong>：最终，通过生成模型（例如GPT或T5等）处理优化后的文档上下文，产生高质量的回答或生成内容。</li>
</ul>
<p>一个典型的线性RAG流模式是：“<strong>重写-检索-阅读（Rewrite-Retrieve-Read，RRR）</strong> ”方法。该方法在预检索阶段引入了一个查询重写模块。这个模块基于 <strong>T5-large</strong> 模型的微调版本，并通过强化学习框架进行优化，将查询重写过程建模为 <strong>马尔可夫决策过程（MDP）</strong> 。</p>
<p>在这个过程中，查询重写模块的输出质量被视为奖励信号，强化学习算法通过策略梯度方法来调整和优化生成的查询，从而确保查询更符合检索任务的需求。这种方式提升了检索的效率，并进一步改善了生成结果的效果。</p>
<p>在检索阶段，<strong>RRR方法</strong>使用了稀疏编码模型（如<strong>BM25</strong>）进行检索，从外部知识库中获取与重写后的查询相关的文档，进一步增强了系统生成内容的准确性和可靠性。</p>
<p>通过这样的设计，线性模式的RAG流不仅提高了生成质量，还能在实际应用中实现高效的知识提取和生成。</p>
<h2 data-id="heading-1">2 条件模式</h2>
<p><strong>条件模式</strong> 是一种灵活的 <strong>RAG流模式</strong>，其核心特点是在不同的条件下选择不同的工作流，以便针对特定场景进行优化。这种模式的关键在于一个 <strong>路由模块（Routing Module）</strong> ，该模块根据输入问题的特性动态选择接下来的处理流程，如下图所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bb8991ca548429b9ac79f7a5fd56527~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819077&amp;x-signature=q5Tdoaw6g9BJq27Q7Q4lfoQiEwQ%3D" alt="" loading="lazy"/></p>
<p>具体来说，当系统接收到不同类型的问题时，它会根据预设的条件或规则决定如何处理。例如，对于涉及严肃议题、政治话题或娱乐内容等不同类型的问题，系统会自动切换到不同的处理流程。这种动态路由机制显著提升了系统处理多样化任务的能力，使得系统能够灵活应对各种复杂场景。</p>
<p><strong>条件模式的分支流</strong> 主要体现在以下几个方面：</p>
<ul>
<li><strong>检索来源</strong>：系统会根据问题的性质选择不同的检索来源。例如，对于严肃问题，系统可能会选择更可靠的、权威性的来源，而对于娱乐性问题，则可能选择更多元或创意性的资料。</li>
<li><strong>流程选择</strong>：针对不同任务的需求，条件模式可能会调整流程的细节，控制模块的顺序、执行的操作，甚至是否进行一些后处理。</li>
<li><strong>模型配置</strong>：不同类型的问题可能需要不同的模型配置。比如，严肃问题可能使用更精确、保守的模型，而娱乐类问题则可能使用更具创意性和生成自由度的模型。</li>
<li><strong>提示设计</strong>：根据任务的性质，系统的提示设计（Prompt Design）也会有所不同。对于严肃问题，提示可能会更为规范和严格，而对于娱乐类问题，提示可能会更具开放性和灵活性。</li>
</ul>
<p>举个例子，对于严肃性较高的问题（如法律、健康、政治等），系统可能会选择更加可靠的检索来源，并对生成的内容设置严格的约束，确保信息的准确性和权威性。而对于娱乐类的问题（如电影、游戏、搞笑等），系统则可以容忍更多的创意和不拘一格的生成，提供富有娱乐性和趣味性的回答。</p>
<p>通过这种方式，<strong>条件模式</strong> 能够根据任务的需求动态调整 <strong>RAG</strong> 各个组件，确保生成的回答既符合场景需求，又保持高相关性和准确性。这种灵活性使得 <strong>条件模式</strong> 在处理多样化、复杂性高的任务时具有显著的优势，能够有效提升系统的适应能力和输出质量。</p>
<h2 data-id="heading-2">3 分支模式</h2>
<p><strong>分支模式</strong> 是 <strong>RAG（Retrieval-Augmented Generation）</strong>  系统中一种增加结果多样性和鲁棒性的重要设计方式。它通过并行运行多个分支，来生成多样化的结果，从而提升系统的性能和准确性。</p>
<p>具体来说，<strong>分支模式</strong> 在某个模块中生成多个并行的分支，每个分支可以独立执行相同或不同的 <strong>RAG流程</strong>。这些分支通常由多个处理模块组成，每个模块生成各自的结果。然后，这些分支的结果会通过一个 <strong>聚合函数</strong> 合并成一个中间输出结果。值得注意的是，合并后的结果不一定意味着流程的结束，它们还可以传递到后续模块（如验证模块）进行进一步处理。整体流程从生成多个分支、独立处理、到结果聚合，形成了一个完整的流水线。</p>
<p>与<strong>条件模式</strong>不同，<strong>分支模式</strong> 的特点在于同时并行运行多个分支，而不是从多个选项中选择一个分支。这使得分支模式能够同时从多个角度进行处理，生成更加丰富和多样化的结果。</p>
<h4 data-id="heading-3">分支模式的结构类型</h4>
<p>根据任务需求，<strong>分支模式</strong> 可以设计为不同的结构，通常分为两种类型：</p>
<ul>
<li>
<p><strong>预检索分支模式（Pre-Retrieval Branching）</strong> 这种模式通过生成多个子查询并并行检索，旨在提高检索的全面性和生成结果的多样性。具体流程是，首先通过查询扩展模块将初始查询扩展为多个子查询。每个子查询然后通过检索模块获取相关文档，形成文档集合。这些文档和相应的子查询一同送入生成模块，产生多个答案集合。最终，所有生成的答案通过融合模块进行整合，形成最终的结果。</p>
<p>这种模式的优势在于，它能够从多个角度挖掘潜在信息，增强生成结果的覆盖度和准确性。它特别适用于需要广泛搜索和多角度生成的任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c70b9c7cd42e49d79ecd013ac9fb7777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819077&amp;x-signature=wGS%2FkFuRSa2YbxdbMRosS0%2FPC08%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>后检索分支模式（Post-Retrieval Branching）</strong> 该模式从单一查询开始，首先通过检索模块获取多个文档块。然后，每个文档块被独立送入生成模块进行处理，生成对应的结果集合。这些结果最终会通过合并模块整合，形成最终输出。</p>
<p>与预检索分支模式不同，后检索分支模式的特点在于，它通过单一查询进行检索，而并行生成则集中在对不同文档块的独立处理上。这个模式非常适合那些需要从同一查询结果中挖掘多角度信息的场景，能更好地利用检索到的内容，提升生成结果的多样性和质量。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65acc7536587464f8ee0417e3206d768~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819077&amp;x-signature=qArkwsRjpn91ubzOaRak1FNoFtk%3D" alt="" loading="lazy"/></p>
</li>
</ul>
<h4 data-id="heading-4">分支模式的优势</h4>
<p>通过并行执行多个分支，分支模式能够从多个角度生成和整合信息，极大地提升了系统的生成能力和结果质量。它特别适合于处理复杂场景和多任务需求，可以为不同的应用场景提供更加多样和精准的答案。因此，分支模式在 <strong>多任务处理</strong> 和 <strong>复杂场景</strong> 中具有显著的优势。</p>
<h2 data-id="heading-5">4 循环模式</h2>
<p><strong>循环模式</strong> 是 <strong>RAG（Retrieval-Augmented Generation）</strong>  系统中一种重要的设计方式，其核心特点是检索与生成步骤之间的相互依赖性。通过引入一个 <strong>调度模块</strong> 来控制流程，循环模式确保系统可以根据任务需求在不同模块之间重复执行某些操作。这使得循环模式可以不断优化流程中的步骤，提升任务的最终效果。</p>
<h4 data-id="heading-6">循环模式的基本原理</h4>
<p>循环模式可以抽象为一个 <strong>有向图</strong>，图中的节点代表系统中的各个模块，边则表示模块之间的控制流或数据流。当某个模块的输出能够返回到之前的模块时，系统就形成了一个 <strong>循环结构</strong>。这样的设计让系统可以根据需要在某些步骤之间来回循环，以不断优化结果，直到达到理想的效果。</p>
<h4 data-id="heading-7">判断模块</h4>
<p>在循环模式中，<strong>判断模块（Judge Module）</strong>  起到了关键作用。它用于决定系统是否需要返回到前一个模块，或者是否继续向下执行。例如，在每一次生成或检索之后，判断模块可以根据当前的输出结果、历史数据、查询和检索到的文档来决定是否继续迭代。如果决定返回，流程就会进行循环；如果决定不返回，流程则继续向前执行。这样，系统能够根据当前任务的情况动态调整整个流程。</p>
<h4 data-id="heading-8">循环模式的类型</h4>
<p>循环模式可以进一步细分为三种类型：<strong>迭代型循环模式</strong>、<strong>递归型循环模式</strong> 和 <strong>自适应型（主动型）循环模式</strong>。每种模式都适用于不同的场景，提供了灵活的处理方式。</p>
<ol>
<li>
<p><strong>迭代型循环模式</strong> 迭代型循环模式通过多次执行检索和生成操作，在每次迭代中逐步优化结果。如下图所示，在每一步迭代中，系统根据当前的查询和之前的输出结果来检索相关文档，然后使用这些文档生成新的输出。迭代过程通常会设置一个 <strong>最大迭代次数的限制</strong>，以避免出现无限循环。在每次迭代后，判断模块会根据当前的生成结果、历史输出、查询和检索到的文档来决定是否继续迭代。迭代型模式非常适合那些需要逐步收集信息并动态调整的任务，能够逐渐完善对复杂问题的回答。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15f29b8a03dc41b3a660080b41c88dfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819077&amp;x-signature=h9rCC0U58soi%2FNZb2dshiKhMfFE%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>递归型循环模式</strong> 递归型循环模式则是一种具有明显依赖性和层次性的检索方式，如图所示。每一步操作都依赖于前一步的输出，并通过不断深化检索过程，逐步获取更深入的信息。递归型模式通常遵循类似 <strong>树状结构</strong> 的模式，每次检索会基于改写后的查询进一步展开，以精确定位所需的知识。递归型检索具有明确的 <strong>退出机制</strong>，以确保在达到终止条件时流程停止，从而避免无限递归。此模式适用于需要分步推理或逐层分析的任务，能够深入挖掘相关信息并生成高质量的回答。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fbb2086ecc7407b89d4130e43ec960c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819077&amp;x-signature=xh4QZTOLAZx5cYdN6IOyRK1%2FvKw%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>自适应型（主动型）循环模式</strong> 自适应型循环模式是一种超越传统被动检索的方式，得益于大语言模型强大的能力。如图9.16所示，自适应型模式的核心思想是通过智能体的方式动态调整检索流程，主动决定何时进行检索，何时终止流程并生成最终结果。这种模式与传统的固定流程不同，具有更高的 <strong>灵活性</strong> 和 <strong>智能性</strong>。它能够实时根据任务的需求调整策略，判断最佳的执行路径。自适应型检索通常通过两种方法来进一步细分：一是 <strong>基于提示</strong> 的方法，通过设计动态提示来引导模型的检索；二是 <strong>基于指令微调</strong> 的方法，通过微调模型来实现更精准的检索控制。自适应型模式特别适用于复杂任务或动态信息需求的场景，能够提升检索效率和生成质量。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/289c41411a194189bf37cfe537788a27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819077&amp;x-signature=0M4UhUQCz5hbNMlL02uVZ27IJo4%3D" alt="" loading="lazy"/></p>
</li>
</ol>
<h4 data-id="heading-9">循环模式的优势</h4>
<p>通过引入循环结构，<strong>循环模式</strong> 能够让系统在检索与生成的过程中不断优化，逐步提升任务的完成效果。无论是 <strong>迭代型</strong> 的逐步改进，还是 <strong>递归型</strong> 的深度推理，或是 <strong>自适应型</strong> 的智能控制，循环模式都为 <strong>RAG</strong> 系统提供了强大的灵活性和处理能力，能够在面对复杂问题时进行更精确的调整和优化，从而提升生成结果的质量和准确性。</p>
<h3 data-id="heading-10">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph4j LangChain4j JAVA 多Agent编排详解]]></title>    <link>https://juejin.cn/post/7577201863724924928</link>    <guid>https://juejin.cn/post/7577201863724924928</guid>    <pubDate>2025-11-27T03:00:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577201863724924928" data-draft-id="7576867727719858211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangGraph4j LangChain4j JAVA  多Agent编排详解 "/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-27T03:00:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zhengzizhe"/> <meta itemprop="url" content="https://juejin.cn/user/159867906828928"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangGraph4j LangChain4j JAVA  多Agent编排详解 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/159867906828928/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zhengzizhe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:00:03.000Z" title="Thu Nov 27 2025 03:00:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    25
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangGraph4j 多Agent编排详解：为什么这么做，怎么做</h2>
<h3 data-id="heading-1">引言</h3>
<p>在多Agent系统中，如何协调多个AI Agent协同完成复杂任务是一个核心挑战。本文深入解析基于LangGraph4j的多Agent编排系统，重点阐述<strong>为什么选择这种架构</strong>以及<strong>如何具体实现</strong>。</p>
<hr/>
<h3 data-id="heading-2">一、为什么选择LangGraph4j？</h3>
<h4 data-id="heading-3">1.1 多Agent编排的核心挑战</h4>
<p>在构建多Agent系统时，我们面临以下核心问题：</p>
<ol>
<li><strong>任务依赖管理</strong>：任务A的输出是任务B的输入，如何确保执行顺序？</li>
<li><strong>并行执行优化</strong>：无依赖的任务如何并行执行以提高效率？</li>
<li><strong>状态共享</strong>：多个Agent如何共享中间结果和上下文？</li>
<li><strong>错误处理</strong>：某个Agent失败时，如何不影响其他Agent？</li>
<li><strong>流程可视化</strong>：如何清晰地表达复杂的执行流程？</li>
</ol>
<h4 data-id="heading-4">1.2 LangGraph4j的解决方案</h4>
<p><strong>LangGraph4j</strong>基于**状态图（StateGraph）**的概念，完美解决了上述问题：</p>
<ul>
<li><strong>图结构</strong>：用节点（Node）表示Agent，用边（Edge）表示依赖关系，直观清晰</li>
<li><strong>状态管理</strong>：通过<code>WorkspaceState</code>统一管理所有中间数据，实现Agent间的数据传递</li>
<li><strong>自动调度</strong>：框架自动根据依赖关系调度执行，支持并行和串行混合</li>
<li><strong>错误隔离</strong>：每个节点独立执行，失败不影响其他节点</li>
</ul>
<p><strong>这就是为什么我们选择LangGraph4j</strong>：它提供了声明式的编排方式，让我们专注于业务逻辑而非执行细节。</p>
<hr/>
<h3 data-id="heading-5">二、为什么采用Supervisor-Worker模式？</h3>
<h4 data-id="heading-6">2.1 设计动机</h4>
<p>传统的多Agent系统往往存在以下问题：</p>
<ul>
<li><strong>硬编码流程</strong>：任务流程写死在代码中，无法动态调整</li>
<li><strong>缺乏智能规划</strong>：无法根据任务特点智能分配Agent</li>
<li><strong>扩展性差</strong>：新增Agent需要修改代码</li>
</ul>
<h4 data-id="heading-7">2.2 Supervisor-Worker模式的优势</h4>
<p>我们采用<strong>Supervisor-Worker模式</strong>，核心思想是：</p>
<pre><code class="hljs">Supervisor（主管Agent）
  ↓ 分析用户请求，生成任务计划
TaskPlan（任务计划）
  ↓ 包含任务列表和依赖关系
Workers（工作者Agent）
  ↓ 执行具体任务
结果汇总
</code></pre>
<p><strong>为什么这样设计？</strong></p>
<ol>
<li><strong>动态规划</strong>：Supervisor根据用户请求和可用Agent动态生成计划，无需硬编码</li>
<li><strong>职责分离</strong>：Supervisor负责"思考"（规划），Worker负责"执行"（干活）</li>
<li><strong>易于扩展</strong>：新增Worker只需注册，Supervisor会自动识别并使用</li>
<li><strong>智能调度</strong>：Supervisor了解每个Worker的能力，可以做出最优分配</li>
</ol>
<h4 data-id="heading-8">2.3 具体实现：Orchestrator类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Orchestrator</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ServiceNode supervisorNode;      <span class="hljs-comment">// 主管节点</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;ServiceNode&gt; workerNodes;   <span class="hljs-comment">// 工作者节点列表</span>
    
    <span class="hljs-comment">/**
     * 执行流程：规划 → 构建图 → 执行
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String userRequest, UserContext userContext)</span> {
        <span class="hljs-comment">// Step 1: Supervisor生成任务计划</span>
        <span class="hljs-type">TaskPlan</span> <span class="hljs-variable">taskPlan</span> <span class="hljs-operator">=</span> plan(userRequest, userContext);
        
        <span class="hljs-comment">// Step 2: 根据计划构建执行图</span>
        CompiledGraph&lt;WorkspaceState&gt; graph = buildGraph(taskPlan, userContext);
        
        <span class="hljs-comment">// Step 3: 执行图</span>
        graph.invoke(init);
    }
}
</code></pre>
<p><strong>为什么分三步？</strong></p>
<ul>
<li><strong>plan()</strong>：让Supervisor理解需求并规划，这是"思考"阶段</li>
<li><strong>buildGraph()</strong>：将计划转换为可执行的图结构，这是"准备"阶段</li>
<li><strong>invoke()</strong>：实际执行，这是"行动"阶段</li>
</ul>
<p>这种分离使得每个阶段职责清晰，易于测试和维护。</p>
<hr/>
<h3 data-id="heading-9">三、如何实现任务规划？</h3>
<h4 data-id="heading-10">3.1 为什么需要任务规划？</h4>
<p>用户请求往往是模糊的，比如"帮我写一份市场分析报告"。Supervisor需要：</p>
<ol>
<li><strong>理解需求</strong>：分析用户真正想要什么</li>
<li><strong>任务分解</strong>：将复杂任务拆解为可执行的子任务</li>
<li><strong>分配Agent</strong>：根据任务特点选择合适的Worker</li>
<li><strong>建立依赖</strong>：确定任务间的执行顺序</li>
</ol>
<h4 data-id="heading-11">3.2 如何实现：plan()方法详解</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> TaskPlan <span class="hljs-title function_">plan</span><span class="hljs-params">(String userRequest, UserContext userContext)</span> {
    <span class="hljs-comment">// 1. 构建规划提示词</span>
    <span class="hljs-comment">// 为什么需要这些信息？</span>
    <span class="hljs-comment">// - userRequest: 用户的具体需求</span>
    <span class="hljs-comment">// - subAgents: 可用的Worker列表及其能力，让Supervisor知道"谁能做什么"</span>
    <span class="hljs-comment">// - chatHistory: 历史对话，提供上下文记忆</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">planningPrompt</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
        {
          "userRequest": "%s",
          "subAgents": %s,
          "chatHistory": %s
        }
        """</span>.formatted(userRequest, subWorkersDesc(), historyContext);
    
    <span class="hljs-comment">// 2. 调用Supervisor AI生成计划</span>
    <span class="hljs-comment">// 为什么用流式调用？</span>
    <span class="hljs-comment">// - 可以实时反馈规划进度</span>
    <span class="hljs-comment">// - 支持长文本生成</span>
    <span class="hljs-type">TokenStream</span> <span class="hljs-variable">chat</span> <span class="hljs-operator">=</span> supAi.chat(planningPrompt);
    
    <span class="hljs-comment">// 3. 等待完整响应</span>
    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
    
    chat.onCompleteResponse(e -&gt; {
        builder.append(e.aiMessage().text());
        latch.countDown();
    });
    chat.start();
    latch.await();
    
    <span class="hljs-comment">// 4. 解析JSON为TaskPlan对象</span>
    <span class="hljs-comment">// 为什么返回JSON？</span>
    <span class="hljs-comment">// - 结构化数据，易于解析</span>
    <span class="hljs-comment">// - Supervisor可以明确指定任务ID、依赖关系等</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> builder.toString();
    <span class="hljs-type">TaskPlan</span> <span class="hljs-variable">taskPlan</span> <span class="hljs-operator">=</span> JSON.parseObject(response, TaskPlan.class);
    
    <span class="hljs-keyword">return</span> taskPlan;
}
</code></pre>
<h4 data-id="heading-12">3.3 TaskPlan的结构设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskPlan</span> {
    <span class="hljs-keyword">private</span> String summary;        <span class="hljs-comment">// 计划摘要：为什么需要？让用户知道Supervisor理解了什么</span>
    <span class="hljs-keyword">private</span> Integer totalTasks;     <span class="hljs-comment">// 总任务数：为什么需要？用于进度跟踪</span>
    <span class="hljs-keyword">private</span> List&lt;Task&gt; tasks;      <span class="hljs-comment">// 任务列表：核心数据</span>
}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> {
    <span class="hljs-keyword">private</span> String id;                    <span class="hljs-comment">// 任务ID：为什么需要？用于依赖关系标识</span>
    <span class="hljs-keyword">private</span> String title;                 <span class="hljs-comment">// 任务标题：为什么需要？便于理解和调试</span>
    <span class="hljs-keyword">private</span> String description;           <span class="hljs-comment">// 任务描述：为什么需要？Worker需要知道具体做什么</span>
    <span class="hljs-keyword">private</span> String agentId;               <span class="hljs-comment">// 负责的Agent ID：为什么需要？指定执行者</span>
    <span class="hljs-keyword">private</span> TaskInputs inputs;            <span class="hljs-comment">// 输入配置：为什么需要？定义数据来源</span>
    <span class="hljs-keyword">private</span> ExecutionStrategy executionStrategy;  <span class="hljs-comment">// 执行策略：为什么需要？控制输出方式</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskInputs</span> {
    <span class="hljs-keyword">private</span> Boolean fromUser;          <span class="hljs-comment">// 是否来自用户：为什么需要？区分数据来源</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; fromTask;     <span class="hljs-comment">// 依赖的任务ID列表：为什么需要？定义执行顺序</span>
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li><code>fromTask</code>列表定义了依赖关系，这是构建执行图的关键</li>
<li><code>agentId</code>指定执行者，确保任务分配给正确的Worker</li>
<li><code>executionStrategy</code>控制是否流式输出，平衡用户体验和性能</li>
</ul>
<hr/>
<h3 data-id="heading-13">四、如何构建执行图？</h3>
<h4 data-id="heading-14">4.1 为什么需要GraphBuilder？</h4>
<p>TaskPlan只是数据结构，需要转换为可执行的图。GraphBuilder的作用是：</p>
<ol>
<li><strong>创建节点</strong>：为每个任务创建执行节点</li>
<li><strong>建立边</strong>：根据依赖关系连接节点</li>
<li><strong>处理入口出口</strong>：连接START和END节点</li>
</ol>
<h4 data-id="heading-15">4.2 如何实现：GraphBuilder.build()详解</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompiledGraph&lt;WorkspaceState&gt; <span class="hljs-title function_">build</span><span class="hljs-params">(
    TaskPlan taskPlan,
    Map&lt;String, ServiceNode&gt; workersByID,
    UserContext userContext
)</span> <span class="hljs-keyword">throws</span> GraphStateException {
    
    <span class="hljs-comment">// ========== 第一步：创建状态图 ==========</span>
    <span class="hljs-comment">// 为什么需要状态图？</span>
    <span class="hljs-comment">// - 状态图是LangGraph4j的核心抽象</span>
    <span class="hljs-comment">// - WorkspaceState::new 是状态工厂方法，用于创建初始状态</span>
    StateGraph&lt;WorkspaceState&gt; graph = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StateGraph</span>&lt;&gt;(WorkspaceState::<span class="hljs-keyword">new</span>);
    
    <span class="hljs-comment">// ========== 第二步：为每个任务创建节点 ==========</span>
    <span class="hljs-comment">// 为什么需要节点？</span>
    <span class="hljs-comment">// - 节点是图的执行单元，每个节点对应一个Agent任务</span>
    <span class="hljs-keyword">for</span> (Task task : taskPlan.getTasks()) {
        <span class="hljs-comment">// 1. 创建执行器：为什么需要执行器？</span>
        <span class="hljs-comment">// - 执行器封装了具体的执行逻辑（调用AI、处理结果等）</span>
        <span class="hljs-comment">// - ExecutorFactory根据策略创建不同类型的执行器（静默/流式）</span>
        <span class="hljs-type">TaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> ExecutorFactory.create(
            task, 
            workersByID.get(task.getAgentId()),  <span class="hljs-comment">// 根据agentId找到对应的ServiceNode</span>
            userContext
        );
        
        <span class="hljs-comment">// 2. 添加节点到图：为什么用异步执行？</span>
        <span class="hljs-comment">// - CompletableFuture.supplyAsync()实现真正的异步执行</span>
        <span class="hljs-comment">// - 无依赖的任务可以并行执行，提高效率</span>
        <span class="hljs-comment">// - executorService是线程池，管理线程资源</span>
        graph.addNode(task.getId(), state -&gt; {
            <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    log.debug(<span class="hljs-string">"异步执行节点: taskId={}, thread={}"</span>, 
                        task.getId(), Thread.currentThread().getName());
                    <span class="hljs-comment">// executor.apply(state)执行任务，返回更新后的状态</span>
                    <span class="hljs-keyword">return</span> executor.apply(state);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.error(<span class="hljs-string">"节点执行异常: taskId={}"</span>, task.getId(), e);
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"节点执行失败: taskId="</span> + task.getId(), e);
                }
            }, executorService);
        });
    }
    
    <span class="hljs-comment">// ========== 第三步：建立依赖关系（添加边）==========</span>
    <span class="hljs-comment">// 为什么需要边？</span>
    <span class="hljs-comment">// - 边定义了节点间的依赖关系和执行顺序</span>
    <span class="hljs-comment">// - LangGraph4j会根据边自动调度执行</span>
    Map&lt;String, Task.TaskInputs&gt; inputMap = taskPlan.getTasks().stream()
        .collect(Collectors.toMap(Task::getId, Task::getInputs));
    
    Set&lt;String&gt; allTargets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Task.TaskInputs&gt; entry : inputMap.entrySet()) {
        <span class="hljs-type">String</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> entry.getKey();
        Task.<span class="hljs-type">TaskInputs</span> <span class="hljs-variable">inputs</span> <span class="hljs-operator">=</span> entry.getValue();
        
        <span class="hljs-comment">// 如果任务有前置依赖，添加边</span>
        <span class="hljs-keyword">if</span> (inputs != <span class="hljs-literal">null</span> &amp;&amp; inputs.getFromTask() != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (String fromTask : inputs.getFromTask()) {
                <span class="hljs-comment">// 添加边：fromTask → taskId</span>
                <span class="hljs-comment">// 这意味着taskId必须等待fromTask完成后才能执行</span>
                graph.addEdge(fromTask, taskId);
                allTargets.add(taskId);  <span class="hljs-comment">// 记录有前置依赖的节点</span>
            }
        }
    }
    
    <span class="hljs-comment">// ========== 第四步：连接START和END ==========</span>
    <span class="hljs-comment">// 为什么需要START和END？</span>
    <span class="hljs-comment">// - START是图的入口，END是图的出口</span>
    <span class="hljs-comment">// - LangGraph4j需要知道从哪里开始，到哪里结束</span>
    
    <span class="hljs-comment">// 找到根节点（无前置依赖的节点）</span>
    Set&lt;String&gt; allNodes = inputMap.keySet();
    List&lt;String&gt; rootNodes = allNodes.stream()
        .filter(node -&gt; !allTargets.contains(node))  <span class="hljs-comment">// 不在allTargets中的节点就是根节点</span>
        .toList();
    
    <span class="hljs-comment">// 为什么可能有多个根节点？</span>
    <span class="hljs-comment">// - 多个独立的任务可以同时开始</span>
    <span class="hljs-comment">// - 例如：任务A和任务B都只依赖用户输入，可以并行执行</span>
    <span class="hljs-keyword">if</span> (rootNodes.isEmpty()) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GraphStateException</span>(<span class="hljs-string">"任务图中没有找到入口任务"</span>);
    }
    
    <span class="hljs-comment">// 连接START到所有根节点</span>
    <span class="hljs-keyword">for</span> (String root : rootNodes) {
        graph.addEdge(StateGraph.START, root);
    }
    
    <span class="hljs-comment">// 找到叶子节点（无后续节点的节点）</span>
    Set&lt;String&gt; nodesWithTargets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (Task task : taskPlan.getTasks()) {
        <span class="hljs-keyword">if</span> (task.getInputs() != <span class="hljs-literal">null</span> &amp;&amp; task.getInputs().getFromTask() != <span class="hljs-literal">null</span>) {
            nodesWithTargets.addAll(task.getInputs().getFromTask());
        }
    }
    
    List&lt;String&gt; leafNodes = allNodes.stream()
        .filter(node -&gt; !nodesWithTargets.contains(node))
        .toList();
    
    <span class="hljs-comment">// 连接所有叶子节点到END</span>
    <span class="hljs-keyword">for</span> (String leaf : leafNodes) {
        graph.addEdge(leaf, StateGraph.END);
    }
    
    <span class="hljs-comment">// ========== 第五步：编译图 ==========</span>
    <span class="hljs-comment">// 为什么需要编译？</span>
    <span class="hljs-comment">// - 编译会优化图结构，检查错误</span>
    <span class="hljs-comment">// - 编译后的图才能执行</span>
    <span class="hljs-keyword">return</span> graph.compile();
}
</code></pre>
<h4 data-id="heading-16">4.3 执行图示例</h4>
<p>假设Supervisor生成了以下计划：</p>
<ul>
<li>Task1（Researcher）：检索资料，依赖用户输入</li>
<li>Task2（Analyst）：分析数据，依赖Task1</li>
<li>Task3（Writer）：写报告，依赖Task2</li>
</ul>
<p>构建的图结构：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> → Task1 → Task2 → Task3 → <span class="hljs-keyword">END</span>
</code></pre>
<p>如果Task1和Task4都只依赖用户输入：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> → Task1 ─┐
      → Task4 ─┼→ Task5 → <span class="hljs-keyword">END</span>
</code></pre>
<p>这样Task1和Task4可以并行执行。</p>
<hr/>
<h3 data-id="heading-17">五、如何执行任务？</h3>
<h4 data-id="heading-18">5.1 为什么需要TaskExecutor？</h4>
<p>不同的任务有不同的执行需求：</p>
<ul>
<li><strong>静默任务</strong>：后台处理，结果只保存到state，不向用户输出</li>
<li><strong>流式任务</strong>：实时向用户输出，提供更好的交互体验</li>
</ul>
<h4 data-id="heading-19">5.2 如何实现：执行器模式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 执行器接口：为什么需要接口？</span>
<span class="hljs-comment">// - 统一执行规范</span>
<span class="hljs-comment">// - 支持多种实现（静默/流式）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TaskExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NodeAction</span>&lt;WorkspaceState&gt; {
    Task <span class="hljs-title function_">getTask</span><span class="hljs-params">()</span>;
    ServiceNode <span class="hljs-title function_">getServiceNode</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">// 工厂方法：为什么用工厂模式？</span>
<span class="hljs-comment">// - 根据策略动态创建执行器</span>
<span class="hljs-comment">// - 隐藏创建细节</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskExecutor <span class="hljs-title function_">create</span><span class="hljs-params">(Task task, ServiceNode serviceNode, UserContext userContext)</span> {
    <span class="hljs-type">ExecutionStrategy</span> <span class="hljs-variable">strategy</span> <span class="hljs-operator">=</span> task.getExecutionStrategy();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span> (strategy) {
        <span class="hljs-keyword">case</span> SILENT -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">SilentExecutor</span>(task, serviceNode, userContext);
        <span class="hljs-keyword">case</span> STREAMING -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamingExecutor</span>(task, serviceNode, userContext);
        <span class="hljs-keyword">default</span> -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">SilentExecutor</span>(task, serviceNode, userContext);
    };
}
</code></pre>
<h4 data-id="heading-20">5.3 SilentExecutor实现详解</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SilentExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTaskExecutor</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">apply</span><span class="hljs-params">(WorkspaceState state)</span> {
        <span class="hljs-comment">// 1. 发送任务开始事件：为什么需要？</span>
        <span class="hljs-comment">// - 让用户知道任务进度</span>
        <span class="hljs-comment">// - 提供可观测性</span>
        userContext.emit(TaskStatusEvent.builder()
            .type(EventType.TASK_START)
            .taskId(task.getId())
            .build());
        
        <span class="hljs-comment">// 2. 获取任务输入：为什么需要？</span>
        <span class="hljs-comment">// - 从state中获取用户输入和依赖任务的结果</span>
        <span class="hljs-comment">// - 组装成完整的输入数据</span>
        Map&lt;String, Object&gt; taskInput = getTaskInput(state);
        
        <span class="hljs-comment">// 3. 调用AI服务：为什么用流式调用？</span>
        <span class="hljs-comment">// - 即使不向用户输出，流式调用也能提供更好的错误处理</span>
        <span class="hljs-comment">// - 可以实时监控AI响应</span>
        <span class="hljs-type">TokenStream</span> <span class="hljs-variable">tokenStream</span> <span class="hljs-operator">=</span> aiService.chat(Json.toJson(taskInput));
        
        <span class="hljs-comment">// 4. 等待完成并收集结果</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">resultBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);
        
        tokenStream.onCompleteResponse(e -&gt; {
            resultBuilder.append(e.aiMessage().text());
            latch.countDown();
        });
        tokenStream.start();
        latch.await();
        
        <span class="hljs-comment">// 5. 保存结果到state：为什么需要？</span>
        <span class="hljs-comment">// - 后续任务可以从state中获取这个结果</span>
        <span class="hljs-comment">// - 实现任务间的数据传递</span>
        Map&lt;String, Object&gt; stateUpdate = saveTaskResult(state, resultBuilder.toString());
        
        <span class="hljs-comment">// 6. 发送完成事件</span>
        userContext.emit(TaskStatusEvent.builder()
            .type(EventType.TASK_COMPLETE)
            .taskId(task.getId())
            .build());
        
        <span class="hljs-keyword">return</span> stateUpdate;  <span class="hljs-comment">// 返回更新后的状态</span>
    }
}
</code></pre>
<h4 data-id="heading-21">5.4 状态传递机制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在BaseTaskExecutor中</span>
<span class="hljs-keyword">protected</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getTaskInput</span><span class="hljs-params">(WorkspaceState state)</span> {
    Map&lt;String, Object&gt; taskInput = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-comment">// 1. 获取用户输入：为什么需要？</span>
    <span class="hljs-comment">// - 某些任务需要直接使用用户输入</span>
    Optional&lt;String&gt; userMessage = state.userMessage();
    <span class="hljs-keyword">if</span> (userMessage.isPresent()) {
        taskInput.put(<span class="hljs-string">"userMessage"</span>, userMessage.get());
    }
    
    <span class="hljs-comment">// 2. 获取依赖任务的输出：为什么需要？</span>
    <span class="hljs-comment">// - 任务可能依赖其他任务的结果</span>
    <span class="hljs-comment">// - 通过taskId从state中获取</span>
    <span class="hljs-type">TaskInputs</span> <span class="hljs-variable">inputs</span> <span class="hljs-operator">=</span> task.getInputs();
    <span class="hljs-keyword">if</span> (inputs != <span class="hljs-literal">null</span> &amp;&amp; inputs.getFromTask() != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (String fromTaskId : inputs.getFromTask()) {
            Optional&lt;Map&lt;String, Object&gt;&gt; fromTaskResult = state.value(fromTaskId);
            <span class="hljs-keyword">if</span> (fromTaskResult.isPresent()) {
                <span class="hljs-comment">// 将依赖任务的结果添加到输入中</span>
                taskInput.put(fromTaskId, fromTaskResult.get());
            }
        }
    }
    
    <span class="hljs-keyword">return</span> taskInput;
}

<span class="hljs-comment">// 保存任务结果：为什么需要？</span>
<span class="hljs-comment">// - 后续任务可以通过taskId获取这个结果</span>
<span class="hljs-comment">// - 实现任务间的数据传递</span>
<span class="hljs-keyword">protected</span> Map&lt;String, Object&gt; <span class="hljs-title function_">saveTaskResult</span><span class="hljs-params">(WorkspaceState state, String result)</span> {
    Map&lt;String, Object&gt; stateUpdate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-comment">// 以taskId为key保存结果，这样依赖任务可以通过taskId获取</span>
    stateUpdate.put(task.getId(), result);
    <span class="hljs-keyword">return</span> stateUpdate;
}
</code></pre>
<hr/>
<h3 data-id="heading-22">六、完整执行流程</h3>
<h4 data-id="heading-23">6.1 用户请求到结果返回</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/execute")</span>
<span class="hljs-keyword">public</span> Flux&lt;TaskStatusEvent&gt; <span class="hljs-title function_">execute</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> TaskExecuteRequest request)</span> {
    <span class="hljs-comment">// 1. 构建Agent系统：为什么需要？</span>
    <span class="hljs-comment">// - 从数据库加载配置，初始化AI服务</span>
    <span class="hljs-comment">// - 构建Orchestrator实例</span>
    taskExecuteService.buildArmory(request.getOrchestratorId());
    
    <span class="hljs-comment">// 2. 获取Orchestrator：为什么需要？</span>
    <span class="hljs-comment">// - Orchestrator包含了Supervisor和Worker的配置</span>
    <span class="hljs-type">Orchestrator</span> <span class="hljs-variable">orchestrator</span> <span class="hljs-operator">=</span> taskExecuteService.getOrchestrator(request.getOrchestratorId());
    
    <span class="hljs-comment">// 3. 创建用户上下文：为什么需要？</span>
    <span class="hljs-comment">// - 管理SSE事件流</span>
    <span class="hljs-comment">// - 提供用户ID和会话ID用于记忆</span>
    <span class="hljs-type">UserContext</span> <span class="hljs-variable">userContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserContext</span>();
    userContext.setUserId(request.getUserId());
    userContext.setSessionId(request.getSessionId());
    
    <span class="hljs-comment">// 4. 启动事件分发器：为什么需要？</span>
    <span class="hljs-comment">// - 将任务执行过程中的事件推送给前端</span>
    <span class="hljs-comment">// - 实现实时反馈</span>
    userContext.startEventDispatcher(emitter);
    
    <span class="hljs-comment">// 5. 异步执行：为什么异步？</span>
    <span class="hljs-comment">// - 不阻塞HTTP请求线程</span>
    <span class="hljs-comment">// - 通过SSE流式返回结果</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        orchestrator.execute(request.getMessage(), userContext);
        userContext.complete();
    }).start();
    
    <span class="hljs-keyword">return</span> Flux.create(emitter -&gt; {
        <span class="hljs-comment">// SSE事件流</span>
    });
}
</code></pre>
<h4 data-id="heading-24">6.2 执行时序图</h4>
<pre><code class="hljs language-scss" lang="scss">用户请求
  ↓
Controller<span class="hljs-selector-class">.execute</span>()
  ↓
TaskExecuteService<span class="hljs-selector-class">.buildArmory</span>()  <span class="hljs-selector-attr">[构建Agent系统]</span>
  ↓
Orchestrator<span class="hljs-selector-class">.execute</span>()
  ├─→ <span class="hljs-built_in">plan</span>()                      <span class="hljs-selector-attr">[Supervisor生成计划]</span>
  │     ├─→ 构建提示词
  │     ├─→ 调用Supervisor AI
  │     └─→ 解析TaskPlan
  │
  ├─→ <span class="hljs-built_in">buildGraph</span>()                <span class="hljs-selector-attr">[构建执行图]</span>
  │     ├─→ 创建StateGraph
  │     ├─→ 添加节点（TaskExecutor）
  │     ├─→ 添加边（依赖关系）
  │     └─→ 编译图
  │
  └─→ graph<span class="hljs-selector-class">.invoke</span>()              <span class="hljs-selector-attr">[执行图]</span>
        ├─→ START → 根节点
        ├─→ 并行执行无依赖任务
        ├─→ 等待依赖完成
        ├─→ 执行后续任务
        └─→ 叶子节点 → END
</code></pre>
<hr/>
<h3 data-id="heading-25">七、设计要点总结</h3>
<h4 data-id="heading-26">7.1 为什么这样设计？</h4>
<ol>
<li><strong>状态图模式</strong>：用图结构表达复杂的执行流程，直观清晰</li>
<li><strong>Supervisor-Worker模式</strong>：职责分离，Supervisor规划，Worker执行</li>
<li><strong>异步执行</strong>：提高效率，支持并行执行无依赖任务</li>
<li><strong>状态管理</strong>：通过WorkspaceState统一管理数据，实现任务间传递</li>
<li><strong>事件驱动</strong>：通过事件系统提供可观测性</li>
</ol>
<h4 data-id="heading-27">7.2 关键实现技巧</h4>
<ol>
<li><strong>依赖解析</strong>：通过<code>fromTask</code>列表自动构建依赖关系</li>
<li><strong>根节点识别</strong>：找到无前置依赖的节点作为入口</li>
<li><strong>叶子节点识别</strong>：找到无后续节点的节点作为出口</li>
<li><strong>状态传递</strong>：以taskId为key保存结果，依赖任务通过taskId获取</li>
<li><strong>错误隔离</strong>：每个节点独立执行，失败不影响其他节点</li>
</ol>
<hr/>
<h3 data-id="heading-28">总结</h3>
<p>本文深入解析了基于LangGraph4j的多Agent编排系统，重点阐述了：</p>
<ol>
<li><strong>为什么选择LangGraph4j</strong>：解决任务依赖、并行执行、状态共享等核心问题</li>
<li><strong>为什么采用Supervisor-Worker模式</strong>：实现动态规划、职责分离、易于扩展</li>
<li><strong>如何实现任务规划</strong>：Supervisor分析需求，生成结构化的TaskPlan</li>
<li><strong>如何构建执行图</strong>：GraphBuilder将TaskPlan转换为可执行的StateGraph</li>
<li><strong>如何执行任务</strong>：TaskExecutor封装执行逻辑，支持静默和流式两种模式</li>
</ol>
<p>通过这种设计，我们实现了<strong>声明式的多Agent编排</strong>，让复杂的多Agent协作变得简单可控。</p>
<hr/>
<p><strong>关键代码位置</strong>：</p>
<ul>
<li><code>Orchestrator.java</code>: 编排器核心逻辑</li>
<li><code>GraphBuilder.java</code>: 图构建实现</li>
<li><code>TaskExecutor.java</code>: 任务执行器接口</li>
<li><code>WorkspaceState.java</code>: 状态管理</li>
<li><code>TaskExecuteController.java</code>: REST API入口</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 告别手写注释！Laravel 自定义命令创建模型时自动生成 @property 属性提示]]></title>    <link>https://juejin.cn/post/7576923573778268202</link>    <guid>https://juejin.cn/post/7576923573778268202</guid>    <pubDate>2025-11-27T03:01:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576923573778268202" data-draft-id="7576888607481020435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 告别手写注释！Laravel 自定义命令创建模型时自动生成 @property 属性提示"/> <meta itemprop="keywords" content="Laravel"/> <meta itemprop="datePublished" content="2025-11-27T03:01:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="依了个旧"/> <meta itemprop="url" content="https://juejin.cn/user/1385831726583448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 告别手写注释！Laravel 自定义命令创建模型时自动生成 @property 属性提示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1385831726583448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    依了个旧
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:01:28.000Z" title="Thu Nov 27 2025 03:01:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong></p>
<p>在 Laravel 开发中，Eloquent Model 是我们最常用的组件。通过 <code>php artisan make:model</code> 创建模型后，最头疼的往往是 IDE（如 PhpStorm 或 VSCode）无法识别数据库字段，导致没有代码提示。</p>
<p>虽然有 <code>laravel-ide-helper</code> 这样的神器，但每次新建模型后都要运行一遍 <code>ide-helper:models</code> 总感觉不够“丝滑”。</p>
<p><strong>如果能在执行 <code>make:model</code> 的那一瞬间，直接连接数据库，把表结构读取出来，自动生成 <code>@property</code> 注释，岂不美哉？</strong></p>
<p>今天就分享一个实战中的自定义 Command，实现“模型创建即自动拥有补全”。</p>
</blockquote>
<h2 data-id="heading-0">🤔 痛点分析</h2>
<p>通常我们创建一个 User 模型，生成的文件是空的：</p>
<p>PHP</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span></span>
{
    use <span class="hljs-type">HasFactory</span>;
}
</code></pre>
<p>我们在写代码时 <code>$user-&gt;...</code> 后面一片空白。为了有提示，我们需要手动去数据库看字段，然后写成这样：</p>
<p>PHP</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">/**
 * @property int $id
 * @property string $name
 * @property string $email
 * @property \Illuminate\Support\Carbon $created_at
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span> </span>{ ... }
</code></pre>
<p>这个过程繁琐且容易出错。下面的代码将把这个过程自动化。</p>
<h2 data-id="heading-1">💻 核心代码实现</h2>
<p>新建一个命令文件 <code>app/Console/Commands/MakeModelWithProperties.php</code> (类名可自定)，代码如下：</p>
<p>PHP</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Console</span>\<span class="hljs-title class_">Commands</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">GeneratorCommand</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Filesystem</span>\<span class="hljs-title">FileNotFoundException</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">DB</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Schema</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Str</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Console</span>\<span class="hljs-title">Input</span>\<span class="hljs-title">InputOption</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MakeModelWithProperties</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GeneratorCommand</span>
</span>{
    <span class="hljs-comment">// 覆盖原生命令，或者取个别名如 make:model:plus</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">'make:model'</span>; 
    
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$description</span> = <span class="hljs-string">'创建包含 @property 注释的 Eloquent 模型类'</span>;
    
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$type</span> = <span class="hljs-string">'Model'</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-comment">// 1. 处理数据库连接</span>
        <span class="hljs-variable">$conn</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">normalizeConnectionOption</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">option</span>(<span class="hljs-string">'connection'</span>));
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$conn</span>) {
            <span class="hljs-variable">$conn</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">promptForConnection</span>();
        }
        <span class="hljs-variable language_">$this</span>-&gt;input-&gt;<span class="hljs-title function_ invoke__">setOption</span>(<span class="hljs-string">'connection'</span>, <span class="hljs-variable">$conn</span>);

        <span class="hljs-comment">// 2. 调用父类逻辑生成文件</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">parent</span>::<span class="hljs-title function_ invoke__">handle</span>() === <span class="hljs-literal">false</span> &amp;&amp; !<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">option</span>(<span class="hljs-string">'force'</span>)) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 3. 处理可选参数 (Migration, Factory 等)</span>
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">handleOptionalGenerators</span>();
    }

    <span class="hljs-comment">/**
     * 核心逻辑：在构建类时注入注释
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildClass</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)
    </span>{
        <span class="hljs-variable">$stub</span> = <span class="hljs-built_in">parent</span>::<span class="hljs-title function_ invoke__">buildClass</span>(<span class="hljs-variable">$name</span>);

        <span class="hljs-variable">$table</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">inferTableName</span>(<span class="hljs-variable">$name</span>);
        <span class="hljs-variable">$connection</span> = (<span class="hljs-keyword">string</span>)<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">option</span>(<span class="hljs-string">'connection'</span>);
        
        <span class="hljs-comment">// 生成 PHPDoc</span>
        <span class="hljs-variable">$propertiesDoc</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">generatePropertiesDoc</span>(<span class="hljs-variable">$table</span>, <span class="hljs-variable">$connection</span>);

        <span class="hljs-comment">// 替换 Stub 中的占位符，或者通过正则插入到 class 定义之前</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Str</span>::<span class="hljs-title function_ invoke__">contains</span>(<span class="hljs-variable">$stub</span>, <span class="hljs-string">'{{ propertiesDoc }}'</span>)) {
            <span class="hljs-variable">$stub</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'{{ propertiesDoc }}'</span>, <span class="hljs-variable">$propertiesDoc</span>, <span class="hljs-variable">$stub</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 默认 stub 没有占位符，使用正则强插</span>
            <span class="hljs-variable">$stub</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">'/(\n\s*class\s+[^\s]+\s+extends)/'</span>, <span class="hljs-string">"\n/**\n<span class="hljs-subst">{$propertiesDoc}</span>\n */<span class="hljs-subst">$1</span>"</span>, <span class="hljs-variable">$stub</span>, <span class="hljs-number">1</span>);
        }

        <span class="hljs-comment">// 自动注入表名和主键</span>
        <span class="hljs-variable">$primaryKey</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getPrimaryKeyColumn</span>(<span class="hljs-variable">$table</span>, <span class="hljs-variable">$connection</span>) ?? <span class="hljs-string">'id'</span>;
        <span class="hljs-comment">// ... (此处省略部分替换逻辑，视具体 Stub 而定)</span>

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$stub</span>;
    }

    <span class="hljs-comment">/**
     * 生成属性注释文档
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generatePropertiesDoc</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$table</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$connection</span></span>)
    </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-variable">$schema</span> = <span class="hljs-title class_">Schema</span>::<span class="hljs-title function_ invoke__">connection</span>(<span class="hljs-variable">$connection</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$schema</span>-&gt;<span class="hljs-title function_ invoke__">hasTable</span>(<span class="hljs-variable">$table</span>)) {
                <span class="hljs-variable">$columns</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getColumnsMeta</span>(<span class="hljs-variable">$table</span>, <span class="hljs-variable">$connection</span>);
                
                <span class="hljs-comment">// 获取表注释</span>
                <span class="hljs-variable">$prefix</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">"database.connections.<span class="hljs-subst">$connection</span>.prefix"</span>) ?? <span class="hljs-string">''</span>;
                <span class="hljs-variable">$tableStatus</span> = DB::<span class="hljs-title function_ invoke__">connection</span>(<span class="hljs-variable">$connection</span>)-&gt;<span class="hljs-title function_ invoke__">select</span>(<span class="hljs-string">"SHOW TABLE STATUS WHERE NAME = ?"</span>, [<span class="hljs-variable">$prefix</span> . <span class="hljs-variable">$table</span>]);
                <span class="hljs-variable">$tableComment</span> = <span class="hljs-variable">$tableStatus</span>[<span class="hljs-number">0</span>]-&gt;Comment ?? <span class="hljs-string">''</span>;

                <span class="hljs-variable">$lines</span> = [];
                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$tableComment</span>) <span class="hljs-variable">$lines</span>[] = <span class="hljs-string">' * '</span> . <span class="hljs-variable">$tableComment</span>;
                
                <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$columns</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$col</span>) {
                    <span class="hljs-variable">$phpType</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">mapDbTypeToPhpType</span>(<span class="hljs-variable">$col</span>[<span class="hljs-string">'type'</span>], <span class="hljs-variable">$col</span>[<span class="hljs-string">'name'</span>]);
                    <span class="hljs-variable">$nullable</span> = <span class="hljs-variable">$col</span>[<span class="hljs-string">'nullable'</span>] ? <span class="hljs-string">'|null'</span> : <span class="hljs-string">''</span>;
                    <span class="hljs-variable">$comment</span> = <span class="hljs-variable">$col</span>[<span class="hljs-string">'comment'</span>] ? <span class="hljs-string">' '</span> . <span class="hljs-variable">$col</span>[<span class="hljs-string">'comment'</span>] : <span class="hljs-string">''</span>;
                    <span class="hljs-variable">$lines</span>[] = <span class="hljs-string">" * @property <span class="hljs-subst">{$phpType}</span><span class="hljs-subst">{$nullable}</span> $<span class="hljs-subst">{$col['name']}</span><span class="hljs-subst">{$comment}</span>"</span>;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">"\n"</span>, <span class="hljs-variable">$lines</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">' *'</span>;
        } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">warn</span>(<span class="hljs-string">'获取表信息失败: '</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());
            <span class="hljs-keyword">return</span> <span class="hljs-string">' *'</span>;
        }
    }

    <span class="hljs-comment">/**
     * 获取列元数据 (直接查询 information_schema 以获取更详细信息)
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getColumnsMeta</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$table</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$connection</span></span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-variable">$conn</span> = DB::<span class="hljs-title function_ invoke__">connection</span>(<span class="hljs-variable">$connection</span>);
        <span class="hljs-variable">$prefix</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">"database.connections.<span class="hljs-subst">$connection</span>.prefix"</span>) ?? <span class="hljs-string">''</span>;

        <span class="hljs-variable">$rows</span> = <span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">select</span>(
            <span class="hljs-string">'select COLUMN_NAME as name, DATA_TYPE as type, IS_NULLABLE as nullable, COLUMN_COMMENT as comment 
             from information_schema.columns 
             where table_schema = database() and table_name = ? order by ORDINAL_POSITION'</span>,
            [<span class="hljs-variable">$prefix</span> . <span class="hljs-variable">$table</span>]
        );

        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">array_map</span>(function (<span class="hljs-variable">$r</span>) {
            <span class="hljs-keyword">return</span> [
                <span class="hljs-string">'name'</span>     =&gt; <span class="hljs-variable">$r</span>-&gt;name,
                <span class="hljs-string">'type'</span>     =&gt; <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$r</span>-&gt;type),
                <span class="hljs-string">'nullable'</span> =&gt; <span class="hljs-title function_ invoke__">strtoupper</span>(<span class="hljs-variable">$r</span>-&gt;nullable ?? <span class="hljs-string">'YES'</span>) === <span class="hljs-string">'YES'</span>,
                <span class="hljs-string">'comment'</span>  =&gt; <span class="hljs-variable">$r</span>-&gt;comment ?? <span class="hljs-string">''</span>,
            ];
        }, <span class="hljs-variable">$rows</span>);
    }

    <span class="hljs-comment">/**
     * 数据库类型映射到 PHP 类型
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mapDbTypeToPhpType</span>(<span class="hljs-params">?<span class="hljs-keyword">string</span> <span class="hljs-variable">$dbType</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$column</span></span>): <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$column</span>, [<span class="hljs-string">'created_at'</span>, <span class="hljs-string">'updated_at'</span>, <span class="hljs-string">'deleted_at'</span>])) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'\Illuminate\Support\Carbon'</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">match</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-title function_ invoke__">str_contains</span>(<span class="hljs-variable">$dbType</span>, <span class="hljs-string">'int'</span>) =&gt; <span class="hljs-string">'int'</span>,
            <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$dbType</span>, [<span class="hljs-string">'decimal'</span>, <span class="hljs-string">'float'</span>, <span class="hljs-string">'double'</span>]) =&gt; <span class="hljs-string">'float'</span>,
            <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$dbType</span>, [<span class="hljs-string">'json'</span>]) =&gt; <span class="hljs-string">'array'</span>,
            <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$dbType</span>, [<span class="hljs-string">'date'</span>, <span class="hljs-string">'datetime'</span>, <span class="hljs-string">'timestamp'</span>]) =&gt; <span class="hljs-string">'\Illuminate\Support\Carbon'</span>,
            <span class="hljs-keyword">default</span> =&gt; <span class="hljs-string">'string'</span>,
        };
    }

    <span class="hljs-comment">// ... 其他辅助函数如 inferTableName, promptForConnection 等请参考完整源码</span>
    
    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStub</span>(<span class="hljs-params"/>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resolveStubPath</span>(<span class="hljs-string">'/stubs/model.stub'</span>);
    }
}
</code></pre>
<h2 data-id="heading-2">🎯 效果演示</h2>
<p>假设我们有一个 <code>users</code> 表，结构如下：</p>
<ul>
<li><code>id</code>: bigint (PK)</li>
<li><code>username</code>: varchar, comment '用户名'</li>
<li><code>is_active</code>: tinyint</li>
<li><code>created_at</code>: timestamp</li>
</ul>
<p>在命令行执行：</p>
<p>Bash</p>
<pre><code class="hljs language-ini" lang="ini">php artisan make:model User <span class="hljs-attr">--connection</span>=mysql
</code></pre>
<p>生成的代码将自动变为：</p>
<p>PHP</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Models</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;

<span class="hljs-comment">/**
 * 用户表
 * <span class="hljs-doctag">@property</span> int $id
 * <span class="hljs-doctag">@property</span> string $username 用户名
 * <span class="hljs-doctag">@property</span> int $is_active
 * <span class="hljs-doctag">@property</span> \Illuminate\Support\Carbon|null $created_at
 * <span class="hljs-doctag">@property</span> \Illuminate\Support\Carbon|null $updated_at
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span>
</span>{
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>现在，你在 Controller 里输入 <code>$user-&gt;</code>，IDE 立刻就会列出 <code>username</code> 和 <code>is_active</code>，开发效率瞬间提升！</p>
<h2 data-id="heading-3">💡 实现细节解析</h2>
<ol>
<li>
<p>正则替换 vs Stub 占位符：</p>
<p>Laravel 默认的 model.stub 并没有 {{ propertiesDoc }} 占位符。代码中做了一个兼容处理：</p>
<ul>
<li>如果你发布了 stubs (<code>php artisan stub:publish</code>) 并在里面加了占位符，它会精准替换。</li>
<li>如果没有，它会用正则 <code>preg_replace</code> 强行把注释插入到 <code>class Xxx extends</code> 的上方。</li>
</ul>
</li>
<li>
<p>多态与Pivot支持：</p>
<p>代码中保留了对 --pivot 和 --morph-pivot 的支持，确保生成中间表模型时也能正常工作。</p>
</li>
</ol>
<h2 data-id="heading-4">📦 如何在你的项目中使用</h2>
<ol>
<li>在 <code>app/Console/Commands</code> 下新建 <code>MakeModelCommand.php</code>。</li>
<li>将上述代码（及必要的 import）粘贴进去。</li>
<li>在 <code>app/Console/Kernel.php</code> 中注册（Laravel 11 可忽略，会自动发现）。</li>
<li>确保你的数据库已经建好表（因为它是<strong>Database First</strong>逻辑，先有表，后生成带注释的模型）。</li>
</ol>
<hr/>
<p><em>Happy Coding!</em> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[单机压测从百到三千：一次短链跳转服务的全链路性能优化实战]]></title>    <link>https://juejin.cn/post/7576923573778382890</link>    <guid>https://juejin.cn/post/7576923573778382890</guid>    <pubDate>2025-11-27T03:13:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576923573778382890" data-draft-id="7574916588719210538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="单机压测从百到三千：一次短链跳转服务的全链路性能优化实战"/> <meta itemprop="keywords" content="后端,性能优化"/> <meta itemprop="datePublished" content="2025-11-27T03:13:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="虎子_layor"/> <meta itemprop="url" content="https://juejin.cn/user/1109832819826707"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            单机压测从百到三千：一次短链跳转服务的全链路性能优化实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1109832819826707/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    虎子_layor
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:13:32.000Z" title="Thu Nov 27 2025 03:13:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">一、项目背景与初始问题</h5>
<p>本项目的核心功能是提供短链跳转服务。除了基本的跳转，还需要精确记录每一次点击事件，包括来源、设备、IP 等信息。</p>
<ul>
<li><strong>部署架构</strong>: 项目前后端在本地运行，Redis 部署在远程云服务器，MySQL 在本地。</li>
<li><strong>性能痛点</strong>: 初始设计中，每次跳转 (<code>302 Redirect</code>) 都会同步执行两次数据库写操作（增加当日点击数和总点击数），导致严重的性能瓶颈。</li>
<li><strong>技术考量</strong>: 之所以未使用 Docker，是因为在当时的环境下，容器网络带来的额外开销（特别是访问远端 Redis 的 58ms RTT）被认为是不可接受的。</li>
</ul>
<ol>
<li>初始同步写操作</li>
</ol>
<pre><code class="hljs language-Java" lang="Java">    <span class="hljs-meta">@Async</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordClick</span><span class="hljs-params">(String shortCode)</span> {
        <span class="hljs-comment">//当日点击数</span>
       dailyClickRepo.incrementClick(shortCode);
        <span class="hljs-comment">//总数增加一次</span>
        shortUrlRepository.incrementClickCount(shortCode);
    }
</code></pre>
<p>2.记录点击事件，解析用户信息</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordClickEvent</span><span class="hljs-params">(String shortCode, HttpServletRequest request)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">referer</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Referer"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">ua</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"User-Agent"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> extractIp(request);
    <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> extractHost(referer);
    <span class="hljs-type">String</span> <span class="hljs-variable">device</span> <span class="hljs-operator">=</span> detectDevice(ua);
    clickRecorderService.recordClickEvent(shortCode, referer, ua, ip, host, device);
}
</code></pre>
<h3 data-id="heading-1">二、压测对比</h3>
<p><strong>1.注释两次写操作</strong></p>
<p>压测结果显示：</p>
<ul>
<li><strong>吞吐量 (RPS)</strong> : 稳定且高。</li>
<li><strong>延迟 (http_req_duration)</strong> : P95 约 3.07ms，平均约 1.15ms。</li>
<li><strong>错误率</strong>: 几乎为 0。</li>
<li><strong>结论</strong>: 无写操作时，跳转接口性能极佳，瓶颈明确指向写操作。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9499e53a0bc43f5875e8ebb3ead6ad2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JmO5a2QX2xheW9y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818011&amp;x-signature=GtBP64zFi038u79xFEza1smf78M%3D" alt="图片.png" loading="lazy"/></p>
<p><strong>2.启用同步写操作</strong></p>
<p>压测结果显示：</p>
<ul>
<li><strong>吞吐量 (RPS)</strong> : 明显下降。</li>
<li><strong>延迟 (http_req_duration)</strong> : P95 飙升至约 1956ms，最大延迟达 7181ms。TTFB (Time To First Byte) P95 也达到了约 3 秒。</li>
<li><strong>错误率</strong>: 仍接近 0，说明功能正确，但性能严重受损。</li>
<li><strong>结论</strong>: 同步写操作成为性能瓶颈。频繁的远程 Redis 写入和本地 MySQL 更新，在热点路径上造成显著的“写放大”效应和资源争用（如连接池、磁盘 IO），拖慢了整个响应过程。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/272a9fbeda9e458cbd9d32014d3272b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JmO5a2QX2xheW9y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818011&amp;x-signature=pkmhWfp%2FIZZ7SAUjqdkkhWhY9Zc%3D" alt="图片.png" loading="lazy"/></li>
</ul>
<h3 data-id="heading-2">三、优化</h3>
<p>针对上述问题，我们采取了循序渐进的优化措施。</p>
<h6 data-id="heading-3"><strong>第一阶段：异步解耦写操作</strong></h6>
<p><strong>问题</strong>: 主流程被同步写操作阻塞。 <strong>优化</strong>: 利用 Spring 的 <code>@Async</code> 注解，将写操作移出主线程。 <strong>实现</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化前：同步写入（阻塞）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordClick</span><span class="hljs-params">(String shortCode)</span> {
    dailyClickRepo.incrementClick(shortCode);
    shortUrlRepository.incrementClickCount(shortCode);
}

<span class="hljs-comment">// 优化后：异步写入（不阻塞）</span>
<span class="hljs-meta">@Async</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordClick</span><span class="hljs-params">(String shortCode)</span> {
    dailyClickRepo.incrementClick(shortCode);
    shortUrlRepository.incrementClickCount(shortCode);
}
</code></pre>
<p>配置线程池：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-meta">@EnableScheduling</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TinyFlowApplication</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">taskExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">32</span>);    <span class="hljs-comment">// 默认很小，扩容</span>
        executor.setMaxPoolSize(<span class="hljs-number">128</span>);
        executor.setQueueCapacity(<span class="hljs-number">20000</span>);
        executor.setThreadNamePrefix(<span class="hljs-string">"async-"</span>);
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}
</code></pre>
<p><strong>效果</strong>: 主流程立即返回，用户感知延迟大幅降低。但数据库写压力依然存在。</p>
<h6 data-id="heading-4"><strong>第二阶段：Redis 原子计数</strong></h6>
<p><strong>问题</strong>: 数据库写入频率过高。 <strong>优化</strong>: 将计数操作下沉到高性能的 Redis，利用其原子自增指令。 <strong>实现</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 Redis 原子计数</span>
<span class="hljs-meta">@Async</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordClick</span><span class="hljs-params">(String shortCode)</span> {
    <span class="hljs-comment">// Redis 原子自增</span>
    redisTemplate.opsForValue().increment(<span class="hljs-string">"click:daily:"</span> + shortCode, <span class="hljs-number">1</span>);
    redisTemplate.opsForValue().increment(<span class="hljs-string">"click:total:"</span> + shortCode, <span class="hljs-number">1</span>);
}
</code></pre>
<p><strong>效果：</strong>  数据库写入频率大幅降低，Redis 承担计数压力</p>
<hr/>
<h6 data-id="heading-5"><strong>第三阶段：内存缓冲与定时批量刷库</strong></h6>
<p><strong>问题</strong>: Redis 写入虽快，但仍需最终持久化到数据库。</p>
<p><strong>优化</strong>: 在应用内存中累积计数变更，通过定时任务批量更新数据库。</p>
<p><strong>实现</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShortUrlService</span> {
    <span class="hljs-comment">// 内存累加器（原子计数）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;String, AtomicLong&gt; clickBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-comment">// 异步写入（不阻塞主流程）</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordClick</span><span class="hljs-params">(String shortCode)</span> {
        clickBuffer.computeIfAbsent(shortCode, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>)).incrementAndGet();
    }
    
    <span class="hljs-comment">// 定时批量刷库（每2秒）</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 2000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flushClicksToDB</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (clickBuffer.isEmpty()) <span class="hljs-keyword">return</span>;
        
        <span class="hljs-comment">// 快照并重置计数器（避免并发问题）</span>
        Map&lt;String, Long&gt; snapshot = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        clickBuffer.forEach((code, count) -&gt; {
            <span class="hljs-type">long</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> count.getAndSet(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 原子读取并重置</span>
            <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">0</span>) snapshot.put(code, value);
        });
        
        <span class="hljs-comment">// 批量更新数据库（减少连接消耗）</span>
        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Long&gt; entry : snapshot.entrySet()) {
            dailyClickRepo.incrementClick(entry.getKey(), entry.getValue());
            shortUrlRepository.incrementClickCount(entry.getKey(), entry.getValue());
        }
    }
}
</code></pre>
<p><strong>效果：</strong>  数据库写入从"每次请求"变为"每2秒批量"，效率大幅提升</p>
<hr/>
<h6 data-id="heading-6"><strong>第四阶段：引入本地缓存 (Caffeine)</strong></h6>
<p><strong>问题</strong>: 查询长链时，即便使用了 Redis，跨公网访问仍有 10ms 级别的延迟。</p>
<p><strong>优化</strong>: 在应用本地引入高性能缓存 Caffeine，构建 L1 (本地) + L2 (Redis) + L3 (DB) 三级缓存体系。</p>
<p><strong>实现</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简单 HashMap 缓存</span>
<span class="hljs-keyword">private</span> Map&lt;String, String&gt; localCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLongUrlByShortCode</span><span class="hljs-params">(String shortCode)</span> {
    <span class="hljs-comment">// L1: 本地 HashMap 缓存</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">cachedUrl</span> <span class="hljs-operator">=</span> localCache.get(shortCode);
    <span class="hljs-keyword">if</span> (cachedUrl != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> cachedUrl;
    
    <span class="hljs-comment">// L2: Redis 缓存</span>
    <span class="hljs-comment">// L3: 数据库</span>
}
</code></pre>
<p><strong>效果：</strong>  本地缓存命中后响应时间从 10ms级降至毫秒级</p>
<hr/>
<h6 data-id="heading-7"><strong>第五阶段：连接池优化 + 缓存预热</strong></h6>
<p><strong>问题</strong>: 高并发下可能出现连接池耗尽，冷启动时缓存未命中导致延迟尖刺。 <strong>优化</strong>:</p>
<ol>
<li><strong>扩大连接池</strong>: 增加数据库和 Redis 连接池的最大连接数。</li>
<li><strong>缓存预热</strong>: 应用启动时主动加载热点数据到 L1 缓存。</li>
</ol>
<p><strong>实现</strong>:</p>
<ol>
<li>扩大连接池配置</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 连接池优化</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>  
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">redis:</span>
      <span class="hljs-attr">lettuce:</span>
        <span class="hljs-attr">pool:</span>
          <span class="hljs-attr">max-active:</span> <span class="hljs-number">400</span>  
          
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">tomcat:</span>
    <span class="hljs-attr">threads:</span>
      <span class="hljs-attr">max:</span> <span class="hljs-number">400</span>            
</code></pre>
<ol start="2">
<li>实现缓存预热机制</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShortUrlService</span> {
    <span class="hljs-meta">@Value("${cache.warmup.enabled:true}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> warmupEnabled;
    
    <span class="hljs-meta">@Value("${cache.warmup.size:1000}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> warmupSize;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmupCache</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (!warmupEnabled) <span class="hljs-keyword">return</span>;
        
        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"Starting cache warmup, loading top {} hot URLs..."</span>, warmupSize);
            <span class="hljs-type">Pageable</span> <span class="hljs-variable">topN</span> <span class="hljs-operator">=</span> PageRequest.of(<span class="hljs-number">0</span>, warmupSize);
            Page&lt;ShortUrl&gt; hotUrls = shortUrlRepository.findAll(topN);
            
            <span class="hljs-type">int</span> <span class="hljs-variable">loaded</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (ShortUrl url : hotUrls.getContent()) {
                localCache.put(url.getShortCode(), url.getLongUrl());
                loaded++;
            }
            
            log.info(<span class="hljs-string">"Cache warmup completed: {} URLs loaded to L1 cache"</span>, loaded);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Cache warmup failed: {}"</span>, e.getMessage(), e);
        }
    }
}
</code></pre>
<p><strong>效果：</strong>  系统稳定性提升，冷启动不再慢</p>
<hr/>
<h4 data-id="heading-8">第六阶段：本地缓存升级为 Caffeine</h4>
<p><strong>问题：</strong>  HashMap 无淘汰策略，可能内存溢出</p>
<p><strong>优化：</strong>  使用 Caffeine 替代 HashMap</p>
<p><strong>实现</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CacheConfig.java</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheConfig</span> {
    <span class="hljs-meta">@Bean("localUrlCache")</span>
    <span class="hljs-keyword">public</span> Cache&lt;String, String&gt; <span class="hljs-title function_">localUrlCache</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Caffeine.newBuilder()
            .maximumSize(<span class="hljs-number">10000</span>)
            .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
            .build();
    }
}

<span class="hljs-comment">// ShortUrlService.java</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShortUrlService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-meta">@Qualifier("localUrlCache")</span>
    <span class="hljs-keyword">private</span> Cache&lt;String, String&gt; localCache;
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLongUrlByShortCode</span><span class="hljs-params">(String shortCode)</span> {
        <span class="hljs-comment">// L1: 本地缓存（毫秒级响应）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">cachedUrl</span> <span class="hljs-operator">=</span> localCache.getIfPresent(shortCode);
        <span class="hljs-keyword">if</span> (cachedUrl != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> cachedUrl;
        
        <span class="hljs-comment">// L2: Redis 缓存（网络延迟）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">redisUrl</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">"short_url:"</span> + shortCode);
        <span class="hljs-keyword">if</span> (redisUrl != <span class="hljs-literal">null</span>) {
            localCache.put(shortCode, redisUrl);
            <span class="hljs-keyword">return</span> redisUrl;
        }
        
        <span class="hljs-comment">// L3: 数据库（最慢）</span>
        <span class="hljs-type">ShortUrl</span> <span class="hljs-variable">shortUrl</span> <span class="hljs-operator">=</span> shortUrlRepository.findByShortCode(shortCode);
        <span class="hljs-keyword">if</span> (shortUrl != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">String</span> <span class="hljs-variable">longUrl</span> <span class="hljs-operator">=</span> shortUrl.getLongUrl();
            redisTemplate.opsForValue().set(<span class="hljs-string">"short_url:"</span> + shortCode, longUrl, Duration.ofHours(<span class="hljs-number">24</span>));
            localCache.put(shortCode, longUrl);
            <span class="hljs-keyword">return</span> longUrl;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}

</code></pre>
<p><strong>效果：</strong>  自动淘汰冷数据，支持统计信息，更专业的缓存管理</p>
<hr/>
<h4 data-id="heading-9">第七阶段：精细化调优</h4>
<p><strong>问题</strong>: 系统仍有优化空间，且需要防止突发流量打垮系统。 <strong>优化</strong>:</p>
<ol>
<li><strong>参数微调</strong>: 根据压测反馈，进一步精细调整连接池、线程池、Tomcat 线程数等参数。</li>
<li><strong>实施限流</strong>: 使用 Resilience4j 等组件，在入口处限制请求速率，保护下游服务。</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 精细化配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">100</span>  <span class="hljs-comment"># 50 → 100</span>
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">redis:</span>
      <span class="hljs-attr">lettuce:</span>
        <span class="hljs-attr">pool:</span>
          <span class="hljs-attr">max-active:</span> <span class="hljs-number">600</span>   <span class="hljs-comment"># 400 → 600</span>
          
<span class="hljs-attr">resilience4j:</span>
  <span class="hljs-attr">ratelimiter:</span>
    <span class="hljs-attr">instances:</span>
      <span class="hljs-attr">redirectLimit:</span>
        <span class="hljs-attr">limitForPeriod:</span> <span class="hljs-number">3000</span>  <span class="hljs-comment"># 基于实测调整</span>
</code></pre>
<p><strong>效果：</strong>  系统能稳定支撑 3000 QPS，性能达到最优状态</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/151ac836dc794abaaf153223e0cce4a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JmO5a2QX2xheW9y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818011&amp;x-signature=e9Vzc7OsWwz3r5dqHjE5sXvXxMg%3D" alt="image.png" loading="lazy"/>
如果不限流，把qps提到5000的效果：并不稳定，所以我先流至3000qps保护系统正常运行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbbfc74f2b4943f6b39e590f9420a363~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JmO5a2QX2xheW9y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818011&amp;x-signature=b%2BFMILb6k7oagBKNEJPtMZjK1wo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-10"><strong>总结</strong>：</h2>
<p><strong>对比优化前：</strong></p>



































<table><thead><tr><th>指标</th><th>优化前</th><th>优化后（3000 QPS）</th><th>提升</th></tr></thead><tbody><tr><td>P95 延迟</td><td>~1956ms</td><td><strong>8.05ms</strong></td><td><strong>降低 99.6%</strong></td></tr><tr><td>最大延迟</td><td>~7181ms</td><td>585ms</td><td><strong>降低 91.8%</strong></td></tr><tr><td>失败率</td><td>0%</td><td>0%</td><td>保持稳定</td></tr><tr><td>吞吐量</td><td>100-500 QPS</td><td><strong>稳定3000 QPS</strong></td><td><strong>提升 500%</strong></td></tr></tbody></table>
<hr/>
<p>关键的优化：</p>
<ol>
<li><strong>异步解耦</strong>: 将耗时操作移出主流程。</li>
<li><strong>线程池调优</strong>: 为异步任务配置合适的线程池。</li>
<li><strong>计数下沉</strong>: 利用 Redis 原子操作替代数据库写入。</li>
<li><strong>批量刷盘</strong>: 将高频写合并为低频批量写。</li>
<li><strong>本地缓存 (Caffeine)</strong> : 构建多级缓存体系，极致压缩读延迟。</li>
<li><strong>缓存预热</strong>: 消除冷启动延迟尖刺。</li>
<li><strong>连接池/Tomcat 调优</strong>: 提升高并发承载力。</li>
<li><strong>限流保护</strong>: 保障系统稳定性。</li>
</ol>
<p>后续的优化方向，后续更新：</p>
<ul>
<li>JVM调优+监控</li>
<li>熔断器</li>
<li>消息队列</li>
<li>水平扩展</li>
<li>读写分离</li>
<li>压测报告</li>
</ul>
<hr/>
<h6 data-id="heading-11">写在最后:</h6>
<p>这是作者第一次记录调优，中间也出现了许多问题，性能优化也不是稳定提升的，但主要还是上升的趋势，没有记录那么完整平滑的优化过程，只能大概的优化可以以图片的形式展示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/744b1849c33a446b86b91cfe0b91a8d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JmO5a2QX2xheW9y:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764818011&amp;x-signature=P7liwRsGp%2BePWcHwlPOANHJ4Ur4%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我用 Chrome 扩展验证了 MCP 的安全风险，结果发现]]></title>    <link>https://juejin.cn/post/7576953459543834678</link>    <guid>https://juejin.cn/post/7576953459543834678</guid>    <pubDate>2025-11-27T03:21:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576953459543834678" data-draft-id="7576935292428255274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我用 Chrome 扩展验证了 MCP 的安全风险，结果发现"/> <meta itemprop="keywords" content="MCP,Chrome"/> <meta itemprop="datePublished" content="2025-11-27T03:21:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我用 Chrome 扩展验证了 MCP 的安全风险，结果发现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:21:11.000Z" title="Thu Nov 27 2025 03:21:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>作为一名前端开发，我想探索浏览器能和 MCP 服务交互到什么程度。受 Koi.ai 文章启发做了个 Chrome 扩展，意外发现：<strong>前端与本地 MCP 的交互场景比想象的要有限，但这个探索过程揭示了更多有趣的技术可能性</strong>。</p>
<h2 data-id="heading-1">起因：一个有趣的技术问题</h2>
<p>作为一名前端开发工程师，我最近一直在关注 MCP (Model Context Protocol) 这个新兴协议。它让 AI 应用能够与各种工具和数据源交互，为前端领域带来了很多新的想象空间。</p>
<p>某天读到 Koi.ai 的一篇研究文章 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.koi.ai%2Fblog%2Ftrust-me-im-local-chrome-extensions-mcp-and-the-sandbox-escape" target="_blank" title="https://www.koi.ai/blog/trust-me-im-local-chrome-extensions-mcp-and-the-sandbox-escape" ref="nofollow noopener noreferrer">Trust Me, I'm Local: Chrome Extensions, MCP, and the Sandbox Escape</a>，文章从安全角度指出 Chrome 扩展可以访问本地运行的 MCP 服务器。但对我来说，这个技术细节引发了更多关于前端能力边界的思考：</p>
<p><strong>我想探索的问题</strong>：</p>
<ul>
<li>前端（Chrome 扩展）能和 MCP 交互到什么程度？</li>
<li>这种交互机制能带来什么样的解决方案？</li>
<li>浏览器沙箱和本地服务的边界在哪里？</li>
<li>是否存在前端直接调用本地 MCP 的实用场景？</li>
</ul>
<h3 data-id="heading-2">原文的安全视角</h3>
<p>简单介绍一下原文背景：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.koi.ai%2F" target="_blank" title="https://www.koi.ai/" ref="nofollow noopener noreferrer">Koi.ai</a> 是一家专注于软件供应链安全的公司，他们的研究团队发现 Chrome 扩展可以扫描并连接到本地 MCP 服务器。如果服务器无认证，可能访问文件系统、Slack 等敏感资源。文章的核心观点是：</p>
<blockquote>
<p>"任何 Chrome 扩展都可以利用这个。不需要特殊权限。"</p>
</blockquote>
<p><strong>但作为前端开发，我的第一反应不是"这很危险"，而是"这很有趣"</strong> ——这不正好说明前端技术栈有了新的能力边界吗？带着技术探索的好奇心，我决定：</p>
<ol>
<li>动手实现一个 Chrome 扩展探索这个边界</li>
<li>了解前端与 MCP 交互的技术细节</li>
<li>评估这种交互模式的实用价值</li>
<li>顺便考虑一下安全性问题</li>
</ol>
<h2 data-id="heading-3">实践：动手探索前端与 MCP 的边界</h2>
<p>作为前端开发，最好的学习方式就是动手做。我花了几天时间实现了一个 Chrome 扩展：</p>
<p><strong>技术实现</strong>：</p>
<ul>
<li>Chrome Extension Manifest V3（前端标准）</li>
<li>后台 Service Worker 扫描本地端口</li>
<li>Fetch API 探测 SSE 和 Streamable HTTP 端点</li>
<li>JSON-RPC 2.0 协议交互</li>
<li>测试用的 MCP 服务器（Express.js）</li>
</ul>
<p><strong>扫描逻辑</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 尝试连接 localhost 的常见端口</span>
<span class="hljs-keyword">const</span> ports = [<span class="hljs-number">3000</span>, <span class="hljs-number">3001</span>, <span class="hljs-number">5173</span>, <span class="hljs-number">8080</span>, ...];
<span class="hljs-keyword">const</span> endpoints = [<span class="hljs-string">'/sse'</span>, <span class="hljs-string">'/mcp'</span>, <span class="hljs-string">'/api/mcp'</span>];

<span class="hljs-comment">// 1. 尝试 SSE 连接</span>
<span class="hljs-keyword">const</span> sseResponse = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`http://localhost:<span class="hljs-subst">${port}</span>/sse`</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">headers</span>: {<span class="hljs-string">'Accept'</span>: <span class="hljs-string">'text/event-stream'</span>}
});
<span class="hljs-keyword">if</span> (sseResponse.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'content-type'</span>)?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'text/event-stream'</span>)) {
  <span class="hljs-keyword">const</span> sessionId = sseResponse.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'x-session-id'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Found SSE MCP server with session:'</span>, sessionId);
}

<span class="hljs-comment">// 2. 尝试 Streamable HTTP 连接</span>
<span class="hljs-keyword">const</span> httpResponse = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`http://localhost:<span class="hljs-subst">${port}</span>/mcp`</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>},
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">jsonrpc</span>: <span class="hljs-string">'2.0'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'initialize'</span>,
    <span class="hljs-attr">params</span>: {
      <span class="hljs-attr">protocolVersion</span>: <span class="hljs-string">'2024-11-05'</span>,
      <span class="hljs-attr">capabilities</span>: {},
      <span class="hljs-attr">clientInfo</span>: {<span class="hljs-attr">name</span>: <span class="hljs-string">'Scanner'</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>}
    },
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>
  })
});
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> httpResponse.<span class="hljs-title function_">json</span>();
<span class="hljs-keyword">if</span> (data.<span class="hljs-property">jsonrpc</span> === <span class="hljs-string">'2.0'</span> &amp;&amp; data.<span class="hljs-property">result</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Found HTTP MCP server:'</span>, data.<span class="hljs-property">result</span>.<span class="hljs-property">serverInfo</span>);
}
</code></pre>
<p>测试很成功！扩展完美检测到了测试服务器，前端可以流畅地完成：扫描本地端口 → 建立 MCP 连接 → 获取工具列表 → 调用 MCP 工具。</p>
<p><strong>技术验证完成：前端确实可以和本地 MCP 交互！</strong></p>
<h2 data-id="heading-4">发现：但实际场景远比想象的有限</h2>
<p>就在我准备为这个"新能力"兴奋时，一个问题让我冷静下来：<strong>作为前端开发，我们真的会在 localhost 运行 HTTP 模式的 MCP 服务器吗？</strong></p>
<p>这个问题引发了我对 MCP 实际部署模式的思考。让我先解释一下 MCP 支持的三种传输方式。</p>
<h3 data-id="heading-5">MCP 的三种传输模式详解</h3>
<p>MCP 协议设计上支持三种传输方式，每种都有不同的使用场景：</p>
<h4 data-id="heading-6">1. stdio 模式（主流方式）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"filesystem"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"@modelcontextprotocol/server-filesystem"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/path"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>通过标准输入输出通信</li>
<li>作为子进程运行，不开放网络端口</li>
<li><strong>Chrome 扩展完全无法访问</strong> ✅</li>
<li>这是 Claude Desktop 等主流应用的标准配置</li>
</ul>
<p><strong>安全性</strong>：高 - 天然隔离，Chrome 扫描不到</p>
<h4 data-id="heading-7">2. Server-Sent Events (SSE) 模式</h4>
<p><strong>特点</strong>：</p>
<ul>
<li>GET 请求建立 SSE 连接，服务器可推送事件</li>
<li>POST 请求发送 JSON-RPC 消息（双向通信）</li>
<li>需要开放 HTTP 端口，使用 session ID 管理连接</li>
</ul>
<h4 data-id="heading-8">3. Streamable HTTP 模式</h4>
<p><strong>特点</strong>：</p>
<ul>
<li>基于标准 HTTP POST 请求，使用 JSON-RPC 2.0 协议</li>
<li>无状态设计，每次请求独立（无需 session）</li>
<li>更简单直接，易于部署和集成</li>
</ul>
<h3 data-id="heading-9">关键发现：网络模式实际部署在哪？</h3>
<p>理解了三种传输模式后，一个更重要的问题浮现出来：<strong>SSE 和 Streamable HTTP 这两种网络传输模式，在实际项目中是怎么部署的？</strong></p>
<p><strong>情况 A：生产部署（常见）</strong></p>
<ul>
<li>部署在远程服务器（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmcp.example.com%25EF%25BC%2589" target="_blank" title="https://mcp.example.com%EF%BC%89" ref="nofollow noopener noreferrer">mcp.example.com）</a></li>
<li>有认证机制（API Key、OAuth 等）</li>
<li>Chrome 扫描不到（不在 localhost）</li>
</ul>
<p><strong>情况 B：本地开发测试（较少）</strong></p>
<ul>
<li>localhost:3001</li>
<li>可能无认证（为了方便测试）</li>
<li>Chrome 可以扫描</li>
<li><strong>但通常是临时的，开发测试完就关闭</strong></li>
</ul>
<h3 data-id="heading-10">实际使用场景分析</h3>

































<table><thead><tr><th>场景</th><th>传输模式</th><th>普遍性</th><th>Chrome 可访问</th><th>实际风险</th></tr></thead><tbody><tr><td>Claude Desktop 等</td><td>stdio</td><td>⭐⭐⭐⭐⭐</td><td>❌</td><td>无</td></tr><tr><td>远程 MCP 服务</td><td>SSE/HTTP</td><td>⭐⭐⭐</td><td>❌</td><td>无</td></tr><tr><td>本地开发测试</td><td>SSE/HTTP</td><td>⭐</td><td>✅</td><td>低</td></tr></tbody></table>
<p><strong>注</strong>：普遍性基于 MCP 官方推荐和主流工具的实际采用情况，非精确统计数据。</p>
<p>看到这个表格，答案很明显：<strong>真正能被 Chrome 扩展访问到的本地 MCP 场景非常少见</strong>。原文描述的安全风险，在实际中发生的概率很低。</p>
<p>这让我意识到：虽然技术上验证了前端可以和本地 MCP 交互，但实用场景确实有限。<strong>那这个项目还有意义吗？</strong></p>
<h2 data-id="heading-11">转型：从 MCP 探索到开发环境工具</h2>
<p>答案是有的！当我跳出最初"前端连接 MCP"的设定，重新审视手上的代码时，发现了新的价值点。</p>
<p><strong>从</strong>：探索前端与 MCP 的交互边界<br/>
<strong>到</strong>：开发环境服务发现工具</p>
<p>想想看，作为前端开发，我们的日常工作中经常会遇到这样的情况：</p>
<ul>
<li>同时运行多个开发服务器（Vite、webpack-dev-server）</li>
<li>本地启动数据库（MongoDB、Redis）</li>
<li>开启各种调试端口</li>
<li>忘记关闭测试服务</li>
</ul>
<p>而我手上这个扫描器，恰好可以帮助解决这些问题：</p>
<ul>
<li>扫描并列出所有本地运行的开发服务</li>
<li>识别服务类型（根据端口和响应）</li>
<li>提醒可能的安全风险</li>
<li>生成本地服务清单</li>
</ul>
<p><strong>这次探索的收获：</strong></p>
<p><strong>技术层面</strong>：</p>
<ul>
<li>理解了浏览器扩展的能力边界</li>
<li>掌握了 Chrome Extension API</li>
<li>实践了 MCP 协议细节</li>
<li>学会了端口扫描的前端实现</li>
</ul>
<p><strong>实用层面</strong>：</p>
<ul>
<li>快速查看本地运行了哪些服务</li>
<li>清理被遗忘的测试服务</li>
<li>团队共享开发环境配置</li>
</ul>
<p>虽然和最初"探索前端 MCP 能力"的目标不同，但这个方向显然更实用。这让我想起了一个词：<strong>Pivot</strong>（战略转向）——保留已有成果，找到新的价值点。</p>
<h2 data-id="heading-12">拓展：国内智能体的安全设计对比</h2>
<p>既然聊到了 MCP 的安全性，作为国内开发者，我也想聊聊国内智能体平台在架构安全上的差异。</p>
<h3 data-id="heading-13">快速对比</h3>









































<table><thead><tr><th>平台</th><th>部署模式</th><th>本地集成</th><th>安全特点</th></tr></thead><tbody><tr><td>字节豆包</td><td>云端为主</td><td>较少</td><td>企业级权限</td></tr><tr><td>百度文心</td><td>云端 + 私有化</td><td>中等</td><td>完善审计</td></tr><tr><td>阿里通义</td><td>云端 + 本地</td><td>支持</td><td>依赖配置</td></tr><tr><td>智谱清言</td><td>API + 本地</td><td>支持</td><td>企业方案</td></tr><tr><td><strong>纳米AI</strong></td><td><strong>本地优先</strong></td><td><strong>完整</strong></td><td><strong>安全基因</strong> ✅</td></tr></tbody></table>
<h3 data-id="heading-14">纳米AI的差异化优势</h3>
<p>通过这次 MCP 安全探索，我发现<strong>纳米AI</strong>在架构设计上有些不同的思考：</p>
<p><strong>核心设计理念</strong>：</p>
<ul>
<li><strong>默认 stdio 通信</strong>：和 Claude 一样，优先用进程间通信，避免网络暴露风险</li>
<li><strong>完全私有化部署</strong>：企业可内网部署，数据不出边界，满足合规要求</li>
<li><strong>细粒度权限控制</strong>：每个工具都有明确权限范围，支持多层认证（API Key、OAuth、SSO）</li>
<li><strong>安全审计完整</strong>：所有工具调用都有日志，内置配置审计工具</li>
</ul>
<p><strong>为什么值得关注</strong>：</p>
<ol>
<li>从设计之初就考虑本地安全（而不是事后补救）</li>
<li>既有国际化的技术标准（如默认 stdio），又适配中国企业需求</li>
<li>开发者生态友好，提供安全配置模板和最佳实践</li>
</ol>
<p><strong>一句话总结</strong>：在 MCP 安全问题日益受关注的今天，<strong>纳米AI</strong>这种"安全优先"的设计理念，比"功能优先，安全后补"更值得信赖。</p>
<h2 data-id="heading-15">总结：一次完整的技术探索</h2>
<h3 data-id="heading-16">关于前端与 MCP 的交互</h3>
<p>回到最初的问题：前端能和 MCP 交互到什么程度？</p>
<p><strong>技术验证的结果</strong>：</p>
<ul>
<li>✅ Chrome 扩展可以访问 localhost 的 MCP 服务器</li>
<li>✅ 可以通过 Fetch API 发送 JSON-RPC 请求</li>
<li>✅ 可以建立 SSE 连接接收事件</li>
<li>✅ 可以调用 MCP 提供的工具</li>
</ul>
<p><strong>实际上受限的</strong>：</p>
<ul>
<li>❌ MCP 官方推荐并被主流工具采用的是 stdio 模式（前端无法访问）</li>
<li>❌ HTTP 模式主要在远程（有 CORS 和认证）</li>
<li>❌ 本地 HTTP 模式较少见（主要用于开发测试，且临时）</li>
<li>❌ 缺少实用的前端直连本地 MCP 场景</li>
</ul>
<h3 data-id="heading-17">这次探索的收获</h3>
<p>虽然最初"前端直连本地 MCP"的设想场景有限，但这次探索本身很有价值：</p>
<p><strong>技术收获</strong>：</p>
<ul>
<li>深入理解了 MCP 协议（三种传输模式）</li>
<li>学会了浏览器中的端口扫描实现</li>
<li>理解了浏览器安全模型的边界</li>
</ul>
<p><strong>实用产出</strong>：</p>
<ul>
<li>开发环境服务发现工具</li>
<li>可以帮助团队管理本地服务</li>
<li>可以作为 MCP 开发调试工具</li>
</ul>
<p><strong>思维层面</strong>：</p>
<ul>
<li>学会从多个视角看待同一个技术现象</li>
<li>理解技术可行性和实际价值的区别</li>
<li>掌握了 Pivot（调整方向）的方法</li>
<li>培养了批判性思考技术文章的能力</li>
</ul>
<hr/>
<h2 data-id="heading-18">项目开源</h2>
<p><strong>GitHub 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdonghai88%2Fmcp-security-scanner" target="_blank" title="https://github.com/donghai88/mcp-security-scanner" ref="nofollow noopener noreferrer">github.com/donghai88/m…</a></p>
<p>完整代码已开源，包含 Chrome 扩展、测试 MCP 服务器。欢迎 Fork、Star 或提 Issue 讨论！</p>
<p><strong>欢迎前端同学交流</strong>：</p>
<ul>
<li>你怎么看前端与 MCP 的集成？有没有好的实践案例？</li>
<li>你遇到过类似"技术可行但场景有限"的探索吗？</li>
<li>对这个项目有什么改进建议或新想法？</li>
</ul>
<hr/>
<p><strong>参考资料</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.koi.ai%2Fblog%2Ftrust-me-im-local-chrome-extensions-mcp-and-the-sandbox-escape" target="_blank" title="https://www.koi.ai/blog/trust-me-im-local-chrome-extensions-mcp-and-the-sandbox-escape" ref="nofollow noopener noreferrer">Koi.ai - Trust Me, I'm Local</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspec.modelcontextprotocol.io%2F" target="_blank" title="https://spec.modelcontextprotocol.io/" ref="nofollow noopener noreferrer">MCP Protocol Specification</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2Fdevelop%2Fconcepts%2Fsecurity" target="_blank" title="https://developer.chrome.com/docs/extensions/develop/concepts/security" ref="nofollow noopener noreferrer">Chrome Extension Security</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fn.cn" target="_blank" title="https://n.cn" ref="nofollow noopener noreferrer">纳米AI 官网</a></li>
</ul>
<hr/>
<p><strong>声明</strong>：</p>
<ul>
<li>本文从前端开发视角探讨 MCP 技术，补充了 Koi.ai 原文的安全研究视角</li>
<li>感谢原作者 Yuval Ronen 的研究工作，为技术社区提供了宝贵的安全洞察</li>
<li>对国内智能体平台的评价基于公开信息和个人使用体验</li>
</ul>
<p><strong>我相信技术探索需要多元视角——安全研究员看到风险，开发者看到可能性，产品人看到价值。这些视角互补，才能让技术生态更健康。欢迎不同背景的同学一起讨论！</strong> 🤝</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Doris 中的 Data Trait：性能提速 2 倍的秘密武器]]></title>    <link>https://juejin.cn/post/7576928310788423732</link>    <guid>https://juejin.cn/post/7576928310788423732</guid>    <pubDate>2025-11-27T03:43:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576928310788423732" data-draft-id="7577201863725318144" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Doris 中的 Data Trait：性能提速 2 倍的秘密武器"/> <meta itemprop="keywords" content="后端,数据库,Apache"/> <meta itemprop="datePublished" content="2025-11-27T03:43:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Doris 中的 Data Trait：性能提速 2 倍的秘密武器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:43:52.000Z" title="Thu Nov 27 2025 03:43:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据库系统的核心层，查询优化器如同一位精明的策略家，不断分析数据特征并制定最优执行计划。Apache Doris 作为一款高性能的 MPP 分析型数据库，其优化器内置的 Data Trait 分析机制，通过挖掘数据内在的统计特征和语义约束，为查询优化提供了基础设施。让我们一起来探索这个强大的功能！</p>
<h2 data-id="heading-0">什么是 Data Trait？</h2>
<p>想象一下，如果你能提前知道数据的 “性格特征”，是不是就能更聪明地处理它们？Data Trait 正是这样一种对查询数据和中间结果的 “性格描述”。在 Doris 中，它目前实现了四种关键特征：</p>
<ol>
<li>唯一性（Uniqueness）：数据的 “身份证” “在这个世界上，我是独一无二的！”—— 当某列数据这样 “宣称” 时，它就具有唯一性特征。数学上表示为：NDV（不同值的数量） = 表的总行数。</li>
<li>均匀性（Uniformity）：数据的 “复制粘贴” “我们全都一样！”—— 当一列数据都是相同值时，它就展现出均匀性。具体指非空不同值数量不超过 1。 有趣事实：这种列就像军队的制服，整齐划一，优化器看到它们可以采取特殊处理策略。</li>
<li>等值集（Equal Set）：数据的 “双胞胎” “我们形影不离，永远相同！”—— 当两列数据在所有行中都完美匹配时（包括 NULL 值），它们就构成等值集。 Doris 的等值集判断是 NULL 敏感的，NULL ≠ NULL 哦！</li>
<li>函数依赖（Functional Dependency）：数据的 “因果关系” “只要知道 X，就必然知道 Y！”—— 当一组列（X）能唯一决定另一组列（Y）的值时，就存在函数依赖。 X 称为决定因素（Determinant），Y 称为被决定因素（Dependecy） 定义如下： ∀X， Y ⊆ R， X → Y ⇔ ∀t1， t2 ∈ R， t1 [X] = t2 [X] ⇒ t1 [Y] = t2 [Y] 其中，t [X] 表示元组 t 在属性集 X 上的投影。</li>
</ol>
<h2 data-id="heading-1">Data Trait 的表示</h2>
<h3 data-id="heading-2">唯一性</h3>
<p>唯一性使用 UniqueDescription 描述， 想象一个公司的员工管理系统：</p>
<ul>
<li>独立唯一性（slots）：就像每个员工的工牌 ID（如 101、102），这些值在整个公司内是独一无二的</li>
<li>联合唯一性（slotSets）：例如“部门+姓名”的组合，单独看部门可能重复（多个研发部员工），单独看姓名也可能重复（同名员工），但“研发部+张三”的组合在全公司是唯一的</li>
</ul>
<h3 data-id="heading-3">均匀性</h3>
<p>均匀性使用 UniformDescription 描述， 包括：</p>
<ul>
<li>已知值的均匀列（有具体 value）：
<ul>
<li>比如查询 WHERE department='研发部'，这时 department 列在结果集中所有值都是“研发部”</li>
<li>类似 SELECT 1 as const_value 中的 const_value 列，所有行都是 1</li>
</ul>
</li>
<li>未知值的均匀列（无具体 value）：
<ul>
<li>例如 LIMIT 1 后的所有列，虽然知道它们值相同，但不确定具体是什么值</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">等值集</h3>
<p>等值集采用并查集（一种高效的数据结构）来管理，就像家族关系网：</p>
<p>每个数据列最初都是独立的“个体”， 当发现两列值完全相同时（如存在谓词 a = b），它们就被划归到同一个家族，最终所有相等的列会形成一棵棵“家族树”，树中的成员彼此等价。</p>
<h3 data-id="heading-5">函数依赖</h3>
<p>函数依赖关系使用有向图实现， 就像公司汇报关系：</p>
<ul>
<li>节点：代表一组数据列（如员工 ID、部门 ID 等）</li>
<li>边（ → ）：表示决定关系，比如：
<ul>
<li>员工 ID → 员工姓名（知道 ID 就能确定姓名）</li>
<li>部门 ID+项目 ID → 项目经理（联合决定）</li>
</ul>
</li>
</ul>
<p>这个关系网具有传递性：如果 A→B 且 B→C，那么 A→C</p>
<h2 data-id="heading-6">Data Trait 是如何推导出来的？</h2>
<ol>
<li>逐层调查：从查询计划的最底层开始，每个处理节点（如扫描、过滤、连接等）都会根据自身特点生成对应的数据特征报告</li>
<li>懒加载机制：只有当优化器真正需要这些特征时才会进行计算，避免不必要的分析工作</li>
<li>特征合成：高层节点会综合下层节点的特征信息，并结合自身操作特点，生成新的特征描述。 同时，Data Trait 之间也可以相互推导：具有 unique 属性的 slot 能决定所有其他 slot；具有 uniform 属性的 slot 依赖于所有其他的 slot；相等的 slot 互相依赖；相等的 slot 具有相同的 Unique 属性和 Uniform 属性。</li>
</ol>
<h3 data-id="heading-7">Data Trait 的推导过程示例</h3>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (
    emp_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    emp_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    dept_id <span class="hljs-type">INT</span>,
    salary <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    hire_date <span class="hljs-type">DATE</span>
) <span class="hljs-keyword">UNIQUE</span> KEY(emp_id) DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(emp_id) PROPERTIES(<span class="hljs-string">'replication_num'</span><span class="hljs-operator">=</span><span class="hljs-string">'1'</span>);

<span class="hljs-keyword">SELECT</span> dept_id, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> emp_count <span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> dept_id;
</code></pre>
<p>以上面的 SQL 为例，说明一下 DATA TRAIT 的推导过程，查询计划如下：</p>
<pre><code class="hljs language-Java" lang="Java">[Aggregate]
   |
[Scan]
</code></pre>
<h4 data-id="heading-8">基表扫描层</h4>
<p>当扫描 employees 表时，优化器发现：</p>
<ul>
<li>唯一标识：emp_id 是 UNIQUE KEY，具有唯一性特征</li>
<li>函数依赖：由于 emp_id 是 UNIQUE KEY，它可以决定表中所有其他列的值（知道员工 ID 就能确定他的部门、姓名等信息）</li>
</ul>
<h4 data-id="heading-9">聚合操作层</h4>
<p>进行 GROUP BY 聚合时，数据特征发生了转变：</p>
<ul>
<li>唯一性变化
<ul>
<li>新增的特性：dept_id 是分组键，具有唯一性特征；</li>
<li>丢失的特性：原本 emp_id 的唯一性不再有效，因为多行数据被折叠成了分组形式。</li>
</ul>
</li>
<li>函数依赖变化
<ul>
<li>新增的关系：现在 dept_id 成为新的“决定因素”，可以确定该部门的员工数量 emp_count（就像知道部门编号就能查到该部门的人数统计）</li>
<li>丢失的关系：原先基于 emp_id 的所有函数依赖都失效了，因为员工级别的信息已被聚合操作折叠。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-10">Data Trait 如何优化查询？魔法般的规则应用</h2>
<p>下面通过完整示例演示 Data Trait 如何在实际查询优化中发挥作用。先从建表开始，逐步展示优化器如何利用数据特征进行优化。</p>
<h3 data-id="heading-11">准备测试环境</h3>
<p>建表语句和插入数据 SQL 如下：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-comment">-- 员工表（包含唯一ID）</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> employees;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> employees (
    emp_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    emp_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    dept_id <span class="hljs-type">INT</span>,
    salary <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    hire_date <span class="hljs-type">DATE</span>
) <span class="hljs-keyword">UNIQUE</span> KEY(emp_id) DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(emp_id) PROPERTIES(<span class="hljs-string">'replication_num'</span><span class="hljs-operator">=</span><span class="hljs-string">'1'</span>);

<span class="hljs-comment">-- 部门表（包含唯一ID）</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> departments;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> departments (
    dept_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    dept_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    location <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>)
) <span class="hljs-keyword">UNIQUE</span> KEY(dept_id) DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(dept_id) PROPERTIES(<span class="hljs-string">'replication_num'</span><span class="hljs-operator">=</span><span class="hljs-string">'1'</span>);

<span class="hljs-comment">-- 订单表（包含唯一ID）</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> orders;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    customer_id <span class="hljs-type">INT</span>,
    order_date <span class="hljs-type">DATE</span>,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
) <span class="hljs-keyword">UNIQUE</span> KEY(order_id) DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(order_id) PROPERTIES(<span class="hljs-string">'replication_num'</span><span class="hljs-operator">=</span><span class="hljs-string">'1'</span>);


<span class="hljs-comment">-- 插入测试数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> departments <span class="hljs-keyword">SELECT</span> number, concat(<span class="hljs-string">'name'</span>,<span class="hljs-built_in">cast</span>(number <span class="hljs-keyword">as</span> string)), concat(<span class="hljs-string">'location'</span>, <span class="hljs-built_in">cast</span>(number <span class="hljs-keyword">as</span> string)) <span class="hljs-keyword">from</span> numbers("number"<span class="hljs-operator">=</span>"30");

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> employees <span class="hljs-keyword">SELECT</span> number, concat(<span class="hljs-string">'name'</span>,<span class="hljs-built_in">cast</span>(number <span class="hljs-keyword">as</span> string)), concat(<span class="hljs-string">'email'</span>,<span class="hljs-built_in">cast</span>(number <span class="hljs-keyword">as</span> string)),number <span class="hljs-operator">%</span> <span class="hljs-number">30</span>, number, <span class="hljs-string">'2025-01-01'</span> <span class="hljs-keyword">from</span> numbers("number" <span class="hljs-operator">=</span> "100000000");

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">1001</span>, <span class="hljs-number">5001</span>, <span class="hljs-string">'2023-01-10'</span>, <span class="hljs-number">999.99</span>),
(<span class="hljs-number">1002</span>, <span class="hljs-number">5001</span>, <span class="hljs-string">'2023-02-15'</span>, <span class="hljs-number">1499.99</span>),
(<span class="hljs-number">1003</span>, <span class="hljs-number">5002</span>, <span class="hljs-string">'2023-01-20'</span>, <span class="hljs-number">799.99</span>),
(<span class="hljs-number">1004</span>, <span class="hljs-number">5003</span>, <span class="hljs-string">'2023-03-05'</span>, <span class="hljs-number">2499.99</span>);
</code></pre>
<h3 data-id="heading-12">Data Trait 优化实战演示</h3>
<h4 data-id="heading-13">根据连接键唯一性消除连接（ELIMINATE_JOIN_BY_UK）</h4>
<p>场景：在进行 left join 时，右表的连接键是唯一的（允许存在多个 NULL 值），且查询只需要左表数据时...</p>
<p>魔法：直接去掉这个 Join！因为右表要么匹配一行，要么不匹配，不影响左表数据完整性。</p>
<p>示例如下：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-comment">-- 原始查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(emp_id) <span class="hljs-keyword">FROM</span> (
<span class="hljs-keyword">SELECT</span> e.emp_id
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.dept_id <span class="hljs-operator">=</span> d.dept_id) t;

<span class="hljs-comment">-- 优化后等效查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(emp_id) <span class="hljs-keyword">FROM</span> employees e;
</code></pre>
<p>关闭 ELIMINATE_JOIN_BY_UK 优化时（使用 set disable_nereids_rules = 'ELIMINATE_JOIN_BY_UK'关闭优化），执行时间为 0.1sec， 在开启 ELIMINATE_JOIN_BY_UK 优化时，执行时间为 0.05sec，<strong>性能提升了 100%</strong>。</p>
<h4 data-id="heading-14">根据唯一性消除冗余聚合键（ELIMINATE_GROUP_BY）</h4>
<p>场景： 当 Group By Key 列中存在具有 unique 并且非空属性的列时...</p>
<p>魔法：可以直接把 Group By 删除</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-comment">--原始查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(c2) <span class="hljs-keyword">FROM</span> 
(<span class="hljs-keyword">SELECT</span> emp_id c1, <span class="hljs-built_in">sum</span>(salary) c2 <span class="hljs-keyword">from</span> employees <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> emp_id, emp_name) t;

<span class="hljs-comment">-- 优化后等效查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(c2) <span class="hljs-keyword">FROM</span> 
(<span class="hljs-keyword">SELECT</span> emp_id c1, salary c2 <span class="hljs-keyword">from</span> employees) t;
</code></pre>
<p>在关闭 ELIMINATE_GROUP_BY 优化时，执行时间为 0.96sec， 在开启 ELIMINATE_GROUP_BY 优化时，  SQL 的执行时间是 0.08sec， <strong>性能提升了 1100%</strong>。</p>
<h4 data-id="heading-15">消除存在依赖关系的聚合键（ELIMINATE_GROUP_BY_KEY）</h4>
<p>场景：Group By 多列，并且这些列中具有函数依赖关系</p>
<p>魔法：使用函数依赖中被决定的 slot 可以在 Group By Key 列中被消除。</p>
<p>示例如下：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-comment">--案例1: 根据函数提供的函数依赖消除</span>
<span class="hljs-comment">-- email -&gt; SUBSTR(email, 1, INSTR(email, '@')-1)</span>
<span class="hljs-comment">-- 原始查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">count</span>(email) <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> email
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> email, SUBSTR(email, INSTR(email, <span class="hljs-string">'l'</span>)<span class="hljs-operator">+</span><span class="hljs-number">1</span>)) t;
<span class="hljs-comment">-- 优化后等效查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">count</span>(email) <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> email
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> email) t;

<span class="hljs-comment">--案例2: 根据等值集提供的函数依赖消除</span>
<span class="hljs-comment">-- 原始查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 
<span class="hljs-keyword">FROM</span> employees e 
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.dept_id <span class="hljs-operator">=</span> d.dept_id 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> e.dept_id, d.dept_id;
<span class="hljs-comment">-- 优化后等效查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 
<span class="hljs-keyword">FROM</span> employees e 
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.dept_id <span class="hljs-operator">=</span> d.dept_id 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> e.dept_id;
</code></pre>
<p>以案例 1 为例，在关闭 ELIMINATE_GROUP_BY_KEY 优化时，执行时间为 2.11s， 在开启 ELIMINATE_GROUP_BY_KEY 优化时，SQL 的执行时间为 1.41sec， <strong>性能提升了 50%</strong>。</p>
<h4 data-id="heading-16">消除均一列的聚合键（ELIMINATE_GROUP_BY_KEY_BY_UNIFORM）</h4>
<p>场景：Group By 的列所有值都相同...</p>
<p>魔法：直接去掉 Group By，因为所有行都属于同一组。</p>
<p>示例如下：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-comment">-- 原始查询</span>
<span class="hljs-keyword">SELECT</span> hire_date, <span class="hljs-built_in">max</span>(salary) <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> hire_date<span class="hljs-operator">=</span><span class="hljs-string">'2025-01-01'</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> dept_id,hire_date;

<span class="hljs-comment">-- 优化后等效查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-string">'2025-01-01'</span>, <span class="hljs-built_in">max</span>(salary) <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> hire_date<span class="hljs-operator">=</span><span class="hljs-string">'2025-01-01'</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> dept_id;
</code></pre>
<p>在关闭 ELIMINATE_GROUP_BY_KEY_BY_UNIFORM 优化时，执行时间为 0.15sec，在开启 ELIMINATE_GROUP_BY_KEY_BY_UNIFORM 优化时，SQL 的执行时间是 0.11sec，<strong>性能提升了 36%</strong>。</p>
<h4 data-id="heading-17">消除无意义排序（ELIMINATE_ORDER_BY_KEY）</h4>
<p>场景：按唯一键排序， 或者排序键中包含具有函数依赖时。</p>
<p>魔法：去掉这个 Order By，因为数据已经自然有序， 去掉函数依赖中被决定的 Key。</p>
<p>示例如下：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-comment">-- 案例1：唯一性推导的函数依赖简化</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">sum</span>(c1) <span class="hljs-keyword">FROM</span>
(<span class="hljs-keyword">SELECT</span> emp_id c1, emp_name c2
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> emp_id,emp_name,email,dept_id,salary,hire_date
LIMIT <span class="hljs-number">1000000</span>) t;
<span class="hljs-comment">-- 优化后等效查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">sum</span>(c1) <span class="hljs-keyword">FROM</span>
(<span class="hljs-keyword">SELECT</span> emp_id c1, emp_name c2
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> emp_id
LIMIT <span class="hljs-number">1000000</span>) t;

<span class="hljs-comment">-- 案例2：表达式推导的函数依赖简化</span>
<span class="hljs-keyword">SELECT</span> hire_date, <span class="hljs-built_in">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> hire_date), <span class="hljs-built_in">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> hire_date)
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> hire_date, <span class="hljs-built_in">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> hire_date), <span class="hljs-built_in">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> hire_date);
<span class="hljs-comment">-- 优化后等效查询</span>
<span class="hljs-keyword">SELECT</span> hire_date, <span class="hljs-built_in">EXTRACT</span>(<span class="hljs-keyword">YEAR</span> <span class="hljs-keyword">FROM</span> hire_date), <span class="hljs-built_in">EXTRACT</span>(<span class="hljs-keyword">MONTH</span> <span class="hljs-keyword">FROM</span> hire_date)
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> hire_date;

<span class="hljs-comment">-- 案例3: 多列表达式依赖简化</span>
<span class="hljs-keyword">SELECT</span> emp_name
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> emp_name, email, CONCAT(emp_name, <span class="hljs-string">' '</span>, email);
<span class="hljs-comment">-- 优化后等效查询</span>
<span class="hljs-keyword">SELECT</span> emp_name
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> emp_name, email;

<span class="hljs-comment">-- 案例4: 根据均匀性消除</span>
<span class="hljs-keyword">SELECT</span> emp_name 
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">WHERE</span> emp_id <span class="hljs-operator">=</span> <span class="hljs-number">101</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> emp_id;
<span class="hljs-comment">--优化后等效查询</span>
<span class="hljs-keyword">SELECT</span> emp_name 
<span class="hljs-keyword">FROM</span> employees 
<span class="hljs-keyword">WHERE</span> emp_id <span class="hljs-operator">=</span> <span class="hljs-number">101</span>;
</code></pre>
<p>以案例 1 为例，在关闭 <code>ELIMINATE_ORDER_BY_KEY</code> 优化时，SQL 的执行时间是 0.37sec， 在开启 <code>ELIMINATE_ORDER_BY_KEY</code> 优化时，SQL 的执行时间是 0.13sec，<strong>性能提升了 185%</strong>。</p>
<h4 data-id="heading-18">优化效果对比</h4>
<p>五个优化规则的效果对比如下图所示，蓝色代表关闭优化规则的 SQL 执行时间，橙色代表开启优化规则的 SQL 执行时间。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea8a27647e434065920052215e13b51a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764819831&amp;x-signature=Sd9Mzc1DeYr8Ddv4VJp0xlGCLt4%3D" alt="优化效果对比.png" loading="lazy"/></p>
<h2 data-id="heading-19">最佳实践</h2>
<h3 data-id="heading-20">建议做法：为所有唯一键列添加明确的 UNIQUE 约束</h3>
<p>无论列是否为主键，只要具有唯一性特征（包括业务唯一键、组合唯一键和外键关联列），都应通过 UNIQUE 约束明确定义。</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    order_id <span class="hljs-type">INT</span>,
    order_code <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>));
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> orders_uk <span class="hljs-keyword">UNIQUE</span> (order_id);
</code></pre>
<p>优化收益：帮助优化器识别唯一性特征，实现 Join 消除、Group By 简化等优化。</p>
<h3 data-id="heading-21">建议做法：合理使用 NOT NULL 约束</h3>
<p>对业务上不允许为空的列添加 NOT NULL，因为上面提到的一些优化规则，是要求 slot 唯一且非空或者均匀且非空才能应用， 添加 NOT NULL 可以避免 NULL 值对优化的干扰。</p>
<pre><code class="hljs language-Java" lang="Java">CREATE TABLE <span class="hljs-title function_">products</span> <span class="hljs-params">(
    product_id INT NOT NULL,
    product_name VARCHAR(<span class="hljs-number">100</span>)</span> NOT NULL);
</code></pre>
<h3 data-id="heading-22">避免做法：过度使用 SELECT *</h3>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-comment">-- 应避免的写法</span>
explain logical plan
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> 
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.dept_id <span class="hljs-operator">=</span> d.dept_id;

<span class="hljs-comment">-- 推荐写法</span>
explain logical plan
<span class="hljs-keyword">SELECT</span> e.<span class="hljs-operator">*</span> 
<span class="hljs-keyword">FROM</span> employees e
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> departments d <span class="hljs-keyword">ON</span> e.dept_id <span class="hljs-operator">=</span> d.dept_id;
</code></pre>
<p>问题原因：例如，优化规则 ELIMINATE_JOIN_BY_UK 能够应用的条件之一是投影列中只出现 LEFT OUTER JOIN 左表的列， 所以当您只需要左表数据时，SELECT * 的使用会阻碍优化器应用优化规则。</p>
<h3 data-id="heading-23">避免做法：避免冗余的分组键和排序键</h3>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-comment">-- 冗余分组列（即使用者知道product_id决定product_name，但是数据库系统未识别此依赖，此时product_name为冗余，可以删除）</span>
<span class="hljs-keyword">SELECT</span> product_id, product_name
<span class="hljs-keyword">FROM</span> products
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> product_id, product_name;
</code></pre>
<p>通过主动避免冗余的分组键和排序键，即使某些函数依赖无法被系统自动识别，您仍然可以提高查询执行效率， 减少资源消耗， 保持代码简洁性。</p>
<h2 data-id="heading-24">总结和展望</h2>
<p>Data Trait 通过四大核心特征（唯一性、均匀性、等值集、函数依赖）为查询优化器提供了深度的数据认知能力：</p>
<ul>
<li><strong>数据特征识别</strong>：精确捕捉数据的本质属性，如主键唯一性、常量列均匀性等</li>
<li><strong>查询语义理解</strong>：解析 SQL 操作背后的真实数据关系，识别冗余操作</li>
<li><strong>优化决策支持</strong>：为查询重写、计划选择等优化提供理论依据</li>
</ul>
<p>Data Trait 的设计采用了高度模块化的架构，为未来的功能扩展预留了充分空间。特别是在 Uniform 特征的扩展方面，计划引入更精细化的取值分布描述能力。当前 Uniform 主要记录列值完全均匀（单一值）的情况，下一步将扩展为支持记录有限离散值的场景。例如当查询包含 WHERE status IN （'active'，'pending'）这样的 IN 谓词过滤时，优化器可以精确获知 status 列在此查询上下文中只有 2 个可能的取值。这种扩展后的 Uniform 特征将为优化器带来更丰富的决策依据。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Amazon Bedrock助力飞书深诺电商广告分类]]></title>    <link>https://juejin.cn/post/7576907627018092595</link>    <guid>https://juejin.cn/post/7576907627018092595</guid>    <pubDate>2025-11-27T03:47:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576907627018092595" data-draft-id="7576918517237153842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Amazon Bedrock助力飞书深诺电商广告分类"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-27T03:47:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Amazon Bedrock助力飞书深诺电商广告分类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:47:17.000Z" title="Thu Nov 27 2025 03:47:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcc59044cf43480fb3a1d998778739ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=isiwpbbUx7tp5WWhzaC6LT2j7ME%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">项目背景</h2>
<p>飞书深诺是中国领先的出海数字营销企业，专注为中国企业提供一站式海外数字营销解决方案，每年管理300亿人民币广告预算，服务近10万家企业出海，产品销往全球230多个国家和地区。其中Datahub 是飞书深诺技术产品事业群数据中台部门，依托飞书深诺独家资源构建的行业大数据底座，多年来为公司多部门提供支撑服务。电商广告行业分类作为数据基础能力建设的一部分，在行业benchmark、账户/站点/签约主体的行业判断等场景中起到关键作用。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fbedrock%2F" target="_blank" title="https://aws.amazon.com/cn/bedrock/" ref="nofollow noopener noreferrer">Amazon Bedrock</a> 是一项完全托管的服务，通过 API 提供来自Amazon、 AI21 Labs、Anthropic、Cohere、Meta、Mistral AI、Stability AI 等领先人工智能公司的高性能基础模型（FM），并提供通过安全性、隐私性和负责任的人工智能构建生成式人工智能应用程序所需的一系列广泛功能。</p>
<p>2024年以前，飞书深诺广告分类的技术方案主要依托于自行训练的深度学习模型。为提升模型学习效率并降低模型迭代成本，2024年起，从传统深度学习模式切换为多模态大语言模型识别模式，采用由亚马逊云科技提供的 Claude Sonnet 3.5/3.7 以及Nova模型，达成了同步降本和准确识别的目标。</p>
<blockquote>
<p>📢限时插播：无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。</p>
<p>⏩快快点击进入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejinhead_0606%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejinhead_0606" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejinhead_0606&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejinhead_0606" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》实验构建无限, 探索启程！</p>
</blockquote>
<h2 data-id="heading-1">解决方案设计</h2>
<h3 data-id="heading-2">广告分类任务</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f4e06854ee14fd2a2564a2f63efce5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=TL69olCldQ22Z2GtEQOlzJLLUXw%3D" alt="" loading="lazy"/></p>
<p>广告分类任务涉及分析各种广告素材（图像、视频、文本）并将其分类到特定的行业类别中。这有助于更好地理解市场细分、竞争对手分析和有针对性的广告策略。</p>
<p>而广告素材来源于不同的广告客户，有着不同的类型与风格。广告素材由于投放的渠道，投放的展示位置不同，有着不同的类型和尺寸大小。为了方便下游业务系统进行分析，需要对这些不同的广告素材进行统一处理，因此需要引入统一的分类类目，然后使用多模态模型对广告素材进行处理，归类到统一的分类类目中。</p>
<h3 data-id="heading-3">详细解决方案</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dde3ac6588d47e084f2ccb63aa1202a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=RcVQslKu3znsGR5GI0WSaUszriA%3D" alt="" loading="lazy"/></p>
<p>我们的解决方案采用三阶段流水线架构，充分发挥亚马逊云科技生成式AI服务的优势，实现从原始素材到精准分类的全流程自动化处理。这种三阶段架构设计既保证了处理效率，又确保了分类精度，为飞书深诺的广告业务提供了强有力的技术支撑。</p>
<h4 data-id="heading-4">第一阶段：数据输入与预处理</h4>
<p>广告系统的入口环节，系统首先接收来自客户的多样化广告素材，包括视频、图片和文本等不同类型。随后，通过智能路由技术自动识别并分类这些素材的类型，为每种素材确定最合适的处理路径。接下来，系统对各种格式的素材执行标准化预处理操作，如视频长度调整、格式转换、尺寸调整、或文本规范化等，最终将所有素材转化为统一的数据格式，为后续的分析和处理阶段奠定基础。</p>
<p><strong>Amazon Nova模型系列对于图片和视频的要求</strong></p>
<p>Amazon Nova 模型配备了新颖的视觉功能，使该模型能够理解和分析图像和视频。提供的图像或视频质量越高，模型准确理解媒体文件中信息的机会就越大。确保图像或视频清晰，且没有过多的模糊或像素化，以保证更准确的结果。如果图像或视频帧包含重要的文本信息，请确认文本清晰且不要太小。避免仅仅为了放大文本而剪掉关键视觉上下文。</p>
<p>Amazon Nova 模型允许您在有效载荷中包含多张图像。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Fnova%2Flatest%2Fuserguide%2Fprompting-video-understanding.html" target="_blank" title="https://docs.aws.amazon.com/nova/latest/userguide/prompting-video-understanding.html" ref="nofollow noopener noreferrer">总有效载荷大小不能超过 25 MB</a>。Amazon Nova 模型可以分析传递的图像并回答问题、对图像进行分类以及根据提供的说明汇总图像。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/465c6e47c15b40a6914ebb90ed34deaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=9gp3eDWUY4d0nnWHfbXqPYeqNlg%3D" alt="" loading="lazy"/></p>
<p>Amazon  Nova 模型允许您在有效载荷中包含单个视频，可采用 base64 格式提供，也可以通过 Amazon S3 URI 提供。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Fnova%2Flatest%2Fuserguide%2Fmodalities-video.html" target="_blank" title="https://docs.aws.amazon.com/nova/latest/userguide/modalities-video.html" ref="nofollow noopener noreferrer">使用 base64  方法时，总有效载荷大小必须在 25 MB 以内</a>。但是，您可以指定 Amazon S3 URI 来理解图像、视频和文档。使用 Amazon S3  让您能够利用该模型处理更大的文件和多个媒体文件，而不受整体有效载荷大小限制约束。Amazon Nova  可以分析输入视频并回答问题、对视频进行分类，并根据提供的说明汇总视频中的信息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/765392e5d4784e1f827b5cdeedd419ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=fPSA%2BDyl0TyXO8%2FXQ8KeijUviqo%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fc4b49dae9f49e0898464144a310ce7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=FxtXMYJaClNBhWoERcYskf2VL%2FM%3D" alt="" loading="lazy"/></p>
<p>针对不满足Nova处理条件的图片或视频，可先进行预处理，将其格式化为Nova可接受的媒体格式和大小。例如，使用FFmpeg对本地文件进行预处理的示例代码如下：</p>
<pre><code class="hljs language-python" lang="python">Python
<span class="hljs-keyword">import</span> ffmpeg
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">def</span> <span class="hljs-title function_">transform_video</span>(<span class="hljs-params">file_name</span>):

    <span class="hljs-comment"># 获取文件大小（以字节为单位）</span>
    file_size_bytes = os.path.getsize(file_name)
    <span class="hljs-comment"># 将文件大小转换为合适的单位（例如 MB）</span>
    file_size_mb = file_size_bytes / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'视频文件大小为: <span class="hljs-subst">{file_size_mb:<span class="hljs-number">.2</span>f}</span> MB'</span>)
    
    <span class="hljs-comment"># 指定新的输出文件路径和名称</span>
    output_filename = os.path.splitext(os.path.basename(file_name))[<span class="hljs-number">0</span>] + <span class="hljs-string">'_proccessed.mp4'</span>
    output_path = <span class="hljs-string">"media/"</span> + output_filename

    <span class="hljs-comment"># 检查输出文件是否已存在</span>
    <span class="hljs-keyword">if</span> os.path.isfile(output_path):
        <span class="hljs-comment"># 如果文件存在,则删除旧文件</span>
        os.remove(output_path)

    <span class="hljs-comment"># 如果视频文件过大，超过25MB，则压缩一下</span>
    <span class="hljs-keyword">if</span> file_size_mb &gt; <span class="hljs-number">25</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'视频文件大于25MB，需要压缩\n'</span>)
        <span class="hljs-keyword">try</span>:
            probe = ffmpeg.probe(file_name)

            <span class="hljs-comment"># 检查视频流是否存在</span>
            video_stream = <span class="hljs-built_in">next</span>((stream <span class="hljs-keyword">for</span> stream <span class="hljs-keyword">in</span> probe[<span class="hljs-string">'streams'</span>] <span class="hljs-keyword">if</span> stream[<span class="hljs-string">'codec_type'</span>] == <span class="hljs-string">'video'</span>), <span class="hljs-literal">None</span>)
            <span class="hljs-keyword">if</span> video_stream <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{file_name}</span> does not contain a video stream."</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 获取视频分辨率</span>
                video_width = video_stream[<span class="hljs-string">'width'</span>]
                video_height = video_stream[<span class="hljs-string">'height'</span>]
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Original Video resolution: <span class="hljs-subst">{video_width}</span>x<span class="hljs-subst">{video_height}</span>"</span>)

                <span class="hljs-comment"># 计算新的分辨率(长宽各为原来的一半)</span>
                new_width = video_width // <span class="hljs-number">2</span>
                new_height = video_height // <span class="hljs-number">2</span>

                <span class="hljs-comment"># 设置ffmpeg流</span>
                stream = ffmpeg.<span class="hljs-built_in">input</span>(file_name)

                <span class="hljs-comment"># 设置视频编码器和分辨率</span>
                stream = ffmpeg.<span class="hljs-built_in">filter</span>(stream, <span class="hljs-string">'scale'</span>, new_width, new_height)
                stream = ffmpeg.output(stream, output_path, vcodec=<span class="hljs-string">'libx264'</span>, acodec=<span class="hljs-string">'aac'</span>, f=<span class="hljs-string">'mp4'</span>, crf=<span class="hljs-number">23</span>, preset=<span class="hljs-string">'veryfast'</span>)

                <span class="hljs-comment"># 运行 FFmpeg 命令</span>
                ffmpeg.run(stream, overwrite_output=<span class="hljs-literal">True</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f'视频压缩成功,输出文件: <span class="hljs-subst">{output_path}</span>'</span>)

        <span class="hljs-keyword">except</span> ffmpeg.Error <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Error: <span class="hljs-subst">{e.stderr}</span>"</span>, e.stdout)

    <span class="hljs-comment"># 如果视频格文件编码为 Nova不支持的类型，尝试转为 Nova 支持的编码H264</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'视频文件大小OK，直接转成H264'</span>)

        <span class="hljs-comment"># 设置ffmpeg流</span>
        stream = ffmpeg.<span class="hljs-built_in">input</span>(file_name)
        stream = ffmpeg.output(stream, output_path, vcodec=<span class="hljs-string">'libx264'</span>, acodec=<span class="hljs-string">'aac'</span>, f=<span class="hljs-string">'mp4'</span>)

        <span class="hljs-comment"># 运行ffmpeg命令</span>
        ffmpeg.run(stream)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Video converted to H.264 and saved as <span class="hljs-subst">{output_path}</span>'</span>)
    
    <span class="hljs-comment"># 返回新的处理后的文件全路径</span>
    <span class="hljs-keyword">return</span> output_path
</code></pre>
<h4 data-id="heading-5">第二阶段：多模态理解</h4>
<p>在第一阶段，使用多模态大语言模型对广告素材内容进行描述，接收视频、图片、文本三种主要类型的素材。大语言模型能够处理并理解这些内容，并生成内容描述与总结文本。</p>
<p>Amazon Nova模型能够处理文本、图像、视频等多种模态的数据，可以直接输出综合描述。系统能够识别这些不同类型的素材，并进行初步的内容理解和特征提取。我们可以将广告素材直接输入到Nova模型对视频、图像内容进行理解。</p>
<p>Nova通过sdk可以能够直接处理视频片段，例如针对本地视频理解，使用到的参考提示词和示例代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">Python
import base64
import boto3
import json

def video_understanding(file_name):
    <span class="hljs-comment"># Create a Bedrock Runtime client in the AWS Region of your choice.</span>
    <span class="hljs-attr">client</span> = boto3.client(
        "bedrock-runtime",
        <span class="hljs-attr">region_name</span>=<span class="hljs-string">"us-east-1"</span>,
    )

    <span class="hljs-attr">MODEL_ID</span> = <span class="hljs-string">"us.amazon.nova-lite-v1:0"</span>

    <span class="hljs-comment"># Open the image you'd like to use and encode it as a Base64 string.</span>
    with open(file_name, "rb") as video_file:
        <span class="hljs-attr">binary_data</span> = video_file.read()
        <span class="hljs-attr">base_64_encoded_data</span> = base64.b64encode(binary_data)
        <span class="hljs-attr">base64_string</span> = base_64_encoded_data.decode(<span class="hljs-string">"utf-8"</span>)
    <span class="hljs-comment"># Define your system prompt(s).</span>
    <span class="hljs-attr">system_list</span>= [
        {
            <span class="hljs-string">"text"</span>: <span class="hljs-string">"You are a expert to understand advertising video materials."</span>
        }
    ]
    <span class="hljs-comment"># Define a "user" message including both the image and a text prompt.</span>
    <span class="hljs-attr">message_list</span> = [
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"content"</span>: [
                {
                    <span class="hljs-string">"video"</span>: {
                        <span class="hljs-string">"format"</span>: <span class="hljs-string">"mp4"</span>,
                        <span class="hljs-string">"source"</span>: {<span class="hljs-string">"bytes"</span>: base64_string},
                    }
                },
                {
                    <span class="hljs-string">"text"</span>: <span class="hljs-string">"Please understand and describe the information in the video, focusing on the product info to classify the product. Within 100 words."</span>
                },
            ],
        }
    ]
    <span class="hljs-comment"># Configure the inference parameters.</span>
    <span class="hljs-attr">inf_params</span> = {<span class="hljs-string">"maxTokens"</span>: <span class="hljs-number">3000</span>, <span class="hljs-string">"topP"</span>: <span class="hljs-number">0.1</span>, <span class="hljs-string">"topK"</span>: <span class="hljs-number">20</span>, <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.3</span>}

    <span class="hljs-attr">native_request</span> = {
        "schemaVersion": "messages-v1",
        "messages": message_list,
        "system": system_list,
        "inferenceConfig": inf_params,
    }
    <span class="hljs-comment"># Invoke the model and extract the response body.</span>
    <span class="hljs-attr">response</span> = client.invoke_model(modelId=MODEL_ID, body=json.dumps(native_request))
    <span class="hljs-attr">model_response</span> = json.loads(response[<span class="hljs-string">"body"</span>].read())
    <span class="hljs-comment"># Pretty print the response JSON.</span>
    print("<span class="hljs-section">[Full Response]</span>")
    print(json.dumps(model_response, <span class="hljs-attr">indent</span>=<span class="hljs-number">2</span>))
    <span class="hljs-comment"># Print the text content for easy readability.</span>
    <span class="hljs-attr">content_text</span> = model_response[<span class="hljs-string">"output"</span>][<span class="hljs-string">"message"</span>][<span class="hljs-string">"content"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"text"</span>]
    print("\n<span class="hljs-section">[Response Content Text]</span>")
    print(content_text)
    
    return content_text
</code></pre>
<p>针对视频文件过大（大于25MB），或者文件已保存在Amazon S3中的视频，可直接指定其来源为S3，无须本地再下载，直接读取S3并理解的示例代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">Python
import base64
import boto3
import json

def video_understanding_for_s3(s3_uri):
    
    <span class="hljs-comment"># 创建 STS 客户端</span>
    <span class="hljs-attr">sts_client</span> = boto3.client(<span class="hljs-string">'sts'</span>)

    <span class="hljs-comment"># 获取账户 ID</span>
    <span class="hljs-attr">account_id</span> = sts_client.get_caller_identity()[<span class="hljs-string">'Account'</span>]
    
    
    <span class="hljs-comment"># Create a Bedrock Runtime client in the AWS Region of your choice.</span>
    <span class="hljs-attr">client</span> = boto3.client(
        "bedrock-runtime",
        <span class="hljs-attr">region_name</span>=<span class="hljs-string">"us-east-1"</span>,
    )

    <span class="hljs-attr">MODEL_ID</span> = <span class="hljs-string">"us.amazon.nova-lite-v1:0"</span>
    <span class="hljs-comment"># Define your system prompt(s).</span>
    <span class="hljs-attr">system_list</span> = [
        {
            <span class="hljs-string">"text"</span>: <span class="hljs-string">"You are a expert to understand advertising video materials."</span>
        }
    ]
    <span class="hljs-comment"># Define a "user" message including both the image and a text prompt.</span>
    <span class="hljs-attr">message_list</span> = [
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"content"</span>: [
                {
                    <span class="hljs-string">"video"</span>: {
                        <span class="hljs-string">"format"</span>: <span class="hljs-string">"mp4"</span>,
                        <span class="hljs-string">"source"</span>: {
                            <span class="hljs-string">"s3Location"</span>: {
                                <span class="hljs-string">"uri"</span>: f<span class="hljs-string">"{s3_uri}"</span>, 
                                <span class="hljs-string">"bucketOwner"</span>: f<span class="hljs-string">"{account_id}"</span>
                            }
                        }
                    }
                },
                {
                    <span class="hljs-string">"text"</span>: <span class="hljs-string">"Please understand and describe the information in the video, focusing on the product info to classify the product. Within 100 words."</span>
                }
            ]
        }
    ]
    <span class="hljs-comment"># Configure the inference parameters.</span>
    <span class="hljs-attr">inf_params</span> = {<span class="hljs-string">"maxTokens"</span>: <span class="hljs-number">300</span>, <span class="hljs-string">"topP"</span>: <span class="hljs-number">0.1</span>, <span class="hljs-string">"topK"</span>: <span class="hljs-number">20</span>, <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.3</span>}

    <span class="hljs-attr">native_request</span> = {
        "schemaVersion": "messages-v1",
        "messages": message_list,
        "system": system_list,
        "inferenceConfig": inf_params,
    }
    <span class="hljs-comment"># Invoke the model and extract the response body.</span>
    <span class="hljs-attr">response</span> = client.invoke_model(modelId=MODEL_ID, body=json.dumps(native_request))
    <span class="hljs-attr">model_response</span> = json.loads(response[<span class="hljs-string">"body"</span>].read())
    <span class="hljs-comment"># Pretty print the response JSON.</span>
    print("<span class="hljs-section">[Full Response]</span>")
    print(json.dumps(model_response, <span class="hljs-attr">indent</span>=<span class="hljs-number">2</span>))
    <span class="hljs-comment"># Print the text content for easy readability.</span>
    <span class="hljs-attr">content_text</span> = model_response[<span class="hljs-string">"output"</span>][<span class="hljs-string">"message"</span>][<span class="hljs-string">"content"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"text"</span>]
    print("\n<span class="hljs-section">[Response Content Text]</span>")
    print(content_text)
    return content_text
</code></pre>
<h4 data-id="heading-6">第三阶段：多模态分类</h4>
<p>系统对预处理完成的素材进行深度分析，将广告图片内容与相应的广告语文本进行智能关联和联合分析，从而获取更全面的语义理解。随后，这些关联数据通过标”四级分类模型”的精细化处理流程，层层递进地进行类别划分和特征提取，最终生成详尽的视频理解内容文本，完成对广告素材的全方位分类标注 ，为后续的精准投放奠定数据基础。</p>
<h5 data-id="heading-7">四级分类模型</h5>
<p>电商广告素材存在多种品类，以及大类中包含多级子分类的嵌套分类结构，为了跟各主流电商平台衔接，同时便于SKU管理，现将所有素材统一归为四级分类:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c1c94fff50f45d5931a38f017fe88b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=6l0wL%2Bft1MiwxHmYO7T7FH0VkxU%3D" alt="" loading="lazy"/></p>
<p>针对原始的分类，需要对其格式化，以便于后续输入给LLM进行处理。以下为两种常见的处理方式：</p>
<h5 data-id="heading-8">多级分类-带ID号</h5>
<pre><code class="hljs language-css" lang="css">JSON
<span class="hljs-selector-attr">[  {    <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1"</span>,    <span class="hljs-string">"name"</span>: <span class="hljs-string">"服装"</span>,    <span class="hljs-string">"children"</span>: [      {        <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1"</span>,        <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装"</span>,        <span class="hljs-string">"children"</span>: [          {            <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1-1"</span>,            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装裙装"</span>          },          {            <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1-2"</span>,            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装T恤"</span>          },          {            <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1-3"</span>,            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装外套/大衣"</span>          },          {            <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1-4"</span>,            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装裤装/牛仔裤"</span>          },          {            <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1-5"</span>,            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装西服/套装"</span>          },          {            <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1-6"</span>,            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装衬衫"</span>          },          {            <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1-7"</span>,            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装毛衣/卫衣"</span>          },          {            <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1-8"</span>,            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装睡衣/家居服"</span>          },          {            <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1-9"</span>,            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装丝袜/袜子"</span>          },          {            <span class="hljs-string">"category_id"</span>: <span class="hljs-string">"1-1-10"</span>,            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装-其他"</span>          }        ]</span>
      },
      ...
</code></pre>
<h5 data-id="heading-9">多级分类-不带ID号</h5>
<pre><code class="hljs language-css" lang="css">JSON
<span class="hljs-selector-attr">[  {    <span class="hljs-string">"name"</span>: <span class="hljs-string">"服装"</span>,    <span class="hljs-string">"children"</span>: [      {        <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装"</span>,        <span class="hljs-string">"children"</span>: [          {            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装裙装"</span>          },          {            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装T恤"</span>          },          {            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装外套/大衣"</span>          },          {            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装裤装/牛仔裤"</span>          },          {            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装西服/套装"</span>          },          {            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装衬衫"</span>          },          {            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装毛衣/卫衣"</span>          },          {            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装睡衣/家居服"</span>          },          {            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装丝袜/袜子"</span>          },          {            <span class="hljs-string">"name"</span>: <span class="hljs-string">"女装-其他"</span>          }        ]</span>
      },
      ...
</code></pre>
<p>由于LLM已具备很强的理解能力，以上两种方式对于LLM的理解精度无较大差异。”多级分类-带ID号”的方式，由于保留了ID号，便于同除LLM之外的其他业务代码相衔接；”多级分类-不带ID号”的方式则更简洁，便于节省LLM input token数。可按照实际需求灵活选择。</p>
<p>因Claude Sonnet系列模型具备更强的逻辑推理能力，因此使用Claude 3.7 Sonnet模型做最后的分类处理。同时，考虑到四级分类在每次调用LLM时，都不会变，因此可以考虑利用<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Fbedrock%2Flatest%2Fuserguide%2Fprompt-caching.html" target="_blank" title="https://docs.aws.amazon.com/bedrock/latest/userguide/prompt-caching.html" ref="nofollow noopener noreferrer">Bedrcok Prompt Caching功能</a>，将其分类列表进行缓存，以便加快推理速度，同时节省大量的input token消耗。</p>
<p>使用Claude 3.7 Sonnet模型做分类的参考提示词和示例代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">Python
from botocore.config import Config
import json
import re

<span class="hljs-comment">#role 方式初始化bedrock</span>
<span class="hljs-attr">config</span> = Config(read_timeout=<span class="hljs-number">1000</span>) <span class="hljs-comment"># second</span>
<span class="hljs-attr">bedrock_runtime</span> = boto3.client(<span class="hljs-string">'bedrock-runtime'</span>, config=config)

def generate_message(bedrock_runtime, model_id, system_prompt, messages, max_tokens):

    <span class="hljs-attr">body</span>=json.dumps(
        {
            "anthropic_version": "bedrock-2023-05-31",
            "max_tokens": max_tokens,
            "temperature": 0.1,
            "top_k": 20,
            "top_p": 0.9,
            "system": system_prompt,
            "messages": messages
        }
    )  
    
<span class="hljs-comment">#     print(body)</span>
    <span class="hljs-attr">response</span> = bedrock_runtime.invoke_model(body=body, modelId=model_id)
    <span class="hljs-attr">response_body</span> = json.loads(response.get(<span class="hljs-string">'body'</span>).read())
   
    return response_body


def video_classify(content):

    <span class="hljs-comment"># 打开文件并读取4级分类格式化好的JSON数据</span>
    with open('category_no_id.json', 'r', <span class="hljs-attr">encoding</span>=<span class="hljs-string">'utf-8'</span>) as f:
        <span class="hljs-attr">data</span> = json.load(f)

    <span class="hljs-comment"># 将JSON数据转换为字符串,并去除所有空白字符</span>
    <span class="hljs-attr">category_json</span> = re.sub(r<span class="hljs-string">'\s+'</span>, <span class="hljs-string">''</span>, json.dumps(data, ensure_ascii=<span class="hljs-literal">False</span>,separators=(<span class="hljs-string">','</span>, <span class="hljs-string">':'</span>)))
   
    <span class="hljs-attr">prompt</span>=f<span class="hljs-string">'''
        &lt;class&gt;
        {category_json}
        &lt;/class&gt;
        &lt;instruction&gt;
        1. 你的任务是将给定的广告视频描述&lt;video_description&gt;，准确分类到&lt;class&gt;预定义的1级，2级和3级类别中。
        2. 从上述&lt;class&gt;类别中选择最匹配的1级，2级和3级子类别，需要1，2，3级分类都需要给出，如果无法确定分类，回答"0"。
        3. 请回复完整分类，包括ID，不需要其他解释。
        4. 直接给出答案，无需前言。
        &lt;/instruction&gt;
        &lt;output_format&gt;
        服装|女装|女装裙装
        &lt;/output_format&gt;'''</span>
    
    <span class="hljs-attr">text_video</span> = f<span class="hljs-string">''' 
        &lt;video_description&gt;
        {content}
        &lt;/video_description&gt;
    '''</span>

    <span class="hljs-comment"># 使用prompt caching功能，将不变的分类列表caching住</span>
    <span class="hljs-attr">prompt_final</span> = [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,<span class="hljs-string">"text"</span>: prompt, <span class="hljs-string">"cache_control"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"ephemeral"</span>}}, {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,<span class="hljs-string">"text"</span>: text_video}]

    <span class="hljs-comment"># model_id='anthropic.claude-3-5-sonnet-20240620-v1:0'</span>
    <span class="hljs-attr">model_id</span> = <span class="hljs-string">"us.anthropic.claude-3-7-sonnet-20250219-v1:0"</span>
    <span class="hljs-attr">system_prompt</span> = <span class="hljs-string">"你是一个专业的广告视频内容分类机器人,专门负责分析和分类广告视频。"</span>
    <span class="hljs-attr">max_tokens</span> = <span class="hljs-number">1000</span>
    <span class="hljs-attr">user_message</span> =  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt_final}
    <span class="hljs-attr">messages</span> = [user_message]
    <span class="hljs-comment"># print(messages)</span>
    <span class="hljs-attr">response</span> = generate_message(bedrock_runtime, model_id, system_prompt, messages, max_tokens)
    print(response)
    return response<span class="hljs-section">['content']</span><span class="hljs-section">[0]</span><span class="hljs-section">['text']</span>
</code></pre>
<h4 data-id="heading-10">结果评估</h4>
<p>通过以上方案，我们进行了一系列实验验证，使用多模态Nova Pro模型进行视频理解 + Claude 3.7 Sonnet进行标签分类，并与之前传统的机器学习方法进行了对比。在探索大型模型能力边界的过程中，我们得出了一个关键结论：大型模型并非无所不能。它们能够将成绩较差的偏科学生提升至中上等水平，使他们的表现更加均衡，但不能直接将差学生转变为顶尖学生。</p>
<p>实验数据显示，在图像处理方面，同样的图像和视频样本，在Claude 3.7模型下的识别准确性从传统机器学习方法的44.5%提升至85%。此外，Claude 3.7在推理任务上也表现出明显的准确性提升，特别是在复杂推理能力方面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c780b98368c4b239ccb4b4391583643~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=8MjpNPOWtXaY4QkYoGAYLFXJZrE%3D" alt="" loading="lazy"/></p>
<p>为验证这些发现的稳定性，我们收集了一个月内的 1.1万条数据进行验证，这些数据包括了各种各样的商品细分品类。在随机抽取的103个分类中，约90.3%(93个)呈现上升趋势，仅9.7%(10个)呈现下降趋势，进一步证实了大型模型在涉及众多商品品类的分类任务中，无须任何提前训练，在绝大部分的分类任务中，表现都优于传统机器学习方法，表现出很好的准确率与稳定性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aab4ec64a1f34879bb0b102db6657f29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=rIBcwSAewf1a6vgpSGKsrYNk%2Ff4%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9bd8fbb872643fe805d0acd8c5a3195~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=ccvfuCdO33C%2FwdBGWntd75yv%2B5U%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">模型可持续性保障</h3>
<p>在模型上线后，我们需要持续关注模型的运行状况，要达到如下目标：</p>
<ul>
<li>自动化监控：减少人工干预，通过机器实时检测异常。</li>
<li>长期稳定性：确保线上结果的可靠性，避免因数据更新造成偏差。</li>
<li>快速响应：发现异常时能自动告警或触发回滚机制。</li>
</ul>
<p>我们采用ABB（A-B-B）监控策略，通过部署一个主模型（A）和两个次模型（B1、B2）来确保分类结果的可靠性。这种策略基于模型集成的思想，通过多模型一致性检查来提高整体系统的准确性和稳定性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c2d1367a3614f35a76f3d5c1c7f325c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=gcyot%2F2E0J5e42HTAlZWaFhmjg4%3D" alt="" loading="lazy"/></p>
<p>通过以上策略，实现不同类型素材，可以调用在各自类型上表现最佳之模型，以达到强强联合的效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bdd3f9d86a4462d95bf17245fb24d43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=HRk0jJWjyGEjOri9uLDCI3uaSoA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">总结与展望</h2>
<p>飞书深诺通过引入基于 Amazon Bedrock平台提供的Claude与Nova多模态生成式AI解决方案，成功实现了电商广告分类的技术升级。实验数据验证了基于生成式AI解决方案的卓越性能，准确率从传统机器学习方法的44.5%提升至85%，在1.1万条数据的验证中，90.3%的分类呈现上升趋势。特别是Amazon Nova模型在视频理解方面的出色表现，以及Claude 3.7 Sonnet在复杂推理任务上的优异能力，为项目成功提供了关键支撑。通过ABB监控策略，系统运行稳定性得到了有效保障，同时实现了降本增效的双重目标。</p>
<p>未来，飞书深诺将继续深化与亚马逊云科技的合作，探索Amazon Bedrock平台更多前沿AI能力，进一步打造垂直行业专家模型，完善基于亚马逊云科技的MLOps流程，增强多模态内容理解能力，为客户提供更高性价比、可扩展、少干预的智能内容理解中台，助力中国企业在全球市场取得更大成功。</p>
<p>*<em>前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</em></p>
<p><strong>本篇作者</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dab5ba5f098443c488a90519fddfd6ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764820113&amp;x-signature=Eb5tD5Dga44Lva5h3hp2mYvcQ2I%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本期最新实验《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejintail_0415%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0415" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejintail_0415&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0415" ref="nofollow noopener noreferrer">多模一站通 —— Amazon Bedrock 上的基础模型初体验</a>》</p>
<p>✨ 精心设计，旨在引导您深入探索Amazon Bedrock的模型选择与调用、模型自动化评估以及安全围栏(Guardrail)等重要功能。无需管理基础设施，利用亚马逊技术与生态，快速集成与部署生成式AI模型能力。</p>
<p>⏩️[<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.amazoncloud.cn%2Fexperience%2Fcloudlab%3Fid%3D6695e4c5e1432f239fae485f%26visitfrom%3D3P_Juejintail_0415%26sc_medium%3Downed%26sc_campaign%3Dcloudlab%26sc_channel%3D3P_Juejintail_0415" target="_blank" title="https://dev.amazoncloud.cn/experience/cloudlab?id=6695e4c5e1432f239fae485f&amp;visitfrom=3P_Juejintail_0415&amp;sc_medium=owned&amp;sc_campaign=cloudlab&amp;sc_channel=3P_Juejintail_0415" ref="nofollow noopener noreferrer">点击进入实验</a>] 即刻开启 AI 开发之旅构建无限, 探索启程！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 作用域：从执行机制到块级作用域的演进]]></title>    <link>https://juejin.cn/post/7577201863721353216</link>    <guid>https://juejin.cn/post/7577201863721353216</guid>    <pubDate>2025-11-27T01:23:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577201863721353216" data-draft-id="7576894778572374051" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 作用域：从执行机制到块级作用域的演进"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-27T01:23:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="3秒一个大"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 作用域：从执行机制到块级作用域的演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    3秒一个大
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T01:23:08.000Z" title="Thu Nov 27 2025 01:23:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 作用域：从执行机制到块级作用域的演进</h2>
<p>在 JavaScript 中，作用域是控制变量和函数可见性与生命周期的核心机制。理解作用域不仅能帮助我们写出更可预测的代码，还能规避因变量提升、作用域污染等问题导致的 bugs。本文将结合具体代码示例，从执行机制、变量提升到块级作用域的实现，全面解析 JavaScript 作用域的核心概念。</p>
<h3 data-id="heading-1">一、作用域的本质：变量的 "生存规则"</h3>
<p>作用域指的是程序中定义变量的区域，它决定了变量在哪些地方可以被访问（可见性），以及变量会存在多久（生命周期）。JavaScript 中有三种主要的作用域类型：</p>
<ul>
<li><strong>全局作用域</strong>：在代码的任何地方都能访问，生命周期与页面一致（页面关闭前始终存在）。</li>
<li><strong>函数局部作用域</strong>：仅在函数内部可访问，生命周期随函数执行结束而销毁。</li>
<li><strong>块级作用域</strong>：ES6 新增，在 <code>{}</code> 包裹的块（如 <code>if</code>、<code>for</code>、单独的 <code>{}</code> 等）内部生效，生命周期随块执行结束而销毁。</li>
</ul>
<h3 data-id="heading-2">二、JS 执行机制：编译与执行的 "两步走"</h3>
<p>JavaScript 引擎（如 V8）执行代码分为<strong>编译</strong>和<strong>执行</strong>两个阶段，这一过程直接影响作用域的表现：</p>
<ol>
<li><strong>编译阶段</strong>：引擎会扫描代码，确定变量和函数的声明位置，创建执行上下文（包含变量环境、词法环境等信息）。</li>
<li><strong>执行阶段</strong>：引擎按顺序执行代码，处理变量赋值、函数调用等操作，依赖编译阶段创建的执行上下文。</li>
</ol>
<p>执行上下文是作用域的具体载体，每个函数调用都会创建一个新的执行上下文并压入调用栈，执行完成后出栈并销毁（变量随之回收）。</p>
<h3 data-id="heading-3">三、变量提升：设计缺陷与现象</h3>
<p>早期 JavaScript（ES5 及之前）存在 "变量提升"（hoisting）特性：变量和函数的声明会被 "提升" 到其作用域的顶部，但赋值不会。这是 JS 设计初期为简化实现留下的缺陷，可能导致与直觉不符的结果。</p>
<h4 data-id="heading-4">代码示例：变量提升的表现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">showName</span>(); <span class="hljs-comment">// 输出："函数showName 执行了"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myname); <span class="hljs-comment">// 输出：undefined（变量声明提升，赋值未提升）</span>

<span class="hljs-keyword">var</span> myname = <span class="hljs-string">"路飞"</span>; <span class="hljs-comment">// 变量声明被提升到作用域顶部</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">showName</span>(<span class="hljs-params"/>) { <span class="hljs-comment">// 函数整体被提升</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'函数showName 执行了'</span>);
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aa9d5a771ea44c6b059929fa2568078~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM-enkuS4gOS4quWkpw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811388&amp;x-signature=7Z0ndEVQvEVvoAVCZ%2BKi7m5DV70%3D" alt="image.png" loading="lazy"/></p>
<p><strong>解释</strong>：</p>
<ul>
<li>函数 <code>showName</code> 的声明被完整提升，因此可以在定义前调用。</li>
<li><code>var</code> 声明的 <code>myname</code> 被提升到作用域顶部，但赋值 <code>="路飞"</code> 留在原地，因此执行 <code>console.log(myname)</code> 时为 <code>undefined</code>。</li>
</ul>
<h3 data-id="heading-5">四、全局作用域与函数局部作用域</h3>
<h4 data-id="heading-6">1. 全局作用域</h4>
<p>在函数外声明的变量属于全局作用域，可在任何地方访问。</p>
<h4 data-id="heading-7">2. 函数局部作用域</h4>
<p>在函数内用 <code>var</code>/<code>let</code>/<code>const</code> 声明的变量属于局部作用域，仅在函数内可见。</p>
<h4 data-id="heading-8">代码示例：全局与局部作用域</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> globalVar = <span class="hljs-string">"我是全局变量"</span>; <span class="hljs-comment">// 全局作用域</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">myFunction</span>(<span class="hljs-params"/>){
    <span class="hljs-keyword">var</span> localVar = <span class="hljs-string">"我是局部变量"</span>; <span class="hljs-comment">// 函数局部作用域</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar); <span class="hljs-comment">// 输出："我是全局变量"（可访问全局变量）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(localVar); <span class="hljs-comment">// 输出："我是局部变量"（可访问局部变量）</span>
}
<span class="hljs-title function_">myFunction</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar); <span class="hljs-comment">// 输出："我是全局变量"（全局可见）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(localVar); <span class="hljs-comment">// 报错：localVar is not defined（局部变量外部不可见）</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed65cea1ada04afc9981769141994e9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM-enkuS4gOS4quWkpw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811388&amp;x-signature=XoAqNEoqXM366ZtVtvkW7C2z6ho%3D" alt="image.png" loading="lazy"/></p>
<p><strong>解释</strong>：</p>
<ul>
<li><code>globalVar</code> 在全局作用域声明，因此函数内外都可访问。</li>
<li><code>localVar</code> 在 <code>myFunction</code> 内部声明，属于局部作用域，函数外部访问会报错。</li>
</ul>
<h3 data-id="heading-9">五、块级作用域：ES6 的改进</h3>
<p>ES5 不支持块级作用域，<code>var</code> 声明的变量会 "穿透" <code>if</code>、<code>for</code> 等块结构，导致变量污染。ES6 引入 <code>let</code> 和 <code>const</code>，正式支持块级作用域，变量仅在 <code>{}</code> 内部有效。</p>
<h4 data-id="heading-10">1. var 无块级作用域的问题</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> name = <span class="hljs-string">"流萤"</span>; <span class="hljs-comment">// 全局变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">showName</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name); <span class="hljs-comment">// 输出：undefined（var声明的name被提升到函数顶部）</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-literal">true</span>){ 
        <span class="hljs-keyword">var</span> name = <span class="hljs-string">"大厂的苗子"</span>; <span class="hljs-comment">// var无块级作用域，声明被提升到函数作用域</span>
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name); <span class="hljs-comment">// 输出："大厂的苗子"（块内赋值影响函数内变量）</span>
}
<span class="hljs-title function_">showName</span>();
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb1f6e848f8f4520b287994321b00ecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM-enkuS4gOS4quWkpw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811388&amp;x-signature=U9HS%2FNx4wOFVLyKvHdGGMXvEI6I%3D" alt="image.png" loading="lazy"/></p>
<p><strong>解释</strong>：<code>var</code> 声明的 <code>name</code> 会被提升到 <code>showName</code> 函数作用域顶部（而非块级作用域），因此第一次打印时变量已声明但未赋值（<code>undefined</code>），块内赋值后函数内的 <code>name</code> 被覆盖。</p>
<h4 data-id="heading-11">2. let 支持块级作用域</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> name = <span class="hljs-string">"流萤"</span>; <span class="hljs-comment">// 全局变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">showName</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name); <span class="hljs-comment">// 输出：流萤</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-literal">false</span>){ 
        <span class="hljs-keyword">let</span> name = <span class="hljs-string">"大厂的苗子"</span>; <span class="hljs-comment">// let有块级作用域，仅在if块内有效</span>
    }
}
<span class="hljs-title function_">showName</span>();
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/412cc6d543254760aacd72d1eb9a4824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM-enkuS4gOS4quWkpw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811388&amp;x-signature=rfx3mKhxsDlL5Qv73FeVoIk4OjM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>解释</strong>：<code>let</code> 声明的 <code>name</code> 被限制在 <code>if</code> 块级作用域内，函数作用域中不存在该变量。但由于 "暂时性死区"（let 变量声明前不可访问），函数内打印 <code>name</code> 时会向上查找全局 <code>name</code>。</p>
<h4 data-id="heading-12">3. 暂时性死区</h4>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">name</span> = <span class="hljs-string">'流萤'</span><span class="hljs-comment">;</span>
{
    console.log(name)<span class="hljs-comment">; // 报错：Cannot access 'name' before initialization</span>
    let <span class="hljs-attr">name</span> = <span class="hljs-string">'大厂的苗子'</span><span class="hljs-comment">; // let声明触发暂时性死区</span>
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ee41e75d4dc4c528c8ff37aaa08244f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM-enkuS4gOS4quWkpw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811388&amp;x-signature=ItrpEkjhEux3AzXIXhzDkZ%2FRBJo%3D" alt="image.png" loading="lazy"/></p>
<p><strong>解释</strong>：块内用 <code>let</code> 声明 <code>name</code> 后，整个块会形成 "暂时性死区"，在 <code>let</code> 声明前访问 <code>name</code> 会直接报错（即使外部有同名全局变量）。这避免了变量提升导致的意外覆盖。</p>
<h3 data-id="heading-13">六、for 循环中的块级作用域</h3>
<p><code>for</code> 循环是块级作用域的典型场景，<code>let</code> 和 <code>var</code> 的表现差异显著：</p>
<pre><code class="hljs language-css" lang="css">function foo() {
    // 若用<span class="hljs-selector-tag">var</span>声明<span class="hljs-selector-tag">i</span>：
    // for(<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;<span class="hljs-number">7</span>;<span class="hljs-selector-tag">i</span>++){} 
    // console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">i</span>); // 输出<span class="hljs-number">7</span>（<span class="hljs-selector-tag">var</span>无块级作用域，<span class="hljs-selector-tag">i</span>泄漏到函数作用域）

    // 用let声明<span class="hljs-selector-tag">i</span>：
    for(let <span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>;<span class="hljs-selector-tag">i</span>&lt;<span class="hljs-number">7</span>;<span class="hljs-selector-tag">i</span>++){} 
    console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">i</span>); // 报错：<span class="hljs-selector-tag">i</span> is not defined（let限制<span class="hljs-selector-tag">i</span>在for块内）
}
foo();
</code></pre>
<p><strong>解释</strong>：</p>
<ul>
<li><code>var</code> 声明的 <code>i</code> 会穿透 <code>for</code> 循环块，泄漏到函数作用域，循环结束后仍可访问（值为 7）。</li>
<li><code>let</code> 声明的 <code>i</code> 被限制在 <code>for</code> 块级作用域内，循环外访问会报错，避免了变量泄漏。</li>
</ul>
<h3 data-id="heading-14">七、执行上下文视角：var 与 let 的 "一国两制"</h3>
<p>ES6 为了兼容旧代码，采用了 "一国两制" 的处理方式：在执行上下文中，<code>var</code> 和 <code>let</code> 被分别存储在不同区域：</p>
<ul>
<li><strong>变量环境</strong>：存储 <code>var</code> 声明的变量（支持变量提升，无块级作用域）。</li>
<li><strong>词法环境</strong>：存储 <code>let</code>/<code>const</code> 声明的变量（支持块级作用域，有暂时性死区），内部维护一个栈结构，块级作用域执行时入栈，执行完出栈。</li>
</ul>
<h4 data-id="heading-15">代码示例：var 与 let 的作用域混合</h4>
<pre><code class="hljs language-ini" lang="ini">function foo (){
    var <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">; // 存储在变量环境（函数作用域）</span>
    let <span class="hljs-attr">b</span> = <span class="hljs-number">2</span><span class="hljs-comment">; // 存储在词法环境（函数作用域）</span>
    {
        let <span class="hljs-attr">b</span> = <span class="hljs-number">3</span><span class="hljs-comment">; // 词法环境栈顶（块级作用域）</span>
        var <span class="hljs-attr">c</span> = <span class="hljs-number">4</span><span class="hljs-comment">; // 变量环境（函数作用域，穿透块）</span>
        let <span class="hljs-attr">d</span> = <span class="hljs-number">5</span><span class="hljs-comment">; // 词法环境栈顶（块级作用域）</span>
        console.log(a)<span class="hljs-comment">; // 1（访问变量环境的a）</span>
        console.log(b)<span class="hljs-comment">; // 3（访问词法环境栈顶的b）</span>
    }
    console.log(b)<span class="hljs-comment">; // 2（词法环境栈顶出栈，访问函数作用域的b）</span>
    console.log(c)<span class="hljs-comment">; // 4（变量环境的c，块外可访问）</span>
    console.log(d)<span class="hljs-comment">; // 报错：d is not defined（词法环境栈顶出栈，d已销毁）</span>
}
foo()<span class="hljs-comment">;</span>
</code></pre>
<p><strong>解释</strong>：</p>
<ul>
<li><code>var</code> 声明的 <code>a</code> 和 <code>c</code> 存储在变量环境，属于函数作用域，块内外均可访问。</li>
<li><code>let</code> 声明的 <code>b</code>（函数内）和 <code>b</code>（块内）、<code>d</code> 存储在词法环境的栈结构中：块执行时，块内 <code>b</code> 和 <code>d</code> 入栈，优先访问栈顶变量；块执行完后栈顶出栈，函数内的 <code>b</code> 恢复可见，<code>d</code> 则被销毁。</li>
</ul>
<h3 data-id="heading-16">八、总结</h3>
<p>JavaScript 作用域的发展反映了语言的进化：从 ES5 仅有全局和函数作用域、依赖变量提升的简单设计，到 ES6 引入块级作用域、通过 <code>let</code>/<code>const</code> 解决变量污染问题。核心要点包括：</p>
<ol>
<li>作用域控制变量的可见性和生命周期（全局、函数、块级）。</li>
<li>变量提升是 ES5 的设计缺陷，<code>var</code> 声明的变量会被提升到作用域顶部。</li>
<li>ES6 的 <code>let</code>/<code>const</code> 通过块级作用域和暂时性死区解决了变量提升的问题。</li>
<li>执行上下文中的变量环境（<code>var</code>）和词法环境（<code>let</code>/<code>const</code>）实现了新旧特性的兼容。</li>
<li>在实际开发中，建议优先使用 <code>let</code>/<code>const</code> 替代 <code>var</code>，利用块级作用域减少变量污染，写出更可靠的代码。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3使用vuedraggable实现拖拽排序]]></title>    <link>https://juejin.cn/post/7576859594360487936</link>    <guid>https://juejin.cn/post/7576859594360487936</guid>    <pubDate>2025-11-27T01:21:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576859594360487936" data-draft-id="7576867727719022627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3使用vuedraggable实现拖拽排序"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T01:21:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="琦遇"/> <meta itemprop="url" content="https://juejin.cn/user/2612889042300814"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3使用vuedraggable实现拖拽排序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612889042300814/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    琦遇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T01:21:08.000Z" title="Thu Nov 27 2025 01:21:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">安装依赖</h3>
<pre><code class="hljs language-npm" lang="npm">npm install vuedraggable@next
</code></pre>
<h3 data-id="heading-1">引入组件</h3>
<pre><code class="hljs language-vue" lang="vue">import draggable from 'vuedraggable'
</code></pre>
<h3 data-id="heading-2">基础用法</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;draggable v-model="innerList" item-key="props" handle=".sort-icon" :disabled="false" :animation="300"&gt;
        &lt;template #item="{ element }"&gt;
            &lt;div class="flexAlign"&gt;
                &lt;div class="sort-icon" style="margin-right: 5px;cursor: pointer;font-size: 18px;"&gt;⠿&lt;/div&gt;
                {{ element.label }}
            &lt;/div&gt;
        &lt;/template&gt;
    &lt;/draggable&gt;
&lt;/template&gt;

&lt;script setup&gt;
    import draggable from 'vuedraggable';
    const innerList = ref([
        {label:"名称"}
    ])
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-3">常用属性说明</h3>













































<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>​<code>v-model</code>​</td><td>Array</td><td>绑定数组，拖拽后自动更新顺序</td></tr><tr><td>​<code>item-key</code>​</td><td>String</td><td>每个 item 的唯一 key</td></tr><tr><td>​<code>tag</code>​</td><td>String</td><td>渲染的容器标签，默认<code>div</code>​</td></tr><tr><td>​<code>group</code>​</td><td>String/Object</td><td>分组设置，支持跨列表拖拽</td></tr><tr><td>​<code>disabled</code>​</td><td>Boolean</td><td>是否禁用拖拽</td></tr><tr><td>​<code>handle</code>​</td><td>String</td><td>拖拽手柄选择器</td></tr><tr><td>​<code>animation</code>​</td><td>Number</td><td>拖拽的动画过渡时间</td></tr></tbody></table>
<h3 data-id="heading-4">事件名</h3>



































<table><thead><tr><th>事件名</th><th>说明</th><th>参数</th></tr></thead><tbody><tr><td>​<code>@start</code>​</td><td>拖拽开始</td><td>​<code>event</code>​</td></tr><tr><td>​<code>@end</code>​</td><td>拖拽完成</td><td>​<code>event</code>​</td></tr><tr><td>​<code>@change</code>​</td><td>列表顺序发生变化</td><td>​<code>{ moved: { oldIndex, newIndex } }</code>​</td></tr><tr><td>​<code>@add</code>​</td><td>从别的列表添加到当前</td><td>​<code>event</code>​</td></tr><tr><td>​<code>@remove</code>​</td><td>当前列表被移除元素</td><td>​<code>event</code>​</td></tr></tbody></table>
<h2 data-id="heading-5">实战进阶场景</h2>
<h3 data-id="heading-6">拖拽手柄限制（只能通过图标拖动）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">draggable</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"list"</span> <span class="hljs-attr">item-key</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">handle</span>=<span class="hljs-string">".sort-icon"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">item</span>=<span class="hljs-string">"{ element }"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sort-icon"</span>&gt;</span>⠿<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      {{ element.name }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">draggable</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">禁用某项拖动</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">draggable</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"list"</span> <span class="hljs-attr">item-key</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">:move</span>=<span class="hljs-string">"checkMove"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"logChange"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">draggable</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkMove</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-keyword">return</span> !e.<span class="hljs-property">draggedContext</span>.<span class="hljs-property">element</span>.<span class="hljs-property">fixed</span>
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">logChange</span> = (<span class="hljs-params">e</span>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">跨列表拖拽</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;draggable <span class="hljs-attr">v-model</span>=<span class="hljs-string">"list1"</span> item-key=<span class="hljs-string">"id"</span> group=<span class="hljs-string">"all"</span>&gt;
  ...
&lt;/draggable&gt;

&lt;draggable <span class="hljs-attr">v-model</span>=<span class="hljs-string">"list2"</span> item-key=<span class="hljs-string">"id"</span> group=<span class="hljs-string">"all"</span>&gt;
  ...
&lt;/draggable&gt;
</code></pre>
<p>也可以使用对象方式更灵活控制：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">group="{</span> <span class="hljs-attr">name:</span> <span class="hljs-string">'all'</span><span class="hljs-string">,</span> <span class="hljs-attr">pull:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span> <span class="hljs-attr">put:</span> <span class="hljs-literal">true</span> <span class="hljs-string">}"</span>
</code></pre>
<hr/>
<h3 data-id="heading-9">嵌套拖拽（如树形结构）</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;draggable <span class="hljs-attr">v-model</span>=<span class="hljs-string">"tabList"</span> item-key=<span class="hljs-string">"id"</span>&gt;
  &lt;template <span class="hljs-comment">#item="{ element }"&gt;</span>
    &lt;div&gt;{{ element.name }}&lt;/div&gt;
    &lt;draggable
      <span class="hljs-attr">v-if</span>=<span class="hljs-string">"element.children"</span>
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"element.children"</span>
      <span class="hljs-attr">item-key</span>=<span class="hljs-string">"id"</span>
      :<span class="hljs-attr">group</span>=<span class="hljs-string">"{ name: 'all' }"</span>
    &gt;
      &lt;template <span class="hljs-comment">#item="{ element }"&gt;</span>
        &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;{{ element.name }}&lt;/div&gt;
      &lt;/template&gt;
    &lt;/draggable&gt;
  &lt;/template&gt;
&lt;/draggable&gt;
</code></pre>
<hr/>
<h2 data-id="heading-10">示例：拖拽后保存顺序</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"save"</span>&gt;</span>保存顺序<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">draggable</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"list"</span> <span class="hljs-attr">item-key</span>=<span class="hljs-string">"id"</span> @<span class="hljs-attr">end</span>=<span class="hljs-string">"save"</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">save</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'新顺序:'</span>, list.<span class="hljs-property">value</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i.<span class="hljs-property">id</span>))
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">常见问题排查</h2>
<ol>
<li>
<p><strong>拖不动？</strong></p>
<ul>
<li>是否设置了 <code>item-key</code>​</li>
<li>是否被 CSS 覆盖了事件（例如 overflow、position）</li>
<li>是否启用了 <code>disabled</code>​ 属性</li>
</ul>
</li>
<li>
<p><strong>拖动异常（闪烁/跳动）？</strong></p>
<ul>
<li>确保子项具有稳定的 <code>key</code>​</li>
<li>不要在拖拽中操作 DOM</li>
</ul>
</li>
<li>
<p><strong>样式塌陷？</strong></p>
<ul>
<li>添加必要的 <code>min-height</code>​、<code>border</code>​ 保持布局正常</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 深度选择器 `:deep` 使用说明]]></title>    <link>https://juejin.cn/post/7577171133432135721</link>    <guid>https://juejin.cn/post/7577171133432135721</guid>    <pubDate>2025-11-27T02:07:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577171133432135721" data-draft-id="7576893180081668138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 深度选择器 `:deep` 使用说明"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T02:07:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="银月流苏"/> <meta itemprop="url" content="https://juejin.cn/user/2242659452206279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 深度选择器 `:deep` 使用说明
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659452206279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    银月流苏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T02:07:05.000Z" title="Thu Nov 27 2025 02:07:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 深度选择器 <code>:deep</code> 使用说明</h2>
<h3 data-id="heading-1">一、基本概念</h3>
<h4 data-id="heading-2">1. 什么是 <code>:deep</code>？</h4>
<p><code>:deep</code> 是 Vue 3 提供的<strong>深度选择器</strong>（Deep Selector），用于在 <code>scoped</code> 样式中穿透到子组件的元素。</p>
<h4 data-id="heading-3">2. 为什么需要 <code>:deep</code>？</h4>
<p>在 Vue 中，<code>&lt;style scoped&gt;</code> 会为每个组件的样式添加唯一的 <code>data-v-*</code> 属性，确保样式只作用于当前组件。但有时候我们需要修改子组件（特别是第三方组件库如 Element Plus）的样式，这时就需要使用 <code>:deep</code> 来穿透样式作用域。</p>
<h3 data-id="heading-4">二、工作原理</h3>
<h4 data-id="heading-5">1. Scoped 样式的作用机制</h4>
<p><strong>普通 scoped 样式：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;style lang="scss" scoped&gt;
.my-class {
    color: red;
}
&lt;/style&gt;
</code></pre>
<p><strong>编译后：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-v-7ba5bd90]</span> <span class="hljs-selector-class">.my-class</span><span class="hljs-selector-attr">[data-v-7ba5bd90]</span> {
    <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<ul>
<li>只会匹配当前组件内的 <code>.my-class</code></li>
<li>不会匹配子组件中的元素</li>
</ul>
<h4 data-id="heading-6">2. 使用 <code>:deep</code> 穿透样式</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;style lang="scss" scoped&gt;
:deep {
    .el-form-item__content {
        align-items: self-start;
    }
}
&lt;/style&gt;
</code></pre>
<p><strong>编译后：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-v-7ba5bd90]</span> <span class="hljs-selector-class">.el-form-item__content</span> {
    <span class="hljs-attribute">align-items</span>: self-start;
}
</code></pre>
<ul>
<li>选择器中的 <code>.el-form-item__content</code> <strong>不会被添加</strong> <code>data-v-*</code> 属性</li>
<li>可以匹配子组件中的 <code>.el-form-item__content</code> 元素</li>
</ul>
<h4 data-id="heading-7">3. 关键区别对比</h4>























<table><thead><tr><th>方式</th><th>编译前</th><th>编译后</th><th>能否匹配子组件</th></tr></thead><tbody><tr><td>普通 scoped</td><td><code>.my-class { }</code></td><td><code>[data-v-xxx] .my-class[data-v-xxx] { }</code></td><td>❌ 否</td></tr><tr><td>使用 <code>:deep</code></td><td><code>:deep { .my-class { } }</code></td><td><code>[data-v-xxx] .el-form-item__content { }</code></td><td>✅ 是</td></tr></tbody></table>
<h3 data-id="heading-8">三、实际应用场景</h3>
<h4 data-id="heading-9">1. 修改 Element Plus 组件样式</h4>
<p><strong>场景：</strong> 修改表格搜索表单中表单项的对齐方式</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;zh-table&gt;
        &lt;!-- zh-table 内部使用 Element Plus 的 el-form-item --&gt;
    &lt;/zh-table&gt;
&lt;/template&gt;

&lt;style lang="scss" scoped&gt;
:deep {
    .el-form-item__content {
        align-items: self-start; /* 顶部对齐 */
    }
}
&lt;/style&gt;
</code></pre>
<p><strong>DOM 结构：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- index.vue 的根元素 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-v-7ba5bd90</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- zh-table 组件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-v-abc123</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-form-item__content"</span>&gt;</span>
                    <span class="hljs-comment">&lt;!-- 👈 被匹配到 --&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>CSS 匹配过程：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 编译后的选择器 */</span>
<span class="hljs-selector-attr">[data-v-7ba5bd90]</span> <span class="hljs-selector-class">.el-form-item__content</span> {
    <span class="hljs-attribute">align-items</span>: self-start;
}

<span class="hljs-comment">/* 匹配过程：
   1. 找到带有 data-v-7ba5bd90 的元素（index.vue 的根元素）
   2. 在该元素的后代中查找 .el-form-item__content
   3. 找到子组件中的 .el-form-item__content 元素
   4. 应用样式
*/</span>
</code></pre>
<h4 data-id="heading-10">2. 修改第三方组件库样式</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;el-input /&gt;
&lt;/template&gt;

&lt;style lang="scss" scoped&gt;
:deep {
    .el-input__wrapper {
        border-radius: 6px;
        background-color: #f5f5f5;
    }

    .el-input__inner {
        height: auto;
        color: #000000e0;
    }
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-11">3. 嵌套使用 <code>:deep</code></h4>
<pre><code class="hljs language-vue" lang="vue">&lt;style lang="scss" scoped&gt;
.zh-default-input {
    :deep {
        .el-input__wrapper {
            border-radius: 6px !important;
        }
        .el-input__inner {
            height: auto;
        }
    }
}
&lt;/style&gt;
</code></pre>
<p><strong>编译后：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-v-xxx]</span> <span class="hljs-selector-class">.zh-default-input</span> <span class="hljs-selector-class">.el-input__wrapper</span> {
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span> <span class="hljs-meta">!important</span>;
}
<span class="hljs-selector-attr">[data-v-xxx]</span> <span class="hljs-selector-class">.zh-default-input</span> <span class="hljs-selector-class">.el-input__inner</span> {
    <span class="hljs-attribute">height</span>: auto;
}
</code></pre>
<h3 data-id="heading-12">四、语法说明</h3>
<h4 data-id="heading-13">1. 基本语法</h4>
<pre><code class="hljs language-scss" lang="scss">:<span class="hljs-built_in">deep</span>(选择器) {
    样式规则
}

<span class="hljs-comment">// 或者使用块语法</span>
:deep {
    选择器 {
        样式规则
    }
}
</code></pre>
<h4 data-id="heading-14">2. 两种写法对比</h4>
<p><strong>写法1：函数式（推荐）</strong></p>
<pre><code class="hljs language-scss" lang="scss">:<span class="hljs-built_in">deep</span>(.el-form-item__content) {
    <span class="hljs-attribute">align-items</span>: self-start;
}
</code></pre>
<p><strong>写法2：块语法</strong></p>
<pre><code class="hljs language-scss" lang="scss">:deep {
    <span class="hljs-selector-class">.el-form-item__content</span> {
        <span class="hljs-attribute">align-items</span>: self-start;
    }
}
</code></pre>
<p><strong>两种写法编译结果相同</strong>，块语法更清晰易读。</p>
<h4 data-id="heading-15">3. 组合使用</h4>
<pre><code class="hljs language-scss" lang="scss">:deep {
    <span class="hljs-selector-class">.el-input__wrapper</span>,
    <span class="hljs-selector-class">.el-textarea__inner</span> {
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span> <span class="hljs-meta">!important</span>;
    }

    <span class="hljs-selector-class">.el-input</span><span class="hljs-selector-class">.is-disabled</span> <span class="hljs-selector-class">.el-input__wrapper</span> {
        <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fafafa</span>;
    }
}
</code></pre>
<h3 data-id="heading-16">五、为什么能找到子组件中的元素？</h3>
<h4 data-id="heading-17">1. CSS 选择器的作用域</h4>
<p><code>:deep</code> 生成的选择器是<strong>后代选择器</strong>（Descendant Selector）：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[data-v-7ba5bd90]</span> <span class="hljs-selector-class">.el-form-item__content</span>
</code></pre>
<p>这个选择器表示：</p>
<ul>
<li>在 <code>data-v-7ba5bd90</code> 元素的后代中</li>
<li>查找 <code>.el-form-item__content</code> 元素</li>
<li><strong>不限制层级</strong>，可以匹配任意深度的后代</li>
</ul>
<h4 data-id="heading-18">2. DOM 树结构</h4>
<pre><code class="hljs language-css" lang="css">index<span class="hljs-selector-class">.vue</span> (data-v-<span class="hljs-number">7</span>ba5bd90)          ← 样式作用域的根
└── zh-<span class="hljs-selector-tag">table</span> (data-v-abc123)         ← 子组件
    └── SearchForm                   ← 子组件的子组件
        └── el-<span class="hljs-selector-tag">form</span>                  ← Element Plus 组件
            └── el-<span class="hljs-selector-tag">form</span>-item
                └── <span class="hljs-selector-class">.el-form-item__content</span>  ← 被匹配到
</code></pre>
<h4 data-id="heading-19">3. 样式穿透机制</h4>
<ul>
<li><code>:deep</code> 让选择器中的目标类<strong>不被添加</strong> <code>data-v-*</code> 属性</li>
<li>因此可以匹配到子组件中的同名类</li>
<li>通过后代选择器在 DOM 树中查找匹配的元素</li>
</ul>
<h3 data-id="heading-20">六、浏览器中的实际效果</h3>
<h4 data-id="heading-21">1. 实际 DOM 结构</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 浏览器渲染后的 DOM --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-v-7ba5bd90</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"..."</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-v-abc123</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-search"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-form table-search--left"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-form-item"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-form-item__content"</span>&gt;</span>
                    <span class="hljs-comment">&lt;!-- 👈 被匹配 --&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-input__inner"</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-22">2. CSS 规则应用</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 编译后的 CSS */</span>
<span class="hljs-selector-attr">[data-v-7ba5bd90]</span> <span class="hljs-selector-class">.el-form-item__content</span> {
    <span class="hljs-attribute">align-items</span>: self-start;
}
</code></pre>
<p><strong>匹配过程：</strong></p>
<ol>
<li>浏览器找到所有带有 <code>data-v-7ba5bd90</code> 属性的元素</li>
<li>在这些元素的后代中查找 <code>.el-form-item__content</code></li>
<li>找到匹配的元素并应用样式</li>
</ol>
<h3 data-id="heading-23">七、注意事项</h3>
<h4 data-id="heading-24">1. 作用域限制</h4>
<p><code>:deep</code> 仍然受到父组件 scoped 的作用域限制：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* ✅ 正确：可以匹配子组件 */</span>
:deep {
    <span class="hljs-selector-class">.el-form-item__content</span> {
        <span class="hljs-attribute">align-items</span>: self-start;
    }
}

<span class="hljs-comment">/* ❌ 错误：无法匹配子组件 */</span>
<span class="hljs-selector-class">.el-form-item__content</span> {
    <span class="hljs-attribute">align-items</span>: self-start; <span class="hljs-comment">/* 只会匹配当前组件 */</span>
}
</code></pre>
<h4 data-id="heading-25">2. 性能考虑</h4>
<p><code>:deep</code> 选择器会遍历整个 DOM 树，应该：</p>
<ul>
<li>✅ <strong>推荐</strong>：使用具体的选择器，减少匹配范围</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">:deep {
    <span class="hljs-selector-class">.el-form-item__content</span> {  <span class="hljs-comment">/* 具体类名 */</span>
        ...
    }
}
</code></pre>
<ul>
<li>⚠️ <strong>避免</strong>：使用过于宽泛的选择器</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">:deep {
    <span class="hljs-selector-tag">div</span> {  <span class="hljs-comment">/* 太宽泛，可能影响很多元素 */</span>
        ...
    }
}
</code></pre>
<h4 data-id="heading-26">3. 优先级问题</h4>
<p><code>:deep</code> 生成的样式优先级可能不够高，必要时使用 <code>!important</code>：</p>
<pre><code class="hljs language-scss" lang="scss">:deep {
    <span class="hljs-selector-class">.el-input__wrapper</span> {
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span> <span class="hljs-meta">!important</span>; <span class="hljs-comment">/* 确保覆盖默认样式 */</span>
    }
}
</code></pre>
<h4 data-id="heading-27">4. 替代方案</h4>
<p>如果只需要修改少量样式，也可以使用：</p>
<p><strong>方案1：不使用 scoped</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;style lang="scss"&gt;
/* 不使用 scoped，样式会全局生效 */
.el-form-item__content {
    align-items: self-start;
}
&lt;/style&gt;
</code></pre>
<p><strong>方案2：使用全局样式文件</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// styles/element.scss</span>
<span class="hljs-selector-class">.el-form-item__content</span> {
    <span class="hljs-attribute">align-items</span>: self-start;
}
</code></pre>
<h3 data-id="heading-28">八、常见使用场景</h3>
<h4 data-id="heading-29">1. 修改 Element Plus 组件样式</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;style lang="scss" scoped&gt;
:deep {
    .el-button {
        border-radius: 6px;
    }

    .el-input__wrapper {
        background-color: #f5f5f5;
    }

    .el-select__wrapper {
        border-radius: 6px;
    }
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-30">2. 修改自定义组件样式</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;zh-table&gt;
        &lt;!-- 需要修改 zh-table 内部的样式 --&gt;
    &lt;/zh-table&gt;
&lt;/template&gt;

&lt;style lang="scss" scoped&gt;
:deep {
    .table-search {
        padding: 16px;
    }

    .el-form-item {
        margin-bottom: 0;
    }
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-31">3. 响应式样式穿透</h4>
<pre><code class="hljs language-scss" lang="scss">:deep {
    <span class="hljs-selector-class">.el-form-item__content</span> {
        <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
            <span class="hljs-attribute">flex-direction</span>: column;
        }
    }
}
</code></pre>
<h3 data-id="heading-32">九、Vue 2 vs Vue 3</h3>
<h4 data-id="heading-33">Vue 2 语法</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* Vue 2 使用 /deep/ 或 &gt;&gt;&gt; */</span>
/deep/ <span class="hljs-selector-class">.el-form-item__content</span> {
    <span class="hljs-attribute">align-items</span>: self-start;
}

<span class="hljs-comment">/* 或者 */</span>
&gt;&gt;&gt; <span class="hljs-selector-class">.el-form-item__content</span> {
    <span class="hljs-attribute">align-items</span>: self-start;
}
</code></pre>
<h4 data-id="heading-34">Vue 3 语法</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* Vue 3 使用 :deep() */</span>
:<span class="hljs-built_in">deep</span>(.el-form-item__content) {
    <span class="hljs-attribute">align-items</span>: self-start;
}

<span class="hljs-comment">/* 或者块语法 */</span>
:deep {
    <span class="hljs-selector-class">.el-form-item__content</span> {
        <span class="hljs-attribute">align-items</span>: self-start;
    }
}
</code></pre>
<h3 data-id="heading-35">十、总结</h3>
<h4 data-id="heading-36"><code>:deep</code> 的核心要点</h4>
<ol>
<li><strong>作用</strong>：穿透 scoped 样式，修改子组件样式</li>
<li><strong>原理</strong>：编译时不为目标选择器添加 <code>data-v-*</code> 属性</li>
<li><strong>机制</strong>：通过后代选择器在 DOM 树中查找匹配元素</li>
<li><strong>使用</strong>：在需要修改子组件样式时使用</li>
<li><strong>注意</strong>：合理使用，避免过度穿透影响性能</li>
</ol>
<h4 data-id="heading-37">最佳实践</h4>
<ol>
<li>✅ 优先使用具体的选择器</li>
<li>✅ 只在必要时使用 <code>:deep</code></li>
<li>✅ 注意样式优先级</li>
<li>✅ 避免过度穿透影响性能</li>
<li>✅ 考虑使用全局样式文件作为替代方案</li>
</ol>
<h4 data-id="heading-38">适用场景</h4>
<ul>
<li>修改第三方组件库（如 Element Plus）的样式</li>
<li>修改自定义子组件的样式</li>
<li>需要保持 scoped 样式隔离的同时修改子组件</li>
</ul>
<p><code>:deep</code> 是 Vue 3 中处理样式穿透的标准方式，理解其工作原理有助于更好地使用和调试样式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[忘掉"发请求"，声明你要的数据：TanStack Query 带来的思维革命]]></title>    <link>https://juejin.cn/post/7576914798056439860</link>    <guid>https://juejin.cn/post/7576914798056439860</guid>    <pubDate>2025-11-27T02:38:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576914798056439860" data-draft-id="7576928310787784756" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="忘掉&quot;发请求&quot;，声明你要的数据：TanStack Query 带来的思维革命"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T02:38:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OLong"/> <meta itemprop="url" content="https://juejin.cn/user/1072754539366318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            忘掉"发请求"，声明你要的数据：TanStack Query 带来的思维革命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1072754539366318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OLong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T02:38:07.000Z" title="Thu Nov 27 2025 02:38:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">声明你要的数据</h2>
<p><strong>使用 TanStack Query 后，你不再需要"发请求"，你只是在"声明数据"。</strong></p>
<p><strong>更重要的是：你不再需要"管理状态"，只需要"消费数据"。</strong></p>
<p>这是一次思维范式的根本转变：</p>
<ul>
<li><strong>传统方式</strong>：你在管理"请求的过程"和"状态的生命周期" - 什么时候发、怎么发、失败了怎么办、要不要重试、loading/error/data 怎么更新</li>
<li><strong>TanStack Query</strong>：你在声明"数据的需求" - 我需要这个数据，剩下的自动处理</li>
</ul>
<p><strong>具体改变：</strong></p>





































<table><thead><tr><th>传统方式</th><th>TanStack Query</th></tr></thead><tbody><tr><td>100 行代码管理一个请求</td><td>20 行代码实现更多功能</td></tr><tr><td>手动定义 useState 管理 loading、error、data</td><td>自动提供完整状态，无需手动管理</td></tr><tr><td>每个组件都要写 loading/error 逻辑</td><td>状态自动同步，写一次到处用</td></tr><tr><td>多组件重复发请求</td><td>自动去重和共享缓存</td></tr><tr><td>手写定时刷新逻辑</td><td>配置即可自动更新</td></tr><tr><td>复杂的乐观更新和回滚</td><td>内置乐观更新机制</td></tr><tr><td>需要 Redux/Context 管理服务器数据</td><td>内置服务器状态管理</td></tr></tbody></table>
<p><strong>结果：代码量减少 80%，状态管理复杂度降低 90%，但功能更强大、更可靠。</strong></p>
<p>你从"请求的搬运工"变成"数据的消费者"，可以将更多精力专注于构建出色的用户体验。</p>
<hr/>
<h3 data-id="heading-1">传统开发的困境：状态管理的噩梦</h3>
<p>当我们谈论前端数据获取时，脑海中总是浮现这样的画面：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 组件挂载时发请求</span>
function <span class="hljs-built_in">UserProfile</span>() {
  const <span class="hljs-selector-attr">[user, setUser]</span> = <span class="hljs-built_in">useState</span>(null)
  const <span class="hljs-selector-attr">[loading, setLoading]</span> = <span class="hljs-built_in">useState</span>(false)
  const <span class="hljs-selector-attr">[error, setError]</span> = <span class="hljs-built_in">useState</span>(null)
  
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-built_in">setLoading</span>(true)
    <span class="hljs-built_in">setError</span>(null)
    
    <span class="hljs-built_in">fetch</span>('/api/user')
      <span class="hljs-selector-class">.then</span>(res =&gt; res.json())
      <span class="hljs-selector-class">.then</span>(data =&gt; {
        setUser(data)
        <span class="hljs-built_in">setLoading</span>(false)
      })
      <span class="hljs-selector-class">.catch</span>(err =&gt; {
        setError(err)
        <span class="hljs-built_in">setLoading</span>(false)
      })
  }, <span class="hljs-selector-attr">[]</span>)
  
  if (loading) return &lt;<span class="hljs-selector-tag">div</span>&gt;Loading...&lt;/<span class="hljs-selector-tag">div</span>&gt;
  if (error) return &lt;<span class="hljs-selector-tag">div</span>&gt;Error: {error<span class="hljs-selector-class">.message</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;
  
  return &lt;<span class="hljs-selector-tag">div</span>&gt;{user?<span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;
}
</code></pre>
<p>这里有两个根深蒂固的思维模式：</p>
<ol>
<li><strong>我们在"发请求"</strong></li>
<li><strong>我们在"管理状态"</strong> - loading、error、data 三个状态要手动定义、手动更新、手动同步</li>
</ol>
<p>每个请求都需要：</p>
<ul>
<li>定义 3 个 useState</li>
<li>在请求前后更新这些状态</li>
<li>处理各种边界情况（取消请求、组件卸载、竞态条件...）</li>
<li>在 JSX 里写一堆条件渲染</li>
</ul>
<p><strong>一个简单的数据获取，就要写 20+ 行样板代码。</strong></p>
<p>更可怕的是，如果多个组件需要同样的数据，你要么：</p>
<ul>
<li>把状态提升到父组件（组件结构被绑架）</li>
<li>用 Context 传递（样板代码更多）</li>
<li>用 Redux/MobX（引入整个状态管理库）</li>
</ul>
<p><strong>但这真的是我们应该关心的吗？我们真正需要的只是那个数据而已。</strong></p>
<h3 data-id="heading-2">范式转变：从"发请求+管理状态"到"访问数据"</h3>
<p><strong>TanStack Query 带来的最大思维转变是：</strong></p>
<ol>
<li><strong>你不再需要"发请求"，你只是在"声明数据"</strong></li>
<li><strong>你不再需要"管理状态"，你只是在"消费数据"</strong></li>
</ol>
<p>看看这段代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: user, isLoading, error } = <span class="hljs-title function_">useQuery</span>({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'user'</span>],
    <span class="hljs-attr">queryFn</span>: fetchUser
  })
  
  <span class="hljs-keyword">if</span> (isLoading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Error: {error.message}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user?.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>注意到了吗？</p>
<ul>
<li>✅ 没有 <code>useEffect</code>，没有手动调用 fetch</li>
<li>✅ 没有 <code>useState</code>，没有手动管理 loading、error、data</li>
<li>✅ 状态自动管理，自动更新，自动同步</li>
</ul>
<p><strong>你只是在说："我需要用户数据"，然后直接用。</strong></p>
<p>至于这个数据：</p>
<ul>
<li>从哪来（缓存？网络？）</li>
<li>什么时候来（现在？稍后？）</li>
<li>状态如何更新（loading → success？loading → error？）</li>
<li>过期了要不要更新</li>
<li>失败了要不要重试</li>
</ul>
<p><strong>这些都不再是你的负担，TanStack Query 会帮你处理。</strong></p>
<blockquote>
<p>不用写 useState，不用写状态更新逻辑，不用担心状态不同步。我只是需要这个数据，状态管理和我有什么关系？</p>
</blockquote>
<h3 data-id="heading-3">数据的"存在性"而非"获取过程"和"状态管理"</h3>
<p>传统方式让我们陷入了"过程式思维"：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 我们关心的是"过程"和"状态"</span>
<span class="hljs-number">1</span>. 定义状态：<span class="hljs-built_in">useState</span>(loading), <span class="hljs-built_in">useState</span>(error), <span class="hljs-built_in">useState</span>(data)
<span class="hljs-number">2</span>. 发起请求：<span class="hljs-built_in">setLoading</span>(true)
<span class="hljs-number">3</span>. 等待响应
<span class="hljs-number">4</span>. 处理结果：<span class="hljs-built_in">setLoading</span>(false), <span class="hljs-built_in">setData</span>() 或 <span class="hljs-built_in">setError</span>()
<span class="hljs-number">5</span>. 在 JSX 中根据状态条件渲染
</code></pre>
<p><strong>这就像你要喝一杯咖啡，却要自己管理咖啡机的每一个零件状态。</strong></p>
<p>而 TanStack Query 让我们回归"声明式思维"：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 我们关心的是"结果"</span>
<span class="hljs-keyword">const</span> { data, isLoading, <span class="hljs-type">error</span> } = useQuery([<span class="hljs-string">'user'</span>], fetchUser)
<span class="hljs-comment">// "用户数据应该存在，请给我"</span>
<span class="hljs-comment">// 状态？TanStack Query 自动管理</span>
</code></pre>
<p><strong>这就像你走进咖啡店，只需要说"我要一杯咖啡"，咖啡师会处理所有细节。</strong></p>
<p>对比：</p>





























<table><thead><tr><th>传统方式</th><th>TanStack Query</th></tr></thead><tbody><tr><td>你是"状态管理员"</td><td>你是"数据消费者"</td></tr><tr><td>手动定义 loading/error/data</td><td>自动提供，直接用</td></tr><tr><td>手动更新每个状态</td><td>自动更新，状态同步</td></tr><tr><td>担心状态不一致</td><td>状态始终一致</td></tr><tr><td>每个组件重复写状态逻辑</td><td>写一次，到处用</td></tr></tbody></table>
<h3 data-id="heading-4">实际场景：威力显现</h3>
<h4 data-id="heading-5">场景一：多组件共享数据（状态同步噩梦）</h4>
<p><strong>传统方式的噩梦</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 组件 A</span>
function <span class="hljs-built_in">ComponentA</span>() {
  const <span class="hljs-selector-attr">[user, setUser]</span> = <span class="hljs-built_in">useState</span>(null)
  const <span class="hljs-selector-attr">[loading, setLoading]</span> = <span class="hljs-built_in">useState</span>(false)
  
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-built_in">setLoading</span>(true)
    <span class="hljs-built_in">fetchUser</span>()<span class="hljs-selector-class">.then</span>(data =&gt; {
      setUser(data)
      <span class="hljs-built_in">setLoading</span>(false)
    })
  }, <span class="hljs-selector-attr">[]</span>)
  
  return &lt;<span class="hljs-selector-tag">div</span>&gt;{user?<span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;
}

<span class="hljs-comment">// 组件 B（同样的数据！）</span>
function <span class="hljs-built_in">ComponentB</span>() {
  const <span class="hljs-selector-attr">[user, setUser]</span> = <span class="hljs-built_in">useState</span>(null)  <span class="hljs-comment">// 又定义一次状态</span>
  const <span class="hljs-selector-attr">[loading, setLoading]</span> = <span class="hljs-built_in">useState</span>(false)
  
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-built_in">setLoading</span>(true)
    <span class="hljs-built_in">fetchUser</span>()<span class="hljs-selector-class">.then</span>(data =&gt; {  // 又发了一次请求
      setUser(data)
      <span class="hljs-built_in">setLoading</span>(false)
    })
  }, <span class="hljs-selector-attr">[]</span>)
  
  return &lt;<span class="hljs-selector-tag">div</span>&gt;{user?<span class="hljs-selector-class">.email</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;
}

<span class="hljs-comment">// 问题：</span>
<span class="hljs-comment">// 1. 发了两次请求</span>
<span class="hljs-comment">// 2. 定义了两套状态</span>
<span class="hljs-comment">// 3. 如果 A 更新了数据，B 不会同步</span>
<span class="hljs-comment">// 4. 需要用 Context 或状态管理库来解决</span>

<span class="hljs-comment">// 你需要：</span>
<span class="hljs-comment">// - Context 传递数据（写一堆 Provider）</span>
<span class="hljs-comment">// - 或者状态提升（破坏组件结构）</span>
<span class="hljs-comment">// - 或者 Redux/MobX（引入整个状态管理体系）</span>
</code></pre>
<blockquote>
<p>为了共享一个数据，要引入整个状态管理库？这也太重了吧...</p>
</blockquote>
<p><strong>TanStack Query 的优雅</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组件 A</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentA</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: user } = <span class="hljs-title function_">useQuery</span>([<span class="hljs-string">'user'</span>], fetchUser)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user?.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-comment">// 组件 B（自动共享！）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentB</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: user } = <span class="hljs-title function_">useQuery</span>([<span class="hljs-string">'user'</span>], fetchUser)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user?.email}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-comment">// 结果：</span>
<span class="hljs-comment">// ✅ 只发一次请求</span>
<span class="hljs-comment">// ✅ 不需要定义任何 useState</span>
<span class="hljs-comment">// ✅ 数据自动共享</span>
<span class="hljs-comment">// ✅ A 组件更新数据，B 组件自动同步</span>
<span class="hljs-comment">// ✅ 不需要 Context、Provider、Redux</span>
</code></pre>
<blockquote>
<p>同一个 queryKey，自动共享数据和状态。不用写 useState，不用担心状态不同步，就这么简单。</p>
</blockquote>
<h4 data-id="heading-6">场景二：数据过期更新</h4>
<p><strong>传统方式</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 30秒后数据可能过期了，需要重新获取吗？</span>
<span class="hljs-comment">// 用户切换标签页回来，需要刷新吗？</span>
<span class="hljs-comment">// 网络重连了，需要更新吗？</span>

<span class="hljs-comment">// 你需要自己写定时器、监听器、重试逻辑……</span>
</code></pre>
<p><strong>TanStack Query</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">const</span> { <span class="hljs-keyword">data</span> } = useQuery([<span class="hljs-string">'user'</span>], fetchUser, {
  staleTime: <span class="hljs-number">30000</span>,  <span class="hljs-comment">// 30秒内是新鲜的</span>
  refetchOnWindowFocus: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 窗口聚焦时更新</span>
  refetchOnReconnect: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 重连时更新</span>
})

<span class="hljs-comment">// 就这样。其他的都自动处理。</span>
</code></pre>
<h4 data-id="heading-7">场景三：乐观更新</h4>
<p><strong>传统方式</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 点赞功能</span>
const handleLike = async () =&gt; {
  <span class="hljs-comment">// 先更新UI</span>
  <span class="hljs-built_in">setLikes</span>(likes + <span class="hljs-number">1</span>)
  
  try {
    await <span class="hljs-built_in">likePost</span>(postId)
  } catch (error) {
    <span class="hljs-comment">// 失败了要回滚</span>
    <span class="hljs-built_in">setLikes</span>(likes - <span class="hljs-number">1</span>)
    <span class="hljs-comment">// 但这时 likes 可能已经被其他操作改变了...</span>
  }
}
</code></pre>
<p><strong>TanStack Query</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> mutation = <span class="hljs-title function_">useMutation</span>(likePost, {
  <span class="hljs-attr">onMutate</span>: <span class="hljs-keyword">async</span> (postId) =&gt; {
    <span class="hljs-comment">// 乐观更新</span>
    queryClient.<span class="hljs-title function_">setQueryData</span>([<span class="hljs-string">'post'</span>, postId], <span class="hljs-function"><span class="hljs-params">old</span> =&gt;</span> ({
      ...old,
      <span class="hljs-attr">likes</span>: old.<span class="hljs-property">likes</span> + <span class="hljs-number">1</span>
    }))
  },
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">err, variables, context</span>) =&gt;</span> {
    <span class="hljs-comment">// 自动回滚到之前的数据</span>
    queryClient.<span class="hljs-title function_">setQueryData</span>([<span class="hljs-string">'post'</span>, postId], context.<span class="hljs-property">previousPost</span>)
  }
})

<span class="hljs-comment">// 失败自动回滚，不需要手动管理</span>
</code></pre>
<h3 data-id="heading-8">心智模型的转变</h3>
<p>使用 TanStack Query 后，你的思考方式会发生根本变化：</p>
<p><strong>以前思考</strong>：</p>
<ul>
<li>❌ "我需要在这里发个请求"</li>
<li>❌ "我要定义 loading、error、data 三个状态"</li>
<li>❌ "请求前设置 loading=true，完成后设置 loading=false"</li>
<li>❌ "要不要显示 loading？"</li>
<li>❌ "数据过期了要重新请求吗？"</li>
<li>❌ "多个组件的状态怎么同步？"</li>
</ul>
<p><strong>现在思考</strong>：</p>
<ul>
<li>✅ "我需要这个数据"</li>
<li>✅ "这个数据的新鲜度要求是什么？"</li>
<li>✅ "数据变化时 UI 应该如何响应？"</li>
</ul>
<p>你从"请求的搬运工"和"状态的管理员"变成了"数据的消费者"。</p>
<h3 data-id="heading-9">代码对比：一目了然</h3>
<h4 data-id="heading-10">传统方式（100行代码）</h4>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">TodoList</span>() {
  const <span class="hljs-selector-attr">[todos, setTodos]</span> = <span class="hljs-built_in">useState</span>([])
  const <span class="hljs-selector-attr">[loading, setLoading]</span> = <span class="hljs-built_in">useState</span>(false)
  const <span class="hljs-selector-attr">[error, setError]</span> = <span class="hljs-built_in">useState</span>(null)
  
  <span class="hljs-comment">// 初始加载</span>
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-built_in">fetchTodos</span>()
  }, <span class="hljs-selector-attr">[]</span>)
  
  <span class="hljs-comment">// 定期刷新</span>
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const interval = <span class="hljs-built_in">setInterval</span>(fetchTodos, <span class="hljs-number">30000</span>)
    return () =&gt; <span class="hljs-built_in">clearInterval</span>(interval)
  }, <span class="hljs-selector-attr">[]</span>)
  
  <span class="hljs-comment">// 窗口聚焦刷新</span>
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const handleFocus = () =&gt; <span class="hljs-built_in">fetchTodos</span>()
    window<span class="hljs-selector-class">.addEventListener</span>('focus', handleFocus)
    return () =&gt; window<span class="hljs-selector-class">.removeEventListener</span>('focus', handleFocus)
  }, <span class="hljs-selector-attr">[]</span>)
  
  const fetchTodos = async () =&gt; {
    <span class="hljs-built_in">setLoading</span>(true)
    try {
      const data = await <span class="hljs-built_in">fetch</span>('/api/todos')<span class="hljs-selector-class">.then</span>(r =&gt; r.json())
      <span class="hljs-built_in">setTodos</span>(data)
      <span class="hljs-built_in">setError</span>(null)
    } catch (err) {
      <span class="hljs-built_in">setError</span>(err.message)
    } finally {
      <span class="hljs-built_in">setLoading</span>(false)
    }
  }
  
  const addTodo = async (text) =&gt; {
    try {
      const newTodo = await <span class="hljs-built_in">fetch</span>('/api/todos', {
        method: 'POST',
        body: JSON.stringify({ text })
      })<span class="hljs-selector-class">.then</span>(r =&gt; r.json())
      
      <span class="hljs-built_in">setTodos</span>([...todos, newTodo])
    } catch (err) {
      <span class="hljs-built_in">setError</span>(err.message)
    }
  }
  
  if (loading) return &lt;<span class="hljs-selector-tag">div</span>&gt;Loading...&lt;/<span class="hljs-selector-tag">div</span>&gt;
  if (error) return &lt;<span class="hljs-selector-tag">div</span>&gt;Error: {error}&lt;/<span class="hljs-selector-tag">div</span>&gt;
  
  return (
    &lt;div&gt;
      {todos.map(todo =&gt; &lt;TodoItem key={todo.id} todo={todo} /&gt;)}
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  )
}
</code></pre>
<h4 data-id="heading-11">TanStack Query 方式（20行代码）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: todos } = <span class="hljs-title function_">useQuery</span>([<span class="hljs-string">'todos'</span>], fetchTodos, {
    <span class="hljs-attr">staleTime</span>: <span class="hljs-number">30000</span>,
    <span class="hljs-attr">refetchOnWindowFocus</span>: <span class="hljs-literal">true</span>,
  })
  
  <span class="hljs-keyword">const</span> addTodoMutation = <span class="hljs-title function_">useMutation</span>(addTodo, {
    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">() =&gt;</span> {
      queryClient.<span class="hljs-title function_">invalidateQueries</span>([<span class="hljs-string">'todos'</span>])
    }
  })
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {todos?.map(todo =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">TodoItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span> <span class="hljs-attr">todo</span>=<span class="hljs-string">{todo}</span> /&gt;</span>)}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>代码量减少 80%，但功能更强大、更可靠。</p>
<h3 data-id="heading-12">深层价值：架构层面的提升</h3>
<p>使用 TanStack Query 不仅仅是代码更简洁，它还带来架构层面的好处：</p>
<h4 data-id="heading-13">1. <strong>服务器状态与客户端状态分离</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 服务器状态（TanStack Query 管理，不需要你写 useState）</span>
<span class="hljs-keyword">const</span> { <span class="hljs-keyword">data</span>: user } = useQuery([<span class="hljs-string">'user'</span>], fetchUser)

<span class="hljs-comment">// 客户端状态（React 管理，这才需要 useState）</span>
<span class="hljs-keyword">const</span> [isModalOpen, setIsModalOpen] = useState(<span class="hljs-literal">false</span>)
</code></pre>
<p><strong>关键洞察</strong>：服务器数据根本不应该用 useState 管理！</p>
<ul>
<li>服务器数据：需要缓存、更新、同步、重试 → TanStack Query</li>
<li>客户端 UI 状态：只在本地，组件卸载就消失 → useState</li>
</ul>
<p>职责清晰，不再混乱。</p>
<blockquote>
<p>之前用 useState 管理服务器数据，就像用螺丝刀钉钉子，工具用错了。</p>
</blockquote>
<h4 data-id="heading-14">2. <strong>告别状态管理样板代码</strong></h4>
<p><strong>传统方式需要的状态管理代码：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 每个数据获取都要写这些</span>
const <span class="hljs-selector-attr">[data, setData]</span> = <span class="hljs-built_in">useState</span>(null)
const <span class="hljs-selector-attr">[loading, setLoading]</span> = <span class="hljs-built_in">useState</span>(false)
const <span class="hljs-selector-attr">[error, setError]</span> = <span class="hljs-built_in">useState</span>(null)

<span class="hljs-comment">// 请求前</span>
<span class="hljs-built_in">setLoading</span>(true)
<span class="hljs-built_in">setError</span>(null)

<span class="hljs-comment">// 请求成功</span>
<span class="hljs-built_in">setData</span>(result)
<span class="hljs-built_in">setLoading</span>(false)

<span class="hljs-comment">// 请求失败</span>
<span class="hljs-built_in">setError</span>(err)
<span class="hljs-built_in">setLoading</span>(false)

<span class="hljs-comment">// 条件渲染</span>
if (loading) return &lt;Loading /&gt;
if (error) return &lt;Error error={error} /&gt;
</code></pre>
<p><strong>TanStack Query：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 一行搞定</span>
<span class="hljs-keyword">const</span> { data, isLoading, <span class="hljs-type">error</span> } = useQuery([<span class="hljs-string">'key'</span>], fetcher)

<span class="hljs-comment">// 条件渲染（可选）</span>
<span class="hljs-keyword">if</span> (isLoading) <span class="hljs-keyword">return</span> &lt;Loading /&gt;
<span class="hljs-keyword">if</span> (<span class="hljs-type">error</span>) <span class="hljs-keyword">return</span> &lt;Error <span class="hljs-type">error</span>={<span class="hljs-type">error</span>} /&gt;
</code></pre>
<p>你不需要写 Redux、MobX、Zustand 来管理服务器数据，TanStack Query 就是你的服务器状态管理器。</p>
<p>而且，它比 Redux 更简单、更强大、更自动化。</p>
<h4 data-id="heading-15">3. <strong>性能优化自动化</strong></h4>
<ul>
<li>请求去重</li>
<li>并行请求优化</li>
<li>窗口聚焦时更新</li>
<li>后台数据预取</li>
<li>这些都是开箱即用</li>
</ul>
<h4 data-id="heading-16">4. <strong>更好的用户体验</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">const</span> { <span class="hljs-keyword">data</span>, isLoading, isFetching } = useQuery([<span class="hljs-string">'user'</span>], fetchUser)

<span class="hljs-comment">// isLoading: 首次加载</span>
<span class="hljs-comment">// isFetching: 后台更新</span>
<span class="hljs-comment">// 可以显示"正在刷新"而不是整个页面重新加载</span>
</code></pre>
<h3 data-id="heading-17">结语：思维的跃迁</h3>
<p><strong>TanStack Query 最大的价值不是它的 API，而是它改变了我们对数据获取和状态管理的认知。</strong></p>
<p>从"我要发请求 + 我要管理状态"到"我要数据"，这是一次思维的跃迁。</p>
<p>就像从命令式编程到声明式编程，从手动档到自动档，你不需要关心底层的每一个齿轮如何转动，你只需要说出你的目的地。</p>
<p><strong>当你不再纠结于"请求"和"状态"，你会发现自己有更多精力专注于真正重要的事情：构建出色的用户体验。</strong></p>
<hr/>
<p><strong>开始使用 TanStack Query，忘掉"发请求"和"管理状态"这两个概念吧。你只需要记住：</strong></p>
<blockquote>
<p>"我需要这个数据" — 请求怎么发、状态怎么管，交给 TanStack Query。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">npm install @tanstack/react-query
</code></pre>
<p>你的前端开发体验，即将焕然一新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React + ECharts 动态折线图实现]]></title>    <link>https://juejin.cn/post/7576953459543474230</link>    <guid>https://juejin.cn/post/7576953459543474230</guid>    <pubDate>2025-11-27T02:39:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576953459543474230" data-draft-id="7576923573777694762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React + ECharts 动态折线图实现"/> <meta itemprop="keywords" content="React.js,前端"/> <meta itemprop="datePublished" content="2025-11-27T02:39:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序媛ing"/> <meta itemprop="url" content="https://juejin.cn/user/1546328016433971"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React + ECharts 动态折线图实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1546328016433971/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序媛ing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T02:39:16.000Z" title="Thu Nov 27 2025 02:39:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上周项目接到一个新的需求，实现一个<strong>每3秒</strong>动态更新数据 的折线图，刚开始有点懵逼了，echarts如何能做成动态的，最终实现的效果如下：</p>
<ul>
<li> 图表不断向左平滑滚动</li>
<li> xAxis 始终保持 180 个点的滑动窗口</li>
<li> 第一次加载一批历史数据，之后每 3 秒追加新数据</li>
<li> 新旧数据无缝衔接</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb0b5e464bd34b9ea614788c7781acce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5aqbaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815956&amp;x-signature=hXN3sWbGqc3YkC9oRcMJBdOiOK0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">实现思路：</h2>
<ol>
<li>初始化阶段：创建 ECharts 实例</li>
<li>第一次数据加载（loadData）：填满 180 点窗口</li>
<li>定时更新（smoothAdvance）：每 3 秒滑动窗口</li>
<li>图表渲染（updateChart）</li>
<li>图表自适应（ResizeObserver）</li>
</ol>
<h2 data-id="heading-1">遇到的问题：</h2>
<p>1. 第一次初始化数据的最后一个点和后续第一个点之间断裂（不连线）</p>
<p>2. 第一次初始化数据的最后的连接点跟3s后更新数据的第一个点的连接线Tooltip显示undifiend</p>
<h2 data-id="heading-2">代码实现如下：</h2>
<h3 data-id="heading-3">初始化阶段：创建 ECharts 实例</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">const</span> <span class="hljs-string">initChart</span> <span class="hljs-string">=</span> <span class="hljs-string">()</span> <span class="hljs-string">=&gt;</span> {  
    <span class="hljs-string">if</span> <span class="hljs-string">(!chartRef.current)</span> <span class="hljs-string">return;</span>  
    <span class="hljs-string">chartInstance.current</span> <span class="hljs-string">=</span> <span class="hljs-string">echarts.init(chartRef.current);</span>  

    <span class="hljs-string">chartInstance.current.setOption(</span>{  
        <span class="hljs-attr">title:</span> {<span class="hljs-attr">text:</span> <span class="hljs-string">labelList.realTime_rx_or_tx_rate</span>, <span class="hljs-attr">left:</span> <span class="hljs-string">"center"</span>},  
        <span class="hljs-attr">tooltip:</span> {  
            <span class="hljs-attr">trigger:</span> <span class="hljs-string">"axis"</span>,  
            <span class="hljs-attr">formatter:</span> <span class="hljs-string">params</span> <span class="hljs-string">=&gt;</span> {  
               <span class="hljs-string">//避免Tooltip显示undifiend</span>
                <span class="hljs-string">const</span> <span class="hljs-string">validParams</span> <span class="hljs-string">=</span> <span class="hljs-string">params.filter(p</span> <span class="hljs-string">=&gt;</span> <span class="hljs-string">p.data</span> <span class="hljs-type">!=</span> <span class="hljs-literal">null</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-type">!Number.isNaN(p.data));</span>  
                <span class="hljs-string">if</span> <span class="hljs-string">(!validParams.length)</span> <span class="hljs-string">return</span> <span class="hljs-string">""</span><span class="hljs-string">;</span>  
                <span class="hljs-string">let</span> <span class="hljs-string">text</span> <span class="hljs-string">=</span> <span class="hljs-string">`$</span>{<span class="hljs-string">params</span>[<span class="hljs-number">0</span>]<span class="hljs-string">.axisValue</span>}<span class="hljs-string">&lt;br/&gt;`;</span>  
                <span class="hljs-string">validParams.forEach(item</span> <span class="hljs-string">=&gt;</span> {  
                    <span class="hljs-string">text</span> <span class="hljs-string">+=</span> <span class="hljs-string">`$</span>{<span class="hljs-string">item.marker</span>}<span class="hljs-string">$</span>{<span class="hljs-string">item.seriesName</span>}<span class="hljs-string">:</span> <span class="hljs-string">$</span>{<span class="hljs-string">formatSpeedForStats(item.data</span>, <span class="hljs-string">"bit"</span><span class="hljs-string">)</span>}<span class="hljs-string">&lt;br/&gt;`;</span>  
                }<span class="hljs-string">);</span>  
                <span class="hljs-string">return</span> <span class="hljs-string">text;</span>  
            }  
        },  
        <span class="hljs-attr">grid:</span> {<span class="hljs-attr">left:</span> <span class="hljs-number">120</span>, <span class="hljs-attr">right:</span> <span class="hljs-number">20</span>, <span class="hljs-attr">bottom:</span> <span class="hljs-number">40</span>, <span class="hljs-attr">top:</span> <span class="hljs-number">80</span>},  
        <span class="hljs-attr">xAxis:</span> {<span class="hljs-attr">type:</span> <span class="hljs-string">"category"</span>, <span class="hljs-attr">boundaryGap:</span> <span class="hljs-literal">false</span>, <span class="hljs-attr">data:</span> []},  
        <span class="hljs-attr">yAxis:</span> {  
            <span class="hljs-attr">type:</span> <span class="hljs-string">"value"</span>,  
            <span class="hljs-attr">axisLabel:</span> {  
                <span class="hljs-attr">formatter:</span> <span class="hljs-string">value</span> <span class="hljs-string">=&gt;</span> <span class="hljs-string">formatSpeedForStats(value</span>, <span class="hljs-string">"bit"</span><span class="hljs-string">)</span>  
            },  
            <span class="hljs-attr">splitLine:</span> {<span class="hljs-attr">lineStyle:</span> {<span class="hljs-attr">type:</span> <span class="hljs-string">"dashed"</span>}}  
        },  
        <span class="hljs-attr">series:</span> [  
            {  
                <span class="hljs-attr">name:</span> <span class="hljs-string">labelList.tx</span>,  
                <span class="hljs-attr">type:</span> <span class="hljs-string">"line"</span>,  
                <span class="hljs-attr">smooth:</span> <span class="hljs-literal">false</span>,  
                <span class="hljs-attr">showSymbol:</span> <span class="hljs-literal">false</span>,  
                <span class="hljs-attr">connectNulls:</span> <span class="hljs-literal">true</span>,  
                <span class="hljs-attr">areaStyle:</span> {<span class="hljs-attr">color:</span> <span class="hljs-string">"rgba(0, 180, 0, 0.2)"</span>},  
                <span class="hljs-attr">lineStyle:</span> {<span class="hljs-attr">color:</span> <span class="hljs-string">"#00c853"</span>, <span class="hljs-attr">width:</span> <span class="hljs-number">2</span>},  
                <span class="hljs-attr">data:</span> []  
            },  
            {  
                <span class="hljs-attr">name:</span> <span class="hljs-string">labelList.rx</span>,  
                <span class="hljs-attr">type:</span> <span class="hljs-string">"line"</span>,  
                <span class="hljs-attr">smooth:</span> <span class="hljs-literal">false</span>,  
                <span class="hljs-attr">showSymbol:</span> <span class="hljs-literal">false</span>,  
                <span class="hljs-attr">connectNulls:</span> <span class="hljs-literal">true</span>,  
                <span class="hljs-attr">areaStyle:</span> {<span class="hljs-attr">color:</span> <span class="hljs-string">"rgba(0, 102, 255, 0.2)"</span>},  
                <span class="hljs-attr">lineStyle:</span> {<span class="hljs-attr">color:</span> <span class="hljs-string">"#0066ff"</span>, <span class="hljs-attr">width:</span> <span class="hljs-number">2</span>},  
                <span class="hljs-attr">data:</span> []  
            }  
        ]  
    }<span class="hljs-string">);</span>  
}<span class="hljs-string">;</span>
</code></pre>
<p> </p>
<pre><code class="hljs language-ini" lang="ini">echarts数据处理方法

const <span class="hljs-attr">processDataPoints</span> = result =&gt; {  
    if (!*Array*.isArray(result) || result.length &lt; 2) return {newTimeData: <span class="hljs-section">[]</span>, newTxData: <span class="hljs-section">[]</span>, newRxData: <span class="hljs-section">[]</span>}<span class="hljs-comment">;  </span>

    const <span class="hljs-attr">newTimeData</span> = []<span class="hljs-comment">;  </span>
    const <span class="hljs-attr">newTxData</span> = []<span class="hljs-comment">;  </span>
    const <span class="hljs-attr">newRxData</span> = []<span class="hljs-comment">;  </span>

    for (let <span class="hljs-attr">i</span> = <span class="hljs-number">1</span><span class="hljs-comment">; i &lt; result.length; i++) {  </span>
        const <span class="hljs-section">[t2, rx2, , tx2]</span> = result<span class="hljs-section">[i]</span><span class="hljs-comment">;  </span>
        const <span class="hljs-section">[t1, rx1, , tx1]</span> = result<span class="hljs-section">[i - 1]</span><span class="hljs-comment">;  </span>

        const <span class="hljs-attr">txRate</span> = ((tx2 - tx1) * <span class="hljs-number">8</span>) / <span class="hljs-number">1024</span> / (t2 - t1)<span class="hljs-comment">;  </span>
        const <span class="hljs-attr">rxRate</span> = ((rx2 - rx1) * <span class="hljs-number">8</span>) / <span class="hljs-number">1024</span> / (t2 - t1)<span class="hljs-comment">;  </span>
        const <span class="hljs-attr">timeStr</span> = new *Date*(t2 * <span class="hljs-number">1000</span>).toLocaleTimeString(<span class="hljs-string">"zh-CN"</span>, {hour12: <span class="hljs-literal">false</span>})<span class="hljs-comment">;  </span>

        newTimeData.push(timeStr)<span class="hljs-comment">;  </span>
        newTxData.push(parseFloat(txRate.toFixed(2)))<span class="hljs-comment">;  </span>
        newRxData.push(parseFloat(rxRate.toFixed(2)))<span class="hljs-comment">;  </span>
    }  

    return {newTimeData, newTxData, newRxData}<span class="hljs-comment">;  </span>
}<span class="hljs-comment">;</span>
</code></pre>
<p> </p>
<h3 data-id="heading-4">第一次数据加载:填满180点窗口</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">loadData</span> = async () =&gt; {  
    try {  
        const <span class="hljs-attr">res</span> = await *api*.request({  
            luci: {  
                getRealtimeStats: {mode: "interface", device}  
            }  
        })<span class="hljs-comment">;  </span>

        const <span class="hljs-attr">result</span> = res?.result<span class="hljs-comment">;  </span>


        const {newTimeData, newTxData, newRxData} = processDataPoints(result)<span class="hljs-comment">;  </span>

        // 初始化用 NaN 填充，避免折线断裂  
        const <span class="hljs-attr">fullTime</span> = *Array*(TOTAL_POINTS).fill(<span class="hljs-string">""</span>)<span class="hljs-comment">;  </span>
        const <span class="hljs-attr">fullTx</span> = *Array*(TOTAL_POINTS).fill(*NaN*)<span class="hljs-comment">;  </span>
        const <span class="hljs-attr">fullRx</span> = *Array*(TOTAL_POINTS).fill(*NaN*)<span class="hljs-comment">;  </span>

        const <span class="hljs-attr">len</span> = newTimeData.length<span class="hljs-comment">;  </span>
        const <span class="hljs-attr">start</span> = TOTAL_POINTS - len<span class="hljs-comment">;  </span>

        for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; len; i++) {  </span>
            fullTime<span class="hljs-section">[start + i]</span> = newTimeData<span class="hljs-section">[i]</span><span class="hljs-comment">;  </span>
            fullTx<span class="hljs-section">[start + i]</span> = newTxData<span class="hljs-section">[i]</span><span class="hljs-comment">;  </span>
            fullRx<span class="hljs-section">[start + i]</span> = newRxData<span class="hljs-section">[i]</span><span class="hljs-comment">;  </span>
        }  
        setTimeData(fullTime)<span class="hljs-comment">;  </span>
        setTxData(fullTx)<span class="hljs-comment">;  </span>
        setRxData(fullRx)<span class="hljs-comment">;  </span>
    } catch (err) {  
        *console*.error(err)<span class="hljs-comment">;  </span>
    }  
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-5">定时更新：每3s滑动窗口 删除旧的三个点，添加最新点</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">smoothAdvance</span> = async () =&gt; {  
    try {  
        const <span class="hljs-attr">res</span> = await *api*.request({  
            luci: {  
                getRealtimeStats: {mode: "interface", device}  
            }  
        })<span class="hljs-comment">;  </span>

        const <span class="hljs-attr">result</span> = res?.result<span class="hljs-comment">;  </span>
               const {newTimeData, newTxData, newRxData} = processDataPoints(result.slice(-4))<span class="hljs-comment">;  </span>
        setTimeData(<span class="hljs-attr">prev</span> =&gt; {  
            const <span class="hljs-attr">kept</span> = prev.slice(<span class="hljs-number">3</span>)<span class="hljs-comment">;  </span>
            const <span class="hljs-attr">lastTime</span> = kept[kept.length - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            
            //避免重复点

            const <span class="hljs-attr">filtered</span> = newTimeData.filter(t =&gt; t !== lastTime)<span class="hljs-comment">;  </span>

            return <span class="hljs-section">[...kept, ...filtered]</span><span class="hljs-comment">;  </span>
        })<span class="hljs-comment">;  </span>
      

        //null值用 NaN 填充，避免折线断裂 同时避免在连线触发tooltip显示（应该在每个点显示）
      
        setTxData(<span class="hljs-attr">prev</span> =&gt; {  
            const <span class="hljs-attr">kept</span> = prev.slice(<span class="hljs-number">3</span>).map(v =&gt; (v == null ? <span class="hljs-string">"NaN"</span> : v))<span class="hljs-comment">;  </span>
            return <span class="hljs-section">[...kept, ...newTxData]</span><span class="hljs-comment">;  </span>
        })<span class="hljs-comment">;  </span>

        setRxData(<span class="hljs-attr">prev</span> =&gt; {  
            const <span class="hljs-attr">kept</span> = prev.slice(<span class="hljs-number">3</span>).map(v =&gt; (v == null ? <span class="hljs-string">"NaN"</span>: v))<span class="hljs-comment">;  </span>
            return <span class="hljs-section">[...kept, ...newRxData]</span><span class="hljs-comment">;  </span>
        })<span class="hljs-comment">;  </span>
    } catch (e) {  
        *console*.error("smoothAdvance error:", e)<span class="hljs-comment">;  </span>
    }  
}<span class="hljs-comment">;</span>
</code></pre>
<p> </p>
<h3 data-id="heading-6">图表渲染 只更新坐标轴 数据数组</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">updateChart</span> = (timeArr, txArr, rxArr) =&gt; {  
    if (!chartInstance.current) return<span class="hljs-comment">;  </span>
    chartInstance.current.setOption(  
        {  
            xAxis: {data: timeArr},  
            series: <span class="hljs-section">[{data: txArr}, {data: rxArr}]</span>  
        },  
        false  
    )<span class="hljs-comment">;  </span>
}<span class="hljs-comment">;</span>

useEffect(() =&gt; {  
    if (chartInstance.current) {  
        updateChart(timeData, txData, rxData)<span class="hljs-comment">;  </span>
    }  
}, <span class="hljs-section">[timeData, txData, rxData]</span>)<span class="hljs-comment">;</span>
</code></pre>
<p> </p>
<h3 data-id="heading-7">图表自适应 (ResizeObserver)</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {  
    const observer = new <span class="hljs-built_in">ResizeObserver</span>(() =&gt; {  
        chartInstance<span class="hljs-selector-class">.current</span>?<span class="hljs-selector-class">.resize</span>();  
    });  
    if (chartRef.current) observer<span class="hljs-selector-class">.observe</span>(chartRef.current);  
    return () =&gt; observer<span class="hljs-selector-class">.disconnect</span>();  
}, <span class="hljs-selector-attr">[]</span>);
</code></pre>
<p> </p>
<h3 data-id="heading-8">图表初始化渲染（第一次加载数据渲染）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {  
  if (!chartInstance.current) <span class="hljs-built_in">initChart</span>();  
    <span class="hljs-built_in">loadData</span>();  
    const timer = <span class="hljs-built_in">setInterval</span>(smoothAdvance, <span class="hljs-number">3000</span>);  
    return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);  
}, <span class="hljs-selector-attr">[]</span>);
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ts学习D1---超基础语法导入]]></title>    <link>https://juejin.cn/post/7576907627017699379</link>    <guid>https://juejin.cn/post/7576907627017699379</guid>    <pubDate>2025-11-27T02:46:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576907627017699379" data-draft-id="7576863819982913545" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ts学习D1---超基础语法导入"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2025-11-27T02:46:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱泡脚的鸡腿"/> <meta itemprop="url" content="https://juejin.cn/user/4466663535419179"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ts学习D1---超基础语法导入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4466663535419179/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱泡脚的鸡腿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T02:46:45.000Z" title="Thu Nov 27 2025 02:46:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>在跟练小兔鲜的时候发现常用ts语法来定义接口返回的数据类型，所以来补习一下ts语法</strong></p>
<h2 data-id="heading-0">1.js是一种弱脚本文件，数据类型定义和使用不严格，所以便于后期维护，就诞生了ts</h2>
<h3 data-id="heading-1">2.编写</h3>
<h3 data-id="heading-2">2.1 ts会以给出的变量类型初始值进行变量类型定义（ts的类型约束功能+类型推断）</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29571c0857544c1b899ccefab3069846~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764816405&amp;x-signature=NCxo1E%2FM3Gwq0wNqKfyhS6W3QRg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 ts的类型注解</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1.使用类型注解，在变量后加‘：’的符号，指定变量的类型</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">str</span>:<span class="hljs-built_in">string</span>=<span class="hljs-string">'abc'</span>

<span class="hljs-comment">// 2.或者先预声明一个变量,之后需要使用的时候再进行赋值</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">num</span>:<span class="hljs-built_in">number</span>
num=<span class="hljs-number">123</span>

</code></pre>
<h3 data-id="heading-4">2.3 ts的类型断言</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> numArr=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
<span class="hljs-keyword">const</span> result=numArr.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>item&gt;<span class="hljs-number">2</span>)
<span class="hljs-comment">// 结合unArr中的元素，这里的‘item=&gt;item&gt;2’有可能不成立，</span>
<span class="hljs-comment">// 会被判定为undefined类型，所以result会标红</span>
result*<span class="hljs-number">5</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/570cb435b63449cc9b69633968f17a12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764816405&amp;x-signature=1fX9eFYoHLfHsmo5FWFM3fIhouA%3D" alt="image.png" loading="lazy"/><br/>
<strong>如果你想筛选掉undefined的情况，就需要使用类型断言‘as number’,断言为一个数值类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> numArr=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
<span class="hljs-keyword">const</span> result=numArr.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>item&gt;<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>
<span class="hljs-comment">// 结合unArr中的元素，这里的‘item=&gt;item&gt;2’有可能不成立，</span>
<span class="hljs-comment">// 会被判定为undefined类型，所以result会标红</span>
result*<span class="hljs-number">5</span>
</code></pre>
<h3 data-id="heading-5">2.4 ts的基础类型和联合类型</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1.ts的基础类型</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">v1</span>:<span class="hljs-built_in">string</span>=<span class="hljs-string">'abc'</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">v2</span>:<span class="hljs-built_in">number</span>=<span class="hljs-number">123</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">v3</span>:<span class="hljs-built_in">boolean</span>=<span class="hljs-literal">true</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">nu</span>:<span class="hljs-literal">null</span>=<span class="hljs-literal">null</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">ud</span>:<span class="hljs-literal">undefined</span>=<span class="hljs-literal">undefined</span>

<span class="hljs-comment">// 2.ts的联合类型</span>
<span class="hljs-comment">// 2.1通过竖线的方式来定义联合类型(如v4：可以赋值string或者number)</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">v4</span>:<span class="hljs-built_in">string</span>|<span class="hljs-built_in">number</span>=<span class="hljs-number">123</span>

<span class="hljs-comment">// 2.2 希望这个数值只能被限定为以下几个数值之一</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">v5</span>:<span class="hljs-number">1</span>|<span class="hljs-number">2</span>|<span class="hljs-number">3</span>=<span class="hljs-number">1</span>  <span class="hljs-comment">// 赋值成功</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">v6</span>:<span class="hljs-number">1</span>|<span class="hljs-number">2</span>|<span class="hljs-number">3</span>=<span class="hljs-number">4</span>  <span class="hljs-comment">// error 4不是v6的成员</span>

<span class="hljs-comment">// 3.ts的数组</span>
<span class="hljs-comment">// 通过类型来约束数组中的类型</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">v7</span>:<span class="hljs-built_in">number</span>[]=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
<span class="hljs-keyword">let</span> <span class="hljs-attr">v8</span>:<span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;=[<span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>]

<span class="hljs-comment">// 4.ts的元组</span>
<span class="hljs-comment">// 4.1元组类型允许表示一个已知元素数量和类型的数组，各元素的类型不必相同</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">v9</span>:[<span class="hljs-built_in">string</span>,<span class="hljs-built_in">number</span>]=[<span class="hljs-string">'a'</span>,<span class="hljs-number">1</span>]
<span class="hljs-comment">// 4.2 取出元祖值</span>
v9[<span class="hljs-number">0</span>] <span class="hljs-comment">//输出a</span>

<span class="hljs-comment">// 4.3 让一些元祖中的元素为可选的</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">v10</span>:[<span class="hljs-built_in">string</span>,<span class="hljs-built_in">number</span>,<span class="hljs-built_in">boolean</span>?]=[<span class="hljs-string">'a'</span>,<span class="hljs-number">1</span>]   <span class="hljs-comment">// ？表示可选</span>


<span class="hljs-comment">// 5.ts的枚举</span>
<span class="hljs-comment">//在js中就是将其编译为键、值的形式</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">MyEnum</span>{   <span class="hljs-comment">// 枚举类型</span>
    a,
    b,
    c
}
<span class="hljs-comment">// 5.1 访问枚举类型的两种方式</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MyEnum</span>.<span class="hljs-property">a</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MyEnum</span>[<span class="hljs-number">0</span>])  <span class="hljs-comment">//等于MyEnum.a</span>
</code></pre>
<h3 data-id="heading-6">2.5 ts的函数</h3>
<h4 data-id="heading-7">2.5.1 void</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 6. void类型(当函数没有返回值的时候，返回值就是undefined，所以函数返回值类型为void)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>):<span class="hljs-built_in">void</span>{  <span class="hljs-comment">// void类型表示没有任何返回值</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'void'</span>)
}
</code></pre>
<h4 data-id="heading-8">2.5.2 给函数的参数分配类型</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyFn</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>,b:<span class="hljs-built_in">string</span></span>){
<span class="hljs-keyword">return</span> a+b;
}
</code></pre>
<h4 data-id="heading-9">2.5.3 给函数的返回值分配类型（用于严格规范函数返回值类型）</h4>
<h5 data-id="heading-10">2.5.3.1</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyFn</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>,b:<span class="hljs-built_in">string</span></span>):<span class="hljs-built_in">number</span>{   <span class="hljs-comment">//报错，因为这里返回值类型不是number</span>
<span class="hljs-keyword">return</span> a+b; 
}
## <span class="hljs-string">``</span><span class="hljs-string">`
#### 2.5.3.2
`</span><span class="hljs-string">``</span>ts
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyFn</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>,b:<span class="hljs-built_in">string</span></span>):<span class="hljs-built_in">number</span>{
<span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
}
</code></pre>
<h5 data-id="heading-11">2.5.3.3 将参数设置为可选（和ES6有点像）</h5>
<p><strong>注意；可选参数写在必选参数左侧（后面）</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyFn</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>,b?:<span class="hljs-built_in">string</span></span>):<span class="hljs-built_in">number</span>{
<span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
}
</code></pre>
<h5 data-id="heading-12">2.5.3.4 剩余参数</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyFn</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>,b?:<span class="hljs-built_in">string</span>, ...rest:<span class="hljs-built_in">number</span>[]</span>):<span class="hljs-built_in">number</span>{
<span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
}

<span class="hljs-keyword">const</span> f=<span class="hljs-title class_">MyFn</span>(<span class="hljs-number">20</span>,<span class="hljs-string">'abc'</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>) <span class="hljs-comment">//1,2,3,4,5,6,7就是剩余函数' ...rest:number[]'的实参</span>
</code></pre>
<h3 data-id="heading-13">2.6 ts的接口</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义一个接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Obj</span>{
    <span class="hljs-attr">name</span>:<span class="hljs-built_in">string</span>,
    <span class="hljs-attr">age</span>:<span class="hljs-built_in">number</span>
}

<span class="hljs-comment">// 使用接口的时候必须要有name和age</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>:<span class="hljs-title class_">Obj</span> = {
    <span class="hljs-attr">name</span>:<span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>:<span class="hljs-number">18</span>
}
</code></pre>
<h3 data-id="heading-14">2.7 ts的type（类型别名）---很常用</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyuserName</span>=<span class="hljs-built_in">string</span>|<span class="hljs-built_in">number</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">username</span>:<span class="hljs-title class_">MyuserName</span>=<span class="hljs-string">"123"</span>
</code></pre>
<h3 data-id="heading-15">2.8 ts的泛型---很常用</h3>
<p><strong>定义一个结构体，但是想适配多中数据类型，可以使用泛型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> myFn&lt;T&gt;(<span class="hljs-attr">a</span>:T,<span class="hljs-attr">b</span>:T):T[]{
    <span class="hljs-keyword">return</span> [a,b];
}
<span class="hljs-comment">// 使用数值类型进行处理</span>
myFn&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)
<span class="hljs-comment">// 使用字符串类型进行处理</span>
myFn&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'1'</span>,<span class="hljs-string">'2'</span>)
<span class="hljs-comment">// 或者不手动定义类型，因为在ts中函数myFn()会自动进行类型推导</span>
<span class="hljs-title function_">myFn</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)  <span class="hljs-comment">//自动将类型判定为number</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[借助 Let's Encrypt 节省 SSL 证书费用]]></title>    <link>https://juejin.cn/post/7577171133432905769</link>    <guid>https://juejin.cn/post/7577171133432905769</guid>    <pubDate>2025-11-27T03:59:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577171133432905769" data-draft-id="7577171133432873001" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="借助 Let's Encrypt 节省 SSL 证书费用"/> <meta itemprop="keywords" content="DevOps,后端"/> <meta itemprop="datePublished" content="2025-11-27T03:59:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mzlogin"/> <meta itemprop="url" content="https://juejin.cn/user/1890815727118414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            借助 Let's Encrypt 节省 SSL 证书费用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1890815727118414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mzlogin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:59:01.000Z" title="Thu Nov 27 2025 03:59:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>向服务商购买一张常见的 DV 通配符 SSL 证书，通常每年价格在数百至一千多元人民币不等；若名下有多个域名需要使用证书，总费用每年可能达到数千元。</p>
<p>在当前强调降本增效的环境下，若评估后认为免费证书能够满足需求，小公司和个人网站即可节省相应成本。</p>
<h2 data-id="heading-0">Let's Encrypt 简介</h2>
<p>Let's Encrypt 是一家免费、开放、自动化的公益性证书颁发机构（CA），由互联网安全研究组（ISRG）运作，属于非营利组织。其目标是推广 HTTPS 的应用，为构建更安全、尊重隐私的互联网提供免费而便捷的支持。</p>
<h2 data-id="heading-1">操作方法</h2>
<p>根据不同使用环境，Let's Encrypt 提供多种验证与获取证书的方式。常用工具是 Certbot，详见文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Feff-certbot.readthedocs.io%2Fen%2Fstable%2F" target="_blank" title="https://eff-certbot.readthedocs.io/en/stable/" ref="nofollow noopener noreferrer">eff-certbot.readthedocs.io/en/stable/</a>。</p>
<p>在部分环境中，可配置工具定期自动续期，减少维护工作。</p>
<p>由于服务器环境较为老旧，且需要将证书上传至阿里云并部署到多个云服务，本文暂采用“本地生成证书—手动上传与更新”的方式。</p>
<h3 data-id="heading-2">0x01 在本地生成证书</h3>
<p>本文使用 Docker 运行 Certbot，参见文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Feff-certbot.readthedocs.io%2Fen%2Fstable%2Finstall.html%23alternative-1-docker" target="_blank" title="https://eff-certbot.readthedocs.io/en/stable/install.html#alternative-1-docker" ref="nofollow noopener noreferrer">eff-certbot.readthedocs.io/en/stable/i…</a>。</p>
<p>生成通配符证书的示例命令如下：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -it --<span class="hljs-built_in">rm</span> --name certbot \
  -v <span class="hljs-string">'/Users/mazhuang/some/path/letsencrypt:/etc/letsencrypt'</span> \
  certbot/certbot certonly \
  --preferred-challenges dns \
  --manual \
  --server https://acme-v02.api.letsencrypt.org/directory \
  --key-type rsa --rsa-key-size 2048
</code></pre>
<ul>
<li><code>--preferred-challenges dns</code>：使用 DNS 方式进行域名验证；</li>
<li><code>--manual</code>：以交互式方式进行询问与操作；</li>
<li><code>--key-type rsa --rsa-key-size 2048</code>：生成 2048 位 RSA 私钥（部分阿里云服务不支持默认的 ECC 证书）。</li>
</ul>
<p>执行后会依次询问邮箱、协议授权、域名等信息，随后提示添加 DNS TXT 记录以完成域名所有权验证，按提示操作即可。</p>
<p>生成成功后，证书与私钥保存在挂载的本地目录中，例如上述命令中的 <code>/Users/mazhuang/some/path/letsencrypt/archive/{domain name}</code>。各文件的说明可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Feff-certbot.readthedocs.io%2Fen%2Fstable%2Fusing.html%23where-certs" target="_blank" title="https://eff-certbot.readthedocs.io/en/stable/using.html#where-certs" ref="nofollow noopener noreferrer">eff-certbot.readthedocs.io/en/stable/u…</a>。</p>
<h3 data-id="heading-3">0x02 上传和部署证书</h3>
<p>将证书上传到阿里云的数字证书管理服务。可使用其一键部署功能（付费），或在各云服务中手动选择使用该证书（免费），按需取用。</p>
<h3 data-id="heading-4">0x03 定期更新证书</h3>
<p>Let's Encrypt 颁发的证书有效期为 90 天，建议在到期前 30 天内更新。可重复步骤 0x01 生成新证书，然后上传并部署。</p>
<h2 data-id="heading-5">注意事项</h2>
<p>部分极为老旧的平台有可能不支持 Let's Encrypt 颁发的证书，建议评估后再决定是否使用，具体的兼容情况可以参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fletsencrypt.org%2Fzh-cn%2Fdocs%2Fcertificate-compatibility%2F" target="_blank" title="https://letsencrypt.org/zh-cn/docs/certificate-compatibility/" ref="nofollow noopener noreferrer">letsencrypt.org/zh-cn/docs/…</a> 。</p>
<p>比如我这边就遇到了因为使用的是 JDK 8 的低于 141 的版本，部署完证书后，发现 xxl-job 定时任务执行器没有注册上，报错 <code>sun.security.validator.ValidatorException: PKIX path building failed</code>。</p>
<p>解决方法：</p>
<ol>
<li>
<p>下载 ISRG Root X1 证书</p>
<p>在这里可以找到： <a href="https://link.juejin.cn?target=https%3A%2F%2Fletsencrypt.org%2Fcertificates%2F" target="_blank" title="https://letsencrypt.org/certificates/" ref="nofollow noopener noreferrer">letsencrypt.org/certificate…</a></p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">cd</span> /opt
get https://letsencrypt.org/certs/isrgrootx1.pem
</code></pre>
</li>
<li>
<p>导入证书到 JDK 的 cacerts 中</p>
<pre><code class="hljs language-sh" lang="sh">keytool -trustcacerts -keystore <span class="hljs-string">"/opt/jdk/jre/lib/security/cacerts"</span> -storepass changeit -noprompt -importcert -<span class="hljs-built_in">alias</span> lets-encrypt-x1 -file <span class="hljs-string">"/opt/isrgrootx1.pem"</span>
</code></pre>
</li>
<li>
<p>重启服务</p>
</li>
</ol>
<h2 data-id="heading-6">小结</h2>
<p>以上步骤简单、成本为零。对小公司和个人网站而言，是节省 SSL 证书费用的可行方案。</p>
<p>若环境允许，建议配置自动化续期，进一步降低维护成本，按需采用。</p>
<h2 data-id="heading-7">参考链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fletsencrypt.org%2Fzh-cn%2F" target="_blank" title="https://letsencrypt.org/zh-cn/" ref="nofollow noopener noreferrer">letsencrypt.org/zh-cn/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feff-certbot.readthedocs.io%2Fen%2Fstable%2F" target="_blank" title="https://eff-certbot.readthedocs.io/en/stable/" ref="nofollow noopener noreferrer">eff-certbot.readthedocs.io/en/stable/</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开发 Flutter Plugin 之 初始配置]]></title>    <link>https://juejin.cn/post/7576929700841717769</link>    <guid>https://juejin.cn/post/7576929700841717769</guid>    <pubDate>2025-11-27T03:21:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576929700841717769" data-draft-id="7576928016900587530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开发 Flutter Plugin 之 初始配置"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-27T03:21:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zonda的地盘"/> <meta itemprop="url" content="https://juejin.cn/user/3474112472422190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开发 Flutter Plugin 之 初始配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3474112472422190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zonda的地盘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:21:37.000Z" title="Thu Nov 27 2025 03:21:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文以 Android 为例，具体可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fpackages-and-plugins%2Fdeveloping-packages" target="_blank" title="https://docs.flutter.dev/packages-and-plugins/developing-packages" ref="nofollow noopener noreferrer">官网</a></p>
</blockquote>
<h2 data-id="heading-0">创建命令</h2>
<pre><code class="hljs language-ini" lang="ini">flutter create \
  --org com.get.aaid \
  --project-name get_aaid_plugin \
  <span class="hljs-attr">--platforms</span>=android,ios \
  <span class="hljs-attr">--android-language</span>=kotlin \
  <span class="hljs-attr">--ios-language</span>=swift \
  <span class="hljs-attr">--template</span>=plugin \
  get_aaid_plugin
</code></pre>
<h2 data-id="heading-1">使用 example 的 gradle 环境，编写和编译插件代码</h2>
<h4 data-id="heading-2">配置 example/android/settings.gradle</h4>
<ul>
<li>在该文件底部加入代码:</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">include</span> <span class="hljs-string">':get_aaid_plugin'</span>
<span class="hljs-title function_ invoke__">project</span>(<span class="hljs-string">':get_aaid_plugin'</span>).projectDir = <span class="hljs-title function_ invoke__">file</span>(<span class="hljs-string">'../../android'</span>)
</code></pre>
<h4 data-id="heading-3">配置 android/build.gradle</h4>
<ol>
<li>在该文件顶部加入代码：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">group</span> = <span class="hljs-string">"com.get.aaid.get_aaid_plugin"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"1.0-SNAPSHOT"</span>

def <span class="hljs-attr">localProperties</span> = new Properties()
def <span class="hljs-attr">localPropertiesFile</span> = rootProject.file(<span class="hljs-string">'local.properties'</span>)
if (localPropertiesFile.exists()) {
    localPropertiesFile.withReader('UTF-8') { reader -&gt;
        localProperties.load(reader)
    }
}
def <span class="hljs-attr">flutterRoot</span> = localProperties.getProperty(<span class="hljs-string">'flutter.sdk'</span>)

... ...

</code></pre>
<ol start="2">
<li>在该文件加入依赖：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">dependencies {
    compileOnly files(<span class="hljs-string">"<span class="hljs-variable">$flutterRoot</span>/bin/cache/artifacts/engine/android-arm/flutter.jar"</span>)
    compileOnly <span class="hljs-string">'androidx.annotation:annotation:1.8.0'</span>
    
... ...

</code></pre>
<blockquote>
<p>如果还是报红，执行 (fvm) flutter precache 即可</p>
</blockquote>
<h2 data-id="heading-4">Flutter 工程引入 pigeons 即可开始编写插件具体代码</h2>
<ul>
<li>常用命令</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">dart run pigeon --input pigeons/messages.dart
</code></pre>
<ul>
<li>参考示例</li>
</ul>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fpigeon" target="_blank" title="https://pub.dev/packages/pigeon" ref="nofollow noopener noreferrer">pub 地址</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fpackages%2Fblob%2Fmain%2Fpackages%2Fpigeon%2Fexample%2FREADME.md" target="_blank" title="https://github.com/flutter/packages/blob/main/packages/pigeon/example/README.md" ref="nofollow noopener noreferrer">github 示例</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[探秘新一代向量存储格式Lance-format (十一) Scanner 与查询执行]]></title>    <link>https://juejin.cn/post/7577171133432447017</link>    <guid>https://juejin.cn/post/7577171133432447017</guid>    <pubDate>2025-11-27T02:35:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577171133432447017" data-draft-id="7576935292428058666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="探秘新一代向量存储格式Lance-format (十一) Scanner 与查询执行"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-27T02:35:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            探秘新一代向量存储格式Lance-format (十一) Scanner 与查询执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T02:35:16.000Z" title="Thu Nov 27 2025 02:35:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第11章：Scanner 与查询执行</h2>
<h3 data-id="heading-1">🎯 核心概览</h3>
<p>Scanner 是 Lance 的查询执行引擎，负责将用户的查询转换为高效的执行计划。本章讲解 Scanner 的构建器模式、投影下推和谓词下推等优化技术。</p>
<hr/>
<h3 data-id="heading-2">📊 第一部分：Scanner 的架构设计</h3>
<h4 data-id="heading-3">What - Scanner 是什么？</h4>
<p><strong>定义</strong>：Scanner 是一个构建器模式的查询执行器，支持灵活的查询配置和优化。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Scanner</span> {
    dataset: Arc&lt;Dataset&gt;,
    projection: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;&gt;,    <span class="hljs-comment">// 选择的列</span>
    filters: <span class="hljs-type">Vec</span>&lt;FilterExpr&gt;,           <span class="hljs-comment">// WHERE 条件</span>
    limit: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">usize</span>&gt;,               <span class="hljs-comment">// LIMIT</span>
    offset: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">usize</span>&gt;,              <span class="hljs-comment">// OFFSET</span>
    index_hints: <span class="hljs-type">Vec</span>&lt;IndexHint&gt;,        <span class="hljs-comment">// 索引提示</span>
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Scanner</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">project</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, columns: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">self</span>.projection = <span class="hljs-title function_ invoke__">Some</span>(columns);
        <span class="hljs-keyword">self</span>
    }
    
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">filter</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, expr: FilterExpr) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">self</span>.filters.<span class="hljs-title function_ invoke__">push</span>(expr);
        <span class="hljs-keyword">self</span>
    }
    
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">limit</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, limit: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">self</span>.limit = <span class="hljs-title function_ invoke__">Some</span>(limit);
        <span class="hljs-keyword">self</span>
    }
    
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">try_into_stream</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Stream</span>&lt;Item = <span class="hljs-type">Result</span>&lt;RecordBatch&gt;&gt;&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">plan</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">build_execution_plan</span>()?;
        plan.<span class="hljs-title function_ invoke__">execute</span>().<span class="hljs-keyword">await</span>
    }
}
</code></pre>
<h4 data-id="heading-4">Why - 为什么需要 Scanner？</h4>
<h5 data-id="heading-5">问题：不优化的扫描</h5>
<pre><code class="hljs language-sql" lang="sql">简单方案：
scan() {
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> fragment {
        read <span class="hljs-keyword">all</span> columns
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">rows</span>
    }
}

性能问题：
✗ 读取不需要的列（浪费 IO）
✗ 不过滤行（浪费内存）
✗ 不使用索引（慢速扫描）

示例：
<span class="hljs-keyword">SELECT</span> id, name <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">30</span>

简单方案：读取所有 <span class="hljs-number">100</span> 列，然后过滤
高效方案：
<span class="hljs-number">1.</span> 识别只需要 id, name 列
<span class="hljs-number">2.</span> 过滤 age <span class="hljs-operator">&gt;</span> <span class="hljs-number">30</span>
<span class="hljs-number">3.</span> 使用 age 上的索引（如果有）
性能提升：<span class="hljs-number">100</span> 倍
</code></pre>
<h4 data-id="heading-6">How - Scanner 的优化策略</h4>
<h5 data-id="heading-7">1. 投影下推（Projection Pushdown）</h5>
<pre><code class="hljs language-bash" lang="bash">传统做法：
SELECT <span class="hljs-built_in">id</span>, name FROM <span class="hljs-built_in">users</span>
    ↓
读取所有列 [<span class="hljs-built_in">id</span>, name, age, email, phone, ...]
    ↓
内存中选择 <span class="hljs-built_in">id</span>, name

问题：浪费 IO

Lance 优化：
SELECT <span class="hljs-built_in">id</span>, name FROM <span class="hljs-built_in">users</span>
    ↓
编译器分析：只需要 <span class="hljs-built_in">id</span>, name
    ↓
告诉文件读取器：只读这两列
    ↓
磁盘上跳过其他列
</code></pre>
<p><strong>实现示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Scanner</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">build_execution_plan</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;ExecutionPlan&gt; {
        <span class="hljs-comment">// 识别需要的列</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">required_columns</span> = <span class="hljs-keyword">match</span> &amp;<span class="hljs-keyword">self</span>.projection {
            <span class="hljs-title function_ invoke__">Some</span>(cols) =&gt; cols.<span class="hljs-title function_ invoke__">clone</span>(),
            <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">self</span>.dataset.<span class="hljs-title function_ invoke__">schema</span>().<span class="hljs-title function_ invoke__">all_columns</span>(),
        };
        
        <span class="hljs-comment">// 为了过滤，可能需要额外的列</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">columns_for_filter</span> = required_columns.<span class="hljs-title function_ invoke__">clone</span>();
        <span class="hljs-keyword">for</span> <span class="hljs-variable">filter</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">self</span>.filters {
            columns_for_filter.<span class="hljs-title function_ invoke__">extend</span>(filter.<span class="hljs-title function_ invoke__">required_columns</span>());
        }
        
        <span class="hljs-comment">// 去重</span>
        columns_for_filter.<span class="hljs-title function_ invoke__">sort</span>();
        columns_for_filter.<span class="hljs-title function_ invoke__">dedup</span>();
        
        <span class="hljs-comment">// 创建读取计划，只读这些列</span>
        <span class="hljs-title function_ invoke__">Ok</span>(ExecutionPlan::Project {
            columns: columns_for_filter,
            filters: <span class="hljs-keyword">self</span>.filters.<span class="hljs-title function_ invoke__">clone</span>(),
        })
    }
}
</code></pre>
<p><strong>性能对比</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">1000 万行，100 列的表

查询：SELECT col_1, col_2 FROM table WHERE col_5 &gt; 100

无投影下推：
<span class="hljs-deletion">- 读取所有列：1GB × 100 = 100GB</span>
<span class="hljs-deletion">- 过滤：在内存中过滤</span>
<span class="hljs-deletion">- 性能：需要 100GB I/O</span>

有投影下推：
<span class="hljs-deletion">- 读取 col_1, col_2, col_5：1GB × 3 = 3GB</span>
<span class="hljs-deletion">- 过滤：在磁盘读取时应用</span>
<span class="hljs-deletion">- 性能：只需要 3GB I/O</span>
<span class="hljs-deletion">- 性能提升：33 倍</span>
</code></pre>
<h5 data-id="heading-8">2. 谓词下推（Predicate Pushdown）</h5>
<pre><code class="hljs language-ini" lang="ini">传统做法：
WHERE age &gt; 30 AND <span class="hljs-attr">city</span> = <span class="hljs-string">'NYC'</span>
    ↓
读取所有数据
    ↓
内存中应用过滤

问题：读了不需要的行

Lance 优化：
WHERE age &gt; 30 AND <span class="hljs-attr">city</span> = <span class="hljs-string">'NYC'</span>
    ↓
检查是否有索引：
- age 有 BTree 索引
- city 有 Bitmap 索引
    ↓
使用索引快速获取候选行
    ↓
只读这些候选行的数据
</code></pre>
<p><strong>实现示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Scanner</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">apply_predicate_pushdown</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u32</span>&gt;&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">candidates</span> = (<span class="hljs-number">0</span>..<span class="hljs-keyword">self</span>.dataset.<span class="hljs-title function_ invoke__">row_count</span>()).collect::&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;();
        
        <span class="hljs-keyword">for</span> <span class="hljs-variable">filter</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">self</span>.filters {
            <span class="hljs-comment">// 尝试使用索引</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(index) = <span class="hljs-keyword">self</span>.dataset.<span class="hljs-title function_ invoke__">get_index</span>(&amp;filter.column) {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">matching</span> = index.<span class="hljs-title function_ invoke__">search</span>(&amp;filter.value)?;
                candidates.<span class="hljs-title function_ invoke__">retain</span>(|id| matching.<span class="hljs-title function_ invoke__">contains</span>(id));
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 无索引，需要全扫描此列</span>
                <span class="hljs-comment">// 延迟到实际读取时</span>
            }
        }
        
        <span class="hljs-title function_ invoke__">Ok</span>(candidates)
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">🏗️ 第二部分：构建器模式详解</h3>
<h4 data-id="heading-10">链式调用</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python 中的构建器模式</span>
results = dataset.scan() \
    .select([<span class="hljs-string">"id"</span>, <span class="hljs-string">"name"</span>, <span class="hljs-string">"age"</span>]) \  <span class="hljs-comment"># 投影</span>
    .where(<span class="hljs-string">"age &gt; 30"</span>) \              <span class="hljs-comment"># 过滤 1</span>
    .where(<span class="hljs-string">"city = 'NYC'"</span>) \          <span class="hljs-comment"># 过滤 2</span>
    .limit(<span class="hljs-number">10</span>) \                      <span class="hljs-comment"># 限制</span>
    .offset(<span class="hljs-number">5</span>) \                      <span class="hljs-comment"># 偏移</span>
    .to_pandas()                      <span class="hljs-comment"># 执行</span>
</code></pre>
<h4 data-id="heading-11">内部转换</h4>
<pre><code class="hljs language-scss" lang="scss">用户调用：<span class="hljs-built_in">scan</span>()<span class="hljs-selector-class">.select</span>([...])<span class="hljs-selector-class">.where</span>(...)<span class="hljs-selector-class">.limit</span>(<span class="hljs-number">10</span>)

内部状态转换：

<span class="hljs-number">1</span>. <span class="hljs-built_in">scan</span>()
   Scanner { projection: None, filters: [], limit: None }

<span class="hljs-number">2</span>. <span class="hljs-selector-class">.select</span>(["id", "name"])
   Scanner { projection: <span class="hljs-built_in">Some</span>([<span class="hljs-string">"id"</span>, <span class="hljs-string">"name"</span>]), filters: [], limit: None }

<span class="hljs-number">3</span>. <span class="hljs-selector-class">.where</span>("age &gt; <span class="hljs-number">30</span>")
   Scanner { projection: <span class="hljs-built_in">Some</span>([<span class="hljs-string">"id"</span>, <span class="hljs-string">"name"</span>]), filters: [age &gt; <span class="hljs-number">30</span>], limit: None }

<span class="hljs-number">4</span>. <span class="hljs-selector-class">.limit</span>(<span class="hljs-number">10</span>)
   Scanner { projection: <span class="hljs-built_in">Some</span>([<span class="hljs-string">"id"</span>, <span class="hljs-string">"name"</span>]), filters: [age &gt; <span class="hljs-number">30</span>], limit: <span class="hljs-built_in">Some</span>(<span class="hljs-number">10</span>) }

<span class="hljs-number">5</span>. <span class="hljs-selector-class">.to_pandas</span>()  <span class="hljs-comment">// 执行</span>
   构建执行计划 → 执行 → 转换为 Pandas
</code></pre>
<h4 data-id="heading-12">优化重排</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Scanner</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">optimize_filters</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-comment">// 优化 1：谓词重排（高选择性的放前面）</span>
        <span class="hljs-keyword">self</span>.filters.<span class="hljs-title function_ invoke__">sort_by_key</span>(|f| {
            <span class="hljs-comment">// 估计选择性（返回的行数百分比）</span>
            <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">estimate_selectivity</span>(f)
        });
        
        <span class="hljs-comment">// 优化 2：合并相同列的过滤</span>
        <span class="hljs-keyword">self</span>.filters = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">merge_filters_on_same_column</span>(&amp;<span class="hljs-keyword">self</span>.filters);
        
        <span class="hljs-comment">// 优化 3：检查可以用索引的过滤</span>
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">identify_index_compatible_filters</span>();
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-13">💡 第三部分：查询优化实例</h3>
<h4 data-id="heading-14">例子 1：简单查询</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> lance

users = lance.<span class="hljs-built_in">open</span>(<span class="hljs-string">"users.lance"</span>)

<span class="hljs-comment"># 查询</span>
results = users.scan() \
    .select([<span class="hljs-string">"id"</span>, <span class="hljs-string">"name"</span>]) \
    .where(<span class="hljs-string">"age &gt; 30"</span>) \
    .to_pandas()

<span class="hljs-comment"># Scanner 执行计划：</span>
<span class="hljs-comment"># 1. 识别需要的列：{id, name, age}</span>
<span class="hljs-comment"># 2. 检查过滤条件：age &gt; 30</span>
<span class="hljs-comment">#    - age 有 BTree 索引</span>
<span class="hljs-comment">#    - 使用索引获取候选行</span>
<span class="hljs-comment"># 3. 读取计划：</span>
<span class="hljs-comment">#    - 使用索引找出 age &gt; 30 的行</span>
<span class="hljs-comment">#    - 从磁盘读取这些行的 id, name, age 列</span>
<span class="hljs-comment">#    - 过滤 age &gt; 30</span>
<span class="hljs-comment">#    - 投影 id, name</span>
<span class="hljs-comment"># 4. 执行</span>

<span class="hljs-comment"># 性能：</span>
<span class="hljs-comment"># 100万行表，只返回10万行</span>
<span class="hljs-comment"># 无优化：读 100万行 × 3列 = 3GB I/O</span>
<span class="hljs-comment"># 有优化：读 10万行 × 3列 = 300MB I/O</span>
<span class="hljs-comment"># 提升：10 倍</span>
</code></pre>
<h4 data-id="heading-15">例子 2：向量搜索 + 过滤</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

products = lance.<span class="hljs-built_in">open</span>(<span class="hljs-string">"products.lance"</span>)

<span class="hljs-comment"># 向量搜索 + 标量过滤</span>
query = np.random.rand(<span class="hljs-number">768</span>).astype(np.float32)

results = products.search(query, k=<span class="hljs-number">100</span>) \
    .where(<span class="hljs-string">"price &lt; 500 AND category = 'electronics'"</span>) \
    .to_pandas()

<span class="hljs-comment"># Scanner 执行计划：</span>
<span class="hljs-comment"># 1. 向量搜索（使用 IVF_PQ 索引）</span>
<span class="hljs-comment">#    - 得到 1000 个候选（k × 10）</span>
<span class="hljs-comment"># 2. 标量过滤</span>
<span class="hljs-comment">#    - 使用 price BTree 索引</span>
<span class="hljs-comment">#    - 使用 category Bitmap 索引</span>
<span class="hljs-comment">#    - 得到 200 个候选</span>
<span class="hljs-comment"># 3. 精确距离计算和排序</span>
<span class="hljs-comment">#    - 计算 200 个向量的精确距离</span>
<span class="hljs-comment">#    - 返回前 100 个</span>

<span class="hljs-comment"># 性能：</span>
<span class="hljs-comment"># 1000万商品，返回 100 个</span>
<span class="hljs-comment"># 无索引：扫描 1000万，计算距离</span>
<span class="hljs-comment"># 有索引：扫描 1000（向量索引），200（标量），计算 200</span>
<span class="hljs-comment"># 提升：50 倍（向量）+ 5 倍（标量）= 250 倍</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">📊 执行流程示意</h3>
<pre><code class="hljs language-ini" lang="ini">用户查询
    ↓
Scanner 构建
    ↓
优化器分析
├─ 投影分析：需要哪些列
├─ 过滤分析：可用的索引
└─ 成本估计：选择最优执行路径
    ↓
执行计划生成
├─ 索引扫描（如果有索引）
├─ 列读取（投影下推）
├─ 过滤应用（谓词下推）
└─ 结果处理（排序、聚合）
    ↓
并行执行
├─ Fragment 1: <span class="hljs-section">[执行计划]</span>
├─ Fragment 2: <span class="hljs-section">[执行计划]</span>
└─ Fragment N: <span class="hljs-section">[执行计划]</span>
    ↓
合并结果
    ↓
返回给用户
</code></pre>
<hr/>
<h3 data-id="heading-17">📚 总结</h3>
<p>Scanner 通过以下机制实现高效查询：</p>
<ol>
<li><strong>投影下推</strong>：只读需要的列</li>
<li><strong>谓词下推</strong>：尽早过滤行</li>
<li><strong>索引利用</strong>：使用可用的索引加速</li>
<li><strong>成本优化</strong>：选择最优的执行计划</li>
<li><strong>并行执行</strong>：多 Fragment 并行处理</li>
</ol>
<p>下一章将讲解数据写入流程，即数据如何进入 Lance。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[保姆级！Oracle→达梦零停机迁移攻略，5 步操作，业务零影响！]]></title>    <link>https://juejin.cn/post/7576923573778104362</link>    <guid>https://juejin.cn/post/7576923573778104362</guid>    <pubDate>2025-11-27T02:36:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576923573778104362" data-draft-id="7577171133432430633" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="保姆级！Oracle→达梦零停机迁移攻略，5 步操作，业务零影响！"/> <meta itemprop="keywords" content="数据库,程序员"/> <meta itemprop="datePublished" content="2025-11-27T02:36:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NineData"/> <meta itemprop="url" content="https://juejin.cn/user/1684900320129816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            保姆级！Oracle→达梦零停机迁移攻略，5 步操作，业务零影响！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1684900320129816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NineData
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T02:36:23.000Z" title="Thu Nov 27 2025 02:36:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>距离 2027 年达成 100% 信创替代的时间目标仅剩 2 年不到的时间，还在使用 Oracle 的企业，需要尽快提上日程了。本文针对使用 Oracle 的企业，介绍如何轻松实现 Oracle 到达梦数据库的不停机迁移。</p>
<p>真正做过 Oracle &gt; 达梦迁移的人都知道，最大的挑战不在工具，而是贯穿了调研、评估、方案选择、语法改造、分批迁移、实时同步、校验、调优在内的复杂工程。这使得迁移过程中的不确定因素极多。</p>
<p>并且 Oracle 普遍用作企业的线上业务支撑，<strong>为了不影响业务运行，迁移必须做到不停机、可回滚、数据一致性强、风险可控。</strong></p>
<p>基于上述挑战，NineData 在近期已完全支持了 Oracle 到达梦数据库的不停机迁移！只要你“想迁”，就马上“能迁”！NineData 已经替你解决了几乎所有的技术难题。</p>
<h2 data-id="heading-0">NineData 替你解决了哪些问题？</h2>
<p>首先来谈一下 NineData 的价值，在从 Oracle 迁移到达梦这件事情上，NineData 把未来需要几个月、甚至半年才能完成的迁移工作，压缩到几天甚至几小时（按数据量计），并且丝毫不影响线上业务。</p>
<p>下面是 NineData 为你解决的核心问题：</p>
<ul>
<li><strong>全自动结构转换</strong>：通过内部定义的规则，全自动完成 Oracle 到达梦的字段结构转换。无需手动在目标建表。</li>
<li><strong>TB 级数据的全量快速迁移</strong>：通过多分片并行传输优化传输速度，并支持断点续传功能，实现海量数据稳定迁移。</li>
<li><strong>迁移过程零停机</strong>：基于源端日志实时捕获新增数据，并同步至目标。对源端影响几乎为 0，不影响业务。</li>
<li><strong>全自动一致性验证</strong>：迁移完成后，对源端和目标端的数据执行全量一致性对比，差异定位到行、列级别，并提供可直接执行的修复 SQL。</li>
<li><strong>任务监控与失败告警</strong>：提供全链路任务监控 + 失败告警体系，迁移过程中任何异常，你都可以第一时间知道，以第一时间进行修复。</li>
<li><strong>全图形化操作界面</strong>：所有迁移脚本和流程通通图形化，对象配置、监控大屏、一键启停、错误告警等等，做到有手就会用。</li>
</ul>
<h2 data-id="heading-1">操作示例</h2>
<p>简单几个步骤即可完成复制任务的配置。</p>
<ol>
<li>选择源和目标数据源，开启增量复制。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d43aa833d0c54ca98a70c787e06cb0c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815783&amp;x-signature=3X%2FB8c9fCP47ZOesl07VIZnyKGU%3D" alt="DM_001.PNG" loading="lazy"/></p>
<ol start="2">
<li>选择需要复制的数据库对象（Schema/库/表/列）。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2536450893434e17865fb8d1fe7da7ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815783&amp;x-signature=WstBTfJdfOVO5fmkTrPEoFOyaL4%3D" alt="DM_002.PNG" loading="lazy"/></p>
<ol start="3">
<li>配置映射关系。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9089140904774456b80661289854b118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815783&amp;x-signature=5%2B9%2FpANYO7bb0eMfqE%2FTGset%2Ba8%3D" alt="DM_003.PNG" loading="lazy"/></p>
<ol start="4">
<li>系统自动预检查。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0615dfd028df4fa5a0ce964023471f03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815783&amp;x-signature=zdPf3rPMIOGLdQPI6kp%2BW0Hlx98%3D" alt="DM_004.PNG" loading="lazy"/></p>
<ol start="5">
<li>实时复制任务启动成功！</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6258c75819394d8cbe0a37b4c354c59c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmluZURhdGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815783&amp;x-signature=yG%2FNbMwdN84qqNd07ylHmhukNqM%3D" alt="DM_005.PNG" loading="lazy"/></p>
<p>至此，配置工作已经全部完成！ 剩下的就交给 NineData 会自动完成，然后在业务低峰期手动切换业务即可。</p>
<h2 data-id="heading-2">安全与合规</h2>
<p>在国产化迁移中，数据安全永远是第一位的。</p>
<p>从 Oracle 读取数据、传输数据、写入达梦数据库，再到最终切换，每一个环节都必须做到安全可控、最小权限、全程可追溯。</p>
<p>NineData 针对 Oracle &gt; 达梦迁移场景，构建了多层安全体系，确保整个迁移过程稳妥可靠：</p>
<ul>
<li><strong>数据传输全程加密</strong>：无论是跨 IDC、跨云，还是本地网络迁移，都确保数据不被窃取、篡改。</li>
<li><strong>隔离式任务管理</strong>：只有具备目标数据源对应访问权限的角色才能创建、修改迁移任务，避免“误操作”和“越权操作”。</li>
<li><strong>全链路审计</strong>：从结构转换、数据迁移到增量同步，所有操作均可追踪和回放，满足金融、政务等对审计合规的严苛要求。</li>
</ul>
<p>公司层面，NineData 已通过多项国际与国内权威安全认证：</p>
<p>✅ ISO/IEC 27001 信息安全管理体系认证</p>
<p>✅ ISO/IEC 27017 云安全管理体系认证</p>
<p>✅ ISO/IEC 20000 信息技术服务管理体系认证</p>
<p>✅ ISO 9001 质量管理体系认证</p>
<p>✅ 国家网络安全等级保护三级（等保三级）认证</p>
<p>这些认证确保你在进行数据迁移时，不仅流程安全、数据安全，而且平台本身也具备严格的行业级安全保证。无论数据规模多大，都能放心、安心、合规地完成关键数据的迁移与切换。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[探秘新一代向量存储格式Lance-format (十二) 数据写入流程]]></title>    <link>https://juejin.cn/post/7576888607481085971</link>    <guid>https://juejin.cn/post/7576888607481085971</guid>    <pubDate>2025-11-27T02:38:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576888607481085971" data-draft-id="7576923573778120746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="探秘新一代向量存储格式Lance-format (十二) 数据写入流程"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-27T02:38:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            探秘新一代向量存储格式Lance-format (十二) 数据写入流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T02:38:18.000Z" title="Thu Nov 27 2025 02:38:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第12章：数据写入流程</h2>
<h3 data-id="heading-1">🎯 核心概览</h3>
<p>写入是数据进入 Lance 的关键路径。本章详解 WriteParams 配置、批量写入优化、事务处理和提交机制。</p>
<hr/>
<h3 data-id="heading-2">📊 第一部分：WriteParams 配置</h3>
<h4 data-id="heading-3">What - WriteParams 是什么？</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">WriteParams</span> {
    <span class="hljs-comment">/// 最大行数/Fragment</span>
    <span class="hljs-keyword">pub</span> max_rows_per_file: <span class="hljs-type">u32</span>,
    
    <span class="hljs-comment">/// 最大字节数/Fragment  </span>
    <span class="hljs-keyword">pub</span> max_bytes_per_file: <span class="hljs-type">u64</span>,
    
    <span class="hljs-comment">/// 写入模式</span>
    <span class="hljs-keyword">pub</span> mode: WriteMode,  <span class="hljs-comment">// Create, Append, Overwrite</span>
    
    <span class="hljs-comment">/// 并发写入 Fragment 数</span>
    <span class="hljs-keyword">pub</span> max_concurrent_writes: <span class="hljs-type">usize</span>,
    
    <span class="hljs-comment">/// 编码配置</span>
    <span class="hljs-keyword">pub</span> encoding_config: EncodingConfig,
}

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">WriteMode</span> {
    Create,      <span class="hljs-comment">// 创建新数据集</span>
    Append,      <span class="hljs-comment">// 追加到现有数据集</span>
    Overwrite,   <span class="hljs-comment">// 覆盖现有数据集</span>
}
</code></pre>
<h4 data-id="heading-4">Why - WriteParams 为什么重要？</h4>
<pre><code class="hljs language-makefile" lang="makefile">性能影响分析：

场景：写入 1 亿行数据

配置 A（默认）：
<span class="hljs-section">max_rows_per_file: 1000000</span>
<span class="hljs-section">max_bytes_per_file: 256MB</span>

Fragment 数：~100 个
写入时间：~10 分钟
内存使用：~1GB

配置 B（小 Fragment）：
<span class="hljs-section">max_rows_per_file: 100000</span>
<span class="hljs-section">max_bytes_per_file: 25MB</span>

Fragment 数：~1000 个
写入时间：~15 分钟（更多开销）
内存使用：~100MB（更低）
查询时间：更快（更小的缓存）

配置 C（大 Fragment）：
<span class="hljs-section">max_rows_per_file: 10000000</span>
<span class="hljs-section">max_bytes_per_file: 2.5GB</span>

Fragment 数：~10 个
写入时间：~5 分钟（更快）
内存使用：~5GB
查询时间：可能更慢（缓存压力）

选择标准：
- 实时数据：小 Fragment（方便更新）
- 批量数据：大 Fragment（写入快）
</code></pre>
<hr/>
<h3 data-id="heading-5">🏗️ 第二部分：批量写入优化</h3>
<h4 data-id="heading-6">写入流程</h4>
<pre><code class="hljs language-arduino" lang="arduino">用户提供数据（Pandas DataFrame / Arrow Table）
    ↓
转换为 RecordBatch 流
    ↓
启动 Transaction
    ↓
分配 WriteBuffer
    ↓
逐 batch 处理：
├─ 接收 batch（可能几千行）
├─ 累积到 buffer（<span class="hljs-number">1</span>M 行或 <span class="hljs-number">256</span>MB）
├─ buffer 满时
│  ├─ 编码数据
│  ├─ 压缩
│  ├─ 写入文件
│  ├─ 创建 Fragment 元数据
│  └─ 清空 buffer
└─ 继续接收
    ↓
所有数据处理完
    ↓
Flush 最后的 buffer
    ↓
创建 Manifest
    ↓
原子提交
</code></pre>
<h4 data-id="heading-7">编码优化</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">WriteBuffer</span> {
    <span class="hljs-comment">/// 每列的原始数据</span>
    columns: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;&gt;,
    
    <span class="hljs-comment">/// 累积的行数</span>
    row_count: <span class="hljs-type">usize</span>,
    
    <span class="hljs-comment">/// 容量限制</span>
    capacity: <span class="hljs-type">usize</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">WriteBuffer</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">flush</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;DataFile&gt; {
        <span class="hljs-comment">// 步骤 1：为每列选择编码</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">encoders</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">choose_encoders</span>();
        
        <span class="hljs-comment">// 步骤 2：并行编码每列</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">encoded_columns</span> = futures::future::<span class="hljs-title function_ invoke__">join_all</span>(
            encoders.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>().<span class="hljs-title function_ invoke__">map</span>(|(i, encoder)| {
                encoder.<span class="hljs-title function_ invoke__">encode</span>(&amp;<span class="hljs-keyword">self</span>.columns[i])
            })
        ).<span class="hljs-keyword">await</span>;
        
        <span class="hljs-comment">// 步骤 3：拼接编码后的数据</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file_data</span> = <span class="hljs-title function_ invoke__">combine_encoded_columns</span>(&amp;encoded_columns)?;
        
        <span class="hljs-comment">// 步骤 4：写入对象存储</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file_path</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"data/{}.lance"</span>, <span class="hljs-keyword">self</span>.next_file_id);
        <span class="hljs-keyword">self</span>.store.<span class="hljs-title function_ invoke__">put</span>(&amp;file_path, file_data).<span class="hljs-keyword">await</span>?;
        
        <span class="hljs-comment">// 步骤 5：清空 buffer</span>
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">reset</span>();
        
        <span class="hljs-title function_ invoke__">Ok</span>(DataFile { path: file_path, row_count: <span class="hljs-keyword">self</span>.row_count })
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">choose_encoders</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> ColumnDataEncoder&gt;&gt; {
        <span class="hljs-keyword">self</span>.columns.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>().<span class="hljs-title function_ invoke__">map</span>(|(i, col_data)| {
            <span class="hljs-comment">// 分析列的统计信息</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">stats</span> = <span class="hljs-title function_ invoke__">analyze_column</span>(col_data);
            
            <span class="hljs-comment">// 选择最优编码</span>
            <span class="hljs-keyword">match</span> &amp;<span class="hljs-keyword">self</span>.schema.fields[i].data_type {
                DataType::Int64 =&gt; {
                    <span class="hljs-keyword">if</span> stats.cardinality &lt; <span class="hljs-number">0.01</span> {
                        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(DictionaryEncoder::<span class="hljs-title function_ invoke__">new</span>())
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> stats.is_monotonic {
                        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(DeltaEncoder::<span class="hljs-title function_ invoke__">new</span>())
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(BitpackingEncoder::<span class="hljs-title function_ invoke__">new</span>(stats.bit_width))
                    }
                }
                DataType::Utf8 =&gt; {
                    <span class="hljs-keyword">if</span> stats.cardinality &lt; <span class="hljs-number">0.1</span> {
                        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(DictionaryEncoder::<span class="hljs-title function_ invoke__">new</span>())
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> stats.is_sorted {
                        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(PrefixEncoder::<span class="hljs-title function_ invoke__">new</span>())
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(RawEncoder::<span class="hljs-title function_ invoke__">new</span>())
                    }
                }
                _ =&gt; <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(RawEncoder::<span class="hljs-title function_ invoke__">new</span>()),
            }
        }).<span class="hljs-title function_ invoke__">collect</span>()
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-8">💫 第三部分：事务与提交机制</h3>
<h4 data-id="heading-9">写入事务</h4>
<pre><code class="hljs language-bash" lang="bash">Transaction 生命周期：

BEGIN WRITE
    ↓
创建临时工作空间
    ↓
写入数据文件到临时位置
    ├─ data/_tmp/fragment_0.lance
    ├─ data/_tmp/fragment_1.lance
    └─ data/_tmp/fragment_N.lance
    ↓
验证数据（可选）
    ├─ 检查数据完整性
    ├─ 检查 Schema 兼容性
    └─ 检查约束（如果有）
    ↓
创建新 Manifest
    ├─ 指向新的 Fragment 文件
    ├─ 更新版本号
    └─ 记录时间戳
    ↓
提交：
├─ 1. 将临时数据文件原子重命名
├─ 2. 写入新 Manifest
├─ 3. 更新 _latest 指针
└─ 4. 成功返回
    ↓
如果失败，清理临时文件
</code></pre>
<h4 data-id="heading-10">提交处理器</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">CommitHandler</span> {
    store: Arc&lt;<span class="hljs-keyword">dyn</span> ObjectStore&gt;,
    lock_manager: Arc&lt;<span class="hljs-keyword">dyn</span> LockManager&gt;,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">CommitHandler</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">commit_write</span>(
        &amp;<span class="hljs-keyword">self</span>,
        manifest: Manifest,
        temp_files: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;,
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">u64</span>&gt; {
        <span class="hljs-comment">// 步骤 1：获取分布式锁</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_lock</span> = <span class="hljs-keyword">self</span>.lock_manager.<span class="hljs-title function_ invoke__">acquire_lock</span>().<span class="hljs-keyword">await</span>?;
        
        <span class="hljs-comment">// 步骤 2：读取当前版本</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">current_version</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">read_current_version</span>().<span class="hljs-keyword">await</span>?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">new_version</span> = current_version + <span class="hljs-number">1</span>;
        
        <span class="hljs-comment">// 步骤 3：重命名临时文件</span>
        <span class="hljs-keyword">for</span> <span class="hljs-variable">temp_file</span> <span class="hljs-keyword">in</span> &amp;temp_files {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">final_path</span> = temp_file.<span class="hljs-title function_ invoke__">replace</span>(<span class="hljs-string">"_tmp/"</span>, <span class="hljs-string">""</span>);
            <span class="hljs-keyword">self</span>.store.<span class="hljs-title function_ invoke__">move_object</span>(temp_file, &amp;final_path).<span class="hljs-keyword">await</span>?;
        }
        
        <span class="hljs-comment">// 步骤 4：写入 Manifest</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">manifest_path</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"_versions/{}.manifest"</span>, new_version);
        <span class="hljs-keyword">self</span>.store.<span class="hljs-title function_ invoke__">put</span>(&amp;manifest_path, manifest.<span class="hljs-title function_ invoke__">serialize</span>()).<span class="hljs-keyword">await</span>?;
        
        <span class="hljs-comment">// 步骤 5：更新最新版本指针</span>
        <span class="hljs-keyword">self</span>.store.<span class="hljs-title function_ invoke__">put</span>(<span class="hljs-string">"_latest"</span>, new_version.<span class="hljs-title function_ invoke__">to_string</span>().<span class="hljs-title function_ invoke__">into</span>()).<span class="hljs-keyword">await</span>?;
        
        <span class="hljs-comment">// 步骤 6：释放锁</span>
        <span class="hljs-title function_ invoke__">drop</span>(_lock);
        
        <span class="hljs-title function_ invoke__">Ok</span>(new_version)
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-11">📊 写入性能优化</h3>
<h4 data-id="heading-12">批量大小的影响</h4>
<pre><code class="hljs language-diff" lang="diff">写入 1GB 数据的性能对比：

Batch 大小太小（1000 行）：
<span class="hljs-deletion">- 频繁编码、压缩、写入</span>
<span class="hljs-deletion">- 系统开销大</span>
<span class="hljs-deletion">- 时间：2 分钟</span>

Batch 大小合适（100K 行）：
<span class="hljs-deletion">- 编码、压缩效率高</span>
<span class="hljs-deletion">- 系统开销均衡</span>
<span class="hljs-deletion">- 时间：10 秒</span>

Batch 大小太大（10M 行）：
<span class="hljs-deletion">- 内存占用高（可能 10GB+）</span>
<span class="hljs-deletion">- 可能 OOM</span>
<span class="hljs-deletion">- 时间：5 秒（但可能失败）</span>

推荐：100K-1M 行/batch
</code></pre>
<h4 data-id="heading-13">并发写入</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> lance
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor

<span class="hljs-comment"># 并发写入多个 Fragment</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">write_partition</span>(<span class="hljs-params">df_partition</span>):
    dataset = lance.<span class="hljs-built_in">open</span>(<span class="hljs-string">"data.lance"</span>, mode=<span class="hljs-string">"append"</span>)
    dataset.add(df_partition)

<span class="hljs-comment"># 分割数据为 10 个分区</span>
partitions = [df[i::<span class="hljs-number">10</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]

<span class="hljs-comment"># 并发写入</span>
<span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">4</span>) <span class="hljs-keyword">as</span> executor:
    futures = [executor.submit(write_partition, p) <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> partitions]
    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> futures:
        f.result()

<span class="hljs-comment"># 性能：</span>
<span class="hljs-comment"># 串行：10 × 1分钟 = 10 分钟</span>
<span class="hljs-comment"># 并发（4 workers）：10 分钟 / 4 ≈ 2.5 分钟</span>
<span class="hljs-comment"># 但注意：并发写入需要事务隔离</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">💡 最佳实践</h3>
<h4 data-id="heading-15">何时使用哪种 WriteMode</h4>
<pre><code class="hljs language-ini" lang="ini">WriteMode::Create
用途：创建新数据集
示例：
  <span class="hljs-attr">dataset</span> = lance.write_dataset(df, <span class="hljs-string">"new.lance"</span>, mode=<span class="hljs-string">"create"</span>)
性能：最快（无需读取现有版本）

WriteMode::Append
用途：添加新数据
示例：
  <span class="hljs-attr">dataset</span> = lance.open(<span class="hljs-string">"existing.lance"</span>)
  dataset.add(new_df)
性能：较快（只需读取最新版本）
注意：自动创建新 Fragment

WriteMode::Overwrite
用途：替换所有数据
示例：
  <span class="hljs-attr">dataset</span> = lance.write_dataset(df, <span class="hljs-string">"data.lance"</span>, mode=<span class="hljs-string">"overwrite"</span>)
性能：最慢（需要删除旧版本的文件）
注意：旧版本变成不可访问的垃圾数据（可配置清理）
</code></pre>
<h4 data-id="heading-16">处理大文件</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> lance

<span class="hljs-comment"># 方法 1：分块读取和写入</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">write_large_csv_incremental</span>(<span class="hljs-params">csv_path, output_path</span>):
    chunks = pd.read_csv(csv_path, chunksize=<span class="hljs-number">100000</span>)
    
    <span class="hljs-keyword">for</span> i, chunk <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(chunks):
        <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span>:
            dataset = lance.write_dataset(chunk, output_path, mode=<span class="hljs-string">"create"</span>)
        <span class="hljs-keyword">else</span>:
            dataset = lance.<span class="hljs-built_in">open</span>(output_path)
            dataset.add(chunk)

<span class="hljs-comment"># 方法 2：使用流式 API（如果支持）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">write_large_parquet_streaming</span>(<span class="hljs-params">parquet_path, output_path</span>):
    reader = pd.read_parquet(parquet_path, engine=<span class="hljs-string">"pyarrow"</span>)
    dataset = lance.write_dataset(reader, output_path, mode=<span class="hljs-string">"create"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-17">📚 总结</h3>
<p>数据写入是 Lance 的关键操作：</p>
<ol>
<li><strong>WriteParams 配置</strong>：影响 Fragment 大小和数量</li>
<li><strong>批量优化</strong>：编码、压缩的自动选择</li>
<li><strong>事务保证</strong>：ACID 属性的实现</li>
<li><strong>并发处理</strong>：多 Fragment 的并行写入</li>
<li><strong>性能调优</strong>：Batch 大小、并发数的选择</li>
</ol>
<p>下一章将讨论数据更新和 Schema 演化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Agent Skills：将 Workflow 打进技能包]]></title>    <link>https://juejin.cn/post/7576953459543457846</link>    <guid>https://juejin.cn/post/7576953459543457846</guid>    <pubDate>2025-11-27T02:37:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576953459543457846" data-draft-id="7577171133432463401" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Agent Skills：将 Workflow 打进技能包"/> <meta itemprop="keywords" content="Agent,Claude"/> <meta itemprop="datePublished" content="2025-11-27T02:37:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Agent Skills：将 Workflow 打进技能包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T02:37:37.000Z" title="Thu Nov 27 2025 02:37:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在这个 AI 技术蓬勃发展的时代，每天都有新东西。每次浏览社交媒体，总能看到自媒体和 KOL 们极力的鼓吹着新产品、新技术，满口「革命」和「未来」，起初真的给我整 FOMO 了，但后来越来越感觉到厌烦，「Function Calling」、「Tool Use」、「MCP」、「Agent」、「Agentic AI」 …… 还有一大堆别的 AI 术语，你很难分清这些概念到底代表了技术的实质突破，还是同一件事被营销话术反复包装，跟前端火的那些年如出一辙，不禁让人感叹 AI 领域的概念也是通货膨胀了。</p>
<p>在 10 月中旬，Anthropic  悄然推出了 Agent Skills（后简称 Skills），不出意外，技术社区又炸锅了。有人发出质疑，认为又在炒概念，也有人认为 Skills 虽然简单，但却是比 MCP 还要强大的玩意。</p>
<p>最近我花了些时间深入研究 Skills，查阅官方文档，看了些 Youtube 视频，动手写了几个示例。结论是它没有某些 KOL 吹得那么神，但确实有其独到之处。而这背后，潜藏着 Anthropic 试图在 MCP 后进一步标准化 LLM 应用的野心。</p>
<p>本文将分享我对 Skills 的理解和思考，希望能为想要了解这项技术的朋友提供一些参考，有说的不对的地方欢迎大家批评指正。</p>
<h2 data-id="heading-0">Why Skills？</h2>
<p>实际上我认为 Skill 想要解决的问题很简单，解决 Prompt Engineering 的复用问题。</p>
<p>试想这样一个场景，你经常写技术文章，每次都要提醒 AI：</p>
<ul>
<li>用轻松的语气，不要输出太多像列表一样的结构化数据</li>
<li>多用代码示例，少讲抽象概念</li>
<li>每段不超过 300 字</li>
</ul>
<p>说实在这还是挺麻烦的，但是合理使用 AI 我们的还是能做的到的，但是你注意到了吗？这个 Workflow 很难迁移到你的下一次 AI 对话中，因为这些 Prompt 你要重新输入一遍。</p>
<p>Anthropic 给出的解法就是 Skills，Skills 就是把做某些重复性任务的 Prompt、资源文件（脚本、知识库之类的）打包在一起，在你的下一次对话中，像「Tool Use」一样按需载入，模型自主决定是否按照你给出的 Skills 行动。嘿，如果能够按照预期触发，我们的 workflow 就能变的更简单好用，不用准备那么多提示词了对吧～</p>
<p>当然 Skills 作为 Anthropic 也可以在社区分享，就像 MCP 刚出来就有了一堆 MCP Hub，现在也出现了很多 Skills Hub。</p>
<p>从技术角度看，Skills 确实有用，但别高估它。有人说 Skills 会革了 n8n、Dify 这些 Agent 平台的命，我是不太信的。Skills 本质上就是把你的 Prompt 和 workflow 打个包，让它能复用。这解决的是不想每次都重复输入指令的问题。但 n8n、Dify 这些平台解决的是什么？是要把十几个步骤串起来，中间还有条件判断、错误处理、定时触发这种复杂编排问题。这俩根本不是一个维度的东西。</p>
<p>Skills 适合那种重复性的、相对标准化的单个任务，比如代码审查、按规范生成文档、检查数据格式这种。你定义好规则，以后每次 Claude 自动按这套规则来，挺方便。但要是你的工作流程是多步骤、多服务的协同，Skills 就玩不转了。而且这些 Agent 平台有可视化界面，非技术人员也能配置，Skills 你还得写代码打包，门槛摆在那。</p>
<p>所以别被营销话术忽悠了。Skills 确实降低了一些简单场景的门槛，以前可能要搭个小 Agent 的事，现在一个 Skill 就搞定。但它不是什么革命性的东西，更不可能把这些平台干掉，顶多算个补充。</p>
<h3 data-id="heading-1">Skills vs MCP</h3>
<p>很多人搞不清楚为何有了 MCP 还需要 Skills，这里插一段解释下。</p>
<p>实际上两者的核心目标不一致，MCP 的目标是帮助 AI 连接外部世界，读取外部世界的数据，向外部世界输出影响，Anthropic 将其描述为「USB Hub」，强调的连接能力。而 Skills 的目标是封装特定领域的知识和 workflow，专注于执行特定任务，要比喻的话也是「瑞士军刀」。这俩一个主外，一个主内，是可以配合使用的。</p>
<h3 data-id="heading-2">Skills vs Projects</h3>
<p>还有一个相近的功能叫做 Projects，在 Claude 和 ChatGPT 上都有类似功能，简单来说就是可以创建一个 workspace，我们把做某件事（比如写现在的这篇文章）作为目标，将完成这件事的 Prompt 和 Context 聚拢在一起，AI 会记住项目背景，和当前的进度，帮我们延续思路，不用每次重新解释我们上次聊到哪了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d69d641d3c3e49fa99430057a046d0bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815857&amp;x-signature=lbNw9h%2Fp3XOt3YNs4rVqHIvAh4A%3D" alt="" loading="lazy"/></p>
<p>但 Skills 聚焦在「做事的方法」，更像是一套可复用的 workflow。它不关心你在做哪个项目，而是帮你保持统一的做事风格或标准。而且 Projects 通常是个人用的，没法直接分享；Skills 则可以打包成模板，分享给团队一起用。</p>
<p>从这个角度看，Projects 管项目，Skills 管方法，一个是工作空间，一个是工具箱。</p>
<h2 data-id="heading-3">什么是 Skills？</h2>
<p>说了这么多，Skills 到底长什么样？它是如何实现「Prompt 复用」和「按需加载」的？接下来我们看看 Skills 的技术细节。</p>
<p>如前文所说 Skills 实际上就是包含了 Prompt 和资源文件的包，用于告知 AI 如何完成特定任务，并在不同会话之间复用，其基本结构是这样的：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill.zip
  └── <span class="hljs-keyword">my</span>-skill/
      ├── SKILL.md （必要）
      └── resources/（非必要的其他文件）
</code></pre>
<p>Anthropic 规定 Skill 包必须是一个 zip 包，且里面包含一个同名的文件夹，文件夹里面才是具体内容，其中的 <code>SKILL.md</code> 也是必须的描述了 Skill 的基本信息，并且里面内容也有特殊的规定，而其他文件就自己根据需求随意添加就好了。</p>
<p><code>SKILL.md</code> 类似这样：</p>
<pre><code class="hljs language-md" lang="md">---
name: your-skill-name
<span class="hljs-section">description: Brief description of what this Skill does and when to use it
---</span>

<span class="hljs-section"># Your Skill Name</span>

<span class="hljs-section">## Instructions</span>
[Clear, step-by-step guidance for Claude to follow]

<span class="hljs-section">## Examples</span>
[Concrete examples of using this Skill]
</code></pre>
<p>可以看到 <code>SKILL.md</code>  分两部分，一部分是 YAML 的头部，用于存储元数据，其 <code>name</code> 和 <code>description</code> 是必须的。下半部分的 Markdown 就可以随意发挥了。</p>
<p>Claude 为 Skills 提供了代码执行环境。在 Claude.ai 中是隔离的虚拟机，而在 Claude Code 中则是直接在用户的本地环境执行，并提供了一套叫做 <strong>渐进式披露</strong>（progressive disclosure） 的调用策略来控制 Context。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/100273e8dad44f4395aff7b8c9b1743d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815857&amp;x-signature=qVXR6d3BvY39Dfo3RhUfCnmSML4%3D" alt="" loading="lazy"/></p>
<ol>
<li>Level 1: - 元数据 (始终加载)：也就是我们刚刚说的  <code>SKILL.md</code> 中的 YAML 头，会在 Claude 启动时载入并附加在 System Prompt 中，和「Tool Use」差不多</li>
<li>Level 2 - 指令（调用时加载）：也就是我们刚刚说的  <code>SKILL.md</code> 中的 Markdown 部分，当 Claude 确认要调用某个 Skill，就会载入全部的 <code>SKILL.md</code> 内容</li>
<li>Level 3 - 资源文件或代码（按需加载）：当指令让 Claude 采取了某些行为要访问这些文件或是执行代码时，才会载入这些资源文件</li>
</ol>
<p>Anthropic 在 Claude 上提供了一些预制的技能可以开启，也支持用户自己上传 zip 包来使用：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9dc55a0f6be4470af78fb9f6555324b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815857&amp;x-signature=4Ui31fwf%2Fwq%2FyWDcgvlQtY3O7Pc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">实战开发</h2>
<p>理解了 Skills 的原理，最好的学习方式就是动手写一个。虽说我们可以直接让 Claude 根据规范为我们创建一个 Skill（确实很方便），但自己从零开始写一遍，能更深入理解 Skills 的设计思想。</p>
<p>接下来我们创建一个实用的 Skill：<strong>上传图床助手</strong> ：平时在写完技术文章之后，发布的过程其实挺麻烦的，因为我经常使用 Ulysses 写作，导出为 Markdown 后，很多图片引用实际是在本地的，如果要发布一般还是要上传到图床上才能直接用。另外，我引用的一些图片的格式很多地方不支持，需要统一成 png 来上传。</p>
<p>我们的目录结构是这样：</p>
<pre><code class="hljs language-bash" lang="bash">article-publisher/
├── SKILL.md                      <span class="hljs-comment"># Skill 定义和工作流程</span>
└── scripts/
    └── upload_images.py      <span class="hljs-comment"># 上传图片到图床脚本</span>
</code></pre>
<p>首先，创建 <code>SKILL.md</code>，规定整个技能的定义和执行步骤。这里我用了比较直白的写法，虽然不完全符合官方的最佳实践（后面会说为什么），但为了稳定性做了一些妥协：</p>
<pre><code class="hljs language-md" lang="md">---
name: upload-article-images
<span class="hljs-section">description: Upload local images from Markdown files to image hosting. When user says "上传图床" or "upload images", immediately run the script at ~/.claude/skills/upload-article-images/scripts/upload<span class="hljs-emphasis">_images.py
---

# Upload Article Images

To upload images from a Markdown file, execute:

`bash
python3 ~/.claude/skills/upload-article-images/scripts/upload_</span>images.py <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">markdown_file_path</span>&gt;</span></span>
`

## Critical: What NOT to do

- Do NOT read the Markdown file first
- Do NOT list or check image files
- Do NOT check if the script exists
- Do NOT search for files
- Do NOT create a new script
- Do NOT write any Python code
- Do NOT ask the user which image hosting service to use

## What to do

Run the command above. That's it.

The script at `~/.claude/skills/upload-article-images/scripts/upload<span class="hljs-emphasis">_images.py` already exists and handles everything.

## Example

User: "帮我处理 index.md，上传图片到图床"

<span class="hljs-strong">**Correct action:**</span>
`bash
python3 ~/.claude/skills/upload-article-images/scripts/upload_</span>images.py index.md
`

<span class="hljs-strong">**Wrong actions:**</span>
- ❌ Reading index.md first
- ❌ Listing PNG/TIFF files
- ❌ Checking if script exists
- ❌ Creating upload<span class="hljs-emphasis">_images.py
- ❌ Asking about image hosting service

## Dependencies

If error: `pip install requests Pillow`
</span></span></code></pre>
<p>首先，<code>description</code> 里明确写了触发词（"上传图床"、"upload images”），然后直接在开头就给出执行命令，避免 Claude 自己瞎猜，还用了大量的 "Do NOT" 来约束行为（虽然官方不推荐，但实测这样更稳定）</p>
<p>之后的 <code>upload_images.py</code>  写我们主要的图片提取、上传、替换逻辑：</p>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section">#!/usr/bin/env python3</span>
"""
图片上传到图床并替换 Markdown 链接
使用方法：python upload<span class="hljs-emphasis">_images.py &lt;文章.md&gt;
"""

import re
import os
import sys
import requests
from pathlib import Path
from PIL import Image
import tempfile


# 支持的图片格式（图床支持的格式）
SUPPORTED_</span>FORMATS = {".png", ".jpg", ".jpeg", ".gif", ".webp", ".bmp"}

<span class="hljs-section"># 需要转换的格式</span>
CONVERT<span class="hljs-emphasis">_FORMATS = {".tiff", ".tif", ".svg", ".ico", ".heic"}


def convert_</span>image<span class="hljs-emphasis">_format(file_</span>path):
<span class="hljs-code">    """
    将不支持的图片格式转换为 PNG
</span>
<span class="hljs-code">    Args:
        file_path: 原始图片路径
</span>
<span class="hljs-code">    Returns:
        str: 转换后的图片路径（如果需要转换），否则返回原路径
        bool: 是否进行了转换
    """
    file_path = Path(file_path)
    ext = file_path.suffix.lower()
</span>
<span class="hljs-code">    # 如果格式已支持，直接返回
    if ext in SUPPORTED_FORMATS:
        return str(file_path), False
</span>
<span class="hljs-code">    # 需要转换
    if ext in CONVERT_FORMATS or ext not in SUPPORTED_FORMATS:
        try:
            # 打开图片
            img = Image.open(file_path)
</span>
<span class="hljs-code">            # 如果是 RGBA 模式，保持透明度
            # 如果不是，转换为 RGB（PNG 支持两种模式）
            if img.mode in ("RGBA", "LA", "P"):
                # 保持透明度
                pass
            elif img.mode != "RGB":
                img = img.convert("RGB")
</span>
<span class="hljs-code">            # 创建临时 PNG 文件
            temp_dir = tempfile.gettempdir()
            temp_file = Path(temp_dir) / f"{file_path.stem}_converted.png"
</span>
<span class="hljs-code">            # 保存为 PNG
            img.save(temp_file, "PNG")
</span>
<span class="hljs-code">            print(f"   🔄 已转换 {ext} → .png")
            return str(temp_file), True
</span>
<span class="hljs-code">        except Exception as e:
            print(f"   ⚠️  格式转换失败: {e}")
            return str(file_path), False
</span>
<span class="hljs-code">    return str(file_path), False
</span>

def upload<span class="hljs-emphasis">_file(file_</span>path):
<span class="hljs-code">    """
    上传文件到图床
</span>
<span class="hljs-code">    Args:
        file_path: 文件路径
</span>
<span class="hljs-code">    Returns:
        str: 上传后的文件 URL
</span>
<span class="hljs-code">    Raises:
        Exception: 上传失败时抛出异常
    """
    url = "https://xxx.com/upload" # 这里记得替换成你的图床 API
</span>
<span class="hljs-code">    with open(file_path, "rb") as f:
        files = {"file": f}
        response = requests.post(url, files=files)
</span>
<span class="hljs-code">    if response.status_code != 200:
        raise Exception(f"上传失败，状态码: {response.status_code}")
</span>
<span class="hljs-code">    result = response.json()
    file_url = result.get("data", {}).get("url")
</span>
<span class="hljs-code">    if not file_url:
        error_msg = result.get("context", {}).get("message", "上传失败")
        raise Exception(error_msg)
</span>
<span class="hljs-code">    return file_url
</span>

def extract<span class="hljs-emphasis">_local_</span>images(md<span class="hljs-emphasis">_content):
    """提取 Markdown 中的本地图片路径"""
    # 匹配 ![<span class="hljs-string">alt</span>](<span class="hljs-link">path</span>) 格式
    pattern = r"!\[([^\]]*)\]\(([^)]+)\)"
    matches = re.findall(pattern, md_</span>content)

<span class="hljs-code">    local_images = []
    for alt_text, img_path in matches:
        # 排除已经是 URL 的图片
        if not img_path.startswith(("http://", "https://")):
            local_images.append((alt_text, img_path))
</span>
<span class="hljs-code">    return local_images
</span>

def replace<span class="hljs-emphasis">_image_</span>links(md<span class="hljs-emphasis">_file, url_</span>mapping):
<span class="hljs-code">    """替换 Markdown 中的图片链接"""
    with open(md_file, "r", encoding="utf-8") as f:
        content = f.read()
</span>
<span class="hljs-code">    for old_path, new_url in url_mapping.items():
        content = content.replace(f"]({old_path})", f"]({new_url})")
</span>
<span class="hljs-code">    with open(md_file, "w", encoding="utf-8") as f:
        f.write(content)
</span>

def main():
<span class="hljs-code">    if len(sys.argv) &lt; 2:
        print("用法: python upload_images.py &lt;Markdown文件&gt;")
        sys.exit(1)
</span>
<span class="hljs-code">    md_file = sys.argv[1]
</span>
<span class="hljs-code">    if not os.path.exists(md_file):
        print(f"❌ 错误：文件不存在: {md_file}")
        sys.exit(1)
</span>
<span class="hljs-code">    print("🔍 扫描文章中的本地图片...")
</span>
<span class="hljs-code">    with open(md_file, "r", encoding="utf-8") as f:
        content = f.read()
</span>
<span class="hljs-code">    local_images = extract_local_images(content)
</span>
<span class="hljs-code">    if not local_images:
        print("✅ 没有找到需要上传的本地图片")
        return
</span>
<span class="hljs-code">    print(f"📤 找到 {len(local_images)} 张本地图片，开始上传...\n")
</span>
<span class="hljs-code">    url_mapping = {}
    md_dir = Path(md_file).parent
    success_count = 0
    temp_files = []  # 存储需要清理的临时文件
</span>
<span class="hljs-code">    for alt_text, img_path in local_images:
        # 转换为绝对路径
        full_path = (md_dir / img_path).resolve()
</span>
<span class="hljs-code">        if not full_path.exists():
            print(f"⚠️  跳过不存在的文件: {img_path}")
            continue
</span>
<span class="hljs-code">        try:
            # 尝试转换格式（如果需要）
            converted_path, was_converted = convert_image_format(str(full_path))
            if was_converted:
                temp_files.append(converted_path)
</span>
<span class="hljs-code">            # 上传图片
            new_url = upload_file(converted_path)
            url_mapping[img_path] = new_url
            success_count += 1
            print(f"✅ {img_path}")
            print(f"   → {new_url}\n")
        except Exception as e:
            print(f"❌ {img_path} 上传失败: {e}\n")
</span>
<span class="hljs-code">    if url_mapping:
        print("🔄 正在替换 Markdown 中的图片链接...")
        replace_image_links(md_file, url_mapping)
        print(f"✅ 完成！成功上传并替换 {success_count} 张图片的链接")
    else:
        print("❌ 没有成功上传任何图片")
</span>
<span class="hljs-code">    # 清理临时文件
    if temp_files:
        print("\n🧹 清理临时文件...")
        for temp_file in temp_files:
            try:
                Path(temp_file).unlink()
            except Exception as e:
                print(f"   ⚠️  清理失败 {temp_file}: {e}")
</span>

if <span class="hljs-strong">__name__</span> == "<span class="hljs-strong">__main__</span>":
<span class="hljs-code">    main()
</span></code></pre>
<p>注意，这里 <code>https://xxx.com/upload</code> 是一个示例地址，你要修改成自己的图床 API。</p>
<p>我们将我们的 skill 整个文件夹移动到 <code>~/.claude/skills</code> 这样 Claude Code 就可以直接使用了。</p>
<p>我导出一份文档，使用 Cladue Code 测试一下看看：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46176f2471da434cbc013f981931f499~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815857&amp;x-signature=jFK0KIz8Z%2BHYyKHftfe9pYT0RHQ%3D" alt="" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/179c7efb677847658afc200c938ac756~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815857&amp;x-signature=0phHGrLYLy9fT%2Fr6lZeJE6Kj6m4%3D" alt="" loading="lazy"/>
可以看到虽然经历了一些波折，但还是成功了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9d144c6b1724426a6efca85a5384c01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815857&amp;x-signature=hxsvh6JJltQH4NemhNYyGI%2Fhnyw%3D" alt="" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d3f7783a57342fa918731d37cbcae39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764815857&amp;x-signature=Njzu7TVowKVmMtXfF6F6Tq9juxE%3D" alt="" loading="lazy"/>
检查原文可以看到，符合我们的预期，链接已经替换成功了！</p>
<h2 data-id="heading-5">写在最后</h2>
<p>其实本文前面写得很快，最难的部分就是实战。不知道是我的 Prompt 水平不够还是 Skills 这个功能还不够成熟，即使按照官方推荐的写法，让 Claude 调用某个脚本，它还是经常选择自己写一个脚本而不是用我内置好的。</p>
<p>本来我规划了一个更复杂的 Skill：润色文章、上传图片、生成摘要和标签、再设计个封面，一套流程自动化。但测试下来发现稳定性太差，经常在某一步卡住或者跳过关键步骤，最后只好简化成现在这个单一功能的版本。</p>
<p>给想尝试写 Skills 的朋友几个建议：</p>
<ol>
<li><strong>慢慢迭代</strong>：别一上来就搞复杂流程，先做单一功能的 Skill</li>
<li><strong>description 可以适当写详细些</strong>：跟官方推荐的不一样，但把一些重要内容放在这里似乎最有效</li>
<li><strong>英文 Prompt 效果更好</strong>：我自己测试下来，感觉英文 Prompt 更稳定、速度也更快，大家也可以多对比下</li>
<li><strong>降低期望</strong>：Skills 目前还是个新东西，还不够稳定好用</li>
</ol>
<p>Skills 这东西设计理念不错，但目前的效果实在不尽如人意。希望 Anthropic 能在稳定性上多下功夫。不过话说回来，即使有这些问题，对于一些简单重复的任务，Skills 还是能省不少事的。</p>
<p>大家如果有什么使用 Skills 的小技巧，欢迎在评论区跟大家分享～</p>
<h2 data-id="heading-6">参考资料</h2>
<ul>
<li>Claude Agent Skills 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.claude.com%2Fen%2Fdocs%2Fagents-and-tools%2Fagent-skills%2Foverview" target="_blank" title="https://docs.claude.com/en/docs/agents-and-tools/agent-skills/overview" ref="nofollow noopener noreferrer">docs.claude.com/en/docs/age…</a></li>
<li>Anthropic Blog- Agent Skills：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fequipping-agents-for-the-real-world-with-agent-skills" target="_blank" title="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></li>
<li>How to create custom Skills ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.claude.com%2Fen%2Farticles%2F12512198-how-to-create-custom-skills" target="_blank" title="https://support.claude.com/en/articles/12512198-how-to-create-custom-skills" ref="nofollow noopener noreferrer">support.claude.com/en/articles…</a></li>
<li>The REAL POWER of Claude Agent SKILLS (Why Most Are Missing It) | Claude Skills Explained ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Dm-5DjcgFmfQ" target="_blank" title="https://www.youtube.com/watch?v=m-5DjcgFmfQ" ref="nofollow noopener noreferrer">www.youtube.com/watch?v=m-5…</a></li>
<li>Claude Agent Skills - 全新的技能包 ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DKBslHtyHRaU" target="_blank" title="https://www.youtube.com/watch?v=KBslHtyHRaU" ref="nofollow noopener noreferrer">www.youtube.com/watch?v=KBs…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[探秘新一代向量存储格式Lance-format (十三) 数据更新与 Schema 演化]]></title>    <link>https://juejin.cn/post/7577201863722008576</link>    <guid>https://juejin.cn/post/7577201863722008576</guid>    <pubDate>2025-11-27T02:44:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577201863722008576" data-draft-id="7576894778572996643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="探秘新一代向量存储格式Lance-format (十三) 数据更新与 Schema 演化"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-27T02:44:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            探秘新一代向量存储格式Lance-format (十三) 数据更新与 Schema 演化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T02:44:20.000Z" title="Thu Nov 27 2025 02:44:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第13章：数据更新与 Schema 演化</h2>
<h3 data-id="heading-1">🎯 核心概览</h3>
<p>数据更新和 Schema 演化是现实系统的关键需求。Lance 支持无重写的列添加、类型转换和回填机制。</p>
<hr/>
<h3 data-id="heading-2">📊 第一部分：列的添加与删除</h3>
<h4 data-id="heading-3">列添加（零成本）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> lance

dataset = lance.<span class="hljs-built_in">open</span>(<span class="hljs-string">"users.lance"</span>)

<span class="hljs-comment"># 添加新列：location（有默认值）</span>
dataset.add_column(<span class="hljs-string">"location"</span>, <span class="hljs-string">"default_city"</span>, default_value=<span class="hljs-string">"Unknown"</span>)

<span class="hljs-comment"># 内部机制：</span>
<span class="hljs-comment"># 1. 在 Schema 中添加新列定义</span>
<span class="hljs-comment"># 2. 记录：新列+默认值信息</span>
<span class="hljs-comment"># 3. 不修改现有数据文件</span>
<span class="hljs-comment"># 4. 读取时自动填充默认值</span>

<span class="hljs-comment"># 性能：O(1)，只修改元数据</span>
</code></pre>
<p><strong>实现细节</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Dataset</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_column</span>(
        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>,
        column_name: <span class="hljs-type">String</span>,
        data_type: DataType,
        default_value: <span class="hljs-type">Option</span>&lt;ScalarValue&gt;,
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
        <span class="hljs-comment">// 步骤 1：验证列名不存在</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.schema.<span class="hljs-title function_ invoke__">contains</span>(&amp;column_name) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(Error::<span class="hljs-title function_ invoke__">ColumnAlreadyExists</span>(column_name));
        }
        
        <span class="hljs-comment">// 步骤 2：在 Schema 中添加新列</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">new_field</span> = Field::<span class="hljs-title function_ invoke__">new</span>(&amp;column_name, data_type, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">self</span>.schema.<span class="hljs-title function_ invoke__">push</span>(new_field);
        
        <span class="hljs-comment">// 步骤 3：记录列的默认值</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">new_manifest</span> = <span class="hljs-keyword">self</span>.manifest.<span class="hljs-title function_ invoke__">clone</span>();
        new_manifest.metadata.<span class="hljs-title function_ invoke__">insert</span>(
            <span class="hljs-built_in">format!</span>(<span class="hljs-string">"column:{}_default"</span>, column_name),
            default_value.<span class="hljs-title function_ invoke__">serialize</span>()?,
        );
        
        <span class="hljs-comment">// 步骤 4：原子提交</span>
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">commit</span>(new_manifest).<span class="hljs-keyword">await</span>?;
        
        <span class="hljs-title function_ invoke__">Ok</span>(())
    }
}
</code></pre>
<p><strong>读取时的处理</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_batch_with_schema_evolution</span>(
    batch: RecordBatch,
    evolved_schema: &amp;Schema,
) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;RecordBatch&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">columns</span> = batch.<span class="hljs-title function_ invoke__">columns</span>().<span class="hljs-title function_ invoke__">to_vec</span>();
    
    <span class="hljs-comment">// 为新列添加默认值</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">field</span> <span class="hljs-keyword">in</span> evolved_schema.<span class="hljs-title function_ invoke__">fields</span>() {
        <span class="hljs-keyword">if</span> !batch.<span class="hljs-title function_ invoke__">schema</span>().<span class="hljs-title function_ invoke__">contains</span>(field.<span class="hljs-title function_ invoke__">name</span>()) {
            <span class="hljs-comment">// 新列不在原始批次中</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">default_value</span> = field.metadata.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">"default"</span>)?;
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">default_array</span> = <span class="hljs-title function_ invoke__">create_array_with_value</span>(
                default_value,
                batch.<span class="hljs-title function_ invoke__">num_rows</span>(),
                &amp;field.data_type,
            )?;
            columns.<span class="hljs-title function_ invoke__">push</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(default_array));
        }
    }
    
    RecordBatch::<span class="hljs-title function_ invoke__">try_new</span>(evolved_schema.<span class="hljs-title function_ invoke__">into</span>(), columns)
}
</code></pre>
<h4 data-id="heading-4">列删除</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 删除列：不删除数据文件</span>
dataset.drop_column(<span class="hljs-string">"old_column"</span>)

<span class="hljs-comment"># 内部：</span>
<span class="hljs-comment"># 1. 在 Schema 中标记列为已删除</span>
<span class="hljs-comment"># 2. 创建新 Manifest</span>
<span class="hljs-comment"># 3. 扫描时跳过此列</span>
<span class="hljs-comment"># 4. 存储文件不变（向后兼容）</span>

<span class="hljs-comment"># 性能：O(1)</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">🔄 第二部分：类型转换</h3>
<h4 data-id="heading-6">兼容的转换</h4>
<pre><code class="hljs language-go" lang="go">可以零拷贝或廉价转换的类型：

<span class="hljs-type">int32</span> → <span class="hljs-type">int64</span>
✓ 可以：符号扩展

<span class="hljs-type">float32</span> → <span class="hljs-type">float64</span>
✓ 可以：精度提升

<span class="hljs-type">string</span> → binary
✓ 可以：编码转换

但不可以逆转转换：
<span class="hljs-type">int64</span> → <span class="hljs-type">int32</span>
✗ 范围可能溢出

<span class="hljs-type">float64</span> → <span class="hljs-type">float32</span>
✗ 精度丢失
</code></pre>
<h4 data-id="heading-7">类型转换实现</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Dataset</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">alter_column_type</span>(
        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>,
        column_name: <span class="hljs-type">String</span>,
        new_type: DataType,
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
        <span class="hljs-comment">// 步骤 1：验证转换可行</span>
        <span class="hljs-keyword">if</span> !<span class="hljs-title function_ invoke__">can_convert</span>(&amp;<span class="hljs-keyword">self</span>.schema.<span class="hljs-title function_ invoke__">field</span>(&amp;column_name).data_type, &amp;new_type) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(Error::IncompatibleTypeConversion);
        }
        
        <span class="hljs-comment">// 步骤 2：如果是廉价转换，只修改 Schema</span>
        <span class="hljs-keyword">if</span> <span class="hljs-title function_ invoke__">is_cheap_conversion</span>(&amp;<span class="hljs-keyword">self</span>.schema.<span class="hljs-title function_ invoke__">field</span>(&amp;column_name).data_type, &amp;new_type) {
            <span class="hljs-keyword">self</span>.schema.<span class="hljs-title function_ invoke__">field_mut</span>(&amp;column_name).data_type = new_type;
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">new_manifest</span> = <span class="hljs-keyword">self</span>.manifest.<span class="hljs-title function_ invoke__">clone</span>();
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">commit</span>(new_manifest).<span class="hljs-keyword">await</span>;
        }
        
        <span class="hljs-comment">// 步骤 3：昂贵转换，需要回填</span>
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">backfill_column_type</span>(&amp;column_name, &amp;new_type).<span class="hljs-keyword">await</span>?;
        
        <span class="hljs-title function_ invoke__">Ok</span>(())
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-8">💫 第三部分：回填（Backfill）机制</h3>
<h4 data-id="heading-9">回填流程</h4>
<pre><code class="hljs language-makefile" lang="makefile">场景：添加必需列（非空，无默认值）

步骤 1：扫描现有数据，提取值
<span class="hljs-section">old_data: [row_0, row_1, ..., row_N]</span>
<span class="hljs-section">新列需要计算值: compute_value(row_i) → value_i</span>

步骤 2：生成新列数据
<span class="hljs-section">new_column: [value_0, value_1, ..., value_N]</span>

步骤 3：创建新 Fragment
包含：旧列 + 新列数据

步骤 4：更新 Manifest
指向新 Fragment

步骤 5：后台清理
删除旧 Fragment（可选）

性能：取决于列的计算复杂度
</code></pre>
<h4 data-id="heading-10">实现示例</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Dataset</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">backfill_column_type</span>(
        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>,
        column_name: &amp;<span class="hljs-type">str</span>,
        new_type: &amp;DataType,
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
        <span class="hljs-comment">// 步骤 1：扫描原始列</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">old_column</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">scan</span>()
            .<span class="hljs-title function_ invoke__">select</span>(<span class="hljs-built_in">vec!</span>[column_name.<span class="hljs-title function_ invoke__">to_string</span>()])
            .<span class="hljs-title function_ invoke__">try_into_stream</span>()
            .<span class="hljs-keyword">await</span>?
            .collect::&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;()
            .<span class="hljs-keyword">await</span>;
        
        <span class="hljs-comment">// 步骤 2：转换</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">converted_column</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">convert_column</span>(
            old_column,
            &amp;<span class="hljs-keyword">self</span>.schema.<span class="hljs-title function_ invoke__">field</span>(column_name).data_type,
            new_type,
        ).<span class="hljs-keyword">await</span>?;
        
        <span class="hljs-comment">// 步骤 3：添加回填标记到 Schema</span>
        <span class="hljs-keyword">self</span>.schema.<span class="hljs-title function_ invoke__">field_mut</span>(column_name).data_type = new_type.<span class="hljs-title function_ invoke__">clone</span>();
        
        <span class="hljs-comment">// 步骤 4：创建新的 Manifest（引用转换后的数据）</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">new_manifest</span> = <span class="hljs-keyword">self</span>.manifest.<span class="hljs-title function_ invoke__">clone</span>();
        new_manifest.metadata.<span class="hljs-title function_ invoke__">insert</span>(
            <span class="hljs-built_in">format!</span>(<span class="hljs-string">"column:{}_backfilled"</span>, column_name),
            <span class="hljs-string">"true"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        );
        
        <span class="hljs-comment">// 步骤 5：提交</span>
        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">commit</span>(new_manifest).<span class="hljs-keyword">await</span>?;
        
        <span class="hljs-title function_ invoke__">Ok</span>(())
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-11">📊 Schema 演化的实际案例</h3>
<h4 data-id="heading-12">案例 1：电商产品表演化</h4>
<pre><code class="hljs language-go" lang="go">初始版本（v0）：
{
    product_id: <span class="hljs-type">int64</span>,
    name: <span class="hljs-type">string</span>,
    price: <span class="hljs-type">float32</span>,
}

v1：添加分类
dataset.add_column(<span class="hljs-string">"category"</span>, <span class="hljs-type">string</span>, <span class="hljs-keyword">default</span>=<span class="hljs-string">"general"</span>)

v2：添加评分
dataset.add_column(<span class="hljs-string">"rating"</span>, <span class="hljs-type">float32</span>, <span class="hljs-keyword">default</span>=<span class="hljs-number">0.0</span>)

v3：添加库存
dataset.add_column(<span class="hljs-string">"stock"</span>, <span class="hljs-type">int32</span>, <span class="hljs-keyword">default</span>=<span class="hljs-number">0</span>)

成本分析：
✓ 每次操作都是 O(<span class="hljs-number">1</span>)
✓ 无数据重写
✓ 支持时间旅行（访问 v0 时自动填充默认）

读取时间旅行：
dataset_v0 = lance.open(<span class="hljs-string">"products.lance"</span>, version=<span class="hljs-number">0</span>)
# Schema：{product_id, name, price}

dataset_v3 = lance.open(<span class="hljs-string">"products.lance"</span>, version=<span class="hljs-number">3</span>)
# Schema：{product_id, name, price, category=<span class="hljs-keyword">default</span>, rating=<span class="hljs-keyword">default</span>, stock=<span class="hljs-keyword">default</span>}
</code></pre>
<h4 data-id="heading-13">案例 2：数据类型升级</h4>
<pre><code class="hljs language-makefile" lang="makefile">初始版本：
<span class="hljs-section">user_count: int32</span>

v1：升级到 int64（支持更大的数字）
dataset.alter_column_type(<span class="hljs-string">"user_count"</span>, int64)

<span class="hljs-comment"># Lance 自动：</span>
<span class="hljs-comment"># 1. 检测这是廉价转换（符号扩展）</span>
<span class="hljs-comment"># 2. 只修改 Schema</span>
<span class="hljs-comment"># 3. 读取时自动转换</span>

成本：O(1) - 无数据重写
</code></pre>
<hr/>
<h3 data-id="heading-14">🏗️ 第四部分：批量更新</h3>
<h4 data-id="heading-15">行级别更新</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 更新单行的单个值</span>
dataset.update(
    row_id=<span class="hljs-number">12345</span>,
    column=<span class="hljs-string">"status"</span>,
    value=<span class="hljs-string">"inactive"</span>
)

<span class="hljs-comment"># 内部：</span>
<span class="hljs-comment"># 1. 找到 row_id 对应的 Fragment</span>
<span class="hljs-comment"># 2. 加载该 Fragment</span>
<span class="hljs-comment"># 3. 修改值</span>
<span class="hljs-comment"># 4. 重新写入 Fragment</span>
<span class="hljs-comment"># 5. 创建新 Manifest</span>
</code></pre>
<h4 data-id="heading-16">条件更新</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 更新满足条件的所有行</span>
dataset.update_where(
    <span class="hljs-built_in">filter</span>=<span class="hljs-string">"status = 'active' AND score &lt; 50"</span>,
    updates={<span class="hljs-string">"status"</span>: <span class="hljs-string">"inactive"</span>}
)

<span class="hljs-comment"># 性能考虑：</span>
<span class="hljs-comment"># 需要扫描所有 Fragment，找出匹配行</span>
<span class="hljs-comment"># 对大数据集可能比较慢</span>
<span class="hljs-comment"># 建议：</span>
<span class="hljs-comment"># - 使用索引加速过滤</span>
<span class="hljs-comment"># - 批量更新小部分数据</span>
<span class="hljs-comment"># - 定期重新组织数据（VACUUM）</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">📚 总结</h3>
<p>Lance 的更新和 Schema 演化特性：</p>
<ol>
<li><strong>零成本列添加</strong>：只修改元数据</li>
<li><strong>灵活的类型转换</strong>：廉价转换自动优化</li>
<li><strong>回填机制</strong>：支持复杂的数据变换</li>
<li><strong>向后兼容</strong>：时间旅行访问旧 Schema</li>
<li><strong>原子性更新</strong>：所有变更都是事务性的</li>
</ol>
<p>下一章开始讨论索引系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[sa-token前后端分离集成redis与jwt基础案例]]></title>    <link>https://juejin.cn/post/7576843726011645978</link>    <guid>https://juejin.cn/post/7576843726011645978</guid>    <pubDate>2025-11-26T12:18:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576843726011645978" data-draft-id="7576843726011629594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="sa-token前后端分离集成redis与jwt基础案例"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T12:18:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="未若君雅裁"/> <meta itemprop="url" content="https://juejin.cn/user/1471564960237800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            sa-token前后端分离集成redis与jwt基础案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1471564960237800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    未若君雅裁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T12:18:58.000Z" title="Wed Nov 26 2025 12:18:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">目录</h4>
<ul>
<li>
<ul>
<li><a href="#1_11" title="#1_11">1，依赖引入</a></li>
<li><a href="#2_53" title="#2_53">2，相关配置</a></li>
<li>
<ul>
<li><a href="#springboot_55" title="#springboot_55">springboot配置文件</a></li>
<li><a href="#_87" title="#_87">配置类：</a></li>
<li>
<ul>
<li><a href="#redis_89" title="#redis_89">redis序列化：</a></li>
<li><a href="#jwt_116" title="#jwt_116">配置集成jwt和加密的实例：</a></li>
<li><a href="#_152" title="#_152">配置拦截器，进行身份和权限校验：</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3_200" title="#3_200">3，登录与退出</a></li>
<li>
<ul>
<li>
<ul>
<li><a href="#_202" title="#_202">代码：</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>前言</strong><br/>
sa-token官方文档：https://<a href="https://link.juejin.cn?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3Dsa-token%26spm%3D1001.2101.3001.7020" target="_blank" title="https://so.csdn.net/so/search?q=sa-token&amp;spm=1001.2101.3001.7020" ref="nofollow noopener noreferrer">sa-token</a>.cc<br/>
<strong>Sa-Token</strong> 是一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3D%25E8%25BD%25BB%25E9%2587%258F%25E7%25BA%25A7%26spm%3D1001.2101.3001.7020" target="_blank" title="https://so.csdn.net/so/search?q=%E8%BD%BB%E9%87%8F%E7%BA%A7&amp;spm=1001.2101.3001.7020" ref="nofollow noopener noreferrer">轻量级</a> Java 权限认证框架，主要解决：<strong>登录认证</strong>、<strong>权限认证</strong>、<strong>单点登录</strong>、<strong>OAuth2.0</strong>、<strong>分布式Session会话</strong>、<strong>微服务网关鉴权</strong> 等一系列权限相关问题。<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e41892685734224b5f7cc6f3d1bd02e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyq6Iul5ZCb6ZuF6KOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764764338&amp;x-signature=r184rfploj3WrRsWr8skKw7XZRc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>本教程的环境是springboot 2.6，jdk1.8</p>
<h3 data-id="heading-1">1，依赖引入</h3>
<p>sa-token依赖：</p>
<pre><code class="hljs language-xml" lang="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dev33<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sa-token-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.39.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>sa-token集成jwt：</p>
<pre><code class="hljs language-xml" lang="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dev33<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sa-token-jwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.39.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>sa-token集成redis</p>
<pre><code class="hljs language-xml" lang="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.dev33<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sa-token-redis-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.39.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>这里我用的是security带的BCrypt密码加密，所以还导入了：</p>
<pre><code class="hljs language-xml" lang="xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-crypto<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">2，相关配置</h3>
<h4 data-id="heading-3">springboot配置文件</h4>
<blockquote>
<p>需要注意集成redis后，要想redis起作用还需要将 is-read-cookie 设为 false<br/>
配置jwt密钥 jwt-secret-key 随便打个长的字符就行了<br/>
数据库和redis连接请自行设置</p>
</blockquote>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># sa-token 配置</span>
<span class="hljs-attr">sa-token:</span>
  <span class="hljs-comment"># token 名称（同时也是 cookie 名称）</span>
  <span class="hljs-attr">token-name:</span> <span class="hljs-string">Authorization</span>
  <span class="hljs-comment"># token 有效期（单位：秒） 默认30天，-1 代表永久有效</span>
  <span class="hljs-attr">timeout:</span> <span class="hljs-number">86400</span>
  <span class="hljs-comment"># token 最低活跃频率（单位：秒），如果 token 超过此时间没有访问系统就会被冻结，默认-1 代表不限制，永不冻结</span>
  <span class="hljs-attr">active-timeout:</span> <span class="hljs-number">-1</span>
  <span class="hljs-comment"># 是否允许同一账号多地同时登录 （为 true 时允许一起登录, 为 false 时新登录挤掉旧登录）</span>
  <span class="hljs-attr">is-concurrent:</span> <span class="hljs-literal">false</span>
  <span class="hljs-comment"># 在多人登录同一账号时，是否共用一个 token （为 true 时所有登录共用一个 token, 为 false 时每次登录新建一个 token）</span>
  <span class="hljs-attr">is-share:</span> <span class="hljs-literal">false</span>
  <span class="hljs-comment"># token 风格（默认可取值：uuid、simple-uuid、random-32、random-64、random-128、tik）</span>
  <span class="hljs-attr">token-style:</span> <span class="hljs-string">uuid</span>
  <span class="hljs-comment">#  配置jwt密钥</span>
  <span class="hljs-attr">jwt-secret-key:</span> <span class="hljs-string">sadfsadfasdfsdafasfdseafasfdsadfsadfsa</span>
  <span class="hljs-comment"># token前缀</span>
  <span class="hljs-attr">token-prefix:</span> <span class="hljs-string">Bearer</span>
  <span class="hljs-comment"># 是否输出操作日志</span>
  <span class="hljs-attr">is-log:</span> <span class="hljs-literal">true</span>
  <span class="hljs-comment"># 是否尝试从 cookie 里读取 Token，此值为 false 后，StpUtil.login(id) 登录时也不会再往前端注入Cookie</span>
  <span class="hljs-comment">#  注意：当使用 redis 作为缓存数据时要将 此关闭，否则不会将redis作为缓存，而是继续使用cookie</span>
  <span class="hljs-attr">is-read-cookie:</span> <span class="hljs-literal">false</span>
</code></pre>
<h4 data-id="heading-4">配置类：</h4>
<h5 data-id="heading-5">redis序列化：</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.satokendemo.config;

<span class="hljs-keyword">import</span> org.springframework.cache.annotation.CachingConfigurerSupport;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CachingConfigurerSupport</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span> {
        RedisTemplate&lt;Object, Object&gt; redisTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();
        redisTemplate.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        redisTemplate.setHashKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        redisTemplate.setValueSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        redisTemplate.setHashValueSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        redisTemplate.setConnectionFactory(connectionFactory);
        <span class="hljs-keyword">return</span> redisTemplate;
    }
}
</code></pre>
<h5 data-id="heading-6">配置集成jwt和加密的实例：</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.satokendemo.config;

<span class="hljs-keyword">import</span> cn.dev33.satoken.jwt.StpLogicJwtForSimple;
<span class="hljs-keyword">import</span> cn.dev33.satoken.stp.StpLogic;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
 
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SaTokenConfig</span> {

    <span class="hljs-comment">/**
     * 配置集成jwt
     * <span class="hljs-doctag">@return</span> StpLogic
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> StpLogic <span class="hljs-title function_">getStpLogicJwt</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StpLogicJwtForSimple</span>();
    }

    <span class="hljs-comment">/**
     * 密码加密配置
     * <span class="hljs-doctag">@return</span> BCryptPasswordEncoder
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> BCryptPasswordEncoder <span class="hljs-title function_">bCryptPasswordEncoder</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();
    }

}

</code></pre>
<h5 data-id="heading-7">配置拦截器，进行身份和权限校验：</h5>
<blockquote>
<p>该配置的作用是不拦截登录，注册和一些文档接口，即匿名访问。<br/>
其它的接口都拦截，并进行是否登录的校验，未登录的用户将无法访问。</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.satokendemo.config;

<span class="hljs-keyword">import</span> cn.dev33.satoken.fun.SaParamFunction;
<span class="hljs-keyword">import</span> cn.dev33.satoken.interceptor.SaInterceptor;
<span class="hljs-keyword">import</span> cn.dev33.satoken.stp.StpUtil;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
 
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMVCConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {

    <span class="hljs-comment">/**
     * 配置saToken的身份权限拦截器
     *
     * <span class="hljs-doctag">@param</span> registry
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SaInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SaParamFunction</span>&lt;Object&gt;() {
                    <span class="hljs-comment">// 是否登录</span>
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(Object o)</span> {
                        <span class="hljs-comment">// 调用sa-token提供的方法，校验用户身份登录</span>
                  <span class="hljs-comment">// 该操作的官网文档地址：https://sa-token.cc/doc.html#/use/route-check</span>
                        StpUtil.checkLogin();
                    }
                }))
                <span class="hljs-comment">// 将所有路径都拦截</span>
                .addPathPatterns(<span class="hljs-string">"/**"</span>)
                <span class="hljs-comment">// 排除不拦截的路径</span>
                .excludePathPatterns(
                        <span class="hljs-string">"/sysUser/login"</span>,
                        <span class="hljs-string">"/sysUser/register"</span>,
                        <span class="hljs-string">"/doc.html"</span>,
                        <span class="hljs-string">"/webjars/**"</span>,
                        <span class="hljs-string">"/swagger-resources"</span>
                );
    }
}
</code></pre>
<h3 data-id="heading-8">3，登录与退出</h3>
<h5 data-id="heading-9">代码：</h5>
<blockquote>
<p>StpUtil.login()： sa-token的登录方法，里面填入用户唯一标识，一般为用户id。因为集成了redis所以登录时会将会话信息存入redis中。同时生成token。token过期后redis中的数据也会被删除<br/>
StpUtil.getTokenValue()：获取token的方法，登录之后调用，返回token，因为已经集成了jwt，所以返回的是 jwt token。<br/>
StpUtil.logout()：退出登录的方法，调用后token将失效，且redis存储的信息也将被删除<br/>
获取登录用户的id方法：<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fab0141a6bc477ebed78ec008637560~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyq6Iul5ZCb6ZuF6KOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764764338&amp;x-signature=9CZKQFs8akrhCaB0KxEKm86FO2I%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.satokendemo.controller;

<span class="hljs-keyword">import</span> cn.dev33.satoken.stp.StpUtil;
<span class="hljs-keyword">import</span> com.satokendemo.result.Result;
<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@RequestMapping("sysUser")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysUserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BCryptPasswordEncoder bCryptPasswordEncoder;
    
    <span class="hljs-comment">// 登录接口</span>
    <span class="hljs-meta">@PostMapping("/login")</span>
    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Map&lt;String,String&gt; sysUser)</span> {

         <span class="hljs-keyword">if</span> (!sysUser.containsKey(<span class="hljs-string">"username"</span>) || !sysUser.containsKey(<span class="hljs-string">"password"</span>)){
             <span class="hljs-keyword">return</span> Result.error(<span class="hljs-number">401</span>,<span class="hljs-string">"用户名或密码为空"</span>);
         }
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">"admin"</span>;
        <span class="hljs-comment">// 使用 BCrypt 加密后的 123456</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">"$2a$10$QIVz.q.uRrqYiiKzK60jGetU/mRWrgPzVoxesgUen3tDVXsfmKB0K"</span>;
        <span class="hljs-keyword">if</span> (sysUser.get(<span class="hljs-string">"username"</span>).equals(<span class="hljs-string">"admin"</span>)&amp;&amp; bCryptPasswordEncoder.matches(sysUser.get(<span class="hljs-string">"password"</span>),<span class="hljs-string">"$2a$10$QIVz.q.uRrqYiiKzK60jGetU/mRWrgPzVoxesgUen3tDVXsfmKB0K"</span>)){
            StpUtil.login(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 这里输入用户id</span>
            <span class="hljs-keyword">return</span> Result.success(StpUtil.getTokenValue());
        }
        <span class="hljs-keyword">return</span> Result.error(<span class="hljs-number">401</span>,<span class="hljs-string">"用户名或密码错误"</span>);
    }
    
    <span class="hljs-comment">// 退出登录接口</span>
    <span class="hljs-meta">@PostMapping("/logout")</span>
    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">logout</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 调用sa-token的退出登录方法</span>
        StpUtil.logout();
        <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">"退出成功"</span>);
    }

}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[metrics-server 部署报错]]></title>    <link>https://juejin.cn/post/7576888607479513107</link>    <guid>https://juejin.cn/post/7576888607479513107</guid>    <pubDate>2025-11-26T13:37:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576888607479513107" data-draft-id="7576871248706174995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="metrics-server 部署报错"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-11-26T13:37:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="胜似代码仔"/> <meta itemprop="url" content="https://juejin.cn/user/394039350009241"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            metrics-server 部署报错
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/394039350009241/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    胜似代码仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T13:37:54.000Z" title="Wed Nov 26 2025 13:37:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题表现</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">E1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">20.876269</span>       <span class="hljs-number">1</span> scraper.go:<span class="hljs-number">149</span>] <span class="hljs-string">"Failed to scrape node"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"Get <span class="hljs-subst">\"</span>https://192.168.174.135:10250/metrics/resource<span class="hljs-subst">\"</span>: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.174.135 because it doesn't contain any IP SANs"</span> node<span class="hljs-operator">=</span><span class="hljs-string">"server-06"</span>
<span class="hljs-type">E1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">20.881132</span>       <span class="hljs-number">1</span> scraper.go:<span class="hljs-number">149</span>] <span class="hljs-string">"Failed to scrape node"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"Get <span class="hljs-subst">\"</span>https://192.168.174.136:10250/metrics/resource<span class="hljs-subst">\"</span>: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.174.136 because it doesn't contain any IP SANs"</span> node<span class="hljs-operator">=</span><span class="hljs-string">"server-07"</span>
<span class="hljs-type">E1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">20.886884</span>       <span class="hljs-number">1</span> scraper.go:<span class="hljs-number">149</span>] <span class="hljs-string">"Failed to scrape node"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"Get <span class="hljs-subst">\"</span>https://192.168.174.133:10250/metrics/resource<span class="hljs-subst">\"</span>: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.174.133 because it doesn't contain any IP SANs"</span> node<span class="hljs-operator">=</span><span class="hljs-string">"server-04"</span>
<span class="hljs-type">E1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">20.891583</span>       <span class="hljs-number">1</span> scraper.go:<span class="hljs-number">149</span>] <span class="hljs-string">"Failed to scrape node"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"Get <span class="hljs-subst">\"</span>https://192.168.174.134:10250/metrics/resource<span class="hljs-subst">\"</span>: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.174.134 because it doesn't contain any IP SANs"</span> node<span class="hljs-operator">=</span><span class="hljs-string">"server-05"</span>
<span class="hljs-type">I1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">24.595189</span>       <span class="hljs-number">1</span> server.go:<span class="hljs-number">192</span>] <span class="hljs-string">"Failed probe"</span> probe<span class="hljs-operator">=</span><span class="hljs-string">"metric-storage-ready"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"no metrics to serve"</span>
<span class="hljs-type">I1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">34.596509</span>       <span class="hljs-number">1</span> server.go:<span class="hljs-number">192</span>] <span class="hljs-string">"Failed probe"</span> probe<span class="hljs-operator">=</span><span class="hljs-string">"metric-storage-ready"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"no metrics to serve"</span>
<span class="hljs-type">E1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">35.842888</span>       <span class="hljs-number">1</span> scraper.go:<span class="hljs-number">149</span>] <span class="hljs-string">"Failed to scrape node"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"Get <span class="hljs-subst">\"</span>https://192.168.174.131:10250/metrics/resource<span class="hljs-subst">\"</span>: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.174.131 because it doesn't contain any IP SANs"</span> node<span class="hljs-operator">=</span><span class="hljs-string">"server-03"</span>
<span class="hljs-type">E1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">35.843603</span>       <span class="hljs-number">1</span> scraper.go:<span class="hljs-number">149</span>] <span class="hljs-string">"Failed to scrape node"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"Get <span class="hljs-subst">\"</span>https://192.168.174.136:10250/metrics/resource<span class="hljs-subst">\"</span>: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.174.136 because it doesn't contain any IP SANs"</span> node<span class="hljs-operator">=</span><span class="hljs-string">"server-07"</span>
<span class="hljs-type">E1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">35.865009</span>       <span class="hljs-number">1</span> scraper.go:<span class="hljs-number">149</span>] <span class="hljs-string">"Failed to scrape node"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"Get <span class="hljs-subst">\"</span>https://192.168.174.137:10250/metrics/resource<span class="hljs-subst">\"</span>: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.174.137 because it doesn't contain any IP SANs"</span> node<span class="hljs-operator">=</span><span class="hljs-string">"server-08"</span>
<span class="hljs-type">E1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">35.869804</span>       <span class="hljs-number">1</span> scraper.go:<span class="hljs-number">149</span>] <span class="hljs-string">"Failed to scrape node"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"Get <span class="hljs-subst">\"</span>https://192.168.174.135:10250/metrics/resource<span class="hljs-subst">\"</span>: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.174.135 because it doesn't contain any IP SANs"</span> node<span class="hljs-operator">=</span><span class="hljs-string">"server-06"</span>
<span class="hljs-type">E1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">35.875473</span>       <span class="hljs-number">1</span> scraper.go:<span class="hljs-number">149</span>] <span class="hljs-string">"Failed to scrape node"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"Get <span class="hljs-subst">\"</span>https://192.168.174.133:10250/metrics/resource<span class="hljs-subst">\"</span>: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.174.133 because it doesn't contain any IP SANs"</span> node<span class="hljs-operator">=</span><span class="hljs-string">"server-04"</span>
<span class="hljs-type">E1126</span> <span class="hljs-number">07</span>:<span class="hljs-number">37</span>:<span class="hljs-number">35.880808</span>       <span class="hljs-number">1</span> scraper.go:<span class="hljs-number">149</span>] <span class="hljs-string">"Failed to scrape node"</span> err<span class="hljs-operator">=</span><span class="hljs-string">"Get <span class="hljs-subst">\"</span>https://192.168.174.134:10250/metrics/resource<span class="hljs-subst">\"</span>: tls: failed to verify certificate: x509: cannot validate certificate for 192.168.174.134 because it doesn't contain any IP SANs"</span> node<span class="hljs-operator">=</span><span class="hljs-string">"server-05"</span>
</code></pre>
<h2 data-id="heading-1">问题解释</h2>
<p>控制平面节点初始化或者 join 以及工作节点 join 都是自签 kubelet server 端的证书，第三方组件请求 kubelet 获取信息时 TLS 握手校验 kubelet server 证书时，发现请求的 ip 不在证书的 sans 中，则无法通过证书校验，TLS 握手失败。有个配置可以将 kubelet server 证书改为请求 Kubernetes CA 签发</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 默认行为（没有 serverTLSBootstrap）</span>
kubelet 启动
  ↓
自己生成证书（自签名）
  ↓
Issuer: <span class="hljs-attr">CN</span> = server-<span class="hljs-number">03</span>-ca@<span class="hljs-number">1764041318</span>  <span class="hljs-comment"># ❌ 自己签发自己</span>
Subject: <span class="hljs-attr">CN</span> = server-<span class="hljs-number">03</span>@<span class="hljs-number">1764041318</span>
  ↓
其他组件不信任这个证书
  ↓
需要 --kubelet-insecure-tls 跳过验证
</code></pre>
<p>配置 serverTLSBootstrap 为 true 后</p>
<pre><code class="hljs language-ini" lang="ini">kubelet 启动
  ↓
不再自己生成证书
  ↓
而是请求 Kubernetes CA 签发
  ↓
Issuer: <span class="hljs-attr">CN</span> = kubernetes  <span class="hljs-comment"># ✅ 由可信 CA 签发</span>
Subject: <span class="hljs-attr">CN</span> = system:node:server-<span class="hljs-number">03</span>, O = system:nodes
  ↓
所有组件都信任这个证书
  ↓
不需要 --kubelet-insecure-tls

</code></pre>
<h2 data-id="heading-2">解决方案</h2>
<p>编辑每个节点的 kubelet 配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑 kubelet 配置</span>
vim /var/lib/kubelet/config.yaml
</code></pre>
<p>添加或修改：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">serverTLSBootstrap:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>重启 kubelet</p>
<pre><code class="hljs">systemctl restart kubelet
</code></pre>
<p>在主节点批准 CSR 请求</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 查看待批准的 CSR</span>
kubectl <span class="hljs-keyword">get</span> csr

<span class="hljs-meta"># 批准所有待处理的 CSR</span>
kubectl <span class="hljs-keyword">get</span> csr | grep Pending | awk <span class="hljs-string">'{print $1}'</span> | xargs kubectl certificate approve
</code></pre>
<h2 data-id="heading-3">问题解决</h2>
<p>metrics-server 能正常获取到节点指标</p>
<pre><code class="hljs language-vbscript" lang="vbscript">root@<span class="hljs-built_in">server</span><span class="hljs-number">-03</span>:~# kubectl top nodes
NAME        CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)   
<span class="hljs-built_in">server</span><span class="hljs-number">-03</span>   <span class="hljs-number">108</span>m         <span class="hljs-number">5</span>%       <span class="hljs-number">1054</span>Mi          <span class="hljs-number">27</span>%         
<span class="hljs-built_in">server</span><span class="hljs-number">-04</span>   <span class="hljs-number">110</span>m         <span class="hljs-number">5</span>%       <span class="hljs-number">828</span>Mi           <span class="hljs-number">21</span>%         
<span class="hljs-built_in">server</span><span class="hljs-number">-05</span>   <span class="hljs-number">98</span>m          <span class="hljs-number">4</span>%       <span class="hljs-number">907</span>Mi           <span class="hljs-number">24</span>%         
<span class="hljs-built_in">server</span><span class="hljs-number">-06</span>   <span class="hljs-number">26</span>m          <span class="hljs-number">1</span>%       <span class="hljs-number">392</span>Mi           <span class="hljs-number">10</span>%         
<span class="hljs-built_in">server</span><span class="hljs-number">-07</span>   <span class="hljs-number">18</span>m          <span class="hljs-number">0</span>%       <span class="hljs-number">369</span>Mi           <span class="hljs-number">9</span>%          
<span class="hljs-built_in">server</span><span class="hljs-number">-08</span>   <span class="hljs-number">20</span>m          <span class="hljs-number">1</span>%       <span class="hljs-number">367</span>Mi           <span class="hljs-number">9</span>% 
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>