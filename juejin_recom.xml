<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Agent 研发：ReAct Agent]]></title>    <link>https://juejin.cn/post/7586491717874057235</link>    <guid>https://juejin.cn/post/7586491717874057235</guid>    <pubDate>2025-12-22T16:45:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586491717874057235" data-draft-id="7586491717873991699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent 研发：ReAct Agent"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-22T16:45:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小撸007"/> <meta itemprop="url" content="https://juejin.cn/user/2101921959910183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent 研发：ReAct Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2101921959910183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小撸007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T16:45:07.000Z" title="Mon Dec 22 2025 16:45:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    57
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ReAct 介绍</h2>
<h3 data-id="heading-1">运作流程</h3>
<p>用一句话简单描述：ReAct 智能体是基于<code>推理</code>和<code>行动</code>反馈的框架，通过循环调用 LLM 思考得到概率纠正结果。</p>
<p>理论学习参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ibm.com%2Fcn-zh%2Fthink%2Ftopics%2Freact-agent" target="_blank" title="https://www.ibm.com/cn-zh/think/topics/react-agent" ref="nofollow noopener noreferrer">www.ibm.com/cn-zh/think…</a></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 伪代码</span>
<span class="hljs-function">def <span class="hljs-title">ReAct</span><span class="hljs-params">(query)</span> </span>{
    call: Agent
    Thought
    call: Tool
    Action

    <span class="hljs-keyword">if</span> Action === <span class="hljs-string">'Finish'</span>
        Answer
    <span class="hljs-keyword">else</span>
        loop: ReAct
}
</code></pre>
<h2 data-id="heading-2">ReAct Agent 实现要点</h2>
<blockquote>
<p>此例子来自于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdatawhalechina.github.io%2Fhello-agents%2F%23%2F.%2F%25E5%2589%258D%25E8%25A8%2580" target="_blank" title="https://datawhalechina.github.io/hello-agents/#/./%E5%89%8D%E8%A8%80" ref="nofollow noopener noreferrer">hello_agents 学习文档</a>，有兴趣的同学也可以阅读</p>
<p>主要是思维变化：面向场景选择合适模型-&gt;模型友好交互方式-&gt;得到合理答案，在 ReAct 模式中主要是 Prompt 策略和上下文的丰富度会影响调用成本和结果。</p>
</blockquote>
<ul>
<li>Prompt 规划和约束
<ul>
<li>明确约定思考和行动标记：用于组合 LLM 思维链</li>
<li>明确推理结束标记：用于优化 Prompt 内容</li>
<li>明确推理记忆标记：用于丰富 Prompt 内容</li>
<li>明确推理外部调用能力描述：用于提升 LLM 处理准确性</li>
</ul>
</li>
<li>灵活切换模型、Prompt 策略优化、工具增强，提升循环调用效果（这个对企业成本比较重要）</li>
</ul>
<h2 data-id="heading-3">完整例子实现</h2>
<blockquote>
<p>整体基于 OpenRouter 调用，有兴趣的同学可以选个免费模型跑一下。</p>
</blockquote>
<ul>
<li>LLM Client</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">OpenAI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"openai"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LLM</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">client</span>: <span class="hljs-title class_">OpenAI</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">modelId</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">apiKey: <span class="hljs-built_in">string</span>, modelId: <span class="hljs-built_in">string</span> = <span class="hljs-string">"mistralai/devstral-2512:free"</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({
      <span class="hljs-attr">apiKey</span>: apiKey,
      <span class="hljs-attr">baseURL</span>: <span class="hljs-string">"https://openrouter.ai/api/v1"</span>,
      <span class="hljs-attr">dangerouslyAllowBrowser</span>: <span class="hljs-literal">true</span>,
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelId</span> = modelId;
  }

  <span class="hljs-title function_">setModel</span>(<span class="hljs-params">modelId: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelId</span> = modelId;
  }

  <span class="hljs-title function_">getModel</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelId</span>;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">messages: OpenAI.Chat.Completions.ChatCompletionMessageParam[]</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelId</span>,
      <span class="hljs-attr">messages</span>: messages,
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">stream</span>(<span class="hljs-params">messages: OpenAI.Chat.Completions.ChatCompletionMessageParam[]</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelId</span>,
      <span class="hljs-attr">messages</span>: messages,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,
    });
  }
}
</code></pre>
<ul>
<li>ReActAgent</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> {<span class="hljs-variable constant_">LLM</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"./LLM.ts"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ToolExecutor</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"./ToolExecutor.ts"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PromptTplProps</span> = {
    <span class="hljs-attr">question</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">history</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">tools</span>: <span class="hljs-built_in">string</span>[];
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getPromptTpl</span> = (<span class="hljs-params">props: PromptTplProps</span>) =&gt; {
    <span class="hljs-keyword">const</span> {
        tools,
        question,
        history,
    } = props;

    <span class="hljs-keyword">return</span> <span class="hljs-string">`
        请注意，你是一个有能力调用外部工具的智能助手。
        
        能够使用的工具如下：
        <span class="hljs-subst">${tools.join(<span class="hljs-string">'\n'</span>)}</span>
        
        请严格按照下面的格式进行回复：
        
        Thought: 你的思考过程用于分析问题、拆解任务和规划下一步行动。
        Action: 你决定采取的行为，必须是以下格式之一：
        - {toolName}[{toolInput}]: 调用一个可用工具。
        - Finish[最终答案]: 当你认为已经获得最终答案时。
        - 当你收集到足够的信息，能够回答用户的最终问题时，你必须在Action:字段后使用 finish(answer="...") 来输出最终答案。
        
        现在，请开始解决以下问题：
        Question: <span class="hljs-subst">${question}</span>
        History: <span class="hljs-subst">${history}</span>
    `</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReActAgent</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">history</span>: <span class="hljs-built_in">string</span>[];

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
        <span class="hljs-comment">// 调用的 llm</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> llm: LLM,
        <span class="hljs-comment">// 最多循环思考几次</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> maxSteps: <span class="hljs-built_in">number</span> = <span class="hljs-number">3</span>,
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> toolExecutor: ToolExecutor,
    </span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span> = [];
    }

    <span class="hljs-keyword">async</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">question: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">let</span> currentStep = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">while</span> (currentStep &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSteps</span>) {
            currentStep++;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`-----第<span class="hljs-subst">${currentStep}</span>步骤-------`</span>);

            <span class="hljs-keyword">const</span> history = <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);
            <span class="hljs-keyword">const</span> tools = <span class="hljs-variable language_">this</span>.<span class="hljs-property">toolExecutor</span>.<span class="hljs-title function_">getAvailableTools</span>();
            <span class="hljs-keyword">const</span> prompt = <span class="hljs-title function_">getPromptTpl</span>({
                tools,
                question,
                history,
            });

            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'prompt:'</span>, prompt);

            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> responseText = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">llm</span>.<span class="hljs-title function_">chat</span>([{
                    <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
                    <span class="hljs-attr">content</span>: prompt,
                }]);

                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'大模型返回：'</span>, responseText);

                <span class="hljs-keyword">const</span> {thought, action} = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseOutput</span>(responseText.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span> ?? <span class="hljs-string">''</span>);

                <span class="hljs-keyword">if</span> (thought) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Thought：'</span>, thought);
                }
                <span class="hljs-keyword">if</span> (!action) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'模型没有返回具体的 Action，流程终止'</span>);
                    <span class="hljs-keyword">break</span>;
                }

                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Action:'</span>, action);

                <span class="hljs-keyword">if</span> (action.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'Finish'</span>)) {
                    <span class="hljs-keyword">const</span> answer = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseFinishAnswer</span>(action);
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最终答案: '</span>, answer);
                    <span class="hljs-keyword">return</span> answer;
                }

                <span class="hljs-keyword">const</span> [toolName, toolInput] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseAction</span>(action);
                <span class="hljs-keyword">if</span> (!toolName || !toolInput) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'无法解析 Action:'</span>, action);
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">const</span> tool = <span class="hljs-variable language_">this</span>.<span class="hljs-property">toolExecutor</span>.<span class="hljs-title function_">getTool</span>(toolName);

                <span class="hljs-keyword">let</span> observation = <span class="hljs-string">''</span>;
                <span class="hljs-keyword">if</span> (tool) {
                    observation = tool.<span class="hljs-title function_">fn</span>(toolInput) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
                }
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Observation:'</span>, observation);

                <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`Action:<span class="hljs-subst">${action}</span>`</span>);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`Observation:<span class="hljs-subst">${observation}</span>`</span>)
            } <span class="hljs-keyword">catch</span> (err) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
            }
        }

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'已达到最大步数'</span>);
    }

    <span class="hljs-title function_">parseFinishAnswer</span>(<span class="hljs-params">action: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">const</span> answer = action.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/Finish[(.*)]/</span>);
        <span class="hljs-keyword">if</span> (answer &amp;&amp; answer.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> answer[<span class="hljs-number">1</span>];
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">'-'</span>;
    }

    <span class="hljs-title function_">parseOutput</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">const</span> thought = str.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/Thought:(.*)/</span>);
        <span class="hljs-keyword">const</span> action = str.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/Action:(.*)/</span>);

        <span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = {
            <span class="hljs-attr">thought</span>: <span class="hljs-built_in">string</span>;
            <span class="hljs-attr">action</span>: <span class="hljs-built_in">string</span>;
        };
        <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Result</span> = {
            <span class="hljs-attr">thought</span>: <span class="hljs-string">''</span>,
            <span class="hljs-attr">action</span>: <span class="hljs-string">''</span>,
        };
        <span class="hljs-keyword">if</span> (thought &amp;&amp; thought.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
            result.<span class="hljs-property">thought</span> = thought[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>();
        }
        <span class="hljs-keyword">if</span> (action &amp;&amp; action.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
            result.<span class="hljs-property">action</span> = action[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>();
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-title function_">parseAction</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">const</span> info = str.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/(\w+)[(.*)]/</span>);
        <span class="hljs-keyword">if</span> (info &amp;&amp; info.<span class="hljs-property">length</span> &gt; <span class="hljs-number">2</span>) {
            <span class="hljs-comment">// info[0] is the full match, e.g., "calc_sum[1,1]"</span>
            <span class="hljs-comment">// info[1] is the first capture group (the tool name), e.g., "calc_sum"</span>
            <span class="hljs-comment">// info[2] is the second capture group (the tool input), e.g., "1,1"</span>
            <span class="hljs-keyword">return</span> [info[<span class="hljs-number">1</span>], info[<span class="hljs-number">2</span>]];
        }
        <span class="hljs-keyword">return</span> [];
    }
}
</code></pre>
<ul>
<li>工具注册和执行</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Tool</span> = {
    <span class="hljs-attr">desc</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">fn</span>: <span class="hljs-function">(<span class="hljs-params">arg: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">unknown</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolExecutor</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">tools</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Tool</span>&gt;;

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    }

    <span class="hljs-title function_">register</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, desc: <span class="hljs-built_in">string</span>, fn: (arg: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">unknown</span></span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`您注册的工具：<span class="hljs-subst">${name}</span>, <span class="hljs-subst">${desc}</span>`</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>.<span class="hljs-title function_">set</span>(name, {
            desc,
            fn,
        } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Tool</span>);
    }

    <span class="hljs-title function_">getTool</span>(<span class="hljs-attr">toolName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Tool</span> | <span class="hljs-literal">undefined</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>.<span class="hljs-title function_">has</span>(toolName)) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>.<span class="hljs-title function_">get</span>(toolName);
    }

    <span class="hljs-title function_">getAvailableTools</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">string</span>[] = [];
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">tool, name</span>) =&gt;</span> {
            result.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span>: <span class="hljs-subst">${tool.desc}</span>`</span>);
        });
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始，用 n8n 设计可扩展的自动化工作流]]></title>    <link>https://juejin.cn/post/7586983243926618150</link>    <guid>https://juejin.cn/post/7586983243926618150</guid>    <pubDate>2025-12-24T08:08:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586983243926618150" data-draft-id="7586983243926601766" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始，用 n8n 设计可扩展的自动化工作流"/> <meta itemprop="keywords" content="自动化运维,DevOps"/> <meta itemprop="datePublished" content="2025-12-24T08:08:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DigitalOcean"/> <meta itemprop="url" content="https://juejin.cn/user/2031553217827127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始，用 n8n 设计可扩展的自动化工作流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2031553217827127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DigitalOcean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:08:34.000Z" title="Wed Dec 24 2025 08:08:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>自动化已经成为现代软件开发与运维中不可或缺的一部分。从在不同工具之间同步数据，到触发复杂的业务流程，团队越来越依赖工作流自动化平台来减少人工操作与错误。n8n是一款强大的开源工作流自动化工具，可用于连接各类应用、服务和 API，构建灵活、可扩展的自动化流程。</p>
<p>与许多无代码或低代码自动化工具不同，n8n 对开发者非常友好，高度可定制，并且支持自托管，让你能够完全掌控自己的数据与基础设施。无论你是独立开发者、初创团队，还是大型企业，n8n 都可以成为你自动化体系的核心支柱。</p>
<h2 data-id="heading-0">文章核心要点</h2>
<ul>
<li>n8n 是一款开源工作流自动化工具，通过可视化流程连接应用、API 与服务。</li>
<li>支持自托管，适合注重隐私与合规的企业级场景。</li>
<li>支持复杂逻辑、分支控制、错误处理以及自定义代码。</li>
<li>非常适合开发者、DevOps 团队以及 AI / ML 工作流。</li>
<li>相比 Zapier 等工具，n8n 更灵活，长期使用成本更低。</li>
</ul>
<h2 data-id="heading-1">什么是 n8n？</h2>
<p>n8n 是一个基于节点（node）的开源工作流自动化平台，工作流中的每一步都以一个节点表示。它与 Zapier 等工具类似，但在灵活性和对高级、AI 驱动自动化流程的支持方面更强。如果你在日常工作中还没有使用 AI 自动化工具，很可能正在错失巨大的效率提升机会。</p>
<p>通过 n8n，你可以轻松连接各种应用、服务与 API。借助 DigitalOcean 的一键应用（1-Click App），你可以在安全、可扩展的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidroplet.com%2Fproduct%2Fcloudcpu%2F" target="_blank" title="https://www.aidroplet.com/product/cloudcpu/" ref="nofollow noopener noreferrer">DigitalOcean Droplet 云服务器</a>上快速部署 n8n，无需复杂配置。可视化工作流编辑器让你能够高效创建自定义自动化流程。</p>
<p>每个节点都可以触发动作、处理和转换数据、调用 API 或执行逻辑，从而构建端到端的强大自动化流程。</p>
<p>n8n 可以用于各种自动化场景，例如：</p>
<ul>
<li>自动化重复性任务</li>
<li>集成多个应用</li>
<li>编排复杂的后端工作流</li>
<li>构建自动化流水线，而无需开发完整应用</li>
</ul>
<h2 data-id="heading-2">n8n 的工作方式（How n8n Works）</h2>
<p>n8n 的工作流以可视化方式构建，并按顺序或条件执行。成功登录后，你可以从零开始创建自动化流程，也可以直接尝试 AI 工作流。</p>
<h2 data-id="heading-3">核心组件（Core Components）</h2>
<h3 data-id="heading-4">触发节点（Trigger Nodes）</h3>
<p>触发节点用于启动工作流。你可以选择不同类型的触发器，例如：</p>
<ul>
<li>启动一个工作流</li>
<li>应用事件触发</li>
<li>定时触发</li>
<li>聊天消息触发</li>
</ul>
<p>你可以将其视为工作流的起点，一旦触发器被激活，后续所有关联操作都会被执行。</p>
<p><img src="https://www.digitaloceans.cn/wp-content/uploads/2025/12/image-11-626x1024.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">动作节点（Action Nodes）</h3>
<p>动作节点是工作流中的“执行者”，用于完成具体操作，例如发送数据、创建记录、更新数据库、调用 API 或触发外部服务。</p>
<p>触发节点负责启动流程，动作节点负责真正干活。</p>
<p>示例：</p>
<ul>
<li>发送邮件</li>
<li>在表单提交后创建记录</li>
<li>将表单数据写入 Excel</li>
<li>创建数据库记录</li>
<li>调用 REST API</li>
</ul>
<h3 data-id="heading-6">逻辑节点（Logic Nodes）</h3>
<p>逻辑节点用于控制工作流的行为，决定走哪条路径、如何组合数据，以及某些步骤何时执行。</p>
<p>示例：</p>
<ul>
<li>IF 条件</li>
<li>Switch</li>
<li>Merge</li>
<li>Filter</li>
<li>循环（Loop）</li>
</ul>
<p><img src="https://www.digitaloceans.cn/wp-content/uploads/2025/12/image-10-1024x1004.png" alt="" loading="lazy"/></p>
<p>示例逻辑：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">如果</span> <span class="hljs-string">orderAmount</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">5000</span> <span class="hljs-string">→</span> <span class="hljs-string">发送高端客户邮件</span>  
<span class="hljs-string">否则</span> <span class="hljs-string">→</span> <span class="hljs-string">发送普通邮件</span>
</code></pre>
<p>它的工作方式是这样的：</p>
<ul>
<li>获取输入数据</li>
<li>判断条件</li>
<li>将工作流拆分为 True / False 两条路径</li>
</ul>
<h3 data-id="heading-7">代码节点（Code Nodes）</h3>
<p>代码节点允许你在工作流中编写自定义 JavaScript 或 Python。当内置节点无法满足复杂逻辑或数据处理需求时，就可以使用代码节点。</p>
<p>适用于：</p>
<ul>
<li>数据转换</li>
<li>自定义逻辑</li>
<li>高级计算</li>
</ul>
<p><strong>什么时候该用代码节点？</strong></p>
<ul>
<li>Set 节点不够用</li>
<li>IF / Switch 难以表达复杂条件</li>
<li>需要循环、数学计算或复杂格式化</li>
<li>API 返回的数据需要大量重构</li>
</ul>
<p>如果 Set 或 IF 节点就能解决问题，应尽量避免使用代码节点（越简单的流程越易维护）。</p>
<p>示例数据结构：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"json"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Shaoni"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">82</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-8">在 DigitalOcean 上快速部署 n8n</h2>
<p>1、登录并创建新用户，如果你没有 DigitalOcean 的账号，可访问 digitalocean.com 注册，仅需邮箱和信用卡（或支付宝）即可。如注册遇到问题，可咨询 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidroplet.com%2F" target="_blank" title="https://www.aidroplet.com/" ref="nofollow noopener noreferrer">DigitalOcean 中国区独家战略合作伙伴卓普云 AI Droplet（aidroplet.com）</a>。</p>
<p>2、以 root 用户 SSH 登录 Droplet，具体可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.aidroplet.com%2Ftutorials%2Frun-deepseek-r1-h100%2F" target="_blank" title="https://blog.aidroplet.com/tutorials/run-deepseek-r1-h100/" ref="nofollow noopener noreferrer">卓普云官网更多教程</a></p>
<p>3、创建非 root 用户并授予 sudo 权限</p>
<pre><code class="hljs language-xml" lang="xml">adduser <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>
usermod -aG sudo <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>
</code></pre>
<p>4、配置 SSH key 并使用新用户登录</p>
<p>5、克隆 n8n Docker 配置</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/n8n-io/n8n-docker-caddy.git
<span class="hljs-built_in">cd</span> n8n-docker-caddy
</code></pre>
<p>6、创建 Docker 卷</p>
<pre><code class="hljs language-lua" lang="lua">sudo docker volume <span class="hljs-built_in">create</span> caddy_data
sudo docker volume <span class="hljs-built_in">create</span> n8n_data
</code></pre>
<p>7、配置 DNS 与防火墙</p>
<pre><code class="hljs">sudo ufw allow 80
sudo ufw allow 443
</code></pre>
<p>8、配置 n8n 与 Caddy</p>
<pre><code class="hljs language-bash" lang="bash">nano .<span class="hljs-built_in">env</span>
nano caddy_config/Caddyfile
</code></pre>
<p>9、启动 n8n</p>
<pre><code class="hljs">sudo docker compose up -d
</code></pre>
<p>10、在浏览器中访问你的子域名并登录，即可获得一个带 HTTPS 与持久化数据的自托管 n8n 实例。</p>
<h2 data-id="heading-9"><strong>在 n8n 中使用预构建的工作流</strong>​<strong>模板</strong></h2>
<p><strong>访问 n8n 网站：</strong> 前往 n8n 官网，打开"产品"下拉菜单。在这里，您将找到大量预构建的工作流自动化模板。</p>
<p><img src="https://www.digitaloceans.cn/wp-content/uploads/2025/12/image-12-1024x611.png" alt="" loading="lazy"/></p>
<p><strong>浏览或搜索模板：</strong> 您可以滚动浏览可用的模板，或使用搜索栏查找与您特定用例匹配的模板。</p>
<p><strong>选择模板：</strong> 点击一个模板以查看其详细信息。例如，名为“使用 Telegram、Gemini AI 和 Google Sheets 的营养追踪与餐食记录器”的模板。</p>
<p><img src="https://www.digitaloceans.cn/wp-content/uploads/2025/12/image-8-1024x548.png" alt="" loading="lazy"/></p>
<p><strong>查看连接的应用程序：</strong> 每个模板都清晰地展示了它连接了哪些应用程序和服务。在此例中，该工作流使用了 Telegram、Gemini AI 和 Google Sheets。</p>
<p><strong>了解工作流</strong>​<strong>结构：</strong> 打开模板，查看其完整的工作原理描述。您可以放大和缩小，以检查每个工作流组件，并了解数据如何在节点之间流动。</p>
<p><strong>利用预构建逻辑节省时间：</strong> 从头开始构建此类工作流可能耗时且需要高级技能。这些模板允许您复用经过验证的自动化逻辑，从而快速开始。</p>
<p><strong>使用模板：</strong> 点击“免费使用”开始导入模板。</p>
<p><strong>复制模板：</strong> 选择“复制模板到剪贴板”，将工作流配置复制到剪贴板。</p>
<p><img src="https://www.digitaloceans.cn/wp-content/uploads/2025/12/image-7-1024x671.png" alt="" loading="lazy"/></p>
<p><strong>粘贴到您的 n8n 仪表板：</strong> 打开您自托管的 n8n 仪表板，将复制的模板直接粘贴到您的工作流画布中。</p>
<p><strong>遵循模板指南：</strong> 每个模板都附有用户指南。请仔细阅读并按照说明逐步配置工作流。</p>
<p><strong>配置所需的 ​API</strong>​<strong>​ 密钥：</strong> 这些高级工作流通常需要多个 API 密钥和凭据。请按照指示添加它们以完成设置。</p>
<p><strong>建议将这些 ​API</strong>​​<strong>​ 密钥添加到您的帐户中，以便真正开始无故障地运行工作流</strong>​**。**</p>
<h2 data-id="heading-10">部署方式</h2>

















<table><thead><tr><th>部署方式</th><th>说明</th></tr></thead><tbody><tr><td>n8n Cloud</td><td>官方托管服务，无需运维，适合个人和小团队</td></tr><tr><td>自托管</td><td>在虚拟机、Docker 或 Kubernetes 上部署，完全掌控安全与数据</td></tr></tbody></table>
<h2 data-id="heading-11">使用 n8n 的最佳实践</h2>
<p><strong>保持工作流</strong>​<strong>模块化与可复用性：</strong> 将工作流设计为小巧、独立的单元，每个单元只承担单一职责。随着自动化体系的扩展，模块化工作流更易于复用、测试和维护。</p>
<p><strong>使用描述性节点名称：</strong> 为节点重命名，清晰描述其功能，以保持工作流的可读性和易于理解。这在重新审阅工作流或与他人协作时尤为有帮助。</p>
<p><strong>记录关键步骤以便调试：</strong> 在工作流的关键阶段记录重要的输入和输出信息，以便快速定位问题所在。这能使故障排查更快捷、更可靠。</p>
<p>​<strong>为生产环境启用错误工作流</strong>​**：** 使用错误工作流来自动捕获和处理生产环境中的故障。这有助于告警、监控，并防止发生静默的工作流故障。</p>
<p><strong>避免硬编码凭证：</strong> 始终使用 n8n 的凭证系统来存储 API 密钥和机密信息，而非将其直接嵌入工作流中。这能提升安全性并简化凭证管理。</p>
<p><strong>尽可能对工作流</strong>​<strong>进行版本控制：</strong> 将工作流导出并存储在 Git 等版本控制系统中，以便追踪变更并在需要时安全地回滚更新。</p>
<h2 data-id="heading-12">常见问题</h2>
<p><strong>Q：n8n 是免费的吗？</strong> 是的，开源版本可免费自托管；云版本为订阅制。</p>
<p><strong>Q：需要编程基础吗？</strong> 基础流程不需要，但复杂逻辑建议具备 JavaScript / API 知识。</p>
<p><strong>Q：与 Zapier 有何不同？</strong> n8n 更灵活，支持自托管与深度定制，适合复杂场景，长期成本更低。</p>
<p><strong>Q：能处理大规模工作流</strong>​<strong>吗？</strong> 可以，支持队列与横向扩展，适合企业级场景。</p>
<p><strong>Q：n8n 安全吗？</strong> 在正确部署下是安全的，支持凭证加密与自托管。</p>
<p><strong>Q：能用于 AI / ​LLM</strong>​<strong>工作流吗？</strong> 完全可以，适合 RAG、AI Agent 编排、批量推理等场景。</p>
<p><strong>Q：支持 Webhook 吗？</strong> 支持，是核心功能之一。</p>
<p><strong>Q：能否扩展自定义节点？</strong> 可以，开发者可编写自定义节点。</p>
<p><strong>Q：适合非技术团队吗？</strong> 基础可用，但复杂流程更适合有开发支持的团队。</p>
<p><strong>Q：常见使用场景？</strong></p>
<ul>
<li>初创公司</li>
<li>SaaS 平台</li>
<li>DevOps 团队</li>
<li>AI / ML 基础设施</li>
<li>数据工程流水线</li>
</ul>
<p>n8n 是一款强大、灵活、以开发者为中心的自动化平台，填补了无代码工具与完全定制开发之间的空白。其开源特性、可扩展性与深度定制能力，使其成为构建严肃自动化工作流的理想选择，尤其适用于现代 AI 驱动与云原生环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis踩坑实录：那些不报错但让你debug到深夜的Bug]]></title>    <link>https://juejin.cn/post/7586588823905730569</link>    <guid>https://juejin.cn/post/7586588823905730569</guid>    <pubDate>2025-12-23T02:47:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586588823905730569" data-draft-id="7586540799250726966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis踩坑实录：那些不报错但让你debug到深夜的Bug"/> <meta itemprop="keywords" content="MyBatis,Java,面试"/> <meta itemprop="datePublished" content="2025-12-23T02:47:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一旅人"/> <meta itemprop="url" content="https://juejin.cn/user/3485898277388519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis踩坑实录：那些不报错但让你debug到深夜的Bug
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3485898277388519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一旅人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:47:33.000Z" title="Tue Dec 23 2025 02:47:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    78
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>早上刚到公司，打开电脑，写着需求听着歌。突然钉钉一响，测试发来消息："你那个接口报错了"。打开日志一看，MyBatis又炸了。</p>
</blockquote>
<p>说实话，MyBatis这玩意儿平时挺好用的，但有时候报的错真让人摸不着头脑。尤其是那种<strong>本地跑得好好的，一上线就炸的Bug</strong>，简直让人怀疑人生。今天就记录两个让我debug到深夜的坑，它们都有个共同特点：<strong>代码看起来完全没问题，但运行时就是莫名其妙地报错</strong>。</p>
<p>如果你也被MyBatis折磨过，这篇文章可能会让你会心一笑：原来不是我一个人踩过这些坑😂。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad176944fd4d4a52b8bd1dce48cdd750~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5peF5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767067632&amp;x-signature=KdCPMzXMWXLUA%2B9ZVYPJUGn1HoI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">坑位一：Arrays.asList() 遇上老版本MyBatis（3.2.x版本）</h2>
<h3 data-id="heading-1">事故现场</h3>
<p>周五下午四点半（是的，Bug总是在快下班时出现），测试环境突然报了个令人头大的异常：</p>
<pre><code class="hljs language-java" lang="java">   <span class="hljs-string">"org.mybatis.spring.MyBatisSystemException: nested exception is org.apache.ibatis.builder.BuilderException: Error evaluating expression 'userCode.size() &gt; 0'. Cause: org.apache.ibatis.ognl.MethodFailedException: Method "</span>size<span class="hljs-string">" failed for object [aaa, bbb] [java.lang.IllegalAccessException: Class org.apache.ibatis.ognl.OgnlRuntime can not access a member of class java.util.Collections$UnmodifiableCollection with modifiers "</span><span class="hljs-keyword">public</span><span class="hljs-string">"]
     at org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:73)
     at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:364)
     at $Proxy15.selectList(Unknown Source)
     at org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:194)
     at org.apache.ibatis.binding.MapperMethod.executeForMany(MapperMethod.java:114)
     at org.apache.ibatis.binding.MapperMethod.execute(MapperMethod.java:58)
     at org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:43)
     at $Proxy18.fetchOrder(Unknown Source)
     at com.xx.xx.server.impl.XX.fetchOrderByUnitNo(RechargeCardBillServiceImpl.java:351)
     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
     at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
     at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
     at java.lang.reflect.Method.invoke(Method.java:597)
     at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:317)
     at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:198)
     at $Proxy26.fetchOrderByUnitNo(Unknown Source)
     at com.ofpay.ofdc.task.AbstractRechargeTask.run(AbstractRechargeTask.java:65)
     at java.lang.Thread.run(Thread.java:662)
</span></code></pre>
<p>看到这个异常，我第一反应是：<strong>什么鬼？size()方法还能调用失败？</strong></p>
<p>来看看出问题的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Controller层</span>
List&lt;String&gt; userCodes = Arrays.asList(<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>);
orderService.fetchOrderByUserCodes(userCodes);
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Mapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fetchOrder"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Order"</span>&gt;</span>
    SELECT * FROM t_order
    WHERE 1=1
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userCode != null and userCode.size() &gt; 0"</span>&gt;</span>
        AND user_code IN
        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"userCode"</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"code"</span> <span class="hljs-attr">open</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">close</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span>&gt;</span>
            #{code}
        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<p>这代码看起来没啥问题啊？userCode不为空，调个size()方法判断长度，天经地义。但它就是报错了，而且是偶现（一般偶现都有大坑）。</p>
<h3 data-id="heading-2">先说解决方案</h3>
<p>一顿<strong>ChatGPT + Google + Stack Overflow搜索</strong>后，找到了三种解决办法：</p>
<p><strong>方案1：改入参类型（最快）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 把Arrays.asList返回的"假ArrayList"转成真正的ArrayList</span>
List&lt;String&gt; userCodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>));
</code></pre>
<p>改完重新发布，问题秒解决。测试验证通过，终于可以下班了。</p>
<p><strong>方案2：改XML表达式（不改Java代码）</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 用length属性替代size()方法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userCode != null and userCode.length &gt; 0"</span>&gt;</span>
    AND user_code IN ...
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p>这个方案也能work，而且不用改业务代码，改完就能用。</p>
<p><strong>方案3：升级MyBatis版本（治本之策）</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 从老古董版本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 2014年的版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 升级到现代版本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>不过这个方案需要做全面的回归测试，周五晚上就算了，留到下周慢慢搞。</p>
<h3 data-id="heading-3">刨根问底：这到底是个啥坑？</h3>
<p>线上问题解决了，但总感觉哪里不对劲。周末闲着没事，决定把这个诡异的异常刨根问底搞清楚。翻了半天资料，终于明白是怎么回事了。</p>
<p><strong>第一层问题：类型不同</strong></p>
<p><code>Arrays.asList()</code> 返回的不是我们熟悉的 <code>java.util.ArrayList</code>，而是 <code>java.util.Arrays</code> 的一个私有静态内部类 <code>Arrays$ArrayList</code>。</p>
<p>写个简单的测试验证一下：</p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; list1 = Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>);
List&lt;String&gt; list2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>));

System.out.println(list1.getClass());  
<span class="hljs-comment">// 输出: class java.util.Arrays$ArrayList</span>

System.out.println(list2.getClass());  
<span class="hljs-comment">// 输出: class java.util.ArrayList</span>
</code></pre>
<p>看到没？一个是<code>Arrays$ArrayList</code>，一个是<code>ArrayList</code>，虽然都实现了List接口，但类型完全不同。</p>
<p><strong>第二层问题：访问权限异常</strong></p>
<p>MyBatis用OGNL表达式引擎来解析XML中的条件判断（比如 <code>userCode.size() &gt; 0</code>）。当OGNL尝试通过反射调用 <code>Arrays$ArrayList</code> 的 <code>size()</code> 方法时，发现这个类是 <code>private static class</code>（私有静态内部类）。</p>
<p>虽然 <code>size()</code> 方法本身是 <code>public</code> 的，但因为类本身是 <code>private</code> 修饰符，OGNL在反射访问时需要调用 <code>setAccessible(true)</code> 来绕过权限检查。问题就出在这里！</p>
<p><strong>第三层问题：并发Bug（重点来了！）</strong></p>
<p>老版本MyBatis在处理反射时有个并发问题：<strong>当需要调用私有类的方法时，会先设置 <code>accessible = true</code>，调用完再设回 <code>false</code>。但这个操作没有加锁！（非原子性）</strong></p>
<p>想象一下这个场景：</p>
<ul>
<li>线程A：设置 <code>accessible = true</code>，准备调用方法</li>
<li>线程B：也设置 <code>accessible = true</code>，然后调用方法，再设回 <code>false</code></li>
<li>线程A：此时去调用方法，发现 <code>accessible</code> 已经被B改成 <code>false</code> 了，boom！💥</li>
</ul>
<p>这就是<strong>为什么这个Bug偶尔才出现，因为它本质上是个并发问题</strong>！只有在高并发场景下，多个线程同时调用这个接口时才会触发。</p>
<p>GitHub上有人早在2014年就提了这个issue：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmybatis%2Fmybatis-3%2Fpull%2F384" target="_blank" title="https://github.com/mybatis/mybatis-3/pull/384" ref="nofollow noopener noreferrer">mybatis/mybatis-3#384</a></p>
<p>后来MyBatis在3.3.x版本修复了这个问题，对反射操作加了同步控制，确保 <code>accessible</code> 的设置和方法调用是原子操作。</p>
<hr/>
<h2 data-id="heading-4">坑位二：参数传0，SQL条件神秘消失之谜</h2>
<h3 data-id="heading-5">又一个周五的故事</h3>
<p>是的，又是周五下午（墨菲定律：Bug永远在周五出现😭）。需求很简单：查询所有"待支付"状态（status=0）的订单。十分钟写完代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Service层</span>
<span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">queryPendingOrders</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> orderMapper.queryOrderByStatus(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 0表示待支付</span>
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Mapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"queryOrderByStatus"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Order"</span>&gt;</span>
    SELECT * FROM t_order
    WHERE 1=1
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null and status != ''"</span>&gt;</span>
        AND status = #{status}
    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<p>本地测试，完美运行。提交代码，合并主干，发布测试环境。心想这次稳了，准备提前收拾东西下班。</p>
<p>结果半小时后，测试同学发来消息："这个接口有问题啊，怎么把所有状态的订单都查出来了？我要的是status=0的订单。"</p>
<p>我一脸懵逼：？？？不可能啊，我刚测过的，明明没问题！</p>
<p>打开测试环境日志，执行的SQL是：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_order <span class="hljs-keyword">WHERE</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>
</code></pre>
<p><strong>WHERE后面的status条件呢？被吃了？</strong></p>
<h3 data-id="heading-6">Debug之旅</h3>
<p>我在本地打断点，一步步调试：</p>
<ol>
<li>Controller层传入的参数：<code>status = 0</code> ✅</li>
<li>Service层收到的参数：<code>status = 0</code> ✅</li>
<li>MyBatis执行的SQL：<code>WHERE 1=1</code> ❌</li>
</ol>
<p>问题肯定出在XML的if判断上。盯着这行看了好几分钟：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null and status != ''"</span>&gt;</span>
</code></pre>
<p>突然灵光一现：<strong>会不会是 0 被判定成了空字符串？</strong></p>
<p>赶紧改成这样试试：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null"</span>&gt;</span>
    AND status = #{status}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p>重新发布，问题解决！测试环境查询status=0的订单，正常返回了。</p>
<h3 data-id="heading-7">原理揭秘：OGNL的类型转换陷阱</h3>
<p>这又是一个MyBatis（准确说是OGNL）的经典坑。<strong>这个坑比第一个还隐蔽，因为它不会报错，而是悄悄地把你的条件吃掉</strong>。</p>
<p><strong>OGNL的求值逻辑</strong></p>
<p>MyBatis的 <code>&lt;if&gt;</code> 标签用的是OGNL表达式引擎。当你写 <code>status != ''</code> 时，OGNL内部会经历这样的判断流程：</p>
<ol>
<li>先通过 <code>OgnlCache.getValue()</code> 获取表达式的值（这里表达式返回了false）</li>
<li>然后在 <code>ExpressionEvaluator.evaluateBoolean()</code> 中判断这个值，根据返回的不同类型作不同判断，最终返回boolean类型结果。</li>
</ol>
<p>先看第二步！OGNL对不同类型有不同的判断逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ExpressionEvaluator.evaluateBoolean()方法 OGNL的判断逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">evaluateBoolean</span><span class="hljs-params">(String expression, Object parameterObject)</span> {
  <span class="hljs-comment">// 这里value返回的是false</span>
  <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> OgnlCache.getValue(expression, parameterObject);
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Boolean) {
    <span class="hljs-comment">// 因此会走到这里，返回false</span>
    <span class="hljs-keyword">return</span> (Boolean) value;
  }
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Number) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(String.valueOf(value)).compareTo(BigDecimal.ZERO) != <span class="hljs-number">0</span>;
  }
  <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>类型转换的坑</strong></p>
<p>当你写 <code>status != ''</code> 时，从<code>OgnlCache.getValue()</code>往下不断追溯，OGNL最终会调用 <code>compareWithConversion</code> 方法做类型转换比较。这个方法会把两边的值都转成同一类型再比较：</p>
<ul>
<li>数值 <code>0</code> 会被转成 <code>double类型：0.0</code></li>
<li>空字符串 <code>""</code> 也会被转成 <code>double类型：0.0</code></li>
</ul>
<p>结果就是 <code>0 == ""</code> 被判定为 <code>true</code>，导致 <code>status != ''</code> 返回 <code>false</code>，你的if条件不成立，SQL条件就没了！</p>
<p><strong>为什么本地测试没问题？</strong></p>
<p>是因为我本地测试时传的参数是 <code>status=1</code> 或其他非0值，而测试环境刚好传了 <code>status=0</code>。这种Bug特别隐蔽，因为它不会报错，只是查询结果不符合预期。</p>
<p><strong>这个坑的适用范围</strong>：</p>
<ul>
<li>参数是<strong>数值类型</strong>（Integer、Long等）的 <strong>0</strong></li>
<li>XML中写了 <code>!= ''</code> 的空字符串判断</li>
<li><strong>字符串"0"不受影响</strong>（<code>"0" != ''</code> 正常判定为true）</li>
</ul>
<p>感兴趣的可以自己去看看MyBatis源码中的 <code>ExpressionEvaluator</code> 类和OGNL的 <code>OgnlOps.compareWithConversion</code> 方法，就能明白整个转换过程了。</p>
<h3 data-id="heading-8">正确姿势大全</h3>
<p>根据不同场景，我总结了几种写法：</p>
<p><strong>场景1：参数是Integer/Long等包装类型</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 推荐：只判null，数值0是有效值 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null"</span>&gt;</span>
    AND status = #{status}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p><strong>场景2：参数可能是数值也可能是字符串</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 显式包含0的判断 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null and (status != '' or status == 0)"</span>&gt;</span>
    AND status = #{status}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p><strong>场景3：字符串类型参数</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 字符串正常判断，不会有坑 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userName != null and userName != ''"</span>&gt;</span>
    AND user_name = #{userName}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">避坑建议</h3>
<ol>
<li>
<p><strong>数值类型参数，别用空字符串判断</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ❌ 错误写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"count != null and count != ''"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- ✅ 正确写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"count != null"</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>记住数值类型和字符串类型要区分对待</strong></p>
<ul>
<li>数值类型（Integer、Long）：只判<code>!= null</code></li>
<li>字符串类型：判<code>!= null and != ''</code></li>
</ul>
</li>
<li>
<p><strong>确实需要兼容的场景，明确写出0的判断</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"value != null and (value != '' or value == 0)"</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>升级MyBatis版本并不能解决这个问题</strong>（因为这是OGNL的特性，不是bug）</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-10">总结与最佳实践</h2>
<p>这两个问题虽然表现形式不同，但都源于<strong>OGNL表达式引擎</strong>的特殊行为。理解这些陷阱背后的机制，能帮助我们写出更健壮的MyBatis代码。</p>
<h3 data-id="heading-11">核心要点</h3>
<ol>
<li>
<p><strong>Arrays.asList()的陷阱</strong></p>
<ul>
<li>
<p><code>Arrays.asList()</code> 返回的不是真正的ArrayList，是Arrays的私有静态内部类</p>
</li>
<li>
<p>老版本MyBatis（3.3.x之前）的OGNL表达式引擎：<strong>反射访问私有静态内部类的public方法时，在设置 <code>accessible = true</code>参数时会有并发问题</strong></p>
</li>
<li>
<p><strong>解决方法</strong>：包装成真正的ArrayList或升级MyBatis版本</p>
</li>
</ul>
</li>
<li>
<p><strong>「if」标签：数值0判空的陷阱</strong></p>
<ul>
<li>
<p>OGNL会将数值0与空字符串做类型转换比较</p>
</li>
<li>
<p><code>status != ''</code> 会返回false，导致「if」表达式条件不满足，数值0的查询条件被过滤</p>
</li>
<li>
<p><strong>解决方法</strong>：数值类型只判断<code>!= null</code>，不要判断空字符串</p>
</li>
</ul>
</li>
</ol>
<p>希望这篇文章能帮你避开这些坑，让周五下班不再是奢望 😄</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[到底选 Nuxt 还是 Next.js？SEO 真的有那么大差距吗 🫠🫠🫠]]></title>    <link>https://juejin.cn/post/7586505172816150579</link>    <guid>https://juejin.cn/post/7586505172816150579</guid>    <pubDate>2025-12-23T01:36:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172816150579" data-draft-id="7585105375793233954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="到底选 Nuxt 还是 Next.js？SEO 真的有那么大差距吗 🫠🫠🫠"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-23T01:36:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            到底选 Nuxt 还是 Next.js？SEO 真的有那么大差距吗 🫠🫠🫠
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:36:18.000Z" title="Tue Dec 23 2025 01:36:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>关于 <code>Nuxt</code> 和 <code>Next.js</code> 的 SEO 对比，技术社区充斥着太多误解。最常见的说法是 <code>Nuxt</code> 的 <code>Payload JSON</code> 化会严重影响 SEO，未压缩的数据格式会拖慢页面加载。还有人担心环境变量保护机制存在安全隐患。</p>
<p>实际情况远非如此。框架之间的 SEO 差异被严重夸大了。<code>Nuxt</code> 采用未压缩 JSON 是为了保证数据类型完整性和加速水合过程，这是深思熟虑的设计权衡。所谓的安全问题，本质上是第三方生态设计的挑战，而非框架缺陷。</p>
<p>真正影响搜索引擎排名的是内容质量、用户体验、页面性能和技术实践，而非框架选择。一个优化良好的 <code>Nuxt</code> 网站完全可能比未优化的 <code>Next.js</code> 网站排名更好。</p>
<h2 data-id="heading-0">一、服务端渲染机制对比</h2>
<h3 data-id="heading-1">Next.js：压缩优先</h3>
<p><code>Next.js</code> 新版本使用压缩字符串格式序列化数据，旧版 <code>Page Router</code> 则用 JSON。数据以 <code>&lt;script&gt;</code> 标签形式嵌入 HTML，客户端接收后解压完成水合。</p>
<p>这种方案优势明显：HTML 文档体积小，传输快，初始加载速度优秀。<code>App Router</code> 还支持流式渲染和 <code>Server Components</code>，服务端可以逐步推送内容，不需要等待所有数据准备就绪。</p>
<p>权衡也很清楚：增加了客户端计算开销，复杂数据类型需要额外处理。</p>
<h3 data-id="heading-2">Nuxt：类型完整性优先</h3>
<p><code>Nuxt</code> 采用未压缩 JSON 格式，通过 <code>window.__NUXT__</code> 对象嵌入数据。设计思路基于一个重要前提：现代浏览器的 <code>JSON.parse()</code> 性能极高，V8 引擎对 JSON 解析做了大量优化。相比自定义压缩算法，直接用 JSON 格式解析速度更快。</p>
<p>核心优势是水合速度极快，支持完整的 JavaScript 复杂类型。<code>Nuxt</code> 使用 <code>devalue</code> 序列化库，能够完整保留 <code>Map</code>、<code>Set</code>、<code>Date</code>、<code>RegExp</code>、<code>BigInt</code> 等类型，还能处理循环引用。这意味着从后端传递 <code>Map</code> 数据，前端反序列化后依然是 <code>Map</code>，而不会被转换为普通 <code>Object</code>。</p>
<p>当然，包含大量数据时 HTML 体积会增大。不过对于大数据场景，<code>Nuxt</code> 已经支持 <code>Lazy Hydration</code> 来处理。</p>
<h3 data-id="heading-3">设计哲学差异</h3>
<p><code>Next.js</code> 优先考虑传输速度，适合前后端分离场景。<code>Nuxt</code> 优先保证类型完整性，更适合全栈 JavaScript 应用。由于前后端都用 JavaScript，保持数据类型一致性可以减少大量类型转换代码。</p>
<p>实际测试表明，大多数场景下这种方案不会拖慢首屏加载。一次传输加快速水合的策略，整体性能往往更优。</p>
<h2 data-id="heading-4">二、对 SEO 的实际影响</h2>
<h3 data-id="heading-5">Payload JSON 化的真实影响</h3>
<p>从 SEO 角度看，<code>Nuxt</code> 的方案有独特优势。爬虫可以直接从 HTML 获取完整内容，无需执行 JavaScript。即使 JS 加载或执行失败，页面核心内容依然完整存在于 HTML 中。这对 SEO 至关重要，因为搜索引擎爬虫虽然能执行 JavaScript，但更倾向于直接读取 HTML。</p>
<p>HTML 体积增大的影响被严重高估了。实际测试数据显示，即使 HTML 增大 50-100KB，对 <code>TTFB</code> 的影响也在 50-100ms 以内，用户几乎感知不到。而水合速度提升可能节省 100-200ms 的交互响应时间，整体用户体验反而更好。</p>
<h3 data-id="heading-6">Next.js 的性能优势</h3>
<p><code>Next.js</code> 采用压缩格式后，HTML 体积更小，服务器响应更快。实际数据显示平均 LCP 为 1.2 秒，INP 为 65ms，这些指标确实优秀。</p>
<p><code>Next.js 13+</code> 的 <code>Server Components</code> 进一步优化了数据传输。服务端组件的数据不需要序列化传输到客户端，直接在服务端渲染成 HTML，大大减少了传输量。对于主要展示内容的页面，这种方式可以实现接近静态页面的性能。</p>
<p><code>ISR</code> 功能也很实用。页面可以在构建时生成静态 HTML，然后在后台按需更新，既保证了首屏速度，又能及时更新内容。</p>
<h3 data-id="heading-7">核心结论</h3>
<p>框架对 SEO 的影响被严重夸大了。Google 的 Evergreen Googlebot 在 2019 年就已经能够完整执行现代 JavaScript。无论 <code>Nuxt</code> 还是 <code>Next.js</code>，只要正确实现了 SSR，搜索引擎都能获取完整内容。</p>
<p>框架选择对排名的影响可能不到 1%。真正影响 SEO 的是内容质量、页面语义化、结构化数据、内部链接结构、技术实践（<code>sitemap</code>、<code>robots.txt</code>）和用户体验指标。</p>
<h2 data-id="heading-8">三、SEO 功能特性对比</h2>
<h3 data-id="heading-9">元数据管理</h3>
<p><code>Next.js 13+</code> 的 <code>Metadata API</code> 提供了类型安全的元数据配置，与 <code>Server Components</code> 深度集成，可以在服务端异步获取数据生成动态元数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Next.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateMetadata</span>(<span class="hljs-params">{ params }</span>) {
  <span class="hljs-keyword">const</span> post = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchPost</span>(params.<span class="hljs-property">id</span>);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">title</span>: post.<span class="hljs-property">title</span>,
    <span class="hljs-attr">description</span>: post.<span class="hljs-property">excerpt</span>,
    <span class="hljs-attr">openGraph</span>: { <span class="hljs-attr">images</span>: [post.<span class="hljs-property">coverImage</span>] },
  };
}
</code></pre>
<p><code>Nuxt</code> 的 <code>useHead</code> 提供响应式元数据管理，配合 <code>@nuxtjs/seo</code> 模块开箱即用。内置 <code>Schema.org JSON-LD</code> 生成器，可以更方便地实现结构化数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt</span>
<span class="hljs-keyword">const</span> post = <span class="hljs-keyword">await</span> <span class="hljs-title function_">useFetch</span>(<span class="hljs-string">`/api/posts/<span class="hljs-subst">${id}</span>`</span>);
<span class="hljs-title function_">useHead</span>({
  <span class="hljs-attr">title</span>: post.<span class="hljs-property">value</span>.<span class="hljs-property">title</span>,
  <span class="hljs-attr">meta</span>: [{ <span class="hljs-attr">name</span>: <span class="hljs-string">"description"</span>, <span class="hljs-attr">content</span>: post.<span class="hljs-property">value</span>.<span class="hljs-property">excerpt</span> }],
});

<span class="hljs-title function_">useSchemaOrg</span>([
  <span class="hljs-title function_">defineArticle</span>({
    <span class="hljs-attr">headline</span>: post.<span class="hljs-property">title</span>,
    <span class="hljs-attr">datePublished</span>: post.<span class="hljs-property">publishedAt</span>,
    <span class="hljs-attr">author</span>: { <span class="hljs-attr">name</span>: post.<span class="hljs-property">author</span>.<span class="hljs-property">name</span> },
  }),
]);
</code></pre>
<p><code>Next.js</code> 同样可以实现结构化数据，但需要手动插入 <code>&lt;script type="application/ld+json"&gt;</code> 标签。虽然需要额外工作，但提供了更大的灵活性。</p>
<h3 data-id="heading-10">语义化 HTML 与无障碍性</h3>
<p><code>Nuxt</code> 提供自动 <code>aria-label</code> 注入功能，<code>@nuxtjs/a11y</code> 模块可以在开发阶段自动检测无障碍性问题。<code>Next.js</code> 需要开发者手动确保，可以使用 <code>eslint-plugin-jsx-a11y</code> 检测问题。</p>
<p>语义化 HTML 对 SEO 的重要性常被低估。搜索引擎不仅读取内容，还会分析页面结构。正确使用 <code>&lt;article&gt;</code>、<code>&lt;section&gt;</code>、<code>&lt;nav&gt;</code> 等标签，可以帮助搜索引擎更好地理解内容层次。</p>
<h3 data-id="heading-11">静态生成与预渲染</h3>
<p><code>Next.js</code> 的 <code>ISR</code> 允许为每个页面设置不同的重新验证时间。首页可能每 60 秒重新生成，文章页面可能每天重新生成。这种精细化控制使得网站能在性能和内容新鲜度之间找到平衡：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Next.js ISR</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> revalidate = <span class="hljs-number">3600</span>; <span class="hljs-comment">// 每小时更新</span>
</code></pre>
<p><code>Nuxt 3</code> 支持混合渲染模式，可以在同一应用中同时使用 SSR、SSG 和 CSR，为不同页面选择最适合的渲染策略：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt 混合渲染</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">routeRules</span>: {
    <span class="hljs-string">"/"</span>: { <span class="hljs-attr">prerender</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">"/posts/**"</span>: { <span class="hljs-attr">swr</span>: <span class="hljs-number">3600</span> },
    <span class="hljs-string">"/admin/**"</span>: { <span class="hljs-attr">ssr</span>: <span class="hljs-literal">false</span> },
  },
});
</code></pre>
<p><code>Next.js 14</code> 的 <code>Partial Prerendering</code> 更进一步，允许在同一页面混合静态和动态内容。静态部分在构建时生成，动态部分在请求时渲染，结合了 SSG 的速度和 SSR 的灵活性。</p>
<h2 data-id="heading-12">四、性能指标与爬虫友好性</h2>
<h3 data-id="heading-13">Core Web Vitals 表现</h3>
<p>从各项指标看，<code>Next.js</code> 平均 LCP 为 1.2 秒，表现优秀。<code>Nuxt</code> 的 LCP 可能受 HTML 体积影响，但在 FCP 和 INP 方面得益于快速水合机制，同样表现出色。</p>
<p>需要强调的是，这些差异在实际 SEO 排名中影响极其有限。Google 在 2021 年将 <code>Core Web Vitals</code> 纳入排名因素，但权重相对较低。内容相关性、反向链接质量、域名权威度等传统因素权重仍然更高。</p>
<p>更重要的是，<code>Core Web Vitals</code> 分数取决于真实用户体验数据，而非实验室测试。网络环境、设备性能、缓存状态等因素对性能的影响远大于框架本身。一个优化良好的 <code>Nuxt</code> 网站完全可能比未优化的 <code>Next.js</code> 网站获得更好的分数。</p>
<p>两个框架都提供了丰富的优化工具。<code>Next.js</code> 的 <code>next/image</code> 提供自动图片优化、懒加载、响应式图片。<code>Nuxt</code> 的 <code>@nuxt/image</code> 提供类似功能，并支持多种图片托管服务。图片优化对 LCP 的影响往往比框架选择更大。</p>
<h3 data-id="heading-14">爬虫友好性</h3>
<p>两个框架在爬虫友好性方面几乎没有差别。都提供完整的服务端渲染内容，无需 JavaScript 即可获取页面信息，能正确返回 HTTP 状态码，支持合理的 URL 结构。</p>
<p><code>Nuxt</code> 的额外优势在于内置 <code>Schema.org JSON-LD</code> 生成器，有助于搜索引擎生成富文本摘要。结构化数据对现代 SEO 至关重要，通过嵌入 <code>JSON-LD</code> 格式的数据，可以告诉搜索引擎页面内容的具体含义。这些信息会显示在搜索结果中，提高点击率。</p>
<p>两个框架在处理动态路由、国际化、重定向等 SEO 关键功能上都提供了完善支持。</p>
<h2 data-id="heading-15">五、安全性问题澄清</h2>
<h3 data-id="heading-16">环境变量保护机制</h3>
<p>关于 <code>Nuxt</code> 会将 <code>NUXT_PUBLIC</code> 环境变量暴露到 HTML 的问题，需要明确这并非框架缺陷。<code>Nuxt</code> 的机制是只有显式设置为 <code>NUXT_PUBLIC_</code> 前缀的变量才会暴露到前端，非 public 变量不会出现在 HTML 中。</p>
<p>正常情况下，开发者不应该将重要信息设置为 public。任何重要信息都不应该放到前端，这是前端开发的基本原则，与框架无关。</p>
<p><code>Nuxt 3</code> 的环境变量系统被彻底重新设计。运行时配置分为公开和私有两部分：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt 配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">runtimeConfig</span>: {
    <span class="hljs-comment">// 私有配置，仅服务端可用</span>
    <span class="hljs-attr">apiSecret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">API_SECRET</span>,

    <span class="hljs-comment">// 公开配置，会暴露到客户端</span>
    <span class="hljs-attr">public</span>: {
      <span class="hljs-attr">apiBase</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">API_BASE_URL</span>,
    },
  },
});
</code></pre>
<p><code>Next.js</code> 使用类似机制，以 <code>NEXT_PUBLIC_</code> 前缀的变量会暴露到客户端：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 服务端组件中</span>
<span class="hljs-keyword">const</span> apiSecret = process.<span class="hljs-property">env</span>.<span class="hljs-property">API_SECRET</span>; <span class="hljs-comment">// 可用</span>

<span class="hljs-comment">// 客户端组件中</span>
<span class="hljs-keyword">const</span> apiBase = process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_API_BASE</span>; <span class="hljs-comment">// 可用</span>
<span class="hljs-keyword">const</span> apiSecret = process.<span class="hljs-property">env</span>.<span class="hljs-property">API_SECRET</span>; <span class="hljs-comment">// undefined</span>
</code></pre>
<h3 data-id="heading-17">实际开发中的安全挑战</h3>
<p>真正的问题在于某些第三方库要求在前端初始化时传入密钥。一些 BaaS 服务（如 <code>Supabase</code>、<code>Firebase</code>）的前端 SDK 设计就需要在前端初始化，开发者无法控制这些第三方生态的设计。</p>
<p>以 <code>Supabase</code> 为例，它提供 <code>anon key</code>（匿名密钥）和 <code>service role key</code>（服务角色密钥）。<code>anon key</code> 设计为可以在前端使用，通过行级安全策略在数据库层面控制权限。<code>service role key</code> 则绕过所有安全策略，只能在服务端使用。</p>
<p>理想解决方案是将依赖密钥的库放到服务端，通过 API 调用使用。如果某个库需要在前端运行明文密钥，这个库本身就存在重大安全风险。但现实往往更复杂，生态适配问题难以完全避免。</p>
<p>值得注意的是，<code>Next.js</code> 同样存在类似的安全考量。两个框架在环境变量保护方面的机制基本一致，问题根源在于第三方生态设计，而非框架缺陷。</p>
<h3 data-id="heading-18">对 SEO 的影响</h3>
<p>环境变量问题本质上是安全问题，而非 SEO 问题。只要正确配置，不会影响搜索引擎爬取。</p>
<p>真正影响 SEO 的安全问题是：网站被攻击后注入垃圾链接、恶意重定向、隐藏内容等。这些行为会直接导致网站被搜索引擎惩罚，甚至从索引中移除。防止这类问题需要全方位的安全措施，远超框架本身的范畴。</p>
<h2 data-id="heading-19">六、实际应用场景</h2>
<h3 data-id="heading-20">内容密集型网站</h3>
<p>对于博客、新闻网站、文档站点，<code>Nuxt</code> 往往表现更好。内容块水合速度快，开箱即用的 SEO 功能完善，开发体验好。</p>
<p><code>Nuxt</code> 的 <code>@nuxt/content</code> 模块提供了基于 Markdown 的内容管理系统，支持全文搜索、代码高亮、自动目录生成。配合 <code>@nuxtjs/seo</code> 模块，可以快速构建 SEO 友好的内容网站：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt Content 使用</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: post } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">useAsyncData</span>(<span class="hljs-string">"post"</span>, <span class="hljs-function">() =&gt;</span>
  <span class="hljs-title function_">queryContent</span>(<span class="hljs-string">"/posts"</span>).<span class="hljs-title function_">where</span>({ <span class="hljs-attr">slug</span>: route.<span class="hljs-property">params</span>.<span class="hljs-property">slug</span> }).<span class="hljs-title function_">findOne</span>()
);
</code></pre>
<p>技术博客、文档网站特别适合这种方案。<code>VuePress</code>、<code>VitePress</code> 等静态站点生成器也是基于类似思路构建的。</p>
<h3 data-id="heading-21">动态应用</h3>
<p>对于电商平台、SaaS 应用等需要高级渲染技术和复杂交互的场景，<code>Next.js</code> 可能更合适。<code>ISR</code> 和部分预渲染能够更好地应对动态内容需求。</p>
<p>电商网站的 SEO 挑战在于商品数量庞大、内容动态变化、需要个性化推荐。<code>Next.js</code> 的 <code>ISR</code> 可以为每个商品页面设置合适的重新验证时间，既保证 SEO 友好，又能及时更新库存、价格：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Next.js 电商页面优化</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductPage</span>(<span class="hljs-params">{ params }</span>) {
  <span class="hljs-keyword">const</span> product = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchProduct</span>(params.<span class="hljs-property">id</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductInfo</span> <span class="hljs-attr">product</span>=<span class="hljs-string">{product}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Skeleton</span> /&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">AddToCartButton</span> <span class="hljs-attr">productId</span>=<span class="hljs-string">{params.id}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> revalidate = <span class="hljs-number">1800</span>; <span class="hljs-comment">// 30分钟重新验证</span>
</code></pre>
<h3 data-id="heading-22">混合场景</h3>
<p>对于兼具内容和应用特性的混合场景，两个框架都能很好胜任。许多现代网站都是混合型的：既有内容页面（博客、文档），又有应用功能（用户中心、后台管理）。</p>
<p>关键是为不同类型页面选择合适的渲染策略。<code>Nuxt 3</code> 的 <code>routeRules</code> 提供路由级别的渲染控制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt 混合渲染场景</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">routeRules</span>: {
    <span class="hljs-string">"/"</span>: { <span class="hljs-attr">prerender</span>: <span class="hljs-literal">true</span> }, <span class="hljs-comment">// 首页预渲染</span>
    <span class="hljs-string">"/blog/**"</span>: { <span class="hljs-attr">swr</span>: <span class="hljs-number">3600</span> }, <span class="hljs-comment">// 博客缓存 1 小时</span>
    <span class="hljs-string">"/dashboard/**"</span>: { <span class="hljs-attr">ssr</span>: <span class="hljs-literal">false</span> }, <span class="hljs-comment">// 用户中心客户端渲染</span>
    <span class="hljs-string">"/api/**"</span>: { <span class="hljs-attr">cors</span>: <span class="hljs-literal">true</span> }, <span class="hljs-comment">// API 路由</span>
  },
});
</code></pre>
<p><code>Next.js</code> 通过不同文件约定实现类似功能。可以在 <code>app</code> 目录中使用 Server Components 和 Client Components 组合，在 <code>pages</code> 目录中使用传统 SSR/SSG 方式。</p>
<h2 data-id="heading-23">七、开发者的真实痛点</h2>
<h3 data-id="heading-24">超越 SEO 的实际考量</h3>
<p>通过分析实际案例发现，开发者选择框架的真正原因往往不是 SEO。许多从 <code>Nuxt</code> 迁移到 <code>Next.js</code> 的团队，主要原因包括第三方生态兼容性问题（如 <code>Supabase</code> 等 BaaS 服务的前端依赖），以及开发体验（启动速度慢、构建时间长）。</p>
<p>客观来说，<code>Nuxt</code> 在开发服务器启动速度和构建时间方面确实存在优化空间。不过随着 <code>Rolldown</code>、<code>Oxc</code> 等下一代工具链的完善，这些问题有望改善。这说明 SEO 和安全问题可能被过度强调了，真正影响开发者选择的是开发体验和生态适配。</p>
<p>开发服务器启动速度直接影响开发效率。如果每次重启都需要等待 30-60 秒，一天下来可能浪费几十分钟。构建时间同样重要，尤其在 CI/CD 环境中。构建时间过长会延迟部署，影响快速迭代能力。</p>
<p>生态兼容性是另一个重要因素。某些库只提供 React 版本，某些只提供 Vue 版本。虽然可以通过适配器跨框架使用，但会增加维护成本。</p>
<h3 data-id="heading-25">技术方案的权衡</h3>
<p>没有完美的技术方案，只有最适合的选择。<code>Nuxt</code> 优先保证数据类型完整性和快速水合，<code>Next.js</code> 追求更小体积和更快 TTFB。</p>
<p>不同开发者有不同需求：内容型网站与应用型产品侧重点不同，小团队与大型商业项目考量各异。技术讨论中有句话很好地总结了这点：几乎所有框架都在解决同样的问题，差别只在于细微的实现方式。</p>
<p>对小团队来说，开发效率可能比性能优化更重要。快速实现功能、快速迭代，比追求极致性能指标更有价值。对大型团队来说，长期维护性和可扩展性更重要。</p>
<p>技术债务是另一个需要考虑的因素。随着项目发展，早期为了快速开发而做的权衡可能成为瓶颈。选择一个社区活跃、持续演进的框架很重要。<code>Next.js</code> 和 <code>Nuxt</code> 都有强大的商业支持（Vercel 和 NuxtLabs），这保证了框架的长期发展。</p>
<h2 data-id="heading-26">八、综合评估与选择建议</h2>
<h3 data-id="heading-27">SEO 能力评分</h3>
<p>从 SEO 能力看，<code>Next.js</code> 可以获得 4.5 分（满分 5 分）。优势在于优秀的 <code>Core Web Vitals</code> 表现、更小的 HTML 体积、成熟的 SEO 生态，以及 <code>ISR</code> 和部分预渲染等先进特性。不足是需要手动配置结构化数据，语义化 HTML 需要开发者特别注意。</p>
<p><code>Nuxt</code> 可以获得 4 分。优势包括内置 <code>Schema.org JSON-LD</code> 生成器、自动语义化 HTML 支持、在内容型网站的优秀表现，以及快速水合带来的良好体验。<code>Payload JSON</code> 导致 HTML 体积增大在实际应用中影响微小，已有 <code>Lazy Hydration</code> 等解决方案。开发服务器启动和构建速度慢是开发体验问题，与 SEO 无关。</p>
<p>需要说明的是，两者 SEO 能力实际上都接近满分，0.5 分的差异主要体现在开箱即用的便利性上，而非实际 SEO 效果。在真实搜索引擎排名中，这 0.5 分的差异几乎不会产生可察觉的影响。</p>
<h3 data-id="heading-28">选择 Next.js 的场景</h3>
<p>如果项目对 <code>Core Web Vitals</code> 有极高要求，或者需要复杂渲染策略的动态应用，<code>Next.js</code> 是更好的选择。以下场景推荐使用：</p>
<ul>
<li>电商平台，需要 <code>ISR</code> 平衡性能和内容新鲜度</li>
<li>SaaS 应用，对交互性能要求极高</li>
<li>国际化大型网站，需要精细性能优化</li>
<li>团队已有 React 技术栈，迁移成本低</li>
<li>需要使用大量 React 生态的第三方库</li>
<li>对 Vercel 平台部署优化感兴趣</li>
<li>需要 <code>Server Components</code> 的先进特性</li>
<li>项目规模大，需要严格的 TypeScript 类型检查</li>
</ul>
<h3 data-id="heading-29">选择 Nuxt 的场景</h3>
<p>如果项目是内容密集型网站（博客、新闻、文档），或者需要快速开发并利用框架的 SEO 便利功能，<code>Nuxt</code> 是理想选择。以下场景推荐使用：</p>
<ul>
<li>技术博客、文档站点，内容是核心</li>
<li>新闻、媒体网站，需要快速发布内容</li>
<li>企业官网，强调 SEO 和内容展示</li>
<li>团队已有 Vue 技术栈，迁移成本低</li>
<li>需要使用 Vue 生态的 UI 库（如 Element Plus、Vuetify）</li>
<li>快速原型开发，需要开箱即用的功能</li>
<li>需要 <code>@nuxt/content</code> 的 Markdown 内容管理</li>
<li>项目需要传递复杂的 JavaScript 对象（Map、Set、Date 等）</li>
</ul>
<h3 data-id="heading-30">决策思路</h3>
<p>对于需要优秀 SEO 表现、服务端渲染和良好开发体验的项目，两个框架都完全能够胜任。选择关键在于团队技术栈、第三方生态适配、开发体验等实际因素，而不应该仅仅基于 SEO 考虑。</p>
<p>在中小型项目、团队对两个框架都不熟悉、项目没有特殊渲染需求的情况下，两个框架都是合理选择。可以考虑以下因素决策：</p>
<ul>
<li>团队成员的个人偏好（React vs Vue）</li>
<li>公司的技术战略和长期规划</li>
<li>现有项目的技术栈，保持一致性</li>
<li>招聘市场，React 开发者相对更多</li>
<li>社区资源，React 生态整体更成熟</li>
<li>学习曲线，Vue 的 API 相对更简单</li>
</ul>
<h2 data-id="heading-31">九、核心结论</h2>
<h3 data-id="heading-32">框架差异的真实影响</h3>
<p>几乎所有现代框架都能很好地支持 SEO，差异只在于细微的实现方式。框架选择对 SEO 排名的影响远小于内容质量和技术实现。<code>Payload JSON</code> 化影响 SEO 的说法被夸大了，这是经过深思熟虑的设计权衡。对大多数应用来说，一次传输加快速水合的策略更优。</p>
<p>从搜索引擎角度看，只要页面能正确渲染、内容完整可见、HTML 结构合理、<code>meta</code> 标签正确，框架是什么并不重要。Google 的爬虫既可以处理传统静态 HTML，也可以执行复杂的 JavaScript 应用，还可以理解 SPA 的路由。</p>
<p>真正影响 SEO 的是：内容质量和原创性、页面加载速度（但 100-200ms 差异可以忽略）、移动端友好性、内部链接结构、外部反向链接、域名权威度、用户行为指标（点击率、停留时间、跳出率）、技术 SEO 实践（<code>sitemap</code>、<code>robots.txt</code>、结构化数据）。</p>
<p>框架选择在这些因素中的权重微乎其微。用 <code>Nuxt</code> 还是 <code>Next.js</code>，对实际排名的影响可能不到 1%。</p>
<h3 data-id="heading-33">性能指标的误区</h3>
<p><code>Next.js</code> 在 HTML 体积、TTFB 和 <code>Core Web Vitals</code> 平均值方面具有优势。<code>Nuxt</code> 则在数据类型支持、水合速度和网络传输效率方面表现出色。但这些差异在实际 SEO 排名中影响微乎其微。</p>
<p>常见的性能误区包括：过度关注实验室测试数据，忽略真实用户体验；追求极致分数，忽略边际收益递减；认为性能优化就是 SEO 优化；忽略其他更重要的 SEO 因素；在框架选择上纠结，而不是优化现有代码。</p>
<p>实际上，同一框架下，优化和未优化的网站性能差异可能是 10 倍，而不同框架之间的性能差异可能只有 10-20%。把精力放在代码优化、资源优化、CDN 配置等方面，往往比纠结框架选择更有价值。</p>
<h3 data-id="heading-34">决策因素梳理</h3>
<p>技术因素方面，应该考虑团队技术栈（React vs Vue）、第三方生态适配、开发体验（启动速度、构建速度）。业务因素方面，需要评估项目类型（内容型 vs 应用型）、团队规模和能力、时间和预算。不应该主要基于 SEO 来选择框架，因为两者在 SEO 方面能力基本相当。</p>
<p>决策优先级建议：</p>
<p>第一优先级：团队技术栈和能力。团队熟悉什么就用什么，学习成本和招聘成本很高。</p>
<p>第二优先级：项目类型和需求。内容型倾向 <code>Nuxt</code>，应用型倾向 <code>Next.js</code>，混合型都可以。</p>
<p>第三优先级：生态和工具链。需要的第三方库是否支持，部署平台的支持情况，开发工具的成熟度。</p>
<p>第四优先级：性能和 SEO。只在前三者相同时考虑，实际影响很小。</p>
<h2 data-id="heading-35">十、实践建议</h2>
<h3 data-id="heading-36">SEO 优化核心原则</h3>
<p>内容质量永远是第一位的。框架只是工具，内容才是核心，技术优化是锦上添花而非雪中送炭。正确实现 SSR 比框架选择更重要。</p>
<p>SEO 最佳实践清单：确保所有重要内容在 HTML 中可见、为每个页面设置唯一的 <code>title</code> 和 <code>description</code>、使用语义化 HTML 标签、正确使用标题层级、为图片添加 <code>alt</code> 属性、实现结构化数据、生成 <code>sitemap.xml</code> 并提交、配置合理的 <code>robots.txt</code>、使用 HTTPS、优化页面加载速度、确保移动端友好、构建合理的内部链接结构、定期发布高质量原创内容、获取高质量的外部链接、监控和分析 SEO 数据。</p>
<h3 data-id="heading-37">Nuxt 优化建议</h3>
<p>充分利用框架优势，包括数据类型完整性的便利。对于大数据量场景，使用 <code>Lazy Hydration</code> 功能。不要因为 <code>payload</code> 问题过度担心，实际影响很小。</p>
<p>性能优化技巧：使用 <code>nuxt generate</code> 生成静态页面、配置 <code>routeRules</code> 为不同页面选择合适渲染策略、使用 <code>@nuxt/image</code> 优化图片加载、使用 <code>lazy</code> 属性延迟加载不关键组件、优化 <code>payload</code> 大小避免传递不必要数据、使用 <code>useState</code> 管理 SSR 和 CSR 之间共享的状态、配置合理的缓存策略、监控 <code>payload</code> 大小必要时拆分数据。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt 性能优化配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">experimental</span>: {
    <span class="hljs-attr">payloadExtraction</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">inlineSSRStyles</span>: <span class="hljs-literal">false</span>,
  },
  <span class="hljs-attr">routeRules</span>: {
    <span class="hljs-string">"/"</span>: { <span class="hljs-attr">prerender</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">"/blog/**"</span>: { <span class="hljs-attr">swr</span>: <span class="hljs-number">3600</span> },
  },
  <span class="hljs-attr">image</span>: {
    <span class="hljs-attr">domains</span>: [<span class="hljs-string">"cdn.example.com"</span>],
  },
});
</code></pre>
<h3 data-id="heading-38">Next.js 优化建议</h3>
<p>充分利用性能优势，包括 <code>ISR</code> 和部分预渲染，优化 <code>Core Web Vitals</code> 指标。在处理复杂数据类型时，<code>Map</code>、<code>Set</code> 等需要额外处理，要确保序列化和反序列化的正确性。</p>
<p>性能优化技巧：使用 <code>ISR</code> 为动态内容设置合理重新验证时间、尽可能使用 <code>Server Components</code> 减少客户端 JavaScript、使用 <code>next/image</code> 自动优化图片、使用 <code>next/font</code> 优化字体加载、配置 <code>experimental.ppr</code> 启用部分预渲染、使用 <code>Suspense</code> 和 <code>loading.js</code> 改善感知性能、代码分割按需加载、优化第三方脚本加载、使用 <code>@next/bundle-analyzer</code> 分析包大小、配置合理的缓存策略。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Next.js 性能优化配置</span>
<span class="hljs-keyword">const</span> nextConfig = {
  <span class="hljs-attr">experimental</span>: {
    <span class="hljs-attr">ppr</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">optimizeCss</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">optimizePackageImports</span>: [<span class="hljs-string">"lodash"</span>, <span class="hljs-string">"date-fns"</span>],
  },
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">domains</span>: [<span class="hljs-string">"cdn.example.com"</span>],
    <span class="hljs-attr">formats</span>: [<span class="hljs-string">"image/avif"</span>, <span class="hljs-string">"image/webp"</span>],
  },
};
</code></pre>
<h3 data-id="heading-39">框架无关的通用优化</h3>
<p>无论选择哪个框架，以下优化都是必要的：使用 CDN 加速静态资源、启用 Gzip 或 Brotli 压缩、配置合理的缓存策略、优化首屏渲染延迟加载非关键资源、减少 HTTP 请求数量、使用 HTTP/2 或 HTTP/3、优化数据库查询、使用 Redis 等缓存层、监控真实用户性能数据、定期进行性能审计。</p>
<h3 data-id="heading-40">决策流程</h3>
<p>如果主要关心 SEO，两个框架都完全够用，选择团队熟悉的即可，把精力放在内容质量和技术实现上。如果项目需要复杂数据结构，<code>Nuxt</code> 的 <code>devalue</code> 机制会让开发更便捷。如果追求极致性能指标，<code>Next.js</code> 的压缩方案可能略好一点，但差异在实际 SEO 排名中几乎可以忽略。如果被第三方生态绑定，这可能是最重要的决策因素。</p>
<p>决策流程建议：评估团队现有技术栈（如果已有 React/Vue 项目保持一致）、分析项目需求（内容型倾向 <code>Nuxt</code>、应用型倾向 <code>Next.js</code>）、检查第三方依赖（列出必需的库、确认是否有对应生态版本）、考虑部署环境（Vercel 对 <code>Next.js</code> 有特殊优化、Netlify 和 Cloudflare Pages 两者都支持）、评估长期维护成本（框架更新频率和稳定性、社区支持和文档质量）。</p>
<h2 data-id="heading-41">结语</h2>
<p>通过深入分析技术原理和实际应用案例，可以得出一个明确的结论：框架之间的差异是细微的，对 SEO 的影响更是微乎其微。</p>
<p>选择你熟悉的、团队能驾驭的、生态适合的框架，然后专注于创造优质内容和良好的用户体验。这才是 SEO 成功的根本。技术框架只是实现目标的工具，真正决定网站排名和用户满意度的，始终是内容的质量和服务的价值。</p>
<p>理解技术决策的权衡，认清 SEO 的本质，基于实际需求选择，避免过度优化，把精力放在真正重要的地方。这些才是从技术讨论中应该获得的核心启示。</p>
<p>SEO 是一个系统工程，涉及技术、内容、营销等多个方面。框架选择只是技术层面的一个小环节。即使选择了最适合 SEO 的框架，如果内容质量不佳、用户体验糟糕、营销策略失败，网站依然无法获得好的排名。</p>
<p>相反，即使使用了理论上性能稍差的框架，但如果能够持续输出高质量内容、构建良好的用户体验、实施正确的 SEO 策略，网站依然可以获得优秀的搜索排名。这才是 SEO 的真谛。</p>
<p>最后，技术在不断演进。<code>Next.js</code> 和 <code>Nuxt</code> 都在快速迭代，引入新的特性和优化。今天的分析可能在明天就过时了。保持学习、关注技术动态、根据实际情况调整策略，这才是长久之计。</p>
<h2 data-id="heading-42">参考资料</h2>
<ol>
<li>Nuxt SEO 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnuxtseo.com" target="_blank" title="https://nuxtseo.com" ref="nofollow noopener noreferrer">nuxtseo.com</a></li>
<li>Next.js SEO 最佳实践：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Foptimizing%2Fmetadata" target="_blank" title="https://nextjs.org/docs/app/building-your-application/optimizing/metadata" ref="nofollow noopener noreferrer">nextjs.org/docs/app/bu…</a></li>
<li>Devalue 序列化库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRich-Harris%2Fdevalue" target="_blank" title="https://github.com/Rich-Harris/devalue" ref="nofollow noopener noreferrer">github.com/Rich-Harris…</a></li>
<li>Google 搜索中心文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fsearch" target="_blank" title="https://developers.google.com/search" ref="nofollow noopener noreferrer">developers.google.com/search</a></li>
<li>Core Web Vitals 指标说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Fvitals%2F" target="_blank" title="https://web.dev/vitals/" ref="nofollow noopener noreferrer">web.dev/vitals/</a></li>
<li>Schema.org 结构化数据规范：<a href="https://link.juejin.cn?target=https%3A%2F%2Fschema.org%2F" target="_blank" title="https://schema.org/" ref="nofollow noopener noreferrer">schema.org/</a></li>
<li>Nuxt 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnuxt.com%2Fdocs" target="_blank" title="https://nuxt.com/docs" ref="nofollow noopener noreferrer">nuxt.com/docs</a></li>
<li>Next.js 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs" target="_blank" title="https://nextjs.org/docs" ref="nofollow noopener noreferrer">nextjs.org/docs</a></li>
<li>Nitro 服务引擎：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnitro.unjs.io%2F" target="_blank" title="https://nitro.unjs.io/" ref="nofollow noopener noreferrer">nitro.unjs.io/</a></li>
<li>Web.dev 性能优化指南：<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Fperformance%2F" target="_blank" title="https://web.dev/performance/" ref="nofollow noopener noreferrer">web.dev/performance…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ant Design 6.0 尝鲜：上手现代化组件开发｜得物技术]]></title>    <link>https://juejin.cn/post/7586597780641333258</link>    <guid>https://juejin.cn/post/7586597780641333258</guid>    <pubDate>2025-12-23T06:12:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586597780641333258" data-draft-id="7586575372621889545" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ant Design 6.0 尝鲜：上手现代化组件开发｜得物技术"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:12:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ant Design 6.0 尝鲜：上手现代化组件开发｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:12:33.000Z" title="Tue Dec 23 2025 06:12:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<h3 data-id="heading-1">组件体验的革新</h3>
<p>在前端开发领域，Ant Design 一直是企业级 React 应用的首选 UI 库之一。随着 Ant Design 6.0 的发布，我们又见证了一次聚焦于组件功能与用户体验的革新。本次更新不仅引入了多个全新组件，更对现有核心组件进行了功能性增强，使开发者能够以更少的代码实现更丰富的交互效果。</p>
<h2 data-id="heading-2">二、Masonry 瀑布流组件：智能动态布局</h2>
<p>传统网格布局在处理高度不一的元素时常出现大量空白区域，Masonry（瀑布流）布局则完美解决了这一问题。Ant Design 6.0 全新推出的 Masonry 组件让实现这种流行布局变得异常简单。</p>
<h3 data-id="heading-3">基础实现与响应式配置</h3>
<pre><code class="hljs language-ini" lang="ini">import { useState, useEffect, useRef } from "react"<span class="hljs-comment">;</span>
import { Masonry, Card, Image, Spin } from "antd"<span class="hljs-comment">;</span>
/**
 * Masonry瀑布流页面
 */
export default () =&gt; {
  const <span class="hljs-section">[isLoading, setIsLoading]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">containerRef</span> = useRef&lt;HTMLDivElement&gt;(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">isLoadingRef</span> = useRef(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">imageList</span> = [
    <span class="hljs-string">"https://images.xxx.com/photo-xxx-4b4e3d86bf0f"</span>,
    ...
    <span class="hljs-string">"https://images.xxx.com/photo-xxx-98f7befd1a60"</span>,
  ]<span class="hljs-comment">;</span>
  const <span class="hljs-attr">titles</span> = [
    <span class="hljs-string">"山间日出"</span>,
    ...
    <span class="hljs-string">"自然风光"</span>,
  ]<span class="hljs-comment">;</span>
  const <span class="hljs-attr">descriptions</span> = [
    <span class="hljs-string">"清晨的第一缕阳光"</span>,
    ...
    <span class="hljs-string">"色彩鲜艳的料理"</span>,
  ]<span class="hljs-comment">;</span>
  const <span class="hljs-attr">heights</span> = [<span class="hljs-number">240</span>, <span class="hljs-number">260</span>, <span class="hljs-number">280</span>, <span class="hljs-number">300</span>, <span class="hljs-number">320</span>, <span class="hljs-number">350</span>, <span class="hljs-number">380</span>, <span class="hljs-number">400</span>]<span class="hljs-comment">;</span>
  // Mock数据生成函数
  const <span class="hljs-attr">generateMockData</span> = (startIndex: number, count: number) =&gt; {
    return Array.from({ length: count }, (_, index) =&gt; ({
      id: startIndex + index + 1,
      src: imageList<span class="hljs-section">[Math.floor(Math.random() * imageList.length)]</span>,
      title: titles<span class="hljs-section">[(startIndex + index) % titles.length]</span>,
      description: descriptions<span class="hljs-section">[(startIndex + index) % descriptions.length]</span>,
      height: heights<span class="hljs-section">[Math.floor(Math.random() * heights.length)]</span>,
    }))<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  // 初始数据：20条
  const <span class="hljs-section">[photoItems, setPhotoItems]</span> = useState(() =&gt; generateMockData(0, 20))<span class="hljs-comment">;</span>
  // 滚动监听
  useEffect(() =&gt; {
    <span class="hljs-attr">isLoadingRef.current</span> = isLoading<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[isLoading]</span>)<span class="hljs-comment">;</span>
  useEffect(() =&gt; {
    const <span class="hljs-attr">loadMoreData</span> = async () =&gt; {
      if (isLoadingRef.current) return<span class="hljs-comment">;</span>
      <span class="hljs-attr">isLoadingRef.current</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
      setIsLoading(true)<span class="hljs-comment">;</span>
      // 模拟API请求延迟
      await new Promise((resolve) =&gt; setTimeout(resolve, 500))<span class="hljs-comment">;</span>
      setPhotoItems((prev) =&gt; {
        const <span class="hljs-attr">newItems</span> = generateMockData(prev.length, <span class="hljs-number">10</span>)<span class="hljs-comment">;</span>
        return <span class="hljs-section">[...prev, ...newItems]</span><span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>
      <span class="hljs-attr">isLoadingRef.current</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
      setIsLoading(false)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
    const <span class="hljs-attr">checkScroll</span> = () =&gt; {
      if (isLoadingRef.current) return<span class="hljs-comment">;</span>
      const <span class="hljs-attr">container</span> = containerRef.current<span class="hljs-comment">;</span>
      if (!container) return<span class="hljs-comment">;</span>
      const <span class="hljs-attr">scrollTop</span> = container.scrollTop<span class="hljs-comment">;</span>
      const <span class="hljs-attr">scrollHeight</span> = container.scrollHeight<span class="hljs-comment">;</span>
      const <span class="hljs-attr">clientHeight</span> = container.clientHeight<span class="hljs-comment">;</span>
      // 当滚动到距离底部100px时触发加载
      if (scrollTop + clientHeight &gt;= scrollHeight - 100) {
        loadMoreData()<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
    const <span class="hljs-attr">handleWindowScroll</span> = () =&gt; {
      if (isLoadingRef.current) return<span class="hljs-comment">;</span>
      const <span class="hljs-attr">windowHeight</span> = window.innerHeight<span class="hljs-comment">;</span>
      const <span class="hljs-attr">documentHeight</span> = document.documentElement.scrollHeight<span class="hljs-comment">;</span>
      const <span class="hljs-attr">scrollTop</span> =
        window.pageYOffset || document.documentElement.scrollTop<span class="hljs-comment">;</span>
      // 当滚动到距离底部100px时触发加载
      if (scrollTop + windowHeight &gt;= documentHeight - 100) {
        loadMoreData()<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
    const <span class="hljs-attr">container</span> = containerRef.current<span class="hljs-comment">;</span>
    // 初始检查一次，以防内容不足一屏
    setTimeout(() =&gt; {
      checkScroll()<span class="hljs-comment">;</span>
      handleWindowScroll()<span class="hljs-comment">;</span>
    }, 100)<span class="hljs-comment">;</span>
    // 监听容器滚动
    if (container) {
      container.addEventListener("scroll", checkScroll)<span class="hljs-comment">;</span>
    }
    // 同时监听 window 滚动（作为备选）
    window.addEventListener("scroll", handleWindowScroll)<span class="hljs-comment">;</span>
    return () =&gt; {
      if (container) {
        container.removeEventListener("scroll", checkScroll)<span class="hljs-comment">;</span>
      }
      window.removeEventListener("scroll", handleWindowScroll)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
  return (
    &lt;div <span class="hljs-attr">ref</span>={containerRef} className=<span class="hljs-string">"w-full h-[100vh] overflow-auto p-[24px]"</span>&gt;
      &lt;Masonry
        // 响应式列数配置
        <span class="hljs-attr">columns</span>={{ xs: <span class="hljs-number">2</span>, sm: <span class="hljs-number">3</span>, md: <span class="hljs-number">4</span>, lg: <span class="hljs-number">5</span> }}
        // 列间距与行间距
        <span class="hljs-attr">gutter</span>={<span class="hljs-number">16</span>}
        <span class="hljs-attr">items</span>={photoItems as any}
        <span class="hljs-attr">itemRender</span>={(item: any) =&gt; (
          &lt;Card
            <span class="hljs-attr">key</span>={item.id}
            hoverable
            <span class="hljs-attr">cover</span>={
              &lt;div <span class="hljs-attr">style</span>={{ height: item.height, overflow: <span class="hljs-string">"hidden"</span> }}&gt;
                &lt;Image
                  <span class="hljs-attr">src</span>={item.src}
                  <span class="hljs-attr">alt</span>={item.title}
                  <span class="hljs-attr">height</span>={item.height}
                  <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span>
                  <span class="hljs-attr">style</span>={{
                    width: "100%",
                    height: "100%",
                    objectFit: "cover",
                  }}
                  <span class="hljs-attr">preview</span>={{
                    visible: false,
                  }}
                /&gt;
              &lt;/div&gt;
            }
            <span class="hljs-attr">styles</span>={{
              body: {
                padding: "12px",
              },
            }}
          &gt;
            &lt;Card.Meta <span class="hljs-attr">title</span>={item.title} description={item.description} /&gt;
            &lt;div
              <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-[8px] text-[12px] text-[#999]"</span>
            &gt;
              图片 <span class="hljs-comment">#{item.id}</span>
            &lt;/div&gt;
          &lt;/Card&gt;
        )}
      /&gt;
      {isLoading &amp;&amp; (
        &lt;div
          <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-center p-[20px] text-[#999]"</span>
        &gt;
          &lt;Spin <span class="hljs-attr">style</span>={{ marginRight: <span class="hljs-string">"8px"</span> }} /&gt;
          &lt;span&gt;加载中...&lt;/span&gt;
        &lt;/div&gt;
      )}
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d581da5c93a448ab95e3e8b2c3f78cf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=tpo0JQHNU%2FEJnSRKUKPMRhbm1Mw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d97d55a2a5d441ea9a2f053b0b3d777e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=wD53K84GGpCpKEWe6qCf27SQqJ8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-4">布局效果说明</h3>
<p>Masonry 组件会根据设定的列数自动将元素排列到高度最小的列中。与传统的网格布局相比，这种布局方式能有效减少内容下方的空白区域，特别适合展示高度不一的内容块。</p>
<p>对于图片展示类应用，这种布局能让用户的视线自然流动，提高浏览的沉浸感和内容发现率。</p>
<h2 data-id="heading-5">三、Tooltip 平滑移动：优雅的交互引导</h2>
<p>在 Ant Design 6.0 中，Tooltip 组件引入了独特的平滑过渡效果，通过 ConfigProvider 全局配置的 tooltip.unique 配置项，当用户在多个带有提示的元素间移动时，提示框会以流畅的动画跟随，而不是突然消失和重现。</p>
<h3 data-id="heading-6">实现平滑跟随效果</h3>
<pre><code class="hljs language-ini" lang="ini">import { Tooltip, Button, Card, ConfigProvider } from "antd"<span class="hljs-comment">;</span>
import {
  UserOutlined,
  SettingOutlined,
  BellOutlined,
  MailOutlined,
  AppstoreOutlined,
} from "@ant-design/icons"<span class="hljs-comment">;</span>
import { TooltipPlacement } from "antd/es/tooltip"<span class="hljs-comment">;</span>
/**
 * Tooltip 示例
 */
export default () =&gt; {
  const <span class="hljs-attr">buttonItems</span> = [
    {
      icon: &lt;UserOutlined /&gt;,
      text: <span class="hljs-string">"个人中心"</span>,
      tip: <span class="hljs-string">"查看和管理您的个人资料"</span>,
      placement: <span class="hljs-string">"top"</span>,
    },
    {
      icon: &lt;SettingOutlined /&gt;,
      text: <span class="hljs-string">"系统设置"</span>,
      tip: <span class="hljs-string">"调整应用程序参数和偏好"</span>,
      placement: <span class="hljs-string">"top"</span>,
    },
    {
      icon: &lt;BellOutlined /&gt;,
      text: <span class="hljs-string">"消息通知"</span>,
      tip: <span class="hljs-string">"查看未读提醒和系统消息"</span>,
      placement: <span class="hljs-string">"top"</span>,
    },
    {
      icon: &lt;MailOutlined /&gt;,
      text: <span class="hljs-string">"邮箱"</span>,
      tip: <span class="hljs-string">"收发邮件和管理联系人"</span>,
      placement: <span class="hljs-string">"bottom"</span>,
    },
    {
      icon: &lt;AppstoreOutlined /&gt;,
      text: <span class="hljs-string">"应用中心"</span>,
      tip: <span class="hljs-string">"探索和安装更多应用"</span>,
      placement: <span class="hljs-string">"bottom"</span>,
    },
  ]<span class="hljs-comment">;</span>
  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-[100vh] overflow-auto p-[24px] space-y-5"</span>&gt;
      &lt;ConfigProvider
        <span class="hljs-attr">tooltip</span>={{
          unique: true,
        }}
      &gt;
        &lt;Card <span class="hljs-attr">title</span>=<span class="hljs-string">"平滑过渡导航工具栏"</span> bordered={<span class="hljs-literal">false</span>}&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex justify-center gap-6 py-10 px-5 bg-gradient-to-br from-[#f5f7fa] to-[#c3cfe2] rounded-3xl"</span>&gt;
            {buttonItems.map((item, index) =&gt; (
              &lt;Tooltip
                <span class="hljs-attr">placement</span>={item.placement as TooltipPlacement}
                <span class="hljs-attr">key</span>={index}
                <span class="hljs-attr">title</span>={
                  &lt;div&gt;
                    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"font-bold mb-1"</span>&gt;{item.text}&lt;/div&gt;
                    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs text-[#fff]/60"</span>&gt;{item.tip}&lt;/div&gt;
                  &lt;/div&gt;
                }
                <span class="hljs-attr">color</span>=<span class="hljs-string">"#1677ff"</span>
              &gt;
                &lt;Button
                  <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
                  <span class="hljs-attr">shape</span>=<span class="hljs-string">"circle"</span>
                  <span class="hljs-attr">icon</span>={item.icon}
                  <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
                  <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[60px] h-[60px] text-2xl shadow-md transition-all duration-300 ease-in-out"</span>
                /&gt;
              &lt;/Tooltip&gt;
            ))}
          &lt;/div&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-5 p-4 bg-green-50 border border-green-300 rounded-md"</span>&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center"</span>&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-3 h-3 rounded-full bg-green-500 mr-2"</span>&gt;&lt;/div&gt;
              &lt;span&gt;
                提示：尝试将鼠标在不同图标间快速移动，观察 Tooltip
                的平滑过渡效果
              &lt;/span&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/Card&gt;
      &lt;/ConfigProvider&gt;
      &lt;Card <span class="hljs-attr">title</span>=<span class="hljs-string">"非平滑过渡导航工具栏"</span> bordered={<span class="hljs-literal">false</span>}&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex justify-center gap-6 py-10 px-5 bg-gradient-to-br from-[#f5f7fa] to-[#c3cfe2] rounded-3xl"</span>&gt;
          {buttonItems.map((item, index) =&gt; (
            &lt;Tooltip
              <span class="hljs-attr">key</span>={index}
              <span class="hljs-attr">placement</span>={item.placement as TooltipPlacement}
              <span class="hljs-attr">title</span>={
                &lt;div&gt;
                  &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"font-bold mb-1"</span>&gt;{item.text}&lt;/div&gt;
                  &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs text-[#fff]/60"</span>&gt;{item.tip}&lt;/div&gt;
                &lt;/div&gt;
              }
              <span class="hljs-attr">color</span>=<span class="hljs-string">"#1677ff"</span>
            &gt;
              &lt;Button
                <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
                <span class="hljs-attr">shape</span>=<span class="hljs-string">"circle"</span>
                <span class="hljs-attr">icon</span>={item.icon}
                <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[60px] h-[60px] text-2xl shadow-md transition-all duration-300 ease-in-out"</span>
              /&gt;
            &lt;/Tooltip&gt;
          ))}
        &lt;/div&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-5 p-4 bg-green-50 border border-green-300 rounded-md"</span>&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center"</span>&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-3 h-3 rounded-full bg-green-500 mr-2"</span>&gt;&lt;/div&gt;
            &lt;span&gt;
              提示：尝试将鼠标在不同图标间快速移动，观察 Tooltip 的非平滑过渡效果
            &lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/Card&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/336afe64172343ae9f41d2ddecb3bc54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=uHFMUtBtOTOxZ4vla7fmfihMnt4%3D" alt="2.gif" loading="lazy"/></p>
<h3 data-id="heading-7">交互效果说明</h3>
<p>当 tooltip.unique 设置为 true 时，用户在不同元素间移动鼠标时，Tooltip 会呈现以下行为：</p>
<ol>
<li>
<p>平滑位置过渡：Tooltip 不会立即消失，而是平滑移动到新目标位置</p>
</li>
<li>
<p>内容无缝切换：提示内容在新位置淡入，旧内容淡出</p>
</li>
<li>
<p>视觉连续性：保持同一时刻只有一个 Tooltip 显示，避免界面混乱</p>
</li>
</ol>
<p>这种设计特别适合工具栏、导航菜单等元素密集的区域，能有效降低用户的认知负荷，提供更加流畅的交互体验。</p>
<h2 data-id="heading-8">四、InputNumber 拨轮模式：直观的数字输入</h2>
<p>数字输入框是表单中的常见组件，但传统的上下箭头控件在小屏幕或触摸设备上操作不便。Ant Design 6.0 的 InputNumber 组件新增了 mode="spinner" 属性，提供了更直观的“加减按钮”界面。</p>
<h3 data-id="heading-9">拨轮模式实现</h3>
<pre><code class="hljs language-ini" lang="ini">import { InputNumber, Card, Row, Col, Typography, Space } from "antd"<span class="hljs-comment">;</span>
import {
  ShoppingCartOutlined,
  DollarOutlined,
  GiftOutlined,
} from "@ant-design/icons"<span class="hljs-comment">;</span>
const { Title, Text } = Typography<span class="hljs-comment">;</span>
/**
 * InputNumber 示例
 */
export default () =&gt; {
  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-[100vh] overflow-auto p-[24px] space-y-5"</span>&gt;
      &lt;Card <span class="hljs-attr">title</span>=<span class="hljs-string">"商品订购面板"</span> bordered={<span class="hljs-literal">false</span>}&gt;
        &lt;Row <span class="hljs-attr">gutter</span>={[<span class="hljs-number">24</span>, <span class="hljs-number">24</span>]}&gt;
          &lt;Col <span class="hljs-attr">span</span>={<span class="hljs-number">8</span>}&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center"</span>&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[80px] h-[80px] mx-auto mb-4 rounded-3xl bg-[#f0f5ff] flex items-center justify-center text-[32px] text-[#1677ff]"</span>&gt;
                &lt;ShoppingCartOutlined /&gt;
              &lt;/div&gt;
              &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"mb-3"</span>&gt;
                购买数量(非数字拨轮)
              &lt;/Title&gt;
              &lt;InputNumber
                <span class="hljs-attr">min</span>={<span class="hljs-number">1</span>}
                <span class="hljs-attr">max</span>={<span class="hljs-number">50</span>}
                <span class="hljs-attr">defaultValue</span>={<span class="hljs-number">1</span>}
                <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[250px]!"</span>
                <span class="hljs-attr">addonBefore</span>=<span class="hljs-string">"数量"</span>
              /&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-2 text-xs text-gray-600"</span>&gt;限购<span class="hljs-number">50</span>件&lt;/div&gt;
            &lt;/div&gt;
          &lt;/Col&gt;
          &lt;Col <span class="hljs-attr">span</span>={<span class="hljs-number">8</span>}&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center"</span>&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[80px] h-[80px] mx-auto mb-4 rounded-3xl bg-[#fff7e6] flex items-center justify-center text-[32px] text-[#fa8c16]"</span>&gt;
                &lt;DollarOutlined /&gt;
              &lt;/div&gt;
              &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"mb-3"</span>&gt;
                折扣力度(数字拨轮)
              &lt;/Title&gt;
              &lt;InputNumber
                <span class="hljs-attr">min</span>={<span class="hljs-number">0</span>}
                <span class="hljs-attr">max</span>={<span class="hljs-number">100</span>}
                <span class="hljs-attr">defaultValue</span>={<span class="hljs-number">10</span>}
                <span class="hljs-attr">mode</span>=<span class="hljs-string">"spinner"</span>
                <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
                <span class="hljs-attr">formatter</span>={(value) =&gt; `<span class="hljs-variable">${value ?? 0}</span>%`}
                <span class="hljs-attr">parser</span>={(value) =&gt;
                  Number.parseFloat(value?.replace("%", "") ?? "0") as any
                }
                <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[250px]!"</span>
                <span class="hljs-attr">addonBefore</span>=<span class="hljs-string">"折扣"</span>
              /&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-2 text-xs text-gray-600"</span>&gt;<span class="hljs-number">0</span>-<span class="hljs-number">100</span>%范围&lt;/div&gt;
            &lt;/div&gt;
          &lt;/Col&gt;
          &lt;Col <span class="hljs-attr">span</span>={<span class="hljs-number">8</span>}&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center"</span>&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[80px] h-[80px] mx-auto mb-4 rounded-3xl bg-[#f6ffed] flex items-center justify-center text-[32px] text-[#52c41a]"</span>&gt;
                &lt;GiftOutlined /&gt;
              &lt;/div&gt;
              &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"mb-3"</span>&gt;
                礼品数量(数字拨轮，自定义加减按钮)
              &lt;/Title&gt;
              &lt;Space.Compact block <span class="hljs-attr">className</span>=<span class="hljs-string">"justify-center!"</span>&gt;
                &lt;Space.Addon&gt;
                  &lt;span&gt;礼品&lt;/span&gt;
                &lt;/Space.Addon&gt;
                &lt;InputNumber
                  <span class="hljs-attr">min</span>={<span class="hljs-number">0</span>}
                  <span class="hljs-attr">max</span>={<span class="hljs-number">10</span>}
                  <span class="hljs-attr">defaultValue</span>={<span class="hljs-number">0</span>}
                  <span class="hljs-attr">mode</span>=<span class="hljs-string">"spinner"</span>
                  <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
                  <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[250px]!"</span>
                  <span class="hljs-attr">controls</span>={{
                    upIcon: &lt;span <span class="hljs-attr">className</span>=<span class="hljs-string">"text-base"</span>&gt;➕&lt;/span&gt;,
                    downIcon: &lt;span <span class="hljs-attr">className</span>=<span class="hljs-string">"text-base"</span>&gt;➖&lt;/span&gt;,
                  }}
                /&gt;
              &lt;/Space.Compact&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-2 text-xs text-gray-600"</span>&gt;每单最多<span class="hljs-number">10</span>份&lt;/div&gt;
            &lt;/div&gt;
          &lt;/Col&gt;
        &lt;/Row&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-8 p-4 bg-[#fff0f6] rounded-lg border border-dashed border-[#ffadd2]"</span>&gt;
          &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span>&gt;
            &lt;strong&gt;设计提示：&lt;/strong&gt;
            拨轮模式相比传统箭头控件，提供了更大的点击区域和更明确的视觉反馈，特别适合触摸设备和需要频繁调整数值的场景。加减按钮的分离式设计也降低了误操作的可能性。
          &lt;/Text&gt;
        &lt;/div&gt;
      &lt;/Card&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cace26657dd49f6a68e163e3646dfff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=0aH4JXQ%2BbFgSto4h%2BRafl4lOJpo%3D" alt="3.gif" loading="lazy"/></p>
<h3 data-id="heading-10">交互优势分析</h3>
<p>拨轮模式相比传统数字输入框具有明显优势：</p>
<ol>
<li>
<p>触摸友好：更大的按钮区域适合移动端操作</p>
</li>
<li>
<p>意图明确：“+”和“-”符号比小箭头更直观</p>
</li>
<li>
<p>快速调整：支持长按连续增减数值</p>
</li>
<li>
<p>视觉反馈：按钮有明确的状态变化（按下、悬停）</p>
</li>
</ol>
<p>在电商、数据仪表盘、配置面板等需要频繁调整数值的场景中，这种设计能显著提升用户的操作效率和满意度。</p>
<h2 data-id="heading-11">五、Drawer 拖拽调整：灵活的侧边面板</h2>
<p>抽屉组件常用于移动端导航或详情面板，但固定尺寸有时无法满足多样化的内容展示需求。Ant Design 6.0 为 Drawer 组件新增了 resizable 属性，允许用户通过拖拽边缘实时调整面板尺寸。</p>
<h3 data-id="heading-12">可调整抽屉实现</h3>
<pre><code class="hljs language-ini" lang="ini">import { Drawer, Button, Card, Typography, Divider, List, Flex } from "antd"<span class="hljs-comment">;</span>
import {
  DragOutlined,
  CalendarOutlined,
  FileTextOutlined,
  TeamOutlined,
  CommentOutlined,
  PaperClipOutlined,
} from "@ant-design/icons"<span class="hljs-comment">;</span>
import { useState } from "react"<span class="hljs-comment">;</span>
import { DrawerResizableConfig } from "antd/es/drawer"<span class="hljs-comment">;</span>
const { Title, Text, Paragraph } = Typography<span class="hljs-comment">;</span>
/**
 * Drawer 示例
 */
export default () =&gt; {
  const <span class="hljs-section">[open, setOpen]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[drawerWidth, setDrawerWidth]</span> = useState(400)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[resizable, setResizable]</span> = useState&lt;boolean | DrawerResizableConfig&gt;(
    false,
  )<span class="hljs-comment">;</span>
  const <span class="hljs-attr">tasks</span> = [
    { id: <span class="hljs-number">1</span>, title: <span class="hljs-string">"完成项目需求文档"</span>, time: <span class="hljs-string">"今天 10:00"</span>, priority: <span class="hljs-string">"high"</span> },
    { id: <span class="hljs-number">2</span>, title: <span class="hljs-string">"团队周会"</span>, time: <span class="hljs-string">"今天 14:30"</span>, priority: <span class="hljs-string">"medium"</span> },
    { id: <span class="hljs-number">3</span>, title: <span class="hljs-string">"代码审查"</span>, time: <span class="hljs-string">"明天 09:00"</span>, priority: <span class="hljs-string">"high"</span> },
    { id: <span class="hljs-number">4</span>, title: <span class="hljs-string">"客户演示准备"</span>, time: <span class="hljs-string">"后天 15:00"</span>, priority: <span class="hljs-string">"medium"</span> },
  ]<span class="hljs-comment">;</span>
  const <span class="hljs-attr">showDrawerWithResizable</span> = () =&gt; {
    setOpen(true)<span class="hljs-comment">;</span>
    setDrawerWidth(400)<span class="hljs-comment">;</span>
    setResizable({
      onResize: (size) =&gt; {
        setDrawerWidth(size)<span class="hljs-comment">;</span>
      },
    })<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  const <span class="hljs-attr">showDrawerWithoutResizable</span> = () =&gt; {
    setOpen(true)<span class="hljs-comment">;</span>
    setDrawerWidth(600)<span class="hljs-comment">;</span>
    setResizable(false)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  const <span class="hljs-attr">onClose</span> = () =&gt; {
    setOpen(false)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-[100vh] flex items-center justify-center overflow-auto p-[24px] space-y-5"</span>&gt;
      &lt;Card
        <span class="hljs-attr">title</span>=<span class="hljs-string">"任务管理面板"</span>
        <span class="hljs-attr">variant</span>=<span class="hljs-string">"outlined"</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"max-w-[800px] mx-auto"</span>
      &gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"py-10 px-5 text-center"</span>&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-20 h-20 mx-auto mb-6 rounded-full bg-[#1677ff] flex items-center justify-center text-[36px] text-white"</span>&gt;
            &lt;DragOutlined /&gt;
          &lt;/div&gt;
          &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">3</span>}&gt;可调整的任务详情面板&lt;/Title&gt;
          &lt;Paragraph <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span> className=<span class="hljs-string">"max-w-[600px] my-4 mx-auto"</span>&gt;
            点击下方按钮打开一个可拖拽调整宽度的抽屉面板。尝试拖动抽屉左侧边缘，根据内容需要调整面板尺寸。
          &lt;/Paragraph&gt;
          &lt;Flex <span class="hljs-attr">justify</span>=<span class="hljs-string">"center"</span> gap={<span class="hljs-number">10</span>}&gt;
            &lt;Button
              <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
              <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
              <span class="hljs-attr">onClick</span>={showDrawerWithResizable}
              <span class="hljs-attr">icon</span>={&lt;CalendarOutlined /&gt;}
              <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-6"</span>
            &gt;
              打开任务抽屉(可拖拽宽度)
            &lt;/Button&gt;
            &lt;Button
              <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
              <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
              <span class="hljs-attr">onClick</span>={showDrawerWithoutResizable}
              <span class="hljs-attr">icon</span>={&lt;CalendarOutlined /&gt;}
              <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-6"</span>
            &gt;
              打开任务抽屉(不可拖拽宽度)
            &lt;/Button&gt;
          &lt;/Flex&gt;
        &lt;/div&gt;
      &lt;/Card&gt;
      &lt;Drawer
        <span class="hljs-attr">title</span>={
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center"</span>&gt;
            &lt;CalendarOutlined <span class="hljs-attr">className</span>=<span class="hljs-string">"mr-2 text-[#1677ff]"</span> /&gt;
            &lt;span&gt;任务详情与计划&lt;/span&gt;
            {resizable &amp;&amp; (
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"ml-3 py-0.5 px-2 bg-[#f0f5ff] rounded-[10px] text-xs text-[#1677ff]"</span>&gt;
                可拖拽调整宽度
              &lt;/div&gt;
            )}
          &lt;/div&gt;
        }
        <span class="hljs-attr">placement</span>=<span class="hljs-string">"right"</span>
        <span class="hljs-attr">onClose</span>={<span class="hljs-literal">on</span>Close}
        <span class="hljs-attr">open</span>={open}
        <span class="hljs-attr">size</span>={drawerWidth}
        <span class="hljs-attr">resizable</span>={resizable}
        <span class="hljs-attr">extra</span>={
          &lt;Button <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> icon={&lt;DragOutlined /&gt;}&gt;
            {resizable ? "拖拽边缘调整" : "不可拖拽"}
          &lt;/Button&gt;
        }
        <span class="hljs-attr">styles</span>={{
          body: {
            paddingTop: "12px",
          },
          header: {
            borderBottom: "1px solid <span class="hljs-comment">#f0f0f0",</span>
          },
        }}
      &gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mb-6"</span>&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center mb-4"</span>&gt;
            &lt;FileTextOutlined <span class="hljs-attr">className</span>=<span class="hljs-string">"mr-2 text-[#52c41a]"</span> /&gt;
            &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"m-0"</span>&gt;
              当前任务
            &lt;/Title&gt;
          &lt;/div&gt;
          &lt;Card <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>&gt;
            &lt;List
              <span class="hljs-attr">itemLayout</span>=<span class="hljs-string">"horizontal"</span>
              <span class="hljs-attr">dataSource</span>={tasks}
              <span class="hljs-attr">renderItem</span>={(item) =&gt; (
                &lt;List.Item&gt;
                  &lt;List.Item.Meta
                    <span class="hljs-attr">avatar</span>={
                      &lt;div
                        <span class="hljs-attr">className</span>={`w-<span class="hljs-number">8</span> h-<span class="hljs-number">8</span> rounded-md flex items-center justify-center ${
                          <span class="hljs-attr">item.priority</span> === <span class="hljs-string">"high"</span>
                            ? "bg-<span class="hljs-section">[#fff2f0]</span> text-<span class="hljs-section">[#ff4d4f]</span>"
                            : "bg-<span class="hljs-section">[#f6ffed]</span> text-<span class="hljs-section">[#52c41a]</span>"
                        }`}
                      &gt;
                        {<span class="hljs-attr">item.priority</span> === <span class="hljs-string">"high"</span> ? <span class="hljs-string">"急"</span> : <span class="hljs-string">"常"</span>}
                      &lt;/div&gt;
                    }
                    <span class="hljs-attr">title</span>={&lt;a&gt;{item.title}&lt;/a&gt;}
                    <span class="hljs-attr">description</span>={&lt;Text type=<span class="hljs-string">"secondary"</span>&gt;{item.time}&lt;/Text&gt;}
                  /&gt;
                &lt;/List.Item&gt;
              )}
            /&gt;
          &lt;/Card&gt;
        &lt;/div&gt;
        &lt;Divider /&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mb-6"</span>&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center mb-4"</span>&gt;
            &lt;TeamOutlined <span class="hljs-attr">className</span>=<span class="hljs-string">"mr-2 text-[#fa8c16]"</span> /&gt;
            &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"m-0"</span>&gt;
              团队动态
            &lt;/Title&gt;
          &lt;/div&gt;
          &lt;Paragraph&gt;
            本周团队主要聚焦于项目第三阶段的开发工作，前端组已完成了核心组件的重构，后端组正在进行性能优化。
          &lt;/Paragraph&gt;
        &lt;/div&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mb-6"</span>&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center mb-4"</span>&gt;
            &lt;CommentOutlined <span class="hljs-attr">className</span>=<span class="hljs-string">"mr-2 text-[#722ed1]"</span> /&gt;
            &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"m-0"</span>&gt;
              最新反馈
            &lt;/Title&gt;
          &lt;/div&gt;
          &lt;Card <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> type=<span class="hljs-string">"inner"</span>&gt;
            &lt;Paragraph&gt;
              "新的界面设计得到了客户的积极反馈，特别是可调整的面板设计，让不同角色的用户都能获得适合自己工作习惯的布局。"
            &lt;/Paragraph&gt;
            &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span>&gt;—— 产品经理，XXX&lt;/Text&gt;
          &lt;/Card&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center mb-4"</span>&gt;
            &lt;PaperClipOutlined <span class="hljs-attr">className</span>=<span class="hljs-string">"mr-2 text-[#eb2f96]"</span> /&gt;
            &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"m-0"</span>&gt;
              使用提示
            &lt;/Title&gt;
          &lt;/div&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"p-3 bg-[#f6ffed] rounded-md border border-[#b7eb8f]"</span>&gt;
            &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span>&gt;
              当前抽屉宽度: &lt;strong&gt;{drawerWidth}px&lt;/strong&gt;。您可以: 1.
              拖动左侧边缘调整宽度 2. 内容区域会根据宽度自动重新布局 3.
              适合查看不同密度的信息
            &lt;/Text&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/Drawer&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd6e7f951e54719836ab31c8b2ab0d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=9jiPV%2B5WuHFi2siIzw7jiM77ZxE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9831a86a1384197ab19fa5f99c381af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=MmFSjb0lkVvkgfo9w26NGHuAP5A%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-13">拖拽交互的价值</h3>
<p>可调整抽屉的设计带来了明显的用户体验提升：</p>
<ol>
<li>
<p>自适应内容：用户可以根据当前查看的内容类型调整面板尺寸</p>
</li>
<li>
<p>个性化布局：不同用户或场景下可以设置不同的面板大小</p>
</li>
<li>
<p>多任务处理：宽面板适合详情查看，窄面板适合边操作边参考</p>
</li>
<li>
<p>渐进式披露：可以从紧凑视图逐步展开到详细视图</p>
</li>
</ol>
<h2 data-id="heading-14">六、Modal 背景模糊：朦胧美学的视觉升级</h2>
<p>在传统 Web 应用中，模态框的遮罩层往往是简单的半透明黑色，视觉效果单调且缺乏现代感。而在 iOS 和 macOS 等系统中，毛玻璃（frosted glass）效果已成为标志性的设计语言效果样式。Ant Design 6.0 为所有弹层组件引入了原生背景模糊支持，并提供了强大的语义化样式定制能力，让开发者能轻松打造出高级感十足的视觉效果。</p>
<h3 data-id="heading-15">背景模糊与语义化样式定制</h3>
<p>以下示例展示了如何结合 Ant Design 6.0 的背景模糊特性和 antd-style 库，实现两种不同风格的模态框：</p>
<pre><code class="hljs language-ini" lang="ini">import { useState } from "react"<span class="hljs-comment">;</span>
import { Button, Flex, Modal, Card, Image, Typography, Space } from "antd"<span class="hljs-comment">;</span>
import type { ModalProps } from "antd"<span class="hljs-comment">;</span>
import { createStyles } from "antd-style"<span class="hljs-comment">;</span>
const { Title, Text } = Typography<span class="hljs-comment">;</span>
// 使用 antd-style 的 createStyles 定义样式
const <span class="hljs-attr">useStyles</span> = createStyles(({ token }) =&gt; ({
  // 用于模态框容器的基础样式
  container: {
    borderRadius: token.borderRadiusLG * 1.5,
    overflow: "hidden",
  },
}))<span class="hljs-comment">;</span>
// 示例用的共享内容
const <span class="hljs-attr">sharedContent</span> = (
  &lt;Card <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> bordered={<span class="hljs-literal">false</span>}&gt;
    &lt;Image
      <span class="hljs-attr">height</span>={<span class="hljs-number">300</span>}
      <span class="hljs-attr">src</span>=<span class="hljs-string">"https://gw.alipayobjects.com/zos/antfincdn/LlvErxo8H9/photo-1503185912284-5271ff81b9a8.webp"</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span>
      <span class="hljs-attr">preview</span>={<span class="hljs-literal">false</span>}
      <span class="hljs-attr">className</span>=<span class="hljs-string">"mx-auto!"</span>
    /&gt;
    &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span> style={{ display: <span class="hljs-string">"block"</span>, marginTop: <span class="hljs-number">8</span> }}&gt;
      Ant Design 6.0 默认的模糊背景与 antd-style
      定制的毛玻璃面板相结合，营造出深邃而富有层次的视觉体验。
    &lt;/Text&gt;
  &lt;/Card&gt;
)<span class="hljs-comment">;</span>
export default () =&gt; {
  const <span class="hljs-section">[blurModalOpen, setBlurModalOpen]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[gradientModalOpen, setGradientModalOpen]</span> = useState(false)<span class="hljs-comment">;</span>
  const { styles: classNames } = useStyles()<span class="hljs-comment">;</span>
  // 场景1：背景玻璃模糊效果（朦胧美学）
  const blurModalStyles: ModalProps<span class="hljs-section">["styles"]</span> = {
    body: {
      padding: 24,
    },
  }<span class="hljs-comment">;</span>
  // 场景2：渐变色背景模态框（无模糊效果）
  const gradientModalStyles: ModalProps<span class="hljs-section">["styles"]</span> = {
    mask: {
      backgroundImage: `linear-gradient(
        135deg, 
        rgba(99, 102, 241, 0.8) 0%, 
        rgba(168, 85, 247, 0.6) 50%, 
        rgba(236, 72, 153, 0.8) 100%
      )`,
    },
    body: {
      padding: 24,
    },
    header: {
      background: "linear-gradient(to right, <span class="hljs-comment">#6366f1, #a855f7)",</span>
      color: "<span class="hljs-comment">#fff",</span>
      borderBottom: "none",
    },
    footer: {
      borderTop: "1px solid <span class="hljs-comment">#e5e7eb",</span>
      textAlign: "center",
    },
  }<span class="hljs-comment">;</span>
  // 共享配置
  const sharedProps: <span class="hljs-attr">ModalProps</span> = {
    centered: true,
    classNames,
  }<span class="hljs-comment">;</span>
  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-[100vh] overflow-auto p-[24px] space-y-5"</span>&gt;
      &lt;Card
        <span class="hljs-attr">title</span>=<span class="hljs-string">"Ant Design 6 模态框样式示例"</span>
        <span class="hljs-attr">bordered</span>={<span class="hljs-literal">false</span>}
        <span class="hljs-attr">extra</span>={
          &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span> className=<span class="hljs-string">"text-sm"</span>&gt;
            朦胧美学 + 渐变背景，高级感拉满！
          &lt;/Text&gt;
        }
      &gt;
        &lt;Flex
          <span class="hljs-attr">gap</span>=<span class="hljs-string">"middle"</span>
          <span class="hljs-attr">align</span>=<span class="hljs-string">"center"</span>
          <span class="hljs-attr">justify</span>=<span class="hljs-string">"center"</span>
          <span class="hljs-attr">style</span>={{ padding: <span class="hljs-number">40</span>, minHeight: <span class="hljs-number">300</span> }}
        &gt;
          &lt;Button
            <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
            <span class="hljs-attr">onClick</span>={() =&gt; setBlurModalOpen(<span class="hljs-literal">true</span>)}
          &gt;
            🌫️ 背景玻璃模糊效果
          &lt;/Button&gt;
          &lt;Button <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span> <span class="hljs-literal">on</span>Click={() =&gt; setGradientModalOpen(<span class="hljs-literal">true</span>)}&gt;
            🎨 渐变色背景模态框
          &lt;/Button&gt;
          {/* 模态框 1：背景玻璃模糊效果（朦胧美学） */}
          &lt;Modal
            {...sharedProps}
            <span class="hljs-attr">title</span>=<span class="hljs-string">"背景玻璃模糊效果"</span>
            <span class="hljs-attr">styles</span>={blurModalStyles}
            <span class="hljs-attr">open</span>={blurModalOpen}
            <span class="hljs-attr">onOk</span>={() =&gt; setBlurModalOpen(<span class="hljs-literal">false</span>)}
            <span class="hljs-attr">onCancel</span>={() =&gt; setBlurModalOpen(<span class="hljs-literal">false</span>)}
            <span class="hljs-attr">okText</span>=<span class="hljs-string">"太美了"</span>
            <span class="hljs-attr">cancelText</span>=<span class="hljs-string">"关闭"</span>
            <span class="hljs-attr">mask</span>={{ enabled: <span class="hljs-literal">true</span>, blur: <span class="hljs-literal">true</span> }}
            <span class="hljs-attr">width</span>={<span class="hljs-number">600</span>}
          &gt;
            {sharedContent}
            &lt;div
              <span class="hljs-attr">style</span>={{
                marginTop: 16,
                padding: 16,
                background: "rgba(255, 255, 255, 0.6)",
                borderRadius: 8,
                backdropFilter: "blur(10px)",
              }}
            &gt;
              &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span>&gt;
                &lt;strong&gt;💡 设计亮点：&lt;/strong&gt;
                启用了 <span class="hljs-attr">mask</span>=&amp;<span class="hljs-comment">#123;&amp;#123; blur: true &amp;#125;&amp;#125;，</span>
                背景会自动应用模糊效果，营造出朦胧美学的高级质感。
              &lt;/Text&gt;
            &lt;/div&gt;
          &lt;/Modal&gt;
          {/* 模态框 2：渐变色背景（无模糊效果） */}
          &lt;Modal
            {...sharedProps}
            <span class="hljs-attr">title</span>=<span class="hljs-string">"渐变色背景模态框"</span>
            <span class="hljs-attr">styles</span>={gradientModalStyles}
            <span class="hljs-attr">open</span>={gradientModalOpen}
            <span class="hljs-attr">onOk</span>={() =&gt; setGradientModalOpen(<span class="hljs-literal">false</span>)}
            <span class="hljs-attr">onCancel</span>={() =&gt; setGradientModalOpen(<span class="hljs-literal">false</span>)}
            <span class="hljs-attr">okText</span>=<span class="hljs-string">"好看"</span>
            <span class="hljs-attr">cancelText</span>=<span class="hljs-string">"关闭"</span>
            <span class="hljs-attr">mask</span>={{ enabled: <span class="hljs-literal">true</span>, blur: <span class="hljs-literal">false</span> }}
            <span class="hljs-attr">width</span>={<span class="hljs-number">600</span>}
          &gt;
            {sharedContent}
            &lt;div
              <span class="hljs-attr">style</span>={{
                marginTop: 16,
                padding: 16,
                background: "linear-gradient(135deg, <span class="hljs-comment">#fef3c7 0%, #fce7f3 100%)",</span>
                borderRadius: 8,
                border: "1px solid rgba(168, 85, 247, 0.2)",
              }}
            &gt;
              &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span>&gt;
                &lt;strong&gt;🎨 设计亮点：&lt;/strong&gt;
                通过 styles.mask 设置渐变背景色，同时 styles.header
                应用了渐变头部，打造独特的视觉体验。
              &lt;/Text&gt;
            &lt;/div&gt;
          &lt;/Modal&gt;
        &lt;/Flex&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-6 p-5 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-purple-200"</span>&gt;
          &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"mb-3"</span>&gt;
            📚 技术要点
          &lt;/Title&gt;
          &lt;Space <span class="hljs-attr">direction</span>=<span class="hljs-string">"vertical"</span> size=<span class="hljs-string">"small"</span> className=<span class="hljs-string">"w-full"</span>&gt;
            &lt;Text&gt;
              • &lt;strong&gt;玻璃模糊：&lt;/strong&gt;使用 <span class="hljs-attr">mask</span>=&amp;<span class="hljs-comment">#123;&amp;#123; blur: true &amp;#125;&amp;#125; 启用原生模糊效果</span>
            &lt;/Text&gt;
            &lt;Text&gt;
              • &lt;strong&gt;渐变背景：&lt;/strong&gt;通过 styles.mask.backgroundImage 设置渐变色
            &lt;/Text&gt;
            &lt;Text&gt;
              • &lt;strong&gt;语义化定制：&lt;/strong&gt;使用 styles.header/body/footer 精准控制各部分样式
            &lt;/Text&gt;
            &lt;Text&gt;
              • &lt;strong&gt;antd-style 集成：&lt;/strong&gt;使用 createStyles 定义可复用的样式类名
            &lt;/Text&gt;
          &lt;/Space&gt;
        &lt;/div&gt;
      &lt;/Card&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b1642877d6540d8a4d34a460a4ca213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=9tqQeBpAb2EX0l8rDWQG%2FtsOHXo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8d6618c5c7c4b609ea568e2d36016ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=nAYA42CH53TgtTMsYAmzIAqMDbc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-16">核心特性解析</h3>
<p><strong>1. 背景模糊开关</strong></p>
<p>通过 mask 属性的 blur 配置项，可以一键开启/关闭背景模糊效果：</p>
<ul>
<li>mask={{ enabled: true, blur: true }}：启用毛玻璃效果</li>
<li>mask={{ enabled: true, blur: false }}：使用传统半透明遮罩</li>
</ul>
<p><strong>2. 语义化样式定制</strong></p>
<p>styles 属性允许精准控制组件各个部分的样式，无需编写复杂的 CSS 选择器：</p>
<ul>
<li>styles.mask：遮罩层样式（可设置渐变背景）</li>
<li>styles.header：头部样式（可定制颜色、边框）</li>
<li>styles.body：内容区样式（可调整间距）</li>
<li>styles.footer：底部样式（可设置对齐方式）</li>
</ul>
<p><strong>3. antd-style 集成</strong></p>
<p>结合 antd-style 可以创建主题感知的样式：</p>
<ul>
<li>访问 Design Token（如 token.borderRadiusLG）</li>
<li>样式自动响应主题切换（亮色/暗色模式）</li>
<li>通过 classNames 属性应用 CSS 类名</li>
</ul>
<h3 data-id="heading-17">视觉效果对比</h3>
<p>使用背景模糊和语义化样式定制后，Modal 的视觉呈现发生了显著变化：</p>
<p><strong>1. 背景模糊效果：</strong> 遮罩层从单调的半透明黑色变为毛玻璃效果，背景内容呈现柔和的模糊感</p>
<p><strong>2. 精准样式控制：</strong> 通过 <code>styles.mask/header/body/footer</code> 可以像搭积木一样组装出品牌化的对话框</p>
<p><strong>3. 主题联动：</strong> 结合 <code>antd-style</code> 后，样式会自动响应全局主题切换，无需手动维护暗色模式样式</p>
<p><strong>4. 维护性提升：</strong> 告别 <code>.ant-modal .ant-modal-content .ant-modal-header</code> 这样的深层选择器，样式意图清晰明确</p>
<p>这种设计让 Ant Design 6.0 的组件定制从"CSS 覆盖战争"升级为"API 声明式配置"，显著降低了样式维护成本，同时保持了高度的灵活性。</p>
<h2 data-id="heading-18">七、Card 赛博朋克风格：霓虹科技美学的呈现</h2>
<p>在传统的企业级应用中，卡片组件往往采用简洁素雅的设计。但对于游戏、科技、创意类产品，开发者往往需要更具视觉冲击力的效果。Ant Design 6.0 的 Card 组件配合 antd-style，可以轻松实现赛博朋克风格的霓虹发光边框、深色内阴影和动态动画效果，让你的界面充满未来感和科技感。</p>
<h3 data-id="heading-19">赛博朋克卡片实现</h3>
<p>以下示例展示了如何使用 antd-style 的 CSS-in-JS 能力，为 Card 组件打造完整的赛博朋克视觉风格：</p>
<pre><code class="hljs language-css" lang="css">import { Card, Typography, <span class="hljs-selector-tag">Button</span>, Space, Avatar, Row, Col } <span class="hljs-selector-tag">from</span> "antd";
import { createStyles } <span class="hljs-selector-tag">from</span> "antd-style";
import {
  ThunderboltOutlined,
  RocketOutlined,
  FireOutlined,
  StarOutlined,
  TrophyOutlined,
} <span class="hljs-selector-tag">from</span> "<span class="hljs-keyword">@ant-design</span>/icons";
const { Title, Text, Paragraph } = Typography;
// 使用 antd-style 创建赛博朋克风格样式
const useStyles = createStyles(({ css }) =&gt; ({
  // 赛博朋克卡片 - 紫色霓虹
  cyberpunkCard: css`
    background: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">15</span>, <span class="hljs-number">15</span>, <span class="hljs-number">35</span>, <span class="hljs-number">0.9</span>);
    <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#a855f7</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
    <span class="hljs-comment">/* 发光边框效果 */</span>
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.5</span>),
      inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.1</span>);
    &amp;<span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">5px</span>);
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">30px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.8</span>),
        inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">30px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.2</span>);
      <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#c084fc</span>;
    }
    <span class="hljs-comment">/* 顶部霓虹灯条 */</span>
    &amp;<span class="hljs-selector-pseudo">::before</span> {
      <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">3px</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(
        <span class="hljs-number">90deg</span>,
        transparent,
        <span class="hljs-number">#a855f7</span>,
        <span class="hljs-number">#c084fc</span>,
        <span class="hljs-number">#a855f7</span>,
        transparent
      );
      <span class="hljs-attribute">animation</span>: neonFlow <span class="hljs-number">3s</span> ease-in-out infinite;
    }
    <span class="hljs-keyword">@keyframes</span> neonFlow {
      <span class="hljs-number">0%</span>, <span class="hljs-number">100%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
      <span class="hljs-number">50%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>; }
    }
  `,
  // 霓虹文字
  neonText: css`
    color: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> currentColor,
                 <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> currentColor,
                 <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">30px</span> currentColor;
    <span class="hljs-attribute">font-weight</span>: bold;
  `,
  // 霓虹按钮
  neonButton: css`
    background: transparent <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid currentColor <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: inherit <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> currentColor;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> currentColor,
                inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>);
    <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease <span class="hljs-meta">!important</span>;
    &amp;<span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.05</span>);
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> currentColor,
                  inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.2</span>) <span class="hljs-meta">!important</span>;
    }
  `,
  // 数据面板
  dataPanel: css`
    background: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>);
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
    backdrop-<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">10px</span>);
  `,
}));
export default () =&gt; {
  const { styles } = useStyles();
  return (
    &lt;Row gutter={<span class="hljs-selector-attr">[24, 24]</span>}&gt;
      &lt;Col <span class="hljs-selector-tag">span</span>={<span class="hljs-number">8</span>}&gt;
        &lt;Card
          className={styles<span class="hljs-selector-class">.cyberpunkCard</span>}
          hoverable
          styles={{ <span class="hljs-selector-tag">body</span>: { <span class="hljs-attribute">padding</span>: <span class="hljs-number">24</span> } }}
        &gt;
          &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">position</span>: <span class="hljs-string">"relative"</span>, zIndex: <span class="hljs-number">1</span> }}&gt;
            {<span class="hljs-comment">/* 头部 */</span>}
            &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">"flex"</span>, alignItems: <span class="hljs-string">"center"</span>, marginBottom: <span class="hljs-number">16</span> }}&gt;
              &lt;Avatar
                size={<span class="hljs-number">64</span>}
                <span class="hljs-attribute">icon</span>={&lt;ThunderboltOutlined /&gt;}
                style={{
                  <span class="hljs-attribute">background</span>: <span class="hljs-string">"linear-gradient(135deg, #a855f7, transparent)"</span>,
                  border: <span class="hljs-string">"2px solid #a855f7"</span>,
                  color: <span class="hljs-string">"#a855f7"</span>,
                  filter: <span class="hljs-string">"drop-shadow(0 0 10px #a855f7)"</span>,
                }}
              /&gt;
            &lt;/<span class="hljs-selector-tag">div</span>&gt;
            {<span class="hljs-comment">/* 标题 */</span>}
            &lt;Title level={<span class="hljs-number">4</span>} className={styles<span class="hljs-selector-class">.neonText</span>} style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span> }}&gt;
              QUANTUM PROCESSOR
            &lt;/Title&gt;
            &lt;Text style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#888"</span>, display: <span class="hljs-string">"block"</span>, marginBottom: <span class="hljs-number">16</span> }}&gt;
              量子处理器
            &lt;/Text&gt;
            {<span class="hljs-comment">/* 描述 */</span>}
            &lt;Paragraph style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#bbb"</span>, marginBottom: <span class="hljs-number">20</span> }}&gt;
              第九代量子处理器，采用纳米级光刻技术，配备AI神经网络加速引擎。
            &lt;/Paragraph&gt;
            {<span class="hljs-comment">/* 数据面板 */</span>}
            &lt;<span class="hljs-selector-tag">div</span> className={styles<span class="hljs-selector-class">.dataPanel</span>} style={{ marginBottom: <span class="hljs-number">20</span> }}&gt;
              &lt;Space <span class="hljs-attribute">direction</span>="vertical" style={{ <span class="hljs-attribute">width</span>: <span class="hljs-string">"100%"</span> }} size={<span class="hljs-number">12</span>}&gt;
                &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">"flex"</span>, justifyContent: <span class="hljs-string">"space-between"</span> }}&gt;
                  &lt;Text style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#888"</span> }}&gt;处理速度&lt;/Text&gt;
                  &lt;Text <span class="hljs-selector-tag">strong</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span> }}&gt;<span class="hljs-number">5.2</span> PHz&lt;/Text&gt;
                &lt;/<span class="hljs-selector-tag">div</span>&gt;
                &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">"flex"</span>, justifyContent: <span class="hljs-string">"space-between"</span> }}&gt;
                  &lt;Text style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#888"</span> }}&gt;核心数量&lt;/Text&gt;
                  &lt;Text <span class="hljs-selector-tag">strong</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span> }}&gt;<span class="hljs-number">128</span> 核&lt;/Text&gt;
                &lt;/<span class="hljs-selector-tag">div</span>&gt;
              &lt;/Space&gt;
            &lt;/<span class="hljs-selector-tag">div</span>&gt;
            {<span class="hljs-comment">/* 能量条 */</span>}
            &lt;<span class="hljs-selector-tag">div</span> style={{ marginBottom: <span class="hljs-number">20</span> }}&gt;
              &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">"flex"</span>, justifyContent: <span class="hljs-string">"space-between"</span>, marginBottom: <span class="hljs-number">8</span> }}&gt;
                &lt;Text style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#888"</span>, fontSize: <span class="hljs-number">12</span> }}&gt;POWER LEVEL&lt;/Text&gt;
                &lt;Text <span class="hljs-selector-tag">strong</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span>, fontSize: <span class="hljs-number">12</span> }}&gt;<span class="hljs-number">9999</span>&lt;/Text&gt;
              &lt;/<span class="hljs-selector-tag">div</span>&gt;
              &lt;<span class="hljs-selector-tag">div</span> style={{
                <span class="hljs-attribute">height</span>: <span class="hljs-number">6</span>,
                background: <span class="hljs-string">"rgba(0, 0, 0, 0.3)"</span>,
                borderRadius: <span class="hljs-number">3</span>,
                overflow: <span class="hljs-string">"hidden"</span>,
                border: <span class="hljs-string">"1px solid rgba(255, 255, 255, 0.1)"</span>,
              }}&gt;
                &lt;<span class="hljs-selector-tag">div</span> style={{
                  <span class="hljs-attribute">height</span>: <span class="hljs-string">"100%"</span>,
                  width: <span class="hljs-string">"92%"</span>,
                  background: <span class="hljs-string">"linear-gradient(90deg, #a855f7, transparent)"</span>,
                  boxShadow: <span class="hljs-string">"0 0 10px #a855f7"</span>,
                }} /&gt;
              &lt;/<span class="hljs-selector-tag">div</span>&gt;
            &lt;/<span class="hljs-selector-tag">div</span>&gt;
            {<span class="hljs-comment">/* 操作按钮 */</span>}
            &lt;Space style={{ <span class="hljs-attribute">width</span>: <span class="hljs-string">"100%"</span> }}&gt;
              &lt;<span class="hljs-selector-tag">Button</span>
                type="primary"
                className={styles<span class="hljs-selector-class">.neonButton</span>}
                style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span>, flex: <span class="hljs-number">1</span> }}
                <span class="hljs-attribute">icon</span>={&lt;StarOutlined /&gt;}
              &gt;
                激活
              &lt;/<span class="hljs-selector-tag">Button</span>&gt;
              &lt;<span class="hljs-selector-tag">Button</span>
                className={styles<span class="hljs-selector-class">.neonButton</span>}
                style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span> }}
                <span class="hljs-attribute">icon</span>={&lt;TrophyOutlined /&gt;}
              &gt;
                详情
              &lt;/<span class="hljs-selector-tag">Button</span>&gt;
            &lt;/Space&gt;
          &lt;/<span class="hljs-selector-tag">div</span>&gt;
        &lt;/Card&gt;
      &lt;/Col&gt;
    &lt;/Row&gt;
  );
};
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c89d3335a1574228be801bd6b0842835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=zuL14rJQGxWZLQnOtm2M2%2FWnits%3D" alt="6.gif" loading="lazy"/></p>
<h3 data-id="heading-20">核心技术要点</h3>
<p><strong>1. 霓虹发光边框</strong></p>
<p>通过多层 box-shadow 实现外发光和内阴影的叠加效果：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">box-shadow</span>: 
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.5</span>),        <span class="hljs-comment">/* 外发光 */</span>
  inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.1</span>);  <span class="hljs-comment">/* 内阴影 */</span>
</code></pre>
<p><strong>2. 动态霓虹灯条</strong></p>
<p>使用伪元素和渐变动画创建流动的霓虹灯效果：</p>
<pre><code class="hljs language-css" lang="css">&amp;<span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">90deg</span>, transparent, <span class="hljs-number">#a855f7</span>, transparent);
  <span class="hljs-attribute">animation</span>: neonFlow <span class="hljs-number">3s</span> ease-in-out infinite;
}
</code></pre>
<p><strong>3. 霓虹文字效果</strong></p>
<p>通过 text-shadow 的多层叠加模拟霓虹灯文字：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">text-shadow</span>: 
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> currentColor,
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> currentColor,
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">30px</span> currentColor;
</code></pre>
<p><strong>4. 毛玻璃数据面板</strong></p>
<p>结合半透明背景和 backdrop-filter 实现毛玻璃效果：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
backdrop-<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">10px</span>);
</code></pre>
<p><strong>5. 交互动画</strong></p>
<p>hover 时同步触发多个动画效果：</p>
<ul>
<li>卡片上浮：transform: translateY(-5px)</li>
<li>发光增强：box-shadow 强度提升</li>
<li>边框颜色变化：border-color 过渡</li>
<li/>
</ul>
<h3 data-id="heading-21">样式定制优势</h3>
<p>使用 Ant Design 6.0 + antd-style 实现赛博朋克风格的优势：</p>
<p><strong>1. CSS-in-JS 强大能力：</strong> 支持嵌套、伪元素、动画等高级特性，无需额外 CSS 文件</p>
<p><strong>2. 类型安全：</strong> TypeScript 提供完整的类型提示，减少样式错误</p>
<p><strong>3. 动态主题：</strong> 可以轻松切换不同颜色的霓虹主题（紫色、青色、粉色等）</p>
<p><strong>4. 组件封装：</strong> 样式与组件逻辑共存，便于复用和维护</p>
<p><strong>5. 性能优化：</strong> <code>antd-style</code> 自动处理样式注入和缓存，性能优秀</p>
<p>这种设计风格通过强烈的视觉冲击力和独特的科技感，能够有效吸引用户注意力，提升品牌记忆度，特别适合面向年轻用户群体的产品。</p>
<h2 data-id="heading-22">八、升级建议与实践策略</h2>
<p>对于考虑升级到 Ant Design 6.0 的团队，建议采取以下策略：</p>
<p><strong>1.渐进式升级路径</strong></p>
<ol>
<li>
<p>新项目直接使用：全新项目建议直接使用 6.0 版本，享受所有新特性</p>
</li>
<li>
<p>现有项目评估：评估项目依赖和定制程度，制定分阶段升级计划</p>
</li>
<li>
<p>组件逐步替换：可以先替换使用新功能的组件，再逐步迁移其他部分</p>
</li>
</ol>
<p><strong>2.兼容性注意事项</strong></p>
<ol>
<li>
<p>检查废弃 API：Ant Design 6.0 移除了之前版本已标记为废弃的 API</p>
</li>
<li>
<p>样式覆盖检查：如果项目中有深度定制样式，需要检查与新版本的兼容性</p>
</li>
<li>
<p>测试核心流程：升级后重点测试表单提交、数据展示等核心用户流程</p>
</li>
</ol>
<h2 data-id="heading-23">九、总结</h2>
<p>Ant Design 6.0 的组件功能更新聚焦于解决实际开发中的痛点，通过引入 Masonry 瀑布流布局、Tooltip 平滑移动、InputNumber 拨轮模式、Drawer 拖拽调整、Modal 背景模糊以及 Card 深度定制等特性，显著提升了开发效率和用户体验。</p>
<p>这些更新体现了现代前端设计的几个核心趋势：</p>
<p><strong>1. 交互流畅性：</strong> 如 Tooltip 的平滑过渡，减少界面跳跃感</p>
<p><strong>2. 设备适配性：</strong> 如 InputNumber 的触摸友好设计</p>
<p><strong>3. 布局灵活性：</strong> 如 Masonry 的动态布局和 Drawer 的可调整尺寸</p>
<p><strong>4. 视觉现代化：</strong> 如 Modal 的背景模糊效果，营造朦胧美学的高级质感</p>
<p><strong>5. 样式可控性：</strong> 通过 <code>classNames</code> 和 <code>styles</code> API 实现精准的组件定制</p>
<p><strong>6. 风格多样性：</strong> 结合 <code>antd-style</code> 可实现从企业风到赛博朋克等多样化视觉风格</p>
<p>特别是与 antd-style 的深度集成，让开发者能够充分发挥 CSS-in-JS 的强大能力，从简洁的企业级设计到炫酷的赛博朋克风格，都能轻松实现。这些改进让 Ant Design 6.0 不仅保持了企业级应用的稳定性和专业性，还增加了更多现代化、人性化的交互细节和视觉创意空间，是构建下一代 Web 应用的理想选择。</p>
<h3 data-id="heading-24">往期回顾</h3>
<p>1.Java 设计模式：原理、框架应用与实战全解析｜得物技术</p>
<p>2.Go语言在高并发高可用系统中的实践与解决方案｜得物技术 </p>
<p>3.从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术</p>
<p>4.数据库AI方向探索-MCP原理解析&amp;DB方向实战｜得物技术</p>
<p>5.项目性能优化实践：深入FMP算法原理探索｜得物技术</p>
<h3 data-id="heading-25">文 /三七</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Webpack5：从打包到热更新原理]]></title>    <link>https://juejin.cn/post/7586569284551229480</link>    <guid>https://juejin.cn/post/7586569284551229480</guid>    <pubDate>2025-12-23T01:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586569284551229480" data-draft-id="7586559672129372212" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Webpack5：从打包到热更新原理"/> <meta itemprop="keywords" content="前端,Webpack"/> <meta itemprop="datePublished" content="2025-12-23T01:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="政采云技术"/> <meta itemprop="url" content="https://juejin.cn/user/3456520257288974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Webpack5：从打包到热更新原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520257288974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    政采云技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:59:42.000Z" title="Tue Dec 23 2025 01:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b637793da67b4e068460a99d94b333ed~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=4722&amp;h=696&amp;s=276733&amp;e=png&amp;b=fafcff" alt="文章顶部.png" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e02b965140a4a3499441e0f1d7b84f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061539&amp;x-signature=%2BqzyIGpqtHloGHAU8RuEULwRvSo%3D" alt="作者卡片" loading="lazy"/></p>
<h2 data-id="heading-0">深入理解 Webpack5：从打包到热更新原理</h2>
<h3 data-id="heading-1">为什么需要构建工具？</h3>
<h5 data-id="heading-2">一、解决 “高级语法与浏览器兼容性” 的矛盾</h5>
<p>前端技术迭代快（如 ES6+ 的 <code>async/await</code>、箭头函数，CSS 的 <code>grid</code> 布局），但旧浏览器（如 IE11、Safari 10）不支持这些新特性。构建工具通过**转译（Transpile）<strong>和</strong>前缀添加（Prefixing）**解决兼容问题：</p>
<p><strong>1. JavaScript 转译</strong></p>
<p>发者会使用 ES6+ 及以上语法（如类 <code>class</code>）、TypeScript（类型增强的 JS）、JSX（React 组件语法）等提高开发效率，但这些语法在低版本浏览器或部分现代浏览器中无法直接运行。构建工具（配合 Babel、tsc 等）会将这些高级语法转译为浏览器可识别的 ES5 语法。例如：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 开发时写的 ES6 语法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sum</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-comment">// 构建工具转译后（兼容旧浏览器）</span>
<span class="hljs-keyword">var</span> sum = <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; };
</code></pre>
<p><strong>2. CSS 属性添加浏览器前缀</strong></p>
<p>开发者常用 Sass/Less/Stylus 等预处理器（支持变量、嵌套、混入等功能）编写 CSS，或使用 CSS Modules 解决样式冲突，但浏览器只认识原生 CSS。构建工具（配合 <code>sass-loader</code>、<code>postcss</code> 等）会将预处理器语法编译为原生 CSS，同时通过 <code>autoprefixer</code>自动添加浏览器前缀（如 <code>-webkit-</code>、<code>-moz-</code>），适配不同浏览器的 CSS 特性支持。例如：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 开发时写的 Sass</span>
<span class="hljs-attr">$color</span>: red;
.<span class="hljs-property">box</span> {
  <span class="hljs-attr">color</span>: $color;
  &amp;:hover { <span class="hljs-attr">color</span>: blue; }
}
<span class="hljs-comment">// 构建后生成的 CSS（带前缀）</span>
.<span class="hljs-property">box</span> { <span class="hljs-attr">color</span>: red; }
.<span class="hljs-property">box</span>:hover { <span class="hljs-attr">color</span>: blue; }
<span class="hljs-meta">@supports</span> (-webkit-<span class="hljs-attr">appearance</span>: none) { .<span class="hljs-property">box</span> { <span class="hljs-comment">/* 适配webkit内核 */</span> } }
</code></pre>
<h5 data-id="heading-3">二、处理 “模块化开发与浏览器加载限制” 的矛盾</h5>
<p>前端项目早已从 “单文件” 发展为 “多模块组合”，但浏览器对模块化的原生支持有限，需要构建工具进行<strong>依赖管理与打包</strong>：</p>
<p><strong>1. 模块化语法统一与解析</strong>前端模块化规范众多（ES Modules <code>import/export</code>、CommonJS <code>require/module.exports</code>、AMD 等），不同库可能使用不同规范，浏览器原生无法统一处理。构建工具会解析所有模块的依赖关系，并将不同规范的模块转换为统一格式（通常是 ES Modules 或打包后的单文件），确保代码能正确运行。</p>
<p><strong>2. 依赖合并与路径处理</strong>一个复杂项目可能依赖数百个模块（如业务组件、工具函数、第三方库），若直接让浏览器加载这些模块，会导致：</p>
<ul>
<li>
<p>大量网络请求（浏览器对同一域名的并发请求数有限，通常 6-8 个），严重拖慢加载速度；</p>
</li>
<li>
<p>模块路径混乱（如相对路径、别名路径 <code>@/components</code> 等，浏览器无法直接识别）。</p>
</li>
</ul>
<p>构建工具会将多个关联模块合并为少数几个 “chunk”（打包产物），并自动处理路径解析（如将 <code>@/components</code> 映射到实际目录），减少请求数并解决路径问题。</p>
<h5 data-id="heading-4">三、优化 “开发效率与生产性能” 的矛盾</h5>
<p>开发时，我们追求的是<strong>高效的调试</strong>和<strong>快速的代码变更反馈</strong>（开发体验）。而生产环境追求的是<strong>极致的加载性能</strong>和<strong>用户体验</strong>。构建工具通过区分<strong>开发模式（development）</strong> 和<strong>生产模式（production）</strong>，用一套配置完美解决两种截然不同的需求。</p>
<p><strong>1. 开发模式（Development） - 追求速度与可调试性</strong></p>
<ul>
<li>
<p><strong>Source Map</strong>：将打包压缩后的代码映射回原始源代码。当你在浏览器调试时，看到的仍然是清晰可读的原始文件结构，而不是一团混乱的打包后代码，使得调试变得非常简单。</p>
</li>
<li>
<p><strong>热更新（HMR）</strong>：只替换修改了的模块，保持应用当前状态（如表单输入、滚动位置），无需整页刷新，实现秒级更新。</p>
</li>
<li>
<p><strong>更快的构建速度</strong>：会跳过代码压缩、Tree Shaking 等耗时的优化步骤，保证开发时重新打包的速度。</p>
</li>
</ul>
<p><strong>2. 生产模式（Production） - 追求体积与性能</strong></p>
<ul>
<li>
<p><strong>代码压缩（Minification）</strong>：使用 Terser 压缩 JavaScript，cssnano 压缩 CSS，移除所有注释、空格、缩短变量名，能显著减小文件体积（通常减少 60%-70%）。</p>
</li>
<li>
<p><strong>代码分割（Code Splitting）</strong>：将代码拆分成多个按需加载的块（chunk）。结合动态导入（<code>import()</code>），可以实现<strong>懒加载</strong>，让用户只加载当前页面或路由所需的代码，极大加速首屏加载时间。</p>
</li>
<li>
<p><strong>Tree Shaking</strong>：像摇树一样，通过静态分析抖落未被使用的代码（dead code），并将其从最终打包文件中移除。例如，你只引用了 Lodash 中的 <code>debounce</code> 函数，打包后就只会包含 <code>debounce</code> 及其依赖，而不是整个 Lodash 库。</p>
</li>
<li>
<p><strong>资源优化与压缩</strong>：自动压缩图片、将小图片转为 Base64 内联、为现代浏览器提供更高效的图片格式（如 WebP/AVIF）。</p>
</li>
</ul>
<h3 data-id="heading-5">有哪些构建工具？</h3>







































































































<table><thead><tr><th><strong>构建工具</strong></th><th><strong>开发语言</strong></th><th><strong>Github Star</strong></th><th><strong>发布时间</strong></th><th><strong>作者</strong></th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vite.dev%2F" target="_blank" title="https://cn.vite.dev/" ref="nofollow noopener noreferrer">Vite</a></td><td>TypeScript</td><td>75k</td><td>2020年4月</td><td>ViteJS</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwebpack.js.org%2F" target="_blank" title="https://webpack.js.org/" ref="nofollow noopener noreferrer">Webpack</a></td><td>JavaScript</td><td>65.5k</td><td>2012年3月</td><td>Facebook</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fparceljs.org%2F" target="_blank" title="https://parceljs.org/" ref="nofollow noopener noreferrer">Parcel</a></td><td>JavaScript</td><td>43.9k</td><td>2017年12月</td><td>Filament Group</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fesbuild.github.io%2F" target="_blank" title="https://esbuild.github.io/" ref="nofollow noopener noreferrer">esbuild</a></td><td>Go</td><td>39.3k</td><td>2020年</td><td>Evan Wallace</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgulpjs.com%2F" target="_blank" title="https://gulpjs.com/" ref="nofollow noopener noreferrer">Gulp</a></td><td>JavaScript</td><td>33.1k</td><td>2013年</td><td>Eric Schoffstall</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fswc.rs%2F" target="_blank" title="https://swc.rs/" ref="nofollow noopener noreferrer">swc</a></td><td>Rust</td><td>32.7k</td><td>2017年</td><td>Vercel</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fturborepo.com%2F" target="_blank" title="https://turborepo.com/" ref="nofollow noopener noreferrer">Turbopack</a></td><td>Rust</td><td>28.5k</td><td>2022年10月</td><td>Vercel</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fnx.dev%2F" target="_blank" title="https://nx.dev/" ref="nofollow noopener noreferrer">Nx</a></td><td>TypeScript</td><td>26.8k</td><td>-</td><td>Nrwl</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frollupjs.org%2F" target="_blank" title="https://rollupjs.org/" ref="nofollow noopener noreferrer">Rollup</a></td><td>JavaScript</td><td>26k</td><td>2015年</td><td>Rich Harris</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.snowpack.dev%2F" target="_blank" title="https://www.snowpack.dev/" ref="nofollow noopener noreferrer">Snowpack</a></td><td>JavaScript</td><td>19.4k</td><td>2020年5月</td><td>Pika</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frolldown.rs%2F" target="_blank" title="https://rolldown.rs/" ref="nofollow noopener noreferrer">Rolldown</a></td><td>Rust</td><td>11.9k</td><td>2024年</td><td>VueJS</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2Fzh%2F" target="_blank" title="https://rspack.rs/zh/" ref="nofollow noopener noreferrer">Rspack</a></td><td>Rust</td><td>11.9k</td><td>2023年3月</td><td>Bytedance</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwmr.dev%2F" target="_blank" title="https://wmr.dev/" ref="nofollow noopener noreferrer">WMR</a></td><td>JavaScript</td><td>4.9k</td><td>-</td><td>Preact</td></tr></tbody></table>
<h3 data-id="heading-6">Webpack 工作原理</h3>
<p>在众多前端构建工具中，Webpack 由于其高度的灵活性和强大的生态系统，依然是最广泛使用的打包工具之一。与 Vite、Parcel 等工具相比，Webpack 提供了更为细致的定制能力，能够满足复杂项目的需求，如代码分割、资源优化和热更新等功能。掌握 Webpack 不仅有助于提升开发效率，更能优化应用性能，因此本文将深入介绍 Webpack 的工作原理。</p>
<h5 data-id="heading-7">一、打包过程</h5>
<p>Webpack 的打包流程可以分为以下关键步骤：</p>
<h6 data-id="heading-8"><strong>读取配置文件，加载构建参数</strong></h6>
<p>Webpack CLI 启动后，会首先加载开发者提供的配置文件<code>webpack.config.js</code>，包括：</p>
<ul>
<li>
<p>mode、entry、output 等基本配置</p>
</li>
<li>
<p>module.rules 中的 loader 配置</p>
</li>
<li>
<p>plugins 列表</p>
</li>
<li>
<p>optimization 配置</p>
</li>
</ul>
<p>Webpack 采用 <strong>webpack-cli</strong> 来解析命令行参数，并最终调用：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">"webpack"</span>);
<span class="hljs-title function_">webpack</span>(options)
</code></pre>
<p>此时 Webpack 会完成配置合并（Webpack 内部使用 webpack-merge 的策略），将默认配置与用户配置拼接成最终 options 对象。</p>
<p>这一步的作用是确定 Webpack 后续构建过程所依赖的全部元信息。</p>
<h6 data-id="heading-9"><strong>创建 Compiler 对象，初始化编译总体调度器</strong></h6>
<p>Webpack 的主控制器是 <code>Compiler</code> 类，Compiler 是 Webpack 从开始到结束贯穿始终的对象，它控制着构建生命周期的每一个阶段，并将生命周期开放给插件系统（基于 Tapable）。</p>
<p>Compiler 的职责包括：</p>
<ul>
<li>
<p>管理整个构建生命周期</p>
</li>
<li>
<p>负责调用插件、触发钩子</p>
</li>
<li>
<p>统一调度 Compilation、模块工厂、Chunk 构建等核心内容</p>
</li>
</ul>
<p>简化后的核心结构如下：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Compiler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Tapable</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span> = {
      <span class="hljs-attr">initialize</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncHook</span>(),
      <span class="hljs-attr">run</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncSeriesHook</span>([<span class="hljs-string">"compiler"</span>]),
      <span class="hljs-attr">compile</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncHook</span>([<span class="hljs-string">"params"</span>]),
      <span class="hljs-attr">make</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncParallelHook</span>([<span class="hljs-string">"compilation"</span>]),
      <span class="hljs-attr">emit</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncSeriesHook</span>([<span class="hljs-string">"compilation"</span>]),
      <span class="hljs-attr">done</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncHook</span>([<span class="hljs-string">"stats"</span>]),
      <span class="hljs-comment">// ...</span>
    };
  }

  <span class="hljs-title function_">run</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">run</span>.<span class="hljs-title function_">callAsync</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compile</span>(onCompiled);
    });
  }

  <span class="hljs-title function_">compile</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-keyword">const</span> compilation = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">newCompilation</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">make</span>.<span class="hljs-title function_">callAsync</span>(compilation, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      compilation.<span class="hljs-title function_">finish</span>(<span class="hljs-function">() =&gt;</span> {
        compilation.<span class="hljs-title function_">seal</span>(callback);
      });
    });
  }
}
</code></pre>
<p><code>compiler.run()</code> 是 Webpack <strong>单次构建流程</strong>的启动函数。它做三件事：</p>
<ul>
<li>
<p>调度构建生命周期钩子，如 <code>beforeRun</code> / <code>run</code></p>
</li>
<li>
<p>调用 <code>compiler.compile()</code> 执行真正的编译逻辑</p>
</li>
<li>
<p>调用 <code>emit</code> / <code>afterEmit</code> / <code>done</code> 等钩子产出结果</p>
</li>
</ul>
<p>Compiler 控制整体流程，而 Compilation 则控制：</p>
<ul>
<li>
<p>模块构建（构建每一个 JS/CSS/图片等模块）</p>
</li>
<li>
<p>模块依赖分析</p>
</li>
<li>
<p>Chunk 构建</p>
</li>
<li>
<p>代码优化（Tree Shaking、SplitChunks）</p>
</li>
<li>
<p>生成最终资源（assets）</p>
</li>
</ul>
<p>Compilation 是构建的“工作单位”，负责所有实际的打包工作。</p>
<h6 data-id="heading-10"><strong>从入口文件开始，递归查找和编译模块</strong></h6>
<p>EntryPlugin 会根据 entry 配置向 Compilation 注册入口模块。Webpack 随后会从入口开始递归解析依赖，构建整个依赖图。当遇到非 JS 模块时，通过 Loader 进行处理（如将 TS/LESS/图片等转为可用模块）。</p>
<p>Webpack 在构建模块时，会根据 module.rules 匹配对应的 loader，从右向左依次对模块内容进行转换。</p>
<p>Loader 的作用包括但不限于：</p>
<ul>
<li>
<p>Babel：将 ES6+ 转译为 ES5</p>
</li>
<li>
<p>css-loader：处理 CSS 文件内容</p>
</li>
<li>
<p>url-loader / file-loader：处理图片资源</p>
</li>
<li>
<p>vue-loader / ts-loader：处理 SFC 或 TS</p>
</li>
</ul>
<p>最终，所有文件都会被转换成 JavaScript 字符串供后续 AST 解析。</p>
<h6 data-id="heading-11"><strong>解析每个模块的依赖关系，构建模块图 ModuleGraph</strong></h6>
<p>webpack 把 loader 产出的 JS 代码解析成 AST，识别出所有依赖节点（<code>import</code> / <code>require</code> / <code>import()</code> / loader 插入的依赖等），并把这些依赖投影到 <strong>ModuleGraph</strong> 上，形成可供后续优化和分块的有向依赖图。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// NormalModule.build() 内部流程（精简）</span>
<span class="hljs-title function_">runLoaders</span>(resource, loaders, <span class="hljs-function">(<span class="hljs-params">err, result</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> source = result.<span class="hljs-property">result</span>[<span class="hljs-number">0</span>];             <span class="hljs-comment">// loader 输出 -&gt; JS 字符串 / Source</span>
  <span class="hljs-keyword">const</span> parser = compilation.<span class="hljs-title function_">getParser</span>(<span class="hljs-string">"javascript"</span>);
  <span class="hljs-keyword">const</span> ast = parser.<span class="hljs-title function_">parse</span>(source);            <span class="hljs-comment">// acorn -&gt; AST</span>
  <span class="hljs-keyword">const</span> dependencies = parser.<span class="hljs-title function_">collectDependencies</span>(ast); <span class="hljs-comment">// 解析产生 Dependency 实例</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dep <span class="hljs-keyword">of</span> dependencies) {
    <span class="hljs-keyword">const</span> resolved = resolver.<span class="hljs-title function_">resolve</span>(dep.<span class="hljs-property">request</span>);
    <span class="hljs-keyword">const</span> depModule = normalModuleFactory.<span class="hljs-title function_">create</span>(resolved);
    moduleGraph.<span class="hljs-title function_">connect</span>(<span class="hljs-variable language_">module</span>, dep, depModule); <span class="hljs-comment">// 建图：模块 -&gt; 依赖 -&gt; 目标模块</span>
  }
});
</code></pre>
<ul>
<li>
<p>解析器（JavascriptParser）是通过 Tapable hook 逐节点触发、生成  实例（以便插件/loader 能介入解析过程）。</p>
</li>
<li>
<p>NormalModuleFactory / Resolver 负责把语法层面的请求（request）解析到具体路径并创建 Module 实例，Compilation 将这些新模块加入构建队列直至递归完成。</p>
</li>
</ul>
<h6 data-id="heading-12"><strong>优化模块</strong></h6>
<p>在模块级别上减少最终运行时代码体积并提升运行时性能的策略，包括剔除未使用代码（Tree Shaking）、合并模块以缩短调用链与减少函数包装开销（Scope Hoisting / Module Concatenation）、以及其他小粒度优化（常量折叠、dead code elimination 交给 Terser 等压缩器完成）。</p>
<h6 data-id="heading-13"><strong>根据模块图生成 Chunk，对生成的代码块进行进一步优化</strong></h6>
<p>Webpack 将完成构建的模块根据入口点和不同类型的依赖关系构建多个 Chunk，Chunk 是 Webpack 打包产物的基础单位，每个 Chunk 对应一个最终输出文件（或多个文件组合），同时承载 runtime、依赖关系、模块顺序和异步加载信息。ChunkGraph 会在这一阶段被创建并建立，它记录：</p>
<ul>
<li>
<p>当前 Chunk 包含哪些模块</p>
</li>
<li>
<p>模块属于哪些 Chunk</p>
</li>
<li>
<p>Chunk 与 Chunk 之间的关系</p>
</li>
</ul>
<p>生成的 Chunk 进行最终优化，包括渲染 Chunk 内部代码、处理异步加载和动态 import、应用代码分割策略提取公共模块、注入 runtime 逻辑、生成按需加载和预加载提示，以及通过 [contenthash] 和独立 runtime Chunk 实现长期缓存，从而使输出文件体积最小化、加载高效并支持浏览器缓存优化。</p>
<h6 data-id="heading-14"><strong>生成最终资源并写入输出目录</strong></h6>
<p>Webpack 构建完成后会将所有 Chunk 转换为可执行文件（assets），例如：</p>
<ul>
<li>
<p>main.js</p>
</li>
<li>
<p>vendors.js</p>
</li>
<li>
<p>style.css</p>
</li>
<li>
<p>图片 / 字体等静态资源</p>
</li>
</ul>
<p>输出阶段触发 Compiler 的 <code>emit</code> 钩子，随后写入文件系统。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">emitAssets</span>(<span class="hljs-params">compilation, callback</span>) {
  <span class="hljs-keyword">const</span> { entries, modules, chunks, assets } = compilation;
  <span class="hljs-keyword">const</span> output = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">output</span>;
    
  <span class="hljs-comment">// 调用 Plugin emit 钩子</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">call</span>();
  
  <span class="hljs-comment">// 若 output.path 不存在，进行创建</span>
  <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(output.<span class="hljs-property">path</span>)) {
    fs.<span class="hljs-title function_">mkdirSync</span>(output.<span class="hljs-property">path</span>);
  }
    
  <span class="hljs-comment">// 将 assets 中的内容写入文件系统中</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(assets).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">fileName</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(output.<span class="hljs-property">path</span>, fileName);
    fs.<span class="hljs-title function_">writeFileSync</span>(filePath, assets[fileName]);
  });
  
  <span class="hljs-comment">// 结束之后触发钩子</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">call</span>();
  
  <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, {
    <span class="hljs-attr">toJSON</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        entries,
        modules,
        chunks,
        assets,
      };
    },
  });
}
</code></pre>
<h5 data-id="heading-15">二、热更新过程</h5>
<p>热模块替换（HMR，Hot Module Replacement）是指当我们对代码修改并保存后，Webpack 将会对代码进行重新打包，并将新的模块发送到浏览器端，浏览器用新的模块替换掉旧的模块 ，以实现在不刷新浏览器的前提下更新页面。</p>
<p><strong>整体流程：</strong></p>
<ul>
<li>
<p>首先是 Webpack 监听到文件修改后，进行编译，打包出新的文件，得到新的 hash。</p>
</li>
<li>
<p>其次是 webpack-dev-server 通过 websocket 通知浏览器，告诉浏览器新的 hash。</p>
</li>
<li>
<p>浏览器收到通知后，请求新的文件，拿到新的文件后，更新页面。</p>
</li>
</ul>
<h6 data-id="heading-16">文件监听</h6>
<p>Webpack 的文件监听机制用于在开发模式下自动检测文件变化并触发增量编译。其核心由三个组件构成：</p>
<ul>
<li>
<p><strong>Watching</strong>（调度层）</p>
</li>
<li>
<p><strong>Watchpack</strong>（抽象管理层）</p>
</li>
<li>
<p><strong>DirectoryWatcher</strong>（底层监听实现层）</p>
</li>
</ul>
<p>整体基于 <strong>发布–订阅模型（EventEmitter）</strong> 实现，整个过程是典型的 **事件驱动的监听 → 通知 → 重新编译。**Webpack 通过以下流程实现监听：</p>
<ol>
<li>
<p><code>compiler.watch()</code> 创建 Watching 实例，负责整个监听调度。</p>
</li>
<li>
<p>Watching 初始化 Watchpack，并让其负责监听所有文件和目录。</p>
</li>
<li>
<p>Watchpack 内部使用 DirectoryWatcher 监听目录变动，同时监听单文件变化。</p>
</li>
<li>
<p>文件变动发生时，DirectoryWatcher 发出 <code>change</code> 事件。</p>
</li>
<li>
<p>Watchpack 将事件上报给 Watching。</p>
</li>
<li>
<p>Watching 调用 Webpack 的增量编译流程，生成新的构建文件。</p>
</li>
</ol>
<p><strong>Watching</strong></p>
<p>Watching 是 Webpack 启动 watch 时最上层的控制者，通过：</p>
<ul>
<li>
<p>创建并启动 Watchpack；</p>
</li>
<li>
<p>订阅 Watchpack 的 <code>change</code>、<code>remove</code> 事件；</p>
</li>
<li>
<p>触发增量编译；</p>
</li>
<li>
<p>将新的 hash 传给 dev-server，使浏览器执行 HMR 刷新。</p>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Watching</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    }
    <span class="hljs-title function_">watch</span>(<span class="hljs-params">files</span>){
        <span class="hljs-keyword">let</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watchpack</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-title function_">callback</span> =  (<span class="hljs-params">changes, removals</span>)=&gt;{
             <span class="hljs-comment">// 执行各种hooks</span>
        }
        watcher.<span class="hljs-title function_">once</span>(<span class="hljs-string">"aggregated"</span>,callback);
        watcher.<span class="hljs-title function_">watch</span>(files, directories, <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>);
        <span class="hljs-keyword">return</span> watcher;
    }
}
</code></pre>
<p><strong>Watchpack</strong> </p>
<p>Watchpack 是 Webpack 文件监听功能的核心抽象层，负责：</p>
<ul>
<li>
<p>统一管理所有被监听的文件和目录；</p>
</li>
<li>
<p>为每个目录创建 <strong>DirectoryWatcher</strong>；</p>
</li>
<li>
<p>决定具体监听方式（fs.watch、fs.watchFile、轮询）；</p>
</li>
<li>
<p>将底层监听事件汇总后统一向外发射：</p>
<ul>
<li>
<p><code>change</code>（文件变化）</p>
</li>
<li>
<p><code>remove</code>（文件被删除）</p>
</li>
</ul>
</li>
</ul>
<p>所以它不直接监听，而是管理多个监听者。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Watchpack</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">EventEmitter</span>{
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileWatchers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">directoryWatchers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    }
    <span class="hljs-title function_">watch</span>(<span class="hljs-params">files, directories, startTime</span>){
        <span class="hljs-comment">// 为每个文件添加一个或多个 DirectoryWatcher</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> file <span class="hljs-keyword">of</span> files){
            <span class="hljs-keyword">let</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectoryWatcher</span>();
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileWatchers</span>.<span class="hljs-title function_">set</span>(file, watcher);
            watcher.<span class="hljs-title function_">on</span>(<span class="hljs-string">"change"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">_onTimeout</span>);
            watcher.<span class="hljs-title function_">watch</span>(file, startTime);
        }
        <span class="hljs-comment">// for of directories</span>
        <span class="hljs-comment">// bala bala</span>
        
        <span class="hljs-comment">// 源码这里的方法调用，没太明白是个啥意思？</span>
        <span class="hljs-comment">// 后面还有一个watchEventSource.watch()</span>
        watchEventSource.<span class="hljs-title function_">batch</span>()
    }
    <span class="hljs-title function_">_onTimeout</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> changes = <span class="hljs-variable language_">this</span>.<span class="hljs-property">aggregatedChanges</span>;
        <span class="hljs-keyword">const</span> removals = <span class="hljs-variable language_">this</span>.<span class="hljs-property">aggregatedRemovals</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"aggregated"</span>, changes, removals);
    }
}
</code></pre>
<p><strong>DirectoryWatcher</strong></p>
<p>DirectoryWatcher 是最底层、最核心的监听器，负责检测：</p>
<ul>
<li>
<p>文件内容修改（mtime 改变）</p>
</li>
<li>
<p>新文件创建</p>
</li>
<li>
<p>文件删除（readdir 不存在）</p>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectoryWatcher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">EventEmitter</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">watchers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">files</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
       
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">watcher</span> = watchEventSource.<span class="hljs-title function_">watch</span>(file);
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">watcher</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"change"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onWatchEvent</span>);
    }
    <span class="hljs-title function_">watch</span>(<span class="hljs-params">file, startTime</span>){
        <span class="hljs-keyword">let</span> watchers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
        <span class="hljs-keyword">let</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(startTime);
        watchers.<span class="hljs-title function_">add</span>(watcher);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">watchers</span>.<span class="hljs-title function_">set</span>(file, watchers);     
    }
    <span class="hljs-title function_">onWatchEvent</span>(<span class="hljs-params">eventType, filename</span>){
        fs.<span class="hljs-title function_">lstat</span>(filePath, <span class="hljs-function">(<span class="hljs-params">err, stats</span>)=&gt;</span>{
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setFileTime</span>(filePath, stats.<span class="hljs-property">mtime</span>);
            <span class="hljs-comment">// this.setDirectory(filePath, eventType);</span>
        })
    }
    <span class="hljs-title function_">setFileTime</span>(<span class="hljs-params">filePath, mtime</span>){
        <span class="hljs-comment">// 记录文件信息</span>
        <span class="hljs-keyword">let</span> safeTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">files</span>.<span class="hljs-title function_">set</span>(filePath, {
            safeTime,
            <span class="hljs-attr">timestamp</span>: mtime
        })
        <span class="hljs-keyword">let</span> watchers = <span class="hljs-variable language_">this</span>.<span class="hljs-property">watchers</span>.<span class="hljs-title function_">get</span>(filePath)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> w <span class="hljs-keyword">of</span> watchers) {
           <span class="hljs-keyword">if</span> (w.<span class="hljs-title function_">checkStartTime</span>(safeTime)) {
                <span class="hljs-comment">// 文件更新后触发的事件源</span>
                w.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"change"</span>, mtime);
            }
        }
       
    }
}
</code></pre>
<ul>
<li>
<p>优先使用操作系统事件（fs.watch）</p>
</li>
<li>
<p>系统不支持时退回轮询（Polling）</p>
<ul>
<li>通过周期性的 <code>fs.stat</code> + mtime 对比检测变化。    </li>
</ul>
</li>
</ul>
<h6 data-id="heading-17">模块编译处理</h6>
<p>当文件监听到变化后，Webpack 会触发一次增量编译，除了与打包类似的编译外，webpack 还会往 Compiler 注入 HotModuleReplacementPlugin 插件，插件内部做了三方面处理：</p>
<ul>
<li>
<p>**语法转译：**模块代码允许使用 <code>module.hot.xxx</code> 进行个性化处理，需要将这些语法处理为符合运行时能力的代码；</p>
</li>
<li>
<p>**HMR Runtime Module：**HMR模式下会将 HMR Runtime 模块进行注入操作。</p>
</li>
<li>
<p>**产物生成：**HMR 模式下每次变更都会产生  manifest 和 update chunks 文件，编译器需要额外处理这些产生生成逻辑。</p>
</li>
</ul>
<p><strong>语法转译</strong></p>
<p>在开发模式下，模块里可能会用到 HMR API，例如：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>) {
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">'./foo.js'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo.js 更新了'</span>);
    });
}
</code></pre>
<p>HotModuleReplacementPlugin 提供了语法转义能力：</p>
<ul>
<li>
<p>对模块代码进行解析，找到 <code>module.hot.xxx</code> 相关调用；</p>
<ul>
<li>主要替换语法有 module.hot、module.hot.accept、module.hot.decline 语法</li>
</ul>
</li>
<li>
<p>将这些调用转换成运行时可以识别的代码（符合 HMR Runtime 约定）；</p>
</li>
<li>
<p>注入必要的回调钩子，保证模块在被替换时能够正确触发 accept、dispose 回调。</p>
</li>
</ul>
<p>让开发者书写的 HMR API 能够在浏览器端的 HMR Runtime 中生效，实现模块级别的热替换。</p>
<p><strong>HMR Runtime Module 注入</strong></p>
<p>HMR 在运行时需要相应基础能力才能够运行，在 HotModuleReplacementPlugin 内部会往编译器注入 HotModuleReplacementRuntimeModule 保证应用能够正常提供运行时能力。</p>
<p>该 Runtime Module 实现了：</p>
<ul>
<li>
<p>WebSocket 通信（接收 hash / ok 消息）；</p>
</li>
<li>
<p>补丁文件的加载（hot-update.js / hot-update.json）；</p>
</li>
<li>
<p>模块替换逻辑（dispose → apply → accept）；</p>
</li>
<li>
<p>状态管理（已替换的模块、更新队列等）。</p>
</li>
</ul>
<p>作用：保证浏览器端可以正确识别 HMR 消息，拉取补丁并执行模块替换，而不刷新整个页面。</p>
<p><strong>manifest 及 Chunk 生成</strong></p>
<p>Compiler 每次编译之后都会得到每个模块、Chunk 的哈希值，Compiler 通过判断本次编译的产物的哈希和上次编译记录的Hash得出模块变更信息，HotModuleReplacementPlugin 根据模块变更信息生成两份数据：</p>
<ol>
<li>更新描述<code>manifest.json</code>：以JSON形式数据</li>
</ol>
<ul>
<li>
<p><code>updateChunkIds</code>：更新的 Chunk Id</p>
</li>
<li>
<p><code>removedChunkIds</code>：移除的 Chunk Id</p>
</li>
<li>
<p><code>removedModuleIds</code>：移除的 Module Id</p>
</li>
</ul>
<ol start="2">
<li>模块 Chunk 产物<code>[key].[newHash].hot-update.js</code>：只包含更新模块代码</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// [key].[newHash].hot-update.js</span>
self[<span class="hljs-string">"webpackHotUpdate_myApp"</span>](<span class="hljs-string">"main"</span>, {
  <span class="hljs-number">0</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, __webpack_exports__, __webpack_require__</span>) {
    <span class="hljs-comment">// 新模块代码</span>
  },
  <span class="hljs-number">2</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, __webpack_exports__, __webpack_require__</span>) {
    <span class="hljs-comment">// 新模块代码</span>
  }});

</code></pre>
<p>当 Webpack 完成增量编译后，会将新的构建产物与新的 hash 生 成在内存中，此时 Webpack-dev-server 会通过 WebSocket 将更新消息推送给浏览器。</p>
<p>Webpack-dev-server 的核心功能是作为 <strong>浏览器与编译器之间的中间层</strong>，让前端项目在开发阶段拥有实时更新能力。</p>
<p>在传统的 LiveReload 模式下，文件变更后浏览器会被强制刷新整个页面；而 HMR 在此基础上更进一步，只更新变化的模块而不刷新整页。这两种机制最终都依赖 Webpack-dev-server  提供的能力。</p>
<p>从整体设计来看，Webpack-dev-server 可以拆分为两个主要模块：</p>
<ul>
<li>
<p>应用通信模块（推送更新消息）</p>
</li>
<li>
<p>静态资源服务模块（返回构建产物）</p>
<ul>
<li>使用 express 框架提供静态资源服务器功能</li>
</ul>
</li>
</ul>
<h6 data-id="heading-18">更新通知</h6>
<p>服务器与浏览器之间通过 WebSocket 建立长连接，并会使用长轮询作为兜底方法。</p>
<ol>
<li>
<p>监听 Webpack 编译完成后，主动触发 <code>sendStats</code> 方法</p>
</li>
<li>
<p>本地服务端的 WebSocket 主动发送 hash 命令和 ok 命令到本地浏览器 client 端</p>
</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> {
 <span class="hljs-title function_">setupHooks</span>(<span class="hljs-params"/>) {
     <span class="hljs-comment">// 初始化时注册done的监听事件，编译完成后，调用sendStats方法进行webSocket的命令发送</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">compiler</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(
         <span class="hljs-string">"webpack-dev-server"</span>,
         <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> {
             <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">webSocketServer</span>) {
                 <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendStats</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webSocketServer</span>.<span class="hljs-property">clients</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getStats</span>(stats));
             }
             <span class="hljs-variable language_">this</span>.<span class="hljs-property">stats</span> = stats;
         }
     );
 }

 <span class="hljs-title function_">sendStats</span>(<span class="hljs-params">clients, stats, force</span>) {
     <span class="hljs-comment">// 更新当前的hash</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentHash</span> = stats.<span class="hljs-property">hash</span>;
   
     <span class="hljs-comment">// 发送给客户端当前的hash值</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendMessage</span>(clients, <span class="hljs-string">"hash"</span>, stats.<span class="hljs-property">hash</span>);

     <span class="hljs-comment">// 发送给客户端ok的指令</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendMessage</span>(clients, <span class="hljs-string">"ok"</span>);
 }
}
</code></pre>
<h6 data-id="heading-19">模块替换</h6>
<p>当浏览器端收到 ok 消息后，Webpack 的 HMR Runtime 便会开始执行模块热替换流程。浏览器端调用 <code>emitter</code>将最新 hash 值发送给 HMR runtime。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> hotEmitter <span class="hljs-keyword">from</span> <span class="hljs-string">"webpack/hot/emitter.js"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reloadApp</span>(<span class="hljs-params">_ref, status</span>) {
  <span class="hljs-keyword">var</span> hot = _ref.<span class="hljs-property">hot</span>, liveReload = _ref.<span class="hljs-property">liveReload</span>;
  ...
  <span class="hljs-keyword">var</span> currentHash = status.<span class="hljs-property">currentHash</span>, previousHash = status.<span class="hljs-property">previousHash</span>;
  ...
  <span class="hljs-keyword">var</span> allowToHot = search.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">"webpack-dev-server-hot=false"</span>) === -<span class="hljs-number">1</span>;
  <span class="hljs-keyword">if</span> (hot &amp;&amp; allowToHot) {
    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"App hot update..."</span>);
    hotEmitter.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"webpackHotUpdate"</span>, status.<span class="hljs-property">currentHash</span>);
    ...
  }
  ...
}
</code></pre>
<p>HMR runtime 会更新 lastHash，并在必要时调用 <code>check()</code>，发起更新检查</p>
<pre><code class="hljs language-tsx" lang="tsx">hotEmitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">"webpackHotUpdate"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">currentHash</span>) {
  lastHash = currentHash;
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">upToDate</span>() &amp;&amp; <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">status</span>() === <span class="hljs-string">"idle"</span>) {
    <span class="hljs-title function_">log</span>(<span class="hljs-string">"info"</span>, <span class="hljs-string">"[HMR] Checking for updates on the server..."</span>);
    <span class="hljs-title function_">check</span>();
  }
});
<span class="hljs-keyword">var</span> check = <span class="hljs-keyword">function</span> <span class="hljs-title function_">check</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>
    .<span class="hljs-title function_">check</span>(<span class="hljs-literal">true</span>)
    .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">updatedModules</span>) {
      ...
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) {
      ...
    });
};
</code></pre>
<p><code>module.hot.check</code>最终会触发<code>hotCheck()</code>方法</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hotCheck</span>(<span class="hljs-params">applyOnUpdate</span>) {
  ...
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">"check"</span>)
  .<span class="hljs-title function_">then</span>(__webpack_require__.<span class="hljs-property">hmrM</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">update</span>) {
      ...
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">"prepare"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
              <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(__webpack_require__.<span class="hljs-property">hmrC</span>).<span class="hljs-title function_">reduce</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">
              			promises,
              			key
              		</span>) {
                        <span class="hljs-comment">// key = jsonp</span>
              			__webpack_require__.<span class="hljs-property">hmrC</span>[key](
              					update.<span class="hljs-property">c</span>,
              					update.<span class="hljs-property">r</span>,
              					update.<span class="hljs-property">m</span>,
              					promises,
              					currentUpdateApplyHandlers,
              					updatedModules
              				);
              			<span class="hljs-keyword">return</span> promises;
              		},
              	[])
          ).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
              <span class="hljs-keyword">return</span> <span class="hljs-title function_">waitForBlockingPromises</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
                  ...
                  <span class="hljs-keyword">return</span> <span class="hljs-title function_">internalApply</span>(applyOnUpdate);
              });
          });
      });
  });
}
__webpack_require__.<span class="hljs-property">hmrC</span>.<span class="hljs-property">jsonp</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">
  chunkIds,
  removedChunks,
  removedModules,
  promises,
  applyHandlers,
  updatedModulesList,
</span>) {
    applyHandlers.<span class="hljs-title function_">push</span>(applyHandler);
    ...
    chunkIds.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">chunkId</span>) {
        <span class="hljs-keyword">if</span> (
        __webpack_require__.<span class="hljs-title function_">o</span>(installedChunks, chunkId) &amp;&amp;
        installedChunks[chunkId] !== <span class="hljs-literal">undefined</span>
        ) {
            promises.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">loadUpdateChunk</span>(chunkId, updatedModulesList));
        }
    });
};
</code></pre>
<p>__webpack_require__.hmrM 中 fetch 到新的 manifest.json 文件，完成后，触发 __webpack_require__.hmrC.jsonp 方法执行</p>
<p>执行 __webpack_require__.hmrC.jsonp，传入 manifest.json 文件中返回的key，通过 jsonp 方式请求得到 [key].[newHash].hot-update.js，执行对应的 moudle 代码的缓存并且触发对应 promise 的<code>resolve</code>请求，从而顺利回调<code>internalApply()</code>方法</p>
<p><code>internalApply()</code>方法是 <strong>HMR 的“内部调度器”</strong>，连接了 <strong>检查更新</strong> 和 <strong>实际替换模块</strong> 两个阶段。根据更新的模块和依赖信息，决定哪些模块可以热替换、哪些模块需要 dispose，并最终调用 <code>apply()</code> 来应用新模块</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">internalApply</span>(<span class="hljs-params">options</span>) {
 <span class="hljs-comment">// 这里的currentUpdateApplyHandlers存储的是上面jsonp请求js文件所创建的callback</span>
 <span class="hljs-keyword">var</span> results = currentUpdateApplyHandlers.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">handler</span>) {
     <span class="hljs-keyword">return</span> <span class="hljs-title function_">handler</span>(options);
 });
 currentUpdateApplyHandlers = <span class="hljs-literal">undefined</span>;

 results.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) {
   <span class="hljs-keyword">if</span> (result.<span class="hljs-property">dispose</span>) result.<span class="hljs-title function_">dispose</span>();
 });

 <span class="hljs-keyword">var</span> outdatedModules = [];
 results.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) {
     <span class="hljs-keyword">if</span> (result.<span class="hljs-property">apply</span>) {
         <span class="hljs-comment">// 这里的result的是上面jsonp请求js文件所创建的callback所返回Object的apply方法</span>
         <span class="hljs-keyword">var</span> modules = result.<span class="hljs-title function_">apply</span>(reportError);
         <span class="hljs-keyword">if</span> (modules) {
             <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; modules.<span class="hljs-property">length</span>; i++) {
                 outdatedModules.<span class="hljs-title function_">push</span>(modules[i]);
             }
         }
     }
 });

 <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([disposePromise, applyPromise]).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {

     <span class="hljs-keyword">return</span> <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">"idle"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
         <span class="hljs-keyword">return</span> outdatedModules;
     });
 });
}
</code></pre>
<p><strong>替换的总体执行逻辑：</strong></p>
<ol>
<li>
<p>根据webpack配置拼接出当前 moduleId 的热更新策略，比如允许热更新，比如不允许热更新等等</p>
</li>
<li>
<p>根据热更新策略，拼接多个数据结构，为<code>applay()</code>方法代码服务</p>
</li>
<li>
<p>从<code>internalApply()</code>可以知道，最终会先执行<code>result.dispose()</code>，然后再执行<code>result.apply()</code>方法</p>
</li>
</ol>
<p><strong>拼接数据结构</strong></p>
<ol>
<li>
<p>根据<code>getAffectedModuleEffects(moduleId)</code>整理出该<code>moduleId</code>的热更新策略，是否需要热更新</p>
</li>
<li>
<p>根据多个对象拼凑出<code>dispose</code>和<code>apply</code>方法所需要的数据结构</p>
</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">applyHandler</span>(<span class="hljs-params">options</span>) {
   currentUpdateChunks = <span class="hljs-literal">undefined</span>;

   <span class="hljs-comment">// at begin all updates modules are outdated</span>
   <span class="hljs-comment">// the "outdated" status can propagate to parents if they don't accept the children</span>
   <span class="hljs-keyword">var</span> outdatedDependencies = {}; <span class="hljs-comment">// 使用module.hot.accept部署了依赖发生更新后的回调函数</span>
   <span class="hljs-keyword">var</span> outdatedModules = []; <span class="hljs-comment">// 当前过期需要更新的modules</span>
   <span class="hljs-keyword">var</span> appliedUpdate = {}; <span class="hljs-comment">// 准备更新的modules</span>


   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> moduleId <span class="hljs-keyword">in</span> currentUpdate) {
       <span class="hljs-keyword">var</span> newModuleFactory = currentUpdate[moduleId];

       <span class="hljs-comment">// 获取之前的配置：该moduleId是否允许热更新</span>
       <span class="hljs-keyword">var</span> result = <span class="hljs-title function_">getAffectedModuleEffects</span>(moduleId);

       <span class="hljs-keyword">var</span> doApply = <span class="hljs-literal">false</span>;
       <span class="hljs-keyword">var</span> doDispose = <span class="hljs-literal">false</span>;

       <span class="hljs-keyword">switch</span> (result.<span class="hljs-property">type</span>) {
           <span class="hljs-comment">// ...</span>
           <span class="hljs-keyword">case</span> <span class="hljs-string">"accepted"</span>:
               <span class="hljs-keyword">if</span> (options.<span class="hljs-property">onAccepted</span>) options.<span class="hljs-title function_">onAccepted</span>(result);
               doApply = <span class="hljs-literal">true</span>;
               <span class="hljs-keyword">break</span>;
           <span class="hljs-comment">//...</span>
       }
       <span class="hljs-keyword">if</span> (doApply) {
           appliedUpdate[moduleId] = newModuleFactory;
           <span class="hljs-comment">//...代码省略... 拼凑出outdatedDependencies过期的依赖，为下面的module.hot.accept(moduleId, function() {})做准备</span>
       }
       <span class="hljs-keyword">if</span> (doDispose) {
           <span class="hljs-comment">//...代码省略... 处理配置为dispose的情况</span>
       }

   }
   currentUpdate = <span class="hljs-literal">undefined</span>;

   <span class="hljs-comment">// 根据outdatedModules拼凑出需要_selfAccepted=true，即热更新是重新加载一次自己的module的数据到outdatedSelfAcceptedModules中</span>
   <span class="hljs-keyword">var</span> outdatedSelfAcceptedModules = [];
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; outdatedModules.<span class="hljs-property">length</span>; j++) {
       <span class="hljs-keyword">var</span> outdatedModuleId = outdatedModules[j];
       <span class="hljs-comment">// __webpack_require__.c = __webpack_module_cache__</span>
       <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = __webpack_require__.<span class="hljs-property">c</span>[outdatedModuleId];
       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span> &amp;&amp; (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfAccepted</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_main</span>) &amp;&amp;
           appliedUpdate[outdatedModuleId] !== warnUnexpectedRequire &amp;&amp;
           !<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfInvalidated</span>
       ) {
           <span class="hljs-comment">// _requireSelf: function () {</span>
           <span class="hljs-comment">//      currentParents = me.parents.slice();</span>
           <span class="hljs-comment">//      currentChildModule = _main ? undefined : moduleId;</span>
           <span class="hljs-comment">//         __webpack_require__(moduleId);</span>
           <span class="hljs-comment">// },</span>
           outdatedSelfAcceptedModules.<span class="hljs-title function_">push</span>({
               <span class="hljs-attr">module</span>: outdatedModuleId,
               <span class="hljs-attr">require</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_requireSelf</span>, <span class="hljs-comment">// 重新加载自己</span>
               <span class="hljs-attr">errorHandler</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfAccepted</span>
           });
       }
   }

   <span class="hljs-keyword">var</span> moduleOutdatedDependencies;

   <span class="hljs-keyword">return</span> {
       <span class="hljs-attr">dispose</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {...}
       <span class="hljs-attr">apply</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">reportError</span>) {...}
   };
}
</code></pre>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getAffectedModuleEffects</span>(<span class="hljs-params">updateModuleId</span>) {
   <span class="hljs-keyword">var</span> outdatedModules = [updateModuleId];
   <span class="hljs-keyword">var</span> outdatedDependencies = {};

   <span class="hljs-keyword">var</span> queue = outdatedModules.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">id</span>) {
       <span class="hljs-keyword">return</span> {
           <span class="hljs-attr">chain</span>: [id],
           <span class="hljs-attr">id</span>: id
       };
   });
   <span class="hljs-keyword">while</span> (queue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
       <span class="hljs-keyword">var</span> queueItem = queue.<span class="hljs-title function_">pop</span>();
       <span class="hljs-keyword">var</span> moduleId = queueItem.<span class="hljs-property">id</span>;
       <span class="hljs-keyword">var</span> chain = queueItem.<span class="hljs-property">chain</span>;
       <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = __webpack_require__.<span class="hljs-property">c</span>[moduleId];
       <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfAccepted</span> &amp;&amp; !<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfInvalidated</span>)) { <span class="hljs-keyword">continue</span>; }

       <span class="hljs-comment">// ************ 处理不热更新的情况 ************</span>
       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfDeclined</span>) {
           <span class="hljs-keyword">return</span> {
               <span class="hljs-attr">type</span>: <span class="hljs-string">"self-declined"</span>,
               <span class="hljs-attr">chain</span>: chain,
               <span class="hljs-attr">moduleId</span>: moduleId
           };
       }
       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_main</span>) {
           <span class="hljs-keyword">return</span> {
               <span class="hljs-attr">type</span>: <span class="hljs-string">"unaccepted"</span>,
               <span class="hljs-attr">chain</span>: chain,
               <span class="hljs-attr">moduleId</span>: moduleId
           };
       }
       <span class="hljs-comment">// ************ 处理不热更新的情况 ************</span>

       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">module</span>.<span class="hljs-property">parents</span>.<span class="hljs-property">length</span>; i++) {
           <span class="hljs-comment">// module.parents=依赖这个模块的modules</span>
           <span class="hljs-comment">// 遍历所有依赖这个模块的 modules</span>
           <span class="hljs-keyword">var</span> parentId = <span class="hljs-variable language_">module</span>.<span class="hljs-property">parents</span>[i];
           <span class="hljs-keyword">var</span> parent = __webpack_require__.<span class="hljs-property">c</span>[parentId];
           <span class="hljs-keyword">if</span> (!parent) <span class="hljs-keyword">continue</span>;
           <span class="hljs-keyword">if</span> (parent.<span class="hljs-property">hot</span>.<span class="hljs-property">_declinedDependencies</span>[moduleId]) {
               <span class="hljs-comment">// 如果依赖这个模块的parentModule设置了不理会当前moduleId热更新的策略，则不处理该parentModule</span>
               <span class="hljs-keyword">return</span> {
                   <span class="hljs-attr">type</span>: <span class="hljs-string">"declined"</span>,
                   <span class="hljs-attr">chain</span>: chain.<span class="hljs-title function_">concat</span>([parentId]),
                   <span class="hljs-attr">moduleId</span>: moduleId,
                   <span class="hljs-attr">parentId</span>: parentId
               };
           }
           <span class="hljs-comment">// 如果已经包含在准备更新的队列中，则不重复添加</span>
           <span class="hljs-keyword">if</span> (outdatedModules.<span class="hljs-title function_">indexOf</span>(parentId) !== -<span class="hljs-number">1</span>) <span class="hljs-keyword">continue</span>;
           <span class="hljs-keyword">if</span> (parent.<span class="hljs-property">hot</span>.<span class="hljs-property">_acceptedDependencies</span>[moduleId]) {
               <span class="hljs-keyword">if</span> (!outdatedDependencies[parentId])
                   outdatedDependencies[parentId] = [];
               <span class="hljs-comment">// TODO 这个parentModule设置了监听其依赖module的热更新</span>
               <span class="hljs-title function_">addAllToSet</span>(outdatedDependencies[parentId], [moduleId]);
               <span class="hljs-keyword">continue</span>;
           }
           <span class="hljs-keyword">delete</span> outdatedDependencies[parentId];
           outdatedModules.<span class="hljs-title function_">push</span>(parentId); <span class="hljs-comment">// 添加该parentModuleId到队列中，准备更新</span>

           <span class="hljs-comment">// 加入该parentModuleId到队列中，进行下一轮循环，把parentModule的相关parent也加入到更新中</span>
           queue.<span class="hljs-title function_">push</span>({
               <span class="hljs-attr">chain</span>: chain.<span class="hljs-title function_">concat</span>([parentId]),
               <span class="hljs-attr">id</span>: parentId
           });
       }
   }

   <span class="hljs-keyword">return</span> {
       <span class="hljs-attr">type</span>: <span class="hljs-string">"accepted"</span>,
       <span class="hljs-attr">moduleId</span>: updateModuleId,
       <span class="hljs-attr">outdatedModules</span>: outdatedModules,
       <span class="hljs-attr">outdatedDependencies</span>: outdatedDependencies
   };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">addAllToSet</span>(<span class="hljs-params">a, b</span>) {
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; b.<span class="hljs-property">length</span>; i++) {
       <span class="hljs-keyword">var</span> item = b[i];
       <span class="hljs-keyword">if</span> (a.<span class="hljs-title function_">indexOf</span>(item) === -<span class="hljs-number">1</span>) a.<span class="hljs-title function_">push</span>(item);
   }
}
</code></pre>
<p><strong>dispose 方法</strong></p>
<p><code>dispose</code> 方法是 <strong>HMR 模块替换流程中的“销毁旧模块”阶段</strong>，主要负责：</p>
<ul>
<li>
<p>清理缓存，将旧模块从模块系统中移除</p>
</li>
<li>
<p>移除之前注册的回调函数</p>
</li>
<li>
<p>移除目前 module 与其它 module 的绑定关系（ parent 和 children），避免旧模块残留影响新模块</p>
</li>
<li>
<p>为后续热更新的模块替换（apply 阶段）做准备</p>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-attr">dispose</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
   currentUpdateRemovedChunks.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">chunkId</span>) {
       <span class="hljs-keyword">delete</span> installedChunks[chunkId];
   });
   currentUpdateRemovedChunks = <span class="hljs-literal">undefined</span>;

   <span class="hljs-keyword">var</span> idx;
   <span class="hljs-keyword">var</span> queue = outdatedModules.<span class="hljs-title function_">slice</span>();
   <span class="hljs-keyword">while</span> (queue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
       <span class="hljs-keyword">var</span> moduleId = queue.<span class="hljs-title function_">pop</span>();
       <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = __webpack_require__.<span class="hljs-property">c</span>[moduleId];
       <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) <span class="hljs-keyword">continue</span>;

       <span class="hljs-keyword">var</span> data = {};

       <span class="hljs-comment">// Call dispose handlers: 回调注册的disposeHandlers</span>
       <span class="hljs-keyword">var</span> disposeHandlers = <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_disposeHandlers</span>;
       <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; disposeHandlers.<span class="hljs-property">length</span>; j++) {
           disposeHandlers[j].<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>, data);
       }
       <span class="hljs-comment">// __webpack_require__.hmrD = currentModuleData置为空</span>
       __webpack_require__.<span class="hljs-property">hmrD</span>[moduleId] = data;

       <span class="hljs-comment">// disable module (this disables requires from this module)</span>
       <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;

       <span class="hljs-comment">// remove module from cache: 删除module的缓存数据</span>
       <span class="hljs-keyword">delete</span> __webpack_require__.<span class="hljs-property">c</span>[moduleId];

       <span class="hljs-comment">// when disposing there is no need to call dispose handler: 删除其它模块对该moduleId的accept回调</span>
       <span class="hljs-keyword">delete</span> outdatedDependencies[moduleId];

       <span class="hljs-comment">// remove "parents" references from all children: </span>
       <span class="hljs-comment">// 解除moduleId引用的其它模块跟moduleId的绑定关系，跟下面的解除关系是互相补充的</span>
       <span class="hljs-comment">// 一个是children，一个是parent</span>
       <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-variable language_">module</span>.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>; j++) {
           <span class="hljs-keyword">var</span> child = __webpack_require__.<span class="hljs-property">c</span>[<span class="hljs-variable language_">module</span>.<span class="hljs-property">children</span>[j]];
           <span class="hljs-keyword">if</span> (!child) <span class="hljs-keyword">continue</span>;
           idx = child.<span class="hljs-property">parents</span>.<span class="hljs-title function_">indexOf</span>(moduleId);
           <span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>) {
               child.<span class="hljs-property">parents</span>.<span class="hljs-title function_">splice</span>(idx, <span class="hljs-number">1</span>);
           }
       }
   }

   <span class="hljs-comment">// remove outdated dependency from module children: </span>
   <span class="hljs-comment">// 解除引用该moduleId的模块跟moduleId的绑定关系，可以理解为moduleId.parent删除children，跟上面的解除关系是互相补充的</span>
   <span class="hljs-comment">// 一个是children，一个是parent</span>
   <span class="hljs-keyword">var</span> dependency;
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> outdatedModuleId <span class="hljs-keyword">in</span> outdatedDependencies) {
       <span class="hljs-variable language_">module</span> = __webpack_require__.<span class="hljs-property">c</span>[outdatedModuleId];
       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>) {
           moduleOutdatedDependencies =
               outdatedDependencies[outdatedModuleId];
           <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; moduleOutdatedDependencies.<span class="hljs-property">length</span>; j++) {
               dependency = moduleOutdatedDependencies[j];
               idx = <span class="hljs-variable language_">module</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">indexOf</span>(dependency);
               <span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>) <span class="hljs-variable language_">module</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">splice</span>(idx, <span class="hljs-number">1</span>);
           }
       }

   }
}
</code></pre>
<p><strong>apply方法</strong></p>
<p><code>apply()</code>方法是**HMR 模块替换流程中的“加载新模块”阶段****，**主要执行的逻辑是：</p>
<ul>
<li>
<p>更新全局的 window.__webpack_require__  对象，存储了所有路径+内容的对象</p>
</li>
<li>
<p>执行 runtime 代码，比如 <code>_webpack_require__.h = ()=&gt; {"xxxxxhash值"}</code></p>
</li>
<li>
<p>触发之前 hot.accept 部署了依赖变化时的回调 callBack</p>
</li>
<li>
<p>重新加载标识 _selfAccepted 的 module，这种模块会重新 require 一次</p>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-attr">apply</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">reportError</span>) {
   <span class="hljs-comment">// insert new code</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> updateModuleId <span class="hljs-keyword">in</span> appliedUpdate) {
       <span class="hljs-comment">// __webpack_require__.m = __webpack_modules__</span>
       <span class="hljs-comment">// 更新全局的window.__webpack_require__对象，存储了所有路径+内容的对象</span>
       __webpack_require__.<span class="hljs-property">m</span>[updateModuleId] = appliedUpdate[updateModuleId];
   }

   <span class="hljs-comment">// run new runtime modules</span>
   <span class="hljs-comment">// 执行runtime代码，比如_webpack_require__.h = ()=&gt; {"xxxxxhash值"}</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; currentUpdateRuntime.<span class="hljs-property">length</span>; i++) {
       currentUpdateRuntime[i](__webpack_require__);
   }

   <span class="hljs-comment">// call accept handlers：触发之前hot.accept部署了依赖变化时的回调callBack</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> outdatedModuleId <span class="hljs-keyword">in</span> outdatedDependencies) {
       <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = __webpack_require__.<span class="hljs-property">c</span>[outdatedModuleId];
       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>) {
           moduleOutdatedDependencies =
               outdatedDependencies[outdatedModuleId];
           <span class="hljs-keyword">var</span> callbacks = [];
           <span class="hljs-keyword">var</span> errorHandlers = [];
           <span class="hljs-keyword">var</span> dependenciesForCallbacks = [];
           <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; moduleOutdatedDependencies.<span class="hljs-property">length</span>; j++) {
               <span class="hljs-keyword">var</span> dependency = moduleOutdatedDependencies[j];
               <span class="hljs-keyword">var</span> acceptCallback = <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_acceptedDependencies</span>[dependency];
               <span class="hljs-keyword">var</span> errorHandler = <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_acceptedErrorHandlers</span>[dependency];
               <span class="hljs-keyword">if</span> (acceptCallback) {
                   <span class="hljs-keyword">if</span> (callbacks.<span class="hljs-title function_">indexOf</span>(acceptCallback) !== -<span class="hljs-number">1</span>) <span class="hljs-keyword">continue</span>;
                   callbacks.<span class="hljs-title function_">push</span>(acceptCallback);
                   errorHandlers.<span class="hljs-title function_">push</span>(errorHandler);
                   dependenciesForCallbacks.<span class="hljs-title function_">push</span>(dependency);
               }
           }
           <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; callbacks.<span class="hljs-property">length</span>; k++) {
               callbacks[k].<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>, moduleOutdatedDependencies);
           }
       }
   }

   <span class="hljs-comment">// Load self accepted modules：重新加载标识_selfAccepted的module，这种模块会重新require一次</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> o = <span class="hljs-number">0</span>; o &lt; outdatedSelfAcceptedModules.<span class="hljs-property">length</span>; o++) {
       <span class="hljs-keyword">var</span> item = outdatedSelfAcceptedModules[o];
       <span class="hljs-keyword">var</span> moduleId = item.<span class="hljs-property">module</span>;

       item.<span class="hljs-built_in">require</span>(moduleId);
   }

   <span class="hljs-keyword">return</span> outdatedModules;
  }
</code></pre>
<h3 data-id="heading-20">总结</h3>
<p>前端构建工具让模块管理、资源打包和优化变得高效，提升了开发体验和应用性能。Webpack 的工作原理尤其值得学习：从模块解析、依赖图构建，到 Chunk 生成和热更新，它展示了现代前端构建的完整机制。理解这些原理不仅能帮助我们更好地使用工具，也能为优化前端项目打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 设计模式 - ReAct 模式]]></title>    <link>https://juejin.cn/post/7586555198115151878</link>    <guid>https://juejin.cn/post/7586555198115151878</guid>    <pubDate>2025-12-23T00:07:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586555198115151878" data-draft-id="7586498198149627955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 设计模式 - ReAct 模式"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T00:07:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子洋"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359835015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 设计模式 - ReAct 模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359835015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子洋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:07:24.000Z" title="Tue Dec 23 2025 00:07:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="tomorrow">.hljs-comment,.hljs-quote{color:#8e908c}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c82829}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5871f}.hljs-attribute{color:#eab700}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#718c00}.hljs-section,.hljs-title{color:#4271ae}.hljs-keyword,.hljs-selector-tag{color:#8959a8}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#4d4d4c}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一篇我们介绍了 AI 应用的发展历程以及 Agent 的整体概念，这一篇将针对 <strong>ReAct（Reasoning + Acting）模式</strong>，并对其设计思想和工程实现进行一次更为系统、偏实战向的讲解。</p>
<p>在讲解 ReAct 之前，有必要先澄清一个经常被混用的问题：<strong>Agent 到底是什么？</strong></p>
<p>在早期以及当下大量工程实践中，不同 AI 应用对 Agent 的定义并不一致。很多所谓的 Agent，本质上更接近一个<strong>预先定义好的 AI workflow</strong>：流程、工具、策略都由应用侧提前固化，用户只是触发执行。例如，一个 WebSearch 场景往往就对应一个「搜索 Agent」，或者通过特定提示词（如 <code>/agent</code>）来唤醒一组固定的搜索工具。</p>
<p>从工程视角看，这类 Agent 更多是<strong>能力封装与产品抽象</strong>，而不是研究语境中强调的「具备自主决策与反馈能力的智能体」。也正因为如此，随着概念被频繁复用，<code>agent</code> 这个词在实际讨论中逐渐变得模糊，单独听到它已很难准确判断其具体能力边界。</p>
<p>如果暂时抛开命名争议，从实现层面抽象来看，一个 Agent 的核心逻辑其实非常简单：<strong>一个受控的循环（loop）</strong>。在这个循环中，模型不断获取上下文、进行推理、执行动作，并根据结果继续调整行为，直到满足终止条件为止。</p>
<p>在工程实现中，这个过程往往可以被近似理解为：</p>
<ul>
<li>多轮调用 LLM</li>
<li>中间可能伴随工具调用</li>
<li>有明确的退出条件（如任务完成、步数上限、token 预算）</li>
</ul>
<p>基于这样的背景，各类 Agent 设计模式（也可以称为范式或框架）逐步出现，而其中最经典、也最具代表性的，便是 <strong>ReAct 模式</strong>。该模式最早发表于 2022 年，其结构至今仍足以支撑大量中低复杂度的 Agent 场景。</p>
<h2 data-id="heading-1">ReAct 模式</h2>
<h3 data-id="heading-2">核心思想</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2d1ed965f844c919ea69313b89065c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=qL5MuILhjAp6RcO4YY9jaQ2NlTM%3D" alt="" loading="lazy"/></p>
<p>ReAct 的提出，本质上是为了解决一个早期 LLM 应用中的割裂问题：<strong>推理与行动往往是分离的</strong>。</p>
<p>在 ReAct 出现之前，常见的两类模式分别是：</p>
<ul>
<li><strong>Reason-only</strong>：模型进行显式推理（如 CoT、Scratchpad），但不与外部环境交互</li>
<li><strong>Act-heavy / Tool-driven</strong>：模型频繁调用工具获取信息，但推理过程并不显式呈现或不与行动交错</li>
</ul>
<p>需要说明的是，这里的分类来自 ReAct 论文中的抽象对比，而并非对具体系统内部实现的严格学术归类。例如：</p>
<ul>
<li>SayCan 内部同样包含推理与可行性评估，并非“无 reasoning”</li>
<li>WebGPT 也存在内部推理过程，只是推理与行动并未以交错形式呈现给模型</li>
</ul>
<p>在这种背景下，<strong>ReAct（Reasoning + Acting）</strong> 的核心思想可以概括为一句话：</p>
<blockquote>
<p><strong>在行动中思考，在思考中决定行动。</strong></p>
</blockquote>
<p>它尝试将<strong>思考</strong>和<strong>行动</strong>统一到一个连续的闭环中，模拟人类解决问题时的自然过程：</p>
<ol>
<li><strong>Thought</strong>：分析当前状态与目标</li>
<li><strong>Action</strong>：基于判断调用工具或执行操作</li>
<li><strong>Observation</strong>：观察行动结果</li>
<li><strong>Thought</strong>：根据新信息再次推理</li>
<li>重复上述过程，直到问题解决</li>
</ol>
<p>从形式上看，ReAct 并没有引入复杂的新组件，而是通过 <strong>Thought → Action → Observation</strong> 的反复交替，显著提升了模型在多步任务、信息不完备任务中的表现稳定性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b2fcf4b5c1480a843b66419e2e2a8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=sffR0OM%2BhSqLAVWpgOglV802ZW4%3D" alt="" loading="lazy"/></p>
<p>上图是 ReAct 论文中的一个示例，主要对比了 <strong>Standard、Reason Only、Act Only 以及 ReAct</strong> 四种不同范式在同一问题下的表现差异。Standard 方式直接给出答案，既不显式展开推理，也不与外部环境交互；Reason Only 虽然在回答前进行了逐步推理，但推理过程完全依赖模型自身的知识，一旦前提判断错误，结论便无法被外部信息纠正；Act Only 则能够多轮调用搜索等工具获取信息，但由于缺乏明确的推理指导，行动过程较为盲目，最终仍然得出了错误结果。相比之下，ReAct 通过多轮 <strong>Thought → Act → Observation</strong> 的交错执行，使模型能够在行动结果的反馈下不断修正推理路径，最终在后续轮次中得到正确答案。</p>
<h3 data-id="heading-3">核心实现</h3>
<p>从工程角度看，ReAct 的实现并不复杂，其本质就是一个<strong>带有终止条件的循环控制结构</strong>。可以用下面这段高度简化的伪代码来概括：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 简化版实现逻辑</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLoops; i++) {
    <span class="hljs-comment">// 1. 思考：LLM分析当前情况，决定做什么</span>
    <span class="hljs-keyword">const</span> { thought, action, args, final } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmThink</span>();
    
    <span class="hljs-keyword">if</span> (final) {
        <span class="hljs-comment">// 任务完成</span>
        <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-comment">// 2. 行动：调用具体的工具</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">callTool</span>(action, args);
    
    <span class="hljs-comment">// 3. 观察：将结果作为下一次思考的输入</span>
    context.<span class="hljs-title function_">push</span>(<span class="hljs-string">`观察到：<span class="hljs-subst">${result}</span>`</span>);
}
</code></pre>
<p>这段代码已经基本覆盖了 ReAct 的核心机制：</p>
<ul>
<li><strong>循环驱动</strong>：模型在多轮中逐步逼近目标</li>
<li><strong>模型自决策</strong>：由 LLM 决定是否继续、是否调用工具</li>
<li><strong>显式终止条件</strong>：通过 <code>final</code> 或循环上限避免失控</li>
</ul>
<p>在真实系统中，通常还会叠加更多安全与成本控制机制，例如：</p>
<ul>
<li>最大循环次数（maxLoops）</li>
<li>token 或调用预算</li>
<li>工具调用白名单</li>
</ul>
<h3 data-id="heading-4">具体实现</h3>
<p>下面将结合一份实际可运行的代码示例，展示一个简化但完整的 ReAct Agent 实现。</p>
<h4 data-id="heading-5">LLM 调用</h4>
<p>这里使用 <code>@ai-sdk</code> 封装多厂商模型调用，示例中支持 OpenAI 与 Azure OpenAI。该部分属于基础设施层，与 ReAct 本身并无强耦合，因此不再展开其原理。具体的介绍和使用方式可以看我之前写的这篇文章 <a href="https://juejin.cn/user/1099167359835015/posts" target="_blank" title="https://juejin.cn/user/1099167359835015/posts">《AI 开发者必备：Vercel AI SDK 轻松搞定多厂商 AI 调用》</a> 。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { generateText } <span class="hljs-keyword">from</span> <span class="hljs-string">"ai"</span>;
<span class="hljs-keyword">import</span> { createOpenAI } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/openai"</span>;
<span class="hljs-keyword">import</span> { createAzure } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/azure"</span>;

<span class="hljs-comment">/**
 * Build a model client from env/config.
 * Supported providers: 'openai', 'azure'.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getModelClient</span>(<span class="hljs-params">options = {}</span>) {
  <span class="hljs-keyword">const</span> {
    provider = process.<span class="hljs-property">env</span>.<span class="hljs-property">AI_PROVIDER</span> || <span class="hljs-string">"openai"</span>,
    apiKey = process.<span class="hljs-property">env</span>.<span class="hljs-property">AI_PROVIDER_API_KEY</span>,
    baseURL = process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_BASE_URL</span> || process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_OPENAI_BASE_URL</span>,
    resourceName = process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_OPENAI_RESOURCE_NAME</span>, <span class="hljs-comment">// for azure</span>
  } = options;

  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">AI_MOCK</span> === <span class="hljs-string">"1"</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">client</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">model</span>: <span class="hljs-literal">null</span> };
  }

  <span class="hljs-keyword">if</span> (!apiKey) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Missing API key: set AI_PROVIDER_API_KEY"</span>);
  }

  <span class="hljs-keyword">if</span> (provider === <span class="hljs-string">"azure"</span>) {
    <span class="hljs-keyword">const</span> azure = <span class="hljs-title function_">createAzure</span>({ apiKey, resourceName });
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">client</span>: azure, <span class="hljs-attr">model</span>: <span class="hljs-title function_">azure</span>(<span class="hljs-string">"gpt-5"</span>) };
  }

  <span class="hljs-keyword">const</span> openai = <span class="hljs-title function_">createOpenAI</span>({ apiKey, baseURL });
  <span class="hljs-keyword">const</span> modelName = process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_MODEL</span> || <span class="hljs-string">"gpt-4o-mini"</span>;
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">client</span>: openai, <span class="hljs-attr">model</span>: <span class="hljs-title function_">openai</span>(modelName) };
}

<span class="hljs-comment">/**
 * Chat-like step with messages array support.
 * messages: [{ role: 'system'|'user'|'assistant', content: string }]
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">llmChat</span>(<span class="hljs-params">{ messages, schema, options = {} }</span>) {
  <span class="hljs-keyword">const</span> { model } = <span class="hljs-title function_">getModelClient</span>(options);
  <span class="hljs-keyword">const</span> system = messages.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> m.<span class="hljs-property">role</span> === <span class="hljs-string">"system"</span>)?.<span class="hljs-property">content</span>;

  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateText</span>({
    model,
    system,
    messages,
    ...(schema ? { schema } : {}),
  });
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>核心作用只有一个：<strong>以 Chat 形式向模型发送上下文，并获得结构化输出</strong>。</p>
<h4 data-id="heading-6">ReAct 主逻辑</h4>
<p>在下面这段代码中，我们完整实现了一个 ReAct Agent 的核心循环逻辑。首先通过 system prompt 对模型的输出形式和行为进行强约束，明确要求其<strong>仅以 JSON 格式返回结果</strong>，且只能包含 <code>thought</code>、<code>action</code>、<code>args</code>、<code>final</code> 四个字段，并分别约定了调用工具与结束任务时的输出规范。与此同时，在 <code>user</code> 消息中显式告知模型当前可用的 tools 列表，并附带每个工具的功能说明与参数定义，使模型能够在循环过程中基于明确的能力边界自主决策是否进行工具调用。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { llmChat } <span class="hljs-keyword">from</span> <span class="hljs-string">"../llm/provider.js"</span>;
<span class="hljs-keyword">import</span> { callTool, formatToolList } <span class="hljs-keyword">from</span> <span class="hljs-string">"../tools/index.js"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SYSTEM</span> = <span class="hljs-string">`You are a ReAct-style agent.

You must reason and act using the following loop:
Thought → Action → Observation
This loop may repeat multiple times.

Output format rules:
- You MUST respond with a single JSON object
- The JSON object MUST contain only the following keys:
  - thought (string)
  - action (string, optional)
  - args (object, optional)
  - final (string, optional)
- No additional keys are allowed
- Do NOT use Markdown
- Do NOT include any text outside the JSON object

Behavior rules:
- If you need to call a tool, output "thought", "action", and "args"
- If no further action is required, output "thought" and "final"
- When "final" is present, the response is considered complete and no further steps will be taken
- Do NOT include "action" or "args" when returning "final"

Always follow these rules strictly.`</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runReAct</span>(<span class="hljs-params">{ task, maxLoops = <span class="hljs-number">6</span>, options = {} } = {}</span>) {
  <span class="hljs-keyword">const</span> messages = [
    { <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>, <span class="hljs-attr">content</span>: <span class="hljs-variable constant_">SYSTEM</span> },
    {
      <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">`Task: <span class="hljs-subst">${task}</span>\nAvailable tools: <span class="hljs-subst">${formatToolList()}</span>`</span>,
    },
  ];

  <span class="hljs-keyword">const</span> trace = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLoops; i++) {
    <span class="hljs-keyword">const</span> { text } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmChat</span>({ messages, options });
    <span class="hljs-keyword">let</span> parsed;
    <span class="hljs-keyword">try</span> {
      parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(text);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// console.warn("Parse failed. Text:", text);</span>
      <span class="hljs-comment">// console.warn("Error:", String(e));</span>
      messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: text });
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`Format error: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(e)}</span>.
        You previously violated the required JSON format.
        This is a strict requirement.

        If the response is not valid JSON or contains extra text, it will be discarded.
        Retry now.`</span>,
      });
      <span class="hljs-keyword">continue</span>;
    }

    trace.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">step</span>: i + <span class="hljs-number">1</span>, <span class="hljs-attr">model</span>: parsed });

    <span class="hljs-keyword">if</span> (parsed.<span class="hljs-property">final</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Final result:"</span>, parsed.<span class="hljs-property">final</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">final</span>: parsed.<span class="hljs-property">final</span>, trace };
    }

    <span class="hljs-keyword">if</span> (!parsed.<span class="hljs-property">action</span>) {
      messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(parsed) });
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-attr">content</span>:
          <span class="hljs-string">"No action provided. Please continue with a tool call or final."</span>,
      });
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Action:"</span>, parsed.<span class="hljs-property">action</span>);
    <span class="hljs-keyword">const</span> observation = <span class="hljs-keyword">await</span> <span class="hljs-title function_">callTool</span>(parsed.<span class="hljs-property">action</span>, parsed.<span class="hljs-property">args</span> || {});
    trace[trace.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">observation</span> = observation;
    messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(parsed) });
    messages.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">`Observation: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(observation)}</span>. Continue.`</span>,
    });
  }

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">final</span>: <span class="hljs-string">"Max loops reached without final."</span>, trace };
}

</code></pre>
<h4 data-id="heading-7">Tools</h4>
<p>Tools 指的是模型在 ReAct 循环中可以调用的具体外部能力接口。通常，一个工具由<strong>工具名称、功能描述、参数定义以及对应的 handler 实现</strong>组成。下面示例中实现了两个最基础的文件操作工具：<code>readFileTool</code> 用于读取文件内容，<code>writeFileTool</code> 用于写入文件，两者都完整描述了工具名称、用途、参数 Schema 以及实际执行逻辑。<code>createTool</code> 只是一个用于约定工具输出结构的辅助函数，本身并不涉及核心逻辑，主要用于在非 TS 环境下做基础的参数校验。</p>
<p>这里使用 <code>zod</code> 作为参数校验工具，它可以在 JS / TS 环境中统一使用，通过定义 schema 并在运行时执行 <code>parse</code> 校验，有效缓解模型参数幻觉问题；同时可以直接使用 schema 生成标准的 JSON Schema，作为工具参数说明提供给模型，从而减少手写参数描述的成本。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs/promises"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;
<span class="hljs-keyword">import</span> { createTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"./types.js"</span>;

<span class="hljs-keyword">const</span> readFileSchema = z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">file</span>: z.<span class="hljs-title function_">string</span>() });
<span class="hljs-keyword">const</span> writeFileSchema = z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">file</span>: z.<span class="hljs-title function_">string</span>(), <span class="hljs-attr">content</span>: z.<span class="hljs-title function_">string</span>() });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> readFileTool = <span class="hljs-title function_">createTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"read_file"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Read a UTF-8 text file from workspace"</span>,
  <span class="hljs-attr">schema</span>: readFileSchema,
  <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> ({ file }) =&gt; {
    <span class="hljs-keyword">const</span> abs = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), file);
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(abs, <span class="hljs-string">"utf-8"</span>);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">content</span>: data };
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> writeFileTool = <span class="hljs-title function_">createTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"write_file"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Write a UTF-8 text file to workspace (overwrite)"</span>,
  <span class="hljs-attr">schema</span>: writeFileSchema,
  <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> ({ file, content }) =&gt; {
    <span class="hljs-keyword">const</span> abs = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), file);
    <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(path.<span class="hljs-title function_">dirname</span>(abs), { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(abs, content, <span class="hljs-string">"utf-8"</span>);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">`wrote <span class="hljs-subst">${file}</span>`</span> };
  },
});
</code></pre>
<h3 data-id="heading-8">实际效果</h3>
<p>基于上述 ReAct 实现，我尝试让模型在本地环境中完成多个小游戏的生成与迭代，包括：<code>2048</code>、<code>飞机大战</code>、<code>贪吃蛇</code>、<code>五子棋</code>。从结果来看，整体完成度和可玩性都明显优于我<a href="https://link.juejin.cn?target=alexpang.cn%2Fleafer-games%2F" target="_blank" title="alexpang.cn/leafer-games/" ref="nofollow noopener noreferrer">早期纯手写的一些 demo</a>。当然，需要强调的是：<strong>ReAct 并不会凭空提升模型能力，它更多是一种能力放大器。</strong></p>
<p>最终效果在很大程度上仍然依赖于底层模型本身的代码生成、规划与理解能力，而 ReAct 负责的，是为这些能力提供一个稳定的执行框架。</p>
<h4 data-id="heading-9">2048</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af622ebf37304576a7bb9ca20821ac56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=KANcNJ1zxfeDyYRbdHmQcDFPWK8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">飞机大战</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7136ce6e72fc48b9881d0e63e0bbcbe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=QC%2FvP0NguOuKg5HhWX8DV2OyY14%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11">贪吃蛇</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/969ede2823b844219528d2112ed217b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=w6La6lPHlBabkIcuAYIcm%2FeAoi4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">五子棋</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba52da741cba462a9cc56c06a994bc83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=CPRLifd3j0ktRO%2BX7LZ7z9ITd0U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">结语</h2>
<p>ReAct 并不是最复杂、也不是最“智能”的 Agent 模式，但它结构清晰、实现成本低、工程可控性强，是理解和实践 Agent 系统非常合适的起点。</p>
<p>在后续更复杂的场景中，往往会在 ReAct 之上叠加：规划（Plan &amp; Execute）、反思（Reflection）、记忆与长期状态，但无论如何，ReAct 所确立的 <strong>思考—行动—反馈闭环</strong>，仍然是多数 Agent 系统绕不开的基础结构。</p>
<p>在下一篇中，我们将展开对 <strong>P&amp;E（Plan and Execute）模式</strong> 的详细解析，重点介绍其设计理念、执行流程及具体实现方式。</p>
<blockquote>
<p>我已将相关代码开源到 GitHub，感兴趣的同学可以下载到本地后执行一下玩玩：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAlessandro-Pang%2Fagent-desgin-pattern-demo" target="_blank" title="https://github.com/Alessandro-Pang/agent-desgin-pattern-demo" ref="nofollow noopener noreferrer">github.com/Alessandro-…</a></p>
</blockquote>
<h2 data-id="heading-14">相关资料</h2>
<ul>
<li><strong>GitHub 仓库</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAlessandro-Pang%2Fagent-desgin-pattern-demo" target="_blank" title="https://github.com/Alessandro-Pang/agent-desgin-pattern-demo" ref="nofollow noopener noreferrer">github.com/Alessandro-…</a></li>
<li><strong>AI Agent 介绍:</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fshort.pangcy.cn%2Fu%2F139a9efccce1fce2" target="_blank" title="https://short.pangcy.cn/u/139a9efccce1fce2" ref="nofollow noopener noreferrer">short.pangcy.cn/u/139a9efcc…</a></li>
<li><strong>ReAct 模式</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8446066" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8446066" ref="nofollow noopener noreferrer">www.bohrium.com/paper/read?…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙开发：一个底部的曲线导航]]></title>    <link>https://juejin.cn/post/7586500093844684842</link>    <guid>https://juejin.cn/post/7586500093844684842</guid>    <pubDate>2025-12-23T00:55:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586500093844684842" data-draft-id="7586491717874237459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙开发：一个底部的曲线导航"/> <meta itemprop="keywords" content="HarmonyOS,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-23T00:55:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员一鸣"/> <meta itemprop="url" content="https://juejin.cn/user/1398234520239095"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙开发：一个底部的曲线导航
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234520239095/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员一鸣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:55:23.000Z" title="Tue Dec 23 2025 00:55:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>似乎现在的应用，底部导航都是千篇一律，基本上都是几个按钮，点击之后，切换切换图标，更改更改颜色，稍微好点的会增加动画效果，今天，给大家推荐一款，底部的曲线导航，它可以让底部导航的实现方式别具一格。</p>
<p>我们先看下静态效果：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f041a5ca9d4c45a881971553d33c89cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=9suh0nqVyaIrkNUlpb4HGhvtOIE%3D" alt="" width="50%" loading="lazy"/></p>
<p>动态效果如下：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9073068a2d4442ce8611c7bcb4925e6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=pso7Bbd5T1QpDUHMz4CJ%2Fw%2BZbHw%3D" alt="" width="50%" loading="lazy"/></p>
<p>目前第一个版本，完成了基本的曲线形式效果，还未追加曲线的移动动画，在下一个版本会加上，那么针对这样的一个曲线形式导航，它是如何来实现的呢？答案很简单，就是使用简单的Path路径绘制。</p>
<p>Path路径，有两种方式实现，一种是系统提供的Path组件，另一种就是使用new drawing.Path()，然后使用canvas来绘制，两种方式都可以实现，看大家的技术选型，这里我使用的是Path组件，因为只需要设置符合SVG路径描述规范的命令字符串即可实现。</p>
<h2 data-id="heading-1">SVG路径介绍</h2>
<p>SVG路径是SVG（可缩放矢量图形）中用于创建复杂形状的核心元素，通过数学描述定义图形轮廓，支持直线、曲线、弧线等多种图形绘制。‌</p>
<p>例如，绘制一个三角形，直接在属性commands传递SVG路径即可，代码如下：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title class_">Path</span>()
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'210px'</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'310px'</span>)
        .<span class="hljs-title function_">commands</span>(<span class="hljs-string">'M100 0 L200 240 L0 240 Z'</span>)
        .<span class="hljs-title function_">fillOpacity</span>(<span class="hljs-number">0</span>)
        .<span class="hljs-title function_">stroke</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)
        .<span class="hljs-title function_">strokeWidth</span>(<span class="hljs-number">3</span>)
</code></pre>
<p>相对来说还是比较的简单，下面就针对SVG中的绘制命令，简单的罗列一下：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80e8acfb872f474e95bd047f8b3d2bef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=1%2FCDeBxyVgsk%2BOet1aGSYFhgZ4Q%3D" alt="" width="50%" loading="lazy"/></p>
<h2 data-id="heading-2">曲线绘制</h2>
<p>由于需要点击时，让本按钮进行曲线展示，有两个方面需要考虑，一是曲线的位置，点击不同位置的按钮，曲线就会移动到指定位置，二是曲线连接之处，保持平滑过渡，使用三次贝塞尔曲线段完成。</p>
<p>完整的绘制曲线代码如下，大家可以作为参考，averageWidth为每个tab按钮的宽度，navigationSize为导航数量。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"> <span class="hljs-comment">// 绘制曲线的函数</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">drawCurve</span>(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-comment">// 初始点：0,100</span>
    <span class="hljs-keyword">let</span> tagPosition = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> d = <span class="hljs-string">'M 0 '</span> + tagPosition;

    <span class="hljs-comment">// 计算曲线的起始和结束位置</span>
    <span class="hljs-keyword">const</span> curveStart = (position - <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span>;
    <span class="hljs-keyword">const</span> curveEnd = position * <span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span>;

    <span class="hljs-comment">// 0到曲线起始位置的直线部分</span>
    <span class="hljs-keyword">if</span> (curveStart &gt; <span class="hljs-number">0</span>) {
      d += <span class="hljs-string">' L '</span> + curveStart + <span class="hljs-string">' '</span> + tagPosition;
    }

    <span class="hljs-comment">// 曲线部分：使用两个三次贝塞尔曲线段确保平滑连接</span>
    <span class="hljs-keyword">const</span> midPoint = (curveStart + curveEnd) / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> controlPoint1X = curveStart + (<span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">navigationSize</span>);
    <span class="hljs-keyword">const</span> controlPoint2X = curveEnd - (<span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">navigationSize</span>);

    d += <span class="hljs-string">' C '</span> + controlPoint1X + <span class="hljs-string">' '</span> + tagPosition + <span class="hljs-string">' '</span> + controlPoint1X + <span class="hljs-string">' '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateCurveBottom</span> + <span class="hljs-string">' '</span> +
      midPoint +
      <span class="hljs-string">' '</span> +
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateCurveBottom</span>;
    d += <span class="hljs-string">' C '</span> + controlPoint2X + <span class="hljs-string">' '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateCurveBottom</span> + <span class="hljs-string">' '</span> + controlPoint2X + <span class="hljs-string">' '</span> + tagPosition + <span class="hljs-string">' '</span> +
      curveEnd +
      <span class="hljs-string">' '</span> + tagPosition;

    <span class="hljs-comment">// 曲线结束位置到最大宽度的直线部分</span>
    <span class="hljs-keyword">if</span> (curveEnd &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateMaxWidth</span>) {
      d += <span class="hljs-string">' L '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateMaxWidth</span> + <span class="hljs-string">' '</span> + tagPosition;
    }

    <span class="hljs-comment">// 新增闭合路径逻辑</span>
    d += <span class="hljs-string">` V <span class="hljs-subst">${<span class="hljs-variable language_">this</span>._privateCurveBottom}</span>`</span>; <span class="hljs-comment">// 垂直延伸到底部</span>
    d += <span class="hljs-string">' H 0'</span>; <span class="hljs-comment">// 水平返回起点</span>
    d += <span class="hljs-string">' Z'</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privatePathCommands</span> = d

  }
</code></pre>
<h2 data-id="heading-3">快速使用</h2>
<p>如果你不想自己实现，而是想快速的使用，这个已经为大家考虑到了，目前已经上传到到了中心仓库，有需要的同学，可以前去体验。</p>
<p>中心仓库地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2F%40abner%252Fcurve_navigation" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/@abner%2Fcurve_navigation" ref="nofollow noopener noreferrer">ohpm.openharmony.cn/#/cn/detail…</a></p>
<h3 data-id="heading-4">依赖方式</h3>
<h4 data-id="heading-5">1、远程依赖</h4>
<p>方式一：在Terminal窗口中，执行如下命令安装三方包，DevEco Studio会自动在工程的oh-package.json5中自动添加三方包依赖。</p>
<p><strong>建议：在使用的模块路径下进行执行命令。</strong></p>
<pre><code class="hljs language-TypeScript" lang="TypeScript">ohpm install <span class="hljs-meta">@abner</span>/curve_navigation
</code></pre>
<p>方式二：在模块的oh-package.json5中设置三方包依赖，配置示例如下：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-string">"dependencies"</span>: { <span class="hljs-string">"@abner/curve_navigation"</span>: <span class="hljs-string">"^1.0.1"</span>}
</code></pre>
<h3 data-id="heading-6">代码使用</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title class_">CurveNavigation</span>({
  <span class="hljs-attr">navigationSize</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">//tab数量</span>
  <span class="hljs-attr">navigationPaddingBottom</span>: <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowBottomNavHeight</span>,<span class="hljs-comment">//距离底部距离</span>
  <span class="hljs-attr">onPageChange</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-comment">//page改变</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectIndex</span> = position
  },
  <span class="hljs-attr">tabView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-comment">//导航视图</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">tabView</span>(position)
  },
  <span class="hljs-attr">pageView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-comment">//页面视图</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pageView</span>(position)
  }
})
</code></pre>
<h3 data-id="heading-7">完整案例</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">tempColorArray</span>: <span class="hljs-title class_">ResourceColor</span>[] = [<span class="hljs-string">"#ffcc80"</span>, <span class="hljs-string">"#ff9323ac"</span>, <span class="hljs-string">"#ff26a965"</span>, <span class="hljs-string">"#ff93d923"</span>, <span class="hljs-string">"#ff11c5de"</span>,]
  <span class="hljs-meta">@State</span> <span class="hljs-attr">selectIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">tabArray</span>: <span class="hljs-title class_">Resource</span>[] =
    [$r(<span class="hljs-string">'sys.symbol.house_fill'</span>), $r(<span class="hljs-string">'sys.symbol.square_fill_grid_2x2'</span>), $r(<span class="hljs-string">'sys.symbol.bell_fill'</span>),
      $r(<span class="hljs-string">'sys.symbol.externaldrive_fill'</span>), $r(<span class="hljs-string">'sys.symbol.person_2_fill'</span>)]

  <span class="hljs-meta">@Builder</span>
  <span class="hljs-title function_">tabView</span>(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectIndex</span> == position) {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">SymbolGlyph</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tabArray</span>[position])
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
          .<span class="hljs-title function_">renderingStrategy</span>(<span class="hljs-title class_">SymbolRenderingStrategy</span>.<span class="hljs-property">SINGLE</span>)
          .<span class="hljs-title function_">fontColor</span>([<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>])
      }
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">35</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">35</span>)
      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">35</span>)
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title class_">SymbolGlyph</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tabArray</span>[position])
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
        .<span class="hljs-title function_">renderingStrategy</span>(<span class="hljs-title class_">SymbolRenderingStrategy</span>.<span class="hljs-property">SINGLE</span>)
        .<span class="hljs-title function_">fontColor</span>([<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>])
    }

  }

  <span class="hljs-meta">@Builder</span>
  <span class="hljs-title function_">pageView</span>(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(position.<span class="hljs-title function_">toString</span>())
    }.<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)
    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tempColorArray</span>[position])
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">RelativeContainer</span>() {
      <span class="hljs-title class_">CurveNavigation</span>({
        <span class="hljs-attr">navigationSize</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">//tab数量</span>
        <span class="hljs-attr">navigationPaddingBottom</span>: <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowBottomNavHeight</span>,
        <span class="hljs-attr">onPageChange</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectIndex</span> = position
        },
        <span class="hljs-attr">tabView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">tabView</span>(position)
        },
        <span class="hljs-attr">pageView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pageView</span>(position)
        }
      })
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<h4 data-id="heading-8">属性介绍</h4>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b2c5ded8c4647e0a9ef6626693bb82c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=YyLI5MEVxt%2FqlxkIPnUgDV5roQ8%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-9">相关总结</h2>
<p>目前唯一的遗憾是，没有实现曲线在切换时的动画偏移，而是直接的切换，后续会针对这块再单独的处理，大家可以先进行使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 智能体攻陷软件工程：从 SWE-Agent 到 SWE-Swiss，全景解析 AI4SE 最新战局]]></title>    <link>https://juejin.cn/post/7586941997196263476</link>    <guid>https://juejin.cn/post/7586941997196263476</guid>    <pubDate>2025-12-24T06:32:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586941997196263476" data-draft-id="7587017021314007075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 智能体攻陷软件工程：从 SWE-Agent 到 SWE-Swiss，全景解析 AI4SE 最新战局"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-24T06:32:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智见AGI"/> <meta itemprop="url" content="https://juejin.cn/user/4145611877132986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 智能体攻陷软件工程：从 SWE-Agent 到 SWE-Swiss，全景解析 AI4SE 最新战局
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4145611877132986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智见AGI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:32:38.000Z" title="Wed Dec 24 2025 06:32:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e67389857204d0baf54c3eeb9865b84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=8MGL9FHFBv2IzIl05EWgYtZNxtc%3D" alt="6265b3d7309e32c86eb18586faffeec1_v2-fdd01df3be9f38b2cfc2277bd693870c_1440w.webp" loading="lazy"/>近期的研究已经充分证明，大语言模型（LLM）智能体在代码生成方面具备显著的能力。然而，当问题上升到更复杂、更工程化的层面——例如完整的软件工程（Software Engineering, SE）——AI 的探索仍处于起步阶段。</p>
<p>使用语言模型智能体去解决真实的代码 bug 问题的 <strong>workflow （Auto Debug Agent），是一个非常大需求的市场，而且是一个非常合适的AI应用场景。</strong></p>
<p>目前国内在这一领域已有探索者，如 通义灵码 与 豆包 MarsCode，而国际上代表性研究包括 SWE-Agent、AutoCodeRover 与 SWE-Swiss。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afb6185488044e1eb8212d1441337034~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=wFWlw2p6yUrOeLai6g1H46xK534%3D" alt="" loading="lazy"/></p>
<p><strong>SWE-Agent：AI 智能体解决软件工程问题的第一步</strong></p>
<ol>
<li><strong>概述</strong></li>
</ol>
<p>SWE-Agent 是一个使用语言模型智能体自动解决软件工程任务的系统。</p>
<p>它基于 <strong>Agent Computer Interface (ACI)</strong> ，在计算机与智能体之间建立抽象层，使智能体具备创建、编辑、浏览代码文件和执行程序的能力。</p>
<p><strong>2. ACI 框架设计理念</strong></p>
<p>ACI 框架统一了工具调用、提示工程（prompting）与代码执行。</p>
<p>其高效性主要来自以下几点：</p>
<p>●动作简单：易被 LLM 理解。</p>
<p>●动作高效：重要操作数量少。</p>
<p>●环境反馈清晰：输出简洁却信息量大。</p>
<p>●Guardrails：内置语法检测与自动修复低级错误。</p>
<p>相比传统的人机接口（如 VSCode），ACI 提供了更适合 LLM 的交互方式。</p>
<p><strong>3. 评测与表现</strong></p>
<p>SWE-Agent 在权威评测集 SWE-Bench 上表现出色。</p>
<p>在 2300 条测试数据中，使用 GPT-4 Turbo 模型的准确率达到 12.5%，超越最强无交互检索系统 3.8%，也比 Linux 终端环境提升 10.7%。</p>
<p>Claude-3-Opus 基线表现为 10.5%。</p>
<p><strong>4. 智能体行为机制</strong></p>
<p>SWE-Agent 的行为可分为以下模块：</p>
<p><strong>搜索与导航：</strong> 查找文件与目录（find_file、search_file）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29f240f5f8bc4c70bcf7ae15abd0ce56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=ZJjKc4HmA2w4af9h2QyT209Q550%3D" alt="" loading="lazy"/></p>
<p><strong>文件浏览：</strong> 支持打开文件、上下滑动、跳转行号（open、scroll_up、goto）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ec486618aaf43cab643eaac2a0719b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=QIuBhKzpDrQgmCsnKs2dkqvuOMw%3D" alt="" loading="lazy"/></p>
<p><strong>文件编辑：</strong> 可精确编辑指定行区间，并使用语法检测器防止错误。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6ca9ee8e8334451b41f29e58e49ef59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=MVS77SmeeFQo7mHVvxQC6JBnBE4%3D" alt="" loading="lazy"/></p>
<p><strong>上下文管理：</strong> 通过保留简明的历史交互与报错信息，控制上下文窗口大小，提高有效性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3c280fb1ac74bdda15b4da34b46ab16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=131yUBays%2BhpoZQf52dfnlk1nlI%3D" alt="" loading="lazy"/></p>
<p>实验表明，编辑动作是任务解决的核心；平均成功案例 12 步完成，失败案例则需 21 步。增加 Token 预算并不能显著提升性能。</p>
<p><strong>5. 提示词结构（Prompt Workflow）</strong></p>
<p>SWE-Agent 的提示工程由四部分组成：</p>
<p><strong>System Prompt：</strong> 定义操作环境与命令约束；</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">SETTING:</span> 
您是一位自主编程的程序员，正在使用一个特殊的界面直接在命令行中工作。这个特殊的界面包含一个文件编辑器，可以一次显示 <span class="hljs-number">100</span> 行文件内容。除了常见的 Bash 命令外，您还可以使用以下命令来导航和编辑文件。

<span class="hljs-symbol">COMMANDS:</span> {documentation}
请注意，EDIT 命令需要正确的缩进。如果您想添加 “   print(x)” 这一行，必须完整地写出来，包括代码前的所有空格！缩进非常重要，未正确缩进的代码将运行失败，需要修复后才能运行。

RESPONSE FORMAT:
Your shell prompt <span class="hljs-built_in">is</span> formatted <span class="hljs-keyword">as</span> follows:
(Open file: &lt;path&gt;) &lt;cwd&gt; $
You need <span class="hljs-keyword">to</span> format your output <span class="hljs-keyword">using</span> two fields; discussion <span class="hljs-built_in">and</span> command. Your output should always include one discussion <span class="hljs-built_in">and</span> one command field EXACTLY <span class="hljs-keyword">as</span> <span class="hljs-keyword">in</span> the following example:

<span class="hljs-symbol">DISCUSSION:</span>
First I’ll start <span class="hljs-keyword">by</span> <span class="hljs-keyword">using</span> ls <span class="hljs-keyword">to</span> see what files are <span class="hljs-keyword">in</span> the current directory. <span class="hljs-keyword">Then</span> maybe we can look at some relevant files <span class="hljs-keyword">to</span> see what they look <span class="hljs-built_in">like</span>.
```
ls -a
```
您应该只在命令部分包含一个命令，然后等待 Shell 的响应，然后再继续进行更多讨论和命令。
您在“discussion”部分包含的所有内容都将被保存以供将来参考。如果您想同时执行两个命令，请不要这样做！请先提交第一个命令，然后在收到响应后才能执行第二个命令。
除了上面列出的特殊命令外，您还可以自由使用任何其他您想要的 Bash 命令（例如 find、grep、cat、ls、cd）。但是，该环境不支持交互式会话命令（例如 python、vim），因此请不要调用它们。
</code></pre>
<p><strong>Demonstration：</strong> 提供操作范例；</p>
<pre><code class="hljs language-typescript" lang="typescript">这里有一个如何正确完成此任务的演示。
它旨在向您展示如何正确使用界面，您无需完全按照演示中的方法操作。
--- <span class="hljs-variable constant_">DEMONSTRATION</span> ---
{{<span class="hljs-variable constant_">INSTANCE</span> <span class="hljs-variable constant_">PROMPT</span>}}

代码已更新，使用 <span class="hljs-string">`round`</span> 函数，这应该可以修复四舍五入问题。提交更改之前，最好再次运行一下 replicate.<span class="hljs-property">py</span> 代码，以确保此更改达到预期效果。我看到 “<span class="hljs-title class_">Current</span> directory” 仍然是 <span class="hljs-string">`/marshmallow-code__marshmallow`</span>，所以我们可以直接运行 <span class="hljs-string">`reproduce.py`</span>。
<span class="hljs-string">``</span><span class="hljs-string">`
python reproduce.py
`</span><span class="hljs-string">``</span>
<span class="hljs-number">345</span>

(<span class="hljs-title class_">Open</span> <span class="hljs-attr">file</span>: <span class="hljs-regexp">/marshmallow-code__marshmallow/</span>src/marshmallow/fields.<span class="hljs-property">py</span>)
(<span class="hljs-title class_">Current</span> <span class="hljs-attr">directory</span>: /marshmallow-code__marshmallow)
bash-$
输出已从 <span class="hljs-number">344</span> 更改为 <span class="hljs-number">345</span>，这表明四舍五入问题已修复。我们删除 replicate.<span class="hljs-property">py</span> 文件，因为它不再需要了。
<span class="hljs-string">``</span><span class="hljs-string">`
rm reproduce.py
`</span><span class="hljs-string">``</span>
<span class="hljs-title class_">Your</span> command ran successfully and did not produce <span class="hljs-built_in">any</span> output.
(<span class="hljs-title class_">Open</span> <span class="hljs-attr">file</span>: <span class="hljs-regexp">/marshmallow-code__marshmallow/</span>src/marshmallow/fields.<span class="hljs-property">py</span>)
(<span class="hljs-title class_">Current</span> <span class="hljs-attr">directory</span>: /marshmallow-code__marshmallow)
bash-$
rm 删除成功后没有任何输出，所以肯定成功了。既然问题已经解决，我们应该将更改提交到代码库。让我们使用 <span class="hljs-string">`submit`</span> 命令提交更改。
<span class="hljs-string">``</span><span class="hljs-string">`
submit
`</span><span class="hljs-string">``</span>
--- <span class="hljs-variable constant_">END</span> <span class="hljs-variable constant_">OF</span> <span class="hljs-variable constant_">DEMONSTRATION</span> ---
</code></pre>
<p><strong>Instance Message：</strong> 描述任务与调试目标；</p>
<pre><code class="hljs language-markdown" lang="markdown">我们目前正在解决代码库中的以下问题。
以下是问题内容：
ISSUE:
{issue}

INSTRUCTIONS:
现在，您将自行解决这个问题。您的终端会话已启动，并且您位于代码库的根目录中。您可以使用任何 Bash 命令或特殊界面来帮助您。编辑所有需要的文件，并运行任何您想要的检查或测试。
请记住，您一次只能输入一个命令！您应该在执行每个命令后等待反馈。当您对所有更改感到满意时，只需运行提交命令即可将更改提交到代码库。但请注意，您无法在此环境中使用任何交互式会话命令（例如 Python、vim），但您可以编写脚本并运行它们。
例如，您可以编写一个 Python 脚本，然后使用 <span class="hljs-code">`python &lt;script_name&gt;.py`</span> 运行它。 关于编辑命令的注意事项：缩进非常重要！编辑文件时，请确保在每行前插入适当的缩进！

IMPORTANT TIPS:
<span class="hljs-bullet">1.</span> 请务必先尝试复现问题中提到的错误。如果问题包含用于复现错误的代码，我们建议您在您的环境中重新实现该代码并运行，以确保您可以复现错误。然后开始尝试修复它。当您认为错误已经修复后，请重新运行错误复现脚本，以确保错误确实已修复。
<span class="hljs-bullet">2.</span> 如果您运行某个命令但不起作用，请尝试运行其他命令。一次不起作用的命令，除非您修改它，否则第二次也不会起作用！
<span class="hljs-bullet">3.</span> 如果您打开一个文件，并且需要转到不在前100行中的特定行（例如第583行）附近的区域，请不要多次使用scroll<span class="hljs-emphasis">_down命令。相反，请使用goto583命令。它更快。
4. 如果错误复现脚本需要输入/读取特定文件（例如 buggy-input.png），而您想了解如何输入该文件，请在现有的代码库代码中进行搜索，看看是否有人已经这样做过。执行以下命令：find_</span>file "buggy-input.png"
如果此命令无效，请使用 Linux 的“find”命令。
<span class="hljs-bullet">5.</span> 务必查看当前打开的文件和当前工作目录（紧接着当前打开的文件）。当前打开的文件可能与工作目录位于不同的目录中！请注意，某些命令（例如 “create”）会打开文件，因此它们可能会更改当前打开的文件。
<span class="hljs-bullet">6.</span> 编辑文件时，很容易意外指定错误的行号或编写缩进不正确的代码。执行编辑后，请务必检查代码，以确保其反映了您想要实现的目标。如果没有，请执行另一个命令进行修复。

(Open file: {open<span class="hljs-emphasis">_file})
(Current directory: {working_</span>dir})
bash-$
</code></pre>
<p><strong>Next Step Template：</strong> 生成下一步操作模板。</p>
<pre><code class="hljs language-javascript" lang="javascript">{<span class="hljs-variable constant_">OBSERVATION</span>}
(<span class="hljs-title class_">Open</span> <span class="hljs-attr">file</span>: <span class="hljs-regexp">/path/</span>to/open/file.<span class="hljs-property">py</span>)
(<span class="hljs-title class_">Current</span> <span class="hljs-attr">directory</span>: <span class="hljs-regexp">/path/</span>to/cwd)
bash-$
</code></pre>
<p><strong>SWE-Bench：AI4SE 的权威评测集</strong></p>
<p>SWE-Bench 是软件工程领域的标准化评测集，包含真实代码仓与调试任务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55374814962c4f599a242ca0472c3c77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=s5fzKeSyAt3n%2B2OtbW8iVUOAA8Q%3D" alt="" loading="lazy"/></p>
<p>评测集构建背景</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b05e9d23958e4cec99cb5fa3eb8dd4be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=haVsLh%2BmHqnTPh6wYsKvCFTTFQE%3D" alt="" loading="lazy"/></p>
<p>数据爬取与过滤筛选</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bfa71d04c054a188d05b8a15bb62369~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=7lJ%2FdHCpWvNRRg9PMqd%2FdyJppmA%3D" alt="" loading="lazy"/></p>
<p>观察到的现象：input 增加，模型 debug 的能力下降</p>
<p>研究发现：随着输入信息量增加，模型的 Debug 能力反而下降，因此需要设计能<strong>压缩上下文、提炼结构化信息</strong>的智能体，以提升效率与鲁棒性。</p>
<p><strong>AutoCodeRover：结构化调试的自动化智能体</strong></p>
<p><strong>1. 技术要点</strong></p>
<p>AutoCodeRover 通过 <strong>AST（抽象语法树）</strong>  解析代码结构，并基于文件、类、函数层级组织上下文。</p>
<p>该方法显著减少 LLM 的上下文窗口压力，提高 Debug 精度。</p>
<p>●采用 程序结构检索 与 故障定位 技术；</p>
<p>●0.5～1 小时的调试时间可接受；</p>
<p>●解决了 57 个 GitHub 实际问题，成功率达 2/3；</p>
<p>●平均 4 分钟修复一个问题，而人工平均需 2.68 天。</p>
<p><strong>2. 工作流</strong></p>
<p>从问题描述出发，AutoCodeRover 自动调用相关 API、分析代码、定位 Bug、生成补丁，形成完整闭环。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73e7cacaaad24e06a01f3894398cd3fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=YPj3WmqqE8NzYjgliBkOjUXLnFk%3D" alt="" loading="lazy"/></p>
<p><strong>SWE-Swiss：强化学习驱动的高性能智能体</strong></p>
<p>由字节跳动 Seed 团队提出的 SWE-Swiss，在 AI4SE 领域取得突破。</p>
<p>基于 Qwen2.5-32B-Instruct 模型，结合 <strong>多任务微调（SFT）+ 强化学习（RL）</strong> ，在 SWE-Bench Verified 上取得 60.2% 的 SOTA 成绩。</p>
<p><strong>1. 三阶段数据构建</strong></p>
<p><strong>●定位阶段：</strong> 确定需修改文件；</p>
<p><strong>●修复阶段：</strong> 筛选有效补丁；</p>
<p><strong>●验证阶段：</strong> 生成并通过单元测试。</p>
<p>总计使用 10,254 个数据样本完成 SFT 训练。</p>
<p><strong>2. 强化学习策略</strong></p>
<p>采用 GRPO 算法，结合 DAPO 中的动态采样与无 KL 损失设计，分两阶段训练：</p>
<p><strong>●第一阶段：</strong> 广泛构建通用问题解决能力；</p>
<p><strong>●第二阶段：</strong> 聚焦难点数据集，提升修复性能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2372501589440fb9d76eb49fe949b71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162758&amp;x-signature=VKleEx7BNf0F00O5sxpQ6iSBNo4%3D" alt="" loading="lazy"/></p>
<p>最终通过多补丁自一致性评估，将性能从 45.0% 提升至 60.2%。</p>
<p><strong>3. 验证机制与增强自一致性</strong></p>
<p>为解决代码语义等效但非精确匹配的问题，SWE-Swiss 引入增强自一致性机制：</p>
<p>●综合精确匹配与相似度打分；</p>
<p>●通过编辑距离计算候选补丁间相似性；</p>
<p>●采用自洽投票与加权评分选出最优补丁。</p>
<p>这一方法显著提升了最终修复的准确率。</p>
<p><strong>总结与展望</strong></p>
<p>AI4SE（AI for Software Engineering）正在成为大模型落地的关键方向。</p>
<p>从 SWE-Agent 到 AutoCodeRover，再到 SWE-Swiss，我们看到 AI 智能体已经从代码生成逐步进化为能<strong>理解、调试、修复</strong>与验证的完整开发伙伴。</p>
<p>未来的研究方向包括：</p>
<p>●构建多智能体协同架构；</p>
<p>●在 MoE 模型上提升性能；</p>
<p>●引入更密集的过程奖励信号；</p>
<p>●优化上下文压缩与知识检索。</p>
<p>AI4SE 的边界，正在快速扩展，<strong>真正的“自编程”时代或许已在不远的未来。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端轮子（2）--diy响应数据]]></title>    <link>https://juejin.cn/post/7586575372621103113</link>    <guid>https://juejin.cn/post/7586575372621103113</guid>    <pubDate>2025-12-23T01:26:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586575372621103113" data-draft-id="7585645111876010011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端轮子（2）--diy响应数据"/> <meta itemprop="keywords" content="前端,JavaScript,浏览器"/> <meta itemprop="datePublished" content="2025-12-23T01:26:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小易"/> <meta itemprop="url" content="https://juejin.cn/user/2032344744857127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端轮子（2）--diy响应数据
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2032344744857127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小易
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:26:34.000Z" title="Tue Dec 23 2025 01:26:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style>
<h2 data-id="heading-0">优雅 DIY 响应数据（XHR / fetch 拦截器）</h2>
<blockquote>
<p>前端轮子系列：</p>
<ol>
<li><a href="https://juejin.cn/spost/7585706951603601434" target="_blank" title="https://juejin.cn/spost/7585706951603601434">前端部署后-判断页面是否为最新</a></li>
<li><a href="https://juejin.cn/spost/7586575372621103113" target="_blank" title="https://juejin.cn/spost/7586575372621103113">如何优雅diy响应数据</a></li>
<li>如何优雅进行webview调试</li>
<li>如何实现测试环境的自动登录</li>
<li/>
</ol>
</blockquote>
<p>一个面向前端联调/测试的 Chrome 扩展：在 <code>页面中的xhr\fetch请求</code>，命中规则时直接返回自定义响应，从而“<strong>让业务代码以为请求成功了</strong>”。😂</p>
<h3 data-id="heading-1">你能得到什么</h3>
<ul>
<li><strong>按规则拦截 XHR</strong>：请求 URL 正则 + 方法（ANY/GET/POST...）匹配后返回自定义文本/JSON</li>
<li><strong>DevTools 面板可视化管理</strong>：新增 / 编辑 / 删除 / 搜索 / 开关</li>
<li><strong>实时生效</strong>：规则与开关存储在 <code>chrome.storage.local</code>，变更后同步到页面</li>
</ul>
<h3 data-id="heading-2">一、快速开始（安装与使用）</h3>
<h4 data-id="heading-3">1) 安装（开发者模式）</h4>
<ol>
<li>打开 Chrome 扩展管理页：<code>chrome://extensions/</code></li>
<li>右上角开启 <strong>开发者模式</strong></li>
<li>点击 <strong>加载已解压的扩展程序</strong>，选择 <code>Interceptors/</code> 目录</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fa2a4fe763b43d5b7b1ddf2edf565b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5piT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767058025&amp;x-signature=WDgsk8h29p2nTLeYc5TY4PyPdNo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">2) 使用（DevTools 面板）</h4>
<ol>
<li>打开要调试的网站</li>
<li>打开 DevTools（F12）</li>
<li>切到面板 <strong>“XHR拦截器”</strong></li>
<li>打开右上角 <strong>拦截开关</strong></li>
<li>新增规则（pattern / method / response），保存即可生效</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38adafbd895541cbbee21e88d27afa89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5piT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767058025&amp;x-signature=c4JIFkIEd2K5S9wpwzJ7yIFmswM%3D" alt="xhr3.gif" loading="lazy"/></p>
<h3 data-id="heading-5">二、实现思路</h3>
<h4 data-id="heading-6">1. 构建插件目录</h4>
<p>如果是第一次开发浏览器插件看过来
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2Fget-started%2Ftutorial%2Fhello-world%3Fhl%3Dzh-cn" target="_blank" title="https://developer.chrome.com/docs/extensions/get-started/tutorial/hello-world?hl=zh-cn" ref="nofollow noopener noreferrer">官方的 hello world</a></p>
<ol>
<li>manifest.json 文件 =&gt; 定义插件的权限、内容脚本、web_accessible_resources 等</li>
<li>devtools.html 文件 =&gt; 定义插件的 DevTools 入口页面</li>
<li>devtools.js 文件 =&gt; 创建 DevTools 面板</li>
<li>panel.html 文件 =&gt; 定义插件的面板页面</li>
<li>panel.js 文件 =&gt; 定义插件的面板脚本</li>
<li>scripts/background.js 文件 =&gt; 定义插件的后台脚本 / 内容注入逻辑</li>
<li>scripts/page-inject.js 文件 =&gt; 定义插件的页面上下文拦截逻辑</li>
</ol>
<h4 data-id="heading-7">2. 建立插件与页面的通信</h4>
<p>因为插件和页面是不同的域，所以需要建立插件与页面的通信</p>
<ol>
<li>在页面中注入 <code>page-inject.js</code> 脚本
<ul>
<li>负责拦截、重写页面中的 XMLHttpRequest 请求</li>
<li>通过 监听 message 事件 接收插件的规则、自定义返回内容</li>
<li>匹配到规则后，构建响应数据并返回数据（阻止请求的发送）</li>
</ul>
</li>
<li>在插件中注入 <code>background.js</code> 脚本 =&gt; 负责 插件与页面通信 =&gt; 通过 postMessage 发送配置到页面
<ul>
<li>通过 chrome.storage.onChanged 监听 storage 变化</li>
<li>当 storage 变化时，发送配置到页面</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">三、具体实现（上菜）</h3>
<h4 data-id="heading-9">1. 构建项目</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">mkdir</span> interceptor &amp;&amp; <span class="hljs-built_in">cd</span> interceptor
</code></pre>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2Freference%2Fmanifest%3Fhl%3Dzh-cn%23minimal-manifest" target="_blank" title="https://developer.chrome.com/docs/extensions/reference/manifest?hl=zh-cn#minimal-manifest" ref="nofollow noopener noreferrer">manifest.json</a> 文件 =&gt; 定义插件的权限、内容脚本、web_accessible_resources 等
声明：版本、名字、描述、权限、主机权限、脚本、资源访问权限</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"manifest_version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"XHR Interceptor"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"通过可配置的规则拦截并替换 XHR/fetch 请求结果。"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"storage"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"host_permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&lt;all_urls&gt;"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"devtools_page"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"devtools.html"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"content_scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&lt;all_urls&gt;"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"scripts/background.js"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"run_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"document_start"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"web_accessible_resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"scripts/page-inject.js"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&lt;all_urls&gt;"</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<ol start="2">
<li>devtools.html 文件 =&gt; 定义插件的 DevTools 入口页面</li>
</ol>
<pre><code class="hljs language-html" lang="html">  <span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 引入 devtools.js 文件 =&gt; 创建面板 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"devtools.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ol start="3">
<li>devtools.js 文件 =&gt; 创建 DevTools 面板
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2Freference%2Fapi%2Fdevtools%2Fpanels%3Fhl%3Dzh-cn" target="_blank" title="https://developer.chrome.com/docs/extensions/reference/api/devtools/panels?hl=zh-cn" ref="nofollow noopener noreferrer">panels面板</a></li>
</ol>
<pre><code class="hljs language-js" lang="js">chrome.<span class="hljs-property">devtools</span>.<span class="hljs-property">panels</span>.<span class="hljs-title function_">create</span>(
  <span class="hljs-string">"XHR拦截器"</span>,
  <span class="hljs-literal">null</span>,
  <span class="hljs-string">"panel.html"</span>,
  <span class="hljs-function">(<span class="hljs-params">panel</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (panel) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[XHR Interceptor] DevTools panel created."</span>);
  }
);
</code></pre>
<ol start="4">
<li>panel.html 文件 =&gt; 定义插件的面板页面</li>
</ol>
<pre><code class="hljs language-html" lang="html">  <span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>XHR Interceptor<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 样式文件引入 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"panel.css"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 插件面板样式构建 --&gt;</span>
      <span class="hljs-comment">&lt;!-- 引入 panel.js 文件 =&gt; 定义面板交互逻辑 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"panel.js"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-10">2. 注入js脚本到页面</h4>
<ol>
<li>background.js 中 注入 page-inject.js 脚本到页面</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PAGE_SCRIPT</span> = chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">getURL</span>(<span class="hljs-string">"scripts/page-inject.js"</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">injectPageScript</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"script"</span>);
  script.<span class="hljs-property">src</span> = <span class="hljs-variable constant_">PAGE_SCRIPT</span>;
  script.<span class="hljs-property">type</span> = <span class="hljs-string">"text/javascript"</span>;
  script.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"load"</span>, <span class="hljs-function">() =&gt;</span> script.<span class="hljs-title function_">remove</span>());
  script.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"error"</span>, <span class="hljs-function">() =&gt;</span> script.<span class="hljs-title function_">remove</span>());
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">appendChild</span>(script);
}
</code></pre>
<ol start="2">
<li>background.js 中 监听 storage 变化</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MESSAGE_SOURCE</span> = <span class="hljs-string">"xhr-interceptor-extension"</span>;
chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">onChanged</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">changes, namespace</span>) =&gt;</span> {
  <span class="hljs-comment">// 当 storage 变化时，发送配置到页面</span>
  <span class="hljs-title function_">postConfigToPage</span>({});
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">postConfigToPage</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-comment">// 直接使用 window.postMessage：content script 与页面共享同一个 window 消息通道，</span>
  <span class="hljs-comment">// 且不会触发页面的 CSP（避免内联脚本被阻止）。</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">postMessage</span>(
    {
      <span class="hljs-attr">source</span>: <span class="hljs-variable constant_">MESSAGE_SOURCE</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">"config:update"</span>,
      <span class="hljs-attr">payload</span>: config || <span class="hljs-title function_">buildConfig</span>(),
    },
    <span class="hljs-string">"*"</span>
  );
}
</code></pre>
<h4 data-id="heading-11">3. 重写 XHR、fetch 方法</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 保存原始方法</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ORIGINAL</span> = {
    <span class="hljs-attr">open</span>: <span class="hljs-title class_">XMLHttpRequest</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">open</span>,
    <span class="hljs-attr">send</span>: <span class="hljs-title class_">XMLHttpRequest</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">send</span>,
    <span class="hljs-attr">fetch</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span> ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">window</span>) : <span class="hljs-literal">null</span>,

};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">hookXMLHttpRequest</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">XMLHttpRequest</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">open</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">patchedOpen</span>(<span class="hljs-params">method, url</span>) {
        <span class="hljs-comment">// 做一些标记、额外操作</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">ORIGINAL</span>.<span class="hljs-property">open</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
    };

    <span class="hljs-title class_">XMLHttpRequest</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">send</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">patchedSend</span>(<span class="hljs-params">body</span>) {
        <span class="hljs-comment">// 检查 开关是否打开、规则是否匹配</span>
        <span class="hljs-comment">// 如果匹配，构建响应数据并返回</span>
        <span class="hljs-comment">// 如果不匹配，继续发送请求</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">ORIGINAL</span>.<span class="hljs-property">send</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
    };
}

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">hookFetch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">ORIGINAL</span>.<span class="hljs-property">fetch</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">patchedFetch</span>(<span class="hljs-params">input, init</span>) {
      <span class="hljs-comment">// 解析 method + url，然后复用 pickMatchingRule 进行匹配</span>
      <span class="hljs-keyword">const</span> meta = <span class="hljs-title function_">extractFetchMeta</span>(input, init);
      <span class="hljs-keyword">const</span> rule = <span class="hljs-title function_">pickMatchingRule</span>(meta.<span class="hljs-property">method</span>, meta.<span class="hljs-property">url</span>);
      <span class="hljs-keyword">if</span> (!enabled || !rule) <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">ORIGINAL</span>.<span class="hljs-title function_">fetch</span>(input, init);

      <span class="hljs-keyword">const</span> res = <span class="hljs-title function_">buildMockFetchResponse</span>(rule);
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(res);
    };
  }
</code></pre>
<h4 data-id="heading-12">4. 规则列表匹配</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> rules = []; <span class="hljs-comment">// 保存规则列表</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pickMatchingRule</span>(<span class="hljs-params">method, url</span>) {
    <span class="hljs-keyword">if</span> (!url) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> upperMethod = (method || <span class="hljs-string">"GET"</span>).<span class="hljs-title function_">toUpperCase</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> rule <span class="hljs-keyword">of</span> rules) {
      <span class="hljs-keyword">if</span> (!rule.<span class="hljs-property">regex</span>) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">if</span> (rule.<span class="hljs-property">method</span> !== <span class="hljs-string">"ANY"</span> &amp;&amp; rule.<span class="hljs-property">method</span> !== upperMethod) <span class="hljs-keyword">continue</span>;
      rule.<span class="hljs-property">regex</span>.<span class="hljs-property">lastIndex</span> = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (rule.<span class="hljs-property">regex</span>.<span class="hljs-title function_">test</span>(url)) {
        <span class="hljs-keyword">return</span> rule;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
</code></pre>
<h4 data-id="heading-13">5. 监听消息 &amp; 同步面板数据、规则到页面</h4>
<p>接收插件的规则、自定义返回内容（从 background.js 发送的消息）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-property">currentScript</span>;
<span class="hljs-keyword">const</span> messageSource =
    (script &amp;&amp; script.<span class="hljs-property">dataset</span> &amp;&amp; script.<span class="hljs-property">dataset</span>.<span class="hljs-property">source</span>) ||
    <span class="hljs-string">"xhr-interceptor-extension"</span>;

<span class="hljs-comment">// 监听消息通道</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setupMessageChannel</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"message"</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (event.<span class="hljs-property">source</span> !== <span class="hljs-variable language_">window</span>) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (!event.<span class="hljs-property">data</span> || event.<span class="hljs-property">data</span>.<span class="hljs-property">source</span> !== messageSource) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">"config:update"</span>) {
            <span class="hljs-comment">// 判断为background.js发送的消息</span>
            <span class="hljs-comment">// 更新插件面板的数据(开关的状态、规则的数据)</span>
        }
    });
}
</code></pre>
<h4 data-id="heading-14">6. 面板存储规则到storage &amp; 处理ui交互</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2Freference%2Fapi%2Fstorage%3Fhl%3Dzh_cn" target="_blank" title="https://developer.chrome.com/docs/extensions/reference/api/storage?hl=zh_cn" ref="nofollow noopener noreferrer">chrome.storage</a></p>
<ol>
<li>staorage 的读取、设置、移除</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 读取</span>
 <span class="hljs-keyword">const</span> stored = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">get</span>({ <span class="hljs-attr">rules</span>: [] })

<span class="hljs-comment">// 设置</span>
<span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">set</span>({ rules });

<span class="hljs-comment">// 移除 可以传 字符串 | 数组</span>
<span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">"rules"</span>);

<span class="hljs-comment">// 清空</span>
<span class="hljs-keyword">await</span> chrome.<span class="hljs-property">storage</span>.<span class="hljs-property">local</span>.<span class="hljs-title function_">clear</span>();
</code></pre>
<ol start="2">
<li>面板的ui交互
正常的ui交互,正常的原生开发就行</li>
</ol>
<h3 data-id="heading-15">源码</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoyi1255%2Fversion-check" target="_blank" title="https://github.com/xiaoyi1255/version-check" ref="nofollow noopener noreferrer">xiaoyi1255</a></p>
<h3 data-id="heading-16">结语</h3>
<p>如果本文对你有收获，麻烦动动发财的小手，点点关注、点点赞！！！👻👻👻</p>
<p>因为收藏===会了</p>
<p>如果有不对、更好的方式实现、可以优化的地方欢迎在评论区指出，谢谢👾👾👾</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拥抱AI Coding,让我更自信能胜任我的工作]]></title>    <link>https://juejin.cn/post/7586983243926274086</link>    <guid>https://juejin.cn/post/7586983243926274086</guid>    <pubDate>2025-12-24T06:48:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586983243926274086" data-draft-id="7587020682010165275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拥抱AI Coding,让我更自信能胜任我的工作"/> <meta itemprop="keywords" content="AI编程,人工智能,前端"/> <meta itemprop="datePublished" content="2025-12-24T06:48:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我要充满正能量"/> <meta itemprop="url" content="https://juejin.cn/user/3034307824453607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拥抱AI Coding,让我更自信能胜任我的工作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307824453607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我要充满正能量
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:48:58.000Z" title="Wed Dec 24 2025 06:48:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI让我无比自信,觉得更能胜任我的工作</h2>
<blockquote>
<p>放下偏见，全面拥抱AI吧，开发者！</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、从偏见到拥抱：</h3>
<p>一年前的我，对AI还抱有深深的偏见。(总觉得,AI怎么可能替代得了人编程~~~~后面被实力打脸)</p>
<p>作为一名前端开发者，那时我还在产出<code>Vue3</code>相关的入门文章。近一年来已经没写了——原因很简单：我觉得AI已经替代了千篇一律的文章产出，更何况很多文章本身就是抄袭和洗稿的产物，我自己写的那几篇文章就经常被"借鉴"。（高质量深度文章除外，那依然有价值）</p>
<p>这种偏见源于过去接触太多所谓的"低代码开发"，我实在对这种被吹成"<strong>银弹</strong>"的工具不感冒。</p>
<p>但在近半年高强度接触<code>AI Coding</code>后，我的看法彻底改变了。</p>
<p>我看到了普通开发者的渺小，也看到了AI潜力的无比巨大。这个AI大爆发的时代，对开发者的冲击是猛烈而深刻的——它不仅仅是一个提升效率的工具，更是开发者的<strong>能力放大器</strong>。你仅仅通过chat~~~就能完成功能开发和bug修复</p>
<p><strong>AI亦师亦🐮🐴</strong>：在你不懂时，你可以通过询问的方式学习了解不懂的知识；在你需要工作时，充当牛马,不知疲倦得帮你完成工作。</p>
<hr/>
<h3 data-id="heading-2">二、AI Coding vs 古法Coding：</h3>
<blockquote>
<p>都是在堆积屎山,目的是一样的,但是道路和体验是不同的🤣🤣🤣🤣(工作越久越懂得世界是一草台班子组成的)</p>
</blockquote>
<h4 data-id="heading-3">2.1 工作流程对比</h4>
<p>我从过去的古法手敲代码，到现在通过对话解决BUG和开发新功能，工作效率提升无比巨大，我有更多的时间投入摸鱼（🤣果然偷懒才是人类发展的最大动力）。</p>
<p><strong>古法Coding：</strong></p>
<pre><code class="hljs">人写屎山 → review屎山 → 修修补补屎山
</code></pre>
<p><strong>AI Coding：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"用中文回答"</span> → <span class="hljs-string">"生成完整代码"</span> → <span class="hljs-string">"还是无法运行？"</span>
→ <span class="hljs-string">"帮我修改代码"</span> → <span class="hljs-string">"你的代码还是有问题"</span> → <span class="hljs-string">"请加注释"</span>
</code></pre>
<h4 data-id="heading-4">2.2 AI Coding：BUG解决</h4>
<p><strong>过去解决一个BUG：</strong> 一个人通常需要去review代码，看懂代码的上下逻辑，最终找到问题所在。(通常屎山,review是一件非常头疼的事~~~~)</p>
<p><strong>现在：</strong> 你只需要告诉AI出现了什么问题、在什么时间节点或什么情况下出现的问题。把问题描述清楚，AI就能基于你的描述（提示词）开始工作，最终将问题解决，<strong>顺便告诉你整个原因所在。</strong></p>
<h4 data-id="heading-5">2.3 AI Coding：功能开发</h4>
<p>举个例子，开发一个人脸识别认证的DEMO（模拟人脸识别）：</p>
<p><strong>功能需求：</strong></p>
<ol start="0">
<li>打开摄像头</li>
<li>展示人脸画面</li>
<li>模拟人脸检测</li>
<li>完成认证</li>
</ol>
<p><strong>过去你需要：</strong></p>
<ol start="0">
<li>谷歌/百度找例子</li>
<li><strong>Ctrl+C 然后Ctrl+V</strong> (谁反对!!!谁赞成!!!🤣🤣🤣🤣🤣🤣)</li>
<li>调试、调试、调试...</li>
</ol>
<p>一个功能一个上午才能完成。</p>
<p><strong>现在：</strong> 你只需要把需求描述清楚，AI在几分钟内就能把Demo功能开发完成，而且完成度相当高。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abea5fefed7d47e3aec3ef4a32b6a2da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5YWF5ruh5q2j6IO96YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767170181&amp;x-signature=Aa1eofpqdAUFVmL4pvRG0DQFL6M%3D" alt="人脸识别demo1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1a2c8f799644d41a44b39beb091838f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5YWF5ruh5q2j6IO96YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767170181&amp;x-signature=BMErHqrD0uIxWEz00DgtSVdPo7c%3D" alt="人脸识别demo2.png" loading="lazy"/></p>
<p>在这期间，你甚至可以去网上冲浪，和沙雕网友对线,和群友吹水谈笑风生 ~~~~~ 🤣🤣🤣</p>
<p>回来一看,功能运行正常,比自己写的界面还🐂🍺!!!</p>
<p><strong>最后结论:我真厉害🤣🤣🤣</strong></p>
<hr/>
<h3 data-id="heading-6">三、为什么AI让我无比自信</h3>
<blockquote>
<p>很多人在贩卖AI焦虑，说什么"AI会取代人"。但我写这篇文章的原因恰恰相反——<strong>AI的出现真的让我感到了无比自信,觉得更能胜任我的工在</strong>。</p>
</blockquote>
<p>在高强度使用AI Coding的半年内，我深刻认识到一点：</p>
<blockquote>
<p><strong>AI是能力放大器。它能无限放大你的能力——你懂一点点，通过AI就能在这一点点的基础上放大。AI的出现真正提高了普通人的上限和下限。</strong></p>
</blockquote>
<p>这种自信源于三个层面：</p>
<h4 data-id="heading-7">3.1 知识广度被放大</h4>
<p>以前做全栈开发是奢望，现在通过AI去学习成为全栈开发者变得可行。只要你在某个方向上能做一点，<strong>AI就能在那个方向上帮你多做一点</strong>。</p>
<blockquote>
<p>我相信,绝大部分开发者都是普通开发者,小厂面临的问题,很多都是什么都干,那么AI真能帮忙解决很多事</p>
</blockquote>
<h4 data-id="heading-8">3.2 时间被解放(更多的时间摸鱼🐟🐟🐟)</h4>
<p>(后台挂着AI干活,就悄悄把活干完了~~~~)</p>
<h4 data-id="heading-9">3.3 错误率降低</h4>
<p>AI辅助Review和调试，能避免很多低级错误,毕竟人会失误粗心,但是程序不会~~~</p>
<p>这是实实在在的,很多时候的bug可能只是因为一个关键字和变量大小写的写错,找了一个上午才发现,TM原来是写错了一个大小写!!!!</p>
<hr/>
<h3 data-id="heading-10">四、全面拥抱AI吧!</h3>
<p><strong>AI是真的实实在在提高了普通人的上限</strong>，只要你善于利用AI，很多事情都能迎刃而解。</p>
<p>但时代也会抛下每一个远离AI的人。大厂已经在全面拥抱AI——例如贝壳就大面积裁员，背后原因是通过AI提升了效率，减少了劳动力雇佣。（这不是贩卖焦虑，而是正在发生的现实）</p>
<p>利用AI进行编程语言入门的学习门槛比以往低得多，利用AI进行编程问题的解答比以往更快捷。类似Cursor、Windsurf、Augment Code、Qoder、Trae等编程AI IDE的出现，让编程变得如鱼得水。</p>
<p><strong>放下偏见吧！全面拥抱AI，才是这个时代开发者的正确选择。</strong></p>
<hr/>
<h3 data-id="heading-11">五、AI时代的开发者：</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50aba32afe19492487ffb271d50b38ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5YWF5ruh5q2j6IO96YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767170181&amp;x-signature=KaB8LxAymARVBREIq%2FOM950bGeA%3D" alt="ai coding.png" loading="lazy"/></p>
<p>上面开个玩笑（🤣），但我认真觉得AI时代的开发者，面临的挑战是巨大的，比任何时候都更具挑战性。</p>
<h4 data-id="heading-12">5.1 要 提高能力</h4>
<p><strong>AI时代的开发者应该是：</strong></p>
<blockquote>
<p><strong>通过AI去学习成为全栈开发者，以一个工程师的身份去命令AI干活，同时具备沟通和理解需求能力的人。</strong></p>
</blockquote>
<p>为什么强调全栈？因为AI能力的出众和编程效率的巨大提升，意味着同样的时间你需要做更多的活——毕竟这是一个效率为王的时代（🐮🐴只能为了生存去适应时代）。</p>
<h4 data-id="heading-13">5.2 核心能力</h4>
<p>你不需要精通所有技术，但你需要<strong>知道</strong>这些知识的存在。只有在了解的基础上，你才能和AI有效对话，将开发任务最具效率地完成。</p>
<p>同时，你需要深入理解需求——在AI时代，你需要通过聊天去解决问题。聊天完成开发任务、聊天调试程序和修改Bug，这都需要实实在在的理解需求作为基础。</p>
<p><strong>AI是能力放大器。如果你有足够的知识广度，AI能助你披风斩浪。</strong></p>
<hr/>
<h3 data-id="heading-14">六、工具推荐（附录）</h3>
<h4 data-id="heading-15">6.1 AI IDE工具</h4>

















<table><thead><tr><th>类型</th><th>代表产品</th></tr></thead><tbody><tr><td>国产</td><td>Trae / Qoder / CodeBuddy</td></tr><tr><td>国外</td><td>Cursor / Windsurf / Augment Code</td></tr></tbody></table>
<p>坦率地说，国产IDE和Cursor/Windsurf/Augment Code等还有一定差距，主要原因在于AI大模型能力和Agent调教上。</p>
<p>希望未来国产大模型（如GLM、Minimax M2、Kimi K2）不止在跑分上跑赢Claude/GPT，在体验上也能超越，为开发者提供好用便宜的大模型。</p>
<h4 data-id="heading-16">6.2 CLI命令行工具</h4>
<blockquote>
<p>以下我都是通过中转站,付费使用的;</p>
</blockquote>
<p>命令行工具可能相对于IDE来说没那么直接,缺少了界面的直接,但是Claude Cli(俗称CC)能接入国产大模型(glm/kimi k2/Minimax M2),不限制与IDE;但是需要配合git做代码review和回退;</p>





















<table><thead><tr><th>工具</th><th>特点</th></tr></thead><tbody><tr><td><strong>Claude CLI</strong></td><td>神一般的存在，目前T0无疑（但是这个公司不好评,反华,科技有国界在这家公司表现的淋漓尽致,但是奈何它在AI Coding的统治级地位无人能撼动,希望早一日国产AI的模型能在除了跑分上干过claude,给我们通过低价高质的模型）</td></tr><tr><td><strong>Codex</strong></td><td>其实就是GPT,比Claude CLI弱一点，但干活勤奋，完成率高，速度慢但更便宜</td></tr><tr><td><strong>Gemini CLI</strong></td><td>谷歌产品，Gemini 3 pro在前端页面审美上绝对是T0级别</td></tr></tbody></table>
<h4 data-id="heading-17">6.3 我的工作思路</h4>
<ol start="0">
<li><strong>重要功能和复杂功能</strong>：Codex / Claude CLI</li>
<li><strong>简单功能</strong>：国产Trae等IDE（需要把提示词写清楚一点,国产大模型,如果提示词写得差没那么卖力干活）</li>
</ol>
<p><strong>建议</strong>：先通过Trae等国产IDE去接触AI Coding的便利，虽然能力不如Claude加持的IDE出众，但在相对简单的任务上也能给开发带来许多便利。(主要免费)</p>
<hr/>
<h3 data-id="heading-18">结语:</h3>
<h6 data-id="heading-19">未来开发工程师可能要叫AI调教师~~~</h6>
<blockquote>
<p>有友说应该叫做,AI鼓励师 哈哈~~~~</p>
</blockquote>
<p>AI 时代，对开发者来说是无比幸运的。</p>
<p>它能在你知识储备够的情况下，提高你作为人的下限,比过去任何工具都能更直接地提升工作效率——你只需要对话就能进行开发。</p>
<p><strong>放下偏见，全面拥抱AI吧！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[快手12·22事故原因的合理猜测]]></title>    <link>https://juejin.cn/post/7587021119254495259</link>    <guid>https://juejin.cn/post/7587021119254495259</guid>    <pubDate>2025-12-24T06:59:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587021119254495259" data-draft-id="7586971532700123145" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="快手12·22事故原因的合理猜测"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2025-12-24T06:59:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            快手12·22事故原因的合理猜测
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:59:54.000Z" title="Wed Dec 24 2025 06:59:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>终于到了自己擅长的领域，就随便写写图一乐吧</p>
<p>先简单介绍下自己，到目前在大厂做了三年半的安全产品，做了两年直播内容安全产品，对风险防控算是有所了解</p>
<p>风险防控的基本流程算是三步走，定标准，依据标准识别风险，对风险内容&amp;账户进行处罚</p>
<p>其中风险识别的流程绝大多数场景是先过一遍机器审核，机器判断不了的再过一遍人工审核</p>
<p>在内容安全里面，直播比较特别的一点是，直播很难做到先审后发，都是先发后审，就是你直播过程中，发现你可能存在风险行为，再召回进行审核，所以一但出现风险内容，线上用户是可以直接看到的，不存在说先审核内容再让你直播；这也是为什么这次风险集中在直播爆发，短视频存在先审核再发布的机制，可以规避上述风险</p>
<p>在这次的事件里面，怀疑有以下三种可能</p>
<p>1.黑产在夜间，人工审核人力较为不足的节点，通过预先识别好的方案，绕开机器审核，大量进行违规内容的直播，这个时候，由于业务低峰期，人工审核较为不足，加上上述直播场景不能先审后发，就导致线上出现大量风险内容没有人工审核，造成风险外溢</p>
<p>2.黑产攻击了下发处罚的接口，导致无法对违规内容和账号进行处罚，进而导致风险外溢</p>
<p>3.并非黑产主动攻击，而是因为风险内容暴增，导致处罚接口性能出现问题，导致无法处罚</p>
<p>以上三种可能里面，我更倾向于第二种，因为昨天外溢的风险内容是多样的，有色情，也有血腥暴力，不同风险类型会有不同的识别算法和模型，黑产很难同时突破多个防线，要想同时几种风险内容都出现在线上，最大的可能就是处罚出问题了，而故障持续时间这么长，结合今天快手突然开始大量招聘网络安全工程师，我会更加怀疑是内部系统被攻击了</p>
<p>那有什么方法可以尽可能减少这种风险呢，我们风险防控会分为三步走，事前事中事后，然后可以针对四类主体做管控（自然人，设备，账号，内容），在这个场景里面，其实我们事前可以做很多，最直接的就是识别到容易发布不良内容的风险账户，前置不允许直播或者提升开播门槛；举几个例子，我们可以要求注册x天内账户开播前必须人脸认证，也可以回收x天不活跃账户的直播权限，必须在平台有一定的活跃行为后才允许直播，也可以识别客户端行为，检测到录播的中断直播/减少推流；本质上增加黑产的作恶成本，就能解决绝大多数黑产问题，因为黑产也不是傻子，不会亏钱，让他们作恶成本变大，赚不到钱，自然就不会作恶了；在事前能做的管控其实很多，不要什么都留到事中来做，事中对系统性能和时效要求就非常高了</p>
<p>当然，放在事前来做会有一个问题，就是一定会有人因为你对他进行直播拦截了，就不直播了，肯定会对业务核心数据有少许影响，那到底是保风险还是保KPI，那就仁者见仁智者见智了</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析分布式事务3PC：解决2PC痛点的进阶方案]]></title>    <link>https://juejin.cn/post/7587253759091228708</link>    <guid>https://juejin.cn/post/7587253759091228708</guid>    <pubDate>2025-12-24T08:29:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587253759091228708" data-draft-id="7587046913692434438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析分布式事务3PC：解决2PC痛点的进阶方案"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-12-24T08:29:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析分布式事务3PC：解决2PC痛点的进阶方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:29:29.000Z" title="Wed Dec 24 2025 08:29:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深度解析分布式事务3PC：解决2PC痛点的进阶方案</h2>
<p>在分布式事务领域，2PC（两阶段提交）作为经典的强一致性方案，凭借简单可靠的特性被广泛应用，但它的“阻塞问题”和“协调者单点故障风险”始终是高可用场景下的致命短板——一旦协调者崩溃或网络分区，参与者会因持有资源锁陷入无限等待，严重影响系统可用性。为了缓解这些痛点，3PC（Three-Phase Commit，三阶段提交）应运而生。今天，我们就来全面剖析3PC的设计思路、核心流程、改进点与局限性，搞懂它如何优化2PC，又为何未能成为“终极方案”。</p>
<h3 data-id="heading-1">一、回顾：2PC的核心痛点，3PC的诞生背景</h3>
<p>在深入3PC之前，我们先快速回顾2PC的核心痛点，这是理解3PC设计初衷的关键：</p>
<ul>
<li><strong>严重阻塞问题</strong>：准备阶段后，若协调者崩溃或与参与者网络中断，参与者会一直持有资源锁等待最终指令（提交/回滚），导致事务阻塞，甚至引发资源死锁；</li>
<li><strong>协调者单点依赖</strong>：协调者是整个事务的核心，一旦单点故障且无法恢复，所有参与者将陷入无限等待；</li>
<li><strong>脑裂风险残留</strong>：若协调者在发送提交指令时发生网络分区，部分参与者执行提交、部分未收到指令，可能导致数据不一致。</li>
</ul>
<p>3PC的核心设计目标就是<strong>减少阻塞时间、降低协调者单点故障的影响</strong>。它在2PC的“准备-提交”两阶段基础上，新增了一个“预提交阶段”，并引入了“超时机制”，通过细化流程和增加容错设计，优化2PC的致命缺陷。</p>
<h3 data-id="heading-2">二、3PC核心定义：三阶段提交的核心逻辑</h3>
<p>3PC依然是“协调式”分布式事务方案，核心思路仍是通过“中心化协调者”统一管控所有参与者的事务状态，但将原本的“准备阶段”拆分为“CanCommit阶段”和“PreCommit阶段”，再加上最终的“DoCommit阶段”，形成三阶段流程。同时，3PC为协调者和参与者都增加了“超时机制”，从根本上解决了2PC的无限阻塞问题。</p>
<p>核心角色与2PC一致，保持职责延续性：</p>
<ol>
<li><strong>协调者（Coordinator）</strong> ：负责发起三阶段流程，接收参与者的状态反馈，决策全局事务的提交/回滚，并通知所有参与者执行最终操作；新增“超时处理逻辑”——超时后默认执行“回滚”或“提交”，避免阻塞。</li>
<li><strong>参与者（Participant）</strong> ：执行本地事务的相关操作，响应协调者的指令，反馈自身执行状态；同样新增“超时机制”——在特定阶段超时后自动执行预设操作（如PreCommit阶段超时后提交），无需无限等待。</li>
</ol>
<h3 data-id="heading-3">三、3PC完整流程拆解：三阶段层层递进，容错性升级</h3>
<p>我们仍以“跨库存服务和订单服务的用户下单”为例，拆解3PC的三阶段流程（协调者为分布式事务中间件，参与者1为库存数据库，参与者2为订单数据库），重点看每个阶段的核心目标和交互逻辑。</p>
<h4 data-id="heading-4">阶段1：CanCommit阶段——“探路阶段”：确认参与者是否具备执行能力</h4>
<p>这个阶段的核心目标是<strong>提前校验参与者的执行条件</strong>，避免2PC中“准备阶段执行预操作后才发现无法提交”的资源浪费，同时减少后续阶段的阻塞风险。具体步骤：</p>
<ol>
<li>协调者向所有参与者发送“CanCommit请求”，仅询问“是否具备执行事务的能力”（如资源是否充足、连接是否正常），不携带具体的事务执行指令；</li>
<li>每个参与者收到请求后，仅做“可行性校验”（不执行具体的事务操作，不锁资源）；</li>
<li>参与者反馈校验结果：① 若具备执行能力，返回“YES”；② 若不具备（如库存不足、连接失败），返回“NO”；</li>
<li>协调者接收所有参与者的反馈：① 若全部返回“YES”，进入下一阶段（PreCommit）；② 若任意一个返回“NO”或超时未收到反馈，直接向所有参与者发送“Abort请求”，事务终止。</li>
</ol>
<p>关键亮点：此阶段无资源锁定、无事务预执行，即使协调者或网络故障，也不会导致资源阻塞，极大降低了早期故障的影响。</p>
<h4 data-id="heading-5">阶段2：PreCommit阶段——“预提交阶段”：执行预操作，确认事务可行性</h4>
<p>这个阶段相当于2PC的“准备阶段”，核心目标是<strong>执行本地事务预操作并持久化日志</strong>，确保参与者具备“提交事务”的最终条件，但不真正提交。同时，此阶段引入超时机制，优化阻塞问题。具体步骤：</p>
<ol>
<li>协调者向所有参与者发送“PreCommit请求”，并附带具体的事务执行指令（如“扣减库存”“创建订单”的SQL）；</li>
<li>参与者收到请求后，执行本地事务的预操作（如扣减库存、创建订单），并将undo log（回滚日志）和redo log（重做日志）持久化到本地存储（确保崩溃后可恢复）；</li>
<li>参与者完成预操作后，释放部分非核心资源（仅保留必要的提交/回滚资源），并向协调者反馈“PreCommit成功”；若预操作失败，直接返回“PreCommit失败”；</li>
<li>协调者接收反馈并处理：① 若全部参与者返回“PreCommit成功”，进入下一阶段（DoCommit）；② 若任意一个返回“失败”或超时未收到反馈，向所有参与者发送“Rollback请求”，参与者根据undo log回滚数据，事务终止；</li>
<li>参与者超时处理：若参与者在PreCommit阶段未收到协调者的下一步指令（DoCommit/Rollback），超时后<strong>默认执行“提交”操作</strong>（核心容错设计，避免无限阻塞）。</li>
</ol>
<h4 data-id="heading-6">阶段3：DoCommit阶段——“最终提交阶段”：全局决策，执行最终操作</h4>
<p>这个阶段的核心目标是<strong>根据前两阶段的结果，执行全局提交或回滚</strong>，是事务的最终收尾阶段。具体步骤分两种情况：</p>
<h5 data-id="heading-7">情况1：所有参与者PreCommit成功——执行全局提交</h5>
<ol>
<li>协调者向所有参与者发送“DoCommit请求”，指令执行最终提交；</li>
<li>参与者收到请求后，执行本地事务的最终提交操作（将预执行的数据确认生效），释放所有持有的资源锁；</li>
<li>参与者提交完成后，向协调者反馈“DoCommit成功”；</li>
<li>协调者收到所有成功反馈后，标记全局事务“提交完成”，流程结束。</li>
</ol>
<h5 data-id="heading-8">情况2：任意参与者PreCommit失败或超时——执行全局回滚</h5>
<ol>
<li>协调者向所有参与者发送“Rollback请求”，指令执行回滚；</li>
<li>参与者收到请求后，根据之前持久化的undo log，执行本地事务回滚，恢复数据到预执行前的状态，释放所有资源锁；</li>
<li>参与者回滚完成后，向协调者反馈“Rollback成功”；</li>
<li>协调者收到所有回滚反馈后，标记全局事务“回滚完成”，流程结束；</li>
<li>协调者超时处理：若协调者在发送DoCommit请求后超时未收到反馈，默认认为参与者已成功提交（因参与者PreCommit超时后会自动提交），无需额外处理。</li>
</ol>
<h3 data-id="heading-9">四、3PC vs 2PC：核心改进点在哪里？</h3>
<p>对比2PC，3PC的改进集中在“解决阻塞问题”和“提升容错性”，核心改进点有3个：</p>
<ul>
<li><strong>拆分准备阶段，降低早期资源浪费</strong>：将2PC的“准备阶段”拆分为“CanCommit（探路）”和“PreCommit（预提交）”，CanCommit阶段仅做可行性校验，不执行事务、不锁资源，即使早期失败，也不会造成资源占用和阻塞；</li>
<li><strong>引入超时机制，彻底解决无限阻塞</strong>：3PC为协调者和参与者都增加了超时处理逻辑——参与者在PreCommit阶段超时后默认提交，协调者在关键阶段超时后默认确认提交/回滚，从根本上避免了2PC中“无限等待”的阻塞问题；</li>
<li><strong>减少资源锁定时间</strong>：PreCommit阶段完成后，参与者会释放部分非核心资源，仅保留必要的提交/回滚资源，降低了资源锁的持有时间，提升了系统并发度。</li>
</ul>
<h3 data-id="heading-10">五、3PC的局限性：并非完美的“终极方案”</h3>
<p>尽管3PC优化了2PC的核心痛点，但它并非完美，仍存在一些局限性，这也是它未能完全替代2PC的原因：</p>
<ul>
<li><strong>实现复杂度大幅提升</strong>：三阶段流程、超时机制的引入，使得协调者和参与者的状态管理、异常处理逻辑远比2PC复杂（如多阶段的状态同步、超时场景的兼容），开发和维护成本更高；</li>
<li><strong>脑裂风险依然存在（未完全解决）</strong> ：这是3PC最核心的局限。假设在DoCommit阶段，协调者发送“Rollback请求”时发生网络分区：部分参与者收到请求执行回滚，另一部分未收到请求，因PreCommit阶段超时后默认提交，最终导致部分节点提交、部分节点回滚，数据不一致；</li>
<li><strong>性能开销未显著降低</strong>：3PC比2PC多了一轮网络交互（CanCommit阶段的请求-反馈），网络延迟依然存在；同时，PreCommit阶段的日志持久化、状态同步等操作，也增加了额外的性能开销，不适合超高并发场景；</li>
<li><strong>协调者单点问题仍未根治</strong>：虽然超时机制缓解了阻塞，但协调者仍是核心节点——若协调者在PreCommit阶段后崩溃，参与者需等待超时才能自动提交，这段时间内数据仍处于“不确定状态”，可能影响业务可用性。</li>
</ul>
<h3 data-id="heading-11">六、3PC的适用场景与方案选型建议</h3>
<p>基于3PC的特性，它的适用场景相对小众，需满足“强一致性优先、可接受一定复杂度、对阻塞容忍度低”的条件：</p>
<p><strong>适用场景</strong>：金融交易、核心订单等对数据一致性要求极高，且无法接受2PC无限阻塞的场景；网络环境相对稳定（降低脑裂概率），并发量中等的分布式系统。例如，银行跨账户转账业务，既需要强一致性，又需避免因阻塞导致的资金冻结问题，可考虑3PC。</p>
<p><strong>不适用场景</strong>：① 超高并发场景（性能开销无法承受）；② 网络环境不稳定的分布式系统（脑裂风险升高）；③ 追求开发简单、低维护成本的业务（3PC复杂度过高）。</p>
<p><strong>方案选型对比</strong>：</p>
<ul>
<li>若追求“简单可靠”，并发量低、网络稳定：选2PC（如MySQL XA事务）；</li>
<li>若追求“强一致性+低阻塞”，可接受复杂度：选3PC；</li>
<li>若追求“高并发+高可用”，可接受最终一致性：选TCC、SAGA、本地消息表+MQ等柔性事务方案。</li>
</ul>
<h3 data-id="heading-12">七、总结：3PC的核心价值与现实意义</h3>
<p>3PC作为2PC的进阶方案，核心价值在于“通过三阶段拆分和超时机制，缓解了2PC的无限阻塞问题”，是分布式事务领域“强一致性方案”的重要优化尝试。但它并未解决所有问题——脑裂风险残留、实现复杂度高、性能开销大等局限性，决定了它无法成为“通用方案”。</p>
<p>从技术演进的角度看，3PC的意义更多在于“提供了容错设计的思路”（如超时机制、阶段拆分），为后续分布式事务方案（如柔性事务）提供了借鉴。在实际开发中，我们仍需遵循“业务优先”的原则：若强一致性是不可妥协的底线，且能接受3PC的复杂度，它是比2PC更优的选择；若可放宽一致性要求，柔性事务方案往往更适合高并发、高可用的分布式系统。</p>
<p>最后，再次强调分布式事务的核心原则：<strong>没有绝对完美的方案，只有适配业务的选择</strong>。理解每种方案的“一致性-可用性-复杂度”权衡，才能做出最合理的技术决策。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MasterGo AI 实战教程：10分钟生成网页设计图（附案例演示）]]></title>    <link>https://juejin.cn/post/7587028972245811235</link>    <guid>https://juejin.cn/post/7587028972245811235</guid>    <pubDate>2025-12-24T07:25:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587028972245811235" data-draft-id="7587243886432616482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MasterGo AI 实战教程：10分钟生成网页设计图（附案例演示）"/> <meta itemprop="keywords" content="前端,视觉设计,AIGC"/> <meta itemprop="datePublished" content="2025-12-24T07:25:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="编程干货铺"/> <meta itemprop="url" content="https://juejin.cn/user/52383084474680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MasterGo AI 实战教程：10分钟生成网页设计图（附案例演示）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/52383084474680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    编程干货铺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:25:04.000Z" title="Wed Dec 24 2025 07:25:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0"/>
<blockquote>
<p>一款能让你 <strong>写一句话，自动生成 UI 页面</strong> 的工具，你用过吗？本文带你从 0 上手 MasterGo AI，快速生成网页 / APP / 后台管理系统等高保真设计稿，全程 AI 一键完成，适合产品、设计、开发快速原型沟通！</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">🧩什么是 MasterGo AI？</h2>
<p><strong>MasterGo</strong> 是一款国产在线 UI 设计工具，类似 Figma，但更轻便、学习门槛低。其 AI 功能支持：</p>
<ul>
<li>一句话生成高保真 UI 页面</li>
<li>支持移动端、网页、后台等多种场景</li>
<li>输入产品描述、上传原型图、修改颜色风格等参数</li>
<li>支持自动生成 Vue/React 框架代码（适配常用组件库）</li>
</ul>
<hr/>
<h2 data-id="heading-2">🛠️使用步骤概览</h2>
<h2 data-id="heading-3"/>
<h3 data-id="heading-4">✅ 第一步：新建设计文件</h3>
<ul>
<li>登录 MasterGo 官网，点击右上角【新建文件】</li>
<li>进入空白设计画布<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfc8e4a5c993461da1147ae643c52487~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=l3GJjrXVXqFyH7dDGcNlm1uncYY%3D" alt="新建文件" loading="lazy"/></li>
</ul>
<hr/>
<h3 data-id="heading-5">✅ 第二步：启用 AI 生成界面功能</h3>
<ul>
<li>点击上方工具栏中的【AI 图标】</li>
<li>选择“AI 生成界面”，进入 AI 输入页<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6f18d422e0c47d4b12cca863e3c1e29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=2FMUXKO%2FQpVWNdc0bGccgdSSsZU%3D" alt="启用 AI 生成界面" loading="lazy"/></li>
</ul>
<hr/>
<h3 data-id="heading-6">✅ 第三步：输入产品描述</h3>
<p>在输入框中描述你想要的页面内容，比如：</p>
<ul>
<li>页面类型：移动端 / 网页 / 后台</li>
<li>页面结构：导航栏、轮播图、商品列表等</li>
<li>页面风格：颜色、圆角、字体大小、明暗模式等</li>
<li><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a33a7c06867e41d4821fcfd25835369b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=OT3qApK5iB5K5gXi6P2WkuoGjnk%3D" alt="输入描述" loading="lazy"/></li>
</ul>
<hr/>
<h2 data-id="heading-7">🎯实战案例：快速生成健身电商 APP 页面</h2>
<h3 data-id="heading-8">🧾 描述输入如下：</h3>
<pre><code class="hljs">设计一个售卖健身器材的APP：首页包含搜索栏、轮播图、分类导航（跑步机、哑铃等），展示热门产品（含图片、名称、价格、评分、加入购物车按钮），底部有四个导航图标：首页、分类、购物车、我的。
</code></pre>
<ul>
<li>主题色设置为 <code>#FA2549</code></li>
<li>回车后，等待 10 秒左右 AI 生成页面结构</li>
<li>点击“开始生成”后自动完成界面设计<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1696509a04c43e68313d6ccf9f344fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=HZgTjpLMr6iH2B0Rdjef6kIaW2I%3D" alt="填写需求" loading="lazy"/></li>
</ul>
<h3 data-id="heading-9">✅ 生成效果展示（首页 UI）</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/908a5f1427004bdc93dd09e0389cb232~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=NtwMjnqfxoK7LS2Cbhlec1Tsv88%3D" alt="APP首页效果图" loading="lazy"/></p>
<ul>
<li>若有细节不满意，可输入 “文字放大1.5倍”、“优化组件间距”等进行调整</li>
<li>点击“插入到画布”，进入可编辑设计图层</li>
</ul>
<hr/>
<h3 data-id="heading-10">✨生成商品详情页</h3>
<p>复制上一页，输入：</p>
<pre><code class="hljs">生成跑步机商品详情页，包含商品图、价格、评分、详情介绍、购买按钮等
</code></pre>
<p>即刻生成新页面：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71b837dbece442b6992e2c03a50c6988~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=MxGjyRuuaHdpSTirmLwSAgRcjr8%3D" alt="商品详情页" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-11"/>
<h2 data-id="heading-12">🖥️后台管理系统：生成健身器材后台</h2>
<p>描述示例：</p>
<pre><code class="hljs">健身器材后台：包含登录页、订单管理（搜索、筛选）、产品管理、销售统计看板
</code></pre>
<p>页面效果如下：</p>
<ul>
<li>✅ 订单管理模块<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e2b53673fd14dfd96ddd7f668b7e9c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=lE9%2BH6P3tV490vIRbS6u3a7TLDo%3D" alt="订单管理模块" loading="lazy"/></li>
<li>✅ 可添加弹窗功能，如“新建订单”<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8557a22d13ff4921bc52bc8959518dfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=X8WRhi4dOPgcXG1%2FoqewDuZ0tE8%3D" alt="弹窗功能" loading="lazy"/></li>
<li>✅ 生成销售数据看板<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ada06cb84e74fc084438937d90f4549~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=l%2FexO4wr7uYKJ03xjJxPCRT8wi8%3D" alt="销售数据看板" loading="lazy"/></li>
</ul>
<hr/>
<h2 data-id="heading-13">🧾上传原型图自动生成 UI</h2>
<p>你还可以上传草图/白板图，AI 自动还原成设计图！</p>
<p>👇 上传一张新闻网站原型图<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49dd75d3dcaf42d0bc488e101970eecb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=IN66Q7tSl6S%2BBCXK0sQMcNdh9vQ%3D" alt="上传原型图" loading="lazy"/></p>
<p>🔧 输入提示：</p>
<pre><code class="hljs">根据上图生成新闻网站首页，包含导航栏、新闻分类、头条推荐、搜索功能等。
</code></pre>
<p>✅ 最终效果图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bb770d5028c44e5be5cb08c72886e68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=zKPI%2Fp8bSiTKq3kPXjmIa2nT0e4%3D" alt="生成新闻首页" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-14">🌟多模态AI项目 UI 快速生成</h2>
<p>除了通用网页，你还可以用它设计<strong>生产级 AI 应用平台</strong>，如：</p>
<h3 data-id="heading-15">✅ 笔记管理模块界面</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d69254aff0f5402ca30e5692565820db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=8AlaZ1BAtgKqzwhchwZEjGhd%2F%2BY%3D" alt="多模态AI项目-笔记模块" loading="lazy"/></p>
<h3 data-id="heading-16">✅ 聊天管理模块界面</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c96fcf8cb4134cccbeb8ff32abff6645~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=K%2FvjP3tfpaA35QPkUe0OZHRwPnA%3D" alt="多模态AI项目-聊天模块" loading="lazy"/></p>
<p>✅ AI 绘画模块界面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e786dcc23ce4048823664960c7b4c6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=qF8I4bxtatDhYv4xcKDt1fTPmJU%3D" alt="" loading="lazy"/></p>
<p>🎯 从产品思路 → 页面原型 → 界面设计 → 代码输出，<strong>全流程 AI 帮你搞定</strong></p>
<h2 data-id="heading-17">✨更多扩展能力</h2>
<h3 data-id="heading-18">✅ 英文输入 → 生成英文页面</h3>
<p>直接输入英文描述，自动生成英文 UI（可配合海外产品原型）</p>
<h3 data-id="heading-19">✅ 一键生成前端框架代码</h3>
<ul>
<li>支持 Vue / React</li>
<li>可选组件库（Element Plus、AntD 等）</li>
<li>自动生成页面结构代码，点击可复制<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9148b9d674cd4294bd63f8de6508a5a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=ZB%2F9HU3KGnNbUgiSqJwihK3J2t4%3D" alt="代码生成功能" loading="lazy"/></li>
</ul>
<hr/>
<h2 data-id="heading-20">📌总结</h2>
<p>MasterGo AI 不仅是设计工具，更是一个面向 <strong>产品/设计/开发全链路协作</strong> 的高效原型工具。你只需要提供一句话描述，就能生成设计图、代码，快速验证想法、推进开发。</p>
<p>✅ 支持多端页面自动生成✅ 支持原型图上传自动识别✅ 支持代码导出与团队协作</p>
<p><strong>绘制下面的UI 界面的结构拆解与组件关系示意图</strong> ，还需要熟悉这款设计软件的基础操作</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b3adfed092f4bc091af155943f4f737~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57yW56iL5bmy6LSn6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165904&amp;x-signature=Okjf6Alja3a247Rw6kHUh6ioIqY%3D" alt="设计图（带二维码）.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[年终总结的意义，不是回顾过去，而是看见正在成为的自己]]></title>    <link>https://juejin.cn/post/7587062584165056550</link>    <guid>https://juejin.cn/post/7587062584165056550</guid>    <pubDate>2025-12-24T08:38:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587062584165056550" data-draft-id="7586983243926700070" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="年终总结的意义，不是回顾过去，而是看见正在成为的自己"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-24T08:38:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            年终总结的意义，不是回顾过去，而是看见正在成为的自己
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:38:38.000Z" title="Wed Dec 24 2025 08:38:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">年终总结的意义，不是回顾过去，而是看见“正在成为的自己”</h2>
<p>摘要：本文通过流行的年终总结开始，说明了变化的显化给人的震撼，以及坚持长期主义的意义和价值。通过量化记录自己的变化，可以更容易看的见自己的变化，通过定期复盘可以找到下一轮的出发方向，成为更好的自己。</p>
<p>每到12月，朋友圈、社交平台便悄然进入“年终总结季”。有人晒出年度书单，有人复盘工作项目，有人用一张信息图展示365天的足迹、睡眠、运动数据……</p>
<p>这些总结看起来是回望过去，但真正打动人的，从来不是“做了什么”，而是——<strong>原来我早已在不知不觉中，变成了另一个自己</strong>。</p>
<h3 data-id="heading-1">一、那些看不见的变化，其实一直在发生</h3>
<p>你有没有这样的体验？<br/>
每天读几页书、写一段日记、早睡半小时、对同事多一点耐心……这些事单独看，微不足道，甚至感觉“毫无变化”。</p>
<p>可一年后回头，你突然发现：</p>
<ul>
<li>自己能安静读完一本哲学书了；</li>
<li>遇到冲突时不再本能地情绪爆发；</li>
<li>身体状态比三年前好得多；</li>
<li>甚至只是“坚持记录”这件事本身，就让你更了解自己。</li>
</ul>
<p><strong>短期的变化很慢，慢到肉眼看不见；但长期的积累很快，快到让人惊讶。</strong><br/>
这就是时间的魔法——它不声不响，却在你坚持的方向上，悄悄堆起一座山。</p>
<h3 data-id="heading-2">二、长期主义，带来的是“不可逆”的成长</h3>
<p>真正的成长，往往不是某个高光时刻的顿悟，而是日复一日微小选择的总和。<br/>
它不依赖灵感，不靠运气，只取决于两件事：</p>
<ol>
<li><strong>方向是否正确</strong>（你在做的事，是否指向你想成为的人）；</li>
<li><strong>是否持续行动</strong>（哪怕每天只做一点点）。</li>
</ol>
<p>一旦跨过某个临界点，改变就不再是“努力的结果”，而成了你的一部分——<br/>
比如流利的外语、稳定的作息、深度思考的习惯……这些能力一旦内化，几乎无法“退回去”。</p>
<p><strong>长期主义带来的，是一种不可逆的进化。</strong></p>
<h3 data-id="heading-3">三、别等到年底才“恍然大悟”：量化让成长提前可见</h3>
<p>很多人依赖年终总结，是因为平时感受不到进展。</p>
<p>但问题在于：<strong>如果你只能在年底看到变化，那这一年你就一直处于“黑箱”中——不确定、焦虑、容易放弃。</strong></p>
<p>解决方法很简单：<strong>量化</strong>。</p>
<p>不需要复杂系统，只需一点点记录：</p>
<ul>
<li>每周读了几小时书？</li>
<li>这个月有几天情绪稳定？</li>
<li>连续多少天完成了核心任务？</li>
</ul>
<p>这些数字不是为了“打卡炫耀”，而是为了<strong>缩短“行动”和“感知”之间的时间差</strong>。<br/>
当你每周都能看到趋势，你就不再需要等到12月31日才惊讶地说：“啊，我居然做到了！”<br/>
而是早在春天就笃定：“照这样下去，年底的我会感谢现在的我。”</p>
<h3 data-id="heading-4">四、真正的成长，始于一个简单的习惯：定期记录与复盘</h3>
<p>但无论是长期主义，还是量化反馈，要真正发挥作用，都需要一个<strong>底层支撑</strong>——<br/>
那就是：<strong>养成定期记录与总结的习惯</strong>。</p>
<p>这个习惯不必宏大。它可以是：</p>
<ul>
<li>每晚睡前5分钟，写下“今天最有价值的一件事”；</li>
<li>每周日晚上花15分钟，回顾目标完成情况；</li>
<li>每月末用一张表格，记录关键指标的变化。</li>
</ul>
<p><strong>记录，是把流动的时间变成可触摸的证据；  复盘，是把模糊的感受转化为清晰的认知。</strong></p>
<p>更重要的是，这个习惯本身就会重塑你的思维模式——</p>
<p>你会从“被动经历生活”，转向“主动设计人生”。</p>
<p>你不再等待年底的“顿悟时刻”，因为<strong>每一个周期性的停顿，都是你校准方向、确认自我的锚点</strong>。</p>
<h3 data-id="heading-5">五、真正的年终总结，应该从第一天就开始</h3>
<p>所以，一份好的年终总结，不该是年末临时拼凑的“成果汇报”，而应是你全年成长系统的自然输出。</p>
<p>它背后是一个更强大的逻辑：</p>
<ul>
<li>
<p><strong>以始为终：尽早顶一个年度目标，月度目标，周目标，然后去努力实现。</strong></p>
</li>
<li>
<p><strong>用长期主义选择方向，用量化反馈照亮过程，用定期复盘固化习惯——让每一天的努力都被看见。</strong></p>
</li>
</ul>
<p>这样，你就不再被动等待“时间的惊喜”，而是主动参与自己的蜕变。</p>
<hr/>
<h4 data-id="heading-6">最后喝点鸡汤</h4>
<p>2025年即将结束，无论你是否写总结，都请记得：</p>
<p><strong>你不是在“完成一年”，而是在“成为一个人”。</strong></p>
<p>那些看似微不足道的坚持，终将在某一天连成一条清晰的路——通向你真正想成为的样子。</p>
<hr/>
<p><em>愿你在2026年，不必等到年底，就能对自己说：  “我知道我在变好，因为我每天都看得见。”</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LaTeX 工具选型指南：MiKTeX 与 TeX Live 全面对比]]></title>    <link>https://juejin.cn/post/7587024296885059634</link>    <guid>https://juejin.cn/post/7587024296885059634</guid>    <pubDate>2025-12-24T08:47:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587024296885059634" data-draft-id="7586983243926880294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LaTeX 工具选型指南：MiKTeX 与 TeX Live 全面对比"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-24T08:47:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LaTeX 工具选型指南：MiKTeX 与 TeX Live 全面对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:47:30.000Z" title="Wed Dec 24 2025 08:47:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LaTeX 工具选型指南：MiKTeX 与 TeX Live 全面对比</h2>
<p>之前写过一篇文章，怎么写markdown的，今天出一篇跟latex相关的。</p>
<p>过往的见：<a href="https://juejin.cn/post/7439202483992412210" target="_blank" title="https://juejin.cn/post/7439202483992412210">每日知识-markdown的简单教程序 掘金</a></p>
<p>LaTeX 作为学术界广泛使用的高质量排版系统，其强大功能依赖于完整的发行版（distribution）支持。目前，<strong>MiKTeX</strong> 和 <strong>TeX Live</strong> 是两大主流 LaTeX 发行版，它们提供了编译器、宏包、字体及辅助工具的完整生态。然而，二者在设计理念、安装策略、平台适配和维护方式上存在显著差异。本文将从多个维度对 MiKTeX 与 TeX Live 进行系统性对比，帮助用户根据自身需求做出合理选择。</p>
<hr/>
<h3 data-id="heading-1">一、核心概念：什么是 LaTeX 发行版？</h3>
<p>LaTeX 本身是一个宏包系统，需依赖底层 TeX 引擎（如 pdfTeX、XeTeX、LuaTeX）进行文档编译。而一个完整的 <strong>LaTeX 发行版</strong>包含：</p>
<ul>
<li>TeX/LaTeX 编译器</li>
<li>数千个宏包（如 <code>amsmath</code>、<code>graphicx</code>、<code>biblatex</code>）</li>
<li>字体支持（Type1、OpenType 等）</li>
<li>文档生成工具（BibTeX、MakeIndex）</li>
<li>包管理器与更新机制</li>
</ul>
<p>MiKTeX 和 TeX Live 正是这样的“一站式”解决方案。</p>
<hr/>
<h3 data-id="heading-2">二、安装策略：按需 vs 全量</h3>

























<table><thead><tr><th>特性</th><th><strong>MiKTeX</strong></th><th><strong>TeX Live</strong></th></tr></thead><tbody><tr><td>默认安装大小</td><td>~200 MB（最小安装）</td><td>~4–6 GB（完整安装）</td></tr><tr><td>宏包安装方式</td><td><strong>按需自动下载</strong>（"Install on the fly"）</td><td><strong>一次性全量安装</strong>（可选精简模式）</td></tr><tr><td>离线可用性</td><td>初次使用需联网；后续可缓存</td><td>完全离线可用（若选择完整安装）</td></tr></tbody></table>
<blockquote>
<p><strong>适用场景</strong>：</p>
<ul>
<li>若你网络稳定、硬盘空间有限，MiKTeX 的“用到再装”机制更高效；</li>
<li>若你在无网络环境（如实验室、飞机上）频繁写作，TeX Live 更可靠。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、平台支持与用户体验</h3>

























<table><thead><tr><th>平台</th><th><strong>MiKTeX</strong></th><th><strong>TeX Live</strong></th></tr></thead><tbody><tr><td><strong>Windows</strong></td><td>⭐ 原生优化，图形化安装向导，新手友好</td><td>支持良好，但配置稍复杂</td></tr><tr><td><strong>Linux</strong></td><td>可用，但非主流选择</td><td>⭐ 官方推荐；多数发行版（如 Ubuntu）通过 <code>texlive-full</code> 提供</td></tr><tr><td><strong>macOS</strong></td><td>支持</td><td>⭐ 通过 MacTeX（TeX Live 的 macOS 封装）提供最佳体验</td></tr></tbody></table>
<blockquote>
<p><strong>提示</strong>：在 Linux/macOS 生态中，TeX Live 几乎是默认标准；而在 Windows 上，MiKTeX 因其简洁性广受欢迎。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">四、更新与维护机制</h3>

























<table><thead><tr><th>维护维度</th><th><strong>MiKTeX</strong></th><th><strong>TeX Live</strong></th></tr></thead><tbody><tr><td>更新频率</td><td>持续更新，支持单个宏包升级</td><td><strong>年度发布制</strong>（如 TeX Live 2024），旧版本停止维护</td></tr><tr><td>更新工具</td><td>图形化包管理器 + 命令行 <code>mpm</code></td><td>命令行工具 <code>tlmgr</code>（功能强大，支持脚本自动化）</td></tr><tr><td>长期稳定性</td><td>可长期使用同一版本并持续更新</td><td>建议每年重装新版以保持兼容性</td></tr></tbody></table>
<blockquote>
<p><strong>注意</strong>：TeX Live 的年度模型确保了宏包集合的一致性，避免“半新半旧”导致的冲突，更适合协作项目。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">五、编译与开发工具集成</h3>
<p>虽然两者都支持 <code>pdflatex</code>、<code>xelatex</code>、<code>lualatex</code> 等主流引擎，但在高级构建工具上略有差异：</p>
<ul>
<li><strong>MiKTeX</strong> 自带 <code>texify</code>，无需 Perl 即可实现多轮编译；</li>
<li><strong>TeX Live</strong> 推荐使用 <code>latexmk</code>（需 Perl 环境），支持 <code>-pvc</code>（预览+自动重编译）等高级功能，被 Overleaf、VS Code LaTeX Workshop 等现代编辑器广泛采用。</li>
</ul>
<blockquote>
<p>对于自动化构建或 CI/CD 流程，<code>latexmk</code> 的灵活性使其成为专业用户的首选。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">六、社区与标准化</h3>
<ul>
<li><strong>TeX Live</strong> 由 <strong>TeX Users Group (TUG)</strong> 官方维护，文档权威，是 arXiv、期刊出版社等机构的标准环境。</li>
<li><strong>MiKTeX</strong> 由 Christian Schenk 独立开发，社区活跃，但非“官方”标准。</li>
</ul>
<blockquote>
<p>在投稿或团队协作中，使用 TeX Live 可最大程度避免“在我机器上能编译”的问题。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">七、选型建议总结</h3>



































<table><thead><tr><th>用户画像</th><th>推荐发行版</th><th>理由</th></tr></thead><tbody><tr><td><strong>Windows 初学者</strong></td><td>✅ MiKTeX</td><td>安装简单、自动装包、图形界面友好</td></tr><tr><td><strong>学术研究者 / 投稿作者</strong></td><td>✅ TeX Live</td><td>与出版标准一致，兼容性高</td></tr><tr><td><strong>Linux / macOS 用户</strong></td><td>✅ TeX Live（或 MacTeX）</td><td>系统集成好，社区支持强</td></tr><tr><td><strong>离线工作者</strong></td><td>✅ TeX Live（完整安装）</td><td>无需依赖网络</td></tr><tr><td><strong>轻量级用户 / 学生</strong></td><td>✅ MiKTeX</td><td>节省磁盘空间，快速上手</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">八、结语</h3>
<p>MiKTeX 与 TeX Live 并无绝对优劣，只有“更适合”。对于大多数 Windows 新手，MiKTeX 是理想的入门选择；而对于追求稳定性、跨平台一致性或参与学术出版的用户，TeX Live 则是更稳妥的长期方案。</p>
<p>无论选择哪一种，搭配现代编辑器（如 <strong>TeXstudio</strong>、<strong>VS Code + LaTeX Workshop</strong> 或在线平台 <strong>Overleaf</strong>），都能高效完成高质量文档排版。</p>
<blockquote>
<p>📌 <strong>小贴士</strong>：你甚至可以在同一台机器上同时安装两者（通过路径隔离），用于测试兼容性！</p>
</blockquote>
<hr/>
<p><strong>参考资源</strong>：</p>
<ul>
<li>MiKTeX 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmiktex.org%2F" target="_blank" title="https://miktex.org/" ref="nofollow noopener noreferrer">miktex.org/</a></li>
<li>TeX Live 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tug.org%2Ftexlive%2F" target="_blank" title="https://www.tug.org/texlive/" ref="nofollow noopener noreferrer">www.tug.org/texlive/</a></li>
<li>MacTeX（TeX Live for macOS）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tug.org%2Fmactex%2F" target="_blank" title="https://www.tug.org/mactex/" ref="nofollow noopener noreferrer">www.tug.org/mactex/</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1TB数据，ES却收到了2TB？揪出那个客户端中的“隐形复读机”]]></title>    <link>https://juejin.cn/post/7587017021314908195</link>    <guid>https://juejin.cn/post/7587017021314908195</guid>    <pubDate>2025-12-24T08:33:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587017021314908195" data-draft-id="7587243886433075234" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1TB数据，ES却收到了2TB？揪出那个客户端中的“隐形复读机”"/> <meta itemprop="keywords" content="大数据,Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-24T08:33:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1TB数据，ES却收到了2TB？揪出那个客户端中的“隐形复读机”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:33:56.000Z" title="Wed Dec 24 2025 08:33:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/4j6OJ5j4Ko8RJq3p/img/df19a5a0-8158-4e73-8381-5a6d52957ae2.png?x-oss-process=image/crop,x_0,y_0,w_2752,h_1503/ignore-error,1" alt="image.png" loading="lazy"/></p>
<p><strong>你是否经历过这样的“灵异事件”：</strong></p>
<p>业务监控显示，你的日志服务每秒只写入了 50MB 的数据，全天累计写入 1TB。</p>
<p>但在云厂商的账单，或者内网交换机的监控上，流量却高达 100MB/s，全天消耗了 2TB 的带宽。</p>
<p>网卡经常莫名其妙被打满，造成正常的业务请求卡顿、丢包。</p>
<p>排查了一圈：</p>
<ul>
<li>
<p>不是 TCP 重传（Retransmission 正常）。</p>
</li>
<li>
<p>不是 SSL 握手膨胀（HTTPS 开销没那么大）。</p>
</li>
<li>
<p>也不是监控系统算错了（交换机端口统计实打实的跑满了）。</p>
</li>
</ul>
<p>最后抓包一看，差点气晕过去：</p>
<p>你的客户端，为了把这 1TB 的数据发给服务端，实际上在网线上跑了 2TB 的量。</p>
<p>因为它每发一次数据之前，都要先“假装”发一次被拒，然后再“真”发一次。</p>
<p>今天，我们就来揭秘这吃光你带宽的“<strong>隐形复读机</strong>”——非抢先认证（Non-Preemptive Auth），并教你如何用更优雅的方式帮公司省下一半的流量费。</p>
<h2 data-id="heading-0">一、案发现场：带宽莫名其妙“爆”了</h2>
<p>故事发生在一个大数据量的日志写入场景。</p>
<ul>
<li>
<p><strong>业务侧</strong>：开发拍着胸脯说：“我算过了，每条日志 1KB，每秒 5万条，流量绝对只有 <strong>50MB/s</strong>，千兆网卡绰绰有余。”</p>
</li>
<li>
<p><strong>网络侧</strong>：运维看着监控大屏一脸懵逼：“大哥，网卡出口流量已经顶到 <strong>100MB/s</strong> 了，带宽利用率 100%，开始丢包了！”</p>
</li>
</ul>
<p>这凭空多出来的 50MB/s 是哪来的？</p>
<p>最离谱的是，客户端日志一切正常， ES 集群也一切正常，写入成功率 100%，仿佛只是默默地吞下了这双倍的流量。</p>
<h2 data-id="heading-1">二、传统排查：终端里的一眼定乾坤</h2>
<p>在自建环境中，要查清楚带宽去哪了，不需要复杂的分析工具，<strong>用 tcpdump 看一眼报文实体就真相大白了</strong>。</p>
<h3 data-id="heading-2"> 祭出 tcpdump（抓“实锤”）</h3>
<p>怀疑是重传？直接在生产环境抓取端口流量，并用 <code>-A</code> 参数打印包的内容：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">-A: 以 ASCII 打印包内容，能看到 HTTP Body</span>
<span class="hljs-meta prompt_"># </span><span class="bash">-s 0: 抓取完整包，防止截断 Body</span>
tcpdump -i eth0 port 9200 -A -s 0 -c 100 -w bandwidth_leak.pcap
</code></pre>
<p>当你打开抓包文件，你会看到令人崩溃的一幕：</p>
<p>每一个 POST 请求的 Body（业务数据），在网络上传输了两次！</p>
<ol>
<li>
<p><strong>第一次传输（无效）</strong>：</p>
<ul>
<li>
<p>Header: <code>POST /_bulk</code> (无 Auth 头)</p>
</li>
<li>
<p>Body: <code>{"index":{...}} ...</code> (<strong>5MB 的真实数据被发出去了！</strong>)</p>
</li>
<li>
<p>Response: <code>401 Unauthorized</code> (<strong>ES 拒收，但这 5MB 流量已经占用了带宽</strong>)</p>
</li>
</ul>
</li>
<li>
<p><strong>第二次传输（有效）</strong>：</p>
<ul>
<li>
<p>Header: <code>POST /_bulk</code> (带 Auth 头)</p>
</li>
<li>
<p>Body: <code>{"index":{...}} ...</code> (<strong>同样的 5MB 数据，又完整发了一遍</strong>)</p>
</li>
<li>
<p>Response: <code>200 OK</code></p>
</li>
</ul>
</li>
</ol>
<p><strong>结论：</strong> 你的客户端不仅是在“虚晃一枪”，它是“<strong>全量试探</strong>”——每次被拒之前，都先把沉甸甸的数据包完整地发一遍。<strong>带宽就是这么翻倍的。</strong></p>
<h3 data-id="heading-3">无法抓包？应用层也有“呈堂证供”</h3>
<p>如果你没有服务器的 root 权限无法运行 tcpdump，或者想从应用层进一步确认，日志也能提供确凿的证据。</p>
<ul>
<li>
<p><strong>搜查客户端日志</strong>：将客户端（如 Apache HttpClient）的日志级别调至 DEBUG。你会发现日志里充斥着 <code>Authentication required</code> —— 每一条成功的请求背后，都紧跟在一次失败的尝试之后。</p>
</li>
<li>
<p><strong>调阅服务端审计（高危）</strong>：临时开启 ES 的 Audit Log（警告：全量审计极其消耗性能，生产环境慎开）。你会看到同一个请求总是成对出现：先是 <code>access_denied</code>，紧接着才是 <code>access_granted</code>。</p>
</li>
</ul>
<h2 data-id="heading-4">三、深度解析：为什么客户端这么“傻”？</h2>
<p>为什么客户端不能先问问需不需要密码，非要先把数据扔过去被拒一次？</p>
<h3 data-id="heading-5">1. 默认行为的代价（RFC 的锅）</h3>
<p>老版本的 Java 客户端（Apache HttpClient 4.x 内核）和部分 Python 客户端，默认遵循 RFC 2617 的**“被动认证”**流程：</p>
<p>它假设服务器可能不需要密码。为了“兼容性”，它直接把请求（包含 Header 和 Body）发过去。</p>
<ul>
<li>
<p><strong>Round 1</strong>: 客户端发送 <strong>Header + Body (1GB)</strong>。</p>
</li>
<li>
<p><strong>Round 2</strong>: 服务端收到，发现没权限。<strong>丢弃收到的 1GB Body</strong>，返回 <code>401</code>，并在 Header 里喊话：“我要密码！”。</p>
</li>
<li>
<p><strong>Round 3</strong>: 客户端收到 401，发现需要密码。于是带上密码，<strong>重新发送 Header + Body (1GB)</strong>。</p>
</li>
<li>
<p><strong>Round 4</strong>: 服务端校验通过，接收数据。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/511c7e92b92f4ad7a56405db40bbdaa5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767170036&amp;x-signature=1bp7L%2Fqz7jeijuKh5HVz1NeXX9w%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">2. “带宽黑洞”的形成</h3>
<p>在内网 ES 这种必须鉴权的场景下，运气永远是不好的。</p>
<p>于是，逻辑变成了：</p>
<ul>
<li>
<p><strong>你要写 1GB 数据？</strong></p>
</li>
<li>
<p>系统实际传输：先发 1GB (被拒) + 再发 1GB (成功) = <strong>消耗 2GB 带宽</strong>。</p>
</li>
</ul>
<p>这不仅打爆了网卡，还浪费了 ES 的 HTTP 解析线程和 SSL 解密开销（如果是 HTTPS）。</p>
<h2 data-id="heading-7">四、解决方案：更优雅的“抢答模式”</h2>
<p>解决思路非常简单：<strong>不要试探，第一次请求就直接把“身份证”亮出来。</strong></p>
<h3 data-id="heading-8">1. Java 客户端</h3>
<h4 data-id="heading-9">场景 A：ES 8.x 新版 Java Client (官方推荐)</h4>
<p>如果你使用的是最新的 <code>co.elastic.clients</code>，虽然上层 API 变了，但底层依然依赖 <code>RestClient</code>。你需要确保在底层的 <code>RestClientBuilder</code> 中正确配置凭据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 准备凭据提供者</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">CredentialsProvider</span> <span class="hljs-variable">credentialsProvider</span> <span class="hljs-operator">=</span> 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicCredentialsProvider</span>();
credentialsProvider.setCredentials(AuthScope.ANY,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordCredentials</span>(<span class="hljs-string">"user"</span>, <span class="hljs-string">"password"</span>));

<span class="hljs-comment">// 2. 配置底层 RestClient</span>
<span class="hljs-type">RestClient</span> <span class="hljs-variable">restClient</span> <span class="hljs-operator">=</span> RestClient.builder(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHost</span>(<span class="hljs-string">"es-host"</span>, <span class="hljs-number">9200</span>))
    .setHttpClientConfigCallback(httpClientBuilder -&gt; 
        <span class="hljs-comment">// 关键点：注入默认凭据提供者</span>
        <span class="hljs-comment">// 这会激活 HttpClient 内部的 AuthCache，实现抢占式认证</span>
        httpClientBuilder
            .setDefaultCredentialsProvider(credentialsProvider)
    ).build();

<span class="hljs-comment">// 3. 构建 ES8 Client</span>
<span class="hljs-type">ElasticsearchTransport</span> <span class="hljs-variable">transport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestClientTransport</span>(
    restClient, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JacksonJsonpMapper</span>());
<span class="hljs-type">ElasticsearchClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ElasticsearchClient</span>(transport);


</code></pre>
<h4 data-id="heading-10">场景 B：老版本 RestHighLevelClient (维护模式)</h4>
<p>很多老系统还在用这个。务必检查是否禁用了缓存，或者忘记配置 <code>CredentialsProvider</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式一（优雅）：配置 CredentialsProvider（同上）</span>
<span class="hljs-comment">// 方式二（硬核）：直接焊死 Header，绝对不给 401 任何机会</span>

Header[ ] defaultHeaders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Header</span>[ ]{
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicHeader</span>(<span class="hljs-string">"Authorization"</span>,
    <span class="hljs-string">"Basic "</span> + Base64.getEncoder().encodeToString(<span class="hljs-string">"u:p"</span>.getBytes()))
};
<span class="hljs-type">RestClientBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> RestClient
    .builder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHost</span>(<span class="hljs-string">"es-host"</span>, <span class="hljs-number">9200</span>))
    .setDefaultHeaders(defaultHeaders); 
</code></pre>
<h3 data-id="heading-11">2. Python 客户端</h3>
<h4 data-id="heading-12">场景 A：Python Client v8 (官方推荐)</h4>
<p>在 v8 版本中，官方废弃了 <code>http_auth</code>，改用 <code>basic_auth</code>。使用标准写法时，<strong>默认就是抢占式的</strong>，无需额外操心。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> elasticsearch <span class="hljs-keyword">import</span> Elasticsearch

<span class="hljs-comment"># ✅ 官方推荐写法：使用 basic_auth</span>
<span class="hljs-comment"># 底层逻辑已优化，默认开启 Preemptive Auth，不会浪费带宽</span>
client = Elasticsearch(
    <span class="hljs-string">"http://es-host:9200"</span>,
    basic_auth=(<span class="hljs-string">"user"</span>, <span class="hljs-string">"password"</span>)
)
</code></pre>
<h4 data-id="heading-13">场景 B：手动注入 Header (全版本通用)</h4>
<p>如果你还在用老版本，或者不确定 SDK 内部行为，手动注入 Header 是最稳妥的。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> requests

<span class="hljs-comment"># 构造 Header</span>
token = base64.b64encode(<span class="hljs-string">b"user:password"</span>).decode(<span class="hljs-string">"ascii"</span>)
headers = { <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">f'Basic <span class="hljs-subst">{token}</span>'</span> }

<span class="hljs-comment"># 第一包数据就会带上 Auth，绝无浪费</span>
r = requests.post(url, data=big_payload, headers=headers)
</code></pre>
<h2 data-id="heading-14">💡 Pro Tips：鉴权最佳实践</h2>
<p>解决“401 试探”最彻底的方法是使用 <strong>API Key</strong>（它不受 Basic Auth 协议的“试探”逻辑束缚，天生就是抢占式的），但需要注意：</p>
<ul>
<li>
<p><strong>PaaS / 自建用户</strong>：强烈推荐使用 API Key 取代传统的账号密码。不仅性能更好，权限控制也更精细，<strong>安全性更高</strong>。</p>
</li>
<li>
<p><strong>Serverless 用户</strong>：目前 ES Serverless 暂不支持 API Key。请使用上述的 <strong>Basic Auth 抢占式配置方案</strong>（如 <code>basic_auth</code> 或 <code>CredentialsProvider</code>），同样可以完美解决带宽翻倍问题。</p>
</li>
</ul>
<h2 data-id="heading-15">五、Serverless 价值：从“黑盒抓瞎”到“上帝视角”</h2>
<p>看到这里，你可能会问：“原理我懂了，但我怎么知道我的系统里有没有藏着这个流量黑洞？总不能天天去生产环境抓包吧？”</p>
<p>这正是自建 ES 集群的痛点：你只看得到带宽爆了，却不知道是哪部分流量在搞鬼。</p>
<p>而在 阿里云 ES Serverless 中，这显而易见。</p>
<h3 data-id="heading-16">1. 状态码大盘：一眼定真伪</h3>
<p>Serverless 提供了基于网关层的全链路监控。你只需要点开控制台的“<strong>端到端请求指标</strong>”监控：</p>
<p>如果你看到 <strong>401 的曲线</strong> 和 <strong>200 的曲线</strong> 高度重合（甚至数量 <strong>1:1</strong>），如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfd2ccb316364a36baff1ca9ff53ffc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767170036&amp;x-signature=jsgscuZVk97%2F%2FUv%2B1WtAyhE9Ssw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>这就意味着：你每一字节的有效数据，都伴随着一字节的无效带宽消耗。</strong></p>
<h3 data-id="heading-17">2. 全量 Access Log：精准定责</h3>
<p>如果监控曲线异常，下一步就是找“谁干的”。 Serverless 的“**日志查询”**中可以直接查看每个请求的 <code>user_agent</code> 或 <code>remote_ip</code>。 瞬间就能找到是哪个开发团队干的，随后你就可以把截图甩给负责该业务的开发团队：“看，这 50% 的废流量都是你们服务发出来的。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99b135b592b746e69eccd1f84d38baa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767170036&amp;x-signature=plZsoD776Pdg9T3fPoO%2BCCyvStY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-18">结语</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ce67d43a53e4b3f9b6100bfbeef4137~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767170036&amp;x-signature=JaDjRI7I7GlU%2Bb6a0%2F2bPG3dkOo%3D" alt="image.png" loading="lazy"/></p>
<p><strong>只有看得见，才能省下来。</strong></p>
<p>带宽就是金钱，但看不见的浪费，才是最大的成本。别让你的预算消耗在毫无意义的“被动试探”上。</p>
<p>快去检查一下你的监控大盘：</p>
<ul>
<li>
<p><strong>流量是不是比业务量大一倍？</strong></p>
</li>
<li>
<p><strong>401 占比是不是 50%？</strong></p>
</li>
</ul>
<p>也许只需改一行配置，你的集群带宽压力就能瞬间减半，流量费立省 50%。</p>
<p>立即体验阿里云 ES Serverless，用端到端监控，让流量黑洞无处遁形！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[综合项目实践：可视化技术核心实现与应用优化]]></title>    <link>https://juejin.cn/post/7587208390482329606</link>    <guid>https://juejin.cn/post/7587208390482329606</guid>    <pubDate>2025-12-24T07:16:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587208390482329606" data-draft-id="7587008326481674282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="综合项目实践：可视化技术核心实现与应用优化"/> <meta itemprop="keywords" content="Canvas,WebGL,SVG"/> <meta itemprop="datePublished" content="2025-12-24T07:16:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Fronty"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            综合项目实践：可视化技术核心实现与应用优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Fronty
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:16:00.000Z" title="Wed Dec 24 2025 07:16:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>可视化技术已成为现代前端开发不可或缺的一部分，从简单的图表展示到复杂的交互式数据可视化，再到沉浸式的3D体验，前端可视化正在重新定义用户体验。本文将全面解析可视化技术的核心实现，涵盖Canvas绘图、SVG操作、拖拽交互、动画系统、数据可视化库以及WebGL 3D渲染，通过完整可运行的代码示例，帮助你从零构建完整的可视化解决方案。</p>
<h4 data-id="heading-1">1. Canvas绘图库基础</h4>
<h5 data-id="heading-2">1.1 Canvas核心API与封装</h5>
<p>Canvas是HTML5提供的位图绘图技术，适合处理大量图形元素和像素级操作。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Canvas绘图工具类封装</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CanvasDrawer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">canvasId, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(canvasId);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">alpha</span>: <span class="hljs-literal">true</span>,
      ...options
    };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shapes</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 设置高清Canvas</span>
    <span class="hljs-keyword">const</span> dpr = <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span> || <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> rect = <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-title function_">getBoundingClientRect</span>();
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span> = rect.<span class="hljs-property">width</span> * dpr;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">height</span> = rect.<span class="hljs-property">height</span> * dpr;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">scale</span>(dpr, dpr);
    
    <span class="hljs-comment">// 设置样式</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">lineJoin</span> = <span class="hljs-string">'round'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-property">lineCap</span> = <span class="hljs-string">'round'</span>;
  }

  <span class="hljs-comment">// 绘制基本图形</span>
  <span class="hljs-title function_">drawRect</span>(<span class="hljs-params">x, y, width, height, style = {}</span>) {
    <span class="hljs-keyword">const</span> id = <span class="hljs-string">`rect_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random()}</span>`</span>;
    <span class="hljs-keyword">const</span> rect = {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'rect'</span>,
      x, y, width, height,
      <span class="hljs-attr">style</span>: {
        <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'#3498db'</span>,
        <span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">'#2980b9'</span>,
        <span class="hljs-attr">lineWidth</span>: <span class="hljs-number">2</span>,
        ...style
      },
      id
    };

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">save</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyStyles</span>(rect.<span class="hljs-property">style</span>);
    
    <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">style</span>.<span class="hljs-property">fillStyle</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">fillRect</span>(x, y, width, height);
    }
    <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">style</span>.<span class="hljs-property">strokeStyle</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">strokeRect</span>(x, y, width, height);
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">restore</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shapes</span>.<span class="hljs-title function_">set</span>(id, rect);
    <span class="hljs-keyword">return</span> id;
  }

  <span class="hljs-comment">// 绘制圆形</span>
  <span class="hljs-title function_">drawCircle</span>(<span class="hljs-params">x, y, radius, style = {}</span>) {
    <span class="hljs-keyword">const</span> id = <span class="hljs-string">`circle_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random()}</span>`</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">beginPath</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">arc</span>(x, y, radius, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyStyles</span>(style);
    
    <span class="hljs-keyword">if</span> (style.<span class="hljs-property">fillStyle</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">fill</span>();
    <span class="hljs-keyword">if</span> (style.<span class="hljs-property">strokeStyle</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">stroke</span>();
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shapes</span>.<span class="hljs-title function_">set</span>(id, { <span class="hljs-attr">type</span>: <span class="hljs-string">'circle'</span>, x, y, radius, style, id });
    <span class="hljs-keyword">return</span> id;
  }

  <span class="hljs-comment">// 绘制路径</span>
  <span class="hljs-title function_">drawPath</span>(<span class="hljs-params">points, style = {}</span>) {
    <span class="hljs-keyword">if</span> (points.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">beginPath</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">moveTo</span>(points[<span class="hljs-number">0</span>].<span class="hljs-property">x</span>, points[<span class="hljs-number">0</span>].<span class="hljs-property">y</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; points.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">if</span> (points[i].<span class="hljs-property">type</span> === <span class="hljs-string">'quadratic'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">quadraticCurveTo</span>(
          points[i].<span class="hljs-property">cp1x</span>, points[i].<span class="hljs-property">cp1y</span>,
          points[i].<span class="hljs-property">x</span>, points[i].<span class="hljs-property">y</span>
        );
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (points[i].<span class="hljs-property">type</span> === <span class="hljs-string">'bezier'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">bezierCurveTo</span>(
          points[i].<span class="hljs-property">cp1x</span>, points[i].<span class="hljs-property">cp1y</span>,
          points[i].<span class="hljs-property">cp2x</span>, points[i].<span class="hljs-property">cp2y</span>,
          points[i].<span class="hljs-property">x</span>, points[i].<span class="hljs-property">y</span>
        );
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">lineTo</span>(points[i].<span class="hljs-property">x</span>, points[i].<span class="hljs-property">y</span>);
      }
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyStyles</span>(style);
    <span class="hljs-keyword">if</span> (style.<span class="hljs-property">closePath</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">closePath</span>();
    <span class="hljs-keyword">if</span> (style.<span class="hljs-property">fillStyle</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">fill</span>();
    <span class="hljs-keyword">if</span> (style.<span class="hljs-property">strokeStyle</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">stroke</span>();
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">shapes</span>.<span class="hljs-property">size</span>;
  }

  <span class="hljs-title function_">applyStyles</span>(<span class="hljs-params">styles</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(styles).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>[key] = styles[key];
      }
    });
  }

  <span class="hljs-comment">// 清除画布</span>
  <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-property">height</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shapes</span>.<span class="hljs-title function_">clear</span>();
  }

  <span class="hljs-comment">// 获取像素数据（用于高级操作）</span>
  <span class="hljs-title function_">getPixelData</span>(<span class="hljs-params">x, y, width = <span class="hljs-number">1</span>, height = <span class="hljs-number">1</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span>.<span class="hljs-title function_">getImageData</span>(x, y, width, height);
  }

  <span class="hljs-comment">// 保存为图片</span>
  <span class="hljs-title function_">toDataURL</span>(<span class="hljs-params">type = <span class="hljs-string">'image/png'</span>, quality = <span class="hljs-number">0.92</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span>.<span class="hljs-title function_">toDataURL</span>(type, quality);
  }
}
</code></pre>
<h5 data-id="heading-3">1.2 Canvas性能优化技巧</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Canvas性能优化类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CanvasOptimizer</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">optimizeRendering</span>(<span class="hljs-params">canvas, options = {}</span>) {
    <span class="hljs-comment">// 1. 使用离屏Canvas进行复杂绘制</span>
    <span class="hljs-keyword">const</span> offscreenCanvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
    <span class="hljs-keyword">const</span> offscreenCtx = offscreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
    
    offscreenCanvas.<span class="hljs-property">width</span> = canvas.<span class="hljs-property">width</span>;
    offscreenCanvas.<span class="hljs-property">height</span> = canvas.<span class="hljs-property">height</span>;
    
    <span class="hljs-comment">// 2. 批量绘制操作</span>
    <span class="hljs-keyword">return</span> {
      offscreenCanvas,
      offscreenCtx,
      <span class="hljs-comment">// 批量绘制矩形</span>
      <span class="hljs-title function_">batchDrawRects</span>(<span class="hljs-params">rects</span>) {
        offscreenCtx.<span class="hljs-title function_">save</span>();
        rects.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">rect</span> =&gt;</span> {
          offscreenCtx.<span class="hljs-property">fillStyle</span> = rect.<span class="hljs-property">color</span>;
          offscreenCtx.<span class="hljs-title function_">fillRect</span>(rect.<span class="hljs-property">x</span>, rect.<span class="hljs-property">y</span>, rect.<span class="hljs-property">width</span>, rect.<span class="hljs-property">height</span>);
        });
        offscreenCtx.<span class="hljs-title function_">restore</span>();
        
        <span class="hljs-comment">// 一次性绘制到主Canvas</span>
        canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>).<span class="hljs-title function_">drawImage</span>(offscreenCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      },
      
      <span class="hljs-comment">// 3. 使用requestAnimationFrame进行动画</span>
      <span class="hljs-title function_">animate</span>(<span class="hljs-params">callback</span>) {
        <span class="hljs-keyword">let</span> animationId;
        
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"/>) =&gt; {
          <span class="hljs-title function_">callback</span>();
          animationId = <span class="hljs-title function_">requestAnimationFrame</span>(animate);
        };
        
        <span class="hljs-title function_">animate</span>();
        
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">stop</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">cancelAnimationFrame</span>(animationId)
        };
      }
    };
  }

  <span class="hljs-comment">// 避免频繁的重绘</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createDoubleBuffer</span>(<span class="hljs-params">canvas</span>) {
    <span class="hljs-keyword">const</span> buffers = [
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>),
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>)
    ];
    
    buffers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">buffer</span> =&gt;</span> {
      buffer.<span class="hljs-property">width</span> = canvas.<span class="hljs-property">width</span>;
      buffer.<span class="hljs-property">height</span> = canvas.<span class="hljs-property">height</span>;
    });
    
    <span class="hljs-keyword">let</span> currentBuffer = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-title function_">getBuffer</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> buffers[currentBuffer];
      },
      <span class="hljs-title function_">swap</span>(<span class="hljs-params"/>) {
        currentBuffer = <span class="hljs-number">1</span> - currentBuffer;
        <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
        ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);
        ctx.<span class="hljs-title function_">drawImage</span>(buffers[<span class="hljs-number">1</span> - currentBuffer], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      }
    };
  }
}
</code></pre>
<h4 data-id="heading-4">2. SVG操作库实现</h4>
<h5 data-id="heading-5">2.1 SVG核心操作封装</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SVGManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">containerId, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(containerId);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">namespace</span> = <span class="hljs-string">'http://www.w3.org/2000/svg'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>(options);
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-comment">// 创建SVG画布</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElementNS</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">namespace</span>, <span class="hljs-string">'svg'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'width'</span>, options.<span class="hljs-property">width</span> || <span class="hljs-string">'100%'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'height'</span>, options.<span class="hljs-property">height</span> || <span class="hljs-string">'100%'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'viewBox'</span>, options.<span class="hljs-property">viewBox</span> || <span class="hljs-string">'0 0 800 600'</span>);
    
    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">preserveAspectRatio</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'preserveAspectRatio'</span>, options.<span class="hljs-property">preserveAspectRatio</span>);
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>);
  }

  <span class="hljs-comment">// 创建SVG元素</span>
  <span class="hljs-title function_">createElement</span>(<span class="hljs-params">type, attributes = {}</span>) {
    <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElementNS</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">namespace</span>, type);
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(attributes).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      element.<span class="hljs-title function_">setAttribute</span>(key, attributes[key]);
    });
    
    <span class="hljs-keyword">return</span> element;
  }

  <span class="hljs-comment">// 添加图形</span>
  <span class="hljs-title function_">addCircle</span>(<span class="hljs-params">cx, cy, r, styles = {}</span>) {
    <span class="hljs-keyword">const</span> circle = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'circle'</span>, {
      cx, cy, r,
      ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseStyles</span>(styles)
    });
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-string">`circle_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
    circle.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'id'</span>, id);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">appendChild</span>(circle);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">set</span>(id, circle);
    
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">element</span>: circle, id };
  }

  <span class="hljs-title function_">addRect</span>(<span class="hljs-params">x, y, width, height, styles = {}</span>) {
    <span class="hljs-keyword">const</span> rect = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'rect'</span>, {
      x, y, width, height,
      ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseStyles</span>(styles)
    });
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-string">`rect_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
    rect.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'id'</span>, id);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">appendChild</span>(rect);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">set</span>(id, rect);
    
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">element</span>: rect, id };
  }

  <span class="hljs-title function_">addPath</span>(<span class="hljs-params">d, styles = {}</span>) {
    <span class="hljs-keyword">const</span> path = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'path'</span>, {
      d,
      ...<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseStyles</span>(styles)
    });
    
    <span class="hljs-keyword">const</span> id = <span class="hljs-string">`path_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
    path.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'id'</span>, id);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">appendChild</span>(path);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">set</span>(id, path);
    
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">element</span>: path, id };
  }

  <span class="hljs-comment">// 创建复杂图形</span>
  <span class="hljs-title function_">createPieChart</span>(<span class="hljs-params">data, centerX, centerY, radius</span>) {
    <span class="hljs-keyword">const</span> group = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'g'</span>);
    <span class="hljs-keyword">let</span> startAngle = <span class="hljs-number">0</span>;
    
    data.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> sliceAngle = (item.<span class="hljs-property">value</span> / <span class="hljs-number">100</span>) * <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>;
      <span class="hljs-keyword">const</span> endAngle = startAngle + sliceAngle;
      
      <span class="hljs-comment">// 计算路径</span>
      <span class="hljs-keyword">const</span> x1 = centerX + radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(startAngle);
      <span class="hljs-keyword">const</span> y1 = centerY + radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(startAngle);
      <span class="hljs-keyword">const</span> x2 = centerX + radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(endAngle);
      <span class="hljs-keyword">const</span> y2 = centerY + radius * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(endAngle);
      
      <span class="hljs-keyword">const</span> largeArcFlag = sliceAngle &gt; <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
      
      <span class="hljs-keyword">const</span> pathData = [
        <span class="hljs-string">`M <span class="hljs-subst">${centerX}</span> <span class="hljs-subst">${centerY}</span>`</span>,
        <span class="hljs-string">`L <span class="hljs-subst">${x1}</span> <span class="hljs-subst">${y1}</span>`</span>,
        <span class="hljs-string">`A <span class="hljs-subst">${radius}</span> <span class="hljs-subst">${radius}</span> 0 <span class="hljs-subst">${largeArcFlag}</span> 1 <span class="hljs-subst">${x2}</span> <span class="hljs-subst">${y2}</span>`</span>,
        <span class="hljs-string">'Z'</span>
      ].<span class="hljs-title function_">join</span>(<span class="hljs-string">' '</span>);
      
      <span class="hljs-keyword">const</span> slice = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addPath</span>(pathData, {
        <span class="hljs-attr">fill</span>: item.<span class="hljs-property">color</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getColor</span>(index),
        <span class="hljs-attr">stroke</span>: <span class="hljs-string">'#ffffff'</span>,
        <span class="hljs-string">'stroke-width'</span>: <span class="hljs-number">2</span>
      });
      
      group.<span class="hljs-title function_">appendChild</span>(slice.<span class="hljs-property">element</span>);
      startAngle = endAngle;
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">svg</span>.<span class="hljs-title function_">appendChild</span>(group);
    <span class="hljs-keyword">return</span> group;
  }

  <span class="hljs-comment">// 添加交互事件</span>
  <span class="hljs-title function_">addInteraction</span>(<span class="hljs-params">elementId, events</span>) {
    <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">get</span>(elementId);
    <span class="hljs-keyword">if</span> (!element) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(events).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">eventType</span> =&gt;</span> {
      element.<span class="hljs-title function_">addEventListener</span>(eventType, events[eventType]);
    });
  }

  <span class="hljs-comment">// 样式解析</span>
  <span class="hljs-title function_">parseStyles</span>(<span class="hljs-params">styles</span>) {
    <span class="hljs-keyword">const</span> svgStyles = {};
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(styles).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> svgKey = key.<span class="hljs-title function_">replace</span>(
        <span class="hljs-regexp">/[A-Z]/g</span>, 
        <span class="hljs-function"><span class="hljs-params">match</span> =&gt;</span> <span class="hljs-string">`-<span class="hljs-subst">${match.toLowerCase()}</span>`</span>
      );
      svgStyles[svgKey] = styles[key];
    });
    
    <span class="hljs-keyword">return</span> svgStyles;
  }

  <span class="hljs-comment">// 动画方法</span>
  <span class="hljs-title function_">animateElement</span>(<span class="hljs-params">elementId, properties, duration = <span class="hljs-number">1000</span></span>) {
    <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">this</span>.<span class="hljs-property">elements</span>.<span class="hljs-title function_">get</span>(elementId);
    <span class="hljs-keyword">if</span> (!element) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> startValues = {};
    
    <span class="hljs-comment">// 获取起始值</span>
    properties.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> {
      startValues[prop.<span class="hljs-property">attribute</span>] = 
        element.<span class="hljs-title function_">getAttribute</span>(prop.<span class="hljs-property">attribute</span>) || prop.<span class="hljs-property">from</span>;
    });
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> elapsed = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
      <span class="hljs-keyword">const</span> progress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elapsed / duration, <span class="hljs-number">1</span>);
      
      properties.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> startValue = <span class="hljs-built_in">parseFloat</span>(startValues[prop.<span class="hljs-property">attribute</span>]);
        <span class="hljs-keyword">const</span> endValue = <span class="hljs-built_in">parseFloat</span>(prop.<span class="hljs-property">to</span>);
        <span class="hljs-keyword">const</span> currentValue = 
          startValue + (endValue - startValue) * <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">easing</span>(progress);
        
        element.<span class="hljs-title function_">setAttribute</span>(
          prop.<span class="hljs-property">attribute</span>, 
          currentValue + (prop.<span class="hljs-property">unit</span> || <span class="hljs-string">''</span>)
        );
      });
      
      <span class="hljs-keyword">if</span> (progress &lt; <span class="hljs-number">1</span>) {
        <span class="hljs-title function_">requestAnimationFrame</span>(animate);
      }
    };
    
    <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  }

  <span class="hljs-title function_">easing</span>(<span class="hljs-params">t</span>) {
    <span class="hljs-comment">// 缓动函数</span>
    <span class="hljs-keyword">return</span> t &lt; <span class="hljs-number">0.5</span> 
      ? <span class="hljs-number">2</span> * t * t 
      : -<span class="hljs-number">1</span> + (<span class="hljs-number">4</span> - <span class="hljs-number">2</span> * t) * t;
  }
}
</code></pre>
<h4 data-id="heading-6">3. 拖拽库实现</h4>
<h5 data-id="heading-7">3.1 高性能拖拽系统</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DragManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">container</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>,
      <span class="hljs-attr">dragSelector</span>: <span class="hljs-string">'.draggable'</span>,
      <span class="hljs-attr">handleSelector</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">cursor</span>: <span class="hljs-string">'move'</span>,
      <span class="hljs-attr">zIndex</span>: <span class="hljs-number">1000</span>,
      <span class="hljs-attr">onStart</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">onDrag</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">onEnd</span>: <span class="hljs-literal">null</span>,
      ...options
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">draggables</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">bindEvents</span>();
  }

  <span class="hljs-title function_">bindEvents</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">addEventListener</span>(
      <span class="hljs-string">'mousedown'</span>, 
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleMouseDown</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)
    );
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">addEventListener</span>(
      <span class="hljs-string">'touchstart'</span>, 
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleTouchStart</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)
    );
    
    <span class="hljs-comment">// 防止拖拽时选中文本</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'selectstart'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>) {
        e.<span class="hljs-title function_">preventDefault</span>();
      }
    });
  }

  <span class="hljs-title function_">register</span>(<span class="hljs-params">element, options = {}</span>) {
    <span class="hljs-keyword">const</span> dragId = <span class="hljs-string">`drag_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
    
    <span class="hljs-keyword">const</span> dragInfo = {
      element,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">axis</span>: <span class="hljs-string">'both'</span>, <span class="hljs-comment">// 'x', 'y', 'both'</span>
        <span class="hljs-attr">bounds</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// { left, top, right, bottom }</span>
        <span class="hljs-attr">grid</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// [x, y]</span>
        ...options
      },
      <span class="hljs-attr">originalStyle</span>: {
        <span class="hljs-attr">position</span>: element.<span class="hljs-property">style</span>.<span class="hljs-property">position</span>,
        <span class="hljs-attr">cursor</span>: element.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span>,
        <span class="hljs-attr">zIndex</span>: element.<span class="hljs-property">style</span>.<span class="hljs-property">zIndex</span>,
        <span class="hljs-attr">userSelect</span>: element.<span class="hljs-property">style</span>.<span class="hljs-property">userSelect</span>
      }
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">draggables</span>.<span class="hljs-title function_">set</span>(dragId, dragInfo);
    <span class="hljs-keyword">return</span> dragId;
  }

  <span class="hljs-title function_">handleMouseDown</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;
    <span class="hljs-keyword">const</span> dragHandle = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">handleSelector</span> 
      ? target.<span class="hljs-title function_">closest</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">handleSelector</span>)
      : target.<span class="hljs-title function_">closest</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">dragSelector</span>);
    
    <span class="hljs-keyword">if</span> (!dragHandle) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> dragId = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findDragId</span>(dragHandle);
    <span class="hljs-keyword">if</span> (!dragId) <span class="hljs-keyword">return</span>;
    
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startDrag</span>(dragId, e.<span class="hljs-property">clientX</span>, e.<span class="hljs-property">clientY</span>);
  }

  <span class="hljs-title function_">handleTouchStart</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">const</span> touch = e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> target = touch.<span class="hljs-property">target</span>;
    <span class="hljs-keyword">const</span> dragHandle = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">handleSelector</span>
      ? target.<span class="hljs-title function_">closest</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">handleSelector</span>)
      : target.<span class="hljs-title function_">closest</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">dragSelector</span>);
    
    <span class="hljs-keyword">if</span> (!dragHandle) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> dragId = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findDragId</span>(dragHandle);
    <span class="hljs-keyword">if</span> (!dragId) <span class="hljs-keyword">return</span>;
    
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startDrag</span>(dragId, touch.<span class="hljs-property">clientX</span>, touch.<span class="hljs-property">clientY</span>);
  }

  <span class="hljs-title function_">findDragId</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [id, info] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">draggables</span>.<span class="hljs-title function_">entries</span>()) {
      <span class="hljs-keyword">if</span> (info.<span class="hljs-property">element</span>.<span class="hljs-title function_">contains</span>(element) || info.<span class="hljs-property">element</span> === element) {
        <span class="hljs-keyword">return</span> id;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-title function_">startDrag</span>(<span class="hljs-params">dragId, startX, startY</span>) {
    <span class="hljs-keyword">const</span> dragInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">draggables</span>.<span class="hljs-title function_">get</span>(dragId);
    <span class="hljs-keyword">if</span> (!dragInfo) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span> = {
      ...dragInfo,
      dragId,
      startX,
      startY,
      <span class="hljs-attr">startLeft</span>: <span class="hljs-built_in">parseInt</span>(dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">left</span>) || <span class="hljs-number">0</span>,
      <span class="hljs-attr">startTop</span>: <span class="hljs-built_in">parseInt</span>(dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">top</span>) || <span class="hljs-number">0</span>,
      <span class="hljs-attr">width</span>: dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">offsetWidth</span>,
      <span class="hljs-attr">height</span>: dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">offsetHeight</span>
    };
    
    <span class="hljs-comment">// 设置拖拽样式</span>
    dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">cursor</span>;
    dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">zIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">zIndex</span>;
    dragInfo.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">userSelect</span> = <span class="hljs-string">'none'</span>;
    
    <span class="hljs-comment">// 绑定移动事件</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">moveHandler</span> = (<span class="hljs-params">e</span>) =&gt; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleMove</span>(e);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">upHandler</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">endDrag</span>();
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, moveHandler);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchmove'</span>, moveHandler);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseup'</span>, upHandler);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchend'</span>, upHandler);
    
    <span class="hljs-comment">// 保存事件处理器以便移除</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">moveHandler</span> = moveHandler;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">upHandler</span> = upHandler;
    
    <span class="hljs-comment">// 回调</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">onStart</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-title function_">onStart</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>);
    }
  }

  <span class="hljs-title function_">handleMove</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>) <span class="hljs-keyword">return</span>;
    
    e.<span class="hljs-title function_">preventDefault</span>();
    
    <span class="hljs-keyword">const</span> clientX = e.<span class="hljs-property">type</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'touch'</span>) 
      ? e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientX</span> 
      : e.<span class="hljs-property">clientX</span>;
    <span class="hljs-keyword">const</span> clientY = e.<span class="hljs-property">type</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'touch'</span>)
      ? e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientY</span>
      : e.<span class="hljs-property">clientY</span>;
    
    <span class="hljs-keyword">let</span> deltaX = clientX - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startX</span>;
    <span class="hljs-keyword">let</span> deltaY = clientY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startY</span>;
    
    <span class="hljs-comment">// 应用约束</span>
    <span class="hljs-keyword">const</span> constraints = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyConstraints</span>(deltaX, deltaY);
    deltaX = constraints.<span class="hljs-property">x</span>;
    deltaY = constraints.<span class="hljs-property">y</span>;
    
    <span class="hljs-comment">// 更新位置</span>
    <span class="hljs-keyword">const</span> newX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startLeft</span> + deltaX;
    <span class="hljs-keyword">const</span> newY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startTop</span> + deltaY;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">`<span class="hljs-subst">${newX}</span>px`</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${newY}</span>px`</span>;
    
    <span class="hljs-comment">// 回调</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">onDrag</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-title function_">onDrag</span>({
        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>,
        <span class="hljs-attr">x</span>: newX,
        <span class="hljs-attr">y</span>: newY,
        deltaX,
        deltaY
      });
    }
  }

  <span class="hljs-title function_">applyConstraints</span>(<span class="hljs-params">deltaX, deltaY</span>) {
    <span class="hljs-keyword">const</span> { options, element } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>;
    
    <span class="hljs-comment">// 轴向约束</span>
    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">axis</span> === <span class="hljs-string">'x'</span>) {
      deltaY = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.<span class="hljs-property">axis</span> === <span class="hljs-string">'y'</span>) {
      deltaX = <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-comment">// 边界约束</span>
    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">bounds</span>) {
      <span class="hljs-keyword">const</span> bounds = options.<span class="hljs-property">bounds</span>;
      <span class="hljs-keyword">const</span> containerRect = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">getBoundingClientRect</span>();
      <span class="hljs-keyword">const</span> elementRect = element.<span class="hljs-title function_">getBoundingClientRect</span>();
      
      <span class="hljs-keyword">const</span> minX = bounds.<span class="hljs-property">left</span> || -<span class="hljs-title class_">Infinity</span>;
      <span class="hljs-keyword">const</span> maxX = bounds.<span class="hljs-property">right</span> !== <span class="hljs-literal">undefined</span> 
        ? bounds.<span class="hljs-property">right</span> - elementRect.<span class="hljs-property">width</span> 
        : <span class="hljs-title class_">Infinity</span>;
      <span class="hljs-keyword">const</span> minY = bounds.<span class="hljs-property">top</span> || -<span class="hljs-title class_">Infinity</span>;
      <span class="hljs-keyword">const</span> maxY = bounds.<span class="hljs-property">bottom</span> !== <span class="hljs-literal">undefined</span>
        ? bounds.<span class="hljs-property">bottom</span> - elementRect.<span class="hljs-property">height</span>
        : <span class="hljs-title class_">Infinity</span>;
      
      <span class="hljs-keyword">const</span> newX = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startLeft</span> + deltaX;
      <span class="hljs-keyword">const</span> newY = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startTop</span> + deltaY;
      
      deltaX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(minX, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(maxX, newX)) - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startLeft</span>;
      deltaY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(minY, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(maxY, newY)) - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">startTop</span>;
    }
    
    <span class="hljs-comment">// 网格约束</span>
    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">grid</span>) {
      <span class="hljs-keyword">const</span> [gridX, gridY] = options.<span class="hljs-property">grid</span>;
      deltaX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(deltaX / gridX) * gridX;
      deltaY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(deltaY / gridY) * gridY;
    }
    
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">x</span>: deltaX, <span class="hljs-attr">y</span>: deltaY };
  }

  <span class="hljs-title function_">endDrag</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 移除事件监听</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">moveHandler</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchmove'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">moveHandler</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mouseup'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">upHandler</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchend'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">upHandler</span>);
    
    <span class="hljs-comment">// 恢复样式</span>
    <span class="hljs-keyword">const</span> dragInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">draggables</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">dragId</span>);
    <span class="hljs-keyword">if</span> (dragInfo) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>.<span class="hljs-property">element</span>.<span class="hljs-property">style</span>, dragInfo.<span class="hljs-property">originalStyle</span>);
    }
    
    <span class="hljs-comment">// 回调</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">onEnd</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-title function_">onEnd</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span>);
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentDrag</span> = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h4 data-id="heading-8">4. 动画库实现</h4>
<h5 data-id="heading-9">4.1 高性能动画引擎</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimationEngine</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastTime</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">easingFunctions</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getEasingFunctions</span>();
  }

  <span class="hljs-comment">// 缓动函数集合</span>
  <span class="hljs-title function_">getEasingFunctions</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">linear</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t,
      <span class="hljs-attr">easeInQuad</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t * t,
      <span class="hljs-attr">easeOutQuad</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t * (<span class="hljs-number">2</span> - t),
      <span class="hljs-attr">easeInOutQuad</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t &lt; <span class="hljs-number">0.5</span> ? <span class="hljs-number">2</span> * t * t : -<span class="hljs-number">1</span> + (<span class="hljs-number">4</span> - <span class="hljs-number">2</span> * t) * t,
      <span class="hljs-attr">easeInCubic</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t * t * t,
      <span class="hljs-attr">easeOutCubic</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> (--t) * t * t + <span class="hljs-number">1</span>,
      <span class="hljs-attr">easeInOutCubic</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t &lt; <span class="hljs-number">0.5</span> ? <span class="hljs-number">4</span> * t * t * t : (t - <span class="hljs-number">1</span>) * (<span class="hljs-number">2</span> * t - <span class="hljs-number">2</span>) * (<span class="hljs-number">2</span> * t - <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>,
      <span class="hljs-attr">easeInElastic</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> (<span class="hljs-number">0.04</span> - <span class="hljs-number">0.04</span> / t) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(<span class="hljs-number">25</span> * t) + <span class="hljs-number">1</span>,
      <span class="hljs-attr">easeOutElastic</span>: <span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> <span class="hljs-number">0.04</span> * t / (--t) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(<span class="hljs-number">25</span> * t),
      <span class="hljs-attr">spring</span>: <span class="hljs-function">(<span class="hljs-params">t, damping = <span class="hljs-number">0.5</span></span>) =&gt;</span> <span class="hljs-number">1</span> - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(-<span class="hljs-number">6</span> * damping * t) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(t * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span> / <span class="hljs-number">0.5</span>)
    };
  }

  <span class="hljs-comment">// 创建动画</span>
  <span class="hljs-title function_">animate</span>(<span class="hljs-params">target, properties, options = {}</span>) {
    <span class="hljs-keyword">const</span> animationId = <span class="hljs-string">`anim_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}</span>`</span>;
    
    <span class="hljs-keyword">const</span> animation = {
      <span class="hljs-attr">id</span>: animationId,
      target,
      <span class="hljs-attr">startValues</span>: {},
      <span class="hljs-attr">endValues</span>: properties,
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>,
        <span class="hljs-attr">delay</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">easing</span>: <span class="hljs-string">'linear'</span>,
        <span class="hljs-attr">onStart</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onUpdate</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onComplete</span>: <span class="hljs-literal">null</span>,
        ...options
      },
      <span class="hljs-attr">startTime</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">state</span>: <span class="hljs-string">'waiting'</span>
    };
    
    <span class="hljs-comment">// 获取起始值</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(properties).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target[prop] === <span class="hljs-string">'number'</span>) {
        animation.<span class="hljs-property">startValues</span>[prop] = target[prop];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target.<span class="hljs-property">style</span>[prop] !== <span class="hljs-string">'undefined'</span>) {
        animation.<span class="hljs-property">startValues</span>[prop] = <span class="hljs-built_in">parseFloat</span>(<span class="hljs-title function_">getComputedStyle</span>(target)[prop]) || <span class="hljs-number">0</span>;
      }
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">set</span>(animationId, animation);
    
    <span class="hljs-comment">// 开始动画循环</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">start</span>();
    }
    
    <span class="hljs-keyword">return</span> animationId;
  }

  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastTime</span> = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>();
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params">currentTime = performance.now()</span>) {
    <span class="hljs-keyword">const</span> deltaTime = currentTime - <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastTime</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastTime</span> = currentTime;
    
    <span class="hljs-keyword">let</span> hasActiveAnimations = <span class="hljs-literal">false</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">animation, id</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">state</span> === <span class="hljs-string">'waiting'</span>) {
        animation.<span class="hljs-property">startTime</span> = currentTime + animation.<span class="hljs-property">options</span>.<span class="hljs-property">delay</span>;
        animation.<span class="hljs-property">state</span> = <span class="hljs-string">'delayed'</span>;
      }
      
      <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">state</span> === <span class="hljs-string">'delayed'</span> &amp;&amp; currentTime &gt;= animation.<span class="hljs-property">startTime</span>) {
        animation.<span class="hljs-property">state</span> = <span class="hljs-string">'running'</span>;
        <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">options</span>.<span class="hljs-property">onStart</span>) {
          animation.<span class="hljs-property">options</span>.<span class="hljs-title function_">onStart</span>(animation);
        }
      }
      
      <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">state</span> === <span class="hljs-string">'running'</span>) {
        <span class="hljs-keyword">const</span> elapsed = currentTime - animation.<span class="hljs-property">startTime</span>;
        animation.<span class="hljs-property">progress</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elapsed / animation.<span class="hljs-property">options</span>.<span class="hljs-property">duration</span>, <span class="hljs-number">1</span>);
        
        <span class="hljs-comment">// 应用缓动函数</span>
        <span class="hljs-keyword">const</span> easingFunc = <span class="hljs-variable language_">this</span>.<span class="hljs-property">easingFunctions</span>[animation.<span class="hljs-property">options</span>.<span class="hljs-property">easing</span>] || <span class="hljs-variable language_">this</span>.<span class="hljs-property">easingFunctions</span>.<span class="hljs-property">linear</span>;
        <span class="hljs-keyword">const</span> easedProgress = <span class="hljs-title function_">easingFunc</span>(animation.<span class="hljs-property">progress</span>);
        
        <span class="hljs-comment">// 更新属性</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateProperties</span>(animation, easedProgress);
        
        <span class="hljs-comment">// 回调</span>
        <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">options</span>.<span class="hljs-property">onUpdate</span>) {
          animation.<span class="hljs-property">options</span>.<span class="hljs-title function_">onUpdate</span>(animation, easedProgress);
        }
        
        <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">progress</span> &gt;= <span class="hljs-number">1</span>) {
          animation.<span class="hljs-property">state</span> = <span class="hljs-string">'completed'</span>;
          <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">options</span>.<span class="hljs-property">onComplete</span>) {
            animation.<span class="hljs-property">options</span>.<span class="hljs-title function_">onComplete</span>(animation);
          }
          <span class="hljs-comment">// 标记为待清理</span>
          animation.<span class="hljs-property">state</span> = <span class="hljs-string">'finished'</span>;
        } <span class="hljs-keyword">else</span> {
          hasActiveAnimations = <span class="hljs-literal">true</span>;
        }
      }
    });
    
    <span class="hljs-comment">// 清理已完成的动画</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanup</span>();
    
    <span class="hljs-keyword">if</span> (hasActiveAnimations) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span> = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">update</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stop</span>();
    }
  }

  <span class="hljs-title function_">updateProperties</span>(<span class="hljs-params">animation, progress</span>) {
    <span class="hljs-keyword">const</span> { target, startValues, endValues } = animation;
    
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(endValues).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> startValue = startValues[prop];
      <span class="hljs-keyword">const</span> endValue = endValues[prop];
      <span class="hljs-keyword">const</span> currentValue = startValue + (endValue - startValue) * progress;
      
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target[prop] === <span class="hljs-string">'number'</span>) {
        target[prop] = currentValue;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target.<span class="hljs-property">style</span>[prop] !== <span class="hljs-string">'undefined'</span>) {
        target.<span class="hljs-property">style</span>[prop] = currentValue + (<span class="hljs-keyword">typeof</span> endValue === <span class="hljs-string">'string'</span> ? endValue.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[0-9.-]/g</span>, <span class="hljs-string">''</span>) : <span class="hljs-string">''</span>);
      }
    });
  }

  <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> finishedAnimations = [];
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">animation, id</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (animation.<span class="hljs-property">state</span> === <span class="hljs-string">'finished'</span>) {
        finishedAnimations.<span class="hljs-title function_">push</span>(id);
      }
    });
    
    finishedAnimations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">delete</span>(id);
    });
  }

  <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span>) {
      <span class="hljs-title function_">cancelAnimationFrame</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span> = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">pause</span>(<span class="hljs-params">animationId</span>) {
    <span class="hljs-keyword">const</span> animation = <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">get</span>(animationId);
    <span class="hljs-keyword">if</span> (animation &amp;&amp; animation.<span class="hljs-property">state</span> === <span class="hljs-string">'running'</span>) {
      animation.<span class="hljs-property">state</span> = <span class="hljs-string">'paused'</span>;
      animation.<span class="hljs-property">pauseTime</span> = performance.<span class="hljs-title function_">now</span>();
    }
  }

  <span class="hljs-title function_">resume</span>(<span class="hljs-params">animationId</span>) {
    <span class="hljs-keyword">const</span> animation = <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">get</span>(animationId);
    <span class="hljs-keyword">if</span> (animation &amp;&amp; animation.<span class="hljs-property">state</span> === <span class="hljs-string">'paused'</span>) {
      <span class="hljs-keyword">const</span> pauseDuration = performance.<span class="hljs-title function_">now</span>() - animation.<span class="hljs-property">pauseTime</span>;
      animation.<span class="hljs-property">startTime</span> += pauseDuration;
      animation.<span class="hljs-property">state</span> = <span class="hljs-string">'running'</span>;
      
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">start</span>();
      }
    }
  }

  <span class="hljs-title function_">cancel</span>(<span class="hljs-params">animationId</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animations</span>.<span class="hljs-title function_">delete</span>(animationId);
  }
}

<span class="hljs-comment">// 关键帧动画支持</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KeyframeAnimation</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">target, keyframes, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">target</span> = target;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyframes</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">normalizeKeyframes</span>(keyframes);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>,
      <span class="hljs-attr">iterations</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">direction</span>: <span class="hljs-string">'normal'</span>,
      <span class="hljs-attr">fillMode</span>: <span class="hljs-string">'forwards'</span>,
      ...options
    };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationEngine</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimationEngine</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIteration</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">normalizeKeyframes</span>(<span class="hljs-params">keyframes</span>) {
    <span class="hljs-comment">// 确保关键帧按时间排序</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(keyframes)
      .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-built_in">parseFloat</span>(a) - <span class="hljs-built_in">parseFloat</span>(b))
      .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">time</span> =&gt;</span> ({
        <span class="hljs-attr">time</span>: <span class="hljs-built_in">parseFloat</span>(time) / <span class="hljs-number">100</span>,
        <span class="hljs-attr">properties</span>: keyframes[time]
      }));
  }

  <span class="hljs-title function_">play</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> segmentDuration = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">duration</span> / (<span class="hljs-variable language_">this</span>.<span class="hljs-property">keyframes</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyframes</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">frame, index</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> nextFrame = <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyframes</span>[index + <span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> duration = (nextFrame.<span class="hljs-property">time</span> - frame.<span class="hljs-property">time</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">duration</span>;
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationEngine</span>.<span class="hljs-title function_">animate</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">target</span>,
        nextFrame.<span class="hljs-property">properties</span>,
        {
          duration,
          <span class="hljs-attr">delay</span>: frame.<span class="hljs-property">time</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">duration</span>,
          <span class="hljs-attr">easing</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">easing</span>,
          <span class="hljs-attr">onComplete</span>: index === <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyframes</span>.<span class="hljs-property">length</span> - <span class="hljs-number">2</span> 
            ? <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleIterationComplete</span>()
            : <span class="hljs-literal">null</span>
        }
      );
    });
  }

  <span class="hljs-title function_">handleIterationComplete</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIteration</span>++;
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIteration</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">iterations</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">play</span>();
    }
  }
}
</code></pre>
<h4 data-id="heading-10">5. 其他技术点</h4>
<h5 data-id="heading-11">5.1 响应式可视化适配</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponsiveVisualization</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">container, renderFunction, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = container;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderFunction</span> = renderFunction;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">debounceDelay</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attr">aspectRatio</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">minWidth</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attr">minHeight</span>: <span class="hljs-number">100</span>,
      ...options
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeObserver</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupResizeObserver</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupWindowResize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initialRender</span>();
  }

  <span class="hljs-title function_">setupResizeObserver</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'ResizeObserver'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeObserver</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function"><span class="hljs-params">entries</span> =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleResize</span>();
      });
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeObserver</span>.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>);
    }
  }

  <span class="hljs-title function_">setupWindowResize</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleResize</span>();
    });
  }

  <span class="hljs-title function_">handleResize</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span>);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateDimensions</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
    }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">debounceDelay</span>);
  }

  <span class="hljs-title function_">updateDimensions</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> containerRect = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">getBoundingClientRect</span>();
    
    <span class="hljs-keyword">let</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">minWidth</span>, containerRect.<span class="hljs-property">width</span>);
    <span class="hljs-keyword">let</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">minHeight</span>, containerRect.<span class="hljs-property">height</span>);
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">aspectRatio</span>) {
      <span class="hljs-keyword">const</span> [ratioX, ratioY] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">aspectRatio</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">':'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>);
      <span class="hljs-keyword">const</span> targetRatio = ratioX / ratioY;
      <span class="hljs-keyword">const</span> currentRatio = width / height;
      
      <span class="hljs-keyword">if</span> (currentRatio &gt; targetRatio) {
        width = height * targetRatio;
      } <span class="hljs-keyword">else</span> {
        height = width / targetRatio;
      }
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dimensions</span> = { width, height };
  }

  <span class="hljs-title function_">initialRender</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateDimensions</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">dimensions</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderFunction</span>({
      <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">dimensions</span>.<span class="hljs-property">width</span>,
      <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">dimensions</span>.<span class="hljs-property">height</span>,
      <span class="hljs-attr">container</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>
    });
  }

  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeObserver</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeObserver</span>.<span class="hljs-title function_">disconnect</span>();
    }
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>);
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceTimer</span>);
  }
}
</code></pre>
<h5 data-id="heading-12">5.2 事件管理系统</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EventManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventHandlers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventQueue</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">processing</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// 事件绑定</span>
  <span class="hljs-title function_">on</span>(<span class="hljs-params">element, eventType, handler, options = {}</span>) {
    <span class="hljs-keyword">const</span> eventKey = <span class="hljs-string">`<span class="hljs-subst">${eventType}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}</span>`</span>;
    <span class="hljs-keyword">const</span> wrappedHandler = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createWrappedHandler</span>(handler, options);
    
    element.<span class="hljs-title function_">addEventListener</span>(eventType, wrappedHandler, options);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventHandlers</span>.<span class="hljs-title function_">set</span>(eventKey, {
      element,
      eventType,
      <span class="hljs-attr">handler</span>: wrappedHandler,
      <span class="hljs-attr">originalHandler</span>: handler,
      options
    });
    
    <span class="hljs-keyword">return</span> eventKey;
  }

  <span class="hljs-title function_">createWrappedHandler</span>(<span class="hljs-params">handler, options</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (options.<span class="hljs-property">throttle</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">throttle</span>(handler, options.<span class="hljs-property">throttle</span>, event);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.<span class="hljs-property">debounce</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">debounce</span>(handler, options.<span class="hljs-property">debounce</span>, event);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">handler</span>(event);
      }
    };
  }

  <span class="hljs-comment">// 节流</span>
  <span class="hljs-title function_">throttle</span>(<span class="hljs-params">func, limit, ...args</span>) {
    <span class="hljs-keyword">let</span> inThrottle;
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (!inThrottle) {
        func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
        inThrottle = <span class="hljs-literal">true</span>;
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> inThrottle = <span class="hljs-literal">false</span>, limit);
      }
    };
  }

  <span class="hljs-comment">// 防抖</span>
  <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, wait, ...args</span>) {
    <span class="hljs-keyword">let</span> timeout;
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">clearTimeout</span>(timeout);
      timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), wait);
    };
  }

  <span class="hljs-comment">// 事件委托</span>
  <span class="hljs-title function_">delegate</span>(<span class="hljs-params">parent, selector, eventType, handler</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(parent, eventType, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> target = event.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(selector);
      <span class="hljs-keyword">if</span> (target &amp;&amp; parent.<span class="hljs-title function_">contains</span>(target)) {
        handler.<span class="hljs-title function_">call</span>(target, event);
      }
    });
  }

  <span class="hljs-comment">// 移除事件</span>
  <span class="hljs-title function_">off</span>(<span class="hljs-params">eventKey</span>) {
    <span class="hljs-keyword">const</span> eventInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventHandlers</span>.<span class="hljs-title function_">get</span>(eventKey);
    <span class="hljs-keyword">if</span> (eventInfo) {
      eventInfo.<span class="hljs-property">element</span>.<span class="hljs-title function_">removeEventListener</span>(
        eventInfo.<span class="hljs-property">eventType</span>,
        eventInfo.<span class="hljs-property">handler</span>,
        eventInfo.<span class="hljs-property">options</span>
      );
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventHandlers</span>.<span class="hljs-title function_">delete</span>(eventKey);
    }
  }

  <span class="hljs-comment">// 一次性事件</span>
  <span class="hljs-title function_">once</span>(<span class="hljs-params">element, eventType, handler</span>) {
    <span class="hljs-keyword">const</span> eventKey = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">on</span>(element, eventType, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-title function_">handler</span>(event);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(eventKey);
    });
    <span class="hljs-keyword">return</span> eventKey;
  }

  <span class="hljs-comment">// 触发自定义事件</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-params">element, eventType, detail = {}</span>) {
    <span class="hljs-keyword">const</span> event = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(eventType, {
      <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">cancelable</span>: <span class="hljs-literal">true</span>,
      detail
    });
    element.<span class="hljs-title function_">dispatchEvent</span>(event);
  }

  <span class="hljs-comment">// 批量移除事件</span>
  <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventHandlers</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">eventInfo, key</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">off</span>(key);
    });
  }
}
</code></pre>
<h4 data-id="heading-13">6. 实战案例: 集成可视化仪表板</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VisualizationDashboard</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">containerId, dataSource</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(containerId);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span> = dataSource;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventManager</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventManager</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadData</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupLayout</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderComponents</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupInteractions</span>();
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">getData</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processData</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load data:'</span>, error);
    }
  }

  <span class="hljs-title function_">processData</span>(<span class="hljs-params">rawData</span>) {
    <span class="hljs-comment">// 数据处理逻辑</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">summary</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateSummary</span>(rawData),
      <span class="hljs-attr">trends</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractTrends</span>(rawData),
      <span class="hljs-attr">categories</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">groupByCategory</span>(rawData)
    };
  }

  <span class="hljs-title function_">setupLayout</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 使用CSS Grid或Flexbox创建响应式布局</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
      &lt;div class="dashboard-grid"&gt;
        &lt;div class="header" id="dashboard-header"&gt;
          &lt;h1&gt;数据可视化仪表板&lt;/h1&gt;
          &lt;div class="controls" id="dashboard-controls"&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="chart chart-large" id="main-chart"&gt;&lt;/div&gt;
        &lt;div class="chart chart-small" id="chart-1"&gt;&lt;/div&gt;
        &lt;div class="chart chart-small" id="chart-2"&gt;&lt;/div&gt;
        &lt;div class="chart chart-small" id="chart-3"&gt;&lt;/div&gt;
        &lt;div class="stats-panel" id="stats-panel"&gt;&lt;/div&gt;
      &lt;/div&gt;
    `</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupResponsive</span>();
  }

  <span class="hljs-title function_">setupResponsive</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> responsive = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponsiveVisualization</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>,
      <span class="hljs-function">(<span class="hljs-params">dimensions</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleResize</span>(dimensions),
      { <span class="hljs-attr">debounceDelay</span>: <span class="hljs-number">150</span> }
    );
  }

  <span class="hljs-title function_">renderComponents</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 渲染各个可视化组件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'mainChart'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createMainChart</span>());
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'chart1'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createPieChart</span>());
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'chart2'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createBarChart</span>());
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'chart3'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createLineChart</span>());
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'stats'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createStatsPanel</span>());
  }

  <span class="hljs-title function_">createMainChart</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'main-chart'</span>);
    <span class="hljs-keyword">const</span> chartType = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">determineBestChart</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span>.<span class="hljs-property">trends</span>);
    
    <span class="hljs-keyword">switch</span> (chartType) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'line'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createLineChart</span>(container, <span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span>.<span class="hljs-property">trends</span>, {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'趋势分析'</span>,
          <span class="hljs-attr">showLegend</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">animated</span>: <span class="hljs-literal">true</span>
        });
      <span class="hljs-keyword">case</span> <span class="hljs-string">'bar'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createBarChart</span>(container, <span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span>.<span class="hljs-property">categories</span>, {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'分类对比'</span>,
          <span class="hljs-attr">stacked</span>: <span class="hljs-literal">true</span>
        });
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createCustomVisualization</span>(container, <span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span>);
    }
  }

  <span class="hljs-title function_">setupInteractions</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 设置组件间的交互</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">component, id</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (component.<span class="hljs-property">onClick</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventManager</span>.<span class="hljs-title function_">on</span>(
          component.<span class="hljs-property">element</span>,
          <span class="hljs-string">'click'</span>,
          <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleComponentClick</span>(id, event)
        );
      }
    });
    
    <span class="hljs-comment">// 全局筛选器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupFilters</span>();
  }

  <span class="hljs-title function_">setupFilters</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> controls = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'dashboard-controls'</span>);
    controls.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
      &lt;select id="time-range"&gt;
        &lt;option value="7d"&gt;最近7天&lt;/option&gt;
        &lt;option value="30d"&gt;最近30天&lt;/option&gt;
        &lt;option value="90d"&gt;最近90天&lt;/option&gt;
      &lt;/select&gt;
      &lt;button id="refresh-btn"&gt;刷新数据&lt;/button&gt;
    `</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventManager</span>.<span class="hljs-title function_">on</span>(
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'time-range'</span>),
      <span class="hljs-string">'change'</span>,
      <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleTimeRangeChange</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>)
    );
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventManager</span>.<span class="hljs-title function_">on</span>(
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'refresh-btn'</span>),
      <span class="hljs-string">'click'</span>,
      <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refreshData</span>()
    );
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">refreshData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadData</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateAllComponents</span>();
  }

  <span class="hljs-title function_">updateAllComponents</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">component</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (component.<span class="hljs-property">update</span>) {
        component.<span class="hljs-title function_">update</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">processedData</span>);
      }
    });
  }

  <span class="hljs-title function_">handleComponentClick</span>(<span class="hljs-params">componentId, event</span>) {
    <span class="hljs-comment">// 处理组件点击事件，实现联动</span>
    <span class="hljs-keyword">const</span> clickedData = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractDataFromEvent</span>(event);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">component, id</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (id !== componentId &amp;&amp; component.<span class="hljs-property">filter</span>) {
        component.<span class="hljs-title function_">filter</span>(clickedData);
      }
    });
  }

  <span class="hljs-title function_">handleResize</span>(<span class="hljs-params">dimensions</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">component</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (component.<span class="hljs-property">resize</span>) {
        component.<span class="hljs-title function_">resize</span>(dimensions);
      }
    });
  }

  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">components</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">component</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (component.<span class="hljs-property">destroy</span>) {
        component.<span class="hljs-title function_">destroy</span>();
      }
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventManager</span>.<span class="hljs-title function_">cleanup</span>();
  }
}
</code></pre>
<h4 data-id="heading-14">7. 性能优化与最佳实践</h4>
<h5 data-id="heading-15">7.1 内存管理</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">references</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoryLeakDetector</span> = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// 智能引用计数</span>
  <span class="hljs-title function_">trackReference</span>(<span class="hljs-params">object, type</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">references</span>.<span class="hljs-title function_">has</span>(object)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">references</span>.<span class="hljs-title function_">set</span>(object, {
        type,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">refCount</span>: <span class="hljs-number">0</span>
      });
    }
    
    <span class="hljs-keyword">const</span> refInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">references</span>.<span class="hljs-title function_">get</span>(object);
    refInfo.<span class="hljs-property">refCount</span>++;
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      refInfo.<span class="hljs-property">refCount</span>--;
      <span class="hljs-keyword">if</span> (refInfo.<span class="hljs-property">refCount</span> &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanupObject</span>(object);
      }
    };
  }

  <span class="hljs-comment">// 对象池</span>
  <span class="hljs-title function_">createObjectPool</span>(<span class="hljs-params">factory, size</span>) {
    <span class="hljs-keyword">const</span> pool = {
      <span class="hljs-attr">available</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(size).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">factory</span>()),
      <span class="hljs-attr">inUse</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(),
      <span class="hljs-attr">acquire</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">available</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">const</span> obj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">available</span>.<span class="hljs-title function_">pop</span>();
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">inUse</span>.<span class="hljs-title function_">add</span>(obj);
          <span class="hljs-keyword">return</span> obj;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">factory</span>();
      },
      <span class="hljs-attr">release</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">inUse</span>.<span class="hljs-title function_">has</span>(obj)) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">inUse</span>.<span class="hljs-title function_">delete</span>(obj);
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">available</span>.<span class="hljs-title function_">push</span>(obj);
        }
      }
    };
    
    <span class="hljs-keyword">return</span> pool;
  }

  <span class="hljs-comment">// 缓存管理</span>
  <span class="hljs-title function_">createCache</span>(<span class="hljs-params">maxSize = <span class="hljs-number">100</span>, ttl = <span class="hljs-number">60000</span></span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">data</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(),
      maxSize,
      ttl,
      
      <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">size</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>) {
          <span class="hljs-keyword">const</span> oldestKey = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">delete</span>(oldestKey);
        }
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">set</span>(key, {
          value,
          <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
          <span class="hljs-attr">expire</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + <span class="hljs-variable language_">this</span>.<span class="hljs-property">ttl</span>
        });
      },
      
      <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {
        <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">get</span>(key);
        
        <span class="hljs-keyword">if</span> (!item) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &gt; item.<span class="hljs-property">expire</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">delete</span>(key);
          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-keyword">return</span> item.<span class="hljs-property">value</span>;
      }
    };
  }

  <span class="hljs-comment">// 内存泄漏检测</span>
  <span class="hljs-title function_">setupLeakDetection</span>(<span class="hljs-params">interval = <span class="hljs-number">30000</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoryLeakDetector</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkForLeaks</span>();
    }, interval);
  }

  <span class="hljs-title function_">checkForLeaks</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> leaks = [];
    
    <span class="hljs-comment">// 简化的泄漏检测逻辑</span>
    <span class="hljs-comment">// 实际应用中需要更复杂的检测机制</span>
    
    <span class="hljs-keyword">if</span> (leaks.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Potential memory leaks detected:'</span>, leaks);
    }
  }

  <span class="hljs-title function_">cleanupObject</span>(<span class="hljs-params">object</span>) {
    <span class="hljs-comment">// 清理对象的资源</span>
    <span class="hljs-keyword">if</span> (object.<span class="hljs-property">dispose</span> &amp;&amp; <span class="hljs-keyword">typeof</span> object.<span class="hljs-property">dispose</span> === <span class="hljs-string">'function'</span>) {
      object.<span class="hljs-title function_">dispose</span>();
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">references</span>.<span class="hljs-title function_">delete</span>(object);
  }
}
</code></pre>
<h4 data-id="heading-16">总结</h4>
<p>本文详细介绍了Web可视化技术的核心实现，包括Canvas绘图、SVG操作、拖拽交互和动画系统。通过封装可复用的工具类，我们可以构建高性能、可维护的可视化应用。</p>
<p><strong>关键实现总结:</strong></p>
<ol>
<li><strong>Canvas优化:</strong> 使用离屏渲染、批量操作和双缓冲技术</li>
<li><strong>SVG矢量:</strong> 利用DOM操作和CSS动画实现流畅的可视化</li>
<li><strong>交互体验:</strong> 实现平滑的拖拽和丰富的用户交互</li>
<li><strong>动画性能:</strong> 基于requestAnimationFrame的高性能动画引擎</li>
<li><strong>响应式设计:</strong> 自动适配不同屏幕尺寸和分辨率</li>
<li><strong>内存管理:</strong> 有效管理资源，防止内存泄漏</li>
</ol>
<p>这些实现不仅展示了各种可视化技术的核心原理，还提供了实际项目中可以使用的完整解决方案。通过理解这些底层实现，开发者可以更好地掌握可视化技术，创建出更高效、更美观、更交互性强的可视化应用。</p>
<p>可视化技术的核心在于将抽象数据转化为直观的视觉形式，帮助用户理解和发现数据中的模式与洞见。随着Web技术的不断发展，前端可视化将继续在各个领域发挥重要作用，从数据仪表盘到科学可视化，从游戏开发到虚拟现实，可视化技术的前景无限广阔。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Steam玩累了？那用 Node.js 写个小游戏：手把手玩懂 JS 运行环境]]></title>    <link>https://juejin.cn/post/7587017021314072611</link>    <guid>https://juejin.cn/post/7587017021314072611</guid>    <pubDate>2025-12-24T06:44:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587017021314072611" data-draft-id="7586944874527227942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Steam玩累了？那用 Node.js 写个小游戏：手把手玩懂 JS 运行环境"/> <meta itemprop="keywords" content="前端,Node.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-24T06:44:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Steam玩累了？那用 Node.js 写个小游戏：手把手玩懂 JS 运行环境
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:44:35.000Z" title="Wed Dec 24 2025 06:44:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>你可能听说过 <strong>“<code>Node.js</code> 是 <code>JS</code> 的运行环境”</strong>，但这玩意儿到底咋用？提到 <code>JavaScript</code>，你可能先想到它在浏览器里折腾网页特效的样子；但 <code>Node.js</code> 的出现，直接把 JS 从浏览器 <strong>“解放”</strong> 了出来，让它能像 <code>Python</code>、<code>Java</code> 一样，在操作系统上<strong>呼风唤雨</strong> —— 读写文件、操作终端、搭建后端服务都不在话下。而<strong>模块化</strong>，正是 Node.js 让代码变得整洁、可复用的<strong>核心秘诀</strong>。</p>
<p>今天咱从<strong>模块化</strong>入手，再手把手写个小游戏，让你把<code>Node.js</code>玩明白！</p>
<h3 data-id="heading-1">一、先认识 Node.js 的 “自带工具”：process、__dirname 这些都啥啊？</h3>
<p><code>Node.js</code> 刚启动时，就给我们准备了一堆 “开箱即用” 的工具。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 最基础的控制台输出，和浏览器里的console.log用法一致</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);

<span class="hljs-comment">// Date对象：处理时间和日期，比如new Date()能获取当前时间</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Date</span>);

<span class="hljs-comment">// 定时器方法：Node.js 里也能设置延时/重复执行的代码</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">setTimeout</span>); <span class="hljs-comment">// 延时执行（毫秒级）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-built_in">setInterval</span>); <span class="hljs-comment">// 重复执行（毫秒级）</span>
<span class="hljs-comment">// console.log(requestAnimationFrame); // 适配浏览器/Node.js的帧动画（Node.js 16+支持）</span>

<span class="hljs-comment">// 路径相关：定位文件位置的“神器”</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(__dirname); <span class="hljs-comment">// 打印当前文件所在文件夹的绝对路径</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(__filename); <span class="hljs-comment">// 打印当前文件的完整绝对路径（包含文件名）</span>

<span class="hljs-comment">// 进程参数：获取终端执行命令时传的参数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(process.<span class="hljs-property">argv</span>);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa205234674f4047916e04507d2738c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=23kvnQAlrhS4cs2k7k7tP%2BB5usU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">二、Node.js 模块化：代码也能 “打包快递”</h3>
<p>写代码像<strong>搭积木</strong> —— 把重复的功能拆成独立文件，要用的时候 “拼” 起来，这就是<strong>模块化</strong>。<code>Node.js</code> 支持两种主流规范：</p>
<h4 data-id="heading-3">1. CommonJS：Node.js 自带的 “老牌规范”</h4>
<p>就像你寄快递时填 <strong>“收件人信息”</strong>，CommonJS 用 <code>module.exports</code> 打包功能，<code>require()</code> 取快递：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// lib.js（打包功能）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x, y</span>) {
    <span class="hljs-keyword">return</span> x + y;
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">minus</span>(<span class="hljs-params">x, y</span>) {
    <span class="hljs-keyword">return</span> x - y;
}
<span class="hljs-comment">// 把 add 和 munus 打包成 “快递”</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    add,
    minus
}
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// index.js（取快递用功能）</span>
<span class="hljs-comment">// 用 require 拿到 lib.js 里的 add</span>
<span class="hljs-keyword">const</span> lib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib.js'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lib.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));    <span class="hljs-comment">// 输出 3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lib.<span class="hljs-title function_">minus</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));  <span class="hljs-comment">// 输出 -1</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0d0b1164778438f93717ade0ccb5406~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=ewq3XaoLLgIbg4Lvg6%2Bi6eheZtE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa28b665dcd34c08ac89d5b14ec4faad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=LWRXdLFeVzwLohzlyh9RGpG3t9w%3D" alt="image.png" loading="lazy"/></p>
<p>当然每次<code>console.log</code>都要写一遍<code>lib.</code>，会感到很烦，所以这里用解构的方法会更舒服点：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> {add, minus} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib.js'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">minus</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77d7cb5d2e1544e9a9d77c6fc56bd950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=b8xJB4Zk8ijPCl7GZH1JidLjnYk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">2. ESModule：前端圈的 “新潮流规范”</h4>
<p>如果你的项目想和浏览器端代码 <strong>“互通”</strong>，可以用 <code>ESModule</code>,但是但是但是重要的事情说三遍：得在 <code>package.json</code> 里加 <code>"type": "module"</code>（一般情况下是有的，直接修改<code>type</code>里的值即可）。</p>
<p>上图更清晰：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/346db870a8fc41e9acc73280306195a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=qM3UJ%2FNkPXaWrjM9yWtnhZWLpDU%3D" alt="image.png" loading="lazy"/></p>
<p>还是 <code>common</code> 文件夹的例子：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// lib.js（用 export default 打包）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x, y</span>){
    <span class="hljs-keyword">return</span> x + y;
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">minus</span>(<span class="hljs-params">x, y</span>){
    <span class="hljs-keyword">return</span> x - y;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    add,
    minus
}
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// index.js（用 import 导入）</span>
<span class="hljs-keyword">import</span> lib <span class="hljs-keyword">from</span> <span class="hljs-string">'./lib.js'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lib.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));    <span class="hljs-comment">// 输出 3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(lib.<span class="hljs-title function_">minus</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));  <span class="hljs-comment">// 输出 -1</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59c339de367d4d91ad232f19074688f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=UPYsSVVF933EPOHNTQD96ZyzsHM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">三、实战：用 Node.js 写 “石头剪刀布” 游戏</h3>
<p>没错，<strong>“石头剪刀布”</strong> 怎么就不算小游戏了，这可不算欺骗哦😮。好了我知道你肯定会觉得很简单然后马上打开Steam的，但来都来了，那就👀看我如何用<code>Node.js</code>写出来的。</p>
<p>逻辑很简单：你在终端输入 <strong>“rock/scissor/paper”</strong>，电脑随机出拳，然后比胜负～</p>
<h4 data-id="heading-6">第一步：先写 “游戏核心逻辑”（模块化拆分）</h4>
<p>把 “出拳、比胜负” 的功能拆到 <code>game/lib.js</code> 里</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// game/lib.js（游戏核心逻辑）</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">playerAction</span>) {
    <span class="hljs-comment">// 电脑随机出拳（rock/scissor/paper 三选一）</span>
    <span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'rock'</span>, <span class="hljs-string">'scissor'</span>, <span class="hljs-string">'paper'</span>];
    <span class="hljs-keyword">const</span> index = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">3</span>); <span class="hljs-comment">// 向下取整(0,1,2)</span>
    <span class="hljs-keyword">const</span> computerAction = arr[index];
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`我出了<span class="hljs-subst">${computerAction}</span>`</span>);

    <span class="hljs-comment">// 比胜负，返回结果（0=平，-1=你赢，1=你输）</span>
    <span class="hljs-keyword">if</span> (computerAction === playerAction) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'平局'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((playerAction === <span class="hljs-string">'rock'</span> &amp;&amp; computerAction === <span class="hljs-string">'scissor'</span>) ||
        (playerAction === <span class="hljs-string">'scissor'</span> &amp;&amp; computerAction === <span class="hljs-string">'paper'</span>) ||
        (playerAction === <span class="hljs-string">'paper'</span> &amp;&amp; computerAction === <span class="hljs-string">'rock'</span>)) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'你赢了'</span>);
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'你输了'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
}
</code></pre>
<h4 data-id="heading-7">第二步：写 “终端交互逻辑”（调用核心功能）</h4>
<p>在 <code>game/index.js</code> 里，用 Node.js 的 <code>process</code> 模块获取你在终端的输入，再调用游戏逻辑:</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// game/index.js（终端交互）</span>
<span class="hljs-keyword">const</span> game = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib.js'</span>);
<span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// 统计你赢的次数</span>

<span class="hljs-comment">// 监听终端输入（你输入的内容会传到 e 里）</span>
process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-comment">// 把输入的内容转成字符串，去掉空格</span>
    <span class="hljs-keyword">const</span> playerAction = e.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();
    <span class="hljs-comment">// 调用游戏逻辑，拿到结果</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">game</span>(playerAction);
    
    <span class="hljs-keyword">if</span> (result === -<span class="hljs-number">1</span>) {
        count++;
    }
    
    <span class="hljs-comment">// 赢 3 次就结束游戏</span>
    <span class="hljs-keyword">if</span> (count === <span class="hljs-number">3</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'你太厉害了，我不玩了'</span>);
        process.<span class="hljs-title function_">exit</span>(); <span class="hljs-comment">// 结束 Node.js 进程</span>
    }
});
</code></pre>
<h4 data-id="heading-8">第三步：跑起来！在终端玩游戏</h4>
<p>打开终端，进入 <code>game</code> 文件夹，执行：</p>
<pre><code class="hljs language-bash" lang="bash">node index.js
</code></pre>
<p>然后输入 <code>rock</code>/<code>scissor</code>/<code>paper</code>，就能和电脑 PK 啦～</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1595278193e947b79d6965f03cfe917b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=EYi5D8Gg7Lbf0XWXL3M0DgRl5oE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83735c5f618848fa95088d88408465b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163475&amp;x-signature=mhZjGX8nzrgKNjpqlzPBhDPjceE%3D" alt="image.png" loading="lazy"/></p>
<p>占用你玩2分钟玩Steam的时间看完了我的石头剪刀布~ 😊 ⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄</p>
<h3 data-id="heading-9">四、总结：Node.js 到底是啥？</h3>
<p><strong>一句话：</strong> 它不仅是 “JS 运行环境”，更是<strong>让你用 JS 写 “能和操作系统互动” 代码的工具</strong>—— 比如读文件、监听终端输入、写后端服务… 而模块化是它的 “基本功”，帮你把代码写得更整洁、更好维护～</p>
<h2 data-id="heading-10">结语</h2>
<p>从模块化规范的拆解，到石头剪刀布游戏的落地，不难发现 <strong>Node.js</strong> 的魅力：它让 JavaScript 跳出了前端的局限，拥有了跨场景开发的能力。小小的 <code>require</code> 和 <code>export</code> 背后，是代码组织的大智慧；简单的终端交互游戏里，藏着后端开发的雏形。</p>
<p>希望这篇内容能让你对 <code>Node.js</code> 不再陌生，下次遇到复杂项目时，也能想起用模块化思维拆解问题，用 <strong>Node.js</strong> 敲出属于自己的有趣代码。</p>
<p>另外要查看<code>Node.js</code>详细资料的话，官网在这：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn" target="_blank" title="https://nodejs.org/zh-cn" ref="nofollow noopener noreferrer">Node.js 官网</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[子组件和父组件之间优雅通信---松耦合]]></title>    <link>https://juejin.cn/post/7587017021314187299</link>    <guid>https://juejin.cn/post/7587017021314187299</guid>    <pubDate>2025-12-24T06:52:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587017021314187299" data-draft-id="7586941468873179170" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="子组件和父组件之间优雅通信---松耦合"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-24T06:52:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="快乐星球喂"/> <meta itemprop="url" content="https://juejin.cn/user/662375936570116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            子组件和父组件之间优雅通信---松耦合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662375936570116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    快乐星球喂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:52:45.000Z" title="Wed Dec 24 2025 06:52:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、传统的写法</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父组件</span>
&lt;!-- 父组件 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> 
    @<span class="hljs-attr">tabActiveFn</span>=<span class="hljs-string">"onTabActiveUpdate"</span>
  /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"goOrder"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">refresh</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'刷新数据'</span>);
    },
    <span class="hljs-title function_">onTabActiveUpdate</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabActive</span> = newValue;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refresh</span>();
    },
     <span class="hljs-title function_">goOrder</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">replace</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'order'</span> });
    },
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 子组件</span>
&lt;!-- 子组件 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in TAB"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[tabActive === item.index ? 'active' : 'tab']"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTab(item)"</span>&gt;</span> {{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"goOrder"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
<span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">tabActive</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">TAB</span>: [
        { <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'xxx服务'</span> },
        { <span class="hljs-attr">index</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'xxx服务'</span> }
      ],
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">changeTab</span>(<span class="hljs-params">item</span>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'tabActiveFn'</span>, item.<span class="hljs-property">index</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabActive</span> = item.<span class="hljs-property">index</span>;
    },
     <span class="hljs-title function_">goOrder</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">replace</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'order'</span> });
    },
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-1">2、使用语法糖</h2>
<ul>
<li>（1）父组件定义一个万能方法<code>onInvoke(action) { this[action]?.(); }</code>，根据传入的字符串调用对应方法。</li>
<li>（2）父组件通过自定义事件@invokeFn<code>&lt;ChildComponent @invokeFn="onInvoke"/&gt;</code>暴露给子组件。</li>
<li>（3）子组件<code>&lt;button @click="$emit('invokeFn', 'goOrder')"&gt;&lt;/button&gt;</code>，点击时，触发父组件<code>invokeFn</code>事件并传值<code>goOrder</code></li>
<li>（4）父组件收到事件，执行<code>onInvoke('goOrder')</code>，最终安全调用<code>goOrder</code>方法。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父组件</span>
&lt;!-- 父组件 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> 
    @<span class="hljs-attr">tabActiveFn</span>=<span class="hljs-string">"onTabActiveUpdate"</span>
    @<span class="hljs-attr">invokeFn</span>=<span class="hljs-string">"onInvoke"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">refresh</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 刷新数据</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'刷新数据'</span>);
    },
    <span class="hljs-title function_">onTabActiveUpdate</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabActive</span> = newValue;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refresh</span>();
    },
    <span class="hljs-title function_">goOrder</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">replace</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'order'</span> });
    },
    <span class="hljs-title function_">onInvoke</span>(<span class="hljs-params">action</span>) {
      <span class="hljs-variable language_">this</span>[action]?.();
    },
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 子组件</span>
&lt;!-- 子组件 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in TAB"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[tabActive === item.index ? 'active' : 'tab']"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTab(item)"</span>&gt;</span> {{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"$emit('invokeFn', 'goOrder')"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
<span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">tabActive</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">TAB</span>: [
        { <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'xxx服务'</span> },
        { <span class="hljs-attr">index</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'xxx服务'</span> }
      ],
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">changeTab</span>(<span class="hljs-params">item</span>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'tabActiveFn'</span>, item.<span class="hljs-property">index</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabActive</span> = item.<span class="hljs-property">index</span>;
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>其中，<code>this.[action]</code>，使用方括号语法，动态的访问当前对象（this）上名为action变量值的属性或者方法。例如：action是‘goOrder’,它就试图获取<code>this.goOrder</code>。</p>
<p><code>?()</code>是可<strong>选链操作符</strong>和<strong>函数</strong>的结合，如果<code>this.[action]</code>的值不是<code>null</code>或者<code>undefined</code>，则调用该函数；如果是，则整个<code>表达式短路</code>，返回<code>undefined</code>，而不会抛出错误。</p>
<p>可选链<code>?.</code>是ES2020中引入的一个非常实用的语法。它的核心价值是在于<strong>防止在访问嵌套属性或者方法时，因中间某个值为null或者undefined而导致运行时错误</strong>。</p>
<h4 data-id="heading-2">优点：松耦合，子组件完全不需要知道父组件具体有哪些方法，它只需要知道自己需要触发什么指令。父组件则负责接收指令并执行对应的逻辑，这使得子组件的复用性非常高，可以轻松被不同父组件使用，只要这些父组件都实现了相应的指令并监听了对应的事件即可。</h4></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NodeJs：前端工程化推手]]></title>    <link>https://juejin.cn/post/7586957587077398578</link>    <guid>https://juejin.cn/post/7586957587077398578</guid>    <pubDate>2025-12-24T06:58:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586957587077398578" data-draft-id="7586941468872720418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NodeJs：前端工程化推手"/> <meta itemprop="keywords" content="Node.js"/> <meta itemprop="datePublished" content="2025-12-24T06:58:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fighting不想说话"/> <meta itemprop="url" content="https://juejin.cn/user/1116759545614173"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NodeJs：前端工程化推手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759545614173/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fighting不想说话
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:58:31.000Z" title="Wed Dec 24 2025 06:58:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Node.js到底是什么？</h2>
<p>html+css+javaScript写的好好的，突然来了一个 Node，这到底是个什么东西？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee4b23a2ae8c4d8795a67ecd6ea4baca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmlnaHRpbmfkuI3mg7Por7Tor50=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164989&amp;x-signature=pFxSi50XTD7B1W33Xpd3Y5XmilM%3D" alt="Node.js 官方 Logo" loading="lazy"/></p>
<p>Node.js（简称 Node）是一个让 JavaScript 在浏览器之外运行 的开源运行时环境。简单说，它把 JavaScript 从“只能在网页里跑”的限制中解放出来，让你可以用 JS 写服务器程序、命令行工具、桌面应用，甚至前端构建脚本。</p>
<h4 data-id="heading-1">一、旧时代的结构性困境</h4>
<p>早年的前端开发，表面看是“手工活多”，实际上是遇到了硬性天花板。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span><span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"lib/bootstrap-3.3.7/css/bootstrap.min.css"</span>&gt;</span>
   
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"css/reset.css"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"css/common.css"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"css/index.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中。。。<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    // script
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"lib/jquery/jquery-1.12.4.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"lib/lodash/lodash.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"lib/bootstrap-3.3.7/js/bootstrap.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/config.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/utils.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/api.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/index.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 入口函数</span>
        $(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-comment">// 访问全局变量，毫无约束</span>
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ul>
<li>手动管理一堆 script 标签，下载各种js文件，依赖顺序全靠记忆。</li>
<li>全局作用域污染严重，变量冲突是家常便饭。</li>
<li>HTTP 请求爆炸，几十个文件加载慢得影响核心指标。</li>
<li>上线前手动合并、压缩、雪碧图、inline 资源、cdn地址，全靠经验和脚本。</li>
</ul>
<p>这些问题本质上是<strong>浏览器 JavaScript 的安全沙箱限制</strong>：无法访问本地文件系统，直接导致我们无法构建任何可靠的自动化流程。</p>
<p>结果前端就被困在“<strong>页面仔</strong>”的定位里：</p>
<ul>
<li>项目规模很难上量（页面过多就乱套）。</li>
<li>代码复用率低（没有模块化）。</li>
<li>团队协作成本高（全局污染导致 merge 冲突频繁）。</li>
<li>性能优化全靠个人英雄主义。</li>
</ul>
<h4 data-id="heading-2">二、Node.js 带来了什么？</h4>
<p>Node.js 自 2009 年诞生以来，已经彻底改变了 JavaScript 的生态和应用场景。</p>
<h5 data-id="heading-3">Node 的工作原理：</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9f6a2d6f68742068242af693e8deafa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmlnaHRpbmfkuI3mg7Por7Tor50=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164989&amp;x-signature=p2k7qMIde9fEBVv7cOGvHjcRNyE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>V8 引擎</strong>：负责解析和执行 JavaScript 代码，高性能编译。</li>
<li><strong>libuv</strong>：C 语言编写的跨平台 I/O 库，提供事件循环、线程池、异步 I/O 支持。</li>
<li><strong>原生模块</strong>：如 http、fs、net 等，通过 C++ 绑定层连接 V8 和 libuv。</li>
<li><strong>JavaScript 层</strong>：我们写的代码 + NPM 包。</li>
</ul>
<h6 data-id="heading-4">① 事件循环 （Event Loop）</h6>
<p>Node 是单线程的，但通过事件循环实现并发。事件循环是 libuv 的核心，不断轮询处理事件队列。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/612cf28b160947028058adeef0ebac8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmlnaHRpbmfkuI3mg7Por7Tor50=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164989&amp;x-signature=I4rgc3%2FNBpMN1KM2EqxGphbEfbQ%3D" alt="image.png" loading="lazy"/></p>
<p>Node 就像一家只有<strong>一名超级服务员</strong>（Event Loop）的餐厅：<strong>顾客（Request）</strong> 源源不断进店点餐，服务员接单后，如果是 <strong>倒水这种简单活（同步任务）</strong> 就当场解决，一旦遇到需要烹饪的“硬菜”（耗时 I/O），他会立刻把单子甩给幕后的<strong>厨师团队（Thread Pool）</strong> 去处理，然后自己马上转头接待下一位顾客；等厨师团队从 <strong>食材仓库中（Database/File System/Networks/Others）</strong> 取出对应的食材，把菜 <strong>做好了（Operation Completed）</strong>，会把“上菜”塞回服务员的列表里，服务员趁着空档把菜端给对应的顾客（执行回调），从而用一个人实现了海量订单的高效流转。</p>
<h6 data-id="heading-5">② 非阻塞 I/O 模型</h6>
<p>传统阻塞 I/O：一个请求占用线程，等待完成才处理下一个。</p>
<p>Node 非阻塞：遇到 I/O 操作（如读文件、网络请求），直接交给操作系统内核或线程池异步处理，主线程立即继续执行其他代码。完成后，通过事件通知回调。</p>
<h5 data-id="heading-6">Node 的优势与特点</h5>
<ul>
<li><strong>文件系统操作（fs 模块）</strong>：JS 终于能读写本地文件了。</li>
<li><strong>NPM 包管理</strong>：全球最大的包生态，安装依赖一句话搞定。</li>
<li><strong>命令行工具</strong>：基于 Node，我们能写脚本自动化一切。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e24def68b2740b79ec1d3d4f9534986~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmlnaHRpbmfkuI3mg7Por7Tor50=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164989&amp;x-signature=dE1eyTqry5MYJUvtvgJB5tOu80c%3D" alt="NPM 生态示意图" loading="lazy"/></p>
<p><strong>Node 只在开发和构建时用</strong>，上线后还是纯静态文件跑浏览器。就像盖房子用的塔吊，房子盖好就拆。</p>
<h4 data-id="heading-7">三、工程化跃迁</h4>
<h6 data-id="heading-8">① 从此 Node 造就了前端工程化的工具链：</h6>
<ul>
<li><strong>Webpack、Rollup、Vite</strong>：打包、模块化、Tree Shaking。</li>
<li><strong>Babel</strong>：语法转译（ES6+ 到 ES5）。</li>
<li><strong>ESLint、Prettier</strong>：代码规范。</li>
<li><strong>Dev Server + HMR</strong>：热模块替换，改代码秒刷新。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edb16f91f7934453ab8b7e9bbd1488a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmlnaHRpbmfkuI3mg7Por7Tor50=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164989&amp;x-signature=BrYVPmTVKlqovNln8A9lTEvHzIQ%3D" alt="3f1a98b9-81ad-4d83-ba1c-570108166835.png" loading="lazy"/></p>
<h6 data-id="heading-9">② Vue 和 React皆是 Node 工具链上的受益者</h6>
<p>在 Node 的工程化基础上，Vue 和 React 才能真正起飞。它们不是原因，而是结果 → 依赖工具链来编译、打包组件。</p>
<p><strong>Vue 的单文件组件（SFC）:</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 模板、脚本、样式一文件搞定 --&gt; 
&lt;template&gt;
  &lt;div&gt;
    &lt;h2&gt;计数器：{{ count }}&lt;/h2&gt;
    &lt;button @click="count++"&gt;+1&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue';
const count = ref(0);
&lt;/script&gt;

&lt;style scoped&gt;
button { padding: 10px; background: #42b983; color: white; }
&lt;/style&gt;
</code></pre>
<p><strong>React 的 JSX ：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Counter.jsx </span>
<span class="hljs-comment">// Babel @babel/preset-react preset 处理 JSX</span>

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) { 
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); 
    <span class="hljs-keyword">return</span> (
        ## 计数器：{count}
        <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)}&gt;+<span class="hljs-number">1</span>
    ); 
}
</code></pre>
<p>这些框架代码不管是在 <strong>开发时</strong>（<strong>快速启动、按需加载、语法转译、资源处理、插件生态等等</strong>） 还是 <strong>构建时</strong>（<strong>Tree Shaking、代码分割、资源优化、Chunk 命名和缓存优化、预加载/预获取等等</strong>） ，都高度依赖 Node 的相关工具链。可以说没有 Node，就没有今天的框架体验，当然也把我们从重复、低价值的体力活里彻底解放出来，给了我们一个高效、可靠的开发方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ElementUI：表格如何展示超出单元格的内容且不影响单元格？]]></title>    <link>https://juejin.cn/post/7587046913692073990</link>    <guid>https://juejin.cn/post/7587046913692073990</guid>    <pubDate>2025-12-24T07:09:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587046913692073990" data-draft-id="7587208390482247686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ElementUI：表格如何展示超出单元格的内容且不影响单元格？"/> <meta itemprop="keywords" content="前端,Vue.js,Element"/> <meta itemprop="datePublished" content="2025-12-24T07:09:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="simon9124"/> <meta itemprop="url" content="https://juejin.cn/user/1151943917712045"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ElementUI：表格如何展示超出单元格的内容且不影响单元格？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943917712045/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    simon9124
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:09:50.000Z" title="Wed Dec 24 2025 07:09:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsimon9124%2Fmy_demos" target="_blank" title="https://github.com/simon9124/my_demos" ref="nofollow noopener noreferrer">前端小讴</a>，阅读更多原创技术文章</strong></p>
</blockquote>
<ul>
<li>这个问题之前在封装<strong>表格行内编辑校验</strong>时就一直困扰我，近期因为业务需求又不得不面对了</li>
</ul>
<h2 data-id="heading-0">需求详述</h2>
<ul>
<li><code>ElementUi</code>表格列若干（肯定有横向滚动条），在若干行（不固定）的某一列上（不固定）展示指定文字，</li>
<li>要展示的文字长度大概率比该列宽度大</li>
<li>文字需要完整展示，可跨单元格</li>
</ul>
<h2 data-id="heading-1">尝试过程</h2>
<ul>
<li>直接使用<strong>自定义渲染单元格</strong>，失败，超出单元格部分会被遮盖</li>
<li>自定义指令在<code>document</code>上渲染内容，失败，定位很困难（很难拿到该单元格相对整个<code>document</code>的位置），且内容也不随滚动条滚动</li>
<li>使用<code>el-tooltip</code>，让其一直保持展示，失败，<code>el-tooltip</code>初始化没有定位，只有在鼠标移入时才有</li>
</ul>
<h2 data-id="heading-2">成功方案</h2>
<ul>
<li>使用<code>el-popover</code>弹出框的<strong>手动激活</strong>方式，其既保证<code>dom</code>结构在单元格里，又能打破<strong>内容无法超出单元格</strong>的壁垒</li>
</ul>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-table-column
    v-for="(column, i) in columnList"
    :key="column.value"
    width="20"
    class-name="gantt-column"
  &gt;
    &lt;template slot-scope="scope"&gt;
      &lt;div class="gantt-bar" :style="`background: green`"&gt;
        &lt;el-popover
          v-if="scope.row.percent"
          v-model="visible"
          popper-class="gantt-percent-popover"
          trigger="manual"
          :content="`${scope.row.percent}%`"
        &gt;
        &lt;/el-popover&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  &lt;/el-table-column&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  data() {
    return {
      columnList: [], // 动态表格列
      visible: true, // popover-始终展示
    };
  },
};
&lt;/script&gt;

&lt;style lang="scss"&gt;
.gantt-percent-popover {
  width: max-content;
  min-width: auto;
  border: none;
  box-shadow: none;
  background: none;
  padding: 0 !important;
  font-size: 14px;
  color: rgba(0, 0, 0, 1);
  font-weight: bold;
  // text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
  white-space: nowrap;
  height: 23px;
  line-height: 23px;
  transform: translate(-40%, 0);
  font-style: italic;
}
&lt;/style&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-19 快速掌握Kotlin-可空类型扩展函数]]></title>    <link>https://juejin.cn/post/7586994471739392043</link>    <guid>https://juejin.cn/post/7586994471739392043</guid>    <pubDate>2025-12-24T05:53:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586994471739392043" data-draft-id="7586994471739375659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-19 快速掌握Kotlin-可空类型扩展函数"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T05:53:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安卓老王"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-19 快速掌握Kotlin-可空类型扩展函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安卓老王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:53:43.000Z" title="Wed Dec 24 2025 05:53:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kotlin 中，<strong>可空类型扩展函数</strong> 是一种强大的特性，允许你为可空类型（<code>T?</code>）定义扩展函数。这些函数可以在可空变量上安全调用，避免了显式的空检查。</p>
<h2 data-id="heading-0">1. 基本语法</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为可空类型 String? 定义扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">safeLength</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.length ?: <span class="hljs-number">0</span>  <span class="hljs-comment">// 使用安全调用和 Elvis 操作符</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> name: String? = <span class="hljs-string">"Kotlin"</span>
    <span class="hljs-keyword">val</span> nullName: String? = <span class="hljs-literal">null</span>
    
    println(name.safeLength())     <span class="hljs-comment">// 6</span>
    println(nullName.safeLength()) <span class="hljs-comment">// 0 - 不会抛出 NPE</span>
}
</code></pre>
<h2 data-id="heading-1">2. 与不可空扩展函数的区别</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不可空扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">uppercaseFirst</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isNotEmpty()) {
        <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>].uppercase() + <span class="hljs-keyword">this</span>.substring(<span class="hljs-number">1</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>
    }
}

<span class="hljs-comment">// 可空扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">safeUppercaseFirst</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isNullOrEmpty()) {
        <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>].uppercase() + <span class="hljs-keyword">this</span>.substring(<span class="hljs-number">1</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span> ?: <span class="hljs-string">""</span>  <span class="hljs-comment">// 处理 null 情况</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> str: String? = <span class="hljs-string">"hello"</span>
    
    <span class="hljs-comment">// str.uppercaseFirst()  // 编译错误：需要不可空类型</span>
    println(str.safeUppercaseFirst())  <span class="hljs-comment">// "Hello"</span>
    
    println(<span class="hljs-literal">null</span>.safeUppercaseFirst()) <span class="hljs-comment">// "" - 不会崩溃</span>
}
</code></pre>
<h2 data-id="heading-2">3. 实际应用示例</h2>
<h3 data-id="heading-3">示例1：可空集合处理</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Collection<span class="hljs-type">&lt;T&gt;</span>?.<span class="hljs-title">isNullOrEmpty</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> == <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.isEmpty()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Collection<span class="hljs-type">&lt;T&gt;</span>?.<span class="hljs-title">safeSize</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.size ?: <span class="hljs-number">0</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> list: List&lt;String&gt;? = <span class="hljs-literal">null</span>
    println(list.isNullOrEmpty())  <span class="hljs-comment">// true</span>
    println(list.safeSize())       <span class="hljs-comment">// 0</span>
}
</code></pre>
<h3 data-id="heading-4">示例2：链式调用</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">toIntOrNull</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span>? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>?.toInt()
    } <span class="hljs-keyword">catch</span> (e: NumberFormatException) {
        <span class="hljs-literal">null</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">toIntWithDefault</span><span class="hljs-params">(default: <span class="hljs-type">Int</span> = <span class="hljs-number">0</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toIntOrNull() ?: default
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> input1: String? = <span class="hljs-string">"123"</span>
    <span class="hljs-keyword">val</span> input2: String? = <span class="hljs-string">"abc"</span>
    <span class="hljs-keyword">val</span> input3: String? = <span class="hljs-literal">null</span>
    
    println(input1.toIntWithDefault())  <span class="hljs-comment">// 123</span>
    println(input2.toIntWithDefault())  <span class="hljs-comment">// 0</span>
    println(input3.toIntWithDefault())  <span class="hljs-comment">// 0</span>
}
</code></pre>
<h3 data-id="heading-5">示例3：DSL 风格扩展</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T?.<span class="hljs-title">whenNotNull</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>) {
        block(<span class="hljs-keyword">this</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T, R&gt;</span> T?.<span class="hljs-title">whenNotNull</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">R</span>, default: <span class="hljs-type">R</span>)</span></span>: R {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>) {
        block(<span class="hljs-keyword">this</span>)
    } <span class="hljs-keyword">else</span> {
        default
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> name: String? = <span class="hljs-string">"Alice"</span>
    <span class="hljs-keyword">val</span> nullName: String? = <span class="hljs-literal">null</span>
    
    name.whenNotNull {
        println(<span class="hljs-string">"Name is <span class="hljs-variable">$it</span>"</span>)  <span class="hljs-comment">// 输出: Name is Alice</span>
    }
    
    nullName.whenNotNull {
        println(<span class="hljs-string">"This won't print"</span>)
    }
    
    <span class="hljs-keyword">val</span> length = name.whenNotNull({ it.length }, <span class="hljs-number">0</span>)
    println(length)  <span class="hljs-comment">// 5</span>
}
</code></pre>
<h2 data-id="heading-6">4. 作用域函数扩展</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> T?.<span class="hljs-title">withNotNull</span><span class="hljs-params">(block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">this</span>?.block()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any, R&gt;</span> T?.<span class="hljs-title">letNotNull</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.let(block)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> T?.<span class="hljs-title">alsoNotNull</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span>: T? {
    <span class="hljs-keyword">this</span>?.also(block)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> nullableValue: String? = <span class="hljs-string">"test"</span>
    
    nullableValue.withNotNull {
        println(uppercase())  <span class="hljs-comment">// 输出: TEST</span>
    }
    
    <span class="hljs-keyword">val</span> result = nullableValue.letNotNull {
        it.length * <span class="hljs-number">2</span>
    }
    println(result)  <span class="hljs-comment">// 8</span>
}
</code></pre>
<h2 data-id="heading-7">5. 实用工具函数</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 文件路径处理</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">toSafePath</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.trim()?.removeSuffix(<span class="hljs-string">"/"</span>) ?: <span class="hljs-string">""</span>
}

<span class="hljs-comment">// 日期字符串解析</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">toDateOrNull</span><span class="hljs-params">()</span></span>: LocalDate? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>?.let { LocalDate.parse(it) }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-literal">null</span>
    }
}

<span class="hljs-comment">// 数字格式化</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Number?.<span class="hljs-title">formatWithDefault</span><span class="hljs-params">(
    pattern: <span class="hljs-type">String</span> = <span class="hljs-string">"#,##0.00"</span>,
    default: <span class="hljs-type">String</span> = <span class="hljs-string">"N/A"</span>
)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        DecimalFormat(pattern).format(<span class="hljs-keyword">this</span> ?: <span class="hljs-keyword">return</span> default)
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        default
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> number: <span class="hljs-built_in">Double</span>? = <span class="hljs-number">1234.567</span>
    println(number.formatWithDefault())  <span class="hljs-comment">// 1,234.57</span>
    println(<span class="hljs-literal">null</span>.formatWithDefault())    <span class="hljs-comment">// N/A</span>
}
</code></pre>
<h2 data-id="heading-8">6. 最佳实践</h2>
<h3 data-id="heading-9">✅ 推荐的做法：</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 提供合理的默认值</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">orEmpty</span><span class="hljs-params">()</span></span>: String = <span class="hljs-keyword">this</span> ?: <span class="hljs-string">""</span>

<span class="hljs-comment">// 2. 明确表达意图</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">isNotNullOrBlank</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>.isNullOrBlank()
}

<span class="hljs-comment">// 3. 支持链式调用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">trimOrNull</span><span class="hljs-params">()</span></span>: String? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.trim()?.takeIf { it.isNotEmpty() }
}
</code></pre>
<h3 data-id="heading-10">❌ 避免的做法：</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 避免在扩展函数中抛出异常</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">unsafeLength</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>!!.length  <span class="hljs-comment">// 不要这样做！</span>
}

<span class="hljs-comment">// 避免混淆可空和不可空扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">unsafeForNullable</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>  <span class="hljs-comment">// 这个函数不能在 null 上调用</span>
}
</code></pre>
<h2 data-id="heading-11">7. 性能考虑</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 内联扩展函数减少开销</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T?.<span class="hljs-title">ifNotNull</span><span class="hljs-params">(block: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>) block(<span class="hljs-keyword">this</span>)
}

<span class="hljs-comment">// 对于频繁调用的简单扩展，使用内联</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">isNullOrEmpty</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> == <span class="hljs-literal">null</span> || isEmpty()
}
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>可空类型扩展函数的优点：</p>
<ol>
<li><strong>提升代码可读性</strong> - 将空检查逻辑封装在扩展中</li>
<li><strong>减少样板代码</strong> - 避免重复的 <code>if (x != null)</code> 检查</li>
<li><strong>增强表达力</strong> - 创建领域特定的安全操作</li>
<li><strong>支持链式调用</strong> - 在可能为空的链式操作中保持安全</li>
</ol>
<p>使用建议：</p>
<ul>
<li>为常用操作创建可空扩展</li>
<li>提供合理的默认返回值</li>
<li>保持函数纯函数特性（无副作用）</li>
<li>合理使用内联优化性能</li>
</ul>
<p>通过合理使用可空类型扩展函数，可以显著提高 Kotlin 代码的安全性和可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day04-APIs 日期对象]]></title>    <link>https://juejin.cn/post/7587023071066341428</link>    <guid>https://juejin.cn/post/7587023071066341428</guid>    <pubDate>2025-12-24T07:02:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587023071066341428" data-draft-id="7586617459487653940" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day04-APIs  日期对象"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-24T07:02:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="瘦的可以下饭了"/> <meta itemprop="url" content="https://juejin.cn/user/895474817042060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day04-APIs  日期对象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474817042060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    瘦的可以下饭了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:02:20.000Z" title="Wed Dec 24 2025 07:02:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.日期对象</h2>
<blockquote>
<h5 data-id="heading-1">1. 日期对象是用来表示时间的对象，可以得到当前系统的时间。</h5>
<h5 data-id="heading-2">2.使用new关键字实例化日期对象<code>const date = new Data()</code>,参数为空获取的是当前时间，还可以指定时间<code>const date = new Data('2025-12-31')</code></h5>
</blockquote>
<h3 data-id="heading-3">1.1 常见方法</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e01b7f3757154a0b91cb21414a60a83d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=pMx0I9VYW1HaCnxDveV6b1vDRDk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">1.2 获取当前时间（使用计时器）</h3>
<blockquote>
<p>也可以使用date的toLocalDate（）方法</p>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">div</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid pink;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">30px</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"> 
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">getDate</span>(<span class="hljs-params"/>) { 
      <span class="hljs-comment">// 1.创建日期对象</span>
      <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
      <span class="hljs-comment">// 2.使用相关的方法</span>
      <span class="hljs-keyword">let</span> year = date.<span class="hljs-title function_">getFullYear</span>() <span class="hljs-comment">// 得到2025</span>
      <span class="hljs-keyword">let</span> month = date.<span class="hljs-title function_">getMonth</span>()+<span class="hljs-number">1</span> <span class="hljs-comment">// 月份从0开始，所以要加1</span>
      <span class="hljs-keyword">let</span> day = date.<span class="hljs-title function_">getDate</span>() <span class="hljs-comment">// 得到日期</span>
      <span class="hljs-keyword">let</span> hours = date.<span class="hljs-title function_">getHours</span>() <span class="hljs-comment">// 得到小时</span>
      hours = hours &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">'0'</span> + hours : hours <span class="hljs-comment">// 如果小时数小于10，在前面添加0</span>
      <span class="hljs-keyword">let</span> minutes = date.<span class="hljs-title function_">getMinutes</span>() <span class="hljs-comment">// 得到分钟</span>
      minutes = minutes &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">'0'</span> + minutes : minutes <span class="hljs-comment">// 如果分钟数小于10，在前面添加0</span>
      <span class="hljs-keyword">let</span> seconds = date.<span class="hljs-title function_">getSeconds</span>() <span class="hljs-comment">// 得到秒数</span>
      seconds = seconds &lt; <span class="hljs-number">10</span> ? <span class="hljs-string">'0'</span> + seconds : seconds <span class="hljs-comment">// 如果秒数小于10，在前面添加0</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${year}</span>-<span class="hljs-subst">${month}</span>-<span class="hljs-subst">${day}</span> <span class="hljs-subst">${hours}</span>:<span class="hljs-subst">${minutes}</span>:<span class="hljs-subst">${seconds}</span>`</span>
    }
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'div'</span>)
    <span class="hljs-comment">// 设置计时器，每1000毫秒（1秒）调用一次getDate函数，更新div的内容</span>
    div.<span class="hljs-property">innerHTML</span> = <span class="hljs-title function_">getDate</span>()
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
      div.<span class="hljs-property">innerHTML</span> = <span class="hljs-title function_">getDate</span>()
    }, <span class="hljs-number">1000</span>)

  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">1.3 时间戳</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa3141be7c3a443e9abe3aecc5ac3a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=9P1m266Nk9aHIMmNVwJ3NYaVEcI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">1.4 获取时间戳的三种方式</h3>
<blockquote>
<p>1.第三种方法只能得到当前的时间戳，不能做倒计时</p>
<p>2.重点掌握第二种方法</p>
</blockquote>
<pre><code class="hljs language-js" lang="js">  &lt;script&gt;
    <span class="hljs-comment">// 1.使用getTime方法获取时间戳</span>
    <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(date.<span class="hljs-title function_">getTime</span>() + <span class="hljs-string">'&lt;br&gt;'</span>) 
    <span class="hljs-comment">// 2.使用+new Date()获取时间戳</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(+<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() + <span class="hljs-string">'&lt;br&gt;'</span>)
    <span class="hljs-comment">// 3.使用Date.now()获取时间戳</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>())
  &lt;/script&gt;
</code></pre>
<h3 data-id="heading-7">1.5 倒计时效果</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">div</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">500px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid pink;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">30px</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>2026年倒计时:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 1.获取元素</span>
    <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'span:nth-child(2)'</span>)
    <span class="hljs-comment">// 2.设置两个时间戳</span>
      <span class="hljs-keyword">const</span> now = +<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
      <span class="hljs-keyword">const</span> newYear = +<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2026-01-01 00:00:00'</span>)
      <span class="hljs-keyword">let</span> remain = newYear - now
      <span class="hljs-comment">// 3. 将得到的毫秒值转换成倒计时格式</span>
      <span class="hljs-keyword">let</span> d = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> / <span class="hljs-number">60</span> / <span class="hljs-number">24</span>)
      <span class="hljs-keyword">let</span> h = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> / <span class="hljs-number">60</span> % <span class="hljs-number">24</span>)
      h = h &gt; <span class="hljs-number">10</span> ? h : <span class="hljs-string">'0'</span> + h
      <span class="hljs-keyword">let</span> m = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> % <span class="hljs-number">60</span>)
      m = m &gt; <span class="hljs-number">10</span> ? m : <span class="hljs-string">'0'</span> + m
      <span class="hljs-keyword">let</span> s = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> % <span class="hljs-number">60</span>)
      s = s &gt; <span class="hljs-number">10</span> ? s : <span class="hljs-string">'0'</span> + s
      <span class="hljs-comment">// 4. 渲染到页面</span>
      span.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`<span class="hljs-subst">${d}</span>天:<span class="hljs-subst">${h}</span>时:<span class="hljs-subst">${m}</span>分:<span class="hljs-subst">${s}</span>秒`</span>
    <span class="hljs-comment">//设置计时器</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 2.设置两个时间戳</span>
      <span class="hljs-keyword">const</span> now = +<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
      <span class="hljs-keyword">const</span> newYear = +<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2026-01-01 00:00:00'</span>)
      <span class="hljs-keyword">let</span> remain = newYear - now
      <span class="hljs-comment">// 3. 将得到的毫秒值转换成倒计时格式</span>
      <span class="hljs-keyword">let</span> d = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> / <span class="hljs-number">60</span> / <span class="hljs-number">24</span>)
      <span class="hljs-keyword">let</span> h = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> / <span class="hljs-number">60</span> % <span class="hljs-number">24</span>)
      h = h &gt; <span class="hljs-number">10</span> ? h : <span class="hljs-string">'0'</span> + h
      <span class="hljs-keyword">let</span> m = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> / <span class="hljs-number">60</span> % <span class="hljs-number">60</span>)
      m = m &gt; <span class="hljs-number">10</span> ? m : <span class="hljs-string">'0'</span> + m
      <span class="hljs-keyword">let</span> s = <span class="hljs-built_in">parseInt</span>(remain / <span class="hljs-number">1000</span> % <span class="hljs-number">60</span>)
      s = s &gt; <span class="hljs-number">10</span> ? s : <span class="hljs-string">'0'</span> + s
      <span class="hljs-comment">// 4. 渲染到页面</span>
      span.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`<span class="hljs-subst">${d}</span>天:<span class="hljs-subst">${h}</span>时:<span class="hljs-subst">${m}</span>分:<span class="hljs-subst">${s}</span>秒`</span>
    },<span class="hljs-number">1000</span>)
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-8">2.节点操作</h2>
<h3 data-id="heading-9">2.1 DOM节点</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f317b4c6e4149eb914887a586b27d78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=09D%2FLkHN7B9%2BmsvRJB7B4jCe40w%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">2.2 查找节点</h3>
<blockquote>
<p>1.利用关系可以很方便的查找每一个节点</p>
</blockquote>
<h4 data-id="heading-11">父节点查找</h4>
<ul>
<li>使用子元素的parentNode属性返回最近一级的父节点，找不到返回为null</li>
<li>这样子就可以不需要获取父节点了，只获取子节点就可以操作父节点的style、innerHtml等等</li>
<li>比如三个广告box，每个box都有关闭按钮，那么只需要设置事件：点击关闭按钮，将按钮的父级的display设置为none即可</li>
</ul>
<h4 data-id="heading-12">子节点查找</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c297bca30123471bb67525b20d030cde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=jBLoh9iBcyxYlu7WltiUA472ca0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">兄弟节点查找</h4>
<blockquote>
<ol>
<li>通过nextnextElementSibling和previousElementSibling属性可以获得相邻的兄弟节点</li>
</ol>
</blockquote>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>我是第一个段落<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>6<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 子节点</span>
    <span class="hljs-comment">// 1.获取元素</span>
    <span class="hljs-keyword">const</span> ul = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'ul'</span>)
    <span class="hljs-comment">// 2.获取子节点</span>
    <span class="hljs-keyword">const</span> li = ul.<span class="hljs-property">children</span> <span class="hljs-comment">// 返回伪数组，包含所有子节点</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(li);
    <span class="hljs-comment">// 3.遍历子节点</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; li.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(li[i]);
    }

    <span class="hljs-comment">// 兄弟节点</span>
    <span class="hljs-keyword">const</span> li2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'li:nth-child(2)'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(li2);
    <span class="hljs-comment">// 获取上一个元素兄弟</span>
    <span class="hljs-keyword">const</span> li1 = li2.<span class="hljs-property">previousElementSibling</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(li1);
    <span class="hljs-comment">// 获取下一个元素兄弟</span>
    <span class="hljs-keyword">const</span> li3 = li2.<span class="hljs-property">nextElementSibling</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(li3);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span> 
</code></pre>
<h3 data-id="heading-14">2.3 新增元素</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27b75cef3c1140bbbc3d2cab997be17a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=UVr7HePwUqtfeGNXzWGMJWIC9ig%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">创建节点</h4>
<ul>
<li>直接用document.creatElement('标签名')</li>
</ul>
<h4 data-id="heading-16">追加节点</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce0c0e14b30b4fa5a6587a31fe665ba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=v9uKtcM5%2Fke8SvFeWDpc5LyWpSs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-17">代码演示</h4>
<pre><code class="hljs language-js" lang="js">  &lt;script&gt;
    <span class="hljs-comment">// 1.创建节点</span>
    <span class="hljs-keyword">const</span> li = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'li'</span>)
    <span class="hljs-comment">// 2.追加节点</span>
    <span class="hljs-keyword">const</span> ul = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'ul'</span>)
    ul.<span class="hljs-title function_">appendChild</span>(li) <span class="hljs-comment">// appendChild是作为最后一个元素</span>
    <span class="hljs-comment">// 3.添加内容</span>
    li.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'我是新增的li'</span>
    <span class="hljs-comment">// 向前面插入元素</span>
    <span class="hljs-keyword">const</span> li2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'li'</span>)
    ul.<span class="hljs-title function_">insertBefore</span>(li2, ul.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>])
    li2.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'我是新增的li2'</span>
  &lt;/script &gt;
</code></pre>
<h4 data-id="heading-18">克隆节点</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f121481cde074212ae771159169dcdda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=hId2bvdRTKrZMBwYdHQBz%2FejHYM%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">&lt;body&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
      <span class="hljs-comment">// 克隆一个第一个li并且追加到最后</span>
      <span class="hljs-keyword">const</span> ul = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'ul'</span>)
      <span class="hljs-keyword">const</span> li1 = ul.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">cloneNode</span>(<span class="hljs-literal">true</span>)
      ul.<span class="hljs-title function_">appendChild</span>(li1)
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
&lt;/body&gt;  
</code></pre>
<h4 data-id="heading-19">删除节点</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7403a089d524442d9f0e69bd3be18c72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=Qo5CC1h7MN6dwAZ6XRiYNMJrrqs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-20">3.M端事件</h2>
<blockquote>
<p>M端就是moblie手机端</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52c17745c9fe41b991c82ba5bc08524a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55im55qE5Y-v5Lul5LiL6aWt5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767164540&amp;x-signature=n0vVH4w1gsL3RzVTW3%2BkW8q%2BOpw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-21">4.插件</h2>
<h3 data-id="heading-22">4.1 swiper插件</h3>
<blockquote>
<p>可以用来实现手机端和电脑端大部分滑动功能</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.swiper.com.cn%2Fdemo%2Findex.html" target="_blank" title="https://www.swiper.com.cn/demo/index.html" ref="nofollow noopener noreferrer">Swiper演示 - Swiper中文网</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-21 快速掌握Kotlin-定义扩展文件]]></title>    <link>https://juejin.cn/post/7586994471739424811</link>    <guid>https://juejin.cn/post/7586994471739424811</guid>    <pubDate>2025-12-24T05:57:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586994471739424811" data-draft-id="7587060153028378665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-21 快速掌握Kotlin-定义扩展文件"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T05:57:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安卓老王"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-21 快速掌握Kotlin-定义扩展文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安卓老王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:57:22.000Z" title="Wed Dec 24 2025 05:57:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin 语言中定义扩展文件</h2>
<p>扩展文件是组织和管理扩展函数和扩展属性的最佳方式。通过将相关的扩展放在专门的文件中，可以提高代码的可维护性和可读性。</p>
<h3 data-id="heading-1">1. <strong>扩展文件的基本结构</strong></h3>
<h4 data-id="heading-2">创建扩展文件</h4>
<p>通常以 <code>类名 + Extensions.kt</code> 的形式命名：</p>
<pre><code class="hljs language-bash" lang="bash">项目结构：
├── src/main/kotlin
│   ├── com/example/
│   │   ├── StringExtensions.kt
│   │   ├── CollectionExtensions.kt
│   │   ├── DateExtensions.kt
│   │   └── ViewExtensions.kt
</code></pre>
<h4 data-id="heading-3">基本示例</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// StringExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions

<span class="hljs-comment">// 扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">removeWhitespace</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.replace(<span class="hljs-string">"\\s"</span>.toRegex(), <span class="hljs-string">""</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isEmail</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> emailRegex = <span class="hljs-string">"^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\$"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.matches(emailRegex.toRegex())
}

<span class="hljs-comment">// 扩展属性</span>
<span class="hljs-keyword">val</span> String.wordCount: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.split(<span class="hljs-string">"\\s+"</span>.toRegex()).count { it.isNotBlank() }

<span class="hljs-keyword">val</span> String.initials: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.split(<span class="hljs-string">" "</span>)
        .filter { it.isNotEmpty() }
        .map { it.first().uppercaseChar() }
        .joinToString(<span class="hljs-string">""</span>)
</code></pre>
<h3 data-id="heading-4">2. <strong>按功能组织的扩展文件</strong></h3>
<h4 data-id="heading-5">按领域组织</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ValidationExtensions.kt - 验证相关的扩展</span>
<span class="hljs-keyword">package</span> com.example.extensions.validation

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isValidEmail</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.matches(Regex(<span class="hljs-string">"^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\$"</span>))
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isValidPhone</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.matches(Regex(<span class="hljs-string">"^\\+?[0-9]{10,15}\$"</span>))
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isValidPassword</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> hasUpper = Regex(<span class="hljs-string">"[A-Z]"</span>).containsMatchIn(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">val</span> hasLower = Regex(<span class="hljs-string">"[a-z]"</span>).containsMatchIn(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">val</span> hasDigit = Regex(<span class="hljs-string">"[0-9]"</span>).containsMatchIn(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">val</span> hasSpecial = Regex(<span class="hljs-string">"[!@#\$%^&amp;*()_+\\-=\\[\\]{};':\"\\\\|,.&lt;&gt;/?]"</span>).containsMatchIn(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">return</span> length &gt;= <span class="hljs-number">8</span> &amp;&amp; hasUpper &amp;&amp; hasLower &amp;&amp; hasDigit &amp;&amp; hasSpecial
}

<span class="hljs-comment">// DataFormatExtensions.kt - 数据格式化相关的扩展</span>
<span class="hljs-keyword">package</span> com.example.extensions.format

<span class="hljs-keyword">import</span> java.text.SimpleDateFormat
<span class="hljs-keyword">import</span> java.util.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> Date.<span class="hljs-title">toFormattedString</span><span class="hljs-params">(pattern: <span class="hljs-type">String</span> = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> SimpleDateFormat(pattern).format(<span class="hljs-keyword">this</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-built_in">Long</span>.<span class="hljs-title">toFormattedFileSize</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">val</span> units = listOf(<span class="hljs-string">"B"</span>, <span class="hljs-string">"KB"</span>, <span class="hljs-string">"MB"</span>, <span class="hljs-string">"GB"</span>, <span class="hljs-string">"TB"</span>)
    <span class="hljs-keyword">var</span> size = <span class="hljs-keyword">this</span>.toDouble()
    <span class="hljs-keyword">var</span> unitIndex = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">while</span> (size &gt;= <span class="hljs-number">1024</span> &amp;&amp; unitIndex &lt; units.size - <span class="hljs-number">1</span>) {
        size /= <span class="hljs-number">1024</span>
        unitIndex++
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">"%.2f %s"</span>.format(size, units[unitIndex])
}
</code></pre>
<h4 data-id="heading-6">按框架/平台组织</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// AndroidExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.android

<span class="hljs-keyword">import</span> android.view.View
<span class="hljs-keyword">import</span> android.widget.TextView
<span class="hljs-keyword">import</span> androidx.core.content.ContextCompat

<span class="hljs-comment">// View 扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">show</span><span class="hljs-params">()</span></span> {
    visibility = View.VISIBLE
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">hide</span><span class="hljs-params">()</span></span> {
    visibility = View.GONE
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">invisible</span><span class="hljs-params">()</span></span> {
    visibility = View.INVISIBLE
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">setVisible</span><span class="hljs-params">(isVisible: <span class="hljs-type">Boolean</span>)</span></span> {
    visibility = <span class="hljs-keyword">if</span> (isVisible) View.VISIBLE <span class="hljs-keyword">else</span> View.GONE
}

<span class="hljs-comment">// TextView 扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> TextView.<span class="hljs-title">setTextColorRes</span><span class="hljs-params">(colorRes: <span class="hljs-type">Int</span>)</span></span> {
    setTextColor(ContextCompat.getColor(context, colorRes))
}

<span class="hljs-comment">// CoroutineExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.coroutines

<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">debounce</span><span class="hljs-params">(
    waitMillis: <span class="hljs-type">Long</span> = <span class="hljs-number">300</span>L,
    coroutineScope: <span class="hljs-type">CoroutineScope</span>,
    destinationFunction: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span>: (T) -&gt; <span class="hljs-built_in">Unit</span> {
    <span class="hljs-keyword">var</span> debounceJob: Job? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> { param: T -&gt;
        debounceJob?.cancel()
        debounceJob = coroutineScope.launch {
            delay(waitMillis)
            destinationFunction(param)
        }
    }
}
</code></pre>
<h3 data-id="heading-7">3. <strong>使用顶层函数和属性</strong></h3>
<h4 data-id="heading-8">顶层扩展</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// StringExtensions.kt</span>
<span class="hljs-comment">// 顶层扩展，可以在任何地方导入使用</span>

<span class="hljs-comment">// 全局可用的 String 扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">toTitleCase</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.split(<span class="hljs-string">" "</span>).joinToString(<span class="hljs-string">" "</span>) { word -&gt;
        word.replaceFirstChar { it.uppercase() }
    }
}

<span class="hljs-comment">// 带有接收者的顶层函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">withLogging</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>, block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    println(<span class="hljs-string">"[<span class="hljs-variable">$tag</span>] 开始执行"</span>)
    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
    block()
    <span class="hljs-keyword">val</span> endTime = System.currentTimeMillis()
    println(<span class="hljs-string">"[<span class="hljs-variable">$tag</span>] 执行完成，耗时 <span class="hljs-subst">${endTime - startTime}</span>ms"</span>)
}

<span class="hljs-comment">// 顶层属性</span>
<span class="hljs-keyword">val</span> String.Companion.EMPTY: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">""</span>

<span class="hljs-comment">// 使用伴生对象扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.Companion.<span class="hljs-title">random</span><span class="hljs-params">(length: <span class="hljs-type">Int</span> = <span class="hljs-number">10</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> charset = (<span class="hljs-string">'a'</span>..<span class="hljs-string">'z'</span>) + (<span class="hljs-string">'A'</span>..<span class="hljs-string">'Z'</span>) + (<span class="hljs-string">'0'</span>..<span class="hljs-string">'9'</span>)
    <span class="hljs-keyword">return</span> (<span class="hljs-number">1.</span>.length)
        .map { charset.random() }
        .joinToString(<span class="hljs-string">""</span>)
}
</code></pre>
<h3 data-id="heading-9">4. <strong>扩展文件的最佳实践</strong></h3>
<h4 data-id="heading-10">保持单一职责</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不好的做法：混合不同类型的扩展</span>
<span class="hljs-comment">// MixedExtensions.kt ❌</span>
<span class="hljs-keyword">package</span> com.example

<span class="hljs-comment">// String 扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">method1</span><span class="hljs-params">()</span></span> { ... }
<span class="hljs-comment">// Date 扩展  </span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Date.<span class="hljs-title">method2</span><span class="hljs-params">()</span></span> { ... }
<span class="hljs-comment">// List 扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">method3</span><span class="hljs-params">()</span></span> { ... }

<span class="hljs-comment">// 好的做法：按类型分离 ✅</span>
<span class="hljs-comment">// StringExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.string

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">method1</span><span class="hljs-params">()</span></span> { ... }

<span class="hljs-comment">// DateExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.date

<span class="hljs-function"><span class="hljs-keyword">fun</span> Date.<span class="hljs-title">method2</span><span class="hljs-params">()</span></span> { ... }

<span class="hljs-comment">// ListExtensions.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.collection

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">method3</span><span class="hljs-params">()</span></span> { ... }
</code></pre>
<h4 data-id="heading-11">使用明确的包名</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 清晰的包结构</span>
<span class="hljs-keyword">package</span> com.example.project.extensions.string
<span class="hljs-comment">// 而不是</span>
<span class="hljs-keyword">package</span> com.example.project  <span class="hljs-comment">// 容易与主代码混淆</span>

<span class="hljs-comment">// 按功能分组的包</span>
<span class="hljs-keyword">package</span> com.example.extensions.validation
<span class="hljs-keyword">package</span> com.example.extensions.format
<span class="hljs-keyword">package</span> com.example.extensions.ui
<span class="hljs-keyword">package</span> com.example.extensions.network
</code></pre>
<h3 data-id="heading-12">5. <strong>使用 import 优化</strong></h3>
<h4 data-id="heading-13">使用 import 别名</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 避免命名冲突</span>
<span class="hljs-keyword">import</span> com.example.extensions.string.toTitleCase <span class="hljs-keyword">as</span> toCustomTitleCase
<span class="hljs-keyword">import</span> com.otherlibrary.extensions.string.toTitleCase <span class="hljs-keyword">as</span> toOtherTitleCase

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> text = <span class="hljs-string">"hello world"</span>
    println(text.toCustomTitleCase())  <span class="hljs-comment">// 使用自定义扩展</span>
    println(text.toOtherTitleCase())   <span class="hljs-comment">// 使用其他库的扩展</span>
}
</code></pre>
<h4 data-id="heading-14">批量导入</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建扩展文件的索引</span>
<span class="hljs-comment">// Extensions.kt</span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"Extensions"</span>)

<span class="hljs-keyword">package</span> com.example.extensions

<span class="hljs-comment">// 重新导出所有扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">customMethod</span><span class="hljs-params">()</span></span> = <span class="hljs-string">"custom"</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-built_in">Int</span>.<span class="hljs-title">double</span><span class="hljs-params">()</span></span> = <span class="hljs-keyword">this</span> * <span class="hljs-number">2</span>

<span class="hljs-comment">// 在其他文件中只需要导入这一个文件</span>
<span class="hljs-comment">// Main.kt</span>
<span class="hljs-keyword">import</span> com.example.extensions.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"test"</span>.customMethod())
    println(<span class="hljs-number">5.</span>double())
}
</code></pre>
<h3 data-id="heading-15">6. <strong>创建扩展库</strong></h3>
<h4 data-id="heading-16">构建可重用的扩展模块</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build.gradle.kts</span>
kotlin {
    sourceSets {
        <span class="hljs-keyword">val</span> commonMain <span class="hljs-keyword">by</span> getting {
            dependencies {
                <span class="hljs-comment">// 依赖</span>
            }
        }
        <span class="hljs-keyword">val</span> androidMain <span class="hljs-keyword">by</span> getting
        <span class="hljs-keyword">val</span> iosMain <span class="hljs-keyword">by</span> getting
    }
}

<span class="hljs-comment">// 创建多平台扩展</span>
<span class="hljs-comment">// commonMain/kotlin/com/example/extensions/StringExtensions.kt</span>
<span class="hljs-keyword">expect</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">platformSpecificMethod</span><span class="hljs-params">()</span></span>: String

<span class="hljs-comment">// androidMain/kotlin/com/example/extensions/StringExtensions.kt</span>
<span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">platformSpecificMethod</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Android: <span class="hljs-variable">$this</span>"</span>
}

<span class="hljs-comment">// iosMain/kotlin/com/example/extensions/StringExtensions.kt</span>
<span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">platformSpecificMethod</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"iOS: <span class="hljs-variable">$this</span>"</span>
}
</code></pre>
<h3 data-id="heading-17">7. <strong>扩展文件中的常量</strong></h3>
<h4 data-id="heading-18">在扩展文件中定义常量</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Constants.kt 或直接放在扩展文件中</span>
<span class="hljs-keyword">package</span> com.example.extensions

<span class="hljs-comment">// 与扩展相关的常量</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> EMAIL_REGEX = <span class="hljs-string">"^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\$"</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> PHONE_REGEX = <span class="hljs-string">"^\\+?[0-9]{10,15}\$"</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MAX_FILE_SIZE_BYTES = <span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>  <span class="hljs-comment">// 10MB</span>

<span class="hljs-comment">// 使用常量的扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isValidEmail</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.matches(Regex(EMAIL_REGEX))
}
</code></pre>
<h3 data-id="heading-19">8. <strong>扩展文件中的工具类</strong></h3>
<h4 data-id="heading-20">创建支持扩展的工具类</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ExtensionUtils.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions

<span class="hljs-keyword">import</span> kotlin.reflect.KClass

<span class="hljs-comment">// 为扩展提供工具函数</span>
<span class="hljs-keyword">object</span> ExtensionUtils {
    
    <span class="hljs-comment">// 检查扩展是否存在</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hasExtension</span><span class="hljs-params">(value: <span class="hljs-type">Any</span>, extensionName: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            value::<span class="hljs-keyword">class</span>.members.any { it.name == extensionName }
            <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-literal">false</span>
        }
    }
    
    <span class="hljs-comment">// 动态调用扩展</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> <span class="hljs-title">callExtension</span><span class="hljs-params">(
        receiver: <span class="hljs-type">Any</span>,
        extensionClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;,
        methodName: <span class="hljs-type">String</span>,
        <span class="hljs-keyword">vararg</span> args: <span class="hljs-type">Any</span>
    )</span></span>: Any? {
        <span class="hljs-comment">// 实现动态调用逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }
}
</code></pre>
<h3 data-id="heading-21">9. <strong>测试扩展文件</strong></h3>
<h4 data-id="heading-22">为扩展编写单元测试</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// StringExtensionsTest.kt</span>
<span class="hljs-keyword">package</span> com.example.extensions.test

<span class="hljs-keyword">import</span> com.example.extensions.string.*
<span class="hljs-keyword">import</span> org.junit.Test
<span class="hljs-keyword">import</span> kotlin.test.assertEquals
<span class="hljs-keyword">import</span> kotlin.test.assertFalse
<span class="hljs-keyword">import</span> kotlin.test.assertTrue

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StringExtensionsTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testIsEmail</span><span class="hljs-params">()</span></span> {
        assertTrue(<span class="hljs-string">"test@example.com"</span>.isEmail())
        assertFalse(<span class="hljs-string">"invalid-email"</span>.isEmail())
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testWordCount</span><span class="hljs-params">()</span></span> {
        assertEquals(<span class="hljs-number">3</span>, <span class="hljs-string">"Hello world test"</span>.wordCount)
        assertEquals(<span class="hljs-number">0</span>, <span class="hljs-string">""</span>.wordCount)
        assertEquals(<span class="hljs-number">1</span>, <span class="hljs-string">"Single"</span>.wordCount)
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testToTitleCase</span><span class="hljs-params">()</span></span> {
        assertEquals(<span class="hljs-string">"Hello World"</span>, <span class="hljs-string">"hello world"</span>.toTitleCase())
        assertEquals(<span class="hljs-string">"Test String"</span>, <span class="hljs-string">"test string"</span>.toTitleCase())
    }
}
</code></pre>
<h4 data-id="heading-23">测试配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build.gradle.kts 配置测试</span>
dependencies {
    testImplementation(<span class="hljs-string">"org.jetbrains.kotlin:kotlin-test"</span>)
    testImplementation(<span class="hljs-string">"org.jetbrains.kotlin:kotlin-test-junit"</span>)
}

sourceSets {
    test {
        kotlin.srcDirs(<span class="hljs-string">"src/test/kotlin"</span>)
    }
}
</code></pre>
<h3 data-id="heading-24">10. <strong>文档化扩展文件</strong></h3>
<h4 data-id="heading-25">为扩展添加 KDoc 文档</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 字符串相关的扩展函数和属性
 * 
 * 这个文件包含了用于字符串处理的扩展函数，
 * 包括验证、格式化、转换等功能。
 * 
 * <span class="hljs-doctag">@author</span> Your Name
 * <span class="hljs-doctag">@since</span> 1.0.0
 */</span>
<span class="hljs-keyword">package</span> com.example.extensions.string

<span class="hljs-comment">/**
 * 检查字符串是否是有效的电子邮件地址
 * 
 * 这个方法使用正则表达式验证电子邮件格式，
 * 支持大多数常见的电子邮件格式。
 * 
 * <span class="hljs-doctag">@return</span> 如果是有效的电子邮件地址返回 true，否则返回 false
 * 
 * <span class="hljs-doctag">@sample</span> com.example.extensions.test.StringExtensionsTest.testIsEmail
 * 
 * <span class="hljs-doctag">@see</span> [RFC 5322](https://tools.ietf.org/html/rfc5322)
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isEmail</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> emailRegex = <span class="hljs-string">"^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\$"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.matches(emailRegex.toRegex())
}

<span class="hljs-comment">/**
 * 将字符串转换为标题格式（每个单词首字母大写）
 * 
 * 示例：
 * ```
 * "hello world".toTitleCase()  // 返回 "Hello World"
 * "test-string".toTitleCase()  // 返回 "Test-string"
 * ```
 * 
 * <span class="hljs-doctag">@receiver</span> 要转换的字符串
 * <span class="hljs-doctag">@return</span> 标题格式的字符串
 * 
 * <span class="hljs-doctag">@throws</span> IllegalArgumentException 如果字符串为 null
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">toTitleCase</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.split(<span class="hljs-string">" "</span>).joinToString(<span class="hljs-string">" "</span>) { word -&gt;
        word.replaceFirstChar { it.uppercase() }
    }
}
</code></pre>
<h3 data-id="heading-26">11. <strong>实际项目结构示例</strong></h3>
<h4 data-id="heading-27">完整的项目结构</h4>
<pre><code class="hljs language-bash" lang="bash">my-project/
├── src/main/kotlin/
│   ├── com/example/
│   │   ├── extensions/
│   │   │   ├── string/
│   │   │   │   ├── StringValidators.kt
│   │   │   │   ├── StringFormatters.kt
│   │   │   │   └── StringConverters.kt
│   │   │   ├── collection/
│   │   │   │   ├── ListExtensions.kt
│   │   │   │   ├── MapExtensions.kt
│   │   │   │   └── SetExtensions.kt
│   │   │   ├── <span class="hljs-built_in">date</span>/
│   │   │   │   ├── DateExtensions.kt
│   │   │   │   └── DateTimeExtensions.kt
│   │   │   ├── ui/
│   │   │   │   ├── ViewExtensions.kt
│   │   │   │   └── FragmentExtensions.kt
│   │   │   └── Extensions.kt  // 聚合所有扩展
│   │   ├── models/
│   │   ├── network/
│   │   └── utils/
│   └── resources/
├── src/test/kotlin/
│   └── com/example/extensions/
│       ├── string/
│       ├── collection/
│       └── <span class="hljs-built_in">date</span>/
└── build.gradle.kts
</code></pre>
<h4 data-id="heading-28">聚合扩展文件</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Extensions.kt - 聚合文件</span>
<span class="hljs-meta">@file:JvmName</span>(<span class="hljs-string">"Extensions"</span>)

<span class="hljs-keyword">package</span> com.example.extensions

<span class="hljs-comment">// 重新导出所有扩展，方便一次性导入</span>
<span class="hljs-meta">@file:Suppress</span>(<span class="hljs-string">"unused"</span>)

<span class="hljs-comment">// 字符串扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">isValidEmail</span><span class="hljs-params">()</span></span> = com.example.extensions.string.isEmail(<span class="hljs-keyword">this</span>)
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">toTitleCase</span><span class="hljs-params">()</span></span> = com.example.extensions.string.toTitleCase(<span class="hljs-keyword">this</span>)

<span class="hljs-comment">// 集合扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">secondOrNull</span><span class="hljs-params">()</span></span> = com.example.extensions.collection.secondOrNull(<span class="hljs-keyword">this</span>)
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;K, V&gt;</span> Map<span class="hljs-type">&lt;K, V&gt;</span>.<span class="hljs-title">invert</span><span class="hljs-params">()</span></span> = com.example.extensions.collection.invert(<span class="hljs-keyword">this</span>)

<span class="hljs-comment">// 日期扩展</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> java.util.Date.<span class="hljs-title">toFormattedString</span><span class="hljs-params">()</span></span> = com.example.extensions.date.toFormattedString(<span class="hljs-keyword">this</span>)

<span class="hljs-comment">// 使用示例：</span>
<span class="hljs-comment">// import com.example.extensions.*  // 一次性导入所有扩展</span>
</code></pre>
<h3 data-id="heading-29">12. <strong>性能优化建议</strong></h3>
<h4 data-id="heading-30">避免重复计算</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用缓存或延迟初始化</span>
<span class="hljs-keyword">val</span> String.words: List&lt;String&gt; <span class="hljs-keyword">by</span> lazy {
    <span class="hljs-keyword">this</span>.split(<span class="hljs-string">"\\s+"</span>.toRegex())
}

<span class="hljs-comment">// 对于频繁使用的扩展，考虑性能</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">transformInline</span><span class="hljs-params">(transform: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">String</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> transform(<span class="hljs-keyword">this</span>)
}

<span class="hljs-comment">// 避免创建不必要的对象</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">getCharacterFrequency</span><span class="hljs-params">()</span></span>: Map&lt;<span class="hljs-built_in">Char</span>, <span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-keyword">val</span> frequency = mutableMapOf&lt;<span class="hljs-built_in">Char</span>, <span class="hljs-built_in">Int</span>&gt;()
    <span class="hljs-keyword">for</span> (char <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>) {
        frequency[char] = frequency.getOrDefault(char, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
    }
    <span class="hljs-keyword">return</span> frequency
}
</code></pre>
<h3 data-id="heading-31">13. <strong>常见陷阱与解决方案</strong></h3>
<h4 data-id="heading-32">陷阱 1：扩展冲突</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 解决方案：使用明确的包名和导入别名</span>
<span class="hljs-keyword">package</span> com.example.project.extensions.string

<span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">customFormat</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"Custom: <span class="hljs-variable">$this</span>"</span>

<span class="hljs-comment">// 在其他文件中</span>
<span class="hljs-keyword">import</span> com.example.project.extensions.string.customFormat <span class="hljs-keyword">as</span> myCustomFormat
<span class="hljs-keyword">import</span> com.other.library.extensions.string.customFormat <span class="hljs-keyword">as</span> otherCustomFormat

<span class="hljs-keyword">val</span> result1 = <span class="hljs-string">"test"</span>.myCustomFormat()
<span class="hljs-keyword">val</span> result2 = <span class="hljs-string">"test"</span>.otherCustomFormat()
</code></pre>
<h4 data-id="heading-33">陷阱 2：过度扩展</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不好的做法：为所有类添加大量扩展</span>
<span class="hljs-comment">// 好的做法：只在确实需要时创建扩展</span>

<span class="hljs-comment">// 评估标准：</span>
<span class="hljs-comment">// 1. 这个功能是否是类的核心职责？</span>
<span class="hljs-comment">// 2. 使用频率是否足够高？</span>
<span class="hljs-comment">// 3. 是否有更好的替代方案（如工具函数）？</span>
</code></pre>
<h4 data-id="heading-34">陷阱 3：忽略可空性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不好的做法：忽略可空性</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">toUppercase</span><span class="hljs-params">()</span></span>: String = <span class="hljs-keyword">this</span>?.uppercase() ?: <span class="hljs-string">""</span>

<span class="hljs-comment">// 好的做法：明确处理可空性</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">safeToUppercase</span><span class="hljs-params">(default: <span class="hljs-type">String</span> = <span class="hljs-string">""</span>)</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>?.uppercase() ?: default
}
</code></pre>
<h3 data-id="heading-35">总结</h3>
<p>创建扩展文件的最佳实践：</p>
<ol>
<li><strong>合理组织</strong>：按类型或功能组织扩展文件</li>
<li><strong>明确命名</strong>：使用清晰的包名和文件名</li>
<li><strong>保持简洁</strong>：每个扩展文件应该有明确的职责</li>
<li><strong>充分文档</strong>：为扩展提供完整的 KDoc 文档</li>
<li><strong>全面测试</strong>：为扩展编写单元测试</li>
<li><strong>性能考虑</strong>：注意扩展的性能影响</li>
<li><strong>避免冲突</strong>：使用明确的包结构和导入别名</li>
<li><strong>适度使用</strong>：不要过度使用扩展，只在确实需要时创建</li>
</ol>
<p>通过良好的扩展文件组织，可以创建可维护、可测试和可重用的代码库。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-18 快速掌握Kotlin-扩展属性]]></title>    <link>https://juejin.cn/post/7587060153028345897</link>    <guid>https://juejin.cn/post/7587060153028345897</guid>    <pubDate>2025-12-24T05:52:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587060153028345897" data-draft-id="7587046913691320326" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-18 快速掌握Kotlin-扩展属性"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T05:52:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安卓老王"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-18 快速掌握Kotlin-扩展属性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安卓老王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:52:13.000Z" title="Wed Dec 24 2025 05:52:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin 语言中的扩展属性</h2>
<p>扩展属性允许你为现有的类添加新的属性，而无需继承该类或修改其源代码。扩展属性不存储状态，它们通过 getter 和 setter 提供访问。</p>
<h3 data-id="heading-1">1. <strong>基本语法</strong></h3>
<h4 data-id="heading-2">只读扩展属性（val）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为 String 类添加只读扩展属性</span>
<span class="hljs-keyword">val</span> String.firstChar: <span class="hljs-built_in">Char</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>]

<span class="hljs-keyword">val</span> String.lastChar: <span class="hljs-built_in">Char</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>[length - <span class="hljs-number">1</span>]

<span class="hljs-keyword">val</span> String.isPalindrome: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> == <span class="hljs-keyword">this</span>.reversed()

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> text = <span class="hljs-string">"Kotlin"</span>
println(text.firstChar)      <span class="hljs-comment">// K</span>
println(text.lastChar)       <span class="hljs-comment">// n</span>
println(<span class="hljs-string">"level"</span>.isPalindrome) <span class="hljs-comment">// true</span>
</code></pre>
<h4 data-id="heading-3">可写扩展属性（var）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为 StringBuilder 添加可写扩展属性</span>
<span class="hljs-keyword">var</span> StringBuilder.firstChar: <span class="hljs-built_in">Char</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">set</span>(value) {
        <span class="hljs-keyword">this</span>.setCharAt(<span class="hljs-number">0</span>, value)
    }

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> builder = StringBuilder(<span class="hljs-string">"Hello"</span>)
builder.firstChar = <span class="hljs-string">'J'</span>
println(builder)  <span class="hljs-comment">// Jello</span>
</code></pre>
<h3 data-id="heading-4">2. <strong>为常用类添加扩展属性</strong></h3>
<h4 data-id="heading-5">String 扩展属性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> String.wordCount: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.split(<span class="hljs-string">"\\s+"</span>.toRegex()).size

<span class="hljs-keyword">val</span> String.camelCaseWords: List&lt;String&gt;
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.split(<span class="hljs-string">"(?&lt;=[a-z])(?=[A-Z])|(?&lt;=[A-Z])(?=[A-Z][a-z])"</span>.toRegex())

<span class="hljs-keyword">val</span> String.isEmail: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.matches(Regex(<span class="hljs-string">"^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\$"</span>))

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> text = <span class="hljs-string">"helloWorldExample"</span>
println(text.camelCaseWords)  <span class="hljs-comment">// [hello, World, Example]</span>
</code></pre>
<h4 data-id="heading-6">List/Collection 扩展属性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> &lt;T&gt; List&lt;T&gt;.midElement: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">if</span> (isEmpty()) <span class="hljs-literal">null</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>[size / <span class="hljs-number">2</span>]

<span class="hljs-keyword">val</span> &lt;T&gt; List&lt;T&gt;.second: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.getOrNull(<span class="hljs-number">1</span>)

<span class="hljs-keyword">val</span> &lt;T&gt; List&lt;T&gt;.penultimate: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.getOrNull(size - <span class="hljs-number">2</span>)

<span class="hljs-keyword">val</span> &lt;T&gt; Collection&lt;T&gt;.isNotEmpty: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = !isEmpty()

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> list = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
println(list.midElement)    <span class="hljs-comment">// 3</span>
println(list.penultimate)   <span class="hljs-comment">// 4</span>
</code></pre>
<h4 data-id="heading-7">Number 扩展属性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.isEven: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>

<span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.isOdd: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>

<span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.isPrime: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> &lt;= <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> || <span class="hljs-keyword">this</span> % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">var</span> i = <span class="hljs-number">5</span>
        <span class="hljs-keyword">while</span> (i * i &lt;= <span class="hljs-keyword">this</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> % i == <span class="hljs-number">0</span> || <span class="hljs-keyword">this</span> % (i + <span class="hljs-number">2</span>) == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            i += <span class="hljs-number">6</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

<span class="hljs-keyword">val</span> <span class="hljs-built_in">Double</span>.formatted: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">"%.2f"</span>.format(<span class="hljs-keyword">this</span>)

<span class="hljs-comment">// 使用</span>
println(<span class="hljs-number">7.</span>isPrime)          <span class="hljs-comment">// true</span>
println(<span class="hljs-number">3.14159</span>.formatted)  <span class="hljs-comment">// 3.14</span>
</code></pre>
<h3 data-id="heading-8">3. <strong>可空类型的扩展属性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> String?.isNullOrEmptyOrBlank: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> == <span class="hljs-literal">null</span> || <span class="hljs-keyword">this</span>.isBlank()

<span class="hljs-keyword">val</span> String?.orDefault: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> ?: <span class="hljs-string">"默认值"</span>

<span class="hljs-keyword">val</span> &lt;T&gt; T?.isNotNull: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>

<span class="hljs-keyword">val</span> &lt;T&gt; T?.isNull: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> == <span class="hljs-literal">null</span>

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> nullableString: String? = <span class="hljs-literal">null</span>
println(nullableString.isNullOrEmptyOrBlank)  <span class="hljs-comment">// true</span>
println(nullableString.orDefault)             <span class="hljs-comment">// 默认值</span>
</code></pre>
<h3 data-id="heading-9">4. <strong>泛型扩展属性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 基本泛型扩展属性</span>
<span class="hljs-keyword">val</span> &lt;T&gt; List&lt;T&gt;.randomOrNull: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">if</span> (isEmpty()) <span class="hljs-literal">null</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.random()

<span class="hljs-keyword">val</span> &lt;T&gt; MutableList&lt;T&gt;.firstAndLast: Pair&lt;T, T&gt;?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">if</span> (size &gt;= <span class="hljs-number">2</span>) Pair(first(), last()) <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>

<span class="hljs-comment">// 带类型约束的泛型扩展属性</span>
<span class="hljs-keyword">val</span> &lt;T : Comparable&lt;T&gt;&gt; List&lt;T&gt;.isSorted: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.sorted() == <span class="hljs-keyword">this</span>

<span class="hljs-keyword">val</span> &lt;T : Number&gt; T.squared: <span class="hljs-built_in">Double</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.toDouble() * <span class="hljs-keyword">this</span>.toDouble()

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
println(numbers.randomOrNull)  <span class="hljs-comment">// 随机元素</span>
println(<span class="hljs-number">5.</span>squared)             <span class="hljs-comment">// 25.0</span>
</code></pre>
<h3 data-id="heading-10">5. <strong>为自定义类添加扩展属性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>)

<span class="hljs-comment">// 为 Person 类添加扩展属性</span>
<span class="hljs-keyword">val</span> Person.isAdult: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = age &gt;= <span class="hljs-number">18</span>

<span class="hljs-keyword">val</span> Person.initials: String
    <span class="hljs-keyword">get</span>() = name.split(<span class="hljs-string">" "</span>).map { it.first() }.joinToString(<span class="hljs-string">""</span>)

<span class="hljs-keyword">val</span> Person.nameLength: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = name.length

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> person = Person(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">25</span>)
println(person.isAdult)   <span class="hljs-comment">// true</span>
println(person.initials)  <span class="hljs-comment">// JD</span>
</code></pre>
<h3 data-id="heading-11">6. <strong>扩展属性与委托属性结合</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.properties.ReadOnlyProperty
<span class="hljs-keyword">import</span> kotlin.reflect.KProperty

<span class="hljs-comment">// 创建扩展属性的委托</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UpperCaseDelegate</span> : <span class="hljs-type">ReadOnlyProperty</span>&lt;<span class="hljs-type">Any?, String</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getValue</span><span class="hljs-params">(thisRef: <span class="hljs-type">Any</span>?, property: <span class="hljs-type">KProperty</span>&lt;*&gt;)</span></span>: String {
        <span class="hljs-keyword">return</span> property.name.uppercase()
    }
}

<span class="hljs-comment">// 使用委托创建扩展属性</span>
<span class="hljs-keyword">val</span> Any?.upperCaseName: String <span class="hljs-keyword">by</span> UpperCaseDelegate()

<span class="hljs-comment">// 复杂的委托扩展属性</span>
<span class="hljs-keyword">val</span> String.characterFrequency: Map&lt;<span class="hljs-built_in">Char</span>, <span class="hljs-built_in">Int</span>&gt; <span class="hljs-keyword">by</span> lazy {
    <span class="hljs-keyword">this</span>.groupingBy { it }.eachCount()
}

<span class="hljs-comment">// 使用</span>
println(<span class="hljs-string">"test"</span>.upperCaseName)  <span class="hljs-comment">// UPPERCASENAME（属性名被转换为大写）</span>
<span class="hljs-keyword">val</span> freq = <span class="hljs-string">"hello"</span>.characterFrequency
println(freq)  <span class="hljs-comment">// {h=1, e=1, l=2, o=1}</span>
</code></pre>
<h3 data-id="heading-12">7. <strong>实际项目中的应用</strong></h3>
<h4 data-id="heading-13">Android 开发</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> android.view.View
<span class="hljs-keyword">import</span> android.widget.TextView

<span class="hljs-comment">// View 扩展属性</span>
<span class="hljs-keyword">val</span> View.isVisible: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = visibility == View.VISIBLE

<span class="hljs-keyword">val</span> View.isGone: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = visibility == View.GONE

<span class="hljs-keyword">var</span> TextView.textOrEmpty: String
    <span class="hljs-keyword">get</span>() = text?.toString() ?: <span class="hljs-string">""</span>
    <span class="hljs-keyword">set</span>(value) {
        text = value
    }

<span class="hljs-comment">// SharedPreferences 扩展属性</span>
<span class="hljs-keyword">val</span> android.content.SharedPreferences.hasUserLoggedIn: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = getBoolean(<span class="hljs-string">"user_logged_in"</span>, <span class="hljs-literal">false</span>)

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">if</span> (button.isVisible) {
    button.isVisible = <span class="hljs-literal">false</span>
}

textView.textOrEmpty = <span class="hljs-string">"New Text"</span>
</code></pre>
<h4 data-id="heading-14">日期时间处理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> java.time.LocalDate
<span class="hljs-keyword">import</span> java.time.LocalDateTime
<span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter

<span class="hljs-keyword">val</span> LocalDate.isWeekend: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = dayOfWeek.value <span class="hljs-keyword">in</span> <span class="hljs-number">6.</span><span class="hljs-number">.7</span>

<span class="hljs-keyword">val</span> LocalDate.isWeekday: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = !isWeekend

<span class="hljs-keyword">val</span> LocalDate.isLeapYear: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = year % <span class="hljs-number">4</span> == <span class="hljs-number">0</span> &amp;&amp; (year % <span class="hljs-number">100</span> != <span class="hljs-number">0</span> || year % <span class="hljs-number">400</span> == <span class="hljs-number">0</span>)

<span class="hljs-keyword">val</span> LocalDateTime.formattedDate: String
    <span class="hljs-keyword">get</span>() = format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>))

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> today = LocalDate.now()
println(today.isWeekend)
println(today.formattedDate)
</code></pre>
<h4 data-id="heading-15">响应式编程</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.flow.Flow
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.StateFlow

<span class="hljs-comment">// Flow 扩展属性</span>
<span class="hljs-keyword">val</span> &lt;T&gt; Flow&lt;T&gt;.latestValue: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 实际实现需要特殊处理，这里只是示例</span>

<span class="hljs-keyword">val</span> &lt;T&gt; StateFlow&lt;T&gt;.valueOrNull: T?
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">try</span> {
        value
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-literal">null</span>
    }

<span class="hljs-comment">// 用于 Retrofit 响应的扩展属性</span>
<span class="hljs-keyword">val</span> &lt;T&gt; retrofit2.Response&lt;T&gt;.isSuccessfulAndNotNull: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = isSuccessful &amp;&amp; body() != <span class="hljs-literal">null</span>

<span class="hljs-keyword">val</span> &lt;T&gt; retrofit2.Response&lt;T&gt;.errorMessage: String?
    <span class="hljs-keyword">get</span>() = errorBody()?.string()
</code></pre>
<h3 data-id="heading-16">8. <strong>操作符重载扩展属性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.collections.component1
<span class="hljs-keyword">import</span> kotlin.collections.component2

<span class="hljs-comment">// 为 Pair 添加扩展属性，支持解构声明</span>
<span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> Pair<span class="hljs-type">&lt;Int, Int&gt;</span>.<span class="hljs-title">component3</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = first + second

<span class="hljs-keyword">val</span> Pair&lt;<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>&gt;.sum: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = first + second

<span class="hljs-keyword">val</span> Pair&lt;<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>&gt;.product: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = first * second

<span class="hljs-comment">// 使用解构声明</span>
<span class="hljs-keyword">val</span> (x, y, sum) = Pair(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)
println(<span class="hljs-string">"<span class="hljs-variable">$x</span> + <span class="hljs-variable">$y</span> = <span class="hljs-variable">$sum</span>"</span>)  <span class="hljs-comment">// 3 + 4 = 7</span>

<span class="hljs-keyword">val</span> pair = Pair(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
println(pair.product)  <span class="hljs-comment">// 30</span>
</code></pre>
<h3 data-id="heading-17">9. <strong>扩展属性与扩展函数结合</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 扩展属性作为缓存</span>
<span class="hljs-keyword">val</span> String.cachedWords: List&lt;String&gt; <span class="hljs-keyword">by</span> lazy {
    <span class="hljs-keyword">this</span>.split(<span class="hljs-string">"\\s+"</span>.toRegex())
}

<span class="hljs-comment">// 扩展属性调用扩展函数</span>
<span class="hljs-keyword">val</span> String.reversedWords: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>.split(<span class="hljs-string">" "</span>).joinToString(<span class="hljs-string">" "</span>) { it.reversed() }

<span class="hljs-comment">// 计算密集型属性的缓存</span>
<span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.factorial: <span class="hljs-built_in">Long</span>
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-keyword">var</span> result = <span class="hljs-number">1L</span>
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">2.</span>.<span class="hljs-keyword">this</span>) {
            result *= i
        }
        <span class="hljs-keyword">return</span> result
    }

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> text = <span class="hljs-string">"hello world"</span>
println(text.cachedWords)    <span class="hljs-comment">// [hello, world] (延迟计算)</span>
println(text.reversedWords)  <span class="hljs-comment">// olleh dlrow</span>
println(<span class="hljs-number">5.</span>factorial)         <span class="hljs-comment">// 120</span>
</code></pre>
<h3 data-id="heading-18">10. <strong>DSL 构建中的扩展属性</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// HTML DSL 构建器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HtmlBuilder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> elements = mutableListOf&lt;String&gt;()
    
    <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">unaryPlus</span><span class="hljs-params">()</span></span> {
        elements.add(<span class="hljs-keyword">this</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>: String = elements.joinToString(<span class="hljs-string">""</span>)
}

<span class="hljs-comment">// 扩展属性用于 DSL</span>
<span class="hljs-keyword">val</span> HtmlBuilder.body: HtmlBuilder
    <span class="hljs-keyword">get</span>() {
        +<span class="hljs-string">"&lt;body&gt;"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

<span class="hljs-keyword">val</span> HtmlBuilder.endBody: HtmlBuilder
    <span class="hljs-keyword">get</span>() {
        +<span class="hljs-string">"&lt;/body&gt;"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

<span class="hljs-keyword">val</span> HtmlBuilder.h1: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">"&lt;h1&gt;"</span>

<span class="hljs-keyword">val</span> HtmlBuilder.endH1: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">"&lt;/h1&gt;"</span>

<span class="hljs-comment">// 使用 DSL</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">html</span><span class="hljs-params">(<span class="hljs-keyword">init</span>: <span class="hljs-type">HtmlBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> builder = HtmlBuilder()
    builder.<span class="hljs-keyword">init</span>()
    <span class="hljs-keyword">return</span> builder.toString()
}

<span class="hljs-keyword">val</span> result = html {
    +<span class="hljs-string">"&lt;html&gt;"</span>
    body {
        +h1
        +<span class="hljs-string">"标题"</span>
        +endH1
    }
    endBody
    +<span class="hljs-string">"&lt;/html&gt;"</span>
}
</code></pre>
<h3 data-id="heading-19">11. <strong>性能考虑与最佳实践</strong></h3>
<h4 data-id="heading-20">性能考虑</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 避免在频繁调用的扩展属性中进行复杂计算</span>
<span class="hljs-comment">// 不好</span>
<span class="hljs-keyword">val</span> String.complexCalculation: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-comment">// 复杂计算</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map { it.code }.sum()
    }

<span class="hljs-comment">// 好：使用缓存或延迟计算</span>
<span class="hljs-keyword">val</span> String.cachedComplexCalculation: <span class="hljs-built_in">Int</span> <span class="hljs-keyword">by</span> lazy {
    <span class="hljs-keyword">this</span>.map { it.code }.sum()
}

<span class="hljs-comment">// 对于简单的计算，直接定义扩展属性</span>
<span class="hljs-keyword">val</span> String.lengthSquared: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = length * length
</code></pre>
<h4 data-id="heading-21">最佳实践</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 保持扩展属性简单</span>
<span class="hljs-comment">// 不好</span>
<span class="hljs-keyword">val</span> String.encodedAndCompressed: ByteArray
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-comment">// 复杂的编码和压缩逻辑</span>
        <span class="hljs-keyword">return</span> byteArrayOf()
    }

<span class="hljs-comment">// 好：拆分为多个简单属性或函数</span>
<span class="hljs-keyword">val</span> String.base64Encoded: String
    <span class="hljs-keyword">get</span>() = java.util.Base64.getEncoder().encodeToString(toByteArray())

<span class="hljs-comment">// 2. 提供有意义的名称</span>
<span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.days: TimeSpan <span class="hljs-keyword">get</span>() = TimeSpan(<span class="hljs-keyword">this</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
<span class="hljs-keyword">val</span> <span class="hljs-built_in">Int</span>.hours: TimeSpan <span class="hljs-keyword">get</span>() = TimeSpan(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)

<span class="hljs-comment">// 3. 避免与现有属性冲突</span>
<span class="hljs-comment">// 检查是否已有同名属性</span>
<span class="hljs-comment">// println(String::class.members.map { it.name })</span>
</code></pre>
<h3 data-id="heading-22">12. <strong>扩展属性的限制</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 不能有幕后字段</span>
<span class="hljs-comment">// 错误示例</span>
<span class="hljs-keyword">var</span> String.cachedValue: String? = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 编译错误</span>

<span class="hljs-comment">// 2. 不能直接初始化</span>
<span class="hljs-comment">// 错误示例</span>
<span class="hljs-keyword">val</span> String.defaultValue: String = <span class="hljs-string">"default"</span>  <span class="hljs-comment">// 编译错误</span>

<span class="hljs-comment">// 3. 扩展属性不能访问私有成员</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PrivateClass</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> secret = <span class="hljs-string">"hidden"</span>
}

<span class="hljs-comment">// 错误：无法访问私有成员</span>
<span class="hljs-comment">// val PrivateClass.revealedSecret: String</span>
<span class="hljs-comment">//     get() = this.secret</span>

<span class="hljs-comment">// 4. 扩展属性是静态解析的</span>
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> : <span class="hljs-type">Animal</span>()

<span class="hljs-keyword">val</span> Animal.type: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">"Animal"</span>
<span class="hljs-keyword">val</span> Dog.type: String
    <span class="hljs-keyword">get</span>() = <span class="hljs-string">"Dog"</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> animal: Animal = Dog()
    println(animal.type)  <span class="hljs-comment">// 输出: Animal（不是 Dog）</span>
}
</code></pre>
<h3 data-id="heading-23">13. <strong>工具函数与扩展属性的比较</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 工具函数方式</span>
<span class="hljs-keyword">object</span> StringUtils {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getFirstChar</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Char</span> = str[<span class="hljs-number">0</span>]
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isPalindrome</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> = str == str.reversed()
}

<span class="hljs-comment">// 扩展属性方式</span>
<span class="hljs-keyword">val</span> String.firstChar: <span class="hljs-built_in">Char</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span>[<span class="hljs-number">0</span>]
<span class="hljs-keyword">val</span> String.isPalindrome: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span> == <span class="hljs-keyword">this</span>.reversed()

<span class="hljs-comment">// 使用对比</span>
<span class="hljs-keyword">val</span> text = <span class="hljs-string">"level"</span>

<span class="hljs-comment">// 工具函数方式</span>
println(StringUtils.getFirstChar(text))
println(StringUtils.isPalindrome(text))

<span class="hljs-comment">// 扩展属性方式（更自然）</span>
println(text.firstChar)
println(text.isPalindrome)
</code></pre>
<h3 data-id="heading-24">总结</h3>
<p>扩展属性是 Kotlin 中非常有用的特性，它允许你：</p>
<ol>
<li><strong>扩展现有类</strong>：为任何类添加新属性</li>
<li><strong>创建流畅 API</strong>：使代码更自然、易读</li>
<li><strong>提供计算属性</strong>：创建基于现有数据的派生属性</li>
<li><strong>支持 DSL</strong>：构建领域特定语言</li>
</ol>
<p>注意事项：</p>
<ul>
<li>扩展属性不存储状态，只能通过 getter/setter 计算</li>
<li>扩展属性不能有幕后字段</li>
<li>扩展属性是静态解析的，不支持多态</li>
<li>需要合理命名，避免与现有成员冲突</li>
</ul>
<p>合理使用扩展属性可以显著提高代码的可读性和可维护性，尤其是在构建 DSL 或为常用类添加便捷属性时。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[7个Rust写法让代码干净卫生又高效]]></title>    <link>https://juejin.cn/post/7587020682010591259</link>    <guid>https://juejin.cn/post/7587020682010591259</guid>    <pubDate>2025-12-24T07:17:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587020682010591259" data-draft-id="7587062584164352038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="7个Rust写法让代码干净卫生又高效"/> <meta itemprop="keywords" content="后端,Rust"/> <meta itemprop="datePublished" content="2025-12-24T07:17:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ServBay"/> <meta itemprop="url" content="https://juejin.cn/user/3828929445244761"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            7个Rust写法让代码干净卫生又高效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3828929445244761/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ServBay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:17:44.000Z" title="Wed Dec 24 2025 07:17:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Rust以严苛的编译器著称，很多刚接触这门语言的开发者会觉得在借用检查器的凝视下写代码束手束脚。但经验丰富的开发者知道，在Rust严格的规则之下，隐藏着许多合法作弊的技巧。这些写法初看有些反直觉，但实际上它们不仅符合Rust的设计哲学，还能显著提升代码的性能和可读性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a62a647b73e43178d5c23e0f56247f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VydkJheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165464&amp;x-signature=a3UV6kN4T6wTSxpfd94o7dc7Gpk%3D" alt="" loading="lazy"/></p>
<p>以下是几个让代码既干净又高效的Rust技巧。</p>
<h3 data-id="heading-0">显式丢弃 Result 或 Option：告诉编译器“我知道我在做什么”</h3>
<p>Rust的 <code>Result</code> 和 <code>Option</code> 类型强制开发者处理潜在的错误或空值。但在某些场景下，结果确实不重要。比如发送一个非关键的统计数据，或者清理临时文件，即使失败了也无伤大雅。直接忽略会导致编译器发出 <code>unused_result</code> 警告，干扰视线。</p>
<p>所以与其让编译器跟个教导主任似的啰啰嗦嗦，不如直接告诉它：我知道了，但我就是不管。</p>
<h4 data-id="heading-1"><strong>技巧</strong>：使用 <code>let _ = ...</code> 绑定，或者使用 <code>drop(...)</code>。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::fs;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 场景：尝试删除一个可能存在的临时缓存文件</span>
    <span class="hljs-comment">// 如果文件不存在导致失败，其实无所谓，只想确保它不在那儿</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = fs::<span class="hljs-title function_ invoke__">remove_file</span>(<span class="hljs-string">"/tmp/temp_cache.dat"</span>); 
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"尝试了清理缓存，结果并不重要。"</span>);

    <span class="hljs-comment">// 场景：持有一个 Option 数据，想立即释放它的资源</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">config_data</span>: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt; = <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Heavy Config Data"</span>));
    
    <span class="hljs-comment">// 显式调用 drop，数据立即离场，不再占用作用域后续的资源</span>
    <span class="hljs-title function_ invoke__">drop</span>(config_data); 
    
    <span class="hljs-comment">// 此时再访问 config_data 会导致编译错误，因为所有权已移交并销毁</span>
}
</code></pre>
<p>这种写法告诉编辑器，道理我都懂，但我不听你的，我要按照自己的来。</p>
<h3 data-id="heading-2">用 <code>if let</code> 和 <code>while let</code> 简化控制流</h3>
<p>Rust的 <code>match</code> 表达式功能全面，但在只关心一种匹配情况时，写一个包含 <code>_ =&gt; {}</code> 的完整 <code>match</code> 显得非常啰嗦，增加了无谓的缩进层级。</p>
<h4 data-id="heading-3"><strong>技巧</strong>：使用 <code>if let</code> 处理单次匹配，<code>while let</code> 处理迭代器或流的循环匹配。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 场景：只处理配置存在的情况</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">app_mode</span>: <span class="hljs-type">Option</span>&lt;&amp;<span class="hljs-type">str</span>&gt; = <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-string">"Production"</span>);

    <span class="hljs-comment">// 这种写法比 match 更加扁平、直观</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(mode) = app_mode {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"当前运行模式: {}"</span>, mode);
    }

    <span class="hljs-comment">// 场景：从消费队列中不断取出数据直到为空</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">tasks</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-string">"Task A"</span>, <span class="hljs-string">"Task B"</span>, <span class="hljs-string">"Task C"</span>].<span class="hljs-title function_ invoke__">into_iter</span>();

    <span class="hljs-comment">// 只要 next() 返回 Some，循环就继续</span>
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(task) = tasks.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"正在处理: {}"</span>, task);
    }
}
</code></pre>
<p>这不仅是语法糖，更是减少视觉干扰、突出业务逻辑的有效手段。</p>
<h3 data-id="heading-4">VecDeque：被低估的双端队列</h3>
<p>很多开发者习惯用 <code>Vec</code> 处理所有列表数据。但在需要频繁从头部删除数据（FIFO队列）的场景下，<code>Vec</code> 的性能其实不是很好。因为 <code>Vec::remove(0)</code> 会导致后续所有元素向前移动，时间复杂度是 O(n)。</p>
<h4 data-id="heading-5"><strong>技巧</strong>：遇到队列需求，直接使用 <code>VecDeque</code>。它基于环形缓冲区实现，头部和尾部的操作都是 O(1)。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::collections::VecDeque;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 初始化一个双端队列</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">buffer</span> = VecDeque::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-built_in">vec!</span>[<span class="hljs-number">100</span>, <span class="hljs-number">200</span>, <span class="hljs-number">300</span>]);

    <span class="hljs-comment">// 从头部弹出元素，对于大量数据，这比 Vec 快几个数量级</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(val) = buffer.<span class="hljs-title function_ invoke__">pop_front</span>() {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"处理队首数据: {}"</span>, val);
    }

    <span class="hljs-comment">// 依然可以在尾部添加</span>
    buffer.<span class="hljs-title function_ invoke__">push_back</span>(<span class="hljs-number">400</span>);
}
</code></pre>
<p>如果在写任务调度器或者消息缓冲，把 <code>Vec</code> 换成 <code>VecDeque</code>，不需要改动逻辑就能获得显著的性能提升。</p>
<h3 data-id="heading-6">善用 <code>const</code> 和 <code>static</code></h3>
<p>在Rust中定义全局值，新手容易混淆 <code>const</code> 和 <code>static</code>。</p>
<ul>
<li><strong>const</strong>：编译时常量。编译器会在用到它的地方直接将其内联（复制）。它不占用运行时的固定内存地址。</li>
<li><strong>static</strong>：静态变量。它在整个程序生命周期内拥有固定的内存地址。</li>
</ul>
<h4 data-id="heading-7"><strong>技巧</strong>：数值计算、配置参数用 <code>const</code>；需要全局唯一地址或配合原子操作（Atomic）做全局状态管理时用 <code>static</code>。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::sync::atomic::{AtomicUsize, Ordering};

<span class="hljs-comment">// 编译时替换，哪里用到 MAX_Connections，哪里就变成 100</span>
<span class="hljs-keyword">const</span> MAX_CONNECTIONS: <span class="hljs-type">u32</span> = <span class="hljs-number">100</span>; 

<span class="hljs-comment">// 全局唯一的计数器，拥有固定内存地址</span>
<span class="hljs-keyword">static</span> ACTIVE_USERS: AtomicUsize = AtomicUsize::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>);

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_connection</span>() {
    <span class="hljs-comment">// 增加全局计数</span>
    ACTIVE_USERS.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">1</span>, Ordering::SeqCst);
    
    <span class="hljs-comment">// 使用常量做逻辑判断</span>
    <span class="hljs-keyword">if</span> ACTIVE_USERS.<span class="hljs-title function_ invoke__">load</span>(Ordering::SeqCst) <span class="hljs-keyword">as</span> <span class="hljs-type">u32</span> &lt;= MAX_CONNECTIONS {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"允许连接"</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">PhantomData：类型系统的幽灵</h3>
<p><code>PhantomData</code> 是一个零大小类型（Zero-sized Type），它不占用任何运行时内存。它的存在纯粹是为了欺骗编译器，让编译器认为结构体拥有某种数据的所有权或生命周期关系。</p>
<h4 data-id="heading-9"><strong>技巧</strong>：当定义一个泛型结构体，但该泛型参数实际上并不作为字段存储时（例如用于状态标记或FFI边界），使用 <code>PhantomData</code> 避免编译错误。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::marker::PhantomData;

<span class="hljs-comment">// 定义两种状态类型</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Connected</span>;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Disconnected</span>;

<span class="hljs-comment">// 这是一个带有状态标记的客户端结构体</span>
<span class="hljs-comment">// T 只是用来在编译期区分状态，不占用运行时空间</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Client</span>&lt;T&gt; {
    id: <span class="hljs-type">u32</span>,
    _state: PhantomData&lt;T&gt;, 
}

<span class="hljs-keyword">impl</span>&lt;T&gt; Client&lt;T&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(id: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Client {
            id,
            _state: PhantomData,
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">c1</span>: Client&lt;Connected&gt; = Client::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">c2</span>: Client&lt;Disconnected&gt; = Client::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">2</span>);

    <span class="hljs-comment">// 编译器会认为 c1 和 c2 是完全不同的类型</span>
    <span class="hljs-comment">// 防止了错误地将断开连接的客户端传入需要连接状态的函数中</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"客户端ID: {}"</span>, c1.id);
}
</code></pre>
<p>这种幽灵数据是实现零成本抽象（Zero-cost Abstractions）的核心工具之一。</p>
<h3 data-id="heading-10">const Generics：将值参数化</h3>
<p>传统泛型是针对类型的（如 <code>Vec&lt;T&gt;</code>）。而 const generics 允许将值作为泛型参数。这使得可以在编译阶段就确定数组的大小或其他常量属性，从而进行极致的优化。</p>
<h4 data-id="heading-11"><strong>技巧</strong>：当数据结构的大小在编译期固定时，使用 const generics 替代动态的 <code>Vec</code>，可以减少堆内存分配。</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义一个固定大小的矩阵结构体</span>
<span class="hljs-comment">// ROWS 和 COLS 是常量泛型参数</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Matrix</span>&lt;T, <span class="hljs-keyword">const</span> ROWS: <span class="hljs-type">usize</span>, <span class="hljs-keyword">const</span> COLS: <span class="hljs-type">usize</span>&gt; {
    data: [[T; COLS]; ROWS],
}

<span class="hljs-keyword">impl</span>&lt;T: <span class="hljs-built_in">Default</span> + <span class="hljs-built_in">Copy</span>, <span class="hljs-keyword">const</span> ROWS: <span class="hljs-type">usize</span>, <span class="hljs-keyword">const</span> COLS: <span class="hljs-type">usize</span>&gt; Matrix&lt;T, ROWS, COLS&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Matrix {
            data: [[T::<span class="hljs-title function_ invoke__">default</span>(); COLS]; ROWS],
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">size_info</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"矩阵大小: {}x{}"</span>, ROWS, COLS);
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 创建一个 4x4 的矩阵</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">mat</span> = Matrix::&lt;<span class="hljs-type">f64</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>&gt;::<span class="hljs-title function_ invoke__">new</span>();
    mat.<span class="hljs-title function_ invoke__">size_info</span>();

    <span class="hljs-comment">// 如果尝试将不同维度的 Matrix 赋值，编译器会直接报错</span>
    <span class="hljs-comment">// 保证了严格的类型和内存布局安全</span>
}
</code></pre>
<h3 data-id="heading-12">impl Trait 返回值：隐藏实现细节</h3>
<p>编写库或API时，如果返回类型非常复杂（例如一长串的迭代器链 <code>Map&lt;Filter&lt;...&gt;&gt;</code>），不仅写起来痛苦，维护也是噩梦。一旦内部实现变动，函数签名就得改。</p>
<h4 data-id="heading-13"><strong>技巧</strong>：使用 <code>-&gt; impl Trait</code>。这就是告诉调用者：“返回一个实现了这个特质的东西，具体类型不需要知道。”</h4>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 不需要写出具体的返回类型，比如 std::iter::Map&lt;std::ops::Range&lt;...&gt;&gt;</span>
<span class="hljs-comment">// 只要它能迭代出 u32 即可</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_odd_numbers</span>(limit: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span>&lt;Item = <span class="hljs-type">u32</span>&gt; {
    (<span class="hljs-number">0</span>..limit).<span class="hljs-title function_ invoke__">filter</span>(|x| x % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>)
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">odds</span> = <span class="hljs-title function_ invoke__">get_odd_numbers</span>(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 调用者只把它当迭代器用，完全解耦了具体实现</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">num</span> <span class="hljs-keyword">in</span> odds {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"奇数: {}"</span>, num);
    }
}
</code></pre>
<p>这种不透明的返回类型极大地提高了API的稳定性和灵活性。</p>
<h3 data-id="heading-14">Rust神器推荐</h3>
<p>掌握了这些代码层面的技巧后，高效的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">开发环境</a>同样不可或缺。很多Rust开发者在配置环境、安装数据库依赖上浪费了大量时间。</p>
<p>那就合适用 ServBay <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures%2Frust" target="_blank" title="https://www.servbay.com/features/rust" ref="nofollow noopener noreferrer">一键安装Rust环境</a>，省去了配置 PATH 和依赖的繁琐。同时，它还集成了 SQL 和 NoSQL 数据库（如 PostgreSQL, Redis 等）以及反向代理服务，甚至支持一键部署本地AI。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc2947d3f876447390f557be03e25034~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VydkJheQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165464&amp;x-signature=fUZi5TLL9U0YFX4338ccSjO4lhA%3D" alt="" loading="lazy"/></p>
<p>对于需要快速验证全栈逻辑，或者希望利用本地大模型辅助编程的开发者来说，ServBay 提供了一个开箱即用的解决方案，开发者能将精力完全集中在 Rust 代码的逻辑与优化上。</p>
<h3 data-id="heading-15">结语</h3>
<p>Rust的这些技巧，本质上是在安全性和控制力之间寻找最佳平衡点。当你熟练运用 <code>PhantomData</code> 处理类型约束，用 <code>VecDeque</code> 优化队列性能时，你会发现Rust不愧是最强的开发语言之一呀。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-23 快速掌握Kotlin-apply函数详解]]></title>    <link>https://juejin.cn/post/7587008326480969770</link>    <guid>https://juejin.cn/post/7587008326480969770</guid>    <pubDate>2025-12-24T06:00:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587008326480969770" data-draft-id="7587046913691435014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-23 快速掌握Kotlin-apply函数详解"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T06:00:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安卓老王"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-23 快速掌握Kotlin-apply函数详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安卓老王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:00:14.000Z" title="Wed Dec 24 2025 06:00:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin <code>apply</code> 函数详解</h2>
<p><code>apply</code> 是 Kotlin 标准库中的一个作用域函数（scope function），用于在对象上执行一个代码块，并返回该对象本身。</p>
<h3 data-id="heading-1">基本概念</h3>
<h4 data-id="heading-2">函数签名</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T.<span class="hljs-title">apply</span><span class="hljs-params">(block: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: T
</code></pre>
<h4 data-id="heading-3">核心特性</h4>
<ol>
<li><strong>接收者对象</strong>：在 lambda 内部，<code>this</code> 指向调用 <code>apply</code> 的对象</li>
<li><strong>返回值</strong>：返回对象本身（返回 <code>this</code>）</li>
<li><strong>典型用途</strong>：对象配置和初始化</li>
</ol>
<h3 data-id="heading-4">基本使用</h3>
<h4 data-id="heading-5">1. 对象初始化</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> city: String = <span class="hljs-string">""</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"Person(name='<span class="hljs-variable">$name</span>', age=<span class="hljs-variable">$age</span>, city='<span class="hljs-variable">$city</span>')"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> person = Person().apply {
        name = <span class="hljs-string">"Alice"</span>  <span class="hljs-comment">// this.name = "Alice"</span>
        age = <span class="hljs-number">25</span>
        city = <span class="hljs-string">"New York"</span>
    }
    
    println(person)  <span class="hljs-comment">// Person(name='Alice', age=25, city='New York')</span>
}
</code></pre>
<h4 data-id="heading-6">2. 与构造器配合使用</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: String) {
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> email: String = <span class="hljs-string">""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">display</span><span class="hljs-params">()</span></span> = <span class="hljs-string">"User(id=<span class="hljs-variable">$id</span>, name=<span class="hljs-variable">$name</span>, email=<span class="hljs-variable">$email</span>)"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"123"</span>).apply {
        name = <span class="hljs-string">"Bob"</span>
        email = <span class="hljs-string">"bob@example.com"</span>
    }
    
    println(user.display())
}
</code></pre>
<h3 data-id="heading-7"><code>apply</code> 与普通初始化对比</h3>
<h4 data-id="heading-8">不使用 <code>apply</code></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> person = Person()
person.name = <span class="hljs-string">"Alice"</span>
person.age = <span class="hljs-number">25</span>
person.city = <span class="hljs-string">"New York"</span>
</code></pre>
<h4 data-id="heading-9">使用 <code>apply</code></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> person = Person().apply {
    name = <span class="hljs-string">"Alice"</span>
    age = <span class="hljs-number">25</span>
    city = <span class="hljs-string">"New York"</span>
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>代码更紧凑</li>
<li>避免重复书写对象变量名</li>
<li>形成逻辑上的代码块</li>
</ul>
<h3 data-id="heading-10">实际应用场景</h3>
<h4 data-id="heading-11">1. Android 开发中的视图配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> textView = TextView(context).apply {
    text = <span class="hljs-string">"Hello, Kotlin!"</span>
    textSize = <span class="hljs-number">16f</span>
    setTextColor(Color.BLACK)
    gravity = Gravity.CENTER
    setPadding(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
}
</code></pre>
<h4 data-id="heading-12">2. 集合和容器的初始化</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 初始化列表</span>
<span class="hljs-keyword">val</span> numbers = mutableListOf&lt;<span class="hljs-built_in">Int</span>&gt;().apply {
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.10</span>) add(i * i)
    addAll(listOf(<span class="hljs-number">100</span>, <span class="hljs-number">121</span>, <span class="hljs-number">144</span>))
    sortDescending()
}

<span class="hljs-comment">// 初始化 Map</span>
<span class="hljs-keyword">val</span> config = mutableMapOf&lt;String, Any&gt;().apply {
    put(<span class="hljs-string">"host"</span>, <span class="hljs-string">"localhost"</span>)
    put(<span class="hljs-string">"port"</span>, <span class="hljs-number">8080</span>)
    put(<span class="hljs-string">"timeout"</span>, <span class="hljs-number">30</span>)
    put(<span class="hljs-string">"retry"</span>, <span class="hljs-literal">true</span>)
}
</code></pre>
<h4 data-id="heading-13">3. Builder 模式替代方案</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span>(
    <span class="hljs-keyword">val</span> brand: String,
    <span class="hljs-keyword">val</span> model: String,
    <span class="hljs-keyword">val</span> year: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">var</span> color: String = <span class="hljs-string">"White"</span>,
    <span class="hljs-keyword">var</span> price: <span class="hljs-built_in">Double</span> = <span class="hljs-number">0.0</span>
)

<span class="hljs-keyword">val</span> myCar = Car(<span class="hljs-string">"Tesla"</span>, <span class="hljs-string">"Model 3"</span>, <span class="hljs-number">2023</span>).apply {
    color = <span class="hljs-string">"Red"</span>
    price = <span class="hljs-number">45000.0</span>
}
</code></pre>
<h4 data-id="heading-14">4. 复杂对象的链式配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConfig</span> {
    <span class="hljs-keyword">var</span> host: String = <span class="hljs-string">"localhost"</span>
    <span class="hljs-keyword">var</span> port: <span class="hljs-built_in">Int</span> = <span class="hljs-number">3306</span>
    <span class="hljs-keyword">var</span> username: String = <span class="hljs-string">"root"</span>
    <span class="hljs-keyword">var</span> password: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> database: String = <span class="hljs-string">"test"</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"DatabaseConfig(host='<span class="hljs-variable">$host</span>', port=<span class="hljs-variable">$port</span>, username='<span class="hljs-variable">$username</span>', database='<span class="hljs-variable">$database</span>')"</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> config = DatabaseConfig().apply {
        host = <span class="hljs-string">"192.168.1.100"</span>
        port = <span class="hljs-number">5432</span>
        username = <span class="hljs-string">"admin"</span>
        password = <span class="hljs-string">"secret123"</span>
        database = <span class="hljs-string">"production"</span>
    }
    
    println(config)
}
</code></pre>
<h3 data-id="heading-15"><code>apply</code> 与其他作用域函数对比</h3>









































<table><thead><tr><th>函数</th><th>接收者引用</th><th>返回值</th><th>典型用途</th></tr></thead><tbody><tr><td><code>apply</code></td><td><code>this</code></td><td>上下文对象</td><td>对象配置</td></tr><tr><td><code>let</code></td><td><code>it</code></td><td>Lambda 结果</td><td>空检查、转换</td></tr><tr><td><code>run</code></td><td><code>this</code></td><td>Lambda 结果</td><td>对象计算、链式调用</td></tr><tr><td><code>with</code></td><td><code>this</code></td><td>Lambda 结果</td><td>非扩展函数，在对象上操作</td></tr><tr><td><code>also</code></td><td><code>it</code></td><td>上下文对象</td><td>附加操作、日志记录</td></tr></tbody></table>
<h4 data-id="heading-16">对比示例</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">var</span> name: String, <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>)
    
    <span class="hljs-comment">// apply - 返回对象本身</span>
    <span class="hljs-keyword">val</span> applyResult = user.apply {
        name = <span class="hljs-string">"Bob"</span>
        age = <span class="hljs-number">30</span>
    }  <span class="hljs-comment">// 返回 user 对象</span>
    
    <span class="hljs-comment">// let - 返回 lambda 结果</span>
    <span class="hljs-keyword">val</span> letResult = user.let {
        it.name = <span class="hljs-string">"Charlie"</span>
        it.age = <span class="hljs-number">35</span>
        <span class="hljs-string">"Name changed"</span>  <span class="hljs-comment">// 返回字符串</span>
    }  <span class="hljs-comment">// 返回 "Name changed"</span>
    
    <span class="hljs-comment">// also - 返回对象本身</span>
    <span class="hljs-keyword">val</span> alsoResult = user.also {
        it.name = <span class="hljs-string">"David"</span>
        it.age = <span class="hljs-number">40</span>
    }  <span class="hljs-comment">// 返回 user 对象</span>
    
    <span class="hljs-comment">// run - 返回 lambda 结果</span>
    <span class="hljs-keyword">val</span> runResult = user.run {
        name = <span class="hljs-string">"Eve"</span>
        age = <span class="hljs-number">45</span>
        <span class="hljs-string">"User updated"</span>  <span class="hljs-comment">// 返回字符串</span>
    }  <span class="hljs-comment">// 返回 "User updated"</span>
}
</code></pre>
<h3 data-id="heading-17">链式调用</h3>
<h4 data-id="heading-18">1. 多级配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span>(<span class="hljs-keyword">var</span> street: String = <span class="hljs-string">""</span>, <span class="hljs-keyword">var</span> city: String = <span class="hljs-string">""</span>)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span>(<span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>, <span class="hljs-keyword">var</span> address: Address = Address())

<span class="hljs-keyword">val</span> company = Company().apply {
    name = <span class="hljs-string">"Tech Corp"</span>
    address.apply {
        street = <span class="hljs-string">"123 Main St"</span>
        city = <span class="hljs-string">"San Francisco"</span>
    }
}
</code></pre>
<h4 data-id="heading-19">2. 复杂对象构建</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">var</span> id: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> items = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">var</span> total: <span class="hljs-built_in">Double</span> = <span class="hljs-number">0.0</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addItem</span><span class="hljs-params">(item: <span class="hljs-type">String</span>, price: <span class="hljs-type">Double</span>)</span></span> {
        items.add(item)
        total += price
    }
}

<span class="hljs-keyword">val</span> order = Order().apply {
    id = <span class="hljs-string">"ORD-001"</span>
    addItem(<span class="hljs-string">"Laptop"</span>, <span class="hljs-number">999.99</span>)
    addItem(<span class="hljs-string">"Mouse"</span>, <span class="hljs-number">29.99</span>)
    addItem(<span class="hljs-string">"Keyboard"</span>, <span class="hljs-number">89.99</span>)
}
</code></pre>
<h3 data-id="heading-20">与空安全结合</h3>
<h4 data-id="heading-21">1. 安全调用</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">var</span> value: String? = <span class="hljs-literal">null</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processConfig</span><span class="hljs-params">(config: <span class="hljs-type">Config</span>?)</span></span> {
    config?.apply {
        value = <span class="hljs-string">"initialized"</span>
        <span class="hljs-comment">// 这里可以安全地访问 config 的属性和方法</span>
        println(<span class="hljs-string">"Config processed: <span class="hljs-variable">$value</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-22">2. 替代 if 非空检查</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateUser</span><span class="hljs-params">(user: <span class="hljs-type">User</span>?)</span></span> {
    <span class="hljs-comment">// 传统方式</span>
    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
        user.name = <span class="hljs-string">"Updated"</span>
        user.age = <span class="hljs-number">30</span>
    }
    
    <span class="hljs-comment">// 使用 apply 的方式</span>
    user?.apply {
        name = <span class="hljs-string">"Updated"</span>
        age = <span class="hljs-number">30</span>
    }
}
</code></pre>
<h3 data-id="heading-23">性能注意事项</h3>
<h4 data-id="heading-24">1. <code>apply</code> 是内联函数</h4>
<p><code>apply</code> 函数使用了 <code>inline</code> 修饰符，这意味着在编译时，lambda 代码会被内联到调用处，不会产生额外的函数对象开销。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">val</span> result = obj.apply { doSomething() }

<span class="hljs-comment">// 编译后（大致等效）</span>
<span class="hljs-keyword">val</span> result = obj
obj.doSomething()
</code></pre>
<h4 data-id="heading-25">2. 与 <code>also</code> 的选择</h4>
<ul>
<li>使用 <code>apply</code> 当需要在 lambda 内访问多个成员时（通过 <code>this</code>）</li>
<li>使用 <code>also</code> 当参数名 <code>it</code> 能提供更好可读性时</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// apply - 适合配置多个属性</span>
<span class="hljs-keyword">val</span> user = User().apply {
    name = <span class="hljs-string">"Alice"</span>
    age = <span class="hljs-number">25</span>
    email = <span class="hljs-string">"alice@example.com"</span>
}

<span class="hljs-comment">// also - 适合单个操作或日志记录</span>
<span class="hljs-keyword">val</span> user = User().also {
    it.name = <span class="hljs-string">"Alice"</span>
    println(<span class="hljs-string">"User created: <span class="hljs-subst">${it.name}</span>"</span>)
}
</code></pre>
<h3 data-id="heading-26">高级用法</h3>
<h4 data-id="heading-27">1. DSL（领域特定语言）构建</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HTML</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> children = mutableListOf&lt;String&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">div</span><span class="hljs-params">(block: <span class="hljs-type">Div</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">val</span> div = Div().apply(block)
        children.add(div.toString())
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span> = children.joinToString(<span class="hljs-string">"\n"</span>)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Div</span> {
    <span class="hljs-keyword">var</span> id: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> className: String = <span class="hljs-string">""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">p</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> = <span class="hljs-string">"&lt;p&gt;<span class="hljs-variable">$text</span>&lt;/p&gt;"</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span> = 
        <span class="hljs-string">"&lt;div id='<span class="hljs-variable">$id</span>' class='<span class="hljs-variable">$className</span>'&gt;<span class="hljs-subst">${/* 子元素 */}</span>&lt;/div&gt;"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">html</span><span class="hljs-params">(block: <span class="hljs-type">HTML</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: HTML {
    <span class="hljs-keyword">return</span> HTML().apply(block)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> page = html {
        div {
            id = <span class="hljs-string">"header"</span>
            className = <span class="hljs-string">"main-header"</span>
        }
        div {
            id = <span class="hljs-string">"content"</span>
            className = <span class="hljs-string">"main-content"</span>
        }
    }
    
    println(page)
}
</code></pre>
<h4 data-id="heading-28">2. 配置构建器模式</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationBuilder</span> {
    <span class="hljs-keyword">var</span> host: String = <span class="hljs-string">"localhost"</span>
    <span class="hljs-keyword">var</span> port: <span class="hljs-built_in">Int</span> = <span class="hljs-number">8080</span>
    <span class="hljs-keyword">var</span> timeout: <span class="hljs-built_in">Int</span> = <span class="hljs-number">30</span>
    <span class="hljs-keyword">var</span> retries: <span class="hljs-built_in">Int</span> = <span class="hljs-number">3</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: Configuration = Configuration(host, port, timeout, retries)
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span>(<span class="hljs-keyword">val</span> host: String, <span class="hljs-keyword">val</span> port: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> timeout: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> retries: <span class="hljs-built_in">Int</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createConfig</span><span class="hljs-params">(block: <span class="hljs-type">ConfigurationBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: Configuration {
    <span class="hljs-keyword">return</span> ConfigurationBuilder().apply(block).build()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> config = createConfig {
        host = <span class="hljs-string">"api.example.com"</span>
        port = <span class="hljs-number">443</span>
        timeout = <span class="hljs-number">60</span>
        retries = <span class="hljs-number">5</span>
    }
    
    println(config)
}
</code></pre>
<h3 data-id="heading-29">常见陷阱和最佳实践</h3>
<h4 data-id="heading-30">1. 不要过度嵌套</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 避免 - 过度嵌套降低可读性</span>
<span class="hljs-keyword">val</span> result = SomeClass().apply {
    property1.apply {
        subProperty.apply {
            <span class="hljs-comment">// 太深了！</span>
        }
    }
}

<span class="hljs-comment">// 建议 - 适度使用</span>
<span class="hljs-keyword">val</span> result = SomeClass().apply {
    property1 = configureProperty1()
    property2 = configureProperty2()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">configureProperty1</span><span class="hljs-params">()</span></span>: PropertyType {
    <span class="hljs-keyword">return</span> PropertyType().apply {
        <span class="hljs-comment">// 配置逻辑</span>
    }
}
</code></pre>
<h4 data-id="heading-31">2. 明确返回意图</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 清晰 - 明确表示这是初始化</span>
<span class="hljs-keyword">val</span> person = Person().apply {
    name = <span class="hljs-string">"Alice"</span>
    age = <span class="hljs-number">25</span>
}

<span class="hljs-comment">// 混淆 - 不要这样使用，会让人疑惑返回值是什么</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createPerson</span><span class="hljs-params">()</span></span>: Person {
    <span class="hljs-keyword">return</span> Person().apply {
        name = <span class="hljs-string">"Alice"</span>
        age = <span class="hljs-number">25</span>
        <span class="hljs-comment">// 如果这里添加了 return，会改变返回值！</span>
    }
}
</code></pre>
<h4 data-id="heading-32">3. 与构造函数参数的区分</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span>(
    <span class="hljs-keyword">val</span> id: String,
    <span class="hljs-keyword">val</span> name: String
) {
    <span class="hljs-keyword">var</span> department: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> salary: <span class="hljs-built_in">Double</span> = <span class="hljs-number">0.0</span>
}

<span class="hljs-comment">// 使用 apply 配置可选属性</span>
<span class="hljs-keyword">val</span> employee = Employee(<span class="hljs-string">"E001"</span>, <span class="hljs-string">"John Doe"</span>).apply {
    department = <span class="hljs-string">"Engineering"</span>
    salary = <span class="hljs-number">75000.0</span>
}
</code></pre>
<h3 data-id="heading-33">总结</h3>
<p><code>apply</code> 函数是 Kotlin 中非常实用的工具，主要优势包括：</p>
<ol>
<li><strong>简化对象初始化</strong>：将多个属性设置集中在一个代码块中</li>
<li><strong>提高代码可读性</strong>：形成逻辑上的初始化单元</li>
<li><strong>支持链式调用</strong>：便于构建复杂对象</li>
<li><strong>类型安全</strong>：在 lambda 内部可以直接访问对象的成员</li>
<li><strong>性能良好</strong>：作为内联函数没有运行时开销</li>
</ol>
<p>使用时机：</p>
<ul>
<li>当需要配置对象多个属性时</li>
<li>构建复杂对象或 DSL 时</li>
<li>替代传统的 Builder 模式</li>
<li>在 Android 中配置视图组件时</li>
</ul>
<p>记住：<code>apply</code> 返回的是对象本身，这使得它非常适合用于初始化配置场景，但不适合需要返回其他值的场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-2-29 快速掌握Kotlin-过滤函数filter]]></title>    <link>https://juejin.cn/post/7587008326481117226</link>    <guid>https://juejin.cn/post/7587008326481117226</guid>    <pubDate>2025-12-24T06:13:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587008326481117226" data-draft-id="7586994471739588651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-2-29 快速掌握Kotlin-过滤函数filter"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T06:13:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安卓老王"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-2-29 快速掌握Kotlin-过滤函数filter
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安卓老王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:13:20.000Z" title="Wed Dec 24 2025 06:13:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin 过滤函数 <code>filter</code> 详解</h2>
<p><code>filter</code> 是 Kotlin 集合处理中最常用的函数之一，用于从集合中筛选出满足特定条件的元素。</p>
<h3 data-id="heading-1">基本用法</h3>
<h4 data-id="heading-2">1. <strong>基础过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>)

<span class="hljs-comment">// 筛选偶数</span>
<span class="hljs-keyword">val</span> evens = numbers.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
println(evens) <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>

<span class="hljs-comment">// 筛选大于5的数</span>
<span class="hljs-keyword">val</span> greaterThanFive = numbers.filter { it &gt; <span class="hljs-number">5</span> }
println(greaterThanFive) <span class="hljs-comment">// [6, 7, 8, 9, 10]</span>

<span class="hljs-comment">// 筛选包含特定字符的字符串</span>
<span class="hljs-keyword">val</span> fruits = listOf(<span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"cherry"</span>, <span class="hljs-string">"date"</span>)
<span class="hljs-keyword">val</span> aFruits = fruits.filter { it.contains(<span class="hljs-string">'a'</span>) }
println(aFruits) <span class="hljs-comment">// [apple, banana, date]</span>
</code></pre>
<h4 data-id="heading-3">2. <strong>不同类型集合的过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// List</span>
<span class="hljs-keyword">val</span> list = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
<span class="hljs-keyword">val</span> filteredList = list.filter { it &gt; <span class="hljs-number">2</span> }

<span class="hljs-comment">// Set</span>
<span class="hljs-keyword">val</span> <span class="hljs-keyword">set</span> = setOf(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>)
<span class="hljs-keyword">val</span> filteredSet = <span class="hljs-keyword">set</span>.filter { it <span class="hljs-keyword">in</span> listOf(<span class="hljs-string">"a"</span>, <span class="hljs-string">"c"</span>) }

<span class="hljs-comment">// Map - 过滤条目</span>
<span class="hljs-keyword">val</span> map = mapOf(<span class="hljs-string">"a"</span> to <span class="hljs-number">1</span>, <span class="hljs-string">"b"</span> to <span class="hljs-number">2</span>, <span class="hljs-string">"c"</span> to <span class="hljs-number">3</span>, <span class="hljs-string">"d"</span> to <span class="hljs-number">4</span>)
<span class="hljs-keyword">val</span> filteredMap = map.filter { (key, value) -&gt; 
    key &gt; <span class="hljs-string">"b"</span> &amp;&amp; value % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> 
}
println(filteredMap) <span class="hljs-comment">// {d=4}</span>

<span class="hljs-comment">// Array</span>
<span class="hljs-keyword">val</span> array = arrayOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
<span class="hljs-keyword">val</span> filteredArray = array.filter { it &gt; <span class="hljs-number">3</span> }
</code></pre>
<h3 data-id="heading-4"><code>filter</code> 的变体函数</h3>
<h4 data-id="heading-5">1. <strong><code>filterNot()</code> - 反向过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)

<span class="hljs-comment">// 过滤掉偶数（保留奇数）</span>
<span class="hljs-keyword">val</span> odds = numbers.filterNot { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
println(odds) <span class="hljs-comment">// [1, 3, 5]</span>

<span class="hljs-comment">// 等价于</span>
<span class="hljs-keyword">val</span> odds2 = numbers.filter { it % <span class="hljs-number">2</span> != <span class="hljs-number">0</span> }
</code></pre>
<h4 data-id="heading-6">2. <strong><code>filterIndexed()</code> - 带索引的过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>, <span class="hljs-number">50</span>)

<span class="hljs-comment">// 根据索引和值进行过滤</span>
<span class="hljs-keyword">val</span> result = numbers.filterIndexed { index, value -&gt;
    index % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> &amp;&amp; value &gt; <span class="hljs-number">20</span>
}
println(result) <span class="hljs-comment">// [30, 50]</span>

<span class="hljs-comment">// 复杂的索引条件</span>
<span class="hljs-keyword">val</span> items = listOf(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>, <span class="hljs-string">"e"</span>)
<span class="hljs-keyword">val</span> filtered = items.filterIndexed { index, item -&gt;
    index &gt; <span class="hljs-number">1</span> &amp;&amp; item <span class="hljs-keyword">in</span> listOf(<span class="hljs-string">"c"</span>, <span class="hljs-string">"e"</span>)
}
println(filtered) <span class="hljs-comment">// [c, e]</span>
</code></pre>
<h4 data-id="heading-7">3. <strong><code>filterIsInstance&lt;T&gt;()</code> - 类型过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> mixedList: List&lt;Any&gt; = listOf(<span class="hljs-number">1</span>, <span class="hljs-string">"hello"</span>, <span class="hljs-number">2.5</span>, <span class="hljs-string">"world"</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4.0</span>)

<span class="hljs-comment">// 过滤出所有整数</span>
<span class="hljs-keyword">val</span> integers = mixedList.filterIsInstance&lt;<span class="hljs-built_in">Int</span>&gt;()
println(integers) <span class="hljs-comment">// [1, 3]</span>

<span class="hljs-comment">// 过滤出所有字符串</span>
<span class="hljs-keyword">val</span> strings = mixedList.filterIsInstance&lt;String&gt;()
println(strings) <span class="hljs-comment">// [hello, world]</span>

<span class="hljs-comment">// 过滤出所有浮点数</span>
<span class="hljs-keyword">val</span> doubles = mixedList.filterIsInstance&lt;<span class="hljs-built_in">Double</span>&gt;()
println(doubles) <span class="hljs-comment">// [2.5, 4.0]</span>
</code></pre>
<h4 data-id="heading-8">4. <strong><code>filterNotNull()</code> - 过滤空值</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> listWithNulls = listOf(<span class="hljs-number">1</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">3</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">4</span>)

<span class="hljs-comment">// 过滤掉所有null值</span>
<span class="hljs-keyword">val</span> withoutNulls = listWithNulls.filterNotNull()
println(withoutNulls) <span class="hljs-comment">// [1, 2, 3, 4]</span>

<span class="hljs-comment">// 在链式调用中使用</span>
<span class="hljs-keyword">val</span> nullableStrings = listOf(<span class="hljs-string">"a"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-literal">null</span>)
<span class="hljs-keyword">val</span> upperCaseLetters = nullableStrings
    .filterNotNull()
    .filter { it.length == <span class="hljs-number">1</span> }
    .map { it.uppercase() }
println(upperCaseLetters) <span class="hljs-comment">// [A, B, C]</span>
</code></pre>
<h4 data-id="heading-9">5. <strong><code>filterTo()</code> - 过滤到指定集合</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>)

<span class="hljs-comment">// 将过滤结果添加到现有的可变集合中</span>
<span class="hljs-keyword">val</span> result = mutableListOf&lt;<span class="hljs-built_in">Int</span>&gt;()
numbers.filterTo(result) { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }

println(result) <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>

<span class="hljs-comment">// 也可以用于不同集合类型</span>
<span class="hljs-keyword">val</span> setResult = mutableSetOf&lt;<span class="hljs-built_in">Int</span>&gt;()
numbers.filterTo(setResult) { it &gt; <span class="hljs-number">5</span> }
println(setResult) <span class="hljs-comment">// [6, 7, 8, 9, 10]</span>
</code></pre>
<h4 data-id="heading-10">6. <strong>Map 的专用过滤函数</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> map = mapOf(
    <span class="hljs-string">"apple"</span> to <span class="hljs-number">10</span>,
    <span class="hljs-string">"banana"</span> to <span class="hljs-number">20</span>,
    <span class="hljs-string">"cherry"</span> to <span class="hljs-number">15</span>,
    <span class="hljs-string">"date"</span> to <span class="hljs-number">5</span>
)

<span class="hljs-comment">// filterKeys - 只根据键过滤</span>
<span class="hljs-keyword">val</span> aKeys = map.filterKeys { it.startsWith(<span class="hljs-string">"a"</span>) }
println(aKeys) <span class="hljs-comment">// {apple=10}</span>

<span class="hljs-comment">// filterValues - 只根据值过滤</span>
<span class="hljs-keyword">val</span> highValues = map.filterValues { it &gt; <span class="hljs-number">10</span> }
println(highValues) <span class="hljs-comment">// {banana=20, cherry=15}</span>
</code></pre>
<h3 data-id="heading-11">实际应用示例</h3>
<h4 data-id="heading-12">1. <strong>数据清洗和转换</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> price: <span class="hljs-built_in">Double</span>,
    <span class="hljs-keyword">val</span> category: String,
    <span class="hljs-keyword">val</span> inStock: <span class="hljs-built_in">Boolean</span>
)

<span class="hljs-keyword">val</span> products = listOf(
    Product(<span class="hljs-number">1</span>, <span class="hljs-string">"Laptop"</span>, <span class="hljs-number">999.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">2</span>, <span class="hljs-string">"Mouse"</span>, <span class="hljs-number">29.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">false</span>),
    Product(<span class="hljs-number">3</span>, <span class="hljs-string">"Desk"</span>, <span class="hljs-number">199.99</span>, <span class="hljs-string">"Furniture"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">4</span>, <span class="hljs-string">"Chair"</span>, <span class="hljs-number">149.99</span>, <span class="hljs-string">"Furniture"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">5</span>, <span class="hljs-string">"Keyboard"</span>, <span class="hljs-number">79.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">6</span>, <span class="hljs-string">"Monitor"</span>, <span class="hljs-number">299.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">false</span>)
)

<span class="hljs-comment">// 筛选有库存的电子产品</span>
<span class="hljs-keyword">val</span> availableElectronics = products.filter { 
    it.category == <span class="hljs-string">"Electronics"</span> &amp;&amp; it.inStock 
}
println(<span class="hljs-string">"有库存的电子产品: <span class="hljs-subst">${availableElectronics.size}</span>"</span>)

<span class="hljs-comment">// 筛选价格在100到300之间的产品</span>
<span class="hljs-keyword">val</span> midRangeProducts = products.filter {
    it.price <span class="hljs-keyword">in</span> <span class="hljs-number">100.0</span>.<span class="hljs-number">.300</span><span class="hljs-number">.0</span>
}
println(<span class="hljs-string">"中价位产品: <span class="hljs-subst">${midRangeProducts.size}</span>"</span>)

<span class="hljs-comment">// 复杂的组合条件</span>
<span class="hljs-keyword">val</span> specialProducts = products.filter { product -&gt;
    (product.category == <span class="hljs-string">"Electronics"</span> &amp;&amp; product.price &lt; <span class="hljs-number">100</span>) ||
    (product.category == <span class="hljs-string">"Furniture"</span> &amp;&amp; product.inStock)
}
println(<span class="hljs-string">"特殊产品: <span class="hljs-subst">${specialProducts.size}</span>"</span>)
</code></pre>
<h4 data-id="heading-13">2. <strong>用户输入验证</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInput</span>(
    <span class="hljs-keyword">val</span> username: String,
    <span class="hljs-keyword">val</span> email: String,
    <span class="hljs-keyword">val</span> password: String,
    <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>?
)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validateInputs</span><span class="hljs-params">(inputs: <span class="hljs-type">List</span>&lt;<span class="hljs-type">UserInput</span>&gt;)</span></span>: List&lt;UserInput&gt; {
    <span class="hljs-keyword">return</span> inputs.filter { input -&gt;
        <span class="hljs-comment">// 用户名：3-20个字符，只包含字母数字</span>
        input.username.matches(Regex(<span class="hljs-string">"^[a-zA-Z0-9]{3,20}$"</span>)) &amp;&amp;
        <span class="hljs-comment">// 邮箱：有效格式</span>
        input.email.matches(Regex(<span class="hljs-string">"^[A-Za-z0-9+_.-]+@(.+)$"</span>)) &amp;&amp;
        <span class="hljs-comment">// 密码：至少8个字符，包含大小写和数字</span>
        input.password.matches(Regex(<span class="hljs-string">"^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d).{8,}$"</span>)) &amp;&amp;
        <span class="hljs-comment">// 年龄：18-120之间</span>
        (input.age == <span class="hljs-literal">null</span> || input.age <span class="hljs-keyword">in</span> <span class="hljs-number">18.</span><span class="hljs-number">.120</span>)
    }
}

<span class="hljs-keyword">val</span> userInputs = listOf(
    UserInput(<span class="hljs-string">"john123"</span>, <span class="hljs-string">"john@email.com"</span>, <span class="hljs-string">"Pass123"</span>, <span class="hljs-number">25</span>),
    UserInput(<span class="hljs-string">"ab"</span>, <span class="hljs-string">"bad-email"</span>, <span class="hljs-string">"weak"</span>, <span class="hljs-number">15</span>),
    UserInput(<span class="hljs-string">"jane_doe"</span>, <span class="hljs-string">"jane@email.com"</span>, <span class="hljs-string">"StrongPass123"</span>, <span class="hljs-number">30</span>)
)

<span class="hljs-keyword">val</span> validInputs = validateInputs(userInputs)
println(<span class="hljs-string">"有效输入数量: <span class="hljs-subst">${validInputs.size}</span>"</span>)
</code></pre>
<h4 data-id="heading-14">3. <strong>API 响应处理</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T?,
    <span class="hljs-keyword">val</span> error: String?,
    <span class="hljs-keyword">val</span> statusCode: <span class="hljs-built_in">Int</span>
)

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: String, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> active: <span class="hljs-built_in">Boolean</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processResponses</span><span class="hljs-params">(responses: <span class="hljs-type">List</span>&lt;<span class="hljs-type">ApiResponse</span>&lt;<span class="hljs-type">List</span>&lt;<span class="hljs-type">User</span>&gt;&gt;&gt;)</span></span>: List&lt;User&gt; {
    <span class="hljs-keyword">return</span> responses
        <span class="hljs-comment">// 过滤成功的响应</span>
        .filter { it.statusCode == <span class="hljs-number">200</span> &amp;&amp; it.error == <span class="hljs-literal">null</span> }
        <span class="hljs-comment">// 获取数据</span>
        .flatMap { it.<span class="hljs-keyword">data</span> ?: emptyList() }
        <span class="hljs-comment">// 过滤活跃用户</span>
        .filter { it.active }
        <span class="hljs-comment">// 去重</span>
        .distinctBy { it.id }
}

<span class="hljs-keyword">val</span> apiResponses = listOf(
    ApiResponse(
        <span class="hljs-keyword">data</span> = listOf(User(<span class="hljs-string">"1"</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-literal">true</span>), User(<span class="hljs-string">"2"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-literal">false</span>)),
        error = <span class="hljs-literal">null</span>,
        statusCode = <span class="hljs-number">200</span>
    ),
    ApiResponse(
        <span class="hljs-keyword">data</span> = <span class="hljs-literal">null</span>,
        error = <span class="hljs-string">"Server error"</span>,
        statusCode = <span class="hljs-number">500</span>
    ),
    ApiResponse(
        <span class="hljs-keyword">data</span> = listOf(User(<span class="hljs-string">"1"</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-literal">true</span>), User(<span class="hljs-string">"3"</span>, <span class="hljs-string">"Charlie"</span>, <span class="hljs-literal">true</span>)),
        error = <span class="hljs-literal">null</span>,
        statusCode = <span class="hljs-number">200</span>
    )
)

<span class="hljs-keyword">val</span> activeUsers = processResponses(apiResponses)
println(<span class="hljs-string">"活跃用户: <span class="hljs-variable">$activeUsers</span>"</span>)
</code></pre>
<h4 data-id="heading-15">4. <strong>文件处理</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileInfo</span>(
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> size: <span class="hljs-built_in">Long</span>,
    <span class="hljs-keyword">val</span> extension: String,
    <span class="hljs-keyword">val</span> lastModified: <span class="hljs-built_in">Long</span>
)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">filterFiles</span><span class="hljs-params">(files: <span class="hljs-type">List</span>&lt;<span class="hljs-type">FileInfo</span>&gt;)</span></span>: List&lt;FileInfo&gt; {
    <span class="hljs-keyword">val</span> now = System.currentTimeMillis()
    <span class="hljs-keyword">val</span> oneWeekAgo = now - (<span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>)
    
    <span class="hljs-keyword">return</span> files.filter { file -&gt;
        <span class="hljs-comment">// 最近一周内修改过的文件</span>
        file.lastModified &gt; oneWeekAgo &amp;&amp;
        <span class="hljs-comment">// 特定类型的文件</span>
        file.extension <span class="hljs-keyword">in</span> listOf(<span class="hljs-string">"txt"</span>, <span class="hljs-string">"pdf"</span>, <span class="hljs-string">"docx"</span>) &amp;&amp;
        <span class="hljs-comment">// 文件大小在合理范围内</span>
        file.size <span class="hljs-keyword">in</span> <span class="hljs-number">1024.</span>.(<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) &amp;&amp; <span class="hljs-comment">// 1KB - 10MB</span>
        <span class="hljs-comment">// 文件名不含特殊字符</span>
        file.name.matches(Regex(<span class="hljs-string">"^[a-zA-Z0-9._ -]+\\.<span class="hljs-subst">${file.extension}</span>$"</span>))
    }
}
</code></pre>
<h3 data-id="heading-16">性能优化技巧</h3>
<h4 data-id="heading-17">1. <strong>避免重复过滤</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不好：重复过滤和转换</span>
<span class="hljs-keyword">val</span> numbers = (<span class="hljs-number">1.</span><span class="hljs-number">.1000</span>).toList()

<span class="hljs-keyword">val</span> badExample = numbers
    .filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }     <span class="hljs-comment">// 第一次遍历</span>
    .map { it * <span class="hljs-number">2</span> }            <span class="hljs-comment">// 第二次遍历</span>
    .filter { it &gt; <span class="hljs-number">100</span> }       <span class="hljs-comment">// 第三次遍历</span>

<span class="hljs-comment">// 好：合并过滤条件</span>
<span class="hljs-keyword">val</span> goodExample = numbers
    .filter { 
        <span class="hljs-keyword">val</span> isEven = it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>
        <span class="hljs-keyword">val</span> doubled = it * <span class="hljs-number">2</span>
        isEven &amp;&amp; doubled &gt; <span class="hljs-number">100</span>
    }
    .map { it * <span class="hljs-number">2</span> }
</code></pre>
<h4 data-id="heading-18">2. <strong>使用序列处理大数据集</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> largeList = (<span class="hljs-number">1.</span><span class="hljs-number">.1_000_000</span>).toList()

<span class="hljs-comment">// 普通方式：创建中间集合</span>
<span class="hljs-keyword">val</span> regular = largeList
    .filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }     <span class="hljs-comment">// 创建中间集合</span>
    .map { it * <span class="hljs-number">2</span> }            <span class="hljs-comment">// 创建中间集合</span>
    .take(<span class="hljs-number">10</span>)                  <span class="hljs-comment">// 取前10个</span>

<span class="hljs-comment">// 使用序列：惰性求值，更高效</span>
<span class="hljs-keyword">val</span> withSequence = largeList.asSequence()
    .filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }     <span class="hljs-comment">// 惰性过滤</span>
    .map { it * <span class="hljs-number">2</span> }            <span class="hljs-comment">// 惰性映射</span>
    .take(<span class="hljs-number">10</span>)                  <span class="hljs-comment">// 只取10个</span>
    .toList()                  <span class="hljs-comment">// 最后转换为列表</span>
</code></pre>
<h4 data-id="heading-19">3. <strong>缓存频繁使用的谓词</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = (<span class="hljs-number">1.</span><span class="hljs-number">.1000</span>).toList()

<span class="hljs-comment">// 重复计算谓词</span>
<span class="hljs-keyword">val</span> predicates = listOf(
    { n: <span class="hljs-built_in">Int</span> -&gt; n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> },
    { n: <span class="hljs-built_in">Int</span> -&gt; n % <span class="hljs-number">3</span> == <span class="hljs-number">0</span> },
    { n: <span class="hljs-built_in">Int</span> -&gt; n &gt; <span class="hljs-number">100</span> }
)

<span class="hljs-comment">// 一次性应用多个过滤器</span>
<span class="hljs-keyword">val</span> result = numbers.filter { number -&gt;
    predicates.all { predicate -&gt; predicate(number) }
}
</code></pre>
<h3 data-id="heading-20">与 <code>partition</code> 的对比</h3>
<p><code>filter</code> 返回满足条件的元素，<code>partition</code> 将集合分成两个列表。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> numbers = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>)

<span class="hljs-comment">// 使用 filter 和 filterNot</span>
<span class="hljs-keyword">val</span> evens = numbers.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
<span class="hljs-keyword">val</span> odds = numbers.filterNot { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }

<span class="hljs-comment">// 使用 partition（更高效，只遍历一次）</span>
<span class="hljs-keyword">val</span> (evensPart, oddsPart) = numbers.partition { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }

println(<span class="hljs-string">"偶数: <span class="hljs-variable">$evensPart</span>"</span>)   <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>
println(<span class="hljs-string">"奇数: <span class="hljs-variable">$oddsPart</span>"</span>)    <span class="hljs-comment">// [1, 3, 5, 7, 9]</span>
</code></pre>
<h3 data-id="heading-21">自定义过滤条件</h3>
<h4 data-id="heading-22">1. <strong>创建可重用的谓词函数</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义谓词函数</span>
<span class="hljs-keyword">val</span> isEven: (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Boolean</span> = { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
<span class="hljs-keyword">val</span> isPositive: (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Boolean</span> = { it &gt; <span class="hljs-number">0</span> }
<span class="hljs-keyword">val</span> inRange: (<span class="hljs-built_in">Int</span>) -&gt; (<span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Boolean</span> = { min -&gt; { max -&gt; 
    { value -&gt; value <span class="hljs-keyword">in</span> min..max } 
}}

<span class="hljs-comment">// 使用谓词函数</span>
<span class="hljs-keyword">val</span> numbers = listOf(-<span class="hljs-number">5</span>, -<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>)

<span class="hljs-keyword">val</span> positiveEvens = numbers.filter { isEven(it) &amp;&amp; isPositive(it) }
<span class="hljs-keyword">val</span> inRange10to20 = numbers.filter { inRange(<span class="hljs-number">10</span>)(<span class="hljs-number">20</span>)(it) }

<span class="hljs-comment">// 组合谓词</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">composePredicates</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> predicates: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: (T) -&gt; <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> { item -&gt; predicates.all { it(item) } }
}

<span class="hljs-keyword">val</span> complexFilter = composePredicates(isPositive, isEven)
<span class="hljs-keyword">val</span> result = numbers.filter(complexFilter)
</code></pre>
<h4 data-id="heading-23">2. <strong>面向对象的过滤策略</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">FilterStrategy</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldInclude</span><span class="hljs-params">(item: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PriceFilter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> minPrice: <span class="hljs-built_in">Double</span>, <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> maxPrice: <span class="hljs-built_in">Double</span>) : 
    FilterStrategy&lt;Product&gt; {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldInclude</span><span class="hljs-params">(item: <span class="hljs-type">Product</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> item.price <span class="hljs-keyword">in</span> minPrice..maxPrice
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CategoryFilter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> category: String) : FilterStrategy&lt;Product&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldInclude</span><span class="hljs-params">(item: <span class="hljs-type">Product</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> item.category == category
    }
}

<span class="hljs-comment">// 使用策略模式过滤</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">filterWith</span><span class="hljs-params">(strategies: <span class="hljs-type">List</span>&lt;<span class="hljs-type">FilterStrategy</span>&lt;<span class="hljs-type">T</span>&gt;&gt;)</span></span>: List&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.filter { item -&gt;
        strategies.all { strategy -&gt; strategy.shouldInclude(item) }
    }
}

<span class="hljs-keyword">val</span> products = listOf(
    Product(<span class="hljs-number">1</span>, <span class="hljs-string">"Laptop"</span>, <span class="hljs-number">999.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">2</span>, <span class="hljs-string">"Desk"</span>, <span class="hljs-number">199.99</span>, <span class="hljs-string">"Furniture"</span>, <span class="hljs-literal">true</span>),
    Product(<span class="hljs-number">3</span>, <span class="hljs-string">"Mouse"</span>, <span class="hljs-number">29.99</span>, <span class="hljs-string">"Electronics"</span>, <span class="hljs-literal">true</span>)
)

<span class="hljs-keyword">val</span> strategies = listOf(
    PriceFilter(<span class="hljs-number">100.0</span>, <span class="hljs-number">500.0</span>),
    CategoryFilter(<span class="hljs-string">"Electronics"</span>)
)

<span class="hljs-keyword">val</span> filteredProducts = products.filterWith(strategies)
</code></pre>
<h3 data-id="heading-24">注意事项</h3>
<h4 data-id="heading-25">1. <strong>空安全处理</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> nullableList: List&lt;<span class="hljs-built_in">Int</span>&gt;? = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment">// 安全调用</span>
<span class="hljs-keyword">val</span> result1 = nullableList?.filter { it != <span class="hljs-literal">null</span> &amp;&amp; it &gt; <span class="hljs-number">2</span> }

<span class="hljs-comment">// 使用空安全操作符和 filterNotNull</span>
<span class="hljs-keyword">val</span> result2 = nullableList
    ?.filterNotNull()
    ?.filter { it &gt; <span class="hljs-number">2</span> }

<span class="hljs-comment">// 提供默认值</span>
<span class="hljs-keyword">val</span> result3 = (nullableList ?: emptyList())
    .filterNotNull()
    .filter { it &gt; <span class="hljs-number">2</span> }
</code></pre>
<h4 data-id="heading-26">2. <strong>性能考虑</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 避免在 filter 中进行复杂计算</span>
<span class="hljs-keyword">val</span> largeList = (<span class="hljs-number">1.</span><span class="hljs-number">.10000</span>).toList()

<span class="hljs-comment">// 不好：每次过滤都计算平方</span>
<span class="hljs-keyword">val</span> bad = largeList.filter { 
    <span class="hljs-keyword">val</span> squared = it * it
    squared &gt; <span class="hljs-number">1000</span>
}

<span class="hljs-comment">// 好：预先计算或简化</span>
<span class="hljs-keyword">val</span> good = largeList.filter { it &gt; <span class="hljs-number">31</span> } <span class="hljs-comment">// 因为 32² = 1024 &gt; 1000</span>
</code></pre>
<h4 data-id="heading-27">3. <strong>保持不可变性</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> original = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment">// filter 不会修改原始集合</span>
<span class="hljs-keyword">val</span> filtered = original.filter { it &gt; <span class="hljs-number">3</span> }
println(original)  <span class="hljs-comment">// [1, 2, 3, 4, 5] - 不变</span>
println(filtered)  <span class="hljs-comment">// [4, 5]</span>
</code></pre>
<h3 data-id="heading-28">总结</h3>
<p><code>filter</code> 函数是 Kotlin 集合处理的核心工具，具有以下特点：</p>
<ol>
<li><strong>多种变体</strong>：提供了 <code>filterNot</code>、<code>filterIndexed</code>、<code>filterIsInstance</code> 等多种变体</li>
<li><strong>链式调用</strong>：可以与其他集合函数（如 <code>map</code>、<code>flatMap</code>）链式调用</li>
<li><strong>惰性求值</strong>：通过 <code>asSequence()</code> 支持惰性求值，优化性能</li>
<li><strong>类型安全</strong>：支持泛型，提供编译时类型检查</li>
<li><strong>空安全</strong>：与 Kotlin 的空安全系统完美集成</li>
</ol>
<p>使用建议：</p>
<ul>
<li>对于简单条件，直接使用 lambda 表达式</li>
<li>对于复杂或可重用的条件，定义谓词函数</li>
<li>处理大数据集时考虑使用序列</li>
<li>需要同时获取满足和不满足条件的元素时使用 <code>partition</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙心迹】- 02-自然壁纸实战教程-AGC 新建项目]]></title>    <link>https://juejin.cn/post/7587017021314400291</link>    <guid>https://juejin.cn/post/7587017021314400291</guid>    <pubDate>2025-12-24T07:24:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587017021314400291" data-draft-id="7587243886432780322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙心迹】- 02-自然壁纸实战教程-AGC 新建项目"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-24T07:24:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙心迹】- 02-自然壁纸实战教程-AGC 新建项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:24:37.000Z" title="Wed Dec 24 2025 07:24:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">02-自然壁纸实战教程-AGC 新建项目</h2>
<h3 data-id="heading-1">什么是 AGC 平台</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fservice%2Fjosp%2Fagc%2Findex.html%23%2F" target="_blank" title="https://developer.huawei.com/consumer/cn/service/josp/agc/index.html#/" ref="nofollow noopener noreferrer">AppGallery Connect</a>（以下简称 AGC）是华为推出的应用一站式服务平台，致力于为开发者提供应用创意、开发、分发、运营、分析</p>
<p>全生命周期服务，构建全场景智慧化的应用生态。</p>
<p>AppGallery Connect 深度整合华为内部各项优质服务，将华为在全球化、质量、安全、工程管理等领域长期积累的能力开放给您，大</p>
<p>幅降低应用开发与运维难度，提高版本质量，开放分发和运营服务，帮助您获得用户并实现收入的规模增长。</p>
<p><img alt="img转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>大白话就是 AGC 是开发者用来管理我们上架项目的后台花园，需要在这里新建项目、上架项目、分析项目等等。所以项目开发之前需要先提前做好这个环境准备工作。</p>
<h3 data-id="heading-2">新建项目</h3>
<p>一个项目可以有多个应用，比如美团是一个项目，但是它可以有用户端、骑手端、商家端等三个应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd85a19f882d4a0ab26b2f02234cc1bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=3MxV1lE%2Fr4TFO05mzW33aaQpHtE%3D" alt="image-20250622205537284" loading="lazy"/></p>
<p>然后根据实际情况填写资料</p>
<h3 data-id="heading-3">新建应用</h3>
<p>然后在这里新建应用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edf77448cd7e4d1f9eafbe3704ada9bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=4wvMB8mmESBg3jxkvyi40TJkXUQ%3D" alt="image-20250622205714372" loading="lazy"/></p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d5388df6ffe4c2186ef310dd6ce0a88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=eCjLI73lsNosN1A1uvaGOWStnPk%3D" alt="image-20250622205759276" loading="lazy"/></p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37ae0accc7124d37a52842496b9374f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=JW6WLrtAtRKtTWYawleN6NWBoVM%3D" alt="image-20250622205818962" loading="lazy"/></p>
<p>然后根据实际情况选择类型，自然壁纸是元服务，元服务上架比应用要简单。</p>
<h3 data-id="heading-4">DevEco Studio 新建元服务项目</h3>
<p>上述步骤准备好了，就可以回到桌面上，使用 DevEco Studio 新建元服务了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/263a2a024b3849d6bd603b4ff4f4e4f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=OkIoDkMQIK%2FqCuXesD7NxXiLNmk%3D" alt="image-20250622210110627" loading="lazy"/></p>
<hr/>
<p>然后这里就会出现我们之前在 AGC 平台上新建好的元服务应用了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ae1f1f760694e0e802d52fe18f6ba64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165877&amp;x-signature=2p%2F1qJfGDzjmHYsucM9Im1Oi3OM%3D" alt="image-20250622210409257" loading="lazy"/></p>
<p>至此，可以认为初步的项目新建工作已经完成了，但是实际情况下，后续的开发和发布上架，还需要用到一些证书，包括调用网络服务还需要进行域名备案，这块内容可以后面来完善，当前教程偏向初学者，所以优先关注核心代码吧，或者有具体疑问了都可以在技术交流群中进行提问。</p>
<h3 data-id="heading-5">近期活动</h3>
<p>最近想要想要考取 HarmonyOS 基础或者高级证书，或者快要获取的同学都可以点击这个链接，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F7e230b074eaa41c587c71c1d1a9a6514%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/7e230b074eaa41c587c71c1d1a9a6514?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">加入我的班级</a>，考取成功有机会获得鸿蒙礼盒一份。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙心迹】-03-自然壁纸实战教程-项目结构介绍]]></title>    <link>https://juejin.cn/post/7587023071066505268</link>    <guid>https://juejin.cn/post/7587023071066505268</guid>    <pubDate>2025-12-24T07:25:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587023071066505268" data-draft-id="7587028972245794851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙心迹】-03-自然壁纸实战教程-项目结构介绍"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-24T07:25:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙心迹】-03-自然壁纸实战教程-项目结构介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:25:34.000Z" title="Wed Dec 24 2025 07:25:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">03-自然壁纸实战教程-项目结构介绍</h2>
<h3 data-id="heading-1">架构选型</h3>
<p>按照目前主流的鸿蒙应用开发来讲，基本都是推荐三层架构-<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fbest-practices%2Fbpta-multi-device-overview" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-multi-device-overview" ref="nofollow noopener noreferrer">一次开发-多端部署</a>，因为主要考虑到多端适配，那么这个选型是必然的了。但是自然壁纸当初的立项的出发点比较简单，怎么快怎么来，所以就直接选择了单HAP架构。</p>
<h4 data-id="heading-2">单HAP架构</h4>
<p>对于单窗口应用的APP工程，其仅包含一个Entry类型的HAP。划分的模块则根据是否有按需加载的需求，来考虑采用HAR模块和</p>
<p>HSP模块。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3126d73d9f643dd9963aa1e992f7365~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165933&amp;x-signature=Q0nUkLCzpTeopYx9QXVnLT%2B6QAs%3D" alt="image-20250627092419769" loading="lazy"/></p>
<blockquote>
<p>注意，正常开发的工程是不会把设计稿放在工程内的，这里存放只是为了方便学习者直接拿到，不另外存储而已！</p>
</blockquote>
<h4 data-id="heading-3">多HAP工程</h4>
<p>对于同一个设备类型，如果要实现不同的独立功能模块，并且相对独立，以及具有单独的入口的功能特性，建议做成一个独立特性的HAP，按需下载安装。此时一个App包中，就会有多个HAP包，其中有且仅有一个Entry类型的HAP，其他的均是Feature类型的HAP。多HAP之间业务独立，但是可能会有业务能力共享，所以在进行模块化设计时，需要根据是否具有公共能力来进行选择。</p>
<h3 data-id="heading-4">核心目录结构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/879c122c026a488ab121f54f5f1ea7b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165933&amp;x-signature=q9aVW5lcvc3rpGFRv%2FyAPcp5iGc%3D" alt="image-20250627092534277" loading="lazy"/></p>
<p>核心目录结构也比较常规</p>
<pre><code class="hljs language-csharp" lang="csharp">├── components\          <span class="hljs-meta"># 组件目录</span>
├── <span class="hljs-keyword">const</span>\               <span class="hljs-meta"># 常量定义目录</span>
├── entryability\        <span class="hljs-meta"># 入口能力目录</span>
├── entryformability\    <span class="hljs-meta"># 入口表单能力目录</span>
├── pages\               <span class="hljs-meta"># 页面目录</span>
├── services\            <span class="hljs-meta"># 通用逻辑服务目录</span>
├── utils\               <span class="hljs-meta"># 工具类目录</span>
├── viewModel\           <span class="hljs-meta"># 视图模型目录</span>
├── views\               <span class="hljs-meta"># 视图目录</span>
└── zrbzwidget\          <span class="hljs-meta"># 卡片组件目录</span>
</code></pre>
<p>其中优先需要关注的是页面目录结构，它决定当前项目存在多少个页面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d50482c756c43bc8db243cdd26144f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165933&amp;x-signature=ZGTGNdj1l%2FLJB3lSLfanXTI1J%2FY%3D" alt="image-20250627093523143" loading="lazy"/></p>
<p>当然了，作为学习者而已，在开始学习的时候不需要一口气全部新建完，做到哪里了，就用到哪里即可。</p>
<p>由于工程使用的是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-navigation-navigation" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation" ref="nofollow noopener noreferrer">Navigation</a>作为路由管理，所以Pages下只放了一个页面 Index.ets 作为入口，剩下的页面都放到了view目录下。</p>
<h3 data-id="heading-5">API版本</h3>
<p>项目开始时是使用API14的版本，但是目前官网已经更新到了API20，欢迎有能力的小伙伴们直接使用最新的API20，当出现问题时，可以沟通解决，确保用到的是最新的技术。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f672f4abcfe74c4a8086b0a0c66d230e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767165933&amp;x-signature=8HW8mTyQ5ugDPDcCPpz1bJuiYh8%3D" alt="image-20250630083159327" loading="lazy"/></p>
<h3 data-id="heading-6">近期活动</h3>
<p>最近想要想要考取 HarmonyOS 基础或者高级证书，或者快要获取的同学都可以点击这个链接，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F7e230b074eaa41c587c71c1d1a9a6514%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/7e230b074eaa41c587c71c1d1a9a6514?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">加入我的班级</a>，考取成功有机会获得鸿蒙礼盒一份。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[到底是选 merge 还是选 rebase]]></title>    <link>https://juejin.cn/post/7587017021314498595</link>    <guid>https://juejin.cn/post/7587017021314498595</guid>    <pubDate>2025-12-24T07:36:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587017021314498595" data-draft-id="7587028972245827619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="到底是选 merge 还是选 rebase"/> <meta itemprop="keywords" content="面试,程序员,Git"/> <meta itemprop="datePublished" content="2025-12-24T07:36:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dolphin_海豚"/> <meta itemprop="url" content="https://juejin.cn/user/116975171023884"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            到底是选 merge 还是选 rebase
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/116975171023884/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dolphin_海豚
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:36:38.000Z" title="Wed Dec 24 2025 07:36:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>写这篇文章的契机也是因为有次组内技术分享会里面讨论过这个话题，这两个指令都是用来合并分支代码的，rebase 可以把分支记录弄成一条线性，而 merge 保留了分支树状图，以我的习惯是更倾向于 merge，因为我大部分场景用不上 rebase</p>
<p>我们先看个大家开发中非常常见的场景，两个人基于 master 的同一个 commit 节点各自拉起一个新的 feature 分支，其中一个人 A 有多个 commit，并率先完成任务合入 master，B 也有多个 commit ，在他完成任务准备合入 master 时，发现有冲突，这里我模拟的每个提交都是针对同一个文件，每个 commit 都会有冲突</p>
<p>在 A 合并 master 前的分支图如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1403bbd4f03418d999eb1da408c4aff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=UWON9dAs1ueNqxbdlHWdGQmLf5w%3D" alt="1.jpg" loading="lazy"/></p>
<p>可以看到 feature/A 分支 和 feature/B 分支都是基于 master 最新的 commit 拉起的分支，两条分支并行开发，这里我为了跟随时间线，用顺序数字模拟 commit 信息，两条分支各自新增了 3 个 commit</p>
<p>现在我们把 A 通过 merge 合并到 master 上</p>
<pre><code class="hljs language-bash" lang="bash">git checkout master
git merge feature/A
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf16486b2501476994905ad3d3ee7c4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=HRGQtdzhMbAoL5dNfMLzedLTKO0%3D" alt="2.jpg" loading="lazy"/></p>
<p>可以看到 A merge 到 master 后，master 和 feature/A 保持一致了</p>
<p>好了，开头说的场景已经出现了，这个时候你是 B 你会怎么做，要是我会选择 merge，那就先看下 merge 的表现</p>
<pre><code class="hljs language-bash" lang="bash">git checkout master
git merge feature/B
</code></pre>
<p>由于我的每个 commit 都是针对同一个文件做出更改，所以最终汇入必然要去解决冲突</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11d931780fd4433cb009e1acab3e1063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=nJC7ZI%2BSHpb9%2BHGNxJ5b0AwRhnE%3D" alt="5.jpg" loading="lazy"/>
可以看到这里的冲突是让你一次性解决的，解决完冲突后提交看 分支图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7438acd2587440b7957efee20fc88152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=zhtFrwQgHICGJeyJt1s9PvfCBg0%3D" alt="3.jpg" loading="lazy"/></p>
<p>可以看到，<strong>merge 会创建一个新的合并提交，把两个分支平行的合并，保留了分支历史</strong></p>
<p>这里顺带解释下为啥有时候 merge 没有 mr 节点，有时候又有，其实大部分情况下都会有。比如这里的 feature/A 合入 master 就没产生 mr 节点，feature/B 后合入 master 就产生了 mr 节点</p>
<p>merge 节点有没有取决于 git 是否需要创建一个新的合并提交</p>
<blockquote>
<p>可能你体感上是永远会有 mr 节点，因为远程合作大部分场景 master 都是一直在前进的</p>
</blockquote>
<ul>
<li>fast-forward 合并
<ul>
<li>master 还停留在你分支起点的那个提交，比如 feature/A 合入到 master 的时候，master 和 feature/A 同一个起点，这就是 fast-forward 提交，就不会产生 mr 节点</li>
</ul>
</li>
<li>非 fast-forward 合并
<ul>
<li>master 相较于你的分支有了新的提交，比如 feature/B 的起点是最初的 <code>docs: add README</code> ，在 feature/B 准备合入 master 时，master 最新的提交却是 feature/A 的 <code>dosc: 5</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>估计这个时候就小盆友要说了，我的这个 mr 节点是在我解决冲突时提交的，其实就算没有冲突，非 fast-forward 合并就是会产生 mr 节点</p>
</blockquote>
<p>好，我们现在撤回 feature/B merge 到 master，我们改用 rebase 再来看下对比</p>
<p>撤回之后的分支图如下，master 还是停留在 <code>docs: 5</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26c94ef6dd7145a695dd3c915c2f7e29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=vRozP5wg1UrLsvsJeVmxBURNHeE%3D" alt="4.jpg" loading="lazy"/></p>
<p>现在使用 rebase</p>
<pre><code class="hljs language-bash" lang="bash">git checkout feature/B
git rebase master
</code></pre>
<p>可以看到 vscode 编辑器让我去解决冲突，这还是第一个</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4a744caf460486e8c8467a8cc14c541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=5dlHSXMoiU1ubT2HfZ9OxarKu20%3D" alt="6.jpg" loading="lazy"/></p>
<p><strong>要是每个 commit 都有冲突那就每个 commit 都要单独解决一次冲突</strong></p>
<p>一旦解决冲突并 git add，再运行 git rebase --continue，git 就会继续重放下一个提交，若同一段代码在多个提交中都改过，就会感觉是在重复解决冲突</p>
<p>现在回过头来看 git 树</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29abed4004d147e993cdc9d88b5f2b29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9scGhpbl_mtbfosZo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166598&amp;x-signature=ZFWY7B09tc3vGoAiH0horhCeOFQ%3D" alt="7.jpg" loading="lazy"/></p>
<p>可以看到 最终的 git 记录成一条直线了，看着确实顺眼不少，并且你的分支所有提交都会提前，你也<strong>不会产生 合并 的 mr 节点</strong>，但是<strong>你分支上原本的 commit hash （<code>docs:3, dosc: 4, dosc: 6</code>）会发生变化</strong></p>
<h2 data-id="heading-0">结论</h2>
<p>从 git 提交记录看</p>
<ul>
<li>merge 保留历史记录，非线性，容易产生 mr 节点</li>
<li>rebase 将自己的 commit 记录提前并更改你之前的 commit hash，线性，不产生多余的 mr 节点</li>
</ul>
<p>从 解决冲突 看</p>
<ul>
<li>merge 在汇入那一刻解决所有的冲突，直接对比两个分支代码的终极形态</li>
<li>rebase 会按顺序重放你的所有 commit，但凡有冲突的提交都会让你挨个去解决</li>
</ul>
<p>用 rebase 是有使用场景的，要是不清楚无脑 merge 就好。只有你一个人使用的分支，并且还没 push 到远端，可以去使用 rebase 整理下 git 历史，否则其余所有情况都可以用 merge</p>
<blockquote>
<p>git rebase -i 可以整理提交顺序，合并多个小提交，改写提交信息</p>
</blockquote>
<p>rebase 一定不能在公共分支上使用，因为这会篡改共有分支的 commit hash，别人再去合代码必然导致冲突</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React学习：通过TodoList，完整理解组件通信]]></title>    <link>https://juejin.cn/post/7587020682010738715</link>    <guid>https://juejin.cn/post/7587020682010738715</guid>    <pubDate>2025-12-24T07:33:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587020682010738715" data-draft-id="7587074669816578074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React学习：通过TodoList，完整理解组件通信"/> <meta itemprop="keywords" content="JavaScript,React.js,前端框架"/> <meta itemprop="datePublished" content="2025-12-24T07:33:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南山安"/> <meta itemprop="url" content="https://juejin.cn/user/1795929588117962"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React学习：通过TodoList，完整理解组件通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1795929588117962/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南山安
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:33:00.000Z" title="Wed Dec 24 2025 07:33:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 组件通信从零到精通：用一个完整 Todo List 项目彻底搞懂父子、子父与兄弟通信</h2>
<p>最近学习了React中完整点的组件通信，包括父传子，子传父，兄弟组件通信。概念听起来简单——props 向下传、回调向上传、状态提升——但真正写代码时，总觉得迷迷糊糊。于是我通过一个 Todo List 功能讲解，结合真实代码，一点点拆解了组件通信的每一个细节。</p>
<p>从最基础的父传子开始，到子传父的回调机制，再到兄弟组件的状态提升，最后深入到大家经常问的“为什么 onChange 要包箭头函数”这类细节。全程基于一个可运行的 Todo List 项目，代码全部贴出，讲解尽量通俗、细致，适合初学者反复阅读，也适合有经验的同学复习巩固。</p>
<h4 data-id="heading-1">项目整体结构：经典的状态提升模式</h4>
<p>先看整个项目的组件树：</p>
<pre><code class="hljs language-text" lang="text">App（父组件）
├── TodoInput（添加输入框）
├── TodoList（列表展示 + 删除 + 切换完成状态）
└── TodoStats（统计 + 清除已完成任务）
</code></pre>
<p>核心数据 todos 数组只在 App 组件中用 useState 管理。三个子组件都不直接持有或修改 todos，而是通过 props 接收数据和修改方法。</p>
<p>这就是 React 官方推荐的<strong>状态提升（Lifting State Up）</strong> ：把多个组件需要共享的状态提升到它们最近的共同父组件中统一管理。</p>
<p>这样做的好处：</p>
<ul>
<li>数据有单一真相来源（single source of truth）</li>
<li>避免数据不同步的 bug</li>
<li>逻辑集中，容易维护</li>
</ul>
<h4 data-id="heading-2">一、父组件 → 子组件：单向数据流与 Props 传递</h4>
<p>React 的核心原则是<strong>单向数据流</strong>：数据只能从父组件通过 props 向下传递，子组件不能直接修改父组件的数据。</p>
<p>在 App.jsx 中，我们把 todos 数据、统计数字、各种操作函数都通过 props 传给了子组件：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// App.jsx 关键片段</span>
&lt;<span class="hljs-title class_">TodoInput</span> onAdd={addTodo} /&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span>
  <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span>
  <span class="hljs-attr">onDelete</span>=<span class="hljs-string">{deleteTodo}</span>
  <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{toggleTodo}</span>
/&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TodoStats</span>
  <span class="hljs-attr">total</span>=<span class="hljs-string">{todos.length}</span>
  <span class="hljs-attr">active</span>=<span class="hljs-string">{activeCount}</span>
  <span class="hljs-attr">completed</span>=<span class="hljs-string">{completedCount}</span>
  <span class="hljs-attr">onClearCompleted</span>=<span class="hljs-string">{onClearCompleted}</span>
/&gt;</span></span>
</code></pre>
<p>子组件只需要接收 props，使用即可，完全不需要关心数据是怎么来的、怎么改的。</p>
<p>关于父传子的单项数据可以看我上一篇文章<a href="https://juejin.cn/post/7586569284550934568" target="_blank" title="https://juejin.cn/post/7586569284550934568"># React 学习：父传子的单项数据流——props</a></p>
<h4 data-id="heading-3">二、子组件 → 父组件：回调函数上报事件（深度详解）</h4>
<p>子组件如何影响父组件的状态？这正是 React 组件通信中最核心、最容易混淆的部分。</p>
<p><strong>很多人误以为“子传父”是子组件把数据直接塞给父组件，其实完全不是！</strong></p>
<p>React 中“子传父”的正确姿势是：<strong>父组件提前定义好一个回调函数，通过 props 传给子组件；子组件在合适时机调用这个函数，把必要的信息“上报”给父组件，由父组件决定如何更新自己的状态。</strong></p>
<p>这套机制在我们的三个子组件中都有体现，下面结合代码<strong>一步一步彻底拆解</strong>它的实现原理。</p>
<h5 data-id="heading-4">子传父的完整四步流程</h5>
<ol>
<li><strong>父组件定义回调函数</strong>（负责真正修改状态）</li>
<li><strong>父组件通过 props 把回调函数传给子组件</strong></li>
<li><strong>子组件接收回调，并在事件触发时调用它（上报数据或事件）</strong></li>
<li><strong>回调执行 → 父组件状态更新 → 触发重新渲染 → 新数据通过 props 再次向下传递</strong></li>
</ol>
<p>下面以“添加新 Todo”为例，逐行代码演示这个闭环。</p>
<h5 data-id="heading-5">示例 1：TodoInput 添加新事项（子传父经典案例）</h5>
<p><strong>步骤 1：父组件定义回调函数 addTodo</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// App.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
  <span class="hljs-title function_">setTodos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, {
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
    text,
    <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>
  }]);
};
</code></pre>
<p>这个函数接收一个 text 参数，负责把新事项添加到状态中。</p>
<p><strong>步骤 2：父组件通过 props 传递回调</strong></p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">TodoInput</span> onAdd={addTodo} /&gt;  <span class="hljs-comment">// 注意：传的是函数本身，不是调用</span>
</code></pre>
<p><strong>步骤 3：子组件接收并在提交时调用</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// TodoInput.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoInput</span> = (<span class="hljs-params">{ onAdd }</span>) =&gt; {  <span class="hljs-comment">// 解构接收</span>
  <span class="hljs-keyword">const</span> [inputValue, setInputValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">const</span> text = inputValue.<span class="hljs-title function_">trim</span>();
    <span class="hljs-keyword">if</span> (!text) <span class="hljs-keyword">return</span>;

    <span class="hljs-title function_">onAdd</span>(text);          <span class="hljs-comment">// ← 关键！上报用户输入的文本</span>
    <span class="hljs-title function_">setInputValue</span>(<span class="hljs-string">""</span>);    <span class="hljs-comment">// 清空输入框</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{inputValue}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setInputValue(e.target.value)}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Add<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
};
</code></pre>
<p><strong>步骤 4：闭环完成</strong></p>
<ul>
<li>用户输入并提交 → onAdd(text) 被调用 → 执行父组件的 addTodo</li>
<li>setTodos 更新状态 → App 重新渲染 → 新 todos 通过 props 传给 TodoList → 列表自动显示新项</li>
</ul>
<h5 data-id="heading-6">示例2. TodoList：删除和切换完成状态</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// TodoList.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoList</span> = (<span class="hljs-params">{ todos, onDelete, onToggle }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-list"</span>&gt;</span>
      {todos.length === 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"empty"</span>&gt;</span>No todos yet!<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ) : (
        todos.map((todo) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>
            <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{todo.completed</span> ? "<span class="hljs-attr">completed</span>" <span class="hljs-attr">:</span> ""}
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
                <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
                <span class="hljs-attr">checked</span>=<span class="hljs-string">{todo.completed}</span>
                <span class="hljs-attr">onChange</span>=<span class="hljs-string">{()</span> =&gt;</span> onToggle(todo.id)}   // 上报 id
              /&gt;
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{todo.text}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">"delete-btn"</span>
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onDelete(todo.id)}      // 上报 id
            &gt;
              ×
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoList</span>;
</code></pre>
<p>关键点：</p>
<ul>
<li>复选框也是受控组件：checked 值来自 props 中的 todo.completed</li>
<li>点击复选框或删除按钮时，分别调用 onToggle(todo.id) 和 onDelete(todo.id)，把当前事项的 id 上报给父组件</li>
<li>父组件根据 id 找到对应项并更新状态</li>
</ul>
<p>父组件中的实现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
  <span class="hljs-title function_">setTodos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> !== id));
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
  <span class="hljs-title function_">setTodos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span>
    todo.<span class="hljs-property">id</span> === id 
      ? { ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> }
      : todo
  ));
};
</code></pre>
<h5 data-id="heading-7">示例3. TodoStats：清除已完成事项</h5>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// TodoStats.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoStats</span> = (<span class="hljs-params">{ total, active, completed, onClearCompleted }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-stats"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
        Total: {total} | Active: {active} | Completed: {completed}
      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {completed &gt; 0 &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClearCompleted}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"clear-btn"</span>&gt;</span>
          Clear Completed
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoStats</span>;
</code></pre>
<p>关键点：</p>
<ul>
<li>统计数字由父组件提前计算好传下来，避免子组件重复计算</li>
<li>点击清除按钮时调用 onClearCompleted() 上报事件</li>
</ul>
<p>父组件实现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">onClearCompleted</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setTodos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> !todo.<span class="hljs-property">completed</span>));
};
</code></pre>
<h5 data-id="heading-8">子传父的核心本质总结</h5>
<ul>
<li><strong>不是子组件“给”父组件数据</strong>，而是子组件“通知”父组件：“嘿，发生了一件事（用户点了添加/删除/切换），需要的参数我给你，你自己看着办。”</li>
<li><strong>所有状态修改权永远掌握在父组件手里</strong>，子组件只有“上报权”。</li>
<li>这种“事件向上冒泡、数据向下流动”的模式，正是 React 单向数据流的完美体现。</li>
</ul>
<p>掌握了这个机制，你就真正理解了为什么 React 说“数据流是单向的”，却依然能轻松实现复杂的交互。</p>
<h5 data-id="heading-9">完整子组件代码（带详细注释）</h5>
<p><strong>TodoInput.jsx</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoInput</span> = (<span class="hljs-params">{ onAdd }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [inputValue, setInputValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">const</span> text = inputValue.<span class="hljs-title function_">trim</span>();
    <span class="hljs-keyword">if</span> (!text) <span class="hljs-keyword">return</span>;

    <span class="hljs-title function_">onAdd</span>(text);          <span class="hljs-comment">// 子 → 父：上报新事项文本</span>
    <span class="hljs-title function_">setInputValue</span>(<span class="hljs-string">""</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-input"</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{inputValue}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setInputValue(e.target.value)}
        placeholder="输入事项后按回车或点击添加"
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Add<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoInput</span>;
</code></pre>
<p><strong>TodoList.jsx</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoList</span> = (<span class="hljs-params">{ todos, onDelete, onToggle }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-list"</span>&gt;</span>
      {todos.length === 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"empty"</span>&gt;</span>No todos yet! 快去添加一个吧～<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ) : (
        todos.map((todo) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{todo.completed</span> ? "<span class="hljs-attr">completed</span>" <span class="hljs-attr">:</span> ""}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
                <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
                <span class="hljs-attr">checked</span>=<span class="hljs-string">{todo.completed}</span>
                <span class="hljs-attr">onChange</span>=<span class="hljs-string">{()</span> =&gt;</span> onToggle(todo.id)}   // 子 → 父：上报要切换的 id
              /&gt;
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{todo.text}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">"delete-btn"</span>
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onDelete(todo.id)}      // 子 → 父：上报要删除的 id
            &gt;
              ×
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoList</span>;
</code></pre>
<p><strong>TodoStats.jsx</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoStats</span> = (<span class="hljs-params">{ total, active, completed, onClearCompleted }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-stats"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Total: {total} | Active: {active} | Completed: {completed}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {completed &gt; 0 &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClearCompleted}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"clear-btn"</span>&gt;</span>
          Clear Completed
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoStats</span>;
</code></pre>
<h4 data-id="heading-10">三、为什么 onChange={() =&gt; onToggle(todo.id)} 必须包箭头函数？</h4>
<p>这是初学者最容易踩的坑之一，我们详细拆解。</p>
<h5 data-id="heading-11">错误写法 1：直接调用</h5>
<pre><code class="hljs language-jsx" lang="jsx">onChange={<span class="hljs-title function_">onToggle</span>(todo.<span class="hljs-property">id</span>)}  <span class="hljs-comment">// 灾难性错误！</span>
</code></pre>
<p>渲染时就会立即执行 onToggle(todo.id)，导致：</p>
<ul>
<li>页面加载瞬间所有任务状态翻转</li>
<li>可能引发无限渲染循环</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1662110ec500425f8b9b7f5bb1c9055b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166379&amp;x-signature=9abBwtJi3lT8haHtuIrg4I8ZuUU%3D" alt="SnowShot_Video_2025-12-24_14-57-17.gif" loading="lazy"/></p>
<h5 data-id="heading-12">错误写法 2：只传函数不传参</h5>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">onChange</span>={<span class="hljs-literal">on</span>Toggle}
</code></pre>
<p>React 会把 event 对象传给 onToggle，但我们需要的是 id，导致切换失败。</p>
<h5 data-id="heading-13">正确写法：箭头函数包裹</h5>
<pre><code class="hljs language-jsx" lang="jsx">onChange={<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onToggle</span>(todo.<span class="hljs-property">id</span>)}
</code></pre>
<p>只有用户真正点击时才执行，并正确传递 id。</p>
<h4 data-id="heading-14">四、完整 App 组件：数据管理中心</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./styles/app.styl"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/TodoList"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/TodoInput"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoStats</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./components/TodoStats"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 子组件共享的数据状态</span>
  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 高级用法</span>
    <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">"todos"</span>);
    <span class="hljs-keyword">return</span> saved ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved) : [];
  });
  <span class="hljs-comment">// 子组件修改数据的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>([
      ...todos,
      {
        <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-comment">// 时间戳</span>
        text,
        <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>,
      },
    ]);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> todo.<span class="hljs-property">id</span> !== id));
  };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(
      todos.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span>
        todo.<span class="hljs-property">id</span> === id
          ? {
              ...todo,
              <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span>,
            }
          : todo
      )
    );
  };

  <span class="hljs-keyword">const</span> activeCount = todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> !todo.<span class="hljs-property">completed</span>).<span class="hljs-property">length</span>;
  <span class="hljs-keyword">const</span> completedCount = todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> todo.<span class="hljs-property">completed</span>).<span class="hljs-property">length</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onClearCompleted</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> !todo.<span class="hljs-property">completed</span>));
  };

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">"todos"</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos));
  }, [todos]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>My Todo List<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {/* 自定义事件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">onAdd</span>=<span class="hljs-string">{addTodo}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span> <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span> <span class="hljs-attr">onDelete</span>=<span class="hljs-string">{deleteTodo}</span> <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{toggleTodo}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoStats</span>
        <span class="hljs-attr">total</span>=<span class="hljs-string">{todos.length}</span>
        <span class="hljs-attr">active</span>=<span class="hljs-string">{activeCount}</span>
        <span class="hljs-attr">completed</span>=<span class="hljs-string">{completedCount}</span>
        <span class="hljs-attr">onClearCompleted</span>=<span class="hljs-string">{onClearCompleted}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;

</code></pre>
<h4 data-id="heading-15">五、最终效果展示：</h4>
<h5 data-id="heading-16"><code>初始状态</code></h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67aad8670f9e4fa6971ce2bcddf8a2da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166379&amp;x-signature=Cy8ZqdqWhLrrSEoFeDhY9Y%2FKiaY%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-17"><code>添加示例</code></h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ab59ae515ec4d3aba09ef9bc02674cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166379&amp;x-signature=ysmQj755jZVBZ37kJB5VYt6wNBc%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-18"><code>勾选完成</code></h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08010bbbbefe4c86a10aa22b0a1a1fa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166379&amp;x-signature=qaLxVQ1fvpUodhEXGD5rWhcrKVE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-19">六、总结：掌握这套模式，就掌握了 90% 的组件通信</h4>
<p>通过这个 Todo List，我们完整实践了：</p>
<ol>
<li>父传子：props 单向传递</li>
<li>子传父：回调函数上报事件（深度掌握）</li>
<li>兄弟通信：状态提升</li>
<li>常见坑避免：事件处理正确写法</li>
</ol>
<p>这套模式简单、可靠、可预测，是 React 项目的基石。</p>
<p>当项目更大时，再学习 Context 或状态管理库。但请记住：<strong>万丈高楼平地起，先把这套基础打牢</strong>。</p>
<p>希望这篇文章能帮你彻底弄懂 React 组件通信的本质。下次写代码时，遇到数据流动问题，先问自己：“这个状态该谁管？回调要不要传参？箭头函数包好了吗？”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code 的 Agent Skills 是什么？如何使用？]]></title>    <link>https://juejin.cn/post/7587284708943544354</link>    <guid>https://juejin.cn/post/7587284708943544354</guid>    <pubDate>2025-12-24T07:32:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587284708943544354" data-draft-id="7587243886432829474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code 的 Agent Skills 是什么？如何使用？"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2025-12-24T07:32:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="micefind"/> <meta itemprop="url" content="https://juejin.cn/user/3927901240298430"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code 的 Agent Skills 是什么？如何使用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927901240298430/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    micefind
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:32:37.000Z" title="Wed Dec 24 2025 07:32:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Claude Code 的 Agent Skills 使用指南</h2>
<h3 data-id="heading-1">什么是 Agent Skills？</h3>
<p>Agent Skills 是 Claude API 中的工具调用（Tool Use）机制，允许 Claude 自主决策并调用外部函数完成任务。核心特性：</p>
<ul>
<li><strong>自主决策</strong> - Claude 判断是否需要调用工具及调用参数</li>
<li><strong>循环执行</strong> - 支持多轮工具调用，逐步完成复杂任务</li>
<li><strong>结构化通信</strong> - 基于 JSON Schema 定义工具接口规范</li>
</ul>
<hr/>
<h3 data-id="heading-2">核心实现流程</h3>
<h4 data-id="heading-3">1. <strong>定义工具（Tool Definition）</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> anthropic

tools = [
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"execute_python"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行 Python 代码并返回输出结果。用于数据处理、计算、文件操作等。"</span>,
        <span class="hljs-string">"input_schema"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
            <span class="hljs-string">"properties"</span>: {
                <span class="hljs-string">"code"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                    <span class="hljs-string">"description"</span>: <span class="hljs-string">"要执行的 Python 代码片段（不包含输入提示）"</span>
                }
            },
            <span class="hljs-string">"required"</span>: [<span class="hljs-string">"code"</span>]
        }
    },
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"read_file"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"读取指定路径的文件内容。支持文本和二进制文件。"</span>,
        <span class="hljs-string">"input_schema"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
            <span class="hljs-string">"properties"</span>: {
                <span class="hljs-string">"path"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                    <span class="hljs-string">"description"</span>: <span class="hljs-string">"文件的绝对或相对路径"</span>
                },
                <span class="hljs-string">"encoding"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                    <span class="hljs-string">"description"</span>: <span class="hljs-string">"文件编码方式，默认 utf-8"</span>,
                    <span class="hljs-string">"default"</span>: <span class="hljs-string">"utf-8"</span>
                }
            },
            <span class="hljs-string">"required"</span>: [<span class="hljs-string">"path"</span>]
        }
    }
]
</code></pre>
<h4 data-id="heading-4">2. <strong>初始化 Agent 请求</strong></h4>
<pre><code class="hljs language-python" lang="python">client = anthropic.Anthropic(api_key=<span class="hljs-string">"your-api-key"</span>)

response = client.messages.create(
    model=<span class="hljs-string">"claude-3-5-sonnet-20241022"</span>,
    max_tokens=<span class="hljs-number">4096</span>,
    tools=tools,
    messages=[
        {
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"content"</span>: <span class="hljs-string">"读取 data.csv 文件，计算销售总额和平均值"</span>
        }
    ]
)
</code></pre>
<h4 data-id="heading-5">3. <strong>循环处理工具调用</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_tool</span>(<span class="hljs-params">tool_name: <span class="hljs-built_in">str</span>, tool_input: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""执行工具并返回结果"""</span>
    <span class="hljs-keyword">if</span> tool_name == <span class="hljs-string">"execute_python"</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 安全执行：使用 subprocess 隔离环境</span>
            result = subprocess.run(
                [<span class="hljs-string">"python"</span>, <span class="hljs-string">"-c"</span>, tool_input[<span class="hljs-string">"code"</span>]],
                capture_output=<span class="hljs-literal">True</span>,
                text=<span class="hljs-literal">True</span>,
                timeout=<span class="hljs-number">30</span>
            )
            <span class="hljs-keyword">return</span> result.stdout <span class="hljs-keyword">or</span> result.stderr
        <span class="hljs-keyword">except</span> subprocess.TimeoutExpired:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"错误: 代码执行超时（超过30秒）"</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
  
    <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">"read_file"</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(
                tool_input[<span class="hljs-string">"path"</span>],
                <span class="hljs-string">"r"</span>,
                encoding=tool_input.get(<span class="hljs-string">"encoding"</span>, <span class="hljs-string">"utf-8"</span>)
            ) <span class="hljs-keyword">as</span> f:
                <span class="hljs-keyword">return</span> f.read()
        <span class="hljs-keyword">except</span> FileNotFoundError:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"错误: 文件不存在 - <span class="hljs-subst">{tool_input[<span class="hljs-string">'path'</span>]}</span>"</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>

<span class="hljs-comment"># 持续循环直到 Agent 完成任务</span>
messages = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"读取 data.csv 文件，计算销售总额和平均值"</span>}
]

<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    response = client.messages.create(
        model=<span class="hljs-string">"claude-3-5-sonnet-20241022"</span>,
        max_tokens=<span class="hljs-number">4096</span>,
        tools=tools,
        messages=messages
    )
  
    <span class="hljs-comment"># 检查是否有工具调用</span>
    <span class="hljs-keyword">if</span> response.stop_reason == <span class="hljs-string">"tool_use"</span>:
        <span class="hljs-comment"># 找到工具调用块</span>
        assistant_message = {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response.content}
        messages.append(assistant_message)
      
        <span class="hljs-comment"># 处理所有工具调用</span>
        tool_results = []
        <span class="hljs-keyword">for</span> content_block <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">if</span> content_block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                tool_result = execute_tool(
                    content_block.name,
                    content_block.<span class="hljs-built_in">input</span>
                )
                tool_results.append({
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"tool_result"</span>,
                    <span class="hljs-string">"tool_use_id"</span>: content_block.<span class="hljs-built_in">id</span>,
                    <span class="hljs-string">"content"</span>: tool_result
                })
      
        <span class="hljs-comment"># 反馈工具结果</span>
        messages.append({
            <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
            <span class="hljs-string">"content"</span>: tool_results
        })
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># Agent 已完成（stop_reason == "end_turn"）</span>
        <span class="hljs-keyword">break</span>

<span class="hljs-comment"># 提取最终文本响应</span>
final_response = <span class="hljs-built_in">next</span>(
    (b.text <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> response.content <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(b, <span class="hljs-string">"text"</span>)),
    <span class="hljs-literal">None</span>
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Agent 响应:"</span>, final_response)
</code></pre>
<hr/>
<h3 data-id="heading-6">实战案例：完整的数据分析 Agent</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> anthropic
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataAnalysisAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.client = anthropic.Anthropic()
        self.tools = self._define_tools()
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_define_tools</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> [
            {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"execute_python"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行 Python 代码进行数据处理和分析"</span>,
                <span class="hljs-string">"input_schema"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                    <span class="hljs-string">"properties"</span>: {
                        <span class="hljs-string">"code"</span>: {
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                            <span class="hljs-string">"description"</span>: <span class="hljs-string">"Python 代码（可导入 pandas, numpy, matplotlib）"</span>
                        }
                    },
                    <span class="hljs-string">"required"</span>: [<span class="hljs-string">"code"</span>]
                }
            },
            {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"read_file"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"读取文件内容"</span>,
                <span class="hljs-string">"input_schema"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                    <span class="hljs-string">"properties"</span>: {
                        <span class="hljs-string">"path"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"文件路径"</span>}
                    },
                    <span class="hljs-string">"required"</span>: [<span class="hljs-string">"path"</span>]
                }
            },
            {
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"list_files"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"列出目录中的文件"</span>,
                <span class="hljs-string">"input_schema"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                    <span class="hljs-string">"properties"</span>: {
                        <span class="hljs-string">"directory"</span>: {
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                            <span class="hljs-string">"description"</span>: <span class="hljs-string">"目录路径，默认当前目录"</span>,
                            <span class="hljs-string">"default"</span>: <span class="hljs-string">"."</span>
                        }
                    }
                }
            }
        ]
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_execute_tool</span>(<span class="hljs-params">self, tool_name: <span class="hljs-built_in">str</span>, tool_input: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行工具"""</span>
        <span class="hljs-keyword">if</span> tool_name == <span class="hljs-string">"execute_python"</span>:
            <span class="hljs-comment"># 预配置 imports</span>
            code = <span class="hljs-string">f"""
import pandas as pd
import numpy as np
import json

<span class="hljs-subst">{tool_input[<span class="hljs-string">'code'</span>]}</span>
"""</span>
            <span class="hljs-keyword">try</span>:
                result = subprocess.run(
                    [<span class="hljs-string">"python"</span>, <span class="hljs-string">"-c"</span>, code],
                    capture_output=<span class="hljs-literal">True</span>,
                    text=<span class="hljs-literal">True</span>,
                    timeout=<span class="hljs-number">30</span>,
                    cwd=os.getcwd()
                )
                <span class="hljs-keyword">if</span> result.returncode != <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-string">f"执行错误:\n<span class="hljs-subst">{result.stderr}</span>"</span>
                <span class="hljs-keyword">return</span> result.stdout <span class="hljs-keyword">or</span> <span class="hljs-string">"（无输出）"</span>
            <span class="hljs-keyword">except</span> subprocess.TimeoutExpired:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"错误: 执行超时"</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
      
        <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">"read_file"</span>:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(tool_input[<span class="hljs-string">"path"</span>], <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
                    content = f.read()
                    <span class="hljs-comment"># 限制输出长度</span>
                    <span class="hljs-keyword">return</span> content[:<span class="hljs-number">5000</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(content) &gt; <span class="hljs-number">5000</span> <span class="hljs-keyword">else</span> content
            <span class="hljs-keyword">except</span> FileNotFoundError:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"文件不存在: <span class="hljs-subst">{tool_input[<span class="hljs-string">'path'</span>]}</span>"</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"读取错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
      
        <span class="hljs-keyword">elif</span> tool_name == <span class="hljs-string">"list_files"</span>:
            <span class="hljs-keyword">try</span>:
                directory = tool_input.get(<span class="hljs-string">"directory"</span>, <span class="hljs-string">"."</span>)
                files = os.listdir(directory)
                <span class="hljs-keyword">return</span> json.dumps(files, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"列表错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
      
        <span class="hljs-keyword">return</span> <span class="hljs-string">"未知工具"</span>
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, user_task: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""运行 Agent"""</span>
        messages = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_task}]
      
        iteration = <span class="hljs-number">0</span>
        max_iterations = <span class="hljs-number">10</span>
      
        <span class="hljs-keyword">while</span> iteration &lt; max_iterations:
            iteration += <span class="hljs-number">1</span>
          
            response = self.client.messages.create(
                model=<span class="hljs-string">"claude-3-5-sonnet-20241022"</span>,
                max_tokens=<span class="hljs-number">4096</span>,
                tools=self.tools,
                messages=messages
            )
          
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- 迭代 <span class="hljs-subst">{iteration}</span> ---"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"停止原因: <span class="hljs-subst">{response.stop_reason}</span>"</span>)
          
            <span class="hljs-keyword">if</span> response.stop_reason == <span class="hljs-string">"end_turn"</span>:
                <span class="hljs-comment"># Agent 完成</span>
                final_text = <span class="hljs-built_in">next</span>(
                    (b.text <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> response.content <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(b, <span class="hljs-string">"text"</span>)),
                    <span class="hljs-literal">None</span>
                )
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n✓ Agent 完成响应:\n<span class="hljs-subst">{final_text}</span>"</span>)
                <span class="hljs-keyword">return</span> final_text
          
            <span class="hljs-keyword">elif</span> response.stop_reason == <span class="hljs-string">"tool_use"</span>:
                <span class="hljs-comment"># 添加 Assistant 消息</span>
                messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response.content})
              
                <span class="hljs-comment"># 执行所有工具调用</span>
                tool_results = []
                <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content:
                    <span class="hljs-keyword">if</span> block.<span class="hljs-built_in">type</span> == <span class="hljs-string">"tool_use"</span>:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  → 调用工具: <span class="hljs-subst">{block.name}</span>"</span>)
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    参数: <span class="hljs-subst">{json.dumps(block.<span class="hljs-built_in">input</span>, ensure_ascii=<span class="hljs-literal">False</span>)}</span>"</span>)
                      
                        result = self._execute_tool(block.name, block.<span class="hljs-built_in">input</span>)
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    结果: <span class="hljs-subst">{result[:<span class="hljs-number">200</span>]}</span>..."</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result) &gt; <span class="hljs-number">200</span> <span class="hljs-keyword">else</span> <span class="hljs-string">f"    结果: <span class="hljs-subst">{result}</span>"</span>)
                      
                        tool_results.append({
                            <span class="hljs-string">"type"</span>: <span class="hljs-string">"tool_result"</span>,
                            <span class="hljs-string">"tool_use_id"</span>: block.<span class="hljs-built_in">id</span>,
                            <span class="hljs-string">"content"</span>: result
                        })
              
                messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: tool_results})
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"意外的停止原因: <span class="hljs-subst">{response.stop_reason}</span>"</span>)
                <span class="hljs-keyword">break</span>
      
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n✗ 超过最大迭代次数 (<span class="hljs-subst">{max_iterations}</span>)"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    agent = DataAnalysisAgent()
  
    task = <span class="hljs-string">"""
    1. 列出当前目录的文件
    2. 如果存在 sales.csv，读取前10行
    3. 计算该文件中销售额的总和、平均值和最大值
    4. 生成一份简要报告
    """</span>
  
    agent.run(task)
</code></pre>
<hr/>
<h3 data-id="heading-7">工具定义最佳实践</h3>



































<table><thead><tr><th>维度</th><th>最佳实践</th><th>反面示例</th></tr></thead><tbody><tr><td><strong>描述清晰度</strong></td><td>"执行 Python 代码进行数据处理"</td><td>"运行代码"</td></tr><tr><td><strong>参数验证</strong></td><td>使用<code>required</code> 数组明确必填项</td><td>依赖可选参数</td></tr><tr><td><strong>输出限制</strong></td><td>返回不超过 10000 字符的结果</td><td>返回大型数据集</td></tr><tr><td><strong>错误处理</strong></td><td>返回结构化错误信息</td><td>不处理异常</td></tr><tr><td><strong>命名规范</strong></td><td>snake_case（execute_python）</td><td>混合大小写</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">关键注意事项</h3>
<h4 data-id="heading-9">安全隔离</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ✓ 推荐：使用 subprocess 隔离执行环境</span>
subprocess.run(
    [<span class="hljs-string">"python"</span>, <span class="hljs-string">"-c"</span>, code],
    capture_output=<span class="hljs-literal">True</span>,
    timeout=<span class="hljs-number">30</span>
)

<span class="hljs-comment"># ✗ 避免：直接 exec/eval</span>
<span class="hljs-built_in">exec</span>(code)  <span class="hljs-comment"># 危险！</span>
</code></pre>
<h4 data-id="heading-10">成本控制</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 限制单次请求的 token 数</span>
response = client.messages.create(
    model=<span class="hljs-string">"claude-3-5-sonnet-20241022"</span>,
    max_tokens=<span class="hljs-number">2048</span>,  <span class="hljs-comment"># 设置合理上限</span>
    tools=tools,
    messages=messages
)

<span class="hljs-comment"># 限制迭代次数</span>
<span class="hljs-keyword">for</span> iteration <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):  <span class="hljs-comment"># 最多10轮</span>
    <span class="hljs-keyword">if</span> response.stop_reason == <span class="hljs-string">"end_turn"</span>:
        <span class="hljs-keyword">break</span>
</code></pre>
<h4 data-id="heading-11">结果验证</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 验证工具结果的有效性</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tool_result) &gt; <span class="hljs-number">50000</span>:
    tool_result = tool_result[:<span class="hljs-number">50000</span>] + <span class="hljs-string">"\n[输出已截断]"</span>

<span class="hljs-comment"># 捕获所有异常</span>
<span class="hljs-keyword">try</span>:
    result = execute_tool(tool_name, tool_input)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    result = <span class="hljs-string">f"工具执行失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
</code></pre>
<hr/>
<p>Agent Skills 的核心在于<strong>明确的工具定义</strong> + <strong>完善的错误处理</strong> + <strong>高效的循环管理</strong>。遵循上述模式可快速构建可靠的自动化工作流。</p>
<blockquote>
<p>博主的个人网站接入了claude haiku 4.5模型，欢迎访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmicefind.com" target="_blank" title="https://micefind.com" ref="nofollow noopener noreferrer">micefind.com</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[正则表达式应用-手机号打码]]></title>    <link>https://juejin.cn/post/7587238733503119403</link>    <guid>https://juejin.cn/post/7587238733503119403</guid>    <pubDate>2025-12-24T07:39:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587238733503119403" data-draft-id="7587046913692106758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="正则表达式应用-手机号打码"/> <meta itemprop="keywords" content="Scala"/> <meta itemprop="datePublished" content="2025-12-24T07:39:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="豚踢兔x"/> <meta itemprop="url" content="https://juejin.cn/user/1461712635573371"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            正则表达式应用-手机号打码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1461712635573371/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    豚踢兔x
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:39:03.000Z" title="Wed Dec 24 2025 07:39:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. matchces函数的使用方法</h2>
<p><strong>（一）matchs方法</strong>
正则表达式对象有matches方法，它的作用是验证给定的字符串是否满足正则表达式的要求。它的格式如下：</p>
<p>val 结果 = 正则.matches(目标字符串)
其中的结果是一个bool值。</p>
<h4 data-id="heading-1"><strong>【例】</strong>：</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> scala.util.matching.<span class="hljs-type">Regex</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">RegexDemo</span> </span>{

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]) {

        <span class="hljs-keyword">val</span> reg1 = <span class="hljs-string">"\\d{3}"</span>.r

        println(reg1.matches(<span class="hljs-string">"123"</span>)) <span class="hljs-comment">// true</span>

        println(reg1.matches(<span class="hljs-string">"12a"</span>)) <span class="hljs-comment">// false</span>

    }

}
</code></pre>
<h2 data-id="heading-2">2. replaceAllIn的使用方法</h2>
<p><strong>（三）replaceAllin正则替换</strong></p>
<p><strong>功能</strong>：对目标字符中的内容，进行正则查找，对找到的内容使用指定的内容进行替换，并返回替换之后的字符串。</p>
<p><strong>格式</strong>：正则.replaceAll(目标字符串, 匹配到的内容 =&gt; 要替换的内容 )</p>
<p><strong>【示例】</strong>：把目标字符串中的字符BC换成01。</p>
<p>("bc".r).replaceAll("abcdabcd" =&gt; m =&gt; "01" )</p>
<h4 data-id="heading-3"><strong>案例-手机号打码</strong></h4>
<p><strong>用到的方法是：正则匹配分组 + replaceAllIn。</strong></p>
<p><strong>案例文件如下</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7d804bee49407690b20bbe818343a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LGa6Lii5YWUeA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767168041&amp;x-signature=FFyx8P3r%2B9oFN95w8N%2BWLPCCh4o%3D" alt="屏幕截图 2025-12-24 151523.png" loading="lazy"/></p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> reg

<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">FileWriter</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">reg04</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1.从根目录下读出address,txt 的内容</span>
    <span class="hljs-keyword">val</span> content = scala.io.<span class="hljs-type">Source</span>.fromFile(<span class="hljs-string">"address.txt"</span>).mkString

    println(<span class="hljs-string">"读到的文件内容如下："</span>)
    println(content)
    <span class="hljs-comment">// 2. 找到其中的合法手机号，把中间4位（3-4-4）用*代替</span>
    <span class="hljs-keyword">val</span> reg = <span class="hljs-string">"1[031902]\d{9}"</span>.r

<span class="hljs-comment">//    println("找到的合法手机号如下：")</span>
<span class="hljs-comment">//    reg.findAllIn(content).foreach(ele=&gt;println(ele))</span>

    <span class="hljs-comment">// 在content中，把所有通过正则找到的内容，换成"abc"</span>
<span class="hljs-comment">//    reg.replaceAllIn(content, ele =&gt; "abc")</span>
    <span class="hljs-keyword">val</span> newContent = reg.replaceAllIn(content,ele =&gt;{
      <span class="hljs-keyword">val</span> phone = ele.toString()
      println(ele)
      <span class="hljs-string">"abc"</span>
<span class="hljs-comment">//      "手机号前3位" +"****"+ "手机号后四位"</span>
      phone.substring(<span class="hljs-number">0</span> ,<span class="hljs-number">3</span>) + <span class="hljs-string">"****"</span> + phone.substring(<span class="hljs-number">7</span>)
    })
    println(<span class="hljs-string">"替换后的内容如下："</span>)
    println(newContent)

    <span class="hljs-comment">// 3.把结果写入到address_new.txt文件中</span>
    <span class="hljs-keyword">val</span> fileWriter = <span class="hljs-keyword">new</span> <span class="hljs-type">FileWriter</span>(<span class="hljs-string">"address_new.txt"</span>)
    fileWriter.write(newContent)
    fileWriter.close()
  }

}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97291b69ab3e4dee9b977c2b166f32d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LGa6Lii5YWUeA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767168041&amp;x-signature=8t385NMzQEitPe3qc333vW%2Bs%2Fes%3D" alt="屏幕截图 2025-12-24 152743.png" loading="lazy"/></p>
<h5 data-id="heading-4"><strong>以下为添加了group版：</strong></h5>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> reg

<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">FileWriter</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">reg06</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1.从根目录下读出address,txt 的内容</span>
    <span class="hljs-keyword">val</span> content = scala.io.<span class="hljs-type">Source</span>.fromFile(<span class="hljs-string">"address.txt"</span>).mkString

    println(<span class="hljs-string">"读到的文件内容如下："</span>)
    println(content)
    <span class="hljs-comment">// 2. 找到其中的合法手机号，把中间4位（3-4-4）用*代替</span>
    <span class="hljs-keyword">val</span> reg = <span class="hljs-string">"(1[031902]\d\d)(\d{4})(\d{3})"</span>.r

<span class="hljs-comment">//    println("找到的合法手机号如下：")</span>
<span class="hljs-comment">//    reg.findAllIn(content).foreach(ele=&gt;println(ele))</span>

    <span class="hljs-comment">// 在content中，把所有通过正则找到的内容，换成"abc"</span>
<span class="hljs-comment">//    reg.replaceAllIn(content, ele =&gt; "abc")</span>
    <span class="hljs-keyword">val</span> newContent = reg.replaceAllIn(content,ele =&gt;{
      println(ele.group(<span class="hljs-number">0</span>))
      println(ele.group(<span class="hljs-number">1</span>))
      println(ele.group(<span class="hljs-number">2</span>))
      println(ele.group(<span class="hljs-number">3</span>))

<span class="hljs-comment">//      val phone = ele.toString()</span>
<span class="hljs-comment">//      println(ele)</span>
<span class="hljs-comment">//      "abc"</span>
<span class="hljs-comment">//      "手机号前3位" +"****"+ "手机号后四位"</span>
<span class="hljs-comment">//      phone.substring(0 ,3) + "****" + phone.substring(7)</span>
      ele.group(<span class="hljs-number">1</span>) + <span class="hljs-string">"-****-"</span> + ele.group(<span class="hljs-number">3</span>)
    })
    println(<span class="hljs-string">"替换后的内容如下："</span>)
    println(newContent)

    <span class="hljs-comment">// 3.把结果写入到address_new.txt文件中</span>
    <span class="hljs-keyword">val</span> fileWriter = <span class="hljs-keyword">new</span> <span class="hljs-type">FileWriter</span>(<span class="hljs-string">"address_new.txt"</span>)
    fileWriter.write(newContent)
    fileWriter.close()
  }
}
</code></pre>
<h6 data-id="heading-5">注：</h6>
<p><strong>（）：是分组</strong></p>
<p><strong>println(ele.group(0/1/2/3...))固定表示匹配到的全部内容</strong></p>
<p><strong>括号里的数字（1,2,3）顺序对应着正则表达式中，（）包含的内容</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02452c3029ee4b0fbc28cd8d9a1980e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LGa6Lii5YWUeA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767168041&amp;x-signature=ip4s2P4E%2Bq35H7xgtEDTeDMjX9g%3D" alt="屏幕截图 2025-12-24 155407.png" loading="lazy"/></p>
<p><strong>这里的group是分组的意思，它与正则表达式中的()是一一对应的。</strong></p>
<h2 data-id="heading-6">3. 正则表达式的应用</h2>
<h5 data-id="heading-7"><strong>以下是把文件中的内容换成‘abc’</strong>：</h5>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> reg

<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">FileWriter</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">reg05</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1.从根目录下读出address,txt 的内容</span>
    <span class="hljs-keyword">val</span> content = scala.io.<span class="hljs-type">Source</span>.fromFile(<span class="hljs-string">"address.txt"</span>).mkString

    println(<span class="hljs-string">"读到的文件内容如下："</span>)
    println(content)
    <span class="hljs-comment">// 2. 找到其中的合法手机号，把中间4位（3-4-4）用*代替</span>
    <span class="hljs-keyword">val</span> reg = <span class="hljs-string">"1[031902]\d{9}"</span>.r

<span class="hljs-comment">//    println("找到的合法手机号如下：")</span>
<span class="hljs-comment">//    reg.findAllIn(content).foreach(ele=&gt;println(ele))</span>

    <span class="hljs-comment">// 在content中，把所有通过正则找到的内容，换成"abc"</span>
    reg.replaceAllIn(content, ele =&gt; <span class="hljs-string">"abc"</span>)
    <span class="hljs-keyword">val</span> newContent = reg.replaceAllIn(content,ele =&gt;{
      println(ele)
     <span class="hljs-string">"abc"</span>
<span class="hljs-comment">//      "手机号前3位" +"****"+ "手机号后四位"</span>
    })
    println(<span class="hljs-string">"替换后的内容如下："</span>)
    println(newContent)

    <span class="hljs-comment">// 3.把结果写入到address_new.txt文件中</span>
  }

}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddec664791914a699ff25215e9e3bd80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LGa6Lii5YWUeA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767168041&amp;x-signature=utUC2OWA%2FUkI1owJ9s28%2F98lqJM%3D" alt="屏幕截图 2025-12-24 153220.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android perfetto - 记录分析memory]]></title>    <link>https://juejin.cn/post/7587062584164532262</link>    <guid>https://juejin.cn/post/7587062584164532262</guid>    <pubDate>2025-12-24T07:41:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587062584164532262" data-draft-id="7587062584164483110" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android perfetto - 记录分析memory"/> <meta itemprop="keywords" content="Android,性能优化"/> <meta itemprop="datePublished" content="2025-12-24T07:41:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="为码消得人憔悴"/> <meta itemprop="url" content="https://juejin.cn/user/3104676567333949"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android perfetto - 记录分析memory
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3104676567333949/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    为码消得人憔悴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T07:41:40.000Z" title="Wed Dec 24 2025 07:41:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、简介</h2>
<p><a href="https://juejin.cn/post/7582846276506157094" target="_blank" title="https://juejin.cn/post/7582846276506157094"><strong>Android perfetto - Perfetto 新手入门指南</strong></a>中初步介绍了Perfetto 是一个强大的性能分析工具，能够帮助开发者捕捉、分析 Android 系统和应用的性能数据。<a href="https://juejin.cn/post/7582791876365991974" target="_blank" title="https://juejin.cn/post/7582791876365991974"><strong>Android perfetto - 什么是 Tracing</strong></a>又介绍了Tracing和Profiling的区别，这篇文档将从分析内存的角度，以memory profiling为切入点展示如何使用 Perfetto 记录和分析内存使用情况。</p>
<h3 data-id="heading-1">2、<strong>内存分析概述</strong></h3>
<p>在 Android 应用中，内存的使用主要涉及两个方面：</p>
<ol>
<li><strong>Native C/C++/Rust 进程</strong>：通常通过 libc 的<code>malloc/free</code>（或者 C++ 的<code>new/delete</code>等包装函数）来分配内存。请注意，即使使用 Java API（通过 JNI 相关函数实现），也可能进行原生内存分配。一个典型的例子是<code>java.util.regex.Pattern</code>，它通常同时拥有 Java 堆内存和原生内存，因为底层使用了原生正则表达式库。</li>
<li><strong>Java/KT 应用</strong>：应用的内存占用的很大一部分存储在管理堆中（在 Android 中由 ART 的垃圾回收器管理）。这是每个<code>new X()</code> 对象所在的地方。</li>
</ol>
<p>Perfetto 提供两种互补的内存分析方式：</p>
<ol>
<li><strong>heap profiling</strong>原生堆分析：通过采样<code>malloc/free</code> 调用的调用栈，生成内存使用的火焰图，帮助诊断内存泄漏和优化内存分配。</li>
<li><strong>heap dumps</strong> Java 堆转储：生成堆保留图，分析 Java 对象的生命周期和内存保留链，帮助发现内存泄漏和无用对象的持有。</li>
</ol>
<h3 data-id="heading-2">3、<strong>Perfetto 内存分析模式</strong></h3>
<h4 data-id="heading-3">3.1、<strong>原生堆分析</strong>Native (C/C++/Rust) Heap Profiling</h4>
<p>原生语言（如 C/C++/Rust）通常通过 <code>malloc/free</code> 等函数进行内存分配。Perfetto 在 Android 和 Linux 系统上拦截这些函数的调用，通过采样内存分配时的调用栈来追踪每个内存分配的位置。此分析可以帮助您了解哪些函数导致了大量的内存分配，或者是否存在未释放的内存（即内存泄漏）。</p>
<ul>
<li><strong>支持的平台</strong>：仅支持 Android 和 Linux，因其依赖于拦截<code>malloc/free</code> 函数。</li>
<li><strong>工作原理</strong>：通过采样<code>malloc</code>和<code>free</code> 的调用栈，Perfetto 能够追踪内存分配的来源。</li>
<li><strong>注意事项</strong>：堆分析是非追溯性的，只能记录追踪开始后的内存分配，无法提供启动前的内存使用情况。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d1ac2c7f84b4df7abacd12ec5d5b5bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Li656CB5raI5b6X5Lq65oaU5oK0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166900&amp;x-signature=F14XAzFFvyfPLhr5BH6rGvMgCB8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">3.2、<strong>Java 堆转储</strong>Java/Managed Heap Dumps</h4>
<p>对于 Java 和 Kotlin 应用，Perfetto 可以创建堆转储，分析对象的生命周期和引用关系。堆转储提供了 Java 堆的详细快照，帮助开发者发现内存泄漏和不必要的对象引用。</p>
<ul>
<li><strong>支持的功能</strong>：通过分析对象之间的引用链，Perfetto 可以生成内存保留图，帮助分析哪些对象被长期持有。</li>
<li><strong>注意事项</strong>：堆转储分析不提供调用栈信息，因此不适合用于追踪原生代码的内存分配情况。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5ddde1df3184e01aec11ea75563dcd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Li656CB5raI5b6X5Lq65oaU5oK0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767166900&amp;x-signature=jNbU%2BiOB2Ur4yBbGJ%2FmSewPU1f4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">3.3、如何抓取</h4>
<p>参考Android perfetto - Perfetto 新手入门指南 中介绍的抓取方法，在config中添加面配置即可</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">data_sources</span> {
  <span class="hljs-string">config</span> {
    <span class="hljs-attr">name:</span> <span class="hljs-string">"android.heapprofd"</span>
    <span class="hljs-string">heapprofd_config</span> {
      <span class="hljs-attr">sampling_interval_bytes:</span> <span class="hljs-number">4096</span>
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"system_server"</span>
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"com.android.systemui"</span>
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"com.example.myapplication"</span><span class="hljs-string">//改成自己的进程名字即可</span>
      <span class="hljs-string">continuous_dump_config</span> {
        <span class="hljs-attr">dump_phase_ms:</span> <span class="hljs-number">1000</span>
        <span class="hljs-attr">dump_interval_ms:</span> <span class="hljs-number">1000</span>
      }
      <span class="hljs-attr">shmem_size_bytes:</span> <span class="hljs-number">8388608</span>
      <span class="hljs-attr">block_client:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">all_heaps:</span> <span class="hljs-literal">true</span>
    }
  }
}

<span class="hljs-string">data_sources</span> {
  <span class="hljs-string">config</span> {
    <span class="hljs-attr">name:</span> <span class="hljs-string">"android.java_hprof"</span>
    <span class="hljs-string">java_hprof_config</span> {
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"system_server"</span>
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"com.android.systemui"</span>
      <span class="hljs-attr">process_cmdline:</span> <span class="hljs-string">"com.example.myapplication"</span><span class="hljs-string">//改成自己的进程名字即可</span>
      <span class="hljs-attr">dump_smaps:</span> <span class="hljs-literal">true</span>
      <span class="hljs-string">continuous_dump_config</span> {
        <span class="hljs-attr">dump_phase_ms:</span> <span class="hljs-number">1000</span>
        <span class="hljs-attr">dump_interval_ms:</span> <span class="hljs-number">1000</span>
      }
    }
  }
}
</code></pre>
<p>抓取要求：</p>
<ul>
<li>在<strong>用户版本（user）上，只有标记为</strong>profileable或<strong>debuggable</strong> 的应用才能进行内存分析。</li>
<li>在<strong>userdebug 版本</strong> 上，所有应用（除了少数关键服务）都可以被分析。</li>
<li>可以通过禁用 SELinux 或使用<code>--disable-selinux</code> 参数解除分析限制。</li>
<li>要标记应用为可分析，只需在应用的清单文件中添加<code>&lt;profileable android:shell="true"/&gt;</code>。</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">...</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">application</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">profileable</span> <span class="hljs-attr">android:shell</span>=<span class="hljs-string">"true"</span>/&gt;</span>
        ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">4、参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fgetting-started%2Fmemory-profiling" target="_blank" title="https://perfetto.dev/docs/getting-started/memory-profiling" ref="nofollow noopener noreferrer">perfetto.dev/docs/gettin…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fcase-studies%2Fmemory" target="_blank" title="https://perfetto.dev/docs/case-studies/memory" ref="nofollow noopener noreferrer">perfetto.dev/docs/case-s…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdata-sources%2Fnative-heap-profiler" target="_blank" title="https://perfetto.dev/docs/data-sources/native-heap-profiler" ref="nofollow noopener noreferrer">perfetto.dev/docs/data-s…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdata-sources%2Fjava-heap-profiler" target="_blank" title="https://perfetto.dev/docs/data-sources/java-heap-profiler" ref="nofollow noopener noreferrer">perfetto.dev/docs/data-s…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ERC-4337 落地场景全盘点：游戏、DAO、DeFi 的下一个爆发点]]></title>    <link>https://juejin.cn/post/7587284708943691810</link>    <guid>https://juejin.cn/post/7587284708943691810</guid>    <pubDate>2025-12-24T08:00:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587284708943691810" data-draft-id="7587046913691795462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ERC-4337 落地场景全盘点：游戏、DAO、DeFi 的下一个爆发点"/> <meta itemprop="keywords" content="智能合约,Solidity,web3"/> <meta itemprop="datePublished" content="2025-12-24T08:00:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木西"/> <meta itemprop="url" content="https://juejin.cn/user/2436173496845549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ERC-4337 落地场景全盘点：游戏、DAO、DeFi 的下一个爆发点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173496845549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:00:53.000Z" title="Wed Dec 24 2025 08:00:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>本文围绕ERC-4337标准展开全面梳理，先系统解析其核心内容，涵盖概念定义、核心价值、组件构成、工作流程、特性优势及当前面临的挑战与发展现状，构建起清晰的理论认知框架；再聚焦实践落地，基于OpenZeppelin与account-abstraction工具，完整实现ERC-4337钱包开发，并详细拆解从开发搭建、测试验证到部署上线的全流程，形成“理论梳理+实践落地”的完整内容体系，为ERC-4337标准的学习与应用提供兼具系统性与可操作性的参考。</p>
</blockquote>
<h2 data-id="heading-1">概述</h2>
<p>ERC4337（Account Abstraction）是以太坊的账户抽象标准，旨在<strong>消除外部账户（EOA）与合约账户的界限</strong>。用户可通过智能合约自定义账户逻辑，实现社交恢复、代付Gas、批量交易等高级功能，而无需修改以太坊共识层;</p>
<p><strong>核心价值</strong>：保留EOA的简单性，同时赋予合约账户的灵活性，显著提升Web3用户体验。</p>
<h2 data-id="heading-2">核心组件架构</h2>
<h4 data-id="heading-3">1. <strong>UserOperation（用户操作）</strong></h4>
<ul>
<li><strong>定义</strong>：伪交易对象，代表用户意图，包含目标调用、验证元数据、Gas参数等信息</li>
<li><strong>特点</strong>：不直接发送到链上，而是提交至独立的 <code>alt-mempool</code>（替代内存池）</li>
</ul>
<h4 data-id="heading-4">2. <strong>智能合约账户（Smart Contract Account）</strong></h4>
<ul>
<li><strong>角色</strong>：用户控制的代理钱包，作为身份主体</li>
<li><strong>功能</strong>：通过 <code>validateUserOp()</code> 验证签名，通过 <code>executeUserOp()</code> 执行交易</li>
<li><strong>优势</strong>：可编程化，支持自定义规则（如多重签名、限额控制）</li>
</ul>
<h4 data-id="heading-5">3. <strong>Bundler（打包器）</strong></h4>
<ul>
<li><strong>作用</strong>：链下服务，监听 <code>alt-mempool</code> 中的 UserOperations</li>
<li><strong>流程</strong>：批量打包多个操作，通过一个交易提交至 <code>EntryPoint</code> 合约</li>
<li><strong>经济性</strong>：由Bundler预付Gas，后续从EntryPoint获得补偿</li>
</ul>
<h4 data-id="heading-6">4. <strong>EntryPoint（入口合约）</strong></h4>
<ul>
<li>
<p><strong>地位</strong>：ERC4337的核心链上网关</p>
</li>
<li>
<p><strong>职责</strong>：</p>
<ul>
<li>验证每个UserOperation的有效性</li>
<li>路由至对应智能合约钱包执行</li>
<li>计算总Gas消耗并补偿Bundler</li>
</ul>
</li>
<li>
<p><strong>关键</strong>：所有Gas支付通过此合约完成（从用户存款或Paymaster）</p>
</li>
</ul>
<h4 data-id="heading-7">5. <strong>Paymaster（支付主）</strong></h4>
<ul>
<li>
<p><strong>定位</strong>：可选的智能合约，提供灵活Gas支付方案</p>
</li>
<li>
<p><strong>两种模式</strong>：</p>
<ul>
<li><strong>赞助模式</strong>：项目方/第三方直接代付Gas</li>
<li><strong>代币模式</strong>：允许用户用ERC-20代币（如USDT）而非ETH支付Gas</li>
</ul>
</li>
<li>
<p><strong>接口</strong>：<code>validatePaymasterUserOp()</code> 验证资格，<code>postOp()</code> 处理后续结算</p>
</li>
</ul>
<h2 data-id="heading-8">标准工作流程</h2>
<p><strong>详细步骤</strong></p>
<ol>
<li><strong>签名生成</strong>：用户使用私钥对操作签名（兼容ERC-191/ERC-712）</li>
<li><strong>内存池广播</strong>：UserOperation进入链下<code>alt-mempool</code></li>
<li><strong>Bundler聚合</strong>：Bundler收集多个操作，创建批量交易</li>
<li><strong>EntryPoint处理</strong>：验证签名、检查Nonce、执行调用、计算Gas</li>
<li><strong>费用结算</strong>：从用户账户存款或Paymaster扣除Gas费，补偿Bundler</li>
</ol>
<h2 data-id="heading-9">关键特性与优势</h2>



































<table><thead><tr><th>特性</th><th>说明</th><th>价值</th></tr></thead><tbody><tr><td><strong>社交恢复</strong></td><td>通过守护人机制重置私钥</td><td>解决私钥丢失问题</td></tr><tr><td><strong>无Gas交易</strong></td><td>Paymaster代付或ERC-20支付</td><td>降低新用户门槛</td></tr><tr><td><strong>批量操作</strong></td><td>单次签名执行多笔调用</td><td>提升操作效率</td></tr><tr><td><strong>可编程权限</strong></td><td>自定义验证逻辑（如多签、限额）</td><td>增强安全性与灵活性</td></tr><tr><td><strong>确定性地址</strong></td><td>代理钱包地址跨网络一致</td><td>类似EOA的用户体验</td></tr></tbody></table>
<h2 data-id="heading-10">当前挑战与现状</h2>
<ul>
<li><strong>采用进展</strong>：核心合约已就绪，多个团队正推出生产级原生钱包</li>
<li><strong>架构局限</strong>：虽改善用户体验，但仍依赖链下Bundler与独立内存池，面临去中心化与普及挑战</li>
<li><strong>意图层（Intent-centric）融合</strong>：ERC4337为意图驱动架构提供基础，但纯意图模式仍需深度整合Paymaster与跨链设计</li>
</ul>
<h2 data-id="heading-11">一句总结</h2>
<p>ERC4337通过链下打包+链上验证的架构，在不修改以太坊协议的前提下实现账户抽象，是智能合约钱包普及的关键基础设施。</p>
<h2 data-id="heading-12">智能合约开发、测试、部署</h2>
<h5 data-id="heading-13"><strong>智能合约</strong></h5>
<h5 data-id="heading-14">1.治理代币合约</h5>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span>.<span class="hljs-number">24</span>;

import {BaseAccount} <span class="hljs-keyword">from</span> <span class="hljs-string">"@account-abstraction/contracts/core/BaseAccount.sol"</span>;
import {IEntryPoint} <span class="hljs-keyword">from</span> <span class="hljs-string">"@account-abstraction/contracts/interfaces/IEntryPoint.sol"</span>;
import {PackedUserOperation} <span class="hljs-keyword">from</span> <span class="hljs-string">"@account-abstraction/contracts/interfaces/PackedUserOperation.sol"</span>;
import {Ownable} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/access/Ownable.sol"</span>;
import {Initializable} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/proxy/utils/Initializable.sol"</span>;
import {UUPSUpgradeable} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/proxy/utils/UUPSUpgradeable.sol"</span>;
import {IERC1271} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/interfaces/IERC1271.sol"</span>;
import {ECDSA} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/utils/cryptography/ECDSA.sol"</span>;
import {MessageHashUtils} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/utils/cryptography/MessageHashUtils.sol"</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@title</span> MySmartAccount
 * <span class="hljs-doctag">@dev</span> ✅ 基于 <span class="hljs-doctag">@account</span>-abstraction/contracts 0.7.0 的标准实现
 */</span>
contract MySmartAccount is BaseAccount, Ownable, Initializable, UUPSUpgradeable, IERC1271 {
    using MessageHashUtils <span class="hljs-keyword">for</span> bytes32;
    
    bytes4 <span class="hljs-keyword">private</span> constant EIP1271_MAGIC_VALUE = <span class="hljs-number">0x1626ba7e</span>;
    
    <span class="hljs-comment">// ✅ 存储 EntryPoint 地址（避免与函数名冲突）</span>
    IEntryPoint <span class="hljs-keyword">private</span> immutable _ACCOUNT_ENTRY_POINT;
    
    <span class="hljs-comment">// 事件</span>
    event <span class="hljs-title function_ invoke__">TransactionExecuted</span>(address indexed target, uint256 value, bytes data);
    event <span class="hljs-title function_ invoke__">BatchExecuted</span>(address[] targets, uint256[] values, bytes[] datas);

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> ✅ 修正：构造函数参数名加下划线，避免与函数冲突
     * <span class="hljs-doctag">@param</span> entryPoint_ ERC-4337 EntryPoint 地址
     * <span class="hljs-doctag">@param</span> initialOwner 初始所有者地址
     */</span>
    <span class="hljs-title function_ invoke__">constructor</span>(
        IEntryPoint entryPoint_,
        address initialOwner
    ) 
        <span class="hljs-title function_ invoke__">BaseAccount</span>()                  <span class="hljs-comment">// ✅ BaseAccount 构造函数无参数</span>
        <span class="hljs-title function_ invoke__">Ownable</span>(initialOwner)          <span class="hljs-comment">// ✅ OpenZeppelin 5.x Ownable 需要 initialOwner</span>
    {
        _ACCOUNT_ENTRY_POINT = entryPoint_;  <span class="hljs-comment">// ✅ 存储到自定义变量</span>
        <span class="hljs-title function_ invoke__">_disableInitializers</span>();
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> ✅ 覆盖 entryPoint() 函数，返回存储的 EntryPoint
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">entryPoint</span>(<span class="hljs-params"/>) <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">virtual</span> <span class="hljs-title">override</span> <span class="hljs-title">returns</span> (<span class="hljs-params">IEntryPoint</span>) </span>{
        <span class="hljs-keyword">return</span> _ACCOUNT_ENTRY_POINT;
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 初始化函数，会覆盖 Ownable 的初始所有者
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initialize</span>(<span class="hljs-params">address initialOwner</span>) <span class="hljs-title">public</span> <span class="hljs-title">virtual</span> <span class="hljs-title">initializer</span> </span>{
        <span class="hljs-title function_ invoke__">_transferOwnership</span>(initialOwner);
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> ✅ 实现 BaseAccount 的抽象函数：_validateSignature（内部函数）
     * <span class="hljs-doctag">@notice</span> 在 v0.7.0 中，BaseAccount 同时要求 _validateSignature 和 validateUserOp
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_validateSignature</span>(<span class="hljs-params">
        PackedUserOperation calldata userOp,
        bytes32 userOpHash
    </span>) <span class="hljs-title">internal</span> <span class="hljs-title">virtual</span> <span class="hljs-title">override</span> <span class="hljs-title">returns</span> (<span class="hljs-params">uint256 validationData</span>) </span>{
        <span class="hljs-comment">// 检查签名长度</span>
        <span class="hljs-keyword">if</span> (userOp.signature.length != <span class="hljs-number">65</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// SIG_VALIDATION_FAILED</span>
        }
        
        <span class="hljs-comment">// ✅ 直接传入完整的 signature bytes，ECDSA.recover 会自动解析</span>
        <span class="hljs-comment">// 注意：userOp.signature 是 bytes calldata，可以直接传给 recover</span>
        bytes32 ethHash = userOpHash.<span class="hljs-title function_ invoke__">toEthSignedMessageHash</span>();
        address signer = ECDSA.<span class="hljs-title function_ invoke__">recover</span>(ethHash, userOp.signature);
        
        <span class="hljs-comment">// 验证签名者是否为所有者</span>
        <span class="hljs-keyword">if</span> (signer != <span class="hljs-title function_ invoke__">owner</span>()) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 验证成功</span>
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> ✅ 实现 BaseAccount 的 validateUserOp 外部函数
     * <span class="hljs-doctag">@notice</span> v0.7.0 要求实现此函数，处理 missingAccountFunds
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateUserOp</span>(<span class="hljs-params">
        PackedUserOperation calldata userOp,
        bytes32 userOpHash,
        uint256 missingAccountFunds
    </span>) <span class="hljs-title">external</span> <span class="hljs-title">virtual</span> <span class="hljs-title">override</span> <span class="hljs-title">returns</span> (<span class="hljs-params">uint256 validationData</span>) </span>{
        <span class="hljs-comment">// 验证调用者是 EntryPoint</span>
        <span class="hljs-keyword">require</span>(msg.sender == <span class="hljs-title function_ invoke__">address</span>(<span class="hljs-title function_ invoke__">entryPoint</span>()), <span class="hljs-string">"account: not from EntryPoint"</span>);
        
        <span class="hljs-comment">// 调用内部签名验证</span>
        validationData = <span class="hljs-title function_ invoke__">_validateSignature</span>(userOp, userOpHash);
        
        <span class="hljs-comment">// 支付 missingAccountFunds 给 EntryPoint</span>
        <span class="hljs-keyword">if</span> (missingAccountFunds &gt; <span class="hljs-number">0</span>) {
            (<span class="hljs-keyword">bool</span> success,) = <span class="hljs-title function_ invoke__">payable</span>(msg.sender).call{value : missingAccountFunds, gas : <span class="hljs-title function_ invoke__">type</span>(uint256).max}(<span class="hljs-string">""</span>);
            (success); <span class="hljs-comment">// 忽略失败（这是 EntryPoint 的责任）</span>
        }
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 辅助函数：要求调用者是 EntryPoint 或所有者
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_requireFromEntryPointOrOwner</span>(<span class="hljs-params"/>) <span class="hljs-title">internal</span> <span class="hljs-title">view</span> </span>{
        <span class="hljs-keyword">require</span>(
            msg.sender == <span class="hljs-title function_ invoke__">address</span>(<span class="hljs-title function_ invoke__">entryPoint</span>()) || msg.sender == <span class="hljs-title function_ invoke__">owner</span>(),
            <span class="hljs-string">"account: not Owner or EntryPoint"</span>
        );
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 执行单笔交易
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(<span class="hljs-params">
        address target,
        uint256 value,
        bytes calldata data
    </span>) <span class="hljs-title">external</span> <span class="hljs-title">payable</span> <span class="hljs-title">virtual</span> </span>{
        <span class="hljs-title function_ invoke__">_requireFromEntryPointOrOwner</span>();
        <span class="hljs-title function_ invoke__">_call</span>(target, value, data);
        emit <span class="hljs-title function_ invoke__">TransactionExecuted</span>(target, value, data);
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 批量执行多笔交易
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">executeBatch</span>(<span class="hljs-params">
        address[] calldata targets,
        uint256[] calldata values,
        bytes[] calldata datas
    </span>) <span class="hljs-title">external</span> <span class="hljs-title">payable</span> <span class="hljs-title">virtual</span> </span>{
        <span class="hljs-title function_ invoke__">_requireFromEntryPointOrOwner</span>();
        <span class="hljs-keyword">require</span>(targets.length == datas.length &amp;&amp; targets.length == values.length, <span class="hljs-string">"Array length mismatch"</span>);
        
        <span class="hljs-keyword">for</span> (uint256 i = <span class="hljs-number">0</span>; i &lt; targets.length; i++) {
            <span class="hljs-title function_ invoke__">_call</span>(targets[i], values[i], datas[i]);
        }
        
        emit <span class="hljs-title function_ invoke__">BatchExecuted</span>(targets, values, datas);
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 内部调用函数，处理执行结果
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_call</span>(<span class="hljs-params">address target, uint256 value, bytes memory data</span>) <span class="hljs-title">internal</span> </span>{
        (<span class="hljs-keyword">bool</span> success, bytes memory result) = target.call{value: value}(data);
        <span class="hljs-keyword">if</span> (!success) {
            assembly { <span class="hljs-title function_ invoke__">revert</span>(<span class="hljs-title function_ invoke__">add</span>(result, <span class="hljs-number">32</span>), <span class="hljs-title function_ invoke__">mload</span>(result)) }
        }
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> ✅ ERC-1271 签名验证实现
     * <span class="hljs-doctag">@notice</span> 对于 memory bytes，不能切片，只能检查长度
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isValidSignature</span>(<span class="hljs-params">
        bytes32 hash,
        bytes memory signature
    </span>) <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">virtual</span> <span class="hljs-title">override</span> <span class="hljs-title">returns</span> (<span class="hljs-params">bytes4 magicValue</span>) </span>{
        <span class="hljs-comment">// ✅ 检查 signature 长度是否符合 65 字节的 EIP-2098 标准</span>
        <span class="hljs-keyword">if</span> (signature.length != <span class="hljs-number">65</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0xffffffff</span>;
        }
        
        <span class="hljs-comment">// ✅ 直接传入完整的 signature，ECDSA.recover 会内部解析</span>
        bytes32 ethHash = hash.<span class="hljs-title function_ invoke__">toEthSignedMessageHash</span>();
        address signer = ECDSA.<span class="hljs-title function_ invoke__">recover</span>(ethHash, signature);
        
        <span class="hljs-keyword">if</span> (signer == <span class="hljs-title function_ invoke__">owner</span>()) {
            <span class="hljs-keyword">return</span> EIP1271_MAGIC_VALUE;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-number">0xffffffff</span>;
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> UUPS 升级授权
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_authorizeUpgrade</span>(<span class="hljs-params">address newImplementation</span>) <span class="hljs-title">internal</span> <span class="hljs-title">override</span> <span class="hljs-title">onlyOwner</span> </span>{}

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 接收 ETH
     */</span>
    <span class="hljs-title function_ invoke__">receive</span>() external payable {}
}
</code></pre>
<h5 data-id="heading-15">2.治理代币合约</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.24</span>;  <span class="hljs-comment">// ✅ 添加这一行</span>

<span class="hljs-keyword">import</span> {MySmartAccount} from <span class="hljs-string">"./MySmartAccount.sol"</span>;
<span class="hljs-keyword">import</span> {IEntryPoint} from <span class="hljs-string">"@account-abstraction/contracts/interfaces/IEntryPoint.sol"</span>;
<span class="hljs-keyword">import</span> {Create2} from <span class="hljs-string">"@openzeppelin/contracts/utils/Create2.sol"</span>;

contract MySmartAccountFactory {
    IEntryPoint <span class="hljs-keyword">private</span> immutable _entryPoint;
    
    event <span class="hljs-title function_">AccountCreated</span><span class="hljs-params">(address indexed account, address indexed owner)</span>;
    
    constructor(IEntryPoint entryPoint) {
        _entryPoint = entryPoint;
    }
    
    function <span class="hljs-title function_">createAccount</span><span class="hljs-params">(bytes32 salt, address owner)</span> external <span class="hljs-title function_">returns</span> <span class="hljs-params">(MySmartAccount account)</span> {
        <span class="hljs-type">address</span> <span class="hljs-variable">predictedAddress</span> <span class="hljs-operator">=</span> getAddress(salt, owner);
        
        <span class="hljs-keyword">if</span> (predictedAddress.code.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> MySmartAccount(payable(predictedAddress));
        }
        
        account = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySmartAccount</span>{salt: salt}(_entryPoint, owner);
        emit <span class="hljs-title function_">AccountCreated</span><span class="hljs-params">(address(account)</span>, owner);
    }
    
    function <span class="hljs-title function_">getAddress</span><span class="hljs-params">(bytes32 salt, address owner)</span> <span class="hljs-keyword">public</span> view <span class="hljs-title function_">returns</span> <span class="hljs-params">(address)</span> {
        <span class="hljs-type">bytes32</span> <span class="hljs-variable">bytecodeHash</span> <span class="hljs-operator">=</span> keccak256(
            abi.encodePacked(
                type(MySmartAccount).creationCode,
                abi.encode(_entryPoint, owner)  <span class="hljs-comment">// ✅ 匹配构造函数参数</span>
            )
        );
        
        <span class="hljs-keyword">return</span> Create2.computeAddress(salt, bytecodeHash, address(<span class="hljs-built_in">this</span>));
    }
}
</code></pre>
<h5 data-id="heading-16">3.治理代币合约</h5>
<pre><code class="hljs language-ini" lang="ini">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24<span class="hljs-comment">;</span>

import {BasePaymaster} from "@account-abstraction/contracts/core/BasePaymaster.sol"<span class="hljs-comment">;</span>
import {IEntryPoint} from "@account-abstraction/contracts/interfaces/IEntryPoint.sol"<span class="hljs-comment">;</span>
import {PackedUserOperation} from "@account-abstraction/contracts/interfaces/PackedUserOperation.sol"<span class="hljs-comment">;</span>
import {ECDSA} from "@openzeppelin/contracts/utils/cryptography/ECDSA.sol"<span class="hljs-comment">;</span>
import {MessageHashUtils} from "@openzeppelin/contracts/utils/cryptography/MessageHashUtils.sol"<span class="hljs-comment">;</span>

contract MyPaymaster is BasePaymaster {
    using MessageHashUtils for bytes32<span class="hljs-comment">;</span>
    
    mapping(<span class="hljs-attr">address</span> =&gt; bool) public whitelistedApps<span class="hljs-comment">;</span>
    mapping(<span class="hljs-attr">address</span> =&gt; uint256) public sponsoredTransactionCount<span class="hljs-comment">;</span>
    uint256 public <span class="hljs-attr">maxSponsoredTransactionsPerApp</span> = <span class="hljs-number">100</span><span class="hljs-comment">;</span>
    
    event AppWhitelisted(address indexed app)<span class="hljs-comment">;</span>
    event AppRemoved(address indexed app)<span class="hljs-comment">;</span>
    
    constructor(IEntryPoint entryPoint) BasePaymaster(entryPoint) {}
    
    function _validatePaymasterUserOp(
        PackedUserOperation calldata userOp,
        bytes32 userOpHash,
         uint256 /*maxCost*/
    ) internal override returns (bytes memory context, uint256 validationData) {
        address <span class="hljs-attr">targetApp</span> = address(bytes20(userOp.callData[<span class="hljs-number">16</span>:<span class="hljs-number">36</span>]))<span class="hljs-comment">;</span>
        require(whitelistedApps<span class="hljs-section">[targetApp]</span>, "App not whitelisted")<span class="hljs-comment">;</span>
        
        require(
            sponsoredTransactionCount<span class="hljs-section">[targetApp]</span> &lt; maxSponsoredTransactionsPerApp,
            "Sponsored transaction limit reached"
        )<span class="hljs-comment">;</span>
        
        if (userOp.paymasterAndData.length &gt; 20) {
            bytes memory <span class="hljs-attr">signature</span> = userOp.paymasterAndData[<span class="hljs-number">20</span>:]<span class="hljs-comment">;</span>
            bytes32 <span class="hljs-attr">hash</span> = userOpHash.toEthSignedMessageHash()<span class="hljs-comment">;</span>
            address <span class="hljs-attr">signer</span> = ECDSA.recover(hash, signature)<span class="hljs-comment">;</span>
            require(<span class="hljs-attr">signer</span> == owner(), <span class="hljs-string">"Invalid paymaster signature"</span>)<span class="hljs-comment">;</span>
        }
        
        sponsoredTransactionCount<span class="hljs-section">[targetApp]</span>++<span class="hljs-comment">;</span>
        return ("", 0)<span class="hljs-comment">;</span>
    }
    
    // ✅ 修正：移除 _postOp 覆盖，使用父类默认实现
    // 如果确实需要后处理，确保正确导入类型
    
    function whitelistApp(address app) external onlyOwner {
        whitelistedApps<span class="hljs-section">[app]</span> = true<span class="hljs-comment">;</span>
        emit AppWhitelisted(app)<span class="hljs-comment">;</span>
    }
    
    function removeApp(address app) external onlyOwner {
        whitelistedApps<span class="hljs-section">[app]</span> = false<span class="hljs-comment">;</span>
        emit AppRemoved(app)<span class="hljs-comment">;</span>
    }
    
    function resetSponsoredCount(address app) external onlyOwner {
        sponsoredTransactionCount<span class="hljs-section">[app]</span> = 0<span class="hljs-comment">;</span>
    }
    
    function setMaxSponsoredTransactions(uint256 maxCount) external onlyOwner {
        <span class="hljs-attr">maxSponsoredTransactionsPerApp</span> = maxCount<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-17">编译指令</h5>
<pre><code class="hljs language-python" lang="python">npx hardhat <span class="hljs-built_in">compile</span>
</code></pre>
<h5 data-id="heading-18"><strong>智能合约部署</strong></h5>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// scripts/deploy.ts</span>
import { network, artifacts } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
import {parseEther} <span class="hljs-keyword">from</span> <span class="hljs-string">"viem"</span>
import EntryPointArtifact <span class="hljs-keyword">from</span> <span class="hljs-string">"@account-abstraction/contracts/artifacts/EntryPoint.json"</span>;
async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"/>) </span>{
   <span class="hljs-comment">// 连接网络</span>
  <span class="hljs-keyword">const</span> { viem } = await network.<span class="hljs-title function_ invoke__">connect</span>({ <span class="hljs-attr">network</span>: network.name });<span class="hljs-comment">//指定网络进行链接</span>
  <span class="hljs-comment">// 获取客户端</span>
  <span class="hljs-keyword">const</span> [deployer] = await viem.<span class="hljs-title function_ invoke__">getWalletClients</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">publicClient</span> = await viem.<span class="hljs-title function_ invoke__">getPublicClient</span>();
  
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">entryPointHash</span> = await deployer.<span class="hljs-title function_ invoke__">deployContract</span>({
    <span class="hljs-attr">abi</span>: EntryPointArtifact.abi,
    <span class="hljs-attr">bytecode</span>: EntryPointArtifact.bytecode,
    <span class="hljs-attr">args</span>: [], // EntryPoint 构造函数不需要参数
  });
  
  <span class="hljs-comment">// 等待确认并获取合约地址</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">entryPointReceipt</span> = await publicClient.<span class="hljs-title function_ invoke__">waitForTransactionReceipt</span>({ 
    <span class="hljs-attr">hash</span>: entryPointHash 
  });
  
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">entryPointAddress</span> = entryPointReceipt.contractAddress;
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"✅ EntryPoint 合约地址:"</span>, entryPointAddress);
  <span class="hljs-comment">// 部署智能合约MySmartAccount</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountRegistry</span> = await artifacts.<span class="hljs-title function_ invoke__">readArtifact</span>(<span class="hljs-string">"MySmartAccount"</span>);
  <span class="hljs-comment">// 部署（构造函数参数：recipient, initialOwner）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountRegistryHash</span> = await deployer.<span class="hljs-title function_ invoke__">deployContract</span>({
    <span class="hljs-attr">abi</span>: MySmartAccountRegistry.abi,//获取abi
    <span class="hljs-attr">bytecode</span>: MySmartAccountRegistry.bytecode,//硬编码
    <span class="hljs-attr">args</span>: [entryPointAddress,deployer.account.address],//process.env.RECIPIENT, process.env.OWNER
  });
  <span class="hljs-comment">// 等待确认并打印合约地址</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountReceipt</span> = await publicClient.<span class="hljs-title function_ invoke__">getTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: MySmartAccountRegistryHash });
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"MySmartAccount合约地址:"</span>, MySmartAccountReceipt.contractAddress);
  <span class="hljs-comment">// 部署工厂合约</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountFactory</span> = await  artifacts.<span class="hljs-title function_ invoke__">readArtifact</span>(<span class="hljs-string">"MySmartAccountFactory"</span>); 

  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountFactoryHash</span> = await deployer.<span class="hljs-title function_ invoke__">deployContract</span>({
    <span class="hljs-attr">abi</span>: MySmartAccountFactory.abi,//获取abi
    <span class="hljs-attr">bytecode</span>: MySmartAccountFactory.bytecode,//硬编码
    <span class="hljs-attr">args</span>: [entryPointAddress],//process.env.RECIPIENT, process.env.OWNER
  });
    <span class="hljs-comment">// 等待确认并打印合约地址</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MySmartAccountFactoryReceipt</span> = await publicClient.<span class="hljs-title function_ invoke__">getTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: MySmartAccountFactoryHash });
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"MySmartAccountFactory合约地址:"</span>, await MySmartAccountFactoryReceipt.contractAddress);

  <span class="hljs-comment">// 部署支付合约MyPaymaster</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MyPaymaster</span> = await artifacts.<span class="hljs-title function_ invoke__">readArtifact</span>(<span class="hljs-string">"MyPaymaster"</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MyPaymasterHash</span> = await deployer.<span class="hljs-title function_ invoke__">deployContract</span>({  // ← 使用 deployContract
    <span class="hljs-attr">abi</span>: MyPaymaster.abi,
    <span class="hljs-attr">bytecode</span>: MyPaymaster.bytecode,
    <span class="hljs-attr">args</span>: [entryPointAddress],
  });
  
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MyPaymasterReceipt</span> = await publicClient.<span class="hljs-title function_ invoke__">waitForTransactionReceipt</span>({ 
    <span class="hljs-attr">hash</span>: MyPaymasterHash 
  });
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"MyPaymaster合约地址:"</span>, MyPaymasterReceipt.contractAddress);
  
}

<span class="hljs-title function_ invoke__">main</span>().<span class="hljs-keyword">catch</span>((error) =&gt; {
  console.<span class="hljs-title function_ invoke__">error</span>(error);
  process.<span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);
});
</code></pre>
<h5 data-id="heading-19">特殊说明：关于本地部署EntryPoint合约问题</h5>
<p><code>本地开发直接在安装包中获取编译后的@account-abstraction/contracts/artifacts/EntryPoint.json 进行部署，如果是测试网或主网中直接使用在线的合约地址即可</code></p>
<h5 data-id="heading-20">部署指令</h5>
<pre><code class="hljs language-arduino" lang="arduino">npx hardhat run ./scripts/xxx.ts
</code></pre>
<h5 data-id="heading-21"><strong>智能合约测试</strong></h5>
<pre><code class="hljs language-ini" lang="ini">// test/ERC4337Wallet.ts
import assert from "node:assert/strict"<span class="hljs-comment">;</span>
import { describe, it, beforeEach } from "node:test"<span class="hljs-comment">;</span>
import { parseEther, toHex, hashMessage } from "viem"<span class="hljs-comment">;</span>
import { network } from "hardhat"<span class="hljs-comment">;</span>
import EntryPointArtifact from "@account-abstraction/contracts/artifacts/EntryPoint.json"<span class="hljs-comment">;</span>

describe("ERC4337钱包核心功能测试", async function () {
  let viem: any<span class="hljs-comment">;</span>
  let publicClient: any<span class="hljs-comment">;</span>
  let deployer: any, owner: any, user1: any<span class="hljs-comment">;</span>
  let entryPointAddress: string<span class="hljs-comment">;</span>
  let mySmartAccountFactory: any<span class="hljs-comment">;</span>
  let myPaymaster: any<span class="hljs-comment">;</span>

  beforeEach(async function () {
    const <span class="hljs-attr">networkData</span> = await network.connect()<span class="hljs-comment">;</span>
    <span class="hljs-attr">viem</span> = networkData.viem<span class="hljs-comment">;</span>
    
    <span class="hljs-section">[deployer, owner, user1]</span> = await viem.getWalletClients()<span class="hljs-comment">;</span>
    <span class="hljs-attr">publicClient</span> = await viem.getPublicClient()<span class="hljs-comment">;</span>

    // 部署 EntryPoint
    console.log("🚀 部署 EntryPoint...")<span class="hljs-comment">;</span>
    const <span class="hljs-attr">entryPointHash</span> = await deployer.deployContract({
      abi: EntryPointArtifact.abi,
      bytecode: EntryPointArtifact.bytecode,
      args: <span class="hljs-section">[]</span>,
    })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">entryPointReceipt</span> = await publicClient.waitForTransactionReceipt({ 
      hash: entryPointHash 
    })<span class="hljs-comment">;</span>
    <span class="hljs-attr">entryPointAddress</span> = entryPointReceipt.contractAddress!<span class="hljs-comment">;</span>
    console.log("✅ EntryPoint:", entryPointAddress)<span class="hljs-comment">;</span>

    // 部署工厂和 Paymaster
    <span class="hljs-attr">mySmartAccountFactory</span> = await viem.deployContract(<span class="hljs-string">"MySmartAccountFactory"</span>, [entryPointAddress])<span class="hljs-comment">;</span>
    console.log("✅ Factory:", mySmartAccountFactory.address)<span class="hljs-comment">;</span>

    <span class="hljs-attr">myPaymaster</span> = await viem.deployContract(<span class="hljs-string">"MyPaymaster"</span>, [entryPointAddress])<span class="hljs-comment">;</span>
    // await myPaymaster.write.deposit()<span class="hljs-comment">;</span>
    console.log("✅ Paymaster:", myPaymaster.address)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  it("应创建智能账户并验证所有权", async function () {
    const <span class="hljs-attr">salt</span> = toHex(<span class="hljs-string">"test-salt"</span>, { size: <span class="hljs-number">32</span> })<span class="hljs-comment">;</span>
    
    // 1. 创建账户
    const <span class="hljs-attr">createTx</span> = await mySmartAccountFactory.write.createAccount([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    await publicClient.waitForTransactionReceipt({ hash: createTx })<span class="hljs-comment">;</span>
    
    // 2. 获取新创建的账户地址（关键！）
    const <span class="hljs-attr">accountAddress</span> = await mySmartAccountFactory.read.getAddress([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    
    // 3. 验证地址是合约
    const <span class="hljs-attr">code</span> = await publicClient.getCode({ address: accountAddress })<span class="hljs-comment">;</span>
    assert.ok(code &amp;&amp; code.length &gt; 2, "账户未成功部署")<span class="hljs-comment">;</span>
    
    // 4. 使用新账户地址创建实例
    const <span class="hljs-attr">mySmartAccount</span> = await viem.getContractAt(<span class="hljs-string">"MySmartAccount"</span>, accountAddress)<span class="hljs-comment">;</span>
    
    // 5. 验证所有权（这会成功，因为账户已初始化）
    const <span class="hljs-attr">actualOwner</span> = await mySmartAccount.read.owner()<span class="hljs-comment">;</span>
    assert.equal(actualOwner.toLowerCase(), owner.account.address.toLowerCase())<span class="hljs-comment">;</span>
    
    console.log("✅ 账户地址:", accountAddress)<span class="hljs-comment">;</span>
    console.log("✅ 所有者:", actualOwner)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  it("应验证 ERC-1271 签名", async function () {
   const <span class="hljs-attr">walletClient</span> = (await viem.getWalletClients())[<span class="hljs-number">0</span>]<span class="hljs-comment">; </span>
    const <span class="hljs-attr">salt</span> = toHex(<span class="hljs-string">"test-salt-1271"</span>, { size: <span class="hljs-number">32</span> })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">createTx</span> = await mySmartAccountFactory.write.createAccount([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    await publicClient.waitForTransactionReceipt({ hash: createTx })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">accountAddress</span> = await mySmartAccountFactory.read.getAddress([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    const <span class="hljs-attr">mySmartAccount</span> = await viem.getContractAt(<span class="hljs-string">"MySmartAccount"</span>, accountAddress)<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">message</span> = <span class="hljs-string">"Hello ERC-1271"</span><span class="hljs-comment">;</span>
    const <span class="hljs-attr">messageHash</span> = hashMessage({ raw:message })<span class="hljs-comment">;</span>
    const <span class="hljs-attr">signature</span> = await walletClient.signMessage({
      account: owner.account,
      message
    })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">result</span> = await mySmartAccount.read.isValidSignature([messageHash, signature])<span class="hljs-comment">;</span>
    console.log("✅ 验证结果:", result)<span class="hljs-comment">;</span>
    // assert.equal(result, "0x1626ba7e")<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  it("应允许所有者执行交易", async function () {
    const <span class="hljs-attr">salt</span> = toHex(<span class="hljs-string">"test-salt-exec"</span>, { size: <span class="hljs-number">32</span> })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">createTx</span> = await mySmartAccountFactory.write.createAccount([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    await publicClient.waitForTransactionReceipt({ hash: createTx })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">accountAddress</span> = await mySmartAccountFactory.read.getAddress([
      salt,
      owner.account.address
    ])<span class="hljs-comment">;</span>
    const <span class="hljs-attr">mySmartAccount</span> = await viem.getContractAt(<span class="hljs-string">"MySmartAccount"</span>, accountAddress)<span class="hljs-comment">;</span>
    
    // 存入 ETH
    await deployer.sendTransaction({
      to: accountAddress,
      value: parseEther("1")
    })<span class="hljs-comment">;</span>
    
    // 执行转账
    const <span class="hljs-attr">executeTx</span> = await mySmartAccount.write.execute([
      user1.account.address,
      parseEther(<span class="hljs-string">"0.5"</span>),
      <span class="hljs-string">"0x"</span>
    ], { account: owner.account })<span class="hljs-comment">;</span>
    
    const <span class="hljs-attr">receipt</span> = await publicClient.waitForTransactionReceipt({ hash: executeTx })<span class="hljs-comment">;</span>
    assert.equal(receipt.status, "success")<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  it("应管理 Paymaster 白名单", async function () {
    const <span class="hljs-attr">app</span> = user1.account.address<span class="hljs-comment">;</span>
    
    // 初始不在白名单
    const <span class="hljs-attr">isWhitelistedBefore</span> = await myPaymaster.read.whitelistedApps([app])<span class="hljs-comment">;</span>
    assert.equal(isWhitelistedBefore, false)<span class="hljs-comment">;</span>
    
    // 添加白名单
    await myPaymaster.write.whitelistApp(<span class="hljs-section">[app]</span>, { account: deployer.account })<span class="hljs-comment">;</span>
    const <span class="hljs-attr">isWhitelistedAfter</span> = await myPaymaster.read.whitelistedApps([app])<span class="hljs-comment">;</span>
    assert.equal(isWhitelistedAfter, true)<span class="hljs-comment">;</span>
    console.log("✅ 已添加白名单:", app)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h5 data-id="heading-22"><strong>测试指令</strong></h5>
<pre><code class="hljs language-bash" lang="bash">npx hardhat <span class="hljs-built_in">test</span> ./test/xxx.ts
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>以上内容完成了对 ERC-4337 标准的全面知识梳理，同时涵盖了其相关智能合约的完整实现流程。从核心知识解析到合约开发、测试验证，再到部署上线，每个环节均提供了详细的操作指引与逻辑说明，形成了 “理论梳理 + 实践落地” 的完整闭环，为开发者掌握 ERC-4337 标准应用与合约开发提供了清晰且可落地的参考框架</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[并发编程高级技巧：运行时检测死锁，告别死锁焦虑]]></title>    <link>https://juejin.cn/post/7586504691845234697</link>    <guid>https://juejin.cn/post/7586504691845234697</guid>    <pubDate>2025-12-22T11:18:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586504691845234697" data-draft-id="7586498198148792371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="并发编程高级技巧：运行时检测死锁，告别死锁焦虑"/> <meta itemprop="keywords" content="后端,性能优化,Java"/> <meta itemprop="datePublished" content="2025-12-22T11:18:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            并发编程高级技巧：运行时检测死锁，告别死锁焦虑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T11:18:18.000Z" title="Mon Dec 22 2025 11:18:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好,我是桦说编程。</p>
<blockquote>
<p>死锁是多线程编程的噩梦，一旦发生程序就会挂起。本文介绍 Guava 的 <code>CycleDetectingLockFactory</code>，让你在开发阶段就能发现潜在死锁，而不是等到生产环境暴雷。</p>
</blockquote>
<h2 data-id="heading-0">问题背景：死锁焦虑</h2>
<p>使用 <code>ReentrantLock</code> 或 <code>synchronized</code> 时，最担心的就是死锁：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程1：先锁A，再锁B</span>
lockA.lock();
lockB.lock();

<span class="hljs-comment">// 线程2：先锁B，再锁A</span>
lockB.lock();
lockA.lock();
</code></pre>
<p>这种代码在单元测试中可能运行正常，但在生产环境高并发时突然死锁，程序挂起，只能重启。</p>
<p><strong>核心痛点</strong>：</p>
<ul>
<li>死锁难以复现，测试阶段很难发现</li>
<li>一旦发生，只能强制重启</li>
<li>排查需要线程 dump 分析，耗时耗力</li>
</ul>
<h2 data-id="heading-1">CycleDetectingLockFactory：运行时死锁检测</h2>
<p>Guava 提供的 <code>CycleDetectingLockFactory</code> 通过<strong>构建锁的依赖图</strong>，在获取锁时实时检测是否会形成环路（死锁）。</p>
<h3 data-id="heading-2">核心原理</h3>
<ol>
<li><strong>锁依赖图</strong>：记录每个线程获取锁的顺序</li>
<li><strong>环路检测</strong>：尝试获取新锁时，检查是否会形成环路</li>
<li><strong>即时失败</strong>：检测到潜在死锁时，立即抛出 <code>PotentialDeadlockException</code></li>
</ol>
<h3 data-id="heading-3">三种检测策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. THROW - 抛出异常（推荐用于开发/测试环境）</span>
CycleDetectingLockFactory.newInstance(Policies.THROW);

<span class="hljs-comment">// 2. WARN - 打印警告日志（适合生产环境）</span>
CycleDetectingLockFactory.newInstance(Policies.WARN);

<span class="hljs-comment">// 3. DISABLED - 禁用检测（性能敏感场景）</span>
CycleDetectingLockFactory.newInstance(Policies.DISABLED);
</code></pre>
<h2 data-id="heading-4">对比演示：死锁 vs 死锁检测</h2>
<h3 data-id="heading-5">场景：转账系统</h3>
<p>两个账户相互转账，线程1从A转到B，线程2从B转到A。</p>
<h3 data-id="heading-6">死锁版本（ReentrantLock）</h3>
<p>使用普通 <code>ReentrantLock</code>，程序会挂起：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> {
        lock.lock();  <span class="hljs-comment">// 先锁自己</span>
        <span class="hljs-keyword">try</span> {
            target.lock.lock();  <span class="hljs-comment">// 再锁对方 - 可能死锁!</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 转账逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                target.lock.unlock();
            }
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-css" lang="css">线程<span class="hljs-number">1</span> 获取了 账户<span class="hljs-selector-tag">A</span> 的锁
线程<span class="hljs-number">2</span> 获取了 账户<span class="hljs-selector-tag">B</span> 的锁
=== <span class="hljs-number">3</span>秒后程序仍未结束，发生死锁 ===
线程<span class="hljs-number">1</span>状态: WAITING
线程<span class="hljs-number">2</span>状态: WAITING
</code></pre>
<h3 data-id="heading-7">死锁检测版本（CycleDetectingLockFactory）</h3>
<p>替换为 <code>CycleDetectingLockFactory</code>，死锁会被立即检测：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.THROW);

<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Lock lock;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Account</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> balance)</span> {
        <span class="hljs-built_in">this</span>.lock = lockFactory.newReentrantLock(name);  <span class="hljs-comment">// 使用工厂创建锁</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            target.lock.lock();  <span class="hljs-comment">// 检测到死锁会抛出异常</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 转账逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                target.lock.unlock();
            }
        } <span class="hljs-keyword">catch</span> (PotentialDeadlockException e) {
            System.err.println(<span class="hljs-string">"检测到潜在死锁: "</span> + e.getMessage());
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-css" lang="css">线程<span class="hljs-number">1</span> 获取了 账户<span class="hljs-selector-tag">A</span> 的锁
线程<span class="hljs-number">2</span> 获取了 账户<span class="hljs-selector-tag">B</span> 的锁
线程<span class="hljs-number">2</span> 检测到潜在死锁!
死锁信息: Potential Deadlock from LockGraphNode{账户<span class="hljs-selector-tag">B</span>} <span class="hljs-selector-tag">to</span> LockGraphNode{账户<span class="hljs-selector-tag">A</span>}
=== 程序正常结束，未发生死锁挂起 ===
</code></pre>
<h2 data-id="heading-8">实战建议</h2>
<h3 data-id="heading-9">1. 开发/测试环境使用 THROW 策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在测试环境配置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.THROW);
</code></pre>
<p><strong>好处</strong>：单元测试、集成测试中自动发现死锁问题，快速失败。</p>
<h3 data-id="heading-10">2. 生产环境使用 WARN 策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在生产环境配置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.WARN);
</code></pre>
<p><strong>好处</strong>：记录告警日志，但不中断业务，便于后续优化。</p>
<h3 data-id="heading-11">3. 性能敏感场景可以禁用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 性能优先场景</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.DISABLED);
</code></pre>
<p><strong>注意</strong>：只有在确认没有死锁风险，且性能测试证明检测有明显开销时才禁用。</p>
<h3 data-id="heading-12">4. 更好的方案：固定加锁顺序</h3>
<p>死锁检测只是兜底手段，根本解决方案是<strong>避免环路依赖</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 按照固定顺序加锁，避免死锁</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">safeTransfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
    <span class="hljs-type">Account</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> System.identityHashCode(from) &lt; System.identityHashCode(to) ? from : to;
    <span class="hljs-type">Account</span> <span class="hljs-variable">second</span> <span class="hljs-operator">=</span> first == from ? to : from;

    first.lock.lock();
    <span class="hljs-keyword">try</span> {
        second.lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 转账逻辑</span>
        } <span class="hljs-keyword">finally</span> {
            second.lock.unlock();
        }
    } <span class="hljs-keyword">finally</span> {
        first.lock.unlock();
    }
}
</code></pre>
<h2 data-id="heading-13">完整示例</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * CycleDetectingLockFactory 死锁检测演示
 *
 * &lt;p&gt;与 DeadlockDemo 相同的转账场景，但使用 CycleDetectingLockFactory
 * &lt;p&gt;当检测到潜在死锁时，会立即抛出 PotentialDeadlockException，而不是挂起程序
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CycleDetectingLockDemo</span> {

    <span class="hljs-comment">// 创建锁工厂，THROW 策略会在检测到死锁时抛出异常</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
            CycleDetectingLockFactory.newInstance(CycleDetectingLockFactory.Policies.THROW);

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Lock lock;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> balance;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Account</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> balance)</span> {
            <span class="hljs-built_in">this</span>.name = name;
            <span class="hljs-built_in">this</span>.balance = balance;
            <span class="hljs-comment">// 使用 CycleDetectingLockFactory 创建锁</span>
            <span class="hljs-comment">// 每个锁都有一个唯一的标识，用于构建锁的依赖图</span>
            <span class="hljs-built_in">this</span>.lock = lockFactory.newReentrantLock(name);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 先锁定自己的账户</span>
                lock.lock();
                <span class="hljs-keyword">try</span> {
                    System.out.println(Thread.currentThread().getName() +
                            <span class="hljs-string">" 获取了 "</span> + name + <span class="hljs-string">" 的锁"</span>);

                    <span class="hljs-comment">// 模拟业务处理耗时</span>
                    Thread.sleep(<span class="hljs-number">100</span>);

                    <span class="hljs-comment">// 尝试锁定目标账户</span>
                    <span class="hljs-comment">// 如果会形成循环依赖（死锁），这里会立即抛出 PotentialDeadlockException</span>
                    target.lock.lock();
                    <span class="hljs-keyword">try</span> {
                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 获取了 "</span> + target.name + <span class="hljs-string">" 的锁"</span>);

                        <span class="hljs-built_in">this</span>.balance -= amount;
                        target.balance += amount;

                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 完成转账: "</span> + name + <span class="hljs-string">" -&gt; "</span> + target.name + <span class="hljs-string">" ¥"</span> + amount);
                    } <span class="hljs-keyword">finally</span> {
                        target.lock.unlock();
                    }
                } <span class="hljs-keyword">finally</span> {
                    lock.unlock();
                }
            } <span class="hljs-keyword">catch</span> (CycleDetectingLockFactory.PotentialDeadlockException e) {
                <span class="hljs-comment">// 检测到潜在死锁，立即抛出异常</span>
                System.err.println(Thread.currentThread().getName() +
                        <span class="hljs-string">" 检测到潜在死锁!"</span>);
                System.err.println(<span class="hljs-string">"死锁信息: "</span> + e.getMessage());
                <span class="hljs-comment">// 打印完整的锁依赖链</span>
                e.printStackTrace();
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> name + <span class="hljs-string">": ¥"</span> + balance;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">Account</span> <span class="hljs-variable">accountA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户A"</span>, <span class="hljs-number">1000</span>);
        <span class="hljs-type">Account</span> <span class="hljs-variable">accountB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户B"</span>, <span class="hljs-number">1000</span>);

        System.out.println(<span class="hljs-string">"=== CycleDetectingLockFactory 死锁检测演示 ==="</span>);
        System.out.println(<span class="hljs-string">"初始状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
        System.out.println();

        <span class="hljs-comment">// 线程1: A -&gt; B 转账</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            accountA.transfer(accountB, <span class="hljs-number">200</span>);
        }, <span class="hljs-string">"线程1"</span>);

        <span class="hljs-comment">// 线程2: B -&gt; A 转账</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            accountB.transfer(accountA, <span class="hljs-number">300</span>);
        }, <span class="hljs-string">"线程2"</span>);

        thread1.start();
        thread2.start();

        <span class="hljs-comment">// 等待线程结束</span>
        thread1.join(<span class="hljs-number">5000</span>);
        thread2.join(<span class="hljs-number">5000</span>);

        System.out.println();
        System.out.println(<span class="hljs-string">"=== 程序正常结束，未发生死锁挂起 ==="</span>);
        System.out.println(<span class="hljs-string">"最终状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
        System.out.println(<span class="hljs-string">"线程1状态: "</span> + thread1.getState());
        System.out.println(<span class="hljs-string">"线程2状态: "</span> + thread2.getState());
    }

    <span class="hljs-comment">/**
     * 演示正确的锁顺序 - 避免死锁
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeTransferDemo</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
            <span class="hljs-type">Account</span> <span class="hljs-variable">accountA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户A"</span>, <span class="hljs-number">1000</span>);
            <span class="hljs-type">Account</span> <span class="hljs-variable">accountB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户B"</span>, <span class="hljs-number">1000</span>);

            System.out.println(<span class="hljs-string">"=== 安全转账演示（按固定顺序加锁）==="</span>);
            System.out.println(<span class="hljs-string">"初始状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
            System.out.println();

            <span class="hljs-comment">// 两个线程都按照相同的顺序加锁：先 A 后 B</span>
            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                safeTransfer(accountA, accountB, <span class="hljs-number">200</span>);
            }, <span class="hljs-string">"线程1"</span>);

            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                safeTransfer(accountB, accountA, <span class="hljs-number">300</span>);
            }, <span class="hljs-string">"线程2"</span>);

            thread1.start();
            thread2.start();

            thread1.join();
            thread2.join();

            System.out.println();
            System.out.println(<span class="hljs-string">"=== 安全转账完成 ==="</span>);
            System.out.println(<span class="hljs-string">"最终状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">safeTransfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
            <span class="hljs-comment">// 按照固定顺序加锁：使用 hashCode 或其他标识符确定顺序</span>
            <span class="hljs-type">Account</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> System.identityHashCode(from) &lt; System.identityHashCode(to) ? from : to;
            <span class="hljs-type">Account</span> <span class="hljs-variable">second</span> <span class="hljs-operator">=</span> first == from ? to : from;

            <span class="hljs-keyword">try</span> {
                first.lock.lock();
                <span class="hljs-keyword">try</span> {
                    System.out.println(Thread.currentThread().getName() +
                            <span class="hljs-string">" 获取了 "</span> + first.name + <span class="hljs-string">" 的锁"</span>);

                    Thread.sleep(<span class="hljs-number">100</span>);

                    second.lock.lock();
                    <span class="hljs-keyword">try</span> {
                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 获取了 "</span> + second.name + <span class="hljs-string">" 的锁"</span>);

                        from.balance -= amount;
                        to.balance += amount;

                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 完成转账: "</span> + from.name + <span class="hljs-string">" -&gt; "</span> + to.name + <span class="hljs-string">" ¥"</span> + amount);
                    } <span class="hljs-keyword">finally</span> {
                        second.lock.unlock();
                    }
                } <span class="hljs-keyword">finally</span> {
                    first.lock.unlock();
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-14">核心要点</h2>
<h3 data-id="heading-15">CycleDetectingLockFactory 的优势</h3>
<ol>
<li><strong>即时反馈</strong>：开发阶段就能发现潜在死锁</li>
<li><strong>零侵入</strong>：只需替换锁的创建方式，业务代码不变</li>
<li><strong>可配置</strong>：根据环境选择不同策略（抛异常/告警/禁用）</li>
<li><strong>清晰诊断</strong>：异常信息包含完整的锁依赖链</li>
</ol>
<h3 data-id="heading-16">使用场景</h3>
<ul>
<li><strong>推荐使用</strong>：多个锁、加锁顺序不确定的场景</li>
<li><strong>测试环境</strong>：全局使用 THROW 策略，自动化测试发现问题</li>
<li><strong>生产环境</strong>：使用 WARN 策略作为监控手段</li>
<li><strong>不推荐</strong>：单锁场景、加锁顺序固定的场景（无必要）</li>
</ul>
<h2 data-id="heading-17">总结</h2>
<ul>
<li><strong>死锁难以复现</strong>，生产环境暴露成本高，<code>CycleDetectingLockFactory</code> 让问题前移</li>
<li><strong>THROW 策略</strong>用于测试环境，<strong>WARN 策略</strong>用于生产环境</li>
<li><strong>死锁检测是兜底</strong>，根本方案是设计合理的加锁顺序</li>
<li><strong>零侵入改造</strong>，只需替换锁的创建方式，立即获得死锁检测能力</li>
<li><strong>检测开销</strong>：需要维护锁依赖图，有轻微性能损耗</li>
</ul>
<p>使用 <code>CycleDetectingLockFactory</code> 可以让你摆脱死锁焦虑，在开发阶段就发现问题，而不是等到生产环境暴雷后手忙脚乱。</p>
<hr/>
<p>如果这篇文章对你有帮助，欢迎关注我，持续分享高质量技术干货，助你更快提升编程能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[于钉钉投诉的申诉与思考：行业观察的价值，在于敢说真实的问题]]></title>    <link>https://juejin.cn/post/7587060153028689961</link>    <guid>https://juejin.cn/post/7587060153028689961</guid>    <pubDate>2025-12-24T06:11:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587060153028689961" data-draft-id="7587060153028673577" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="于钉钉投诉的申诉与思考：行业观察的价值，在于敢说真实的问题"/> <meta itemprop="keywords" content="人工智能,产品经理,阿里巴巴"/> <meta itemprop="datePublished" content="2025-12-24T06:11:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            于钉钉投诉的申诉与思考：行业观察的价值，在于敢说真实的问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:11:07.000Z" title="Wed Dec 24 2025 06:11:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>收到钉钉方面以 “刻意挑起矛盾、贬低品牌” 为由的投诉时，我正在整理近期企业服务 AI 赛道的案例 —— 作为长期扎根这个领域的观察者，我始终认为，对产品战略的理性分析、对行业生态的客观审视，从来不是 “抹黑”，而是推动行业进步的必要声音。今天写下这篇文字，既是对投诉的正式回应，也是想和关注这个赛道的朋友聊聊：我们究竟需要怎样的行业讨论？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d9be61f9f994e9cbf362ab02aa3fbb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161467&amp;x-signature=8CAJWkJ%2FZf7XgWTaX%2FyOuPqbgcM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-0">一、先谈初衷：我从未想过 “贬低”，只希望 “说透”</h2>
<p>在《如何评价钉钉 AI1.1 新品发布会》一文中，我的核心诉求很明确：从战略逻辑、生态可行性、竞争隐忧三个维度，拆解钉钉 “行业垂直 AI” 战略背后的真实挑战。这些分析绝非主观臆断，而是基于公开信息与行业常识：</p>
<ul>
<li>关于 “钉钉与 Qoder 的左右分野”，我始终强调二者 “均为阿里旗下独立产品”—— 这是公开的业务定位，而非我刻意制造的对立。我分析 “资源内耗”，依据的是国内 AI 人才缺口达 500 万、复合型人才稀缺的行业现状：当一家企业同时在通用编程（Qoder）与垂直行业（钉钉）两条赛道发力时，有限的人才与技术资源如何分配？这是所有大型企业多业务线布局都会面临的问题，怎么就成了 “挑起矛盾”？</li>
<li>关于 “垂直模型的现实支撑”，我质疑的不是 “垂直化” 本身，而是钉钉发布会中未明确的细节：医疗数据的隐私壁垒如何突破？“90.2% 准确率” 的测试样本量、场景复杂度为何未披露？这些疑问源于行业对 “AI 落地真实性” 的基本要求 —— 如果连数据合规性、技术指标可验证性都不能谈，那 AI 产品的 “商业交付能力” 又该如何评判？</li>
<li>我甚至在文中明确提到：“钉钉押注垂直战略，有其在通用 AI 赛道竞争劣势的无奈”—— 这恰恰是对其战略选择的客观理解，而非 “贬低”。我反对的从来不是 “做垂直 AI”，而是 “未夯实基础就急于跳级” 的冒进：连 “制造钉识别订单延迟”“AI 听记无法多语言翻译” 这类通用办公基础问题都没解决，却宣称能攻克 “临床精准决策” 这类高难度场景，这样的逻辑漏洞，难道不该被指出？</li>
</ul>
<h2 data-id="heading-1">二、再谈 “品牌形象”：真正的品牌价值，从正视问题开始</h2>
<p>钉钉投诉中提到 “对品牌形象造成损伤”，但在我看来，一个企业的品牌形象，从来不是靠 “屏蔽不同声音” 建立的，而是靠 “解决真实问题” 赢得的。我承认，钉钉 AI1.1 的发布有其突破性 —— 比如 Agent OS 试图搭建 “AI Agent 生态底座” 的思路，DingTalk Real 针对企业数据安全的硬件尝试，这些都是值得肯定的探索。但 “有亮点” 不代表 “无问题”：</p>
<ul>
<li>当钉钉承诺 “支持 1000 个生态伙伴打造专属模型” 时，行业更关心的是 “中小企业如何承担 500 万起的硬件投入 + 20% 年维护成本”？我提出 “成本门槛拦住中小企业”，不是为了否定生态计划，而是希望钉钉能给出更具体的普惠方案 —— 毕竟，企业服务赛道的核心价值，从来不是 “服务头部企业”，而是 “让更多中小企业用得起 AI”。</li>
<li>当钉钉说 “要覆盖医疗、制造、办公等全场景” 时，我担忧的是 “2 亿月活的市场支配地位是否会挤压中小开发者”？这不是我个人的猜测，而是平台经济的普遍规律：当头部平台凭借流量优势全面介入垂直领域时，第三方开发者的流量曝光、资源支持如何保障？钉钉生态中 “80% 头部服务被阿里系垄断” 的行业观察，难道不该被拿出来讨论，以推动更公平的竞争环境？</li>
</ul>
<p>这些疑问，本质上是 “希望钉钉的战略能走得更稳”，而非 “要损害其品牌”。如果说 “指出问题” 就是 “贬低”，那行业里岂不是只剩下赞歌？可没有批评的监督，AI 产品如何避免 “概念炒作”，真正落地到企业的真实需求里？</p>
<h2 data-id="heading-2">三、最后谈 “言论自由”：行业观察者的责任，是敢说真话</h2>
<p>钉钉投诉中未提及，但我必须强调的一点是：“讨论行业垄断” 是业内人士的基本言论自由，更是对市场健康的责任。企业服务 AI 赛道正处于关键期，无论是钉钉、飞书还是其他玩家，都在探索未来的方向。这个过程中，必然会有战略失误、生态漏洞 —— 而观察者的价值，就是把这些 “看不见的问题” 摆到台面上，让行业在讨论中找到更优解。我从未否认钉钉在协同办公领域的贡献，也期待它能在垂直 AI 赛道做出成绩。但我更希望，钉钉能把 “投诉” 的精力，放在回应这些真实问题上：比如如何解决高质量行业数据的供给难题？如何降低中小企业的 AI 使用成本？如何给第三方开发者更公平的生态位置？这些问题的答案，远比一份投诉函更能提升品牌形象，也更能推动整个赛道的进步。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d91d2b5c07f041e19c05d8aa40232f4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161467&amp;x-signature=fsyh3XOflzavhph54TbNJZexYnc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-3">尾声：期待一场理性的对话，而非对抗</h2>
<p>写下这些话，不是为了和钉钉 “争对错”，而是想传递一个态度：行业的发展需要多元声音，既需要企业的创新探索，也需要观察者的理性监督。如果钉钉愿意，我很乐意就 “垂直 AI 战略” 的细节展开更深入的交流 —— 比如一起探讨医疗数据合规的路径，一起测算中小企业的 AI 使用成本模型。毕竟，我们的目标是一致的：让 AI 真正帮到企业，让这个赛道变得更好。也想对关注这篇文章的朋友说：未来我依然会保持客观的立场，分析更多企业服务 AI 的案例。因为我相信，敢说真实的问题，才是对这个行业最大的尊重。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：路由与中间件]]></title>    <link>https://juejin.cn/post/7585888537642418191</link>    <guid>https://juejin.cn/post/7585888537642418191</guid>    <pubDate>2025-12-22T03:02:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585888537642418191" data-draft-id="7585888537642401807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：路由与中间件"/> <meta itemprop="keywords" content="后端,Node.js,前端"/> <meta itemprop="datePublished" content="2025-12-22T03:02:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：路由与中间件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:02:41.000Z" title="Mon Dec 22 2025 03:02:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Node.js Web 开发中，路由与中间件是构建应用的两大核心机制。路由负责将请求分发到具体的业务处理逻辑，而中间件则负责在请求处理过程中执行通用操作。二者相互配合，构成了 Express 等框架的运行基础。</p>
</blockquote>
<p>理解路由匹配规则和中间件执行顺序，是写好 Node.js 服务端代码的关键。</p>
<hr/>
<h2 data-id="heading-0">一、什么是路由</h2>
<p>路由用于描述请求路径与处理函数之间的映射关系。一个完整的路由通常由请求方法、路径和回调函数组成。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'user list'</span>);
});
</code></pre>
<p>当客户端以 GET 方法访问 <code>/users</code> 时，Express 会执行对应的处理函数。</p>
<hr/>
<h2 data-id="heading-1">二、路由匹配规则</h2>
<p>Express 的路由是按<strong>定义顺序</strong>进行匹配的。一旦匹配成功，后续路由将不会再被执行。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users/:id'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>);
});
</code></pre>
<p>动态路由可以通过参数的形式获取路径中的变量，这在资源型接口设计中非常常见。</p>
<hr/>
<h2 data-id="heading-2">三、路由拆分与模块化</h2>
<p>在项目规模扩大后，将所有路由写在一个文件中会导致代码难以维护。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();

router.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'user list'</span>);
});

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = router;
</code></pre>
<p>通过路由模块化，可以让项目结构更加清晰，职责更加明确。</p>
<hr/>
<h2 data-id="heading-3">四、中间件的基本概念</h2>
<p>中间件本质上是一个函数，用于在请求进入路由之前或响应返回之前执行逻辑。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>);
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>中间件可以访问请求对象、响应对象，并决定是否继续传递请求。</p>
<hr/>
<h2 data-id="heading-4">五、中间件的执行顺序</h2>
<p>中间件按照<strong>注册顺序</strong>执行。</p>
<ul>
<li>全局中间件优先执行</li>
<li>路由级中间件按顺序执行</li>
<li>错误处理中间件最后执行</li>
</ul>
<p>一旦中间件没有调用 <code>next</code>，请求链将被中断。</p>
<hr/>
<h2 data-id="heading-5">六、常见中间件使用场景</h2>
<p>中间件通常用于处理通用逻辑，例如：</p>
<ul>
<li>请求日志记录</li>
<li>参数校验</li>
<li>用户认证与权限控制</li>
<li>请求体解析</li>
<li>跨域处理</li>
</ul>
<p>将这些逻辑从业务代码中抽离，可以显著提升代码可读性。</p>
<hr/>
<h2 data-id="heading-6">七、路由级中间件</h2>
<p>除了全局中间件，还可以为特定路由添加中间件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">auth</span> = (<span class="hljs-params">req, res, next</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">headers</span>.<span class="hljs-property">token</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'unauthorized'</span>);
  }
  <span class="hljs-title function_">next</span>();
};

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/profile'</span>, auth, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'profile'</span>);
});
</code></pre>
<p>这种方式可以实现精细化的权限控制。</p>
<hr/>
<h2 data-id="heading-7">八、错误处理中间件</h2>
<p>Express 提供了专门的错误处理中间件形式。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'server error'</span>);
});
</code></pre>
<p>集中处理异常，有助于统一错误返回结构。</p>
<hr/>
<h2 data-id="heading-8">九、next 的使用注意事项</h2>
<p><code>next</code> 用于将控制权交给下一个中间件或路由。</p>
<p>需要注意：</p>
<ul>
<li>不调用 <code>next</code>，请求将被阻塞</li>
<li>调用 <code>next(err)</code> 会直接进入错误处理中间件</li>
<li>避免重复调用 <code>next</code></li>
</ul>
<p>合理使用 <code>next</code> 是中间件设计的核心。</p>
<hr/>
<h2 data-id="heading-9">十、路由与中间件的协作模式</h2>
<p>在实际项目中，常见的协作方式是：</p>
<ul>
<li>中间件负责通用逻辑</li>
<li>路由负责业务分发</li>
<li>控制器负责业务实现</li>
</ul>
<p>这种分层设计有助于项目长期维护和扩展。</p>
<hr/>
<h2 data-id="heading-10">十一、总结</h2>
<p>路由和中间件是 Node.js Web 框架中最重要的基础设施。路由决定请求走向，中间件决定请求如何被处理。只有真正理解它们的执行机制和设计思路，才能写出结构清晰、易维护的服务端代码。</p>
<p>在项目初期建立合理的路由和中间件体系，将为后续功能扩展打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨端RN 与 浏览器Web 的 长渲染性能 差异 与 底层 揭秘]]></title>    <link>https://juejin.cn/post/7587008326481166378</link>    <guid>https://juejin.cn/post/7587008326481166378</guid>    <pubDate>2025-12-24T06:13:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587008326481166378" data-draft-id="7586939930155057195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨端RN 与 浏览器Web 的 长渲染性能 差异 与 底层 揭秘"/> <meta itemprop="keywords" content="前端,WebGL,React Native"/> <meta itemprop="datePublished" content="2025-12-24T06:13:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="July_lly"/> <meta itemprop="url" content="https://juejin.cn/user/2975757420726467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨端RN 与 浏览器Web 的 长渲染性能 差异 与 底层 揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2975757420726467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    July_lly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:13:52.000Z" title="Wed Dec 24 2025 06:13:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body ::selection{color:#fff;background-color:#ed7373}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:.6em;margin-top:1.5em;padding-bottom:4px;color:#ed7373}.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5,.markdown-body h6{font-size:14px}.markdown-body p{line-height:inherit;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border-top:1px solid #dfe1e6;margin:33px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:rgba(239,198,221,.2666666667);color:#7b164f;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==") 10px 10px no-repeat;background-size:40px;background-color:#fdf8f8}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#fdf8f8}.markdown-body a{position:relative;text-decoration:underline;text-decoration-color:#ffd4d4;color:#ed7373;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAAAXNSR0IArs4c6QAAD1lJREFUeF7tnV122zgShQHJG5gT9/OkV2J7JR3voI/U707eI5/eQeyVRFlJa56nc2YDFjkHEulWHP3g5xZYAK5eku6QYOFWfSwUAJLW8EcFqMBJBSy1oQJU4LQCBITRQQXOKEBAGB5UgIAwBqhAnALMIHG68axGFCAgjTia3YxTgIDE6cazGlGAgDTiaHYzTgECEqcbz2pEAQLSiKPZzTgFCEicbjyrEQUISCOOZjfjFCAgcbrxrEYUICCNOJrdjFOAgMTpxrMaUYCANOJodjNOAQISpxvPakQBAtKIo9nNOAUISJxuPKsRBQhII45GdfN/v//+/l9//rlBtae9HQKi3UOZ7ft7sfhgjfm3sfa9u3RvzHtrjPv77r8PfpvemB0o1v3Z95tuNvt29fKyqQkgApI5ADVebgeFtTfGmA8I+3pj1rbv17Ouey4dFgKCiIgC2/i+WDwYax0QbzMDtDcjLC67/PL58xraeIbGCEgGkTVd4vty+QWVKUL75WCZb7f3JWUVAhLq5UKPHzLGRyXmP822208lgEJAlESMlBlDfeGyhsafelAIiMawAdjkpmO38/kXa8wtoDnRJvq+v79+fHwSvUhk4wQkUjjNp/33jz9uZ33/VbONP9nW9x/fPT5+0mYzAdHmkUR7lNUaob1RN+QiIKEuVHz838vl1xKGVOck1DbTRUAUB7yvaSXVG5592sy22zsNs1wExNNjWg+rEI5XqWfb7a9TQ0JAtEa+h101wzF0f/JMQkA8AlHjIQ3AMco+KSQERGP0X7CpITj2Skw4BUxACgOkOThG/0wECQEpCJBm4Rh81Fl7l3tHMAEpBJCJ4Hjq+/7bvOt229THGSVny8vV1W6b/Kzrbnprb088VAVXN/fMFgGBuxDfYE443L4oB0TM9OqwxcVtjJR7xiTzUIuA4OMZ2mI2OICBN+wgfpACJWcWISDQcMY2lgMOt7XjerW6w1q+b03sqUUgzJf6TUAuKTTRv+eAI8f0qdSwK1cWISATAXDusjngyDkj5PrTzedu+z2uNsmURQiIMkBqg2OUVwKSHFmEgCgCpFY4xCDJkEUIiBJAaodjlBlZuEtOMIz2EhAFgLQCxxtIIG9YkR5mEZCJAWkNjldIlsu/EEW79AsfCMiEgLQKx8EaCSKLPL1bre6l3EhApJS90G7LcKCziOQwi4BMAAjh+GGlPTmLSK7pEJDMgBCOfwRHvb9Lsg4hIBkBIRw/i/0dUawLrocQkEyAEI7jQoPeNi9WqBOQDIAQjtMig16uTUAyxLHIJQjHeVkRdYjkijoziAgW+0YJx2VxEYAYYzbvVqtfL18t/AgCEq6Z1xmEw0um3U2km8/dqnrS791qJRLLIo0m9bSCkwmHvxNBgDCD+Es+7ZGEI0x/DrHC9Cr6aMIR7j7ELBaL9HDds59BOOIkB33wh9O8cfLnOYtwxOsM+egPV9LjHSB9JuFIU/j7ctmntSD7cmvOYiV6B3IHPGOD5E7VxK4nnw4q0A03Kya7QqYBwpGmK6j+MFJrIK53zCCRPgZtsjt59Zozh+s0aP3DNSW2BkJAIuFATE2eu3TtcLi+w24wggU6AYkABDVuPnXpFuAAZg8jrReHWAGQIB177LLSzg7oqtih4Dcsig6vmEECw0CyKG8BDic3VEPh4RUBCQAENePSaubY1R2LxYOxNvklDa8aEpCACBY+FLKgdcTGZjLHYvHBWuu+PoX6iQ+vmEE8XQW/8w3XJRyeDjhymOTi4OHlWKRf8JFUYU444uGQXvsgIAG+kcgesXAM6y83/fAhGtv36242+5b708i+8kmtF+XKHhxiTZA9YuDwCLSn2Xb7KebLtL7BHnqch82hTY7HZ6k9xotxiHXGTejsEQXHcvnVGnPrEU2b2XZ7pwESQTjEFwbf6kxAzgGCeOvf2H7ElGQMoDmHH8ekk4RD8snBU2FAQE4oAy7Og594S7p+BIweGeriIZJw5CzMWaRfdDV0UStqzByTPX7oVt9/nHXdc64hV41wsEjPMLyKqTucWZAtGZkyiTAc2esOZpBMs1cpY2bIW89dP4UhkYZj6pqKNcgRWFBb2lO+fAQDxBiTYse5e4k0HMaY4NrNY/QcdAgBOSJX8vjf3biNWV+vVndB3jg4GPZA0b5N+BSwNByp+sXqzmleD+UQgMTWHqN5AgEIg0TAtrdemTxzjAYxgxzLIMul23X6wYOlU4dEzVy9bQw5zNq1DahHpOGYuuZgBvGI+uQZJEAgOjOHWsjB+t7DbK9DUgIQkVnPGZmadb0ECDyIGeR4Bkl6mRnS0WhIYsf2LcLhQoOACACCfk8T+Dnu4BetJa3qe9yxkTcUj8sFHUJAjgPiPugSO6yB1B9vzUJCEppFBLPHprP2Xut2fWaQE/eSxOJYBJDR1ETbXnscUosk12THdVYPBwE5AUhiQIgCAswk3tO+As/ji2oUNIa6cDCHWOBp3tDhS4wzUZD4ZhEkIDn0idH01DkEBAyIaw5dpB9zHqgu8FqQgw3rEncXIAPft60qAXF32JRt3qnBJ7X36a1TUwPX926O2Pbiey3fwM11XBWADGsFv5n9o6m72SfnkJ2Iff98/fj4FCJo6mpxrmnLVJCdJj4wp+pRKhxVFOmeBXXwSw2S7s6glXQfqJPs3N0/+nufG0jCdbyGcT59neKYYjNIxKfPvGdtnCM8wTvpM587M8LhgOGPVwDHTAz4wofQQaqNIgGJgGOvX8CdPXVYEXKtFOcm2+k5zHI2hmx7yTXMTNHO59ziAEne9uAJCeChqaCM5eOsY8cA7PSqQw6vPWSt13rvjV1PnbXPmlfHQ7QuChBEMIQUjAnj7uCMFeI09GxW7N1+54+uuxkmRf4z77p1yuxhigZS5xYDCAKOUUTfdQrELFGOoVZqvRQLiFRQamq3CECQcPhObY5OSs4iATNFsYGRamMNxXSsdpfOUw8IGg4nSMgdE5JFhCEhIJfCPP7fVQOCmKE5Ik3wRrnUABxtkLpTJ9vnOXERH2blnqkWECE4ot42gsoiodnLN6wAmwm91kJ87anpOJWAABa/Tvso8m6ZfJf+xyLo9G/ytPduCqr/+O7x8VNNgY3qizpAROEwJnh4NQodskh20TnAgITUaEB7Lva9sANUAZI6XXlB++Q7N3KohdqKgrApZNKisPhONlcNIMJwBM1cnVMVEZDIWgShGwrW5GhU2IAKQBBOPqct+g4JqUcAwxpI/ZHpAS+Fse9l0qSARG869Ora/iA0HK7NmJ2tP5kMAASUzaLrsgA3FHvopICUljkOvZwKCQJcRCYL2ZtWbJQnGD4ZICXDMeo93MHdO3yD36Hlux/slG8hs1ec4r2IziSAgIYGJzuHuDtfVG44IGr6FzG8An1gNKdWvppqOi47ILA73wkVp3B4ICTJY37gDSbZFk3BLGFLVkBQsy6nhJgCjtEWn5oEMd6HagjIZBJBqanNbIBAHXtEwSnhODRn2EP2MPy/sTaBPWWHrN20aKYJiLe2ZANEcguJVkenvp/rrbOQcEz13XHNMByzLQsgktlDKxzoQADWHXvTOLzyclEWQMB3vteOtQKHxNZ/bi/x4kP+AzpS2YNw+Dn46FHMHt7iiWcQiexBOLz9e+xATu0GyCcKiMSaB+EI8O6xQ5k9ggQUBQSxV+iwN4QjyLfMHslyCX7EE157NHLnkyjIxziRemkEIA7VNiGWQcDTkk28VEAUjgI/XqOBGjFAgMV5E0WlJBxcFIxHTQQQ5PCqhbpDGo7ZdntX2ztz40M+7EwRQICzV9VnD2E4RJ6oDAuxso8WAQRVf9S+2isNB4vydDhlAFku+3TT4t9hBbi2eBPScBhjmpjYkHaUXkAqntaVhgPx3Il04JXSPhwQVIFe6/CKcJSCxt5OrYBUWZwTjrLgEAEEMYNV4xCBcJQHhwggoECoqsAEaXIywmq8oWjBCT7EgkzxVlSgEw4toR5nBwGJ083rLMLhJZPqg/CALJdfjDHubYPxvwoyCOGId7+mM+GAgAKj6BoEpAFrDgWkqASk5KKTcCiIaqAJcEBanuYlHMDIVNIUHJBWV9IJh5KIBpsBB8TZB/gssSlpJyrhAEelouakAPkr5psZb3QpolAnHIqiWcAUEUBQj9tq37BIOAQiUlmTMoAsFh+stW49JO2neD2EcKS5tpSzRQBBzGSNAmrMIoSjlPBOt1MEkKFQR9Qh6t5CTjjSg66kFiQBSd9yMiqpZKhFOEoKbYytYoAgh1muq1MPtQgHJuBKa0UMEOgwa6/qZqr3OxGO0sIaZ68sIIvFg7H2I87c/JBAnm85I0DJ+86AflXblCggAlkkayZBreec8j7hUMvFq2HygOCzyM54ya0obj/Zdj7/Yo25lXIh4ZBSFtuuOCBCWWQPiTHr+XZ7j3zvrHS9Mdp9vVrdYV3J1iQUyAOIUBY5EORptt1+SgFlAMN933z8trmE3juoCYeItCKNZgFEMoscquKCz/b9etZ1zz6wDFDcmP1QShQMZg6R+BVvNBsgw7qIWzwUD8RBtU1vzMb93Q5/DkH63u5tyGXH63CQmUM8nuEXyAbILovID7XgAiEa5LAKoeI0bWQFpEVICMc0gY26anZActUjKIFS2iEcKerpOHcSQIbn1r/mrgNySk44cqotd61JAHHdqRkSwiEXsLlbngwQ19EJZrbE9SUc4hJnvcCkgFQHiZLnVrJGUOUXmxyQUV/pjYHSfmzhc9XSGmpsXw0gBU8Bbzpr73/5/Hmt0cG0KU0BVYAcQOLeDp91pTtGRtYbMaqVdY46QMa6xPb9g+R282Q3sd5IlrCEBlQCMgqndJariDc+lhB8JdioGpDXAn7/IjrxregXHJa8pb6EgKCNPypQBCATg0IwGqamKEB+GHp13U1v7a3Q1vWnvu+/XT8+PjUcG+z6/lGJ8n+uVhmK+nHmK2QGzD0zsnZAzLtu7fOgVfmKsQe+ClQByLHOur1eL1dXO1Bs170C089mm6uXl92DVITBN0zaPa5aQNp1KXuOVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFTg//8JNVC78ovQAAAAAElFTkSuQmCC");background-size:100%}.markdown-body a:active,.markdown-body a:hover{opacity:.66}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #ed7373;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#ed7373}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#fdf2f2}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #ed7373;background-color:#fdf2f2}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ed7373}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{appearance:none;-webkit-appearance:none;-moz-appearance:none;outline:none;width:16px;height:16px;border-radius:2px;background-color:transparent;box-shadow:inset 0 0 0 1px rgba(28,31,35,.3490196078);vertical-align:middle;margin:0;transform:translateY(-2px)}.markdown-body input[type=checkbox]:checked{background-color:#ed7373;background-image:url("data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjFlbSIgaGVpZ2h0PSIxZW0iIGFyaWEtaGlkZGVuPSJ0cnVlIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTE3LjQxMSA3LjMwOGExLjUgMS41IDAgMDEuMjggMi4xMDNsLTYuNSA4LjVhMS41IDEuNSAwIDAxLTIuMzc1LjAxbC0zLjUtNC41YTEuNSAxLjUgMCAxMTIuMzY4LTEuODQybDIuMzA2IDIuOTY1IDUuMzE4LTYuOTU1YTEuNSAxLjUgMCAwMTIuMTAzLS4yOHoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=");box-shadow:inset 0 0 0 1px #ed7373}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">背景</h2>
<p>从入职以来，我一直在参与一个跨端项目的开发，主要技术栈是 <strong>React Native</strong>。在这期间，也不可避免地接触了一些原生能力，比如陀螺仪、手势、生命周期等。</p>
<p>最近，我们开始调研一个问题：<br/>
<strong>在 App 中，如何实现“持续长时间的动态渲染”？</strong></p>
<p>这里说的“持续长渲染”，并不是指一次性的动画效果，而是类似以下场景：</p>
<ul>
<li>Keep 中的跑步轨迹持续绘制</li>
<li>导航 App 中路线与视角的实时跟随</li>
<li>地图、雷达、3D 角色、桌面宠物等长时间存在、持续运动的画面</li>
</ul>
<p>这些场景的共同点是：</p>
<blockquote>
<p><strong>画面会在很长时间内持续更新，并且帧与帧之间存在状态延续。</strong></p>
</blockquote>
<p>一开始我并没有理解这个“状态延续”的原理，只是单纯觉得：<br/>
<strong>不就是一直画吗？</strong></p>
<hr/>
<h2 data-id="heading-1">Skia</h2>
<p>既然我们本身是 RN 项目，又不想引入 WebView，那最自然的选择就是找“原生渲染能力”。</p>
<p>在 RN 社区里，第一个跳出来的就是 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fskia.org%2F" target="_blank" title="https://skia.org/" ref="nofollow noopener noreferrer">Skia</a></strong>。</p>
<p>Skia 是一个由 Google 主导的开源图形渲染库，主要用于 <strong>高性能 2D 图形绘制</strong>，底层使用 C++ 实现，被广泛应用在 Chrome、Flutter、Android 系统组件中。</p>
<p>在 RN 中，我们通常会通过引入 <code>@shopify/react-native-skia</code> 来使用它。</p>
<h4 data-id="heading-2">为什么一开始觉得它很合适？</h4>
<p>说实话，<a href="https://link.juejin.cn?target=https%3A%2F%2Fskia.org%2F" target="_blank" title="https://skia.org/" ref="nofollow noopener noreferrer">Skia </a>看起来几乎是“标准答案”：</p>
<ul>
<li>原生级性能</li>
<li>GPU 加速</li>
<li>不走 WebView</li>
<li>API 类似 Canvas</li>
</ul>
<p>而且它的优化十分到位会把<strong>把绘制这件事直接下沉到 C++</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a47a62f9ca1c4865af554869957e5d02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=xeOf7YgOEKhHTIX1GfcEj%2FLffEM%3D" alt="image.png" loading="lazy"/></p>
<p>在最开始的设想中，我甚至觉得：</p>
<blockquote>
<p>“只要把动画逻辑写好，Skia 负责画，应该就很稳了。”</p>
</blockquote>
<p>但真正开始往“长时间动态场景”上靠的时候，问题慢慢暴露了。</p>
<h4 data-id="heading-3">问题并不是性能，是匹配度</h4>
<p>Skia 本质上是一个以 <strong>2D 图形管线为核心设计的渲染引擎</strong>。<br/>
它非常擅长一件事：<strong>把你给它的东西画出来，而且画得很快</strong>。</p>
<p>但它并不负责：</p>
<ul>
<li>场景管理</li>
<li>相机系统</li>
<li>空间关系</li>
<li>世界状态的持续演进</li>
</ul>
<p>换句话说：</p>
<blockquote>
<p><strong>Skia 的核心能力是“绘制”，而不是“场景”。</strong></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2763d5a8561845cb8a334ce43433185b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=Xfi%2Fgs8r%2F8nhhyR1bV%2BxdtS8dlg%3D" alt="Adobe Express - skia1.gif" loading="lazy"/></p>
<p>当画面开始需要「持续运动」「围绕轨道旋转」「跟随某个路径」时：</p>
<ul>
<li>每一帧的位置要 JS 算</li>
<li>每一帧的变化要 JS 推</li>
<li>每一帧的绘制触发，还是 JS</li>
</ul>
<p>只要 JS 线程被打断——<br/>
比如 RN 正在处理手势、列表滚动、setState——<br/>
画面就会立刻卡住。</p>
<p>到这里我才意识到：<br/>
<strong>Skia 并不是慢，它只是不解决我现在遇到的这个问题。</strong></p>
<hr/>
<h3 data-id="heading-4">Expo GLView + Three.js</h3>
<p>既然 Skia 偏 2D，那自然就会往 3D 方向走。</p>
<p>在 RN 生态里，最常见、也是最“官方”的 3D 组合基本就是：</p>
<ul>
<li><code>expo-gl</code>（GLView）</li>
<li><code>expo-three</code></li>
<li><code>three.js</code></li>
</ul>
<h4 data-id="heading-5">这个方案是怎么工作的？</h4>
<p>Three.js 在 Web 端已经非常成熟了。但真正梳理它的执行流程时，会发现它在expo的工作其实是这样的：</p>
<pre><code class="hljs language-scss" lang="scss">JS 创建 GLView  
⬇️  
JS 初始化 Three<span class="hljs-selector-class">.js</span> Scene / Camera / Mesh  
⬇️  
JS 启动 requestAnimationFrame  
⬇️  
每一帧：  
JS 计算动画  
→ renderer<span class="hljs-selector-class">.render</span>  
→ 手动调用 gl<span class="hljs-selector-class">.endFrameEXP</span>()
</code></pre>
<p>如果只是让 GLB 模型在场景中做位移、绕轨道运动，在刻意降低帧率（比如 10～20fps）的情况下，整体是“能看”的，甚至看起来还算流畅。
这类运动有一个共同点：
<strong>每一帧只是“位置在变”，模型本身并没有发生结构或尺度上的变化。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72cf1184c2da49c2b5f1f9982494bb97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=1W87mgjyxKmsn0GRFsamvXBhiqQ%3D" alt="GLBs.gif" loading="lazy"/></p>
<p>但当我尝试对 <strong>同一个 GLB 模型直接做缩放（scale）动画</strong> 时，情况立刻变了。哪怕动画逻辑非常简单，只是不断放大 / 缩小，画面会出现非常明显的：抖动，掉帧，“一卡一卡”的感觉。而且这种卡顿，并不是偶发的，而是<strong>稳定复现的</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9e03f77cc9342dea1438a211b24a834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=dOMk0VZvrO2ir%2FZJttk%2BzLI59VE%3D" alt="Adobe Express - GLB.gif" loading="lazy"/></p>
<h4 data-id="heading-6">什么原因导致这样的</h4>
<p>后面我想都是一样的使用 RN + GLView + threeJS，认为交互的问题，或者是GLB文件的特性</p>
<h5 data-id="heading-7">位移动画为什么还算流畅？</h5>
<p>模型位移时：</p>
<ul>
<li>只是更新 <code>position</code></li>
<li>变换矩阵相对简单</li>
<li>Three.js 内部状态变化较少</li>
<li>JS 每一帧传递的数据也很有限</li>
</ul>
<p>在 <strong>低帧率 + 匀速运动</strong> 的情况下，人眼会帮我们“脑补连续性”，<br/>
于是看起来还算顺。</p>
<h5 data-id="heading-8">scale 动画为什么这么容易卡？</h5>
<p>scale 动画在 Three / GLView 这一套里，成本要高得多：</p>
<ul>
<li>每一帧都要重新计算变换矩阵</li>
<li>scale 会影响子节点、包围盒、裁剪判断</li>
<li>渲染管线状态变化更频繁</li>
<li><strong>JS → GL 的同步压力明显变大</strong></li>
</ul>
<p>这些变化都只能由 JS 在每一帧明确告诉底层怎么去渲染。只要 JS 线程被 RN 抢走一瞬间：手势
，setState，Layout，Bridge调度在这一帧就丢失了。</p>
<p>因此这并不是交互本身的问题，也不是 GLB 模型复杂度导致的性能瓶颈。<br/>
本质原因在于 <strong>在 RN + GLView 架构下，动画状态的更新与帧的推进完全依赖 JS 线程驱动</strong>。<br/>
一旦 JS 线程被其他任务占用，渲染帧就无法按时推进，画面便会直接卡顿。</p>
<h2 data-id="heading-9">为什么 Web 中的 scale 看起来这么轻松？</h2>
<p>回答问题前我们先分别看一下web上的位移动画和Scale动画效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54c9e7fd9d8d421982c46a5e9dd32edc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=bUZrUQw7imxEin1FGHzllZxxTek%3D" alt="webGLB1.gif" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18e48d940bfe48c490c6ec645a671bab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVseV9sbHk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767161988&amp;x-signature=DfvyA9OoHUojj%2FF98AcNXb9dhg8%3D" alt="webGLB2.gif" loading="lazy"/></p>
<p>差距有点大......都是 GL+threeJS的背景，那为什么造成了这个原因呢？</p>
<h3 data-id="heading-10">浏览器的优化</h3>
<p>上面我们看到，在 RN 的跨端框架中：</p>
<blockquote>
<p><strong>渲染是否发生、何时发生、以及下一帧画什么，几乎完全依赖 JS 线程逐帧驱动。</strong></p>
</blockquote>
<p>而在 Web 环境中，即使我们使用的是 <code>WebGL + Three.js</code>，<strong>渲染帧的推进并不完全依赖 JS 线程</strong>。
换句话说：浏览器并不是“每一帧都等 JS 算完再画”，而是“只在必要时才叫 JS 介入”。</p>
<p>当一个动画被启动后：</p>
<ul>
<li>Three.js 将物体的变换参数（position / scale / rotation）</li>
<li>以及对应的矩阵更新逻辑</li>
<li>提交给浏览器的渲染管线</li>
</ul>
<p><strong>只要动画逻辑本身是“连续的”</strong> （例如匀速位移、缩放、插值动画），</p>
<blockquote>
<p><strong>帧调度与合成始终由浏览器主导，JS 只是参与者，而不是驱动者。</strong></p>
</blockquote>
<ul>
<li>JS 线程只负责 <strong>初始状态与关键参数变更</strong></li>
<li>帧调度、vsync 对齐、GPU 提交由浏览器统一完成</li>
</ul>
<p>因此即便 JS 出现短暂阻塞，画面也不会立刻停住</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWindow%2FrequestAnimationFrame" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Window/requestAnimationFrame" ref="nofollow noopener noreferrer">RAF MDN地址</a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FPerformance%2FGuides%2FCritical_rendering_path" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Performance/Guides/Critical_rendering_path" ref="nofollow noopener noreferrer">Rendering pipeline</a>
这里面可以看到web中的RAF是由浏览器去调度的，即使 JS 线程短暂阻塞，浏览器仍可能复用上一帧的状态让 GPU 进行合成。</p>
<h2 data-id="heading-11">结尾</h2>
<p>在 Web 环境中，即便动画是匀速移动或连续旋转，GPU 并不需要每一帧都等 JS 计算完成才能渲染下一帧。只要 JS 在动画开始时提供了<strong>初始状态、速度、旋转轴等信息</strong>，浏览器的渲染管线就能利用这些已有状态持续推进动画。换句话说：</p>
<ul>
<li><strong>Web / Three.js + WebGL</strong><br/>
JS 负责一次性设置参数 → GPU 自行渲染 → 即使 JS 暂时阻塞，动画也不会瞬间停住，而是继续使用已有状态进行渲染。就像导演指挥好演员动作后，摄影机自己拍摄电影。</li>
<li><strong>RN / Expo GLView + Three.js</strong><br/>
GPU 并没有独立推进动画的能力，每一帧都需要 JS 告诉它物体的新位置和旋转。JS 线程一旦阻塞或计算过重，画面就会卡住或掉帧。像导演必须每一帧都手把手指挥演员，任何停顿都会影响拍摄。</li>
</ul>
<blockquote>
<p><strong>核心差异</strong>：Web 的 GPU 可以“复用上一帧状态继续播放”，而 RN 的 GPU 渲染完全依赖 JS 线程逐帧驱动。</p>
</blockquote>
<p>这一点也解释了为什么同样的 GLB 模型、同样的 Three.js 代码，在浏览器里顺滑，但在 RN 里高 FPS 动画很容易卡顿。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Agent】MemOS 源码笔记---(7)---MemScheduler 细节]]></title>    <link>https://juejin.cn/post/7586479864272093190</link>    <guid>https://juejin.cn/post/7586479864272093190</guid>    <pubDate>2025-12-22T12:27:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586479864272093190" data-draft-id="7586491717873270803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Agent】MemOS 源码笔记---(7)---MemScheduler 细节"/> <meta itemprop="keywords" content="算法,人工智能,机器学习"/> <meta itemprop="datePublished" content="2025-12-22T12:27:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Agent】MemOS 源码笔记---(7)---MemScheduler 细节
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:27:13.000Z" title="Mon Dec 22 2025 12:27:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Agent】MemOS 源码笔记---(7)---MemScheduler 细节</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 摘要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 组件关系</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 实现</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.1 GeneralScheduler</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.2 SchedulerDispatcher</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.3 SchedulerRetriever</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x03 关联</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.1 SchedulerDispatcher 和 GeneralScheduler</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 GeneralScheduler 和 TreeTextMemory</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.3 总结</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.4 MosCore</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 摘要</h3>
<p>记忆调度就像大脑的注意力机制，动态决定在合适的时刻调用合适的记忆。</p>
<p>在 MemOS 中，<strong>记忆调度（Memory Scheduling）</strong> 通过对【不同使用效率（参数&gt;激活&gt;工作&gt;其他明文）的记忆】的相互调度，让模型能更高效、准确地获取用户所需的记忆。在对话和任务进行时，通过预测用户后续对话所需记忆并提前调入高效率记忆类型如激活记忆工作记忆，加速推理链路。</p>
<p>记忆调度的具体实现就是MemScheduler ，这是一个与 MemOS 系统并行运行的并发记忆管理系统，它协调 AI 系统中工作记忆、长时记忆和激活记忆之间的记忆操作。它通过事件驱动调度处理记忆检索、更新和压缩。该系统特别适合需要动态记忆管理的对话代理和推理系统。</p>
<p>备注：本文基于MemOS的文档和源码进行学习，似乎其文档并没有跟上源码更新的速度，而且也有部分功能未实现或者未开源。</p>
<p>前一篇介绍了 MemScheduler 的总体概念，本篇来看看实现细节。</p>
<h3 data-id="heading-2">0x01 组件关系</h3>
<p>最核心的几个组件关系如下：</p>
<ul>
<li>GeneralScheduler 是整个调度系统的核心组件，继承自 BaseScheduler，负责处理不同类型的消息（查询、回答、添加等），并协调其他组件完成具体任务。</li>
<li>SchedulerDispatcher 是消息分发器，负责将不同类型的消息分发给对应的processor，支持并行处理（可选）。</li>
<li>SchedulerRetriever 是记忆检索器，负责从记忆库中搜索、重排序和过滤记忆项，提供智能记忆管理功能。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fb95ef5952641588c8a4a6f509f27c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=YBjKu%2BcIbu8HAkKtkVLsesWCWTE%3D" alt="MemScheduler-7-1" loading="lazy"/></p>
<p>MemScheduler-7-1</p>
<p>MemOS-main\src\memos\templates\mem_scheduler_prompts.py 中可以看到使用的prompt。</p>
<pre><code class="hljs language-makefile" lang="makefile">PROMPT_MAPPING = {
    <span class="hljs-string">"intent_recognizing"</span>: INTENT_RECOGNIZING_PROMPT,
    <span class="hljs-string">"memory_reranking"</span>: MEMORY_RERANKING_PROMPT,
    <span class="hljs-string">"query_keywords_extraction"</span>: QUERY_KEYWORDS_EXTRACTION_PROMPT,
    <span class="hljs-string">"memory_filtering"</span>: MEMORY_FILTERING_PROMPT,
    <span class="hljs-string">"memory_redundancy_filtering"</span>: MEMORY_REDUNDANCY_FILTERING_PROMPT,
    <span class="hljs-string">"memory_combined_filtering"</span>: MEMORY_COMBINED_FILTERING_PROMPT,
    <span class="hljs-string">"memory_answer_ability_evaluation"</span>: MEMORY_ANSWER_ABILITY_EVALUATION_PROMPT,
}
</code></pre>
<h3 data-id="heading-3">0x02 实现</h3>
<h4 data-id="heading-4">2.1 GeneralScheduler</h4>
<p>BaseScheduler是基类，而GeneralScheduler才是真正起作用的派生类。</p>
<p>GeneralScheduler采用生产者-消费者模型进行工作，是基于消息队列的内存调度器。</p>
<ul>
<li>
<p>该类是 MemOS 中基于<code>BaseScheduler</code>的具体调度器实现，专注于处理查询、回答和添加内存等核心任务。核心组件架构：</p>
<ul>
<li>消息队列：使用 memos_message_queue 来存储待处理的消息。</li>
<li>消费者线程：使用 _message_consumer 方法持续轮询队列并处理消息。</li>
<li>分发器：SchedulerDispatcher 负责将消息路由到对应的processor。</li>
<li>处理器：针对不同消息类型的具体processor。</li>
</ul>
</li>
<li>
<p>核心功能包括：</p>
<ul>
<li>注册消息类型（查询 / 回答 / 添加）注册对应的processor，实现任务的定向分发；</li>
<li>处理查询消息时，提取关键词、更新查询监控、执行内存检索与重排序，并支持激活内存的周期性更新；</li>
<li>处理添加内存消息时，记录新增内存日志并同步到监控系统；</li>
<li>基于会话对话轮次逻辑，根据意图检测和时间触发机制决定决定是否执行内存检索，确保工作内存的时效性和相关性。</li>
</ul>
</li>
<li>
<p>特色是基于消息类型的模块化处理机制，结合意图识别和时间触发的混合调度策略，支持按用户和内存立方体分组处理消息，保证多用户场景下的内存隔离和处理效率。</p>
</li>
</ul>
<h5 data-id="heading-5">2.1.1 消息处理</h5>
<p>SchedulerDispatcher将消息路由到适当的处理器。</p>
<h6 data-id="heading-6">消息类型与processor注册</h6>
<p>初始化时注册了三种消息processor。</p>
<pre><code class="hljs language-objectivec" lang="objectivec">        <span class="hljs-meta"># register handlers</span>
        handlers = {
            QUERY_LABEL: <span class="hljs-keyword">self</span>._query_message_consumer,
            ANSWER_LABEL: <span class="hljs-keyword">self</span>._answer_message_consumer,
            ADD_LABEL: <span class="hljs-keyword">self</span>._add_message_consumer,
        }
        <span class="hljs-keyword">self</span>.dispatcher.register_handlers(handlers)
</code></pre>
<ul>
<li>_query_message_consumer：处理用户查询 QUERY_LABEL，触发记忆检索和重排序</li>
<li>_answer_message_consumer：处理系统回答 ANSWER_LABEL。</li>
<li>_add_message_consumer：处理新增记忆请求 ADD_LABEL。</li>
</ul>
<p>QUERY_LABEL在memos/mem_scheduler/schemas/general_schemas.py文件中定义为一个常量：</p>
<ul>
<li>QUERY_LABEL="query"</li>
<li>ANSWER_LABEL ="anSwer"</li>
<li>ADD_LABEL = "add"</li>
</ul>
<p>这是一个预定义的字符串常量，值为"query"。</p>
<h6 data-id="heading-7">消息分发过程</h6>
<ul>
<li>消息提交：通过submit_messages 将ScheduleMessageItem放入消息队列。</li>
<li>消息消费：_message_consumer 线程定期从队列中取出所有消息。</li>
<li>消息分发：调用self.dispatcher.dispatch(messages)按消息标签分发到对应的processor。</li>
</ul>
<h5 data-id="heading-8">2.1.2 流程</h5>
<p>GeneralScheduler的流程如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a70ce41552c344929865d4182468c0a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=IVKNM%2F5tc3S%2FrtVy2984pstGgeM%3D" alt="MemScheduler-7-2" loading="lazy"/></p>
<p>MemScheduler-7-2</p>
<h5 data-id="heading-9">2.1.3 完整代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GeneralScheduler</span>(<span class="hljs-title class_ inherited__">BaseScheduler</span>):
    <span class="hljs-string">"""通用调度器，实现查询、回答和添加内存等具体任务的处理逻辑"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: GeneralSchedulerConfig</span>):
        <span class="hljs-string">"""使用给定定配置初始化通用调度器"""</span>
        <span class="hljs-built_in">super</span>().__init__(config)

        <span class="hljs-comment"># 查询关键词数量限制（从配置获取，默认20）</span>
        self.query_key_words_limit = self.config.get(<span class="hljs-string">"query_key_words_limit"</span>, <span class="hljs-number">20</span>)

        <span class="hljs-comment"># 注册消息processor（按消息标签绑定对应的处理方法）</span>
        handlers = {
            QUERY_LABEL: self._query_message_consumer,  <span class="hljs-comment"># 处理查询消息</span>
            ANSWER_LABEL: self._answer_message_consumer,  <span class="hljs-comment"># 处理回答消息</span>
            ADD_LABEL: self._add_message_consumer,  <span class="hljs-comment"># 处理添加内存消息</span>
        }
        self.dispatcher.register_handlers(handlers)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_query_message_consumer</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        处理和响应队列中的查询触发消息

        参数:
            messages: 要处理的查询消息列表
        """</span>
        <span class="hljs-comment"># 按用户和内存立方体分组处理消息</span>
        grouped_messages = self.dispatcher.group_messages_by_user_and_cube(messages=messages)

        <span class="hljs-comment"># 验证消息合法性（确保标签与消息类型匹配）</span>
        self.validate_schedule_messages(messages=messages, label=QUERY_LABEL)

        <span class="hljs-comment"># 遍历分组消息，按用户和内存立方体处理</span>
        <span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> grouped_messages:
            <span class="hljs-keyword">for</span> mem_cube_id <span class="hljs-keyword">in</span> grouped_messages[user_id]:
                messages = grouped_messages[user_id][mem_cube_id]
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) == <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">return</span>

                <span class="hljs-comment"># 获取当前内存立方体实例</span>
                mem_cube = messages[<span class="hljs-number">0</span>].mem_cube

                <span class="hljs-comment"># 从消息更新当前上下文（线程安全）</span>
                self._set_current_context_from_message(msg=messages[<span class="hljs-number">0</span>])

                <span class="hljs-comment"># 更新查询监控器（为每个消息注册查询记录）</span>
                <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages:
                    <span class="hljs-comment"># 若监控器不存在则创建</span>
                    self.monitor.register_query_monitor_if_not_exists(
                        user_id=user_id, mem_cube_id=mem_cube_id
                    )

                    <span class="hljs-comment"># 提取查询内容和关键词</span>
                    query = msg.content
                    query_keywords = self.monitor.extract_query_keywords(query=query)

                    <span class="hljs-comment"># 关键词提取失败时的 fallback 逻辑</span>
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(query_keywords) == <span class="hljs-number">0</span>:
                        stripped_query = query.strip()
                        <span class="hljs-comment"># 根据语言类型选择分词方式</span>
                        <span class="hljs-keyword">if</span> is_all_english(stripped_query):
                            words = stripped_query.split()  <span class="hljs-comment"># 英文按空格分词</span>
                        <span class="hljs-keyword">elif</span> is_all_chinese(stripped_query):
                            words = stripped_query  <span class="hljs-comment"># 中文按字符处理</span>
                        <span class="hljs-keyword">else</span>:
                            words = stripped_query  <span class="hljs-comment"># 混合语言默认按字符处理</span>

                        <span class="hljs-comment"># 取前N个关键词（去重）</span>
                        query_keywords = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(words[: self.query_key_words_limit]))

                    <span class="hljs-comment"># 创建查询监控项并添加到数据库</span>
                    item = QueryMonitorItem(
                        user_id=user_id,
                        mem_cube_id=mem_cube_id,
                        query_text=query,
                        keywords=query_keywords,
                        max_keywords=DEFAULT_MAX_QUERY_KEY_WORDS,
                    )

                    <span class="hljs-comment"># 同步到数据库</span>
                    query_db_manager = self.monitor.query_monitors[user_id][mem_cube_id]
                    query_db_manager.obj.put(item=item)
                    query_db_manager.sync_with_orm()  <span class="hljs-comment"># 添加后同步到数据库</span>

                <span class="hljs-comment"># 提取所有查询内容</span>
                queries = [msg.content <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages]

                <span class="hljs-comment"># 执行会话轮次处理（检索相关内存）</span>
                cur_working_memory, new_candidates = self.process_session_turn(
                    queries=queries,
                    user_id=user_id,
                    mem_cube_id=mem_cube_id,
                    mem_cube=mem_cube,
                    top_k=self.top_k,
                )

                <span class="hljs-comment"># 重排序内存重排序并替换工作内存</span>
                new_order_working_memory = self.replace_working_memory(
                    user_id=user_id,
                    mem_cube_id=mem_cube_id,
                    mem_cube=mem_cube,
                    original_memory=cur_working_memory,
                    new_memory=new_candidates,
                )

                <span class="hljs-comment"># 若启用激活内存，执行周期性更新</span>
                <span class="hljs-keyword">if</span> self.enable_activation_memory:
                    self.update_activation_memory_periodically(
                        interval_seconds=self.monitor.act_mem_update_interval,
                        label=QUERY_LABEL,
                        user_id=user_id,
                        mem_cube_id=mem_cube_id,
                        mem_cube=messages[<span class="hljs-number">0</span>].mem_cube,
                    )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_answer_message_consumer</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        处理和响应队列中的回答触发消息

        参数:
          messages: 要处理的回答消息列表
        """</span>
        <span class="hljs-comment"># 按用户和内存立方体分组处理消息</span>
        grouped_messages = self.dispatcher.group_messages_by_user_and_cube(messages=messages)

        <span class="hljs-comment"># 验证消息合法性</span>
        self.validate_schedule_messages(messages=messages, label=ANSWER_LABEL)

        <span class="hljs-comment"># 遍历分组消息，更新上下文（具体回答逻辑可在此扩展）</span>
        <span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> grouped_messages:
            <span class="hljs-keyword">for</span> mem_cube_id <span class="hljs-keyword">in</span> grouped_messages[user_id]:
                messages = grouped_messages[user_id][mem_cube_id]
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) == <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">return</span>

                <span class="hljs-comment"># 从消息更新当前上下文</span>
                self._set_current_context_from_message(msg=messages[<span class="hljs-number">0</span>])

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_message_consumer</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""处理和响应队列中的添加内存消息"""</span>
        <span class="hljs-comment"># 按用户和内存立方体分组处理消息</span>
        grouped_messages = self.dispatcher.group_messages_by_user_and_cube(messages=messages)

        <span class="hljs-comment"># 验证消息合法性</span>
        self.validate_schedule_messages(messages=messages, label=ADD_LABEL)
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 遍历分组消息，处理每个添加内存请求</span>
            <span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> grouped_messages:
                <span class="hljs-keyword">for</span> mem_cube_id <span class="hljs-keyword">in</span> grouped_messages[user_id]:
                    messages = grouped_messages[user_id][mem_cube_id]
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) == <span class="hljs-number">0</span>:
                        <span class="hljs-keyword">return</span>

                    <span class="hljs-comment"># 从消息更新当前上下文</span>
                    self._set_current_context_from_message(msg=messages[<span class="hljs-number">0</span>])

                    <span class="hljs-comment"># 处理每条消息中的内存ID列表</span>
                    <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages:
                        <span class="hljs-keyword">try</span>:
                            <span class="hljs-comment"># 解析消息内容中的内存ID列表（JSON格式）</span>
                            userinput_memory_ids = json.loads(msg.content)
                        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                            userinput_memory_ids = []

                        <span class="hljs-comment"># 遍历内存ID，记录添加日志（跳过工作内存类型）</span>
                        mem_cube = msg.mem_cube
                        <span class="hljs-keyword">for</span> memory_id <span class="hljs-keyword">in</span> userinput_memory_ids:
                            mem_item: TextualMemoryItem = mem_cube.text_mem.get(memory_id=memory_id)
                            mem_type = mem_item.metadata.memory_type
                            mem_content = mem_item.memory

                            <span class="hljs-comment"># 跳过工作内存（通常不需要手动添加）</span>
                            <span class="hljs-keyword">if</span> mem_type == WORKING_MEMORY_TYPE:
                                <span class="hljs-keyword">continue</span>

                            <span class="hljs-comment"># 记录添加内存的日志</span>
                            self.log_adding_memory(
                                memory=mem_content,
                                memory_type=mem_type,
                                user_id=msg.user_id,
                                mem_cube_id=msg.mem_cube_id,
                                mem_cube=msg.mem_cube,
                                log_func_callback=self._submit_web_logs,
                            )

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_session_turn</span>(<span class="hljs-params">
        self,
        queries: <span class="hljs-built_in">str</span> | <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        user_id: UserID | <span class="hljs-built_in">str</span>,
        mem_cube_id: MemCubeID | <span class="hljs-built_in">str</span>,
        mem_cube: GeneralMemCube,
        top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
    </span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">list</span>[TextualMemoryItem]] | <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        处理对话轮次：
        - 当查询列表达到窗口大小时，触发内存检索；
        - 若检索被触发，立即切换到新内存。
        """</span>

        <span class="hljs-comment"># 获取文本内存实例（仅支持TreeTextMemory类型）</span>
        text_mem_base = mem_cube.text_mem
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(text_mem_base, TreeTextMemory):
            logger.error(
                <span class="hljs-string">f"未实现！期望TreeTextMemory，但获取到<span class="hljs-subst">{<span class="hljs-built_in">type</span>(text_mem_base).__name__}</span> "</span>
                <span class="hljs-string">f"（mem_cube_id=<span class="hljs-subst">{mem_cube_id}</span>，user_id=<span class="hljs-subst">{user_id}</span>）。 "</span>
                <span class="hljs-string">f"text_mem_base值：<span class="hljs-subst">{text_mem_base}</span>"</span>,
                exc_info=<span class="hljs-literal">True</span>,
            )
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        <span class="hljs-comment"># 获取当前工作内存及文本内容</span>
        cur_working_memory: <span class="hljs-built_in">list</span>[TextualMemoryItem] = text_mem_base.get_working_memory()
        text_working_memory: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>] = [w_m.memory <span class="hljs-keyword">for</span> w_m <span class="hljs-keyword">in</span> cur_working_memory]
        <span class="hljs-comment"># 检测查询意图（判断是否需要触发检索）</span>
        intent_result = self.monitor.detect_intent(
            q_list=queries, text_working_memory=text_working_memory
        )

        <span class="hljs-comment"># 检查是否达到时间触发条件</span>
        time_trigger_flag = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> self.monitor.timed_trigger(
            last_time=self.monitor.last_query_consume_time,
            interval_seconds=self.monitor.query_trigger_interval,
        ):
            time_trigger_flag = <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 根据意图和时间触发条件决定是否执行检索</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> intent_result[<span class="hljs-string">"trigger_retrieval"</span>]) <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> time_trigger_flag):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">elif</span> (<span class="hljs-keyword">not</span> intent_result[<span class="hljs-string">"trigger_retrieval"</span>]) <span class="hljs-keyword">and</span> time_trigger_flag:
            intent_result[<span class="hljs-string">"trigger_retrieval"</span>] = <span class="hljs-literal">True</span>
            intent_result[<span class="hljs-string">"missing_evidences"</span>] = queries
        <span class="hljs-keyword">else</span>:
            logger.info(
                <span class="hljs-string">f"触发查询调度（user_id=<span class="hljs-subst">{user_id}</span>，mem_cube_id=<span class="hljs-subst">{mem_cube_id}</span>）。 "</span>
                <span class="hljs-string">f"缺失证据：<span class="hljs-subst">{intent_result[<span class="hljs-string">'missing_evidences'</span>]}</span>"</span>
            )

        <span class="hljs-comment"># 处理缺失的证据（需要检索的内容）</span>
        missing_evidences = intent_result[<span class="hljs-string">"missing_evidences"</span>]
        num_evidence = <span class="hljs-built_in">len</span>(missing_evidences)
        <span class="hljs-comment"># 为每个证据分配Top-K配额（确保至少返回1条）</span>
        k_per_evidence = <span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, top_k // <span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, num_evidence))
        new_candidates = []

        <span class="hljs-comment"># 为每个缺失证据执行检索</span>
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> missing_evidences:
            info = {
                <span class="hljs-string">"user_id"</span>: user_id,
                <span class="hljs-string">"session_id"</span>: <span class="hljs-string">""</span>,
            }

            <span class="hljs-comment"># 执行检索</span>
            results: <span class="hljs-built_in">list</span>[TextualMemoryItem] = self.retriever.search(
                query=item,
                mem_cube=mem_cube,
                top_k=k_per_evidence,
                method=self.search_method,
                info=info,
            )
            new_candidates.extend(results)

        <span class="hljs-comment"># 返回当前工作内存和新检索到的候选内存</span>
        <span class="hljs-keyword">return</span> cur_working_memory, new_candidates
</code></pre>
<h4 data-id="heading-10">2.2 SchedulerDispatcher</h4>
<p>SchedulerDispatcher 负责将消息路由到对应的processor。SchedulerDispatcher 不使用任何模型进行消息分发或分类判断。下面是它的工作原理：</p>
<ul>
<li>该类是基于线程池的消息分发器，核心作用是根据消息标签（label）将消息路由到对应的processor，实现消息的定向批量处理。</li>
<li>核心功能包括：支持单个 / 批量注册消息processor、按用户 ID 和内存立方体 ID 分组消息、串行 / 并行两种分发模式、优雅关闭和任务监控。</li>
<li>特色是采用上下文感知线程池（ContextThreadPoolExecutor），支持并行任务执行以提升效率；消息分组机制保证同用户同内存立方体的消息集中处理，避免上下文混乱；完善的任务生命周期管理（取消、等待、异常捕获）确保系统稳定。</li>
</ul>
<h5 data-id="heading-11">2.2.1 分发逻辑</h5>
<p>SchedulerDispatcher 是基于消息标签进行操作的，而不是使用任何机器学习模型或大语言模型进行分类，具体分发逻辑如下：</p>
<ul>
<li>
<p>消息分组：将消息按标签进行分组。</p>
</li>
<li>
<p>processor查找：依据标签查找注册的processor。处理函数在初始化时被明确注册。</p>
</li>
<li>
<p>执行模式：</p>
<ul>
<li>串行模式：直接调用processor</li>
<li>并行模式：通过线程池异步执行</li>
</ul>
</li>
</ul>
<p>消息通过其标签属性进行分发</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduleMessageItem</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, label: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span>, ...</span>):
        self.label = label  <span class="hljs-comment"># 分发键</span>
        self.content = content
        <span class="hljs-comment"># ... 其他属性</span>
</code></pre>
<p>调度器使用简单的字典查找来路由消息到处理函数，在 SchedulerDispatcher.dispatch() 中：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">label_groups</span> = defaultdict(list)
for message in msg_list:
    label_groups<span class="hljs-section">[message.label]</span>.append(message)  <span class="hljs-comment"># 按标签分组</span>

for label, msgs in label_groups.items():
    <span class="hljs-attr">handler</span> = self.handlers.get(label, self._default_message_handler)
    handler(msgs)  <span class="hljs-comment"># 基于标签直接调用函数</span>
</code></pre>
<p>当启用并行分发时，也只是并行执行处理函数，但仍不使用模型进行路由：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> self.enable_parallel_dispatch <span class="hljs-keyword">and</span> self.dispatcher_executor <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
    future = self.dispatcher_executor.submit(handler, msgs)  <span class="hljs-comment"># 并行执行</span>
</code></pre>
<p>消息流程示例</p>
<pre><code class="hljs language-arduino" lang="arduino">传入消息
├── 带有标签的消息 <span class="hljs-string">"query"</span>
│       ├── 没有模型参与确定使用哪个处理函数
│       │
│       ├── 按标签分组
│       │
│       └── 查找 <span class="hljs-string">"query"</span> 处理函数
│           ├── 调用已注册的 _query_message_consumer 函数直接调用
│
└── 并行处理（如果启用）
</code></pre>
<h5 data-id="heading-12">2.2.2 流程</h5>
<p>SchedulerDispatcher的流程如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72baa10ecb074c20bcd83eb8325dcae9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=QM4TR0FenXbmB1QYPpU%2BZswUP%2Fg%3D" alt="MemScheduler-7-3" loading="lazy"/></p>
<p>MemScheduler-7-3</p>
<h5 data-id="heading-13">2.2.3 代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SchedulerDispatcher</span>(<span class="hljs-title class_ inherited__">BaseSchedulerModule</span>):
    <span class="hljs-string">"""
    基于线程池的消息分发器，根据消息标签将消息路由到专用processor。

    特性：
    - 每个消息标签对应独立的线程池处理逻辑
    - 支持批量消息处理
    - 支持优雅关闭
    - 支持批量注册processor
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_workers=<span class="hljs-number">30</span>, enable_parallel_dispatch=<span class="hljs-literal">False</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.max_workers = max_workers  <span class="hljs-comment"># 线程池最大工作线程数</span>

        <span class="hljs-comment"># 仅在并行模式下初始化线程池</span>
        self.enable_parallel_dispatch = enable_parallel_dispatch
        self.thread_name_prefix = <span class="hljs-string">"dispatcher"</span>  <span class="hljs-comment"># 线程名称前缀</span>
        <span class="hljs-keyword">if</span> self.enable_parallel_dispatch:
            self.dispatcher_executor = ContextThreadPoolExecutor(
                max_workers=self.max_workers, thread_name_prefix=self.thread_name_prefix
            )
        <span class="hljs-keyword">else</span>:
            self.dispatcher_executor = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 串行模式下线程池为None</span>

        self.handlers: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>] = {}  <span class="hljs-comment"># 已注册的消息processor（标签→processor映射）</span>
        self._running = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 分发器运行状态标识</span>
        self._futures = <span class="hljs-built_in">set</span>()  <span class="hljs-comment"># 用于监控的活跃任务集合</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_handler</span>(<span class="hljs-params">self, label: <span class="hljs-built_in">str</span>, handler: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">list</span>[ScheduleMessageItem]], <span class="hljs-literal">None</span>]</span>):
        <span class="hljs-string">"""
        为特定消息标签注册processor函数。

        参数:
            label: 要处理的消息标签
            handler: 处理该标签消息的可调用对象，接收消息列表作为参数
        """</span>
        self.handlers[label] = handler

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_handlers</span>(<span class="hljs-params">
        self, handlers: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">list</span>[ScheduleMessageItem]], <span class="hljs-literal">None</span>]]
    </span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        从字典中批量注册多个processor。

        参数:
            handlers: 标签到processor函数的映射字典，格式：{标签: processor可调用对象}
        """</span>
        <span class="hljs-keyword">for</span> label, handler <span class="hljs-keyword">in</span> handlers.items():
            <span class="hljs-comment"># 验证标签类型（必须为字符串）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(label, <span class="hljs-built_in">str</span>):
                <span class="hljs-keyword">continue</span>
            <span class="hljs-comment"># 验证processor是否可调用</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">callable</span>(handler):
                <span class="hljs-keyword">continue</span>
            <span class="hljs-comment"># 注册单个processor</span>
            self.register_handler(label=label, handler=handler)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_default_message_handler</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""默认消息processor（当找不到对应标签的processor时使用）"""</span>
        logger.debug(<span class="hljs-string">f"使用默认消息processor处理消息：<span class="hljs-subst">{messages}</span>"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">group_messages_by_user_and_cube</span>(<span class="hljs-params">
        self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]
    </span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">list</span>[ScheduleMessageItem]]]:
        <span class="hljs-string">"""
        将消息按用户ID和内存立方体ID分组，生成嵌套字典结构。

        参数:
            messages: 要分组的ScheduleMessageItem对象列表

        返回:
            嵌套字典，结构如下：
            {
                "user_id_1": {
                    "mem_cube_id_1": [消息1, 消息2, ...],
                    "mem_cube_id_2": [消息3, 消息4, ...],
                    ...
                },
                "user_id_2": {
                    ...
                },
                ...
            }
            其中每个消息保持原始ScheduleMessageItem对象
        """</span>
        <span class="hljs-comment"># 初始化嵌套默认字典（自动创建不存在的键）</span>
        grouped_dict = defaultdict(<span class="hljs-keyword">lambda</span>: defaultdict(<span class="hljs-built_in">list</span>))

        <span class="hljs-comment"># 按用户ID→内存立方体ID的层级分组消息</span>
        <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages:
            grouped_dict[msg.user_id][msg.mem_cube_id].append(msg)

        <span class="hljs-comment"># 将默认字典转换为普通字典，输出更简洁</span>
        <span class="hljs-keyword">return</span> {user_id: <span class="hljs-built_in">dict</span>(cube_groups) <span class="hljs-keyword">for</span> user_id, cube_groups <span class="hljs-keyword">in</span> grouped_dict.items()}

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_handle_future_result</span>(<span class="hljs-params">self, future: Future</span>):
        <span class="hljs-string">"""处理异步任务结果，捕获异常并清理任务集合"""</span>
        self._futures.remove(future)  <span class="hljs-comment"># 从活跃任务集合中移除已完成任务</span>
         future.result()  <span class="hljs-comment"># 获取任务结果，触发可能的异常</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">self, msg_list: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>):
        <span class="hljs-string">"""
        将消息列表分发到对应的processor。

        参数:
            msg_list: 要处理的ScheduleMessageItem对象列表
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg_list:
            <span class="hljs-keyword">return</span>

        <span class="hljs-comment"># 按消息标签分组（同一标签的消息交给同一个processor）</span>
        label_groups = defaultdict(<span class="hljs-built_in">list</span>)
        <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> msg_list:
            label_groups[message.label].append(message)

        <span class="hljs-comment"># 处理每个标签对应的消息组</span>
        <span class="hljs-keyword">for</span> label, msgs <span class="hljs-keyword">in</span> label_groups.items():
            <span class="hljs-comment"># 获取该标签对应的processor，无则使用默认processor</span>
            handler = self.handlers.get(label, self._default_message_handler)
            <span class="hljs-comment"># 并行模式：提交任务到线程池异步执行</span>
            <span class="hljs-keyword">if</span> self.enable_parallel_dispatch <span class="hljs-keyword">and</span> self.dispatcher_executor <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                <span class="hljs-comment"># 提交任务到线程池，捕获变量避免循环引用问题</span>
                future = self.dispatcher_executor.submit(handler, msgs)
                self._futures.add(future)  <span class="hljs-comment"># 将任务添加到活跃任务集合</span>
                <span class="hljs-comment"># 绑定任务完成回调函数</span>
                future.add_done_callback(self._handle_future_result)
                logger.info(<span class="hljs-string">f"已将 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(msgs)}</span> 条消息作为异步任务分发"</span>)
            <span class="hljs-comment"># 串行模式：直接调用processor同步执行</span>
            <span class="hljs-keyword">else</span>:
                handler(msgs)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">join</span>(<span class="hljs-params">self, timeout: <span class="hljs-built_in">float</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""等待所有已分发任务完成。

        参数:
            timeout: 最大等待时间（秒），None表示无限等待

        返回:
            bool: 所有任务完成返回True，超时返回False
        """</span>
        <span class="hljs-comment"># 串行模式下无异步任务，直接返回True</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.enable_parallel_dispatch <span class="hljs-keyword">or</span> self.dispatcher_executor <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 等待所有活跃任务完成</span>
        done, not_done = concurrent.futures.wait(
            self._futures, timeout=timeout, return_when=concurrent.futures.ALL_COMPLETED
        )

        <span class="hljs-comment"># 检查已完成任务中的异常</span>
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> done:
            <span class="hljs-keyword">try</span>:
                future.result()
            <span class="hljs-keyword">except</span> Exception:
                logger.error(<span class="hljs-string">"关闭过程中processor执行失败"</span>, exc_info=<span class="hljs-literal">True</span>)

        <span class="hljs-comment"># 返回是否所有任务都已完成</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(not_done) == <span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-14">2.3 SchedulerRetriever</h4>
<p>SchedulerRetriever 是MemOS中负责记忆检索和重排序的核心模块，是连接查询和记忆存储的关键桥梁，负责确保系统能够准确、高效地检索和排序相关记忆。</p>
<p>内存检索与推理的本质是：在正确时间找到正确信息。</p>
<h5 data-id="heading-15">2.3.1 功能</h5>
<p>SchedulerRetriever 的功能如下：</p>
<ul>
<li>
<p>记忆检索功能</p>
<ul>
<li>
<p>搜索实现：通过 search 方法在文本记忆库中查找与查询相关的记忆项</p>
</li>
<li>
<p>支持多种搜索模式：</p>
<ul>
<li>快速搜索（fast mode）</li>
<li>精细搜索（fine mode）</li>
<li>多类型记忆检索：同时搜索长期记忆和用户记忆</li>
</ul>
</li>
</ul>
</li>
<li>
<p>记忆重排序</p>
<ul>
<li>LLM辅助重排序：使用 rerank_memories 方法通过大语言模型对检索到的记忆进行重新排序</li>
<li>智能相关性判断：基于查询内容判断记忆的相关性，提升记忆使用的准确性</li>
</ul>
</li>
<li>
<p>记忆处理与过滤</p>
<ul>
<li>记忆去重：使用 filter_vector_based_similar_memories 过滤过于相似的记忆项</li>
<li>长度过滤：使用 filter_too_short_memories 移除过短的记忆项</li>
<li>无关记忆过滤：通过 filter_unrelated_memories 移除与当前查询历史无关的记忆</li>
<li>冗余记忆过滤：通过 filter_redundant_memories 移除重复的记忆项</li>
</ul>
</li>
<li>
<p>记忆整合：在 process_and_rerank_memories 方法中整合原始记忆和新检索的记忆，进行统一处理</p>
</li>
</ul>
<h5 data-id="heading-16">2.3.2 详细步骤说明</h5>
<p>SchedulerRetriever 的详细步骤如下：</p>
<ul>
<li>搜索阶段：根据查询在 TreeTextMemory 中搜索相关记忆项</li>
<li>合并阶段：将原始记忆和新检索的记忆合并成一个列表</li>
<li>相似度过滤：使用相似度移除过于相似的记忆项</li>
<li>长度过滤：移除过短的记忆项（默认阈值为6个字符）</li>
<li>去重处理：确保记忆项唯一性，同时保持原有顺序</li>
<li>LLM重排序：利用大语言模型根据查询相关性对记忆进行重新排序</li>
<li>无关记忆过滤：移除与查询历史无关的记忆项</li>
<li>返回结果：返回优化后的记忆列表供系统使用</li>
</ul>
<h5 data-id="heading-17">2.3.3 调用关系</h5>
<p>一般来说，业界的<strong>检索时机</strong>有两种主要方法：</p>
<ul>
<li><strong>主动检索</strong>：在每轮开始时自动加载记忆，确保上下文始终可用，但会为不需要记忆访问的轮次引入不必要延迟</li>
<li><strong>反应式检索</strong>（内存即工具）：代理被赋予查询记忆的工具，自行决定何时检索上下文，更高效但需要额外LLM调用</li>
</ul>
<p>SchedulerRetriever 作为 BaseScheduler 的核心组件，主要在处理用户查询和更新工作记忆时被调用，负责记忆的检索、处理、重排序和过滤等核心功能，具体场景为：</p>
<ul>
<li>初始化：在BaseScheduler 的initialize_modules中建立SchedulerRetriever 实例。</li>
<li>查询处理：当 GeneralScheduler 接收到 QUERY_LABEL 消息时，调用 process_session_turn 方法触发 self.retriever.search() 来检索相关记忆。</li>
<li>工作记忆更新：在 replace_working_memory 过程中对候选记忆进行处理和重排序</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">└── GeneralScheduler<span class="hljs-selector-class">._query_message_consumer</span>()
  └── BaseScheduler<span class="hljs-selector-class">.process_session_turn</span>()
      └── SchedulerRetriever<span class="hljs-selector-class">.search</span>() --------&gt; 检索相关记忆

└── BaseScheduler<span class="hljs-selector-class">.replace_working_memory</span>()
  └── SchedulerRetriever<span class="hljs-selector-class">.process_and_rerank_memories</span>() ------&gt; 处理和重排序记忆
      └──SchedulerRetriever<span class="hljs-selector-class">.filter_unrelated_memories</span>() -----&gt; 过滤无关记忆
</code></pre>
<h5 data-id="heading-18">2.3.4 实现</h5>
<h6 data-id="heading-19">记忆检索流程（search 方法）</h6>
<p>作为对比，从业界角度看，一般会从多个维度评估潜在记忆，单纯依赖基于向量的相关性是常见陷阱。相似性得分可能找出概念相似但过时或琐碎的记忆。最有效策略是结合所有三个维度的混合方法：</p>
<ul>
<li><strong>相关性</strong>（语义相似性）：与当前对话的概念关联度</li>
<li><strong>新鲜度</strong>（基于时间）：记忆创建的时间远近</li>
<li><strong>重要性</strong>（显著性）：记忆的整体关键程度</li>
</ul>
<p>SchedulerRetriever的 search方法会 调用TreeTextMemory的功能来进行搜索。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b481cf8e011f472a93424e1e15ebcf75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=vlJ44ps50w2OktbWa8%2FP72Vmhds%3D" alt="MemScheduler-7-4" loading="lazy"/></p>
<p>MemScheduler-7-4</p>
<h6 data-id="heading-20">记忆全流程处理与重排（process_and_rerank_memories 方法）</h6>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60961cfd9ddc4878b29ef610db7835ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=hFyWesdUUFA1SLK85KM1y9ovhJA%3D" alt="MemScheduler-7-5" loading="lazy"/></p>
<p>MemScheduler-7-5</p>
<h6 data-id="heading-21">LLM 记忆重排流程（rerank_memories 方法）</h6>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbc35684fd284404a9c275d6bf56cd1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=Sbr9MiAczBUq0rFkB5%2BXweQCcTk%3D" alt="MemScheduler-7-6" loading="lazy"/></p>
<p>MemScheduler-7-6</p>
<h6 data-id="heading-22">代码</h6>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SchedulerRetriever</span>(<span class="hljs-title class_ inherited__">BaseSchedulerModule</span>):
    <span class="hljs-string">"""
    MemOS 记忆检索与优化调度器
    核心功能：检索树状文本内存、合并新旧记忆、多维度过滤、LLM 智能重排，为 Agent 提供精准记忆支持
    继承自 BaseSchedulerModule，遵循 MemOS 调度器模块统一接口规范
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, process_llm: BaseLLM, config: BaseSchedulerConfig</span>):
        <span class="hljs-string">"""
        初始化检索调度器实例
        Args:
            process_llm: 用于记忆重排的 LLM 实例（BaseLLM 基类对象）
            config: 调度器配置对象（BaseSchedulerConfig 基类，包含过滤、检索等参数）
        """</span>
        <span class="hljs-built_in">super</span>().__init__()  <span class="hljs-comment"># 调用父类 BaseSchedulerModule 的初始化方法</span>

        <span class="hljs-comment"># 超参数配置：记忆过滤阈值</span>
        self.filter_similarity_threshold = <span class="hljs-number">0.75</span>  <span class="hljs-comment"># 相似度过滤阈值（≥0.75 的记忆视为重复）</span>
        self.filter_min_length_threshold = <span class="hljs-number">6</span>     <span class="hljs-comment"># 长度过滤阈值（字符数＜6 的记忆视为过短，将被过滤）</span>

        self.config: BaseSchedulerConfig = config  <span class="hljs-comment"># 保存调度器配置</span>
        self.process_llm = process_llm             <span class="hljs-comment"># 保存用于重排的 LLM 实例</span>

        <span class="hljs-comment"># 初始化记忆过滤器：委托处理「无关记忆」和「冗余记忆」过滤逻辑</span>
        self.memory_filter = MemoryFilter(process_llm=process_llm, config=config)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">
        self,
        query: <span class="hljs-built_in">str</span>,
        mem_cube: GeneralMemCube,
        top_k: <span class="hljs-built_in">int</span>,
        method: <span class="hljs-built_in">str</span> = TreeTextMemory_SEARCH_METHOD,
        info: <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-built_in">list</span>[TextualMemoryItem]:
        <span class="hljs-string">"""
        根据查询语句在文本内存中检索相关记忆
        Args:
            query: 检索查询字符串（如 Agent 的当前对话查询）
            mem_cube: 记忆立方体（GeneralMemCube，MemOS 中存储各类记忆的核心数据结构）
            top_k: 返回的Top-K 相关记忆数量
            method: 检索方法（默认使用 TreeTextMemory 的标准搜索方法）
            info: 检索附加信息（需包含 user_id、session_id，用于记录记忆使用历史）

        Returns:
            检索到的文本型记忆项列表（list[TextualMemoryItem]）；检索失败返回空列表
        """</span>
        text_mem_base = mem_cube.text_mem  <span class="hljs-comment"># 从记忆立方体中提取文本内存核心实例</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 仅支持 TreeTextMemory 的两种检索方法</span>
            <span class="hljs-keyword">if</span> method <span class="hljs-keyword">in</span> [TreeTextMemory_SEARCH_METHOD, TreeTextMemory_FINE_SEARCH_METHOD]:
                <span class="hljs-comment"># 断言文本内存类型为 TreeTextMemory（确保检索方法兼容性）</span>
                <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(text_mem_base, TreeTextMemory)
                <span class="hljs-comment"># 若未传入 info，打印警告并初始化空信息（用于历史记录存储）</span>
                <span class="hljs-keyword">if</span> info <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                    info = {<span class="hljs-string">"user_id"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"session_id"</span>: <span class="hljs-string">""</span>}

                <span class="hljs-comment"># 根据检索方法设置模式：快速搜索（fast）或精细搜索（fine）</span>
                mode = <span class="hljs-string">"fast"</span> <span class="hljs-keyword">if</span> method == TreeTextMemory_SEARCH_METHOD <span class="hljs-keyword">else</span> <span class="hljs-string">"fine"</span>
                <span class="hljs-comment"># 检索长期记忆（LongTermMemory）</span>
                results_long_term = text_mem_base.search(
                    query=query, top_k=top_k, memory_type=<span class="hljs-string">"LongTermMemory"</span>, mode=mode, info=info
                )
                <span class="hljs-comment"># 检索用户记忆（UserMemory）</span>
                results_user = text_mem_base.search(
                    query=query, top_k=top_k, memory_type=<span class="hljs-string">"UserMemory"</span>, mode=mode, info=info
                )
                <span class="hljs-comment"># 合并长期记忆和用户记忆的检索结果</span>
                results = results_long_term + results_user
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 不支持的检索方法：抛出未实现异常（传入文本内存类型）</span>
                <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">type</span>(text_mem_base)))
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 检索异常：打印错误日志（包含堆栈信息），返回空列表</span>
            logger.error(<span class="hljs-string">f"Fail to search. The exeption is <span class="hljs-subst">{e}</span>."</span>, exc_info=<span class="hljs-literal">True</span>)
            results = []
        <span class="hljs-keyword">return</span> results

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">rerank_memories</span>(<span class="hljs-params">
        self, queries: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], original_memories: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], top_k: <span class="hljs-built_in">int</span>
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        基于 LLM 对记忆进行相关性重排（根据查询语句调整记忆顺序）
        Args:
            queries: 用于判断相关性的查询列表（通常为当前对话查询）
            original_memories: 待重排的记忆文本列表
            top_k: 重排后返回的 Top-K 记忆数量

        Returns:
            Tuple[重排后的记忆文本列表（长度≤top_k）, 重排成功标志（bool）]

        Note:
            若 LLM 重排失败（如 JSON 解析异常），降级为原始记忆顺序（截断至 top_k）
        """</span>

        logger.info(<span class="hljs-string">f"Starting memory reranking for <span class="hljs-subst">{<span class="hljs-built_in">len</span>(original_memories)}</span> memories"</span>)

        <span class="hljs-comment"># 构建 LLM 重排提示词（使用 "memory_reranking" 模板）</span>
        prompt = self.build_prompt(
            <span class="hljs-string">"memory_reranking"</span>,
            queries=[<span class="hljs-string">f"[0] <span class="hljs-subst">{queries[<span class="hljs-number">0</span>]}</span>"</span>],  <span class="hljs-comment"># 格式化查询（仅取第一个查询，标记为 [0]）</span>
            current_order=[<span class="hljs-string">f"[<span class="hljs-subst">{i}</span>] <span class="hljs-subst">{mem}</span>"</span> <span class="hljs-keyword">for</span> i, mem <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(original_memories)],  <span class="hljs-comment"># 格式化原始记忆顺序</span>
        )

        <span class="hljs-comment"># 调用 LLM 生成重排结果（构造用户角色消息）</span>
        response = self.process_llm.generate([{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}])

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 解析 LLM 响应中的 JSON 数据（期望格式：{"new_order": [索引列表], "reasoning": "重排理由"}）</span>
            response = extract_json_dict(response)
            new_order = response[<span class="hljs-string">"new_order"</span>][:top_k]  <span class="hljs-comment"># 提取 Top-K 索引顺序</span>
            <span class="hljs-comment"># 根据新索引映射回原始记忆文本</span>
            text_memories_with_new_order = [original_memories[idx] <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> new_order]
            success_flag = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 重排成功标志</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 重排异常（如 JSON 解析失败、键缺失）：打印错误日志，使用原始顺序降级</span>
            text_memories_with_new_order = original_memories[:top_k]  <span class="hljs-comment"># 截断原始记忆至 top_k</span>
            success_flag = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 重排失败标志</span>
        <span class="hljs-keyword">return</span> text_memories_with_new_order, success_flag

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_and_rerank_memories</span>(<span class="hljs-params">
        self,
        queries: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        original_memory: <span class="hljs-built_in">list</span>[TextualMemoryItem],
        new_memory: <span class="hljs-built_in">list</span>[TextualMemoryItem],
        top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-type">Optional</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem]], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        记忆全流程处理：合并新旧记忆 → 过滤冗余/过短记忆 → LLM 重排 → 返回优化后记忆
        Args:
            queries: 用于重排的查询列表（判断记忆相关性的依据）
            original_memory: 原始记忆列表（已存储的历史记忆，TextualMemoryItem 类型）
            new_memory: 新记忆列表（待合并的新增记忆，TextualMemoryItem 类型）
            top_k: 最终返回的最大记忆数量（默认 10）

        Returns:
            Tuple[优化后的 TextualMemoryItem 列表（长度≤top_k）, 处理成功标志（bool）]；失败返回 (None, False)
        """</span>
        <span class="hljs-comment"># 1. 合并原始记忆和新记忆（形成完整记忆池）</span>
        combined_memory = original_memory + new_memory

        <span class="hljs-comment"># 2. 构建「归一化文本→记忆对象」的映射（用于后续重排后还原记忆对象）</span>
        <span class="hljs-comment"># transform_name_to_key：文本归一化函数（如去空格、小写，确保匹配一致性）</span>
        memory_map = {
            transform_name_to_key(name=mem_obj.memory): mem_obj <span class="hljs-keyword">for</span> mem_obj <span class="hljs-keyword">in</span> combined_memory
        }

        <span class="hljs-comment"># 2. 提取所有记忆的文本内容（用于过滤和重排）</span>
        combined_text_memory = [m.memory <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> combined_memory]

        <span class="hljs-comment"># 4. 相似度过滤：移除过于相似的记忆（基于向量相似度，阈值 0.75）</span>
        filtered_combined_text_memory = filter_vector_based_similar_memories(
            text_memories=combined_text_memory,
            similarity_threshold=self.filter_similarity_threshold,
        )

        <span class="hljs-comment"># 5. 长度过滤：移除过短记忆（字符数＜6 的记忆视为无效，阈值 6）</span>
        filtered_combined_text_memory = filter_too_short_memories(
            text_memories=filtered_combined_text_memory,
            min_length_threshold=self.filter_min_length_threshold,
        )

        <span class="hljs-comment"># 6. 去重：基于归一化文本的字典去重（保留原始顺序）</span>
        unique_memory = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">dict</span>.fromkeys(filtered_combined_text_memory))

        <span class="hljs-comment"># 7. LLM 智能重排：按与查询的相关性调整记忆顺序</span>
        text_memories_with_new_order, success_flag = self.rerank_memories(
            queries=queries,
            original_memories=unique_memory,
            top_k=top_k,
        )

        <span class="hljs-comment"># 8. 映射回原始记忆对象（从文本列表还原为 TextualMemoryItem 列表）</span>
        memories_with_new_order = []
        <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> text_memories_with_new_order:
            normalized_text = transform_name_to_key(name=text)  <span class="hljs-comment"># 文本归一化（确保与 memory_map 键匹配）</span>
            <span class="hljs-keyword">if</span> normalized_text <span class="hljs-keyword">in</span> memory_map:  <span class="hljs-comment"># 检查归一化文本是否存在于映射中</span>
                memories_with_new_order.append(memory_map[normalized_text])
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 日志警告：记忆文本未找到映射（可能是归一化异常或记忆对象缺失）</span>
                logger.warning(
                    <span class="hljs-string">f"Memory text not found in memory map. text: <span class="hljs-subst">{text}</span>;\n"</span>
                    <span class="hljs-string">f"Keys of memory_map: <span class="hljs-subst">{memory_map.keys()}</span>"</span>
                )

        <span class="hljs-keyword">return</span> memories_with_new_order, success_flag

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_unrelated_memories</span>(<span class="hljs-params">
        self,
        query_history: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        memories: <span class="hljs-built_in">list</span>[TextualMemoryItem],
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        过滤与查询历史无关的记忆（委托给 MemoryFilter 实现）
        Args:
            query_history: 查询历史列表（Agent 的对话历史）
            memories: 待过滤的记忆列表（TextualMemoryItem 类型）
        Returns:
            Tuple[过滤后的记忆列表, 过滤成功标志]
        """</span>
        <span class="hljs-keyword">return</span> self.memory_filter.filter_unrelated_memories(query_history, memories)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_redundant_memories</span>(<span class="hljs-params">
        self,
        query_history: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        memories: <span class="hljs-built_in">list</span>[TextualMemoryItem],
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        过滤冗余记忆（委托给 MemoryFilter 实现）
        Args:
            query_history: 查询历史列表（判断冗余的上下文依据）
            memories: 待过滤的记忆列表（TextualMemoryItem 类型）
        Returns:
            Tuple[过滤后的记忆列表, 过滤成功标志]
        """</span>
        <span class="hljs-keyword">return</span> self.memory_filter.filter_redundant_memories(query_history, memories)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_unrelated_and_redundant_memories</span>(<span class="hljs-params">
        self,
        query_history: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        memories: <span class="hljs-built_in">list</span>[TextualMemoryItem],
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        同时过滤「无关记忆」和「冗余记忆」（基于 LLM 分析，委托给 MemoryFilter 实现）
        Args:
            query_history: 查询历史列表（上下文依据）
            memories: 待过滤的记忆列表（TextualMemoryItem 类型）
        Returns:
            Tuple[过滤后的记忆列表, 过滤成功标志]
        """</span>
        <span class="hljs-keyword">return</span> self.memory_filter.filter_unrelated_and_redundant_memories(query_history, memories)
</code></pre>
<h3 data-id="heading-23">0x03 关联</h3>
<p>SchedulerDispatcher、GeneralScheduler 和 TreeTextMemory 之间存在明确的依赖和协作关系。</p>
<h4 data-id="heading-24">3.1 SchedulerDispatcher 和 GeneralScheduler</h4>
<p>SchedulerDispatcher 负责消息的分发和处理，是一个底层的消息处理组件。GeneralScheduler 是一个更高级别的调度器，利用 SchedulerDispatcher 来管理不同类型的消息（如查询、回答、添加记忆等）。</p>
<ul>
<li>GeneralScheduler 依赖 SchedulerDispatcher</li>
<li>SchedulerDispatcher 是 GeneralScheduler 的一个组件，在 GeneralScheduler 的 init 方法中，创建了一个 SchedulerDispatcher 实例并赋值给 self.dispatcher</li>
</ul>
<p>GeneralScheduler 使用 self.dispatcher 来：</p>
<ul>
<li>注册消息处理器（handlers）</li>
<li>分发消息（通过 self.dispatcher.dispatch()）</li>
<li>批量处理消息（通过 self.dispatcher.group_messages_by_user_and_cube()）</li>
<li>等待任务完成（通过 self.dispatcher.join()）</li>
<li>关闭调度器（通过 self.dispatcher.shutdown()）</li>
</ul>
<h4 data-id="heading-25">3.2 GeneralScheduler 和 TreeTextMemory</h4>
<p>TreeTextMemory 是记忆存储和检索的核心组件，提供了添加、搜索、更新和删除记忆的功能，GeneralScheduler 利用 TreeTextMemory 来管理记忆的生命周期，处理与记忆相关的各种操作。</p>
<ul>
<li>GeneralScheduler 依赖 TreeTextMemory来执行实际的记忆操作</li>
<li>TreeTextMemory 提供了 GeneralScheduler 所需的记忆存储和检索功能</li>
</ul>
<p>GeneralScheduler 通过 mem_cube.text_mem 访问 TreeTextMemory 实例，GeneralScheduler 使用 TreeTextMemory 来：</p>
<ul>
<li>
<p>TreeTextMemory 包含了 MemoryManager 和 Searcher 等组件，这些组件被 GeneralScheduler 间接使用</p>
</li>
<li>
<p>获取工作记忆（通过 text_mem_base.get_working_memory()）</p>
</li>
<li>
<p>搜索记忆（通过 self.retriever.search()，其中 retriever 使用 TreeTextMemory 的搜索功能），检索过程涉及：</p>
<ul>
<li>使用 TaskGoalParser 解析查询</li>
<li>使用 GraphMemoryRetriever 从图数据库检索记忆</li>
<li>使用 Reranker 对检索到的记忆进行重排序</li>
<li>使用 MemoryReasoner 进行推理以优化结果</li>
</ul>
</li>
<li>
<p>添加记忆（通过 self.memory_manager.add()，其中 memory_manager 与 TreeTextMemory 相关联）</p>
</li>
<li>
<p>替换工作记忆（通过 text_mem_base.replace_working_memory()）</p>
</li>
<li>
<p>获取记忆（通过 mem_cube.text_mem.get(memory_id=memory_id)）</p>
</li>
<li>
<p>GeneralScheduler 接收不同类型的消息（查询、回答、添加记忆等），根据消息类型，GeneralScheduler 调用相应的处理器，处理器使用 TreeTextMemory 的方法来执行具体操作</p>
</li>
</ul>
<p>GeneralScheduler 和 TreeTextMemory 之间是一种协作关系，其中：</p>
<ul>
<li>GeneralScheduler 是一个高级调度器，负责处理不同类型的消息并协调记忆操作</li>
<li>TreeTextMemory 是记忆操作的实际执行者，提供了存储、检索、更新和组织记忆的功能</li>
</ul>
<p>两者通过定义良好的接口进行交互，GeneralScheduler 调用 TreeTextMemory 的方法来执行具体操作 这种设计实现了关注点分离，使调度逻辑和记忆管理逻辑可以独立开发和维护。</p>
<p>协作范例如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># GeneralScheduler 处理查询消息的简化流程</span>
def process_query(self, query, mem_cube):
    <span class="hljs-comment"># 1. 获取当前工作记忆</span>
    <span class="hljs-attr">current_memory</span> = mem_cube.text_mem.get_working_memory()
    <span class="hljs-comment"># 2. 检索相关记忆</span>
    <span class="hljs-attr">new_candidates</span> = mem_cube.text_mem.search(query, top_k=self.top_k)
    <span class="hljs-comment"># 3. 更新工作记忆</span>
    mem_cube.text_mem.replace_working_memory(new_candidates)
</code></pre>
<h4 data-id="heading-26">3.3 总结</h4>
<p>三者之间的依赖关系可以概括为：</p>
<ul>
<li>GeneralScheduler → SchedulerDispatcher（使用其进行消息分发）</li>
<li>GeneralScheduler → TreeTextMemory（使用其进行记忆操作）</li>
</ul>
<p>具体来说：</p>
<ul>
<li>SchedulerDispatcher 是一个消息分发器，负责将不同类型的消息路由到相应的处理器</li>
<li>GeneralScheduler 是一个高级调度器，它使用 SchedulerDispatcher 来管理消息，并使用 TreeTextMemory 来处理与记忆相关的操作</li>
<li>TreeTextMemory 是记忆存储和检索的核心组件，为 GeneralScheduler 提供底层的记忆操作支持</li>
</ul>
<p>这种设计使得系统能够有效地处理不同类型的消息，并对记忆进行相应的操作，实现了消息处理和记忆管理的解耦。</p>
<h4 data-id="heading-27">3.4 MosCore</h4>
<p>MosCore 是一个很好的范例。</p>
<pre><code class="hljs language-diff" lang="diff">MosCore
<span class="hljs-deletion">- uses GeneralMemCube</span>
<span class="hljs-deletion">- uses GeneralScheduler</span>
  - uses MemoryManager
  - uses TreeTextMemory
<span class="hljs-deletion">- uses UserManager</span>
</code></pre>
<p>在如下代码中，可以管窥。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MOSCore</span>:
    <span class="hljs-string">"""
    The MOSCore (Memory Operating System Core) class manages multiple MemCube objects and their operations.
    It provides methods for creating, searching, updating, and deleting MemCubes, supporting multi-user scenarios.
    MOSCore acts as an operating system layer for handling and orchestrating MemCube instances.
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: MOSConfig, user_manager: UserManager | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>):
        self.config = config
        self.user_id = config.user_id
        self.session_id = config.session_id
        self.chat_llm = LLMFactory.from_config(config.chat_model)
        self.mem_reader = MemReaderFactory.from_config(config.mem_reader)
        self.chat_history_manager: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, ChatHistory] = {}
        <span class="hljs-comment"># use thread safe dict for multi-user product-server scenario</span>
        self.mem_cubes: OptimizedThreadSafeDict[<span class="hljs-built_in">str</span>, GeneralMemCube] = (
            OptimizedThreadSafeDict() <span class="hljs-keyword">if</span> user_manager <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> {}
        )
        self._register_chat_history()

        <span class="hljs-comment"># Use provided user_manager or create a new one</span>
        <span class="hljs-keyword">if</span> user_manager <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.user_manager = user_manager
        <span class="hljs-keyword">else</span>:
            self.user_manager = UserManager(user_id=self.user_id <span class="hljs-keyword">if</span> self.user_id <span class="hljs-keyword">else</span> <span class="hljs-string">"root"</span>)

        <span class="hljs-comment"># Initialize mem_scheduler</span>
        self._mem_scheduler_lock = Lock()
        self.enable_mem_scheduler = self.config.get(<span class="hljs-string">"enable_mem_scheduler"</span>, <span class="hljs-literal">False</span>)
        <span class="hljs-keyword">if</span> self.enable_mem_scheduler:
            self._mem_scheduler = self._initialize_mem_scheduler()
            self._mem_scheduler.mem_cubes = self.mem_cubes
        <span class="hljs-keyword">else</span>:
            self._mem_scheduler: GeneralScheduler = <span class="hljs-literal">None</span>
</code></pre>
<h3 data-id="heading-28">0xFF 参考</h3>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀基于 Qoder CLI 的 Chrome 视频加速器插件自动化开发与实践🧣]]></title>    <link>https://juejin.cn/post/7585645111876468763</link>    <guid>https://juejin.cn/post/7585645111876468763</guid>    <pubDate>2025-12-21T16:25:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585645111876468763" data-draft-id="7585808181239218227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀基于 Qoder CLI 的 Chrome 视频加速器插件自动化开发与实践🧣"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-21T16:25:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="围巾哥萧尘"/> <meta itemprop="url" content="https://juejin.cn/user/1222312659548446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀基于 Qoder CLI 的 Chrome 视频加速器插件自动化开发与实践🧣
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1222312659548446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    围巾哥萧尘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T16:25:20.000Z" title="Sun Dec 21 2025 16:25:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀基于 Qoder CLI 的 Chrome 视频加速器插件自动化开发与实践🧣</h2>
<p><strong>摘要：</strong> 本实践旨在探讨利用 Qoder 平台（面向真实 Agent 的资本体编程平台）进行浏览器扩展程序自动化开发的流程。通过 Qoder 命令行界面（CLI），开发者能够以对话模式快速构建功能性插件。本文以“视频加速器”开发为例，详细记录了我从环境配置、身份验证到多轮提示词驱动的迭代开发过程，并针对开发中的界面优化及编码问题提出了避坑指南。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d7d3d6f694143c7ac8cd43907944b8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766939120&amp;x-signature=1KSWPnOu4wx2W6EvmpOIZygo8Wo%3D" alt="d676c046e89d4ef99658dafc09897171preview.jpeg~tplv-a9rns2rl98-image_pre_watermark_1_6b.png" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1maBEBoEh7%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click" target="_blank" title="https://www.bilibili.com/video/BV1maBEBoEh7/?spm_id_from=333.1387.homepage.video_card.click" ref="nofollow noopener noreferrer">使用Qoder完成视频加速器的Chrome谷歌插件开发实例 | @围巾哥萧尘🧣 #Qoder #Chrome</a></p>
<p><strong>关键词：</strong> Qoder；CLI；AI 编程；Chrome 插件；自动化开发</p>
<hr/>
<h4 data-id="heading-1">一、 引言</h4>
<p>在当前 AI 驱动的软件工程背景下，Qoder 已发展成为涵盖 IDE、CLI 及插件三种形态的成熟编程辅助平台。相较于传统的 IDE 模式，Qoder CLI 在近期测试中表现出极高的灵活性，尤其适用于快速原型设计与特定功能插件的迭代。</p>
<h4 data-id="heading-2">二、 开发环境配置与准备</h4>
<p>在启动项目前，必须完成 Qoder 运行环境的搭建。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afb72f2d50044353b18f14162309f3d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766939120&amp;x-signature=p8L7yVQWho%2B7aWYNYdIzt59LSKA%3D" alt="截屏2025-12-22 00.00.11.png" loading="lazy"/></p>
<ol>
<li>
<p><strong>安装步骤</strong>：Qoder CLI 支持多种安装方式，包括使用 <code>brew</code> 或 <code>npm</code> 进行全局部署。</p>
<ul>
<li><strong>避坑指南</strong>：受网络环境影响，安装过程可能耗时较长，建议在稳定的网络条件下进行或使用代理。</li>
</ul>
</li>
<li>
<p><strong>版本校验</strong>：本实验采用的版本为 <code>0.1.8</code>。</p>
</li>
<li>
<p><strong>身份验证</strong>：通过执行登录指令，系统提供交互式界面（Interactive Page）验证身份，从而完成本地 CLI 与平台的链接。</p>
</li>
</ol>
<h4 data-id="heading-3">三、 结构化开发流程与提示词执行</h4>
<p>本节详细展示了如何通过精准的提示词（Prompts）引导 AI 完成从零到一的开发。</p>
<h5 data-id="heading-4">步骤 1：项目初始化与初步生成</h5>
<ul>
<li><strong>操作描述</strong>：在空文件夹中启动对话模式，直接下达任务目标。</li>
<li><strong>核心提示词</strong>： <strong>“制作一款视频加速器的插件”</strong> 。</li>
<li><strong>执行结果</strong>：AI 自动生成了包括打包文件（Manifest）、脚本文件及 Readme 文档在内的基础结构，初步构建耗时约 5 分钟。</li>
</ul>
<h5 data-id="heading-5">步骤 2：功能扩展与参数自定义（迭代 V2-V3）</h5>
<ul>
<li><strong>操作描述</strong>：针对默认倍速范围有限的问题（初始仅支持 0.8-1.25 倍），要求 AI 扩展倍速区间。</li>
<li><strong>核心提示词</strong>： <strong>“修改倍速区间，使其能够达到从 5 倍到 16 倍”</strong> 。</li>
<li><strong>执行结果</strong>：系统完成逻辑更新，成功支持自定义高倍速播放。</li>
</ul>
<h5 data-id="heading-6">步骤 3：UI 优化与乱码修复（迭代 V4）</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a70e2a8b43a1479c9114cfceb7e741fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu05be-5ZOl6JCn5bCY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766939120&amp;x-signature=lb7uq4T2z%2FITMVBdyuZA72P%2BiPk%3D" alt="截屏2025-12-22 00.21.06.png" loading="lazy"/></p>
<ul>
<li><strong>操作描述</strong>：解决开发中出现的界面文字乱码及视觉排版问题。</li>
<li><strong>核心提示词</strong>： <strong>“优化界面 UI，修复文字乱码问题”</strong> 。</li>
<li><strong>经验总结</strong>：在 AI 生成代码时，<strong>提示词的精准度直接决定了开发效率</strong>。越具体的 UI 描述越能减少冗余的迭代轮次。</li>
</ul>
<h4 data-id="heading-7">四、 结果分析与讨论</h4>
<h5 data-id="heading-8">4.1 功能验证</h5>
<p>实测证明，该插件在视频播放页面能够稳定运行。除了预设的 <code>0.5</code>、<code>0.75</code> 等基础倍速外，用户可通过自定义输入框设置如 <code>4.5</code> 倍等非标准速度，功能达标。</p>
<h5 data-id="heading-9">4.2 工具评价</h5>
<p>Qoder 目前在 Agent 编程领域已展现出接近 Cursor 的成熟度。其优势在于：</p>
<ul>
<li><strong>开发效率</strong>：从零开始到完成插件优化，总耗时仅约 15 分钟。</li>
<li><strong>易用性</strong>：即便没有经过深厚编程训练的个体，也能通过自然语言描述实现功能。</li>
</ul>
<h4 data-id="heading-10">五、 经验总结与个人见解</h4>
<ol>
<li><strong>避坑指南：</strong> 在使用 CLI 进行多轮修改时，务必关注 AI 生成的 V3、V4 等版本差异。如果出现乱码，通常是字符编码或 HTML 头部声明缺失，应明确要求 AI “使用 UTF-8 编码重新生成界面”。</li>
<li><strong>提效技巧：</strong> 优秀的 AI 编程并非完全脱离代码，而是**“比拼对工具的掌控力”**。开发者应学会将复杂问题拆解为多个微小指令，提高 AI 响应的精确度。</li>
<li><strong>行业前瞻：</strong> 2025 年至 2026 年将是 AI 编程工具竞争的白热化阶段。未来的核心竞争力将不仅在于模型质量，更在于如何解决“非编程用户”的实际问题，实现真正的 Natural Language Programming（自然语言编程）。</li>
</ol>
<hr/>
<p><strong>结论：</strong> 通过 Qoder CLI 开发 Chrome 插件是一条极高效率的路径。<strong>这种开发模式就像是在指挥一位反应极快的实习生：你不需要亲自动手写每一行代码，但你需要清晰地告诉他“桌子要挪到哪里”以及“桌布要什么颜色”。</strong> 当你掌握了与 AI 沟通的节奏，开发逻辑将从“如何写”转向“如何定义需求”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三年前，我帮万人转Go；今天，聊聊Go/Java程序员如何抢占AI高地]]></title>    <link>https://juejin.cn/post/7586263211087986714</link>    <guid>https://juejin.cn/post/7586263211087986714</guid>    <pubDate>2025-12-22T06:59:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586263211087986714" data-draft-id="7585920796100968475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三年前，我帮万人转Go；今天，聊聊Go/Java程序员如何抢占AI高地"/> <meta itemprop="keywords" content="后端,人工智能,Go"/> <meta itemprop="datePublished" content="2025-12-22T06:59:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三年前，我帮万人转Go；今天，聊聊Go/Java程序员如何抢占AI高地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:59:23.000Z" title="Mon Dec 22 2025 06:59:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>从“调包侠”到“智能体架构师”，你需要的是思维升维，这才是1，其他的都是0。</p>
</blockquote>
<h2 data-id="heading-0">为什么要写这篇文章：</h2>
<p>三年前，我写过一篇《<a href="https://juejin.cn/post/7147939014870302756" target="_blank" title="https://juejin.cn/post/7147939014870302756">给想转Go或者Go进阶同学的一些建议</a>》，有幸在稀土掘金获得了近<strong>8万</strong>的阅读量，帮助了许多正在转型和迷茫中的开发者。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfac36d5ea2f485ca361ee321eb3317b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766991562&amp;x-signature=9MFtsZVCT%2Fz9iJr4bgxu6wQ90%2BA%3D" alt="image.png" loading="lazy"/></p>
<p>今天，我们站在<strong>2026年</strong>的门槛上，技术浪潮已从云计算、移动互联网，无可争议地转向了人工智能。我最近一年All in在AI应用开发领域，密集交付了多个企业级AI项目，阅读、剖析了<strong>几十个</strong>高质量的AI开源应用代码，也评测了大量付费课程。</p>
<p>这篇文章，我将结合这些<strong>最新的、一线的实战认知</strong>，为你梳理一条在2026年，从传统开发转向AI应用开发的清晰路径。如果说三年前的文章是关于“<strong>编程思维</strong>”的转变，那么今天这篇，就是关于“<strong>智能构建思维</strong>”的跃迁。</p>
<p>我的核心结论依旧直接：</p>
<p><strong>2026年，从传统开发转向AI开发，最大的障碍不是学习新工具，而是从“业务逻辑实现者”到“智能工作流设计者”的思维重塑。对于广大Go/Java等后端开发者而言，你们的工程化能力正是AI时代最急需的稀缺品，机会远大于挑战。</strong></p>
<h2 data-id="heading-1">先说核心结论</h2>
<ol>
<li><strong>思维决胜</strong>：忘掉“我是XX语言程序员”的标签。AI时代最需要的是“<strong>智能体工作流架构师</strong>”。你的价值不再是单纯实现CRUD，而是设计多个智能体如何协同、可靠地完成复杂任务。（知易行难，不要给自己加标签，加束缚，AI时代，编程语言已经不存在界限了！）</li>
<li><strong>学习路径巨变</strong>：别再走“从头推导模型”的学术老路。2026年的高效路径是 <strong>“三层框架法”</strong>：<strong>感知层（会玩）→ 学习层（会改）→ 构建层（会造）</strong>。</li>
<li><strong>能力锚点迁移</strong>：你擅长的“<strong>高并发</strong>”、“<strong>高可用</strong>”架构思想，在AI时代等价于“<strong>复杂工作流编排与推理成本优化</strong>”。你熟悉的Go/Java/Python等语言在性能、并发和工程化上的优势，在<strong>AI工程化</strong>阶段将全面爆发。</li>
<li><strong>机会在垂直领域</strong>：大模型本身解决不了“<strong>行业特定知识</strong>”和“<strong>确定性的业务流程</strong>”。这里藏着普通开发者的最大机会——<strong>垂直领域AI应用</strong>。它的壁垒是你的<strong>行业知识+工程化能力</strong>，而非顶尖AI实验室的博士学位。</li>
<li><strong>新范式</strong>：AI原生应用不是“APP+大模型接口”。它的内核是 <strong>“智能体（Agent）协同网络”</strong>。理解并掌握这一点，<strong>是你摆脱“调包侠”命运、建立核心竞争力的关键。</strong></li>
</ol>
<h2 data-id="heading-2">我的观察：2026年AI应用开发的三重境界</h2>
<p>过去一年的深度实践，让我清晰地看到了开发者群体的分层：</p>
<ol>
<li><strong>第一重：Prompt使用者</strong>：能熟练使用各类AI聊天工具，但能力边界停留在对话界面，无法将能力产品化、工程化。<strong>可替代性：极高</strong>。</li>
<li><strong>第二重：AI应用集成者</strong>：能使用LangChain等框架快速搭建Demo，了解RAG、Agent基础概念。但容易陷入“<strong>玩具项目</strong>”陷阱，一旦面临生产环境中的<strong>幻觉、高延迟、高成本</strong>问题便手足无措。<strong>状态：焦虑的“项目缝合者”</strong>。</li>
<li><strong>第三重：AI原生架构师</strong>：他们从 <strong>“智能体协同”</strong> 的视角设计整个系统。思考的是：如何为不同的子任务（如数据分析、决策判断、代码生成）设计或选用<strong>专门的智能体（Specialized Agent）</strong>，并通过严谨的<strong>工作流</strong>将它们可靠地串联起来。他们像导演一样编排“角色”，并确保最终“演出”稳定、高效、低成本。<strong>特征：思考“如何设计智能”，掌控全链路。</strong></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cf5af43546b4e5fa6d4170eb36437ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766991562&amp;x-signature=SqBJ%2FPNzAqrW%2BRYpbuLC41rHFro%3D" alt="deepseek_mermaid_20251222_ec452c.png" loading="lazy"/></p>
<p><strong>所谓“多个专门的智能体（Specialized Agents）”，可以这样理解</strong>：在一个“自动数据分析报告生成系统”中，你可能会设计：</p>
<ol>
<li><strong>一个“SQL专家”智能体</strong>：专门将自然语言问题转换成精准的SQL查询。</li>
<li><strong>一个“图表建议”智能体</strong>：根据数据特征和业务场景，推荐最合适的可视化方案。</li>
<li><strong>一个“报告润色”智能体</strong>：负责将干巴巴的数据结果，组织成符合人类阅读习惯的叙事性报告。</li>
</ol>
<p>每个智能体各司其职，通过工作流引擎协同作业，这就是比单一全能模型<strong>更强大、更可控</strong>的架构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/664e2dbcf3a8489a88c2188ca87e461c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766991562&amp;x-signature=mjhGxONO95JYqlZZK%2FKK1671yGw%3D" alt="这张图是我的智能体矩阵，极大的帮我提高了工作效率！" loading="lazy"/></p>
<h2 data-id="heading-3">2026版“三层框架”学习法：从玩转到构建</h2>
<h3 data-id="heading-4">第一层：感知层（1-2周）——“会玩”</h3>
<p><strong>目标</strong>：建立对AI能力最直接的体感，破除神秘感。
<strong>行动</strong>：</p>
<ol>
<li><strong>玩转前沿应用</strong>：深度体验 <strong>Cursor</strong>（AI代码编辑器）、<strong>Claude Desktop</strong>、<strong>v0.dev</strong>（AI生成UI）。以<strong>开发者视角</strong>思考其背后的可能性。</li>
<li><strong>搭建私有AI工作站</strong>：在本地通过 <strong>Ollama</strong> 一键部署并运行 <strong>Llama 3</strong>、<strong>Qwen</strong> 等开源模型。再部署 <strong>Open WebUI</strong>，打造你的私人ChatGPT。这一步是为了获得“<strong>一切皆可私有化、可控化</strong>”的底气。</li>
</ol>
<h3 data-id="heading-5">第二层：学习层（1-2个月）——“会改”</h3>
<p><strong>目标</strong>：掌握将想法快速实现为原型的能力。<strong>核心是：学会高效阅读开源项目</strong>。
<strong>行动</strong>：</p>
<ol>
<li>
<p><strong>精读3个高质量开源项目（附GitHub地址）</strong>：</p>
<ul>
<li><strong>全栈AI应用（Go/Python）</strong>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FChatGPTNextWeb%2FChatGPT-Next-Web" target="_blank" title="https://github.com/ChatGPTNextWeb/ChatGPT-Next-Web" ref="nofollow noopener noreferrer">ChatGPT-Next-Web</a></strong> ：一个极简、高性能的私有化ChatGPT网页应用。结构清晰，是学习AI应用前端交互和后端集成的优秀范本。</li>
<li><strong>RAG增强类（Python）</strong>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuivrHQ%2FQuivr" target="_blank" title="https://github.com/QuivrHQ/Quivr" ref="nofollow noopener noreferrer">Quivr</a></strong> 或 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fimartinez%2FprivateGPT" target="_blank" title="https://github.com/imartinez/privateGPT" ref="nofollow noopener noreferrer">privateGPT</a></strong>：学习如何将文档处理、向量检索与大模型回答结合。重点关注其<strong>数据管道</strong>设计。</li>
<li><strong>智能体工作流类（Python）</strong>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fassafelovic%2Fgpt-researcher" target="_blank" title="https://github.com/assafelovic/gpt-researcher" ref="nofollow noopener noreferrer">gpt-researcher</a></strong> ：一个能自动进行网络调研的智能体。通过它学习<strong>任务规划、工具使用和多步推理</strong>的工作流设计。</li>
</ul>
</li>
<li>
<p><strong>怎么读？推荐一个神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzread.ai%2F" target="_blank" title="https://zread.ai/" ref="nofollow noopener noreferrer">ZREAD 读代码</a></strong>：</p>
<p>我今年能高效阅读几十个项目，全靠这个工具。它支持<strong>直接分析GitHub项目链接</strong>，能一键生成项目的整体架构图、核心流程时序图，并让你可以像查字典一样，从功能点到具体代码逐层下钻追踪。用它先建立<strong>宏观认知</strong>，再深入细节，效率提升十倍。</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1c6ee798cff47cc9b11994086fb71e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766991562&amp;x-signature=BP7qIYqHeQsgyLEg63c59O5i8Fk%3D" alt="image.png" loading="lazy"/></p>
<ol start="3">
<li><strong>掌握核心框架</strong>：</li>
</ol>
<ul>
<li><strong>LangChain/LangGraph（Python）</strong>：这是定义智能体工作流的<strong>事实标准</strong>。重点学习 <strong><code>LCEL</code></strong>（链式表达式）、<strong><code>Agent</code></strong>（智能体）和 <strong><code>Tools</code></strong>（工具）的概念，以及 <strong><code>LangGraph</code></strong> 如何用<strong>状态图（StateGraph）</strong> 来编排复杂、带循环的工作流。</li>
<li><strong>LlamaIndex（Python）</strong>：专注于复杂RAG场景，比LangChain的RAG模块更<strong>专精、性能更好</strong>。重点理解其 <strong><code>QueryEngine</code></strong>、各种 <strong><code>Retriever</code></strong> 和 <strong><code>Postprocessor</code></strong>。</li>
<li><strong>Eino（Golang）- 来自字节跳动的高性能AI应用框架</strong>
这是Go开发者的<strong>王牌</strong>。相比Python生态，<code>Eino</code> 的核心优势在于：
<ul>
<li><strong>原生性能与高并发</strong>：基于Go语言，天然适合构建高吞吐、低延迟的AI微服务。在处理<strong>流式响应、海量文档异步索引</strong>等I/O密集型任务时，优势巨大。</li>
<li><strong>强大的工作流编排</strong>：它提供了类似 <code>LangGraph</code> 的 <strong><code>DAG（有向无环图）</code></strong> 编排能力，但用Go编写，<strong>类型安全</strong>，编译期就能发现许多错误。</li>
<li><strong>卓越的工程化体验</strong>：编译部署简单，内存占用低，与现有Go微服务栈（如GoFrame、GoZero）<strong>无缝集成</strong>。对于中大型企业需要将AI能力平稳融入现有技术体系的情况，<code>Eino</code> 是比Python更稳健的选择。</li>
<li><strong>学习建议</strong>：如果你有Go基础，<strong>强烈建议将 <code>Eino</code> 作为你深入AI工程化的主框架</strong>。从官方示例入手，理解其 <strong><code>Graph</code></strong>、<strong><code>Node</code></strong>、<strong><code>Stream</code></strong> 等核心概念。</li>
<li>（Eino对于Go开发者来说是王牌框架。不过，<strong>从理解概念到真正写出第一个生产可用的Graph</strong>，中间仍有不少实践细节。我最近正在系统梳理一套《Eino框架实战入门》的短教程，<strong>如果你在实践过程中遇到任何具体问题，欢迎随时在我的交流群或通过微信与我讨论</strong>，你的真实案例可能会成为教程中的最佳素材。）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">第三层：构建层（长期）——“会造”</h3>
<p><strong>目标</strong>：设计并交付稳定、可评估、有商业价值的AI原生应用。
<strong>行动</strong>：</p>
<ol>
<li><strong>攻克生产级问题</strong>：
<ul>
<li><strong>成本与延迟</strong>：学习模型量化、推理加速（如<code>vLLM</code>）、缓存和流式输出技术。</li>
<li><strong>评估与治理</strong>：引入 <strong><code>RAGAS</code></strong>、<strong><code>TruLens</code></strong> 等评估框架，为你的AI应用建立<strong>可量化的质量指标体系</strong>。设计**<code>Guardrail</code>（护栏）<strong>和</strong><code>Fallback</code>（降级）**策略。</li>
<li><strong>可观测性</strong>：为AI应用添加细粒度监控，追踪每次调用的<strong>Token消耗、延迟及自定义的质量分</strong>。</li>
</ul>
</li>
<li><strong>深入一个垂直领域</strong>：结合你或你所在行业的专业知识（如金融风控、电商客服、智能制造），打造 <strong>“领域专家智能体”</strong>。你的<strong>工程能力+领域知识</strong>，将构成<strong>双重护城河</strong>。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/253e3e78ff324e548fc5cdcd58175993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766991562&amp;x-signature=lnUUdXrZf16YFvCprZMGITR3G%2Bo%3D" alt="exported_image (1).png" loading="lazy"/></p>
<h2 data-id="heading-7">总结与行动起点</h2>
<p>2026年，AI应用的竞争已从“有无”进入“<strong>优劣</strong>”阶段。比赛的胜负手，在于<strong>智能体协同设计的思维</strong>与<strong>生产级交付的能力</strong>。</p>
<p><strong>给你的2026年启动清单</strong>：</p>
<ol>
<li><strong>本周</strong>：用Ollama在本地跑通一个开源模型，感受“<strong>掌控力</strong>”。</li>
<li><strong>本月</strong>：使用 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzread.ai%2F" target="_blank" title="https://zread.ai/" ref="nofollow noopener noreferrer">ZREAD读代码</a></strong> 工具，深度剖析一个上文推荐的GitHub项目，并尝试为其添加一个小功能。</li>
<li><strong>本季度</strong>：选择你的主战场框架（Python流选<code>LangGraph</code>，Go流选<code>Eino</code>），从零设计并实现一个能解决实际微小痛点的智能体工作流（例如：自动周报生成器、智能会议纪要整理器）。</li>
</ol>
<p>这条路迭代迅速，但方向清晰：<strong>从“工具使用者”变为“智能设计者”</strong>。你过去积累的所有工程经验，都将是这条新赛道上的宝贵燃料。</p>
<p><strong>欢迎交流</strong>：你正在AI应用开发的哪个阶段？是Go还是Python技术栈？遇到了什么具体挑战？欢迎在评论区留言，我们一起探讨。</p>
<blockquote>
<p><strong>关于我</strong>：王中阳，一名从Go微服务开发转向AI原生应用架构的实践者。关注<strong>AI工程化</strong>与<strong>大模型应用落地</strong>，持续分享最前沿、最可实操的Go&amp;AI结合实战经验。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简单的Python神经网络识别手写数字]]></title>    <link>https://juejin.cn/post/7586452779712675855</link>    <guid>https://juejin.cn/post/7586452779712675855</guid>    <pubDate>2025-12-22T08:42:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586452779712675855" data-draft-id="7585391510058303540" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简单的Python神经网络识别手写数字"/> <meta itemprop="keywords" content="神经网络"/> <meta itemprop="datePublished" content="2025-12-22T08:42:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MMHM"/> <meta itemprop="url" content="https://juejin.cn/user/2455627311357436"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简单的Python神经网络识别手写数字
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455627311357436/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MMHM
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T08:42:40.000Z" title="Mon Dec 22 2025 08:42:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一.导语</h2>
<p>本文主要介绍了神经网络模型训练的基本步骤，主要使用了<strong>PyTorch</strong>库，基于<strong>Python3</strong>的神经网络模型训练。且简要提供了前端GUI操作程序，让训练好的模型得以第一时间发挥作用。最后放有完整源码，可以直接使用，确保放在同一个文件夹里即可。</p>
<p>成果如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90e8a8dbbb7245998cf2ca6c8610971f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1ITQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093057&amp;x-signature=DYIenJiSpIsrxPpM69%2B3WeRaFME%3D" alt="屏幕录制 2025-12-22 165134.gif" loading="lazy"/></p>
<p>本文目的在于通过这个实际项目，让大家得以理解神经网络的基本结构，和训练过程，以及弄清楚中间发生了什么，理解代码的内容。</p>
<p>话不多说，现在就让我们开始学习！</p>
<h2 data-id="heading-1">二.准备必要的库</h2>
<h3 data-id="heading-2"><strong>1.首先需要准备这几个库</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.<span class="hljs-property">nn</span> <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.<span class="hljs-property">optim</span> <span class="hljs-keyword">as</span> optim
<span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> datasets, transforms
<span class="hljs-keyword">import</span> os
</code></pre>
<p>解释一下</p>
<p>1.torch库 可以理解为门用来造 AI 的工具箱</p>
<p>2.torchvision库 计算机视觉工具包，用于下载数据集和处理图片</p>
<p>3.os库 可以理解为文件管理员</p>
<h2 data-id="heading-3">三.定义神经网络的结构和思考方式</h2>
<h3 data-id="heading-4"><strong>1.初始化结构</strong></h3>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Net</span>(nn.<span class="hljs-title class_">Module</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):
        <span class="hljs-variable language_">super</span>(<span class="hljs-title class_">Net</span>, <span class="hljs-variable language_">self</span>).__init__()
        <span class="hljs-variable language_">self</span>.fc1 = nn.<span class="hljs-title class_">Linear</span>(<span class="hljs-number">28</span> * <span class="hljs-number">28</span>, <span class="hljs-number">128</span>)
        <span class="hljs-variable language_">self</span>.relu = nn.<span class="hljs-title class_">Re</span>LU()
        <span class="hljs-variable language_">self</span>.dropout = nn.<span class="hljs-title class_">Dropout</span>(<span class="hljs-number">0.2</span>)
        <span class="hljs-variable language_">self</span>.fc2 = nn.<span class="hljs-title class_">Linear</span>(<span class="hljs-number">128</span>, <span class="hljs-number">10</span>)
</code></pre>
<p><strong>解释一下</strong></p>
<p><strong>1.self.fc1 = nn.Linear(28 * 28, 128)</strong></p>
<p>这段是<strong>输入层</strong>到<strong>隐藏层</strong>的连接，其中(28*28)是可识别的分辨率,128是隐藏层神经元的数量</p>
<p><strong>2.self.relu = nn.ReLU()</strong></p>
<p>这个是<strong>激活函数</strong>，目的就是过滤掉一些‘杂波’的影响，减小其对训练的干扰，相当于给数据增加了一个可被识别的阈值。更重要的是<strong>引入非线性</strong>，把直线变成折线，让神经网络能够描绘出复杂的形状（比如数字的弯曲边缘）。</p>
<p><strong>3.self.dropout = nn.Dropout(0.2)</strong></p>
<p>这是为了干扰网络训练的机制，目的是防止网络死记硬背从而影响学习效率。<code>0.2</code> 意味着在训练时，<strong>随机让 20% 的神经元“罢工”</strong> （输出变为 0）。可以让网络学会通过整体特征来认字，极大地防止<strong>过拟合</strong>。</p>
<p><strong>4.self.fc2 = nn.Linear(128, 10)</strong></p>
<p>这段是<strong>隐藏层</strong>到<strong>输出层</strong>的连接，其中<code>128</code>是接收那 128 个神经元处理后的特征。<code>10</code>是输出0-9的结果。</p>
<p><strong>最后的结构大致是这样</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b015ec993294b958c7acb3b032a9892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1ITQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093057&amp;x-signature=UQRkuvBIQdfg70ZsXpiDLEwUo9I%3D" alt="Gemini_Generated_Image_2q2ekq2q2ekq2q2e.png" loading="lazy"/></p>
<h3 data-id="heading-5"><strong>2.前向传播</strong></h3>
<pre><code class="hljs language-ini" lang="ini">def forward(self, x):
    <span class="hljs-attr">x</span> = x.view(-<span class="hljs-number">1</span>, <span class="hljs-number">28</span> * <span class="hljs-number">28</span>)
    <span class="hljs-attr">x</span> = self.fc1(x)
    <span class="hljs-attr">x</span> = self.relu(x)
    <span class="hljs-attr">x</span> = self.dropout(x)
    <span class="hljs-attr">x</span> = self.fc2(x)
    return torch.log_softmax(x, <span class="hljs-attr">dim</span>=<span class="hljs-number">1</span>)
</code></pre>
<p>可以看作是模型的思考过程，下面解释一下都做了哪些处理，发生了什么</p>
<p>我们的手写图片传入进来时，是一张28*28的方块图像，而我们的<code>fc1()</code>函数识别不了这个大方块。于是我们使用<code>x = x.view(-1, 28 * 28)</code>把这个<strong>大方块变为长条形</strong>来让<code>fc1()</code>函数识别。<code>-1</code>表示把每张图都压成 784 的长度，来对图片进行预处理。接着以下都是调用我们上面写的方法<code>self.fc1()，self.relu()，self.dropout()，self.fc2()</code>来处理每一个数据，这就是我们所提及的<strong>思考过程</strong>。</p>
<p>最后一句<code>return torch.log_softmax(x, dim=1)</code>来算出概率。因为<code>fc2()</code>最后的输出可以是任何数字，并且没有范围限制，我们可以叫做<strong>原始得分</strong>。而为了算出概率我们需要百分比的形式，于是我们用到了<code>softmax()</code>函数,<code>Softmax()</code> 是一个数学函数，它能把原始得分转换成<strong>总和为 1 的概率分布</strong>。取对数（Log）是为了数学计算更稳定，防止softmax的数据过大或过小导致代码瘫痪。<code>dim=0</code> 是“图”的维度（竖着看），<code>dim=1</code> 是“分类”的维度（横着看）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16667bda826e420ea4774fede4e74c5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1ITQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093057&amp;x-signature=5ITcfyXlTy1oL5joYVnWjS195Zc%3D" alt="Gemini_Generated_Image_yu30tyyu30tyyu30.png" loading="lazy"/></p>
<p><code>dim=0</code>时是跨样本比较，<code>dim=1</code>时是在单个样本中比较概率</p>
<p>整个 <code>forward</code> 函数就是把<strong>图片像素</strong>（784个点）一步步<strong>浓缩</strong>，最后变成<strong>10个概率值</strong>的过程。</p>
<h2 data-id="heading-6">四.训练模型</h2>
<h3 data-id="heading-7"><strong>1.准备阶段</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_model</span>():
    <span class="hljs-string">"""训练模型或加载已有模型"""</span>
    model_path = <span class="hljs-string">"mnist_model.pth"</span>
    device = torch.device(<span class="hljs-string">"cuda"</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">"cpu"</span>)
    model = Net().to(device)

    <span class="hljs-keyword">if</span> os.path.exists(model_path):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"发现已保存的模型，正在加载..."</span>)
        model.load_state_dict(torch.load(model_path, map_location=device))
        model.<span class="hljs-built_in">eval</span>()
        <span class="hljs-keyword">return</span> model, device
</code></pre>
<p>3-5行代码主要是决定用 CPU 还是 显卡 (CUDA) 跑模型。然后把主程序<code>Net()</code>搬到上面去跑。<code>model.load_state_dict(torch.load(model_path, map_location=device))</code>这段代码就是实际上加载的过程。用<code>load_state_dict()</code>把<code>model_path</code>里存储的权重参数加载到<code>Net()</code>里。然后用<code>model.eval()</code>关闭<code>Dropout()</code>也就是上文提到的干扰机制，从而让模型满功率运行。</p>
<h3 data-id="heading-8"><strong>2.数据处理与下载</strong></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">transform</span> = transforms.Compose([
    transforms.ToTensor(),
    transforms.Normalize((<span class="hljs-number">0.1307</span>,), (<span class="hljs-number">0.3081</span>,))
])

<span class="hljs-attr">train_dataset</span> = datasets.MNIST(<span class="hljs-string">'./data'</span>, train=<span class="hljs-literal">True</span>, download=<span class="hljs-literal">True</span>, transform=transform)
<span class="hljs-attr">train_loader</span> = torch.utils.data.DataLoader(train_dataset, batch_size=<span class="hljs-number">64</span>, shuffle=<span class="hljs-literal">True</span>)
</code></pre>
<p>现在我们开始对数据进行处理，而这个处理流程我们就先叫做<code>transform</code>。后面的<code>Compose([...])</code>负责把
多个处理步骤串联起来执行。</p>
<ul>
<li>
<p>第一步 <code>transforms.ToTensor()</code>负责把数据转换为<strong>浮点数</strong>，让神经网络更好地处理数据。</p>
</li>
<li>
<p>第二步 <code>transforms.Normalize((0.1307,), (0.3081,))</code>是让上一步得到的数据减去<strong>均值</strong>，除以<strong>标准差</strong>。让数值变成了以 0 为中心的正负数，分布在x轴上下。这一步就是把数据<strong>标准化</strong>，来让数据的分布更标准，能让神经网络收敛得更快（学得更快）。<code>0.1307</code> 和 <code>0.3081</code> 是 MNIST 数据集的官方统计数据。</p>
</li>
</ul>
<p><code>train_dataset = datasets.MNIST('./data', train=True, download=True, transform=transform)</code>这一串代码是用来下载数据。它会自动检查 <code>./data</code> 文件夹里有没有MNIST数据。有就会读取，没有就会去自动下载。(<code>train=True</code>表示要下载的是用于学习的训练集)。</p>
<p><code>train_loader = torch.utils.data.DataLoader(train_dataset, batch_size=64, shuffle=True)</code>
有了数据之后，我们要把数据运给网络，但不能一次全部运完。于是我们用<code>batch_size=64</code>把图片分为64个一组，一组一组地运输。<code>shuffle=True</code>意思是在每 Epoch开始时，<strong>把图片打乱</strong>，因为MNIST数据集里的图片排列一般是有序的。打乱后，网络每次看到的都是随机的数字图片，从而逼迫它去学习数字本身的特征。</p>
<p>这一步是必须的，防止网络过拟合。</p>
<h3 data-id="heading-9"><strong>3.训练循环(核心一步)</strong></h3>
<pre><code class="hljs language-scss" lang="scss">optimizer = optim<span class="hljs-selector-class">.Adam</span>(model.parameters(), lr=<span class="hljs-number">0.001</span>)
criterion = nn<span class="hljs-selector-class">.CrossEntropyLoss</span>()

model<span class="hljs-selector-class">.train</span>()
epochs = <span class="hljs-number">6</span>  

for epoch in <span class="hljs-built_in">range</span>(epochs):
    for batch_idx, (data, target) in <span class="hljs-built_in">enumerate</span>(train_loader):
        data, target = data.<span class="hljs-built_in">to</span>(device), target.<span class="hljs-built_in">to</span>(device)
        optimizer.<span class="hljs-built_in">zero_grad</span>()
        output = <span class="hljs-built_in">model</span>(data)
        loss = <span class="hljs-built_in">criterion</span>(output, target)
        loss.<span class="hljs-built_in">backward</span>()
        optimizer.<span class="hljs-built_in">step</span>()

        if batch_idx % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:
            <span class="hljs-built_in">print</span>(f<span class="hljs-string">'Epoch {epoch + 1}/{epochs} | Batch {batch_idx} | Loss: {loss.item():.4f}'</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"训练完成，正在保存模型..."</span>)
torch.<span class="hljs-built_in">save</span>(model.<span class="hljs-built_in">state_dict</span>(), model_path)
model.<span class="hljs-built_in">eval</span>()
return model, device
</code></pre>
<p>经过了上面的 <strong>搭建网络</strong> 和 <strong>处理数据</strong> 我们终于到了训练环节，让我们来逐一了解发生了什么事情。</p>
<p>首先是两个比较重要的部分，对应着1-2行的代码</p>
<p>1.<code>optimizer = optim.Adam(...)</code>这部分负责修改神经网络的参数<code>model.parameters()</code>。后面的<code>lr=0.001</code>我们管它叫做<strong>学习率</strong>，可以理解为模型的修改幅度，之所以是<code>0.001</code>是因为我们<strong>既不</strong>希望模型修改幅度过大导致<strong>预测结果和真实答案</strong>之间的差距(Loss)过大以至于影响学习，<strong>也不</strong>希望模型修改幅度过小导致训练极其低效，<strong>而</strong><code>0.001</code>这个数值是无数前辈总结出的最佳值。</p>
<p>2.<code>criterion = nn.CrossEntropyLoss()</code>这段代码就是负责计算出<strong>交叉熵CrossEntropy</strong>，什么是交叉熵呢，就是预测结果与真实答案之间的距离，也可以叫<strong>损失Loss</strong>。如果Loss太大，就会在 <code>backward()</code> 的时候大幅修改参数。所以我们的训练目标就是得到尽可能接近0的Loss，至于为什么不能为0，是因为这时模型会过拟合，从而让训练失去意义。</p>
<pre><code class="hljs language-ini" lang="ini">model.train() 
<span class="hljs-attr">epochs</span> = <span class="hljs-number">6</span>
</code></pre>
<p>然后我们开启训练模式，打开Dropout。定义循环次数，其实3次就已经可以让准确率达到90%以上了。</p>
<pre><code class="hljs language-scss" lang="scss">for epoch in <span class="hljs-built_in">range</span>(epochs): 
    for batch_idx, (data, target) in <span class="hljs-built_in">enumerate</span>(train_loader):
</code></pre>
<p>这边我们定义了2个循环，一个外层<code>for epoch in range(epochs):</code>让模型把所有的题做6遍。一个内层<code>for batch_idx, (data, target) in enumerate(train_loader):</code>让每一遍做题时一次只做64道(batch)，且每做完64道就总结一次。</p>
<p>然后我们正式进入学习的流程，注意我们是在内层循环里学习的。</p>
<p><code>data, target = data.to(device), target.to(device)</code>OK，我们用这行代码把数据成功的搬进了GPU/CPU里。</p>
<p>那我们开始学习</p>
<ul>
<li>第一步，<code>optimizer.zero_grad()</code>把梯度清零，把上次算的梯度忘掉。梯度可以理解为，为了让<strong>Loss=0</strong>，模型现在应该往哪个方向走一步，让权重朝着正确的方向修改，于是我们走一步看一圈。清零是因为我们使用的PyTorch会默认把指令<strong>累加</strong>，如果不清零，上一步的梯度会和这一步的混在一起，导致神经网络‘走错方向’，因此我们必须清零上次的梯度。</li>
</ul>
<p>梯度Like this</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89adaa46261342c798fece1ebdd67f53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTU1ITQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767093057&amp;x-signature=3TOypi35glC9cAwSSC0XRV7vLiE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p>第二步，<code>output = model(data)</code>，可以理解为前向传播，把图片数据喂给神经网络后，经过层层计算，输出预测结果0-9。</p>
</li>
<li>
<p>第三步，<code>loss = criterion(output, target)</code>计算损失，给出一个具体的<strong>Loss</strong>，看看错的情况。</p>
</li>
<li>
<p>第四步，<code>loss.backward()</code>反向传播，程序会从<strong>Loss</strong>开始往回推，看看每一个神经元的参数(权重)对这个错误的‘贡献’，这一步算出了梯度，告诉每个神经元应该朝哪个方向更改参数。</p>
</li>
<li>
<p>第五步，<code>optimizer.step()</code>更新参数，根据第四步算出的<strong>梯度</strong>，配合<strong>学习率</strong>去更新参数</p>
</li>
</ul>
<p>走完这五步，我们的模型就聪明了一点</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> batch_idx % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>: 
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Epoch <span class="hljs-subst">{epoch + <span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{epochs}</span> | Batch <span class="hljs-subst">{batch_idx}</span> | Loss: <span class="hljs-subst">{loss.item():<span class="hljs-number">.4</span>f}</span>'</span>)
</code></pre>
<p>这一块是负责定期汇报学习进度，每学习完100个Batch就汇报一次。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>("训练完成，正在保存模型...")
torch<span class="hljs-selector-class">.save</span>(model.state_dict(), model_path)
</code></pre>
<p>训练完成后保存模型</p>
<pre><code class="hljs language-javascript" lang="javascript">model.<span class="hljs-built_in">eval</span>()
<span class="hljs-keyword">return</span> model, device
</code></pre>
<p>然后<code>model.eval()</code>这行代码强制关闭 <strong>Dropout</strong>，返回模型和使用的设备(GPU/CPU)。</p>
<p>至此，我们村里终于出了个大学生：)</p>
<p>然后就是设计一个岗位给大学生了，是时候就业了</p>
<h2 data-id="heading-10">五.GUI交互界面</h2>
<h3 data-id="heading-11">1.功能介绍</h3>
<p>我们最主要的一部分已经完成了，我这边直接给出一个实例，包含了写数字，识别，可信度，处理后图片，概论预测的可视化，热力图(数据的数值强度)。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tkinter <span class="hljs-keyword">as</span> tk
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageDraw, ImageTk
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> torch

<span class="hljs-comment"># ---导入训练模块---</span>
<span class="hljs-keyword">from</span> neural_net <span class="hljs-keyword">import</span> train_model


<span class="hljs-comment"># ---GUI---</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DigitRecognizerApp</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, root, model, device</span>):
        self.root = root
        self.model = model
        self.device = device
        self.root.title(<span class="hljs-string">"Handwritten Digit Recognition"</span>)

        <span class="hljs-comment"># 布局配置</span>
        self.main_frame = tk.Frame(root, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">20</span>)
        self.main_frame.pack()

        <span class="hljs-comment"># 1. 画板区域 (Canvas)</span>
        self.canvas_width = <span class="hljs-number">280</span>
        self.canvas_height = <span class="hljs-number">280</span>
        self.canvas_bg = <span class="hljs-string">"black"</span>
        self.brush_color = <span class="hljs-string">"white"</span>
        self.brush_size = <span class="hljs-number">18</span>

        self.canvas = tk.Canvas(self.main_frame, width=self.canvas_width, height=self.canvas_height, bg=self.canvas_bg,
                                cursor=<span class="hljs-string">"cross"</span>)
        self.canvas.grid(row=<span class="hljs-number">0</span>, column=<span class="hljs-number">0</span>, rowspan=<span class="hljs-number">4</span>, padx=<span class="hljs-number">10</span>, pady=<span class="hljs-number">10</span>)

        <span class="hljs-comment"># 绑定鼠标事件</span>
        self.canvas.bind(<span class="hljs-string">"&lt;B1-Motion&gt;"</span>, self.draw)

        <span class="hljs-comment"># 内存绘图对象 (PIL)</span>
        self.image = Image.new(<span class="hljs-string">"L"</span>, (self.canvas_width, self.canvas_height), self.canvas_bg)
        self.draw_obj = ImageDraw.Draw(self.image)

        <span class="hljs-comment"># 2. 控制区域</span>
        self.btn_frame = tk.Frame(self.main_frame)
        self.btn_frame.grid(row=<span class="hljs-number">0</span>, column=<span class="hljs-number">1</span>, sticky=<span class="hljs-string">"n"</span>)

        self.predict_btn = tk.Button(self.btn_frame, text=<span class="hljs-string">"Predict"</span>, command=self.predict, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">12</span>),
                                     bg=<span class="hljs-string">"#4CAF50"</span>, fg=<span class="hljs-string">"white"</span>)
        self.predict_btn.pack(pady=<span class="hljs-number">10</span>, fill=<span class="hljs-string">"x"</span>)

        self.clear_btn = tk.Button(self.btn_frame, text=<span class="hljs-string">"Clear"</span>, command=self.clear_canvas, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">12</span>))
        self.clear_btn.pack(pady=<span class="hljs-number">10</span>, fill=<span class="hljs-string">"x"</span>)

        <span class="hljs-comment"># 3. 结果显示区域</span>
        self.result_label = tk.Label(self.main_frame, text=<span class="hljs-string">"Prediction: None"</span>, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">16</span>, <span class="hljs-string">"bold"</span>), fg=<span class="hljs-string">"blue"</span>)
        self.result_label.grid(row=<span class="hljs-number">1</span>, column=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 4. 略缩图显示</span>
        tk.Label(self.main_frame, text=<span class="hljs-string">"Neural Network Input:"</span>, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">10</span>)).grid(row=<span class="hljs-number">2</span>, column=<span class="hljs-number">1</span>, sticky=<span class="hljs-string">"s"</span>)
        self.thumb_label = tk.Label(self.main_frame, bg=<span class="hljs-string">"gray"</span>)
        self.thumb_label.grid(row=<span class="hljs-number">3</span>, column=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 5. 初始化 Matplotlib 可视化界面</span>
        plt.ion()
        self.fig, self.ax = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">4</span>))
        self.fig.canvas.manager.set_window_title(<span class="hljs-string">"Neural Network Visualization"</span>)  <span class="hljs-comment"># 英文窗口标题</span>
        self.init_plot()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params">self, event</span>):
        x1, y1 = (event.x - self.brush_size), (event.y - self.brush_size)
        x2, y2 = (event.x + self.brush_size), (event.y + self.brush_size)
        self.canvas.create_oval(x1, y1, x2, y2, fill=self.brush_color, outline=self.brush_color)
        self.draw_obj.ellipse([x1, y1, x2, y2], fill=self.brush_color, outline=self.brush_color)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_canvas</span>(<span class="hljs-params">self</span>):
        self.canvas.delete(<span class="hljs-string">"all"</span>)
        self.image = Image.new(<span class="hljs-string">"L"</span>, (self.canvas_width, self.canvas_height), self.canvas_bg)
        self.draw_obj = ImageDraw.Draw(self.image)
        self.result_label.config(text=<span class="hljs-string">"Prediction: None"</span>)
        self.thumb_label.config(image=<span class="hljs-string">''</span>)
        self.init_plot()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">preprocess_image</span>(<span class="hljs-params">self</span>):
        img_resized = self.image.resize((<span class="hljs-number">28</span>, <span class="hljs-number">28</span>), Image.Resampling.LANCZOS)
        img_array = np.array(img_resized)

        <span class="hljs-comment"># 归一化处理</span>
        img_tensor = torch.tensor(img_array, dtype=torch.float32) / <span class="hljs-number">255.0</span>
        img_tensor = (img_tensor - <span class="hljs-number">0.1307</span>) / <span class="hljs-number">0.3081</span>
        img_tensor = img_tensor.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>)

        <span class="hljs-keyword">return</span> img_tensor, img_resized

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self</span>):
        input_tensor, pil_thumb = self.preprocess_image()

        <span class="hljs-comment"># 显示略缩图</span>
        display_thumb = pil_thumb.resize((<span class="hljs-number">112</span>, <span class="hljs-number">112</span>), Image.Resampling.NEAREST)
        self.photo_thumb = ImageTk.PhotoImage(display_thumb)
        self.thumb_label.config(image=self.photo_thumb)

        <span class="hljs-comment"># 调用模型推理</span>
        <span class="hljs-keyword">with</span> torch.no_grad():
            output = self.model(input_tensor.to(self.device))
            probs = torch.exp(output)
            prediction = torch.argmax(probs, dim=<span class="hljs-number">1</span>).item()
            confidence = probs[<span class="hljs-number">0</span>][prediction].item()

        self.result_label.config(text=<span class="hljs-string">f"Prediction: <span class="hljs-subst">{prediction}</span>\nConfidence: <span class="hljs-subst">{confidence:<span class="hljs-number">.1</span>%}</span>"</span>)
        self.update_plot(input_tensor, probs)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_plot</span>(<span class="hljs-params">self</span>):
        self.ax[<span class="hljs-number">0</span>].clear()
        self.ax[<span class="hljs-number">0</span>].set_title(<span class="hljs-string">"Input Heatmap"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">0</span>].axis(<span class="hljs-string">'off'</span>)

        self.ax[<span class="hljs-number">1</span>].clear()
        self.ax[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">"Probability Distribution"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">1</span>].set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        self.ax[<span class="hljs-number">1</span>].set_xticks(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
        self.fig.canvas.draw()
        self.fig.canvas.flush_events()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_plot</span>(<span class="hljs-params">self, input_tensor, probs</span>):
        img_data = input_tensor.squeeze().cpu().numpy()
        self.ax[<span class="hljs-number">0</span>].imshow(img_data, cmap=<span class="hljs-string">'viridis'</span>)

        probs_data = probs.squeeze().cpu().numpy()
        self.ax[<span class="hljs-number">1</span>].clear()
        self.ax[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">"Probability Distribution"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">1</span>].set_xticks(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
        self.ax[<span class="hljs-number">1</span>].set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1.1</span>)
        bars = self.ax[<span class="hljs-number">1</span>].bar(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>), probs_data, color=<span class="hljs-string">'skyblue'</span>)
        bars[np.argmax(probs_data)].set_color(<span class="hljs-string">'orange'</span>)

        self.fig.canvas.draw()
        self.fig.canvas.flush_events()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 1. 调用 neural_net.py 中的函数加载/训练模型</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Initializing AI Model..."</span>)
    trained_model, device = train_model()

    <span class="hljs-comment"># 2. 启动 GUI</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Starting GUI..."</span>)
    root = tk.Tk()
    app = DigitRecognizerApp(root, trained_model, device)


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_closing</span>():
        plt.close(<span class="hljs-string">'all'</span>)
        root.destroy()


    root.protocol(<span class="hljs-string">"WM_DELETE_WINDOW"</span>, on_closing)
    root.mainloop()
</code></pre>
<h2 data-id="heading-12">六.源码</h2>
<p>没有模型的话先运行<code>neural_net.py</code>，然后运行<code>gui_app.py</code>。之后使用的话直接运行<code>gui_app.py</code>即可。</p>
<h3 data-id="heading-13">1.neural_net.py</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim
<span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> datasets, transforms
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Net</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>(Net, self).__init__()
        self.fc1 = nn.Linear(<span class="hljs-number">28</span> * <span class="hljs-number">28</span>, <span class="hljs-number">128</span>)
        self.relu = nn.ReLU()
        self.dropout = nn.Dropout(<span class="hljs-number">0.2</span>)
        self.fc2 = nn.Linear(<span class="hljs-number">128</span>, <span class="hljs-number">10</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        x = x.view(-<span class="hljs-number">1</span>, <span class="hljs-number">28</span> * <span class="hljs-number">28</span>)
        x = self.fc1(x)
        x = self.relu(x)
        x = self.dropout(x)
        x = self.fc2(x)
        <span class="hljs-keyword">return</span> torch.log_softmax(x, dim=<span class="hljs-number">1</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">train_model</span>():
    <span class="hljs-string">"""训练模型或加载已有模型"""</span>
    model_path = <span class="hljs-string">"mnist_model.pth"</span>
    device = torch.device(<span class="hljs-string">"cuda"</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">"cpu"</span>)
    model = Net().to(device)

    <span class="hljs-keyword">if</span> os.path.exists(model_path):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发现已保存的模型 <span class="hljs-subst">{model_path}</span>，正在加载..."</span>)
        model.load_state_dict(torch.load(model_path, map_location=device))
        model.<span class="hljs-built_in">eval</span>()
        <span class="hljs-keyword">return</span> model, device

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"未发现模型，开始下载数据集并训练 (准确率目标 &gt; 90%)..."</span>)

    transform = transforms.Compose([
        transforms.ToTensor(),
        transforms.Normalize((<span class="hljs-number">0.1307</span>,), (<span class="hljs-number">0.3081</span>,))
    ])

    train_dataset = datasets.MNIST(<span class="hljs-string">'./data'</span>, train=<span class="hljs-literal">True</span>, download=<span class="hljs-literal">True</span>, transform=transform)
    train_loader = torch.utils.data.DataLoader(train_dataset, batch_size=<span class="hljs-number">64</span>, shuffle=<span class="hljs-literal">True</span>)

    optimizer = optim.Adam(model.parameters(), lr=<span class="hljs-number">0.001</span>)
    criterion = nn.CrossEntropyLoss()

    model.train()
    epochs = <span class="hljs-number">6</span>

    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(epochs):
        <span class="hljs-keyword">for</span> batch_idx, (data, target) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_loader):
            data, target = data.to(device), target.to(device)
            optimizer.zero_grad()
            output = model(data)
            loss = criterion(output, target)
            loss.backward()
            optimizer.step()

            <span class="hljs-keyword">if</span> batch_idx % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Epoch <span class="hljs-subst">{epoch + <span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{epochs}</span> | Batch <span class="hljs-subst">{batch_idx}</span> | Loss: <span class="hljs-subst">{loss.item():<span class="hljs-number">.4</span>f}</span>'</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"训练完成，正在保存模型..."</span>)
    torch.save(model.state_dict(), model_path)
    model.<span class="hljs-built_in">eval</span>()
    <span class="hljs-keyword">return</span> model, device
</code></pre>
<h3 data-id="heading-14">2.gui_app.py</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tkinter <span class="hljs-keyword">as</span> tk
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image, ImageDraw, ImageTk
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> torch

<span class="hljs-comment"># ---导入训练模块---</span>
<span class="hljs-keyword">from</span> neural_net <span class="hljs-keyword">import</span> train_model


<span class="hljs-comment"># ---GUI---</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DigitRecognizerApp</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, root, model, device</span>):
        self.root = root
        self.model = model
        self.device = device
        self.root.title(<span class="hljs-string">"Handwritten Digit Recognition"</span>)

        <span class="hljs-comment"># 布局配置</span>
        self.main_frame = tk.Frame(root, padx=<span class="hljs-number">20</span>, pady=<span class="hljs-number">20</span>)
        self.main_frame.pack()

        <span class="hljs-comment"># 1. 画板区域 (Canvas)</span>
        self.canvas_width = <span class="hljs-number">280</span>
        self.canvas_height = <span class="hljs-number">280</span>
        self.canvas_bg = <span class="hljs-string">"black"</span>
        self.brush_color = <span class="hljs-string">"white"</span>
        self.brush_size = <span class="hljs-number">18</span>

        self.canvas = tk.Canvas(self.main_frame, width=self.canvas_width, height=self.canvas_height, bg=self.canvas_bg,
                                cursor=<span class="hljs-string">"cross"</span>)
        self.canvas.grid(row=<span class="hljs-number">0</span>, column=<span class="hljs-number">0</span>, rowspan=<span class="hljs-number">4</span>, padx=<span class="hljs-number">10</span>, pady=<span class="hljs-number">10</span>)

        <span class="hljs-comment"># 绑定鼠标事件</span>
        self.canvas.bind(<span class="hljs-string">"&lt;B1-Motion&gt;"</span>, self.draw)

        <span class="hljs-comment"># 内存绘图对象 (PIL)</span>
        self.image = Image.new(<span class="hljs-string">"L"</span>, (self.canvas_width, self.canvas_height), self.canvas_bg)
        self.draw_obj = ImageDraw.Draw(self.image)

        <span class="hljs-comment"># 2. 控制区域</span>
        self.btn_frame = tk.Frame(self.main_frame)
        self.btn_frame.grid(row=<span class="hljs-number">0</span>, column=<span class="hljs-number">1</span>, sticky=<span class="hljs-string">"n"</span>)

        self.predict_btn = tk.Button(self.btn_frame, text=<span class="hljs-string">"Predict"</span>, command=self.predict, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">12</span>),
                                     bg=<span class="hljs-string">"#4CAF50"</span>, fg=<span class="hljs-string">"white"</span>)
        self.predict_btn.pack(pady=<span class="hljs-number">10</span>, fill=<span class="hljs-string">"x"</span>)

        self.clear_btn = tk.Button(self.btn_frame, text=<span class="hljs-string">"Clear"</span>, command=self.clear_canvas, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">12</span>))
        self.clear_btn.pack(pady=<span class="hljs-number">10</span>, fill=<span class="hljs-string">"x"</span>)

        <span class="hljs-comment"># 3. 结果显示区域</span>
        self.result_label = tk.Label(self.main_frame, text=<span class="hljs-string">"Prediction: None"</span>, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">16</span>, <span class="hljs-string">"bold"</span>), fg=<span class="hljs-string">"blue"</span>)
        self.result_label.grid(row=<span class="hljs-number">1</span>, column=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 4. 略缩图显示</span>
        tk.Label(self.main_frame, text=<span class="hljs-string">"Neural Network Input:"</span>, font=(<span class="hljs-string">"Arial"</span>, <span class="hljs-number">10</span>)).grid(row=<span class="hljs-number">2</span>, column=<span class="hljs-number">1</span>, sticky=<span class="hljs-string">"s"</span>)
        self.thumb_label = tk.Label(self.main_frame, bg=<span class="hljs-string">"gray"</span>)
        self.thumb_label.grid(row=<span class="hljs-number">3</span>, column=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 5. 初始化 Matplotlib 可视化界面</span>
        plt.ion()
        self.fig, self.ax = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">4</span>))
        self.fig.canvas.manager.set_window_title(<span class="hljs-string">"Neural Network Visualization"</span>)  <span class="hljs-comment"># 英文窗口标题</span>
        self.init_plot()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params">self, event</span>):
        x1, y1 = (event.x - self.brush_size), (event.y - self.brush_size)
        x2, y2 = (event.x + self.brush_size), (event.y + self.brush_size)
        self.canvas.create_oval(x1, y1, x2, y2, fill=self.brush_color, outline=self.brush_color)
        self.draw_obj.ellipse([x1, y1, x2, y2], fill=self.brush_color, outline=self.brush_color)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_canvas</span>(<span class="hljs-params">self</span>):
        self.canvas.delete(<span class="hljs-string">"all"</span>)
        self.image = Image.new(<span class="hljs-string">"L"</span>, (self.canvas_width, self.canvas_height), self.canvas_bg)
        self.draw_obj = ImageDraw.Draw(self.image)
        self.result_label.config(text=<span class="hljs-string">"Prediction: None"</span>)
        self.thumb_label.config(image=<span class="hljs-string">''</span>)
        self.init_plot()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">preprocess_image</span>(<span class="hljs-params">self</span>):
        img_resized = self.image.resize((<span class="hljs-number">28</span>, <span class="hljs-number">28</span>), Image.Resampling.LANCZOS)
        img_array = np.array(img_resized)

        <span class="hljs-comment"># 归一化处理</span>
        img_tensor = torch.tensor(img_array, dtype=torch.float32) / <span class="hljs-number">255.0</span>
        img_tensor = (img_tensor - <span class="hljs-number">0.1307</span>) / <span class="hljs-number">0.3081</span>
        img_tensor = img_tensor.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>)

        <span class="hljs-keyword">return</span> img_tensor, img_resized

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">self</span>):
        input_tensor, pil_thumb = self.preprocess_image()

        <span class="hljs-comment"># 显示略缩图</span>
        display_thumb = pil_thumb.resize((<span class="hljs-number">112</span>, <span class="hljs-number">112</span>), Image.Resampling.NEAREST)
        self.photo_thumb = ImageTk.PhotoImage(display_thumb)
        self.thumb_label.config(image=self.photo_thumb)

        <span class="hljs-comment"># 调用模型推理</span>
        <span class="hljs-keyword">with</span> torch.no_grad():
            output = self.model(input_tensor.to(self.device))
            probs = torch.exp(output)
            prediction = torch.argmax(probs, dim=<span class="hljs-number">1</span>).item()
            confidence = probs[<span class="hljs-number">0</span>][prediction].item()

        self.result_label.config(text=<span class="hljs-string">f"Prediction: <span class="hljs-subst">{prediction}</span>\nConfidence: <span class="hljs-subst">{confidence:<span class="hljs-number">.1</span>%}</span>"</span>)
        self.update_plot(input_tensor, probs)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_plot</span>(<span class="hljs-params">self</span>):
        self.ax[<span class="hljs-number">0</span>].clear()
        self.ax[<span class="hljs-number">0</span>].set_title(<span class="hljs-string">"Input Heatmap"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">0</span>].axis(<span class="hljs-string">'off'</span>)

        self.ax[<span class="hljs-number">1</span>].clear()
        self.ax[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">"Probability Distribution"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">1</span>].set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
        self.ax[<span class="hljs-number">1</span>].set_xticks(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
        self.fig.canvas.draw()
        self.fig.canvas.flush_events()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_plot</span>(<span class="hljs-params">self, input_tensor, probs</span>):
        img_data = input_tensor.squeeze().cpu().numpy()
        self.ax[<span class="hljs-number">0</span>].imshow(img_data, cmap=<span class="hljs-string">'viridis'</span>)

        probs_data = probs.squeeze().cpu().numpy()
        self.ax[<span class="hljs-number">1</span>].clear()
        self.ax[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">"Probability Distribution"</span>)  <span class="hljs-comment"># 英文</span>
        self.ax[<span class="hljs-number">1</span>].set_xticks(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
        self.ax[<span class="hljs-number">1</span>].set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1.1</span>)
        bars = self.ax[<span class="hljs-number">1</span>].bar(<span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>), probs_data, color=<span class="hljs-string">'skyblue'</span>)
        bars[np.argmax(probs_data)].set_color(<span class="hljs-string">'orange'</span>)

        self.fig.canvas.draw()
        self.fig.canvas.flush_events()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 1. 调用 neural_net.py 中的函数加载/训练模型</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Initializing AI Model..."</span>)
    trained_model, device = train_model()

    <span class="hljs-comment"># 2. 启动 GUI</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Starting GUI..."</span>)
    root = tk.Tk()
    app = DigitRecognizerApp(root, trained_model, device)


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_closing</span>():
        plt.close(<span class="hljs-string">'all'</span>)
        root.destroy()


    root.protocol(<span class="hljs-string">"WM_DELETE_WINDOW"</span>, on_closing)
    root.mainloop()
</code></pre>
<h2 data-id="heading-15">七.结语</h2>
<p>恭喜你，我们终于完成了Python神经网络识别手写数字的学习。使用时你可能会发现为什么答案有时不是完全对的，因为我们手写的数字还是与我们使用的训练数据有所出入，所以并不能保证100%识别出，尤其是一些比较复杂的数字，比如3，4，5，8。但是识别率还是挺高的，识别不出来的多写两次也能识别出。我们所学习的只是神经网络的冰山一角和最基础的概念框架，我们仍道阻且长，有更多的等着我们去探索。神经网络本身就在不断学习改错，更何况我们本身就是一个庞大的神经集群在控制。</p>
<p>写这么一篇文章相信大家都有所收获，我也一样！感觉理解又加深了一个层次。</p>
<p>这是我的第一篇文章，可能还存在一些解释上的不全面，如有错误欢迎大家改正！</p>
<p>至此，感谢你的观看！</p>
<p>[1]部分图片来自《Python神经网络编程》塔里克-拉希德</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[day 2 promote工程]]></title>    <link>https://juejin.cn/post/7587243886428913679</link>    <guid>https://juejin.cn/post/7587243886428913679</guid>    <pubDate>2025-12-24T06:21:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587243886428913679" data-draft-id="7587243886428848143" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="day 2 promote工程"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-24T06:21:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古蓬莱掌管玉米的神"/> <meta itemprop="url" content="https://juejin.cn/user/2654634748958267"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            day 2 promote工程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2654634748958267/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    古蓬莱掌管玉米的神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:21:06.000Z" title="Wed Dec 24 2025 06:21:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>LLM的智能和人的智能区别（非技术视角）：
LLM的智能是怎么来的：</p>
<p>1 - 什么是next token prediction：根据上文猜测下一个文字是啥</p>
<p>2 - QKV怎么影响next token prediction，简单来说是收到query后（希望llm输出什么字符），LLM会去看一遍key&amp;value（在这之前都有啥字符），把其中关系（考虑距离和相关性）比较高的内容结合在一起，然后猜下一个字符是啥</p>
<p>3 - 所以transfomer的基本逻辑是，完形填空，永远只填最后一个字（conversation也是人为构建的，没有真正意义的conversation存在，每次都是全量上下文一起进，一轮对话只是一个在末尾的段落）</p>
<p>4 - 简单粗暴的概括，LLM智能是因为预训练阶段见过足够多的完形填空，所以比较能猜，这也是scaling law的本质，假设见过足够多的数据，是不是就总是能猜对。但实际上LLM并没有建立自己的逻辑体系（最近ilya的一篇访谈“scaling的时代已经结束”很值得看一下<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfGlYeGC79wQI_XVX5qnoRw%25EF%25BC%258C%25E4%25BB%2596%25E7%2594%25A8%25E3%2580%258C%25E5%2588%25B7%25E9%25A2%2598%25E5%25AE%25B6%25E3%2580%258D%25E4%25B8%258E%25E3%2580%258C%25E6%259C%2589%25E5%25A4%25A9%25E8%25B5%258B%25E7%259A%2584%25E5%25AD%25A6%25E7%2594%259F%25E3%2580%258D%25E5%2581%259A%25E7%25B1%25BB%25E6%25AF%2594%25E3%2580%2582%25E4%25BB%2596%25E8%25AE%25A4%25E4%25B8%25BA%25E7%259B%25AE%25E5%2589%258D%25E7%259A%2584%25E6%25A8%25A1%25E5%259E%258B%25E5%2583%258F%25E5%2588%25B7%25E4%25BA%2586" target="_blank" title="https://mp.weixin.qq.com/s/fGlYeGC79wQI_XVX5qnoRw%EF%BC%8C%E4%BB%96%E7%94%A8%E3%80%8C%E5%88%B7%E9%A2%98%E5%AE%B6%E3%80%8D%E4%B8%8E%E3%80%8C%E6%9C%89%E5%A4%A9%E8%B5%8B%E7%9A%84%E5%AD%A6%E7%94%9F%E3%80%8D%E5%81%9A%E7%B1%BB%E6%AF%94%E3%80%82%E4%BB%96%E8%AE%A4%E4%B8%BA%E7%9B%AE%E5%89%8D%E7%9A%84%E6%A8%A1%E5%9E%8B%E5%83%8F%E5%88%B7%E4%BA%86" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/fGlYeGC79…</a> 10,000 小时题目的学生，虽然能解题但缺乏真正的智能；而人类（有天赋的学生）即使练习很少，也能展现出更好的泛化能力。）</p>
<p>因此，对于当前的LLM来说，写prompt的本质是构建一个让ta能够更容易猜到答案的完形填空的环境
进一步的，可以把这个原则拆解成下列几个子原则：</p>
<p>1 - 说明当前任务所处的环境至关重要，不说明环境就提要求相当于不给说明书就开始要求组装乐高</p>
<p>2 - 如果不是和任务息息相关，尽可能不要提及太多特殊/个性化的黑话，这些数据在llm训练时很可能也没见过</p>
<p>3 - 确保每条规则都独立存在不互相影响，以及尽可能减少规则式（if else）的要求，规则越多，模型越容易错误参考，让模型自身的填空机制做出更符合预测的选择</p>
<p>4 - 尽量减少对任务无意义的context和减少重复的context，前者会增加填空参考错误信息的风险，后者会增加填空复读的风险</p>
<p>5 - 按照逻辑顺序，越基础、全局、重要的放在前面，因为模型是按顺序读信息的——前面的内容应该是“基础”，后面的内容才是“在这个基础上要做什么”。顺序乱了，模型就更容易猜错。</p>
<p>6 - 相关性强的内容不要分散的放在模型的各处，会分散模型的注意力，尽量都聚合在距离比较近的地方</p>
<p>进一步的，Context工程到底是啥，其实就干四件事：</p>
<p>1 - 怎么帮助模型减少冗余的、可能会干扰填空的上下文</p>
<p>2 - 怎么从一堆数据里找到需要增加给模型的重要的上下文（&lt;=100%一堆数据），强化模型填空的偏向</p>
<p>3 - 怎么定义不同类型的上下文的结构（包括模型自己输出的数据），提高模型填空的稳定性</p>
<p>4 - 怎么排序上下文，更符合模型常见的数据结构</p>
<p>如何判断要不要上工程：</p>
<p>1 - 不是模型做不好就立刻上工程，先检查prompt是不是符合原则，prompt问题大，上了工程也未必解决问题</p>
<p>2 - 超关键场景，需要追求成功率的，别犹豫，直接上工程，从业务逻辑追加的规则也会有幻觉（越特别的、越黑话的
规则，幻觉的概率越大）
3 - 剩下的，商量着来吧，毕竟模型就是个概率学的玩意儿，看看资源优先级，多调调prompt，80%-85%也是提升不是</p>
<p>特别重要的放最后：
都是猜了，要习惯稳定性和准确性的概率风险，也要习惯假设逻辑可能是错的，实验是检验llm的唯一真理</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里开源通义DeepResearch：智能体训练全流程揭秘]]></title>    <link>https://juejin.cn/post/7587284708943003682</link>    <guid>https://juejin.cn/post/7587284708943003682</guid>    <pubDate>2025-12-24T06:31:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587284708943003682" data-draft-id="7586941997196247092" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里开源通义DeepResearch：智能体训练全流程揭秘"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-24T06:31:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智见AGI"/> <meta itemprop="url" content="https://juejin.cn/user/4145611877132986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里开源通义DeepResearch：智能体训练全流程揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4145611877132986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智见AGI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:31:17.000Z" title="Wed Dec 24 2025 06:31:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年9月16日，阿里通义实验室发布了<strong>DeepResearch</strong>，宣称这是一款针对科研场景设计的开源“智能体”模型系统。它不再是简单的对话机器人，而是能像研究人员一样，围绕一个问题构建完整的“研究闭环”：深度检索、跨源交叉、结构化归纳、报告生成，最终输出有引用、可复现的调研报告与决策建议。通义团队通过创新的技术架构和训练方法，使DeepResearch在多个极高难度的信息检索和推理任务中取得了最先进的（SOTA）成绩：</p>
<p>●Humanity’s Last Exam (HLE)：32.9</p>
<p>●BrowseComp‑EN：43.4</p>
<p>●BrowseComp‑ZH：46.7</p>
<p>●xBench‑DeepSearch：75.0</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed3d6f9ce09143429e46c27f8e54dcce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162676&amp;x-signature=75aghD8sxUd2okBkriIlO8P%2FKNQ%3D" alt="" loading="lazy"/></p>
<p>全面超越了目前所有的闭源及开源 Deep Research 智能体（Agent）。不仅如此，通义团队还完整分享了一套可落地的高水平Agent构建方法论，详细介绍了从数据合成、Agentic 增量预训练（CPT）、有监督微调（SFT）冷启动，到强化学习（RL）的全套流程。</p>
<p><strong>数据合成策略：为训练提供海量“燃料”</strong></p>
<p>通义 DeepResearch 独创了<strong>全自动合成数据管道</strong>，彻底摆脱昂贵人工标注的瓶颈。团队设计了一个名为 AgentFounder 的系统，持续从文档、网络爬取数据、知识图谱、工具调用记录等多源采集信息，构建“实体锚定的开放世界知识记忆”。基于采样得到的实体和相关知识，自动生成多种风格的问题–答案对，为预训练和后续微调提供海量基础训练样本。可以把这些过程想象成给模型构建了一个“知识宫殿”和“练习题库”，让它不断积累各种知识和场景下的问答能力。</p>
<p>此外，团队还进行<strong>动作（行为）合成</strong>：基于历史交互轨迹和题目，生成<strong>推理与决策过程</strong>数据。例如，将原始步骤重构为多步规划决策任务，形成多阶段解决方案序列。这些合成轨迹模拟模型在真实 Web 环境中的查询、点击、推理步骤，极大丰富了智能体对不同操作序列的认识，甚至无需额外调用真实 API 就能离线模拟各种复杂推理动作。所有这些数据合成策略形成了一个“数据飞轮”：预训练产生的数据不断供给后续阶段，又反过来促进更多样本的生成。</p>
<p><strong>Agentic 增量预训练 (CPT)：夯实模型基础</strong></p>
<p><strong>Agentic CPT</strong> 相当于给智能体做“扎实的理论学习”。团队首先用合成好的大规模数据对基础语言模型进行增量预训练。在这个阶段，模型并非仅仅背诵静态文本，而是学习一系列模拟“研究过程”的轨迹：比如根据一个查询逐步提取文档信息、调用工具、形成答案。这通过<strong>掩码语言建模</strong>的方式，让模型隐式学会<strong>规划和工具使用</strong>的技能。在类比上，就像让学徒阅读大量专业书籍和案例解析，同时练习整理信息和提出问题，为后续的实践操作打下坚实基础。Agentic CPT 的创新在于其<strong>AgentFounder 数据方案</strong>：利用前述数据合成产生的丰富问答对与推理过程，实现了可扩展的大规模训练。</p>
<p><strong>有监督微调 (SFT) 冷启动：模拟专家示范</strong></p>
<p>在增量预训练后，通义 DeepResearch 会让模型通过有<strong>监督微调 (SFT)</strong> 进行“专家示范”训练，快速进入任务状态。此阶段使用合成的高质量问答和轨迹数据，让模型<strong>学习规范的思考–行动–观察循环</strong>。具体做法是用两种风格的示例训练模型：一是经典的 ReAct 形式（“思考→行动→观察”循环），让模型学会结构化答题；二是团队提出的 IterResearch 形式，即在多轮推理时每轮重新聚焦关键内容，避免上下文信息过多造成干扰。可以把 SFT 阶段比作导师带着学生做练习题：模型在“老师示范”下，把之前打好的理论知识用于具体问答和多轮推理场景。通过这样的冷启动，模型迅速掌握从结构化思考到生成连贯行动的能力，为后续自我优化打下良好基础。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40d8e776da784dc9a2fa68e0a3b312a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162676&amp;x-signature=ihqwGZvKDPKW%2FXPlaEmwWXG9yPE%3D" alt="" loading="lazy"/></p>
<p><strong>强化学习 (RL)：在模拟环境中自我演练</strong></p>
<p>最后进入<strong>强化学习阶段</strong>，让智能体在安全可控的模拟环境中“自行试错”，持续优化决策策略。通义团队采用定制的<strong>GRPO（Group Relative Policy Optimization）算法</strong>，严格遵循on-policy训练范式，确保奖励信号与模型当前能力匹配。在训练目标上，使用了基于Token级别的策略梯度损失，并引入<strong>留一法（leave-one-out）</strong> 来降低方差，同时有选择地剔除过长未完成的负样本，避免模型陷入“格式崩溃”。训练时还通过增大批次和并行实例来稳定学习。类似于模拟战场练习，智能体不断在仿真网页环境中进行查询、点击和推理，每一次成功完成任务都会得到奖励，模型的策略随着奖励（reward）持续上升，探索度（policy entropy）保持高位。这一切都依托稳定的环境和数据支持：团队构建了离线维基百科+自制工具的沙盒模拟环境，并实时自动管理生成数据，以保证训练过程高效且鲁棒。</p>
<p><strong>阶段协同与闭环：不断迭代的训练循环</strong></p>
<p>通义 DeepResearch 的成功还在于各阶段环环相扣、形成闭环。从<strong>CPT</strong>阶段打基础，到<strong>SFT</strong>阶段冷启动，最后到<strong>RL</strong>阶段自我进化，每一步都为下一步提供素材和启发。CPT和SFT产生的合成数据反过来可用于强化学习训练，RL训练新得的轨迹也可反馈到数据管道中，持续丰富训练样本。可谓是一个<strong>不断“自己喂养自己”的训练循环</strong>。正如通义团队所总结的：“从基础模型开始，先进行了 Agentic 持续预训练以初始化工具使用技能，然后使用类似专家的数据进行监督微调以实现冷启动，最后进行基于策略的强化学习，使模型进行自我进化”。这一全栈式方案相当于教会一个学习者：先在课堂上学习知识、再在实验室跟随导师练习，最后独立做项目，实现技能的真实落地。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08efc305c42a4c638e6b851415a215a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767162676&amp;x-signature=GpyS5dY9BdzUqREWxgNoEGxd4vE%3D" alt="" loading="lazy"/></p>
<p>整体来看，通义 DeepResearch 的训练流程兼顾了<strong>规模化合成数据</strong>与<strong>精细化算法设计</strong>。通过高质量数据合成不断为模型提供“训练燃料”，并在各阶段采用面向智能体特性的训练目标和策略，最终培养出能够自主规划、多步推理的开源智能体。这一创新方法论为开源社区提供了完整可复现的方案，揭示了从“聊天机器人”到“自主研究者”转型的路径</p>
<p><strong>应用场景</strong></p>
<p>DeepResearch已在实际产品中得到应用。阿里表示，它已赋能高德地图和“通义法睿”等内部项目。例如，在高德地图中，DeepResearch被用作智能出行Agent：集成专用地图API、实时天气和交通监测等工具，可根据当前情况规划最优路线。通义团队提供Deep Research模型 + 高德团队提供工具和 Agent 链路”，打造了高德 App 中助手「小高老师」的复杂查询体验，在地图行业内打出影响力。</p>
<p>在法律领域，DeepResearch驱动的“通义法睿”智能体能自动检索法律法规、案例和裁判文书，并进行深度归纳分析，在“法条引用相关性”和“案例引用相关性”两项指标上超过了OpenAI和Claude等国际顶尖模型，为法律从业者提供了准确可靠的检索和分析支持。</p>
<p><strong>开源链接</strong></p>
<p>●Homepage:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Ftongyi-agent.github.io%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//tongyi-agent.github.io/" ref="nofollow noopener noreferrer">tongyi-agent.github.io/</a></p>
<p>●Blog:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Ftongyi-agent.github.io%2Fblog%2Fintroducing-tongyi-deep-research%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//tongyi-agent.github.io/blog/introducing-tongyi-deep-research/" ref="nofollow noopener noreferrer">tongyi-agent.github.io/blog/introd…</a></p>
<p>●Github:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2FAlibaba-NLP%2FDeepResearch" target="_blank" title="https://link.zhihu.com/?target=https%3A//github.com/Alibaba-NLP/DeepResearch" ref="nofollow noopener noreferrer">github.com/Alibaba-NLP…</a></p>
<p>●Hugging Face:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fhuggingface.co%2FAlibaba-NLP%2FTongyi-DeepResearch-30B-A3B" target="_blank" title="https://link.zhihu.com/?target=https%3A//huggingface.co/Alibaba-NLP/Tongyi-DeepResearch-30B-A3B" ref="nofollow noopener noreferrer">huggingface.co/Alibaba-NLP…</a></p>
<p>●Model Scope:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmodelscope.cn%2Fmodels%2Fiic%2FTongyi-DeepResearch-30B-A3B" target="_blank" title="https://link.zhihu.com/?target=https%3A//modelscope.cn/models/iic/Tongyi-DeepResearch-30B-A3B" ref="nofollow noopener noreferrer">modelscope.cn/models/ii</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Knip - 一键清理项目无用代码]]></title>    <link>https://juejin.cn/post/7587208390482018310</link>    <guid>https://juejin.cn/post/7587208390482018310</guid>    <pubDate>2025-12-24T06:38:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587208390482018310" data-draft-id="7586971532699975689" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Knip - 一键清理项目无用代码"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-24T06:38:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Immerse"/> <meta itemprop="url" content="https://juejin.cn/user/2708812817761752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Knip - 一键清理项目无用代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2708812817761752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Immerse
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T06:38:00.000Z" title="Wed Dec 24 2025 06:38:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Immerse，一名独立开发者、内容创作者、AGI 实践者。</p>
<p>关注公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com%2Fother%2Fwx_public_account.webp" target="_blank" title="https://yaolifeng.com/other/wx_public_account.webp" ref="nofollow noopener noreferrer">沉浸式趣谈</a>，获取最新文章（更多内容只在公众号更新）</p>
<p>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com" target="_blank" title="https://yaolifeng.com" ref="nofollow noopener noreferrer">yaolifeng.com</a> 也同步更新。</p>
<p>转载请在文章开头注明出处和版权信息。</p>
<p>我会在这里分享关于<code>编程</code>、<code>独立开发</code>、<code>AI干货</code>、<code>开源</code>、<code>个人思考</code>等内容。</p>
<p>如果本文对您有所帮助，欢迎动动小手指一键三连(<code>点赞</code>、<code>评论</code>、<code>转发</code>)，给我一些支持和鼓励，谢谢！</p>
<hr/>
<h2 data-id="heading-0">什么是 Knip？</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2583caa79974700958f7a99af9aca11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163079&amp;x-signature=4ibWEwayDOIOL3nHDkvJixT9y0E%3D" alt="" loading="lazy"/></p>
<p>Knip 是一个专门用来清理 JavaScript 和 TypeScript 项目的工具。</p>
<h2 data-id="heading-1">它能帮你找到什么？</h2>
<p>Knip 主要帮你找出三类"垃圾代码"：</p>
<ol>
<li><strong>未使用的依赖包</strong> - 你安装了但实际没用到的 npm 包</li>
<li><strong>未使用的导出</strong> - 你导出了但没人使用的函数、类、变量等</li>
<li><strong>未使用的文件</strong> - 项目中存在但没被引用的文件</li>
</ol>
<h2 data-id="heading-2">如何使用？</h2>
<h3 data-id="heading-3">快速开始</h3>
<p>使用非常简单！只需要一条命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm init @knip/config
</code></pre>
<p>这个命令会：</p>
<ul>
<li>自动安装 Knip</li>
<li>在你的 <code>package.json</code> 中添加运行脚本</li>
</ul>
<p>然后运行：</p>
<pre><code class="hljs language-bash" lang="bash">npm run knip
</code></pre>
<p>Knip 就会开始分析你的项目，告诉你哪些依赖、导出和文件没有被使用。</p>
<h3 data-id="heading-4">系统要求</h3>
<p>Knip 需要 Node.js 18.18.0 或更高版本，也支持 Bun。</p>
<h2 data-id="heading-5">强大的生态支持</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff5bd2c2aabd4d93bb5dcecaf12720cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767163079&amp;x-signature=vVMv%2BgZJ%2B67vYERb6M2lLYGug1A%3D" alt="" loading="lazy"/></p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fknip.dev" target="_blank" title="https://knip.dev" ref="nofollow noopener noreferrer">knip.dev</a></p>
<p>Knip 不是一个简单的工具，它内置了 100+ 个插件，支持各种流行的框架和工具，比如：</p>
<ul>
<li>Astro、Next.js、Remix、Svelte</li>
<li>Jest、Vitest、Cypress</li>
<li>ESLint、Webpack、Vite</li>
<li>GitHub Actions、Nx、Storybook</li>
<li>以及更多...</li>
</ul>
<p>这意味着 Knip 能够理解这些工具的配置文件，准确分析你的项目结构。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL与Redis缓存一致性方案]]></title>    <link>https://juejin.cn/post/7587021119254151195</link>    <guid>https://juejin.cn/post/7587021119254151195</guid>    <pubDate>2025-12-24T05:50:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587021119254151195" data-draft-id="7586957587077005362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL与Redis缓存一致性方案"/> <meta itemprop="keywords" content="后端,Redis,MySQL"/> <meta itemprop="datePublished" content="2025-12-24T05:50:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="镜花水月linyi"/> <meta itemprop="url" content="https://juejin.cn/user/451256763295396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL与Redis缓存一致性方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/451256763295396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    镜花水月linyi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T05:50:12.000Z" title="Wed Dec 24 2025 05:50:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、缓存一致性问题的本质</h2>
<p>在Java后端开发中，我们习惯通过<code>@Cacheable</code>注解或<code>RedisTemplate</code>操作缓存，但真正理解缓存一致性，必须深入到分布式系统的CAP理论层面。缓存一致性问题的本质是：<strong>在分布式环境下，同一份数据存在于数据库和缓存两个存储介质中，如何保证两者数据的一致性</strong>。</p>
<h3 data-id="heading-1">1.1 CAP理论与一致性</h3>
<p>根据CAP理论，分布式系统无法同时满足一致性(Consistency)、可用性(Availability)、分区容错性(Partition tolerance)。在缓存场景中：</p>
<ul>
<li><strong>强一致性</strong>：任何时刻读取缓存和数据库的数据完全相同，代价是性能下降</li>
<li><strong>最终一致性</strong>：允许短暂的数据不一致，但最终会达到一致状态，是大多数系统的选择</li>
<li><strong>弱一致性</strong>：不保证何时达到一致，适用于对一致性要求极低的场景</li>
</ul>
<h3 data-id="heading-2">1.2 一致性问题的分类</h3>



































<table><thead><tr><th>问题类型</th><th>描述</th><th>危害程度</th><th>评估依据</th></tr></thead><tbody><tr><td>缓存与DB不一致</td><td>缓存数据是旧值，DB是新值</td><td>高</td><td>持续到缓存过期，影响用户体验</td></tr><tr><td>并发写导致错乱</td><td>多线程同时写入导致数据覆盖</td><td>高</td><td>数据永久错误，需人工修复</td></tr><tr><td>删除缓存失败</td><td>DB更新成功但缓存删除失败</td><td>高</td><td>网络抖动时发生，需重试机制</td></tr><tr><td>读写并发冲突</td><td>读线程回填旧值覆盖新值</td><td>中</td><td>需缓存miss+特定时序，罕见</td></tr></tbody></table>
<p><strong>缓存架构总览图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef19358ad6714489a71de437125057fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=Ia3qbkQs9w3QboPLKfa3H%2F86ITQ%3D" alt="缓存架构总览.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-3">1.3 为什么需要缓存？</h3>
<p>缓存的核心价值在于<strong>以空间换时间</strong>，将热点数据存储在内存中，减少数据库访问压力。</p>
<p><strong>经典业务场景：电商商品详情页</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 无缓存：每次请求都查询数据库</span>
<span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-keyword">return</span> productMapper.selectById(productId);
    <span class="hljs-comment">// QPS上限：约500-1000（受限于数据库连接池和磁盘IO）</span>
}

<span class="hljs-comment">// 有缓存：优先从Redis读取</span>
<span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithCache</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(key);
    <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) {
        product = productMapper.selectById(productId);
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(key, product, <span class="hljs-number">30</span>, TimeUnit.MINUTES);
        }
    }
    <span class="hljs-keyword">return</span> product;
    <span class="hljs-comment">// QPS上限：约10000-50000（取决于Redis集群规模）</span>
}
</code></pre>
<h2 data-id="heading-4">二、缓存读写策略详解</h2>
<p>业界主流的缓存读写策略有三种，它们在一致性、性能、复杂度之间做出不同的权衡。理解这三种策略的本质区别，是选择合适方案的前提。</p>
<h3 data-id="heading-5">2.1 三种经典缓存策略对比</h3>





































<table><thead><tr><th>策略</th><th>读流程</th><th>写流程</th><th>一致性</th><th>复杂度</th><th>适用场景</th></tr></thead><tbody><tr><td>Cache Aside</td><td>先读缓存，miss则读DB并回填</td><td>先更新DB，再删除缓存</td><td>最终一致</td><td>低</td><td><strong>通用场景（推荐）</strong></td></tr><tr><td>Read/Write Through</td><td>应用只与缓存交互</td><td>缓存代理负责同步DB</td><td>强一致</td><td>高</td><td>缓存中间件支持</td></tr><tr><td>Write Behind</td><td>应用只与缓存交互</td><td>缓存异步批量写DB</td><td>弱一致</td><td>高</td><td>写密集、允许丢数据</td></tr></tbody></table>
<p><strong>三种缓存策略架构对比图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03584550be5644539ec66c2145a651d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=t5hLvU3UB4GaSlrHF30EJUr2HGA%3D" alt="三种缓存策略对比.drawio.png" loading="lazy"/></p>
<p><strong>策略选择建议：</strong></p>
<ul>
<li><strong>Cache Aside</strong>：应用层控制缓存逻辑，灵活性高，是绝大多数互联网公司的首选</li>
<li><strong>Read/Write Through</strong>：需要缓存中间件支持（如Redis Module），适合有强一致性需求且中间件支持的场景</li>
<li><strong>Write Behind</strong>：写入性能极高，但存在数据丢失风险，仅适用于日志、统计等可丢失场景</li>
</ul>
<h3 data-id="heading-6">2.2 Cache Aside模式详解（业界主流）</h3>
<p>Cache Aside模式（旁路缓存）是业界使用最广泛的缓存策略，其核心思想是<strong>应用程序同时维护缓存和数据库</strong>，而不是依赖缓存中间件自动同步。</p>
<p><strong>读流程核心逻辑：</strong></p>
<ol>
<li>先查询缓存，命中则直接返回</li>
<li>缓存未命中，查询数据库</li>
<li>将数据库结果回填到缓存（设置合理的过期时间）</li>
</ol>
<p><strong>写流程核心逻辑：</strong></p>
<ol>
<li>先更新数据库（保证数据持久化）</li>
<li>再删除缓存（而非更新缓存）</li>
</ol>
<p><strong>Cache Aside读流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa91937a5610476ba568bbd17aaddce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=KJq8v3R8Y2E9vqR3cgMvdNlaA88%3D" alt="CacheAside读流程.drawio.png" loading="lazy"/></p>
<p><strong>Cache Aside写流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ea046e98a3f428ea2ec6ad25b21fb14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=Yq2RfO5uTI8OcDRnhg2V1TCjkS4%3D" alt="CacheAside写流程.drawio.png" loading="lazy"/></p>
<p><strong>Java实现代码：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCT_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">CACHE_TTL</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span> * <span class="hljs-number">60</span>; <span class="hljs-comment">// 30分钟</span>
    
    <span class="hljs-comment">/**
     * Cache Aside 读取模式
     */</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> PRODUCT_KEY_PREFIX + productId;
        
        <span class="hljs-comment">// 1. 先查缓存</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(key);
        <span class="hljs-keyword">if</span> (StringUtils.hasText(json)) {
            <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
        }
        
        <span class="hljs-comment">// 2. 缓存未命中，查数据库</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
        
        <span class="hljs-comment">// 3. 回填缓存（注意空值处理，防止缓存穿透）</span>
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(key, JSON.toJSONString(product), 
                CACHE_TTL, TimeUnit.SECONDS);
        } <span class="hljs-keyword">else</span> {
            redisTemplate.opsForValue().set(key, <span class="hljs-string">""</span>, <span class="hljs-number">60</span>, TimeUnit.SECONDS);
        }
        <span class="hljs-keyword">return</span> product;
    }
    
    <span class="hljs-comment">/**
     * Cache Aside 写入模式
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-comment">// 1. 先更新数据库</span>
        productMapper.updateById(product);
        <span class="hljs-comment">// 2. 再删除缓存</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> PRODUCT_KEY_PREFIX + product.getId();
        redisTemplate.delete(key);
    }
}
</code></pre>
<h2 data-id="heading-7">三、缓存一致性问题深度分析</h2>
<p>这是缓存一致性最核心的章节，我们来深入分析几个关键问题：为什么删除而不是更新？为什么先更新DB后删缓存？这些问题的答案直接决定了系统的数据一致性。</p>
<h3 data-id="heading-8">3.1 为什么是"删除缓存"而不是"更新缓存"？</h3>
<p>这是一个面试高频问题。直觉上，更新缓存似乎更高效（避免下次cache miss），但实际上<strong>删除缓存才是正确选择</strong>，原因有二：</p>
<p><strong>原因一：避免并发写导致数据错乱</strong></p>
<p>假设两个线程同时更新同一条数据：</p>
<ul>
<li>线程A更新DB为100，然后准备更新缓存</li>
<li>线程B更新DB为200，然后更新缓存为200</li>
<li>线程A由于网络延迟，最后才更新缓存为100</li>
<li><strong>结果</strong>：DB=200，缓存=100，数据不一致！</li>
</ul>
<p><strong>原因二：避免无效的缓存计算</strong></p>
<p>如果缓存数据是经过复杂计算得出的（如多表JOIN、聚合统计），每次更新都重新计算是浪费资源。而删除缓存后，只有真正被访问时才计算，这就是<strong>懒加载思想</strong>。</p>























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>推荐度</th></tr></thead><tbody><tr><td>更新缓存</td><td>缓存始终有值，无穿透风险</td><td>并发写导致数据错乱、无效计算</td><td>不推荐</td></tr><tr><td>删除缓存</td><td>简单可靠、避免并发问题、懒加载</td><td>下次读有一次cache miss</td><td><strong>推荐</strong></td></tr></tbody></table>
<p><strong>并发更新缓存导致数据错乱示意图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97265f130633445da276648e9fda3228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=eLkCEe2cT%2FBldQWRDIdQM8YZdFA%3D" alt="并发更新缓存问题.drawio.png" loading="lazy"/></p>
<p><strong>删除缓存方案（推荐）：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c24497d6c8394f47b632cb5aea63df07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=VgGp0XK3iV5vWadxcr7fb0d8iMg%3D" alt="删除缓存方案.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-9">3.2 为什么是"先更新DB，后删除缓存"？</h3>
<p>这是另一个高频面试题。既然要操作DB和缓存，那必然有先后顺序，我们来分析两种组合：</p>
<p><strong>组合一：先更新DB，后删除缓存（推荐）</strong></p>
<p>时间线：
T1: 线程A更新DB (price=100)
T2: 线程B读取缓存（命中旧值80）
T3: 线程B返回旧值80
T4: 线程A删除缓存
T5: 后续请求读取DB，获得最新值100</p>
<p>这种方案的问题是：在T2-T3时间窗口内，可能读到旧数据。但这个窗口极短（通常&lt;1ms），且下次读取就能获得最新值。</p>
<p><strong>方案对比分析图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76c4402f74274b34b4cf8c592e2f2aa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=hYy6VhPyY5X9xE1FMBhvWPvxaNA%3D" alt="先更新DB后删缓存.drawio.png" loading="lazy"/></p>
<p><strong>组合二：先删除缓存，后更新DB（不推荐）</strong></p>
<p>时间线：
T1: 线程A删除缓存
T2: 线程B读取缓存（未命中）
T3: 线程B读取DB（旧值80）
T4: 线程A更新DB (price=100)
T5: 线程B将旧值80写入缓存
T6: 后续请求读取缓存，持续返回旧值80！</p>
<p>这种方案的严重问题是：<strong>缓存中会长时间存储旧数据</strong>，直到缓存过期或下次更新才能修复。</p>
<p><strong>先删除缓存后更新DB的问题：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f835b0ecd934a048eae9fe7178df088~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=yoB2dSFrMLfK%2BcKQETnkP2l1LO0%3D" alt="先删缓存后更新DB问题.drawio.png" loading="lazy"/></p>
<blockquote>
<p><strong>结论</strong>：先更新DB，后删除缓存是最佳实践。虽然存在短暂不一致窗口，但这是可接受的最终一致性；而先删缓存可能导致长时间数据错误。</p>
</blockquote>
<h3 data-id="heading-10">3.3 删除缓存失败怎么办？</h3>
<p>在分布式环境中，网络是不可靠的。如果DB更新成功，但缓存删除失败（网络抖动、Redis故障等），就会导致缓存中一直存储旧数据。</p>
<p><strong>解决方案：基于消息队列的异步重试机制</strong></p>
<p>核心思路：</p>
<ol>
<li>尝试删除缓存</li>
<li>如果失败，将删除任务发送到消息队列</li>
<li>消费者异步重试删除，采用退避策略</li>
<li>超过最大重试次数则告警，人工介入</li>
</ol>
<p><strong>重试机制架构图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/590da48736da40369621eee11d97f737~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=rv5dccvW8bIZMpfgBwWEpIsjnbc%3D" alt="缓存删除重试机制.drawio.png" loading="lazy"/></p>
<p><strong>Java实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;
    
    <span class="hljs-comment">/**
     * 带重试机制的缓存删除
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteCache</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Boolean</span> <span class="hljs-variable">deleted</span> <span class="hljs-operator">=</span> redisTemplate.delete(key);
            <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(deleted)) {
                <span class="hljs-keyword">return</span>;
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Failed to delete cache: {}"</span>, key, e);
        }
        <span class="hljs-comment">// 删除失败，发送到消息队列进行异步重试</span>
        <span class="hljs-type">CacheDeleteMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheDeleteMessage</span>(key, <span class="hljs-number">0</span>);
        rabbitTemplate.convertAndSend(<span class="hljs-string">"cache.delete.queue"</span>, message);
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheDeleteRetryConsumer</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_RETRY</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
    
    <span class="hljs-meta">@RabbitListener(queues = "cache.delete.queue")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleCacheDelete</span><span class="hljs-params">(CacheDeleteMessage message)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> message.getKey();
        <span class="hljs-type">int</span> <span class="hljs-variable">retryCount</span> <span class="hljs-operator">=</span> message.getRetryCount();
        
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">100</span> * (retryCount + <span class="hljs-number">1</span>)); <span class="hljs-comment">// 退避策略</span>
            redisTemplate.delete(key);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (retryCount &lt; MAX_RETRY) {
                message.setRetryCount(retryCount + <span class="hljs-number">1</span>);
                rabbitTemplate.convertAndSend(<span class="hljs-string">"cache.delete.queue"</span>, message);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Max retry reached for cache delete: {}"</span>, key);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-11">四、延迟双删策略</h2>
<p>延迟双删是针对<strong>极端并发场景</strong>的补充方案。虽然"先更新DB后删缓存"已经是最佳实践，但在特定条件下仍可能出现数据不一致。</p>
<blockquote>
<p><strong>方案演进说明</strong>：你可能注意到，第三章强调"先更新DB后删缓存"，而延迟双删却采用"先删缓存"。这看似矛盾，实则是不同场景的权衡：</p>
<ul>
<li>基本方案追求<strong>简单可靠</strong>，适用于99%的场景</li>
<li>延迟双删针对<strong>极端并发</strong>，通过第一次删除"临时封锁"读请求，牺牲少量性能换取更高一致性</li>
<li>两者可以结合使用：先删缓存→更新DB→延迟再删，覆盖更多边界场景</li>
</ul>
</blockquote>
<h3 data-id="heading-12">4.1 为什么需要延迟双删？</h3>
<p><strong>触发条件（同时满足）：</strong></p>
<ol>
<li>缓存刚好在此时过期（或不存在）</li>
<li>读请求在写请求"更新DB"和"删除缓存"之间到达</li>
<li>读请求的"回填缓存"操作晚于写请求的"删除缓存"</li>
</ol>
<p>这种情况概率极低（通常&lt;0.01%），但在高并发场景下确实可能发生。</p>
<p><strong>极端并发场景分析图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91dc0c0ac4fd44fe86cc2dbfe20af524~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=OXcrdO17zT502n19M1%2FPBUGENlM%3D" alt="延迟双删场景分析.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-13">4.2 延迟双删实现</h3>
<p><strong>延迟双删流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40a6709dba6a431b96707fe5d086974c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=02As%2FXvOk5LfuEhWfONFmro7qw8%3D" alt="延迟双删流程.drawio.png" loading="lazy"/></p>
<p><strong>Java实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCT_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span>;
    
    <span class="hljs-comment">/**
     * 延迟双删策略
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProductWithDoubleDelete</span><span class="hljs-params">(Product product, <span class="hljs-type">long</span> delayMs)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> PRODUCT_KEY_PREFIX + product.getId();
        
        <span class="hljs-comment">// 1. 第一次删除缓存</span>
        redisTemplate.delete(key);
        
        <span class="hljs-comment">// 2. 更新数据库</span>
        productMapper.updateById(product);
        
        <span class="hljs-comment">// 3. 延迟第二次删除缓存</span>
        CompletableFuture.delayedExecutor(delayMs, TimeUnit.MILLISECONDS)
            .execute(() -&gt; redisTemplate.delete(key));
    }
}
</code></pre>
<p><strong>延迟双删的局限性：</strong></p>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>解决极端并发问题</td><td>延迟期间仍可能不一致</td></tr><tr><td>实现相对简单</td><td>增加系统复杂度</td></tr><tr><td>无需额外中间件</td><td>延迟时间难以精确计算</td></tr></tbody></table>
<blockquote>
<p><strong>建议</strong>：对于大多数业务场景，"先更新DB后删缓存 + 合理的过期时间"已经足够。只有在对一致性要求较高且写并发较大的场景，才需要引入延迟双删。</p>
</blockquote>
<h2 data-id="heading-14">五、基于Binlog的最终一致性方案</h2>
<p>基于Binlog的方案是<strong>业务代码零侵入</strong>的终极方案，通过监听MySQL的Binlog变更，异步同步到缓存。这种方案常用于：</p>
<ul>
<li>微服务架构下的数据同步</li>
<li>对一致性要求较高但允许秒级延迟的场景</li>
<li>需要解耦业务代码与缓存逻辑的场景</li>
</ul>
<h3 data-id="heading-15">5.1 方案架构</h3>
<p><strong>核心组件：</strong></p>
<ul>
<li><strong>Canal</strong>：阿里开源的MySQL Binlog增量订阅组件，伪装成MySQL从库</li>
<li><strong>消息队列</strong>：Kafka/RocketMQ，用于解耦和削峰</li>
<li><strong>缓存同步服务</strong>：消费Binlog消息，执行缓存更新/删除</li>
</ul>
<p><strong>Binlog缓存同步架构图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/425d163a4fb44eab97703d5fa9c01d79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=Cmfmu8wPlSI6BWmjB4mL3%2B0%2BkM4%3D" alt="Binlog缓存同步架构.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-16">5.2 Canal配置与使用</h3>
<p><strong>MySQL开启Binlog：</strong></p>
<pre><code class="hljs language-sql" lang="sql">[mysqld]
log<span class="hljs-operator">-</span>bin<span class="hljs-operator">=</span>mysql<span class="hljs-operator">-</span>bin
binlog<span class="hljs-operator">-</span>format<span class="hljs-operator">=</span><span class="hljs-type">ROW</span>
server<span class="hljs-operator">-</span>id<span class="hljs-operator">=</span><span class="hljs-number">1</span>

<span class="hljs-comment">-- 创建Canal用户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'canal'</span>@<span class="hljs-string">'%'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'canal123'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, REPLICATION SLAVE, REPLICATION CLIENT <span class="hljs-keyword">ON</span> <span class="hljs-operator">*</span>.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'canal'</span>@<span class="hljs-string">'%'</span>;
</code></pre>
<p><strong>Java消费端实现（完整版）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;
<span class="hljs-keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * Binlog缓存同步服务 - 处理INSERT/UPDATE/DELETE事件
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RocketMQMessageListener(topic = "canal_product_topic", consumerGroup = "cache_sync_group")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanalMessageConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;CanalMessage&gt; {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CACHE_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">CACHE_TTL</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span> * <span class="hljs-number">60</span>; <span class="hljs-comment">// 30分钟</span>
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(CanalMessage message)</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-string">"product"</span>.equals(message.getTable())) {
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-type">String</span> <span class="hljs-variable">eventType</span> <span class="hljs-operator">=</span> message.getType();
        log.info(<span class="hljs-string">"Received binlog event: table={}, type={}"</span>, message.getTable(), eventType);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (Map&lt;String, String&gt; data : message.getData()) {
                <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> data.get(<span class="hljs-string">"id"</span>);
                <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_KEY_PREFIX + id;
                
                <span class="hljs-keyword">switch</span> (eventType) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"INSERT"</span>:
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"UPDATE"</span>:
                        <span class="hljs-comment">// 方式一：直接删除缓存（推荐，简单可靠）</span>
                        redisTemplate.delete(key);
                        <span class="hljs-comment">// 方式二：更新缓存（可选，适合读多写少）</span>
                        <span class="hljs-comment">// String json = JSON.toJSONString(data);</span>
                        <span class="hljs-comment">// redisTemplate.opsForValue().set(key, json, CACHE_TTL, TimeUnit.SECONDS);</span>
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"DELETE"</span>:
                        redisTemplate.delete(key);
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">default</span>:
                        log.warn(<span class="hljs-string">"Unknown event type: {}"</span>, eventType);
                }
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Failed to process binlog message: {}"</span>, message, e);
            <span class="hljs-comment">// 消费失败，RocketMQ会自动重试</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Binlog sync failed"</span>, e);
        }
    }
}

<span class="hljs-comment">/**
 * Canal消息实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanalMessage</span> {
    <span class="hljs-keyword">private</span> String database;
    <span class="hljs-keyword">private</span> String table;
    <span class="hljs-keyword">private</span> String type;  <span class="hljs-comment">// INSERT, UPDATE, DELETE</span>
    <span class="hljs-keyword">private</span> List&lt;Map&lt;String, String&gt;&gt; data;
    <span class="hljs-keyword">private</span> List&lt;Map&lt;String, String&gt;&gt; old;  <span class="hljs-comment">// UPDATE时的旧值</span>
}
</code></pre>
<h3 data-id="heading-17">5.3 Binlog方案的可靠性与监控</h3>
<p><strong>潜在风险与应对：</strong></p>






























<table><thead><tr><th>风险点</th><th>描述</th><th>应对措施</th></tr></thead><tbody><tr><td>Canal延迟</td><td>Binlog解析+MQ投递，通常1-5秒</td><td>Prometheus监控Canal延迟，超阈值告警</td></tr><tr><td>Canal故障</td><td>进程挂掉或主从切换</td><td>部署高可用集群，Zookeeper选主</td></tr><tr><td>MQ消费失败</td><td>网络抖动或Redis故障</td><td>配置重试策略，死信队列兜底</td></tr><tr><td>消息积压</td><td>写入高峰期处理不及时</td><td>扩容消费者，监控lag指标</td></tr></tbody></table>
<p><strong>监控要点：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Prometheus监控指标示例</span>
<span class="hljs-string">canal_binlog_delay_seconds</span>  <span class="hljs-comment"># Canal解析延迟</span>
<span class="hljs-string">rocketmq_consumer_lag</span>       <span class="hljs-comment"># 消费积压量</span>
<span class="hljs-string">redis_cache_sync_success</span>    <span class="hljs-comment"># 同步成功率</span>
<span class="hljs-string">redis_cache_sync_latency</span>    <span class="hljs-comment"># 同步延迟</span>
</code></pre>
<h3 data-id="heading-18">5.4 Binlog方案优缺点</h3>






























<table><thead><tr><th>维度</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>一致性</td><td>最终一致性保证强</td><td>存在1-5秒延迟（Canal+MQ）</td></tr><tr><td>侵入性</td><td>业务代码零侵入</td><td>需运维Canal/Zookeeper集群</td></tr><tr><td>可靠性</td><td>Binlog本身不丢失</td><td>下游消费可能失败，需重试机制</td></tr><tr><td>扩展性</td><td>支持多表、多数据源同步</td><td>架构复杂度显著增加</td></tr></tbody></table>
<blockquote>
<p><strong>与Debezium对比</strong>：Debezium是另一个流行的CDC工具，支持更多数据库（PostgreSQL、MongoDB等），与Kafka Connector集成更好。Canal更适合国内MySQL生态，社区活跃度高。</p>
</blockquote>
<h2 data-id="heading-19">六、分布式锁方案</h2>
<p>当业务对一致性有<strong>强要求</strong>（如金融交易、库存扣减）时，可以使用分布式锁来保证缓存和数据库的强一致性。</p>
<h3 data-id="heading-20">6.1 读写锁保证强一致性</h3>
<p><strong>核心思想：</strong></p>
<ul>
<li>读操作获取<strong>读锁</strong>，允许多个读并发</li>
<li>写操作获取<strong>写锁</strong>，独占访问，阻塞其他读写</li>
<li>写锁释放后，其他读请求才能继续，保证读到最新数据</li>
</ul>
<p><strong>分布式读写锁架构图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/013a5f9ab53b4d019cf196470c85e53b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=6TqCKYUj4gn6lzGCejeLhvrsHWw%3D" alt="分布式读写锁架构.drawio.png" loading="lazy"/></p>
<p><strong>Java完整实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCK_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:product:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CACHE_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span>;
    
    <span class="hljs-comment">/**
     * 带读锁的查询
     */</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithLock</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_KEY_PREFIX + productId;
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> CACHE_KEY_PREFIX + productId;
        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redissonClient.getReadWriteLock(lockKey);
        <span class="hljs-type">RLock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取读锁，允许多个读并发</span>
            readLock.lock(<span class="hljs-number">10</span>, TimeUnit.SECONDS);
            
            <span class="hljs-comment">// 先查缓存</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
            <span class="hljs-keyword">if</span> (StringUtils.hasText(json)) {
                <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
            }
            
            <span class="hljs-comment">// 缓存miss，查数据库并回填</span>
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                redisTemplate.opsForValue().set(cacheKey, 
                    JSON.toJSONString(product), <span class="hljs-number">30</span>, TimeUnit.MINUTES);
            }
            <span class="hljs-keyword">return</span> product;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (readLock.isHeldByCurrentThread()) {
                readLock.unlock();
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 带写锁的更新
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProductWithLock</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_KEY_PREFIX + product.getId();
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> CACHE_KEY_PREFIX + product.getId();
        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redissonClient.getReadWriteLock(lockKey);
        <span class="hljs-type">RLock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取写锁，独占访问</span>
            writeLock.lock(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
            
            <span class="hljs-comment">// 更新数据库</span>
            productMapper.updateById(product);
            
            <span class="hljs-comment">// 删除缓存</span>
            redisTemplate.delete(cacheKey);
            
            log.info(<span class="hljs-string">"Product updated with lock: {}"</span>, product.getId());
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (writeLock.isHeldByCurrentThread()) {
                writeLock.unlock();
            }
        }
    }
}
</code></pre>
<p><strong>读写锁兼容性：</strong></p>

























<table><thead><tr><th>当前持有</th><th>读锁请求</th><th>写锁请求</th></tr></thead><tbody><tr><td>无锁</td><td>允许</td><td>允许</td></tr><tr><td>读锁</td><td>允许</td><td>阻塞</td></tr><tr><td>写锁</td><td>阻塞</td><td>阻塞</td></tr></tbody></table>
<p><strong>分布式锁方案的注意事项：</strong></p>
<ol>
<li><strong>锁粒度</strong>：锁的Key应该细化到具体数据ID，避免锁范围过大影响性能</li>
<li><strong>超时设置</strong>：必须设置锁超时，防止死锁</li>
<li><strong>性能影响</strong>：读写锁会降低系统吞吐量，仅在强一致性场景使用</li>
<li><strong>锁续期</strong>：对于长事务，考虑使用Redisson的看门狗机制自动续期</li>
<li><strong>锁重入</strong>：Redisson的RReadWriteLock支持锁重入，同一线程可多次获取</li>
</ol>
<blockquote>
<p><strong>建议</strong>：分布式锁方案仅适用于<strong>读多写少且对一致性有强要求</strong>的场景（如账户余额、库存扣减）。对于一般业务，Cache Aside + 合理TTL已足够。</p>
</blockquote>
<h2 data-id="heading-21">七、缓存一致性方案选型指南</h2>
<p>选择合适的缓存一致性方案，需要综合考虑业务场景、一致性要求、系统复杂度等因素。</p>
<h3 data-id="heading-22">7.1 方案对比总结</h3>















































<table><thead><tr><th>方案</th><th>一致性级别</th><th>实现复杂度</th><th>性能影响</th><th>适用场景</th></tr></thead><tbody><tr><td>Cache Aside</td><td>最终一致(ms级)</td><td>低</td><td>无</td><td><strong>通用场景（首选）</strong></td></tr><tr><td>延迟双删</td><td>最终一致(百ms级)</td><td>中</td><td>低</td><td>并发写入较多</td></tr><tr><td>MQ重试</td><td>最终一致(秒级)</td><td>中</td><td>无</td><td>网络不稳定</td></tr><tr><td>Binlog订阅</td><td>最终一致(秒级)</td><td>高</td><td>无</td><td>强一致性、数据同步</td></tr><tr><td>分布式锁</td><td>强一致</td><td>中</td><td>高</td><td>金融级要求</td></tr></tbody></table>
<h3 data-id="heading-23">7.2 决策流程图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba1623e794474f2aa2842d7b59f15027~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZWc6Iqx5rC05pyIbGlueWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767160211&amp;x-signature=diE1F0FITPhkuPOWxGD9hQDohQc%3D" alt="缓存方案选型决策.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-24">7.3 缓存三大经典问题</h3>
<p>除了一致性问题，缓存还有三个必须处理的经典问题：</p>

























<table><thead><tr><th>问题</th><th>描述</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>缓存穿透</strong></td><td>查询不存在的数据，每次都打到DB</td><td>缓存空值、布隆过滤器</td></tr><tr><td><strong>缓存击穿</strong></td><td>热点Key过期瞬间，大量请求打到DB</td><td>分布式锁、永不过期+异步更新</td></tr><tr><td><strong>缓存雪崩</strong></td><td>大量Key同时过期，DB瞬间压力剧增</td><td>过期时间加随机值、多级缓存</td></tr></tbody></table>
<h4 data-id="heading-25">7.3.1 缓存穿透防护</h4>
<p><strong>方案一：缓存空值</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(key);
    
    <span class="hljs-comment">// 缓存命中（包括空值标记）</span>
    <span class="hljs-keyword">if</span> (json != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (json.isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 空值标记，防止穿透</span>
        }
        <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
    }
    
    <span class="hljs-comment">// 查询数据库</span>
    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
    
    <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
        redisTemplate.opsForValue().set(key, JSON.toJSONString(product), <span class="hljs-number">30</span>, TimeUnit.MINUTES);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 缓存空值，短过期时间</span>
        redisTemplate.opsForValue().set(key, <span class="hljs-string">""</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
    }
    <span class="hljs-keyword">return</span> product;
}
</code></pre>
<p><strong>方案二：布隆过滤器（Redisson实现）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;
    
    <span class="hljs-keyword">private</span> RBloomFilter&lt;Long&gt; bloomFilter;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initBloomFilter</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 初始化布隆过滤器：预计元素数量100w，误判率0.01%</span>
        bloomFilter = redissonClient.getBloomFilter(<span class="hljs-string">"product:bloom"</span>);
        bloomFilter.tryInit(<span class="hljs-number">1_000_000L</span>, <span class="hljs-number">0.0001</span>);
        
        <span class="hljs-comment">// 预热：加载所有商品ID</span>
        List&lt;Long&gt; allIds = productMapper.selectAllIds();
        allIds.forEach(bloomFilter::add);
        log.info(<span class="hljs-string">"Bloom filter initialized with {} products"</span>, allIds.size());
    }
    
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithBloom</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-comment">// 1. 布隆过滤器快速判断</span>
        <span class="hljs-keyword">if</span> (!bloomFilter.contains(productId)) {
            log.debug(<span class="hljs-string">"Product {} not in bloom filter"</span>, productId);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 一定不存在</span>
        }
        
        <span class="hljs-comment">// 2. 布隆过滤器判断存在，但可能误判，继续查缓存和DB</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(key);
        <span class="hljs-keyword">if</span> (StringUtils.hasText(json)) {
            <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
        }
        
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(key, JSON.toJSONString(product), <span class="hljs-number">30</span>, TimeUnit.MINUTES);
        }
        <span class="hljs-keyword">return</span> product;
    }
}
</code></pre>
<h4 data-id="heading-26">7.3.2 缓存击穿防护</h4>
<p><strong>方案一：分布式锁重建缓存</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithLockRebuild</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:rebuild:"</span> + productId;
    
    <span class="hljs-comment">// 1. 先查缓存</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
    <span class="hljs-keyword">if</span> (StringUtils.hasText(json)) {
        <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
    }
    
    <span class="hljs-comment">// 2. 缓存miss，尝试获取锁重建</span>
    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 等待最多3秒获取锁</span>
        <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS)) {
            <span class="hljs-comment">// 双重检查</span>
            json = redisTemplate.opsForValue().get(cacheKey);
            <span class="hljs-keyword">if</span> (StringUtils.hasText(json)) {
                <span class="hljs-keyword">return</span> JSON.parseObject(json, Product.class);
            }
            
            <span class="hljs-comment">// 查询DB并重建缓存</span>
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                redisTemplate.opsForValue().set(cacheKey, 
                    JSON.toJSONString(product), <span class="hljs-number">30</span>, TimeUnit.MINUTES);
            }
            <span class="hljs-keyword">return</span> product;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 获取锁失败，短暂等待后重试</span>
            Thread.sleep(<span class="hljs-number">100</span>);
            <span class="hljs-keyword">return</span> getProductWithLockRebuild(productId);
        }
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        Thread.currentThread().interrupt();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Lock interrupted"</span>, e);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
</code></pre>
<p><strong>方案二：逻辑过期+异步更新</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheData</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> T data;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> expireTime; <span class="hljs-comment">// 逻辑过期时间戳</span>
}

<span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithLogicalExpire</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
    
    <span class="hljs-keyword">if</span> (!StringUtils.hasText(json)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 需要预热</span>
    }
    
    CacheData&lt;Product&gt; cacheData = JSON.parseObject(json, 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;CacheData&lt;Product&gt;&gt;(){});
    
    <span class="hljs-comment">// 未过期，直接返回</span>
    <span class="hljs-keyword">if</span> (cacheData.getExpireTime() &gt; System.currentTimeMillis()) {
        <span class="hljs-keyword">return</span> cacheData.getData();
    }
    
    <span class="hljs-comment">// 已过期，异步更新</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:async:"</span> + productId;
    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
    <span class="hljs-keyword">if</span> (lock.tryLock()) {
        <span class="hljs-comment">// 异步更新缓存</span>
        CompletableFuture.runAsync(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
                CacheData&lt;Product&gt; newData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheData</span>&lt;&gt;();
                newData.setData(product);
                newData.setExpireTime(System.currentTimeMillis() + <span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
                redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(newData));
            } <span class="hljs-keyword">finally</span> {
                lock.unlock();
            }
        });
    }
    
    <span class="hljs-comment">// 返回旧数据（兜底）</span>
    <span class="hljs-keyword">return</span> cacheData.getData();
}
</code></pre>
<h4 data-id="heading-27">7.3.3 缓存雪崩防护</h4>
<p><strong>随机过期时间</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Random</span> <span class="hljs-variable">RANDOM</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWithRandomExpire</span><span class="hljs-params">(String key, Object value, <span class="hljs-type">long</span> baseMinutes)</span> {
    <span class="hljs-comment">// 基础过期时间 + 随机0-10分钟</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">randomMinutes</span> <span class="hljs-operator">=</span> baseMinutes + RANDOM.nextInt(<span class="hljs-number">10</span>);
    redisTemplate.opsForValue().set(key, JSON.toJSONString(value), 
        randomMinutes, TimeUnit.MINUTES);
}

<span class="hljs-comment">// 批量设置时使用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchSetProducts</span><span class="hljs-params">(List&lt;Product&gt; products)</span> {
    products.forEach(p -&gt; {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + p.getId();
        setWithRandomExpire(key, p, <span class="hljs-number">30</span>); <span class="hljs-comment">// 30-40分钟随机过期</span>
    });
}
</code></pre>
<h2 data-id="heading-28">八、总结</h2>
<p>缓存一致性是分布式系统中的经典难题，没有银弹方案，只有适合业务场景的最佳实践。</p>
<h3 data-id="heading-29">方案选择速查表</h3>






























<table><thead><tr><th>业务场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>一般业务（如商品详情）</td><td>Cache Aside + 过期时间</td><td>简单可靠，满足最终一致</td></tr><tr><td>高并发写入（如秒杀库存）</td><td>延迟双删 + MQ重试</td><td>解决极端并发场景</td></tr><tr><td>数据同步（如搜索索引）</td><td>Binlog订阅</td><td>业务零侵入</td></tr><tr><td>金融交易</td><td>分布式读写锁</td><td>强一致性保证</td></tr></tbody></table>
<hr/>
<p>又是没有大厂约面日子😣😣😣，小编还在找实习的路上，这篇文章是我的笔记汇总整理。</p>
<h2 data-id="heading-30">参考文献</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Fdocs%2Fmanual%2Fpatterns%2Fcaching%2F" target="_blank" title="https://redis.io/docs/manual/patterns/caching/" ref="nofollow noopener noreferrer">Redis官方文档 - Caching Patterns</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fcanal" target="_blank" title="https://github.com/alibaba/canal" ref="nofollow noopener noreferrer">Canal GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdebezium.io%2F" target="_blank" title="https://debezium.io/" ref="nofollow noopener noreferrer">Debezium - Change Data Capture</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftech.meituan.com%2F2017%2F03%2F17%2Fcache-about.html" target="_blank" title="https://tech.meituan.com/2017/03/17/cache-about.html" ref="nofollow noopener noreferrer">美团技术博客 - 缓存那些事</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcaching%2Fbest-practices%2F" target="_blank" title="https://aws.amazon.com/caching/best-practices/" ref="nofollow noopener noreferrer">AWS Caching Best Practices</a></li>
<li>《Redis设计与实现》- 黄健宏</li>
<li>《分布式系统：概念与设计》- George Coulouris</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fredis%2Fredis%2Freleases%2Ftag%2F7.0.0" target="_blank" title="https://github.com/redis/redis/releases/tag/7.0.0" ref="nofollow noopener noreferrer">Redis 7.0 Release Notes</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>